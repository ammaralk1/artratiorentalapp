<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title data-i18n data-i18n-key="customerDetails.pageTitle">معلومات العميل</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script>
    (function () {
      document.documentElement.classList.add('language-loading');
      document.documentElement.classList.add('theme-loading');
      try {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.classList.add('dark-mode');
        }
      } catch (error) {
        // ignore
      }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/styles/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="theme-loading">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-start my-3 flex-wrap gap-3">
      <div>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <a href="home.html" class="btn btn-outline-primary" data-i18n data-i18n-key="actions.goHome">🏠 الرئيسية</a>
          <a href="dashboard.html" class="btn btn-outline-primary" data-i18n data-i18n-key="tabs.reservations">📅 الحجوزات</a>
          <a href="projects.html" class="btn btn-outline-primary" data-i18n data-i18n-key="projects.nav.projects">📁 المشاريع</a>
        </div>
        <h2 class="mb-0" data-i18n data-i18n-key="customerDetails.title">👤 بيانات العميل</h2>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-outline-secondary language-toggle-btn" id="language-toggle" data-label-ar="🇸🇦 العربية" data-label-en="🇬🇧 English" aria-pressed="false"></button>
        <button class="btn btn-outline-secondary theme-toggle-btn" id="theme-toggle" data-i18n data-i18n-key="actions.toggleTheme">🌙 الوضع الليلي</button>
        <button class="btn btn-danger" id="logout-btn" data-i18n data-i18n-key="actions.logout">🚪 تسجيل الخروج</button>
      </div>
    </div>

    <div class="box">
      <div id="customer-details"></div>
    </div>

    <section class="customer-reservations-section mt-4">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3 filters-bar">
        <input type="text" id="customer-search-reservation" class="form-control w-auto" placeholder="🔍 ابحث باسم العميل أو رقم الحجز..." data-i18n data-i18n-placeholder-key="customerDetails.filters.search">
        <input type="text" id="customer-filter-start-date" class="form-control w-auto" placeholder="📅 من تاريخ" data-i18n data-i18n-placeholder-key="reservations.list.filters.start">
        <input type="text" id="customer-filter-end-date" class="form-control w-auto" placeholder="📅 إلى تاريخ" data-i18n data-i18n-placeholder-key="reservations.list.filters.end">
        <select id="customer-reservation-date-range" class="form-select w-auto">
          <option value="" data-i18n data-i18n-key="reservations.list.filters.range.all">⏱️ كل التواريخ</option>
          <option value="today" data-i18n data-i18n-key="reservations.list.filters.range.today">📅 اليوم</option>
          <option value="week" data-i18n data-i18n-key="reservations.list.filters.range.week">📆 هذا الأسبوع</option>
          <option value="month" data-i18n data-i18n-key="reservations.list.filters.range.month">🗓️ هذا الشهر</option>
        </select>
        <select id="customer-reservation-status-filter" class="form-select w-auto">
          <option value="" data-i18n data-i18n-key="reservations.list.filters.status.all">⚙️ كل الحالات</option>
          <option value="confirmed" data-i18n data-i18n-key="reservations.list.filters.status.confirmed">✅ مؤكدة</option>
          <option value="pending" data-i18n data-i18n-key="reservations.list.filters.status.pending">⏳ غير مؤكدة</option>
          <option value="completed" data-i18n data-i18n-key="reservations.list.filters.status.completed">📁 منتهية</option>
        </select>
        <button type="button" class="btn btn-outline-secondary" id="customer-clear-filters" data-i18n data-i18n-key="actions.clearFilters">🔄 إعادة التصفية</button>
      </div>
      <div id="customer-reservations" class="mt-3"></div>
    </section>

    <section class="customer-projects-section mt-4">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <h3 class="mb-0" data-i18n data-i18n-key="customerProjects.title">📁 مشاريع العميل</h3>
      </div>
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3 filters-bar">
        <input type="text" id="customer-project-search" class="form-control w-auto" placeholder="🔍 ابحث باسم المشروع أو الوصف..." data-i18n data-i18n-placeholder-key="projectCards.filters.search">
        <select id="customer-project-status-filter" class="form-select w-auto">
          <option value="" data-i18n data-i18n-key="projectCards.filters.status.all">⚙️ كل الحالات</option>
          <option value="upcoming" data-i18n data-i18n-key="projectCards.filters.status.upcoming">📅 مشاريع قادمة</option>
          <option value="ongoing" data-i18n data-i18n-key="projectCards.filters.status.ongoing">⚙️ مشاريع قيد التنفيذ</option>
          <option value="completed" data-i18n data-i18n-key="projectCards.filters.status.completed">✅ مشاريع منتهية</option>
        </select>
        <button type="button" class="btn btn-outline-secondary" id="customer-projects-clear-filters" data-i18n data-i18n-key="actions.clearFilters">🔄 إعادة التصفية</button>
      </div>
      <div class="box">
        <div id="customer-projects" class="row g-3" data-empty="لا توجد مشاريع مرتبطة بهذا العميل." data-empty-key="customerProjects.empty"></div>
      </div>
    </section>
  </div>

  <div class="modal fade" id="reservationDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n data-i18n-key="reservations.details.modalTitle">📋 تفاصيل الحجز</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" data-i18n data-i18n-aria-label-key="actions.close"></button>
        </div>
        <div class="modal-body" id="reservation-details-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n data-i18n-key="actions.close">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editReservationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n data-i18n-key="reservations.edit.modalTitle">✏️ تعديل الحجز</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" data-i18n data-i18n-aria-label-key="actions.close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-reservation-form" class="row g-3">
            <input type="hidden" id="edit-res-index">

            <div class="col-md-6">
              <label class="form-label" for="edit-res-id" data-i18n data-i18n-key="reservations.edit.labels.id">🆔 رقم الحجز</label>
              <input type="text" class="form-control" id="edit-res-id" disabled>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-res-customer" data-i18n data-i18n-key="reservations.edit.labels.customer">👤 العميل</label>
              <input type="text" class="form-control" id="edit-res-customer" disabled>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="edit-res-start" data-i18n data-i18n-key="reservations.edit.labels.startDate">📅 تاريخ البداية</label>
              <input type="text" class="form-control" id="edit-res-start">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-res-start-time" data-i18n data-i18n-key="reservations.edit.labels.startTime">⏰ وقت البداية</label>
              <input type="text" class="form-control" id="edit-res-start-time">
            </div>

            <div class="col-md-6">
              <label class="form-label" for="edit-res-end" data-i18n data-i18n-key="reservations.edit.labels.endDate">📅 تاريخ النهاية</label>
              <input type="text" class="form-control" id="edit-res-end">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-res-end-time" data-i18n data-i18n-key="reservations.edit.labels.endTime">⏰ وقت النهاية</label>
              <input type="text" class="form-control" id="edit-res-end-time">
            </div>

            <div class="col-md-6">
              <label class="form-label" for="edit-res-project" data-i18n data-i18n-key="reservations.edit.labels.project">📁 المشروع المرتبط</label>
              <select id="edit-res-project" class="form-select">
                <option value="" data-i18n data-i18n-key="reservations.create.placeholders.project">اختر مشروعاً (اختياري)</option>
              </select>
            </div>
            <div class="col-md-6">
              <div class="d-flex flex-wrap align-items-center gap-3 mt-4 mt-md-0">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="edit-res-tax">
                  <label class="form-check-label" for="edit-res-tax" data-i18n data-i18n-key="reservations.edit.labels.tax">شامل الضريبة (15%)</label>
                </div>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="edit-res-confirmed">
                  <label class="form-check-label" for="edit-res-confirmed" data-i18n data-i18n-key="reservations.edit.labels.confirmed">✅ تم التأكيد</label>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="edit-res-discount" data-i18n data-i18n-key="reservations.edit.labels.discount">💵 الخصم</label>
              <div class="input-group">
                <input type="text" class="form-control" id="edit-res-discount" placeholder="ادخل قيمة الخصم" data-i18n data-i18n-placeholder-key="reservations.edit.placeholders.discount">
                <select id="edit-res-discount-type" class="form-select">
                  <option value="percent" data-i18n data-i18n-key="reservations.edit.discount.percent">٪ نسبة</option>
                  <option value="amount" data-i18n data-i18n-key="reservations.edit.discount.amount">💵 مبلغ</option>
                </select>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="edit-res-paid" data-i18n data-i18n-key="reservations.edit.labels.paymentStatus">💳 حالة الدفع</label>
              <select id="edit-res-paid" class="form-select">
                <option value="paid" data-i18n data-i18n-key="reservations.edit.payment.paid">مدفوع</option>
                <option value="unpaid" selected data-i18n data-i18n-key="reservations.edit.payment.unpaid">لم يتم الدفع</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label" for="edit-res-notes" data-i18n data-i18n-key="reservations.edit.labels.notes">📝 الملاحظات</label>
              <textarea class="form-control" id="edit-res-notes" rows="3" placeholder="اكتب أي ملاحظات..." data-i18n data-i18n-placeholder-key="reservations.edit.placeholders.notes"></textarea>
            </div>

            <div class="col-12">
              <div id="edit-res-summary" class="alert alert-info"></div>
            </div>

            <div class="col-12">
              <label for="edit-res-equipment-barcode" class="form-label" data-i18n data-i18n-key="reservations.edit.labels.addEquipment">🎥 إضافة معدة</label>
              <input type="text" class="form-control mb-2" id="edit-res-equipment-barcode" placeholder="🔍 امسح أو أدخل الباركود ثم اضغط Enter" data-i18n data-i18n-placeholder-key="reservations.edit.placeholders.barcode">
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th data-i18n data-i18n-key="reservations.edit.table.headers.code">الكود</th>
                      <th data-i18n data-i18n-key="reservations.edit.table.headers.description">الوصف</th>
                      <th data-i18n data-i18n-key="reservations.edit.table.headers.price">السعر</th>
                      <th data-i18n data-i18n-key="reservations.edit.table.headers.quantity">الكمية</th>
                      <th data-i18n data-i18n-key="reservations.edit.table.headers.image">الصورة</th>
                      <th data-i18n data-i18n-key="reservations.edit.table.headers.delete">حذف</th>
                    </tr>
                  </thead>
                  <tbody id="edit-res-items">
                    <tr><td colspan="6" class="text-center" data-i18n data-i18n-key="reservations.edit.table.empty">لا توجد معدات</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label" for="edit-res-technician" data-i18n data-i18n-key="reservations.edit.labels.technician">😎 إضافة عضو طاقم</label>
              <div class="input-group">
                <select id="edit-res-technician" class="form-select"></select>
                <button type="button" class="btn btn-outline-primary" id="add-technician-reservation" data-i18n data-i18n-key="reservations.edit.labels.addTechnician">➕ إضافة</button>
              </div>
            </div>

            <div class="col-12">
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th data-i18n data-i18n-key="reservations.edit.tech.headers.name">الاسم</th>
                      <th data-i18n data-i18n-key="reservations.edit.tech.headers.role">الدور</th>
                      <th data-i18n data-i18n-key="reservations.edit.tech.headers.wage">الأجر اليومي</th>
                      <th data-i18n data-i18n-key="reservations.edit.tech.headers.actions">إجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="edit-res-technicians">
                    <tr><td colspan="4" class="text-center" data-i18n data-i18n-key="reservations.edit.tech.empty">لا يوجد أعضاء طاقم</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n data-i18n-key="actions.cancel">إلغاء</button>
          <button type="button" class="btn btn-primary" id="save-reservation-changes" data-i18n data-i18n-key="reservations.edit.actions.save">💾 حفظ التعديلات</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n data-i18n-key="customerDetails.edit.modalTitle">✏️ تعديل العميل</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" data-i18n data-i18n-aria-label-key="actions.close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-id">

          <div class="mb-3">
            <label class="form-label" for="edit-name" data-i18n data-i18n-key="customers.form.labels.name">👤 الاسم</label>
            <input class="form-control" id="edit-name" placeholder="اسم العميل" data-i18n data-i18n-placeholder-key="customers.form.placeholders.name">
          </div>

          <div class="mb-3">
            <label class="form-label" for="edit-phone" data-i18n data-i18n-key="customers.form.labels.phone">📞 الجوال</label>
            <input class="form-control" id="edit-phone" placeholder="05xxxxxxxx" data-i18n data-i18n-placeholder-key="customers.form.placeholders.phone">
          </div>

          <div class="mb-3">
            <label class="form-label" for="edit-company" data-i18n data-i18n-key="customers.form.labels.company">🏢 الشركة</label>
            <input class="form-control" id="edit-company" placeholder="اسم الشركة" data-i18n data-i18n-placeholder-key="customers.form.placeholders.company">
          </div>

          <div class="mb-3">
            <label class="form-label" for="edit-email" data-i18n data-i18n-key="customers.form.labels.email">📧 البريد</label>
            <input class="form-control" id="edit-email" placeholder="example@email.com" data-i18n data-i18n-placeholder-key="customers.form.placeholders.email">
          </div>

          <div class="mb-3">
            <label class="form-label" for="edit-address" data-i18n data-i18n-key="customers.form.labels.address">📍 العنوان</label>
            <input class="form-control" id="edit-address" placeholder="عنوان العميل" data-i18n data-i18n-placeholder-key="customers.form.placeholders.address">
          </div>

          <div class="mb-3">
            <label class="form-label" for="edit-notes" data-i18n data-i18n-key="customers.form.labels.notes">📝 الملاحظات</label>
            <textarea class="form-control" id="edit-notes" rows="3" placeholder="معلومات إضافية أو تذكيرات" data-i18n data-i18n-placeholder-key="customers.form.placeholders.notes"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="save-edit-btn" data-i18n data-i18n-key="customers.form.actions.update">💾 حفظ التعديل</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n data-i18n-key="projects.modal.title">تفاصيل المشروع</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" data-i18n data-i18n-aria-label-key="actions.close"></button>
        </div>
        <div class="modal-body" id="project-details-body"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script type="module" src="/src/scripts/language.js"></script>
  <script type="module" src="/src/scripts/translations/common.js"></script>
  <script type="module" src="/src/scripts/translations/dashboard.js"></script>
  <script type="module" src="/src/scripts/translations/projects.js"></script>
  <script type="module" src="/src/scripts/translations/customer.js"></script>

  <script type="module">
    import { applyStoredTheme, initThemeToggle } from '/src/scripts/theme.js';
    import { checkAuth, logout } from '/src/scripts/auth.js';
    import { loadData, saveData, migrateOldData } from '/src/scripts/storage.js';
    import { renderCustomerReservations, renderCustomerProjects } from '/src/scripts/customerDetails.js';
    import { showReservationDetails } from '/src/scripts/reservationsUI.js';
    import { showToast, normalizeNumbers } from '/src/scripts/utils.js';
    import { t } from '/src/scripts/language.js';
    import { apiRequest, ApiError } from '/src/scripts/apiClient.js';
    import { mapReservationFromApi } from '/src/scripts/reservationsService.js';
    import { mapProjectFromApi } from '/src/scripts/projectsService.js';
    import { mapTechnicianFromApi } from '/src/scripts/techniciansService.js';

    applyStoredTheme();
    checkAuth();
    initThemeToggle();
    migrateOldData();

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn && !logoutBtn.dataset.listenerAttached) {
      logoutBtn.addEventListener('click', () => logout());
      logoutBtn.dataset.listenerAttached = 'true';
    }

    window.showReservationDetails = showReservationDetails;

    const params = new URLSearchParams(window.location.search);
    const customerId = params.get('id');
    const container = document.getElementById('customer-details');

    let currentCustomer = null;
    let isCustomerLoading = false;
    let customerLoadError = '';

    function findCustomerById(id) {
      const { customers } = loadData();
      if (!Array.isArray(customers)) return null;
      return customers.find((customer) => String(customer.id) === String(id));
    }

    function mapCustomerFromApi(raw = {}) {
      if (!raw || typeof raw !== 'object') return null;
      const idValue = raw.id ?? raw.customerId ?? raw.customer_id ?? null;
      const customerName = raw.full_name ?? raw.customerName ?? raw.name ?? '';
      if (idValue == null) {
        return null;
      }
      return {
        id: String(idValue),
        customerName,
        full_name: customerName,
        phone: raw.phone ?? '',
        companyName: raw.company ?? raw.company_name ?? raw.companyName ?? '',
        company: raw.company ?? raw.company_name ?? raw.companyName ?? '',
        email: raw.email ?? '',
        address: raw.address ?? '',
        notes: raw.notes ?? '',
        created_at: raw.created_at ?? raw.createdAt ?? null,
        updated_at: raw.updated_at ?? raw.updatedAt ?? null,
      };
    }

    function upsertCustomerInStore(customer) {
      if (!customer) return;
      const snapshot = loadData();
      const customers = Array.isArray(snapshot.customers) ? [...snapshot.customers] : [];
      const index = customers.findIndex((item) => String(item.id) === String(customer.id));
      if (index >= 0) {
        customers[index] = { ...customers[index], ...customer };
      } else {
        customers.push(customer);
      }
      saveData({ customers });
    }

    async function ensureTechniciansLoaded() {
      const { technicians } = loadData();
      if (Array.isArray(technicians) && technicians.length > 0) {
        return;
      }

      try {
        const response = await apiRequest('/technicians/');
        const records = Array.isArray(response?.data)
          ? response.data.map(mapTechnicianFromApi)
          : [];
        if (records.length > 0) {
          saveData({ technicians: records });
        }
      } catch (error) {
        console.warn('⚠️ Failed to load technicians list', error);
      }
    }

    async function fetchCustomerReservationsData(id) {
      if (!id) return;
      try {
        const params = new URLSearchParams({ customer_id: String(id), limit: '200' });
        const response = await apiRequest(`/reservations/?${params.toString()}`);
        const records = Array.isArray(response?.data)
          ? response.data.map(mapReservationFromApi)
          : [];
        saveData({ reservations: records });
      } catch (error) {
        console.warn('⚠️ Failed to load customer reservations', error);
      }
    }

    async function fetchCustomerProjectsData(id) {
      if (!id) return;
      try {
        const params = new URLSearchParams({ client_id: String(id), limit: '200' });
        const response = await apiRequest(`/projects/?${params.toString()}`);
        const records = Array.isArray(response?.data)
          ? response.data.map(mapProjectFromApi)
          : [];
        saveData({ projects: records });
      } catch (error) {
        console.warn('⚠️ Failed to load customer projects', error);
      }
    }

    async function loadCustomerFromApi(id, { showSpinner = false } = {}) {
      if (!id) return;

      if (showSpinner) {
        isCustomerLoading = true;
        customerLoadError = '';
        renderDetails();
      } else {
        isCustomerLoading = true;
        customerLoadError = '';
      }

      try {
        const response = await apiRequest(`/customers/?id=${encodeURIComponent(id)}`);
        const rawCustomer = response?.data ?? response;
        const mappedCustomer = mapCustomerFromApi(rawCustomer);
        if (!mappedCustomer) {
          throw new Error('Invalid customer payload received from server');
        }

        currentCustomer = mappedCustomer;
        upsertCustomerInStore(mappedCustomer);
        isCustomerLoading = false;
        customerLoadError = '';
        renderDetails();

        await ensureTechniciansLoaded();
        await Promise.all([
          fetchCustomerReservationsData(mappedCustomer.id),
          fetchCustomerProjectsData(mappedCustomer.id),
        ]);

        renderCustomerReservations(mappedCustomer.id);
        renderCustomerProjects(mappedCustomer.id);
      } catch (error) {
        isCustomerLoading = false;
        if (error instanceof ApiError && error.status === 404) {
          currentCustomer = null;
          customerLoadError = '';
          renderDetails();
          return;
        }

        console.error('⚠️ Failed to load customer details', error);
        const message = t('customerDetails.errors.loadFailed', '⚠️ تعذر تحميل بيانات العميل.');
        if (currentCustomer) {
          customerLoadError = '';
          showToast(message);
          renderDetails();
        } else {
          customerLoadError = `${message}${error?.message ? ` (${error.message})` : ''}`;
          renderDetails();
        }
      }
    }

    function renderDetails() {
      if (!container) return;

      if (!currentCustomer) {
        if (isCustomerLoading) {
          container.innerHTML = `<p class="text-muted" data-i18n data-i18n-key="customerDetails.status.loading">${t('customerDetails.status.loading', '⏳ جارٍ تحميل بيانات العميل...')}</p>`;
          return;
        }

        if (customerLoadError) {
          container.innerHTML = `<p class="text-danger">${customerLoadError}</p>`;
          return;
        }

        container.innerHTML = `<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.notFound">${t('customerDetails.errors.notFound', '⚠️ لم يتم العثور على هذا العميل.')}</p>`;
        return;
      }

      const fields = [
        { key: 'customerDetails.fields.name', value: currentCustomer.customerName || '—' },
        { key: 'customerDetails.fields.phone', value: currentCustomer.phone ? normalizeNumbers(currentCustomer.phone) : '—' },
        { key: 'customerDetails.fields.company', value: currentCustomer.companyName || '—' },
        { key: 'customerDetails.fields.email', value: currentCustomer.email || '—' },
        { key: 'customerDetails.fields.address', value: currentCustomer.address || '—' },
        { key: 'customerDetails.fields.notes', value: currentCustomer.notes || '—' }
      ].map(({ key, value }) => `
        <p class="customer-detail-row">
          <strong data-i18n data-i18n-key="${key}">${t(key)}</strong>
          <span>${value}</span>
        </p>
      `).join('');

      container.innerHTML = `
        <div class="customer-details">
          ${fields}
        </div>
        <button class="btn btn-warning mt-3" id="edit-btn" data-i18n data-i18n-key="customerDetails.actions.edit">${t('customerDetails.actions.edit', '✏️ تعديل العميل')}</button>
      `;
      bindEditButton();
    }

    function populateEditModal() {
      document.getElementById('edit-id').value = currentCustomer?.id || '';
      document.getElementById('edit-name').value = currentCustomer?.customerName || '';
      document.getElementById('edit-phone').value = normalizeNumbers(currentCustomer?.phone || '');
      document.getElementById('edit-company').value = currentCustomer?.companyName || '';
      document.getElementById('edit-email').value = currentCustomer?.email || '';
      document.getElementById('edit-address').value = currentCustomer?.address || '';
      document.getElementById('edit-notes').value = currentCustomer?.notes || '';
    }

    function bindEditButton() {
      const editBtn = document.getElementById('edit-btn');
      if (!editBtn || editBtn.dataset.listenerAttached) return;
      editBtn.addEventListener('click', () => {
        populateEditModal();
        const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
        modal.show();
      });
      editBtn.dataset.listenerAttached = 'true';
    }

    const saveEditBtn = document.getElementById('save-edit-btn');
    if (saveEditBtn && !saveEditBtn.dataset.listenerAttached) {
      saveEditBtn.addEventListener('click', () => {
        if (!currentCustomer) return;

        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value.trim();
        const phone = normalizeNumbers(document.getElementById('edit-phone').value.trim());
        const company = document.getElementById('edit-company').value.trim();
        const email = document.getElementById('edit-email').value.trim();
        const address = document.getElementById('edit-address').value.trim();
        const notes = document.getElementById('edit-notes').value.trim();

        if (!name || !phone) {
          showToast(t('customerDetails.toast.missingRequired', '⚠️ الاسم ورقم الهاتف إلزاميان'));
          return;
        }

        const data = loadData();
        const customers = Array.isArray(data.customers) ? data.customers : [];
        const idx = customers.findIndex((customer) => String(customer.id) === String(id));
        if (idx === -1) {
          showToast(t('customerDetails.toast.notFound', '⚠️ العميل غير موجود'));
          return;
        }

        customers[idx] = {
          ...customers[idx],
          customerName: name,
          phone,
          companyName: company,
          email,
          address,
          notes
        };

        saveData({ customers });
        currentCustomer = customers[idx];
        renderDetails();
        renderCustomerReservations(customerId);
        renderCustomerProjects(customerId);
        document.dispatchEvent(new CustomEvent('customers:changed'));
        showToast(t('customerDetails.toast.updateSuccess', '✅ تم تحديث بيانات العميل'));

        const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
        modal?.hide();
      });
      saveEditBtn.dataset.listenerAttached = 'true';
    }

    async function initializeCustomerPage() {
      if (!customerId) {
        if (container) {
          container.innerHTML = `<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${t('customerDetails.errors.missingId', '⚠️ لا يوجد معرف عميل في الرابط.')}</p>`;
        }
        return;
      }

      currentCustomer = findCustomerById(customerId);
      if (currentCustomer) {
        renderDetails();
        renderCustomerReservations(customerId);
        renderCustomerProjects(customerId);
      }

      await loadCustomerFromApi(customerId, { showSpinner: !currentCustomer });
    }

    initializeCustomerPage();

    document.addEventListener('language:changed', () => {
      renderDetails();
      if (customerId && currentCustomer) {
        renderCustomerReservations(customerId);
        renderCustomerProjects(customerId);
      }
    });
  </script>
</body>
</html>
