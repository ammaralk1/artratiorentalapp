import{n as G,a as Q,x as tt,B as et,d as nt,C as B}from"./reservationsService.B36iRCMw.js";import{t as at,n as C,p as Y}from"./auth.DPPwhYNj.js";const h={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function mt(t){h.callbacks.onRender=typeof t=="function"?t:null}function pt(t){h.callbacks.onBeforeRender=typeof t=="function"?t:null}function ft(t){h.callbacks.onAfterRender=typeof t=="function"?t:null}function ht(t){h.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function gt(t){h.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function yt(t){h.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function R(t){if(h.loadedScripts.has(t))return h.loadedScripts.get(t);const e=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,o=new Promise((a,r)=>{const n=()=>{e&&(e.dataset.loaded="true"),a()},s=l=>r(l);if(e){if(e.dataset.loaded==="true"){a();return}e.addEventListener("load",n,{once:!0}),e.addEventListener("error",s,{once:!0});return}const u=document.createElement("script");u.src=t,u.async=!0,u.onload=()=>{u.dataset.loaded="true",a()},u.onerror=l=>r(l),document.head.appendChild(u)});return h.loadedScripts.set(t,o),o}function wt(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(h.apexChartsReady||(h.apexChartsReady=R("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),h.apexChartsReady)}function q(t,e=1500){return new Promise((o,a)=>{const r=setTimeout(()=>o(null),Math.max(200,e));t.then(n=>{clearTimeout(r),o(n)},n=>{clearTimeout(r),o(null)})})}async function rt(){try{const t=await fetch("/vendor/html2pdf.bundle.min.js",{method:"GET",cache:"no-cache"});if(!t.ok)return!1;const e=(t.headers.get("content-type")||"").toLowerCase();if(!(e.includes("javascript")||e.includes("ecmascript")))return!1;const o=await t.text();if(!o||/<\s*!doctype\s+html/i.test(o))return!1;const a=new Blob([o],{type:"text/javascript"}),r=URL.createObjectURL(a);await R(r);try{URL.revokeObjectURL(r)}catch{}return typeof window.html2pdf<"u"}catch{return!1}}function bt(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(h.html2PdfReady||(h.html2PdfReady=(async()=>await q(rt(),1200)&&window.html2pdf?window.html2pdf:(await q(R("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"),2e3),window.html2pdf||null))()),h.html2PdfReady)}function St(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(h.xlsxReady||(h.xlsxReady=R("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),h.xlsxReady)}function Dt(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(h.jsZipReady||(h.jsZipReady=R("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),h.jsZipReady)}function D(t,e,o=e){const r=Y()==="en"?o??e:e;return at(t,r)}function Nt(){h.formatters.cachedLocale=null,h.formatters.numberFormatter=null}function I(){return(Y()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function O(){const t=Y();if(t!==h.formatters.cachedLocale||!h.formatters.numberFormatter||!h.formatters.currencyFormatter){h.formatters.cachedLocale=t;const e=I();h.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),h.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:h.formatters.numberFormatter,currencyFormatter:h.formatters.currencyFormatter}}function Mt(t){const{numberFormatter:e}=O(),o=e.format(Math.round(t||0));return C(o)}function Tt(t){const{currencyFormatter:e}=O(),o=Number.isFinite(Number(t))?Number(t):0,a=e.format(o);return`${C(a)} SR`}function E(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const o=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${o}-${a}-${r}`}function Ct(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const o=new Intl.DateTimeFormat(I(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return C(o.format(e))}function X(t){return new Intl.DateTimeFormat(I(),{month:"short"}).format(t)}const ot=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),V=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),_=1440*60*1e3,T={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function x(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const o=t[0]||{},a=t[e-1]||{},r=`${o.id??o.reservationId??""}-${o.start??""}`,n=`${a.id??a.reservationId??""}-${a.start??""}`,s=h.formatters?.cachedLocale||"ar";return`${e}|${r}|${n}|${s}`}function P(t,e){return t.get(e)}function L(t,e,o){if(t.set(e,o),t.size>64){const a=t.keys().next().value;t.delete(a)}return o}function Z(t){return C(String(t||"")).toLowerCase().trim()}function k(t){return(t||"").toString().trim()}function W(t,e){if(!t||!e)return 1;const o=new Date(t),a=new Date(e);if(Number.isNaN(o.getTime())||Number.isNaN(a.getTime()))return 1;const r=a.getTime()-o.getTime();return r<=0?1:Math.max(1,Math.ceil(r/_))}function z(t){return t?(h.techniciansIndex||(h.techniciansIndex=new Map((h.data.technicians||[]).map(e=>[String(e.id),e]))),h.techniciansIndex.get(String(t))||null):null}function j(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const o of e){if(o==null)continue;const a=Number.parseFloat(C(String(o)));if(Number.isFinite(a))return a}return 0}function H(t={}){const e=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const o of e){if(o==null)continue;const a=Number.parseFloat(C(String(o)));if(Number.isFinite(a))return a}return j(t)}function F(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;W(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,o=t.discountType||t.discount_type||"percent",a=String(o).toLowerCase()==="amount"?"amount":"percent",r=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",n=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,s=n!=null?et(n):Number.NaN,l=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(s)&&s>0?s:null,d=Array.isArray(t.crewAssignments)?t.crewAssignments:[],m=d.length?d.map(y=>y?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],c=nt({items:Array.isArray(t.items)?t.items:[],technicianIds:m,crewAssignments:d,discount:e,discountType:a,applyTax:r,start:t.start,end:t.end,companySharePercent:l}),i=Number(t.cost);let p=c.finalTotal,f=c.taxAmount;if(Number.isFinite(i)&&i>0&&(p=B(i),r)){const y=p-c.taxableAmount;Number.isFinite(y)&&y>=0&&(f=B(y))}const g={rentalDays:c.rentalDays,equipmentTotal:c.equipmentTotal,crewTotal:c.crewTotal,crewCostTotal:c.crewCostTotal,discountAmount:c.discountAmount,subtotalAfterDiscount:c.subtotalAfterDiscount,taxableAmount:c.taxableAmount,taxAmount:f,finalTotal:p,companySharePercent:c.companySharePercent,companyShareAmount:c.companyShareAmount,netProfit:c.netProfit,companyShareEnabled:c.companySharePercent>0};return t.__financials=g,g}function J(t){return t?.projectId&&h.data.projectsMap.get(String(t.projectId))||null}function U(t=""){const e=String(t).toLowerCase().trim();return e?ot.get(e)||e:""}function st(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const o of e){const a=String(o||"").toLowerCase().trim();if(a&&V.has(a))return V.get(a)}return t?.paid===!0||t?.paid==="true"}function N(t){const e=J(t),o=Q(t,e),a=U(o.projectStatus);let r=U(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");o.projectLinked&&a&&r!=="cancelled"&&(r=a),r||(r=o.effectiveConfirmed?"confirmed":"pending"),r!=="cancelled"&&(tt(t)||a==="completed")&&(r="completed");let n=o.effectiveConfirmed||r==="confirmed"||r==="completed";r==="cancelled"&&(n=!1),n&&r!=="completed"&&r!=="cancelled"&&(r="confirmed");const s=st(t),u=t?.paidStatus??t?.paid_status??(s?"paid":"unpaid");return{statusValue:r,confirmed:n,paid:s,paidStatus:u}}function Ft(t){const e=t.length;let o=0,a=0,r=0,n=0,s=0,u=0,l=0,d=0,m=0,c=0,i=0,p=0;t.forEach(g=>{const{statusValue:y,confirmed:S,paid:w,paidStatus:A}=N(g);if(y==="completed"&&(a+=1),y==="cancelled"&&(r+=1),S&&(o+=1),w&&y!=="cancelled"&&(n+=1),y!=="cancelled"&&A!=="paid"&&(s+=1),y!=="cancelled"){const b=F(g);u+=b.finalTotal,l+=b.companyShareAmount,d+=b.taxAmount,m+=b.crewTotal,c+=b.crewCostTotal??0,i+=b.netProfit;const M=$(g);Number.isFinite(M)&&M>0&&(p+=M)}});const f=e?u/e:0;return{total:e,confirmed:o,completed:a,cancelled:r,activeTotal:Math.max(0,e-r),paidCount:n,unpaidCount:s,outstandingTotal:p,revenue:u,average:f,companyShareTotal:l,taxTotal:d,crewTotal:m,crewCostTotal:c,netProfit:i}}function v({range:t,start:e,end:o}){const a=new Date;if(a.setHours(23,59,59,999),t==="custom"){const s=e?new Date(`${e}T00:00:00`):null,u=o?new Date(`${o}T23:59:59`):null;return{startDate:K(s)?s:null,endDate:K(u)?u:null}}let r=new Date(a),n=null;switch(t){case"last30":{n=new Date(a),n.setDate(n.getDate()-29);break}case"thisWeek":{const s=new Date(a),l=(s.getDay()-6+7)%7;s.setDate(s.getDate()-l),s.setHours(0,0,0,0);const d=new Date(s);d.setDate(s.getDate()+6),d.setHours(23,59,59,999),n=s,r=d;break}case"thisMonth":{n=new Date(a.getFullYear(),a.getMonth(),1),r=new Date(a.getFullYear(),a.getMonth()+1,0),r.setHours(23,59,59,999);break}case"thisQuarter":{const s=Math.floor(a.getMonth()/3);n=new Date(a.getFullYear(),s*3,1),r=new Date(a.getFullYear(),(s+1)*3,0),r.setHours(23,59,59,999);break}case"thisYear":{n=new Date(a.getFullYear(),0,1),r=new Date(a.getFullYear(),12,0),r.setHours(23,59,59,999);break}case"all":default:n=null,r=null;break}return n&&n.setHours(0,0,0,0),{startDate:n,endDate:r}}function K(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function At(t,e){const{startDate:o,endDate:a}=v(e);let r=0;const n=[];return(t||[]).forEach(s=>{if(!s)return;const u=typeof s.repairCost=="number"?s.repairCost:Number.parseFloat(C(String(s.repairCost??"")));if(!Number.isFinite(u)||u<=0)return;const l=String(s.statusRaw??s.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const m=s.resolvedAt??s.resolved_at??null,c=s.reportedAt??s.reported_at??null,i=s.createdAt??s.created_at??null,p=m?new Date(m):null,f=c?new Date(c):i?new Date(i):null,g=p&&!Number.isNaN(p.getTime())?p:f&&!Number.isNaN(f.getTime())?f:null;if(g&&(o&&g<o||a&&g>a))return;const y=Math.round(u*100)/100;r+=y,n.push({id:s.id,cost:y,date:g})}),{total:r,items:n}}function Rt(t,e){const o=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:o,netProfit:(t.netProfit||0)-o}}function xt(t){const e=`trend:${x(t)}`,o=P(T.trend,e);if(o)return o;const a=new Date,r=[],n=(t||[]).map(l=>l?.start?new Date(l.start):null).filter(l=>l&&!Number.isNaN(l.getTime()));let s=6,u=new Date(a.getFullYear(),a.getMonth(),1);if(n.length){const l=new Date(Math.min(...n.map(f=>f.getTime()))),d=new Date(Math.max(...n.map(f=>f.getTime()))),m=new Date(l.getFullYear(),l.getMonth(),1);u=new Date(d.getFullYear(),d.getMonth(),1);const c=u.getFullYear()-m.getFullYear(),i=u.getMonth()-m.getMonth(),p=c*12+i;s=Math.min(12,Math.max(6,p+1))}for(let l=s-1;l>=0;l-=1){const d=new Date(u.getFullYear(),u.getMonth()-l,1),m=d.getFullYear(),c=d.getMonth(),i=t.filter(b=>{const M=b?.start?new Date(b.start):null;return M&&M.getFullYear()===m&&M.getMonth()===c}).filter(b=>N(b).statusValue!=="cancelled"),p=i.length;let f=0,g=0,y=0;i.forEach(b=>{const M=F(b);f+=M.finalTotal,g+=M.netProfit,y+=M.companyShareAmount});const S=X(d),w=new Date(d.getFullYear(),d.getMonth(),1),A=new Date(d.getFullYear(),d.getMonth()+1,0);r.push({label:S,count:p,revenue:f,netProfit:g,companyShare:y,periodStart:w,periodEnd:A,startInput:E(w),endInput:E(A)})}try{const l=new Map;(t||[]).forEach(c=>{if(N(c).statusValue==="cancelled")return;const i=c?.start?new Date(c.start):null;if(!i||Number.isNaN(i.getTime()))return;const p=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`,f=F(c),g=l.get(p)||0;l.set(p,g+(Number(f.finalTotal)||0))});const d=r.map(c=>Number(c.revenue||0)),m=r.map((c,i)=>i<2?null:(d[i]+d[i-1]+d[i-2])/3);r.forEach((c,i)=>{const p=i>0?Number(r[i-1]?.revenue||0):null;let f=null;p!=null&&Number.isFinite(p)&&p>0&&(f=(Number(c.revenue||0)-p)/p*100);const g=c.periodStart instanceof Date?c.periodStart:null;let y=null;if(g&&!Number.isNaN(g.getTime())){const S=`${g.getFullYear()-1}-${String(g.getMonth()+1).padStart(2,"0")}`,w=l.get(S);Number.isFinite(w)&&w>0&&(y=(Number(c.revenue||0)-w)/w*100)}c.momChange=f,c.yoyChange=y,c.movingAvgRevenue=m[i]})}catch{}return L(T.trend,e,r)}function Pt(t){const e=new Date,o=(t||[]).map(s=>s?.start?new Date(s.start):null).filter(s=>s&&!Number.isNaN(s.getTime()));let a=6,r=new Date(e.getFullYear(),e.getMonth(),1);if(o.length){const s=new Date(Math.min(...o.map(i=>i.getTime()))),u=new Date(Math.max(...o.map(i=>i.getTime()))),l=new Date(s.getFullYear(),s.getMonth(),1);r=new Date(u.getFullYear(),u.getMonth(),1);const d=r.getFullYear()-l.getFullYear(),m=r.getMonth()-l.getMonth(),c=d*12+m;a=Math.min(12,Math.max(6,c+1))}const n=[];for(let s=a-1;s>=0;s-=1){const u=new Date(r.getFullYear(),r.getMonth()-s,1),l=u.getFullYear(),d=u.getMonth();let m=0,c=0;(t||[]).forEach(i=>{const p=i?.start?new Date(i.start):null;if(!p||p.getFullYear()!==l||p.getMonth()!==d)return;const{statusValue:f,confirmed:g}=N(i);f==="cancelled"?c+=1:(g||f==="confirmed"||f==="completed")&&(m+=1)}),n.push({label:X(u),confirmed:m,cancelled:c})}return n}function Lt(t){const e=`status:${x(t)}`,o=P(T.status,e);if(o)return o;const a={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(m=>{const{statusValue:c,confirmed:i}=N(m);c==="completed"?a.completed+=1:c==="cancelled"?a.cancelled+=1:c==="confirmed"||i?a.confirmed+=1:a.pending+=1});const r=Math.max(1,(t||[]).length),n=a.confirmed,s=a.pending,u=a.completed,l=a.cancelled,d=[{label:D("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:n,percent:Math.round(n/r*100)||0,rawCount:n,className:"status-confirmed",filterKey:"confirmed"},{label:D("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:s,percent:Math.round(s/r*100)||0,rawCount:s,className:"status-pending",filterKey:"pending"},{label:D("reservations.reports.status.completedLabel","منتهية","Completed"),value:u,percent:Math.round(u/r*100)||0,rawCount:u,className:"status-completed",filterKey:"completed"},{label:D("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:l,percent:Math.round(l/r*100)||0,rawCount:l,className:"status-cancelled",filterKey:"cancelled"}];return L(T.status,e,d)}function kt(t){const e=`payment:${x(t)}`,o=P(T.payment,e);if(o)return o;const a=t.length||1;let r=0,n=0,s=0;(t||[]).forEach(l=>{const{paidStatus:d}=N(l);d==="paid"?r+=1:d==="partial"?n+=1:s+=1});const u=[{label:D("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-paid",filterKey:"paid"},{label:D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:n,percent:Math.round(n/a*100)||0,rawCount:n,className:"status-partial",filterKey:"partial"},{label:D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:s,percent:Math.round(s/a*100)||0,rawCount:s,className:"status-unpaid",filterKey:"unpaid"}];return L(T.payment,e,u)}function Et(t,e){const o=`topCustomers:${x(t)}`,a=P(T.topCustomers,o);if(a)return a;const r=new Map,n=new Map((e||[]).map(u=>[String(u.id),u]));t.forEach(u=>{const{statusValue:l}=N(u);if(l==="cancelled")return;const d=String(u?.customerId??"unknown"),m=r.get(d)||{count:0,revenue:0},c=F(u);m.count+=1,m.revenue+=c.finalTotal,r.set(d,m)});const s=Array.from(r.entries()).map(([u,l])=>({name:n.get(u)?.customerName||D("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:l.count,revenue:l.revenue})).sort((u,l)=>l.revenue-u.revenue).slice(0,5);return L(T.topCustomers,o,s)}function _t(t,e){const o=`topEquipment:${x(t)}`,a=P(T.topEquipment,o);if(a)return a;const r=new Map,n=new Map((e||[]).map(l=>[k(l?.barcode),l])),s=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(l=>{(l?.items||[]).forEach(d=>{const m=k(d?.barcode),c=m?n.get(m):null,i=d?.desc||d?.description||d?.name||c?.desc||c?.description||c?.name||"",p=i&&i.trim()?i:s,f=G(p)||"unknown",g=Number(d?.qty)||1,y=Number(d?.price)||0,S=g*y,w=r.get(f)||{name:p,count:0,revenue:0};w.name=p,w.count+=g,w.revenue+=S,r.set(f,w)})});const u=Array.from(r.values()).sort((l,d)=>d.count!==l.count?d.count-l.count:d.revenue-l.revenue).slice(0,5);return L(T.topEquipment,o,u)}function jt(){Object.values(T).forEach(t=>t.clear())}function ct(t,e,o,a,r){const n=[],s=t?.reservationId||t?.id;s&&n.push(s),t?.notes&&n.push(t.notes);const{statusValue:u,paidStatus:l}=N(t);u&&n.push(u);const d=t?.paymentStatus||t?.payment_status;d&&n.push(d),t?.paid!=null&&n.push(t.paid?"paid":"unpaid"),l&&n.push(l);const m=o.get(String(t?.customerId));m&&n.push(m.customerName,m.company_name||m.companyName,m.contact_person||"");const c=J(t);return c&&n.push(c.title,c.code,c.status),n.push(lt(l)),(t?.items||[]).forEach(p=>{p?.desc&&n.push(p.desc),p?.barcode&&n.push(p.barcode);const f=a.get(k(p?.barcode));f&&n.push(f.desc,f.description,f.name)}),(t?.technicians||[]).forEach(p=>{const f=r.get(String(p));f&&n.push(f.name,f.role,f.department)}),Z(n.filter(Boolean).join(" ")).includes(e)}function Yt(t,e,o,a,r){const{startDate:n,endDate:s}=v(e),u=Z(e.search),l=!!u,d=new Map((o||[]).map(i=>[String(i.id),i])),m=new Map((a||[]).map(i=>[k(i?.barcode),i])),c=new Map((r||[]).map(i=>[String(i.id),i]));return(t||[]).filter(i=>{if(i&&i.projectId!=null&&String(i.projectId).trim()!=="")return!1;const p=i?.start?new Date(i.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let f=i?.end?new Date(i.end):p;if(Number.isNaN(f.getTime())&&(f=p),n&&f<n||s&&p>s)return!1;const{statusValue:g,confirmed:y,paid:S,paidStatus:w}=N(i);if(e.status==="confirmed"&&!(g==="confirmed"||g==="completed"||y)||e.status==="pending"&&g!=="pending"||e.status==="completed"&&g!=="completed"||e.status==="cancelled"&&g!=="cancelled"||e.payment==="paid"&&!S||e.payment==="unpaid"&&S||e.payment==="partial"&&w!=="partial")return!1;if(e.share&&e.share!=="all"){const b=F(i).companySharePercent>0;if(e.share==="with"&&!b||e.share==="without"&&b)return!1}return!(l&&!ct(i,u,d,m,c))})}function lt(t){const e=String(t??"").toLowerCase();return e==="paid"?D("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function It(t,e){const o=new Map((e||[]).map(n=>[String(n.id),n])),a=new Map;return(t||[]).forEach(n=>{const{statusValue:s}=N(n);if(s==="cancelled")return;const u=W(n.start,n.end),l=Array.isArray(n.crewAssignments)?n.crewAssignments:[];if(l.length){l.forEach(m=>{const c=m?.technicianId!=null?String(m.technicianId):null;if(!c)return;const i=o.get(c)||z(c)||{},p=Number.isFinite(Number(m?.positionClientPrice))&&Number(m.positionClientPrice)>0?Number(m.positionClientPrice):H(i),f=Number.isFinite(Number(m?.positionCost))&&Number(m.positionCost)>0?Number(m.positionCost):j(i),g=p*u,y=f*u,S=a.get(c)||{id:c,name:i?.name||String(c),days:0,billable:0,cost:0};S.days+=u,S.billable+=g,S.cost+=y,a.set(c,S)});return}(Array.isArray(n.technicians)?n.technicians.map(m=>String(m)):[]).forEach(m=>{const c=o.get(m)||z(m)||{},i=H(c),p=j(c),f=i*u,g=p*u,y=a.get(m)||{id:m,name:c?.name||String(m),days:0,billable:0,cost:0};y.days+=u,y.billable+=f,y.cost+=g,a.set(m,y)})}),Array.from(a.values()).map(n=>({...n,net:n.billable-n.cost})).sort((n,s)=>s.net-n.net)}function it(t=[]){if(!Array.isArray(t)||!t.length)return 0;let e=0;return t.forEach(o=>{const a=Number(o?.amount);Number.isFinite(a)&&a>0&&(e+=a)}),e}function $(t){const e=F(t),o=Number(e.finalTotal||0);let a=Number(t?.paidAmount);if(!Number.isFinite(a)||a<=0){const n=it(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(n)&&n>0&&(a=n)}if((!Number.isFinite(a)||a<=0)&&Number.isFinite(Number(t?.paidPercent))){const n=Number(t.paidPercent);n>0&&n<=100&&(a=n/100*o)}return Number.isFinite(a)||(a=0),Math.max(0,Math.round((o-a)*100)/100)}function $t(t,e,o=5){const a=new Map((e||[]).map(n=>[String(n.id),n])),r=[];return(t||[]).forEach(n=>{const{paidStatus:s,statusValue:u}=N(n);if(u==="cancelled"||s!=="unpaid"&&s!=="partial")return;const l=$(n);if(!Number.isFinite(l)||l<=0)return;const d=a.get(String(n.customerId));r.push({id:n.id||n.reservationId||"",code:n.reservationCode||n.reservationId||n.id||"",customer:d?.customerName||n.customerName||"",outstanding:l,paidStatus:s})}),r.sort((n,s)=>s.outstanding-n.outstanding).slice(0,o)}function Bt(t,{horizonDays:e=90}={}){const o=new Date,a=new Date(o.getTime()+e*_),r=new Map;return(t||[]).forEach(n=>{const{statusValue:s,paidStatus:u}=N(n);if(s==="cancelled"||u==="paid")return;const l=$(n);if(!Number.isFinite(l)||l<=0)return;const d=n?.start?new Date(n.start):null,m=n?.end?new Date(n.end):d;let c=m&&!Number.isNaN(m.getTime())?m:d;if((!c||Number.isNaN(c.getTime()))&&(c=new Date(o.getTime()+7*_)),c<o||c>a)return;const i=E(new Date(c.getFullYear(),c.getMonth(),c.getDate())),p=r.get(i)||{date:i,amount:0,count:0};p.amount+=l,p.count+=1,r.set(i,p)}),Array.from(r.values()).sort((n,s)=>n.date<s.date?-1:1)}export{Bt as A,$t as B,mt as C,pt as D,ft as E,ht as F,gt as G,yt as H,Nt as I,Dt as J,St as a,jt as b,F as c,v as d,bt as e,wt as f,Mt as g,Tt as h,N as i,Ct as j,E as k,R as l,Yt as m,Ft as n,At as o,lt as p,Rt as q,h as r,xt as s,D as t,Lt as u,Pt as v,kt as w,Et as x,_t as y,It as z};
