import{t as A,p as oe,n as k,j as H,d as se,b as Ee,h as jt,A as Ht}from"./auth.BFR8Y3ym.js";import{r as ft,I as Vt,x as Ke,s as Kt,L as Qt,l as ve,J as Ot,K as Qe,z as pe,b as ke,C as Fe,D as gt,E as Ut}from"./state.B8SZ8bSY.js";const Gt=()=>A("reservations.create.summary.currency","SR");let me=[],J=[],ee=[],te=[],w="create",yt=()=>{},ht=()=>{};const qe=new Map,Be=450;function Wt(e){const t=qe.get(e);return t!=null&&Date.now()-t<Be}function Yt(e){qe.set(e,Date.now()),setTimeout(()=>{const t=qe.get(e);t!=null&&Date.now()-t>=Be&&qe.delete(e)},Be+50)}function Pe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function le(e={}){return{...e,assignmentId:e.assignmentId||Pe()}}function De(e){if(!e)return null;const t=String(e),n=me.find(a=>String(a?.id)===t);if(n)return{...n};const{technicians:i=[]}=se();return i.find(a=>String(a?.id)===t)||null}function fe(e={},t=oe()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Oe(e={},t=oe()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function bt(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=J.find(o=>String(o.id).trim().toLowerCase()===n);if(i)return i;const a=Ot(e);return a||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function nt(e){const t=bt(e,e?.name??""),n=oe(),i=fe(t,n)||t?.name||"",a=Oe(t,n);return we({assignmentId:Pe(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:a,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function we(e={}){const t={assignmentId:e.assignmentId||Pe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=bt(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=oe(),a=fe(n,i)||t.positionLabel,o=Oe(n,i);t.positionLabel=a||t.positionLabel||n?.name||"",t.positionLabelAlt=o||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=De(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function ye(){J=Vt()}function Jt(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return le(we(t));const n=De(t),i=n?{assignmentId:Pe(),positionLabel:n.role||A("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:Pe(),positionLabel:A("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return le(we(i))}).filter(Boolean):[]}function ce(e="create"){return e==="edit"?te.map(le):ee.map(le)}function ne(e="create",t=[]){try{ye()}catch{}const n=Jt(t);e==="edit"?(te=n,ge("edit-selected-technicians-list",te,"edit"),ht()):(ee=n,ge("selected-technicians-list",ee,"create"),yt()),Ie()}function Ue(e="create"){if(e==="edit"){const r=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),s=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=r?ve(r,s):null,g=l?ve(l,u):null;let b=null;const h=document.getElementById("edit-res-index")?.value;if(h!=null){const N=Number.parseInt(h,10);if(Number.isInteger(N)){const{reservations:v=[]}=se(),p=v?.[N];p&&(b=p.id??p.reservationId??null)}}return{start:d,end:g,ignoreReservationId:b}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=t?ve(t,i):null,c=n?ve(n,a):null;return{start:o,end:c,ignoreReservationId:null}}function Ie(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=ce(w).length;if(t){const n=A("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",k(String(t)));e.textContent=n}else e.textContent=A("technicians.picker.selectionInfo","No crew selected yet")}function Le(e){const t=Number.isFinite(e)?e:0;return`${k(t.toFixed(2))} ${Gt()}`}function Xt(e){const t=ce(w),n=new Set(t.filter(s=>s.assignmentId!==e&&s.technicianId).map(s=>s.technicianId)),i=me.length?me:se().technicians||[],{start:a,end:o,ignoreReservationId:c}=Ue(w),r=!!(a&&o);return i.map(s=>{const u=String(s.id),d=n.has(u),g=r?Ke(u,a,o,c):!1,b=k(s.name||s.full_name||s.fullName||s.email||u);return{id:u,label:b,disabled:d||g,conflict:g,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=ce(w);if(!t.length){const n=A("technicians.picker.noAssignments","لم يتم إضافة أي مناصب بعد"),i=A("technicians.picker.assignments.hint","استخدم قائمة المناصب على اليسار لإضافة طاقم العمل.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">🧑‍🤝‍🧑</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}ye(),e.innerHTML=t.map((n,i)=>{const a=k(String(i+1)),o=Le(n.positionClientPrice||0),c=Xt(n.assignmentId),r=A("technicians.picker.noTechnicianOption","— بدون تعيين —"),l=n.technicianId!=null?String(n.technicianId):"",s=n.technicianName?k(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,d=A("technicians.picker.optionAssigned","(مستخدم)"),g=A("technicians.picker.optionConflicting","(متعارض)"),b=c.map(f=>{const S=l===f.id,_=f.disabled&&!S?`${f.label} ${f.conflict?g:d}`:f.label;return`
        <option value="${f.label}"
                data-id="${f.id}"
                data-disabled="${f.disabled?"true":"false"}"
                data-conflict="${f.conflict?"true":"false"}"
                data-taken="${f.taken?"true":"false"}"
                label="${_}"></option>
      `}).join("");let h=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!h||String(h).trim()===""){const f=n.positionId?J.find(P=>String(P.id)===String(n.positionId)):null,S=!f&&n.positionKey?J.find(P=>String(P.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(f||S){const P=f||S;h=fe(P,oe())||P?.name||""}}const N=n.positionLabelAlt?`<div class="text-muted small">${k(n.positionLabelAlt)}</div>`:"",v=A("technicians.picker.actions.remove","إزالة"),p=A("technicians.picker.assignments.price","سعر العميل");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${a}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${k(h||A("reservations.crew.positionFallback","منصب بدون اسم"))}</div>
            ${N}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${o}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${r}"
              value="${l?s:""}"
              aria-label="${A("technicians.picker.assignments.member","عضو الطاقم")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${b}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${v}">
            ${v}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{_t(n.dataset.assignmentId,w)}),n.dataset.listenerAttached="true")}),Zt(e)}function Zt(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,a=()=>{en(n,i)};n.addEventListener("change",a),n.addEventListener("blur",a),n.dataset.listenerAttached="true"})}function en(e,t){if(!t||Wt(t))return;Yt(t);const n=e.value?.trim()??"";if(!n){Ce(t,"");return}const i=e.getAttribute("list"),a=i?document.getElementById(i):null,o=a?Array.from(a.options):[],c=k(n).toLowerCase(),r=o.find(s=>k(s.value).toLowerCase()===c);if(!r){H(A("technicians.picker.toast.autocompleteNoMatch","⚠️ لم يتم العثور على فني مطابق، الرجاء اختيار من القائمة")),e.value="",Ce(t,"");return}if(r.dataset.disabled==="true"){r.dataset.conflict==="true"?H(A("technicians.picker.optionConflict","⚠️ هذا العضو لديه تعارض في التاريخ/الوقت المحدد")):H(A("technicians.picker.optionTaken","⚠️ لا يمكن اختيار هذا العضو لأنه مرتبط بمنصب آخر")),e.value="";return}const l=r.dataset.id;if(!l){H(A("technicians.picker.toast.autocompleteNoMatch","⚠️ لم يتم العثور على فني مطابق، الرجاء اختيار من القائمة")),e.value="",Ce(t,"");return}Ce(t,l)}function ze(){const e=document.getElementById("crew-position-list");if(!e)return;ye();const t=document.getElementById("crew-position-search"),n=k(String(t?.value||"")).trim().toLowerCase(),a=ce(w).reduce((r,l)=>{const s=l?.positionId!=null?String(l.positionId):null;return s&&r.set(s,(r.get(s)||0)+1),r},new Map),o=J.filter(r=>n?[r.labelAr,r.labelEn,r.name].filter(Boolean).map(s=>k(String(s)).toLowerCase()).join(" ").includes(n):!0);if(!o.length){e.innerHTML=`<div class="text-muted">${A("technicians.picker.noPositions","لا توجد مناصب مطابقة.")}</div>`;return}const c=oe();e.innerHTML=o.map(r=>{const l=fe(r,c)||r.name||"",s=Oe(r,c),u=Le(r.clientPrice||0),d=Le(r.cost||0),g=s?`<span class="crew-position-card__subtitle">${k(s)}</span>`:"",b=A("technicians.picker.positionCostLabel","التكلفة"),h=A("technicians.picker.positionClientPriceLabel","سعر العميل"),N=A("technicians.picker.actions.addPosition","إضافة المنصب"),v=a.get(String(r.id))||0,p=A("technicians.picker.positionCountBadge","مضاف ×{count}").replace("{count}",k(String(v)));return`
      <article class="crew-position-card" data-position-id="${r.id}" tabindex="0" role="button" aria-label="${k(l)}">
        ${v>0?`<span class="crew-position-card__badge" aria-label="${p}">${k(String(v))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">🎯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${k(l)}</h6>
            ${g}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${b}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${h}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary crew-position-add-btn" data-position-id="${r.id}">
            ${N}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(r=>{r.dataset.listenerAttached||(r.addEventListener("click",l=>{l.stopPropagation(),xe(r.dataset.positionId)}),r.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(r=>{r.dataset.cardListenerAttached||(r.addEventListener("click",()=>{xe(r.dataset.positionId)}),r.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),xe(r.dataset.positionId))}),r.dataset.cardListenerAttached="true")})}function xe(e){ye();const t=J.find(a=>String(a.id)===String(e)),n=nt(t||{id:null,name:""}),i=ce(w);i.push(n),ne(w,i),Y(),H(A("technicians.picker.toast.positionAdded","✅ تم إضافة المنصب إلى القائمة"),"success")}function _t(e,t="create"){if(!e)return;const n=ce(t).filter(i=>i.assignmentId!==e);ne(t,n),Y(),H(A("technicians.picker.toast.positionRemoved","🗑️ تم حذف المنصب من القائمة"))}function Ce(e,t){if(!e)return;const n=ce(w),i=n.find(s=>s.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ne(w,n),Y(),H(A("technicians.picker.toast.assignmentCleared","ℹ️ تمت إزالة التعيين من هذا المنصب"));return}if(n.find(s=>s.assignmentId!==e&&s.technicianId===t)){H(A("technicians.picker.duplicateTechnician","⚠️ لا يمكن تعيين نفس الشخص لأكثر من منصب في نفس الحجز")),Y();return}const o=De(t),{start:c,end:r,ignoreReservationId:l}=Ue(w);if(c&&r&&Ke(String(t),c,r,l)){H(A("technicians.picker.optionConflict","⚠️ هذا العضو لديه تعارض في التاريخ/الوقت المحدد")),Y();return}o?(i.technicianId=String(o.id),i.technicianName=o.name??null,i.technicianRole=o.role??null,i.technicianPhone=o.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ne(w,n),Y(),i.technicianName?H(A("technicians.picker.toast.assignmentApplied","✅ تم تعيين {name} على هذا المنصب").replace("{name}",k(i.technicianName)),"success"):H(A("technicians.picker.toast.assignmentIdApplied","✅ تم تعيين العضو المحدد على هذا المنصب"),"success")}async function it(e="create"){w=e,Y(),Ie();let t=Kt();if(!Array.isArray(t)||t.length===0)try{const i=await ft();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(me=t);try{await Qt()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}ye(),ze(),Y(),Ie();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function tn(){return ce(w).map(le)}function nn(){const e=tn(),{start:t,end:n,ignoreReservationId:i}=Ue(w);if(t&&n){const o=e.filter(c=>c.technicianId&&Ke(c.technicianId,t,n,i));if(o.length>0){const c=o.map(l=>l.technicianName||l.technicianId).join(A("reservations.list.crew.separator","، ")),r=A("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",c);o.forEach(l=>{l.technicianId=null,l.technicianName=null}),ne(w,e),Y(),H(r),Ie();return}}ne(w,e);const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a)?.hide?.(),H(A("technicians.picker.toast.selectionApplied","✅ تم حفظ الطاقم بنجاح"),"success")}function ge(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${A("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.")}</span>`;return}ye(),i.innerHTML=t.map(a=>{let o=a.positionLabel??a.position_label??a.position_name??a.role??a.position??"";if(!o||String(o).trim()===""){const d=a.positionId?J.find(b=>String(b.id)===String(a.positionId)):null,g=!d&&a.positionKey?J.find(b=>String(b.name).toLowerCase()===String(a.positionKey).toLowerCase()):null;o=d?fe(d,oe())||d?.name||"":g&&(fe(g,oe())||g?.name)||""}const c=k(o||A("reservations.crew.positionFallback","منصب بدون اسم")),r=a.technicianName?`${k(a.technicianName)}`:A("technicians.picker.noTechnicianOption","— بدون تعيين —");let l=Number(a.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[a.position_client_price,a.client_price,a.customer_price,a.daily_total,a.dailyTotal,a.total];for(const g of d){const b=Number(g);if(Number.isFinite(b)&&b>0){l=b;break}}}if((!Number.isFinite(l)||l<=0)&&(a.positionId||a.positionKey)){const d=a.positionId?J.find(h=>String(h.id)===String(a.positionId)):null,g=!d&&a.positionKey?J.find(h=>String(h.name).toLowerCase()===String(a.positionKey).toLowerCase()):null,b=d||g||null;b&&Number.isFinite(Number(b.clientPrice))&&(l=Number(b.clientPrice))}const s=Le(Number.isFinite(l)&&l>0?l:0),u=A("reservations.crew.removeAria","إزالة");return`
      <span class="technician-chip" data-assignment-id="${a.assignmentId}">
        <span class="technician-chip-name">${c}</span>
        <small class="technician-chip-role">${r}</small>
        <small class="technician-chip-wage">💼 ${s}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${a.assignmentId}" aria-label="${u}">✖</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",()=>{_t(a.dataset.assignmentId,a.dataset.context)}),a.dataset.listenerAttached="true")})}}function an(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",c=>{const r=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),s=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),g=!!(l&&s),b=!!(u&&d),h=!!r;if(!g||!b){c.preventDefault(),H(A("technicians.picker.requireDates","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية أولاً"),"warning");return}if(!h){c.preventDefault(),H(A("technicians.picker.requireCustomer","⚠️ يرجى اختيار العميل أولاً"),"warning");return}it("create")}),e.dataset.listenerAttached="true";const o=()=>{const c=document.getElementById("res-customer")?.value?.trim(),r=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),s=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(c&&r&&l&&s&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(c=>document.getElementById(c)).filter(Boolean).forEach(c=>{["input","change"].forEach(r=>c.addEventListener(r,o))}),o()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>it("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{ze()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",nn),i.dataset.listenerAttached="true");const a=document.getElementById("selectTechniciansModal");a&&!a.dataset.listenerAttached&&window.bootstrap?.Modal&&(a.addEventListener("shown.bs.modal",async()=>{if(!me.length&&(!se().technicians||se().technicians.length===0))try{await ft()}catch(o){console.warn("[crew-picker] fetch on show failed",o)}ze(),Y(),Ie()}),a.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("crew-position-search");o&&(o.value="")}),a.dataset.listenerAttached="true"),ge("selected-technicians-list",ee,"create"),ge("edit-selected-technicians-list",te,"edit")}function Kn({onDraftChange:e,onEditChange:t}={}){yt=typeof e=="function"?e:()=>{},ht=typeof t=="function"?t:()=>{},an()}function on(){return ee.map(le)}function cn(){return te.map(le)}function at(){return ee.map(e=>e.technicianId).filter(Boolean).map(String)}function ot(){return te.map(e=>e.technicianId).filter(Boolean).map(String)}function Qn(e=[]){ne("edit",e)}function On(){ne("create",[])}function Un(){ne("edit",[])}function ct(e=[]){return e.map(t=>{if(t.technicianId){const n=De(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function Gn(e=[]){Array.isArray(e)&&e.length&&(me=e),ee=ct(ee),te=ct(te),ge("selected-technicians-list",ee,"create"),ge("edit-selected-technicians-list",te,"edit"),Y()}function rt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function kt(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=k(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),a=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const o=t.includes(","),c=t.includes(".");if(o&&c){const l=t.lastIndexOf(","),s=t.lastIndexOf(".");l>s?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(o){const l=t.split(",");l.length===2&&l[1].length===3?t=l.join(""):t=t.replace(/,/g,".")}else if(c){const l=t.split(".");if(l.length===2){const[,s]=l;if(s.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(t=u)}}else l.length>2&&(t=rt(t))}if(t=t.replace(/,/g,""),t=rt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const r=Number.parseFloat(t);return Number.isFinite(r)?a?-r:r:Number.NaN}function $(e){return kt(e)}function z(e){const t=kt(e);if(!Number.isFinite(t))return 0;let n=t,i=0;for(;Math.abs(n)>1e5&&i<8;)n/=10,i+=1;return Number(n.toFixed(2))}function _e(e){return k(String(e??"")).trim().toLowerCase()}function Pt(e=""){return k(String(e)).trim().toLowerCase()}const rn=2;function sn(e){const t=$(e);return Number.isFinite(t)?t.toFixed(rn):"0.00"}function st(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(k(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return z(i)}return 1}function ln(e={}){const t=e?.desc||e?.description||e?.name||"",n=Pt(t),i=sn(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function un(e=[]){const t=new Map;return e.forEach((n,i)=>{const a=ln(n);if(!a)return;if(!t.has(a)){const c=n?.desc||n?.description||n?.name||"",r=Pt(c),l=ut(n),s=n?.image||n?.imageUrl||n?.img||"";t.set(a,{key:a,description:c,normalizedDescription:r,unitPrice:l,image:s,items:[],itemIndices:[],barcodes:[]})}const o=t.get(a);o.items.push(n),o.itemIndices.push(i),n?.barcode&&o.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,a)=>i+st(a),0)})).map(n=>{const i=n.quantity||0,a=n.items.reduce((s,u)=>{const d=ut(u),g=st(u);return s+d*g},0),o=z(a),c=$(n.unitPrice),r=Number.isFinite(c)?c:0,l=i>0?z(o/i):z(r);return{...n,quantity:i,count:i,totalPrice:o,unitPrice:l}})}function lt(e={}){return(ke(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??_e(n?.barcode),qty:(()=>{const i=Number.parseFloat(k(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:(()=>{const i=Number.parseFloat(k(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),price:(()=>{const i=$(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})()}))}function Me(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(k(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function dn(e={},t=[],n=null){try{const s=pe(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(s){const u=findPackageById(s);if(u){const d=u.price??u.total_price??u.package_price,g=$(d);if(Number.isFinite(g)&&g>0)return z(g)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,a=$(i);if(Number.isFinite(a)&&a>0)return z(a);const o=e.total_price??e.totalPrice??e.total,c=$(o),r=Number.parseFloat(k(String(n)).replace(/[^0-9.]/g,"")),l=Number.isFinite(r)&&r>0?r:Me(e);return Number.isFinite(c)&&c>0&&l>0?z(c/l):0}function pn(e={}){const t=Array.isArray(e?.items)?e.items:[],n=un(t),i=Qe(),a=new Set,o=new Map;i.forEach(p=>{const f=pe(p?.id??p?.packageId??p?.package_id??p?.code);f&&a.add(f);const S=k(String(p?.package_code??p?.code??"")).trim().toLowerCase();S&&o.set(S,f||S)});const c=(p,f=0)=>{const S=pe(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),P=k(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return S||(P&&o.has(P)?o.get(P):P||`pkg-${f}`)},r=new Map,l=(p,f=0,S="packages")=>{if(!p||typeof p!="object")return;const _=c(p,f)||`pkg-${f}`;if(!r.has(_)){r.set(_,{source:p,normalizedId:_,index:f,itemSource:S==="items"?p:null});return}const y=r.get(_);if(y.source||(y.source=p),S==="items"&&(y.itemSource=p,y.source&&typeof y.source=="object")){const q=Array.isArray(y.source.packageItems)&&y.source.packageItems.length>0,C=Array.isArray(p.packageItems)&&p.packageItems.length>0;!q&&C&&(y.source={...y.source,packageItems:p.packageItems}),!y.source.image&&p.image&&(y.source={...y.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,f)=>l(p,f,"packages")),t.forEach((p,f)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const S=c(p,f+r.size);l({...p,package_id:S,packageId:S,package_code:p.package_code??p.code},f+r.size,"items")}});const s=[],u=new Set,d=new Set;r.forEach(({source:p,itemSource:f=null,normalizedId:S},P)=>{const _=p||{},y=f&&typeof f=="object"?f:null;let q=lt(_);(!Array.isArray(q)||q.length===0)&&y&&(q=lt(y)),q.forEach(L=>{const E=L?.normalizedBarcode??_e(L?.barcode);E&&u.add(E);const G=L?.equipmentId??L?.equipment_id??null;G!=null&&d.add(String(G))});let C=Me(_);if(y){const L=Me(y);Number.isFinite(L)&&L>0&&(C=L)}(!Number.isFinite(C)||C<=0)&&(C=1);let D=dn(_,q,C);const U=[y?.price,y?.unit_price,y?.unitPrice];for(const L of U){const E=$(L);if(Number.isFinite(E)&&E>0){D=z(E);break}}D=z(D);const K=(()=>{const L=[_?.pricing_mode,_?.pricingMode,_?.pricing,y?.pricing_mode,y?.pricingMode,y?.pricing];for(const E of L){if(E==null)continue;const G=String(E).trim().toLowerCase();if(G==="daily"||G==="per_day"||G==="day")return"daily";if(G==="fixed"||G==="per_booking"||G==="booking")return"fixed"}return"daily"})(),B=[y?.total,y?.total_price,y?.totalPrice,_?.total,_?.total_price,_?.totalPrice];let j=NaN;for(const L of B){const E=$(L);if(Number.isFinite(E)&&E>=0){j=E;break}}Number.isFinite(j)||(j=D*C),j=z(j);const W=[_?.package_code,_?.code,_?.packageCode,_?.displayCode,_?.display_code,_?.barcode,y?.package_code,y?.code,y?.packageCode,y?.displayCode,y?.display_code,y?.barcode,S,P].find(L=>L==null?!1:String(L).trim().length>0),I=W!=null?k(String(W)).trim():"";if(I){const L=_e(I);L&&u.add(L)}const F=q.map(L=>k(String(L?.barcode??L?.normalizedBarcode??""))).filter(Boolean),Q=[_?.name,_?.package_name,_?.title,y?.name,y?.desc,y?.package_name,I,k(String(P))].find(L=>L!=null&&String(L).trim()!=="")||k(String(I||P)),X=q.find(L=>L?.image)?.image??_?.image??y?.image??null,R=1;s.push({key:`package::${P}`,description:Q,normalizedDescription:k(String(Q)),unitPrice:D,totalPrice:j,pricingMode:K,quantity:C,count:R,image:X,barcodes:F,barcode:I,package_code:I,packageDisplayCode:I,items:[{type:"package",packageItems:q,packageId:S,desc:Q,price:D,qty:R,barcode:I}],type:"package",packageItems:q,packageId:S})});const g=new Set(Array.from(u).map(p=>_e(p)).filter(Boolean)),b=n.filter(p=>{if(p.items.some(_=>_?.type==="package")&&s.length>0)return!1;const S=(_={})=>[_.packageId,_.package_id,_.package_code,_.packageCode,_.bundleId,_.bundle_id].some(y=>y!=null&&y!=="");return!p.items.every(_=>{const y=mn(_),q=y!=null?String(y):null;if(q&&d.has(q))return!0;const C=_?.barcode?_e(_.barcode):null;return!!(C&&g.has(C)||S(_))})}),h=new Set,N=[];return s.forEach(p=>{const f=c({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!f||h.has(f)||(h.add(f),N.push(p))}),{groups:N.length?[...N,...b]:n,packageGroups:s,groupedItems:n,filteredGroupedItems:b,packagesMap:r}}function mn(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function ut(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=$(n);if(Number.isFinite(i))return i}return 0}function Wn(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function fn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":case"ملغية":case"ملغى":case"canceled":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function Yn(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,a=i!=null&&i!==""&&i!=="null",o=a?fn(t?.status??t?.status_label??t?.statusLabel??""):null,c=a&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:n,projectLinked:a,projectStatus:o,projectConfirmed:c,effectiveConfirmed:a?c:n}}const It=10;function At(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=$(n);if(Number.isFinite(i))return z(i)}return 0}function gn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=$(n);if(Number.isFinite(i))return z(i)}return At(e)}function yn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=se();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,a)=>{const o=n.get(String(a));if(!o)return i;const c=At(o),r=gn(o);return{costPerDay:i.costPerDay+(Number.isFinite(c)?c:0),totalPerDay:i.totalPerDay+(Number.isFinite(r)?r:0)}},{costPerDay:0,totalPerDay:0})}const hn=1440*60*1e3,de=.01;function ue(e){if(e==null||e==="")return null;const t=k(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function dt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let a=Number.isFinite(e)?e:0;if(a<t&&(a=t),a>n&&(a=n),i!=null){const o=10**i;a=Math.round(a*o)/o}return a}function Nt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function Ge({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:a=null,history:o=[]}={}){const c=Number.isFinite(Number(e))?Number(e):0,r=t==="amount"?"amount":t==="percent"?"percent":null;let l=ue(i),s=ue(a);const u=ue(n);let d=0,g=0;Array.isArray(o)&&o.length&&o.forEach(f=>{if(!f)return;const S=f.type==="amount"||f.type==="percent"?f.type:null,P=ue(f.value),_=ue(f.amount),y=ue(f.percentage);if(S==="amount"){const q=_??P;q!=null&&(d+=q,c>0&&(g+=q/c*100))}else if(S==="percent"){const q=y??P;q!=null&&(g+=q,c>0&&(d+=q/100*c))}else _!=null&&(d+=_,c>0&&(g+=_/c*100)),y!=null&&(g+=y,c>0&&(d+=y/100*c))});function b(f=[]){return!Array.isArray(f)||f.length===0?{costPerDay:0,totalPerDay:0}:f.reduce((S,P)=>{const _=$(P?.positionCost??P?.position_cost??P?.cost??P?.dailyWage??P?.daily_wage??0),y=$(P?.positionClientPrice??P?.position_client_price??P?.clientPrice??P?.dailyTotal??P?.daily_total??P?.total??0),q=Number.isFinite(_)?_:0,C=Number.isFinite(y)?y:0;return{costPerDay:S.costPerDay+q,totalPerDay:S.totalPerDay+C}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=b),r==="amount"&&u!=null?l=u:r==="percent"&&u!=null?s=u:r===null&&u!=null&&(s!=null?s=u:l=u),(l==null||l<=0)&&s!=null&&s>0&&c>0&&(l=c*(s/100)),(s==null||s<=0)&&l!=null&&l>0&&c>0&&(s=l/c*100);const h=l??0,N=s??0;l=h+d,s=N+g,l=dt(l??0,{min:0,max:c>0?c:Number.POSITIVE_INFINITY,precision:2}),s=dt(s??0,{min:0,max:100,precision:2});let v=r;return v||(l>0&&c>0?v="amount":s>0&&(v="percent")),{paidAmount:l,paidPercent:s,paymentProgressType:v,paymentProgressValue:v==="amount"?l:v==="percent"?s:null}}function We({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const a=Nt(e),o=Number.isFinite(Number(i))?Number(i):0,c=Number.isFinite(Number(t))?Number(t):0,r=Number.isFinite(Number(n))?Number(n):0;if(a==="paid")return"paid";const l=o>0&&c>=o-de,s=r>=100-de*100;if(l||s)return"paid";const u=c>de||r>de;return a==="partial"||u?"partial":"unpaid"}function bn(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const a=i.getTime()-n.getTime();if(a<=0)return 1;const o=a/hn;return Math.max(1,Math.ceil(o))}function he({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:a="percent",applyTax:o=!1,start:c=null,end:r=null,companySharePercent:l=null}={}){const s=bn(c,r);let u=!1;try{if(typeof window<"u"&&window.location){const I=new URL(window.location.href),F=(I.searchParams.get("noDays")||I.searchParams.get("pricing")||"").toLowerCase();u=F==="1"||F==="true"||F==="fixed"||F==="nodays"}}catch{}const{groups:d}=pn({items:Array.isArray(e)?e:[]}),g=I=>{if((I?.type||"").toLowerCase()==="package")return!0;const F=Array.isArray(I?.items)?I.items:[];if(!F.length)return!1;if(F.some(R=>R?.reservation_id!=null||R?.reservationId!=null))return!0;const Q=F.every(R=>R?.unit_price!=null||R?.unitPrice!=null),X=F.some(R=>R?.daily_rate!=null||R?.dailyRate!=null||R?.unit_rate!=null||R?.unitRate!=null||R?.price!=null);return!!(Q&&!X)};let b=0,h=0;(Array.isArray(d)?d:[]).forEach(I=>{const F=Number.isFinite(Number(I?.quantity))?Number(I.quantity):0,x=Number.isFinite(Number(I?.unitPrice))?Number(I.unitPrice):0,Q=String(I?.type||"").toLowerCase()==="package",X=String(I?.pricingMode||"").toLowerCase(),R=g(I);u?h+=F*x:Q?X==="fixed"?h+=F*x:b+=F*x:R?h+=F*x:b+=F*x});const N=z(b*s+h),v=Array.isArray(n)?n:[],p=v.length?v.map(I=>I?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:f,totalPerDay:S}=v.length?v.reduce((I,F)=>{const x=$(F?.positionCost??F?.position_cost??F?.cost??F?.dailyWage??F?.daily_wage??0),Q=$(F?.positionClientPrice??F?.position_client_price??F?.clientPrice??F?.dailyTotal??F?.daily_total??F?.total??0),X=Number.isFinite(x)?x:0,R=Number.isFinite(Q)?Q:0;return{costPerDay:I.costPerDay+X,totalPerDay:I.totalPerDay+R}},{costPerDay:0,totalPerDay:0}):yn(p),P=z(S*s),_=z(f*s),y=z(N+P),q=Number(i)||0;let C=a==="amount"?q:y*(q/100);(!Number.isFinite(C)||C<0)&&(C=0),C>y&&(C=y);const D=Math.max(0,y-C),U=Number.isFinite(l)&&Number(l)>0?Number(l):0,m=U>0?Math.max(0,D*(U/100)):0,K=D+m;let B=o?K*.15:0;(!Number.isFinite(B)||B<0)&&(B=0),B=Number(B.toFixed(2));const j=K+B,V=Math.max(0,Number(j.toFixed(2))),W=Math.max(0,Math.max(0,N+P-C)-_);return{rentalDays:s,equipmentTotal:N,crewTotal:P,crewCostTotal:_,discountAmount:C,subtotalAfterDiscount:D,taxableAmount:K,taxAmount:B,finalTotal:V,companySharePercent:U,companyShareAmount:m,netProfit:W}}function Jn(e=[],t=0,n="percent",i=!1,a=[],{start:o=null,end:c=null,companySharePercent:r=null}={}){const l=b=>b&&typeof b=="object"&&(b.positionId!==void 0||b.position_id!==void 0||b.positionLabel!==void 0||b.position_name!==void 0||b.positionClientPrice!==void 0),s=Array.isArray(a)&&a.some(l)?a:[],u=s.length?s.map(b=>b?.technicianId).filter(Boolean):Array.isArray(a)?a:[];return he({items:e,technicianIds:u,crewAssignments:s,discount:t,discountType:n,applyTax:i,start:o,end:c,companySharePercent:r??It}).finalTotal}function St({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:a,paymentStatus:o,paidAmount:c=0,paidPercent:r=0,companySharePercent:l=null,companyShareAmount:s=null,taxAmount:u=null,netProfit:d=null,totalKey:g="reservations.summary.total",equipmentTotal:b=null,crewTotal:h=null}){const N=A("reservations.create.summary.currency","SR"),v=k(String(e)),p=k(String(t)),f=k(String(n??1)),S=k(String(i)),P=Nt(o),_=P==="paid"?"مدفوع":P==="partial"?"مدفوع جزئياً":"غير مدفوع",y=A(`reservations.create.paymentStatus.${P}`,_),q=Number.isFinite(Number(c))?Math.max(0,Number(c)):0,C=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,D=q>de||C>de,U=A("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),m=k(q.toFixed(2)),K=k(C.toFixed(C%1?2:0)),B=A("reservations.summary.itemsLabel","📦 عدد المعدات"),j=A("reservations.summary.durationLabel","⏱️ عدد الأيام"),V=A("reservations.summary.crewLabel","😎 عدد الفريق"),W=A("reservations.details.labels.itemsTotal","💼 إجمالي المعدات"),I=A("reservations.details.labels.crewTotal","😎 إجمالي الفريق"),F=A("reservations.summary.taxLabelShort","🧾 الضريبة"),x=A("reservations.summary.paymentLabelShort","💳 حالة الدفع"),Q=A(g.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),X=A("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),R=A("reservations.details.labels.netProfit","💵 صافي الربح"),L=Number.isFinite(d)?Math.max(0,Number(d)):null,E=[{label:B,value:p},{label:j,value:f},{label:V,value:S}],G=Number.isFinite(Number(b))?Math.max(0,Number(b)):null;G!=null&&E.push({label:W,value:`${k(G.toFixed(2))} ${N}`});const tt=Number.isFinite(Number(h))?Math.max(0,Number(h)):null;if(tt!=null&&E.push({label:I,value:`${k(tt.toFixed(2))} ${N}`}),a){let Z=A("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(u)&&u>0&&(Z=`${k(Number(u).toFixed(2))} ${N}`),E.push({label:F,value:Z})}const Se=Number.isFinite(l)?Number(l):null;if(Se!==null&&Se>0){const Z=Number.isFinite(s)?Number(s):e*(Se/100),be=k(String(Se)),zt=k(Number.isFinite(Z)?Z.toFixed(2):"0"),Mt=`${be}% (${zt} ${N})`;E.push({label:X,value:Mt})}if(L!==null&&Math.abs(L-Number(e))>.009){const Z=k(L.toFixed(2));E.push({label:R,value:`${Z} ${N}`})}E.push({label:x,value:y}),D&&E.push({label:U,value:`${m} ${N} (${K}%)`});const wt=`${v} ${N}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${E.map(({label:Z,value:be})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${Z}</span>
            ${be?`<span class="reservation-summary-value">${be}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${Q}</span>
          <span class="reservation-summary-value">${wt}</span>
        </div>
      </div>
    </div>
  `}function _n({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:o=null,paymentProgressValue:c=null,start:r,end:l,companySharePercent:s=null,paymentHistory:u=[]}){const d=on(),g=typeof at=="function"?at()??[]:[],b=Array.isArray(g)?g.map(String):[],h=d.length?d.map(y=>y?.technicianId).filter(Boolean).map(String):b,N=d.length||h.length,v=Number.isFinite(s)?Number(s):null,p=he({items:e,technicianIds:h,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:r,end:l,companySharePercent:v}),f=Ge({totalAmount:p.finalTotal,progressType:o,progressValue:c,history:u}),S=We({manualStatus:a,paidAmount:f.paidAmount,paidPercent:f.paidPercent,totalAmount:p.finalTotal}),P=St({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:N,applyTax:i,paymentStatus:S,paidAmount:f.paidAmount,paidPercent:f.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal}),_={paymentStatus:S,paidAmount:f.paidAmount,paidPercent:f.paidPercent,paymentProgressType:f.paymentProgressType,paymentProgressValue:f.paymentProgressValue,total:p.finalTotal};return _n.lastResult=_,Pn(P),P}function kn({items:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:o=null,paymentProgressValue:c=null,start:r,end:l,companySharePercent:s=null,paymentHistory:u=[]}){const d=cn(),g=typeof ot=="function"?ot()??[]:[],b=Array.isArray(g)?g.map(String):[],h=d.length?d.map(y=>y?.technicianId).filter(Boolean).map(String):b,N=d.length||h.length,v=Number.isFinite(s)?Number(s):null,p=he({items:e,technicianIds:h,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:r,end:l,companySharePercent:v}),f=Ge({totalAmount:p.finalTotal,progressType:o,progressValue:c,history:u}),S=We({manualStatus:a,paidAmount:f.paidAmount,paidPercent:f.paidPercent,totalAmount:p.finalTotal}),P=St({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:N,applyTax:i,paymentStatus:S,paidAmount:f.paidAmount,paidPercent:f.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal}),_={html:P,paymentStatus:S,paidAmount:f.paidAmount,paidPercent:f.paidPercent,paymentProgressType:f.paymentProgressType,paymentProgressValue:f.paymentProgressValue,total:p.finalTotal};return kn.lastResult=_,P}function Pn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,pt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,pt(n,e))}function pt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const In=se()||{};let ie=(In.reservations||[]).map(Tt);function re(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const vt="__reservation_packages_cache__";function Ct(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function qt(){const e=Ct();if(!e)return{};try{const t=e.getItem(vt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function mt(e){const t=Ct();if(t)try{t.setItem(vt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function An(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=Qe();if(!Array.isArray(t)||t.length===0)return[];const n=new Map;e.forEach(a=>{if(!a||typeof a!="object")return;const o=a.equipmentId??a.equipment_id??a.id??null;if(o==null)return;const c=String(o),r=(()=>{const l=[a.qty,a.quantity,a.count,1];for(const s of l){const u=Number(s);if(Number.isFinite(u)&&u>0)return u}return 1})();n.set(c,(n.get(c)||0)+r)});const i=[];return t.forEach((a,o)=>{const c=ke(a)||[],r=new Map;let l=!0;if(c.forEach(h=>{const N=h?.equipmentId??h?.equipment_id??null,v=Number.isFinite(Number(h?.qty))&&Number(h.qty)>0?Number(h.qty):1;if(N==null){l=!1;return}const p=String(N);r.set(p,(r.get(p)||0)+v)}),!l||r.size===0)return;let s=1/0;for(const[h,N]of r.entries()){const v=n.get(h)||0,p=Math.floor(v/N);if(p<=0){s=0;break}p<s&&(s=p)}if(!Number.isFinite(s)||s<=0)return;for(const[h,N]of r.entries()){const v=n.get(h)||0;n.set(h,Math.max(0,v-s*N))}const u=pe(a?.id??a?.packageId??a?.package_id??a?.code),d=Array.from(r.entries()).map(([h,N])=>({equipment_id:/^\d+$/.test(h)?Number(h):h,quantity:N,unit_price:0})),g=(a?.package_code??a?.code??u)||`pkg-${o}`,b=Ut(a)||u||`package-${o}`;i.push({package_code:g,name:b,quantity:s,unit_price:gt(a)||0,items:d})}),i}function Nn(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,a=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",o=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,c=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return i||a||o||c})}function Sn(e){return[]}function Ft(e=[]){return Array.isArray(e)?e.map((t,n)=>Bt(t,n)).filter(Boolean).map((t,n)=>{const i=pe(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),a=Te(t,i).map(s=>{const u=M(s.qty??s.quantity??s.count??s.units??s.unit_qty??s.unitQty??s.unit_count??s.unitCount??s.package_quantity??s.packageQty??1),d=re(T(s.price??s.unit_price??0));return{...s,qty:u,quantity:u,price:d,unit_price:d}}),o=M(t.quantity??t.qty??1);let c=re(T(t.unit_price??t.unitPrice??t.price??0));if(!c||c<=0){const s=a.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);s>0&&o>0&&(c=re(Number((s/o).toFixed(2))))}const r=T(t.total_price??t.totalPrice??t.total??c*o),l=r>0?re(r):re(Number((c*o).toFixed(2)));return{...t,packageId:i,package_id:i,qty:o,quantity:o,unit_price:c,unitPrice:c,price:c,total_price:l,total:l,packageItems:a}}):[]}function Ae(e,t){if(!e)return;const n=qt(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],mt(n));return}n[i]=Ft(t),mt(n)}function vn(e){if(!e)return[];const t=qt(),n=String(e),i=t[n];return Array.isArray(i)?Ft(i):[]}function Ye(e,t=0){if(e==null)return null;if(typeof e!="object"){const S=e!=null?String(e):null;return{assignmentId:`crew-${t}-${S??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:S,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,a=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,o=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let c=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";c||(c=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const r=e.position_label_ar??null,l=e.position_label_en??null,s=e.position_label_alt??l??r??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,g=re($(u)),b=re($(d)),h=e&&typeof e.technician=="object"?e.technician:null,N=e.technician_id??e.technicianId??e.id??h?.id??e.userId??e.user_id??null,v=e.technician_name??e.technicianName??e.name??h?.name??e.full_name??null,p=e.role??h?.role??e.specialization??null,f=e.technician_phone??h?.phone??e.phone??null;return{assignmentId:String(n),positionId:a!=null?String(a):null,positionKey:o!=null?String(o):null,positionLabel:c!=null?String(c):"",positionLabelAlt:s!=null?String(s):"",positionLabelAr:r!=null?String(r):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(g)?g:0,positionClientPrice:Number.isFinite(b)?b:0,technicianId:N!=null?String(N):null,technicianName:v!=null?String(v):null,technicianRole:p!=null?String(p):null,technicianPhone:f!=null?String(f):null,notes:e.notes??null}}function Cn(){return ie}function Ne(e){ie=Array.isArray(e)?e.map($e):[],ie.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Ae(n,t.packages);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];Nn(i)}),jt({reservations:ie});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return ie}async function qn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,l])=>{l!=null&&l!==""&&t.set(r,String(l))});const n=t.toString(),a=(await Ee(`/reservations/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(a)?o=a:a&&typeof a=="object"&&(Array.isArray(a.items)?o=a.items:Array.isArray(a.results)?o=a.results:Array.isArray(a.data)?o=a.data:Array.isArray(a.records)&&(o=a.records));const c=o.map(Re);return Ne(c)}async function Fn(e){const t=await Ee("/reservations/",{method:"POST",body:e}),n=Re(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const i=Je(e.payment_history);i.length&&(n.paymentHistory=i)}if((!Array.isArray(n.crewAssignments)||n.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const i=e.technicians.map((a,o)=>Ye(a,o)).filter(Boolean);i.length&&(n.crewAssignments=i,n.techniciansDetails=i.map((a,o)=>{const c=e.technicians[o];return typeof c=="object"?{...c,...a}:a}))}if(Array.isArray(e?.packages)&&e.packages.length){const i=et({packages:e.packages});n.packages=ae(n.packages,i)}{const i=Ze(n.items||[],n.packages||[]);n.items=i.items,n.packages=ae(n.packages||[],i.packages)}if(Ae(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const i=he({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=i.companyShareAmount,n.cost=i.finalTotal,n.totalAmount=i.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Ne([...ie,n]),n}async function Lt(e,t){const n=await Ee(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=Re(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const o=Je(t.payment_history);o.length&&(i.paymentHistory=o,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const o=t.technicians.map((c,r)=>Ye(c,r)).filter(Boolean);o.length&&(i.crewAssignments=o,i.techniciansDetails=o.map((c,r)=>{const l=t.technicians[r];return typeof l=="object"?{...l,...c}:c}))}if(Array.isArray(t?.packages)&&t.packages.length){const o=et({packages:t.packages});i.packages=ae(i.packages,o)}{const o=Ze(i.items||[],i.packages||[]);i.items=o.items,i.packages=ae(i.packages||[],o.packages)}if(Ae(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const o=he({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=o.companyShareAmount,i.cost=o.finalTotal,i.totalAmount=o.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const a=ie.map(o=>String(o.id)===String(e)?i:o);return Ne(a),i}async function Ln(e){await Ee(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=ie.filter(n=>String(n.id)!==String(e));Ne(t),Ae(e,null)}async function Tn(e){return Lt(e,{status:"confirmed",confirmed:!0})}function Re(e={}){return $e({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function Tt(e={}){return $e(e)}function $e(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(Et):[],a=et(e);const o=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let c=o.map((I,F)=>Ye(I,F)).filter(Boolean),r=c.map((I,F)=>{const x=o?.[F];return{...x&&typeof x=="object"?{...x}:x!=null?{id:x}:{},...I}});const l=c.map(I=>I.technicianId).filter(I=>I!=null&&I!=="").map(I=>Number.isNaN(Number(I))?String(I):Number(I)),s=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=T(e.total_amount??e.totalAmount??e.cost??0);const g=T(e.discount??0),b=e.discount_type??e.discountType??"percent",h=["percent","amount"].includes(b)?b:"percent",N=!!(e.apply_tax??e.applyTax??!1);let v=Mn(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),f=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,S=f!=null?Number.parseFloat(k(String(f).replace("%","").trim())):NaN,P=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let _=P!=null?P===!0||P===1||P==="1"||String(P).toLowerCase()==="true":Number.isFinite(S)&&S>0,y=_&&Number.isFinite(S)?Number(S):0;const q=e.company_share_amount??e.companyShareAmount;let C=Number.isFinite(Number(q))?Number(q):NaN;N&&y<=0&&(y=It,_=!0);const D=he({items:i,technicianIds:l,crewAssignments:c,discount:g,discountType:h,applyTax:N,start:s,end:u,companySharePercent:y>0?y:null});(!Number.isFinite(d)||d<=0||N)&&(d=D.finalTotal),(!Number.isFinite(C)||C<0)&&(C=D.companyShareAmount),C=Number.isFinite(C)?Number(C.toFixed(2)):0,!_&&y>0&&(_=!0);const U=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],m=Dn(U),K=Je(m),B=t??n??e.reservation_code??e.reservationId??null;if(a.length)Ae(B,a);else{const I=vn(B);I.length&&(a=ae(a,I))}if(!a.length&&Array.isArray(i)&&i.length)try{const I=An(i);Array.isArray(I)&&I.length&&(a=ae(a,I))}catch(I){console.warn("[reservationsService] inference of packages from items failed",I)}const j=Ze(i,a);i=j.items,a=ae(a,j.packages);const V=Ge({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:K});v=We({manualStatus:v,paidAmount:V.paidAmount,paidPercent:V.paidPercent,totalAmount:d});const W=v==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:s,end:u,status:zn(e.status??(p?"confirmed":"pending")),confirmed:p,location:e.location??"",notes:e.notes??"",discount:g,discountType:h,applyTax:N,paid:W,paidStatus:v,paidAmount:V.paidAmount,paidPercent:V.paidPercent,paymentProgressType:V.paymentProgressType,paymentProgressValue:V.paymentProgressValue,paymentHistory:K,payment_history:K,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:c,techniciansDetails:r,startDatetime:s,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:a,companySharePercent:y,companyShareAmount:C,companyShareEnabled:_}}function Et(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=T(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),a=k(String(e.barcode??e.code??e.serial??"")),o=e.description??e.desc??e.name??e.title??"",c={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:a,desc:o,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},r=Dt(e.type??e.item_type??e.kind??null),l=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,s=O(l),u=Te(e,s);if(r==="package"||s||u.length){c.type="package";const d=s||(t!=null?String(t):c.id?O(c.id):"");d&&(c.packageId=d,c.package_id=d,c.package_code=e.package_code??e.packageCode??d),c.name=o||c.package_code||d||"",c.barcode=c.barcode||k(String(e.package_code??e.packageCode??"")),c.packageItems=u;const g=$t({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},u,n);(!Number.isFinite(c.price)||c.price<=0||c.price>g*10)&&(c.price=g),c.qtyPerPackage=u.length?u[0]?.qtyPerPackage??c.qtyPerPackage:c.qtyPerPackage,c.totalQuantity=n}return c}function En({reservationCode:e,customerId:t,start:n,end:i,status:a,title:o,location:c,notes:r,projectId:l,totalAmount:s,discount:u,discountType:d,applyTax:g,paidStatus:b,confirmed:h,items:N,packages:v,crewAssignments:p=[],technicians:f=p,companySharePercent:S,companyShareEnabled:P,paidAmount:_,paidPercentage:y,paymentProgressType:q,paymentProgressValue:C,paymentHistory:D}){const U=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:a??"pending",title:o??null,location:c??null,notes:r??null,project_id:l||null,total_amount:s??0,discount:u??0,discount_type:d??"percent",apply_tax:g?1:0,paid_status:b??"unpaid",paid_amount:Number.isFinite(_)?T(_):0,paid_percentage:Number.isFinite(y)?Number(y.toFixed(2)):0,payment_progress_type:q??null,payment_progress_value:Number.isFinite(C)?Number(C.toFixed(2)):null,payment_history:Array.isArray(D)?D.map(m=>({type:je(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?T(m.value):null,amount:m?.amount!=null?T(m.amount):m?.payment_amount!=null?T(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],payments:Array.isArray(D)?D.map(m=>({type:je(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?T(m.value):null,amount:m?.amount!=null?T(m.amount):m?.payment_amount!=null?T(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],confirmed:h===void 0?null:!!h,items:Rn(N),packages:$n(N,v),company_share_percent:P&&Number.isFinite(S)?Number(S):null,company_share_enabled:P?1:0,technicians:U.length?U.map((m,K)=>{const B=m.technicianId??m.technician_id??m.id??null,j=m.positionId??m.position_id??m.position??m.position_code??null,V=m.positionLabel??m.position_name??m.role??null,W=T(m.positionCost??m.position_cost??m.cost??m.daily_wage??m.dailyWage??0),I=T(m.positionClientPrice??m.position_client_price??m.client_price??m.clientPrice??m.daily_total??m.dailyTotal??m.total??0);return{id:B,technician_id:B,role:V??m.technicianRole??null,notes:m.notes??null,position_id:j,position_key:m.positionKey??m.position_key??null,position_name:V,position_label_ar:m.positionLabelAr??m.position_label_ar??null,position_label_en:m.positionLabelEn??m.position_label_en??null,position_cost:W,position_client_price:I,client_price:I,cost:W,assignment_id:m.assignmentId??m.assignment_id??`crew-${K}`}}):Array.isArray(f)?f.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function Je(e){const t=Xe(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,a=je(i),o=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,c=o!=null?Number.parseFloat(k(String(o))):null,r=n.amount!=null?Number.parseFloat(k(String(n.amount))):n.payment_amount!=null?Number.parseFloat(k(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(k(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(k(String(n.payment_percentage))):null,s=Number.isFinite(r)?r:a==="amount"&&Number.isFinite(c)?c:null,u=Number.isFinite(l)?l:a==="percent"&&Number.isFinite(c)?c:null,d=a??(s!=null?"amount":u!=null?"percent":null),g=d==="amount"?s:d==="percent"?u:Number.isFinite(c)?c:null,b=n.note??n.notes??n.comment??n.payment_note??null,h=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:g,amount:s,percentage:u,note:b,recordedAt:h}}).filter(n=>n&&n.type)}function je(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Xe(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const c of t)if(Array.isArray(e[c]))return e[c];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(c=>Array.isArray(c));if(Array.isArray(i))return i;const a=Object.values(e);if(a.length&&a.every(c=>c&&typeof c=="object")){const c=a.map(r=>r);if(c.every(r=>!Array.isArray(r)))return c}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(c=>c in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Xe(t)}catch{return[]}return[]}function Dn(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Xe(t);if(Array.isArray(n)&&n.length)return n}return[]}function Rn(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const a=M(n.qty??n.quantity??1);n.packageItems.forEach(o=>{const c=o?.equipmentId??o?.equipment_id??o?.id??null;if(c==null)return;const r=M(o?.qty??o?.quantity??1),l=a*r;t.push({equipment_id:He(c),quantity:l,unit_price:T(o?.price??o?.unit_price??0),notes:o?.notes??null})});return}const i=n.equipmentId??n.equipment_id??n.id??null;i!=null&&t.push({equipment_id:He(i),quantity:M(n.qty??n.quantity??1),unit_price:T(n.price??n.unit_price??0),notes:n.notes??null})}),t}function He(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function $n(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const a=M(i.qty??i.quantity??1),o=Array.isArray(i.packageItems)?i.packageItems.map(c=>{const r=c?.equipmentId??c?.equipment_id??c?.id??null;return r==null?null:{equipment_id:He(r),quantity:M(c?.qty??c?.quantity??c?.count??c?.units??c?.unit_qty??c?.unitQty??c?.unit_count??c?.unitCount??c?.package_quantity??c?.packageQty??1),unit_price:T(c?.price??c?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:a,unit_price:T(i.price??i.unit_price??0),items:o})}),n}function Dt(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function O(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return pe(t)}function Ve(e){return e==null?"":k(String(e)).trim().toLowerCase()}function Rt(e={},t=1){if(!e||typeof e!="object"){const l=k(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:l,normalizedBarcode:Ve(l),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=T(e.unit_price??e.unitPrice??e.price??0),o=k(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),c=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let r;if(c!=null)r=M(c,{fallback:1,max:99});else if(t>0){const l=i/t;Number.isFinite(l)&&l>0&&Number.isInteger(l)?r=M(l,{fallback:1,max:99}):r=Math.min(i,99)}else r=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:r,quantity:r,qtyPerPackage:r,totalQuantity:i,price:a,unit_price:a,barcode:o,normalizedBarcode:Ve(e.normalizedBarcode??o),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function xn(e={},t={}){const n=O(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=M(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=T(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),o=k(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:o,desc:t.desc??t.description??e.name??e.desc??e.title??o,qty:i,quantity:i,price:a,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:o,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function Ze(e=[],t=[]){const n=Bn(e),i=Array.isArray(t)?ae(t,n.packages):n.packages,a=new Map;return i.forEach(o=>{const c=O(o.packageId??o.package_id??o.id);c&&a.set(c,o)}),n.packages.forEach(o=>{const c=O(o.packageId??o.package_id??o.id);if(!c)return;const r=a.get(c);r&&((!Array.isArray(r.packageItems)||r.packageItems.length===0)&&(r.packageItems=o.packageItems),!r.name&&o.name&&(r.name=o.name),!r.image&&o.image&&(r.image=o.image))}),{items:n.items,packages:Array.from(a.values())}}function Bn(e=[]){const t=new Map;if(e.forEach(o=>{const c=O(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(!c)return;const r=c;t.has(r)||t.set(r,{base:o,items:[]}),t.get(r).items.push(o)}),!t.size)return{items:e,packages:[]};const n=[],i=[],a=new Set;return e.forEach(o=>{const c=O(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(c&&t.has(c)){if(a.has(c))return;const r=t.get(c),l=r.base||o,s=r.items.map(d=>Rt(d,1)),u={packageId:c,package_id:c,package_code:l.package_code??l.packageCode??l.barcode??k(String(c)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${c}`,quantity:M(l.package_quantity??l.packageQty??1,{fallback:1,max:9999}),unit_price:T(l.package_price??l.packagePrice??l.price??0),packageItems:s,image:l.image??null};i.push(u),n.push(xn(u,l)),a.add(c);return}n.push(o)}),{items:n,packages:i}}function Te(e={},t=""){if(!e||typeof e!="object")return[];const n=O(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let a=ke({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),o=[];if((!Array.isArray(a)||a.length===0)&&n){const s=Fe(n);s&&(a=ke(s),o=Array.isArray(a)?a:[])}else if(n){const s=Fe(n);s&&(o=ke(s)||[])}if(!Array.isArray(a)||a.length===0)return[];const c=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),r=a.map(s=>Rt(s,c));if(o.length){const s=new Map;o.forEach(u=>{if(!u)return;const d=Ve(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&s.set(d,u)}),r.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!s.has(d))return;const g=s.get(d),b=M(g.quantity??g.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=b,u.qty=b,u.quantity=b;const h=T(g.unit_price??g.unitPrice??g.price??u.price);u.price=h,u.unit_price=h,!u.desc&&g.desc&&(u.desc=g.desc),!u.image&&g.image&&(u.image=g.image)})}const l=new Map;return r.forEach(s=>{const u=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=s.qty,d.quantity+=s.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=s.qtyPerPackage),(!d.price||d.price===0)&&s.price&&(d.price=s.price,d.unit_price=s.unit_price),!d.desc&&s.desc&&(d.desc=s.desc),!d.image&&s.image&&(d.image=s.image);return}l.set(u,{...s})}}),Array.from(l.values())}function $t(e={},t=[],n=1){try{const o=O(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(o){const c=Fe(o);if(c){const r=gt(c);if(Number.isFinite(Number(r))&&Number(r)>0)return Number(r)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return T(i);const a=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(a))){const o=T(a);return n>0?Number((o/n).toFixed(2)):o}return 0}function xt(e,t){if(!e)return t;if(!t)return e;const n={...e},i=a=>{(n[a]===void 0||n[a]===null||n[a]==="")&&(n[a]=t[a])};return["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=wn(n.packageItems,t.packageItems),n.items=n.packageItems),n}function wn(e=[],t=[]){const n=new Map,i=a=>{a.forEach(o=>{if(!o)return;const c=o.normalizedBarcode||(o.equipmentId?`id:${o.equipmentId}`:null);if(c){if(n.has(c)){const r=n.get(c);r.qty+=o.qty??0,r.quantity+=o.quantity??0,(!Number.isFinite(r.qtyPerPackage)||r.qtyPerPackage<=0)&&Number.isFinite(o.qtyPerPackage)&&(r.qtyPerPackage=o.qtyPerPackage),(!r.price||r.price===0)&&o.price&&(r.price=o.price,r.unit_price=o.unit_price),!r.desc&&o.desc&&(r.desc=o.desc),!r.image&&o.image&&(r.image=o.image);return}n.set(c,{...o})}})};return i(e),i(t),Array.from(n.values())}function ae(e=[],t=[]){const n=[],i=new Map,a=Qe(),o=new Map;a.forEach(l=>{const s=O(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&o.set(u,s||u)});const c=l=>{const s=O(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?k(u):"";return s||(d&&o.has(d)?o.get(d):d||null)},r=l=>{Array.isArray(l)&&l.forEach(s=>{if(!s||typeof s!="object")return;const u=c(s);if(u)if(i.has(u)){const d=i.get(u);n[d]=xt(n[d],s)}else i.set(u,n.length),n.push({...s})})};return r(e),r(t),n}function Bt(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const d=O(e),g=d?Fe(d):null,b=g?Te(g,d):[],h=g?T(g.price??g.unit_price??g.unitPrice??0):0,N=1,v=Number((h*N).toFixed(2));return{id:`package::${d||t}`,packageId:d||`pkg-${t}`,package_id:d||`pkg-${t}`,package_code:k(String(e))||d||`pkg-${t}`,name:g?.name??g?.package_name??g?.packageName??k(String(e))??"",desc:g?.name??k(String(e))??"",quantity:N,qty:N,unit_price:h,unitPrice:h,price:h,total:v,total_price:v,barcode:k(String(e)),packageItems:b,items:b,type:"package",image:g?.image??null}}if(typeof e!="object")return null;const n=O(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=Te(e,n),o=$t(e,a,i),c=e.total_price??e.totalPrice??e.total??o*i,r=Number.isFinite(Number(c))?T(c):Number((o*i).toFixed(2)),l=e.package_code??e.packageCode??e.code??n,s=k(String(e.barcode??l??"")),u=e.image??e.cover??e.thumbnail??a.find(d=>d.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:l,name:e.name??e.package_name??e.packageName??e.title??e.description??l??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??l??n,quantity:i,qty:i,unit_price:o,unitPrice:o,price:o,total:r,total_price:r,barcode:s,packageItems:a,items:a,type:"package",image:u}}function et(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,a=(r,l=n.length)=>{const s=Bt(r,l);if(!s)return;const u=s.packageId||s.package_code||s.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);n[d]=xt(n[d],s)}else i.set(u,n.length),n.push(s)};t.forEach(r=>{r.forEach((l,s)=>{a(l,s+n.length)})}),n.length===0&&e.package&&a(e.package,0);const o=Array.isArray(e.items)?e.items:[],c=(r={})=>!r||typeof r!="object"?!1:!!(Dt(r.type??r.item_type??r.kind??null)==="package"||r.packageItems&&Array.isArray(r.packageItems)&&r.packageItems.length||r.items&&Array.isArray(r.items)&&r.items.length&&r.items.every(s=>typeof s=="object")||r.packageId||r.package_id||r.package_code||r.packageCode||r.bundleId||r.bundle_id);return o.forEach((r,l)=>{c(r)&&a(r,n.length+l)}),n}function T(e){const t=$(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function M(e,{fallback:t=1,max:n=1e6}={}){const i=$(e);if(!Number.isFinite(i))return t;const a=Math.round(i);return a<=0||a>n?t:a}function zn(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":case"ملغية":case"ملغى":case"canceled":return"cancelled";default:return"pending"}}function Mn(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function jn(e){return e instanceof Ht}const Xn=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:En,confirmReservationApi:Tn,createReservationApi:Fn,deleteReservationApi:Ln,getCachedReservationCrew:Sn,getReservationsState:Cn,isApiError:jn,mapLegacyReservation:Tt,mapReservationFromApi:Re,mapReservationItem:Et,refreshReservationsFromApi:qn,setReservationsState:Ne,toInternalReservation:$e,updateReservationApi:Lt},Symbol.toStringTag,{value:"Module"}));export{pn as A,$e as B,kn as C,It as D,Sn as E,Qn as F,cn as G,Un as H,Tt as I,Tn as J,Xn as K,Yn as a,bn as b,Ge as c,We as d,Jn as e,he as f,Cn as g,Ln as h,Wn as i,Kn as j,Gn as k,on as l,Re as m,Pt as n,_n as o,un as p,mn as q,qn as r,ln as s,En as t,Lt as u,Fn as v,jn as w,On as x,z as y,$ as z};
