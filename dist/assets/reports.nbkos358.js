const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./preview.Clvog6gu.js","./calculations.D9p8bbkq.js","./reservationsService.BlxgUU8k.js","./auth.Ctjt0Ej_.js","./auth.D-CkbXm0.css","./dashboard.Cd5_Z_W2.js","./controller.DDAPmCPd.js","./dashboardShell.BBCYfYUU.js","./customers.CdnCl5G6.js","./index.BfPQEXqw.css","./maintenanceService.CRdil96O.js"])))=>i.map(i=>d[i]);
import{_ as re}from"./dashboard.Cd5_Z_W2.js";import{r as t,a as oe,t as c,f as k,b as S,d as K,e as Ee,c as j,p as Ce,g as Q,h as Le,i as Me,j as $e,k as Pe,l as Re,m as De,n as Te,o as Ae,q as Ie,s as Be,u as je,v as He,w as Ne,x as _e,y as Fe,z as V}from"./calculations.D9p8bbkq.js";import{l as ze,a as _,b as qe,n as q,g as Oe}from"./auth.Ctjt0Ej_.js";import{z as Ue,v as ie,w as We}from"./reservationsService.BlxgUU8k.js";import{mapMaintenanceFromApi as ce}from"./maintenanceService.CRdil96O.js";import{C as Xe,D as Ge,E as Ve,F as Ye,G as Ke,H as Je,I as Qe}from"./controller.DDAPmCPd.js";function le(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function de(e={}){const a=String(e?.barcode??"").trim(),r=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:a,desc:r,description:r,name:e?.name??r,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function pe(e={}){const a=e?.title??e?.name??"",r=e?.project_code??e?.projectCode??"",s=e?.status??"",n=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:a,code:r,status:s,confirmed:n}}function Ze(){let e;try{e=ze()}catch(f){return console.warn("âš ï¸ [reports] Failed to access cached data",f),!1}if(!e||typeof e!="object")return!1;const{reservations:a=[],customers:r=[],equipment:s=[],technicians:n=[],projects:o=[],maintenance:i=[]}=e;if(!(a.length||r.length||s.length||n.length||o.length))return!1;t.data.reservations=Array.isArray(a)?a.map(Ue):[],t.data.customers=Array.isArray(r)?r.map(le):[],t.data.equipment=Array.isArray(s)?s.map(de):[],t.data.technicians=Array.isArray(n)?n.map(ie):[],t.data.projects=Array.isArray(o)?o.map(pe):[],t.data.projectsMap=new Map(t.data.projects.map(f=>[f.id,f])),t.data.maintenance=Array.isArray(i)?i.map(ce):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(f=>[String(f.id),f]));try{oe()}catch{}return!0}async function ue({silent:e=!1}={}){if(!t.loading){t.loading=!0,t.errorMessage="",e||t.callbacks.onBeforeRender?.();try{const[a,r,s,n,o,i]=await Promise.all([_("/reservations/?limit=500"),_("/customers/?limit=500"),_("/equipment/?limit=500"),_("/technicians/?limit=500"),_("/projects/?limit=500"),_("/maintenance/?limit=500")]);t.data.reservations=Array.isArray(a?.data)?a.data.map(l=>We(l)):[],t.data.customers=Array.isArray(r?.data)?r.data.map(le):[],t.data.equipment=Array.isArray(s?.data)?s.data.map(de):[],t.data.technicians=Array.isArray(n?.data)?n.data.map(ie):[],t.data.projects=Array.isArray(o?.data)?o.data.map(pe):[],t.data.projectsMap=new Map(t.data.projects.map(l=>[l.id,l])),t.data.maintenance=Array.isArray(i?.data)?i.data.map(ce):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(l=>[String(l.id),l]));try{oe()}catch{}}catch(a){console.error("âŒ [reports] Failed to load reports data",a),t.errorMessage=a instanceof qe?a.message:c("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!t.data.projectsMap||!(t.data.projectsMap instanceof Map))&&(t.data.projectsMap=new Map)}finally{t.loading=!1,e||t.callbacks.onAfterRender?.()}}}function Z(e){if(t.loadedScripts.has(e))return t.loadedScripts.get(e);const a=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,r=new Promise((s,n)=>{const o=()=>{a&&(a.dataset.loaded="true"),s()},i=f=>n(f);if(a){if(a.dataset.loaded==="true"){s();return}a.addEventListener("load",o,{once:!0}),a.addEventListener("error",i,{once:!0});return}const l=document.createElement("script");l.src=e,l.async=!0,l.onload=()=>{l.dataset.loaded="true",s()},l.onerror=f=>n(f),document.head.appendChild(l)});return t.loadedScripts.set(e,r),r}function ee(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(t.apexChartsReady||(t.apexChartsReady=Z("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),t.apexChartsReady)}function et(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(t.html2PdfReady||(t.html2PdfReady=Z("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),t.html2PdfReady)}function tt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(t.xlsxReady||(t.xlsxReady=Z("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),t.xlsxReady)}function H(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function A(e,a){const r=document.getElementById(e);if(r){if(!a||a.length===0){r.innerHTML=`<div class="text-sm text-base-content/60">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}r.innerHTML=a.map(s=>{const n=Math.min(Math.max(s.percent??0,0),100),o=c("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",k(s.rawCount??s.value??0)),i=s.className?`reports-progress-fill ${s.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${s.label}</span>
            <span class="reports-progress-value">${k(s.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${n}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}function L(e,a){const r=document.querySelector(`[data-chart-loading="${e}"]`);r&&(r.style.display=a?"":"none")}async function at(e){const a=document.getElementById("reports-volume-chart");if(!a)return;const r=Array.isArray(e)?e:[];if(t.lastTrendData=r,L("volume",!0),!r.length){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("volume",!1);return}try{const s=await ee();if(!s){a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("volume",!1);return}const n=r.map(m=>m.label),o=r.map(m=>Math.round(m.count||0)),i=r.map(m=>Number(m.revenue||0)),l=r.map(m=>Number(m.netProfit||0)),f=o.reduce((m,C)=>m+(Number.isFinite(C)?C:0),0),h=i.reduce((m,C)=>m+(Number.isFinite(C)?C:0),0),b=l.reduce((m,C)=>m+(Number.isFinite(C)?C:0),0);if(f===0&&h===0&&b===0){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const v=[{name:c("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:o},{name:c("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:i},{name:c("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:l,yAxisIndex:1}],d={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(m,C,$)=>{if($?.dataPointIndex!=null){const D=t.lastTrendData[$.dataPointIndex];t.callbacks.onTrendDrilldown?.(D,$.dataPointIndex)}}}},theme:{mode:H()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:n,labels:{style:{colors:H()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:c("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:m=>k(m)},title:{text:c("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:c("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:m=>S(m)},title:{text:c("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(m,{seriesIndex:C})=>C===0?k(m):S(m)}}},u=H(),x=String(n.join("|")),y=t.chartsMeta.trend,w=t.charts.trend&&y.theme===u&&y.categoriesSig===x;t.charts.trend&&w?t.charts.trend.updateSeries(v,!0):t.charts.trend?(t.charts.trend.updateOptions({...d},!0,!0),t.charts.trend.updateSeries(v,!0)):(a.innerHTML="",t.charts.trend=new s(a,{...d,series:v}),t.charts.trend.render()),t.chartsMeta.trend={categoriesSig:x,theme:u},L("volume",!1)}catch(s){console.error("âš ï¸ [reports] Failed to render trend chart",s),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("volume",!1)}}async function rt(e){const a=document.getElementById("reports-status-chart"),r="reports-status-breakdown";if(!a)return;const s=Array.isArray(e)?e:[];t.lastStatusData=s,L("status",!0);const n=s.map(i=>Math.max(0,i.value||0)),o=n.reduce((i,l)=>i+l,0);if(!s.length||o===0){t.charts.status&&(t.charts.status.destroy(),t.charts.status=null),A(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("status",!1);return}try{const i=await ee();if(!i){A(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("status",!1);return}const l=s.map(u=>u.label),f={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,x,y)=>{if(y?.dataPointIndex!=null){const w=t.lastStatusData[y.dataPointIndex];w?.filterKey&&t.callbacks.onStatusDrilldown?.(w,y.dataPointIndex)}}}},theme:{mode:H()},labels:l,series:n,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:c("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>k(n.reduce((u,x)=>u+x,0))}}}}},tooltip:{y:{formatter:(u,x)=>{const y=t.lastStatusData?.[x?.seriesIndex||0],w=y?`${k(y.percent)}%`:`${k(u)}%`;return`${y?k(y.rawCount??y.value??0):k(u)} / ${w}`}}}},h=H(),b=String(l.join("|")),v=t.chartsMeta.status,d=t.charts.status&&v.theme===h&&v.labelsSig===b;t.charts.status&&d?t.charts.status.updateSeries(n,!0):t.charts.status?(t.charts.status.updateOptions({...f},!0,!0),t.charts.status.updateSeries(n,!0)):(a.innerHTML="",t.charts.status=new i(a,{...f,series:n}),t.charts.status.render()),A(r,s),t.chartsMeta.status={labelsSig:b,theme:h},L("status",!1)}catch(i){console.error("âš ï¸ [reports] Failed to render status chart",i),A(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("status",!1)}}async function nt(e){const a=document.getElementById("reports-payment-chart"),r="reports-payment-breakdown";if(!a)return;const s=Array.isArray(e)?e:[];t.lastPaymentData=s,L("payment",!0);const n=s.map(i=>Math.max(0,i.value||0)),o=n.reduce((i,l)=>i+l,0);if(!s.length||o===0){t.charts.payment&&(t.charts.payment.destroy(),t.charts.payment=null),A(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("payment",!1);return}try{const i=await ee();if(!i){A(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("payment",!1);return}const l=s.map(u=>u.label),f={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,x,y)=>{if(y?.dataPointIndex!=null){const w=t.lastPaymentData[y.dataPointIndex];w?.filterKey&&t.callbacks.onPaymentDrilldown?.(w,y.dataPointIndex)}}}},theme:{mode:H()},labels:l,series:n,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},tooltip:{y:{formatter:(u,x)=>{const y=t.lastPaymentData?.[x?.seriesIndex||0],w=y?`${k(y.percent)}%`:`${k(u)}%`;return`${y?k(y.rawCount??y.value??0):k(u)} / ${w}`}}}},h=H(),b=String(l.join("|")),v=t.chartsMeta.payment,d=t.charts.payment&&v.theme===h&&v.labelsSig===b;t.charts.payment&&d?t.charts.payment.updateSeries(n,!0):t.charts.payment?(t.charts.payment.updateOptions({...f},!0,!0),t.charts.payment.updateSeries(n,!0)):(a.innerHTML="",t.charts.payment=new i(a,{...f,series:n}),t.charts.payment.render()),A(r,s),t.chartsMeta.payment={labelsSig:b,theme:h},L("payment",!1)}catch(i){console.error("âš ï¸ [reports] Failed to render payment chart",i),A(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("payment",!1)}}function st(e){const a=document.getElementById("reports-kpi-total"),r=document.getElementById("reports-kpi-total-meta"),s=document.getElementById("reports-kpi-revenue"),n=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),l=document.getElementById("reports-kpi-confirmed-meta"),f=document.getElementById("reports-kpi-paid"),h=document.getElementById("reports-kpi-paid-meta"),b=e.total||0,v=e.revenue||0,d=e.confirmed||0,u=e.paidCount||0,x=e.average||0,y=e.companyShareTotal||0,w=e.taxTotal||0,m=e.crewTotal||0,C=e.crewCostTotal||0,$=e.netProfit||0,D=e.maintenanceExpense||0,ae=b?Math.round(d/b*100):0,G=b?Math.round(u/b*100):0;if(a&&(a.textContent=k(b)),r){const M=c("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",k(e.completed||0));r.textContent=M}if(s&&(s.textContent=S(v)),n)if(b===0)n.textContent=c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const M=c("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");n.textContent=M.replace("{net}",S($)).replace("{share}",S(y)).replace("{average}",S(x))}if(o)if(v>0){const M=[{label:c("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:S(v),hint:c("reservations.reports.kpi.revenue.details.grossHint","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)","Total bookings value (before discounts)")},{label:c("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:S(y),hint:c("reservations.reports.kpi.revenue.details.shareHint","ØªÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…ØŒ ÙˆØªÙØ¶Ø§Ù Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Applied after discount and added to total")},{label:c("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:S(w),hint:c("reservations.reports.kpi.revenue.details.taxHint","Ø¶Ø±ÙŠØ¨Ø© 15% Ø¹Ù„Ù‰ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… + Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©)","15% VAT on (after-discount total + company share)")},{label:c("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:S(m),hint:c("reservations.reports.kpi.revenue.details.crewGrossHint","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ø§Ù‚Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„","Crew price billed to client")},{label:c("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:S(C),hint:c("reservations.reports.kpi.revenue.details.crewHint","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©","Crew cost to company")}];D>0&&M.push({label:c("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${S(D)}`}),M.push({label:c("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:S($)}),o.innerHTML=M.map(({label:N,value:I,hint:B})=>`
          <div class="reports-kpi-detail-row" title="${B||""}">
            <span class="reports-kpi-detail-label">${N}</span>
            <span class="reports-kpi-detail-value">${I}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(i&&(i.textContent=`${ae}%`),l){const M=c("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",k(d));l.textContent=M}if(f&&(f.textContent=`${G}%`),h){const M=c("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",k(u));h.textContent=M}}function P(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function X(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function ot(e,a,r){const s=document.getElementById("reports-reservations-body");if(!s)return[];if(!e||e.length===0)return s.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const n=new Map((a||[]).map(d=>[String(d.id),d]));new Map((r||[]).map(d=>[String(d.id),d]));const o={code:c("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:c("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:c("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:c("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:c("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:c("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:c("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:c("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},i=ct([...e]),{page:l,pageSize:f}=t.pagination,h=Math.max(0,(l-1)*f),v=i.slice(h,h+f).map(d=>{const u=pt(d,n),x={[o.code]:u.code.text,[o.customer]:u.customer.text,[o.date]:u.date.text,[o.status]:u.status.text,[o.payment]:u.payment.text,[o.total]:u.total.text,[o.share]:u.share.text,[o.net]:u.net.text};return{formatted:u,exportRow:x}});return s.innerHTML=v.map(({formatted:d})=>`
      <tr data-drilldown="reservation" data-search="${X(d.code.text)}">
        <td data-report-column="code">${d.code.html}</td>
        <td data-report-column="customer">${d.customer.html}</td>
        <td data-report-column="date">${d.date.html}</td>
        <td data-report-column="status">${d.status.html}</td>
        <td data-report-column="payment">${d.payment.html}</td>
        <td data-report-column="total">${d.total.html}</td>
        <td data-report-column="share">${d.share.html}</td>
        <td data-report-column="net">${d.net.html}</td>
      </tr>
    `).join(""),dt(i.length),it(),v.map(({exportRow:d})=>d)}function it(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(a=>{a.dataset.sortBound!=="true"&&(a.addEventListener("click",()=>{const r=a.dataset.sortKey;r&&(t.sort.key===r?t.sort.dir=t.sort.dir==="asc"?"desc":"asc":(t.sort.key=r,t.sort.dir="asc"),t.pagination.page=1,t.callbacks.onRender?.())}),a.dataset.sortBound="true")})}function ct(e){const{key:a,dir:r}=t.sort||{key:"date",dir:"desc"},s=r==="asc"?1:-1;return e.sort((n,o)=>s*lt(n,o,a))}function lt(e,a,r){switch(r){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(a?.reservationId??a?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(a?.customerName??a?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(a?.start||0);case"status":{const s=K(e)?.statusValue||"",n=K(a)?.statusValue||"";return String(s).localeCompare(String(n),"ar")}case"total":{const s=j(e)?.finalTotal||0,n=j(a)?.finalTotal||0;return s-n}case"share":{const s=j(e)?.companyShareAmount||0,n=j(a)?.companyShareAmount||0;return s-n}case"net":{const s=j(e)?.netProfit||0,n=j(a)?.netProfit||0;return s-n}default:return new Date(e?.start||0)-new Date(a?.start||0)}}function dt(e){const a=document.getElementById("reports-table-pagination");if(!a)return;const{page:r,pageSize:s}=t.pagination,n=Math.max(1,Math.ceil(e/s)),o=r<=1?"disabled":"",i=r>=n?"disabled":"",l=e===0?0:(r-1)*s+1,f=Math.min(r*s,e);a.innerHTML=`
    <div class="pager">
      <button type="button" ${o} data-page="prev">â—€</button>
      <button type="button" ${i} data-page="next">â–¶</button>
    </div>
    <div class="page-info">${k(l)}â€“${k(f)} / ${k(e)}</div>
    <div class="pager page-size">
      <label>${c("reservations.reports.pageSize","Ù„ÙƒÙ„ ØµÙØ­Ø©","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,a.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{t.pagination.page>1&&(t.pagination.page-=1,t.callbacks.onRender?.())}),a.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const h=Math.max(1,Math.ceil(e/t.pagination.pageSize));t.pagination.page<h&&(t.pagination.page+=1,t.callbacks.onRender?.())}),a.querySelectorAll("[data-size]")?.forEach(h=>{h.addEventListener("click",()=>{const b=Number(h.dataset.size);Number.isFinite(b)&&b>0&&(t.pagination.pageSize=b,t.pagination.page=1,t.callbacks.onRender?.())})})}function pt(e,a,r){const s=e?.reservationId||e?.id||"â€”",n=q(String(s)),i=a.get(String(e?.customerId))?.customerName||c("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),l=K(e),f=ut(l.statusValue),h=mt(l.statusValue,f),b=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],v=ft(l.paidStatus,b),d=b.length;let u=v.html;if(d>0){const D=c("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",k(d));u=`<div class="reports-payment-cell">${v.html}<small class="reports-payment-subtext">${P(D)}</small></div>`}const x=Ee(e?.start),y=j(e),w=S(y.finalTotal),m=y.companySharePercent>0?`${k(y.companySharePercent)}% (${S(y.companyShareAmount)})`:c("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),C=S(y.netProfit),$=P(i);return{code:{html:P(n),text:n},customer:{html:$,text:i},date:{html:P(x),text:x},status:h,payment:{html:u,text:v.text},total:{html:P(w),text:w},share:{html:P(m),text:m},net:{html:P(C),text:C}}}function ut(e){switch(e){case"completed":return O(c("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return O(c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return O(c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return q(e||"â€”")}}function mt(e,a){const r=O(a);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${P(r)}</span>`,text:r}}function ft(e,a=[]){const r=Ce(e),s=String(e??"").toLowerCase(),n=s==="paid"?"paid":s==="partial"?"partial":"unpaid";let o="";const i=c("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(a)&&a.length&&(o=a.map(h=>{const b=h?.recordedAt?Q(h.recordedAt):"â€”",v=Number.isFinite(Number(h?.amount))&&Number(h.amount)>0?`${q(Number(h.amount).toFixed(2))} ${i}`:"",d=Number.isFinite(Number(h?.percentage))&&Number(h.percentage)>0?`${q(Number(h.percentage).toFixed(2))}%`:"",u=[b];return v&&u.push(v),d&&u.push(d),u.filter(Boolean).join(" â€¢ ")}).join(`
`));const l=o?` title="${X(o)}"`:"";return{html:`<span class="reservation-chip status-${n}"${l}>${P(r)}</span>`,text:r}}function O(e){return q(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function te(e){const a=Q(new Date).replace(/-/g,"");return`${c("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${a}.${e}`}function ht(e,a,r){const s=new Blob([e],{type:r}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=a,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(n),4e3)}function W(e){if(!e||!e.length)return;const a=Object.keys(e[0]),r=[a.join(",")];e.forEach(n=>{const o=a.map(i=>`"${String(n[i]??"").replace(/"/g,'""')}"`);r.push(o.join(","))});const s=`\uFEFF${r.join(`\r
`)}\r
`;ht(s,te("csv"),"text/csv;charset=utf-8;")}async function me(e){try{const a=await tt();if(!a){W(e);return}const r=a.utils.json_to_sheet(e),s=a.utils.book_new(),n=c("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");a.utils.book_append_sheet(s,r,n),a.writeFile(s,te("xlsx"))}catch(a){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",a),W(e)}}function fe(e=[]){const r=(t.lastSnapshot||{}).metrics||{},s=new Date,n=document.createElement("div");n.id="reports-pdf-root",n.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),n.style.cssText="position:fixed;left:0;top:0;z-index:2147483647;background:#ffffff;width:100%;display:flex;justify-content:center;";const o=document.createElement("style");o.textContent=`
    /* Ø¹Ø²Ù„ ØªØ§Ù… Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø¯Ø§Ø®Ù„ Ø¬Ø°Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
    #reports-pdf-root, #reports-pdf-root * { color: #000 !important; background:#fff !important; box-sizing: border-box; box-shadow:none !important; outline:0 !important; }
    :where(html.dark-mode, body.dark-mode) #reports-pdf-root, :where(html.dark-mode, body.dark-mode) #reports-pdf-root * { color: #000 !important; }
    html, body { font-family: Tajawal, Arial, sans-serif; }
    /* Ø§Ø³ØªØ®Ø¯Ù… Ø­Ø¬Ù… A4 Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    #reports-pdf-root { width: 210mm; margin: 0 auto; }
    .pdf { width: 210mm; padding: 10mm; color: #000; background: #fff; direction: rtl; margin: 0 auto; }
    .pdf h1 { margin: 0 0 8px; font-size: 22px; font-weight: 800; color:#000; }
    .pdf h1, .pdf .subtitle, .section-title { text-align: right; }
    .pdf .subtitle { margin: 0 0 18px; color: #000; font-size: 13px; opacity: 0.85; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
    .kpi { border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; background:#fff; text-align: right; }
    .kpi .label { font-size: 12px; color: #000; opacity: 0.8; }
    .kpi .value { font-size: 16px; font-weight: 700; color:#000; }
    .section-title { margin: 14px 0 8px; font-weight: 800; font-size: 16px; color:#000; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; color:#000; }
    table, thead, tbody, tr, th, td { background:#fff !important; color:#000 !important; border-color:#e5e7eb !important; }
    tbody tr:hover { background:#fff !important; }
    .reservation-chip,
    .status-confirmed,
    .status-pending,
    .status-completed { background:#fff !important; color:#000 !important; border:1px solid #e5e7eb !important; box-shadow:none !important; }
    thead th { text-align: right; background: #f3f4f6 !important; border: 1px solid #e5e7eb; padding: 8px 10px; font-weight: 800; color:#000; }
    tbody td { border: 1px solid #e5e7eb; padding: 8px 10px; color:#000; text-align:right; }
    tbody tr:nth-child(even) td { background: #fafafa; }
  `,n.appendChild(o);const i=document.createElement("div");i.className="pdf",i.innerHTML=`
    <h1>${c("reservations.reports.print.title","ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations report")}</h1>
    <p class="subtitle">${Q(s)} â€¢ ${c("reservations.reports.print.generated","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙ„ÙŠØ¯","Generated on")}</p>
    <div class="kpis">
      <div class="kpi"><div class="label">${c("reservations.reports.kpi.total.label","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations")}</div><div class="value">${k(r.total||0)}</div></div>
      <div class="kpi"><div class="label">${c("reservations.reports.kpi.revenue.label","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª","Revenue")}</div><div class="value">${S(r.revenue||0)}</div></div>
      <div class="kpi"><div class="label">${c("reservations.reports.kpi.net.label","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")}</div><div class="value">${S(r.netProfit||0)}</div></div>
      <div class="kpi"><div class="label">${c("reservations.reports.kpi.share.label","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share")}</div><div class="value">${S(r.companyShareTotal||0)}</div></div>
      <div class="kpi"><div class="label">${c("reservations.reports.kpi.tax.label","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax")}</div><div class="value">${S(r.taxTotal||0)}</div></div>
      <div class="kpi"><div class="label">${c("reservations.reports.kpi.maintenance.label","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance")}</div><div class="value">${S(r.maintenanceExpense||0)}</div></div>
    </div>
    <div class="section-title">${c("reservations.reports.results.title","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations details")}</div>
  `;const l=document.createElement("table"),f=document.createElement("thead"),h=document.createElement("tbody"),b=e&&e.length?Object.keys(e[0]):[c("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),c("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),c("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),c("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),c("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),c("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),c("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),c("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")],v=document.createElement("tr");return b.forEach(d=>{const u=document.createElement("th");u.textContent=d,v.appendChild(u)}),f.appendChild(v),(e||[]).forEach(d=>{const u=document.createElement("tr");b.forEach(x=>{const y=document.createElement("td");y.textContent=d[x]!=null?String(d[x]):"",u.appendChild(y)}),h.appendChild(u)}),l.appendChild(f),l.appendChild(h),i.appendChild(l),n.appendChild(i),n}async function he(e=[],a={}){const r=a?.action==="print"?"print":"save",s=fe(e&&e.length?e:t.lastSnapshot.tableRows||[]);document.body.appendChild(s);const n=s.querySelector(".pdf"),o=210,i=297,l=10,f=96,h=Math.round(o/25.4*f),b=Math.round(i/25.4*f),v=te("pdf");n&&(n.style.width="210mm",n.style.maxWidth="210mm",n.style.padding="0",n.style.margin="0 auto",n.style.background="#ffffff",n.style.color="#000000"),Xe();const d=[],u=Ge(s);Ve(s,window,d),Ye(s,window,d),Ke(s);try{await et();const x=window.html2pdf().set({margin:l,filename:v,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",scrollX:0,scrollY:0,windowWidth:h,windowHeight:n?Math.max(n.scrollHeight,n.offsetHeight):b},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(n||s).toPdf();if(r==="save")await x.save();else{const y=await x.get("pdf").then(w=>w.output("bloburl"));await new Promise(w=>{const m=document.createElement("iframe");m.style.position="fixed",m.style.right="0",m.style.bottom="0",m.style.width="1px",m.style.height="1px",m.style.border="0",m.onload=()=>{try{m.contentWindow?.focus(),m.contentWindow?.print()}catch{}setTimeout(()=>{m.remove(),w()},1e3)},m.src=y,document.body.appendChild(m)})}}catch(x){try{const y=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,w=window.html2canvas;if(typeof y=="function"&&typeof w=="function"){await(document.fonts?.ready||Promise.resolve());const m=await w(n||s,{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",scrollX:0,scrollY:0,windowWidth:h,windowHeight:n?Math.max(n.scrollHeight,n.offsetHeight):b}),C=m.toDataURL("image/jpeg",.98),$=new y({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),D=m.width,G=m.height/D,M=Math.max(1,o-2*l),N=Math.max(1,i-2*l);let I=M,B=I*G;if(B>N){const Se=N/B;B=N,I=I*Se}const ke=l+Math.max(0,(M-I)/2),we=l+Math.max(0,(N-B)/2);$.addImage(C,"JPEG",ke,we,I,B),$.save(v)}else console.error("âš ï¸ [reports] export failed",x)}catch(y){console.error("âš ï¸ [reports] export fallback failed",y)}}finally{Je(d),Qe(s,u),s.remove()}}async function ye(e,a){switch(e){case"pdf":await he(a);break;case"excel":await me(a);break;case"csv":default:W(a);break}}function ge(e){const a=document.getElementById("reports-top-customers");if(a){if(!e||e.length===0){a.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}a.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${X(r.name)}">
        <td>${P(r.name)}</td>
        <td>${k(r.count)}</td>
        <td>${S(r.revenue)}</td>
      </tr>
    `).join("")}}function ve(e){const a=document.getElementById("reports-top-equipment");if(a){if(!e||e.length===0){a.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}a.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${X(r.name)}">
        <td>${P(r.name)}</td>
        <td>${k(r.count)}</td>
        <td>${S(r.revenue)}</td>
      </tr>
    `).join("")}}const yt=Object.freeze(Object.defineProperty({__proto__:null,buildPdfReportElement:fe,exportAsCsv:W,exportAsExcel:me,exportAsPdf:he,exportReport:ye,renderTopCustomers:ge,renderTopEquipment:ve},Symbol.toStringTag,{value:"Module"})),g=t.filters;function gt(e){if(t.columnControlsBound)return;const a=document.getElementById("reports-column-controls");a&&(a.querySelectorAll("input[data-column-toggle]").forEach(r=>{const s=r.dataset.columnToggle;s&&(r.checked=t.columnPreferences[s]!==!1,r.addEventListener("change",()=>{t.columnPreferences[s]=r.checked,e()}))}),t.columnControlsBound=!0,e())}function be(){Object.entries(t.columnPreferences).forEach(([e,a])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(r=>{r.classList.toggle("hidden",!a)})})}function vt(e){if(t.exportHandlersBound)return;const a=document.querySelectorAll("[data-export]");a.length&&(a.forEach(r=>{r.addEventListener("click",async()=>{const{export:s=""}=r.dataset;if(s){r.disabled=!0;try{await e(s)}catch(n){console.error("âš ï¸ [reports] export failed",n)}finally{r.disabled=!1}}})}),t.exportHandlersBound=!0)}function bt(e,a){t.searchDebounceTimer&&(clearTimeout(t.searchDebounceTimer),t.searchDebounceTimer=null),t.searchDebounceTimer=setTimeout(()=>{g.search=e||"",a()},220)}function xt(e,a){e&&(g.range="custom",g.start=e.startInput||null,g.end=e.endInput||null,a())}function kt(e,a){e&&(g.status=g.status===e?"all":e,a())}function wt(e,a){e&&(g.payment=g.payment===e?"all":e,a())}function St(e,a){e&&(g.search=e,a())}function Et({onClear:e}={}){const a=document.getElementById("reservations-active-filters");if(!a)return;const r=[],s=(n,o,i)=>{r.push(`<span class="filter-chip" data-chip="${n}">${o} <button type="button" aria-label="clear" data-clear="${n}">âœ•</button></span>`)};if(g.range&&g.range!=="all"){let n="";switch(g.range){case"last30":n=c("reservations.reports.filters.range.last30","Ø¢Ø®Ø± 30 ÙŠÙˆÙ…","Last 30 days");break;case"thisWeek":n=c("reservations.reports.filters.range.thisWeek","Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","This week");break;case"thisMonth":n=c("reservations.reports.filters.range.thisMonth","Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±","This month");break;case"thisQuarter":n=c("reservations.reports.filters.range.thisQuarter","Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹","This quarter");break;case"thisYear":n=c("reservations.reports.filters.range.thisYear","Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…","This year");break;case"custom":n=`${c("reservations.reports.filters.range.custom","Ù…Ø®ØµØµ","Custom")} (${g.start||"â€”"} â†’ ${g.end||"â€”"})`;break;default:n=g.range}s("range",n)}if(g.status&&g.status!=="all"){const n=c(`reservations.reports.filters.status.${g.status}`,g.status,g.status);s("status",n)}if(g.payment&&g.payment!=="all"){const n=c(`reservations.reports.filters.payment.${g.payment}`,g.payment,g.payment);s("payment",n)}if(g.share&&g.share!=="all"){const n=c(`reservations.reports.filters.share.${g.share}`,g.share,g.share);s("share",n)}g.search&&g.search.trim().length&&s("search",`ğŸ” ${g.search.trim()}`),a.innerHTML=r.join(""),a.querySelectorAll("[data-clear]").forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.clear;o&&(o==="range"?(g.range="all",g.start=null,g.end=null):o in g&&(o==="search"?g.search="":g[o]="all"),e?.(o))})})}const p=t.filters;function ne(){V(),E(),setTimeout(()=>{V(),E(),U()},0),setTimeout(()=>{V(),E(),U()},60),U()}function z(){p.range==="custom"&&E()}function U(e,a){if(!window.flatpickr)return;e&&(t.startDateInputRef=e),a&&(t.endDateInputRef=a);const r=t.startDateInputRef,s=t.endDateInputRef;if(!r&&!s)return;const n=Ct(),o=i=>{const l={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return n&&(l.locale=n),l};if(t.startDatePicker&&(t.startDatePicker.destroy(),t.startDatePicker=null),t.endDatePicker&&(t.endDatePicker.destroy(),t.endDatePicker=null),r&&(t.startDatePicker=window.flatpickr(r,o({onChange(i,l){p.start=l||null,t.endDatePicker&&(i?.length?t.endDatePicker.set("minDate",i[0]):t.endDatePicker.set("minDate",null)),z()},onValueUpdate(i,l){p.start=l||null,z()}}))),s&&(t.endDatePicker=window.flatpickr(s,o({onChange(i,l){p.end=l||null,t.startDatePicker&&(i?.length?t.startDatePicker.set("maxDate",i[0]):t.startDatePicker.set("maxDate",null)),z()},onValueUpdate(i,l){p.end=l||null,z()}}))),t.startDatePicker&&r){t.startDatePicker.setDate(r.value,!1);const i=t.endDatePicker?.selectedDates?.[0]||t.endDateInputRef?.value;i&&t.startDatePicker.set("maxDate",i)}if(t.endDatePicker&&s){t.endDatePicker.setDate(s.value,!1);const i=t.startDatePicker?.selectedDates?.[0]||t.startDateInputRef?.value;i&&t.endDatePicker.set("minDate",i)}}function Ct(){return(Oe()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function J(e,a){e&&(e.classList.toggle("active",!!a),e.classList.toggle("hidden",!a))}function T(){const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),s=document.getElementById("reports-share-filter"),n=document.getElementById("reports-search"),o=document.getElementById("reports-start"),i=document.getElementById("reports-end"),l=document.getElementById("reports-custom-range");e&&e.value!==p.range&&(e.value=p.range),a&&a.value!==p.status&&(a.value=p.status),r&&r.value!==p.payment&&(r.value=p.payment),s&&s.value!==p.share&&(s.value=p.share),n&&n.value!==p.search&&(n.value=p.search||""),o&&o.value!==(p.start||"")&&(o.value=p.start||""),i&&i.value!==(p.end||"")&&(i.value=p.end||""),J(l,p.range==="custom")}function Lt(){try{const e=new URLSearchParams(window.location.search),a=s=>e.get(s),r=s=>s==null||s===""?null:s;p.range=a("range")||p.range,p.status=a("status")||p.status,p.payment=a("payment")||p.payment,p.share=a("share")||p.share,p.search=a("search")||"",p.start=r(a("start")),p.end=r(a("end")),p.range!=="custom"&&(p.start=null,p.end=null)}catch{}}let Y=null;function R(){Y&&clearTimeout(Y),Y=setTimeout(()=>{try{const e=new URLSearchParams,a=(n,o,i)=>{o!=null&&o!==""&&o!==i&&e.set(n,o)};a("range",p.range,"all"),a("status",p.status,"all"),a("payment",p.payment,"all"),a("share",p.share,"all"),a("search",p.search,""),p.range==="custom"&&(a("start",p.start,null),a("end",p.end,null));const r=e.toString(),s=r?`${location.pathname}?${r}`:location.pathname;window.history.replaceState({},"",s)}catch{}},120)}function xe({active:e,icon:a,title:r,subtitle:s}){const n=document.getElementById("reports-empty-state");if(!n)return;const o=n.querySelector(".reports-empty-icon"),i=n.querySelector("h4"),l=n.querySelector("p");t.emptyDefaults.icon===null&&o&&(t.emptyDefaults.icon=o.textContent),t.emptyDefaults.title===null&&i&&(t.emptyDefaults.title=i.textContent),t.emptyDefaults.subtitle===null&&l&&(t.emptyDefaults.subtitle=l.textContent),n.classList.toggle("active",!!e),n.classList.toggle("hidden",!e),!(!o||!i||!l)&&(e?(o.textContent=a!==void 0?a:t.emptyDefaults.icon??o.textContent,i.textContent=r!==void 0?r:t.emptyDefaults.title??i.textContent,l.textContent=s!==void 0?s:t.emptyDefaults.subtitle??l.textContent):(o.textContent=t.emptyDefaults.icon??o.textContent,i.textContent=t.emptyDefaults.title??i.textContent,l.textContent=t.emptyDefaults.subtitle??l.textContent))}function Mt(e){xe({active:!!e})}function se(e){const a=document.getElementById("reports-kpi-skeleton"),r=document.getElementById("reservations-reports-kpis"),s=document.getElementById("reports-table-skeleton"),n=document.getElementById("reports-reservations-table"),o=document.getElementById("reservations-revenue-skeleton"),i=document.getElementById("reservations-revenue-breakdown");a&&r&&(a.style.display=e?"":"none",r.style.opacity=e?"0.4":"1"),s&&n&&(s.style.display=e?"":"none",n.style.opacity=e?"0.4":"1"),o&&i&&(o.style.display=e?"":"none",i.style.opacity=e?"0.4":"1")}function $t(){if(t.drilldownBound)return;const e=document.getElementById("reports-top-customers"),a=document.getElementById("reports-top-equipment"),r=document.getElementById("reports-reservations-body"),s=n=>{const o=n.target?.closest("[data-drilldown]");if(!o)return;const i=o.dataset.search||"";St(i,()=>{T(),E()})};e?.addEventListener("click",s),a?.addEventListener("click",s),r?.addEventListener("click",s),t.drilldownBound=!0}function F(){ue({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function E(){if(T(),R(),Et({onClear:()=>{T(),R(),E()}}),t.loading){se(!0);return}if(t.errorMessage){xe({active:!0,icon:"âš ï¸",title:t.errorMessage,subtitle:c("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}se(!1);const{reservations:e,customers:a,equipment:r,technicians:s,maintenance:n}=t.data,o=Le(e,p,a,r,s),i=Me(o),l=$e(n,p),f=Pe(i,l.total),h=Re(o),b=De(o),v=Te(o),d=Ae(o,a),u=Ie(o,r);st(f),at(h),rt(b),nt(v),ge(d),ve(u);const x=ot(o,a,s);be(),Mt(o.length===0),t.lastSnapshot.filtered=o,t.lastSnapshot.metrics=f,t.lastSnapshot.trend=h,t.lastSnapshot.statusBreakdown=b,t.lastSnapshot.paymentBreakdown=v,t.lastSnapshot.tableRows=x,t.lastSnapshot.maintenance=l}function Pt(){if(t.initialized)return;t.initialized=!0;const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),s=document.getElementById("reports-share-filter"),n=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),l=document.getElementById("reports-print"),f=document.getElementById("reports-custom-range"),h=document.getElementById("reports-search");if(!e)return;Lt(),T(),Ze()&&E(),e.addEventListener("change",()=>{p.range=e.value,J(f,p.range==="custom"),p.range!=="custom"&&(p.start=null,p.end=null),R(),E()}),a?.addEventListener("change",()=>{p.status=a.value,R(),E()}),r?.addEventListener("change",()=>{p.payment=r.value,R(),E()}),s?.addEventListener("change",()=>{p.share=s.value,R(),E()}),h?.addEventListener("input",()=>{const d=h.value||"";bt(d,()=>{T(),R(),E()})}),n?.addEventListener("change",()=>{p.start=n.value||null,R(),z()}),o?.addEventListener("change",()=>{p.end=o.value||null,R(),z()}),i?.addEventListener("click",()=>{p.range==="custom"&&(p.start=n?.value||null,p.end=o?.value||null),R(),E()}),l?.addEventListener("click",async()=>{try{const d=t.lastSnapshot.tableRows||[];await(await re(()=>Promise.resolve().then(()=>yt),void 0,import.meta.url)).exportAsPdf(d,{action:"print"})}catch{try{window.print()}catch{}}}),U(n,o),J(f,p.range==="custom"),t.languageListenerAttached||(document.addEventListener("language:changed",ne),document.addEventListener("language:translationsReady",ne),t.languageListenerAttached=!0),t.dataListenersAttached||(document.addEventListener("reservations:changed",F),document.addEventListener("customers:changed",F),document.addEventListener("equipment:changed",F),document.addEventListener("projects:changed",F),document.addEventListener("technicians:updated",F),window.addEventListener("maintenance:updated",F),t.dataListenersAttached=!0),gt(be),vt(async d=>{const u=t.lastSnapshot.tableRows||[];if(!u.length){console.warn("[reports] No reservation data to export");return}await ye(d,u)});const v=document.getElementById("reports-preview-pdf");v&&!v.dataset.bound&&(v.addEventListener("click",async()=>{try{const d=await re(()=>import("./preview.Clvog6gu.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url),u=t.lastSnapshot.tableRows||[];d.openReportsPdfPreview(u)}catch(d){console.error("âš ï¸ [reports] Failed to open PDF preview",d)}}),v.dataset.bound="true"),$t(),t.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>E(),0)}),t.themeListenerAttached=!0),Be(E),je(()=>{E()}),He(()=>{E()}),Ne(d=>{xt(d,()=>{T(),E()})}),_e(d=>{kt(d?.filterKey,()=>{T(),E()})}),Fe(d=>{wt(d?.filterKey,()=>{T(),E()})}),ue().catch(d=>{console.error("âŒ [reports] Failed to initialise reports data",d)})}const jt=Object.freeze(Object.defineProperty({__proto__:null,initReports:Pt,renderReports:E},Symbol.toStringTag,{value:"Module"}));export{fe as b,he as e,jt as r};
