import{t as p,r as L,f as ct,c as pt,p as lt,a as dt,b as $,d as J,e as mt}from"./calculations.Cuzjzmo7.js";import{e as ut}from"./reports.ASNUKFZL.js";import{s as ft,c as ht,d as gt,q as yt}from"./controller.CKj9uBP3.js";import{n as Y}from"./auth.DEm-O4iH.js";import"./reservationsService.DHFcI6wO.js";import"./dashboard.DeR4oVwR.js";/* empty css              */import"./dashboardShell.BJ8UOETr.js";import"./customers.DDv-F3VN.js";import"./maintenanceService.-sdg2Aq9.js";const z=96,X=25.4,K=210,bt=297,N=Math.round(K/X*z),H=Math.round(bt/X*z),j=z/X,xt=/safari/i,wt=/(iphone|ipad|ipod)/i,vt=/(crios|fxios|edgios|opios)/i;function Ct(){try{const o=navigator.userAgent||"";return wt.test(o)&&xt.test(o)&&!vt.test(o)}catch{return!1}}function Pt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function Mt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const r=document.createElement("style");r.textContent=String(yt).trim(),t.appendChild(r);const i=document.createElement("div");i.className="quote-preview-pages",i.setAttribute("data-quote-pages",""),t.appendChild(i);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function Q(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function V({rightMm:o,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function St(o){try{const t=Q(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const i="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${i}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${i}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${i}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(r,e);const l=()=>{const h=Number(r.querySelector("[data-rpt-right]").value),c=Number(r.querySelector("[data-rpt-top]").value),M=Number(r.querySelector("[data-rpt-scale]").value),g=Math.max(.9,Math.min(1,M/100));V({rightMm:h,topMm:c,scale:g});const d=h*j,_=c*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${d}px, ${_}px) scale(${g})`})};r.querySelector("[data-rpt-apply]").addEventListener("click",l),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,V({rightMm:0,topMm:0,scale:1});const h=o.querySelector("[data-quote-pages]");Object.assign(h.style,{transform:"none"})});const s=t.rightMm*j,n=t.topMm*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${s}px, ${n}px) scale(${t.scale})`})}catch{}}function B({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function Et(o){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=p("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const i=document.createElement("p");i.className="rpt-subtitle",i.textContent=`${mt(new Date)} • ${p("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(i);const e=document.createElement("div");e.className="rpt-kpis";const l=(s,n)=>{const h=document.createElement("div");return h.className="rpt-kpi",h.innerHTML=`<div class="label">${s}</div><div class="value">${n}</div>`,h};return e.appendChild(l(p("reservations.reports.kpi.total.label","الحجوزات","Reservations"),J(o.total||0))),e.appendChild(l(p("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),$(o.revenue||0))),e.appendChild(l(p("reservations.reports.kpi.net.label","صافي الربح","Net profit"),$(o.netProfit||0))),e.appendChild(l(p("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),$(o.companyShareTotal||0))),e.appendChild(l(p("reservations.reports.kpi.tax.label","الضريبة","Tax"),$(o.taxTotal||0))),e.appendChild(l(p("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),$(o.maintenanceExpense||0))),t.appendChild(e),t}function kt(){try{const o=L?.data||{},t=L?.lastSnapshot?.filtered||o.reservations||[],r=new Map((o.customers||[]).map(n=>[String(n.id),n])),i=[...t].sort((n,h)=>new Date(h?.start||0)-new Date(n?.start||0)),e={code:p("reservations.reports.results.headers.id","الحجز","Reservation"),customer:p("reservations.reports.results.headers.customer","العميل","Customer"),date:p("reservations.reports.results.headers.date","التاريخ","Date"),status:p("reservations.reports.results.headers.status","الحالة","Status"),payment:p("reservations.reports.results.headers.payment","الدفع","Payment"),total:p("reservations.reports.results.headers.total","الإجمالي","Total"),share:p("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:p("reservations.reports.results.headers.net","صافي الربح","Net profit")},l=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],s=i.map(n=>{const h=n?.reservationId||n?.id||"—",c=Y(String(h)),g=r.get(String(n?.customerId))?.customerName||p("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),d=ct(n?.start),_=pt(n),b=(()=>{switch(_.statusValue){case"completed":return String(p("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(p("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(p("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return Y(String(_.statusValue||"—"))}})(),k=lt(_.paidStatus),S=dt(n),I=$(S.finalTotal),A=S.companySharePercent>0?`${J(S.companySharePercent)}% (${$(S.companyShareAmount)})`:p("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),m=$(S.netProfit);return{[e.code]:c,[e.customer]:g,[e.date]:d,[e.status]:b,[e.payment]:k,[e.total]:I,[e.share]:A,[e.net]:m}});return{headers:l,rows:s}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function G(o){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),i=document.createElement("tr");o.forEach(l=>{const s=document.createElement("th");s.textContent=l,i.appendChild(s)}),r.appendChild(i);const e=document.createElement("tbody");return t.appendChild(r),t.appendChild(e),{table:t,tbody:e}}function Tt(o,t,r,i){const e=o.querySelector("[data-quote-pages]"),l=B({primary:!0});e.appendChild(l);const s=Et(i);l.appendChild(s);let{table:n,tbody:h}=G(r);l.appendChild(n);const c=18,M=28,g=[];for(let b=0;b<t.length;b+=M)g.push(t.slice(b,b+M));if(g.length){const b=g[0];if(b.length>c){const k=b.splice(c);g.length>1?g[1]=k.concat(g[1]):g.push(k)}}const d=(b,k)=>{const S=document.createElement("tr");r.forEach(I=>{const A=document.createElement("td");A.textContent=k[I]!=null?String(k[I]):"",S.appendChild(A)}),b.appendChild(S)};(g.shift()||t).forEach(b=>d(h,b)),g.forEach(b=>{const k=B({primary:!1});e.appendChild(k);const S=G(r);k.appendChild(S.table),b.forEach(I=>d(S.tbody,I))})}function Rt(o=[],{context:t="preview"}={}){const i=(L.lastSnapshot||{}).metrics||{};let e,l=o&&o.length?o:null;if(l)e=Object.keys(l[0]||{});else{const h=kt();e=h.headers,l=h.rows}const s=Mt(t),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${N}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(s);try{ft(s),ht(s),gt(s)}catch{}return Tt(s,l||[],e,i),s.parentElement?.removeChild(s),n.parentElement?.removeChild(n),t==="preview"&&St(s),s}async function Ht(o=[],{action:t="save"}={}){const r=Rt(o,{context:"export"}),i=document.createElement("div");Object.assign(i.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),i.appendChild(r),document.body.appendChild(i);try{{const c=window.open("","_blank");if(!c)throw new Error("Popup blocked");const M=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${p("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} /* ضمان إظهار كل صفحة كتلة مطبوعة */ .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{c.document.open(),c.document.write(M),c.document.close()}catch{}const g=r.cloneNode(!0);try{c.document.body.appendChild(g)}catch{}try{c.document?.fonts?.ready&&await c.document.fonts.ready}catch{}await new Promise(d=>setTimeout(d,60));try{c.focus(),c.print()}catch{}return}const s=Ct()&&!Pt()?window.open("","_blank"):null;if(s)try{s.document.open(),s.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${p("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${p("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${p("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),s.document.close()}catch{}await ut();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const n=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,h=window.html2canvas;if(typeof n=="function"&&typeof h=="function"){const c=Q(),M=new n({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),d={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},_=Array.from(r.querySelectorAll(".quote-page"));let b=0;const k=(m,x=250)=>{try{const u=m.getContext("2d"),{width:y,height:w}=m,a=new Uint8ClampedArray(y*4),v=f=>{const E=u.getImageData(0,f,y,1).data||a;let T=0;for(let C=0;C<y;C+=1){const R=C*4,q=E[R],D=E[R+1],W=E[R+2];if((q<x||D<x||W<x)&&(T+=1,T>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let P=0;for(let f=0;f<w;f+=2)if(!v(f)){P=f;break}return P}catch{return 0}},S=(m,x=245)=>{try{const u=m.getContext("2d"),{width:y,height:w}=m,a=Math.floor(y*.55),v=Math.max(10,y-a),P=Math.max(3,Math.ceil(v*.015));for(let f=0;f<w;f+=2){const E=u.getImageData(a,f,v,1).data;let T=0;for(let C=0;C<v;C+=1){const R=C*4,q=E[R],D=E[R+1],W=E[R+2];if((q<x||D<x||W<x)&&(T+=1,T>=P))return f}}return 0}catch{return 0}},I=(m,x=250)=>{try{const u=m.getContext("2d"),{width:y,height:w}=m,a=P=>{const f=u.getImageData(0,P,y,1).data;let E=0;for(let T=0;T<y;T+=1){const C=T*4,R=f[C],q=f[C+1],D=f[C+2];if((R<x||q<x||D<x)&&(E+=1,E>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let v=0;for(let P=w-1;P>=0;P-=2)if(!a(P)){v=w-1-P;break}return v}catch{return 0}},A=(m,x,u)=>{try{const{width:y,height:w}=m,a=Math.max(0,Math.min(w-1,Math.round(x))),v=Math.max(0,Math.min(w-a,Math.round(u))),P=Math.max(1,w-a-v);if(a===0&&v===0)return m;const f=document.createElement("canvas");return f.width=y,f.height=P,f.getContext("2d").drawImage(m,0,-a),f}catch{return m}};for(let m=0;m<_.length;m+=1){const x=_[m],u=x.ownerDocument||document,y=u.createElement("div");Object.assign(y.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const w=u.createElement("div");w.id="quotation-pdf-root",w.setAttribute("data-quote-render-context","export"),w.style.width=`${N}px`,w.style.maxWidth=`${N}px`,w.style.minWidth=`${N}px`,w.style.background="#ffffff";const a=x.cloneNode(!0);a.style.width=`${N}px`,a.style.maxWidth=`${N}px`,a.style.minWidth=`${N}px`,a.style.height=`${H}px`,a.style.maxHeight=`${H}px`,a.style.minHeight=`${H}px`,a.style.position="relative",a.style.background="#ffffff",a.style.overflow="hidden";try{const F=a.querySelector(".rpt-header")||a.firstElementChild;if(F){const nt=F.getBoundingClientRect(),at=a.getBoundingClientRect(),st=Math.max(0,nt.top-at.top),it=(a.classList.contains("quote-page--primary")?6:4)*j,U=st-it;U>0&&(a.style.transform=`translateY(${-U}px)`)}}catch{}w.appendChild(a),y.appendChild(w),u.body.appendChild(y);let v;try{v=await h(a,{...d,scrollX:0,scrollY:0,windowWidth:N,windowHeight:H})}finally{y.parentNode?.removeChild(y)}if(!v)continue;const P=k(v,246),f=S(v,244),E=Math.max(P,f),T=I(v,246),C=A(v,E,T),R=Math.max(.9,Math.min(1,c.scale||1)),q=K*R,D=C.height/C.width*q;let W=Number(c.rightMm)||0;const Z=x.classList.contains("quote-page--primary")?6:4,tt=S(C,244),et=q/C.width,ot=tt*et;let O=(Number(c.topMm)||0)+Z-ot;O<-60&&(O=-60);const rt=C.toDataURL("image/jpeg",.95);b>0&&M.addPage(),M.addImage(rt,"JPEG",W,O,q,D,`page-${b+1}`,"FAST"),b+=1,await new Promise(F=>requestAnimationFrame(F))}if(b===0)throw new Error("PDF generation produced no pages");if(t==="print"){const m=M.output("bloburl");if(s)try{s.location.href=m}catch{}else await new Promise(x=>{const u=document.createElement("iframe");Object.assign(u.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),u.onload=()=>{try{u.contentWindow?.focus(),u.contentWindow?.print()}catch{}setTimeout(()=>{u.remove(),x()},700)},u.src=m,document.body.appendChild(u)})}else M.save("reservations-report.pdf")}else{const c=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const M=await c.get("pdf").then(g=>g.output("bloburl"));await new Promise(g=>{const d=document.createElement("iframe");Object.assign(d.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),d.onload=()=>{try{d.contentWindow?.focus(),d.contentWindow?.print()}catch{}setTimeout(()=>{d.remove(),g()},700)},d.src=M,document.body.appendChild(d)})}else await c.save("reservations-report.pdf")}}finally{i.remove()}}export{Rt as buildReportsPdfPages,Ht as exportReportsPdf};
