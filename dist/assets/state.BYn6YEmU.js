import{d as L,n as B,h as it,b as P,A as re,a as st,m as ot,c as ct,i as rt,l as lt,p as te,t as u,q as dt,w as De,j as p,x as ut}from"./auth.Cluol2cK.js";const ft=L()||{};let z=(ft.technicians||[]).map(he);function Z(){return z}function O(e){return z=Array.isArray(e)?e.map(he):[],it({technicians:z}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),z}async function ze(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,r])=>{r!=null&&r!==""&&t.set(a,String(r))});const n=t.toString(),i=await P(`/technicians/${n?`?${n}`:""}`),s=i?.data??i;let o=[];Array.isArray(s)?o=s:s&&typeof s=="object"&&(Array.isArray(s.items)?o=s.items:Array.isArray(s.results)?o=s.results:Array.isArray(s.data)?o=s.data:Array.isArray(s.records)&&(o=s.records));const c=o.map(ne);return O(c)}async function $e(e){const t=await P("/technicians/",{method:"POST",body:e}),n=ne(t?.data??{});return O([...z,n]),n}async function me(e,t){const n=await P(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=ne(n?.data??{}),s=z.map(o=>String(o.id)===String(e)?i:o);return O(s),i}async function Me(e){await P(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),O(z.filter(t=>String(t.id)!==String(e)))}function pe({name:e,phone:t,email:n,telegramChatId:i,role:s,department:o,dailyWage:c,dailyTotal:a,status:r,notes:l,active:d=!0}){return{full_name:e??"",phone:t??"",email:n??null,telegram_chat_id:i??null,specialization:s??"",department:o??null,daily_wage:c??0,daily_total:a??null,status:r??"available",notes:l??null,active:d?1:0}}function ne(e={}){return Re({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,telegram_chat_id:e.telegram_chat_id,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function he(e={}){return Re(e)}function Re(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",i=e.phone??"",s=e.email??null,o=e.telegram_chat_id??e.telegramChatId??null,c=e.specialization??e.role??e.position??"",a=e.department??e.team??"",r=we(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=we(e.daily_total??e.dailyTotal??e.total??e.total_wage??r),d=Le(e.baseStatus??e.status??"available"),h=Le(e.status??e.baseStatus??"available"),f=e.notes??"",m=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:i,email:s,telegramChatId:o,role:c,department:a,dailyWage:r,dailyTotal:l,status:h,baseStatus:d,notes:f,active:m}}function we(e){const t=Number.parseFloat(B(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Le(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function J(e){return e instanceof re}const cn=Object.freeze(Object.defineProperty({__proto__:null,buildTechnicianPayload:pe,createTechnicianApi:$e,deleteTechnicianApi:Me,getTechniciansState:Z,isApiError:J,mapLegacyTechnician:he,mapTechnicianFromApi:ne,refreshTechniciansFromApi:ze,setTechniciansState:O,updateTechnicianApi:me},Symbol.toStringTag,{value:"Module"}));st();ot();ct();document.addEventListener("DOMContentLoaded",()=>{rt();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>lt()),e.dataset.listenerAttached="true")});function ee(e){const t=Number(e)||0,i=te()==="ar"?"ar-SA-u-nu-latn":"en-US",s=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${B(s)} SR`}function rn(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function ln(e){const t=new Date,n=e?.start?new Date(e.start):null,i=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":i&&!Number.isNaN(i.getTime())&&i<t?"completed":"ongoing"}function dn(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function D(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const mt="technicianPositions:updated";let T=[],xe=!1,k=null;function ge(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function je({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:i??null,label_en:s??null}}function pt(e){return T=Array.isArray(e)?e.map(ge).filter(t=>t.name!=="").sort((t,n)=>j(t).localeCompare(j(n),"ar",{sensitivity:"base"})):[],xe=!0,ae(),q()}function ae(){try{const e={positions:q()},t=new CustomEvent(mt,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function j(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function q(){return T.map(e=>({...e}))}function ht(e){const t=String(e??"").trim().toLowerCase();return t&&T.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function gt({forceRefresh:e=!1}={}){return xe&&!e?q():(k&&!e||(k=P("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return pt(n)}).finally(()=>{k=null})),k)}async function ie({forceRefresh:e=!1}={}){try{return await gt({forceRefresh:e})}catch(t){throw t instanceof re?t:new re(t?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function bt({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}){const o=je({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}),c=await P("/technician-positions/",{method:"POST",body:o}),a=ge(c?.data??{});return T=[...T,a],T.sort((r,l)=>j(r).localeCompare(j(l),"ar",{sensitivity:"base"})),ae(),a}async function yt(e,{name:t,cost:n,clientPrice:i,labelAr:s,labelEn:o}){if(!e)throw new Error("Position id is required");const c=je({name:t,cost:n,clientPrice:i,labelAr:s,labelEn:o}),a=await P(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:c}),r=ge(a?.data??{});return T=T.map(l=>l.id===r.id?r:l),T.sort((l,d)=>j(l).localeCompare(j(d),"ar",{sensitivity:"base"})),ae(),r}async function It(e){if(!e)throw new Error("Position id is required");return await P(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),T=T.filter(t=>t.id!==Number(e)),ae(),q()}const le="__ART_RATIO_TECH_SUB_TAB__",Ue=["technicians-management","technicians-positions"];let E=null,Pe=!1,Y=!1,G="",de=!1,_=null,$="technicians-management";const qe=Et();qe&&($=qe);async function Ve({showToastOnError:e=!0}={}){if(!Y){Y=!0,G="",I();try{await ze(),de=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),G=J(t)?t.message:u("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&p(G,"error")}finally{Y=!1,I()}}}function He(){return Z()}function X(e=""){return B(String(e)).trim().toLowerCase()}function vt(e){return e==null?"":String(e)}function U(e=""){return B(String(e)).replace(/[^0-9+]/g,"")}function A(e=""){const t=B(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...i]=t.split(".");return`${n}.${i.join("")}`}function x(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const i=e.selectionEnd;e.value=n,i!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function Et(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(le);return e&&Ue.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function At(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Ue.includes(e)){window.localStorage.removeItem(le);return}window.localStorage.setItem(le,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function Oe(e,t=0,n=null){const i=String(e??"").trim(),s=i?ht(i):null;return s?{matchedPosition:s,dailyWage:Number.isFinite(s.cost)?s.cost:0,dailyTotal:s.clientPrice==null?null:Number.isFinite(s.clientPrice)?s.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function We(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function ue(e,t=te()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function St(e,t=te()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function ke(){const{container:e,body:t}=We();!e||!t||(t.textContent="",e.hidden=!0)}function be(e,t={}){const{container:n,body:i}=We();if(!n||!i)return;const s=String(e??"").trim();if(!s){ke();return}const o=Oe(s,t?.dailyWage??0,t?.dailyTotal??null),c=ee(o.dailyWage||0),a=o.dailyTotal!=null?ee(o.dailyTotal):u("technicians.positionSummary.noClientPrice","â€”");o.matchedPosition?i.textContent=u("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",a):i.textContent=u("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",a),n.hidden=!1}function Q(){const e=document.getElementById("technician-position-options");if(!e)return;const t=q(),n=te(),i=new Set,s=[];t.forEach(o=>{const c=ue(o,n).trim();c&&!i.has(c.toLowerCase())&&(s.push(`<option value="${D(c)}"></option>`),i.add(c.toLowerCase()));const a=St(o,n).trim();a&&!i.has(a.toLowerCase())&&(s.push(`<option value="${D(a)}"></option>`),i.add(a.toLowerCase()));const r=o.name?.trim();r&&!i.has(r.toLowerCase())&&(s.push(`<option value="${D(r)}"></option>`),i.add(r.toLowerCase()))}),e.innerHTML=s.join("")}function Fe(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),s=t.map(a=>a?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(a=>{if(!a)return;const l=a.getAttribute("data-tech-tab")===s;a.classList.toggle("tab-active",l),a.classList.toggle("active",l),a.setAttribute("aria-selected",l?"true":"false"),a.setAttribute("tabindex",l?"0":"-1")}),n.forEach(a=>{if(!a)return;const l=a.getAttribute("data-tech-tab-panel")===s;a.hidden=!l,a.classList.toggle("active",l)}),$=s,At(s);const c=t.find(a=>a?.getAttribute("data-tech-tab")===s)?.closest("[data-tab-scroll]");c&&c.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),s==="technicians-positions"&&(N(),ie().then(()=>{N()}).catch(a=>{console.error("âŒ [technicians] failed to load positions for tab switch",a),p(a?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function ye(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",i=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=u(n,i)}function Ie(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=u("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function ve(){ye(E?"update":"add"),Ie(!!E),I()}function Tt(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,i=Array.from(new Set(e.map(o=>(o?.role||"").trim()).filter(Boolean))).sort((o,c)=>o.localeCompare(c,"ar",{sensitivity:"base"})),s=u("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${s}</option>`+i.map(o=>`<option value="${o}">${o}</option>`).join(""),n&&i.includes(n)?t.value=n:t.value="",t.value}function se(){const e=document.getElementById("technician-form");e&&(e.reset(),E=null,ye("add"),Ie(!1),ke())}function Bt(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),i=document.getElementById("technician-email"),s=document.getElementById("technician-telegram"),o=document.getElementById("technician-role"),c=document.getElementById("technician-department"),a=document.getElementById("technician-notes");!t||!n||!o||(t.value=e.name||"",n.value=U(e.phone||""),i&&(i.value=e.email||""),s&&(s.value=e.telegramChatId||""),o.value=e.role||"",c&&(c.value=e.department||""),a&&(a.value=e.notes||""),E=String(e.id),ye("update"),Ie(!0),be(o.value,e))}function _t(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-email"),i=document.getElementById("technician-telegram"),s=document.getElementById("technician-role"),o=document.getElementById("technician-department"),c=document.getElementById("technician-notes");if(!e||!t||!s)return null;const a=e.value.trim(),r=U(t.value.trim());t.value=r;const l=(n?.value||"").trim(),d=(i?.value||"").trim()||null,h=s.value.trim(),f=o?.value.trim()||"",m="available",g=c?.value.trim()||"",v=E?Ge(E):null,{dailyWage:y,dailyTotal:b}=Oe(h,v?.dailyWage??0,v?.dailyTotal??null);return a?r?h?!Number.isFinite(y)||y<0?(p(u("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):b!=null&&(!Number.isFinite(b)||b<0)?(p(u("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(be(h,{dailyWage:y,dailyTotal:b}),{name:a,phone:r,email:l,telegramChatId:d,role:h,department:f,dailyWage:Number.isFinite(y)?y:0,dailyTotal:b==null?null:Number(b),status:m,baseStatus:m,notes:g}):(p(u("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),s.focus(),null):(p(u("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(p(u("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function Ct(e){e.preventDefault();try{await ie()}catch(i){console.error("âŒ [technicians] failed to load positions before submit",i);const s=i?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");p(s,"error");return}const t=_t();if(!t)return;const n=pe({name:t.name,phone:t.phone,email:t.email||null,telegramChatId:t.telegramChatId||null,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{E?(await me(E,n),p(u("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await $e(n),p(u("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),se(),I()}catch(i){console.error("âŒ [technicians] handleTechnicianSubmit failed",i);const s=J(i)?i.message:u("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");p(s,"error")}}function Nt(){se()}function wt(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),email:document.getElementById("edit-technician-email"),telegram:document.getElementById("edit-technician-telegram"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=U(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.email&&t.email.value!==(e.email||"")&&(t.email.value=e.email||""),t.telegram&&t.telegram.value!==(e.telegramChatId||"")&&(t.telegram.value=e.telegramChatId||""),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const i=A(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==i&&(t.wage.value=i);const s=A(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==s&&(t.total.value=s);const o=e.baseStatus||e.status||"available";t.status.value!==o&&(t.status.value=o),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),x(t.phone,U),x(t.wage,A),x(t.total,A)}function Lt(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),i=document.getElementById("edit-technician-email"),s=document.getElementById("edit-technician-telegram"),o=document.getElementById("edit-technician-role"),c=document.getElementById("edit-technician-department"),a=document.getElementById("edit-technician-wage"),r=document.getElementById("edit-technician-total"),l=document.getElementById("edit-technician-status"),d=document.getElementById("edit-technician-notes");if(!e||!t||!n||!o||!a||!r||!l)return null;const h=e.value.trim(),f=t.value.trim(),m=U(n.value.trim());n.value=m;const g=(i?.value||"").trim(),v=(s?.value||"").trim()||null,y=o.value.trim(),b=c?.value.trim()||"",F=A(a.value.trim());a.value=F;const M=F===""?0:parseFloat(F),ce=A(r.value.trim());r.value=ce;const W=ce===""?null:parseFloat(ce),Ne=l.value||"available",at=d?.value.trim()||"";return h?f?m?y?Number.isNaN(M)||M<0?(p(u("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),a.focus(),null):W!=null&&(Number.isNaN(W)||W<0)?(p(u("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),r.focus(),null):{id:h,name:f,phone:m,email:g,telegramChatId:v,role:y,department:b,dailyWage:Number.isFinite(M)?M:0,dailyTotal:W==null?null:Number(W),status:Ne,baseStatus:Ne,notes:at}:(p(u("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),o.focus(),null):(p(u("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(p(u("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(p(u("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Pt(){const e=Lt();if(!e)return;const t=pe({name:e.name,phone:e.phone,email:e.email||null,telegramChatId:e.telegramChatId||null,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await me(e.id,t),p(u("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),I()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const i=J(n)?n.message:u("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");p(i,"error")}}function I(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=X(t?.value||"");if(Y&&!de){const l=u("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}if(G&&!de){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${G}</td></tr>`;return}const i=Ae(),{reservations:s=[]}=L(),o=new Date;Tt(i);const c=document.getElementById("technician-role-filter"),a=X(c?.value||""),r=i.filter(l=>a&&X(l.role||"")!==a?!1:n?X([l.name,l.phone,l.email,l.role,l.department,l.notes].filter(Boolean).join(" ")).includes(n):!0);if(r.length===0){const l=u("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}e.innerHTML=r.map(l=>{const d=E&&String(E)===String(l.id),m=(Ze(l.id,s,o)?"busy":l.status||l.baseStatus||"available")==="busy"?{label:u("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:u("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},g=u("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),v=u("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),y=De(),b=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${l.id}">${g}</button>`];return y&&b.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${l.id}">${v}</button>`),`
      <tr${d?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${l.id}" class="text-decoration-none">${l.name}</a></td>
        <td>${l.role||""}</td>
        <td>${l.department||"â€”"}</td>
        <td><span class="${m.className}"><span class="technician-status-badge__text">${m.label}</span></span></td>
        <td class="table-notes-cell">${l.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${b.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function oe(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function Ke(e="add"){const{submitBtn:t,cancelBtn:n}=oe(),i=e==="update";if(t){const s=i?"positions.form.actions.update":"positions.form.actions.submit",o=i?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=u(s,o)}n&&(n.classList.toggle("d-none",!i),n.textContent=u("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function Ee(){const{form:e,idInput:t,nameArInput:n,nameEnInput:i,costInput:s,clientPriceInput:o}=oe();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),i&&(i.value=""),s&&(s.value=""),o&&(o.value=""),_=null,Ke("add")}function qt(e){const{idInput:t,nameArInput:n,nameEnInput:i,costInput:s,clientPriceInput:o}=oe();!e||!s||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),i&&(i.value=e.labelEn||""),s.value=A(e.cost??0),o&&(o.value=e.clientPrice==null?"":A(e.clientPrice)),_=e.id||null,Ke("update"))}function Ft(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:i}=oe();if(!n)return null;const s=e?.value.trim()||"",o=t?.value.trim()||"",c=o||s,a=_?q().find(f=>String(f.id)===String(_)):null,r=A(n.value.trim());n.value=r;const l=r===""?0:parseFloat(r),d=i?A(i.value.trim()):"";i&&(i.value=d);const h=d===""?null:parseFloat(d);return c?!Number.isFinite(l)||l<0?(p(u("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):h!=null&&(!Number.isFinite(h)||h<0)?(p(u("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),i?.focus(),null):{id:_,name:a?.name||c,cost:Number(l.toFixed(2)),clientPrice:h==null?null:Number(h.toFixed(2)),labelAr:s||null,labelEn:o||null}:(p(u("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function V(){const e=document.getElementById("technician-role");if(!e)return;const t=E?Ge(E):null;be(e.value,t||{})}function N(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=q();if(t&&(t.textContent=B(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${u("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(i=>{const s=_&&String(_)===String(i.id),o=ee(i.cost||0),c=i.clientPrice==null?u("technicians.positionSummary.noClientPrice","â€”"):ee(i.clientPrice),a=ue(i,"ar")||"â€”",r=ue(i,"en")||"â€”",l=u("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),d=u("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${s?' class="technician-table-row-editing"':""}>
        <td>${D(a)}</td>
        <td>${D(r)}</td>
        <td>${D(o)}</td>
        <td>${D(c)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${i.id}">${l}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${i.id}">${d}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function Dt(e){e.preventDefault();const t=Ft();if(t)try{const n=!!_;n?await yt(t.id,t):await bt(t);const i=n?u("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):u("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");p(i),Ee(),N(),Q(),V()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const i=n?.message||u("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");p(i,"error")}}function zt(){Ee()}async function $t(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await ie();const i=q().find(s=>String(s.id)===String(n));if(!i){p(u("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}qt(i),N();return}if(t.classList.contains("position-delete-btn")){if(!confirm(u("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await It(n),_&&String(_)===String(n)&&Ee(),p(u("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),N(),Q(),V()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");p(n,"error")}}function Mt(e){const t=He().find(n=>String(n.id)===String(e));if(!t){p(u("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}Bt(t),p(u("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function Rt(e){if(!De()){ut();return}if(confirm(u("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await Me(e),p(u("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),E&&String(E)===String(e)&&se(),I()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=J(t)?t.message:u("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");p(n,"error")}}function un(){Se(),I()}function Ge(e){return He().find(t=>String(t.id)===String(e))||null}function xt(e){const t=new Set,n=s=>{if(s==null)return;const o=String(s).trim();o&&t.add(o)},i=s=>{Array.isArray(s)&&s.forEach(o=>{if(o!=null)if(typeof o=="object"){const c=o.id??o.technicianId??o.technician_id??(o.technician&&(o.technician.id??o.technician.technicianId??o.technician.technician_id));n(c)}else n(o)})};return i(e?.technicians),i(e?.techniciansDetails),Array.from(t)}function jt(e){const t=e?.start??e?.startDatetime??e?.start_datetime??e?.start_date??null,n=e?.end??e?.endDatetime??e?.end_datetime??e?.end_date??null;return{start:t,end:n}}function Ze(e,t=[],n){const i=vt(e);return i?t.some(s=>{if(!s)return!1;const o=String(s?.status||s?.reservationStatus||"").toLowerCase();if(o==="cancelled"||o==="canceled"||!xt(s).includes(i))return!1;const{start:a,end:r}=jt(s);if(!a||!r)return!1;const l=new Date(a),d=new Date(r);return Number.isNaN(l.getTime())||Number.isNaN(d.getTime())?!1:l<=n&&n<d}):!1}function Ae(){const e=L().reservations||[],t=Z();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let i=!1;const s=t.map(o=>{if(!o)return o;const c=o.baseStatus||o.status||"available";let a=c==="busy"?"busy":c;return Ze(o.id,e,n)&&(a="busy"),(a!==o.status||c!==o.baseStatus)&&(i=!0),{...o,baseStatus:c,status:a}});return i?(O(s),s):t}document.addEventListener("reservations:changed",()=>{const e=Z();if(Ae()===e)try{I()}catch{}});document.addEventListener("reservations:updated",()=>{const e=Z();if(Ae()===e)try{I()}catch{}});function Se(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",f=>{Ct(f).catch(m=>{console.error("âŒ [technicians] submit handler failed",m)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Nt),n.dataset.listenerAttached="true"),x(document.getElementById("technician-phone"),U);const i=document.getElementById("technician-role");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{V()}),i.dataset.listenerAttached="true");const s=document.getElementById("technicians-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",f=>{const m=f.target;if(m instanceof HTMLElement){if(m.classList.contains("technician-edit-btn")){const g=m.dataset.id;Mt(g)}if(m.classList.contains("technician-delete-btn")){const g=m.dataset.id;Rt(g).catch(v=>{console.error("âŒ [technicians] delete handler failed",v)})}}}),s.dataset.listenerAttached="true");const o=document.getElementById("search-technician-input");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",()=>{o.value=B(o.value),I()}),o.dataset.listenerAttached="true");const c=document.getElementById("technician-role-filter");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{I()}),c.dataset.listenerAttached="true");const a=document.getElementById("save-technician-changes");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{Pt().catch(f=>{console.error("âŒ [technicians] modal save failed",f)})}),a.dataset.listenerAttached="true");const r=document.getElementById("position-form");r&&!r.dataset.listenerAttached&&(r.addEventListener("submit",f=>{Dt(f).catch(m=>{console.error("âŒ [technicians] position submit failed",m)})}),r.dataset.listenerAttached="true");const l=document.getElementById("position-cancel-btn");l&&!l.dataset.listenerAttached&&(l.addEventListener("click",zt),l.dataset.listenerAttached="true");const d=document.getElementById("positions-table");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",$t),d.dataset.listenerAttached="true"),x(document.getElementById("position-cost"),A),x(document.getElementById("position-client-price"),A);const h=document.querySelector("[data-tech-tabs]");h&&!h.dataset.listenerAttached&&(h.querySelectorAll("[data-tech-tab]").forEach(m=>{m&&m.addEventListener("click",()=>{const g=m.getAttribute("data-tech-tab");Fe(g)})}),h.dataset.listenerAttached="true"),Fe($),ie().then(()=>{Q(),$==="technicians-positions"&&N(),V()}).catch(f=>{console.error("âŒ [technicians] failed to load technician positions",f),p(f?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),Pe||(document.addEventListener("technician:prefill",f=>{const m=f.detail;m&&wt(m)}),Pe=!0),t&&se(),$==="technicians-positions"&&N()}window.addEventListener("DOMContentLoaded",()=>{Se(),I(),ve(),Ve()});const Je=()=>{I()};window.addEventListener("technicians:updated",Je);document.addEventListener("technicians:updated",Je);document.addEventListener("technicians:refreshRequested",()=>{Se(),I(),ve(),Ve({showToastOnError:!1})});document.addEventListener("language:changed",()=>{ve(),Q(),$==="technicians-positions"&&N(),V()});document.addEventListener(dt.USER_UPDATED,()=>{I()});const Qe=()=>{Q(),$==="technicians-positions"&&N(),V()};window.addEventListener("technicianPositions:updated",Qe);document.addEventListener("technicianPositions:updated",Qe);function K(e){return B(String(e||"")).trim().toLowerCase()}function Ut(e){const t=Number.parseFloat(B(String(e??"1")));return!Number.isFinite(t)||t<=0||t>50?1:Math.max(1,Math.round(t))}function w(e){const t=String(e??"").trim().toLowerCase();return t||""}function Xe(){const{packages:e=[]}=L();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function Vt(e){const t=w(e);return t&&Xe().find(i=>w(i?.id??i?.packageId??i?.package_id)===t)||null}function Te(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(a=>({barcode:a}))),n.forEach(a=>{if(!a)return;if(typeof a=="string"||typeof a=="number"){const f=K(a);if(!f)return;t.push({equipmentId:null,barcode:f,normalizedBarcode:f,qty:1,price:0,desc:""});return}if(typeof a!="object")return;const r=K(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number),l=[a.equipmentId,a.equipment_id,a.itemId,a.item_id,a.id].find(f=>f!=null&&f!==""),d=[a.unit_price,a.unitPrice,a.price,a.daily_rate].find(f=>Number.isFinite(Number(f))),h=[a.quantity,a.qty,a.count].find(f=>f!=null&&String(f).trim()!=="");t.push({equipmentId:l!=null?String(l):null,barcode:a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??"",normalizedBarcode:r,qty:Ut(h),price:d!=null?Number(d):0,desc:a.description??a.desc??a.name??"",image:a.image??a.imageUrl??a.img??null})});const i=new Map,{equipment:s=[]}=L()||{},o=new Map,c=new Map;return(Array.isArray(s)?s:[]).forEach(a=>{if(!a||typeof a!="object")return;[a.id,a.equipment_id,a.equipmentId,a.item_id,a.itemId].map(d=>d!=null?String(d):"").filter(Boolean).forEach(d=>{o.has(d)||o.set(d,a)});const l=K(a.barcode);l&&!c.has(l)&&c.set(l,a)}),t.forEach(a=>{if(a.equipmentId&&o.has(a.equipmentId)){const r=o.get(a.equipmentId);if(r){if(a.desc||(a.desc=r.desc||r.description||r.name||""),a.barcode||(a.barcode=r.barcode||""),a.price==null||a.price===0){const l=r.price??r.unit_price,d=Number(l);Number.isFinite(d)&&d>=0&&d<1e6&&(a.price=d)}a.image||(a.image=r.image||r.imageUrl||r.img||null)}}else if(a.normalizedBarcode&&c.has(a.normalizedBarcode)){const r=c.get(a.normalizedBarcode);if(r){if(a.desc||(a.desc=r.desc||r.description||r.name||""),a.barcode||(a.barcode=r.barcode||""),a.price==null||a.price===0){const l=r.price??r.unit_price,d=Number(l);Number.isFinite(d)&&d>=0&&d<1e6&&(a.price=d)}a.image||(a.image=r.image||r.imageUrl||r.img||null)}}}),t.forEach(a=>{const r=a.normalizedBarcode||(a.barcode?K(a.barcode):""),l=r||(a.equipmentId?`id:${a.equipmentId}`:null);if(!l)return;if(!i.has(l)){i.set(l,{...a,normalizedBarcode:r});return}const d=i.get(l);d.qty+=a.qty,!d.price&&a.price&&(d.price=a.price),!d.desc&&a.desc&&(d.desc=a.desc),!d.image&&a.image&&(d.image=a.image)}),Array.from(i.values())}function Ht(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const i of t){const s=Number(i);if(Number.isFinite(s))return s}return Te(e).reduce((i,s)=>i+(s.price||0)*(s.qty||1),0)}function Ot(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Wt(){return Xe().map(t=>{const n=w(t?.id??t?.packageId??t?.package_id??t?.code),i=Ot(t)||n||"package",s=Ht(t);return{id:n,name:i,price:s,code:t?.package_code??t?.code??n,items:Te(t),raw:t}}).filter(t=>t.id)}function kt(e){const t=K(e);return t?Wt().filter(n=>n.items.some(i=>i.normalizedBarcode===t)):[]}function Kt(e){return Te(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let H=[],Ye=[],et=[],tt="single";function fn(){return H}function mn(e){H=Array.isArray(e)?e:[]}function pn(e){H=[...H,e]}function hn(e){Number.isInteger(e)&&e>=0&&(H=H.filter((t,n)=>n!==e))}function gn(){return Ye}function bn(e){Ye=Array.isArray(e)?e:[]}function yn(){return et}function In(e){et=Array.isArray(e)?e:[]}function vn(e){}function En(){return tt==="package"?"package":"single"}function An(e){tt=e==="package"?"package":"single"}function Sn(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[i="",s=""]=n.split("T"),o=i?i.slice(0,10):"",c=s.match(/(\d{1,2}:\d{2})/);let a="";if(c){const[r="00",l="00"]=c[0].split(":");a=`${r.padStart(2,"0")}:${l.padStart(2,"0")}`}return{date:o,time:a}}function Tn(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function S(e){return B(String(e||"")).trim().toLowerCase()}const Gt=864e13;function C(e){if(!e&&e!==0)return null;if(e instanceof Date){const i=e.getTime();return Number.isNaN(i)?null:new Date(i)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const i=new Date(e);return Number.isNaN(i.getTime())?null:i}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const s=new Date(i);if(!Number.isNaN(s.getTime()))return s}}if(!t.includes("T")&&t.includes(" ")){const i=t.indexOf(" ");t=`${t.slice(0,i)}T${t.slice(i+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const i=new Date(`${t}Z`);if(!Number.isNaN(i.getTime()))return i}return null}function Bn(e,t,n,i=null){if(!e||!t||!n)return!1;const s=C(t),o=C(n);if(!s||!o||s>=o)return!1;const c=S(e);if(!c)return!1;const a=L()||{},r=Array.isArray(a.reservations)?a.reservations:[],l=Array.isArray(a.maintenance)?a.maintenance:[],d=Array.isArray(a.equipment)?a.equipment:[],h=sn(d),f=_e(i);return r.some(g=>{if(!g||Ce(g,f)||!g.start||!g.end)return!1;const v=String(g?.status||g?.reservationStatus||"").toLowerCase();if(v==="cancelled"||v==="canceled")return!1;const y=C(g.start),b=C(g.end);return!y||!b||!(y<o&&b>s)?!1:Jt(g,c)})?!0:l.some(g=>{if(!Yt(g)||!tn(g,h).has(c))return!1;const{start:y,end:b}=nn(g);if(!y&&!b)return!0;const F=y??new Date(0),M=b??new Date(Gt);return F<o&&M>s})}function Zt(e,t,n,i=null){const s=w(e);if(!s||!t||!n)return!1;const o=C(t),c=C(n);if(!o||!c||o>=c)return!1;const a=L()||{},r=Array.isArray(a.reservations)?a.reservations:[],l=_e(i);return r.some(d=>{if(!d?.start||!d?.end||Ce(d,l))return!1;const h=String(d?.status||d?.reservationStatus||"").toLowerCase();if(h==="cancelled"||h==="canceled")return!1;const f=C(d.start),m=C(d.end);return!f||!m||!(f<c&&m>o)?!1:Qt(d,s)})}function _n(e,t,n,i=null){const s=S(e);if(!s||!t||!n)return[];const o=kt(s);return o.length?o.filter(c=>Zt(c.id,t,n,i)):[]}function nt(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(i=>{const s=e[i];Array.isArray(s)&&s.length&&t.push(s)}),t}function Jt(e,t){if(!t||!e||typeof e!="object")return!1;const n=S(e?.barcode);if(n&&n===t)return!0;const i=nt(e);for(const s of i)for(const o of s)if(Xt(o).has(t))return!0;return!1}function Qt(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const o of n){if(!o&&o!==0)continue;const c=w(o);if(c&&c===t)return!0}const i=e.packages;if(Array.isArray(i))for(const o of i){const c=w(o);if(c&&c===t)return!0}const s=nt(e);for(const o of s)for(const c of o)if(Be(c).has(t))return!0;return!1}function Xt(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const o=S(e);return o&&t.add(o),t}if(typeof e!="object")return t;const n=S(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(o=>{const c=e[o];Array.isArray(c)&&c.forEach(a=>{if(a!=null){if(typeof a=="string"||typeof a=="number"){const r=S(a);r&&t.add(r);return}if(typeof a=="object"){const r=S(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number);r&&t.add(r)}}})});const s=Be(e);return s.size&&s.forEach(o=>{const c=Vt(o);if(!c)return;Kt(c).forEach(r=>{const l=r.normalizedBarcode??S(r.barcode);l&&t.add(l)})}),t}function Be(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(i=>{const s=w(i);s&&t.add(s)}),e.package&&typeof e.package=="object"&&Be(e.package).forEach(s=>t.add(s)),Array.isArray(e.packages)&&e.packages.forEach(i=>{const s=w(i);s&&t.add(s)}),t}function Yt(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(an(e))return!1;for(const n of t){const i=en(n);if(i){if(i==="completed"||i==="cancelled"||i==="closed")return!1;if(i==="open"||i==="in_progress")return!0}}return!0}function en(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function tn(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(c=>{const a=S(c);a&&n.add(a)});const s=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(s){const c=S(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);c&&n.add(c)}return[e?.equipmentId,e?.equipment_id,s?.id,s?.equipmentId,s?.equipment_id].map(c=>c!=null?String(c):"").filter(Boolean).forEach(c=>{const a=t.get(c);if(!a)return;const r=S(a?.barcode??a?.equipmentBarcode??a?.code??a?.serial??a?.serialNumber??a?.serial_number);r&&n.add(r)}),n}function nn(e){const t=fe([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=fe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function an(e){return!!fe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function fe(e=[]){for(const t of e){const n=C(t);if(n)return n}return null}function sn(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{t.has(s)||t.set(s,n)})}),t}function Cn(e,t,n,i=null){if(!e||!t||!n)return!1;const s=new Date(t),o=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:c=[]}=L(),a=String(e),r=_e(i);return c.some(l=>{if(!l?.start||!l?.end||Ce(l,r))return!1;const d=String(l?.status||l?.reservationStatus||"").toLowerCase();if(d==="cancelled"||d==="canceled")return!1;const h=new Date(l.start),f=new Date(l.end);return Number.isNaN(h.getTime())||Number.isNaN(f.getTime())||!(h<o&&f>s)?!1:(Array.isArray(l.technicians)?l.technicians:[]).some(v=>String(v)===a)})}function _e(e){return R(e,new Set)}function Ce(e,t){if(!t||t.size===0)return!1;const n=R([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const i of n)if(t.has(i))return!0;return!1}function R(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(o=>R(o,t)),t;if(Array.isArray(e))return e.forEach(o=>R(o,t)),t;if(typeof e=="object"){const o=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return o.forEach(a=>{Object.prototype.hasOwnProperty.call(e,a)&&(c=!0,R(e[a],t))}),c||Object.values(e).forEach(a=>R(a,t)),t}const n=B(String(e??"")).trim();if(!n)return t;const i=[n,n.toLowerCase(),n.toUpperCase()],s=n.replace(/\D+/g,"");if(s){i.push(s);const o=Number.parseInt(s,10);Number.isNaN(o)||i.push(String(o))}return i.forEach(o=>{o&&t.add(o)}),t}export{mn as A,Zt as B,Vt as C,Ht as D,Ot as E,In as F,An as G,bn as H,q as I,ht as J,Xe as K,ie as L,cn as M,un as a,Te as b,rn as c,ln as d,D as e,ee as f,Ge as g,gn as h,Wt as i,vn as j,fn as k,Tn as l,ne as m,S as n,yn as o,_n as p,Bn as q,ze as r,Ae as s,dn as t,pn as u,En as v,hn as w,Cn as x,Sn as y,w as z};
