import{r as O,a as U,c as D,g as W,j as l,b as h,t as _}from"./auth.B4em9lkc.js";import{i as G}from"./dashboardShell.DF2kUed9.js";O({ar:{notifications:{title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",header:"ğŸ”” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",subtitle:"Ø£Ø±Ø³Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„ÙØ±ÙŠÙ‚ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª/Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.",form:{entityType:"Ø§Ù„Ù†ÙˆØ¹",entity:{reservation:"Ø­Ø¬Ø²",project:"Ù…Ø´Ø±ÙˆØ¹"},search:"Ø¨Ø­Ø«","search.placeholder":"Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"},table:{headers:{code:"Ø§Ù„ÙƒÙˆØ¯",title:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",when:"Ø§Ù„ÙˆÙ‚Øª",customer:"Ø§Ù„Ø¹Ù…ÙŠÙ„",actions:"Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"},loading:"â³ Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«â€¦",select:"Ø§Ø®ØªÙŠØ§Ø±"},channels:{email:"Ø¥ÙŠÙ…ÙŠÙ„",telegram:"ØªÙ„ÙŠØºØ±Ø§Ù…"},compose:{title:"âœ‰ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø©",recipients:"Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†",toTechnicians:"Ø§Ù„ÙÙ†ÙŠÙˆÙ† Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†ÙˆÙ†",toAdmins:"Ø§Ù„Ø¥Ø¯Ù…Ù†",subject:"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹",body:"Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©",templates:{reminder:"ğŸ“Œ ØªØ°ÙƒÙŠØ±",note:"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©"},send:"ğŸš€ Ø¥Ø±Ø³Ø§Ù„",sentOk:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"},logs:{title:"ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",subtitle:"ØªØ§Ø¨Ø¹ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ­Ø§Ù„Ø© ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©.",refresh:"ğŸ”„ ØªØ­Ø¯ÙŠØ«",clear:"ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„",prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚",next:"Ø§Ù„ØªØ§Ù„ÙŠ",filters:{allEntities:"ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹",allChannels:"ÙƒÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª",allStatuses:"ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª",sent:"Ù…Ø±Ø³Ù„Ø©",failed:"ÙØ§Ø´Ù„Ø©","q.placeholder":"Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/Ø§Ù„Ù…Ø¹Ø±Ù‘Ù"},headers:{time:"Ø§Ù„ÙˆÙ‚Øª",event:"Ø§Ù„Ø­Ø¯Ø«",entity:"Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø¹Ø±Ù",recipient:"Ø§Ù„Ù…Ø³ØªÙ„Ù…",channel:"Ø§Ù„Ù‚Ù†Ø§Ø©",status:"Ø§Ù„Ø­Ø§Ù„Ø©",error:"Ø§Ù„Ø®Ø·Ø£"},empty:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.",loading:"â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"}}}});U();G();const t={};let L=null,x=null,w=null;function o(n){return document.querySelector(n)}function Q(){t.entityType=o("#notif-entity-type"),t.search=o("#notif-search"),t.resultsBody=o("#notif-results-body"),t.composeSection=o("#notif-compose-section"),t.selectedSummary=o("#notif-selected-summary"),t.chEmail=o("#notif-channel-email"),t.chTelegram=o("#notif-channel-telegram"),t.toTechs=o("#notif-to-techs"),t.toAdmins=o("#notif-to-admins"),t.extraEmails=o("#notif-extra-emails"),t.extraChatIds=o("#notif-extra-chatids"),t.subject=o("#notif-subject"),t.body=o("#notif-body"),t.sendBtn=o("#notif-send-btn"),t.previewBtn=o("#notif-preview-btn"),t.retryLastBtn=o("#notif-retry-last"),t.previewBox=o("#notif-preview"),t.tReminder=o("#notif-template-reminder"),t.tNote=o("#notif-template-note"),t.logEntity=o("#log-filter-entity"),t.logChannel=o("#log-filter-channel"),t.logStatus=o("#log-filter-status"),t.logQ=o("#log-filter-q"),t.logRefresh=o("#log-refresh-btn"),t.logClear=o("#log-clear-btn"),t.logBody=o("#notif-logs-body"),t.logPagination=o("#log-pagination"),t.logFailedSummary=o("#notif-logs-failed-summary"),t.tgSearch=o("#tg-tech-search"),t.tgSearchBtn=o("#tg-tech-search-btn"),t.tgRefreshBtn=o("#tg-tech-refresh-btn"),t.tgBody=o("#tg-tech-body"),t.tgAdminGenBtn=o("#tg-admin-gen-btn"),t.tgAdminCopyBtn=o("#tg-admin-copy-btn"),t.tgAdminBody=o("#tg-admin-body"),t.tgAdminLinkBox=o("#tg-admin-link-box"),t.tgChatSearch=o("#tg-chat-tech-search"),t.tgChatPick=o("#tg-chat-pick-btn"),t.tgChatRefresh=o("#tg-chat-refresh-btn"),t.tgChatSelected=o("#tg-chat-selected"),t.tgChatMessages=o("#tg-chat-messages"),t.tgChatInput=o("#tg-chat-input"),t.tgChatSend=o("#tg-chat-send")}function j(n,a){const e=n.start_datetime||n.startDate||"",r=n.end_datetime||n.endDate||"";return e&&r&&e!==r?`${e} â€” ${r}`:e||r||""}function z(n,a){if(!Array.isArray(n)||n.length===0){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${_("notifications.table.loading","Ù„Ø§ Ù†ØªØ§Ø¦Ø¬")}</td></tr>`;return}t.resultsBody.innerHTML=n.map(e=>{const r=a==="reservation"?e.reservation_code||"":e.project_code||"",i=e.title||"",s=j(e),c=a==="reservation"?e.customer_name||"":e.client_name||"";return`
      <tr>
        <td>${r||"â€”"}</td>
        <td>${i||"â€”"}</td>
        <td>${s||"â€”"}</td>
        <td>${c||"â€”"}</td>
        <td><button type="button" class="btn btn-sm btn-primary" data-select-id="${e.id}" data-select-type="${a}">${_("notifications.table.select","Ø§Ø®ØªÙŠØ§Ø±")}</button></td>
      </tr>
    `}).join("")}async function M(){const n=t.entityType.value,a=(t.search.value||"").trim();try{const e=n==="reservation"?"/reservations/":"/projects/",r=new URLSearchParams;a!==""&&r.set("search",a),r.set("limit","20");const i=await h(`${e}?${r.toString()}`);z(i?.data??[],n)}catch(e){console.error(e),t.resultsBody.innerHTML='<tr><td colspan="5" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</td></tr>'}}function K(){x&&clearTimeout(x),x=setTimeout(M,350)}function V(n,a){const e=n==="reservation"?a.reservation_code||"":a.project_code||"",r=a.title||e||n,i=j(a),s=a.location||"",c=n==="reservation"?a.customer_name||"":a.client_name||"";return[e?`Ø§Ù„ÙƒÙˆØ¯: ${e}`:"",`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${r}`,i?`Ø§Ù„ÙˆÙ‚Øª: ${i}`:"",s?`Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${s}`:"",c?`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${c}`:""].filter(Boolean).join(" | ")}async function J(n,a){try{const i=(await h(`${a==="reservation"?"/reservations/":"/projects/"}?id=${encodeURIComponent(n)}`))?.data;if(!i)throw new Error("Not found");L={type:a,id:Number(i.id),summary:V(a,i)},t.selectedSummary.textContent=L.summary,t.composeSection.hidden=!1;try{setTimeout(()=>{t.composeSection?.scrollIntoView({behavior:"smooth",block:"start"}),t.body&&typeof t.body.focus=="function"&&t.body.focus()},10)}catch{}try{await E()}catch{}}catch(e){console.error(e),l("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯")}}function X(n,{prefix:a}={}){if(!t.previewBox)return;const e=N(n,{prefix:a});t.previewBox.innerHTML=e;try{Y(n)}catch{}}function N(n,{prefix:a}={}){const e=n?.sent||null,r=n?.targets||{},i=n?.targets_detail||{};let s=Number(r.email||0),c=Number(r.telegram||0);const m=Array.isArray(i.email)?i.email:[],u=Array.isArray(i.telegram)?i.telegram:[];!s&&m.length&&(s=m.length),!c&&u.length&&(c=u.length);const d=(y,v=10)=>{const C=y.map(B=>String(B.name||B.recipient||"")).filter(Boolean),f=Array.from(new Set(C));return f.length?f.length<=v?f.join("ØŒ "):f.slice(0,v).join("ØŒ ")+`ØŒ Ùˆ+${f.length-v} Ø¢Ø®Ø±ÙŠÙ†`:""},g=[];if(s){const y=e&&typeof e.email=="number"?`${e.email}/${s}`:String(s),v=d(m);g.push(`Ø¥ÙŠÙ…ÙŠÙ„: <strong>${y}</strong>${v?` â€” ${v}`:""}`)}if(c){const y=e&&typeof e.telegram=="number"?`${e.telegram}/${c}`:String(c),v=d(u);g.push(`ØªÙ„ÙŠØºØ±Ø§Ù…: <strong>${y}</strong>${v?` â€” ${v}`:""}`)}const p=a?`<span class="text-base-content/80">${a}</span> â€” `:"",b=g.length?g.join(" | "):"Ù„Ø§ Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†.";return p+b}function Y(n){const a=n?.targets||{},e=n?.targets_detail||{};let r=Number(a.email||0),i=Number(a.telegram||0);!r&&Array.isArray(e.email)&&(r=e.email.length),!i&&Array.isArray(e.telegram)&&(i=e.telegram.length);const s=(c,m,u)=>{if(!c)return;const d=c.parentElement?.querySelector("span");d&&(d.textContent=u?`${m} (${u})`:m)};s(t.chEmail,"Ø¥ÙŠÙ…ÙŠÙ„",r),s(t.chTelegram,"ØªÙ„ÙŠØºØ±Ø§Ù…",i)}async function Z(){if(!L){l("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}const n={email:!!t.chEmail.checked,telegram:!!t.chTelegram.checked};if(!n.email&&!n.telegram){l("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");return}const a={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(r=>r.trim()).filter(Boolean),additional_telegram_chat_ids:(t.extraChatIds.value||"").split(",").map(r=>r.trim()).filter(Boolean)},e={subject:(t.subject.value||"ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ").trim(),text:(t.body.value||"").trim()};if(!e.text){l("Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");return}try{const r=await h("/notifications/send.php",{method:"POST",body:{entity_type:L.type,entity_id:L.id,channels:n,recipients:a,message:e}}),i=r?.data||{},s=i?.sent||{email:0,telegram:0},c=i?.targets||{email:0,telegram:0},m=i?.targets_detail||{email:[],telegram:[]},u=Number(s.email||0),d=Number(s.telegram||0);let g=Number(c.email||0),p=Number(c.telegram||0);!g&&Array.isArray(m.email)&&(g=m.email.length),!p&&Array.isArray(m.telegram)&&(p=m.telegram.length);const b=[],y=g>0||u>0,v=p>0||d>0;if(y){const f=u>0?`Ø¥ÙŠÙ…ÙŠÙ„: ${u}/${g}`:g>0?`Ø¥ÙŠÙ…ÙŠÙ„: ${g}`:"";f&&b.push(f)}if(v){const f=d>0?`ØªÙ„ÙŠØºØ±Ø§Ù…: ${d}/${p}`:p>0?`ØªÙ„ÙŠØºØ±Ø§Ù…: ${p}`:"";f&&b.push(f)}y&&u===0&&g>0&&i?.errors?.last_email_error&&b.push("ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯");const C=b.length?` â€” ${b.join(" | ")}`:"";l(`${_("notifications.compose.sentOk","ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­")}${C}`),X(i,{prefix:"Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„"});try{const f=Number(c.email||0)+Number(c.telegram||0),B=Number(s.email||0)+Number(s.telegram||0),F=f>B;if(t.retryLastBtn){const H=r?.data?.batch_id||i?.batch_id;F&&H?(t.retryLastBtn.hidden=!1,t.retryLastBtn.setAttribute("data-batch",String(H))):(t.retryLastBtn.hidden=!0,t.retryLastBtn.removeAttribute("data-batch"))}}catch{}$()}catch(r){console.error(r);const i=r&&r.message?String(r.message):"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";l(i)}}async function tt(){const n=t.retryLastBtn?.getAttribute("data-batch")||"";if(!n){l("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©");return}try{const a=await h("/notifications/retry.php",{method:"POST",body:{batch_id:n}}),e=Number(a?.data?.sent||0);l(`ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© â€” Ø£ÙØ±Ø³Ù„Øª: ${e}`),$()}catch(a){console.error(a);const e=a&&(a.payload?.error||a.message)?String(a.payload?.error||a.message):"ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©";l(e)}}async function E(){if(!L){l("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}const n={email:!!t.chEmail.checked,telegram:!!t.chTelegram.checked};if(!n.email&&!n.telegram){l("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");return}const a={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(e=>e.trim()).filter(Boolean),additional_telegram_chat_ids:(t.extraChatIds.value||"").split(",").map(e=>e.trim()).filter(Boolean)};try{const r=(await h("/notifications/resolve.php",{method:"POST",body:{entity_type:L.type,entity_id:L.id,channels:n,recipients:a}}))?.data||{};t.previewBox&&(t.previewBox.innerHTML=N(r)),l("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")}catch(e){console.error(e),l("ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")}}function et(){t.search.addEventListener("input",K),t.entityType.addEventListener("change",()=>{t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${_("notifications.table.loading","Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«â€¦")}</td></tr>`,M()}),t.resultsBody.addEventListener("click",e=>{const r=e.target.closest("[data-select-id]");r&&J(r.getAttribute("data-select-id"),r.getAttribute("data-select-type"))}),t.tReminder.addEventListener("click",()=>{const e=`ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø­Ø¬Ø²/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:
ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ ÙˆØ§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù….`;t.body.value=e}),t.tNote.addEventListener("click",()=>{const e=`Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:
ÙŠØ±Ø¬Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.`;t.body.value=e}),t.sendBtn.addEventListener("click",Z),t.tgSearchBtn&&t.tgSearchBtn.addEventListener("click",A),t.tgRefreshBtn&&t.tgRefreshBtn.addEventListener("click",A),t.tgSearch&&t.tgSearch.addEventListener("keydown",e=>{e.key==="Enter"&&A()}),t.tgBody&&t.tgBody.addEventListener("click",async e=>{const r=e.target.closest("[data-gen-id]"),i=e.target.closest("[data-copy-link]"),s=e.target.closest("[data-unlink-id]");if(r){const c=r.getAttribute("data-gen-id");await lt(c);return}if(i){const c=i.getAttribute("data-copy-link");if(c)try{await navigator.clipboard.writeText(c),l("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·")}catch{l("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹")}return}if(s){const c=s.getAttribute("data-unlink-id");await gt(c);return}}),t.tgAdminGenBtn&&t.tgAdminGenBtn.addEventListener("click",dt),t.tgAdminCopyBtn&&t.tgAdminCopyBtn.addEventListener("click",async()=>{const e=t.tgAdminCopyBtn.getAttribute("data-link");if(e)try{await navigator.clipboard.writeText(e),l("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}catch{l("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®")}}),t.tgAdminBody&&t.tgAdminBody.addEventListener("click",async e=>{const r=e.target.closest("[data-admin-unlink]");if(!r)return;const i=r.getAttribute("data-admin-unlink");await mt(i)}),t.previewBtn&&t.previewBtn.addEventListener("click",E),t.retryLastBtn&&t.retryLastBtn.addEventListener("click",tt),t.tgChatPick&&t.tgChatPick.addEventListener("click",P),t.tgChatRefresh&&t.tgChatRefresh.addEventListener("click",T),t.tgChatSend&&t.tgChatSend.addEventListener("click",ct),t.tgChatSearch&&t.tgChatSearch.addEventListener("keydown",e=>{e.key==="Enter"&&P()});const n=()=>{w&&clearTimeout(w),w=setTimeout(()=>{L&&E().catch(()=>{})},250)};t.chEmail&&t.chEmail.addEventListener("change",n),t.chTelegram&&t.chTelegram.addEventListener("change",n),t.toTechs&&t.toTechs.addEventListener("change",n),t.toAdmins&&t.toAdmins.addEventListener("change",n),t.extraEmails&&t.extraEmails.addEventListener("input",n),t.extraChatIds&&t.extraChatIds.addEventListener("input",n);const a=()=>{S=1,$()};["change","input"].forEach(e=>{t.logEntity.addEventListener(e,a),t.logChannel.addEventListener(e,a),t.logStatus.addEventListener(e,a),t.logQ.addEventListener(e,()=>{x&&clearTimeout(x),x=setTimeout(()=>{S=1,$()},350)})}),t.logRefresh.addEventListener("click",$),t.logClear&&t.logClear.addEventListener("click",async()=>{if(window.confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±."))try{const r=I();await h(`/notifications/logs.php?${r.toString()}`,{method:"DELETE"}),l("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„"),S=1,$()}catch(r){console.error(r),l("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„")}}),t.logPagination&&t.logPagination.addEventListener("click",e=>{const r=e.target.closest("[data-page]");if(!r)return;const i=Number(r.getAttribute("data-page"))||1;i!==S&&(S=i,$())})}let S=1;const R=20;function I(){const n=new URLSearchParams;return t.logEntity.value&&n.set("entity_type",t.logEntity.value),t.logChannel.value&&n.set("channel",t.logChannel.value),t.logStatus.value&&n.set("status",t.logStatus.value),(t.logQ.value||"").trim()&&n.set("q",t.logQ.value.trim()),n.set("limit",String(R)),n.set("page",String(S)),n}function nt(n){const a=Number(n?.total||0),e=Number(n?.pages||1),r=Number(n?.page||1);if(!t.logPagination)return;if(a<=R){t.logPagination.innerHTML="";return}const i=(d,g,p=!1,b=!1)=>{const y=["btn","btn-sm"];return b?y.push("btn-primary"):y.push("btn-outline"),p&&y.push("btn-disabled"),`<button type="button" class="${y.join(" ")}" data-page="${g}" ${p?"disabled":""}>${d}</button>`};let s="";s+=i(_("notifications.logs.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"),Math.max(1,r-1),r<=1);const c=7,m=(d,g)=>Array.from({length:g-d+1},(p,b)=>d+b);let u=[];if(e<=c)u=m(1,e);else{const d=Math.max(2,r-1),g=Math.min(e-1,r+1);u=[1,...m(d,g),e]}for(const d of u){if(d<1||d>e)continue;const g=d===r;s+=i(String(d),d,!1,g)}s+=i(_("notifications.logs.next","Ø§Ù„ØªØ§Ù„ÙŠ"),Math.min(e,r+1),r>=e),t.logPagination.innerHTML=s}function at(n){return{reservation_created:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø²",reservation_reminder_24h:"ØªØ°ÙƒÙŠØ± 24 Ø³Ø§Ø¹Ø©",reservation_reminder_1h:"ØªØ°ÙƒÙŠØ± Ø³Ø§Ø¹Ø©",reservation_technician_assigned:"ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ (Ø­Ø¬Ø²)",reservation_status_changed:"ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø­Ø¬Ø²",project_created:"Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹",project_technician_assigned:"ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ (Ù…Ø´Ø±ÙˆØ¹)",manual_notification:"Ø¥Ø±Ø³Ø§Ù„ ÙŠØ¯ÙˆÙŠ"}[n]||n}function rt(n){if(!Array.isArray(n)||n.length===0){t.logBody.innerHTML=`<tr><td colspan="8" class="text-center text-muted">${_("notifications.logs.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.")}</td></tr>`;return}t.logBody.innerHTML=n.map(a=>{const e=a.created_at||"â€”",r=at(a.event_type||""),i=`${a.entity_type||""} #${a.entity_id||""}`,s=a.recipient_display||`${a.recipient_type||""}: ${a.recipient_identifier||""}`,c=a.recipient_name||"",m=a.channel||"",u=a.status||"",d=(a.error||"").toString().slice(0,140);return`
      <tr>
        <td>${e}</td>
        <td>${r}</td>
        <td>${i}</td>
        <td>${c||"â€”"}</td>
        <td>${s}</td>
        <td>${m}</td>
        <td>${u==="sent"?'<span class="badge bg-primary-subtle">Ù…Ø±Ø³Ù„Ø©</span>':'<span class="badge bg-danger-subtle">ÙØ§Ø´Ù„Ø©</span>'}</td>
        <td title="${d}">${d}</td>
      </tr>
    `}).join("")}async function $(){try{t.logBody.innerHTML=`<tr><td colspan="8" class="text-center text-muted">${_("notifications.logs.loading","â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦")}</td></tr>`;const n=I(),a=await h(`/notifications/logs.php?${n.toString()}`),e=Array.isArray(a?.data)?a.data:[];rt(e),it(e),nt(a?.meta||{})}catch(n){console.error(n),t.logBody.innerHTML='<tr><td colspan="7" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</td></tr>'}}function it(n){if(t.logFailedSummary)try{const a=(Array.isArray(n)?n:[]).filter(s=>(s?.status||"")==="failed");if(!a.length){t.logFailedSummary.classList.add("hidden"),t.logFailedSummary.textContent="";return}const e=a.map(s=>String(s.recipient_display||`${s.recipient_type||""}: ${s.recipient_identifier||""}`)).filter(Boolean),r=Array.from(new Set(e)),i=r.length<=10?r.join("ØŒ "):r.slice(0,10).join("ØŒ ")+`ØŒ Ùˆ+${r.length-10} Ø¢Ø®Ø±ÙŠÙ†`;t.logFailedSummary.textContent=`ÙØ§Ø´Ù„Ø©: ${a.length} â€” ${i}`,t.logFailedSummary.classList.remove("hidden")}catch{t.logFailedSummary.classList.add("hidden")}}async function st(){try{t.tgWebhookInfo&&(t.tgWebhookInfo.textContent="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦");const n=await h("/telegram/webhook-manage.php"),a=n?.data||n||{},e=a.url||"â€”",r=a.has_custom_certificate?"yes":"no",i=a.pending_update_count!=null?String(a.pending_update_count):"â€”",s=a.last_error_message?`Ø®Ø·Ø£: ${a.last_error_message}`:"",c=a.last_error_date?new Date(a.last_error_date*1e3).toLocaleString():"",m=[`URL: ${e}`,`Pending: ${i}`,`Cert: ${r}`];s&&m.push(s),c&&m.push(`ÙˆÙ‚Øª Ø§Ù„Ø®Ø·Ø£: ${c}`),t.tgWebhookInfo&&(t.tgWebhookInfo.textContent=m.join(" | "))}catch(n){console.error(n),t.tgWebhookInfo&&(t.tgWebhookInfo.textContent="ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„Ø©")}}async function ot(){if(t.diagBody)try{t.diagBody.innerHTML='<tr><td colspan="3" class="text-center text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</td></tr>';const n=await h("/notifications/diagnostics.php"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];if(!a.length){t.diagBody.innerHTML='<tr><td colspan="3" class="text-center text-muted">â€”</td></tr>';return}t.diagBody.innerHTML=a.map(e=>{const i=!!e.ok?'<span class="badge bg-primary-subtle">OK</span>':'<span class="badge bg-danger-subtle">Ù…ÙÙ‚ÙˆØ¯</span>',s=e.hint||"";return`<tr><td>${e.name}</td><td>${i}</td><td>${s}</td></tr>`}).join("")}catch(n){console.error(n),t.diagBody.innerHTML='<tr><td colspan="3" class="text-center text-error">ÙØ´Ù„ Ø§Ù„ÙØ­Øµ</td></tr>'}}(async function(){await D();const a=await W();if(!a||a.role!=="admin"){l("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·"),window.location.href="home.html";return}Q(),et(),M(),$(),A(),q(),st(),ot()})();let k=null;async function P(){const n=(t.tgChatSearch?.value||"").trim();if(!n){l("Ø§ÙƒØªØ¨ Ø§Ø³Ù…/Ø¬ÙˆØ§Ù„ Ø§Ù„ÙÙ†ÙŠ Ù„Ù„Ø¨Ø­Ø«");return}try{const a=new URLSearchParams;a.set("search",n),a.set("limit","5");const e=await h(`/technicians/?${a.toString()}`),r=Array.isArray(e?.data)?e.data:[];if(!r.length){l("Ù„Ø§ Ù†ØªØ§Ø¦Ø¬");return}const i=r[0];k={id:i.id,name:i.full_name||i.name||String(i.id)},t.tgChatSelected&&(t.tgChatSelected.textContent=`Ø§Ù„Ù…Ø­Ø¯Ø¯: ${k.name}`),await T()}catch(a){console.error("[chatPickTechnician] primary lookup failed",a);try{const e=await h("/technicians/?limit=20"),r=Array.isArray(e?.data)?e.data:[],i=g=>String(g||"").toLowerCase(),s=g=>String(g||"").replace(/[^0-9]/g,""),c=i(n),m=s(n),u=r.find(g=>i(g.full_name||g.name).includes(c)||m&&s(g.phone||"").includes(m));if(u){k={id:u.id,name:u.full_name||u.name||String(u.id)},t.tgChatSelected&&(t.tgChatSelected.textContent=`Ø§Ù„Ù…Ø­Ø¯Ø¯: ${k.name}`),await T();return}const d=a&&(a.payload?.error||a.message)?String(a.payload?.error||a.message):"Ù„Ø§ Ù†ØªØ§Ø¦Ø¬";l(`ÙØ´Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙ†ÙŠ â€” ${d}`)}catch(e){console.error("[chatPickTechnician] fallback lookup failed",e);const r=e&&(e.payload?.error||e.message)?String(e.payload?.error||e.message):"ÙØ´Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙ†ÙŠ";l(r)}}}async function T(){if(!k){l("Ø§Ø®ØªØ± ÙÙ†ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}try{t.tgChatMessages&&(t.tgChatMessages.innerHTML='<div class="text-center text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>');const n=new URLSearchParams;n.set("technician_id",String(k.id)),n.set("limit","100");const a=await h(`/telegram/messages.php?${n.toString()}`),e=Array.isArray(a?.data)?a.data:Array.isArray(a)?a:[];if(!e.length){t.tgChatMessages.innerHTML='<div class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';return}const r=e.map(i=>{const s=i.direction==="outbound",c=s?"Ø£Ù†Ø§":i.technician_name||"ÙÙ†ÙŠ",m=s?"justify-end":"justify-start",u=s?"bg-primary text-primary-content":"bg-base-200",d=i.created_at||"",g=(i.text||"").replace(/</g,"&lt;");return`<div class="flex ${m}"><div class="rounded-xl px-3 py-2 m-1 max-w-[80%] ${u}"><div class="text-xs opacity-70">${c} â€¢ ${d}</div><div>${g}</div></div></div>`}).join("");t.tgChatMessages.innerHTML=r,t.tgChatMessages.scrollTop=t.tgChatMessages.scrollHeight}catch(n){console.error(n),t.tgChatMessages.innerHTML='<div class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>'}}async function ct(){if(!k){l("Ø§Ø®ØªØ± ÙÙ†ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}const n=(t.tgChatInput?.value||"").trim();if(!n){l("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©");return}try{await h("/telegram/messages.php",{method:"POST",body:{technician_id:k.id,text:n}}),t.tgChatInput&&(t.tgChatInput.value=""),await T()}catch(a){console.error(a);const e=a&&(a.payload?.error||a.message)?String(a.payload?.error||a.message):"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";l(e)}}async function A(){if(t.tgBody)try{t.tgBody.innerHTML='<tr><td colspan="4" class="text-center text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>';const n=(t.tgSearch?.value||"").trim(),a=new URLSearchParams;n&&a.set("search",n),a.set("limit","20");const e=await h(`/technicians/?${a.toString()}`),r=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];if(!r.length){t.tgBody.innerHTML='<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';return}t.tgBody.innerHTML=r.map(i=>{const s=i.full_name||i.name||"",c=i.phone||"",m=!!(i.telegram_chat_id||i.telegramChatId||i.has_tg_link),u=m?'<span class="badge bg-primary-subtle">Ù…Ø±ØªØ¨Ø·</span>':'<span class="badge bg-warning-subtle">ØºÙŠØ± Ù…Ø±ØªØ¨Ø·</span>',d=m?`<button type="button" class="btn btn-sm btn-outline btn-error" data-unlink-id="${i.id}">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</button>`:`<button type="button" class="btn btn-sm" data-gen-id="${i.id}">ğŸ”— ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø·</button>`;return`<tr>
        <td>${s}</td>
        <td>${c}</td>
        <td>${u}</td>
        <td>${d}</td>
      </tr>`}).join("")}catch(n){console.error(n),t.tgBody.innerHTML='<tr><td colspan="4" class="text-center text-error">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>'}}async function lt(n){try{const a=await h(`/telegram/generate-link.php?technician_id=${encodeURIComponent(n)}`),e=a?.data?.link||a?.link||null;if(!e){l("âš ï¸ ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·");return}const r=t.tgBody?.querySelector(`button[data-gen-id="${n}"]`)?.closest("tr");if(r){const i=r.querySelector("td:last-child");i&&(i.innerHTML=`<button type="button" class="btn btn-sm" data-copy-link="${e}">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>`)}l("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·")}catch(a){console.error(a),l("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·")}}async function q(){if(t.tgAdminBody)try{t.tgAdminBody.innerHTML='<tr><td colspan="3" class="text-center text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>';const n=await h("/telegram/admins.php"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];if(!a.length){t.tgAdminBody.innerHTML='<tr><td colspan="3" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ø¥Ø¯Ù…Ù† Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';return}t.tgAdminBody.innerHTML=a.map(e=>{const r=String(e.chat_id||""),i=e.last_used_at||"â€”";return`<tr>
        <td>${r}</td>
        <td>${i}</td>
        <td><button type="button" class="btn btn-sm btn-outline btn-error" data-admin-unlink="${r}">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</button></td>
      </tr>`}).join("")}catch(n){console.error(n),t.tgAdminBody.innerHTML='<tr><td colspan="3" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†</td></tr>'}}async function dt(){try{const n=await h("/telegram/generate-link.php?context=admin"),a=n?.data?.link||n?.link||null;if(!a){l("âš ï¸ ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†");return}t.tgAdminCopyBtn&&(t.tgAdminCopyBtn.removeAttribute("disabled"),t.tgAdminCopyBtn.setAttribute("data-link",a)),t.tgAdminLinkBox&&(t.tgAdminLinkBox.classList.remove("hidden"),t.tgAdminLinkBox.textContent=a),l("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}catch(n){console.error(n),l("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}}async function gt(n){if(!(!n||!window.confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ†ÙŠØŸ")))try{await h("/telegram/unlink.php",{method:"POST",body:{target:"technician",technician_id:Number(n)}}),l("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø· Ù„Ù„ÙÙ†ÙŠ"),A()}catch(e){console.error(e);const r=e&&(e.payload?.error||e.message)?String(e.payload?.error||e.message):"ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·";l(r)}}async function mt(n){if(!(!n||!window.confirm(`ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù† (${n})ØŸ`)))try{await h("/telegram/unlink.php",{method:"POST",body:{target:"admin",chat_id:String(n)}}),l("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†"),q()}catch(e){console.error(e);const r=e&&(e.payload?.error||e.message)?String(e.payload?.error||e.message):"ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†";l(r)}}
