import{t as N,p as le,n as b,j as R,d as me,b as ze,h as Xt,A as Zt}from"./auth.g2-5obuT.js";import{r as Pt,i as en,D as Ze,s as tn,k as nn,P as an,u as $e,E as At,j as on,O as et,G as fe,H as ge,b as Ne,I as St,J as cn}from"./state.CYuafVY6.js";const rn=()=>N("reservations.create.summary.currency","SR");let Ie=[],X=[],ce=[],re=[],M="create",Ct=()=>{},vt=()=>{};const De=new Map,Ue=450;function sn(e){const t=De.get(e);return t!=null&&Date.now()-t<Ue}function ln(e){De.set(e,Date.now()),setTimeout(()=>{const t=De.get(e);t!=null&&Date.now()-t>=Ue&&De.delete(e)},Ue+50)}function qe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ye(e={}){return{...e,assignmentId:e.assignmentId||qe()}}function Me(e){if(!e)return null;const t=String(e),n=Ie.find(a=>String(a?.id)===t);if(n)return{...n};const{technicians:i=[]}=me();return i.find(a=>String(a?.id)===t)||null}function Pe(e={},t=le()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function tt(e={},t=le()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function qt(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=X.find(c=>String(c.id).trim().toLowerCase()===n);if(i)return i;const a=on(e);return a||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function dt(e){const t=qt(e,e?.name??""),n=le(),i=Pe(t,n)||t?.name||"",a=tt(t,n);return Ge({assignmentId:qe(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:a,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Ge(e={}){const t={assignmentId:e.assignmentId||qe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=qt(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=le(),a=Pe(n,i)||t.positionLabel,c=tt(n,i);t.positionLabel=a||t.positionLabel||n?.name||"",t.positionLabelAlt=c||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=Me(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function he(){X=en()}function un(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return ye(Ge(t));const n=Me(t),i=n?{assignmentId:qe(),positionLabel:n.role||N("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:qe(),positionLabel:N("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return ye(Ge(i))}).filter(Boolean):[]}function ue(e="create"){return e==="edit"?re.map(ye):ce.map(ye)}function ne(e="create",t=[]){try{he()}catch{}const n=un(t);e==="edit"?(re=n,Ae("edit-selected-technicians-list",re,"edit"),vt()):(ce=n,Ae("selected-technicians-list",ce,"create"),Ct()),Fe()}function je(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),s=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=o?$e(o,s):null,m=l?$e(l,u):null;let g=null;const y=document.getElementById("edit-res-index")?.value;if(y!=null){const _=Number.parseInt(y,10);if(Number.isInteger(_)){const{reservations:I=[]}=me(),p=I?.[_];p&&(g=p.id??p.reservationId??null)}}return{start:d,end:m,ignoreReservationId:g}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00",c=t?$e(t,i):null,r=n?$e(n,a):null;return{start:c,end:r,ignoreReservationId:null}}function Fe(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=ue(M).length;if(t){const n=N("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",b(String(t)));e.textContent=n}else e.textContent=N("technicians.picker.selectionInfo","No crew selected yet")}function xe(e){const t=Number.isFinite(e)?e:0;return`${b(t.toFixed(2))} ${rn()}`}function dn(e){const t=ue(M),n=new Set(t.filter(s=>s.assignmentId!==e&&s.technicianId).map(s=>s.technicianId)),i=Ie.length?Ie:me().technicians||[],{start:a,end:c,ignoreReservationId:r}=je(M),o=!!(a&&c);return i.map(s=>{const u=String(s.id),d=n.has(u),m=o?Ze(u,a,c,r):!1,g=b(s.name||s.full_name||s.fullName||s.email||u);return{id:u,label:g,disabled:d||m,conflict:m,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=ue(M);if(!t.length){const n=N("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=N("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}he(),e.innerHTML=t.map((n,i)=>{const a=b(String(i+1)),c=xe(n.positionClientPrice||0),r=dn(n.assignmentId),o=N("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),l=n.technicianId!=null?String(n.technicianId):"",s=n.technicianName?b(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,d=N("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),m=N("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),g=r.map(h=>{const P=l===h.id,S=h.disabled&&!P?`${h.label} ${h.conflict?m:d}`:h.label;return`
        <option value="${h.label}"
                data-id="${h.id}"
                data-disabled="${h.disabled?"true":"false"}"
                data-conflict="${h.conflict?"true":"false"}"
                data-taken="${h.taken?"true":"false"}"
                label="${S}"></option>
      `}).join("");let y=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!y||String(y).trim()===""){const h=n.positionId?X.find(A=>String(A.id)===String(n.positionId)):null,P=!h&&n.positionKey?X.find(A=>String(A.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(h||P){const A=h||P;y=Pe(A,le())||A?.name||""}}const _=n.positionLabelAlt?`<div class="text-muted small">${b(n.positionLabelAlt)}</div>`:"",I=N("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),p=N("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${a}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${b(y||N("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${_}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${c}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${o}"
              value="${l?s:""}"
              aria-label="${N("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${g}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${I}">
            ${I}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{Ft(n.dataset.assignmentId,M)}),n.dataset.listenerAttached="true")}),pn(e)}function pn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,a=()=>{mn(n,i)};n.addEventListener("change",a),n.addEventListener("blur",a),n.dataset.listenerAttached="true"})}function mn(e,t){if(!t||sn(t))return;ln(t);const n=e.value?.trim()??"";if(!n){we(t,"");return}const i=e.getAttribute("list"),a=i?document.getElementById(i):null,c=a?Array.from(a.options):[],r=b(n).toLowerCase(),o=c.find(s=>b(s.value).toLowerCase()===r);if(!o){R(N("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(t,"");return}if(o.dataset.disabled==="true"){if(o.dataset.conflict==="true")try{const{start:s,end:u,ignoreReservationId:d}=je(M),m=o.dataset.id||"",g=s&&u&&m?At(String(m),s,u,d):[],y=N("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),_=g&&g.length?`: ${g.join("ØŒ ")}`:"";R(`${y}${_}`,"warning",6e3)}catch{R(N("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else R(N("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const l=o.dataset.id;if(!l){R(N("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(t,"");return}we(t,l)}function Re(){const e=document.getElementById("crew-position-list");if(!e)return;he();const t=document.getElementById("crew-position-search"),n=b(String(t?.value||"")).trim().toLowerCase(),a=ue(M).reduce((o,l)=>{const s=l?.positionId!=null?String(l.positionId):null;return s&&o.set(s,(o.get(s)||0)+1),o},new Map),c=X.filter(o=>n?[o.labelAr,o.labelEn,o.name].filter(Boolean).map(s=>b(String(s)).toLowerCase()).join(" ").includes(n):!0);if(!c.length){e.innerHTML=`<div class="text-muted">${N("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const r=le();e.innerHTML=c.map(o=>{const l=Pe(o,r)||o.name||"",s=tt(o,r),u=xe(o.clientPrice||0),d=xe(o.cost||0),m=s?`<span class="crew-position-card__subtitle">${b(s)}</span>`:"",g=N("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),y=N("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),_=N("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),I=a.get(String(o.id))||0,p=N("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",b(String(I)));return`
      <article class="crew-position-card" data-position-id="${o.id}" tabindex="0" role="button" aria-label="${b(l)}">
        ${I>0?`<span class="crew-position-card__badge" aria-label="${p}">${b(String(I))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${b(l)}</h6>
            ${m}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${y}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${b(String(o.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${y}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${o.clientPrice==null?"":b(String(o.clientPrice))}" inputmode="decimal" placeholder="${b("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${o.id}">${N("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${o.id}">${N("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${o.id}">
            ${_}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${o.id}">
            ${N("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.stopPropagation(),Ke(o.dataset.positionId)}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(o=>{o.dataset.cardListenerAttached||(o.addEventListener("click",()=>{o.dataset.editing!=="true"&&Ke(o.dataset.positionId)}),o.addEventListener("keydown",l=>{if(l.key==="Enter"||l.key===" "){if(l.preventDefault(),o.dataset.editing==="true")return;Ke(o.dataset.positionId)}}),o.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const s=o.closest(".crew-position-card");if(!s)return;const u=s.querySelector(".crew-position-card__metrics"),d=s.querySelector(".crew-position-card__footer"),m=s.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),m&&(m.hidden=!1),s.dataset.editing="true";const g=s.querySelector(".crew-position-edit-cost"),y=s.querySelector(".crew-position-edit-client"),_=I=>{I.addEventListener("input",p=>{const P=b(p.target.value).replace(/[^0-9.]/g,"");if(P!==p.target.value){const A=p.target.selectionEnd||P.length;p.target.value=P,p.target.setSelectionRange(A,A)}},{once:!0})};g&&_(g),y&&_(y)}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();const s=o.closest(".crew-position-card"),u=o.dataset.positionId;if(!(!s||!u))try{const d=s.querySelector(".crew-position-edit-cost"),m=s.querySelector(".crew-position-edit-client"),g=b(d?.value||"").trim(),y=b(m?.value||"").trim(),_=g===""?0:Number.parseFloat(g),I=y===""?null:Number.parseFloat(y);if(!Number.isFinite(_)||_<0){R(N("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(I!=null&&(!Number.isFinite(I)||I<0)){R(N("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),m?.focus();return}he();const p=X.find(h=>String(h.id)===String(u));if(!p){R(N("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await an(u,{name:p.name,cost:Number(_.toFixed(2)),clientPrice:I==null?null:Number(I.toFixed(2)),labelAr:p.labelAr,labelEn:p.labelEn}),R(N("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),Re(),Y()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const m=d?.message||N("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");R(m,"error")}}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const s=o.closest(".crew-position-card");if(!s)return;const u=s.querySelector(".crew-position-card__metrics"),d=s.querySelector(".crew-position-card__footer"),m=s.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),m&&(m.hidden=!0),delete s.dataset.editing}),o.dataset.listenerAttached="true")})}function Ke(e){he();const t=X.find(a=>String(a.id)===String(e)),n=dt(t||{id:null,name:""}),i=ue(M);i.push(n),ne(M,i),Y(),R(N("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Ft(e,t="create"){if(!e)return;const n=ue(t).filter(i=>i.assignmentId!==e);ne(t,n),Y(),R(N("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function we(e,t){if(!e)return;const n=ue(M),i=n.find(s=>s.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ne(M,n),Y(),R(N("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(n.find(s=>s.assignmentId!==e&&s.technicianId===t)){R(N("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),Y();return}const c=Me(t),{start:r,end:o,ignoreReservationId:l}=je(M);if(r&&o&&Ze(String(t),r,o,l)){try{const s=At(String(t),r,o,l),u=N("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=s&&s.length?`: ${s.join("ØŒ ")}`:"";R(`${u}${d}`,"warning",6e3)}catch{R(N("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}Y();return}c?(i.technicianId=String(c.id),i.technicianName=c.name??null,i.technicianRole=c.role??null,i.technicianPhone=c.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ne(M,n),Y(),i.technicianName?R(N("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",b(i.technicianName)),"success"):R(N("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function pt(e="create"){M=e,Y(),Fe();let t=tn();if(!Array.isArray(t)||t.length===0)try{const i=await Pt();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(Ie=t);try{await nn()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}he(),Re(),Y(),Fe();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function fn(){return ue(M).map(ye)}function gn(){const e=fn(),{start:t,end:n,ignoreReservationId:i}=je(M);if(t&&n){const c=e.filter(r=>r.technicianId&&Ze(r.technicianId,t,n,i));if(c.length>0){const r=c.map(l=>l.technicianName||l.technicianId).join(N("reservations.list.crew.separator","ØŒ ")),o=N("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",r);c.forEach(l=>{l.technicianId=null,l.technicianName=null}),ne(M,e),Y(),R(o),Fe();return}}ne(M,e);const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a)?.hide?.(),R(N("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function Ae(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${N("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}he(),i.innerHTML=t.map(a=>{let c=a.positionLabel??a.position_label??a.position_name??a.role??a.position??"";if(!c||String(c).trim()===""){const d=a.positionId?X.find(g=>String(g.id)===String(a.positionId)):null,m=!d&&a.positionKey?X.find(g=>String(g.name).toLowerCase()===String(a.positionKey).toLowerCase()):null;c=d?Pe(d,le())||d?.name||"":m&&(Pe(m,le())||m?.name)||""}const r=b(c||N("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),o=a.technicianName?`${b(a.technicianName)}`:N("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let l=Number(a.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[a.position_client_price,a.client_price,a.customer_price,a.daily_total,a.dailyTotal,a.total];for(const m of d){const g=Number(m);if(Number.isFinite(g)&&g>0){l=g;break}}}if((!Number.isFinite(l)||l<=0)&&(a.positionId||a.positionKey)){const d=a.positionId?X.find(y=>String(y.id)===String(a.positionId)):null,m=!d&&a.positionKey?X.find(y=>String(y.name).toLowerCase()===String(a.positionKey).toLowerCase()):null,g=d||m||null;g&&Number.isFinite(Number(g.clientPrice))&&(l=Number(g.clientPrice))}const s=xe(Number.isFinite(l)&&l>0?l:0),u=N("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${a.assignmentId}">
        <span class="technician-chip-name">${r}</span>
        <small class="technician-chip-role">${o}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${s}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${a.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",()=>{Ft(a.dataset.assignmentId,a.dataset.context)}),a.dataset.listenerAttached="true")})}}function yn(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",r=>{const o=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),s=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),m=!!(l&&s),g=!!(u&&d),y=!!o;if(!m||!g){r.preventDefault(),R(N("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!y){r.preventDefault(),R(N("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}pt("create")}),e.dataset.listenerAttached="true";const c=()=>{const r=document.getElementById("res-customer")?.value?.trim(),o=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),s=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(r&&o&&l&&s&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(r=>document.getElementById(r)).filter(Boolean).forEach(r=>{["input","change"].forEach(o=>r.addEventListener(o,c))}),c()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>pt("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Re()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",gn),i.dataset.listenerAttached="true");const a=document.getElementById("selectTechniciansModal");a&&!a.dataset.listenerAttached&&window.bootstrap?.Modal&&(a.addEventListener("shown.bs.modal",async()=>{if(!Ie.length&&(!me().technicians||me().technicians.length===0))try{await Pt()}catch(c){console.warn("[crew-picker] fetch on show failed",c)}Re(),Y(),Fe()}),a.addEventListener("hidden.bs.modal",()=>{const c=document.getElementById("crew-position-search");c&&(c.value="")}),a.dataset.listenerAttached="true"),Ae("selected-technicians-list",ce,"create"),Ae("edit-selected-technicians-list",re,"edit")}function pi({onDraftChange:e,onEditChange:t}={}){Ct=typeof e=="function"?e:()=>{},vt=typeof t=="function"?t:()=>{},yn()}function hn(){return ce.map(ye)}function bn(){return re.map(ye)}function mt(){return ce.map(e=>e.technicianId).filter(Boolean).map(String)}function ft(){return re.map(e=>e.technicianId).filter(Boolean).map(String)}function mi(e=[]){ne("create",e)}function fi(e=[]){ne("edit",e)}function gi(){ne("create",[])}function yi(){ne("edit",[])}function gt(e=[]){return e.map(t=>{if(t.technicianId){const n=Me(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function hi(e=[]){Array.isArray(e)&&e.length&&(Ie=e),ce=gt(ce),re=gt(re),Ae("selected-technicians-list",ce,"create"),Ae("edit-selected-technicians-list",re,"edit"),Y()}function yt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Lt(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=b(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),a=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const c=t.includes(","),r=t.includes(".");if(c&&r){const l=t.lastIndexOf(","),s=t.lastIndexOf(".");l>s?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(c){const l=t.split(",");l.length===2&&l[1].length===3?t=l.join(""):t=t.replace(/,/g,".")}else if(r){const l=t.split(".");if(l.length===2){const[,s]=l;if(s.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(t=u)}}else l.length>2&&(t=yt(t))}if(t=t.replace(/,/g,""),t=yt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const o=Number.parseFloat(t);return Number.isFinite(o)?a?-o:o:Number.NaN}function D(e){return Lt(e)}function $(e){const t=Lt(e);if(!Number.isFinite(t))return 0;let n=t,i=0;for(;Math.abs(n)>1e5&&i<8;)n/=10,i+=1;return Number(n.toFixed(2))}function ve(e){return b(String(e??"")).trim().toLowerCase()}function Et(e=""){return b(String(e)).trim().toLowerCase()}const _n=2;function kn(e){const t=D(e);return Number.isFinite(t)?t.toFixed(_n):"0.00"}function Qe(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(b(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return $(i)}return 1}function Nn(e={}){const t=e?.desc||e?.description||e?.name||"",n=Et(t),i=kn(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function In(e=[]){const t=new Map;return e.forEach((n,i)=>{const a=Nn(n);if(!a)return;if(!t.has(a)){const r=n?.desc||n?.description||n?.name||"",o=Et(r),l=bt(n),s=_t(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(a,{key:a,description:r,normalizedDescription:o,unitPrice:l,unitCost:s,image:u,items:[],itemIndices:[],barcodes:[]})}const c=t.get(a);c.items.push(n),c.itemIndices.push(i),n?.barcode&&c.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,a)=>i+Qe(a),0)})).map(n=>{const i=n.quantity||0,a=n.items.reduce((y,_)=>{const I=bt(_),p=Qe(_);return y+I*p},0),c=$(a),r=D(n.unitPrice),o=Number.isFinite(r)?r:0,l=n.items.reduce((y,_)=>{const I=_t(_),p=Qe(_);return y+I*p},0),s=$(l),u=D(n.unitCost),d=Number.isFinite(u)?u:0,m=i>0?$(c/i):$(o),g=i>0?$(s/i):$(d);return{...n,quantity:i,count:i,totalPrice:c,unitPrice:m,totalCost:s,unitCost:g}})}function ht(e={}){return(Ne(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??ve(n?.barcode),qty:(()=>{const i=Number.parseFloat(b(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=D(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=D(n?.cost??n?.unit_cost??n?.unitCost??n?.rental_cost??n?.purchase_price);return Number.isFinite(i)?i:0})()}))}function Pn(e={},{packageQuantity:t=1}={}){const n=fe(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=n&&ge(n)||e,a=Ne(i)||[],c=Number.isFinite(Number(t))&&Number(t)>0?Number(t):1;return a.map(r=>{const l=D(r?.price??r?.unit_price??r?.unitPrice),s=Number.isFinite(l)?$(l):0,u=D(r?.cost??r?.unit_cost??r?.unitCost??r?.rental_cost??r?.purchase_price),d=Number.isFinite(u)?$(u):0,m=1*c,g=$(s*m),y=$(d*m);return{equipmentId:r?.equipmentId??r?.equipment_id??null,barcode:r?.barcode??r?.normalizedBarcode??"",desc:r?.desc??r?.description??"",qtyPerPackage:1,packageQuantity:c,totalUnits:m,unitPrice:s,perDayTotal:g,unitCost:d,perDayCost:y}})}function An(e={},{packageQuantity:t=1,days:n=1}={}){const i=Pn(e,{packageQuantity:t}),a=$(i.reduce((l,s)=>l+(Number(s.perDayTotal)||0),0)),c=$(i.reduce((l,s)=>l+(Number(s.perDayCost)||0),0)),r=$(a*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1)),o=$(c*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1));return{lines:i,perDayTotal:a,total:r,perDayCostTotal:c,costTotal:o}}function Sn(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(b(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function Cn(e={},t=[],n=null){try{const s=fe(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(s){const u=ge(s);if(u){const d=u.price??u.total_price??u.package_price,m=D(d);if(Number.isFinite(m)&&m>0)return $(m)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,a=D(i);if(Number.isFinite(a)&&a>0)return $(a);const c=e.total_price??e.totalPrice??e.total,r=D(c),o=Number.parseFloat(b(String(n)).replace(/[^0-9.]/g,"")),l=Number.isFinite(o)&&o>0?o:Sn(e);return Number.isFinite(r)&&r>0&&l>0?$(r/l):0}function vn(e={}){const t=Array.isArray(e?.items)?e.items:[],n=In(t),i=et(),a=new Set,c=new Map;i.forEach(p=>{const h=fe(p?.id??p?.packageId??p?.package_id??p?.code);h&&a.add(h);const P=b(String(p?.package_code??p?.code??"")).trim().toLowerCase();P&&c.set(P,h||P)});const r=(p,h=0)=>{const P=fe(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),A=b(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return P||(A&&c.has(A)?c.get(A):A||`pkg-${h}`)},o=new Map,l=(p,h=0,P="packages")=>{if(!p||typeof p!="object")return;const S=r(p,h)||`pkg-${h}`;if(!o.has(S)){o.set(S,{source:p,normalizedId:S,index:h,itemSource:P==="items"?p:null});return}const k=o.get(S);if(k.source||(k.source=p),P==="items"&&(k.itemSource=p,k.source&&typeof k.source=="object")){const v=Array.isArray(k.source.packageItems)&&k.source.packageItems.length>0,L=Array.isArray(p.packageItems)&&p.packageItems.length>0;!v&&L&&(k.source={...k.source,packageItems:p.packageItems}),!k.source.image&&p.image&&(k.source={...k.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,h)=>l(p,h,"packages")),t.forEach((p,h)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const P=r(p,h+o.size);l({...p,package_id:P,packageId:P,package_code:p.package_code??p.code},h+o.size,"items")}});const s=[],u=new Set,d=new Set;o.forEach(({source:p,itemSource:h=null,normalizedId:P},A)=>{const k=(P?ge(P):null)||p||{},v=h&&typeof h=="object"?h:null;let L=ht(k);(!Array.isArray(L)||L.length===0)&&v&&(L=ht(v)),L.forEach(q=>{const T=q?.normalizedBarcode??ve(q?.barcode);T&&u.add(T);const x=q?.equipmentId??q?.equipment_id??null;x!=null&&d.add(String(x))});let B=1,V=Cn(k,L,B);const f=[v?.price,v?.unit_price,v?.unitPrice];for(const q of f){const T=D(q);if(Number.isFinite(T)&&T>0){V=$(T);break}}V=$(V);const G=[k?.unit_cost,k?.unitCost,k?.cost,v?.unit_cost,v?.unitCost,v?.cost];let j=0;for(const q of G){const T=D(q);if(Number.isFinite(T)&&T>=0){j=$(T);break}}if(!j&&Array.isArray(L)&&L.length){const q=L.reduce((T,x)=>{const de=D(x?.cost),be=Number.isFinite(Number(x?.qtyPerPackage))&&Number(x.qtyPerPackage)>0?Number(x.qtyPerPackage):1;return T+(Number.isFinite(de)?de:0)*be},0);j=$(q)}const H=(()=>{const q=[k?.pricing_mode,k?.pricingMode,k?.pricing,v?.pricing_mode,v?.pricingMode,v?.pricing];for(const T of q){if(T==null)continue;const x=String(T).trim().toLowerCase();if(x==="daily"||x==="per_day"||x==="day")return"daily";if(x==="fixed"||x==="per_booking"||x==="booking")return"fixed"}return"daily"})(),O=[v?.total,v?.total_price,v?.totalPrice,k?.total,k?.total_price,k?.totalPrice];let K=NaN;for(const q of O){const T=D(q);if(Number.isFinite(T)&&T>=0){K=T;break}}Number.isFinite(K)||(K=V*B),K=$(K);const ee=[k?.package_code,k?.code,k?.packageCode,k?.displayCode,k?.display_code,k?.barcode,v?.package_code,v?.code,v?.packageCode,v?.displayCode,v?.display_code,v?.barcode,P,A].find(q=>q==null?!1:String(q).trim().length>0),C=ee!=null?b(String(ee)).trim():"";if(C){const q=ve(C);q&&u.add(q)}const E=L.map(q=>b(String(q?.barcode??q?.normalizedBarcode??""))).filter(Boolean),U=[k?.name,k?.package_name,k?.title,v?.name,v?.desc,v?.package_name,C,b(String(A))].find(q=>q!=null&&String(q).trim()!=="")||b(String(C||A)),ae=L.find(q=>q?.image)?.image??k?.image??v?.image??null,z=1;s.push({key:`package::${A}`,description:U,normalizedDescription:b(String(U)),unitPrice:V,unitCost:j,totalPrice:K,pricingMode:H,quantity:B,count:z,image:ae,barcodes:E,barcode:C,package_code:C,packageDisplayCode:C,items:[{type:"package",packageItems:L,packageId:P,desc:U,price:V,cost:j,qty:z,barcode:C}],type:"package",packageItems:L,packageId:P})});const m=new Set(Array.from(u).map(p=>ve(p)).filter(Boolean)),g=n.filter(p=>{if(p.items.some(S=>S?.type==="package")&&s.length>0)return!1;const P=(S={})=>[S.packageId,S.package_id,S.package_code,S.packageCode,S.bundleId,S.bundle_id].some(k=>k!=null&&k!=="");return!p.items.every(S=>{const k=qn(S),v=k!=null?String(k):null;if(v&&d.has(v))return!0;const L=S?.barcode?ve(S.barcode):null;return!!(L&&m.has(L)||P(S))})}),y=new Set,_=[];return s.forEach(p=>{const h=r({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!h||y.has(h)||(y.add(h),_.push(p))}),{groups:_.length?[..._,...g]:n,packageGroups:s,groupedItems:n,filteredGroupedItems:g,packagesMap:o}}function qn(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function bt(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=D(n);if(Number.isFinite(i))return i}return 0}function _t(e={}){const t=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const n of t){const i=D(n);if(Number.isFinite(i))return i}return 0}function bi(e){const t=e?.status??e?.reservationStatus??null;if(t){const a=String(t).trim().toLowerCase();if(a==="completed"||a==="closed"||a==="Ù…ØºÙ„Ù‚"||a==="Ù…ÙƒØªÙ…Ù„"||a==="Ù…Ù†ØªÙ‡ÙŠ"||a==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const n=new Date(e.end);return Number.isNaN(n.getTime())?!1:n<new Date}function Fn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function _i(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,a=i!=null&&i!==""&&i!=="null",c=a?Fn(t?.status??t?.status_label??t?.statusLabel??""):null,r=a&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(c));return{reservationConfirmed:n,projectLinked:a,projectStatus:c,projectConfirmed:r,effectiveConfirmed:a?r:n}}const Tt=10;function $t(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=D(n);if(Number.isFinite(i))return $(i)}return 0}function Ln(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=D(n);if(Number.isFinite(i))return $(i)}return $t(e)}function En(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=me();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,a)=>{const c=n.get(String(a));if(!c)return i;const r=$t(c),o=Ln(c);return{costPerDay:i.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:i.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const Tn=1440*60*1e3,ke=.01;function _e(e){if(e==null||e==="")return null;const t=b(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function kt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let a=Number.isFinite(e)?e:0;if(a<t&&(a=t),a>n&&(a=n),i!=null){const c=10**i;a=Math.round(a*c)/c}return a}function wt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function nt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:a=null,history:c=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,o=t==="amount"?"amount":t==="percent"?"percent":null;let l=_e(i),s=_e(a);const u=_e(n);let d=0,m=0;Array.isArray(c)&&c.length&&c.forEach(p=>{if(!p)return;const h=p.type==="amount"||p.type==="percent"?p.type:null,P=_e(p.value),A=_e(p.amount),S=_e(p.percentage);if(h==="amount"){const k=A??P;k!=null&&(d+=k,r>0&&(m+=k/r*100))}else if(h==="percent"){const k=S??P;k!=null&&(m+=k,r>0&&(d+=k/100*r))}else A!=null&&(d+=A,r>0&&(m+=A/r*100)),S!=null&&(m+=S,r>0&&(d+=S/100*r))}),o==="amount"&&u!=null?l=u:o==="percent"&&u!=null?s=u:o===null&&u!=null&&(s!=null?s=u:l=u),(l==null||l<=0)&&s!=null&&s>0&&r>0&&(l=r*(s/100)),(s==null||s<=0)&&l!=null&&l>0&&r>0&&(s=l/r*100);const g=l??0,y=s??0;l=g+d,s=y+m,l=kt(l??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),s=kt(s??0,{min:0,max:100,precision:2});let _=o;return _||(l>0&&r>0?_="amount":s>0&&(_="percent")),{paidAmount:l,paidPercent:s,paymentProgressType:_,paymentProgressValue:_==="amount"?l:_==="percent"?s:null}}function it({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const a=wt(e),c=Number.isFinite(Number(i))?Number(i):0,r=Number.isFinite(Number(t))?Number(t):0,o=Number.isFinite(Number(n))?Number(n):0;if(a==="paid")return"paid";const l=c>0&&r>=c-ke,s=o>=100-ke*100;if(l||s)return"paid";const u=r>ke||o>ke;return a==="partial"||u?"partial":"unpaid"}function $n(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const a=i.getTime()-n.getTime();if(a<=0)return 1;const c=a/Tn;return Math.max(1,Math.ceil(c))}function Se({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:a="percent",applyTax:c=!1,start:r=null,end:o=null,companySharePercent:l=null,groupingSource:s=null}={}){const u=$n(r,o);let d=!1;try{if(typeof window<"u"&&window.location){const C=new URL(window.location.href),E=(C.searchParams.get("noDays")||C.searchParams.get("pricing")||"").toLowerCase();d=E==="1"||E==="true"||E==="fixed"||E==="nodays"}}catch{}const m=s&&typeof s=="object"?s:{items:Array.isArray(e)?e:[]},{groups:g}=vn(m),y=C=>{if((C?.type||"").toLowerCase()==="package")return!0;const E=Array.isArray(C?.items)?C.items:[];if(!E.length)return!1;if(E.some(z=>z?.reservation_id!=null||z?.reservationId!=null))return!0;const U=E.every(z=>z?.unit_price!=null||z?.unitPrice!=null),ae=E.some(z=>z?.daily_rate!=null||z?.dailyRate!=null||z?.unit_rate!=null||z?.unitRate!=null||z?.price!=null);return!!(U&&!ae)};let _=0,I=0;(Array.isArray(g)?g:[]).forEach(C=>{const E=Number.isFinite(Number(C?.quantity))?Number(C.quantity):0,ie=Number.isFinite(Number(C?.unitPrice))?Number(C.unitPrice):0,U=Number.isFinite(Number(C?.unitCost))?Number(C.unitCost):0,ae=String(C?.type||"").toLowerCase()==="package",z=y(C),q=d||z?1:u;if(ae){const T={package_code:C?.package_code||C?.packageDisplayCode||C?.barcode||C?.packageId||C?.key,packageItems:Array.isArray(C?.packageItems)?C.packageItems:void 0},x=An(T,{packageQuantity:E,days:q}),de=Number.isFinite(Number(x.total))?Number(x.total):E*(Number.isFinite(ie)?ie:0)*q,be=(()=>{const pe=Number(x?.costTotal);if(Number.isFinite(pe))return pe;const Te=Number(x?.perDayCostTotal);return Number.isFinite(Te)?Te*q:E*(Number.isFinite(U)?U:0)*q})();_+=de,I+=be}else _+=E*ie*q,I+=E*U*q});const p=$(_),h=$(I),P=Array.isArray(n)?n:[],A=P.length?P.map(C=>C?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:S,totalPerDay:k}=P.length?P.reduce((C,E)=>{const ie=D(E?.positionCost??E?.position_cost??E?.cost??E?.dailyWage??E?.daily_wage??0),U=D(E?.positionClientPrice??E?.position_client_price??E?.clientPrice??E?.dailyTotal??E?.daily_total??E?.total??0),ae=Number.isFinite(ie)?ie:0,z=Number.isFinite(U)?U:0;return{costPerDay:C.costPerDay+ae,totalPerDay:C.totalPerDay+z}},{costPerDay:0,totalPerDay:0}):En(A),v=$(k*u),L=$(S*u),B=$(p+v),V=Number(i)||0;let f=a==="amount"?V:B*(V/100);(!Number.isFinite(f)||f<0)&&(f=0),f>B&&(f=B);const G=Math.max(0,B-f),j=Number.isFinite(l)&&Number(l)>0?Number(l):0,Z=j>0?Math.max(0,G*(j/100)):0,H=G+Z;let O=c?H*.15:0;(!Number.isFinite(O)||O<0)&&(O=0),O=Number(O.toFixed(2));const K=H+O,w=Math.max(0,Number(K.toFixed(2))),ee=Math.max(0,Math.max(0,p+v-f)-L-h);return{rentalDays:u,equipmentTotal:p,equipmentCostTotal:h,crewTotal:v,crewCostTotal:L,discountAmount:f,subtotalAfterDiscount:G,taxableAmount:H,taxAmount:O,finalTotal:w,companySharePercent:j,companyShareAmount:Z,netProfit:ee}}function ki(e=[],t=0,n="percent",i=!1,a=[],{start:c=null,end:r=null,companySharePercent:o=null}={}){const l=g=>g&&typeof g=="object"&&(g.positionId!==void 0||g.position_id!==void 0||g.positionLabel!==void 0||g.position_name!==void 0||g.positionClientPrice!==void 0),s=Array.isArray(a)&&a.some(l)?a:[],u=s.length?s.map(g=>g?.technicianId).filter(Boolean):Array.isArray(a)?a:[];return Se({items:e,technicianIds:u,crewAssignments:s,discount:t,discountType:n,applyTax:i,start:c,end:r,companySharePercent:o??Tt}).finalTotal}function Dt({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:a,paymentStatus:c,paidAmount:r=0,paidPercent:o=0,companySharePercent:l=null,companyShareAmount:s=null,taxAmount:u=null,netProfit:d=null,totalKey:m="reservations.summary.total",equipmentTotal:g=null,crewTotal:y=null,equipmentCostTotal:_=null}){const I=N("reservations.create.summary.currency","SR"),p=b(String(e)),h=b(String(t)),P=b(String(n??1)),A=b(String(i)),S=wt(c),k=S==="paid"?"Ù…Ø¯ÙÙˆØ¹":S==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",v=N(`reservations.create.paymentStatus.${S}`,k),L=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,B=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,V=L>ke||B>ke,f=N("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),G=b(L.toFixed(2)),j=b(B.toFixed(B%1?2:0)),Z=N("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),H=N("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),O=N("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),K=N("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),w=N("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ee=N("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),C=N("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),E=N("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),U=N(m==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",N("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),ae=N("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),z=N("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),q=Number.isFinite(d)?Math.max(0,Number(d)):null,T=[{label:Z,value:h},{label:H,value:P},{label:O,value:A}],x=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;x!=null&&T.push({label:K,value:`${b(x.toFixed(2))} ${I}`});const de=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;de!=null&&T.push({label:w,value:`${b(de.toFixed(2))} ${I}`});const be=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;if(be!=null&&T.push({label:ee,value:`${b(be.toFixed(2))} ${I}`}),a){let oe=N("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(oe=`${b(Number(u).toFixed(2))} ${I}`),T.push({label:C,value:oe})}const pe=Number.isFinite(l)?Number(l):null;if(pe!==null&&pe>0){const oe=Number.isFinite(s)?Number(s):e*(pe/100),Ce=b(String(pe)),Yt=b(Number.isFinite(oe)?oe.toFixed(2):"0"),Jt=`${Ce}% (${Yt} ${I})`;T.push({label:ae,value:Jt})}if(q!==null&&Math.abs(q-Number(e))>.009){const oe=b(q.toFixed(2));T.push({label:z,value:`${oe} ${I}`})}T.push({label:E,value:v}),V&&T.push({label:f,value:`${G} ${I} (${j}%)`});const Te=`${p} ${I}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${T.map(({label:oe,value:Ce})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${oe}</span>
            ${Ce?`<span class="reservation-summary-value">${Ce}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${U}</span>
          <span class="reservation-summary-value">${Te}</span>
        </div>
      </div>
    </div>
  `}function wn({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:c=null,paymentProgressValue:r=null,start:o,end:l,companySharePercent:s=null,paymentHistory:u=[]}){const d=hn(),m=typeof mt=="function"?mt()??[]:[],g=Array.isArray(m)?m.map(String):[],y=d.length?d.map(k=>k?.technicianId).filter(Boolean).map(String):g,_=d.length||y.length,I=Number.isFinite(s)?Number(s):null,p=Se({items:e,technicianIds:y,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:o,end:l,companySharePercent:I}),h=nt({totalAmount:p.finalTotal,progressType:c,progressValue:r,history:u}),P=it({manualStatus:a,paidAmount:h.paidAmount,paidPercent:h.paidPercent,totalAmount:p.finalTotal}),A=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,paymentProgressType:h.paymentProgressType,paymentProgressValue:h.paymentProgressValue,total:p.finalTotal};return wn.lastResult=S,xn(A),A}function Dn({items:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:c=null,paymentProgressValue:r=null,start:o,end:l,companySharePercent:s=null,paymentHistory:u=[]}){const d=bn(),m=typeof ft=="function"?ft()??[]:[],g=Array.isArray(m)?m.map(String):[],y=d.length?d.map(k=>k?.technicianId).filter(Boolean).map(String):g,_=d.length||y.length,I=Number.isFinite(s)?Number(s):null,p=Se({items:e,technicianIds:y,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:o,end:l,companySharePercent:I}),h=nt({totalAmount:p.finalTotal,progressType:c,progressValue:r,history:u}),P=it({manualStatus:a,paidAmount:h.paidAmount,paidPercent:h.paidPercent,totalAmount:p.finalTotal}),A=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={html:A,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,paymentProgressType:h.paymentProgressType,paymentProgressValue:h.paymentProgressValue,total:p.finalTotal};return Dn.lastResult=S,A}function xn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Nt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Nt(n,e))}function Nt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Rn=me()||{};let te=(Rn.reservations||[]).map(Ot);function J(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const xt="__reservation_packages_cache__",Rt="__reservation_item_cost_cache__";function Bt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function zt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Mt(){const e=Bt();if(!e)return{};try{const t=e.getItem(xt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function It(e){const t=Bt();if(t)try{t.setItem(xt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function at(){const e=zt();if(!e)return{};try{const t=e.getItem(Rt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation item cost cache",t),{}}}function We(e){const t=zt();if(t)try{t.setItem(Rt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation item cost cache",n)}}function Bn(e,t=0){if(!e||typeof e!="object")return null;const n=e.equipment_id??e.equipmentId??e.id??null,i=b(String(e.barcode??e.code??"")).trim(),a=J(F(e.cost??e.unit_cost)),c=J(F(e.price??e.unit_price)),r=Number.isFinite(a),o=Number.isFinite(c);return!r&&!o?null:{key:n!=null?`id:${n}`:i?`bc:${i}`:`idx:${t}`,equipmentId:n,barcode:i,cost:r?a:null,price:o?c:null}}function zn(e,t){if(!e)return;const n=Array.isArray(t)?t.map((c,r)=>Bn(c,r)).filter(Boolean):[],i=at(),a=String(e);if(!n.length){i[a]&&(delete i[a],We(i));return}i[a]=n,We(i)}function Mn(e=[]){const t=at(),n=new Set;e.forEach(a=>{const c=a?.id??a?.reservationId??a?.reservation_code??null;c&&n.add(String(c))});let i=!1;Object.keys(t).forEach(a=>{n.has(a)||(delete t[a],i=!0)}),i&&We(t)}function jn(e){if(!e)return[];const t=at(),n=String(e),i=t[n];return Array.isArray(i)?i:[]}function Hn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=et();if(!Array.isArray(t)||t.length===0)return[];const n=new Map;e.forEach(a=>{if(!a||typeof a!="object")return;const c=a.equipmentId??a.equipment_id??a.id??null;if(c==null)return;const r=String(c),o=(()=>{const l=[a.qty,a.quantity,a.count,1];for(const s of l){const u=Number(s);if(Number.isFinite(u)&&u>0)return u}return 1})();n.set(r,(n.get(r)||0)+o)});const i=[];return t.forEach((a,c)=>{const r=Ne(a)||[],o=new Map;let l=!0;if(r.forEach(y=>{const _=y?.equipmentId??y?.equipment_id??null,I=Number.isFinite(Number(y?.qty))&&Number(y.qty)>0?Number(y.qty):1;if(_==null){l=!1;return}const p=String(_);o.set(p,(o.get(p)||0)+I)}),!l||o.size===0)return;let s=1/0;for(const[y,_]of o.entries()){const I=n.get(y)||0,p=Math.floor(I/_);if(p<=0){s=0;break}p<s&&(s=p)}if(!Number.isFinite(s)||s<=0)return;for(const[y,_]of o.entries()){const I=n.get(y)||0;n.set(y,Math.max(0,I-s*_))}const u=fe(a?.id??a?.packageId??a?.package_id??a?.code),d=Array.from(o.entries()).map(([y,_])=>({equipment_id:/^\d+$/.test(y)?Number(y):y,quantity:_,unit_price:0})),m=(a?.package_code??a?.code??u)||`pkg-${c}`,g=cn(a)||u||`package-${c}`;i.push({package_code:m,name:g,quantity:s,unit_price:St(a)||0,items:d})}),i}function Vn(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,a=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",c=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,r=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return i||a||c||r})}function On(e){return[]}function jt(e=[]){return Array.isArray(e)?e.map((t,n)=>Wt(t,n)).filter(Boolean).map((t,n)=>{const i=fe(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),a=Be(t,i).map(s=>{const u=Q(s.qty??s.quantity??s.count??s.units??s.unit_qty??s.unitQty??s.unit_count??s.unitCount??s.package_quantity??s.packageQty??1),d=J(F(s.price??s.unit_price??0));return{...s,qty:u,quantity:u,price:d,unit_price:d}}),c=Q(t.quantity??t.qty??1);let r=J(F(t.unit_price??t.unitPrice??t.price??0));if(!r||r<=0){const s=a.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);s>0&&c>0&&(r=J(Number((s/c).toFixed(2))))}const o=F(t.total_price??t.totalPrice??t.total??r*c),l=o>0?J(o):J(Number((r*c).toFixed(2)));return{...t,packageId:i,package_id:i,qty:c,quantity:c,unit_price:r,unitPrice:r,price:r,total_price:l,total:l,packageItems:a}}):[]}function Le(e,t){if(!e)return;const n=Mt(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],It(n));return}n[i]=jt(t),It(n)}function Kn(e){if(!e)return[];const t=Mt(),n=String(e),i=t[n];return Array.isArray(i)?jt(i):[]}function ot(e,t=0){if(e==null)return null;if(typeof e!="object"){const P=e!=null?String(e):null;return{assignmentId:`crew-${t}-${P??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:P,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,a=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,c=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let r=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";r||(r=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const o=e.position_label_ar??null,l=e.position_label_en??null,s=e.position_label_alt??l??o??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,m=J(D(u)),g=J(D(d)),y=e&&typeof e.technician=="object"?e.technician:null,_=e.technician_id??e.technicianId??e.id??y?.id??e.userId??e.user_id??null,I=e.technician_name??e.technicianName??e.name??y?.name??e.full_name??null,p=e.role??y?.role??e.specialization??null,h=e.technician_phone??y?.phone??e.phone??null;return{assignmentId:String(n),positionId:a!=null?String(a):null,positionKey:c!=null?String(c):null,positionLabel:r!=null?String(r):"",positionLabelAlt:s!=null?String(s):"",positionLabelAr:o!=null?String(o):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(m)?m:0,positionClientPrice:Number.isFinite(g)?g:0,technicianId:_!=null?String(_):null,technicianName:I!=null?String(I):null,technicianRole:p!=null?String(p):null,technicianPhone:h!=null?String(h):null,notes:e.notes??null}}function Qn(){return te}function Ee(e){te=Array.isArray(e)?e.map(Ve):[],te.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Le(n,t.packages),zn(n,t.items);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];Vn(i)}),Mn(te),Xt({reservations:te});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return te}async function Un(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),a=(await ze(`/reservations/${n?`?${n}`:""}`))?.data;let c=[];Array.isArray(a)?c=a:a&&typeof a=="object"&&(Array.isArray(a.items)?c=a.items:Array.isArray(a.results)?c=a.results:Array.isArray(a.data)?c=a.data:Array.isArray(a.records)&&(c=a.records));const r=c.map(He).map(Vt);return Ee(r)}async function Gn(e){const t=await ze("/reservations/",{method:"POST",body:e}),n=He(t?.data??{}),i=Array.isArray(e?.items)?e.items:null;if(i&&(Array.isArray(n.items)&&n.items.length?n.items=Ht(n.items,i):n.items=i.map(Oe)),!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=rt(e.payment_history);a.length&&(n.paymentHistory=a)}if((!Array.isArray(n.crewAssignments)||n.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const a=e.technicians.map((c,r)=>ot(c,r)).filter(Boolean);a.length&&(n.crewAssignments=a,n.techniciansDetails=a.map((c,r)=>{const o=e.technicians[r];return typeof o=="object"?{...o,...c}:c}))}if(Array.isArray(e?.packages)&&e.packages.length){const a=ut({packages:e.packages});n.packages=se(n.packages,a)}{const a=lt(n.items||[],n.packages||[]);n.items=a.items,n.packages=se(n.packages||[],a.packages)}if(Le(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=Se({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Ee([...te,n]),n}async function ct(e,t){const n=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=He(n?.data??{}),a=Array.isArray(t?.items)?t.items:null;if(a&&(Array.isArray(i.items)&&i.items.length?i.items=Ht(i.items,a):i.items=a.map(Oe)),console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const r=rt(t.payment_history);r.length&&(i.paymentHistory=r,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const r=t.technicians.map((o,l)=>ot(o,l)).filter(Boolean);r.length&&(i.crewAssignments=r,i.techniciansDetails=r.map((o,l)=>{const s=t.technicians[l];return typeof s=="object"?{...s,...o}:o}))}if(Array.isArray(t?.packages))if(t.packages.length){const r=ut({packages:t.packages});i.packages=se(i.packages,r)}else i.packages=[];{const r=lt(i.items||[],i.packages||[]);i.items=r.items,i.packages=se(i.packages||[],r.packages)}if(Le(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const r=Se({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=r.companyShareAmount,i.cost=r.finalTotal,i.totalAmount=r.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const c=te.map(r=>String(r.id)===String(e)?i:r);return Ee(c),i}function Ht(e,t){if(!Array.isArray(e)||!Array.isArray(t))return e;const n=new Map;return t.forEach((i,a)=>{if(!i||typeof i!="object")return;const c=i.equipment_id??i.equipmentId??i.id??null,r=b(String(i.barcode??"")).trim(),o=c!=null?`id:${c}`:r?`bc:${r}`:`idx:${a}`,l=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,s=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;n.set(o,{cost:l,price:s})}),e.map((i,a)=>{const c=i.equipmentId??i.equipment_id??i.id??null,r=b(String(i.barcode??"")).trim(),o=[c!=null?`id:${c}`:null,r?`bc:${r}`:null,`idx:${a}`].filter(Boolean);let l=null;for(const u of o)if(n.has(u)){l=n.get(u);break}if(!l)return i;const s={...i};return Number.isFinite(l.cost)&&(s.cost=l.cost,s.unit_cost=l.cost),Number.isFinite(l.price)&&(s.price=l.price,s.unit_price=l.price),s})}function Vt(e){try{return Wn(e)}catch(t){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",t),e}}function Wn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(c=>c!=null?String(c):"").filter(Boolean);if(!t.length)return e;const n=te.find(c=>{if(!c)return!1;const r=c.id!=null?String(c.id):"",o=c.reservationId!=null?String(c.reservationId):"",l=c.reservation_code!=null?String(c.reservation_code):"";return r&&t.includes(r)||o&&t.includes(o)||l&&t.includes(l)});if(!n||!Array.isArray(n.items))return e;const i=new Map;n.items.forEach((c,r)=>{const o=c?.equipmentId??c?.equipment_id??c?.id??null,l=b(String(c?.barcode??"")).trim(),s=o!=null?`id:${o}`:l?`bc:${l}`:`idx:${r}`;i.set(s,c)});const a=e.items.map((c,r)=>{const o=c?.equipmentId??c?.equipment_id??c?.id??null,l=b(String(c?.barcode??"")).trim(),s=[o!=null?`id:${o}`:null,l?`bc:${l}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const y of s)if(i.has(y)){u=i.get(y);break}if(!u)return c;const d={...c},m=Number(u.cost),g=Number(u.price);return Number.isFinite(m)&&m>0&&(d.cost=m,d.unit_cost=m),Number.isFinite(g)&&g>0&&(d.price=g,d.unit_price=g),d});return{...e,items:a}}function Yn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(c=>c!=null?String(c):"").filter(Boolean);if(!t.length)return e;let n=[];for(const c of t)if(n=jn(c),n.length)break;if(!n.length)return e;const i=new Map;n.forEach((c,r)=>{if(!c||typeof c!="object")return;const o=c.equipmentId??c.equipment_id??null,l=b(String(c.barcode??"")).trim(),s=o!=null?`id:${o}`:l?`bc:${l}`:`idx:${r}`;i.set(s,c)});const a=e.items.map((c,r)=>{const o=c?.equipmentId??c?.equipment_id??c?.id??null,l=b(String(c?.barcode??"")).trim(),s=[o!=null?`id:${o}`:null,l?`bc:${l}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const h of s)if(i.has(h)){u=i.get(h);break}if(!u)return c;const d={...c},m=J(F(u.cost??u.unit_cost)),g=J(F(u.price??u.unit_price)),y=Number.isFinite(m),_=Number.isFinite(g),I=Number(c.cost),p=Number(c.price);return y&&(!Number.isFinite(I)||I<=0)&&(d.cost=m,d.unit_cost=m),_&&(!Number.isFinite(p)||p<=0)&&(d.price=g,d.unit_price=g),d});return{...e,items:a}}async function Jn(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=te.filter(n=>String(n.id)!==String(e));Ee(t),Le(e,null)}async function Xn(e){return ct(e,{status:"confirmed",confirmed:!0})}async function Zn(e,t=null){const n={status:"completed",confirmed:!0};return typeof t=="string"&&(n.notes=t),ct(e,n)}function He(e={}){const t=Ve({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});return Yn(Vt(t))}function Ot(e={}){return Ve(e)}function Ve(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(Oe):[],a=ut(e);const c=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let r=c.map((w,ee)=>ot(w,ee)).filter(Boolean),o=r.map((w,ee)=>{const C=c?.[ee];return{...C&&typeof C=="object"?{...C}:C!=null?{id:C}:{},...w}});const l=r.map(w=>w.technicianId).filter(w=>w!=null&&w!=="").map(w=>Number.isNaN(Number(w))?String(w):Number(w)),s=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=F(e.total_amount??e.totalAmount??e.cost??0);const m=F(e.discount??0),g=e.discount_type??e.discountType??"percent",y=["percent","amount"].includes(g)?g:"percent",_=!!(e.apply_tax??e.applyTax??!1);let I=si(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),h=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,P=h!=null?Number.parseFloat(b(String(h).replace("%","").trim())):NaN,A=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let S=A!=null?A===!0||A===1||A==="1"||String(A).toLowerCase()==="true":Number.isFinite(P)&&P>0,k=S&&Number.isFinite(P)?Number(P):0;const v=e.company_share_amount??e.companyShareAmount;let L=Number.isFinite(Number(v))?Number(v):NaN;_&&k<=0&&(k=Tt,S=!0);const B=Se({items:i,technicianIds:l,crewAssignments:r,discount:m,discountType:y,applyTax:_,start:s,end:u,companySharePercent:k>0?k:null});(!Number.isFinite(d)||d<=0||_)&&(d=B.finalTotal),(!Number.isFinite(L)||L<0)&&(L=B.companyShareAmount),L=Number.isFinite(L)?Number(L.toFixed(2)):0,!S&&k>0&&(S=!0);const V=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],f=ti(V),G=rt(f),j=t??n??e.reservation_code??e.reservationId??null;if(a.length)Le(j,a);else{const w=Kn(j);w.length&&(a=se(a,w))}if(!a.length&&Array.isArray(i)&&i.length)try{const w=Hn(i);Array.isArray(w)&&w.length&&(a=se(a,w))}catch(w){console.warn("[reservationsService] inference of packages from items failed",w)}const Z=lt(i,a);i=Z.items,a=se(a,Z.packages);const H=nt({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:G});I=it({manualStatus:I,paidAmount:H.paidAmount,paidPercent:H.paidPercent,totalAmount:d});const O=I==="paid",K=ri(e.status??(p?"confirmed":"pending"));return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:s,end:u,status:K,completed:K==="completed",confirmed:p,location:e.location??"",notes:e.notes??"",discount:m,discountType:y,applyTax:_,paid:O,paidStatus:I,paidAmount:H.paidAmount,paidPercent:H.paidPercent,paymentProgressType:H.paymentProgressType,paymentProgressValue:H.paymentProgressValue,paymentHistory:G,payment_history:G,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:r,techniciansDetails:o,startDatetime:s,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:a,companySharePercent:k,companyShareAmount:L,companyShareEnabled:S}}function Oe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=Q(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=F(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),a=F(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),c=b(String(e.barcode??e.code??e.serial??"")),r=e.description??e.desc??e.name??e.title??"",o={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:c,desc:r,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,cost:a,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},l=Kt(e.type??e.item_type??e.kind??null),s=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=W(s),d=Be(e,u);if(l==="package"||u||d.length){o.type="package";const m=u||(t!=null?String(t):o.id?W(o.id):"");m&&(o.packageId=m,o.package_id=m,o.package_code=e.package_code??e.packageCode??m),o.name=r||o.package_code||m||"",o.barcode=o.barcode||b(String(e.package_code??e.packageCode??"")),o.packageItems=d;const g=Ut({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(o.price)||o.price<=0||o.price>g*10)&&(o.price=g),o.qtyPerPackage=d.length?d[0]?.qtyPerPackage??o.qtyPerPackage:o.qtyPerPackage,o.totalQuantity=n}return o}function ei({reservationCode:e,customerId:t,start:n,end:i,status:a,title:c,location:r,notes:o,projectId:l,totalAmount:s,discount:u,discountType:d,applyTax:m,paidStatus:g,confirmed:y,items:_,packages:I,crewAssignments:p=[],technicians:h=p,companySharePercent:P,companyShareEnabled:A,paidAmount:S,paidPercentage:k,paymentProgressType:v,paymentProgressValue:L,paymentHistory:B}){const V=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:a??"pending",title:c??null,location:r??null,notes:o??null,project_id:l||null,total_amount:s??0,discount:u??0,discount_type:d??"percent",apply_tax:m?1:0,paid_status:g??"unpaid",paid_amount:Number.isFinite(S)?F(S):0,paid_percentage:Number.isFinite(k)?Number(k.toFixed(2)):0,payment_progress_type:v??null,payment_progress_value:Number.isFinite(L)?Number(L.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(f=>({type:Ye(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?F(f.value):null,amount:f?.amount!=null?F(f.amount):f?.payment_amount!=null?F(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(f=>({type:Ye(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?F(f.value):null,amount:f?.amount!=null?F(f.amount):f?.payment_amount!=null?F(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],confirmed:y===void 0?null:!!y,items:ni(_),packages:ii(_,I),company_share_percent:A&&Number.isFinite(P)?Number(P):null,company_share_enabled:A?1:0,technicians:V.length?V.map((f,G)=>{const j=f.technicianId??f.technician_id??f.id??null,Z=f.positionId??f.position_id??f.position??f.position_code??null,H=f.positionLabel??f.position_name??f.role??null,O=F(f.positionCost??f.position_cost??f.cost??f.daily_wage??f.dailyWage??0),K=F(f.positionClientPrice??f.position_client_price??f.client_price??f.clientPrice??f.daily_total??f.dailyTotal??f.total??0);return{id:j,technician_id:j,role:H??f.technicianRole??null,notes:f.notes??null,position_id:Z,position_key:f.positionKey??f.position_key??null,position_name:H,position_label_ar:f.positionLabelAr??f.position_label_ar??null,position_label_en:f.positionLabelEn??f.position_label_en??null,position_cost:O,position_client_price:K,client_price:K,cost:O,assignment_id:f.assignmentId??f.assignment_id??`crew-${G}`}}):Array.isArray(h)?h.map(f=>typeof f=="object"&&f!==null?{id:f.id??f.technician_id??f.technicianId??f.ID,role:f.role??null,notes:f.notes??null}:Number.isNaN(Number(f))?String(f):Number(f)):[]}}function rt(e){const t=st(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,a=Ye(i),c=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,r=c!=null?Number.parseFloat(b(String(c))):null,o=n.amount!=null?Number.parseFloat(b(String(n.amount))):n.payment_amount!=null?Number.parseFloat(b(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(b(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(b(String(n.payment_percentage))):null,s=Number.isFinite(o)?o:a==="amount"&&Number.isFinite(r)?r:null,u=Number.isFinite(l)?l:a==="percent"&&Number.isFinite(r)?r:null,d=a??(s!=null?"amount":u!=null?"percent":null),m=d==="amount"?s:d==="percent"?u:Number.isFinite(r)?r:null,g=n.note??n.notes??n.comment??n.payment_note??null,y=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:m,amount:s,percentage:u,note:g,recordedAt:y}}).filter(n=>n&&n.type)}function Ye(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function st(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of t)if(Array.isArray(e[r]))return e[r];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(i))return i;const a=Object.values(e);if(a.length&&a.every(r=>r&&typeof r=="object")){const r=a.map(o=>o);if(r.every(o=>!Array.isArray(o)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return st(t)}catch{return[]}return[]}function ti(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=st(t);if(Array.isArray(n)&&n.length)return n}return[]}function ni(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const a=Q(n.qty??n.quantity??1);n.packageItems.forEach(c=>{const r=c?.equipmentId??c?.equipment_id??c?.id??null;if(r==null)return;const o=Q(c?.qty??c?.quantity??1),l=a*o;t.push({equipment_id:Je(r),quantity:l,unit_price:F(c?.price??c?.unit_price??0),unit_cost:F(c?.cost??c?.unit_cost??0),notes:c?.notes??null})});return}const i=n.equipmentId??n.equipment_id??n.id??null;i!=null&&t.push({equipment_id:Je(i),quantity:Q(n.qty??n.quantity??1),unit_price:F(n.price??n.unit_price??0),unit_cost:F(n.cost??n.unit_cost??0),notes:n.notes??null})}),t}function Je(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function ii(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const a=Q(i.qty??i.quantity??1),c=Array.isArray(i.packageItems)?i.packageItems.map(r=>{const o=r?.equipmentId??r?.equipment_id??r?.id??null;return o==null?null:{equipment_id:Je(o),quantity:Q(r?.qty??r?.quantity??r?.count??r?.units??r?.unit_qty??r?.unitQty??r?.unit_count??r?.unitCount??r?.package_quantity??r?.packageQty??1),unit_price:F(r?.price??r?.unit_price??0),unit_cost:F(r?.cost??r?.unit_cost??0)}}).filter(Boolean):[];n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:a,unit_price:F(i.price??i.unit_price??0),unit_cost:F(i.cost??i.unit_cost??0),items:c})}),n}function Kt(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function W(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return fe(t)}function Xe(e){return e==null?"":b(String(e)).trim().toLowerCase()}function Qt(e={},t=1){if(!e||typeof e!="object"){const l=b(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:l,normalizedBarcode:Xe(l),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=Q(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=F(e.unit_price??e.unitPrice??e.price??0),c=b(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),r=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let o;if(r!=null)o=Q(r,{fallback:1,max:99});else if(t>0){const l=i/t;Number.isFinite(l)&&l>0&&Number.isInteger(l)?o=Q(l,{fallback:1,max:99}):o=Math.min(i,99)}else o=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:o,quantity:o,qtyPerPackage:o,totalQuantity:i,price:a,unit_price:a,barcode:c,normalizedBarcode:Xe(e.normalizedBarcode??c),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function ai(e={},t={}){const n=W(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=Q(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=F(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),c=b(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:c,desc:t.desc??t.description??e.name??e.desc??e.title??c,qty:i,quantity:i,price:a,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:c,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function lt(e=[],t=[]){const n=oi(e),i=Array.isArray(t)?se(t,n.packages):n.packages,a=new Map;return i.forEach(c=>{const r=W(c.packageId??c.package_id??c.id);r&&a.set(r,c)}),n.packages.forEach(c=>{const r=W(c.packageId??c.package_id??c.id);if(!r)return;const o=a.get(r);o&&((!Array.isArray(o.packageItems)||o.packageItems.length===0)&&(o.packageItems=c.packageItems),!o.name&&c.name&&(o.name=c.name),!o.image&&c.image&&(o.image=c.image))}),{items:n.items,packages:Array.from(a.values())}}function oi(e=[]){const t=new Map;if(e.forEach(c=>{const r=W(c.packageId??c.package_id??c.packageCode??c.package_code??c.bundleId??c.bundle_id??null);if(!r)return;const o=r;t.has(o)||t.set(o,{base:c,items:[]}),t.get(o).items.push(c)}),!t.size)return{items:e,packages:[]};const n=[],i=[],a=new Set;return e.forEach(c=>{const r=W(c.packageId??c.package_id??c.packageCode??c.package_code??c.bundleId??c.bundle_id??null);if(r&&t.has(r)){if(a.has(r))return;const o=t.get(r),l=o.base||c,s=o.items.map(d=>Qt(d,1)),u={packageId:r,package_id:r,package_code:l.package_code??l.packageCode??l.barcode??b(String(r)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${r}`,quantity:Q(l.package_quantity??l.packageQty??1,{fallback:1,max:9999}),unit_price:F(l.package_price??l.packagePrice??l.price??0),packageItems:s,image:l.image??null};i.push(u),n.push(ai(u,l)),a.add(r);return}n.push(c)}),{items:n,packages:i}}function Be(e={},t=""){if(!e||typeof e!="object")return[];const n=W(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let a=Ne({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),c=[];if((!Array.isArray(a)||a.length===0)&&n){const s=ge(n);s&&(a=Ne(s),c=Array.isArray(a)?a:[])}else if(n){const s=ge(n);s&&(c=Ne(s)||[])}if(!Array.isArray(a)||a.length===0)return[];const r=Q(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),o=a.map(s=>Qt(s,r));if(c.length){const s=new Map;c.forEach(u=>{if(!u)return;const d=Xe(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&s.set(d,u)}),o.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!s.has(d))return;const m=s.get(d),g=Q(m.quantity??m.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=g,u.qty=g,u.quantity=g;const y=F(m.unit_price??m.unitPrice??m.price??u.price);u.price=y,u.unit_price=y,!u.desc&&m.desc&&(u.desc=m.desc),!u.image&&m.image&&(u.image=m.image)})}const l=new Map;return o.forEach(s=>{const u=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=s.qty,d.quantity+=s.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=s.qtyPerPackage),(!d.price||d.price===0)&&s.price&&(d.price=s.price,d.unit_price=s.unit_price),!d.desc&&s.desc&&(d.desc=s.desc),!d.image&&s.image&&(d.image=s.image);return}l.set(u,{...s})}}),Array.from(l.values())}function Ut(e={},t=[],n=1){try{const c=W(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(c){const r=ge(c);if(r){const o=St(r);if(Number.isFinite(Number(o))&&Number(o)>0)return Number(o)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return F(i);const a=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(a))){const c=F(a);return n>0?Number((c/n).toFixed(2)):c}return 0}function Gt(e,t){if(!e)return t;if(!t)return e;const n={...e},i=a=>{(n[a]===void 0||n[a]===null||n[a]==="")&&(n[a]=t[a])};return["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=ci(n.packageItems,t.packageItems),n.items=n.packageItems),n}function ci(e=[],t=[]){const n=new Map,i=a=>{a.forEach(c=>{if(!c)return;const r=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(r){if(n.has(r)){const o=n.get(r);o.qty+=c.qty??0,o.quantity+=c.quantity??0,(!Number.isFinite(o.qtyPerPackage)||o.qtyPerPackage<=0)&&Number.isFinite(c.qtyPerPackage)&&(o.qtyPerPackage=c.qtyPerPackage),(!o.price||o.price===0)&&c.price&&(o.price=c.price,o.unit_price=c.unit_price),!o.desc&&c.desc&&(o.desc=c.desc),!o.image&&c.image&&(o.image=c.image);return}n.set(r,{...c})}})};return i(e),i(t),Array.from(n.values())}function se(e=[],t=[]){const n=[],i=new Map,a=et(),c=new Map;a.forEach(l=>{const s=W(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&c.set(u,s||u)});const r=l=>{const s=W(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?b(u):"";return s||(d&&c.has(d)?c.get(d):d||null)},o=l=>{Array.isArray(l)&&l.forEach(s=>{if(!s||typeof s!="object")return;const u=r(s);if(u)if(i.has(u)){const d=i.get(u);n[d]=Gt(n[d],s)}else i.set(u,n.length),n.push({...s})})};return o(e),o(t),n}function Wt(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const d=W(e),m=d?ge(d):null,g=m?Be(m,d):[],y=m?F(m.price??m.unit_price??m.unitPrice??0):0,_=1,I=Number((y*_).toFixed(2));return{id:`package::${d||t}`,packageId:d||`pkg-${t}`,package_id:d||`pkg-${t}`,package_code:b(String(e))||d||`pkg-${t}`,name:m?.name??m?.package_name??m?.packageName??b(String(e))??"",desc:m?.name??b(String(e))??"",quantity:_,qty:_,unit_price:y,unitPrice:y,price:y,total:I,total_price:I,barcode:b(String(e)),packageItems:g,items:g,type:"package",image:m?.image??null}}if(typeof e!="object")return null;const n=W(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=Q(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=Be(e,n),c=Ut(e,a,i),r=e.total_price??e.totalPrice??e.total??c*i,o=Number.isFinite(Number(r))?F(r):Number((c*i).toFixed(2)),l=e.package_code??e.packageCode??e.code??n,s=b(String(e.barcode??l??"")),u=e.image??e.cover??e.thumbnail??a.find(d=>d.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:l,name:e.name??e.package_name??e.packageName??e.title??e.description??l??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??l??n,quantity:i,qty:i,unit_price:c,unitPrice:c,price:c,total:o,total_price:o,barcode:s,packageItems:a,items:a,type:"package",image:u}}function ut(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,a=(o,l=n.length)=>{const s=Wt(o,l);if(!s)return;const u=s.packageId||s.package_code||s.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);n[d]=Gt(n[d],s)}else i.set(u,n.length),n.push(s)};t.forEach(o=>{o.forEach((l,s)=>{a(l,s+n.length)})}),n.length===0&&e.package&&a(e.package,0);const c=Array.isArray(e.items)?e.items:[],r=(o={})=>!o||typeof o!="object"?!1:!!(Kt(o.type??o.item_type??o.kind??null)==="package"||o.packageItems&&Array.isArray(o.packageItems)&&o.packageItems.length||o.items&&Array.isArray(o.items)&&o.items.length&&o.items.every(s=>typeof s=="object")||o.packageId||o.package_id||o.package_code||o.packageCode||o.bundleId||o.bundle_id);return c.forEach((o,l)=>{r(o)&&a(o,n.length+l)}),n}function F(e){const t=D(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function Q(e,{fallback:t=1,max:n=1e6}={}){const i=D(e);if(!Number.isFinite(i))return t;const a=Math.round(i);return a<=0||a>n?t:a}function ri(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function si(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function li(e){return e instanceof Zt}const Ni=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:ei,closeReservationApi:Zn,confirmReservationApi:Xn,createReservationApi:Gn,deleteReservationApi:Jn,getCachedReservationCrew:On,getReservationsState:Qn,isApiError:li,mapLegacyReservation:Ot,mapReservationFromApi:He,mapReservationItem:Oe,refreshReservationsFromApi:Un,setReservationsState:Ee,toInternalReservation:Ve,updateReservationApi:ct},Symbol.toStringTag,{value:"Module"}));export{Ve as A,Dn as B,vn as C,Tt as D,D as E,$ as F,On as G,fi as H,bn as I,yi as J,Ot as K,An as L,Xn as M,Zn as N,Ni as O,_i as a,$n as b,nt as c,Se as d,it as e,Jn as f,Qn as g,ki as h,pi as i,hi as j,hn as k,wn as l,He as m,Et as n,In as o,qn as p,Nn as q,Un as r,mi as s,ei as t,ct as u,Gn as v,li as w,gi as x,mt as y,bi as z};
