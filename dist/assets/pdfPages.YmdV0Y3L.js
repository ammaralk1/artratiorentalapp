import{t as o,r as C,f as q,c as N,p as D,a as M,b as f,d as S,e as I}from"./calculations.Bqm4O-PR.js";import{e as A}from"./reports.BVNfiBWy.js";import{s as F,c as z,d as H,q as W}from"./controller.CwK47G-r.js";import{n as w}from"./auth.BcQOd76e.js";import"./reservationsService.BtJ4Aekt.js";import"./dashboard.CFfYs4OC.js";/* empty css              */import"./dashboardShell.deT9qe6E.js";import"./customers.Bfn9j-AP.js";import"./maintenanceService.Cf3sMnbW.js";const k=96,R=25.4,$=210,L=297,_=Math.round($/R*k),j=Math.round(L/R*k),O=/safari/i,X=/(iphone|ipad|ipod)/i,U=/(crios|fxios|edgios|opios)/i;function G(){try{const r=navigator.userAgent||"";return X.test(r)&&O.test(r)&&!U.test(r)}catch{return!1}}function V(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function Y(r="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",r);const p=document.createElement("style");p.textContent=String(W).trim(),t.appendChild(p);const s=document.createElement("div");s.className="quote-preview-pages",s.setAttribute("data-quote-pages",""),t.appendChild(s);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; }
    .rpt-table th { background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
  `,t.appendChild(e),t}function E({primary:r=!1}={}){const t=document.createElement("div");return t.className="quote-page",r&&t.classList.add("quote-page--primary"),t}function B(r){const t=document.createElement("div");t.className="rpt-header";const p=document.createElement("h1");p.textContent=o("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const s=document.createElement("p");s.className="rpt-subtitle",s.textContent=`${I(new Date)} • ${o("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(p),t.appendChild(s);const e=document.createElement("div");e.className="rpt-kpis";const a=(i,n)=>{const d=document.createElement("div");return d.className="rpt-kpi",d.innerHTML=`<div class="label">${i}</div><div class="value">${n}</div>`,d};return e.appendChild(a(o("reservations.reports.kpi.total.label","الحجوزات","Reservations"),S(r.total||0))),e.appendChild(a(o("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),f(r.revenue||0))),e.appendChild(a(o("reservations.reports.kpi.net.label","صافي الربح","Net profit"),f(r.netProfit||0))),e.appendChild(a(o("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),f(r.companyShareTotal||0))),e.appendChild(a(o("reservations.reports.kpi.tax.label","الضريبة","Tax"),f(r.taxTotal||0))),e.appendChild(a(o("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),f(r.maintenanceExpense||0))),t.appendChild(e),t}function J(){try{const r=C?.data||{},t=C?.lastSnapshot?.filtered||r.reservations||[],p=new Map((r.customers||[]).map(n=>[String(n.id),n])),s=[...t].sort((n,d)=>new Date(d?.start||0)-new Date(n?.start||0)),e={code:o("reservations.reports.results.headers.id","الحجز","Reservation"),customer:o("reservations.reports.results.headers.customer","العميل","Customer"),date:o("reservations.reports.results.headers.date","التاريخ","Date"),status:o("reservations.reports.results.headers.status","الحالة","Status"),payment:o("reservations.reports.results.headers.payment","الدفع","Payment"),total:o("reservations.reports.results.headers.total","الإجمالي","Total"),share:o("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:o("reservations.reports.results.headers.net","صافي الربح","Net profit")},a=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],i=s.map(n=>{const d=n?.reservationId||n?.id||"—",c=w(String(d)),u=p.get(String(n?.customerId))?.customerName||o("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),x=q(n?.start),y=N(n),l=(()=>{switch(y.statusValue){case"completed":return String(o("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(o("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(o("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return w(String(y.statusValue||"—"))}})(),h=D(y.paidStatus),m=M(n),g=f(m.finalTotal),v=m.companySharePercent>0?`${S(m.companySharePercent)}% (${f(m.companyShareAmount)})`:o("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),T=f(m.netProfit);return{[e.code]:c,[e.customer]:u,[e.date]:x,[e.status]:l,[e.payment]:h,[e.total]:g,[e.share]:v,[e.net]:T}});return{headers:a,rows:i}}catch(r){return console.warn("[reports/pdf] failed to build export rows from state",r),{headers:[],rows:[]}}}function P(r){const t=document.createElement("table");t.className="rpt-table";const p=document.createElement("thead"),s=document.createElement("tr");r.forEach(a=>{const i=document.createElement("th");i.textContent=a,s.appendChild(i)}),p.appendChild(s);const e=document.createElement("tbody");return t.appendChild(p),t.appendChild(e),{table:t,tbody:e}}function K(r,t,p,s){const e=r.querySelector("[data-quote-pages]"),a=E({primary:!0});e.appendChild(a);const i=B(s);a.appendChild(i);let{table:n,tbody:d}=P(p);a.appendChild(n);const c=18,b=28,u=[];for(let l=0;l<t.length;l+=b)u.push(t.slice(l,l+b));if(u.length){const l=u[0];if(l.length>c){const h=l.splice(c);u.length>1?u[1]=h.concat(u[1]):u.push(h)}}const x=(l,h)=>{const m=document.createElement("tr");p.forEach(g=>{const v=document.createElement("td");v.textContent=h[g]!=null?String(h[g]):"",m.appendChild(v)}),l.appendChild(m)};(u.shift()||t).forEach(l=>x(d,l)),u.forEach(l=>{const h=E({primary:!1});e.appendChild(h);const m=P(p);h.appendChild(m.table),l.forEach(g=>x(m.tbody,g))})}function Q(r=[],{context:t="preview"}={}){const s=(C.lastSnapshot||{}).metrics||{};let e,a=r&&r.length?r:null;if(a)e=Object.keys(a[0]||{});else{const d=J();e=d.headers,a=d.rows}const i=Y(t),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${_}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(i);try{F(i),z(i),H(i)}catch{}return K(i,a||[],e,s),i.parentElement?.removeChild(i),n.parentElement?.removeChild(n),i}async function de(r=[],{action:t="save"}={}){const p=Q(r,{context:"export"}),s=document.createElement("div");Object.assign(s.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),s.appendChild(p),document.body.appendChild(s);try{const a=G()&&!V()?window.open("","_blank"):null;if(a)try{a.document.open(),a.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${o("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${o("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${o("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),a.document.close()}catch{}await A();const i=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",scrollX:0,scrollY:0,windowWidth:_,windowHeight:j},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(p).toPdf();if(t==="print"){const n=await i.get("pdf").then(d=>d.output("bloburl"));if(a)try{a.location.href=n}catch{}else await new Promise(d=>{const c=document.createElement("iframe");Object.assign(c.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),c.onload=()=>{try{c.contentWindow?.focus(),c.contentWindow?.print()}catch{}setTimeout(()=>{c.remove(),d()},1e3)},c.src=n,document.body.appendChild(c)})}else await i.save("reservations-report.pdf")}finally{s.remove()}}export{Q as buildReportsPdfPages,de as exportReportsPdf};
