import{r as qe,t as u,n as A,l as qt,s as x,a as Vt,e as Ve,h as Ue,i as He,j as ze}from"./auth.DeRd8Lwk.js";import{i as Oe}from"./dashboardShell.GGxhX8QT.js";import{e as Tt,g as We,c as Ke}from"./form.BWwryHSX.js";import{r as ne,g as Ut,D as ft,o as Ye,q as Ge,s as Ht,j as Qe,x as Ae,y as Je}from"./reservationsService.uHRkBvfi.js";import{e as Ee,c as ae,d as Se,g as Xe,w as Ze,f as tn,u as en,s as nn,h as an}from"./controller.CTQSP90Y.js";import{g as At,b as cn,f as sn,a as rn,c as on,d as ie,s as ln,e as dn}from"./projectFocusTemplates.DuRNYSo5.js";qe({ar:{"technicianDetails.pageTitle":"معلومات عضو الطاقم","technicianDetails.title":"😎 بيانات عضو الطاقم","technicianDetails.actions.back":"⬅️ العودة","technicianDetails.actions.edit":"✏️ تعديل عضو الطاقم","technicianDetails.hero.subtitle":"راجع نشاط عضو الطاقم ومهامه الحالية.","technicianDetails.hero.helper":"استخدم هذه الصفحة لمتابعة حجوزات ومشاريع عضو الطاقم.","technicianTabs.reservations":"📅 حجوزات الفني","technicianTabs.projects":"📁 مشاريع الفني","technicianFinancial.stats.total":"💼 إجمالي المستحقات","technicianFinancial.stats.paid":"💰 المبالغ المدفوعة","technicianFinancial.stats.outstanding":"🧾 المبلغ المتبقي","technicianFinancial.stats.totalDesc":"مرتبطة بـ {count} مهام","technicianFinancial.stats.paidDesc":"تم تسجيل {count} دفعات","technicianFinancial.stats.outstandingDesc":"المتبقي {amount}","technicianFinancial.actions.viewDetails":"📊 عرض التفاصيل","technicianFinancial.modal.title":"📊 الملخص المالي للفني","technicianFinancial.modal.subtitle":"نظرة تفصيلية على مستحقات العضو والمدفوعات السابقة والحالية.","technicianFinancial.list.title":"تفاصيل الحجوزات والمشاريع","technicianFinancial.assignments.empty":"لا توجد حجوزات أو مشاريع مرتبطة لعرضها.","technicianFinancial.list.reservation":"الحجز / المشروع","technicianFinancial.list.period":"الفترة","technicianFinancial.list.due":"المستحق","technicianFinancial.list.status":"حالة الدفع","technicianFinancial.list.outstanding":"المتبقي","technicianFinancial.list.settled":"لا يوجد","technicianFinancial.list.reservationFallback":"حجز رقم {id}","technicianFinancial.list.projectReference":"مشروع #{id}","technicianFinancial.status.paid":"مدفوع","technicianFinancial.status.partial":"مدفوع جزئياً","technicianFinancial.status.unpaid":"غير مدفوع","technicianFinancial.payouts.title":"💸 سجل الدفعات الداخلية","technicianFinancial.payouts.helper":"سجّل المبالغ التي تم دفعها لهذا العضو من الشركة لضمان تتبع السداد.","technicianFinancial.payouts.empty":"لا توجد دفعات مسجلة بعد.","technicianFinancial.payouts.form.amount":"💰 المبلغ","technicianFinancial.payouts.form.date":"📅 تاريخ الدفع","technicianFinancial.payouts.form.note":"📝 ملاحظات (اختياري)","technicianFinancial.payouts.form.submit":"💸 تسجيل الدفعة","technicianFinancial.payouts.confirmDelete":"❌ هل تريد حذف هذه الدفعة؟","technicianFinancial.payouts.confirmTitle":"🗑️ حذف الدفعة","technicianFinancial.payouts.confirmMessage":"هل أنت متأكد من حذف هذه الدفعة؟ لا يمكن التراجع عن هذا الإجراء.","technicianFinancial.payouts.confirmCancel":"إلغاء","technicianFinancial.payouts.confirmAccept":"🗑️ حذف","technicianFinancial.payouts.toast.added":"✅ تم تسجيل الدفعة.","technicianFinancial.payouts.toast.removed":"🗑️ تم حذف الدفعة.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ أدخل قيمة صحيحة للمبلغ.","technicianFinancial.payouts.toast.failed":"⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ لا يمكن تحديد عضو الطاقم حالياً.","technicianDetails.filters.search":"🔍 ابحث باسم العميل أو اكتب رقم الحجز (مثل #123) أو المشروع...","technicianDetails.fields.role":"👔 الوظيفة:","technicianDetails.fields.department":"🧩 القسم:","technicianDetails.fields.phone":"📞 الجوال:","technicianDetails.fields.email":"📧 البريد:","technicianDetails.fields.wage":"💰 الأجر اليومي:","technicianDetails.fields.total":"💼 التكلفة الإجمالية:","technicianDetails.fields.baseStatus":"⚙️ الحالة الأساسية:","technicianDetails.fields.notes":"📝 الملاحظات:","technicianDetails.fallback.email":"—","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"غير محدد","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ لا يوجد معرف عضو طاقم في الرابط.","technicianDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العضو.","technicianDetails.errors.loadFailed":"❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.","technicianDetails.errors.reservationsLoadFailed":"❌ تعذر تحميل حجوزات هذا العضو حالياً.","technicianDetails.status.loading":"⏳ جارٍ تحميل بيانات عضو الطاقم...","technicianDetails.edit.modalTitle":"✏️ تعديل بيانات عضو الطاقم","technicians.picker.actions.apply":"تم","technicianProjects.title":"📁 مشاريع الفني","technicianReservations.title":"📅 حجوزات الفني","technicianProjects.empty":"لا توجد مشاريع مرتبطة بهذا العضو."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"😎 Crew Member Profile","technicianDetails.actions.back":"⬅️ Back","technicianDetails.actions.edit":"✏️ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew member’s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"📅 Technician Reservations","technicianTabs.projects":"📁 Technician Projects","technicianFinancial.stats.total":"💼 Total Due","technicianFinancial.stats.paid":"💰 Paid Amount","technicianFinancial.stats.outstanding":"🧾 Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"📊 View details","technicianFinancial.modal.title":"📊 Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"💸 Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"💰 Amount","technicianFinancial.payouts.form.date":"📅 Payment date","technicianFinancial.payouts.form.note":"📝 Notes (optional)","technicianFinancial.payouts.form.submit":"💸 Record payout","technicianFinancial.payouts.confirmDelete":"❌ Delete this payout?","technicianFinancial.payouts.confirmTitle":"🗑️ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"🗑️ Delete","technicianFinancial.payouts.toast.added":"✅ Payout logged successfully.","technicianFinancial.payouts.toast.removed":"🗑️ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"⚠️ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ Unable to determine the crew member right now.","technicianDetails.filters.search":"🔍 Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"👔 Role:","technicianDetails.fields.department":"🧩 Department:","technicianDetails.fields.phone":"📞 Phone:","technicianDetails.fields.email":"📧 Email:","technicianDetails.fields.wage":"💰 Daily Rate:","technicianDetails.fields.total":"💼 Total Charge:","technicianDetails.fields.baseStatus":"⚙️ Base Status:","technicianDetails.fields.notes":"📝 Notes:","technicianDetails.fallback.email":"—","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"⚠️ Crew member not found.","technicianDetails.errors.loadFailed":"❌ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"❌ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"⏳ Loading crew member details...","technicianDetails.edit.modalTitle":"✏️ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"📁 Technician Projects","technicianReservations.title":"📅 Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let kt={},I={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},ce=!1;function Ct(t=""){return A(String(t)).replace(/[٬،]/g,"").trim().toLowerCase()}function Ie(t,e,n){if(!e||!n)return;const{startDate:a,endDate:c}=Se(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?c?n._flatpickr.setDate(c,!1,"Y-m-d"):n._flatpickr.clear():n.value=c||""}function z(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function we(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!ce){try{await Ee({suppressError:!1,force:!0})}catch(g){console.error("❌ [technician-details] Failed to hydrate reservations list",g),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${u("technicianDetails.errors.reservationsLoadFailed","❌ تعذر تحميل حجوزات هذا العضو حالياً.")}</p>`;return}ce=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),c=document.getElementById("technician-filter-end-date"),i=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),o=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),c&&window.flatpickr(c,{dateFormat:"Y-m-d"}));const d=()=>{let g=A(a?.value||"").trim(),v=A(c?.value||"").trim(),D=i?.value||"";if(new Set(["","today","week","month"]).has(D)||(D="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),g="",v=""),!g&&!v&&D){const{startDate:$,endDate:r}=Se(D);g=$,v=r}return{searchTerm:Ct(n?.value||""),startDate:g,endDate:v,status:l?.value||"",quickRange:D,technicianId:t}},m=()=>{kt=d(),ae("technician-reservations",kt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=A(n.value),m()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),m()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{i&&(i.value=""),m()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Ie(i.value,a,c),m()}),i.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",m),l.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),i&&(i.value=""),l&&(l.value=""),m()}),o.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{ae("technician-reservations",kt)},m()}function Fe(t){I.currentId=t;const{container:e}=it();e&&(I.initialized||(un(),mn(),fn(),document.addEventListener("projects:changed",()=>{I.currentId&&C()}),document.addEventListener("language:changed",()=>{I.currentId&&C()}),document.addEventListener("customers:changed",()=>{I.currentId&&C()}),document.addEventListener("technicians:updated",()=>{I.currentId&&C()}),I.initialized=!0),C())}function it(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function un(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:c,rangeSelect:i}=it();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=A(t.value),C()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{i&&(i.value=""),C()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(c,{dateFormat:"Y-m-d"}),c.addEventListener("change",()=>{i&&(i.value=""),C()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Ie(i.value,a,c),C()}),i.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{C()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:l,statusSelect:o,startInput:d,endInput:m,rangeSelect:g}=it();l&&(l.value=""),o&&(o.value=""),d&&(d._flatpickr&&d._flatpickr.clear(),d.value=""),m&&(m._flatpickr&&m._flatpickr.clear(),m.value=""),g&&(g.value=""),C()}),n.dataset.listenerAttached="true")}function mn(){const{container:t}=it();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",pn),t.dataset.projectModalListenerAttached="true")}function hn(){const{container:t}=it();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const c=e.dataset.projectId?String(e.dataset.projectId):"";c&&Et(c)}),e.dataset.technicianModalListenerAttached="true")})}function pn(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&Et(a)}function fn(){zt()}function zt(){if(I.modal?.el&&I.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(I.modal={el:t,body:e},!0)}function C(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:c}=it();if(!t||!I.currentId)return;const i=Ct(e?.value||""),l=n?.value||"",o=a?.value||"",d=c?.value||"",m=o?new Date(`${o}T00:00:00`):null,g=d?new Date(`${d}T23:59:59`):null,{projects:v=[],customers:D=[],technicians:T=[],reservations:R=[]}=qt(),$=new Map(D.map(s=>[String(s.id),s])),r=new Map(T.map(s=>[String(s.id),s])),h=new Map(v.map(s=>[String(s.id),s])),b=gn(R),j=String(I.currentId),w=new Map,O=(s,y=null)=>{if(!s)return;const p=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(p&&!w.has(p)){const f=y??z(s?.technicians);w.set(p,{...s,technicians:f})}};v.forEach(s=>{const y=z(s?.technicians);y.length&&y.includes(j)&&O({...s,technicians:y},y)}),R.forEach(s=>{if(!s?.projectId)return;const y=z(s.technicians);if(!y.includes(j))return;const p=String(s.projectId),f=w.get(p),S=h.get(p),{effectiveConfirmed:E}=ne(s,S??f??null);if(f){const N=z(f.technicians),G=Array.from(new Set([...N,...y]));w.set(p,{...f,technicians:G,confirmed:f.confirmed||E});return}if(S){const N=z(S?.technicians),G=Array.from(new Set([...N,...y]));O({...S,technicians:G,confirmed:ne(s,S).effectiveConfirmed},G);return}O({id:p,title:s.projectTitle||s.title||s.project_title||`#${p}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:y,clientId:s.projectClientId??s.customerId??null,confirmed:E,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},y)});const V=Array.from(w.values());I.projectsMap=w,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:w,keys:()=>Array.from(w.keys())}});const W=V.filter(s=>{if(i){const y=$.get(String(s.clientId))?.customerName||"",p=[s.id,s.projectId,s.project_id,s.projectCode,s.project_code,s.reference,s.reference_code,s.code,At(s)];if(!Ct([s.title,s.description,y,p.filter(S=>S!=null&&S!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(i))return!1}if(l&&An(s)!==l)return!1;if(m||g){const y=s.start||s.createdAt||s.created_at||null,p=s.end||s.projectEnd||s.project_end||null,f=y?new Date(y):null,S=p?new Date(p):f;if(m&&f&&f<m||g&&S&&S>g)return!1}return!0}).sort((s,y)=>{const p=new Date(s.start||s.createdAt||0).getTime();return new Date(y.start||y.createdAt||0).getTime()-p});if(!W.length){const s=u("technicianProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العضو.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=W.map(s=>{const y=At(s),p=y?b.get(y)||[]:[],f=$.get(String(s.clientId))||null;return cn(s,{customer:f,techniciansMap:r,reservations:p})}).join(""),hn()}function gn(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const c=String(a);e.has(c)||e.set(c,[]),e.get(c).push(n)}),e}function Et(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!zt())return;const n=I.modal;if(!n?.body)return;const{projects:a=[],reservations:c=[],customers:i=[]}=qt(),l=I.projectsMap?.get(e)||null;let o=l??se(a,e);if(o||(o=se(a,e)),!o)return;const d=String(I.currentId||"");let m=z(o.technicians);if(!m.length&&l&&(m=z(l.technicians),o={...l,...o}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:d,normalizedTechnicians:m}}}),d&&!m.includes(d)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:e,activeTechnicianId:d,normalizedTechnicians:m});return}o={...o,technicians:m};const g=i.find(D=>String(D.id)===String(o.clientId))||null,v=c.filter(D=>{const T=sn(D);return T&&T===e});n.body.dataset.mode="view",n.body.innerHTML=rn(o,{customer:g,reservations:v}),yn(o),bn(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function yn(t){if(!t||!I.modal?.body)return;const e=I.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",n=>{n.preventDefault(),vn(t)})}function bn(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');if(!e.length)return;async function n(a){if(!Number.isInteger(a)||a<0)return!1;const c=Xe("showReservationDetails");if(typeof c=="function")return c(a),!0;try{const i=await Ze("showReservationDetails");if(typeof i=="function")return i(a),!0}catch(i){console.warn("⚠️ [technicianDetails] Unable to resolve reservation UI handler",i)}return!1}e.forEach(a=>{a.dataset.listenerAttached!=="true"&&(a.addEventListener("click",async c=>{c.preventDefault(),c.stopPropagation();const i=Ut();let l=Number.parseInt(a.dataset.index||"",10);if(!Number.isInteger(l)||l<0){const d=a.dataset.reservationId;d&&(l=i.findIndex(g=>[g?.id,g?.reservationId,g?.reservation_id].some(D=>D!=null&&String(D)===d)))}await n(l)||x(u("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),a.dataset.listenerAttached="true")})}function vn(t){if(!t||!zt())return;const e=I.modal;if(!e?.body)return;const{customers:n=[]}=qt(),a=n.find(o=>String(o.id)===String(t.clientId))||null,c=a?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||a?.companyName||a?.company||"",l=Array.isArray(t?.expenses)?t.expenses.map((o,d)=>({id:o?.id||`expense-${t.id}-${d}-${Date.now()}`,label:o?.label||"",amount:Number(o?.amount)||0})):[];e.body.dataset.mode="edit",e.body.innerHTML=on(t,{clientName:c,clientCompany:i}),Dn(t,{clientName:c,clientCompany:i,expenses:l})}function Dn(t,{clientName:e="",clientCompany:n="",expenses:a=[]}={}){const c=I.modal?.body;if(!t||!c)return;const i=c.querySelector("#project-details-edit-form");if(!i)return;const l={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},o=i.querySelector('[data-action="cancel-edit"]');o&&o.addEventListener("click",p=>{p.preventDefault(),Et(t.id)});const d=i.querySelector("#project-edit-expense-label"),m=i.querySelector("#project-edit-expense-amount"),g=i.querySelector('[data-action="add-expense"]'),v=i.querySelector("#project-edit-expense-list"),D=i.querySelector('[name="project-start-date"]'),T=i.querySelector('[name="project-start-time"]'),R=i.querySelector('[name="project-end-date"]'),$=i.querySelector('[name="project-end-time"]'),r=i.querySelector("#project-edit-payment-status"),h=i.querySelector("#project-edit-tax"),b=i.querySelector("#project-edit-company-share"),j=i.querySelector("#project-edit-discount-type"),w=i.querySelector("#project-edit-discount"),O=i.querySelector("#project-edit-payment-progress-type"),V=i.querySelector("#project-edit-payment-progress-value");let W=!1;const s=p=>{!h||!b||W||(W=!0,p==="share"?b.checked?(h.checked||(h.checked=!0),Tt(b,ft)):h.checked&&(h.checked=!1):p==="tax"&&(h.checked?Tt(b,ft):b.checked&&(b.checked=!1)),W=!1)},y=()=>{v&&(v.innerHTML=dn(l.expenses))};y(),g&&!g.dataset.listenerAttached&&(g.addEventListener("click",p=>{p.preventDefault();const f=d?.value.trim()||"",S=A(m?.value||"0"),E=Number(S);if(!f){x(u("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),d?.focus();return}if(!Number.isFinite(E)||E<=0){x(u("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),m?.focus();return}l.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:f,amount:E}),d&&(d.value=""),m&&(m.value=""),y()}),g.dataset.listenerAttached="true"),v&&!v.dataset.listenerAttached&&(v.addEventListener("click",p=>{const f=p.target.closest('[data-action="remove-expense"]');if(!f)return;const{id:S}=f.dataset;l.expenses=l.expenses.filter(E=>String(E.id)!==String(S)),y()}),v.dataset.listenerAttached="true"),w&&!w.dataset.listenerAttached&&(w.addEventListener("input",p=>{const f=p.target;f instanceof HTMLInputElement&&(f.value=A(f.value||""))}),w.dataset.listenerAttached="true"),V&&!V.dataset.listenerAttached&&(V.addEventListener("input",p=>{const f=p.target;f instanceof HTMLInputElement&&(f.value=A(f.value||""))}),V.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{r.dataset.userSelected="true"}),r.dataset.listenerAttached="true"),b&&!b.dataset.listenerAttached&&(b.addEventListener("change",()=>s("share")),b.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("change",()=>s("tax")),h.dataset.listenerAttached="true"),b?.checked&&Tt(b,ft),s(b?.checked?"share":"tax"),i.addEventListener("submit",async p=>{if(p.preventDefault(),i.dataset.submitting==="true")return;const f=i.querySelector('[name="project-title"]'),S=i.querySelector('[name="project-type"]'),E=i.querySelector('[name="project-description"]'),N=f?.value.trim()||"",G=S?.value||"",Yt=D?.value.trim()||"",Pe=T?.value.trim()||"",je=E?.value.trim()||"",Gt=r?.value?.toLowerCase()||"unpaid",Qt=["paid","partial"].includes(Gt)?Gt:"unpaid",ct=h?.checked===!0;if(!N||!G||!Yt){x(u("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),f?.focus();return}const Jt=R?.value.trim()||"",Ne=$?.value.trim()||"",Xt=ie(Yt,Pe),It=Jt?ie(Jt,Ne):"";if(It){const q=new Date(Xt),U=new Date(It);if(!Number.isNaN(q.getTime())&&!Number.isNaN(U.getTime())&&q>U){x(u("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),R?.focus();return}}const pt=At(t);if(!pt){x(u("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const Zt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,Be=l.expenses.reduce((q,U)=>q+(Number(U.amount)||0),0),te=j?.value==="amount"?"amount":"percent",Ce=A(w?.value||"0");let st=Number.parseFloat(Ce);(!Number.isFinite(st)||st<0)&&(st=0);const rt=b?.checked===!0;let ot=rt?We(b):null;(!Number.isFinite(ot)||ot<=0)&&(ot=rt&&ct?ft:null);const lt=Ke({equipmentEstimate:Zt,expensesTotal:Be,discountValue:st,discountType:te,applyTax:ct,companyShareEnabled:rt,companySharePercent:ot}),Me=O?.value==="amount"?"amount":"percent",ee=A(V?.value||""),Re=ee?Number.parseFloat(ee):null,X=Ye({totalAmount:lt.totalWithTax,progressType:Me,progressValue:Re,history:[]}),wt=r?.dataset?.userSelected==="true",_e=Ge({manualStatus:wt?Qt:null,paidAmount:X.paidAmount,paidPercent:X.paidPercent,totalAmount:lt.totalWithTax}),Ft=wt?Qt:_e;!wt&&r&&(r.value=Ft),r?.dataset&&delete r.dataset.userSelected;const $e=tn({projectCode:t.projectCode,title:N,type:G,clientId:t.clientId,clientCompany:l.clientCompany,description:je,start:Xt,end:It||null,applyTax:ct,paymentStatus:Ft,equipmentEstimate:Zt,expenses:l.expenses,discount:st,discountType:te,companyShareEnabled:rt&&ct,companySharePercent:rt&&ct?ot:null,companyShareAmount:lt.companyShareAmount,taxAmount:lt.taxAmount,totalWithTax:lt.totalWithTax,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[],paidAmount:X.paidAmount,paidPercentage:X.paidPercent,paymentProgressType:X.paymentProgressType,paymentProgressValue:X.paymentProgressValue}),_=i.querySelector('button[type="submit"]');_&&(_.disabled=!0,_.dataset.originalText=_.textContent||"",_.textContent=u("projects.details.edit.saving","جاري الحفظ...")),i.dataset.submitting="true";try{const q=await en(pt,$e);await ln(pt,Ft),document.dispatchEvent(new CustomEvent("projects:changed")),x(u("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),C();const U=At(q)||pt;U&&Et(U)}catch(q){console.error("❌ [technicianDetails] Failed to update project from modal",q);const U=typeof q?.message=="string"?q.message:u("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");x(U,"error")}finally{delete i.dataset.submitting,_&&(_.disabled=!1,_.dataset.originalText&&(_.textContent=_.dataset.originalText,delete _.dataset.originalText))}})}function se(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(i=>i!=null&&String(i)===n))||null}function An(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}async function En(t,{signal:e}={}){const n=new URLSearchParams;t&&n.set("technician_id",t);const a=n.toString(),c=await Vt(`/technician-payouts/${a?`?${a}`:""}`,{signal:e});return Array.isArray(c?.data)?c.data:[]}async function Sn({technicianId:t,amount:e,note:n,paidAt:a}){return(await Vt("/technician-payouts/",{method:"POST",body:{technician_id:t,amount:e,note:n,paid_at:a}}))?.data??null}async function In(t){return(await Vt(`/technician-payouts/?id=${encodeURIComponent(t)}`,{method:"DELETE"}))?.data??null}Ve();Ue();Oe();const wn=new URLSearchParams(window.location.search),F=wn.get("id"),H=document.getElementById("technician-details"),re=document.getElementById("technician-hero-name"),Fn=document.getElementById("technician-hero-status"),oe=document.getElementById("technician-hero-role"),Lt=document.getElementById("technician-hero-position"),gt=document.getElementById("dashboard-greeting-technician-name"),dt=document.getElementById("dashboard-greeting-technician-role"),Tn=document.getElementById("dashboard-greeting-technician-status"),le=document.getElementById("dashboard-greeting-technician-role-badge"),de=document.getElementById("sidebar-stat-projects"),ue=document.getElementById("sidebar-stat-reservations"),me=document.getElementById("sidebar-stat-equipment"),he=document.getElementById("sidebar-stat-technicians"),B={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},L=document.getElementById("technician-financial-modal"),yt=document.getElementById("technician-financial-open"),pe=document.getElementById("technician-financial-modal-total"),fe=document.getElementById("technician-financial-modal-paid"),ge=document.getElementById("technician-financial-modal-outstanding"),xt=document.getElementById("technician-financial-modal-empty"),Pt=document.getElementById("technician-financial-modal-table-wrapper"),jt=document.getElementById("technician-financial-modal-rows"),kn=Array.from(document.querySelectorAll("[data-financial-modal-close]")),Z=document.getElementById("technician-payout-form"),k=document.getElementById("technician-payout-amount"),et=document.getElementById("technician-payout-date"),Ln=document.getElementById("technician-payout-note"),J=document.getElementById("technician-payouts-list"),Nt=document.getElementById("technician-payouts-empty"),nt=document.getElementById("technician-payout-confirm-modal"),K=document.getElementById("technician-payout-confirm-yes"),xn=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),Mt=Array.from(document.querySelectorAll("[data-technician-tab]")),Pn=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let Ot="reservations",P=null,Q={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Bt=[],St=null;He();function Wt(){return document.documentElement.getAttribute("lang")||"ar"}function bt(t){const e=Number(t)||0,a=Wt()==="ar"?"ar-SA-u-nu-latn":"en-US";try{return new Intl.NumberFormat(a,{maximumFractionDigits:0}).format(e)}catch{return A(String(e))||"0"}}function ut({projects:t=0,reservations:e=0,equipment:n=0,technicians:a=0}={}){de&&(de.textContent=bt(t)),ue&&(ue.textContent=bt(e)),me&&(me.textContent=bt(n)),he&&(he.textContent=bt(a))}function jn(t){if(!t||typeof t!="object")return 0;const e=[t.quantity,t.qty,t.count];for(const n of e){if(n==null||n==="")continue;const a=Number(A(String(n)));if(Number.isFinite(a))return a>0?a:0}return 1}function Nn(t,e){if(!Array.isArray(t)||!t.length)return{projects:0,reservations:0,equipment:0,technicians:e?1:0};const n=new Set,a=new Set;e&&a.add(String(e));let c=0;return t.forEach(i=>{if(!i)return;i.projectId!=null&&n.add(String(i.projectId)),z(i.technicians).forEach(o=>a.add(o)),Array.isArray(i.items)&&i.items.forEach(o=>{c+=jn(o)})}),{projects:n.size,reservations:t.length,equipment:c,technicians:a.size||(e?1:0)}}function M(t){const e=Number(t)||0,a=Wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const c=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${A(c)} SR`}catch{const i=Math.round(e);return`${A(String(i))} SR`}}function Rt(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const a=Wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),o=e.getFullYear();return`${i}/${l}/${o}`}}function at(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ye(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(A(String(n)));if(Number.isFinite(a))return a}return 0}function Bn(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="technician-payment-badge technician-payment-badge--unpaid";return e==="paid"?(n="technicianFinancial.status.paid",a="technician-payment-badge technician-payment-badge--paid"):e==="partial"&&(n="technicianFinancial.status.partial",a="technician-payment-badge technician-payment-badge--partial"),`<span class="${a}" data-i18n data-i18n-key="${n}">${u(n,n)}</span>`}function be(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),c=Number(n.payoutsCount??0),i=u("technicianFinancial.stats.totalDesc","مرتبطة بـ {count} مهام").replace("{count}",A(String(a))),l=u("technicianFinancial.stats.paidDesc","{count} دفعات مسجلة").replace("{count}",A(String(c))),o=u("technicianFinancial.stats.outstandingDesc","المتبقي {amount}"),d=e.outstanding>0?o.replace("{amount}",M(e.outstanding)):"—";B.total&&(B.total.textContent=M(e.total)),B.totalDesc&&(B.totalDesc.textContent=a>0?i:"—"),B.paid&&(B.paid.textContent=M(e.paid)),B.paidDesc&&(B.paidDesc.textContent=c>0?l:"—"),B.outstanding&&(B.outstanding.textContent=M(e.outstanding)),B.outstandingDesc&&(B.outstandingDesc.textContent=d)}function _t(t){const{totals:e,breakdown:n,payouts:a}=t;if(pe&&(pe.textContent=M(e.total)),fe&&(fe.textContent=M(e.paid)),ge&&(ge.textContent=M(e.outstanding)),!(!jt||!Pt||!xt)){if(!n.length)jt.innerHTML="",Pt.classList.add("hidden"),xt.classList.remove("hidden");else{xt.classList.add("hidden"),Pt.classList.remove("hidden");const c=n.map(i=>{const l=i.period||"—",o=i.outstandingAmount>0?M(i.outstandingAmount):`<span class="text-success">${u("technicianFinancial.list.settled","لا يوجد")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${at(i.label)}</div>
            <div class="text-xs text-base-content/60">${at(i.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${at(l)}</td>
          <td>${M(i.dueAmount)}</td>
          <td>${Bn(i.paidStatus)}</td>
          <td>${o}</td>
        </tr>
      `}).join("");jt.innerHTML=c}Cn(a)}}function Cn(t=[]){if(!J||!Nt)return;if(!Array.isArray(t)||t.length===0){J.innerHTML="",Nt.classList.remove("hidden");return}const e=t.map(n=>{const a=M(n.amount||0),c=Rt(n.paidAt||n.createdAt),i=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${at(n.note)}</p>`:"",l=u("actions.delete","🗑️ حذف");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${at(c)}</span>
          </div>
          ${i}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${at(n.id)}" data-i18n data-i18n-key="actions.delete">${l}</button>
      </li>
    `}).join("");J.innerHTML=e,Nt.classList.add("hidden")}function Te(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function Mn(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function Rn(t){const e=A(String(t??""));if(!e)return"";const c=e.replace(/[٬،]/g,"").replace(/[٫,]/g,".").replace(/[^0-9.]/g,"").split("."),i=c[0]||"",l=c.length>1?c.slice(1).join(""):"",o=i.replace(/^0+(\d)/,"$1"),d=o.length?o:l?"0":"",m=l?l.replace(/\D/g,"").slice(0,2):"";return m?`${d}.${m}`:d}function _n(t){if(t.preventDefault(),!F){x(u("technicianFinancial.payouts.toast.invalidTechnician","⚠️ لا يمكن تحديد عضو الطاقم حالياً."));return}const e=k?.value??"",n=Number.parseFloat(A(String(e)));if(!Number.isFinite(n)||n<=0){x(u("technicianFinancial.payouts.toast.invalidAmount","⚠️ أدخل قيمة صحيحة للمبلغ.")),k?.focus();return}const a=Ln?.value?.trim()||"",c=Mn(et?.value||null),i=Z?.querySelector('button[type="submit"]');i&&(i.disabled=!0),Sn({technicianId:F,amount:Number(n.toFixed(2)),note:a,paidAt:c.toISOString()}).then(l=>{x(u("technicianFinancial.payouts.toast.added","✅ تم تسجيل الدفعة.")),Z?.reset(),et&&(et.value=Te(l?.paidAt||new Date)),P&&ht(P)}).catch(l=>{console.error("❌ [technician-page] Failed to create technician payout",l);const o=l?.message||u("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.");x(o)}).finally(()=>{i&&(i.disabled=!1)})}function $n(t){t&&Vn(t)}function qn(){L&&(L.classList.remove("hidden"),L.classList.add("show"),L.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),et&&!et.value&&(et.value=Te(new Date)))}function Kt(){L&&(L.classList.remove("show"),L.classList.remove("modal-open"),L.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function Vn(t){nt&&(St=t||null,nt.classList.remove("hidden"),nt.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function $t(){nt&&(nt.classList.remove("show","modal-open"),nt.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),St=null,K&&(K.disabled=!1))}function ke(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function Un(t){if(t.preventDefault(),!P)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...P}}))}catch(a){console.error("⚠️ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function Le(){ke().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Un),t.dataset.listenerAttached="true")})}async function ht(t){if(Q={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},be(Q),_t(Q),ut(),!F||!t)return;try{await Ee({suppressError:!0})}catch(r){console.error("⚠️ [technician-page] Failed to load reservations for financial summary",r)}const n=Ut(),a=String(F);try{const r=await En(a);Bt=Array.isArray(r)?r:[]}catch(r){console.error("⚠️ [technician-page] Failed to load technician payouts from API",r),Bt=[]}const c=n.filter(r=>!r||String(r.status||"").toLowerCase()==="cancelled"?!1:(Array.isArray(r.technicians)?r.technicians.map(b=>String(b)):[]).includes(a)),i=Nn(c,a);ut(i);const l=c.map((r,h)=>{const b=Array.isArray(r.techniciansDetails)?r.techniciansDetails.find(E=>{const N=E?.id??E?.technician_id??E?.technicianId??E?.ID;return N!=null&&String(N)===a}):null,j=ye(b)||ye(t),w=Math.max(1,Je(r.start,r.end)),O=Math.max(0,Math.round(j*w)),V=u("technicianFinancial.list.reservationFallback","حجز رقم {id}").replace("{id}",A(String(r.reservationId||r.id||"?"))),W=r.title&&r.title.trim().length?r.title.trim():V,s=[];if(r.reservationId||r.id){const E=r.reservationId||r.id;s.push(`#${A(String(E))}`)}if(r.projectId&&s.push(u("technicianFinancial.list.projectReference","مشروع #{id}").replace("{id}",A(String(r.projectId)))),r.status){const E=`reservations.status.${r.status}`;s.push(u(E,r.status))}const y=Rt(r.start),p=Rt(r.end),f=y===p?y:`${y} – ${p}`,S=(()=>{const E=r.start||r.startDatetime||r.createdAt||r.created_at,N=E?new Date(E).getTime():NaN;return Number.isNaN(N)?h:N})();return{label:W,reference:s.join(" • ")||"—",period:f,dueAmount:O,paidAmount:0,outstandingAmount:O,paidStatus:"unpaid",sortKey:S,originalIndex:h}}),o=Bt.map(r=>({...r,amount:Number(r.amount)||0}));let d=o.reduce((r,h)=>r+h.amount,0);const g=[...l].sort((r,h)=>r.sortKey===h.sortKey?r.originalIndex-h.originalIndex:r.sortKey-h.sortKey).map(r=>{const h={...r},b=Number(r.dueAmount)||0,j=Math.min(b,Math.max(0,Number(d.toFixed(2))));j>0&&(d=Number((d-j).toFixed(2))),h.paidAmount=Number(j.toFixed(2));const w=Math.max(0,Number((b-j).toFixed(2)));return h.outstandingAmount=w,w<=.009?(h.paidStatus="paid",h.outstandingAmount=0):j>0?h.paidStatus="partial":h.paidStatus="unpaid",h}).sort((r,h)=>r.originalIndex-h.originalIndex).map(({sortKey:r,originalIndex:h,...b})=>b),v=g.reduce((r,h)=>r+h.dueAmount,0),D=o.reduce((r,h)=>r+(Number(h.amount)||0),0),T=Math.max(0,Number((v-D).toFixed(2))),R={total:Math.max(0,Number(v.toFixed(2))),paid:Math.max(0,Number(D.toFixed(2))),outstanding:T},$={assignments:g.length,payoutsCount:o.length,outstandingAmount:T};Q={totals:R,metrics:$,breakdown:g,payouts:o},be(Q),_t(Q)}function Y(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const c=n==null?"":String(n).trim(),i=c.length>0;t.textContent=i?`${e} ${c}`:`${e} —`,a?t.classList.toggle("hidden",!i):i||t.classList.remove("hidden")}function ve(t){const e=[Fn,Tn].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(o=>{o.className="technician-badge hidden",o.textContent="—"});return}const a=n==="busy",c=["technician-badge"];c.push(a?"technician-badge--status-busy":"technician-badge--status-available");const i=a?"technicians.status.busy":"technicians.status.available",l=a?"⛔ مشغول":"✅ متاح";if(e.forEach(o=>{o.className=c.join(" "),o.classList.remove("hidden"),o.setAttribute("data-i18n",""),o.setAttribute("data-i18n-key",i),o.textContent=u(i,l)}),Lt)if(a){const o=Hn(F),d=o&&String(o).trim().length?o:"";Y(Lt,"🏷️",d,{hideWhenEmpty:!0})}else Y(Lt,"🏷️","",{hideWhenEmpty:!0})}function Hn(t){try{const e=Ut();if(!Array.isArray(e)||e.length===0)return"";const n=t!=null?String(t):null;if(!n)return"";const a=new Date,c=e.find(d=>{if(!d||!d.start&&!d.startDatetime&&!d.start_datetime)return!1;const m=z(d.technicians);if(!Array.isArray(m)||!m.includes(n))return!1;const g=d.start??d.startDatetime??d.start_datetime,v=d.end??d.endDatetime??d.end_datetime;if(!g||!v)return!1;const D=new Date(g),T=new Date(v);return Number.isNaN(D.getTime())||Number.isNaN(T.getTime())?!1:D<=a&&a<T});if(!c)return"";const l=(Array.isArray(c.crewAssignments)&&c.crewAssignments.length?c.crewAssignments:Array.isArray(c.techniciansDetails)?c.techniciansDetails:[]).find(d=>{const m=d?.id??d?.technicianId??d?.technician_id;return m!=null&&String(m)===n});return l&&(l.positionLabel??l.position_name??l.position_label??l.positionKey??l.position)||""}catch{return""}}function tt(t){if(!t){Y(re,"😎","—"),Y(oe,"🎯","",{hideWhenEmpty:!0}),gt&&(gt.textContent="—"),dt&&(dt.textContent="—"),Y(le,"🎯","",{hideWhenEmpty:!0}),ve(null);return}if(Y(re,"😎",t.name||"—"),Y(oe,"🎯",t.role||"",{hideWhenEmpty:!0}),gt&&(gt.textContent=t.name||"—"),dt){const e=t.role?t.role:"";if(e)dt.textContent=`🎯 ${e}`;else{const n=u("technicianDetails.fallback.role","غير محدد");dt.textContent=`🎯 ${n}`}}Y(le,"🎯",t.role||"",{hideWhenEmpty:!0}),ve(t.status||t.baseStatus||"available")}function mt(t){ke().forEach(e=>{e.disabled=!!t})}function Dt(t){t&&(Ot=t,Mt.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Pn.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&F&&Fe(F),t==="reservations"&&F&&we(F))}function zn(){Mt.length&&(Mt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&Dt(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&Dt(n)}),t.dataset.listenerAttached="true")}),Dt(Ot))}tt(null);mt(!0);zn();Le();yt&&!yt.dataset.listenerAttached&&(yt.addEventListener("click",()=>{_t(Q),qn()}),yt.dataset.listenerAttached="true");kn.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{Kt()}),t.dataset.listenerAttached="true")});Z&&!Z.dataset.listenerAttached&&(Z.addEventListener("submit",_n),Z.dataset.listenerAttached="true");J&&!J.dataset.listenerAttached&&(J.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");$n(n)}),J.dataset.listenerAttached="true");if(k&&!k.dataset.normalizerAttached){const t=()=>{const e=Rn(k.value);if(e!==k.value){const n=e.length;k.value=e,k.setSelectionRange&&k.setSelectionRange(n,n)}};k.addEventListener("input",t),k.addEventListener("blur",()=>{if(t(),k.value){const e=Number.parseFloat(k.value);Number.isFinite(e)&&(k.value=e.toFixed(2))}}),k.dataset.normalizerAttached="true"}xn.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",$t),t.dataset.listenerAttached="true")});K&&!K.dataset.listenerAttached&&(K.addEventListener("click",()=>{if(!St){$t();return}K.disabled=!0,In(St).then(()=>{x(u("technicianFinancial.payouts.toast.removed","🗑️ تم حذف الدفعة.")),$t(),P&&ht(P)}).catch(t=>{console.error("❌ [technician-page] Failed to remove technician payout",t);const e=t?.message||u("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.");x(e),K.disabled=!1})}),K.dataset.listenerAttached="true");L&&!L.dataset.listenerAttached&&(L.addEventListener("click",t=>{t.target===L&&Kt()}),L.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&L&&L.classList.contains("modal-open")&&Kt()});nn({showReservationDetails:an});const vt=document.getElementById("logout-btn");vt&&!vt.dataset.listenerAttached&&(vt.addEventListener("click",()=>ze()),vt.dataset.listenerAttached="true");function On(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function Wn(t){const e=Number(t??0);if(!Number.isFinite(e)||e<=0)return"";const n=u("technicians.badge.perDay","/اليوم");return`${M(e)} ${n}`}function De(t){const e=Number(t??0);return!Number.isFinite(e)||e<=0?"":M(e)}function xe(t){if(!H)return;if(tt(t),!t){H.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${u("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,mt(!0);return}const e=t.phone?A(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${u("reservations.details.technicians.phoneUnknown","غير متوفر")}</span>`,n=t.email?t.email:`<span data-i18n data-i18n-key="technicianDetails.fallback.email">${u("technicianDetails.fallback.email","—")}</span>`,a=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${u("technicianDetails.fallback.role","غير محدد")}</span>`,c=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${u("technicianDetails.fallback.department","—")}</span>`,i=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${u("technicianDetails.fallback.notes","—")}</span>`,o=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${u("reservations.create.summary.currency","SR")}</span>`,d=Wn(t.dailyWage)||`${On(t.dailyWage)} ${o}`,m=De(t.dailyTotal),g=d,v=m||De(t.dailyWage)||d;console.debug("[technician] amounts",{id:t.id,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,wageValue:g,totalValue:v});const T=[{key:"technicianDetails.fields.role",value:a},{key:"technicianDetails.fields.department",value:c},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.email",value:n},{key:"technicianDetails.fields.notes",value:i}].map(({key:R,value:$})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${R}">${u(R)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${$}</p>
    </article>
  `).join("");H.innerHTML=T,Le(),mt(!1),Dt(Ot)}async function Kn(){if(!H)return;if(!F){tt(null),ut(),mt(!0),P=null,H.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${u("technicianDetails.errors.missingId","⚠️ لا يوجد معرف عضو طاقم في الرابط.")}</p>`;return}H.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${u("technicianDetails.status.loading","⏳ جارٍ تحميل بيانات عضو الطاقم...")}</p>`,mt(!0),tt(null);let t=null,e=null;try{await Qe(),Ht()}catch(n){e=n,console.error("❌ [technician-details] Failed to refresh technician from API",n)}if(t=Ae(F),!t){e?H.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${u("technicianDetails.errors.loadFailed","❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.")}</p>`:H.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${u("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,tt(null),ut(),P=null;return}if(!t){H.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${u("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,tt(null),ut(),P=null;return}P=t,await ht(t),xe(t),we(F),Fe(F)}Ht();Kn();const Yn=async()=>{if(!F)return;Ht();const t=Ae(F);t&&(P=t,await ht(t),xe(t))};window.addEventListener("technicians:updated",Yn);const Gn=()=>{!F||!P||ht(P)};document.addEventListener("reservations:changed",Gn,{passive:!0});
