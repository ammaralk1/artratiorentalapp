import{d as Be,n as p,p as hn,t as a,v as ze,y as Ee,w as ga,j as K}from"./auth.BQO8NFzC.js";import{a as Oe,h as _a,k as Ue,c as Ve,e as Ke,d as vn,C as $a,s as B,p as ot,b as Sa,N as ln,g as St,f as Na,z as re,O as Ta,P as gn,u as _n,r as $n}from"./reservationsService.DenHKTLU.js";import{n as Bt,i as ee,j as dn,s as Aa}from"./technicians.DGlCP7NZ.js";import{s as Ca,r as wa}from"./uiBridge.CRKichU6.js";const Pa=new Map([["available","available"],["Ù…ØªØ§Ø­","available"],["Ù…ØªÙˆÙØ±","available"],["Ø¬Ø§Ù‡Ø²","available"],["ready","available"],["reserved","reserved"],["Ù…Ø­Ø¬ÙˆØ²","reserved"],["Ù…Ø­Ø¬ÙˆØ²Ø©","reserved"],["maintenance","maintenance"],["ØµÙŠØ§Ù†Ø©","maintenance"],["under_maintenance","maintenance"],["retired","retired"],["Ù…ØªÙˆÙ‚Ù","retired"],["Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©","retired"]]);function xa(t){const n=String(t??"").trim().toLowerCase();return n&&Pa.get(n)||"available"}function Fa(t){return t?typeof t=="object"?t:Da(t):null}function us(t){const n=Fa(t);return n?xa(n.status||n.state||n.statusLabel||n.status_label):"available"}function ja(t={}){return t.image||t.imageUrl||t.img||""}function ps(t={}){const n=[t.cost,t.unit_cost,t.unitCost,t.rental_cost,t.rentalCost,t.purchase_price,t.purchasePrice];for(const o of n){const s=Number(o);if(Number.isFinite(s))return s}return 0}function ms(t){if(!t)return null;const n=Bt(t),{equipment:o=[]}=Be();return(o||[]).find(s=>Bt(s?.barcode)===n)||null}function Da(t){const n=Bt(t);if(!n)return null;const{equipment:o=[]}=Be();return(o||[]).find(s=>Bt(s?.barcode)===n)||null}const g={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],servicesClientPriceTotal:0,filters:{search:"",status:"",payment:"",type:"",confirmed:"",range:"",startDate:"",endDate:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null,pendingLinkedToast:!1,focusPagination:{page:1,pageSize:6,totalPages:1}},j={};function fs(){g.selectedTechnicians=[],g.selectedEquipment=[],g.expenses=[],g.servicesClientPriceTotal=0}function v(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Nt(t){const n=Number(t)||0,s=hn()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",i=new Intl.NumberFormat(s,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(n));return`${p(i)} SR`}function $t(t){if(!t)return"â€”";const n=new Date(t);if(Number.isNaN(n.getTime()))return"â€”";const o=String(n.getDate()).padStart(2,"0"),s=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getFullYear()),r=String(n.getMinutes()).padStart(2,"0"),c=n.getHours(),d=c>=12?"PM":"AM",u=c%12||12,m=String(u).padStart(2,"0"),f=`${o}/${s}/${i} ${m}:${r} ${d}`;return p(f)}function ka(t){const n=hn(),o=p(String(t));return n==="en"?`${o} ${t===1?"project":"projects"}`:`${o} Ù…Ø´Ø±ÙˆØ¹`}function un(t){j.tableCount&&(j.tableCount.dataset.count=String(t),j.tableCount.textContent=ka(t))}function ys(t){if(!t)return"";const n=t.dataset.emptyKey,o=t.dataset.empty||"";return n?a(n,o):o}const bs="project",hs="editProject",ae=3600*1e3,se=.15,ie=6,vs="projectsTab",gs="projectsSubTab",_s={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab",templates:"projects-templates-tab"},La={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed",cancelled:"Cancelled",conflict:"Conflict"};function Sn(t){if(!t)return"";if(t instanceof Date)return t.toISOString();let n=String(t).trim();return n?(n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T")),n):""}function Nn(t){if(!t?.start)return Number.NaN;const n=Sn(t.start),o=new Date(n).getTime();return Number.isFinite(o)?o:Number.NaN}function Ia(t){if(t?.createdAt){const o=Sn(t.createdAt),s=new Date(o).getTime();if(Number.isFinite(s))return s}const n=Nn(t);return Number.isFinite(n)?n:Number.NEGATIVE_INFINITY}function $s(t,n){if(!t)return"";const o=n&&/\d{1,2}:\d{2}/.test(n)?n:"00:00",[s="00",i="00"]=o.split(":"),r=s.padStart(2,"0"),c=i.padStart(2,"0");return`${t}T${r}:${c}`}function Tn(t,n){const o=String(t||"");return o.length<=n?o:`${o.slice(0,Math.max(0,n-1))}â€¦`}function Ss(t){if(!t||typeof t!="string")return{date:"",time:""};let n=t.trim();if(!n)return{date:"",time:""};if(n.includes(" ")&&(n=n.replace(" ","T")),!n.includes("T"))return{date:n,time:""};const[o,s=""]=n.split("T");return{date:o,time:s}}const Ea=30,Ra=200;let pn=0;function We(){return g.focusPagination||(g.focusPagination={page:1,pageSize:ie,totalPages:1}),(!g.focusPagination.pageSize||g.focusPagination.pageSize<=0)&&(g.focusPagination.pageSize=ie),g.focusPagination}function ce(t){if(!t)return a("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const n={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return a(n,t)}function ne(t){return p(String(t||"")).toLowerCase().trim()}function mn(t,n=!1){if(!t)return null;const o=new Date(`${t}T${n?"23:59:59":"00:00:00"}`);return Number.isNaN(o.getTime())?null:o}function qa(t){try{const n=Je(t.id),o=It(t)||{},s=Number(o.subtotal||0),i=(n||[]).reduce((m,f)=>m+(Number(f?.totalAmount)||oe(f)||0),0),r=o.applyTax?Number(((s+i)*se).toFixed(2)):0,c=Number((s+i+r).toFixed(2)),d=t.paymentHistory||t.payments||[],u=Ve({totalAmount:c,paidAmount:d.length?0:t.paidAmount,paidPercent:d.length?0:t.paidPercent,history:d});return Ke({manualStatus:null,paidAmount:u.paidAmount,paidPercent:u.paidPercent,totalAmount:c})}catch{return null}}function Ma(t){const n=g.customers.find(b=>String(b.id)===String(t.clientId)),o=ne(g.filters.search),s=ne([t.title,t.description,n?.customerName,t.clientCompany,ce(t.type),t.id,t.projectCode].filter(Boolean).join(" "));if(o&&!s.includes(o))return!1;const i=ne(g.filters.type);if(i&&ne(t.type)!==i)return!1;const r=Ge(t),c=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":r;if(g.filters.status&&g.filters.status!==c)return!1;const d=t.confirmed===!0||t.confirmed==="true";if(g.filters.confirmed==="yes"&&!d||g.filters.confirmed==="no"&&d||g.filters.confirmed==="closed"&&c!=="completed")return!1;const u=qa(t);if(g.filters.payment&&(!u||g.filters.payment!==u))return!1;const m=mn(g.filters.startDate),f=mn(g.filters.endDate,!0);if(m||f){const b=t.start?new Date(t.start):null;if(!b||Number.isNaN(b.getTime())||m&&b<m||f&&b>f)return!1}return!0}function An(){return(Array.isArray(g.projects)?g.projects:[]).filter(n=>Ma(n))}function Ha(){if(!j.projectsTableBody)return;const t=An();if(!t.length){const u=g.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",m=g.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",f=v(a(u,m));j.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="6" class="text-center text-muted">${f}</td></tr>`,un(0),g.visibleProjects=[],yn([]),Wa();return}const n=[...t].sort((u,m)=>{const f=fn(u);return fn(m)-f});g.visibleProjects=n,un(n.length);const o=We(),s=o.pageSize||ie,i=Math.max(1,Math.ceil(n.length/s));o.totalPages=i,o.page=Math.min(Math.max(1,o.page||1),i);const r=(o.page-1)*s,c=r+s,d=n.slice(r,c);za(d),yn(d),Cn(d,{totalPagesOverride:i,currentPageOverride:o.page,prePaged:!0}),qe(i,o.page)}function fn(t){const n=Ia(t);if(Number.isFinite(n))return n;const o=Number(t?.id);if(Number.isFinite(o))return o;const s=Nn(t);return Number.isFinite(s)?s:Number.NEGATIVE_INFINITY}function Ba(t){if(typeof window<"u"&&typeof window.requestIdleCallback=="function"){window.requestIdleCallback(t,{timeout:120});return}setTimeout(t,0)}function za(t){if(!j.projectsTableBody)return;const n=++pn;j.projectsTableBody.innerHTML="";const o=(s=0)=>{if(n!==pn)return;const i=Math.min(t.length,s+Ea),r=document.createDocumentFragment();for(let c=s;c<i;c+=1){const d=Oa(t[c]),u=document.createElement("tbody");for(u.innerHTML=d;u.firstChild;)r.appendChild(u.firstChild)}j.projectsTableBody.appendChild(r),i<t.length&&Ba(()=>o(i))};o(0)}function Oa(t){const o=g.customers.find($=>String($.id)===String(t.clientId))?.customerName||a("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),s=["commercial","coverage","photography","social"].includes(t.type)?t.type:"default",{expensesTotal:i,totalWithTax:r}=It(t),c=v(ce(t.type)),d=`<span class="project-type-chip project-type-chip--${s}">${c}</span>`,u=t.projectCode||`PRJ-${p(String(t.id))}`,m=`<span class="project-code-badge">#${v(u)}</span>`,b=ze()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${v(a("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${v(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${m}
            ${d}
          </div>
        </div>
      </td>
      <td>
        ${v(o)}
      </td>
      <td>${Ua(t.start,t.end)}</td>
      <td>${Nt(r)}</td>
      <td>${Nt(i)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${v(a("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${b}
      </td>
    </tr>
  `}function Ua(t,n){if(!t)return"â€”";const o=$t(t),s=n?$t(n):"",i=u=>{const m=String(u).split(" ").filter(Boolean),f=m.shift()||"",b=m.join(" ");return{date:f,time:b}},r=i(o),c=s?i(s):{date:"",time:""};if(c.date&&r.date===c.date){const u=r.time&&c.time?`Ù…Ù† ${r.time} Ø¥Ù„Ù‰ ${c.time}`:"";return`
      <div class="date-range">
        <div class="date-line">${r.date}</div>
        ${u?`<div class="time-line">${u}</div>`:""}
      </div>
    `}const d=r.time&&c.time?`Ù…Ù† ${r.time} Ø¥Ù„Ù‰ ${c.time}`:"";return`
    <div class="date-range">
      <div class="date-line">${r.date}</div>
      ${c.date?`<div class="date-line">${c.date}</div>`:""}
      ${d?`<div class="time-line">${d}</div>`:""}
    </div>
  `}function Va(t,n){if(!t)return{dateHtml:"â€”",timeText:""};const o=$t(t),s=n?$t(n):"",i=m=>{const f=String(m).split(" ").filter(Boolean),b=f.shift()||"",$=f.join(" ");return{date:b,time:$}},r=i(o),c=s?i(s):{date:"",time:""};let d="",u="";return c.date&&r.date===c.date?(d=`<div class="date-range"><div class="date-line">${r.date}</div></div>`,u=`Ù…Ù† ${r.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${c.time||"â€”:â€”"}`):(d=`<div class="date-range"><div class="date-line">${r.date}</div>`+(c.date?`<div class="date-line">${c.date}</div>`:"")+"</div>",u=`Ù…Ù† ${r.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${c.time||"â€”:â€”"}`),{dateHtml:d,timeText:u}}function yn(t){if(!j.timeline)return;const o=(Array.isArray(t)?t:g.visibleProjects.length?g.visibleProjects:g.projects).slice(0,Ra).map(b=>{if(!b?.start)return null;const $=new Date(b.start);if(Number.isNaN($.getTime()))return null;let S=b.end?new Date(b.end):new Date($);return Number.isNaN(S.getTime())&&(S=new Date($)),S<=$&&(S=new Date($.getTime()+ae)),{project:b,startDate:$,endDate:S}}).filter(Boolean).sort((b,$)=>b.startDate-$.startDate);if(!o.length){const b=v(a("projects.timeline.empty",j.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));j.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${b}</div>`;return}const s=o[0].startDate.getTime(),i=Math.max(...o.map(b=>b.endDate.getTime()));let r=i-s;r<=0&&(r=ae);const c=Ka(o),d=a("projects.timeline.range","{start} â†’ {end}"),u=a("projects.timeline.conflict","Scheduling conflict"),m=o.map(b=>{const{project:$,startDate:S,endDate:L}=b,W=L.getTime()-S.getTime();let O=(S.getTime()-s)/r*100;O=Math.max(0,Math.min(O,100));let J=W/r*100;J=Math.max(J,2.5),O+J>100&&(J=Math.max(1.5,100-O));const V=`project-timeline__item--${Ge($)}`,bt=c.has($.id),M=($.title||"").trim()||a("projects.fallback.untitled","Untitled project"),Tt=Tn(M,26),ct=g.customers.find(Q=>String(Q.id)===String($.clientId)),lt=ct?.customerName||a("projects.fallback.unknownClient","Unknown client"),ht=($.clientCompany||ct?.companyName||"").trim(),Et=ce($.type),At=$t(S.toISOString()),Ct=$t(L.toISOString()),Ot=d.replace("{start}",At).replace("{end}",Ct),Dt=ht?`${lt} (${ht})`:lt,tt=`${M} â€¢ ${Et} â€¢ ${Dt} | ${Ot}`,le=bt?`<span class="project-timeline__item-conflict" title="${v(u)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${V}${bt?" project-timeline__item--conflict":""}" style="left:${O}%;width:${J}%;" title="${v(tt)}">
          <span class="project-timeline__item-label">${v(Tt)}</span>
          ${le}
        </div>
      `}).join(""),f=`
    <div class="project-timeline__scale">
      <span>${v($t(new Date(s).toISOString()))}</span>
      <span>${v($t(new Date(i).toISOString()))}</span>
    </div>
  `;j.timeline.innerHTML=`
    ${f}
    <div class="project-timeline__track">
      ${m}
    </div>
  `}function Ka(t){const n=new Set;for(let o=0;o<t.length;o+=1)for(let s=o+1;s<t.length;s+=1){const i=t[o],r=t[s];i.startDate<r.endDate&&r.startDate<i.endDate&&(n.add(i.project.id),n.add(r.project.id))}return n}function Wa(){Cn()}function Cn(t=null,{totalPagesOverride:n=null,currentPageOverride:o=null,prePaged:s=!1}={}){if(!j.focusCards)return;const i=Array.isArray(t)?t:g.visibleProjects.length?g.visibleProjects:An(),r=We(),c=Number.isFinite(r.pageSize)?r.pageSize:ie,d=n??Math.max(1,Math.ceil(i.length/c)),u=o??Math.min(Math.max(1,r.page||1),d);r.page=u,r.totalPages=d;const m=s?i:i.slice((u-1)*c,u*c);if(!m.length){const f=v(a("projects.focus.empty",j.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));j.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${f}</div></div>`,qe(1,1);return}j.focusCards.innerHTML=m.map(f=>Ga(f,"list")).join(""),qe(d,u)}function qe(t,n){const o=[j.focusPagination,j.tablePagination].filter(Boolean);if(!o.length)return;const s=Math.max(1,t),i=Math.min(Math.max(1,n||1),s),r=[],c=5;let d=Math.max(1,i-2),u=Math.min(s,d+c-1);u-d+1<c&&d>1&&(d=Math.max(1,u-c+1));for(let f=d;f<=u;f+=1)r.push(f);const m=`
    <button type="button" class="btn btn-sm btn-outline-primary" data-page="${i-1}" ${i===1?"disabled":""} aria-label="${v(a("projects.pagination.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"))}">â€¹</button>
    ${r.map(f=>`<button type="button" class="${f===i?"btn btn-sm btn-primary active":"btn btn-sm btn-outline-primary"}" data-page="${f}">${f}</button>`).join("")}
    <button type="button" class="btn btn-sm btn-outline-primary" data-page="${i+1}" ${i===s?"disabled":""} aria-label="${v(a("projects.pagination.next","Ø§Ù„ØªØ§Ù„ÙŠ"))}">â€º</button>
  `;o.forEach(f=>{f.innerHTML=`<div class="btn-group" role="group" aria-label="Projects pagination">${m}</div>`,f.onclick=b=>{const $=b.target instanceof HTMLElement?b.target.closest("button[data-page]"):null;if(!$||$.disabled)return;const S=Number.parseInt($.dataset.page||"0",10);if(!Number.isInteger(S)||S<1||S>s||S===i)return;const L=We();L.page=S,Ha()}})}function Ga(t,n){const o=g.customers.find(w=>String(w.id)===String(t.clientId)),s=o?.customerName||a("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");(t.clientCompany||o?.companyName||"").trim();const i=Array.isArray(t.technicians)?t.technicians.length:0,r=Je(t.id),c=r.length;wn(t);const d=Number(t?.servicesClientPrice??0),{applyTax:u}=It(t),m=(t.description||"").trim(),f=m?Tn(m,110):a("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),b=ce(t.type),$=It(t)||{},S=Number($.subtotal||0),L=(r||[]).reduce((w,h)=>w+(Number(h?.totalAmount)||oe(h)||0),0),W=$.applyTax?Number(((S+L)*se).toFixed(2)):0,O=Number((S+L+W).toFixed(2)),J=t.paymentHistory||t.payments||[],yt=Ve({totalAmount:O,paidAmount:J.length?0:t.paidAmount,paidPercent:J.length?0:t.paidPercent,history:J}),V=Ke({manualStatus:null,paidAmount:yt.paidAmount,paidPercent:yt.paidPercent,totalAmount:O}),bt=a(`projects.paymentStatus.${V}`,V==="paid"?"Paid":V==="partial"?"Partially Paid":"Unpaid"),M=V==="paid"?"status-paid":V==="partial"?"status-partial":"status-unpaid",Tt=V==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",ct=t.confirmed===!0||t.confirmed==="true",lt=v(String(t.id)),ht=t.projectCode||`PRJ-${p(String(t.id))}`,Et=p(ht);try{const h=(new URL(window.location.href).searchParams.get("paymentDebug")||"").toLowerCase();(h==="1"||h==="true"||h==="yes")&&console.debug("[PaymentDebug][card]",{projectId:t?.id,projectTaxableBase:S,combinedReservationsTotal:L,combinedTax:W,combinedTotalWithTax:O,paidAmount:yt.paidAmount,paidPercent:yt.paidPercent,paymentStatus:V})}catch{}const At={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},Ct={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},Ot=At[n]||At.recent;a(Ot,Ct[n]||Ct.recent);const Dt=Ge(t),tt=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":Dt;a(`projects.status.${tt}`,La[tt]||tt);const Q=(()=>{try{const w=t.start?new Date(t.start):null,h=t.end?new Date(t.end):w?new Date(w.getTime()+ae):null;return!w||!h||Number.isNaN(w.getTime())||Number.isNaN(h.getTime())?!1:g.projects.some(U=>{if(!U||String(U.id)===String(t.id))return!1;const X=U.start?new Date(U.start):null,Z=U.end?new Date(U.end):X?new Date(X.getTime()+ae):null;if(!X||!Z||Number.isNaN(X.getTime())||Number.isNaN(Z.getTime()))return!1;const gt=Math.max(w.getTime(),X.getTime()),qt=Math.min(h.getTime(),Z.getTime());return gt<qt})}catch{return!1}})()&&(tt==="upcoming"||tt==="ongoing")?"conflict":tt,de=Q==="upcoming"?"timeline-status-badge timeline-status-badge--upcoming":Q==="ongoing"?"timeline-status-badge timeline-status-badge--ongoing":Q==="completed"?"timeline-status-badge timeline-status-badge--completed":Q==="cancelled"?"timeline-status-badge timeline-status-badge--cancelled":"timeline-status-badge timeline-status-badge--conflict",Y=(t.title||"").trim()||a("projects.fallback.untitled","Untitled project"),wt=Q==="cancelled"?[]:[Tt];Q==="cancelled"?wt.push("project-focus-card--cancelled"):ct&&wt.push("project-focus-card--confirmed");const Pt=r.reduce((w,h)=>{const U=Array.isArray(h.items)?h.items:[],X=Array.isArray(h.crewAssignments)?h.crewAssignments:[],Z=X.length?X:Array.isArray(h.technicians)?h.technicians:[],gt=vn({items:U,technicianIds:Array.isArray(Z)&&!Z.length?Z:[],crewAssignments:Array.isArray(Z)&&Z.length&&typeof Z[0]=="object"?Z:[],discount:h.discount??0,discountType:h.discountType||"percent",applyTax:!1,start:h.start,end:h.end,companySharePercent:null}),qt=oe(h),we=(()=>{try{const{groups:Yt}=Ue(h);return(Yt||[]).reduce((Mt,pt)=>{if(String(pt?.type||"").toLowerCase()==="package"){const xe=Array.isArray(pt?.packageItems)?pt.packageItems:[],Fe=new Set(xe.map(Ht=>(Ht?.normalizedBarcode||Ht?.barcode||Ht?.equipmentId||"").toString()));return Mt+Fe.size}const Xt=Number.isFinite(Number(pt?.count))?Number(pt.count):Number.isFinite(Number(pt?.quantity))?Number(pt.quantity):1;return Mt+(Xt>0?Xt:1)},0)}catch{return(Array.isArray(h?.items)?h.items:[]).length||0}})(),Pe=(h.technicians||[]).length;return{netTotal:w.netTotal+qt,equipmentMoney:w.equipmentMoney+Number(gt.equipmentTotal||0),crewMoney:w.crewMoney+Number(gt.crewTotal||0),equipmentCount:w.equipmentCount+we,crewCount:w.crewCount+Pe}},{netTotal:0,equipmentMoney:0,crewMoney:0,equipmentCount:0,crewCount:0}),Ut=Number(Pt.netTotal.toFixed(2)),ue=Pt.equipmentCount,Rt=Pt.crewCount||i,pe=Number(d||0),vt=Number((Pt.equipmentMoney+Pt.crewMoney+pe).toFixed(2)),kt=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let xt=(t?.discountType==="amount"?"amount":"percent")==="amount"?kt:vt*(kt/100);(!Number.isFinite(xt)||xt<0)&&(xt=0),xt>vt&&(xt=vt);const et=Math.max(0,vt-xt),Kt=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",Wt=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,Gt=Kt&&u&&Wt>0?Wt:0,Jt=Number((et*(Gt/100)).toFixed(2)),me=u?Number(((et+Jt)*se).toFixed(2)):0,fe=Number((et+Jt+me).toFixed(2)),ye=`<span class="project-code-badge project-focus-card__code">#${v(Et)}</span>`,be="",he="",ve=a(`projects.status.${Q}`,Q),ge=`<span class="${de}">${v(ve)}</span>`,_e=`<span class="reservation-chip ${M} project-focus-card__payment-chip">${v(bt)}</span>`,x=(w,h,U)=>{const X=String(U||""),gt=X.trim().startsWith("<");return`
      <div class="project-focus-card__row">
        <span class="project-focus-card__row-label">
          ${w?`<span class="project-focus-card__row-icon">${v(w)}</span>`:""}
          ${v(h)}
        </span>
        <span class="project-focus-card__row-value">${gt?X:v(X)}</span>
      </div>
    `},{dateHtml:$e,timeText:Qt}=Va(t.start,t.end),Se=[{icon:"ğŸ‘¤",label:a("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:s},{icon:"ğŸ·ï¸",label:a("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`<span class="project-type-chip project-type-chip--${t.type||"default"}">${v(b)}</span>`},{icon:"ğŸ“…",label:a("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:$e},Qt?{icon:"â°",label:a("projects.focus.summary.time","Ø§Ù„ÙˆÙ‚Øª"),value:Qt}:null].filter(Boolean).map(({icon:w,label:h,value:U})=>x(w,h,U)).join(""),Ne=Gt>0&&u?` ${a("projects.details.chips.vatOn","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)")}`:"",Te=`${a("projects.details.summary.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")}${Ne}`,Ae=[{icon:"ğŸ’¼",label:a("projectCards.stats.servicesClientPrice","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"),value:Nt(d)},{icon:"ğŸ’µ",label:Te,value:Nt(fe)}].map(({icon:w,label:h,value:U})=>x(w,h,U)).join(""),Ce=[{icon:"ğŸ”—",label:a("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:p(String(c))},{icon:"ğŸ“¦",label:a("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:p(String(ue))},{icon:"ğŸ˜",label:a("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:p(String(Rt))},{icon:"ğŸ’µ",label:a("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:Nt(Ut)}].map(({icon:w,label:h,value:U})=>x(w,h,U)).join("");let Ft="";return Q==="cancelled"?Ft=`<span class="reservation-chip status-cancelled project-focus-card__confirm-indicator">${v(a("projects.focus.cancelled","Ù…Ø´Ø±ÙˆØ¹ Ù…Ù„ØºÙŠ"))}</span>`:ct?Q!=="completed"?Ft=`<button class="btn btn-sm btn-warning project-focus-card__confirm-btn" data-action="close-project" data-id="${lt}">${v(a("projects.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`:Ft=`<span class="reservation-chip status-completed project-focus-card__confirm-indicator">${v(a("projects.tag.closed","Ù…ØºÙ„Ù‚"))}</span>`:Ft=`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${lt}">${v(a("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`,`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${[...wt,Q==="completed"?"project-focus-card--completed":""].filter(Boolean).join(" ")}" data-project-id="${lt}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${ye}
          ${be}
          ${he}
          ${ge}
          ${_e}
        </div>
        <h6 class="project-focus-card__title">${v(Y)}</h6>
        <p class="project-focus-card__description">${v(f)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${v(a("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${Se}
            </div>
          </div>
          <!-- Show reservations above the financial summary -->
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${v(a("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${Ce}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${v(a("projects.focus.summary.payment","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${Ae}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${Ft}
        </div>
      </article>
    </div>
  `}function Ge(t){const n=typeof t?.status=="string"?t.status.trim().toLowerCase():null,o=new Date,s=t.start?new Date(t.start):null,i=t.end?new Date(t.end):null;if(n&&(n==="cancelled"||n==="canceled"||n==="Ù…Ù„ØºÙŠ"||n==="Ù…Ù„ØºÙ‰"))return"cancelled";if(i&&!Number.isNaN(i.getTime())&&i<o)return"completed";if(n){if(n==="completed"||n==="Ù…ÙƒØªÙ…Ù„"||n==="Ù…ØºÙ„Ù‚")return"completed";if(n==="ongoing"||n==="in_progress"||n==="in-progress"||n==="Ø¬Ø§Ø±ÙŠ"||n==="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°")return"ongoing";if(n==="upcoming"||n==="Ù‚Ø§Ø¯Ù…")return"upcoming"}return s&&!Number.isNaN(s.getTime())&&s>o?"upcoming":"ongoing"}function wn(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((n,o)=>n+(Number(o.amount)||0),0):0}function It(t){const n=Number(t?.equipmentEstimate)||0,o=wn(t),s=n+o,i=t?.applyTax===!0||t?.applyTax==="true",r=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let d=(t?.discountType==="amount"?"amount":"percent")==="amount"?r:s*(r/100);(!Number.isFinite(d)||d<0)&&(d=0),d>s&&(d=s);const u=Math.max(0,s-d),m=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",f=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,b=i||m&&f>0,$=m&&b&&f>0?f:0,S=$>0?Number((u*($/100)).toFixed(2)):0,L=u+S;let W=b?L*se:0;(!Number.isFinite(W)||W<0)&&(W=0),W=Number(W.toFixed(2));let O=b?Number(t?.totalWithTax):L;return b?(!Number.isFinite(O)||O<=0)&&(O=Number((L+W).toFixed(2))):O=L,{equipmentEstimate:n,expensesTotal:o,baseSubtotal:s,discountAmount:d,subtotalAfterDiscount:u,companyShareAmount:S,subtotal:L,applyTax:b,taxAmount:W,totalWithTax:O}}function Ns(){const t=g.projects.length,n=g.projects.filter(i=>{const r=i.start?new Date(i.start):null;return!r||Number.isNaN(r.getTime())?!1:r>new Date}).length,o=g.projects.reduce((i,r)=>i+It(r).expensesTotal,0),s=g.projects.reduce((i,r)=>i+It(r).totalWithTax,0);j.projectsCount&&(j.projectsCount.textContent=p(String(t))),j.projectsUpcoming&&(j.projectsUpcoming.textContent=p(String(n))),j.projectsExpenses&&(j.projectsExpenses.textContent=Nt(o)),j.projectsBudget&&(j.projectsBudget.textContent=Nt(s))}function Je(t){return t?g.reservations.filter(n=>{const o=n?.projectId??n?.project_id??null;return o!=null&&String(o)===String(t)}):[]}function oe(t){if(!t)return 0;const n=Array.isArray(t.items)?t.items:[],o=t.discount??0,s=Number(p(String(o)))||0,i=t.discountType||"percent",r=Array.isArray(t.crewAssignments)?t.crewAssignments:[],c=r.length?r:Array.isArray(t.technicians)?t.technicians:[],d=_a(n,s,i,!1,c,{start:t.start,end:t.end,companySharePercent:0});if(Number.isFinite(d))return d;const u=Number(p(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Ja(t){try{const{groups:n}=Ue(t);return(n||[]).reduce((o,s)=>{if(String(s?.type||"").toLowerCase()==="package"){const c=Array.isArray(s?.packageItems)?s.packageItems:[],d=new Set(c.map(u=>(u?.normalizedBarcode||u?.barcode||u?.equipmentId||"").toString()));return o+d.size}const r=Number.isFinite(Number(s?.count))?Number(s.count):Number.isFinite(Number(s?.quantity))?Number(s.quantity):1;return o+(r>0?r:1)},0)}catch{return(Array.isArray(t?.items)?t.items:[]).length||0}}function Qa(t,n,o=null){if(!t)return"";const s=t.reservationId||t.id||`RES-${n+1}`,i=t.status||t.state||"pending",r=String(i).toLowerCase(),{effectiveConfirmed:c}=Oe(t,o),d=c?"confirmed":r,u=a(`reservations.list.status.${d}`,d==="confirmed"?"âœ… Ù…Ø¤ÙƒØ¯":d==="pending"?"â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯":d),f={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[d]||"project-reservation-card__badge--info",b=typeof o?.paymentStatus=="string"?o.paymentStatus.toLowerCase():null,$=b&&["paid","partial","unpaid"].includes(b)?b:String(t.paidStatus||t.paymentStatus||(t.paid?"paid":"unpaid")).toLowerCase(),S=$==="paid"?"paid":$==="partial"?"partial":"unpaid",L=S==="paid"?a("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"):S==="partial"?a("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"):a("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),W=S==="paid"?"project-reservation-card__badge--paid":S==="partial"?"project-reservation-card__badge--partial":"project-reservation-card__badge--unpaid",O=t.completed===!0||t.completed==="true",J=a("reservations.details.completed","Ù…ØºÙ„Ù‚"),yt=O?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${v(J)}</span>`:"",V=oe(t),bt=Nt(V),M=Ja(t),Tt=(t.technicians||[]).length,ct=a("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),lt=a("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ht=a("projectCards.stats.reservationTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${n}" data-reservation-index="${n}" data-project-id="${o?o.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${v(s)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${f}">${v(u)}</span>
          <span class="project-reservation-card__badge ${W}">${v(L)}</span>
          ${yt}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__meta project-reservation-card__meta--vertical">
          <span>ğŸ˜ ${v(ct)}: ${p(String(Tt))}</span>
          <span>ğŸ“¦ ${v(lt)}: ${p(String(M))}</span>
          <span>ğŸ’µ ${v(ht)}: ${v(bt)}</span>
        </div>
      </div>
    </article>
  `}function Ts(t){const n=Je(t.id).map(r=>{const c=r?.id??r?.reservationId??r?.reservation_code??r?.reservation_id,d=g.reservations.findIndex(u=>{const m=u?.id??u?.reservationId??u?.reservation_code??u?.reservation_id;return c!=null&&m!=null&&String(m)===String(c)});return{reservation:r,index:d}}).filter(({index:r})=>Number.isInteger(r)&&r>=0).sort((r,c)=>{const d=r.reservation.start?new Date(r.reservation.start).getTime():0;return(c.reservation.start?new Date(c.reservation.start).getTime():0)-d}),o=a("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),s=a("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),i=n.length?`<div class="project-reservations-list">${n.map(({reservation:r,index:c})=>Qa(r,c,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${v(s)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${v(o)}</h6>
      </div>
      ${i}
    </section>
  `}function z(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Re(t){if(t==null)return"";const n=String(t).trim();return n?p(n):""}function As(t,n,o=[],s,i=null){const{projectLinked:r,effectiveConfirmed:c}=Oe(t,i);t.paid===!0||t.paid;const d=$a(t),u=t.items||[];let{groups:m}=Ue(t);const f=e=>!!(e&&typeof e=="object"&&(e.type==="package"||Array.isArray(e.packageItems)&&e.packageItems.length||Array.isArray(e.items)&&e.items.some(l=>l&&l.type==="package"))),b=e=>{const l=(e?.package_code??e?.packageDisplayCode??e?.barcode??e?.description??(Array.isArray(e?.items)&&e.items[0]?.barcode)??"").toString().trim().toLowerCase();return p(l)},$=(e,l)=>{const N=I=>{const H=Array.isArray(I?.items)?I.items[0]:null,D=[H?.price,H?.unit_price,H?.unitPrice,I?.unitPrice,I?.totalPrice];for(const st of D){const _=ot(st);if(Number.isFinite(_)&&_>0)return _}return 0},F=N(e),R=N(l);return F&&R?F<=R?e:l:F?e:l},S=[],L=new Map;m.forEach(e=>{if(!f(e)){S.push(e);return}const l=b(e);if(!l){if(!L.has("__unknown__"))L.set("__unknown__",S.length),S.push(e);else{const N=L.get("__unknown__");S[N]=$(S[N],e)}return}if(!L.has(l))L.set(l,S.length),S.push(e);else{const N=L.get(l);S[N]=$(S[N],e)}}),m=S;const{technicians:W=[]}=Be(),O=[].concat(Array.isArray(o)?o:[]).concat(Array.isArray(W)?W:[]),J=new Map;O.forEach(e=>{if(!e||e.id==null)return;const l=String(e.id),N=J.get(l)||{};J.set(l,{...N,...e})});const V=(Array.isArray(t.crewAssignments)&&t.crewAssignments.length?t.crewAssignments:Array.isArray(t.techniciansDetails)&&t.techniciansDetails.length?t.techniciansDetails:(t.technicians||[]).map(e=>({technicianId:e}))).map((e,l)=>{const N=e?.technicianId!=null?J.get(String(e.technicianId)):null;let F=e.positionLabel??e.position_name??e.position_label??e.role??e.position??"";(!F||F.trim()==="")&&(F=e.positionLabelAr??e.position_label_ar??e.positionLabelEn??e.position_label_en??e.position_name_ar??e.position_name_en??"");const R=e.positionLabelAlt??e.position_label_alt??e.positionLabelEn??e.position_label_en??e.positionLabelAr??e.position_label_ar??"";let I=F,H=R;if(!I||I.trim()==="")try{const _=ee?ee():[];let y=null;if(e.positionId!=null&&(y=_.find(A=>String(A.id)===String(e.positionId))||null),!y){const A=e.positionKey??e.position_key??e.positionName??e.position_name??e.position??"";if(A&&(y=typeof dn=="function"?dn(A):null,!y&&_.length)){const P=String(A).trim().toLowerCase();y=_.find(nt=>[nt.name,nt.labelAr,nt.labelEn].filter(Boolean).map(E=>String(E).toLowerCase()).includes(P))||null}}y&&(I=y.labelAr||y.labelEn||y.name||"",(!H||String(H).trim()==="")&&(y.labelAr&&y.labelEn?H=I===y.labelAr?y.labelEn:y.labelAr:H=y.labelAr||y.labelEn||""))}catch{}const D=B(ot(e.positionCost??e.position_cost??e.cost??e.daily_wage??e.dailyWage??N?.dailyWage??N?.wage??0)),st=B(ot(e.positionClientPrice??e.position_client_price??e.client_price??e.clientPrice??e.daily_total??e.dailyTotal??e.total??N?.dailyTotal??N?.total??N?.total_wage??0));return{assignmentId:e.assignmentId??e.assignment_id??`crew-${l}`,positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_key??e.positionName??e.position_name??e.position??null,positionLabel:I,positionLabelAlt:H,positionLabelAr:e.positionLabelAr??e.position_label_ar??null,positionLabelEn:e.positionLabelEn??e.position_label_en??null,positionCost:D,positionClientPrice:st,technicianId:e.technicianId!=null?String(e.technicianId):N?.id!=null?String(N.id):null,technicianName:e.technicianName??e.technician_name??N?.name??null,technicianRole:e.technicianRole??N?.role??null,technicianPhone:e.technicianPhone??N?.phone??null,notes:e.notes??null}}),bt=ze(),M=Sa(t.start,t.end),Tt=t.discount??t.discountValue??t.discount_value??t.discountAmount??0,ct=ot(Tt),lt=Number.isFinite(ct)?ct:0,ht=t.discountType??t.discount_type??t.discountMode??"percent",Et=String(ht).toLowerCase()==="amount"?"amount":"percent",At=!!(t.applyTax??t.apply_tax??t.taxApplied),Ct=ot(t.cost??t.total??t.finalTotal);Number.isFinite(Ct)&&B(Ct);const Dt=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share,tt=Dt!=null?ot(Dt):Number.NaN,de=((t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied)===!0||Number.isFinite(tt)&&tt>0)&&Number.isFinite(tt)?tt:0,Y=vn({items:u,technicianIds:t.technicians||[],crewAssignments:V,discount:lt,discountType:Et,applyTax:At,start:t.start,end:t.end,companySharePercent:de,groupingSource:t}),wt=B(Y.equipmentTotal),Pt=B(Y.equipmentCostTotal),Ut=B(Y.crewTotal),ue=B(Y.crewCostTotal),Rt=B(Y.discountAmount),pe=B(Y.subtotalAfterDiscount),vt=Number.isFinite(Y.companySharePercent)?Y.companySharePercent:0;let kt=B(Y.companyShareAmount);kt=vt>0?B(Math.max(0,kt)):0;const Vt=B(Y.taxAmount),et=B(Y.finalTotal),Kt=B(Y.netProfit),Wt=p(String(t.reservationId??t.id??"")),Gt=t.start?p(Ee(t.start)):"-",Jt=t.end?p(Ee(t.end)):"-",me=p(String(V.length)),fe=p(wt.toFixed(2)),ye=p(Pt.toFixed(2)),be=p(Rt.toFixed(2)),he=p(pe.toFixed(2)),ve=p(Vt.toFixed(2)),ge=p((Number.isFinite(et)?et:0).toFixed(2)),_e=p(String(M)),x=a("reservations.create.summary.currency","SR"),$e=a("reservations.details.labels.discount","Ø§Ù„Ø®ØµÙ…"),Qt=a("reservations.details.labels.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)"),Se=a("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),Ne=a("reservations.details.labels.subtotalAfterDiscount","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"),Te=a("reservations.details.labels.duration","Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),Ae=a("reservations.details.labels.companyShare","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),Ce=a("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),Ft=a("reservations.details.labels.equipmentCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),w=a("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),h={item:a("reservations.equipment.table.item","Ø§Ù„Ù…Ø¹Ø¯Ø©"),quantity:a("reservations.equipment.table.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),unitPrice:a("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©"),unitCost:a("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©"),total:a("reservations.equipment.table.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"),actions:a("reservations.equipment.table.actions","Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª")},U=a("reservations.details.noItems","ğŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø­Ø§Ù„ÙŠØ§Ù‹."),X=a("reservations.details.noCrew","ğŸ˜ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø².");a("reservations.details.technicians.roleUnknown","ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const Z=a("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±");a("reservations.details.technicians.wage","{amount} {currency} / Ø§Ù„ÙŠÙˆÙ…");const gt=a("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),qt=a("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),we=a("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),Pe=a("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),Yt=a("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),Mt=a("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),pt=a("reservations.details.labels.id","ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"),Qe=a("reservations.details.section.bookingInfo","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"),Xt=a("reservations.details.section.paymentSummary","Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹"),xe=a("reservations.details.labels.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),Fe=a("reservations.details.section.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ"),Ht=a("reservations.details.crew.count","{count} Ø¹Ø¶Ùˆ"),Pn=a("reservations.details.section.items","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),xn=a("reservations.details.items.count","{count} Ø¹Ù†ØµØ±"),Fn=a("reservations.details.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),jn=a("reservations.details.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),Dn=a("reservations.details.labels.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„"),kn=a("reservations.details.labels.contact","Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„"),Ln=a("reservations.details.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·");a("reservations.details.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙŠ Ù…Ø´Ø±ÙˆØ¹.");const In=a("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),En=a("reservations.details.actions.openProject","ğŸ“ ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),Rn=a("reservations.details.labels.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),qn=a("reservations.details.labels.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),Mn=a("reservations.details.labels.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),Hn=a("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),Bn=a("reservations.details.labels.itemsCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),zn=a("reservations.details.labels.itemsTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),On=Ft,Un=a("reservations.paymentHistory.title","Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª"),Vn=a("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©"),Kn=a("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),Ye=!r||!i?[]:Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[],Wn=Array.isArray(t?.paymentHistory)?t.paymentHistory:Array.isArray(t?.payment_history)?t.payment_history:Array.isArray(t?.paymentLogs)?t.paymentLogs:[],je=Ye.length?Ye:Wn,Gn=je.length?0:Number(t.paidAmount??t.paid_amount)||0,Jn=je.length?0:Number(t.paidPercent??t.paid_percentage)||0,Xe=Ve({totalAmount:Number.isFinite(Number(et))?Number(et):0,paidAmount:Gn,paidPercent:Jn,history:je}),Zt=Ke({manualStatus:null,paidAmount:Xe.paidAmount,paidPercent:Xe.paidPercent,totalAmount:Number.isFinite(Number(et))?Number(et):0}),De=Zt==="partial",Ze=Zt==="paid"?we:De?Yt:Pe;function Qn(e){if(e==null)return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;const l=String(e).replace(/[^0-9.+-]/g,""),N=Number(l);return Number.isFinite(N)?N:Number.NaN}const ke=(e={})=>{const l=String(e.type??e.kind??e.category??"").toLowerCase();return!!(["package","bundle","pack"].includes(l)||Array.isArray(e.packageItems)&&e.packageItems.length)},Yn=(e={})=>[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id].some(l=>l!=null&&l!==""),Xn=(e={})=>!e||typeof e!="object"?!1:!ke(e)&&Yn(e);let Le=Array.isArray(m)&&m.length?m.length:(Array.isArray(u)?u.filter(e=>e&&typeof e=="object"&&!Xn(e)).length:0)||1;Le=Math.max(1,Math.round(Le));const Zn=p(String(Le)),tn=xn.replace("{count}",Zn),ta=Ht.replace("{count}",me),ea=t.notes?p(t.notes):Hn,na=p(Ut.toFixed(2)),aa=p(ue.toFixed(2)),sa=p(String(vt)),ia=p(kt.toFixed(2)),oa=`${sa}% (${ia} ${x})`,ra=Number.isFinite(Kt)?Math.max(0,Kt):0,ca=p(ra.toFixed(2)),dt=[{icon:"ğŸ’¼",label:zn,value:`${fe} ${x}`}];dt.push({icon:"ğŸ’¸",label:On,value:`${ye} ${x}`}),dt.push({icon:"ğŸ˜",label:Se,value:`${na} ${x}`});const la=a("reservations.details.labels.crewCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ±ÙŠÙ‚");dt.push({icon:"ğŸ’µ",label:la,value:`${aa} ${x}`}),Rt>0&&dt.push({icon:"ğŸ’¸",label:$e,value:`${be} ${x}`}),dt.push({icon:"ğŸ“Š",label:Ne,value:`${he} ${x}`}),At&&Vt>0&&dt.push({icon:"ğŸ§¾",label:Qt,value:`${ve} ${x}`}),vt>0&&dt.push({icon:"ğŸ¦",label:Ae,value:oa}),dt.push({icon:"ğŸ’µ",label:Ce,value:`${ca} ${x}`}),dt.push({icon:"ğŸ’°",label:xe,value:`${ge} ${x}`});const da=dt.map(({icon:e,label:l,value:N})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${e} ${l}</span>
      <span class="summary-details-value">${N}</span>
    </div>
  `).join("");let en="";try{const l=new URL(window.location.href).searchParams.get("debugFinance");if(l==="1"||l==="true"){const N=_=>(_?.type||"").toLowerCase()==="package"&&String(_?.pricingMode||"").toLowerCase()==="fixed"?"fixed":"daily",F=_=>{if((_?.type||"").toLowerCase()==="package")return!1;const y=Array.isArray(_?.items)?_.items:[];if(!y.length)return!1;if(y.some(E=>E?.reservation_id!=null||E?.reservationId!=null))return!0;const P=y.every(E=>E?.unit_price!=null||E?.unitPrice!=null),nt=y.some(E=>E?.daily_rate!=null||E?.dailyRate!=null||E?.unit_rate!=null||E?.unitRate!=null||E?.price!=null);return P&&!nt};let R=0,I=0,H=0,D=0;const st=(Array.isArray(m)?m:[]).map((_,y)=>{const A=Number.isFinite(Number(_?.quantity))?Number(_.quantity):0,P=Number.isFinite(Number(_?.unitPrice))?Number(_.unitPrice):0,nt=N(_);let E=nt==="fixed"?A*P:A*P*M,ut="";if((_?.type||"").toLowerCase()==="package")try{const it={package_code:_?.package_code||_?.packageDisplayCode||_?.barcode||_?.packageId||_?.key,packageItems:Array.isArray(_?.packageItems)?_.packageItems:void 0},ft=Number(_?.unitPrice);let _t;if(Number.isFinite(ft)&&ft>0)_t=A*ft;else{const G=ln(it,{packageQuantity:A,days:M});_t=Number.isFinite(Number(G.perDayTotal))?Number(G.perDayTotal):A*P}E=_t*M,R+=_t,I+=E;const te=(pricing.lines||[]).map((G,cn)=>`
              <tr>
                <td colspan="2"></td>
                <td>â€¢ ${z(String(G.desc||G.barcode||"item"))}</td>
                <td>${p(String(G.qtyPerPackage))} Ã— ${p(String(A))} Ã— ${p(String(M))}</td>
                <td>${p(String((G.unitPrice||0).toFixed?G.unitPrice.toFixed(2):G.unitPrice))}</td>
                <td>${p(String((G.perDayTotal*M).toFixed?(G.perDayTotal*M).toFixed(2):G.perDayTotal*M))}</td>
              </tr>`).join("");ut=te||""}catch{}else{const it=F(_),ft=it?0:A*P,_t=it?A*P:ft*M;H+=ft,D+=_t}return`
          <tr>
            <td>${y+1}</td>
            <td>${z(String(_?.description||"-"))}</td>
            <td>${nt}</td>
            <td>${p(String(A))}</td>
            <td>${p(String(P.toFixed?P.toFixed(2):P))}</td>
            <td>${p(String(E.toFixed?E.toFixed(2):E))}</td>
          </tr>${ut}`}).join("");en=`
        <details class="reservation-finance-debug" style="margin-top:12px">
          <summary>Debug: ØªÙØµÙŠÙ„ Ø§Ù„ØªØ³Ø¹ÙŠØ±</summary>
          <div style="padding:8px 0; font-size: 12px">
            <div>Ø§Ù„Ø£ÙŠØ§Ù…: ${p(String(M))}</div>
            <div style="margin-top:6px"><strong>Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø³Ø±ÙŠØ¹Ø©:</strong></div>
            <div>Ù…Ù† Ø§Ù„Ø­ÙØ²Ù… (ÙŠÙˆÙ…ÙŠ): ${p(String(R.toFixed(2)))} ${x}</div>
            <div>Ù…Ù† Ø§Ù„Ø­ÙØ²Ù… (ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¯Ø©): ${p(String(I.toFixed(2)))} ${x}</div>
            <div>Ù…ÙØ±Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙØ²Ù… (ÙŠÙˆÙ…ÙŠ): ${p(String(H.toFixed(2)))} ${x}</div>
            <div>Ù…ÙØ±Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙØ²Ù… (ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¯Ø©): ${p(String(D.toFixed(2)))} ${x}</div>
            <div style="margin-top:4px">Equipment Total (breakdown): ${p(String(wt.toFixed(2)))} ${x}</div>
            <table class="table table-xs" style="width:100%; margin-top:8px">
              <thead>
                <tr>
                  <th>#</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø©</th>
                </tr>
              </thead>
              <tbody>${st}</tbody>
            </table>
          </div>
        </details>`,console.debug("[finance-debug] groups",m,{rentalDays:M,equipmentTotal:wt,crewTotal:Ut,discountAmount:Rt,taxAmount:Vt})}}catch{}console.debug("[reservations/details] payment history raw",t.paymentHistory,t.payment_history);let at=[];r&&i&&(Array.isArray(i.paymentHistory)?at=i.paymentHistory:Array.isArray(i.payment_history)?at=i.payment_history:Array.isArray(i.payments)?at=i.payments:Array.isArray(i.paymentLogs)&&(at=i.paymentLogs)),(!Array.isArray(at)||at.length===0)&&(Array.isArray(t.paymentHistory)?at=t.paymentHistory:Array.isArray(t.payment_history)?at=t.payment_history:Array.isArray(t.paymentLogs)?at=t.paymentLogs:at=[]);const nn=Array.isArray(at)?at:[],ua=nn.length?`<ul class="reservation-payment-history-list">${nn.map(e=>{const l=typeof e?.type=="string"?e.type.toLowerCase():"",N=l==="amount"?a("reservations.paymentHistory.type.amount","Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©"):l==="percent"?a("reservations.paymentHistory.type.percent","Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©"):a("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©"),F=Number.isFinite(Number(e?.percentage))&&Number(e.percentage)>0?Number(e.percentage):Number.isFinite(Number(e?.value))&&l==="percent"?Number(e.value):null,R=F!=null&&Number.isFinite(Number(et))&&Number(et)>0?Math.round(Number(et)*(F/100)*100)/100:null,I=Number.isFinite(Number(e?.amount))&&Number(e.amount)>0?Number(e.amount):null,H=l==="percent"&&R!=null?R:I,D=H!=null?`${p(H.toFixed(2))} ${x}`:"â€”",st=F!=null?`${p(F.toFixed(2))}%`:"â€”",_=e?.recordedAt?p(Ee(e.recordedAt)):"â€”",y=e?.note?`<div class="payment-history-note">${z(p(e.note))}</div>`:"";return`
          <li>
            <div class="payment-history-entry">
              <span class="payment-history-entry__type">${z(N)}</span>
              <span class="payment-history-entry__amount">${D}</span>
              <span class="payment-history-entry__percent">${st}</span>
              <span class="payment-history-entry__date">${_}</span>
            </div>
            ${y}
          </li>
        `}).join("")}</ul>`:`<div class="reservation-payment-history-empty">${z(Vn)}</div>`,an=String(t?.status||t?.reservationStatus||"").toLowerCase(),sn=an==="cancelled"||an==="canceled",on=sn?[{text:a("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ"),className:"status-cancelled"},{text:Ze,className:Zt==="paid"?"status-paid":De?"status-partial":"status-unpaid"}]:[{text:c?gt:qt,className:c?"status-confirmed":"status-pending"},{text:Ze,className:Zt==="paid"?"status-paid":De?"status-partial":"status-unpaid"}];d&&!sn&&on.push({text:Mt,className:"status-completed"});const pa=on.map(({text:e,className:l})=>`<span class="status-chip ${l}">${e}</span>`).join(""),jt=(e,l,N)=>`
    <div class="res-info-row">
      <span class="label">${e} ${l}</span>
      <span class="value">${N}</span>
    </div>
  `;let Ie="";if(t.projectId){let e=z(In);if(i){const l=i.title||a("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");e=`${z(l)} <button type="button" class="btn btn-sm btn-outline-primary" data-action="open-project" data-project-id="${i.id}">${z(En)}</button>`}Ie=`
      <div class="res-info-row">
        <span class="label">ğŸ“ ${Ln}</span>
        <span class="value">${e}</span>
      </div>
    `}const mt=[];mt.push(jt("ğŸ‘¤",Dn,n?.customerName||t.customerName||Kn)),mt.push(jt("ğŸ“",kn,n?.phone||"â€”")),mt.push(jt("ğŸ—“ï¸",Rn,Gt)),mt.push(jt("ğŸ—“ï¸",qn,Jt)),mt.push(jt("ğŸ“¦",Bn,tn)),mt.push(jt("â±ï¸",Te,_e)),mt.push(jt("ğŸ“",Mn,ea)),Ie&&mt.push(Ie);const ma=mt.join(""),fa=m.length?m.map(e=>{const l=e.items[0]||{},N=ja(l)||e.image,F=N?`<img src="${N}" alt="${w}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>';let R=[];if(Array.isArray(e.packageItems)&&e.packageItems.length)R=[...e.packageItems];else{const T=[];e.items.forEach(q=>{Array.isArray(q?.packageItems)&&q.packageItems.length&&T.push(...q.packageItems)}),R=T}if(Array.isArray(R)&&R.length>1){const T=new Set;R=R.filter(q=>{const C=q?.normalizedBarcode&&String(q.normalizedBarcode).toLowerCase()||q?.barcode&&String(q.barcode).toLowerCase()||(q?.equipmentId!=null?`id:${q.equipmentId}`:null);return C?T.has(C)?!1:(T.add(C),!0):!0})}const I=ke(e)||e.items.some(T=>ke(T))||R.length>0,H=(T,{fallback:q=1,max:C=1e3}={})=>{const k=Qn(T);return Number.isFinite(k)&&k>0?Math.min(C,k):q};let D;if(I){const T=H(l?.qty??l?.quantity??l?.count,{fallback:NaN,max:999});Number.isFinite(T)&&T>0?D=T:D=H(e.quantity??e.count??1,{fallback:1,max:999})}else D=H(e.quantity??e.count??l?.qty??l?.quantity??l?.count??0,{fallback:1,max:9999});const st=p(String(D)),_=(T,{preferPositive:q=!1}={})=>{let C=Number.NaN;for(const k of T){const rt=ot(k);if(Number.isFinite(rt)){if(q&&rt>0)return rt;Number.isFinite(C)||(C=rt)}}return C};let y,A,P;if(I){const T=[l?.price,l?.unit_price,l?.unitPrice,e.unitPrice];if(y=_(T,{preferPositive:!0}),!Number.isFinite(y)||y<0){const k=ot(e.totalPrice??l?.total??l?.total_price);Number.isFinite(k)&&D>0&&(y=k/D)}Number.isFinite(y)||(y=0);const q=[l?.cost,l?.unit_cost,l?.unitCost,e.unitCost];A=_(q,{preferPositive:!0}),Number.isFinite(A)||(A=0);const C=[l?.total,l?.total_price,e.totalPrice];if(P=_(C),!Number.isFinite(P))P=y*D;else{const k=y*D;Number.isFinite(k)&&k>0&&Math.abs(P-k)>k*.25&&(P=k)}}else{const T=[l?.price,l?.unit_price,l?.unitPrice,e.unitPrice];if(y=_(T,{preferPositive:!0}),!Number.isFinite(y)||y<0){const C=ot(e.totalPrice??l?.total??l?.total_price);Number.isFinite(C)&&D>0&&(y=C/D)}Number.isFinite(y)||(y=0);const q=[l?.cost,l?.unit_cost,l?.unitCost,e.unitCost];A=_(q,{preferPositive:!0}),(!Number.isFinite(A)||A<0)&&(A=0),P=ot(e.totalPrice??l?.total??l?.total_price),Number.isFinite(P)||(P=y*D)}y=B(y),A=B(A),P=B(P);const nt=`${p(y.toFixed(2))} ${x}`,E=`${p(A.toFixed(2))} ${x}`;`${p(P.toFixed(2))}${x}`;const ut=e.barcodes.map(T=>p(String(T||""))).filter(Boolean),it=ut.length?`<details class="reservation-item-barcodes">
              <summary>${a("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
              <ul class="reservation-barcode-list">
                ${ut.map(T=>`<li>${T}</li>`).join("")}
              </ul>
            </details>`:"";let ft="";if(R.length){const T=new Map,q=C=>1;if(R.forEach(C=>{if(!C)return;const k=Bt(C.barcode||C.normalizedBarcode||C.desc||Math.random());if(!k)return;const rt=T.get(k),Lt=q();if(rt){rt.qty=Lt,rt.total=Lt;return}T.set(k,{desc:C.desc||C.barcode||a("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Math.max(1,Math.min(Lt,99)),total:Math.max(1,Math.min(Lt,99)),barcode:C.barcode??C.normalizedBarcode??""})}),T.size){const C=Array.from(T.values()).map(k=>{const rt=p(String(k.qty>0?Math.min(k.qty,99):1)),Lt=z(k.desc||""),va=k.barcode?` <span class="reservation-package-items__barcode">(${z(p(String(k.barcode)))})</span>`:"";return`<li>${Lt}${va} Ã— ${rt}</li>`}).join("");ft=`
              <details class="reservation-package-items">
                <summary>${a("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
                <ul class="reservation-package-items__list">
                  ${C}
                </ul>
              </details>
            `}}const _t=I?`${ft||""}${it||""}`:it,te=p(String(M));let G;if(I){let T=y;if(!Number.isFinite(T)||T<=0){const q={package_code:e?.package_code||e?.packageDisplayCode||e?.barcode||e?.packageId||e?.key,packageItems:Array.isArray(e?.packageItems)?e.packageItems:void 0};try{const C=ln(q,{packageQuantity:Number.isFinite(D)?D:1,days:1});Number.isFinite(Number(C.perDayTotal))&&(T=Number(C.perDayTotal))}catch{}}G=B(T*M)}else G=B(y*D*M);const cn=`${p(G.toFixed(2))} ${x}`;return`
          <tr>
            <td class="reservation-modal-items-table__cell reservation-modal-items-table__cell--item">
              <div class="reservation-item-info">
                <div class="reservation-item-thumb-wrapper">${F}</div>
                <div class="reservation-item-copy">
                  <div class="reservation-item-title">${z(l.desc||l.description||l.name||e.description||"-")}</div>
                  ${_t}
                </div>
              </div>
            </td>
            <td class="reservation-modal-items-table__cell" data-label="${z(h.quantity)}">
              <div class="reservation-quantity-control reservation-quantity-control--static">
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">âˆ’</button>
                <span class="reservation-qty-value">${st}</span>
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">+</button>
              </div>
            </td>
            <td class="reservation-modal-items-table__cell" data-label="${z(a("reservations.details.table.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…"))}">${te}</td>
            <td class="reservation-modal-items-table__cell" data-label="${z(h.unitPrice)}">${nt}</td>
            <td class="reservation-modal-items-table__cell" data-label="${z(h.unitCost)}">${E}</td>
            <td class="reservation-modal-items-table__cell" data-label="${z(h.total)}">${cn}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${U}</td></tr>`,ya=`
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>${h.item}</th>
            <th>${h.quantity}</th>
            <th>${a("reservations.details.table.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…")}</th>
            <th>${h.unitPrice}</th>
            <th>${h.unitCost}</th>
            <th>${h.total}</th>
          </tr>
        </thead>
        <tbody>${fa}</tbody>
      </table>
    </div>
  `,rn=V.map((e,l)=>{const N=p(String(l+1));let F=e.positionLabel??e.position_name??e.position_label??e.position_title??e.role??e.position??null;if((!F||F.trim()==="")&&(F=e.positionLabelAr??e.position_label_ar??e.position_title_ar??e.positionLabelEn??e.position_label_en??e.position_name_ar??e.position_title_en??e.position_name_en??null),!F||F.trim()==="")try{const P=typeof ee=="function"?ee():[],nt=e.positionId?P.find(it=>String(it.id)===String(e.positionId)):null,E=!nt&&e.positionKey?P.find(it=>String(it.name).toLowerCase()===String(e.positionKey).toLowerCase()):null,ut=nt||E||null;ut&&(F=ut.labelAr||ut.labelEn||ut.name||F)}catch{}const R=Re(F)||a("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),I=Re(e.positionLabelAlt??e.position_label_alt??e.positionLabelEn??e.position_label_en??e.positionLabelAr??e.position_label_ar??e.position_name_en??e.position_name_ar??""),H=Re(e.technicianName)||a("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),D=e.technicianPhone||Z,st=B(ot(e.positionCost??e.position_cost??e.cost??e.daily_wage??e.dailyWage??e.internal_cost??0)),_=B(ot(e.positionClientPrice??e.position_client_price??e.client_price??e.customer_price??e.position_price??e.clientPrice??e.daily_total??e.dailyTotal??e.total??0)),y=`${p(_.toFixed(2))} ${x}`,A=st>0?`${p(st.toFixed(2))} ${x}`:null;return`
      <div class="reservation-technician-card">
        <div class="technician-card-head">
          <span class="technician-index">${N}</span>
          <div class="d-flex flex-column">
            <span class="technician-name">${H}</span>
            <small class="text-muted">ğŸ·ï¸ ${R}${I?` â€” ${I}`:""}</small>
            <small class="text-muted">ğŸ’¼ ${y}</small>
          </div>
        </div>
        <div class="technician-card-body">
          <div>ğŸ“ ${D}</div>
          ${A?`<div>ğŸ’µ ${a("reservations.details.technicians.costLabel","Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©")}: ${A}</div>`:""}
        </div>
      </div>
    `}).join(""),ba=Array.isArray(V)&&V.length>4,ha=V.length?ba?`
          <div class="reservation-technicians-slider" data-tech-slider>
            <button type="button" class="slider-btn slider-btn--prev" data-slider-prev aria-label="${z(a("reservations.details.slider.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"))}" title="${z(a("reservations.details.slider.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"))}">â€¹</button>
            <div class="reservation-technicians-track" data-slider-track>
              ${rn}
            </div>
            <button type="button" class="slider-btn slider-btn--next" data-slider-next aria-label="${z(a("reservations.details.slider.next","Ø§Ù„ØªØ§Ù„ÙŠ"))}" title="${z(a("reservations.details.slider.next","Ø§Ù„ØªØ§Ù„ÙŠ"))}">â€º</button>
          </div>
        `:`<div class="reservation-technicians-grid">${rn}</div>`:`<ul class="reservation-modal-technicians"><li>${X}</li></ul>`;return`
    <div class="reservation-modal">
      <div class="reservation-modal-header">
        <div class="reservation-modal-id">
          <span>${pt}</span>
          <strong>${Wt}</strong>
        </div>
        <div class="status-chips">
          ${pa}
        </div>
      </div>

      <div class="reservation-modal-grid">
        <div class="reservation-info-card">
          <h6>${Qe}</h6>
          ${ma}
        </div>
      </div>
      <div class="reservation-summary-card">
        <div class="summary-icon">ğŸ’³</div>
        <div class="summary-body">
          <h6 class="summary-heading">${Xt}</h6>
          <div class="summary-content">
            <div class="summary-details">
              ${da}
            </div>
            <div class="reservation-payment-history-modal">
              <h6 class="history-heading">${Un}</h6>
              ${ua}
            </div>
            ${en}
          </div>
        </div>
      </div>

      <div class="reservation-technicians-section">
        <div class="section-title">
          <span>${Fe}</span>
          <span class="count">${ta}</span>
        </div>
        ${ha}
      </div>

      <div class="reservation-items-section">
        <div class="section-title">
          <span>${Pn}</span>
          <span class="count">${tn}</span>
        </div>
        ${ya}
      </div>

      <div class="reservation-modal-actions">
        <button type="button" class="modal-action-btn modal-action-btn--ghost" id="reservation-details-export-btn" data-index="${s}">
          ${a("reservations.details.actions.exportPdf","Ø¹Ø±Ø¶ Ø³Ø¹Ø±")}
        </button>
        <button type="button" class="modal-action-btn modal-action-btn--ghost" id="reservation-details-checklist-btn" data-index="${s}">
          ${a("reservations.details.actions.exportChecklist","ğŸ“‹ Ù„Ø³ØªØ© Ù…Ø¹Ø¯Ø§Øª ÙˆÙÙ†ÙŠÙŠÙ†")}
        </button>
        <button type="button" class="modal-action-btn modal-action-btn--primary" id="reservation-details-edit-btn" data-index="${s}">${Fn}</button>
        ${bt?`<button type="button" class="modal-action-btn modal-action-btn--danger" id="reservation-details-delete-btn" data-index="${s}">${jn}</button>`:""}
      </div>
    </div>
  `}function zt(){const t=()=>{Ca(),wa(),Aa()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(t,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(t);return}}t()}let Me=!1,He=null;function Ya(t){if(!t||typeof t!="object")return"";const n=Object.entries(t).filter(([o,s])=>s!=null).map(([o,s])=>[o,String(s)]);return n.length===0?"":JSON.stringify(n.sort(([o],[s])=>o.localeCompare(s)))}async function Xa(t={}){const{suppressError:n=!0,params:o=null,force:s=!1}=t??{},i=Ya(o);if(!s&&Me&&St().length>0&&i===He)return St();try{const r=await $n(o||{});return Me=!0,He=i,r}catch(r){if(console.error("âŒ [reservationsActions] Failed to load reservations from API",r),!n)throw r;return St()}}function Za(){Me=!1,He=null}function bn(t){if(!t)return null;const n=String(t).trim();if(!n)return null;const o=n.includes(" ")?n.replace(" ","T"):n,s=new Date(o);return Number.isNaN(s.getTime())?null:s}function ts(t){const n=[t?.start,t?.startDatetime,t?.start_datetime,t?.start_date,t?.startDate],o=[t?.end,t?.endDatetime,t?.end_datetime,t?.end_date,t?.endDate];let s=null;for(const r of n)if(s=bn(r),s)break;let i=null;for(const r of o)if(i=bn(r),i)break;return!i&&s&&(i=new Date(s.getTime()+14400*1e3)),{start:s,end:i}}async function es(t,{onAfterChange:n}={}){if(!ze())return ga(),!1;const s=St()[t];if(!s)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const i=s.id||s.reservationId;if(!i)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;try{return await Na(i),zt(),n?.({type:"deleted",reservation:s}),K(a("reservations.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²")),!0}catch(r){console.error("âŒ [reservationsActions] deleteReservation failed",r);const c=re(r)?r.message:a("reservations.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return K(c,"error"),!1}}async function ns(t,{onAfterChange:n}={}){const s=St()[t];if(!s)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const i=s.id||s.reservationId;if(!i)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const{projectLinked:r}=Oe(s);if(r)return K(a("reservations.toast.confirmBlockedByProject","âš ï¸ Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² ØªØªØ­ÙƒÙ… Ø¨Ù‡Ø§ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø· ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ£ÙƒÙŠØ¯Ù‡ Ù…Ù† Ù‡Ù†Ø§"),"info"),!1;try{const c=await Ta(i);return zt(),n?.({type:"confirmed",reservation:c}),K(a("reservations.toast.confirmed","âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²")),!0}catch(c){console.error("âŒ [reservationsActions] confirmReservation failed",c);const d=re(c)?c.message:a("reservations.toast.confirmFailed","ØªØ¹Ø°Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return K(d,"error"),!1}}async function as(t,n="",{onAfterChange:o,reservationId:s}={}){const i=St();let r=i[t];const c=s!=null?String(s):null;if(!r&&c&&(r=i.find(m=>{const f=m?.id??m?.reservationId??m?.reservation_id;return f!=null&&String(f)===c})),!r)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const d=r.id||r.reservationId;if(!d)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;if(String(r.status||"").toLowerCase()==="completed")return K(a("reservations.toast.alreadyClosed","âœ… Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ù…ØºÙ„Ù‚ Ù…Ø³Ø¨Ù‚Ø§Ù‹")),!1;try{let m=r.notes?String(r.notes).trim():"";const f=(n||"").trim();if(f){const $=a("reservations.closeModal.notePrefix","Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥ØºÙ„Ø§Ù‚");m=m?`${m}
${$}: ${f}`:`${$}: ${f}`}const b=await gn(d,m);return zt(),o?.({type:"closed",reservation:b}),K(a("reservations.toast.closed","âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²")),!0}catch(m){console.error("âŒ [reservationsActions] closeReservation failed",m);const f=re(m)?m.message:a("reservations.toast.closeFailed","ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return K(f,"error"),!1}}function ss(t=""){const n=String(t||"");if(!n.trim())return"";const o=["Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥ØºÙ„Ø§Ù‚","Close note"];let s=-1;for(const r of o){const c=n.lastIndexOf(r);c>s&&(s=c)}return s===-1?"":n.slice(0,s).replace(/\n$/,"")}async function is(t,{onAfterChange:n}={}){const s=St()[t];if(!s)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const i=s.id||s.reservationId;if(!i)return K(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;try{const r=ss(s.notes||""),c=await _n(i,{status:"confirmed",confirmed:!0,notes:r});return zt(),n?.({type:"reopened",reservation:c}),K(a("reservations.toast.reopened","â†©ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚")),!0}catch(r){console.error("âŒ [reservationsActions] reopenReservation failed",r);const c=re(r)?r.message:a("reservations.toast.reopenFailed","ØªØ¹Ø°Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return K(c,"error"),!1}}async function os(){const t=St();if(!Array.isArray(t)||t.length===0)return!1;const n=new Date;let o=!1,s=0;for(const i of t){if(i?.projectId!=null&&i.projectId!==""&&i.projectId!=="null")continue;const c=String(i?.status||"").toLowerCase();if(["cancelled","canceled","completed","closed"].includes(c))continue;const d=i?.id||i?.reservationId;if(!d)continue;const{start:u,end:m}=ts(i);if(!(!u||!m)&&!(m>n))try{i?.confirmed===!0||i?.confirmed==="true"||c==="confirmed"?(await gn(d,i?.notes||null),s+=1):await _n(d,{status:"cancelled",cancelled:!0,confirmed:!1}),o=!0}catch(f){console.warn("âš ï¸ [reservations] auto-close standalone failed for",d,f)}}if(o){try{await $n()}catch{}try{document.dispatchEvent(new CustomEvent("reservations:changed"))}catch{}try{zt()}catch{}}return s>0}const Cs=Object.freeze(Object.defineProperty({__proto__:null,autoCloseExpiredStandaloneReservations:os,closeReservation:as,confirmReservation:ns,deleteReservation:es,ensureReservationsLoaded:Xa,reopenReservation:is,resetReservationsFetchState:Za},Symbol.toStringTag,{value:"Module"}));export{Da as A,ms as B,ps as C,As as D,as as E,is as F,es as G,ns as H,Cs as I,vs as P,Wa as a,gs as b,_s as c,j as d,Xa as e,$t as f,bs as g,hs as h,se as i,v as j,fs as k,ys as l,Nt as m,oe as n,Je as o,It as p,Ge as q,Ha as r,g as s,La as t,Ns as u,Ts as v,Ss as w,$s as x,us as y,ja as z};
