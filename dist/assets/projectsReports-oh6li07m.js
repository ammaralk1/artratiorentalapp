import{l as q,t as m,n as h,f as L,g as N}from"./auth-CX320jqT.js";/* empty css              *//* empty css                */import"./common-BaVD3hzN.js";import"./projects-CjCLdm3d.js";import"./projectsCommon-67Kw12-F.js";import{_ as H}from"./preload-helper-PPVm8Dsz.js";import{e as z,v as G,D as B,z as K,B as Y,C as Z,q as j,g as J}from"./projectsService-Bd9a53Mn.js";const R=.15,v={},i={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},n={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null};let y=null;const $=["upcoming","ongoing","completed"];async function X(){try{await z({suppressError:!0}),await G({force:!0})}catch(t){console.error("❌ [projectsReports] Failed to load initial data",t),B(t)&&console.warn("Projects API error:",t.message)}}async function Q(){await tt(),et(),await X(),F(),V(),it(),b(),document.addEventListener("language:changed",ct),document.addEventListener("projects:changed",()=>{E().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{E().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",ut)}document.addEventListener("DOMContentLoaded",Q);async function tt(){if(y)return y;try{y=(await H(()=>import("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"),[],import.meta.url)).default}catch(t){console.warn("Chart.js failed to load",t),y=null}return y}function et(){n.search=document.getElementById("reports-search"),n.statusChips=document.getElementById("reports-status-chips"),n.payment=document.getElementById("reports-payment"),n.dateRange=document.getElementById("reports-date-range"),n.customRangeWrapper=document.getElementById("reports-custom-range"),n.startDate=document.getElementById("reports-start-date"),n.endDate=document.getElementById("reports-end-date"),n.refreshBtn=document.getElementById("reports-refresh"),n.kpiGrid=document.getElementById("reports-kpi-grid"),n.table=document.getElementById("reports-table"),n.tableBody=n.table?.querySelector("tbody"),n.tableMeta=document.getElementById("reports-table-meta"),n.tableEmpty=document.getElementById("reports-empty")}function F(){const{customers:t=[]}=q();i.customers=Array.isArray(t)?t:[],i.reservations=J();const a=new Map(i.customers.map(r=>[String(r.id),r])),e=K();i.projects=Array.isArray(e)?e.map(r=>at(r,a)):[],i.totalProjects=i.projects.length}function at(t,a){const e=t.paymentStatus==="paid"?"paid":"unpaid",r=a.get(String(t.clientId)),l=nt(t.id),d=l.reduce((U,W)=>U+rt(W),0),c=st(t),u=Number(t?.equipmentEstimate)||0,s=Number((u+c).toFixed(2)),o=t?.applyTax===!0||t?.applyTax==="true",p=o?Number((s*R).toFixed(2)):0,f=o?Number(((s+d)*R).toFixed(2)):0,C=Number((s+d+f).toFixed(2)),T=ot(t),S=t.start?new Date(t.start):null,O=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:r?.customerName||r?.name||"",clientCompany:t.clientCompany||r?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:e,confirmed:t.confirmed===!0||t.confirmed==="true",start:S,end:O,applyTax:o,status:T,reservationsTotal:Number(d.toFixed(2)),expensesTotal:c,subtotal:s,taxAmount:p,combinedTaxAmount:f,overallTotal:C,unpaidValue:e==="paid"?0:C,reservationsCount:l.length}}function nt(t){return Array.isArray(i.reservations)?i.reservations.filter(a=>String(a.projectId)===String(t)):[]}function rt(t){if(!t)return 0;const a=Array.isArray(t.items)?t.items:[],e=t.discount??0,r=Number(h(String(e)))||0,l=t.discountType||"percent",d=Array.isArray(t.technicians)?t.technicians:[],c=j(a,r,l,!1,d,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(h(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function st(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((a,e)=>a+(Number(e.amount)||0),0):0}function ot(t){const a=new Date,e=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return e&&!Number.isNaN(e.getTime())&&e>a?"upcoming":r&&!Number.isNaN(r.getTime())&&r<a?"completed":"ongoing"}function it(){if(n.search){let t;n.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{i.filters.search=n.search.value.trim(),b()},180)})}n.payment&&(n.payment.value=i.filters.payment,n.payment.addEventListener("change",()=>{i.filters.payment=n.payment.value||"all",b()})),n.dateRange&&(n.dateRange.addEventListener("change",lt),n.dateRange.value=i.filters.range),n.startDate&&n.startDate.addEventListener("change",()=>{i.filters.startDate=n.startDate.value,i.filters.range==="custom"&&b()}),n.endDate&&n.endDate.addEventListener("change",()=>{i.filters.endDate=n.endDate.value,i.filters.range==="custom"&&b()}),n.refreshBtn&&n.refreshBtn.addEventListener("click",()=>{if(i.filters.range!=="custom"){b();return}i.filters.startDate=n.startDate?.value||"",i.filters.endDate=n.endDate?.value||"",b()})}function lt(t){const a=t.target.value;i.filters.range=a,a==="custom"?n.customRangeWrapper?.classList.add("active"):(n.customRangeWrapper?.classList.remove("active"),i.filters.startDate="",i.filters.endDate="",n.startDate&&(n.startDate.value=""),n.endDate&&(n.endDate.value=""),b())}async function E(){try{await Promise.all([Y(),Z()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),B(t)&&console.warn("Projects API error:",t.message)}finally{F(),b()}}function ct(){V(),b()}function ut(t){t.key&&!["projects","reservations","customers"].includes(t.key)||E().catch(a=>{console.error("❌ [projectsReports] Storage sync failed",a)})}function b(){const t=dt();k(),ft(t),bt(t),yt(t),ht(t),vt(t),Ct(t)}function dt(){const{search:t,statuses:a,payment:e,range:r,startDate:l,endDate:d}=i.filters,c=_(t),u=new Date,s=Number(r);let o=null;if(r==="custom"){o=l?new Date(l):null;const p=d?new Date(d):null;return i.projects.filter(f=>!I(f,a)||!P(f,e)||!M(f,c)?!1:pt(f.start,o,p))}return r!=="all"&&Number.isFinite(s)&&(o=new Date,o.setDate(u.getDate()-s)),i.projects.filter(p=>!I(p,a)||!P(p,e)||!M(p,c)?!1:r==="all"?!0:mt(p.start,o,u))}function I(t,a){return a.includes(t.status)}function P(t,a){return a==="all"?!0:t.paymentStatus===a}function M(t,a){return a?_([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(a):!0}function mt(t,a,e){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:a?t>=a&&t<=e:!0}function pt(t,a,e){if(!a&&!e)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(a&&!Number.isNaN(a.getTime())&&r<a.getTime()||e&&!Number.isNaN(e.getTime())&&r>e.getTime())}function _(t){return t?h(String(t)).toLowerCase().trim():""}function ft(t){if(!n.kpiGrid)return;const a=t.length,e=t.reduce((c,u)=>c+u.overallTotal,0),r=t.reduce((c,u)=>c+u.unpaidValue,0),l=t.reduce((c,u)=>c+u.expensesTotal,0),d=[{icon:"📊",label:m("projects.reports.kpi.totalProjects","Total projects"),value:w(a),meta:m("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:"💰",label:m("projects.reports.kpi.totalValue","Total value"),value:D(e),meta:m("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:"🧾",label:m("projects.reports.kpi.unpaidValue","Outstanding value"),value:D(r),meta:m("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:"💸",label:m("projects.reports.kpi.expenses","Total expenses"),value:D(l),meta:m("projects.reports.kpi.expensesMeta","Expenses for included projects")}];n.kpiGrid.innerHTML=d.map(({icon:c,label:u,value:s,meta:o})=>`
    <div class="reports-kpi-card">
      <div class="reports-kpi-icon">${c}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${g(u)}</p>
        <p class="reports-kpi-value">${g(s)}</p>
        <span class="reports-kpi-meta">${g(o)}</span>
      </div>
    </div>
  `).join("")}function V(){if(!n.statusChips)return;const t=$.map(a=>{const e=m(`projects.status.${a}`,a);return`<button type="button" class="reports-status-chip" data-status="${a}">${g(e)}</button>`}).join("");n.statusChips.innerHTML=t,n.statusChips.dataset.listenerAttached||(n.statusChips.addEventListener("click",gt),n.statusChips.dataset.listenerAttached="true"),k()}function gt(t){const a=t.target.closest("[data-status]");if(!a)return;const e=a.dataset.status;if(!e)return;const r=new Set(i.filters.statuses);r.has(e)?r.delete(e):r.add(e),r.size===0&&$.forEach(l=>r.add(l)),i.filters.statuses=Array.from(r),k(),b()}function k(){if(!n.statusChips)return;const t=new Set(i.filters.statuses);n.statusChips.querySelectorAll("[data-status]").forEach(a=>{a.classList.toggle("is-active",t.has(a.dataset.status))})}function bt(t){if(!y)return;const a=document.getElementById("reports-status-chart");if(!a)return;const e=["upcoming","ongoing","completed"],r=e.map(u=>t.filter(s=>s.status===u).length),d={labels:e.map(u=>m(`projects.status.${u}`,u)),datasets:[{data:r,backgroundColor:["rgba(59, 130, 246, 0.85)","rgba(250, 204, 21, 0.85)","rgba(34, 197, 94, 0.85)"],borderColor:["rgba(37, 99, 235, 1)","rgba(217, 119, 6, 1)","rgba(22, 163, 74, 1)"],borderWidth:1}]};A("status",a,"doughnut",d,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function yt(t){if(!y)return;const a=document.getElementById("reports-timeline-chart");if(!a)return;const e=new Map,r=new Intl.DateTimeFormat(Dt(),{month:"short",year:"numeric"});t.forEach(o=>{if(!o.start||Number.isNaN(o.start.getTime()))return;const p=`${o.start.getFullYear()}-${o.start.getMonth()+1}`,f=e.get(p)||{total:0,label:r.format(o.start)};f.total+=o.overallTotal,e.set(p,f)});const l=Array.from(e.keys()).sort((o,p)=>{const[f,C]=o.split("-").map(Number),[T,S]=p.split("-").map(Number);return f===T?C-S:f-T}),d=l.map(o=>e.get(o)?.label||o),c=l.map(o=>Math.round(e.get(o)?.total||0)),u={labels:d,datasets:[{label:m("projects.reports.charts.timeline","Revenue over time"),data:c,borderColor:"rgba(76, 110, 245, 0.95)",backgroundColor:"rgba(76, 110, 245, 0.25)",fill:!0,tension:.35,pointRadius:4}]};A("timeline",a,"line",u,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:o=>x(o)}}},plugins:{legend:{display:!1}}})}function ht(t){if(!y)return;const a=document.getElementById("reports-expense-chart");if(!a)return;const e=[...t].sort((s,o)=>o.overallTotal-s.overallTotal).slice(0,6),r=e.map(s=>s.title||s.projectCode),l=e.map(s=>Math.round(s.overallTotal)),d=e.map(s=>Math.round(s.expensesTotal)),c={labels:r,datasets:[{label:m("projects.reports.datasets.value","Total value"),data:l,backgroundColor:"rgba(76, 110, 245, 0.65)"},{label:m("projects.reports.datasets.expenses","Expenses"),data:d,backgroundColor:"rgba(244, 114, 182, 0.55)"}]};A("expenses",a,"bar",c,{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0,ticks:{callback:s=>x(s)}}},plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function vt(t){if(!y)return;const a=document.getElementById("reports-clients-chart");if(!a)return;const e=new Map;t.forEach(s=>{const o=s.clientName||s.clientCompany||m("projects.fallback.unknownClient","Unknown client"),p=e.get(o)||0;e.set(o,p+s.overallTotal)});const r=Array.from(e.entries()).sort((s,o)=>o[1]-s[1]).slice(0,6),l=r.map(([s])=>s),d=r.map(([,s])=>Math.round(s)),c={labels:l,datasets:[{label:m("projects.reports.charts.clients","Top clients"),data:d,backgroundColor:"rgba(59, 130, 246, 0.75)"}]};A("clients",a,"bar",c,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:s=>x(s)}}},plugins:{legend:{display:!1}}})}function A(t,a,e,r,l){if(!(!y||!a)){if(v[t]){v[t].data=r,v[t].options=l,v[t].update();return}v[t]=new y(a,{type:e,data:r,options:l})}}function Ct(t){if(!n.table||!n.tableBody||!n.tableEmpty)return;if(!t.length){n.table.style.display="none",n.tableEmpty.classList.add("active"),n.tableMeta&&(n.tableMeta.textContent="");return}n.table.style.display="",n.tableEmpty.classList.remove("active");const a=t.map(e=>{const r=Tt(e.start,e.end),l=m(`projects.status.${e.status}`,e.status),d=m(`projects.paymentStatus.${e.paymentStatus}`,e.paymentStatus),c=e.clientCompany?`${g(e.clientName)} <small class="text-muted">${g(e.clientCompany)}</small>`:g(e.clientName||m("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${g(e.title||e.projectCode)}</span>
            <small class="text-muted">${g(`#${e.projectCode}`)}</small>
          </div>
        </td>
        <td>${c}</td>
        <td>${g(l)}</td>
        <td>${g(r)}</td>
        <td>${g(D(e.overallTotal))}</td>
        <td>${g(d)}</td>
      </tr>
    `}).join("");if(n.tableBody.innerHTML=a,n.tableMeta){const e=m("projects.reports.table.meta","Showing {count} of {total} projects");n.tableMeta.textContent=e.replace("{count}",w(t.length)).replace("{total}",w(i.totalProjects))}}function Tt(t,a){if(!t&&!a)return"—";const e=t?L(t.toISOString()):"—",r=a?L(a.toISOString()):"—";return a?`${e} → ${r}`:e}function D(t){const a=Number(t)||0,e=N(),r=e==="ar"?"ar-SA":"en-US",l=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(a)),d=e==="ar"?"ر.س":"SAR";return`${h(l)} ${d}`}function w(t){const e=N()==="ar"?"ar-SA":"en-US";return h(new Intl.NumberFormat(e).format(t))}function x(t){const e=N()==="ar"?"ar-SA":"en-US";return h(new Intl.NumberFormat(e,{notation:"compact",compactDisplay:"short"}).format(t))}function Dt(){return N()==="ar"?"ar-SA":"en-US"}function g(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
