import{n as G,r as Q,i as J,p as X,l as Z,m as L}from"./reservationsService.DYjpTDJA.js";import{t as v,n as F,g as E}from"./auth.DAFISFqZ.js";const y={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function ut(t){y.callbacks.onRender=typeof t=="function"?t:null}function it(t){y.callbacks.onBeforeRender=typeof t=="function"?t:null}function mt(t){y.callbacks.onAfterRender=typeof t=="function"?t:null}function dt(t){y.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function pt(t){y.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function ft(t){y.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function D(t,e,s=e){const o=E()==="en"?s??e:e;return v(t,o)}function gt(){y.formatters.cachedLocale=null,y.formatters.numberFormatter=null}function Y(){return(E()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function z(){const t=E();if(t!==y.formatters.cachedLocale||!y.formatters.numberFormatter||!y.formatters.currencyFormatter){y.formatters.cachedLocale=t;const e=Y();y.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),y.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:y.formatters.numberFormatter,currencyFormatter:y.formatters.currencyFormatter}}function ht(t){const{numberFormatter:e}=z(),s=e.format(Math.round(t||0));return F(s)}function yt(t){const{currencyFormatter:e}=z(),s=Number.isFinite(Number(t))?Number(t):0,a=e.format(s);return`${F(a)} SR`}function I(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${a}-${o}`}function bt(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const s=new Intl.DateTimeFormat(Y(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return F(s.format(e))}function H(t){return new Intl.DateTimeFormat(Y(),{month:"short"}).format(t)}const tt=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),$=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),et=1440*60*1e3,S={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function C(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const s=t[0]||{},a=t[e-1]||{},o=`${s.id??s.reservationId??""}-${s.start??""}`,n=`${a.id??a.reservationId??""}-${a.start??""}`,r=y.formatters?.cachedLocale||"ar";return`${e}|${o}|${n}|${r}`}function P(t,e){return t.get(e)}function R(t,e,s){if(t.set(e,s),t.size>64){const a=t.keys().next().value;t.delete(a)}return s}function K(t){return F(String(t||"")).toLowerCase().trim()}function x(t){return(t||"").toString().trim()}function O(t,e){if(!t||!e)return 1;const s=new Date(t),a=new Date(e);if(Number.isNaN(s.getTime())||Number.isNaN(a.getTime()))return 1;const o=a.getTime()-s.getTime();return o<=0?1:Math.max(1,Math.ceil(o/et))}function j(t){return t?(y.techniciansIndex||(y.techniciansIndex=new Map((y.data.technicians||[]).map(e=>[String(e.id),e]))),y.techniciansIndex.get(String(t))||null):null}function k(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const s of e){if(s==null)continue;const a=Number.parseFloat(F(String(s)));if(Number.isFinite(a))return a}return 0}function q(t={}){const e=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const s of e){if(s==null)continue;const a=Number.parseFloat(F(String(s)));if(Number.isFinite(a))return a}return k(t)}function A(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;O(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,s=t.discountType||t.discount_type||"percent",a=String(s).toLowerCase()==="amount"?"amount":"percent",o=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",n=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,r=n!=null?X(n):Number.NaN,l=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(r)&&r>0?r:null,m=Array.isArray(t.crewAssignments)?t.crewAssignments:[],d=m.length?m.map(h=>h?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],c=Z({items:Array.isArray(t.items)?t.items:[],technicianIds:d,crewAssignments:m,discount:e,discountType:a,applyTax:o,start:t.start,end:t.end,companySharePercent:l}),u=Number(t.cost);let p=c.finalTotal,f=c.taxAmount;if(Number.isFinite(u)&&u>0&&(p=L(u),o)){const h=p-c.taxableAmount;Number.isFinite(h)&&h>=0&&(f=L(h))}const g={rentalDays:c.rentalDays,equipmentTotal:c.equipmentTotal,crewTotal:c.crewTotal,crewCostTotal:c.crewCostTotal,discountAmount:c.discountAmount,subtotalAfterDiscount:c.subtotalAfterDiscount,taxableAmount:c.taxableAmount,taxAmount:f,finalTotal:p,companySharePercent:c.companySharePercent,companyShareAmount:c.companyShareAmount,netProfit:c.netProfit,companyShareEnabled:c.companySharePercent>0};return t.__financials=g,g}function U(t){return t?.projectId&&y.data.projectsMap.get(String(t.projectId))||null}function B(t=""){const e=String(t).toLowerCase().trim();return e?tt.get(e)||e:""}function nt(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const s of e){const a=String(s||"").toLowerCase().trim();if(a&&$.has(a))return $.get(a)}return t?.paid===!0||t?.paid==="true"}function N(t){const e=U(t),s=Q(t,e),a=B(s.projectStatus);let o=B(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");s.projectLinked&&a&&o!=="cancelled"&&(o=a),o||(o=s.effectiveConfirmed?"confirmed":"pending"),o!=="cancelled"&&(J(t)||a==="completed")&&(o="completed");let n=s.effectiveConfirmed||o==="confirmed"||o==="completed";o==="cancelled"&&(n=!1),n&&o!=="completed"&&o!=="cancelled"&&(o="confirmed");const r=nt(t),i=t?.paidStatus??t?.paid_status??(r?"paid":"unpaid");return{statusValue:o,confirmed:n,paid:r,paidStatus:i}}function wt(t){const e=t.length;let s=0,a=0,o=0,n=0,r=0,i=0,l=0,m=0,d=0,c=0;t.forEach(p=>{const{statusValue:f,confirmed:g,paid:h}=N(p);if(f==="completed"&&(a+=1),f==="cancelled"&&(o+=1),g&&(s+=1),h&&f!=="cancelled"&&(n+=1),f!=="cancelled"){const b=A(p);r+=b.finalTotal,i+=b.companyShareAmount,l+=b.taxAmount,m+=b.crewTotal,d+=b.crewCostTotal??0,c+=b.netProfit}});const u=e?r/e:0;return{total:e,confirmed:s,completed:a,cancelled:o,activeTotal:Math.max(0,e-o),paidCount:n,revenue:r,average:u,companyShareTotal:i,taxTotal:l,crewTotal:m,crewCostTotal:d,netProfit:c}}function W({range:t,start:e,end:s}){const a=new Date;if(a.setHours(23,59,59,999),t==="custom"){const r=e?new Date(`${e}T00:00:00`):null,i=s?new Date(`${s}T23:59:59`):null;return{startDate:V(r)?r:null,endDate:V(i)?i:null}}let o=new Date(a),n=null;switch(t){case"last30":{n=new Date(a),n.setDate(n.getDate()-29);break}case"thisWeek":{const r=new Date(a),l=(r.getDay()-6+7)%7;r.setDate(r.getDate()-l),r.setHours(0,0,0,0);const m=new Date(r);m.setDate(r.getDate()+6),m.setHours(23,59,59,999),n=r,o=m;break}case"thisMonth":{n=new Date(a.getFullYear(),a.getMonth(),1),o=new Date(a.getFullYear(),a.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const r=Math.floor(a.getMonth()/3);n=new Date(a.getFullYear(),r*3,1),o=new Date(a.getFullYear(),(r+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{n=new Date(a.getFullYear(),0,1),o=new Date(a.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:n=null,o=null;break}return n&&n.setHours(0,0,0,0),{startDate:n,endDate:o}}function V(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function Dt(t,e){const{startDate:s,endDate:a}=W(e);let o=0;const n=[];return(t||[]).forEach(r=>{if(!r)return;const i=typeof r.repairCost=="number"?r.repairCost:Number.parseFloat(F(String(r.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const l=String(r.statusRaw??r.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const d=r.resolvedAt??r.resolved_at??null,c=r.reportedAt??r.reported_at??null,u=r.createdAt??r.created_at??null,p=d?new Date(d):null,f=c?new Date(c):u?new Date(u):null,g=p&&!Number.isNaN(p.getTime())?p:f&&!Number.isNaN(f.getTime())?f:null;if(g&&(s&&g<s||a&&g>a))return;const h=Math.round(i*100)/100;o+=h,n.push({id:r.id,cost:h,date:g})}),{total:o,items:n}}function St(t,e){const s=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:s,netProfit:(t.netProfit||0)-s}}function Nt(t){const e=`trend:${C(t)}`,s=P(S.trend,e);if(s)return s;const a=new Date,o=[],n=(t||[]).map(l=>l?.start?new Date(l.start):null).filter(l=>l&&!Number.isNaN(l.getTime()));let r=6,i=new Date(a.getFullYear(),a.getMonth(),1);if(n.length){const l=new Date(Math.min(...n.map(f=>f.getTime()))),m=new Date(Math.max(...n.map(f=>f.getTime()))),d=new Date(l.getFullYear(),l.getMonth(),1);i=new Date(m.getFullYear(),m.getMonth(),1);const c=i.getFullYear()-d.getFullYear(),u=i.getMonth()-d.getMonth(),p=c*12+u;r=Math.min(12,Math.max(6,p+1))}for(let l=r-1;l>=0;l-=1){const m=new Date(i.getFullYear(),i.getMonth()-l,1),d=m.getFullYear(),c=m.getMonth(),u=t.filter(M=>{const T=M?.start?new Date(M.start):null;return T&&T.getFullYear()===d&&T.getMonth()===c}).filter(M=>N(M).statusValue!=="cancelled"),p=u.length;let f=0,g=0,h=0;u.forEach(M=>{const T=A(M);f+=T.finalTotal,g+=T.netProfit,h+=T.companyShareAmount});const b=H(m),w=new Date(m.getFullYear(),m.getMonth(),1),_=new Date(m.getFullYear(),m.getMonth()+1,0);o.push({label:b,count:p,revenue:f,netProfit:g,companyShare:h,periodStart:w,periodEnd:_,startInput:I(w),endInput:I(_)})}try{const l=new Map;(t||[]).forEach(c=>{if(N(c).statusValue==="cancelled")return;const u=c?.start?new Date(c.start):null;if(!u||Number.isNaN(u.getTime()))return;const p=`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`,f=A(c),g=l.get(p)||0;l.set(p,g+(Number(f.finalTotal)||0))});const m=o.map(c=>Number(c.revenue||0)),d=o.map((c,u)=>u<2?null:(m[u]+m[u-1]+m[u-2])/3);o.forEach((c,u)=>{const p=u>0?Number(o[u-1]?.revenue||0):null;let f=null;p!=null&&Number.isFinite(p)&&p>0&&(f=(Number(c.revenue||0)-p)/p*100);const g=c.periodStart instanceof Date?c.periodStart:null;let h=null;if(g&&!Number.isNaN(g.getTime())){const b=`${g.getFullYear()-1}-${String(g.getMonth()+1).padStart(2,"0")}`,w=l.get(b);Number.isFinite(w)&&w>0&&(h=(Number(c.revenue||0)-w)/w*100)}c.momChange=f,c.yoyChange=h,c.movingAvgRevenue=d[u]})}catch{}return R(S.trend,e,o)}function Mt(t){const e=new Date,s=(t||[]).map(r=>r?.start?new Date(r.start):null).filter(r=>r&&!Number.isNaN(r.getTime()));let a=6,o=new Date(e.getFullYear(),e.getMonth(),1);if(s.length){const r=new Date(Math.min(...s.map(u=>u.getTime()))),i=new Date(Math.max(...s.map(u=>u.getTime()))),l=new Date(r.getFullYear(),r.getMonth(),1);o=new Date(i.getFullYear(),i.getMonth(),1);const m=o.getFullYear()-l.getFullYear(),d=o.getMonth()-l.getMonth(),c=m*12+d;a=Math.min(12,Math.max(6,c+1))}const n=[];for(let r=a-1;r>=0;r-=1){const i=new Date(o.getFullYear(),o.getMonth()-r,1),l=i.getFullYear(),m=i.getMonth();let d=0,c=0;(t||[]).forEach(u=>{const p=u?.start?new Date(u.start):null;if(!p||p.getFullYear()!==l||p.getMonth()!==m)return;const{statusValue:f,confirmed:g}=N(u);f==="cancelled"?c+=1:(g||f==="confirmed"||f==="completed")&&(d+=1)}),n.push({label:H(i),confirmed:d,cancelled:c})}return n}function Tt(t){const e=`status:${C(t)}`,s=P(S.status,e);if(s)return s;const a={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(d=>{const{statusValue:c,confirmed:u}=N(d);c==="completed"?a.completed+=1:c==="cancelled"?a.cancelled+=1:c==="confirmed"||u?a.confirmed+=1:a.pending+=1});const o=Math.max(1,(t||[]).length),n=a.confirmed,r=a.pending,i=a.completed,l=a.cancelled,m=[{label:D("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:n,percent:Math.round(n/o*100)||0,rawCount:n,className:"status-confirmed",filterKey:"confirmed"},{label:D("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:r,percent:Math.round(r/o*100)||0,rawCount:r,className:"status-pending",filterKey:"pending"},{label:D("reservations.reports.status.completedLabel","منتهية","Completed"),value:i,percent:Math.round(i/o*100)||0,rawCount:i,className:"status-completed",filterKey:"completed"},{label:D("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:l,percent:Math.round(l/o*100)||0,rawCount:l,className:"status-cancelled",filterKey:"cancelled"}];return R(S.status,e,m)}function Ft(t){const e=`payment:${C(t)}`,s=P(S.payment,e);if(s)return s;const a=t.length||1;let o=0,n=0,r=0;(t||[]).forEach(l=>{const{paidStatus:m}=N(l);m==="paid"?o+=1:m==="partial"?n+=1:r+=1});const i=[{label:D("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-paid",filterKey:"paid"},{label:D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:n,percent:Math.round(n/a*100)||0,rawCount:n,className:"status-partial",filterKey:"partial"},{label:D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}];return R(S.payment,e,i)}function At(t,e){const s=`topCustomers:${C(t)}`,a=P(S.topCustomers,s);if(a)return a;const o=new Map,n=new Map((e||[]).map(i=>[String(i.id),i]));t.forEach(i=>{const{statusValue:l}=N(i);if(l==="cancelled")return;const m=String(i?.customerId??"unknown"),d=o.get(m)||{count:0,revenue:0},c=A(i);d.count+=1,d.revenue+=c.finalTotal,o.set(m,d)});const r=Array.from(o.entries()).map(([i,l])=>({name:n.get(i)?.customerName||D("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:l.count,revenue:l.revenue})).sort((i,l)=>l.revenue-i.revenue).slice(0,5);return R(S.topCustomers,s,r)}function Ct(t,e){const s=`topEquipment:${C(t)}`,a=P(S.topEquipment,s);if(a)return a;const o=new Map,n=new Map((e||[]).map(l=>[x(l?.barcode),l])),r=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(l=>{(l?.items||[]).forEach(m=>{const d=x(m?.barcode),c=d?n.get(d):null,u=m?.desc||m?.description||m?.name||c?.desc||c?.description||c?.name||"",p=u&&u.trim()?u:r,f=G(p)||"unknown",g=Number(m?.qty)||1,h=Number(m?.price)||0,b=g*h,w=o.get(f)||{name:p,count:0,revenue:0};w.name=p,w.count+=g,w.revenue+=b,o.set(f,w)})});const i=Array.from(o.values()).sort((l,m)=>m.count!==l.count?m.count-l.count:m.revenue-l.revenue).slice(0,5);return R(S.topEquipment,s,i)}function Pt(){Object.values(S).forEach(t=>t.clear())}function at(t,e,s,a,o){const n=[],r=t?.reservationId||t?.id;r&&n.push(r),t?.notes&&n.push(t.notes);const{statusValue:i,paidStatus:l}=N(t);i&&n.push(i);const m=t?.paymentStatus||t?.payment_status;m&&n.push(m),t?.paid!=null&&n.push(t.paid?"paid":"unpaid"),l&&n.push(l);const d=s.get(String(t?.customerId));d&&n.push(d.customerName,d.company_name||d.companyName,d.contact_person||"");const c=U(t);return c&&n.push(c.title,c.code,c.status),n.push(rt(l)),(t?.items||[]).forEach(p=>{p?.desc&&n.push(p.desc),p?.barcode&&n.push(p.barcode);const f=a.get(x(p?.barcode));f&&n.push(f.desc,f.description,f.name)}),(t?.technicians||[]).forEach(p=>{const f=o.get(String(p));f&&n.push(f.name,f.role,f.department)}),K(n.filter(Boolean).join(" ")).includes(e)}function Rt(t,e,s,a,o){const{startDate:n,endDate:r}=W(e),i=K(e.search),l=!!i,m=new Map((s||[]).map(u=>[String(u.id),u])),d=new Map((a||[]).map(u=>[x(u?.barcode),u])),c=new Map((o||[]).map(u=>[String(u.id),u]));return(t||[]).filter(u=>{if(u&&u.projectId!=null&&String(u.projectId).trim()!=="")return!1;const p=u?.start?new Date(u.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let f=u?.end?new Date(u.end):p;if(Number.isNaN(f.getTime())&&(f=p),n&&f<n||r&&p>r)return!1;const{statusValue:g,confirmed:h,paid:b,paidStatus:w}=N(u);if(e.status==="confirmed"&&!(g==="confirmed"||g==="completed"||h)||e.status==="pending"&&g!=="pending"||e.status==="completed"&&g!=="completed"||e.status==="cancelled"&&g!=="cancelled"||e.payment==="paid"&&!b||e.payment==="unpaid"&&b||e.payment==="partial"&&w!=="partial")return!1;if(e.share&&e.share!=="all"){const M=A(u).companySharePercent>0;if(e.share==="with"&&!M||e.share==="without"&&M)return!1}return!(l&&!at(u,i,m,d,c))})}function rt(t){const e=String(t??"").toLowerCase();return e==="paid"?D("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function xt(t,e){const s=new Map((e||[]).map(n=>[String(n.id),n])),a=new Map;return(t||[]).forEach(n=>{const{statusValue:r}=N(n);if(r==="cancelled")return;const i=O(n.start,n.end),l=Array.isArray(n.crewAssignments)?n.crewAssignments:[];if(l.length){l.forEach(d=>{const c=d?.technicianId!=null?String(d.technicianId):null;if(!c)return;const u=s.get(c)||j(c)||{},p=Number.isFinite(Number(d?.positionClientPrice))&&Number(d.positionClientPrice)>0?Number(d.positionClientPrice):q(u),f=Number.isFinite(Number(d?.positionCost))&&Number(d.positionCost)>0?Number(d.positionCost):k(u),g=p*i,h=f*i,b=a.get(c)||{id:c,name:u?.name||String(c),days:0,billable:0,cost:0};b.days+=i,b.billable+=g,b.cost+=h,a.set(c,b)});return}(Array.isArray(n.technicians)?n.technicians.map(d=>String(d)):[]).forEach(d=>{const c=s.get(d)||j(d)||{},u=q(c),p=k(c),f=u*i,g=p*i,h=a.get(d)||{id:d,name:c?.name||String(d),days:0,billable:0,cost:0};h.days+=i,h.billable+=f,h.cost+=g,a.set(d,h)})}),Array.from(a.values()).map(n=>({...n,net:n.billable-n.cost})).sort((n,r)=>r.net-n.net)}function ot(t=[]){if(!Array.isArray(t)||!t.length)return 0;let e=0;return t.forEach(s=>{const a=Number(s?.amount);Number.isFinite(a)&&a>0&&(e+=a)}),e}function st(t){const e=A(t),s=Number(e.finalTotal||0);let a=Number(t?.paidAmount);if(!Number.isFinite(a)||a<=0){const n=ot(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(n)&&n>0&&(a=n)}if((!Number.isFinite(a)||a<=0)&&Number.isFinite(Number(t?.paidPercent))){const n=Number(t.paidPercent);n>0&&n<=100&&(a=n/100*s)}return Number.isFinite(a)||(a=0),Math.max(0,Math.round((s-a)*100)/100)}function _t(t,e,s=5){const a=new Map((e||[]).map(n=>[String(n.id),n])),o=[];return(t||[]).forEach(n=>{const{paidStatus:r,statusValue:i}=N(n);if(i==="cancelled"||r!=="unpaid"&&r!=="partial")return;const l=st(n);if(!Number.isFinite(l)||l<=0)return;const m=a.get(String(n.customerId));o.push({id:n.id||n.reservationId||"",code:n.reservationCode||n.reservationId||n.id||"",customer:m?.customerName||n.customerName||"",outstanding:l,paidStatus:r})}),o.sort((n,r)=>r.outstanding-n.outstanding).slice(0,s)}export{dt as A,pt as B,ft as C,gt as D,A as a,yt as b,N as c,ht as d,I as e,bt as f,Pt as g,W as h,Rt as i,wt as j,Dt as k,St as l,Nt as m,Tt as n,Mt as o,rt as p,Ft as q,y as r,At as s,D as t,Ct as u,xt as v,_t as w,ut as x,it as y,mt as z};
