import{n as q,d as Ve,q as yt,t as l,b as U,j as v,w as de,x as Ie,h as Ue,A as qt}from"./auth.Dym-pMl4.js";import{n as vt,x as ht}from"./state.CHtcBeE7.js";const Se="select.form-select:not([data-no-enhance]):not([multiple])",N=new WeakMap;let _e=null,He=!1,C=null;function an(e=document){e&&(e.querySelectorAll(Se).forEach(t=>se(t)),!_e&&e===document&&(_e=new MutationObserver(t=>{for(const n of t)n.addedNodes?.forEach(a=>{a instanceof Element&&(a.matches?.(Se)&&se(a),a.querySelectorAll?.(Se).forEach(i=>se(i)))})}),_e.observe(document.body,{childList:!0,subtree:!0})),He||(He=!0,document.addEventListener("pointerdown",_t,{capture:!0})))}function ie(e){if(!(e instanceof HTMLSelectElement))return;if(!e.dataset.enhancedSelect){se(e);return}const t=e.closest(".enhanced-select");t&&(Ne(t),re(t),Be(t))}function se(e){if(!(e instanceof HTMLSelectElement))return;if(e.dataset.enhancedSelect){ie(e);return}if(e.multiple||e.size>1)return;const t=document.createElement("div");t.className="enhanced-select";const n=e.parentNode;n&&n.insertBefore(t,e),t.appendChild(e),e.dataset.enhancedSelect="true",e.classList.add("enhanced-select__native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const a=document.createElement("button");a.type="button",a.className="enhanced-select__trigger",a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const i=document.createElement("ul");i.className="enhanced-select__menu",i.setAttribute("role","listbox"),i.setAttribute("tabindex","-1"),t.append(a,i);const c={select:e,trigger:a,menu:i,observer:null,refreshRaf:null};N.set(t,c),a.addEventListener("click",()=>St(t)),a.addEventListener("keydown",s=>Lt(s,t)),i.addEventListener("click",s=>xt(s,t)),i.addEventListener("keydown",s=>Bt(s,t)),e.addEventListener("change",()=>{re(t),Qe(t)}),c.observer=new MutationObserver(s=>{let r=!1,u=!1;for(const o of s)o.type==="attributes"&&o.attributeName==="disabled"&&(u=!0),o.type==="childList"&&(r=!0);u&&Be(t),r&&Et(c,t)}),c.observer.observe(e,{attributes:!0,attributeFilter:["disabled"],childList:!0}),Ne(t),re(t),Be(t)}function Et(e,t){e&&(e.refreshRaf||(e.refreshRaf=requestAnimationFrame(()=>{e.refreshRaf=null,Ne(t),re(t)})))}function Ne(e){const t=N.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const i=Array.from(n.options||[]),c=document.createDocumentFragment();i.forEach(s=>{const r=document.createElement("li");r.className="enhanced-select__option",r.textContent=s.textContent??s.value??"",r.dataset.value=s.value??"",r.setAttribute("role","option"),r.setAttribute("tabindex","-1"),s.disabled&&(r.setAttribute("aria-disabled","true"),r.classList.add("is-disabled")),s.selected&&(r.setAttribute("aria-selected","true"),r.dataset.selected="true",r.setAttribute("tabindex","0")),c.appendChild(r)}),a.innerHTML="",a.appendChild(c),Qe(e)}function re(e){const t=N.get(e);if(!t)return;const{select:n,trigger:a}=t;if(!n||!a)return;const i=n.selectedOptions?.[0]??n.options?.[n.selectedIndex],c=i?.textContent?.trim()||i?.value||"";a.textContent=c}function Qe(e){const t=N.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const i=n.value;a.querySelectorAll(".enhanced-select__option").forEach(s=>{const r=s.dataset.value===i;s.toggleAttribute("aria-selected",r),s.dataset.selected=r?"true":"",s.setAttribute("tabindex",r?"0":"-1")})}function Be(e){const t=N.get(e);if(!t)return;const{select:n,trigger:a}=t,i=!!n?.disabled;e.classList.toggle("enhanced-select--disabled",i),a.disabled=i}function St(e){N.get(e)&&(e.getAttribute("data-open")==="true"?Q(e):Ke(e))}function Ke(e){const t=N.get(e);if(!t)return;C&&C!==e&&Q(C,{focusTrigger:!1}),e.setAttribute("data-open","true"),t.trigger.setAttribute("aria-expanded","true"),C=e;const n=t.menu.querySelector('.enhanced-select__option[aria-selected="true"]')??t.menu.querySelector(".enhanced-select__option:not([aria-disabled='true'])");n?n.focus():t.menu.focus()}function Q(e,{focusTrigger:t=!0}={}){const n=N.get(e);n&&(e.setAttribute("data-open","false"),n.trigger.setAttribute("aria-expanded","false"),t&&n.trigger.focus({preventScroll:!0}),C===e&&(C=null))}function _t(e){if(!C)return;const t=e.target;t instanceof Node&&(C.contains(t)||Q(C,{focusTrigger:!1}))}function Lt(e,t){const n=e.key;n==="ArrowDown"||n==="ArrowUp"||n===" "||n==="Enter"?(e.preventDefault(),Ke(t)):n==="Escape"&&Q(t)}function Bt(e,t){const n=e.key,a=N.get(t);if(!a)return;const i=Array.from(a.menu.querySelectorAll(".enhanced-select__option:not([aria-disabled='true'])"));if(!i.length)return;const c=i.findIndex(s=>s===document.activeElement);if(n==="ArrowDown"||n==="ArrowUp"){e.preventDefault();const r=(c+(n==="ArrowDown"?1:-1)+i.length)%i.length;i[r].focus()}else if(n==="Home")e.preventDefault(),i[0].focus();else if(n==="End")e.preventDefault(),i[i.length-1].focus();else if(n==="Enter"||n===" "){e.preventDefault();const s=document.activeElement;s&&s.classList.contains("enhanced-select__option")&&ze(s,t)}else n==="Escape"&&(e.preventDefault(),Q(t))}function xt(e,t){const n=e.target?.closest?.(".enhanced-select__option");n&&ze(n,t)}function ze(e,t){const n=N.get(t);if(!n||e.getAttribute("aria-disabled")==="true")return;const{select:a}=n,i=e.dataset.value??"";a.value!==i&&(a.value=i,a.dispatchEvent(new Event("change",{bubbles:!0}))),Q(t)}const me=Object.freeze({change:"reservationEquipmentSelection:change",requestAdd:"reservationEquipmentSelection:requestAdd"});let M=null;function $e(e,t={}){typeof document>"u"||document.dispatchEvent(new CustomEvent(e,{detail:t}))}function Ge(e,t){if(typeof document>"u")return;const{body:n}=document;n&&(e?(n.classList.add("equipment-selection-active"),t&&(n.dataset.equipmentSelectionMode=t)):(n.classList.remove("equipment-selection-active"),n.dataset&&delete n.dataset.equipmentSelectionMode))}function At(e={}){const t={...e};return t.barcode&&(t.barcode=q(String(t.barcode||"").trim())),t.start&&typeof t.start!="string"&&(t.start=String(t.start)),t.end&&typeof t.end!="string"&&(t.end=String(t.end)),t}function sn(e={}){const t=At({...e,activatedAt:Date.now()});return M=t,Ge(!0,t.mode||"create"),$e(me.change,{active:!0,selection:{...t}}),t}function xe(e="manual"){if(!M)return;const t=M;M=null,Ge(!1),$e(me.change,{active:!1,previous:t,reason:e})}function It(){return!!M}function Nt(){return M?{...M}:null}function $t(e){if(!M)return!1;let t;if(typeof e=="string"||typeof e=="number"){const n=q(String(e??"").trim());if(!n)return!1;t={barcodes:[n],quantity:1}}else if(e&&typeof e=="object"){const{barcodes:n,barcode:a,quantity:i,groupKey:c,description:s}=e,r=Array.isArray(n)?n:[];a&&r.push(a);const u=r.map(m=>q(String(m??"").trim())).filter(m=>typeof m=="string"&&m.length>0);if(!u.length)return!1;const o=Number.isInteger(i)&&i>0?i:u.length;t={barcodes:u,quantity:Math.min(o,u.length)},c&&(t.groupKey=c),s&&(t.description=s)}else return!1;return $e(me.requestAdd,{...t,selection:{...M}}),!0}typeof document<"u"&&document.addEventListener("dashboard:tabChanged",e=>{const t=e?.detail?.tabId;!t||t==="equipment-tab"||xe("tab-changed")});const Ct=Ve()||{};let F=(Ct.equipment||[]).map(wt),Ae=!1,P="",X=null,j=null,H=null,pe=!1,Re=!1;function Mt(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function kt(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function wt(e={}){return Ce({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function fe(e={}){return Ce(e)}function Ce(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",i=e.subcategory??e.sub??"",c=Z(e.quantity??e.qty??0),s=ge(e.unit_price??e.price??0),r=q(String(e.barcode??"").trim()),u=E(e.status??e.state??e.status_label??e.statusLabel??"available"),o=e.image_url??e.imageUrl??e.image??"",m=e.name??e.item_name??n,f=e.lessor??e.owner??"";return{id:Tt(t)?String(t):"",category:a,sub:i,desc:n,name:m,qty:c,price:s,barcode:r,status:u,image:o,imageUrl:o,lessor:f,created_at:e.created_at??null,updated_at:e.updated_at??null}}function Tt(e){return e!=null&&e!==""}function Z(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function ge(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function Ft(e){!e||e.dataset.englishDigitsAttached||(e.addEventListener("input",()=>{const{selectionStart:t,selectionEnd:n,value:a}=e,i=q(a);if(i!==a&&(e.value=i,t!=null&&n!=null)){const c=i.length-a.length,s=t+c,r=n+c;e.setSelectionRange(s,r)}}),e.dataset.englishDigitsAttached="true")}function Pe(e){if(!e)return"";const t=q(String(e.barcode??"")).trim();if(t)return t;if(Array.isArray(e.variants))for(const n of e.variants){const a=q(String(n?.barcode??"")).trim();if(a)return a}return""}function Dt(e,t){const n=Pe(e),a=Pe(t);if(!n&&!a)return 0;if(!n)return 1;if(!a)return-1;const i=/^[0-9]+$/,c=i.test(n),s=i.test(a);if(c&&s){if(n.length!==a.length)return n.length-a.length;const o=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(o!==0)return o}else{if(c!==s)return c?-1:1;{const o=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(o!==0)return o}}const r=ce(e?.desc||e?.description||e?.name||""),u=ce(t?.desc||t?.description||t?.name||"");return r.localeCompare(u,"ar",{sensitivity:"base"})}function h(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function E(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":case"Ù…ØªÙˆÙØ±":return"available";case"reserved":case"Ù…Ø­Ø¬ÙˆØ²":case"Ù…Ø¤Ø¬Ø±Ø©":case"rented":return"reserved";case"maintenance":case"ØµÙŠØ§Ù†Ø©":return"maintenance";case"retired":case"Ù…ØªÙˆÙ‚Ù":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"retired";default:return"available"}}function Ot(e){return E(e)}function oe(){if(!It())return null;const e=Nt();return e?{...e}:null}function Xt(e){const t=oe();if(!t)return{active:!1};const n=Array.isArray(e?.variants)&&e.variants.length?e.variants:[e],{start:a,end:i,ignoreReservationId:c=null}=t,s=t?.mode||t?.source||"",r=[],u=new Set;if(n.forEach(g=>{const d=vt(g?.barcode);!d||u.has(d)||(u.add(d),r.push({variant:g,barcode:d}))}),!r.length)return{active:!0,canSelect:!1,reason:l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù")};if(s==="package-manager"||s==="equipment-packages"){const g=Math.max(1,r.length||1);return{active:!0,canSelect:!0,barcode:r[0].barcode,availableBarcodes:r.map(({barcode:d})=>d),maxQuantity:g,reason:""}}const o=r.filter(({variant:g})=>{const d=E(g?.status);return d!=="maintenance"&&d!=="retired"});if(!a||!i)return{active:!0,canSelect:!1,barcode:o[0]?.barcode||r[0].barcode,reason:l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),availableBarcodes:[],maxQuantity:0};const m=o.filter(({barcode:g})=>!ht(g,a,i,c));if(m.length)return{active:!0,canSelect:!0,barcode:m[0].barcode,availableBarcodes:m.map(({barcode:g})=>g),maxQuantity:m.length};let f=l("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");if(o.length>0)f=l("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");else{const g=new Set(r.map(({variant:d})=>E(d?.status)));g.has("maintenance")?f=l("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹"):g.has("reserved")?f=l("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§"):g.has("retired")&&(f=l("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"))}return{active:!0,canSelect:!1,barcode:o[0]?.barcode||r[0].barcode,reason:f,availableBarcodes:[],maxQuantity:0}}function jt(){const e=document.querySelector('[data-tab="reservations-tab"]');e&&(e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.querySelector("#sub-tab-trigger-create-tab")?.click(),document.getElementById("equipment-barcode")?.focus()},200)}))}function We(){if(typeof document>"u")return;const e=document.getElementById("equipment-selection-banner"),t=document.getElementById("equipment-selection-return"),n=document.getElementById("equipment-selection-banner-title"),a=document.getElementById("equipment-selection-banner-hint");if(!e)return;const i=oe();e.hidden=!i;const c=i?.mode||i?.source||"";i?c==="package-manager"||c==="equipment-packages"?(n&&(n.textContent=l("equipment.packages.selection.bannerTitle","ğŸ“¦ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø¯Ø§Øª Ù„Ù„Ø­Ø²Ù…Ø©")),a&&(a.textContent=l("equipment.packages.selection.bannerHint","Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø²Ù…Ø©.")),t&&(t.textContent=l("equipment.packages.selection.doneButton","âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø²Ù…Ø©"))):(n&&(n.textContent=l("reservations.create.equipment.selector.bannerTitle","ğŸ”— Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø¯Ø§Øª Ù„Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯")),a&&(a.textContent=l("reservations.create.equipment.selector.bannerHint","Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… Ø£Ø¶Ù Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¬Ø².")),t&&(t.textContent=l("reservations.create.equipment.selector.returnButton","â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²"))):(n&&(n.textContent=l("reservations.create.equipment.selector.bannerTitle","ğŸ”— Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø¯Ø§Øª Ù„Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯")),a&&(a.textContent=l("reservations.create.equipment.selector.bannerHint","Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… Ø£Ø¶Ù Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¬Ø².")),t&&(t.textContent=l("reservations.create.equipment.selector.returnButton","â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²"))),i&&t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const r=oe(),u=r?.mode||r?.source||"";u==="package-manager"||u==="equipment-packages"?xe("package-finish-button"):(xe("return-button"),jt())}),t.dataset.listenerAttached="true")}function _(){return F}function R(e){F=Array.isArray(e)?e.map(Ce):[],Ue({equipment:F}),kt()}function ce(e){return String(e??"").trim().toLowerCase()}function D(e){if(!e)return"";const t=e.desc||e.description||e.name||"";let n=ce(t);return n||(n=ce(e.category||"")),n||(n=q(String(e.barcode||"")).trim().toLowerCase()),n}function be(e){const t=D(e);return t?_().filter(n=>D(n)===t):[]}function J(e){const t=document.getElementById("equipment-details-cover");if(!t)return;const n=ee(e);if(n){const a=h(e.desc||e.description||e.name||"");t.innerHTML=`<img src="${h(n)}" alt="${a}">`,t.classList.add("has-image")}else t.innerHTML='<span class="equipment-details-header__placeholder" aria-hidden="true">ğŸ“¦</span>',t.classList.remove("has-image")}function Ye(e){const t=document.getElementById("equipment-lessor-badge");if(!t)return;const n=(e?.lessor||"").trim();if(n){const a=l("equipment.modal.labels.lessor","ğŸ¢ Ø§Ù„Ù…Ø¤Ø¬Ø±");t.textContent=`${a}: ${n}`,t.hidden=!1}else t.hidden=!0,t.textContent="ğŸ¢"}function Me(){return{category:document.getElementById("edit-equipment-category"),subcategory:document.getElementById("edit-equipment-subcategory"),description:document.getElementById("edit-equipment-description"),quantity:document.getElementById("edit-equipment-quantity"),price:document.getElementById("edit-equipment-price"),image:document.getElementById("edit-equipment-image"),barcode:document.getElementById("edit-equipment-barcode"),status:document.getElementById("edit-equipment-status"),lessor:document.getElementById("edit-equipment-lessor")}}function ue(){const e=Me();return{category:e.category?.value??"",subcategory:e.subcategory?.value??"",description:e.description?.value??"",quantity:e.quantity?.value??"",price:e.price?.value??"",image:e.image?.value??"",barcode:e.barcode?.value??"",status:e.status?.value??"",lessor:e.lessor?.value??""}}function ke(e={}){const t=Me();t.category&&(t.category.value=e.category??""),t.subcategory&&(t.subcategory.value=e.subcategory??""),t.description&&(t.description.value=e.description??""),t.quantity&&(t.quantity.value=e.quantity!=null?q(String(e.quantity)):""),t.price&&(t.price.value=e.price!=null?q(String(e.price)):""),t.image&&(t.image.value=e.image??""),t.barcode&&(t.barcode.value=e.barcode??""),t.status&&(t.status.value=e.status??""),t.lessor&&(t.lessor.value=e.lessor??"")}function V(e){pe=e;const t=Me(),n=document.getElementById("equipment-edit-cancel"),a=document.getElementById("save-equipment-changes"),i=document.getElementById("edit-equipment-form");if(i&&i.classList.toggle("equipment-details-form--editing",e),[t.category,t.subcategory,t.description,t.quantity,t.price,t.image,t.lessor].forEach(s=>{s&&(e?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"))}),n&&(n.hidden=!e,n.disabled=!e),a){a.disabled=!1;const s=e?"equipment.modal.actions.save":"equipment.modal.actions.edit",r=e?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"âœï¸ ØªØ¹Ø¯ÙŠÙ„";a.textContent=l(s,r),a.dataset.mode=e?"save":"view"}if(e){const s=t.description||t.category||t.subcategory;s&&setTimeout(()=>{s.focus(),typeof s.select=="function"&&s.select()},0)}}async function Ht(e){if(!de()){Ie();return}if(!e)return;try{await Ze()}catch(n){console.error("âŒ [equipment.js] Unable to load XLSX",n),alert(l("equipment.toast.xlsxMissing","âš ï¸ Ù…ÙƒØªØ¨Ø© Excel (XLSX) ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),i=XLSX.read(a,{type:"array"}),c=i.Sheets[i.SheetNames[0]],s=XLSX.utils.sheet_to_json(c,{defval:""});if(!Array.isArray(s)||s.length===0){v(l("equipment.toast.uploadEmpty","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"));return}const r=[];let u=0;if(s.forEach(o=>{const m=o.Ø§Ù„Ù‚Ø³Ù…??o.category??"",f=o["Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"]??o.subcategory??"",g=o.Ø§Ù„ÙˆØµÙ??o.description??o.name??"",d=o.Ø§Ù„ÙƒÙ…ÙŠØ©??o.quantity??0,b=o.Ø§Ù„Ø³Ø¹Ø±??o.price??0,p=o.Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯??o.barcode??"",y=o.Ø§Ù„ØµÙˆØ±Ø©??o.image_url??o.image??"",S=o.Ø§Ù„Ù…Ø¤Ø¬Ø±??o["Ø§Ù„Ù…Ø¤Ø¬Ø± "]??o.Lessor??o.lessor??o.lessor??"",B=q(String(p||"")).trim();if(!g||!B){u+=1;return}r.push(we({category:m,subcategory:f,description:g,quantity:d,unit_price:b,barcode:B,image_url:y,lessor:S}))}),!r.length){v(l("equipment.toast.uploadEmpty","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"));return}try{const o=await U("/equipment/?bulk=1&update_existing=1&skip_duplicates=1",{method:"POST",body:r}),m=Array.isArray(o?.data)?o.data.map(fe):[];if(m.length){const y=[..._(),...m];R(y)}await te({showToastOnError:!1}),L();const f=o?.meta?.count??m.length,g=Number(o?.meta?.skipped_duplicates||0),d=Number(o?.meta?.updated||0),b=[];f&&b.push(`${f} âœ”ï¸`),d&&b.push(`${d} ğŸ”`);const p=(u||0)+g;p&&b.push(`${p} âš ï¸`),v(l("equipment.toast.uploadSuccess","âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")+(b.length?` (${b.join(" / ")})`:""))}catch(o){const m=K(o,"equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„");v(m,"error")}}catch(a){console.error("âŒ [equipment.js] Failed to process Excel file",a),v(l("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")}},t.onerror=function(){console.error("âŒ [equipment.js] FileReader error",t.error),v(l("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")},t.readAsArrayBuffer(e)}async function Je({onlyAvailable:e=!1}={}){try{await Ze()}catch(d){console.error("âŒ [equipment.js] Unable to load XLSX for download",d),v(l("equipment.toast.xlsxMissing","âš ï¸ Ù…ÙƒØªØ¨Ø© Excel (XLSX) ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©."));return}const n=_().filter(d=>e?E(d.status)==="available":!0).map(d=>({Ø§Ù„Ù‚Ø³Ù…:d.category||"","Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ":d.sub||"",Ø§Ù„ÙˆØµÙ:d.desc||d.description||d.name||"",Ø§Ù„ÙƒÙ…ÙŠØ©:Number.isFinite(Number(d.qty))?Number(d.qty):0,Ø§Ù„Ø³Ø¹Ø±:Number.isFinite(Number(d.price))?Number(d.price):0,Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:d.barcode||"",Ø§Ù„ØµÙˆØ±Ø©:ee(d)||"",Ø§Ù„Ù…Ø¤Ø¬Ø±:d.lessor||""})),a=XLSX.utils.json_to_sheet(n),i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,a,"Equipment");const c=d=>String(d).padStart(2,"0"),s=new Date,r=s.getFullYear(),u=c(s.getMonth()+1),o=c(s.getDate()),m=c(s.getHours()),f=c(s.getMinutes()),g=`${e?"equipment-available":"equipment-all"}-${r}${u}${o}-${m}${f}.xlsx`;try{XLSX.writeFile(i,g,{compression:!0})}catch(d){console.error("âŒ [equipment.js] Failed to generate Excel file",d),v(l("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")}}const Rt="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let Y=null;function Ze(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):Y||(Y=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",i,{once:!0}),n.addEventListener("error",c,{once:!0});return}const a=document.createElement("script");a.src=Rt,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",i,{once:!0}),a.addEventListener("error",c,{once:!0}),document.head.appendChild(a);function i(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function c(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("âš ï¸ [equipment.js] ensureXLSXLoaded failed",e),Y=null,e}),Y)}function we({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:i=0,barcode:c="",status:s="Ù…ØªØ§Ø­",image_url:r="",lessor:u=""}){const o=q(String(c||"")).trim(),m=Ot(s);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:Z(a),unit_price:ge(i),barcode:o,status:m,image_url:r?.trim()||null,lessor:(typeof u=="string"?u.trim():"")||null}}async function et(){if(!de()){Ie();return}if(confirm(l("equipment.toast.clearConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§ØªØŸ")))try{const t=(await U("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await te({showToastOnError:!1}),v(l("equipment.toast.clearSuccess","ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")+(t?` (${t})`:""))}catch(e){const t=K(e,"equipment.toast.clearFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");v(t,"error")}}function ee(e){return e.image||e.imageUrl||e.img||""}function Pt(e){const t=E(e),n={available:{label:l("equipment.form.options.available","âœ… Ù…ØªØ§Ø­"),className:"equipment-status-badge equipment-status-badge--available"},reserved:{label:l("equipment.form.options.booked","ğŸ“Œ Ù…Ø­Ø¬ÙˆØ²"),className:"equipment-status-badge equipment-status-badge--reserved"},maintenance:{label:l("equipment.form.options.maintenance","ğŸ› ï¸ ØµÙŠØ§Ù†Ø©"),className:"equipment-status-badge equipment-status-badge--maintenance"},retired:{label:l("equipment.form.options.retired","ğŸ“¦ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©"),className:"equipment-status-badge equipment-status-badge--retired"}},{label:a,className:i}=n[t]||{label:e||"-",className:"equipment-status-badge equipment-status-badge--default"};return`<span class="${i}">${a}</span>`}function le(){const e=document.getElementById("equipment-variants-section"),t=document.getElementById("equipment-variants-table-body"),n=document.getElementById("equipment-variants-count");if(e&&(e.hidden=!0),t){const a=l("equipment.modal.variants.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ Ù…Ø±ØªØ¨Ø·Ø© Ø£Ø®Ø±Ù‰.");t.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${h(a)}</td></tr>`}n&&(n.textContent="0")}function tt(e){const t=document.getElementById("equipment-variants-section"),n=document.getElementById("equipment-variants-table-body"),a=document.getElementById("equipment-variants-count");if(!t||!n||!e)return;const c=X?.groupKey||D(e);if(!c){le();return}const s=_().filter(f=>D(f)===c).sort((f,g)=>{const d=String(f.barcode||"").trim(),b=String(g.barcode||"").trim();return!d&&!b?0:d?b?d.localeCompare(b,"ar",{numeric:!0,sensitivity:"base"}):-1:1});if(!s.length){le();return}t.hidden=!1,a&&(a.textContent=String(s.length));const r=l("equipment.modal.variants.current","Ø§Ù„Ø­Ø§Ù„ÙŠ"),u=l("equipment.form.labels.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),o=_(),m=s.map(f=>{const g=f.id&&e.id?String(f.id)===String(e.id):String(f.barcode||"")===String(e.barcode||""),d=g?"equipment-variants-table__row--current":"",b=h(String(f.barcode||"-")),p=g?`<span class="equipment-variants-current-badge">${h(r)}</span>`:"",y=q(String(Number.isFinite(Number(f.qty))?Number(f.qty):0)),S=o.indexOf(f),B=h(l("equipment.item.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù")),k=S>=0?`<div class="table-action-buttons equipment-variant-actions">
            <button type="button" class="btn btn-sm btn-error equipment-variant-action equipment-variant-action--danger" data-variant-action="delete" data-variant-index="${S}">${B}</button>
          </div>`:"";return`
        <tr class="${d}">
          <td>
            ${b}
            ${p}
          </td>
          <td>${Pt(f.status)}</td>
          <td>
            <span class="equipment-variants-qty" title="${h(u)}">${y}</span>
          </td>
          <td class="table-actions-cell">${k}</td>
        </tr>
      `}).join("");n.innerHTML=m}function Vt({item:e,index:t}){const n=ee(e),a=l("equipment.item.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),i=l("equipment.item.imageAlt","ØµÙˆØ±Ø©"),c=l("equipment.item.currency","SR"),s=de(),r={description:l("equipment.card.labels.description","Ø§Ù„ÙˆØµÙ"),status:l("equipment.card.labels.status","Ø§Ù„Ø­Ø§Ù„Ø©"),alias:l("equipment.card.labels.alias","Ø§Ù„Ø§Ø³Ù…"),quantity:l("equipment.card.labels.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),price:l("equipment.card.labels.price","Ø§Ù„Ø³Ø¹Ø±"),category:l("equipment.card.labels.category","Ø§Ù„Ù‚Ø³Ù…"),subcategory:l("equipment.card.labels.subcategory","Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"),barcode:l("equipment.card.labels.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),available:l("equipment.card.labels.available","Ù…ØªØ§Ø­")},u=Number.isFinite(Number(e.qty))?Number(e.qty):0,o=Number.isFinite(Number(e.price))?Number(e.price):0,m=u.toLocaleString("en-US"),f=o.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),g=Number.isFinite(Number(e.reservedQty))?Number(e.reservedQty):0,d=Number.isFinite(Number(e.maintenanceQty))?Number(e.maintenanceQty):0,b=Number.isFinite(Number(e.availableQty))?Number(e.availableQty):Math.max(u-g-d,0),p=b.toLocaleString("en-US"),y=l("equipment.card.labels.availableOfTotal","Ù…Ù† Ø£ØµÙ„"),S=E(e.status);let B=`${h(r.available)}: ${h(p)} ${h(y)} ${h(m)}`,k="available";if(b===0){const $={reserved:{text:u===1?l("equipment.card.availability.reservedSingle","Ù…Ø¤Ø¬Ø±Ø©"):l("equipment.card.availability.reserved","Ù…Ø¤Ø¬Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"),modifier:"reserved"},maintenance:{text:l("equipment.card.availability.maintenance","ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©"),modifier:"maintenance"},retired:{text:l("equipment.card.availability.retired","ØºÙŠØ± Ù…ØªØ§Ø­Ø©"),modifier:"retired"},default:{text:l("equipment.card.availability.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"),modifier:"unavailable"}},I=$[S]||$.default;B=h(I.text),k=I.modifier}const w=`<span class="equipment-card__availability equipment-card__availability--${k}">${B}</span>`,z="",O=e.desc||e.name||"â€”",x=e.name&&e.name!==e.desc?e.name:"",ne=`
    <div class="equipment-card__info-row equipment-card__info-row--center">
      ${[{label:r.quantity,value:m},{label:r.price,value:`${f} ${c}`}].map(({label:$,value:I})=>`
            <span class="equipment-card__info-item equipment-card__info-item--stacked">
              <span class="equipment-card__detail-label">${$}</span>
              <span class="equipment-card__detail-value">${I}</span>
            </span>
          `).join("")}
    </div>`,G=[e.category?{label:r.category,value:e.category}:null,e.sub?{label:r.subcategory,value:e.sub}:null].filter(Boolean),rt=G.length?`<div class="equipment-card__categories">${G.map(({label:$,value:I})=>`
            <div class="equipment-card__category">
              <span class="equipment-card__detail-label">${$}</span>
              <span class="equipment-card__detail-value">${I}</span>
            </div>
          `).join("")}</div>`:"",ot=x?`<div class="equipment-card__alias">
        <span class="equipment-card__detail-label">${r.alias}</span>
        <span class="equipment-card__detail-value">${x}</span>
      </div>`:"",ct=`
    <div class="equipment-card__details">
      ${`
    <div class="equipment-card__description">
      <span class="equipment-card__label">${r.description}</span>
      <h3 class="equipment-card__title">${O}</h3>
    </div>
  `}
      ${ne}
    </div>
  `,ye=[],A=Xt(e),Te=A?.availableBarcodes?.length?A.availableBarcodes.join(","):A?.barcode?A.barcode:"";let qe="",ve="";if(A.active){const $=`equipment-select-qty-${t}`,I=!!A.canSelect,he=I?Math.max(1,Number(A.maxQuantity||A.availableBarcodes?.length||1)):1,lt=Math.max(1,Math.min(he,99)),De=[];for(let W=1;W<=lt;W+=1){const bt=q(String(W));De.push(`<option value="${W}"${W===1?" selected":""}>${bt}</option>`)}const dt=I?"":" disabled",mt=l("reservations.create.equipment.selector.quantityLabel","Ø§Ù„ÙƒÙ…ÙŠØ©"),Oe=I?`${l("reservations.create.equipment.selector.availableHint","Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©")}: ${q(String(he))}`:A.reason?A.reason:"";qe=`
      <div class="equipment-card__selection-controls">
        <label class="equipment-card__selection-label" for="${$}">${mt}</label>
        <select class="equipment-card__quantity-select" id="${$}" data-equipment-select-quantity${dt}>
          ${De.join("")}
        </select>
        ${Oe?`<span class="equipment-card__selection-hint">${h(Oe)}</span>`:""}
      </div>
    `;const Xe=oe(),je=Xe?.mode||Xe?.source||"",pt=je==="package-manager"||je==="equipment-packages"?l("equipment.packages.selection.addToPackage","â• Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø²Ù…Ø©"):l("reservations.create.equipment.selector.addToReservation","â• Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²"),ft=I?"":" disabled",gt=A.reason?` title="${h(A.reason)}"`:"",Ee=['data-equipment-action="select-reservation"',`data-selection-max="${I?he:0}"`];Te&&Ee.push(`data-selection-barcodes="${h(Te)}"`),e.groupKey&&Ee.push(`data-selection-group="${h(String(e.groupKey))}"`),ve=`
      <button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--select" ${Ee.join(" ")}${ft}${gt}>${pt}</button>
    `}s&&ye.push(`<button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--delete" data-equipment-action="delete" data-equipment-index="${t}">${a}</button>`);const Fe=ye.length?ye.join(`
`):"",ut=h(O);return`
    <article
      class="equipment-card"
      data-equipment-index="${t}"
      ${e.groupKey?`data-equipment-group-key="${h(String(e.groupKey))}"`:""}
      data-equipment-card="true"
      role="listitem"
      tabindex="0"
      aria-label="${ut}"
    >
      <div class="equipment-card__header">
      <div class="equipment-card__status-block">
        ${z}
        ${w}
      </div>
        <div class="equipment-card__media-wrapper">
          <div class="equipment-card__media" aria-hidden="true">
            ${n?`<img src="${n}" alt="${i}" loading="lazy">`:'<div class="equipment-card__placeholder">ğŸ“¦</div>'}
          </div>
          ${ct}
        </div>
      </div>
      <div class="equipment-card__body">
        ${rt}
        ${ot}
      </div>
      ${qe||ve||Fe?`<div class="equipment-card__actions equipment-card__actions--center">
            ${qe}
            ${ve}
            ${Fe}
          </div>`:""}
    </article>
  `}function Ut(e){const t=[...new Set(e.map(s=>s.category).filter(Boolean))],n=[...new Set(e.map(s=>s.sub).filter(Boolean))],a=document.getElementById("filter-category"),i=document.getElementById("filter-sub");if(a){const s=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(r=>{const u=document.createElement("option");u.value=r,u.textContent=r,a.appendChild(u)}),t.includes(s)&&(a.value=s),ie(a)}if(i){const s=i.value;for(;i.options.length>1;)i.remove(1);n.forEach(r=>{const u=document.createElement("option");u.value=r,u.textContent=r,i.appendChild(u)}),n.includes(s)&&(i.value=s),ie(i)}const c=document.getElementById("filter-status");c&&ie(c)}function nt(){const e=Ve();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return F=t||[],F;const i=new Date;let c=!1;const s=new Set((a||[]).filter(u=>u?.status==="open").map(u=>q(String(u?.equipmentBarcode??"")).trim().toLowerCase())),r=t.map(u=>{if(!u)return u;const o=E(u.status),m=q(String(u.barcode??"")).trim().toLowerCase(),f=m&&s.has(m);let g=f?"maintenance":"available";if(!f&&m)for(const d of n||[]){if(!Qt(d,i))continue;if(d.items?.some(p=>q(String(p?.barcode??"")).trim().toLowerCase()===m)){g="reserved";break}}return g!==o?(c=!0,{...u,status:g}):{...u,status:g}});return c?R(r):(F=r,Ue({equipment:F})),F}function Qt(e,t){if(!e?.start||!e?.end)return!1;const n=String(e?.status||e?.reservationStatus||"").toLowerCase();if(n==="cancelled"||n==="canceled")return!1;const a=new Date(e.start),i=new Date(e.end);return Number.isNaN(a.getTime())||Number.isNaN(i.getTime())?!1:a<=t&&t<i}function Le(e,{tone:t="",icon:n="ğŸ“¦"}={}){const a=["equipment-empty-state"];return t&&a.push(`equipment-empty-state--${t}`),`
    <div class="${a.join(" ")}">
      <div class="equipment-empty-state__icon" aria-hidden="true">${n}</div>
      <p class="equipment-empty-state__text">${e}</p>
    </div>
  `}function L(){const e=document.getElementById("equipment-list");if(!e)return;We();const t=nt(),n=Array.isArray(t)?t:_(),a=new Map;n.forEach(p=>{if(!p)return;const y=D(p);y&&(a.has(y)||a.set(y,[]),a.get(y).push(p))});const i=Array.from(a.values()).map(p=>{const y=p[0],S=p.reduce((x,T)=>x+(Number.isFinite(Number(T.qty))?Number(T.qty):0),0),B=["maintenance","reserved","available","retired"],k=p.map(x=>E(x.status)).sort((x,T)=>B.indexOf(x)-B.indexOf(T))[0]||"available",w=p.reduce((x,T)=>{const ne=Z(T?.qty??0)||0,G=E(T?.status);return G==="reserved"?x.reserved+=ne:G==="maintenance"&&(x.maintenance+=ne),x},{reserved:0,maintenance:0}),z=Math.max(S-w.reserved-w.maintenance,0);return{item:{...y,qty:S,status:k,variants:p,groupKey:D(y),reservedQty:w.reserved,maintenanceQty:w.maintenance,availableQty:z},index:n.indexOf(y)}});i.sort((p,y)=>Dt(p.item,y.item));const c=document.getElementById("search-equipment")?.value||"",s=q(c).toLowerCase().trim(),r=document.getElementById("filter-category")?.value||"",u=document.getElementById("filter-sub")?.value||"",o=document.getElementById("filter-status")?.value||"",m=o?E(o):"";if(Ae&&!n.length){e.innerHTML=Le(l("equipment.list.loading","â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª..."),{icon:"â³"});return}if(P&&!n.length){e.innerHTML=Le(P,{tone:"error",icon:"âš ï¸"});return}const f=i.filter(({item:p})=>{const y=q(String(p.barcode??"")).toLowerCase().trim(),S=Array.isArray(p.variants)?p.variants.map(O=>q(String(O.barcode??"")).toLowerCase().trim()).filter(Boolean):[],B=!s||p.name&&p.name.toLowerCase().includes(s)||p.desc&&p.desc.toLowerCase().includes(s)||y&&y.includes(s)||S.some(O=>O.includes(s))||p.category&&p.category.toLowerCase().includes(s)||p.sub&&p.sub.toLowerCase().includes(s),k=!r||p.category===r,w=!u||p.sub===u,z=!m||E(p.status)===m;return B&&k&&w&&z}),g=s?l("equipment.list.emptyFiltered","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©."):l("equipment.list.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯."),d=f;e.innerHTML=d.length?d.map(Vt).join(""):Le(g);const b=document.getElementById("equipment-list-count");if(b){const p=l("equipment.list.countSuffix","Ø¹Ù†ØµØ±"),y=q(String(d.length)),S=d.length?`${y} ${p}`:`0 ${p}`;b.textContent=S}Ut(n)}async function te({showToastOnError:e=!0}={}){Ae=!0,P="",L();try{const t=await U("/equipment/?all=1"),n=t?.data??t;let a=[];Array.isArray(n)?a=n:n&&typeof n=="object"&&(Array.isArray(n.items)?a=n.items:Array.isArray(n.results)?a=n.results:Array.isArray(n.data)?a=n.data:Array.isArray(n.records)&&(a=n.records));const i=a.map(fe);R(i)}catch(t){t&&typeof t=="object"&&Number(t.status)===401?P="":(P=K(t,"equipment.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),e&&v(P,"error"))}finally{Ae=!1,L()}}function K(e,t,n){if(e instanceof qt){const a=e.payload?.errors;if(a&&typeof a=="object"){const i=Object.values(a)[0];if(Array.isArray(i))return i[0];if(typeof i=="string")return i}if(e.message)return e.message}return l(t,n)}async function Kt(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",i=q(a).trim(),c=ge(t.querySelector("#new-equipment-price")?.value||"0"),s=Z(t.querySelector("#new-equipment-qty")?.value||"1"),r=t.querySelector("#new-equipment-image")?.value?.trim()||"",u=t.querySelector("#new-equipment-category")?.value?.trim()||"",o=t.querySelector("#new-equipment-sub")?.value?.trim()||"",m=t.querySelector("#new-equipment-lessor")?.value?.trim()||"",f=t.querySelector("#new-equipment-status")?.value||"Ù…ØªØ§Ø­";if(!n||!i){v(l("equipment.toast.missingFields","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"));return}const g=we({category:u,subcategory:o,description:n,quantity:s,unit_price:c,barcode:i,status:f,image_url:r,lessor:m});try{const d=await U("/equipment/",{method:"POST",body:g}),b=fe(d?.data),p=[..._(),b];R(p),L(),t.reset();const y=t.querySelector("#new-equipment-status");y&&(y.value="Ù…ØªØ§Ø­"),v(l("equipment.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø©"))}catch(d){const b=K(d,"equipment.toast.addFailed","ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø©");v(b,"error")}}async function at(e){if(!de()){Ie();return}const t=_(),n=t[e];if(n&&confirm(l("equipment.toast.deleteConfirm","âŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø©ØŸ")))try{n.id&&await U(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),R(a),L(),v(l("equipment.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø¯Ø©"))}catch(a){const i=K(a,"equipment.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹");v(i,"error")}}async function zt(e,t){const n=_(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const c=[...n];c[e]={...c[e],...t},R(c),L();return}const i=we({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image,lessor:t.lessor});try{const c=await U(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:i}),s=fe(c?.data),r=[...n];r[e]=s,R(r),L(),v(l("equipment.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­"))}catch(c){const s=K(c,"equipment.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©");throw v(s,"error"),c}}function ae(){L()}function it(e){const n=_()[e];if(!n)return;j=e;const a=be(n),i=a[0]||n,c=a.reduce((u,o)=>u+(Number.isFinite(Number(o.qty))?Number(o.qty):0),0),s=["maintenance","reserved","available","retired"],r=a.map(u=>E(u.status)).sort((u,o)=>s.indexOf(u)-s.indexOf(o))[0]||E(i.status);document.getElementById("edit-equipment-index").value=e,ke({category:i.category||"",subcategory:i.sub||"",description:i.desc||i.description||"",quantity:String(c||i.qty||0),price:i.price!=null?String(i.price):"0",image:ee(i)||"",barcode:i.barcode||"",status:i.status||r,lessor:i.lessor||""}),V(!1),H=ue(),J(i),Ye(i),tt(i),X={groupKey:D(i),barcode:String(i.barcode||""),id:i.id||null},Mt(document.getElementById("editEquipmentModal"))?.show()}function Gt(e){const t=e.target.closest('[data-equipment-action="select-reservation"]');if(t){e.preventDefault(),e.stopPropagation();const i=t.closest('[data-equipment-card="true"]'),c=i?.querySelector("[data-equipment-select-quantity]");let s=Number.parseInt(c?.value||"1",10);(!Number.isFinite(s)||s<=0)&&(s=1);const r=Number.parseInt(t.dataset.selectionMax||"0",10);Number.isFinite(r)&&r>0&&s>r&&(s=r);const o=(t.dataset.selectionBarcodes||"").split(",").map(d=>d.trim()).filter(d=>d.length>0),m=i?.querySelector(".equipment-card__title")?.textContent?.trim()||"",f=i?.dataset.equipmentGroupKey||t.dataset.selectionGroup||"";$t({barcodes:o,quantity:s,groupKey:f,description:m})||v(l("reservations.create.equipment.selector.selectionInactive","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¬Ø² ÙˆØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯"));return}if(e.target.closest("[data-equipment-select-quantity]")||e.target.closest(".equipment-card__selection-controls"))return;const n=e.target.closest('[data-equipment-action="delete"]');if(n){e.preventDefault(),e.stopPropagation();const i=Number(n.dataset.equipmentIndex);Number.isNaN(i)||at(i).catch(c=>{console.error("âŒ [equipment.js] deleteEquipment",c)});return}const a=e.target.closest('[data-equipment-card="true"]');if(a){const i=Number(a.dataset.equipmentIndex);Number.isNaN(i)||it(i)}}function Wt(e){if(e.defaultPrevented||e.target.closest("[data-equipment-action]")||e.target.matches("[data-equipment-select-quantity]")||e.target.closest(".equipment-card__selection-controls"))return;const t=e.target.closest('[data-equipment-card="true"]');if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const n=Number(t.dataset.equipmentIndex);Number.isNaN(n)||it(n)}}function Yt(e){const t=e.target.closest('[data-variant-action="delete"]');if(t){const n=Number(t.dataset.variantIndex);Number.isNaN(n)||at(n).catch(a=>{console.error("âŒ [equipment.js] deleteEquipment",a)});return}}function st(){if(!X||!document.getElementById("editEquipmentModal")?.classList.contains("show"))return;const n=_(),a=X.id?n.find(u=>String(u.id)===String(X.id)):null,i=X.groupKey,c=i?n.find(u=>D(u)===i):null,s=a||c;if(!s){le();return}const r=n.findIndex(u=>u===s);if(r>=0){const u=document.getElementById("edit-equipment-index");u&&(u.value=String(r)),j=r}if(tt(s),J(s),Ye(s),!pe){const u=be(s),o=u[0]||s,m=u.reduce((d,b)=>d+(Number.isFinite(Number(b.qty))?Number(b.qty):0),0),f=["maintenance","reserved","available","retired"],g=u.map(d=>E(d.status)).sort((d,b)=>f.indexOf(d)-f.indexOf(b))[0]||E(o.status);ke({category:o.category||"",subcategory:o.sub||"",description:o.desc||o.description||"",quantity:String(m||o.qty||0),price:o.price!=null?String(o.price):"0",image:ee(o)||"",barcode:o.barcode||"",status:o.status||g,lessor:o.lessor||""}),H=ue()}J(primary)}function Jt(){document.getElementById("search-equipment")?.addEventListener("input",ae),document.getElementById("filter-category")?.addEventListener("change",ae),document.getElementById("filter-sub")?.addEventListener("change",ae),document.getElementById("filter-status")?.addEventListener("change",ae),document.getElementById("add-equipment-form")?.addEventListener("submit",Kt);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",i=>{i.preventDefault(),et().catch(c=>{console.error("âŒ [equipment.js] clearEquipment",c)})}),e.dataset.listenerAttached="true");const t=document.getElementById("excel-download-trigger");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",i=>{i.preventDefault(),Je().catch(c=>{console.error("âŒ [equipment.js] downloadEquipmentToExcel",c)})}),t.dataset.listenerAttached="true");const n=document.getElementById("equipment-list");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Gt),n.addEventListener("keydown",Wt),n.dataset.listenerAttached="true");const a=document.getElementById("equipment-variants-table-body");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Yt),a.dataset.listenerAttached="true"),["edit-equipment-quantity","edit-equipment-price","edit-equipment-barcode"].forEach(i=>{const c=document.getElementById(i);Ft(c)})}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{if(!pe){H=ue(),V(!0);return}const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){v(l("equipment.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:Z(document.getElementById("edit-equipment-quantity").value)||1,price:ge(document.getElementById("edit-equipment-price").value)||0,barcode:q(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value,lessor:document.getElementById("edit-equipment-lessor").value};try{await zt(t,n),H=ue(),V(!1),st()}catch(a){console.error("âŒ [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{Jt(),L(),te();const e=document.getElementById("equipment-edit-cancel");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{if(H&&ke(H),j!=null){const a=_()[j];if(a){const c=be(a)[0]||a;J(c)}}V(!1)}),e.dataset.listenerAttached="true");const t=document.getElementById("save-equipment-changes");t&&!t.dataset.listenerAttached&&(t.dataset.listenerAttached="true",t.dataset.mode||(t.dataset.mode="view"))});document.addEventListener("language:changed",()=>{if(L(),V(pe),j!=null){const t=_()[j];if(t){const a=be(t)[0]||t;J(a)}}});document.addEventListener("equipment:refreshRequested",()=>{te({showToastOnError:!1})});document.addEventListener(yt.USER_UPDATED,()=>{L()});document.addEventListener("equipment:changed",()=>{st()});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editEquipmentModal");e&&!e.dataset.variantsListenerAttached&&(e.addEventListener("hidden.bs.modal",()=>{X=null,le(),j=null,H=null,V(!1)}),e.dataset.variantsListenerAttached="true")});typeof document<"u"&&!Re&&(document.addEventListener(me.change,()=>{We(),L()}),Re=!0);const rn=Object.freeze(Object.defineProperty({__proto__:null,clearEquipment:et,downloadEquipmentToExcel:Je,refreshEquipmentFromApi:te,renderEquipment:L,syncEquipmentStatuses:nt,uploadEquipmentFromExcel:Ht},Symbol.toStringTag,{value:"Module"}));export{me as E,sn as a,It as b,xe as c,te as d,rn as e,an as i,L as r,nt as s,Ht as u};
