import{t as c,r as L,f as nt,c as at,p as st,a as it,b as $,d as J,e as ct}from"./calculations.Cuzjzmo7.js";import{e as pt}from"./reports.50AL4XDN.js";import{s as lt,c as dt,d as mt,q as ut}from"./controller.CKj9uBP3.js";import{n as V}from"./auth.DEm-O4iH.js";import"./reservationsService.DHFcI6wO.js";import"./dashboard.BVJwjZhW.js";/* empty css              */import"./dashboardShell.BJ8UOETr.js";import"./customers.DDv-F3VN.js";import"./maintenanceService.-sdg2Aq9.js";const X=96,U=25.4,K=210,ft=297,N=Math.round(K/U*X),H=Math.round(ft/U*X),j=X/U,ht=/safari/i,gt=/(iphone|ipad|ipod)/i,bt=/(crios|fxios|edgios|opios)/i;function yt(){try{const o=navigator.userAgent||"";return gt.test(o)&&ht.test(o)&&!bt.test(o)}catch{return!1}}function xt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function wt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const r=document.createElement("style");r.textContent=String(ut).trim(),t.appendChild(r);const s=document.createElement("div");s.className="quote-preview-pages",s.setAttribute("data-quote-pages",""),t.appendChild(s);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function Q(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function Y({rightMm:o,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function vt(o){try{const t=Q(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const s="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${s}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(r,e);const m=()=>{const f=Number(r.querySelector("[data-rpt-right]").value),i=Number(r.querySelector("[data-rpt-top]").value),v=Number(r.querySelector("[data-rpt-scale]").value),h=Math.max(.9,Math.min(1,v/100));Y({rightMm:f,topMm:i,scale:h});const C=f*j,S=i*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${C}px, ${S}px) scale(${h})`})};r.querySelector("[data-rpt-apply]").addEventListener("click",m),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,Y({rightMm:0,topMm:0,scale:1});const f=o.querySelector("[data-quote-pages]");Object.assign(f.style,{transform:"none"})});const a=t.rightMm*j,n=t.topMm*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${a}px, ${n}px) scale(${t.scale})`})}catch{}}function B({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function Ct(o){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=c("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const s=document.createElement("p");s.className="rpt-subtitle",s.textContent=`${ct(new Date)} • ${c("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(s);const e=document.createElement("div");e.className="rpt-kpis";const m=(a,n)=>{const f=document.createElement("div");return f.className="rpt-kpi",f.innerHTML=`<div class="label">${a}</div><div class="value">${n}</div>`,f};return e.appendChild(m(c("reservations.reports.kpi.total.label","الحجوزات","Reservations"),J(o.total||0))),e.appendChild(m(c("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),$(o.revenue||0))),e.appendChild(m(c("reservations.reports.kpi.net.label","صافي الربح","Net profit"),$(o.netProfit||0))),e.appendChild(m(c("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),$(o.companyShareTotal||0))),e.appendChild(m(c("reservations.reports.kpi.tax.label","الضريبة","Tax"),$(o.taxTotal||0))),e.appendChild(m(c("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),$(o.maintenanceExpense||0))),t.appendChild(e),t}function Pt(){try{const o=L?.data||{},t=L?.lastSnapshot?.filtered||o.reservations||[],r=new Map((o.customers||[]).map(n=>[String(n.id),n])),s=[...t].sort((n,f)=>new Date(f?.start||0)-new Date(n?.start||0)),e={code:c("reservations.reports.results.headers.id","الحجز","Reservation"),customer:c("reservations.reports.results.headers.customer","العميل","Customer"),date:c("reservations.reports.results.headers.date","التاريخ","Date"),status:c("reservations.reports.results.headers.status","الحالة","Status"),payment:c("reservations.reports.results.headers.payment","الدفع","Payment"),total:c("reservations.reports.results.headers.total","الإجمالي","Total"),share:c("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:c("reservations.reports.results.headers.net","صافي الربح","Net profit")},m=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],a=s.map(n=>{const f=n?.reservationId||n?.id||"—",i=V(String(f)),h=r.get(String(n?.customerId))?.customerName||c("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),C=nt(n?.start),S=at(n),g=(()=>{switch(S.statusValue){case"completed":return String(c("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(c("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(c("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return V(String(S.statusValue||"—"))}})(),_=st(S.paidStatus),E=it(n),T=$(E.finalTotal),A=E.companySharePercent>0?`${J(E.companySharePercent)}% (${$(E.companyShareAmount)})`:c("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),p=$(E.netProfit);return{[e.code]:i,[e.customer]:h,[e.date]:C,[e.status]:g,[e.payment]:_,[e.total]:T,[e.share]:A,[e.net]:p}});return{headers:m,rows:a}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function G(o){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),s=document.createElement("tr");o.forEach(m=>{const a=document.createElement("th");a.textContent=m,s.appendChild(a)}),r.appendChild(s);const e=document.createElement("tbody");return t.appendChild(r),t.appendChild(e),{table:t,tbody:e}}function Mt(o,t,r,s){const e=o.querySelector("[data-quote-pages]"),m=B({primary:!0});e.appendChild(m);const a=Ct(s);m.appendChild(a);let{table:n,tbody:f}=G(r);m.appendChild(n);const i=18,v=28,h=[];for(let g=0;g<t.length;g+=v)h.push(t.slice(g,g+v));if(h.length){const g=h[0];if(g.length>i){const _=g.splice(i);h.length>1?h[1]=_.concat(h[1]):h.push(_)}}const C=(g,_)=>{const E=document.createElement("tr");r.forEach(T=>{const A=document.createElement("td");A.textContent=_[T]!=null?String(_[T]):"",E.appendChild(A)}),g.appendChild(E)};(h.shift()||t).forEach(g=>C(f,g)),h.forEach(g=>{const _=B({primary:!1});e.appendChild(_);const E=G(r);_.appendChild(E.table),g.forEach(T=>C(E.tbody,T))})}function St(o=[],{context:t="preview"}={}){const s=(L.lastSnapshot||{}).metrics||{};let e,m=o&&o.length?o:null;if(m)e=Object.keys(m[0]||{});else{const f=Pt();e=f.headers,m=f.rows}const a=wt(t),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${N}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(a);try{lt(a),dt(a),mt(a)}catch{}return Mt(a,m||[],e,s),a.parentElement?.removeChild(a),n.parentElement?.removeChild(n),t==="preview"&&vt(a),a}async function At(o=[],{action:t="save"}={}){const r=St(o,{context:"export"}),s=document.createElement("div");Object.assign(s.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),s.appendChild(r),document.body.appendChild(s);try{if(t==="print"&&localStorage.getItem("reportsPdf.nativePrint")==="on"){const i=window.open("","_blank");if(!i)throw new Error("Popup blocked");const v=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${c("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} /* ضمان إظهار كل صفحة كتلة مطبوعة */ .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{i.document.open(),i.document.write(v),i.document.close()}catch{}const h=r.cloneNode(!0);try{i.document.body.appendChild(h)}catch{}try{i.document?.fonts?.ready&&await i.document.fonts.ready}catch{}await new Promise(C=>setTimeout(C,60));try{i.focus(),i.print()}catch{}return}const a=yt()&&!xt()?window.open("","_blank"):null;if(a)try{a.document.open(),a.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${c("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),a.document.close()}catch{}await pt();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const n=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,f=window.html2canvas;if(typeof n=="function"&&typeof f=="function"){const i=Q(),v=new n({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),C={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},S=Array.from(r.querySelectorAll(".quote-page"));let g=0;const _=(p,l=250)=>{try{const x=p.getContext("2d"),{width:b,height:y}=p,d=new Uint8ClampedArray(b*4),w=u=>{const k=x.getImageData(0,u,b,1).data||d;let R=0;for(let M=0;M<b;M+=1){const q=M*4,I=k[q],D=k[q+1],F=k[q+2];if((I<l||D<l||F<l)&&(R+=1,R>Math.max(2,Math.ceil(b*.003))))return!1}return!0};let P=0;for(let u=0;u<y;u+=2)if(!w(u)){P=u;break}return P}catch{return 0}},E=(p,l=245)=>{try{const x=p.getContext("2d"),{width:b,height:y}=p,d=Math.floor(b*.55),w=Math.max(10,b-d),P=Math.max(3,Math.ceil(w*.015));for(let u=0;u<y;u+=2){const k=x.getImageData(d,u,w,1).data;let R=0;for(let M=0;M<w;M+=1){const q=M*4,I=k[q],D=k[q+1],F=k[q+2];if((I<l||D<l||F<l)&&(R+=1,R>=P))return u}}return 0}catch{return 0}},T=(p,l=250)=>{try{const x=p.getContext("2d"),{width:b,height:y}=p,d=P=>{const u=x.getImageData(0,P,b,1).data;let k=0;for(let R=0;R<b;R+=1){const M=R*4,q=u[M],I=u[M+1],D=u[M+2];if((q<l||I<l||D<l)&&(k+=1,k>Math.max(2,Math.ceil(b*.003))))return!1}return!0};let w=0;for(let P=y-1;P>=0;P-=2)if(!d(P)){w=y-1-P;break}return w}catch{return 0}},A=(p,l,x)=>{try{const{width:b,height:y}=p,d=Math.max(0,Math.min(y-1,Math.round(l))),w=Math.max(0,Math.min(y-d,Math.round(x))),P=Math.max(1,y-d-w);if(d===0&&w===0)return p;const u=document.createElement("canvas");return u.width=b,u.height=P,u.getContext("2d").drawImage(p,0,-d),u}catch{return p}};for(let p=0;p<S.length;p+=1){const l=S[p],x=l.ownerDocument||document,b=x.createElement("div");Object.assign(b.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const y=x.createElement("div");y.id="quotation-pdf-root",y.setAttribute("data-quote-render-context","export"),y.style.width=`${N}px`,y.style.maxWidth=`${N}px`,y.style.minWidth=`${N}px`,y.style.background="#ffffff";const d=l.cloneNode(!0);d.style.width=`${N}px`,d.style.maxWidth=`${N}px`,d.style.minWidth=`${N}px`,d.style.height=`${H}px`,d.style.maxHeight=`${H}px`,d.style.minHeight=`${H}px`,d.style.position="relative",d.style.background="#ffffff",d.style.overflow="hidden",y.appendChild(d),b.appendChild(y),x.body.appendChild(b);let w;try{w=await f(d,{...C,scrollX:0,scrollY:0,windowWidth:N,windowHeight:H})}finally{b.parentNode?.removeChild(b)}if(!w)continue;const P=_(w,246),u=E(w,244),k=Math.max(P,u),R=T(w,246),M=A(w,k,R),q=Math.max(.9,Math.min(1,i.scale||1)),I=K*q,D=M.height/M.width*I;let F=Number(i.rightMm)||0;const Z=l.classList.contains("quote-page--primary")?6:4;let O=0;try{const W=l.querySelector(".rpt-header")||l.firstElementChild;if(W){const ot=W.getBoundingClientRect(),rt=l.getBoundingClientRect();O=Math.max(0,ot.top-rt.top)}}catch{O=0}const tt=O/j;let z=(Number(i.topMm)||0)+Z-tt;z<-80&&(z=-80);const et=M.toDataURL("image/jpeg",.95);g>0&&v.addPage(),v.addImage(et,"JPEG",F,z,I,D,`page-${g+1}`,"FAST"),g+=1,await new Promise(W=>requestAnimationFrame(W))}if(g===0)throw new Error("PDF generation produced no pages");if(t==="print"){try{v.autoPrint({variant:"non-conform"})}catch{}const p=v.output("bloburl");if(a)try{a.location.href=p}catch{}else if(!window.open(p,"_blank")){const x=document.createElement("a");x.href=p,x.download="reservations-report.pdf",x.click()}}else v.save("reservations-report.pdf")}else{const i=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const v=await i.get("pdf");try{v.autoPrint({variant:"non-conform"})}catch{}const h=v.output("bloburl");if(!window.open(h,"_blank")){const S=document.createElement("a");S.href=h,S.download="reservations-report.pdf",S.click()}}else await i.save("reservations-report.pdf")}}finally{s.remove()}}export{St as buildReportsPdfPages,At as exportReportsPdf};
