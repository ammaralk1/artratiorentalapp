import{t as C,p as le,n as b,j as M,d as ue,b as ze,h as Zt,A as en}from"./auth.BLFzWQsL.js";import{r as kt,i as tn,D as Ze,s as nn,k as an,P as on,u as $e,E as It,j as cn,O as et,G as fe,H as _e,b as Pe,I as St,J as sn}from"./state.DZCwr8Fl.js";const rn=()=>C("reservations.create.summary.currency","SR");let Ae=[],X=[],ce=[],se=[],V="create",vt=()=>{},qt=()=>{};const xe=new Map,Ue=450;function ln(e){const n=xe.get(e);return n!=null&&Date.now()-n<Ue}function un(e){xe.set(e,Date.now()),setTimeout(()=>{const n=xe.get(e);n!=null&&Date.now()-n>=Ue&&xe.delete(e)},Ue+50)}function qe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ge(e={}){return{...e,assignmentId:e.assignmentId||qe()}}function Me(e){if(!e)return null;const n=String(e),t=Ae.find(s=>String(s?.id)===n);if(t)return{...t};const{technicians:i=[]}=ue();return i.find(s=>String(s?.id)===n)||null}function Ce(e={},n=le()){return e?n==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function tt(e={},n=le()){return e?n==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function Ft(e,n=""){if(!e)return null;if(typeof e=="object")return e;const t=String(e).trim().toLowerCase();if(!t)return null;const i=X.find(o=>String(o.id).trim().toLowerCase()===t);if(i)return i;const s=cn(e);return s||{id:null,name:n||t,labelAr:n||t,labelEn:n||t,cost:0,clientPrice:0}}function dt(e){const n=Ft(e,e?.name??""),t=le(),i=Ce(n,t)||n?.name||"",s=tt(n,t);return Ge({assignmentId:qe(),positionId:n?.id??null,positionKey:n?.name??null,positionLabel:i,positionLabelAlt:s,positionCost:Number.isFinite(n?.cost)?Number(n.cost):0,positionClientPrice:Number.isFinite(n?.clientPrice)?Number(n.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Ge(e={}){const n={assignmentId:e.assignmentId||qe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},t=Ft(n.positionId??n.positionKey??n.positionLabel,n.positionLabel);if(t){n.positionId=t.id??n.positionId;const i=le(),s=Ce(t,i)||n.positionLabel,o=tt(t,i);n.positionLabel=s||n.positionLabel||t?.name||"",n.positionLabelAlt=o||n.positionLabelAlt||"",(n.positionCost==null||!Number.isFinite(n.positionCost)||n.positionCost===0)&&(n.positionCost=Number.isFinite(t?.cost)?Number(t.cost):n.positionCost),(n.positionClientPrice==null||!Number.isFinite(n.positionClientPrice)||n.positionClientPrice===0)&&(n.positionClientPrice=Number.isFinite(t?.clientPrice)?Number(t.clientPrice):n.positionClientPrice)}if(n.technicianId!=null){const i=Me(n.technicianId);i?(n.technicianId=String(i.id),n.technicianName=i.name??n.technicianName??null,n.technicianRole=i.role??n.technicianRole??null,n.technicianPhone=i.phone??null):(n.technicianId=String(n.technicianId),n.technicianName=n.technicianName??null)}else n.technicianId=null,n.technicianName=null,n.technicianPhone=null;return n.positionCost=Number.isFinite(n.positionCost)?Number(n.positionCost):0,n.positionClientPrice=Number.isFinite(n.positionClientPrice)?Number(n.positionClientPrice):0,n}function ye(){X=tn()}function dn(e=[]){return Array.isArray(e)?e.map(n=>{if(n==null)return null;if(n&&typeof n=="object")return ge(Ge(n));const t=Me(n),i=t?{assignmentId:qe(),positionLabel:t.role||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(t.dailyWage)?Number(t.dailyWage):0,positionClientPrice:Number.isFinite(t.dailyTotal)?Number(t.dailyTotal):0,technicianId:t.id,technicianName:t.name,technicianRole:t.role}:{assignmentId:qe(),positionLabel:C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:n!=null?String(n):null,technicianName:null};return ge(Ge(i))}).filter(Boolean):[]}function de(e="create"){return e==="edit"?se.map(ge):ce.map(ge)}function ne(e="create",n=[]){try{ye()}catch{}const t=dn(n);e==="edit"?(se=t,ke("edit-selected-technicians-list",se,"edit"),qt()):(ce=t,ke("selected-technicians-list",ce,"create"),vt()),Fe()}function je(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=a?$e(a,c):null,f=l?$e(l,u):null;let y=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const _=Number.parseInt(g,10);if(Number.isInteger(_)){const{reservations:N=[]}=ue(),p=N?.[_];p&&(y=p.id??p.reservationId??null)}}return{start:d,end:f,ignoreReservationId:y}}const n=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",s=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=n?$e(n,i):null,r=t?$e(t,s):null;return{start:o,end:r,ignoreReservationId:null}}function Fe(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const n=de(V).length;if(n){const t=C("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",b(String(n)));e.textContent=t}else e.textContent=C("technicians.picker.selectionInfo","No crew selected yet")}function De(e){const n=Number.isFinite(e)?e:0;return`${b(n.toFixed(2))} ${rn()}`}function pn(e){const n=de(V),t=new Set(n.filter(c=>c.assignmentId!==e&&c.technicianId).map(c=>c.technicianId)),i=Ae.length?Ae:ue().technicians||[],{start:s,end:o,ignoreReservationId:r}=je(V),a=!!(s&&o);return i.map(c=>{const u=String(c.id),d=t.has(u),f=a?Ze(u,s,o,r):!1,y=b(c.name||c.full_name||c.fullName||c.email||u);return{id:u,label:y,disabled:d||f,conflict:f,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const n=de(V);if(!n.length){const t=C("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=C("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${t}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}ye(),e.innerHTML=n.map((t,i)=>{const s=b(String(i+1)),o=De(t.positionClientPrice||0),r=pn(t.assignmentId),a=C("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),l=t.technicianId!=null?String(t.technicianId):"",c=t.technicianName?b(t.technicianName):"",u=`crew-assignment-options-${t.assignmentId}`,d=C("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),f=C("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),y=r.map(h=>{const P=l===h.id,S=h.disabled&&!P?`${h.label} ${h.conflict?f:d}`:h.label;return`
        <option value="${h.label}"
                data-id="${h.id}"
                data-disabled="${h.disabled?"true":"false"}"
                data-conflict="${h.conflict?"true":"false"}"
                data-taken="${h.taken?"true":"false"}"
                label="${S}"></option>
      `}).join("");let g=t.positionLabel??t.position_label??t.position_name??t.role??t.position??"";if(!g||String(g).trim()===""){const h=t.positionId?X.find(k=>String(k.id)===String(t.positionId)):null,P=!h&&t.positionKey?X.find(k=>String(k.name).toLowerCase()===String(t.positionKey).toLowerCase()):null;if(h||P){const k=h||P;g=Ce(k,le())||k?.name||""}}const _=t.positionLabelAlt?`<div class="text-muted small">${b(t.positionLabelAlt)}</div>`:"",N=C("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),p=C("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${t.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${s}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${b(g||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${_}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${o}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${t.assignmentId}"
              placeholder="${a}"
              value="${l?c:""}"
              aria-label="${C("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${y}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${t.assignmentId}" aria-label="${N}">
            ${N}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Lt(t.dataset.assignmentId,V)}),t.dataset.listenerAttached="true")}),mn(e)}function mn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(t=>{if(t.dataset.listenerAttached)return;const i=t.dataset.assignmentId,s=()=>{fn(t,i)};t.addEventListener("change",s),t.addEventListener("blur",s),t.dataset.listenerAttached="true"})}function fn(e,n){if(!n||ln(n))return;un(n);const t=e.value?.trim()??"";if(!t){we(n,"");return}const i=e.getAttribute("list"),s=i?document.getElementById(i):null,o=s?Array.from(s.options):[],r=b(t).toLowerCase(),a=o.find(c=>b(c.value).toLowerCase()===r);if(!a){M(C("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}if(a.dataset.disabled==="true"){if(a.dataset.conflict==="true")try{const{start:c,end:u,ignoreReservationId:d}=je(V),f=a.dataset.id||"",y=c&&u&&f?It(String(f),c,u,d):[],g=C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),_=y&&y.length?`: ${y.join("ØŒ ")}`:"";M(`${g}${_}`,"warning",6e3)}catch{M(C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else M(C("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const l=a.dataset.id;if(!l){M(C("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}we(n,l)}function Re(){const e=document.getElementById("crew-position-list");if(!e)return;ye();const n=document.getElementById("crew-position-search"),t=b(String(n?.value||"")).trim().toLowerCase(),s=de(V).reduce((a,l)=>{const c=l?.positionId!=null?String(l.positionId):null;return c&&a.set(c,(a.get(c)||0)+1),a},new Map),o=X.filter(a=>t?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(c=>b(String(c)).toLowerCase()).join(" ").includes(t):!0);if(!o.length){e.innerHTML=`<div class="text-muted">${C("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const r=le();e.innerHTML=o.map(a=>{const l=Ce(a,r)||a.name||"",c=tt(a,r),u=De(a.clientPrice||0),d=De(a.cost||0),f=c?`<span class="crew-position-card__subtitle">${b(c)}</span>`:"",y=C("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=C("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),_=C("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),N=s.get(String(a.id))||0,p=C("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",b(String(N)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${b(l)}">
        ${N>0?`<span class="crew-position-card__badge" aria-label="${p}">${b(String(N))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${b(l)}</h6>
            ${f}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${y}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${y}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${b(String(a.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${a.clientPrice==null?"":b(String(a.clientPrice))}" inputmode="decimal" placeholder="${b("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${a.id}">${C("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${a.id}">${C("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${a.id}">
            ${_}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${a.id}">
            ${C("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.stopPropagation(),Ke(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{a.dataset.editing!=="true"&&Ke(a.dataset.positionId)}),a.addEventListener("keydown",l=>{if(l.key==="Enter"||l.key===" "){if(l.preventDefault(),a.dataset.editing==="true")return;Ke(a.dataset.positionId)}}),a.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const c=a.closest(".crew-position-card");if(!c)return;const u=c.querySelector(".crew-position-card__metrics"),d=c.querySelector(".crew-position-card__footer"),f=c.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),f&&(f.hidden=!1),c.dataset.editing="true";const y=c.querySelector(".crew-position-edit-cost"),g=c.querySelector(".crew-position-edit-client"),_=N=>{N.addEventListener("input",p=>{const P=b(p.target.value).replace(/[^0-9.]/g,"");if(P!==p.target.value){const k=p.target.selectionEnd||P.length;p.target.value=P,p.target.setSelectionRange(k,k)}},{once:!0})};y&&_(y),g&&_(g)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();const c=a.closest(".crew-position-card"),u=a.dataset.positionId;if(!(!c||!u))try{const d=c.querySelector(".crew-position-edit-cost"),f=c.querySelector(".crew-position-edit-client"),y=b(d?.value||"").trim(),g=b(f?.value||"").trim(),_=y===""?0:Number.parseFloat(y),N=g===""?null:Number.parseFloat(g);if(!Number.isFinite(_)||_<0){M(C("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(N!=null&&(!Number.isFinite(N)||N<0)){M(C("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),f?.focus();return}ye();const p=X.find(h=>String(h.id)===String(u));if(!p){M(C("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await on(u,{name:p.name,cost:Number(_.toFixed(2)),clientPrice:N==null?null:Number(N.toFixed(2)),labelAr:p.labelAr,labelEn:p.labelEn}),M(C("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),Re(),Y()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const f=d?.message||C("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");M(f,"error")}}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const c=a.closest(".crew-position-card");if(!c)return;const u=c.querySelector(".crew-position-card__metrics"),d=c.querySelector(".crew-position-card__footer"),f=c.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),f&&(f.hidden=!0),delete c.dataset.editing}),a.dataset.listenerAttached="true")})}function Ke(e){ye();const n=X.find(s=>String(s.id)===String(e)),t=dt(n||{id:null,name:""}),i=de(V);i.push(t),ne(V,i),Y(),M(C("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Lt(e,n="create"){if(!e)return;const t=de(n).filter(i=>i.assignmentId!==e);ne(n,t),Y(),M(C("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function we(e,n){if(!e)return;const t=de(V),i=t.find(c=>c.assignmentId===e);if(!i)return;if(!n){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ne(V,t),Y(),M(C("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(t.find(c=>c.assignmentId!==e&&c.technicianId===n)){M(C("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),Y();return}const o=Me(n),{start:r,end:a,ignoreReservationId:l}=je(V);if(r&&a&&Ze(String(n),r,a,l)){try{const c=It(String(n),r,a,l),u=C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=c&&c.length?`: ${c.join("ØŒ ")}`:"";M(`${u}${d}`,"warning",6e3)}catch{M(C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}Y();return}o?(i.technicianId=String(o.id),i.technicianName=o.name??null,i.technicianRole=o.role??null,i.technicianPhone=o.phone??null):(i.technicianId=String(n),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ne(V,t),Y(),i.technicianName?M(C("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",b(i.technicianName)),"success"):M(C("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function pt(e="create"){V=e,Y(),Fe();let n=nn();if(!Array.isArray(n)||n.length===0)try{const i=await kt();n=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(n)&&(Ae=n);try{await an()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}ye(),Re(),Y(),Fe();const t=document.getElementById("selectTechniciansModal");t&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(t).show()}function _n(){return de(V).map(ge)}function gn(){const e=_n(),{start:n,end:t,ignoreReservationId:i}=je(V);if(n&&t){const o=e.filter(r=>r.technicianId&&Ze(r.technicianId,n,t,i));if(o.length>0){const r=o.map(l=>l.technicianName||l.technicianId).join(C("reservations.list.crew.separator","ØŒ ")),a=C("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",r);o.forEach(l=>{l.technicianId=null,l.technicianName=null}),ne(V,e),Y(),M(a),Fe();return}}ne(V,e);const s=document.getElementById("selectTechniciansModal");s&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s)?.hide?.(),M(C("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function ke(e,n=[],t="create"){const i=document.getElementById(e);if(i){if(!n.length){i.innerHTML=`<span class="text-muted">${C("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}ye(),i.innerHTML=n.map(s=>{let o=s.positionLabel??s.position_label??s.position_name??s.role??s.position??"";if(!o||String(o).trim()===""){const d=s.positionId?X.find(y=>String(y.id)===String(s.positionId)):null,f=!d&&s.positionKey?X.find(y=>String(y.name).toLowerCase()===String(s.positionKey).toLowerCase()):null;o=d?Ce(d,le())||d?.name||"":f&&(Ce(f,le())||f?.name)||""}const r=b(o||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=s.technicianName?`${b(s.technicianName)}`:C("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let l=Number(s.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[s.position_client_price,s.client_price,s.customer_price,s.daily_total,s.dailyTotal,s.total];for(const f of d){const y=Number(f);if(Number.isFinite(y)&&y>0){l=y;break}}}if((!Number.isFinite(l)||l<=0)&&(s.positionId||s.positionKey)){const d=s.positionId?X.find(g=>String(g.id)===String(s.positionId)):null,f=!d&&s.positionKey?X.find(g=>String(g.name).toLowerCase()===String(s.positionKey).toLowerCase()):null,y=d||f||null;y&&Number.isFinite(Number(y.clientPrice))&&(l=Number(y.clientPrice))}const c=De(Number.isFinite(l)&&l>0?l:0),u=C("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${s.assignmentId}">
        <span class="technician-chip-name">${r}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${c}</small>
        <button type="button" class="technician-chip-remove" data-context="${t}" data-assignment-id="${s.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(s=>{s.dataset.listenerAttached||(s.addEventListener("click",()=>{Lt(s.dataset.assignmentId,s.dataset.context)}),s.dataset.listenerAttached="true")})}}function yn(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",r=>{const a=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),c=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),f=!!(l&&c),y=!!(u&&d),g=!!a;if(!f||!y){r.preventDefault(),M(C("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){r.preventDefault(),M(C("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}pt("create")}),e.dataset.listenerAttached="true";const o=()=>{const r=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),c=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(r&&a&&l&&c&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(r=>document.getElementById(r)).filter(Boolean).forEach(r=>{["input","change"].forEach(a=>r.addEventListener(a,o))}),o()}const n=document.getElementById("open-edit-technician-picker");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>pt("edit")),n.dataset.listenerAttached="true");const t=document.getElementById("crew-position-search");t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{Re()}),t.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",gn),i.dataset.listenerAttached="true");const s=document.getElementById("selectTechniciansModal");s&&!s.dataset.listenerAttached&&window.bootstrap?.Modal&&(s.addEventListener("shown.bs.modal",async()=>{if(!Ae.length&&(!ue().technicians||ue().technicians.length===0))try{await kt()}catch(o){console.warn("[crew-picker] fetch on show failed",o)}Re(),Y(),Fe()}),s.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("crew-position-search");o&&(o.value="")}),s.dataset.listenerAttached="true"),ke("selected-technicians-list",ce,"create"),ke("edit-selected-technicians-list",se,"edit")}function mi({onDraftChange:e,onEditChange:n}={}){vt=typeof e=="function"?e:()=>{},qt=typeof n=="function"?n:()=>{},yn()}function hn(){return ce.map(ge)}function bn(){return se.map(ge)}function mt(){return ce.map(e=>e.technicianId).filter(Boolean).map(String)}function ft(){return se.map(e=>e.technicianId).filter(Boolean).map(String)}function fi(e=[]){ne("create",e)}function _i(e=[]){ne("edit",e)}function gi(){ne("create",[])}function yi(){ne("edit",[])}function _t(e=[]){return e.map(n=>{if(n.technicianId){const t=Me(n.technicianId);if(t)return n.technicianId=String(t.id),n.technicianName=t.name??n.technicianName??null,n.technicianRole=t.role??n.technicianRole??null,n.technicianPhone=t.phone??null,n;n.technicianId=null,n.technicianName=null,n.technicianRole=null,n.technicianPhone=null}return n})}function hi(e=[]){Array.isArray(e)&&e.length&&(Ae=e),ce=_t(ce),se=_t(se),ke("selected-technicians-list",ce,"create"),ke("edit-selected-technicians-list",se,"edit"),Y()}function gt(e){const n=e.split(".");if(n.length<=2)return e;const t=n.pop(),i=n.join("");return t?`${i}.${t}`:i}function Et(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let n=b(String(e)).trim();if(!n)return Number.NaN;const t=n.search(/[0-9]/),i=n.indexOf("-"),s=i!==-1&&(t===-1||i<t);if(n=n.replace(/[-+]/g,""),n=n.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),n=n.replace(/[^0-9.,]/g,""),!n)return Number.NaN;const o=n.includes(","),r=n.includes(".");if(o&&r){const l=n.lastIndexOf(","),c=n.lastIndexOf(".");l>c?(n=n.replace(/\./g,""),n=n.replace(/,/g,".")):n=n.replace(/,/g,"")}else if(o){const l=n.split(",");l.length===2&&l[1].length===3?n=l.join(""):n=n.replace(/,/g,".")}else if(r){const l=n.split(".");if(l.length===2){const[,c]=l;if(c.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(n=u)}}else l.length>2&&(n=gt(n))}if(n=n.replace(/,/g,""),n=gt(n),!/^[0-9]*\.?[0-9]*$/.test(n)||!n||n===".")return Number.NaN;const a=Number.parseFloat(n);return Number.isFinite(a)?s?-a:a:Number.NaN}function D(e){return Et(e)}function $(e){const n=Et(e);if(!Number.isFinite(n))return 0;let t=n,i=0;for(;Math.abs(t)>1e5&&i<8;)t/=10,i+=1;return Number(t.toFixed(2))}function ve(e){return b(String(e??"")).trim().toLowerCase()}function Tt(e=""){return b(String(e)).trim().toLowerCase()}const Nn=2;function Pn(e){const n=D(e);return Number.isFinite(n)?n.toFixed(Nn):"0.00"}function Qe(e={}){const n=[e?.qty,e?.quantity,e?.count,e?.units];for(const t of n){const i=Number.parseFloat(b(String(t??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return $(i)}return 1}function An(e={}){const n=e?.desc||e?.description||e?.name||"",t=Tt(n),i=Pn(e?.price??e?.unitPrice??e?.unit_price??0);return`${t}::${i}`}function Cn(e=[]){const n=new Map;return e.forEach((t,i)=>{const s=An(t);if(!s)return;if(!n.has(s)){const r=t?.desc||t?.description||t?.name||"",a=Tt(r),l=ht(t),c=bt(t),u=t?.image||t?.imageUrl||t?.img||"";n.set(s,{key:s,description:r,normalizedDescription:a,unitPrice:l,unitCost:c,image:u,items:[],itemIndices:[],barcodes:[]})}const o=n.get(s);o.items.push(t),o.itemIndices.push(i),t?.barcode&&o.barcodes.push(String(t.barcode))}),Array.from(n.values()).map(t=>({...t,quantity:t.items.reduce((i,s)=>i+Qe(s),0)})).map(t=>{const i=t.quantity||0,s=t.items.reduce((g,_)=>{const N=ht(_),p=Qe(_);return g+N*p},0),o=$(s),r=D(t.unitPrice),a=Number.isFinite(r)?r:0,l=t.items.reduce((g,_)=>{const N=bt(_),p=Qe(_);return g+N*p},0),c=$(l),u=D(t.unitCost),d=Number.isFinite(u)?u:0,f=i>0?$(o/i):$(a),y=i>0?$(c/i):$(d);return{...t,quantity:i,count:i,totalPrice:o,unitPrice:f,totalCost:c,unitCost:y}})}function yt(e={}){return(Pe(e)||[]).map(t=>({...t,normalizedBarcode:t?.normalizedBarcode??ve(t?.barcode),qty:(()=>{const i=Number.parseFloat(b(String(t?.qty??t?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=D(t?.price??t?.unit_price??t?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=D(t?.cost??t?.unit_cost??t?.unitCost??t?.rental_cost??t?.purchase_price);return Number.isFinite(i)?i:0})()}))}function kn(e={},{packageQuantity:n=1}={}){const t=fe(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=t&&_e(t)||e,s=Pe(i)||[],o=Number.isFinite(Number(n))&&Number(n)>0?Number(n):1;return s.map(r=>{const l=D(r?.price??r?.unit_price??r?.unitPrice),c=Number.isFinite(l)?$(l):0,u=D(r?.cost??r?.unit_cost??r?.unitCost??r?.rental_cost??r?.purchase_price),d=Number.isFinite(u)?$(u):0,f=1*o,y=$(c*f),g=$(d*f);return{equipmentId:r?.equipmentId??r?.equipment_id??null,barcode:r?.barcode??r?.normalizedBarcode??"",desc:r?.desc??r?.description??"",qtyPerPackage:1,packageQuantity:o,totalUnits:f,unitPrice:c,perDayTotal:y,unitCost:d,perDayCost:g}})}function In(e={},{packageQuantity:n=1,days:t=1}={}){const i=kn(e,{packageQuantity:n}),s=$(i.reduce((l,c)=>l+(Number(c.perDayTotal)||0),0)),o=$(i.reduce((l,c)=>l+(Number(c.perDayCost)||0),0)),r=$(s*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1)),a=$(o*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1));return{lines:i,perDayTotal:s,total:r,perDayCostTotal:o,costTotal:a}}function Sn(e={}){const n=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,t=Number.parseFloat(b(String(n)).replace(/[^0-9.]/g,""));return Number.isFinite(t)&&t>0?t:1}function vn(e={},n=[],t=null){try{const c=fe(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(c){const u=_e(c);if(u){const d=u.price??u.total_price??u.package_price,f=D(d);if(Number.isFinite(f)&&f>0)return $(f)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,s=D(i);if(Number.isFinite(s)&&s>0)return $(s);const o=e.total_price??e.totalPrice??e.total,r=D(o),a=Number.parseFloat(b(String(t)).replace(/[^0-9.]/g,"")),l=Number.isFinite(a)&&a>0?a:Sn(e);return Number.isFinite(r)&&r>0&&l>0?$(r/l):0}function qn(e={}){const n=Array.isArray(e?.items)?e.items:[],t=Cn(n),i=et(),s=new Set,o=new Map;i.forEach(p=>{const h=fe(p?.id??p?.packageId??p?.package_id??p?.code);h&&s.add(h);const P=b(String(p?.package_code??p?.code??"")).trim().toLowerCase();P&&o.set(P,h||P)});const r=(p,h=0)=>{const P=fe(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),k=b(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return P||(k&&o.has(k)?o.get(k):k||`pkg-${h}`)},a=new Map,l=(p,h=0,P="packages")=>{if(!p||typeof p!="object")return;const S=r(p,h)||`pkg-${h}`;if(!a.has(S)){a.set(S,{source:p,normalizedId:S,index:h,itemSource:P==="items"?p:null});return}const A=a.get(S);if(A.source||(A.source=p),P==="items"&&(A.itemSource=p,A.source&&typeof A.source=="object")){const q=Array.isArray(A.source.packageItems)&&A.source.packageItems.length>0,L=Array.isArray(p.packageItems)&&p.packageItems.length>0;!q&&L&&(A.source={...A.source,packageItems:p.packageItems}),!A.source.image&&p.image&&(A.source={...A.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,h)=>l(p,h,"packages")),n.forEach((p,h)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const P=r(p,h+a.size);l({...p,package_id:P,packageId:P,package_code:p.package_code??p.code},h+a.size,"items")}});const c=[],u=new Set,d=new Set;a.forEach(({source:p,itemSource:h=null,normalizedId:P},k)=>{const A=(P?_e(P):null)||p||{},q=h&&typeof h=="object"?h:null;let L=yt(A);(!Array.isArray(L)||L.length===0)&&q&&(L=yt(q)),L.forEach(F=>{const T=F?.normalizedBarcode??ve(F?.barcode);T&&u.add(T);const z=F?.equipmentId??F?.equipment_id??null;z!=null&&d.add(String(z))});let B=1,w=vn(A,L,B);const m=[q?.price,q?.unit_price,q?.unitPrice];for(const F of m){const T=D(F);if(Number.isFinite(T)&&T>0){w=$(T);break}}w=$(w);const U=[A?.unit_cost,A?.unitCost,A?.cost,q?.unit_cost,q?.unitCost,q?.cost];let H=0;for(const F of U){const T=D(F);if(Number.isFinite(T)&&T>=0){H=$(T);break}}if(!H&&Array.isArray(L)&&L.length){const F=L.reduce((T,z)=>{const pe=D(z?.cost),he=Number.isFinite(Number(z?.qtyPerPackage))&&Number(z.qtyPerPackage)>0?Number(z.qtyPerPackage):1;return T+(Number.isFinite(pe)?pe:0)*he},0);H=$(F)}const O=(()=>{const F=[A?.pricing_mode,A?.pricingMode,A?.pricing,q?.pricing_mode,q?.pricingMode,q?.pricing];for(const T of F){if(T==null)continue;const z=String(T).trim().toLowerCase();if(z==="daily"||z==="per_day"||z==="day")return"daily";if(z==="fixed"||z==="per_booking"||z==="booking")return"fixed"}return"daily"})(),K=[q?.total,q?.total_price,q?.totalPrice,A?.total,A?.total_price,A?.totalPrice];let Q=NaN;for(const F of K){const T=D(F);if(Number.isFinite(T)&&T>=0){Q=T;break}}Number.isFinite(Q)||(Q=w*B),Q=$(Q);const ee=[A?.package_code,A?.code,A?.packageCode,A?.displayCode,A?.display_code,A?.barcode,q?.package_code,q?.code,q?.packageCode,q?.displayCode,q?.display_code,q?.barcode,P,k].find(F=>F==null?!1:String(F).trim().length>0),v=ee!=null?b(String(ee)).trim():"";if(v){const F=ve(v);F&&u.add(F)}const E=L.map(F=>b(String(F?.barcode??F?.normalizedBarcode??""))).filter(Boolean),G=[A?.name,A?.package_name,A?.title,q?.name,q?.desc,q?.package_name,v,b(String(k))].find(F=>F!=null&&String(F).trim()!=="")||b(String(v||k)),ae=L.find(F=>F?.image)?.image??A?.image??q?.image??null,j=1;c.push({key:`package::${k}`,description:G,normalizedDescription:b(String(G)),unitPrice:w,unitCost:H,totalPrice:Q,pricingMode:O,quantity:B,count:j,image:ae,barcodes:E,barcode:v,package_code:v,packageDisplayCode:v,items:[{type:"package",packageItems:L,packageId:P,desc:G,price:w,cost:H,qty:j,barcode:v}],type:"package",packageItems:L,packageId:P})});const f=new Set(Array.from(u).map(p=>ve(p)).filter(Boolean)),y=t.filter(p=>{if(p.items.some(S=>S?.type==="package")&&c.length>0)return!1;const P=(S={})=>[S.packageId,S.package_id,S.package_code,S.packageCode,S.bundleId,S.bundle_id].some(A=>A!=null&&A!=="");return!p.items.every(S=>{const A=Fn(S),q=A!=null?String(A):null;if(q&&d.has(q))return!0;const L=S?.barcode?ve(S.barcode):null;return!!(L&&f.has(L)||P(S))})}),g=new Set,_=[];return c.forEach(p=>{const h=r({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!h||g.has(h)||(g.add(h),_.push(p))}),{groups:_.length?[..._,...y]:t,packageGroups:c,groupedItems:t,filteredGroupedItems:y,packagesMap:a}}function Fn(e={}){const n=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const t of n)if(!(t==null||t===""))return String(t);return null}function ht(e={}){const n=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function bt(e={}){const n=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function bi(e){const n=e?.status??e?.reservationStatus??null;if(n){const s=String(n).trim().toLowerCase();if(s==="completed"||s==="closed"||s==="Ù…ØºÙ„Ù‚"||s==="Ù…ÙƒØªÙ…Ù„"||s==="Ù…Ù†ØªÙ‡ÙŠ"||s==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Ln(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Ni(e={},n=null){const t=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,s=i!=null&&i!==""&&i!=="null",o=s?Ln(n?.status??n?.status_label??n?.statusLabel??""):null,r=s&&(n?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:t,projectLinked:s,projectStatus:o,projectConfirmed:r,effectiveConfirmed:s?r:t}}const $t=10;function wt(e={}){const n=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const t of n){const i=D(t);if(Number.isFinite(i))return $(i)}return 0}function En(e={}){const n=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const t of n){if(t==null||t==="")continue;const i=D(t);if(Number.isFinite(i))return $(i)}return wt(e)}function Tn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:n=[]}=ue();if(!Array.isArray(n)||n.length===0)return{costPerDay:0,totalPerDay:0};const t=new Map(n.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,s)=>{const o=t.get(String(s));if(!o)return i;const r=wt(o),a=En(o);return{costPerDay:i.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const $n=1440*60*1e3,Ne=.01;function be(e){if(e==null||e==="")return null;const n=b(String(e)).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return Number.isFinite(t)?t:null}function Nt(e,{min:n=0,max:t=Number.POSITIVE_INFINITY,precision:i=2}={}){let s=Number.isFinite(e)?e:0;if(s<n&&(s=n),s>t&&(s=t),i!=null){const o=10**i;s=Math.round(s*o)/o}return s}function xt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function nt({totalAmount:e=0,progressType:n=null,progressValue:t=null,paidAmount:i=null,paidPercent:s=null,history:o=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,a=n==="amount"?"amount":n==="percent"?"percent":null;let l=be(i),c=be(s);const u=be(t);let d=0,f=0;Array.isArray(o)&&o.length&&o.forEach(p=>{if(!p)return;const h=p.type==="amount"||p.type==="percent"?p.type:null,P=be(p.value),k=be(p.amount),S=be(p.percentage);if(h==="amount"){const A=k??P;A!=null&&(d+=A,r>0&&(f+=A/r*100))}else if(h==="percent"){const A=S??P;A!=null&&(f+=A,r>0&&(d+=A/100*r))}else k!=null&&(d+=k,r>0&&(f+=k/r*100)),S!=null&&(f+=S,r>0&&(d+=S/100*r))}),a==="amount"&&u!=null?l=u:a==="percent"&&u!=null?c=u:a===null&&u!=null&&(c!=null?c=u:l=u),(l==null||l<=0)&&c!=null&&c>0&&r>0&&(l=r*(c/100)),(c==null||c<=0)&&l!=null&&l>0&&r>0&&(c=l/r*100);const y=l??0,g=c??0;l=y+d,c=g+f,l=Nt(l??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),c=Nt(c??0,{min:0,max:100,precision:2});let _=a;return _||(l>0&&r>0?_="amount":c>0&&(_="percent")),{paidAmount:l,paidPercent:c,paymentProgressType:_,paymentProgressValue:_==="amount"?l:_==="percent"?c:null}}function it({manualStatus:e="unpaid",paidAmount:n=0,paidPercent:t=0,totalAmount:i=0}={}){const s=xt(e),o=Number.isFinite(Number(i))?Number(i):0,r=Number.isFinite(Number(n))?Number(n):0,a=Number.isFinite(Number(t))?Number(t):0;if(s==="paid")return"paid";const l=o>0&&r>=o-Ne,c=a>=100-Ne*100;if(l||c)return"paid";const u=r>Ne||a>Ne;return s==="partial"||u?"partial":"unpaid"}function wn(e,n){if(!e||!n)return 1;const t=new Date(e),i=new Date(n);if(Number.isNaN(t.getTime())||Number.isNaN(i.getTime()))return 1;const s=i.getTime()-t.getTime();if(s<=0)return 1;const o=s/$n;return Math.max(1,Math.ceil(o))}function Ie({items:e=[],technicianIds:n=[],crewAssignments:t=[],discount:i=0,discountType:s="percent",applyTax:o=!1,start:r=null,end:a=null,companySharePercent:l=null,groupingSource:c=null}={}){const u=wn(r,a);let d=!1;try{if(typeof window<"u"&&window.location){const v=new URL(window.location.href),E=(v.searchParams.get("noDays")||v.searchParams.get("pricing")||"").toLowerCase();d=E==="1"||E==="true"||E==="fixed"||E==="nodays"}}catch{}const f=c&&typeof c=="object"?c:{items:Array.isArray(e)?e:[]},{groups:y}=qn(f),g=v=>{if((v?.type||"").toLowerCase()==="package")return!0;const E=Array.isArray(v?.items)?v.items:[];if(!E.length)return!1;if(E.some(j=>j?.reservation_id!=null||j?.reservationId!=null))return!0;const G=E.every(j=>j?.unit_price!=null||j?.unitPrice!=null),ae=E.some(j=>j?.daily_rate!=null||j?.dailyRate!=null||j?.unit_rate!=null||j?.unitRate!=null||j?.price!=null);return!!(G&&!ae)};let _=0,N=0;(Array.isArray(y)?y:[]).forEach(v=>{const E=Number.isFinite(Number(v?.quantity))?Number(v.quantity):0,ie=Number.isFinite(Number(v?.unitPrice))?Number(v.unitPrice):0,G=Number.isFinite(Number(v?.unitCost))?Number(v.unitCost):0,ae=String(v?.type||"").toLowerCase()==="package",j=g(v),F=d||j?1:u;if(ae){const T={package_code:v?.package_code||v?.packageDisplayCode||v?.barcode||v?.packageId||v?.key,packageItems:Array.isArray(v?.packageItems)?v.packageItems:void 0},z=In(T,{packageQuantity:E,days:F}),pe=Number.isFinite(Number(z.total))?Number(z.total):E*(Number.isFinite(ie)?ie:0)*F,he=(()=>{const me=Number(z?.costTotal);if(Number.isFinite(me))return me;const Te=Number(z?.perDayCostTotal);return Number.isFinite(Te)?Te*F:E*(Number.isFinite(G)?G:0)*F})();_+=pe,N+=he}else _+=E*ie*F,N+=E*G*F});const p=$(_),h=$(N),P=Array.isArray(t)?t:[],k=P.length?P.map(v=>v?.technicianId).filter(Boolean):Array.isArray(n)?n:[],{costPerDay:S,totalPerDay:A}=P.length?P.reduce((v,E)=>{const ie=D(E?.positionCost??E?.position_cost??E?.cost??E?.dailyWage??E?.daily_wage??0),G=D(E?.positionClientPrice??E?.position_client_price??E?.clientPrice??E?.dailyTotal??E?.daily_total??E?.total??0),ae=Number.isFinite(ie)?ie:0,j=Number.isFinite(G)?G:0;return{costPerDay:v.costPerDay+ae,totalPerDay:v.totalPerDay+j}},{costPerDay:0,totalPerDay:0}):Tn(k),q=$(A*u),L=$(S*u),B=$(p+q),w=Number(i)||0;let m=s==="amount"?w:B*(w/100);(!Number.isFinite(m)||m<0)&&(m=0),m>B&&(m=B);const U=Math.max(0,B-m),H=Number.isFinite(l)&&Number(l)>0?Number(l):0,Z=H>0?Math.max(0,U*(H/100)):0,O=U+Z;let K=o?O*.15:0;(!Number.isFinite(K)||K<0)&&(K=0),K=Number(K.toFixed(2));const Q=O+K,x=Math.max(0,Number(Q.toFixed(2))),ee=Math.max(0,Math.max(0,p+q-m)-L-h);return{rentalDays:u,equipmentTotal:p,equipmentCostTotal:h,crewTotal:q,crewCostTotal:L,discountAmount:m,subtotalAfterDiscount:U,taxableAmount:O,taxAmount:K,finalTotal:x,companySharePercent:H,companyShareAmount:Z,netProfit:ee}}function Pi(e=[],n=0,t="percent",i=!1,s=[],{start:o=null,end:r=null,companySharePercent:a=null}={}){const l=y=>y&&typeof y=="object"&&(y.positionId!==void 0||y.position_id!==void 0||y.positionLabel!==void 0||y.position_name!==void 0||y.positionClientPrice!==void 0),c=Array.isArray(s)&&s.some(l)?s:[],u=c.length?c.map(y=>y?.technicianId).filter(Boolean):Array.isArray(s)?s:[];return Ie({items:e,technicianIds:u,crewAssignments:c,discount:n,discountType:t,applyTax:i,start:o,end:r,companySharePercent:a??$t}).finalTotal}function Dt({total:e,itemsCount:n,rentalDays:t,techniciansCount:i,applyTax:s,paymentStatus:o,paidAmount:r=0,paidPercent:a=0,companySharePercent:l=null,companyShareAmount:c=null,taxAmount:u=null,netProfit:d=null,totalKey:f="reservations.summary.total",equipmentTotal:y=null,crewTotal:g=null,equipmentCostTotal:_=null}){const N=C("reservations.create.summary.currency","SR"),p=b(String(e)),h=b(String(n)),P=b(String(t??1)),k=b(String(i)),S=xt(o),A=S==="paid"?"Ù…Ø¯ÙÙˆØ¹":S==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",q=C(`reservations.create.paymentStatus.${S}`,A),L=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,B=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,w=L>Ne||B>Ne,m=C("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),U=b(L.toFixed(2)),H=b(B.toFixed(B%1?2:0)),Z=C("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),O=C("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),K=C("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),Q=C("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),x=C("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ee=C("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),v=C("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),E=C("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),G=C(f==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",C("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),ae=C("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),j=C("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),F=Number.isFinite(d)?Math.max(0,Number(d)):null,T=[{label:Z,value:h},{label:O,value:P},{label:K,value:k}],z=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;z!=null&&T.push({label:Q,value:`${b(z.toFixed(2))} ${N}`});const pe=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;pe!=null&&T.push({label:x,value:`${b(pe.toFixed(2))} ${N}`});const he=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(he!=null&&T.push({label:ee,value:`${b(he.toFixed(2))} ${N}`}),s){let oe=C("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(oe=`${b(Number(u).toFixed(2))} ${N}`),T.push({label:v,value:oe})}const me=Number.isFinite(l)?Number(l):null;if(me!==null&&me>0){const oe=Number.isFinite(c)?Number(c):e*(me/100),Se=b(String(me)),Jt=b(Number.isFinite(oe)?oe.toFixed(2):"0"),Xt=`${Se}% (${Jt} ${N})`;T.push({label:ae,value:Xt})}if(F!==null&&Math.abs(F-Number(e))>.009){const oe=b(F.toFixed(2));T.push({label:j,value:`${oe} ${N}`})}T.push({label:E,value:q}),w&&T.push({label:m,value:`${U} ${N} (${H}%)`});const Te=`${p} ${N}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${T.map(({label:oe,value:Se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${oe}</span>
            ${Se?`<span class="reservation-summary-value">${Se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${G}</span>
          <span class="reservation-summary-value">${Te}</span>
        </div>
      </div>
    </div>
  `}function xn({selectedItems:e,discount:n,discountType:t,applyTax:i,paidStatus:s,paymentProgressType:o=null,paymentProgressValue:r=null,start:a,end:l,companySharePercent:c=null,paymentHistory:u=[]}){const d=hn(),f=typeof mt=="function"?mt()??[]:[],y=Array.isArray(f)?f.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):y,_=d.length||g.length,N=Number.isFinite(c)?Number(c):null,p=Ie({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:a,end:l,companySharePercent:N}),h=nt({totalAmount:p.finalTotal,progressType:o,progressValue:r,history:u}),P=it({manualStatus:s,paidAmount:h.paidAmount,paidPercent:h.paidPercent,totalAmount:p.finalTotal}),k=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,paymentProgressType:h.paymentProgressType,paymentProgressValue:h.paymentProgressValue,total:p.finalTotal};return xn.lastResult=S,Rn(k),k}function Dn({items:e,discount:n,discountType:t,applyTax:i,paidStatus:s,paymentProgressType:o=null,paymentProgressValue:r=null,start:a,end:l,companySharePercent:c=null,paymentHistory:u=[]}){const d=bn(),f=typeof ft=="function"?ft()??[]:[],y=Array.isArray(f)?f.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):y,_=d.length||g.length,N=Number.isFinite(c)?Number(c):null,p=Ie({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:a,end:l,companySharePercent:N}),h=nt({totalAmount:p.finalTotal,progressType:o,progressValue:r,history:u}),P=it({manualStatus:s,paidAmount:h.paidAmount,paidPercent:h.paidPercent,totalAmount:p.finalTotal}),k=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={html:k,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,paymentProgressType:h.paymentProgressType,paymentProgressValue:h.paymentProgressValue,total:p.finalTotal};return Dn.lastResult=S,k}function Rn(e){const n=document.getElementById("reservation-preview");n&&(n.innerHTML=e,Pt(n,e));const t=document.getElementById("reservation-preview-bottom");t&&(t.innerHTML=e,Pt(t,e))}function Pt(e,n){const t=typeof n=="string"&&n.trim().length>0;e.classList.toggle("reservation-summary-host",t)}const Bn=ue()||{};let te=(Bn.reservations||[]).map(Kt);function J(e){let n=Number(e);if(!Number.isFinite(n))return 0;let t=0;for(;Math.abs(n)>1e5&&t<8;)n/=10,t+=1;return Number(n.toFixed(2))}const Rt="__reservation_packages_cache__",Bt="__reservation_item_cost_cache__";function zt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Mt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function jt(){const e=zt();if(!e)return{};try{const n=e.getItem(Rt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation packages cache",n),{}}}function At(e){const n=zt();if(n)try{n.setItem(Rt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation packages cache",t)}}function at(){const e=Mt();if(!e)return{};try{const n=e.getItem(Bt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation item cost cache",n),{}}}function We(e){const n=Mt();if(n)try{n.setItem(Bt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation item cost cache",t)}}function zn(e,n=0){if(!e||typeof e!="object")return null;const t=e.equipment_id??e.equipmentId??e.id??null,i=b(String(e.barcode??e.code??"")).trim(),s=J(I(e.cost??e.unit_cost)),o=J(I(e.price??e.unit_price)),r=Number.isFinite(s),a=Number.isFinite(o);return!r&&!a?null:{key:t!=null?`id:${t}`:i?`bc:${i}`:`idx:${n}`,equipmentId:t,barcode:i,cost:r?s:null,price:a?o:null}}function Mn(e,n){if(!e)return;const t=Array.isArray(n)?n.map((o,r)=>zn(o,r)).filter(Boolean):[],i=at(),s=String(e);if(!t.length){i[s]&&(delete i[s],We(i));return}i[s]=t,We(i)}function jn(e=[]){const n=at(),t=new Set;e.forEach(s=>{const o=s?.id??s?.reservationId??s?.reservation_code??null;o&&t.add(String(o))});let i=!1;Object.keys(n).forEach(s=>{t.has(s)||(delete n[s],i=!0)}),i&&We(n)}function Vn(e){if(!e)return[];const n=at(),t=String(e),i=n[t];return Array.isArray(i)?i:[]}function Hn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const n=et();if(!Array.isArray(n)||n.length===0)return[];const t=new Map;e.forEach(s=>{if(!s||typeof s!="object")return;const o=s.equipmentId??s.equipment_id??s.id??null;if(o==null)return;const r=String(o),a=(()=>{const l=[s.qty,s.quantity,s.count,1];for(const c of l){const u=Number(c);if(Number.isFinite(u)&&u>0)return u}return 1})();t.set(r,(t.get(r)||0)+a)});const i=[];return n.forEach((s,o)=>{const r=Pe(s)||[],a=new Map;let l=!0;if(r.forEach(g=>{const _=g?.equipmentId??g?.equipment_id??null,N=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(_==null){l=!1;return}const p=String(_);a.set(p,(a.get(p)||0)+N)}),!l||a.size===0)return;let c=1/0;for(const[g,_]of a.entries()){const N=t.get(g)||0,p=Math.floor(N/_);if(p<=0){c=0;break}p<c&&(c=p)}if(!Number.isFinite(c)||c<=0)return;for(const[g,_]of a.entries()){const N=t.get(g)||0;t.set(g,Math.max(0,N-c*_))}const u=fe(s?.id??s?.packageId??s?.package_id??s?.code),d=Array.from(a.entries()).map(([g,_])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:_,unit_price:0})),f=(s?.package_code??s?.code??u)||`pkg-${o}`,y=sn(s)||u||`package-${o}`;i.push({package_code:f,name:y,quantity:c,unit_price:St(s)||0,items:d})}),i}function On(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(n=>{const i=(n.positionLabel??"").trim().length>0,s=n.positionId!=null||n.positionKey!=null&&String(n.positionKey).trim()!=="",o=Number.isFinite(Number(n.positionClientPrice))&&Number(n.positionClientPrice)>0,r=Number.isFinite(Number(n.positionCost))&&Number(n.positionCost)>0;return i||s||o||r})}function Kn(e){return[]}function Vt(e=[]){return Array.isArray(e)?e.map((n,t)=>Yt(n,t)).filter(Boolean).map((n,t)=>{const i=fe(n.packageId??n.package_id??n.package_code??n.code??n.id??`pkg-${t}`),s=Be(n,i).map(c=>{const u=R(c.qty??c.quantity??c.count??c.units??c.unit_qty??c.unitQty??c.unit_count??c.unitCount??c.package_quantity??c.packageQty??1),d=J(I(c.price??c.unit_price??0));return{...c,qty:u,quantity:u,price:d,unit_price:d}}),o=R(n.quantity??n.qty??1);let r=J(I(n.unit_price??n.unitPrice??n.price??0));if(!r||r<=0){const c=s.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);c>0&&o>0&&(r=J(Number((c/o).toFixed(2))))}const a=I(n.total_price??n.totalPrice??n.total??r*o),l=a>0?J(a):J(Number((r*o).toFixed(2)));return{...n,packageId:i,package_id:i,qty:o,quantity:o,unit_price:r,unitPrice:r,price:r,total_price:l,total:l,packageItems:s}}):[]}function Le(e,n){if(!e)return;const t=jt(),i=String(e);if(!Array.isArray(n)||n.length===0){t[i]&&(delete t[i],At(t));return}t[i]=Vt(n),At(t)}function Qn(e){if(!e)return[];const n=jt(),t=String(e),i=n[t];return Array.isArray(i)?Vt(i):[]}function ot(e,n=0){if(e==null)return null;if(typeof e!="object"){const P=e!=null?String(e):null;return{assignmentId:`crew-${n}-${P??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:P,technicianName:null,technicianRole:null,notes:null}}const t=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${n}`,i=e&&typeof e.position=="object"?e.position:null,s=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,o=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let r=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";r||(r=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,l=e.position_label_en??null,c=e.position_label_alt??l??a??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,f=J(D(u)),y=J(D(d)),g=e&&typeof e.technician=="object"?e.technician:null,_=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,N=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,p=e.role??g?.role??e.specialization??null,h=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(t),positionId:s!=null?String(s):null,positionKey:o!=null?String(o):null,positionLabel:r!=null?String(r):"",positionLabelAlt:c!=null?String(c):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(f)?f:0,positionClientPrice:Number.isFinite(y)?y:0,technicianId:_!=null?String(_):null,technicianName:N!=null?String(N):null,technicianRole:p!=null?String(p):null,technicianPhone:h!=null?String(h):null,notes:e.notes??null}}function Un(){return te}function Ee(e){te=Array.isArray(e)?e.map(He):[],te.forEach(n=>{if(!n)return;const t=n.id??n.reservationId??n.reservationCode;Le(t,n.packages),Mn(t,n.items);const i=n.crewAssignments&&n.crewAssignments.length?n.crewAssignments:n.techniciansDetails||[];On(i)}),jn(te),Zt({reservations:te});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return te}async function Gn(e={}){const n=new URLSearchParams;Object.entries(e).forEach(([a,l])=>{l!=null&&l!==""&&n.set(a,String(l))});const t=n.toString(),s=(await ze(`/reservations/${t?`?${t}`:""}`))?.data;let o=[];Array.isArray(s)?o=s:s&&typeof s=="object"&&(Array.isArray(s.items)?o=s.items:Array.isArray(s.results)?o=s.results:Array.isArray(s.data)?o=s.data:Array.isArray(s.records)&&(o=s.records));const r=o.map(Ve).map(Ot);return Ee(r)}async function Wn(e){const n=await ze("/reservations/",{method:"POST",body:e}),t=Ve(n?.data??{}),i=Array.isArray(e?.items)?e.items:null;if(i&&(Array.isArray(t.items)&&t.items.length?t.items=Ht(t.items,i):t.items=i.map(Oe)),!Number.isFinite(t.companySharePercent)&&e?.company_share_percent!=null&&(t.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(t.paymentHistory)||t.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const s=st(e.payment_history);s.length&&(t.paymentHistory=s)}if((!Array.isArray(t.crewAssignments)||t.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const s=e.technicians.map((o,r)=>ot(o,r)).filter(Boolean);s.length&&(t.crewAssignments=s,t.techniciansDetails=s.map((o,r)=>{const a=e.technicians[r];return typeof a=="object"?{...a,...o}:o}))}if(Array.isArray(e?.packages)&&e.packages.length){const s=ut({packages:e.packages});t.packages=re(t.packages,s)}{const s=lt(t.items||[],t.packages||[]);t.items=s.items,t.packages=re(t.packages||[],s.packages)}if(Le(t.id??t.reservationId??t.reservation_code,t.packages),t.companySharePercent>0&&(!Number.isFinite(t.companyShareAmount)||t.companyShareAmount<=0)){const s=Ie({items:t.items||[],technicianIds:t.technicians||[],discount:t.discount,discountType:t.discountType,applyTax:t.applyTax,start:t.start,end:t.end,companySharePercent:t.companySharePercent});t.companyShareAmount=s.companyShareAmount,t.cost=s.finalTotal,t.totalAmount=s.finalTotal}return t.companyShareEnabled=e?.company_share_enabled?!0:t.companySharePercent>0,Ee([...te,t]),t}async function ct(e,n){const t=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:n}),i=Ve(t?.data??{}),s=Array.isArray(n?.items)?n.items:null;if(s&&(Array.isArray(i.items)&&i.items.length?i.items=Ht(i.items,s):i.items=s.map(Oe)),console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&n?.company_share_percent!=null&&(i.companySharePercent=Number(n.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(n?.payment_history)){const r=st(n.payment_history);r.length&&(i.paymentHistory=r,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(n?.technicians)&&n.technicians.length){const r=n.technicians.map((a,l)=>ot(a,l)).filter(Boolean);r.length&&(i.crewAssignments=r,i.techniciansDetails=r.map((a,l)=>{const c=n.technicians[l];return typeof c=="object"?{...c,...a}:a}))}if(Array.isArray(n?.packages))if(n.packages.length){const r=ut({packages:n.packages});i.packages=re(i.packages,r)}else i.packages=[];{const r=lt(i.items||[],i.packages||[]);i.items=r.items,i.packages=re(i.packages||[],r.packages)}if(Le(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const r=Ie({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=r.companyShareAmount,i.cost=r.finalTotal,i.totalAmount=r.finalTotal}i.companyShareEnabled=n?.company_share_enabled?!0:i.companySharePercent>0;const o=te.map(r=>String(r.id)===String(e)?i:r);return Ee(o),i}function Ht(e,n){if(!Array.isArray(e)||!Array.isArray(n))return e;const t=new Map;return n.forEach((i,s)=>{if(!i||typeof i!="object")return;const o=i.equipment_id??i.equipmentId??i.id??null,r=b(String(i.barcode??"")).trim(),a=o!=null?`id:${o}`:r?`bc:${r}`:`idx:${s}`,l=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,c=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;t.set(a,{cost:l,price:c})}),e.map((i,s)=>{const o=i.equipmentId??i.equipment_id??i.id??null,r=b(String(i.barcode??"")).trim(),a=[o!=null?`id:${o}`:null,r?`bc:${r}`:null,`idx:${s}`].filter(Boolean);let l=null;for(const u of a)if(t.has(u)){l=t.get(u);break}if(!l)return i;const c={...i};return Number.isFinite(l.cost)&&(c.cost=l.cost,c.unit_cost=l.cost),Number.isFinite(l.price)&&(c.price=l.price,c.unit_price=l.price),c})}function Ot(e){try{return Yn(e)}catch(n){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",n),e}}function Yn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!n.length)return e;const t=te.find(o=>{if(!o)return!1;const r=o.id!=null?String(o.id):"",a=o.reservationId!=null?String(o.reservationId):"",l=o.reservation_code!=null?String(o.reservation_code):"";return r&&n.includes(r)||a&&n.includes(a)||l&&n.includes(l)});if(!t||!Array.isArray(t.items))return e;const i=new Map;t.items.forEach((o,r)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=b(String(o?.barcode??"")).trim(),c=a!=null?`id:${a}`:l?`bc:${l}`:`idx:${r}`;i.set(c,o)});const s=e.items.map((o,r)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=b(String(o?.barcode??"")).trim(),c=[a!=null?`id:${a}`:null,l?`bc:${l}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const g of c)if(i.has(g)){u=i.get(g);break}if(!u)return o;const d={...o},f=Number(u.cost),y=Number(u.price);return Number.isFinite(f)&&f>0&&(d.cost=f,d.unit_cost=f),Number.isFinite(y)&&y>0&&(d.price=y,d.unit_price=y),d});return{...e,items:s}}function Jn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!n.length)return e;let t=[];for(const o of n)if(t=Vn(o),t.length)break;if(!t.length)return e;const i=new Map;t.forEach((o,r)=>{if(!o||typeof o!="object")return;const a=o.equipmentId??o.equipment_id??null,l=b(String(o.barcode??"")).trim(),c=a!=null?`id:${a}`:l?`bc:${l}`:`idx:${r}`;i.set(c,o)});const s=e.items.map((o,r)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=b(String(o?.barcode??"")).trim(),c=[a!=null?`id:${a}`:null,l?`bc:${l}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const h of c)if(i.has(h)){u=i.get(h);break}if(!u)return o;const d={...o},f=J(I(u.cost??u.unit_cost)),y=J(I(u.price??u.unit_price)),g=Number.isFinite(f),_=Number.isFinite(y),N=Number(o.cost),p=Number(o.price);return g&&(!Number.isFinite(N)||N<=0)&&(d.cost=f,d.unit_cost=f),_&&(!Number.isFinite(p)||p<=0)&&(d.price=y,d.unit_price=y),d});return{...e,items:s}}async function Xn(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const n=te.filter(t=>String(t.id)!==String(e));Ee(n),Le(e,null)}async function Zn(e){return ct(e,{status:"confirmed",confirmed:!0})}async function ei(e,n=null){const t={status:"completed",confirmed:!0};return typeof n=="string"&&(t.notes=n),ct(e,t)}function Ve(e={}){const n=He({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});return Jn(Ot(n))}function Kt(e={}){return He(e)}function He(e={}){const n=e.id??e.reservation_id??e.reservationId??null,t=e.reservation_code??e.reservationCode??e.reservationId??(n!=null?`RSV-${n}`:null);let i=Array.isArray(e.items)?e.items.map(Oe):[],s=ut(e);const o=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let r=o.map((x,ee)=>ot(x,ee)).filter(Boolean),a=r.map((x,ee)=>{const v=o?.[ee];return{...v&&typeof v=="object"?{...v}:v!=null?{id:v}:{},...x}});const l=r.map(x=>x.technicianId).filter(x=>x!=null&&x!=="").map(x=>Number.isNaN(Number(x))?String(x):Number(x)),c=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=I(e.total_amount??e.totalAmount??e.cost??0);const f=I(e.discount??0),y=e.discount_type??e.discountType??"percent",g=["percent","amount"].includes(y)?y:"percent",_=!!(e.apply_tax??e.applyTax??!1);let N=li(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),h=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,P=h!=null?Number.parseFloat(b(String(h).replace("%","").trim())):NaN,k=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let S=k!=null?k===!0||k===1||k==="1"||String(k).toLowerCase()==="true":Number.isFinite(P)&&P>0,A=S&&Number.isFinite(P)?Number(P):0;const q=e.company_share_amount??e.companyShareAmount;let L=Number.isFinite(Number(q))?Number(q):NaN;_&&A<=0&&(A=$t,S=!0);const B=Ie({items:i,technicianIds:l,crewAssignments:r,discount:f,discountType:g,applyTax:_,start:c,end:u,companySharePercent:A>0?A:null});(!Number.isFinite(d)||d<=0||_)&&(d=B.finalTotal),(!Number.isFinite(L)||L<0)&&(L=B.companyShareAmount),L=Number.isFinite(L)?Number(L.toFixed(2)):0,!S&&A>0&&(S=!0);const w=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],m=ni(w),U=st(m),H=n??t??e.reservation_code??e.reservationId??null;if(s.length)Le(H,s);else{const x=Qn(H);x.length&&(s=re(s,x))}if(!s.length&&Array.isArray(i)&&i.length)try{const x=Hn(i);Array.isArray(x)&&x.length&&(s=re(s,x))}catch(x){console.warn("[reservationsService] inference of packages from items failed",x)}const Z=lt(i,s);i=Z.items,s=re(s,Z.packages);const O=nt({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:U});N=it({manualStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,totalAmount:d});const K=N==="paid",Q=ri(e.status??(p?"confirmed":"pending"));return{id:n!=null?String(n):"",reservationId:t??(n!=null?String(n):""),reservationCode:t??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:c,end:u,status:Q,completed:Q==="completed",confirmed:p,location:e.location??"",notes:e.notes??"",discount:f,discountType:g,applyTax:_,paid:K,paidStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,paymentProgressType:O.paymentProgressType,paymentProgressValue:O.paymentProgressValue,paymentHistory:U,payment_history:U,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:r,techniciansDetails:a,startDatetime:c,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:s,companySharePercent:A,companyShareAmount:L,companyShareEnabled:S}}function Oe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const n=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,t=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=I(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),s=I(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),o=b(String(e.barcode??e.code??e.serial??"")),r=e.description??e.desc??e.name??e.title??"",a={id:e.id!=null?String(e.id):n!=null?String(n):"",equipmentId:n,barcode:o,desc:r,qty:t,quantity:t,qtyPerPackage:null,totalQuantity:t,price:i,cost:s,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},l=Qt(e.type??e.item_type??e.kind??null),c=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=W(c),d=Be(e,u);if(l==="package"||u||d.length){a.type="package";const f=u||(n!=null?String(n):a.id?W(a.id):"");f&&(a.packageId=f,a.package_id=f,a.package_code=e.package_code??e.packageCode??f),a.name=r||a.package_code||f||"",a.barcode=a.barcode||b(String(e.package_code??e.packageCode??"")),a.packageItems=d;const y=Gt({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,t);(!Number.isFinite(a.price)||a.price<=0||a.price>y*10)&&(a.price=y),a.qtyPerPackage=d.length?d[0]?.qtyPerPackage??a.qtyPerPackage:a.qtyPerPackage,a.totalQuantity=t}return a}function ti({reservationCode:e,customerId:n,start:t,end:i,status:s,title:o,location:r,notes:a,projectId:l,totalAmount:c,discount:u,discountType:d,applyTax:f,paidStatus:y,confirmed:g,items:_,packages:N,crewAssignments:p=[],technicians:h=p,companySharePercent:P,companyShareEnabled:k,paidAmount:S,paidPercentage:A,paymentProgressType:q,paymentProgressValue:L,paymentHistory:B}){const w=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:n,start_datetime:t,end_datetime:i,status:s??"pending",title:o??null,location:r??null,notes:a??null,project_id:l||null,total_amount:c??0,discount:u??0,discount_type:d??"percent",apply_tax:f?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(S)?I(S):0,paid_percentage:Number.isFinite(A)?Number(A.toFixed(2)):0,payment_progress_type:q??null,payment_progress_value:Number.isFinite(L)?Number(L.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(m=>({type:Ye(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?I(m.value):null,amount:m?.amount!=null?I(m.amount):m?.payment_amount!=null?I(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(m=>({type:Ye(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?I(m.value):null,amount:m?.amount!=null?I(m.amount):m?.payment_amount!=null?I(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:ii(_),packages:ai(_,N),company_share_percent:k&&Number.isFinite(P)?Number(P):null,company_share_enabled:k?1:0,technicians:w.length?w.map((m,U)=>{const H=m.technicianId??m.technician_id??m.id??null,Z=m.positionId??m.position_id??m.position??m.position_code??null,O=m.positionLabel??m.position_name??m.role??null,K=I(m.positionCost??m.position_cost??m.cost??m.daily_wage??m.dailyWage??0),Q=I(m.positionClientPrice??m.position_client_price??m.client_price??m.clientPrice??m.daily_total??m.dailyTotal??m.total??0);return{id:H,technician_id:H,role:O??m.technicianRole??null,notes:m.notes??null,position_id:Z,position_key:m.positionKey??m.position_key??null,position_name:O,position_label_ar:m.positionLabelAr??m.position_label_ar??null,position_label_en:m.positionLabelEn??m.position_label_en??null,position_cost:K,position_client_price:Q,client_price:Q,cost:K,assignment_id:m.assignmentId??m.assignment_id??`crew-${U}`}}):Array.isArray(h)?h.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function st(e){const n=rt(e);return!Array.isArray(n)||n.length===0?[]:n.map(t=>{if(!t||typeof t!="object")return null;const i=t.type??t.payment_type??t.paymentType??t.method??t.paymentMethod??t.kind??null,s=Ye(i),o=t.value??t.payment_value??t.paymentValue??t.amount??t.payment_amount??t.percentage??t.payment_percentage??null,r=o!=null?Number.parseFloat(b(String(o))):null,a=t.amount!=null?Number.parseFloat(b(String(t.amount))):t.payment_amount!=null?Number.parseFloat(b(String(t.payment_amount))):null,l=t.percentage!=null?Number.parseFloat(b(String(t.percentage))):t.payment_percentage!=null?Number.parseFloat(b(String(t.payment_percentage))):null,c=Number.isFinite(a)?a:s==="amount"&&Number.isFinite(r)?r:null,u=Number.isFinite(l)?l:s==="percent"&&Number.isFinite(r)?r:null,d=s??(c!=null?"amount":u!=null?"percent":null),f=d==="amount"?c:d==="percent"?u:Number.isFinite(r)?r:null,y=t.note??t.notes??t.comment??t.payment_note??null,g=t.recordedAt??t.recorded_at??t.payment_date??t.date??t.createdAt??t.created_at??null;return{type:d,value:f,amount:c,percentage:u,note:y,recordedAt:g}}).filter(t=>t&&t.type)}function Ye(e){if(!e)return null;const n=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(n)?"amount":["percent","percentage","ratio"].includes(n)?"percent":null}function rt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const n=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of n)if(Array.isArray(e[r]))return e[r];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(i))return i;const s=Object.values(e);if(s.length&&s.every(r=>r&&typeof r=="object")){const r=s.map(a=>a);if(r.every(a=>!Array.isArray(a)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const n=JSON.parse(e);return rt(n)}catch{return[]}return[]}function ni(e=[]){if(!Array.isArray(e))return[];for(const n of e){const t=rt(n);if(Array.isArray(t)&&t.length)return t}return[]}function ii(e){if(!Array.isArray(e)||e.length===0)return[];const n=[];return e.forEach(t=>{if(!t||typeof t!="object")return;if(t.type==="package"&&Array.isArray(t.packageItems)&&t.packageItems.length){const r=R(t.qty??t.quantity??1);t.packageItems.forEach(a=>{const l=a?.equipmentId??a?.equipment_id??a?.id??null;if(l==null)return;const c=R(a?.qty??a?.quantity??1),u=r*c,d=I(a?.cost??a?.unit_cost??a?.rental_cost??a?.internal_cost??a?.purchase_price??a?.equipment_cost??0);n.push({equipment_id:Je(l),quantity:u,unit_price:I(a?.price??a?.unit_price??0),unit_cost:d,cost:d,total_cost:Number.isFinite(d)?Number((d*u).toFixed(2)):0,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,notes:a?.notes??null})});return}const i=Array.isArray(t.packageItems)?t.packageItems:[],s=t.equipmentId??t.equipment_id??t.id??null;if(s==null)return;const o=(()=>{const r=I(t.cost??t.unit_cost??t.rental_cost??t.internal_cost??t.purchase_price??t.equipment_cost??0);if(Number.isFinite(r)&&r>0)return r;if(i.length){const a=i.reduce((l,c)=>{const u=I(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.internal_cost??c.purchase_price??c.equipment_cost??c.item_cost??0),d=R(c.qty??c.quantity??c.qtyPerPackage??c.unit_qty??1);return l+u*d},0);if(a>0)return Number(a.toFixed(2))}return r})();n.push({equipment_id:Je(s),quantity:R(t.qty??t.quantity??1),unit_price:I(t.price??t.unit_price??0),unit_cost:o,cost:o,total_cost:Number.isFinite(o)?Number((o*R(t.qty??t.quantity??1)).toFixed(2)):0,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,notes:t.notes??null})}),n}function Je(e){const n=Number(e);return Number.isFinite(n)&&n>=0?n:String(e)}function ai(e,n){const t=Array.isArray(n)?n.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const s=R(i.qty??i.quantity??1),o=Array.isArray(i.packageItems)?i.packageItems.map(a=>{const l=a?.equipmentId??a?.equipment_id??a?.id??null;if(l==null)return null;let c=I(a?.cost??a?.unit_cost??a?.rental_cost??a?.internal_cost??a?.purchase_price??a?.equipment_cost??0);if((!Number.isFinite(c)||c===0)&&l!=null){const u=Ct(l);Number.isFinite(u)&&u>0&&(c=u)}return{equipment_id:Je(l),quantity:R(a?.qty??a?.quantity??a?.count??a?.units??a?.unit_qty??a?.unitQty??a?.unit_count??a?.unitCount??a?.package_quantity??a?.packageQty??1),unit_price:I(a?.price??a?.unit_price??0),unit_cost:c,cost:c,rental_cost:c,purchase_price:c,internal_cost:c,equipment_cost:c,item_cost:c}}).filter(Boolean):[];let r=I(i.cost??i.unit_cost??i.rental_cost??i.internal_cost??i.purchase_price??i.equipment_cost??0);if((!Number.isFinite(r)||r===0)&&i.equipmentId!=null){const a=Ct(i.equipmentId);Number.isFinite(a)&&a>0&&(r=a)}if((!Number.isFinite(r)||r===0)&&o.length){const a=o.reduce((l,c)=>{const u=I(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.internal_cost??c.purchase_price??c.equipment_cost??c.item_cost??0),d=R(c.qty??c.quantity??c.qtyPerPackage??1);return l+u*d},0);a>0&&(r=Number(a.toFixed(2)))}t.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:s,unit_price:I(i.price??i.unit_price??0),unit_cost:r,cost:r,total_cost:Number.isFinite(r)?Number((r*s).toFixed(2)):0,rental_cost:r,purchase_price:r,internal_cost:r,equipment_cost:r,item_cost:r,items:o})}),t}function Qt(e){if(e==null)return"";const n=String(e).trim().toLowerCase();return n==="package"||n==="bundle"||n==="pack"?"package":n}function W(e){if(e==null)return"";const n=String(e).replace(/^package::/i,"");return fe(n)}function Xe(e){return e==null?"":b(String(e)).trim().toLowerCase()}function Ut(e={},n=1){if(!e||typeof e!="object"){const c=b(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:c,normalizedBarcode:Xe(c),desc:"",image:null}}const t=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=I(e.unit_price??e.unitPrice??e.price??0),o=I(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),r=b(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),a=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let l;if(a!=null)l=R(a,{fallback:1,max:99});else if(n>0){const c=i/n;Number.isFinite(c)&&c>0&&Number.isInteger(c)?l=R(c,{fallback:1,max:99}):l=Math.min(i,99)}else l=Math.min(i,99);return{equipmentId:t!=null?String(t):null,equipment_id:t,qty:l,quantity:l,qtyPerPackage:l,totalQuantity:i,price:s,unit_price:s,cost:o,unit_cost:o,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,barcode:r,normalizedBarcode:Xe(e.normalizedBarcode??r),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function oi(e={},n={}){const t=W(e.packageId??e.package_id??e.id??n.packageId??n.package_id??n.id??""),i=R(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),s=I(e.unit_price??e.unitPrice??e.price??n.price??n.unit_price??n.unitPrice??0);let o=I(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??n.unit_cost??n.unitCost??n.cost??0);if((!Number.isFinite(o)||o===0)&&Array.isArray(e.packageItems)&&e.packageItems.length){const a=e.packageItems.reduce((l,c)=>{const u=I(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.purchase_price??c.internal_cost??c.equipment_cost??c.item_cost??0),d=R(c.qty??c.quantity??c.qtyPerPackage??1);return l+u*d},0);a>0&&(o=Number(a.toFixed(2)))}const r=b(String(e.package_code??e.packageCode??e.barcode??n.package_code??n.packageCode??n.barcode??""));return{id:n.id??(e.id!=null?String(e.id):t?`package::${t}`:""),equipmentId:null,barcode:r,desc:n.desc??n.description??e.name??e.desc??e.title??r,qty:i,quantity:i,price:s,cost:o,unit_cost:o,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,notes:n.notes??null,image:e.image??n.image??null,type:"package",packageId:t,package_id:t,package_code:r,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(n.packageItems)?n.packageItems:[]}}function lt(e=[],n=[]){const t=ci(e),i=Array.isArray(n)?re(n,t.packages):t.packages,s=new Map;return i.forEach(o=>{const r=W(o.packageId??o.package_id??o.id);r&&s.set(r,o)}),t.packages.forEach(o=>{const r=W(o.packageId??o.package_id??o.id);if(!r)return;const a=s.get(r);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=o.packageItems),!a.name&&o.name&&(a.name=o.name),!a.image&&o.image&&(a.image=o.image))}),{items:t.items,packages:Array.from(s.values())}}function ci(e=[]){const n=new Map;if(e.forEach(o=>{const r=W(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(!r)return;const a=r;n.has(a)||n.set(a,{base:o,items:[]}),n.get(a).items.push(o)}),!n.size)return{items:e,packages:[]};const t=[],i=[],s=new Set;return e.forEach(o=>{const r=W(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(r&&n.has(r)){if(s.has(r))return;const a=n.get(r),l=a.base||o,c=a.items.map(f=>Ut(f,1)),u=(()=>{const f=I(l.unit_cost??l.unitCost??l.cost??l.rental_cost??l.internal_cost??l.purchase_price??l.equipment_cost??l.item_cost??0);if(Number.isFinite(f)&&f>0)return f;if(c.length){const y=c.reduce((g,_)=>{const N=I(_.cost??_.unit_cost??_.unitCost??_.rental_cost??_.internal_cost??_.purchase_price??_.equipment_cost??_.item_cost??0),p=R(_.qty??_.quantity??_.qtyPerPackage??1);return g+N*p},0);if(y>0)return Number(y.toFixed(2))}return f})(),d={packageId:r,package_id:r,package_code:l.package_code??l.packageCode??l.barcode??b(String(r)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${r}`,quantity:R(l.package_quantity??l.packageQty??1,{fallback:1,max:9999}),unit_price:I(l.package_price??l.packagePrice??l.price??0),unit_cost:u,unitCost:u,cost:u,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u,packageItems:c,image:l.image??null};i.push(d),t.push(oi(d,l)),s.add(r);return}t.push(o)}),{items:t,packages:i}}function Be(e={},n=""){if(!e||typeof e!="object")return[];const t=W(n||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let s=Pe({...e,id:e.id??t??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??t,items:i,packageItems:i}),o=[];if((!Array.isArray(s)||s.length===0)&&t){const c=_e(t);c&&(s=Pe(c),o=Array.isArray(s)?s:[])}else if(t){const c=_e(t);c&&(o=Pe(c)||[])}if(!Array.isArray(s)||s.length===0)return[];const r=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=s.map(c=>Ut(c,r));if(o.length){const c=new Map;o.forEach(u=>{if(!u)return;const d=Xe(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&c.set(d,u)}),a.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!c.has(d))return;const f=c.get(d),y=R(f.quantity??f.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=y,u.qty=y,u.quantity=y;const g=I(f.unit_price??f.unitPrice??f.price??u.price);u.price=g,u.unit_price=g,!u.desc&&f.desc&&(u.desc=f.desc),!u.image&&f.image&&(u.image=f.image)})}const l=new Map;return a.forEach(c=>{const u=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=c.qty,d.quantity+=c.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=c.qtyPerPackage),(!d.price||d.price===0)&&c.price&&(d.price=c.price,d.unit_price=c.unit_price),!d.desc&&c.desc&&(d.desc=c.desc),!d.image&&c.image&&(d.image=c.image);return}l.set(u,{...c})}}),Array.from(l.values())}function Gt(e={},n=[],t=1){try{const o=W(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(o){const r=_e(o);if(r){const a=St(r);if(Number.isFinite(Number(a))&&Number(a)>0)return Number(a)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return I(i);const s=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(s))){const o=I(s);return t>0?Number((o/t).toFixed(2)):o}return 0}function Wt(e,n){if(!e)return n;if(!n)return e;const t={...e},i=r=>{(t[r]===void 0||t[r]===null||t[r]==="")&&(t[r]=n[r])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(t.unit_price))||t.unit_price===0)&&Number.isFinite(Number(n.unit_price))&&(t.unit_price=n.unit_price,t.unitPrice=n.unitPrice,t.price=n.price);const s=I(t.unit_cost??t.unitCost??t.cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost),o=I(n.unit_cost??n.unitCost??n.cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost);if((!Number.isFinite(s)||s===0)&&Number.isFinite(o)){const r=o;t.unit_cost=r,t.unitCost=r,t.cost=r,t.total_cost=Number.isFinite(n.total_cost)?n.total_cost:t.total_cost,Number.isFinite(t.rental_cost)||(t.rental_cost=r),Number.isFinite(t.purchase_price)||(t.purchase_price=r),Number.isFinite(t.internal_cost)||(t.internal_cost=r),Number.isFinite(t.equipment_cost)||(t.equipment_cost=r),Number.isFinite(t.item_cost)||(t.item_cost=r)}return(!Number.isFinite(Number(t.total_price))||t.total_price===0)&&Number.isFinite(Number(n.total_price))&&(t.total_price=n.total_price,t.total=n.total),!Array.isArray(t.packageItems)||t.packageItems.length===0?(t.packageItems=Array.isArray(n.packageItems)?n.packageItems:[],t.items=t.packageItems):Array.isArray(n.packageItems)&&n.packageItems.length&&(t.packageItems=si(t.packageItems,n.packageItems),t.items=t.packageItems),t}function si(e=[],n=[]){const t=new Map,i=s=>{s.forEach(o=>{if(!o)return;const r=o.normalizedBarcode||(o.equipmentId?`id:${o.equipmentId}`:null);if(r){if(t.has(r)){const a=t.get(r);a.qty+=o.qty??0,a.quantity+=o.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(o.qtyPerPackage)&&(a.qtyPerPackage=o.qtyPerPackage),(!a.price||a.price===0)&&o.price&&(a.price=o.price,a.unit_price=o.unit_price);const l=I(a.cost??a.unit_cost??a.unitCost??a.rental_cost??a.purchase_price??a.internal_cost??a.equipment_cost??a.item_cost),c=I(o.cost??o.unit_cost??o.unitCost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);if((!Number.isFinite(l)||l===0)&&Number.isFinite(c)){const u=c;a.cost=u,a.unit_cost=u,a.unitCost=u,Number.isFinite(a.rental_cost)||(a.rental_cost=u),Number.isFinite(a.purchase_price)||(a.purchase_price=u),Number.isFinite(a.internal_cost)||(a.internal_cost=u),Number.isFinite(a.equipment_cost)||(a.equipment_cost=u),Number.isFinite(a.item_cost)||(a.item_cost=u)}!a.desc&&o.desc&&(a.desc=o.desc),!a.image&&o.image&&(a.image=o.image);return}t.set(r,{...o})}})};return i(e),i(n),Array.from(t.values())}function re(e=[],n=[]){const t=[],i=new Map,s=et(),o=new Map;s.forEach(l=>{const c=W(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&o.set(u,c||u)});const r=l=>{const c=W(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?b(u):"";return c||(d&&o.has(d)?o.get(d):d||null)},a=l=>{Array.isArray(l)&&l.forEach(c=>{if(!c||typeof c!="object")return;const u=r(c);if(u)if(i.has(u)){const d=i.get(u);t[d]=Wt(t[d],c)}else i.set(u,t.length),t.push({...c})})};return a(e),a(n),t}function Ct(e){if(e==null)return 0;const n=ue()||{},i=(Array.isArray(n.equipment)?n.equipment:[]).find(o=>[o.id,o.equipment_id,o.equipmentId,o.item_id,o.itemId].some(a=>String(a)===String(e)));if(!i)return 0;const s=I(i.cost??i.unit_cost??i.unitCost??i.rental_cost??i.purchase_price??i.internal_cost??i.equipment_cost??i.item_cost??0);return Number.isFinite(s)&&s>0?s:0}function Yt(e,n=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const g=W(e),_=g?_e(g):null,N=_?Be(_,g):[],p=_?I(_.price??_.unit_price??_.unitPrice??0):0,P=(()=>{const q=_?.unit_cost??_?.unitCost??_?.cost??_?.rental_cost??_?.internal_cost??_?.purchase_price??_?.equipment_cost??_?.item_cost;if(Number.isFinite(Number(q)))return I(q);if(Array.isArray(N)&&N.length){const L=N.reduce((B,w)=>{const m=I(w.cost??w.unit_cost??w.unitCost??w.rental_cost??w.internal_cost??w.purchase_price??w.equipment_cost??w.item_cost??0),U=R(w.qty??w.quantity??w.qtyPerPackage??1);return B+m*U},0);if(L>0)return Number(L.toFixed(2))}return 0})(),k=1,S=Number((p*k).toFixed(2)),A=Number((P*k).toFixed(2));return{id:`package::${g||n}`,packageId:g||`pkg-${n}`,package_id:g||`pkg-${n}`,package_code:b(String(e))||g||`pkg-${n}`,name:_?.name??_?.package_name??_?.packageName??b(String(e))??"",desc:_?.name??b(String(e))??"",quantity:k,qty:k,unit_price:p,unitPrice:p,price:p,unit_cost:P,unitCost:P,cost:P,total_cost:A,rental_cost:P,purchase_price:P,internal_cost:P,equipment_cost:P,item_cost:P,total:S,total_price:S,barcode:b(String(e)),packageItems:N,items:N,type:"package",image:_?.image??null}}if(typeof e!="object")return null;const t=W(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${n}`,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=Be(e,t),o=Gt(e,s,i),a=(()=>{const g=e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost;if(Number.isFinite(Number(g)))return I(g);if(Array.isArray(s)&&s.length){const _=s.reduce((N,p)=>{const h=I(p.cost??p.unit_cost??p.unitCost??p.rental_cost??p.internal_cost??p.purchase_price??p.equipment_cost??p.item_cost??0),P=R(p.qtyPerPackage??p.qty??p.quantity??p.count??1);return N+h*P},0);if(_>0)return Number(_.toFixed(2))}return 0})(),l=e.total_price??e.totalPrice??e.total??o*i,c=Number.isFinite(Number(l))?I(l):Number((o*i).toFixed(2)),u=Number.isFinite(a)?Number((a*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??t,f=b(String(e.barcode??d??"")),y=e.image??e.cover??e.thumbnail??s.find(g=>g.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,packageId:t,package_id:t,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??t,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??t,quantity:i,qty:i,unit_price:o,unitPrice:o,price:o,unit_cost:a,unitCost:a,cost:a,total_cost:u,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,total:c,total_price:c,barcode:f,packageItems:s,items:s,type:"package",image:y}}function ut(e={}){const n=[];Array.isArray(e.packages)&&n.push(e.packages),Array.isArray(e.reservation_packages)&&n.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&n.push(e.reservationPackages),Array.isArray(e.package_details)&&n.push(e.package_details),Array.isArray(e.packageDetails)&&n.push(e.packageDetails),Array.isArray(e.package_list)&&n.push(e.package_list),Array.isArray(e.packageList)&&n.push(e.packageList);const t=[],i=new Map,s=(a,l=t.length)=>{const c=Yt(a,l);if(!c)return;const u=c.packageId||c.package_code||c.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);t[d]=Wt(t[d],c)}else i.set(u,t.length),t.push(c)};n.forEach(a=>{a.forEach((l,c)=>{s(l,c+t.length)})}),t.length===0&&e.package&&s(e.package,0);const o=Array.isArray(e.items)?e.items:[],r=(a={})=>!a||typeof a!="object"?!1:!!(Qt(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(c=>typeof c=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return o.forEach((a,l)=>{r(a)&&s(a,t.length+l)}),t}function I(e){const n=D(e);return Number.isFinite(n)?Number(n.toFixed(2)):0}function R(e,{fallback:n=1,max:t=1e6}={}){const i=D(e);if(!Number.isFinite(i))return n;const s=Math.round(i);return s<=0||s>t?n:s}function ri(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function li(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function ui(e){return e instanceof en}const Ai=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:ti,closeReservationApi:ei,confirmReservationApi:Zn,createReservationApi:Wn,deleteReservationApi:Xn,getCachedReservationCrew:Kn,getReservationsState:Un,isApiError:ui,mapLegacyReservation:Kt,mapReservationFromApi:Ve,mapReservationItem:Oe,refreshReservationsFromApi:Gn,setReservationsState:Ee,toInternalReservation:He,updateReservationApi:ct},Symbol.toStringTag,{value:"Module"}));export{He as A,Dn as B,qn as C,$t as D,D as E,$ as F,Kn as G,_i as H,bn as I,yi as J,Kt as K,In as L,Zn as M,ei as N,Ai as O,Ni as a,wn as b,nt as c,Ie as d,it as e,Xn as f,Un as g,Pi as h,mi as i,hi as j,hn as k,xn as l,Ve as m,Tt as n,Cn as o,Fn as p,An as q,Gn as r,fi as s,ti as t,ct as u,Wn as v,ui as w,gi as x,mt as y,bi as z};
