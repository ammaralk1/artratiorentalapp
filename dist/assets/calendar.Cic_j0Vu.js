import{b as oe,g as O,s as q,h as le,r as de}from"./reservationsService.B1PaZFeJ.js";import{t as l,g as M,l as B}from"./auth.B-7mf_rT.js";import{e as ce,b as P}from"./controller.CCLrCeiS.js";const ue={limit:200};let c=null,U=!1,K=!1,Z=!1,J=null,R=null,Q=!1,F=null,N=null,D=!1,h="",I=null;const $=new Map;function w(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function H(){const e=document.getElementById("calendar"),n=document.getElementById("calendar-panel")||e?.parentElement||null,r=document.getElementById("calendar-status");return{calendarEl:e,panelEl:n,statusEl:r}}function X(){try{if(typeof FullCalendar<"u")return FullCalendar}catch{}return typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof global<"u"&&global.FullCalendar?global.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}async function fe(){const e=X();return e||I||(I=new Promise(n=>{try{const r="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js",a=document.createElement("script");a.src=r,a.async=!0,a.onload=()=>n(X()),a.onerror=()=>n(null),document.head.appendChild(a)}catch{n(null)}}),I)}function me(){if(typeof window>"u")return null;const e=window.tui?.Calendar||window.toastui?.Calendar||window.Calendar;return typeof e=="function"?e:null}function pe(e){return $.has(e)||$.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),$.get(e)}function V(e,n,r=!1){if(r){const m=(M?.()==="en"?"en":"ar")==="en"?"All day":"Ø·ÙˆØ§Ù„ Ø§Ù„ÙŠÙˆÙ…";return l("calendar.labels.allDay",m)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const s=M?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",o=pe(s),t=o.format(a);if(!n)return t;const d=new Date(n);if(Number.isNaN(d.getTime()))return t;const p=o.format(d);return t===p?t:`${t} â€“ ${p}`}function ge({paid:e,confirmed:n,completed:r}){const a=["calendar-event"];return(r===!0||r==="true")&&a.push("calendar-event--completed"),n===!0||n==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function be(e){try{const{event:n}=e||{},r=n?.extendedProps||{},a=V(n?.startStr,n?.endStr,n?.allDay),s=r?.reservationId?String(r.reservationId):n?.id!=null?String(n.id):"â€”",o=r?.customerName||l("calendar.labels.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),t=r?.confirmed===!0||r?.confirmed==="true",d=r?.paid===!0||r?.paid==="paid",p=r?.completed===!0||r?.completed==="true",u=(E,L)=>`<span class="calendar-chip ${E}">${w(L)}</span>`,m=t?l("calendar.badges.confirmed","Ù…Ø¤ÙƒØ¯"):l("calendar.badges.pending","ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),f=d?l("calendar.badges.paid","Ù…Ø¯ÙÙˆØ¹"):l("calendar.badges.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),C=[u(t?"status-confirmed":"status-pending",m),u(d?"status-paid":"status-unpaid",f)];return p&&C.push(u("status-completed",l("calendar.badges.completed","Ù…Ù†ØªÙ‡ÙŠ"))),{html:`
      <div class="calendar-event-wrapper">
        <div class="calendar-event-card">
          <div class="calendar-event-card__head">
            <span class="calendar-event-card__time">${w(a||"")}</span>
            <span class="calendar-event-card__id">${w(s)}</span>
          </div>
          <div class="calendar-event-card__customer">${w(o)}</div>
          <div class="calendar-event-card__chips">${C.join("")}</div>
        </div>
      </div>`}}catch{return{html:""}}}function he(){const{calendarEl:e}=H();if(!e)return;const n=e.querySelector(".fc-header-toolbar");if(!n)return;n.classList.add("calendar-toolbar"),n.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const r=n.querySelector(".fc-toolbar-title");r&&r.classList.add("calendar-toolbar__title"),n.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function v({loading:e=!1,error:n="",empty:r=!1}={}){const{panelEl:a,statusEl:s}=H();if(!a||!s)return;const o=typeof n=="string"?n.trim().length>0:!!n,t=!e&&!o&&!!r,d=e||o||t;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",o),a.classList.toggle("is-empty",t),s.dataset.initialized||(s.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),s.dataset.initialized="true"),s.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),s.classList.toggle("hidden",!d),!d){s.innerHTML="",s.removeAttribute("data-status");return}let p="";e?p=l("calendar.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª..."):o?p=typeof n=="string"&&n.trim().length>0?n:l("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹."):t&&(p=l("calendar.status.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©."));const u=e?"loading":o?"error":"empty";if(s.setAttribute("data-status",u),s.classList.add(`calendar-status-card--${u}`),s.innerHTML="",e){const f=document.createElement("span");f.className="loading loading-spinner loading-md text-primary",f.setAttribute("aria-hidden","true"),s.appendChild(f)}else{const f=document.createElement("span");f.className="calendar-status-card__icon",f.setAttribute("aria-hidden","true"),f.textContent=o?"âš ï¸":"ğŸ—“ï¸",s.appendChild(f)}const m=document.createElement("span");m.className="calendar-status-card__message text-center text-sm font-semibold",m.textContent=p,s.appendChild(m)}function ne(e,n=null){if(!e||typeof e!="object")return null;const r=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??r;if(!r)return null;String(e.status??"").toLowerCase();const s=e.paidStatus??e.paid_status??null,o=e.paid!=null?e.paid:s==="paid",{effectiveConfirmed:t}=de(e,n),d=e.reservationId??e.reservationCode??e.reservation_code??e.id??r,p=e.customerName??e.customer_name??"";let u=!!e.completed;if(!u&&a){const m=new Date(a);Number.isNaN(m.getTime())||(u=m<new Date)}return{id:e.id??d??r,start:r,end:a||r,paid:o,confirmed:t,completed:u,reservationId:d??"",customerName:p,raw:e}}function we(e=[]){const{projects:n=[]}=B(),r=new Map(n.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,o=s!=null&&s!==""&&r.get(String(s))||null,t=ne(a,o);if(!t)return null;const d=ge({paid:t.paid,confirmed:t.confirmed,completed:t.completed});return{id:t.id,title:"",start:t.start,end:t.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:d,extendedProps:{...a,raw:a,paid:t.paid,confirmed:t.confirmed,completed:t.completed,reservationId:t.reservationId,customerName:t.customerName}}}).filter(Boolean)}async function Y(){if(D)return O();D=!0,h="";try{await ce({suppressError:!1,params:ue})}catch(e){console.error("âŒ [calendar] Failed to load reservations for calendar view",e),h=oe(e)?e.message:e instanceof Error&&e.message||""}finally{D=!1}return O()}function _(){if(c){try{typeof c.destroy=="function"&&c.destroy()}catch{}c=null}}function ee(e){const n={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:n})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:n}))}function ae(){se()}function ye(){U||(document.addEventListener("language:changed",()=>{c&&c.setOption("locale",M()),se()}),U=!0),K||(document.addEventListener("reservations:changed",()=>{ae()}),K=!0)}function W(e){return e<=480?"xs":e<=768?"sm":"lg"}function re(){if(typeof window>"u")return"month";const e=window.innerWidth||1024,n=W(e);return n==="xs"?"day":n==="sm"?"week":"month"}function T(){if(!c)return;const e=typeof window<"u"&&window.innerWidth||1024,n=W(e),r=c.__isFullCalendar?ie():re();J!==n&&typeof c.changeView=="function"&&(J=n,c.changeView(r,!0))}function ve(){Z||typeof window>"u"||(window.addEventListener("resize",()=>{R&&clearTimeout(R),R=setTimeout(()=>{T()},160)},{passive:!0}),Z=!0)}function Ce(){if(Q||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{N&&clearTimeout(N),N=setTimeout(()=>{ae()},80)};F=new MutationObserver(e),F.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&F.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Q=!0}function te(e){const n=document.getElementById("calendar-reservation-details");if(!n){alert(l("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"));return}const r=B()||{},{reservations:a=[],customers:s=[],projects:o=[],technicians:t=[]}=r,d=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},p=[d.id,d.reservationId,d.reservation_id,d.reservationCode,d.reservation_code].map(i=>i==null?"":String(i)).filter(i=>i.length>0);let u=-1,m=null;p.length>0&&(u=a.findIndex(i=>{const b=[i?.id,i?.reservationId,i?.reservation_id,i?.reservationCode,i?.reservation_code].map(g=>g==null?"":String(g)).filter(g=>g.length>0);return b.length===0?!1:b.some(g=>p.includes(g))}),u>=0&&(m=a[u]));let f;m?(f={...d,...m},Array.isArray(m.items)&&m.items.length&&(f.items=m.items),Array.isArray(m.packages)&&m.packages.length&&(f.packages=m.packages)):f=d;const C=f.projectId??f.project_id??null,y=C!=null&&o.find(i=>String(i.id)===String(C))||null,E=f.customerId??f.customer_id,L=s.find(i=>String(i.id)===String(E)),x=q(),k=[...Array.isArray(x)?x:[],...Array.isArray(t)?t:[]],S=new Map;k.forEach(i=>{if(!i||i.id==null)return;const b=String(i.id),g=S.get(b)||{};S.set(b,{...g,...i})});const j=Array.from(S.values());let z="";try{z=P(f,L,j,u>=0?u:0,y)}catch(i){console.error("âŒ [calendar] Failed to build reservation details for calendar modal",i),n.innerHTML=`<p class="text-sm text-error">${w(l("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"))}</p>`;return}n.innerHTML=z,n.classList.add("calendar-reservation-details");try{le()?.then(()=>{try{const i=Array.from(new Map((q()||[]).map(g=>[String(g.id),g])).values()),b=P(f,L,i,u>=0?u:0,y);n.innerHTML=b,n.classList.add("calendar-reservation-details")}catch{}}).catch(()=>{})}catch{}n.querySelector(".reservation-modal-actions")?.remove(),n.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(i=>{i instanceof HTMLElement&&(i.setAttribute("disabled","true"),i.setAttribute("aria-disabled","true"),i.setAttribute("tabindex","-1"))});const A=n.querySelector('[data-action="open-project"]');A&&(y?A.addEventListener("click",()=>{const i=y?.id!=null?String(y.id):"",b=i?`projects.html?project=${encodeURIComponent(i)}`:"projects.html";window.location.href=b}):A instanceof HTMLElement&&A.setAttribute("disabled","true"));const G=document.getElementById("calendarReservationModal");G&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(G).show():alert(l("calendar.alerts.cannotOpenModal","Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„"))}function se(){ye(),ve(),Ce();const{calendarEl:e}=H();if(!e)return;const n=me();if(!n){(async()=>{const r=await fe();if(!r||typeof r.Calendar!="function"){const o=l("calendar.status.missingLibrary","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");v({error:o}),_();return}v({loading:!0});const a=await Y();if(h){const o=l("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");v({loading:!1,error:h||o}),_();return}const s=we(a);c?c.batchRendering?.(()=>{c.removeAllEvents(),c.addEventSource(s)}):(c=new r.Calendar(e,{initialView:ie(),locale:M(),timeZone:"local",expandRows:!0,height:"auto",contentHeight:"auto",slotMinTime:"06:00:00",slotMaxTime:"24:00:00",slotDuration:"00:30:00",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},dayMaxEventRows:2,fixedWeekCount:!0,showNonCurrentDates:!0,views:{dayGridMonth:{dayMaxEventRows:2,fixedWeekCount:!0}},moreLinkClick:"popover",lazyFetching:!1,noEventsContent(){return l("calendar.noEvents","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚")},buttonText:{today:l("calendar.buttons.today","Ø§Ù„ÙŠÙˆÙ…"),month:l("calendar.buttons.month","Ø´Ù‡Ø±"),week:l("calendar.buttons.week","Ø£Ø³Ø¨ÙˆØ¹"),day:l("calendar.buttons.day","ÙŠÙˆÙ…")},events:s,eventContent:be,eventClick(o){te(o.event.extendedProps)},windowResize:T,datesSet(){he()}}),c.render(),c.__isFullCalendar=!0),T(),ee(s),v({loading:!1,error:"",empty:s.length===0})})();return}(async()=>{v({loading:!0});const r=await Y();if(h){const t=l("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");v({loading:!1,error:h||t}),_();return}const a=Ee(r);_();const s=re();c=new n("#calendar",{defaultView:s,usageStatistics:!1,isReadOnly:!0,week:{taskView:!1,hourStart:6,hourEnd:24},month:{visibleWeeksCount:0,startDayOfWeek:0,isAlways6Weeks:!0,maxVisibleEventCount:6,moreLayerSize:420},template:{time(t){const d=t?.raw?.paid===!0||t?.raw?.paid==="paid",p=t?.raw?.confirmed===!0||t?.raw?.confirmed==="true",u=t?.raw?.completed===!0||t?.raw?.completed==="true",m=l("calendar.labels.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),f=V(t.start?.toString?.()||t.start,t.end?.toString?.()||t.end,t.isAllDay),C=t?.raw?.reservationId?String(t.raw.reservationId):"â€”",y=t?.raw?.customerName||m,E=(S,j)=>`<span class="badge ${S} badge-sm">${w(j)}</span>`,L=p?l("calendar.badges.confirmed","Ù…Ø¤ÙƒØ¯"):l("calendar.badges.pending","ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),x=d?l("calendar.badges.paid","Ù…Ø¯ÙÙˆØ¹"):l("calendar.badges.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),k=[E(p?"badge-success":"badge-warning",L),E(d?"badge-info":"badge-error",x)];return u&&k.push(E("badge-neutral",l("calendar.badges.completed","Ù…Ù†ØªÙ‡ÙŠ"))),`
            <div class="card bg-base-100/90 border border-base-200 shadow-sm rounded-xl p-2">
              <div class="flex items-baseline justify-between text-[0.8rem]">
                <span class="font-bold">${w(f||"")}</span>
                <span class="font-semibold">${w(C)}</span>
              </div>
              <div class="mt-1 font-semibold text-sm truncate">${w(y)}</div>
              <div class="mt-1 flex gap-1 flex-wrap">${k.join("")}</div>
            </div>
          `}}}),c.__isTui=!0;const o=t=>{if(t)try{te(t)}catch{}};typeof c.on=="function"&&(c.on("clickSchedule",t=>o(t?.schedule?.raw||t?.schedule)),c.on("clickEvent",t=>o(t?.event?.raw||t?.event)));try{typeof c.createSchedules=="function"?c.createSchedules(a):typeof c.createEvents=="function"&&c.createEvents(a)}catch{}T(),ee(a),v({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{T()},120)})().catch(r=>{console.error("âŒ [calendar] renderCalendar failed",r),h=r instanceof Error&&r.message||h||"";const a=l("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");v({loading:!1,error:h||a}),_()})}function Ee(e=[]){const{projects:n=[]}=B(),r=new Map(n.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,o=s!=null&&r.get(String(s))||null,t=ne(a,o);if(!t)return null;const d=V(t.start,t.end,!1),p=t.customerName||"",u=[d,p].filter(Boolean).join(" Â· ");return{id:String(t.id),calendarId:"default",title:u,category:"time",isAllDay:!1,isAllday:!1,start:t.start,end:t.end,raw:{...a,paid:t.paid,confirmed:t.confirmed,completed:t.completed,reservationId:t.reservationId,customerName:t.customerName}}}).filter(Boolean)}function ie(){if(typeof window>"u")return"dayGridMonth";const e=window.innerWidth||1024,n=W(e);return n==="xs"?"timeGridDay":n==="sm"?"timeGridWeek":"dayGridMonth"}export{se as renderCalendar};
