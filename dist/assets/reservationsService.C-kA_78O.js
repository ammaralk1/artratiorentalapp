import{t as C,p as ue,n as h,j as M,d as de,b as ze,h as Zt,A as en}from"./auth.BLFzWQsL.js";import{r as kt,i as tn,D as et,s as nn,k as an,P as on,u as $e,E as It,j as sn,O as tt,G as ge,H as pe,b as se,I as St,J as cn}from"./state.BK2rhNHf.js";const rn=()=>C("reservations.create.summary.currency","SR");let Ae=[],X=[],ce=[],re=[],V="create",vt=()=>{},qt=()=>{};const xe=new Map,Ge=450;function ln(e){const n=xe.get(e);return n!=null&&Date.now()-n<Ge}function un(e){xe.set(e,Date.now()),setTimeout(()=>{const n=xe.get(e);n!=null&&Date.now()-n>=Ge&&xe.delete(e)},Ge+50)}function qe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ye(e={}){return{...e,assignmentId:e.assignmentId||qe()}}function Me(e){if(!e)return null;const n=String(e),t=Ae.find(a=>String(a?.id)===n);if(t)return{...t};const{technicians:i=[]}=de();return i.find(a=>String(a?.id)===n)||null}function Ce(e={},n=ue()){return e?n==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function nt(e={},n=ue()){return e?n==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function Ft(e,n=""){if(!e)return null;if(typeof e=="object")return e;const t=String(e).trim().toLowerCase();if(!t)return null;const i=X.find(s=>String(s.id).trim().toLowerCase()===t);if(i)return i;const a=sn(e);return a||{id:null,name:n||t,labelAr:n||t,labelEn:n||t,cost:0,clientPrice:0}}function pt(e){const n=Ft(e,e?.name??""),t=ue(),i=Ce(n,t)||n?.name||"",a=nt(n,t);return We({assignmentId:qe(),positionId:n?.id??null,positionKey:n?.name??null,positionLabel:i,positionLabelAlt:a,positionCost:Number.isFinite(n?.cost)?Number(n.cost):0,positionClientPrice:Number.isFinite(n?.clientPrice)?Number(n.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function We(e={}){const n={assignmentId:e.assignmentId||qe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},t=Ft(n.positionId??n.positionKey??n.positionLabel,n.positionLabel);if(t){n.positionId=t.id??n.positionId;const i=ue(),a=Ce(t,i)||n.positionLabel,s=nt(t,i);n.positionLabel=a||n.positionLabel||t?.name||"",n.positionLabelAlt=s||n.positionLabelAlt||"",(n.positionCost==null||!Number.isFinite(n.positionCost)||n.positionCost===0)&&(n.positionCost=Number.isFinite(t?.cost)?Number(t.cost):n.positionCost),(n.positionClientPrice==null||!Number.isFinite(n.positionClientPrice)||n.positionClientPrice===0)&&(n.positionClientPrice=Number.isFinite(t?.clientPrice)?Number(t.clientPrice):n.positionClientPrice)}if(n.technicianId!=null){const i=Me(n.technicianId);i?(n.technicianId=String(i.id),n.technicianName=i.name??n.technicianName??null,n.technicianRole=i.role??n.technicianRole??null,n.technicianPhone=i.phone??null):(n.technicianId=String(n.technicianId),n.technicianName=n.technicianName??null)}else n.technicianId=null,n.technicianName=null,n.technicianPhone=null;return n.positionCost=Number.isFinite(n.positionCost)?Number(n.positionCost):0,n.positionClientPrice=Number.isFinite(n.positionClientPrice)?Number(n.positionClientPrice):0,n}function be(){X=tn()}function dn(e=[]){return Array.isArray(e)?e.map(n=>{if(n==null)return null;if(n&&typeof n=="object")return ye(We(n));const t=Me(n),i=t?{assignmentId:qe(),positionLabel:t.role||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(t.dailyWage)?Number(t.dailyWage):0,positionClientPrice:Number.isFinite(t.dailyTotal)?Number(t.dailyTotal):0,technicianId:t.id,technicianName:t.name,technicianRole:t.role}:{assignmentId:qe(),positionLabel:C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:n!=null?String(n):null,technicianName:null};return ye(We(i))}).filter(Boolean):[]}function me(e="create"){return e==="edit"?re.map(ye):ce.map(ye)}function ne(e="create",n=[]){try{be()}catch{}const t=dn(n);e==="edit"?(re=t,ke("edit-selected-technicians-list",re,"edit"),qt()):(ce=t,ke("selected-technicians-list",ce,"create"),vt()),Fe()}function je(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=o?$e(o,c):null,f=l?$e(l,u):null;let m=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const y=Number.parseInt(g,10);if(Number.isInteger(y)){const{reservations:N=[]}=de(),p=N?.[y];p&&(m=p.id??p.reservationId??null)}}return{start:d,end:f,ignoreReservationId:m}}const n=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=n?$e(n,i):null,r=t?$e(t,a):null;return{start:s,end:r,ignoreReservationId:null}}function Fe(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const n=me(V).length;if(n){const t=C("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",h(String(n)));e.textContent=t}else e.textContent=C("technicians.picker.selectionInfo","No crew selected yet")}function De(e){const n=Number.isFinite(e)?e:0;return`${h(n.toFixed(2))} ${rn()}`}function pn(e){const n=me(V),t=new Set(n.filter(c=>c.assignmentId!==e&&c.technicianId).map(c=>c.technicianId)),i=Ae.length?Ae:de().technicians||[],{start:a,end:s,ignoreReservationId:r}=je(V),o=!!(a&&s);return i.map(c=>{const u=String(c.id),d=t.has(u),f=o?et(u,a,s,r):!1,m=h(c.name||c.full_name||c.fullName||c.email||u);return{id:u,label:m,disabled:d||f,conflict:f,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const n=me(V);if(!n.length){const t=C("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=C("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${t}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}be(),e.innerHTML=n.map((t,i)=>{const a=h(String(i+1)),s=De(t.positionClientPrice||0),r=pn(t.assignmentId),o=C("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),l=t.technicianId!=null?String(t.technicianId):"",c=t.technicianName?h(t.technicianName):"",u=`crew-assignment-options-${t.assignmentId}`,d=C("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),f=C("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),m=r.map(b=>{const P=l===b.id,S=b.disabled&&!P?`${b.label} ${b.conflict?f:d}`:b.label;return`
        <option value="${b.label}"
                data-id="${b.id}"
                data-disabled="${b.disabled?"true":"false"}"
                data-conflict="${b.conflict?"true":"false"}"
                data-taken="${b.taken?"true":"false"}"
                label="${S}"></option>
      `}).join("");let g=t.positionLabel??t.position_label??t.position_name??t.role??t.position??"";if(!g||String(g).trim()===""){const b=t.positionId?X.find(I=>String(I.id)===String(t.positionId)):null,P=!b&&t.positionKey?X.find(I=>String(I.name).toLowerCase()===String(t.positionKey).toLowerCase()):null;if(b||P){const I=b||P;g=Ce(I,ue())||I?.name||""}}const y=t.positionLabelAlt?`<div class="text-muted small">${h(t.positionLabelAlt)}</div>`:"",N=C("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),p=C("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${t.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${a}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${h(g||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${y}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${s}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${t.assignmentId}"
              placeholder="${o}"
              value="${l?c:""}"
              aria-label="${C("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${m}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${t.assignmentId}" aria-label="${N}">
            ${N}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Lt(t.dataset.assignmentId,V)}),t.dataset.listenerAttached="true")}),mn(e)}function mn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(t=>{if(t.dataset.listenerAttached)return;const i=t.dataset.assignmentId,a=()=>{fn(t,i)};t.addEventListener("change",a),t.addEventListener("blur",a),t.dataset.listenerAttached="true"})}function fn(e,n){if(!n||ln(n))return;un(n);const t=e.value?.trim()??"";if(!t){we(n,"");return}const i=e.getAttribute("list"),a=i?document.getElementById(i):null,s=a?Array.from(a.options):[],r=h(t).toLowerCase(),o=s.find(c=>h(c.value).toLowerCase()===r);if(!o){M(C("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}if(o.dataset.disabled==="true"){if(o.dataset.conflict==="true")try{const{start:c,end:u,ignoreReservationId:d}=je(V),f=o.dataset.id||"",m=c&&u&&f?It(String(f),c,u,d):[],g=C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),y=m&&m.length?`: ${m.join("ØŒ ")}`:"";M(`${g}${y}`,"warning",6e3)}catch{M(C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else M(C("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const l=o.dataset.id;if(!l){M(C("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}we(n,l)}function Re(){const e=document.getElementById("crew-position-list");if(!e)return;be();const n=document.getElementById("crew-position-search"),t=h(String(n?.value||"")).trim().toLowerCase(),a=me(V).reduce((o,l)=>{const c=l?.positionId!=null?String(l.positionId):null;return c&&o.set(c,(o.get(c)||0)+1),o},new Map),s=X.filter(o=>t?[o.labelAr,o.labelEn,o.name].filter(Boolean).map(c=>h(String(c)).toLowerCase()).join(" ").includes(t):!0);if(!s.length){e.innerHTML=`<div class="text-muted">${C("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const r=ue();e.innerHTML=s.map(o=>{const l=Ce(o,r)||o.name||"",c=nt(o,r),u=De(o.clientPrice||0),d=De(o.cost||0),f=c?`<span class="crew-position-card__subtitle">${h(c)}</span>`:"",m=C("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=C("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),y=C("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),N=a.get(String(o.id))||0,p=C("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",h(String(N)));return`
      <article class="crew-position-card" data-position-id="${o.id}" tabindex="0" role="button" aria-label="${h(l)}">
        ${N>0?`<span class="crew-position-card__badge" aria-label="${p}">${h(String(N))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${h(l)}</h6>
            ${f}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${m}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${m}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${h(String(o.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${o.clientPrice==null?"":h(String(o.clientPrice))}" inputmode="decimal" placeholder="${h("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${o.id}">${C("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${o.id}">${C("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${o.id}">
            ${y}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${o.id}">
            ${C("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.stopPropagation(),Ke(o.dataset.positionId)}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(o=>{o.dataset.cardListenerAttached||(o.addEventListener("click",()=>{o.dataset.editing!=="true"&&Ke(o.dataset.positionId)}),o.addEventListener("keydown",l=>{if(l.key==="Enter"||l.key===" "){if(l.preventDefault(),o.dataset.editing==="true")return;Ke(o.dataset.positionId)}}),o.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const c=o.closest(".crew-position-card");if(!c)return;const u=c.querySelector(".crew-position-card__metrics"),d=c.querySelector(".crew-position-card__footer"),f=c.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),f&&(f.hidden=!1),c.dataset.editing="true";const m=c.querySelector(".crew-position-edit-cost"),g=c.querySelector(".crew-position-edit-client"),y=N=>{N.addEventListener("input",p=>{const P=h(p.target.value).replace(/[^0-9.]/g,"");if(P!==p.target.value){const I=p.target.selectionEnd||P.length;p.target.value=P,p.target.setSelectionRange(I,I)}},{once:!0})};m&&y(m),g&&y(g)}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();const c=o.closest(".crew-position-card"),u=o.dataset.positionId;if(!(!c||!u))try{const d=c.querySelector(".crew-position-edit-cost"),f=c.querySelector(".crew-position-edit-client"),m=h(d?.value||"").trim(),g=h(f?.value||"").trim(),y=m===""?0:Number.parseFloat(m),N=g===""?null:Number.parseFloat(g);if(!Number.isFinite(y)||y<0){M(C("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(N!=null&&(!Number.isFinite(N)||N<0)){M(C("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),f?.focus();return}be();const p=X.find(b=>String(b.id)===String(u));if(!p){M(C("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await on(u,{name:p.name,cost:Number(y.toFixed(2)),clientPrice:N==null?null:Number(N.toFixed(2)),labelAr:p.labelAr,labelEn:p.labelEn}),M(C("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),Re(),Y()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const f=d?.message||C("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");M(f,"error")}}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const c=o.closest(".crew-position-card");if(!c)return;const u=c.querySelector(".crew-position-card__metrics"),d=c.querySelector(".crew-position-card__footer"),f=c.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),f&&(f.hidden=!0),delete c.dataset.editing}),o.dataset.listenerAttached="true")})}function Ke(e){be();const n=X.find(a=>String(a.id)===String(e)),t=pt(n||{id:null,name:""}),i=me(V);i.push(t),ne(V,i),Y(),M(C("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Lt(e,n="create"){if(!e)return;const t=me(n).filter(i=>i.assignmentId!==e);ne(n,t),Y(),M(C("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function we(e,n){if(!e)return;const t=me(V),i=t.find(c=>c.assignmentId===e);if(!i)return;if(!n){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ne(V,t),Y(),M(C("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(t.find(c=>c.assignmentId!==e&&c.technicianId===n)){M(C("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),Y();return}const s=Me(n),{start:r,end:o,ignoreReservationId:l}=je(V);if(r&&o&&et(String(n),r,o,l)){try{const c=It(String(n),r,o,l),u=C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=c&&c.length?`: ${c.join("ØŒ ")}`:"";M(`${u}${d}`,"warning",6e3)}catch{M(C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}Y();return}s?(i.technicianId=String(s.id),i.technicianName=s.name??null,i.technicianRole=s.role??null,i.technicianPhone=s.phone??null):(i.technicianId=String(n),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ne(V,t),Y(),i.technicianName?M(C("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",h(i.technicianName)),"success"):M(C("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function mt(e="create"){V=e,Y(),Fe();let n=nn();if(!Array.isArray(n)||n.length===0)try{const i=await kt();n=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(n)&&(Ae=n);try{await an()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}be(),Re(),Y(),Fe();const t=document.getElementById("selectTechniciansModal");t&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(t).show()}function _n(){return me(V).map(ye)}function gn(){const e=_n(),{start:n,end:t,ignoreReservationId:i}=je(V);if(n&&t){const s=e.filter(r=>r.technicianId&&et(r.technicianId,n,t,i));if(s.length>0){const r=s.map(l=>l.technicianName||l.technicianId).join(C("reservations.list.crew.separator","ØŒ ")),o=C("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",r);s.forEach(l=>{l.technicianId=null,l.technicianName=null}),ne(V,e),Y(),M(o),Fe();return}}ne(V,e);const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a)?.hide?.(),M(C("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function ke(e,n=[],t="create"){const i=document.getElementById(e);if(i){if(!n.length){i.innerHTML=`<span class="text-muted">${C("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}be(),i.innerHTML=n.map(a=>{let s=a.positionLabel??a.position_label??a.position_name??a.role??a.position??"";if(!s||String(s).trim()===""){const d=a.positionId?X.find(m=>String(m.id)===String(a.positionId)):null,f=!d&&a.positionKey?X.find(m=>String(m.name).toLowerCase()===String(a.positionKey).toLowerCase()):null;s=d?Ce(d,ue())||d?.name||"":f&&(Ce(f,ue())||f?.name)||""}const r=h(s||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),o=a.technicianName?`${h(a.technicianName)}`:C("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let l=Number(a.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[a.position_client_price,a.client_price,a.customer_price,a.daily_total,a.dailyTotal,a.total];for(const f of d){const m=Number(f);if(Number.isFinite(m)&&m>0){l=m;break}}}if((!Number.isFinite(l)||l<=0)&&(a.positionId||a.positionKey)){const d=a.positionId?X.find(g=>String(g.id)===String(a.positionId)):null,f=!d&&a.positionKey?X.find(g=>String(g.name).toLowerCase()===String(a.positionKey).toLowerCase()):null,m=d||f||null;m&&Number.isFinite(Number(m.clientPrice))&&(l=Number(m.clientPrice))}const c=De(Number.isFinite(l)&&l>0?l:0),u=C("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${a.assignmentId}">
        <span class="technician-chip-name">${r}</span>
        <small class="technician-chip-role">${o}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${c}</small>
        <button type="button" class="technician-chip-remove" data-context="${t}" data-assignment-id="${a.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",()=>{Lt(a.dataset.assignmentId,a.dataset.context)}),a.dataset.listenerAttached="true")})}}function yn(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",r=>{const o=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),c=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),f=!!(l&&c),m=!!(u&&d),g=!!o;if(!f||!m){r.preventDefault(),M(C("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){r.preventDefault(),M(C("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}mt("create")}),e.dataset.listenerAttached="true";const s=()=>{const r=document.getElementById("res-customer")?.value?.trim(),o=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),c=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(r&&o&&l&&c&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(r=>document.getElementById(r)).filter(Boolean).forEach(r=>{["input","change"].forEach(o=>r.addEventListener(o,s))}),s()}const n=document.getElementById("open-edit-technician-picker");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>mt("edit")),n.dataset.listenerAttached="true");const t=document.getElementById("crew-position-search");t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{Re()}),t.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",gn),i.dataset.listenerAttached="true");const a=document.getElementById("selectTechniciansModal");a&&!a.dataset.listenerAttached&&window.bootstrap?.Modal&&(a.addEventListener("shown.bs.modal",async()=>{if(!Ae.length&&(!de().technicians||de().technicians.length===0))try{await kt()}catch(s){console.warn("[crew-picker] fetch on show failed",s)}Re(),Y(),Fe()}),a.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("crew-position-search");s&&(s.value="")}),a.dataset.listenerAttached="true"),ke("selected-technicians-list",ce,"create"),ke("edit-selected-technicians-list",re,"edit")}function mi({onDraftChange:e,onEditChange:n}={}){vt=typeof e=="function"?e:()=>{},qt=typeof n=="function"?n:()=>{},yn()}function bn(){return ce.map(ye)}function hn(){return re.map(ye)}function ft(){return ce.map(e=>e.technicianId).filter(Boolean).map(String)}function _t(){return re.map(e=>e.technicianId).filter(Boolean).map(String)}function fi(e=[]){ne("create",e)}function _i(e=[]){ne("edit",e)}function gi(){ne("create",[])}function yi(){ne("edit",[])}function gt(e=[]){return e.map(n=>{if(n.technicianId){const t=Me(n.technicianId);if(t)return n.technicianId=String(t.id),n.technicianName=t.name??n.technicianName??null,n.technicianRole=t.role??n.technicianRole??null,n.technicianPhone=t.phone??null,n;n.technicianId=null,n.technicianName=null,n.technicianRole=null,n.technicianPhone=null}return n})}function bi(e=[]){Array.isArray(e)&&e.length&&(Ae=e),ce=gt(ce),re=gt(re),ke("selected-technicians-list",ce,"create"),ke("edit-selected-technicians-list",re,"edit"),Y()}function yt(e){const n=e.split(".");if(n.length<=2)return e;const t=n.pop(),i=n.join("");return t?`${i}.${t}`:i}function Et(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let n=h(String(e)).trim();if(!n)return Number.NaN;const t=n.search(/[0-9]/),i=n.indexOf("-"),a=i!==-1&&(t===-1||i<t);if(n=n.replace(/[-+]/g,""),n=n.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),n=n.replace(/[^0-9.,]/g,""),!n)return Number.NaN;const s=n.includes(","),r=n.includes(".");if(s&&r){const l=n.lastIndexOf(","),c=n.lastIndexOf(".");l>c?(n=n.replace(/\./g,""),n=n.replace(/,/g,".")):n=n.replace(/,/g,"")}else if(s){const l=n.split(",");l.length===2&&l[1].length===3?n=l.join(""):n=n.replace(/,/g,".")}else if(r){const l=n.split(".");if(l.length===2){const[,c]=l;if(c.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(n=u)}}else l.length>2&&(n=yt(n))}if(n=n.replace(/,/g,""),n=yt(n),!/^[0-9]*\.?[0-9]*$/.test(n)||!n||n===".")return Number.NaN;const o=Number.parseFloat(n);return Number.isFinite(o)?a?-o:o:Number.NaN}function D(e){return Et(e)}function $(e){const n=Et(e);if(!Number.isFinite(n))return 0;let t=n,i=0;for(;Math.abs(t)>1e5&&i<8;)t/=10,i+=1;return Number(t.toFixed(2))}function ve(e){return h(String(e??"")).trim().toLowerCase()}function Tt(e=""){return h(String(e)).trim().toLowerCase()}const Nn=2;function Pn(e){const n=D(e);return Number.isFinite(n)?n.toFixed(Nn):"0.00"}function Qe(e={}){const n=[e?.qty,e?.quantity,e?.count,e?.units];for(const t of n){const i=Number.parseFloat(h(String(t??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return $(i)}return 1}function An(e={}){const n=e?.desc||e?.description||e?.name||"",t=Tt(n),i=Pn(e?.price??e?.unitPrice??e?.unit_price??0);return`${t}::${i}`}function Cn(e=[]){const n=new Map;return e.forEach((t,i)=>{const a=An(t);if(!a)return;if(!n.has(a)){const r=t?.desc||t?.description||t?.name||"",o=Tt(r),l=ht(t),c=Nt(t),u=t?.image||t?.imageUrl||t?.img||"";n.set(a,{key:a,description:r,normalizedDescription:o,unitPrice:l,unitCost:c,image:u,items:[],itemIndices:[],barcodes:[]})}const s=n.get(a);s.items.push(t),s.itemIndices.push(i),t?.barcode&&s.barcodes.push(String(t.barcode))}),Array.from(n.values()).map(t=>({...t,quantity:t.items.reduce((i,a)=>i+Qe(a),0)})).map(t=>{const i=t.quantity||0,a=t.items.reduce((g,y)=>{const N=ht(y),p=Qe(y);return g+N*p},0),s=$(a),r=D(t.unitPrice),o=Number.isFinite(r)?r:0,l=t.items.reduce((g,y)=>{const N=Nt(y),p=Qe(y);return g+N*p},0),c=$(l),u=D(t.unitCost),d=Number.isFinite(u)?u:0,f=i>0?$(s/i):$(o),m=i>0?$(c/i):$(d);return{...t,quantity:i,count:i,totalPrice:s,unitPrice:f,totalCost:c,unitCost:m}})}function bt(e={}){return(se(e)||[]).map(t=>({...t,normalizedBarcode:t?.normalizedBarcode??ve(t?.barcode),qty:(()=>{const i=Number.parseFloat(h(String(t?.qty??t?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=D(t?.price??t?.unit_price??t?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=D(t?.cost??t?.unit_cost??t?.unitCost??t?.rental_cost??t?.purchase_price);return Number.isFinite(i)?i:0})()}))}function kn(e={},{packageQuantity:n=1}={}){const t=ge(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=t&&pe(t)||e,a=se(i)||[],s=Number.isFinite(Number(n))&&Number(n)>0?Number(n):1;return a.map(r=>{const l=D(r?.price??r?.unit_price??r?.unitPrice),c=Number.isFinite(l)?$(l):0,u=D(r?.cost??r?.unit_cost??r?.unitCost??r?.rental_cost??r?.purchase_price),d=Number.isFinite(u)?$(u):0,f=1*s,m=$(c*f),g=$(d*f);return{equipmentId:r?.equipmentId??r?.equipment_id??null,barcode:r?.barcode??r?.normalizedBarcode??"",desc:r?.desc??r?.description??"",qtyPerPackage:1,packageQuantity:s,totalUnits:f,unitPrice:c,perDayTotal:m,unitCost:d,perDayCost:g}})}function In(e={},{packageQuantity:n=1,days:t=1}={}){const i=kn(e,{packageQuantity:n}),a=$(i.reduce((l,c)=>l+(Number(c.perDayTotal)||0),0)),s=$(i.reduce((l,c)=>l+(Number(c.perDayCost)||0),0)),r=$(a*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1)),o=$(s*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1));return{lines:i,perDayTotal:a,total:r,perDayCostTotal:s,costTotal:o}}function Sn(e={}){const n=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,t=Number.parseFloat(h(String(n)).replace(/[^0-9.]/g,""));return Number.isFinite(t)&&t>0?t:1}function vn(e={},n=[],t=null){try{const c=ge(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(c){const u=pe(c);if(u){const d=u.price??u.total_price??u.package_price,f=D(d);if(Number.isFinite(f)&&f>0)return $(f)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,a=D(i);if(Number.isFinite(a)&&a>0)return $(a);const s=e.total_price??e.totalPrice??e.total,r=D(s),o=Number.parseFloat(h(String(t)).replace(/[^0-9.]/g,"")),l=Number.isFinite(o)&&o>0?o:Sn(e);return Number.isFinite(r)&&r>0&&l>0?$(r/l):0}function qn(e={}){const n=Array.isArray(e?.items)?e.items:[],t=Cn(n),i=tt(),a=new Set,s=new Map;i.forEach(p=>{const b=ge(p?.id??p?.packageId??p?.package_id??p?.code);b&&a.add(b);const P=h(String(p?.package_code??p?.code??"")).trim().toLowerCase();P&&s.set(P,b||P)});const r=(p,b=0)=>{const P=ge(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),I=h(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return P||(I&&s.has(I)?s.get(I):I||`pkg-${b}`)},o=new Map,l=(p,b=0,P="packages")=>{if(!p||typeof p!="object")return;const S=r(p,b)||`pkg-${b}`;if(!o.has(S)){o.set(S,{source:p,normalizedId:S,index:b,itemSource:P==="items"?p:null});return}const A=o.get(S);if(A.source||(A.source=p),P==="items"&&(A.itemSource=p,A.source&&typeof A.source=="object")){const q=Array.isArray(A.source.packageItems)&&A.source.packageItems.length>0,L=Array.isArray(p.packageItems)&&p.packageItems.length>0;!q&&L&&(A.source={...A.source,packageItems:p.packageItems}),!A.source.image&&p.image&&(A.source={...A.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,b)=>l(p,b,"packages")),n.forEach((p,b)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const P=r(p,b+o.size);l({...p,package_id:P,packageId:P,package_code:p.package_code??p.code},b+o.size,"items")}});const c=[],u=new Set,d=new Set;o.forEach(({source:p,itemSource:b=null,normalizedId:P},I)=>{const A=(P?pe(P):null)||p||{},q=b&&typeof b=="object"?b:null;let L=bt(A);(!Array.isArray(L)||L.length===0)&&q&&(L=bt(q)),L.forEach(F=>{const T=F?.normalizedBarcode??ve(F?.barcode);T&&u.add(T);const z=F?.equipmentId??F?.equipment_id??null;z!=null&&d.add(String(z))});let B=1,w=vn(A,L,B);const _=[q?.price,q?.unit_price,q?.unitPrice];for(const F of _){const T=D(F);if(Number.isFinite(T)&&T>0){w=$(T);break}}w=$(w);const U=[A?.unit_cost,A?.unitCost,A?.cost,q?.unit_cost,q?.unitCost,q?.cost];let H=0;for(const F of U){const T=D(F);if(Number.isFinite(T)&&T>=0){H=$(T);break}}if(!H&&Array.isArray(L)&&L.length){const F=L.reduce((T,z)=>{const fe=D(z?.cost),he=Number.isFinite(Number(z?.qtyPerPackage))&&Number(z.qtyPerPackage)>0?Number(z.qtyPerPackage):1;return T+(Number.isFinite(fe)?fe:0)*he},0);H=$(F)}const O=(()=>{const F=[A?.pricing_mode,A?.pricingMode,A?.pricing,q?.pricing_mode,q?.pricingMode,q?.pricing];for(const T of F){if(T==null)continue;const z=String(T).trim().toLowerCase();if(z==="daily"||z==="per_day"||z==="day")return"daily";if(z==="fixed"||z==="per_booking"||z==="booking")return"fixed"}return"daily"})(),K=[q?.total,q?.total_price,q?.totalPrice,A?.total,A?.total_price,A?.totalPrice];let Q=NaN;for(const F of K){const T=D(F);if(Number.isFinite(T)&&T>=0){Q=T;break}}Number.isFinite(Q)||(Q=w*B),Q=$(Q);const ee=[A?.package_code,A?.code,A?.packageCode,A?.displayCode,A?.display_code,A?.barcode,q?.package_code,q?.code,q?.packageCode,q?.displayCode,q?.display_code,q?.barcode,P,I].find(F=>F==null?!1:String(F).trim().length>0),v=ee!=null?h(String(ee)).trim():"";if(v){const F=ve(v);F&&u.add(F)}const E=L.map(F=>h(String(F?.barcode??F?.normalizedBarcode??""))).filter(Boolean),G=[A?.name,A?.package_name,A?.title,q?.name,q?.desc,q?.package_name,v,h(String(I))].find(F=>F!=null&&String(F).trim()!=="")||h(String(v||I)),ae=L.find(F=>F?.image)?.image??A?.image??q?.image??null,j=1;c.push({key:`package::${I}`,description:G,normalizedDescription:h(String(G)),unitPrice:w,unitCost:H,totalPrice:Q,pricingMode:O,quantity:B,count:j,image:ae,barcodes:E,barcode:v,package_code:v,packageDisplayCode:v,items:[{type:"package",packageItems:L,packageId:P,desc:G,price:w,cost:H,qty:j,barcode:v}],type:"package",packageItems:L,packageId:P})});const f=new Set(Array.from(u).map(p=>ve(p)).filter(Boolean)),m=t.filter(p=>{if(p.items.some(S=>S?.type==="package")&&c.length>0)return!1;const P=(S={})=>[S.packageId,S.package_id,S.package_code,S.packageCode,S.bundleId,S.bundle_id].some(A=>A!=null&&A!=="");return!p.items.every(S=>{const A=Fn(S),q=A!=null?String(A):null;if(q&&d.has(q))return!0;const L=S?.barcode?ve(S.barcode):null;return!!(L&&f.has(L)||P(S))})}),g=new Set,y=[];return c.forEach(p=>{const b=r({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!b||g.has(b)||(g.add(b),y.push(p))}),{groups:y.length?[...y,...m]:t,packageGroups:c,groupedItems:t,filteredGroupedItems:m,packagesMap:o}}function Fn(e={}){const n=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const t of n)if(!(t==null||t===""))return String(t);return null}function ht(e={}){const n=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function Nt(e={}){const n=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function hi(e){const n=e?.status??e?.reservationStatus??null;if(n){const a=String(n).trim().toLowerCase();if(a==="completed"||a==="closed"||a==="Ù…ØºÙ„Ù‚"||a==="Ù…ÙƒØªÙ…Ù„"||a==="Ù…Ù†ØªÙ‡ÙŠ"||a==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Ln(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Ni(e={},n=null){const t=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,a=i!=null&&i!==""&&i!=="null",s=a?Ln(n?.status??n?.status_label??n?.statusLabel??""):null,r=a&&(n?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:t,projectLinked:a,projectStatus:s,projectConfirmed:r,effectiveConfirmed:a?r:t}}const $t=10;function wt(e={}){const n=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const t of n){const i=D(t);if(Number.isFinite(i))return $(i)}return 0}function En(e={}){const n=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const t of n){if(t==null||t==="")continue;const i=D(t);if(Number.isFinite(i))return $(i)}return wt(e)}function Tn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:n=[]}=de();if(!Array.isArray(n)||n.length===0)return{costPerDay:0,totalPerDay:0};const t=new Map(n.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,a)=>{const s=t.get(String(a));if(!s)return i;const r=wt(s),o=En(s);return{costPerDay:i.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:i.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const $n=1440*60*1e3,Pe=.01;function Ne(e){if(e==null||e==="")return null;const n=h(String(e)).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return Number.isFinite(t)?t:null}function Pt(e,{min:n=0,max:t=Number.POSITIVE_INFINITY,precision:i=2}={}){let a=Number.isFinite(e)?e:0;if(a<n&&(a=n),a>t&&(a=t),i!=null){const s=10**i;a=Math.round(a*s)/s}return a}function xt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function it({totalAmount:e=0,progressType:n=null,progressValue:t=null,paidAmount:i=null,paidPercent:a=null,history:s=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,o=n==="amount"?"amount":n==="percent"?"percent":null;let l=Ne(i),c=Ne(a);const u=Ne(t);let d=0,f=0;Array.isArray(s)&&s.length&&s.forEach(p=>{if(!p)return;const b=p.type==="amount"||p.type==="percent"?p.type:null,P=Ne(p.value),I=Ne(p.amount),S=Ne(p.percentage);if(b==="amount"){const A=I??P;A!=null&&(d+=A,r>0&&(f+=A/r*100))}else if(b==="percent"){const A=S??P;A!=null&&(f+=A,r>0&&(d+=A/100*r))}else I!=null&&(d+=I,r>0&&(f+=I/r*100)),S!=null&&(f+=S,r>0&&(d+=S/100*r))}),o==="amount"&&u!=null?l=u:o==="percent"&&u!=null?c=u:o===null&&u!=null&&(c!=null?c=u:l=u),(l==null||l<=0)&&c!=null&&c>0&&r>0&&(l=r*(c/100)),(c==null||c<=0)&&l!=null&&l>0&&r>0&&(c=l/r*100);const m=l??0,g=c??0;l=m+d,c=g+f,l=Pt(l??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),c=Pt(c??0,{min:0,max:100,precision:2});let y=o;return y||(l>0&&r>0?y="amount":c>0&&(y="percent")),{paidAmount:l,paidPercent:c,paymentProgressType:y,paymentProgressValue:y==="amount"?l:y==="percent"?c:null}}function at({manualStatus:e="unpaid",paidAmount:n=0,paidPercent:t=0,totalAmount:i=0}={}){const a=xt(e),s=Number.isFinite(Number(i))?Number(i):0,r=Number.isFinite(Number(n))?Number(n):0,o=Number.isFinite(Number(t))?Number(t):0;if(a==="paid")return"paid";const l=s>0&&r>=s-Pe,c=o>=100-Pe*100;if(l||c)return"paid";const u=r>Pe||o>Pe;return a==="partial"||u?"partial":"unpaid"}function wn(e,n){if(!e||!n)return 1;const t=new Date(e),i=new Date(n);if(Number.isNaN(t.getTime())||Number.isNaN(i.getTime()))return 1;const a=i.getTime()-t.getTime();if(a<=0)return 1;const s=a/$n;return Math.max(1,Math.ceil(s))}function Ie({items:e=[],technicianIds:n=[],crewAssignments:t=[],discount:i=0,discountType:a="percent",applyTax:s=!1,start:r=null,end:o=null,companySharePercent:l=null,groupingSource:c=null}={}){const u=wn(r,o);let d=!1;try{if(typeof window<"u"&&window.location){const v=new URL(window.location.href),E=(v.searchParams.get("noDays")||v.searchParams.get("pricing")||"").toLowerCase();d=E==="1"||E==="true"||E==="fixed"||E==="nodays"}}catch{}const f=c&&typeof c=="object"?c:{items:Array.isArray(e)?e:[]},{groups:m}=qn(f),g=v=>{if((v?.type||"").toLowerCase()==="package")return!0;const E=Array.isArray(v?.items)?v.items:[];if(!E.length)return!1;if(E.some(j=>j?.reservation_id!=null||j?.reservationId!=null))return!0;const G=E.every(j=>j?.unit_price!=null||j?.unitPrice!=null),ae=E.some(j=>j?.daily_rate!=null||j?.dailyRate!=null||j?.unit_rate!=null||j?.unitRate!=null||j?.price!=null);return!!(G&&!ae)};let y=0,N=0;(Array.isArray(m)?m:[]).forEach(v=>{const E=Number.isFinite(Number(v?.quantity))?Number(v.quantity):0,ie=Number.isFinite(Number(v?.unitPrice))?Number(v.unitPrice):0,G=Number.isFinite(Number(v?.unitCost))?Number(v.unitCost):0,ae=String(v?.type||"").toLowerCase()==="package",j=g(v),F=d||j?1:u;if(ae){const T={package_code:v?.package_code||v?.packageDisplayCode||v?.barcode||v?.packageId||v?.key,packageItems:Array.isArray(v?.packageItems)?v.packageItems:void 0},z=In(T,{packageQuantity:E,days:F}),fe=Number.isFinite(Number(z.total))?Number(z.total):E*(Number.isFinite(ie)?ie:0)*F,he=(()=>{const _e=Number(z?.costTotal);if(Number.isFinite(_e))return _e;const Te=Number(z?.perDayCostTotal);return Number.isFinite(Te)?Te*F:E*(Number.isFinite(G)?G:0)*F})();y+=fe,N+=he}else y+=E*ie*F,N+=E*G*F});const p=$(y),b=$(N),P=Array.isArray(t)?t:[],I=P.length?P.map(v=>v?.technicianId).filter(Boolean):Array.isArray(n)?n:[],{costPerDay:S,totalPerDay:A}=P.length?P.reduce((v,E)=>{const ie=D(E?.positionCost??E?.position_cost??E?.cost??E?.dailyWage??E?.daily_wage??0),G=D(E?.positionClientPrice??E?.position_client_price??E?.clientPrice??E?.dailyTotal??E?.daily_total??E?.total??0),ae=Number.isFinite(ie)?ie:0,j=Number.isFinite(G)?G:0;return{costPerDay:v.costPerDay+ae,totalPerDay:v.totalPerDay+j}},{costPerDay:0,totalPerDay:0}):Tn(I),q=$(A*u),L=$(S*u),B=$(p+q),w=Number(i)||0;let _=a==="amount"?w:B*(w/100);(!Number.isFinite(_)||_<0)&&(_=0),_>B&&(_=B);const U=Math.max(0,B-_),H=Number.isFinite(l)&&Number(l)>0?Number(l):0,Z=H>0?Math.max(0,U*(H/100)):0,O=U+Z;let K=s?O*.15:0;(!Number.isFinite(K)||K<0)&&(K=0),K=Number(K.toFixed(2));const Q=O+K,x=Math.max(0,Number(Q.toFixed(2))),ee=Math.max(0,Math.max(0,p+q-_)-L-b);return{rentalDays:u,equipmentTotal:p,equipmentCostTotal:b,crewTotal:q,crewCostTotal:L,discountAmount:_,subtotalAfterDiscount:U,taxableAmount:O,taxAmount:K,finalTotal:x,companySharePercent:H,companyShareAmount:Z,netProfit:ee}}function Pi(e=[],n=0,t="percent",i=!1,a=[],{start:s=null,end:r=null,companySharePercent:o=null}={}){const l=m=>m&&typeof m=="object"&&(m.positionId!==void 0||m.position_id!==void 0||m.positionLabel!==void 0||m.position_name!==void 0||m.positionClientPrice!==void 0),c=Array.isArray(a)&&a.some(l)?a:[],u=c.length?c.map(m=>m?.technicianId).filter(Boolean):Array.isArray(a)?a:[];return Ie({items:e,technicianIds:u,crewAssignments:c,discount:n,discountType:t,applyTax:i,start:s,end:r,companySharePercent:o??$t}).finalTotal}function Dt({total:e,itemsCount:n,rentalDays:t,techniciansCount:i,applyTax:a,paymentStatus:s,paidAmount:r=0,paidPercent:o=0,companySharePercent:l=null,companyShareAmount:c=null,taxAmount:u=null,netProfit:d=null,totalKey:f="reservations.summary.total",equipmentTotal:m=null,crewTotal:g=null,equipmentCostTotal:y=null}){const N=C("reservations.create.summary.currency","SR"),p=h(String(e)),b=h(String(n)),P=h(String(t??1)),I=h(String(i)),S=xt(s),A=S==="paid"?"Ù…Ø¯ÙÙˆØ¹":S==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",q=C(`reservations.create.paymentStatus.${S}`,A),L=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,B=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,w=L>Pe||B>Pe,_=C("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),U=h(L.toFixed(2)),H=h(B.toFixed(B%1?2:0)),Z=C("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),O=C("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),K=C("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),Q=C("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),x=C("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ee=C("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),v=C("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),E=C("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),G=C(f==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",C("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),ae=C("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),j=C("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),F=Number.isFinite(d)?Math.max(0,Number(d)):null,T=[{label:Z,value:b},{label:O,value:P},{label:K,value:I}],z=Number.isFinite(Number(m))?Math.max(0,Number(m)):null;z!=null&&T.push({label:Q,value:`${h(z.toFixed(2))} ${N}`});const fe=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;fe!=null&&T.push({label:x,value:`${h(fe.toFixed(2))} ${N}`});const he=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(he!=null&&T.push({label:ee,value:`${h(he.toFixed(2))} ${N}`}),a){let oe=C("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(oe=`${h(Number(u).toFixed(2))} ${N}`),T.push({label:v,value:oe})}const _e=Number.isFinite(l)?Number(l):null;if(_e!==null&&_e>0){const oe=Number.isFinite(c)?Number(c):e*(_e/100),Se=h(String(_e)),Jt=h(Number.isFinite(oe)?oe.toFixed(2):"0"),Xt=`${Se}% (${Jt} ${N})`;T.push({label:ae,value:Xt})}if(F!==null&&Math.abs(F-Number(e))>.009){const oe=h(F.toFixed(2));T.push({label:j,value:`${oe} ${N}`})}T.push({label:E,value:q}),w&&T.push({label:_,value:`${U} ${N} (${H}%)`});const Te=`${p} ${N}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${T.map(({label:oe,value:Se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${oe}</span>
            ${Se?`<span class="reservation-summary-value">${Se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${G}</span>
          <span class="reservation-summary-value">${Te}</span>
        </div>
      </div>
    </div>
  `}function xn({selectedItems:e,discount:n,discountType:t,applyTax:i,paidStatus:a,paymentProgressType:s=null,paymentProgressValue:r=null,start:o,end:l,companySharePercent:c=null,paymentHistory:u=[]}){const d=bn(),f=typeof ft=="function"?ft()??[]:[],m=Array.isArray(f)?f.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):m,y=d.length||g.length,N=Number.isFinite(c)?Number(c):null,p=Ie({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:o,end:l,companySharePercent:N}),b=it({totalAmount:p.finalTotal,progressType:s,progressValue:r,history:u}),P=at({manualStatus:a,paidAmount:b.paidAmount,paidPercent:b.paidPercent,totalAmount:p.finalTotal}),I=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,paymentProgressType:b.paymentProgressType,paymentProgressValue:b.paymentProgressValue,total:p.finalTotal};return xn.lastResult=S,Rn(I),I}function Dn({items:e,discount:n,discountType:t,applyTax:i,paidStatus:a,paymentProgressType:s=null,paymentProgressValue:r=null,start:o,end:l,companySharePercent:c=null,paymentHistory:u=[]}){const d=hn(),f=typeof _t=="function"?_t()??[]:[],m=Array.isArray(f)?f.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):m,y=d.length||g.length,N=Number.isFinite(c)?Number(c):null,p=Ie({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:o,end:l,companySharePercent:N}),b=it({totalAmount:p.finalTotal,progressType:s,progressValue:r,history:u}),P=at({manualStatus:a,paidAmount:b.paidAmount,paidPercent:b.paidPercent,totalAmount:p.finalTotal}),I=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={html:I,paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,paymentProgressType:b.paymentProgressType,paymentProgressValue:b.paymentProgressValue,total:p.finalTotal};return Dn.lastResult=S,I}function Rn(e){const n=document.getElementById("reservation-preview");n&&(n.innerHTML=e,At(n,e));const t=document.getElementById("reservation-preview-bottom");t&&(t.innerHTML=e,At(t,e))}function At(e,n){const t=typeof n=="string"&&n.trim().length>0;e.classList.toggle("reservation-summary-host",t)}const Bn=de()||{};let te=(Bn.reservations||[]).map(Kt);function J(e){let n=Number(e);if(!Number.isFinite(n))return 0;let t=0;for(;Math.abs(n)>1e5&&t<8;)n/=10,t+=1;return Number(n.toFixed(2))}const Rt="__reservation_packages_cache__",Bt="__reservation_item_cost_cache__";function zt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Mt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function jt(){const e=zt();if(!e)return{};try{const n=e.getItem(Rt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation packages cache",n),{}}}function Ct(e){const n=zt();if(n)try{n.setItem(Rt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation packages cache",t)}}function ot(){const e=Mt();if(!e)return{};try{const n=e.getItem(Bt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation item cost cache",n),{}}}function Ye(e){const n=Mt();if(n)try{n.setItem(Bt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation item cost cache",t)}}function zn(e,n=0){if(!e||typeof e!="object")return null;const t=e.equipment_id??e.equipmentId??e.id??null,i=h(String(e.barcode??e.code??"")).trim(),a=J(k(e.cost??e.unit_cost)),s=J(k(e.price??e.unit_price)),r=Number.isFinite(a),o=Number.isFinite(s);return!r&&!o?null:{key:t!=null?`id:${t}`:i?`bc:${i}`:`idx:${n}`,equipmentId:t,barcode:i,cost:r?a:null,price:o?s:null}}function Mn(e,n){if(!e)return;const t=Array.isArray(n)?n.map((s,r)=>zn(s,r)).filter(Boolean):[],i=ot(),a=String(e);if(!t.length){i[a]&&(delete i[a],Ye(i));return}i[a]=t,Ye(i)}function jn(e=[]){const n=ot(),t=new Set;e.forEach(a=>{const s=a?.id??a?.reservationId??a?.reservation_code??null;s&&t.add(String(s))});let i=!1;Object.keys(n).forEach(a=>{t.has(a)||(delete n[a],i=!0)}),i&&Ye(n)}function Vn(e){if(!e)return[];const n=ot(),t=String(e),i=n[t];return Array.isArray(i)?i:[]}function Hn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const n=tt();if(!Array.isArray(n)||n.length===0)return[];const t=new Map;e.forEach(a=>{if(!a||typeof a!="object")return;const s=a.equipmentId??a.equipment_id??a.id??null;if(s==null)return;const r=String(s),o=(()=>{const l=[a.qty,a.quantity,a.count,1];for(const c of l){const u=Number(c);if(Number.isFinite(u)&&u>0)return u}return 1})();t.set(r,(t.get(r)||0)+o)});const i=[];return n.forEach((a,s)=>{const r=se(a)||[],o=new Map;let l=!0;if(r.forEach(g=>{const y=g?.equipmentId??g?.equipment_id??null,N=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(y==null){l=!1;return}const p=String(y);o.set(p,(o.get(p)||0)+N)}),!l||o.size===0)return;let c=1/0;for(const[g,y]of o.entries()){const N=t.get(g)||0,p=Math.floor(N/y);if(p<=0){c=0;break}p<c&&(c=p)}if(!Number.isFinite(c)||c<=0)return;for(const[g,y]of o.entries()){const N=t.get(g)||0;t.set(g,Math.max(0,N-c*y))}const u=ge(a?.id??a?.packageId??a?.package_id??a?.code),d=Array.from(o.entries()).map(([g,y])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:y,unit_price:0})),f=(a?.package_code??a?.code??u)||`pkg-${s}`,m=cn(a)||u||`package-${s}`;i.push({package_code:f,name:m,quantity:c,unit_price:St(a)||0,items:d})}),i}function On(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(n=>{const i=(n.positionLabel??"").trim().length>0,a=n.positionId!=null||n.positionKey!=null&&String(n.positionKey).trim()!=="",s=Number.isFinite(Number(n.positionClientPrice))&&Number(n.positionClientPrice)>0,r=Number.isFinite(Number(n.positionCost))&&Number(n.positionCost)>0;return i||a||s||r})}function Kn(e){return[]}function Vt(e=[]){return Array.isArray(e)?e.map((n,t)=>Yt(n,t)).filter(Boolean).map((n,t)=>{const i=ge(n.packageId??n.package_id??n.package_code??n.code??n.id??`pkg-${t}`),a=Be(n,i).map(c=>{const u=R(c.qty??c.quantity??c.count??c.units??c.unit_qty??c.unitQty??c.unit_count??c.unitCount??c.package_quantity??c.packageQty??1),d=J(k(c.price??c.unit_price??0));return{...c,qty:u,quantity:u,price:d,unit_price:d}}),s=R(n.quantity??n.qty??1);let r=J(k(n.unit_price??n.unitPrice??n.price??0));if(!r||r<=0){const c=a.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);c>0&&s>0&&(r=J(Number((c/s).toFixed(2))))}const o=k(n.total_price??n.totalPrice??n.total??r*s),l=o>0?J(o):J(Number((r*s).toFixed(2)));return{...n,packageId:i,package_id:i,qty:s,quantity:s,unit_price:r,unitPrice:r,price:r,total_price:l,total:l,packageItems:a}}):[]}function Le(e,n){if(!e)return;const t=jt(),i=String(e);if(!Array.isArray(n)||n.length===0){t[i]&&(delete t[i],Ct(t));return}t[i]=Vt(n),Ct(t)}function Qn(e){if(!e)return[];const n=jt(),t=String(e),i=n[t];return Array.isArray(i)?Vt(i):[]}function st(e,n=0){if(e==null)return null;if(typeof e!="object"){const P=e!=null?String(e):null;return{assignmentId:`crew-${n}-${P??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:P,technicianName:null,technicianRole:null,notes:null}}const t=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${n}`,i=e&&typeof e.position=="object"?e.position:null,a=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,s=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let r=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";r||(r=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const o=e.position_label_ar??null,l=e.position_label_en??null,c=e.position_label_alt??l??o??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,f=J(D(u)),m=J(D(d)),g=e&&typeof e.technician=="object"?e.technician:null,y=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,N=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,p=e.role??g?.role??e.specialization??null,b=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(t),positionId:a!=null?String(a):null,positionKey:s!=null?String(s):null,positionLabel:r!=null?String(r):"",positionLabelAlt:c!=null?String(c):"",positionLabelAr:o!=null?String(o):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(f)?f:0,positionClientPrice:Number.isFinite(m)?m:0,technicianId:y!=null?String(y):null,technicianName:N!=null?String(N):null,technicianRole:p!=null?String(p):null,technicianPhone:b!=null?String(b):null,notes:e.notes??null}}function Un(){return te}function Ee(e){te=Array.isArray(e)?e.map(He):[],te.forEach(n=>{if(!n)return;const t=n.id??n.reservationId??n.reservationCode;Le(t,n.packages),Mn(t,n.items);const i=n.crewAssignments&&n.crewAssignments.length?n.crewAssignments:n.techniciansDetails||[];On(i)}),jn(te),Zt({reservations:te});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return te}async function Gn(e={}){const n=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&n.set(o,String(l))});const t=n.toString(),a=(await ze(`/reservations/${t?`?${t}`:""}`))?.data;let s=[];Array.isArray(a)?s=a:a&&typeof a=="object"&&(Array.isArray(a.items)?s=a.items:Array.isArray(a.results)?s=a.results:Array.isArray(a.data)?s=a.data:Array.isArray(a.records)&&(s=a.records));const r=s.map(Ve).map(Ot);return Ee(r)}async function Wn(e){const n=await ze("/reservations/",{method:"POST",body:e}),t=Ve(n?.data??{}),i=Array.isArray(e?.items)?e.items:null;if(i&&(Array.isArray(t.items)&&t.items.length?t.items=Ht(t.items,i):t.items=i.map(Oe)),!Number.isFinite(t.companySharePercent)&&e?.company_share_percent!=null&&(t.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(t.paymentHistory)||t.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=rt(e.payment_history);a.length&&(t.paymentHistory=a)}if((!Array.isArray(t.crewAssignments)||t.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const a=e.technicians.map((s,r)=>st(s,r)).filter(Boolean);a.length&&(t.crewAssignments=a,t.techniciansDetails=a.map((s,r)=>{const o=e.technicians[r];return typeof o=="object"?{...o,...s}:s}))}if(Array.isArray(e?.packages)&&e.packages.length){const a=dt({packages:e.packages});t.packages=le(t.packages,a)}{const a=ut(t.items||[],t.packages||[]);t.items=a.items,t.packages=le(t.packages||[],a.packages)}if(Le(t.id??t.reservationId??t.reservation_code,t.packages),t.companySharePercent>0&&(!Number.isFinite(t.companyShareAmount)||t.companyShareAmount<=0)){const a=Ie({items:t.items||[],technicianIds:t.technicians||[],discount:t.discount,discountType:t.discountType,applyTax:t.applyTax,start:t.start,end:t.end,companySharePercent:t.companySharePercent});t.companyShareAmount=a.companyShareAmount,t.cost=a.finalTotal,t.totalAmount=a.finalTotal}return t.companyShareEnabled=e?.company_share_enabled?!0:t.companySharePercent>0,Ee([...te,t]),t}async function ct(e,n){const t=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:n}),i=Ve(t?.data??{}),a=Array.isArray(n?.items)?n.items:null;if(a&&(Array.isArray(i.items)&&i.items.length?i.items=Ht(i.items,a):i.items=a.map(Oe)),console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&n?.company_share_percent!=null&&(i.companySharePercent=Number(n.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(n?.payment_history)){const r=rt(n.payment_history);r.length&&(i.paymentHistory=r,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(n?.technicians)&&n.technicians.length){const r=n.technicians.map((o,l)=>st(o,l)).filter(Boolean);r.length&&(i.crewAssignments=r,i.techniciansDetails=r.map((o,l)=>{const c=n.technicians[l];return typeof c=="object"?{...c,...o}:o}))}if(Array.isArray(n?.packages))if(n.packages.length){const r=dt({packages:n.packages});i.packages=le(i.packages,r)}else i.packages=[];{const r=ut(i.items||[],i.packages||[]);i.items=r.items,i.packages=le(i.packages||[],r.packages)}if(Le(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const r=Ie({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=r.companyShareAmount,i.cost=r.finalTotal,i.totalAmount=r.finalTotal}i.companyShareEnabled=n?.company_share_enabled?!0:i.companySharePercent>0;const s=te.map(r=>String(r.id)===String(e)?i:r);return Ee(s),i}function Ht(e,n){if(!Array.isArray(e)||!Array.isArray(n))return e;const t=new Map;return n.forEach((i,a)=>{if(!i||typeof i!="object")return;const s=i.equipment_id??i.equipmentId??i.id??null,r=h(String(i.barcode??"")).trim(),o=s!=null?`id:${s}`:r?`bc:${r}`:`idx:${a}`,l=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,c=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;t.set(o,{cost:l,price:c})}),e.map((i,a)=>{const s=i.equipmentId??i.equipment_id??i.id??null,r=h(String(i.barcode??"")).trim(),o=[s!=null?`id:${s}`:null,r?`bc:${r}`:null,`idx:${a}`].filter(Boolean);let l=null;for(const u of o)if(t.has(u)){l=t.get(u);break}if(!l)return i;const c={...i};return Number.isFinite(l.cost)&&(c.cost=l.cost,c.unit_cost=l.cost),Number.isFinite(l.price)&&(c.price=l.price,c.unit_price=l.price),c})}function Ot(e){try{return Yn(e)}catch(n){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",n),e}}function Yn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(s=>s!=null?String(s):"").filter(Boolean);if(!n.length)return e;const t=te.find(s=>{if(!s)return!1;const r=s.id!=null?String(s.id):"",o=s.reservationId!=null?String(s.reservationId):"",l=s.reservation_code!=null?String(s.reservation_code):"";return r&&n.includes(r)||o&&n.includes(o)||l&&n.includes(l)});if(!t||!Array.isArray(t.items))return e;const i=new Map;t.items.forEach((s,r)=>{const o=s?.equipmentId??s?.equipment_id??s?.id??null,l=h(String(s?.barcode??"")).trim(),c=o!=null?`id:${o}`:l?`bc:${l}`:`idx:${r}`;i.set(c,s)});const a=e.items.map((s,r)=>{const o=s?.equipmentId??s?.equipment_id??s?.id??null,l=h(String(s?.barcode??"")).trim(),c=[o!=null?`id:${o}`:null,l?`bc:${l}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const g of c)if(i.has(g)){u=i.get(g);break}if(!u)return s;const d={...s},f=Number(u.cost),m=Number(u.price);return Number.isFinite(f)&&f>0&&(d.cost=f,d.unit_cost=f),Number.isFinite(m)&&m>0&&(d.price=m,d.unit_price=m),d});return{...e,items:a}}function Jn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(s=>s!=null?String(s):"").filter(Boolean);if(!n.length)return e;let t=[];for(const s of n)if(t=Vn(s),t.length)break;if(!t.length)return e;const i=new Map;t.forEach((s,r)=>{if(!s||typeof s!="object")return;const o=s.equipmentId??s.equipment_id??null,l=h(String(s.barcode??"")).trim(),c=o!=null?`id:${o}`:l?`bc:${l}`:`idx:${r}`;i.set(c,s)});const a=e.items.map((s,r)=>{const o=s?.equipmentId??s?.equipment_id??s?.id??null,l=h(String(s?.barcode??"")).trim(),c=[o!=null?`id:${o}`:null,l?`bc:${l}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const b of c)if(i.has(b)){u=i.get(b);break}if(!u)return s;const d={...s},f=J(k(u.cost??u.unit_cost)),m=J(k(u.price??u.unit_price)),g=Number.isFinite(f),y=Number.isFinite(m),N=Number(s.cost),p=Number(s.price);return g&&(!Number.isFinite(N)||N<=0)&&(d.cost=f,d.unit_cost=f),y&&(!Number.isFinite(p)||p<=0)&&(d.price=m,d.unit_price=m),d});return{...e,items:a}}async function Xn(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const n=te.filter(t=>String(t.id)!==String(e));Ee(n),Le(e,null)}async function Zn(e){return ct(e,{status:"confirmed",confirmed:!0})}async function ei(e,n=null){const t={status:"completed",confirmed:!0};return typeof n=="string"&&(t.notes=n),ct(e,t)}function Ve(e={}){const n=He({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});return Jn(Ot(n))}function Kt(e={}){return He(e)}function He(e={}){const n=e.id??e.reservation_id??e.reservationId??null,t=e.reservation_code??e.reservationCode??e.reservationId??(n!=null?`RSV-${n}`:null);let i=Array.isArray(e.items)?e.items.map(Oe):[],a=dt(e);const s=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let r=s.map((x,ee)=>st(x,ee)).filter(Boolean),o=r.map((x,ee)=>{const v=s?.[ee];return{...v&&typeof v=="object"?{...v}:v!=null?{id:v}:{},...x}});const l=r.map(x=>x.technicianId).filter(x=>x!=null&&x!=="").map(x=>Number.isNaN(Number(x))?String(x):Number(x)),c=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=k(e.total_amount??e.totalAmount??e.cost??0);const f=k(e.discount??0),m=e.discount_type??e.discountType??"percent",g=["percent","amount"].includes(m)?m:"percent",y=!!(e.apply_tax??e.applyTax??!1);let N=li(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),b=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,P=b!=null?Number.parseFloat(h(String(b).replace("%","").trim())):NaN,I=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let S=I!=null?I===!0||I===1||I==="1"||String(I).toLowerCase()==="true":Number.isFinite(P)&&P>0,A=S&&Number.isFinite(P)?Number(P):0;const q=e.company_share_amount??e.companyShareAmount;let L=Number.isFinite(Number(q))?Number(q):NaN;y&&A<=0&&(A=$t,S=!0);const B=Ie({items:i,technicianIds:l,crewAssignments:r,discount:f,discountType:g,applyTax:y,start:c,end:u,companySharePercent:A>0?A:null});(!Number.isFinite(d)||d<=0||y)&&(d=B.finalTotal),(!Number.isFinite(L)||L<0)&&(L=B.companyShareAmount),L=Number.isFinite(L)?Number(L.toFixed(2)):0,!S&&A>0&&(S=!0);const w=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],_=ni(w),U=rt(_),H=n??t??e.reservation_code??e.reservationId??null;if(a.length)Le(H,a);else{const x=Qn(H);x.length&&(a=le(a,x))}if(!a.length&&Array.isArray(i)&&i.length)try{const x=Hn(i);Array.isArray(x)&&x.length&&(a=le(a,x))}catch(x){console.warn("[reservationsService] inference of packages from items failed",x)}const Z=ut(i,a);i=Z.items,a=le(a,Z.packages);const O=it({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:U});N=at({manualStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,totalAmount:d});const K=N==="paid",Q=ri(e.status??(p?"confirmed":"pending"));return{id:n!=null?String(n):"",reservationId:t??(n!=null?String(n):""),reservationCode:t??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:c,end:u,status:Q,completed:Q==="completed",confirmed:p,location:e.location??"",notes:e.notes??"",discount:f,discountType:g,applyTax:y,paid:K,paidStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,paymentProgressType:O.paymentProgressType,paymentProgressValue:O.paymentProgressValue,paymentHistory:U,payment_history:U,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:r,techniciansDetails:o,startDatetime:c,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:a,companySharePercent:A,companyShareAmount:L,companyShareEnabled:S}}function Oe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const n=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,t=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=k(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),a=k(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),s=h(String(e.barcode??e.code??e.serial??"")),r=e.description??e.desc??e.name??e.title??"",o={id:e.id!=null?String(e.id):n!=null?String(n):"",equipmentId:n,barcode:s,desc:r,qty:t,quantity:t,qtyPerPackage:null,totalQuantity:t,price:i,cost:a,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},l=Qt(e.type??e.item_type??e.kind??null),c=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=W(c),d=Be(e,u);if(l==="package"||u||d.length){o.type="package";const f=u||(n!=null?String(n):o.id?W(o.id):"");f&&(o.packageId=f,o.package_id=f,o.package_code=e.package_code??e.packageCode??f),o.name=r||o.package_code||f||"",o.barcode=o.barcode||h(String(e.package_code??e.packageCode??"")),o.packageItems=d;const m=Gt({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,t);(!Number.isFinite(o.price)||o.price<=0||o.price>m*10)&&(o.price=m),o.qtyPerPackage=d.length?d[0]?.qtyPerPackage??o.qtyPerPackage:o.qtyPerPackage,o.totalQuantity=t}return o}function ti({reservationCode:e,customerId:n,start:t,end:i,status:a,title:s,location:r,notes:o,projectId:l,totalAmount:c,discount:u,discountType:d,applyTax:f,paidStatus:m,confirmed:g,items:y,packages:N,crewAssignments:p=[],technicians:b=p,companySharePercent:P,companyShareEnabled:I,paidAmount:S,paidPercentage:A,paymentProgressType:q,paymentProgressValue:L,paymentHistory:B}){const w=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:n,start_datetime:t,end_datetime:i,status:a??"pending",title:s??null,location:r??null,notes:o??null,project_id:l||null,total_amount:c??0,discount:u??0,discount_type:d??"percent",apply_tax:f?1:0,paid_status:m??"unpaid",paid_amount:Number.isFinite(S)?k(S):0,paid_percentage:Number.isFinite(A)?Number(A.toFixed(2)):0,payment_progress_type:q??null,payment_progress_value:Number.isFinite(L)?Number(L.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(_=>({type:Je(_?.type??_?.payment_type??_?.method??_?.paymentMethod),value:_?.value!=null?k(_.value):null,amount:_?.amount!=null?k(_.amount):_?.payment_amount!=null?k(_.payment_amount):null,percentage:_?.percentage!=null?Number(_.percentage):_?.payment_percentage!=null?Number(_.payment_percentage):null,note:_?.note??_?.notes??_?.comment??_?.payment_note??null,recorded_at:_?.recordedAt??_?.recorded_at??_?.createdAt??_?.created_at??_?.payment_date??_?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(_=>({type:Je(_?.type??_?.payment_type??_?.method??_?.paymentMethod),value:_?.value!=null?k(_.value):null,amount:_?.amount!=null?k(_.amount):_?.payment_amount!=null?k(_.payment_amount):null,percentage:_?.percentage!=null?Number(_.percentage):_?.payment_percentage!=null?Number(_.payment_percentage):null,note:_?.note??_?.notes??_?.comment??_?.payment_note??null,recorded_at:_?.recordedAt??_?.recorded_at??_?.createdAt??_?.created_at??_?.payment_date??_?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:ii(y),packages:ai(y,N),company_share_percent:I&&Number.isFinite(P)?Number(P):null,company_share_enabled:I?1:0,technicians:w.length?w.map((_,U)=>{const H=_.technicianId??_.technician_id??_.id??null,Z=_.positionId??_.position_id??_.position??_.position_code??null,O=_.positionLabel??_.position_name??_.role??null,K=k(_.positionCost??_.position_cost??_.cost??_.daily_wage??_.dailyWage??0),Q=k(_.positionClientPrice??_.position_client_price??_.client_price??_.clientPrice??_.daily_total??_.dailyTotal??_.total??0);return{id:H,technician_id:H,role:O??_.technicianRole??null,notes:_.notes??null,position_id:Z,position_key:_.positionKey??_.position_key??null,position_name:O,position_label_ar:_.positionLabelAr??_.position_label_ar??null,position_label_en:_.positionLabelEn??_.position_label_en??null,position_cost:K,position_client_price:Q,client_price:Q,cost:K,assignment_id:_.assignmentId??_.assignment_id??`crew-${U}`}}):Array.isArray(b)?b.map(_=>typeof _=="object"&&_!==null?{id:_.id??_.technician_id??_.technicianId??_.ID,role:_.role??null,notes:_.notes??null}:Number.isNaN(Number(_))?String(_):Number(_)):[]}}function rt(e){const n=lt(e);return!Array.isArray(n)||n.length===0?[]:n.map(t=>{if(!t||typeof t!="object")return null;const i=t.type??t.payment_type??t.paymentType??t.method??t.paymentMethod??t.kind??null,a=Je(i),s=t.value??t.payment_value??t.paymentValue??t.amount??t.payment_amount??t.percentage??t.payment_percentage??null,r=s!=null?Number.parseFloat(h(String(s))):null,o=t.amount!=null?Number.parseFloat(h(String(t.amount))):t.payment_amount!=null?Number.parseFloat(h(String(t.payment_amount))):null,l=t.percentage!=null?Number.parseFloat(h(String(t.percentage))):t.payment_percentage!=null?Number.parseFloat(h(String(t.payment_percentage))):null,c=Number.isFinite(o)?o:a==="amount"&&Number.isFinite(r)?r:null,u=Number.isFinite(l)?l:a==="percent"&&Number.isFinite(r)?r:null,d=a??(c!=null?"amount":u!=null?"percent":null),f=d==="amount"?c:d==="percent"?u:Number.isFinite(r)?r:null,m=t.note??t.notes??t.comment??t.payment_note??null,g=t.recordedAt??t.recorded_at??t.payment_date??t.date??t.createdAt??t.created_at??null;return{type:d,value:f,amount:c,percentage:u,note:m,recordedAt:g}}).filter(t=>t&&t.type)}function Je(e){if(!e)return null;const n=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(n)?"amount":["percent","percentage","ratio"].includes(n)?"percent":null}function lt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const n=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of n)if(Array.isArray(e[r]))return e[r];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(i))return i;const a=Object.values(e);if(a.length&&a.every(r=>r&&typeof r=="object")){const r=a.map(o=>o);if(r.every(o=>!Array.isArray(o)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const n=JSON.parse(e);return lt(n)}catch{return[]}return[]}function ni(e=[]){if(!Array.isArray(e))return[];for(const n of e){const t=lt(n);if(Array.isArray(t)&&t.length)return t}return[]}function ii(e){if(!Array.isArray(e)||e.length===0)return[];const n=[];return e.forEach(t=>{if(!t||typeof t!="object")return;if(t.type==="package"&&Array.isArray(t.packageItems)&&t.packageItems.length){const r=R(t.qty??t.quantity??1);t.packageItems.forEach(o=>{const l=o?.equipmentId??o?.equipment_id??o?.id??null;if(l==null)return;const c=R(o?.qty??o?.quantity??1),u=r*c,d=k(o?.cost??o?.unit_cost??o?.rental_cost??o?.internal_cost??o?.purchase_price??o?.equipment_cost??o?.item_cost??0);n.push({equipment_id:Xe(l),quantity:u,unit_price:k(o?.price??o?.unit_price??0),unit_cost:d,cost:d,total_cost:Number.isFinite(d)?Number((d*u).toFixed(2)):0,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,notes:o?.notes??null})});return}const i=Array.isArray(t.packageItems)?t.packageItems:[],a=t.equipmentId??t.equipment_id??t.id??null;if(a==null)return;const s=(()=>{const r=k(t.cost??t.unit_cost??t.rental_cost??t.internal_cost??t.purchase_price??t.equipment_cost??0);if(Number.isFinite(r)&&r>0)return r;if(i.length){const o=i.reduce((l,c)=>{const u=k(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.internal_cost??c.purchase_price??c.equipment_cost??c.item_cost??0),d=R(c.qty??c.quantity??c.qtyPerPackage??c.unit_qty??1);return l+u*d},0);if(o>0)return Number(o.toFixed(2))}return r})();n.push({equipment_id:Xe(a),quantity:R(t.qty??t.quantity??1),unit_price:k(t.price??t.unit_price??0),unit_cost:s,cost:s,total_cost:Number.isFinite(s)?Number((s*R(t.qty??t.quantity??1)).toFixed(2)):0,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,notes:t.notes??null})}),n}function Xe(e){const n=Number(e);return Number.isFinite(n)&&n>=0?n:String(e)}function ai(e,n){const t=Array.isArray(n)?n.slice():[],i=new Map;return Array.isArray(e)&&e.forEach(a=>{const s=a?.equipmentId??a?.equipment_id??a?.id??null;if(s==null)return;let r=k(a?.unit_cost??a?.cost??a?.rental_cost??a?.purchase_price);if(!Number.isFinite(r)||r<=0){const o=Ue(s);Number.isFinite(o)&&o>0&&(r=o)}Number.isFinite(r)&&r>0&&i.set(String(s),r)}),Array.isArray(e)&&e.forEach(a=>{if(!a||typeof a!="object"||a.type!=="package")return;const s=W(a.packageId??a.package_id??a.package_code??a.packageCode??a.bundleId??a.bundle_id??a.id??null),r=s?pe(s):null,o=R(a.package_qty??a.packageQty??a.qty??a.quantity??r?.package_qty??1),l=Array.isArray(se(r||{}))&&se(r||{}).length?se(r||{}):Array.isArray(a.packageItems)?a.packageItems:[],c=Array.isArray(l)?l.map(d=>{const f=d?.equipmentId??d?.equipment_id??d?.id??null;if(f==null)return null;let m=k(d?.cost??d?.unit_cost??d?.unitCost??d?.rental_cost??d?.internal_cost??d?.purchase_price??d?.equipment_cost??d?.item_cost??0);if((!Number.isFinite(m)||m===0)&&f!=null){const g=Ue(f);Number.isFinite(g)&&g>0?m=g:i.has(String(f))&&(m=i.get(String(f)))}return{equipment_id:Xe(f),quantity:R(d?.qty??d?.quantity??d?.count??d?.units??d?.unit_qty??d?.unitQty??d?.unit_count??d?.unitCount??d?.package_quantity??d?.packageQty??1),unit_price:k(d?.price??d?.unit_price??0),unit_cost:m,cost:m,rental_cost:m,purchase_price:m,internal_cost:m,equipment_cost:m,item_cost:m}}).filter(Boolean):[];let u=k(a.cost??a.unit_cost??a.rental_cost??a.internal_cost??a.purchase_price??a.equipment_cost??0);if((!Number.isFinite(u)||u===0)&&a.equipmentId!=null){const d=Ue(a.equipmentId);Number.isFinite(d)&&d>0?u=d:i.has(String(a.equipmentId))&&(u=i.get(String(a.equipmentId)))}if((!Number.isFinite(u)||u===0)&&c.length){const d=c.reduce((f,m)=>{const g=k(m.cost??m.unit_cost??m.unitCost??m.rental_cost??m.internal_cost??m.purchase_price??m.equipment_cost??m.item_cost??0),y=R(m.qty??m.quantity??m.qtyPerPackage??1);return f+g*y},0);d>0&&(u=Number(d.toFixed(2)))}t.push({package_code:a.packageId??a.package_id??a.barcode??null,name:a.desc??a.name??"",quantity:o,unit_price:k(a.price??a.unit_price??0),unit_cost:u,cost:u,total_cost:Number.isFinite(u)?Number((u*o).toFixed(2)):0,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u,items:c})}),t}function Qt(e){if(e==null)return"";const n=String(e).trim().toLowerCase();return n==="package"||n==="bundle"||n==="pack"?"package":n}function W(e){if(e==null)return"";const n=String(e).replace(/^package::/i,"");return ge(n)}function Ze(e){return e==null?"":h(String(e)).trim().toLowerCase()}function Ut(e={},n=1){if(!e||typeof e!="object"){const c=h(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:c,normalizedBarcode:Ze(c),desc:"",image:null}}const t=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=k(e.unit_price??e.unitPrice??e.price??0),s=k(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),r=h(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),o=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let l;if(o!=null)l=R(o,{fallback:1,max:99});else if(n>0){const c=i/n;Number.isFinite(c)&&c>0&&Number.isInteger(c)?l=R(c,{fallback:1,max:99}):l=Math.min(i,99)}else l=Math.min(i,99);return{equipmentId:t!=null?String(t):null,equipment_id:t,qty:l,quantity:l,qtyPerPackage:l,totalQuantity:i,price:a,unit_price:a,cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,barcode:r,normalizedBarcode:Ze(e.normalizedBarcode??r),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function oi(e={},n={}){const t=W(e.packageId??e.package_id??e.id??n.packageId??n.package_id??n.id??""),i=R(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=k(e.unit_price??e.unitPrice??e.price??n.price??n.unit_price??n.unitPrice??0);let s=k(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??n.unit_cost??n.unitCost??n.cost??0);if((!Number.isFinite(s)||s===0)&&Array.isArray(e.packageItems)&&e.packageItems.length){const o=e.packageItems.reduce((l,c)=>{const u=k(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.purchase_price??c.internal_cost??c.equipment_cost??c.item_cost??0),d=R(c.qty??c.quantity??c.qtyPerPackage??1);return l+u*d},0);o>0&&(s=Number(o.toFixed(2)))}const r=h(String(e.package_code??e.packageCode??e.barcode??n.package_code??n.packageCode??n.barcode??""));return{id:n.id??(e.id!=null?String(e.id):t?`package::${t}`:""),equipmentId:null,barcode:r,desc:n.desc??n.description??e.name??e.desc??e.title??r,qty:i,quantity:i,price:a,cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,notes:n.notes??null,image:e.image??n.image??null,type:"package",packageId:t,package_id:t,package_code:r,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(n.packageItems)?n.packageItems:[]}}function ut(e=[],n=[]){const t=si(e),i=Array.isArray(n)?le(n,t.packages):t.packages,a=new Map;return i.forEach(s=>{const r=W(s.packageId??s.package_id??s.id);r&&a.set(r,s)}),t.packages.forEach(s=>{const r=W(s.packageId??s.package_id??s.id);if(!r)return;const o=a.get(r);o&&((!Array.isArray(o.packageItems)||o.packageItems.length===0)&&(o.packageItems=s.packageItems),!o.name&&s.name&&(o.name=s.name),!o.image&&s.image&&(o.image=s.image))}),{items:t.items,packages:Array.from(a.values())}}function si(e=[]){const n=new Map;if(e.forEach(s=>{const r=W(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(!r)return;const o=r;n.has(o)||n.set(o,{base:s,items:[]}),n.get(o).items.push(s)}),!n.size)return{items:e,packages:[]};const t=[],i=[],a=new Set;return e.forEach(s=>{const r=W(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(r&&n.has(r)){if(a.has(r))return;const o=n.get(r),l=o.base||s,c=o.items.map(f=>Ut(f,1)),u=(()=>{const f=k(l.unit_cost??l.unitCost??l.cost??l.rental_cost??l.internal_cost??l.purchase_price??l.equipment_cost??l.item_cost??0);if(Number.isFinite(f)&&f>0)return f;if(c.length){const m=c.reduce((g,y)=>{const N=k(y.cost??y.unit_cost??y.unitCost??y.rental_cost??y.internal_cost??y.purchase_price??y.equipment_cost??y.item_cost??0),p=R(y.qty??y.quantity??y.qtyPerPackage??1);return g+N*p},0);if(m>0)return Number(m.toFixed(2))}return f})(),d={packageId:r,package_id:r,package_code:l.package_code??l.packageCode??l.barcode??h(String(r)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${r}`,quantity:R(l.package_quantity??l.packageQty??1,{fallback:1,max:9999}),unit_price:k(l.package_price??l.packagePrice??l.price??0),unit_cost:u,unitCost:u,cost:u,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u,packageItems:c,image:l.image??null};i.push(d),t.push(oi(d,l)),a.add(r);return}t.push(s)}),{items:t,packages:i}}function Be(e={},n=""){if(!e||typeof e!="object")return[];const t=W(n||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let a=se({...e,id:e.id??t??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??t,items:i,packageItems:i}),s=[];if((!Array.isArray(a)||a.length===0)&&t){const c=pe(t);c&&(a=se(c),s=Array.isArray(a)?a:[])}else if(t){const c=pe(t);c&&(s=se(c)||[])}if(!Array.isArray(a)||a.length===0)return[];const r=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),o=a.map(c=>Ut(c,r));if(s.length){const c=new Map;s.forEach(u=>{if(!u)return;const d=Ze(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&c.set(d,u)}),o.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!c.has(d))return;const f=c.get(d),m=R(f.quantity??f.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=m,u.qty=m,u.quantity=m;const g=k(f.unit_price??f.unitPrice??f.price??u.price);u.price=g,u.unit_price=g,!u.desc&&f.desc&&(u.desc=f.desc),!u.image&&f.image&&(u.image=f.image)})}const l=new Map;return o.forEach(c=>{const u=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=c.qty,d.quantity+=c.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=c.qtyPerPackage),(!d.price||d.price===0)&&c.price&&(d.price=c.price,d.unit_price=c.unit_price),!d.desc&&c.desc&&(d.desc=c.desc),!d.image&&c.image&&(d.image=c.image);return}l.set(u,{...c})}}),Array.from(l.values())}function Gt(e={},n=[],t=1){try{const s=W(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(s){const r=pe(s);if(r){const o=St(r);if(Number.isFinite(Number(o))&&Number(o)>0)return Number(o)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return k(i);const a=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(a))){const s=k(a);return t>0?Number((s/t).toFixed(2)):s}return 0}function Wt(e,n){if(!e)return n;if(!n)return e;const t={...e},i=r=>{(t[r]===void 0||t[r]===null||t[r]==="")&&(t[r]=n[r])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(t.unit_price))||t.unit_price===0)&&Number.isFinite(Number(n.unit_price))&&(t.unit_price=n.unit_price,t.unitPrice=n.unitPrice,t.price=n.price);const a=k(t.unit_cost??t.unitCost??t.cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost),s=k(n.unit_cost??n.unitCost??n.cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost);if((!Number.isFinite(a)||a===0)&&Number.isFinite(s)){const r=s;t.unit_cost=r,t.unitCost=r,t.cost=r,t.total_cost=Number.isFinite(n.total_cost)?n.total_cost:t.total_cost,Number.isFinite(t.rental_cost)||(t.rental_cost=r),Number.isFinite(t.purchase_price)||(t.purchase_price=r),Number.isFinite(t.internal_cost)||(t.internal_cost=r),Number.isFinite(t.equipment_cost)||(t.equipment_cost=r),Number.isFinite(t.item_cost)||(t.item_cost=r)}return(!Number.isFinite(Number(t.total_price))||t.total_price===0)&&Number.isFinite(Number(n.total_price))&&(t.total_price=n.total_price,t.total=n.total),!Array.isArray(t.packageItems)||t.packageItems.length===0?(t.packageItems=Array.isArray(n.packageItems)?n.packageItems:[],t.items=t.packageItems):Array.isArray(n.packageItems)&&n.packageItems.length&&(t.packageItems=ci(t.packageItems,n.packageItems),t.items=t.packageItems),t}function ci(e=[],n=[]){const t=new Map,i=a=>{a.forEach(s=>{if(!s)return;const r=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(r){if(t.has(r)){const o=t.get(r);o.qty+=s.qty??0,o.quantity+=s.quantity??0,(!Number.isFinite(o.qtyPerPackage)||o.qtyPerPackage<=0)&&Number.isFinite(s.qtyPerPackage)&&(o.qtyPerPackage=s.qtyPerPackage),(!o.price||o.price===0)&&s.price&&(o.price=s.price,o.unit_price=s.unit_price);const l=k(o.cost??o.unit_cost??o.unitCost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost),c=k(s.cost??s.unit_cost??s.unitCost??s.rental_cost??s.purchase_price??s.internal_cost??s.equipment_cost??s.item_cost);if((!Number.isFinite(l)||l===0)&&Number.isFinite(c)){const u=c;o.cost=u,o.unit_cost=u,o.unitCost=u,Number.isFinite(o.rental_cost)||(o.rental_cost=u),Number.isFinite(o.purchase_price)||(o.purchase_price=u),Number.isFinite(o.internal_cost)||(o.internal_cost=u),Number.isFinite(o.equipment_cost)||(o.equipment_cost=u),Number.isFinite(o.item_cost)||(o.item_cost=u)}!o.desc&&s.desc&&(o.desc=s.desc),!o.image&&s.image&&(o.image=s.image);return}t.set(r,{...s})}})};return i(e),i(n),Array.from(t.values())}function le(e=[],n=[]){const t=[],i=new Map,a=tt(),s=new Map;a.forEach(l=>{const c=W(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&s.set(u,c||u)});const r=l=>{const c=W(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?h(u):"";return c||(d&&s.has(d)?s.get(d):d||null)},o=l=>{Array.isArray(l)&&l.forEach(c=>{if(!c||typeof c!="object")return;const u=r(c);if(u)if(i.has(u)){const d=i.get(u);t[d]=Wt(t[d],c)}else i.set(u,t.length),t.push({...c})})};return o(e),o(n),t}function Ue(e){if(e==null)return 0;const n=de()||{},i=(Array.isArray(n.equipment)?n.equipment:[]).find(s=>[s.id,s.equipment_id,s.equipmentId,s.item_id,s.itemId].some(o=>String(o)===String(e)));if(!i)return 0;const a=k(i.cost??i.unit_cost??i.unitCost??i.rental_cost??i.purchase_price??i.internal_cost??i.equipment_cost??i.item_cost??0);return Number.isFinite(a)&&a>0?a:0}function Yt(e,n=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const g=W(e),y=g?pe(g):null,N=y?Be(y,g):[],p=y?k(y.price??y.unit_price??y.unitPrice??0):0,P=(()=>{const q=y?.unit_cost??y?.unitCost??y?.cost??y?.rental_cost??y?.internal_cost??y?.purchase_price??y?.equipment_cost??y?.item_cost;if(Number.isFinite(Number(q)))return k(q);if(Array.isArray(N)&&N.length){const L=N.reduce((B,w)=>{const _=k(w.cost??w.unit_cost??w.unitCost??w.rental_cost??w.internal_cost??w.purchase_price??w.equipment_cost??w.item_cost??0),U=R(w.qty??w.quantity??w.qtyPerPackage??1);return B+_*U},0);if(L>0)return Number(L.toFixed(2))}return 0})(),I=1,S=Number((p*I).toFixed(2)),A=Number((P*I).toFixed(2));return{id:`package::${g||n}`,packageId:g||`pkg-${n}`,package_id:g||`pkg-${n}`,package_code:h(String(e))||g||`pkg-${n}`,name:y?.name??y?.package_name??y?.packageName??h(String(e))??"",desc:y?.name??h(String(e))??"",quantity:I,qty:I,unit_price:p,unitPrice:p,price:p,unit_cost:P,unitCost:P,cost:P,total_cost:A,rental_cost:P,purchase_price:P,internal_cost:P,equipment_cost:P,item_cost:P,total:S,total_price:S,barcode:h(String(e)),packageItems:N,items:N,type:"package",image:y?.image??null}}if(typeof e!="object")return null;const t=W(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${n}`,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=Be(e,t),s=Gt(e,a,i),o=(()=>{const g=e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost;if(Number.isFinite(Number(g)))return k(g);if(Array.isArray(a)&&a.length){const y=a.reduce((N,p)=>{const b=k(p.cost??p.unit_cost??p.unitCost??p.rental_cost??p.internal_cost??p.purchase_price??p.equipment_cost??p.item_cost??0),P=R(p.qtyPerPackage??p.qty??p.quantity??p.count??1);return N+b*P},0);if(y>0)return Number(y.toFixed(2))}return 0})(),l=e.total_price??e.totalPrice??e.total??s*i,c=Number.isFinite(Number(l))?k(l):Number((s*i).toFixed(2)),u=Number.isFinite(o)?Number((o*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??t,f=h(String(e.barcode??d??"")),m=e.image??e.cover??e.thumbnail??a.find(g=>g.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,packageId:t,package_id:t,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??t,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??t,quantity:i,qty:i,unit_price:s,unitPrice:s,price:s,unit_cost:o,unitCost:o,cost:o,total_cost:u,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,total:c,total_price:c,barcode:f,packageItems:a,items:a,type:"package",image:m}}function dt(e={}){const n=[];Array.isArray(e.packages)&&n.push(e.packages),Array.isArray(e.reservation_packages)&&n.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&n.push(e.reservationPackages),Array.isArray(e.package_details)&&n.push(e.package_details),Array.isArray(e.packageDetails)&&n.push(e.packageDetails),Array.isArray(e.package_list)&&n.push(e.package_list),Array.isArray(e.packageList)&&n.push(e.packageList);const t=[],i=new Map,a=(o,l=t.length)=>{const c=Yt(o,l);if(!c)return;const u=c.packageId||c.package_code||c.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);t[d]=Wt(t[d],c)}else i.set(u,t.length),t.push(c)};n.forEach(o=>{o.forEach((l,c)=>{a(l,c+t.length)})}),t.length===0&&e.package&&a(e.package,0);const s=Array.isArray(e.items)?e.items:[],r=(o={})=>!o||typeof o!="object"?!1:!!(Qt(o.type??o.item_type??o.kind??null)==="package"||o.packageItems&&Array.isArray(o.packageItems)&&o.packageItems.length||o.items&&Array.isArray(o.items)&&o.items.length&&o.items.every(c=>typeof c=="object")||o.packageId||o.package_id||o.package_code||o.packageCode||o.bundleId||o.bundle_id);return s.forEach((o,l)=>{r(o)&&a(o,t.length+l)}),t}function k(e){const n=D(e);return Number.isFinite(n)?Number(n.toFixed(2)):0}function R(e,{fallback:n=1,max:t=1e6}={}){const i=D(e);if(!Number.isFinite(i))return n;const a=Math.round(i);return a<=0||a>t?n:a}function ri(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function li(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function ui(e){return e instanceof en}const Ai=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:ti,closeReservationApi:ei,confirmReservationApi:Zn,createReservationApi:Wn,deleteReservationApi:Xn,getCachedReservationCrew:Kn,getReservationsState:Un,isApiError:ui,mapLegacyReservation:Kt,mapReservationFromApi:Ve,mapReservationItem:Oe,refreshReservationsFromApi:Gn,setReservationsState:Ee,toInternalReservation:He,updateReservationApi:ct},Symbol.toStringTag,{value:"Module"}));export{He as A,Dn as B,qn as C,$t as D,D as E,$ as F,Kn as G,_i as H,hn as I,yi as J,Kt as K,In as L,Zn as M,ei as N,Ai as O,Ni as a,wn as b,it as c,Ie as d,at as e,Xn as f,Un as g,Pi as h,mi as i,bi as j,bn as k,xn as l,Ve as m,Tt as n,Cn as o,Fn as p,An as q,Gn as r,fi as s,ti as t,ct as u,Wn as v,ui as w,gi as x,ft as y,hi as z};
