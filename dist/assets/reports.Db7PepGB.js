import{t as kt,n as k,g as U,l as Pt,w as it,a as R,A as Et}from"./maintenance.BnsilVv3.js";import{o as Tt,p as At}from"./reservations.DRN0EUrN.js";import{m as lt,n as Rt,r as Lt,i as Mt,p as Nt,c as It,s as rt}from"./projects.LJ2hsl-k.js";const Ft=/color\([^)]*\)/gi,B=/(color\(|color-mix\(|oklab|oklch)/i,Bt=["color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","outlineColor","fill","stroke"],$t=typeof document<"u"?document.createElement("canvas"):null,H=$t?.getContext?.("2d")||null;function ut(t){return t.replace(/[A-Z]/g,e=>`-${e.toLowerCase()}`)}function K(t,e="#000"){if(!H||!t)return e;try{return H.fillStyle="#000",H.fillStyle=t,H.fillStyle||e}catch{return e}}function _t(){const t=window.html2canvas;if(!t?.Color||t.Color.__artRatioPatched)return;const e=t.Color.fromString.bind(t.Color);t.Color.fromString=n=>{try{return e(n)}catch(a){if(typeof n=="string"&&B.test(n)){const o=K(n)||"#000";try{return e(o)}catch{return e("#000")}}throw a}},t.Color.__artRatioPatched=!0}function N(t,e,n){if(!t||!e?.style)return;const a=e.style.getPropertyValue(n),o=e.style.getPropertyPriority(n);t.push({element:e,prop:n,value:a,priority:o})}function jt(t=[]){if(!(!Array.isArray(t)||!t.length))for(let e=t.length-1;e>=0;e-=1){const{element:n,prop:a,value:o,priority:s}=t[e]||{};!n?.style||!a||(o&&o.length>0?n.style.setProperty(a,o,s||""):n.style.removeProperty(a))}}function Ht(t,e=window,n=[]){if(!t||!e||typeof e.getComputedStyle!="function")return;const a=t.querySelectorAll?.("*");a&&a.forEach(o=>{const s=e.getComputedStyle(o);if(!s)return;Bt.forEach(i=>{const l=s[i];if(l&&B.test(l)){const d=ut(i);N(n,o,d);const m=i==="backgroundColor"?"#ffffff":s.color||"#000000",u=K(l,m);o.style.setProperty(d,u,"important")}});const c=s.backgroundImage;if(c&&B.test(c)){const i=K(s.backgroundColor||"#ffffff","#ffffff");N(n,o,"background-image"),N(n,o,"background-color"),o.style.setProperty("background-image","none","important"),o.style.setProperty("background-color",i,"important")}})}function qt(t,e=window,n=[]){if(!t||!e||typeof e.getComputedStyle!="function")return;const a=t.querySelectorAll?.("*");a&&a.forEach(o=>{const s=e.getComputedStyle(o);if(!s)return;["color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor"].forEach(i=>{const l=s[i];if(l&&B.test(l)){const d=ut(i);N(n,o,d);const m=i==="backgroundColor"?"#ffffff":"#000000";o.style.setProperty(d,m,"important")}});const c=s.backgroundImage;c&&B.test(c)&&(N(n,o,"background-image"),N(n,o,"background-color"),o.style.setProperty("background-image","none","important"),o.style.setProperty("background-color","#ffffff","important"))})}function Oe(t){if(!t)return;const e=(n="")=>typeof n=="string"&&n.includes("color(")?n.replace(Ft,"#000"):n;t.querySelectorAll?.("style")?.forEach?.(n=>{const a=n.textContent;typeof a=="string"&&a.includes("color(")&&(n.textContent=e(a))}),t.querySelectorAll?.("[style]")?.forEach?.(n=>{const a=n.getAttribute("style");typeof a=="string"&&a.includes("color(")&&n.setAttribute("style",e(a))})}const r={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function Ot(t){r.callbacks.onRender=typeof t=="function"?t:null}function zt(t){r.callbacks.onBeforeRender=typeof t=="function"?t:null}function Vt(t){r.callbacks.onAfterRender=typeof t=="function"?t:null}function Yt(t){r.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function Ut(t){r.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function Xt(t){r.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function p(t,e,n=e){const o=U()==="en"?n??e:e;return kt(t,o)}function W(){r.formatters.cachedLocale=null,r.formatters.numberFormatter=null}function J(){return(U()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function dt(){const t=U();if(t!==r.formatters.cachedLocale||!r.formatters.numberFormatter||!r.formatters.currencyFormatter){r.formatters.cachedLocale=t;const e=J();r.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),r.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:r.formatters.numberFormatter,currencyFormatter:r.formatters.currencyFormatter}}function w(t){const{numberFormatter:e}=dt(),n=e.format(Math.round(t||0));return k(n)}function S(t){const{currencyFormatter:e}=dt(),n=Number.isFinite(Number(t))?Number(t):0,a=e.format(n);return`${k(a)} SR`}function z(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}-${a}-${o}`}function Wt(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=new Intl.DateTimeFormat(J(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return k(n.format(e))}function Kt(t){return new Intl.DateTimeFormat(J(),{month:"short"}).format(t)}function pt(t={}){return{id:t?.id!=null?String(t.id):"",customerName:t?.full_name??t?.customerName??t?.name??"",companyName:t?.company??t?.company_name??t?.companyName??"",phone:t?.phone??""}}function mt(t={}){const e=String(t?.barcode??"").trim(),n=t?.description??t?.name??"";return{id:t?.id!=null?String(t.id):"",barcode:e,desc:n,description:n,name:t?.name??n,category:t?.category??"",subcategory:t?.subcategory??"",status:t?.status??"",price:Number.parseFloat(t?.unit_price??t?.price??0)||0}}function ft(t={}){const e=t?.title??t?.name??"",n=t?.project_code??t?.projectCode??"",a=t?.status??"",o=t?.confirmed===!0;return{id:t?.id!=null?String(t.id):"",title:e,code:n,status:a,confirmed:o}}function Gt(){let t;try{t=Pt()}catch(l){return console.warn("âš ï¸ [reports] Failed to access cached data",l),!1}if(!t||typeof t!="object")return!1;const{reservations:e=[],customers:n=[],equipment:a=[],technicians:o=[],projects:s=[],maintenance:c=[]}=t;return e.length||n.length||a.length||o.length||s.length?(r.data.reservations=Array.isArray(e)?e.map(Tt):[],r.data.customers=Array.isArray(n)?n.map(pt):[],r.data.equipment=Array.isArray(a)?a.map(mt):[],r.data.technicians=Array.isArray(o)?o.map(lt):[],r.data.projects=Array.isArray(s)?s.map(ft):[],r.data.projectsMap=new Map(r.data.projects.map(l=>[l.id,l])),r.data.maintenance=Array.isArray(c)?c.map(it):[],r.techniciansIndex=new Map((r.data.technicians||[]).map(l=>[String(l.id),l])),!0):!1}async function ht({silent:t=!1}={}){if(!r.loading){r.loading=!0,r.errorMessage="",t||r.callbacks.onBeforeRender?.();try{const[e,n,a,o,s,c]=await Promise.all([R("/reservations/?limit=500"),R("/customers/?limit=500"),R("/equipment/?limit=500"),R("/technicians/?limit=500"),R("/projects/?limit=500"),R("/maintenance/?limit=500")]);r.data.reservations=Array.isArray(e?.data)?e.data.map(i=>At(i)):[],r.data.customers=Array.isArray(n?.data)?n.data.map(pt):[],r.data.equipment=Array.isArray(a?.data)?a.data.map(mt):[],r.data.technicians=Array.isArray(o?.data)?o.data.map(lt):[],r.data.projects=Array.isArray(s?.data)?s.data.map(ft):[],r.data.projectsMap=new Map(r.data.projects.map(i=>[i.id,i])),r.data.maintenance=Array.isArray(c?.data)?c.data.map(it):[],r.techniciansIndex=new Map((r.data.technicians||[]).map(i=>[String(i.id),i]))}catch(e){console.error("âŒ [reports] Failed to load reports data",e),r.errorMessage=e instanceof Et?e.message:p("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!r.data.projectsMap||!(r.data.projectsMap instanceof Map))&&(r.data.projectsMap=new Map)}finally{r.loading=!1,t||r.callbacks.onAfterRender?.()}}}const Zt=new Map([["confirmed","confirmed"],["Ù…Ø¤ÙƒØ¯","confirmed"],["Ù…Ø¤ÙƒØ¯Ø©","confirmed"],["approved","confirmed"],["pending","pending"],["Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","pending"],["ØºÙŠØ± Ù…Ø¤ÙƒØ¯","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["Ù…Ù†ØªÙ‡ÙŠ","completed"],["Ù…Ù†ØªÙ‡ÙŠØ©","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["Ù…Ù„ØºÙŠ","cancelled"]]),at=new Map([["paid",!0],["Ù…Ø¯ÙÙˆØ¹",!0],["Ù…Ø¯ÙÙˆØ¹Ø©",!0],["ØªÙ… Ø§Ù„Ø¯ÙØ¹",!0],["completed",!0],["unpaid",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",!1],["pending",!1],["Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",!1]]),Qt=1440*60*1e3;function yt(t){return k(String(t||"")).toLowerCase().trim()}function V(t){return(t||"").toString().trim()}function Jt(t,e){if(!t||!e)return 1;const n=new Date(t),a=new Date(e);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const o=a.getTime()-n.getTime();return o<=0?1:Math.max(1,Math.ceil(o/Qt))}function $(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;Jt(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,n=t.discountType||t.discount_type||"percent",a=String(n).toLowerCase()==="amount"?"amount":"percent",o=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",s=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,c=s!=null?Nt(s):Number.NaN,l=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(c)&&c>0?c:null,d=Array.isArray(t.crewAssignments)?t.crewAssignments:[],m=d.length?d.map(v=>v?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],u=It({items:Array.isArray(t.items)?t.items:[],technicianIds:m,crewAssignments:d,discount:e,discountType:a,applyTax:o,start:t.start,end:t.end,companySharePercent:l}),h=Number(t.cost);let f=u.finalTotal,y=u.taxAmount;if(Number.isFinite(h)&&h>0&&(f=rt(h),o)){const v=f-u.taxableAmount;Number.isFinite(v)&&v>=0&&(y=rt(v))}const b={rentalDays:u.rentalDays,equipmentTotal:u.equipmentTotal,crewTotal:u.crewTotal,crewCostTotal:u.crewCostTotal,discountAmount:u.discountAmount,subtotalAfterDiscount:u.subtotalAfterDiscount,taxableAmount:u.taxableAmount,taxAmount:y,finalTotal:f,companySharePercent:u.companySharePercent,companyShareAmount:u.companyShareAmount,netProfit:u.netProfit,companyShareEnabled:u.companySharePercent>0};return t.__financials=b,b}function gt(t){return t?.projectId&&r.data.projectsMap.get(String(t.projectId))||null}function ot(t=""){const e=String(t).toLowerCase().trim();return e?Zt.get(e)||e:""}function te(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const n of e){const a=String(n||"").toLowerCase().trim();if(a&&at.has(a))return at.get(a)}return t?.paid===!0||t?.paid==="true"}function I(t){const e=gt(t),n=Lt(t,e),a=ot(n.projectStatus);let o=ot(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");n.projectLinked&&a&&(o=a),(!o||o==="cancelled")&&(o=n.effectiveConfirmed?"confirmed":"pending"),(Mt(t)||a==="completed")&&(o="completed");const s=n.effectiveConfirmed||o==="confirmed"||o==="completed";s&&o!=="completed"&&(o="confirmed");const c=te(t),i=t?.paidStatus??t?.paid_status??(c?"paid":"unpaid");return{statusValue:o,confirmed:s,paid:c,paidStatus:i}}function ee(t){const e=t.length;let n=0,a=0,o=0,s=0,c=0,i=0,l=0,d=0,m=0;t.forEach(h=>{const{statusValue:f,confirmed:y,paid:b}=I(h);f==="completed"&&(a+=1),y&&(n+=1),b&&(o+=1);const v=$(h);s+=v.finalTotal,c+=v.companyShareAmount,i+=v.taxAmount,l+=v.crewTotal,d+=v.crewCostTotal??0,m+=v.netProfit});const u=e?s/e:0;return{total:e,confirmed:n,completed:a,paidCount:o,revenue:s,average:u,companyShareTotal:c,taxTotal:i,crewTotal:l,crewCostTotal:d,netProfit:m}}function bt({range:t,start:e,end:n}){const a=new Date;if(a.setHours(23,59,59,999),t==="custom"){const c=e?new Date(`${e}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:st(c)?c:null,endDate:st(i)?i:null}}let o=new Date(a),s=null;switch(t){case"last30":{s=new Date(a),s.setDate(s.getDate()-29);break}case"thisWeek":{const c=new Date(a),l=(c.getDay()-6+7)%7;c.setDate(c.getDate()-l),c.setHours(0,0,0,0);const d=new Date(c);d.setDate(c.getDate()+6),d.setHours(23,59,59,999),s=c,o=d;break}case"thisMonth":{s=new Date(a.getFullYear(),a.getMonth(),1),o=new Date(a.getFullYear(),a.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const c=Math.floor(a.getMonth()/3);s=new Date(a.getFullYear(),c*3,1),o=new Date(a.getFullYear(),(c+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{s=new Date(a.getFullYear(),0,1),o=new Date(a.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:s=null,o=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:o}}function st(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function ne(t,e){const{startDate:n,endDate:a}=bt(e);let o=0;const s=[];return(t||[]).forEach(c=>{if(!c)return;const i=typeof c.repairCost=="number"?c.repairCost:Number.parseFloat(k(String(c.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const l=String(c.statusRaw??c.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const m=c.resolvedAt??c.resolved_at??null,u=c.reportedAt??c.reported_at??null,h=c.createdAt??c.created_at??null,f=m?new Date(m):null,y=u?new Date(u):h?new Date(h):null,b=f&&!Number.isNaN(f.getTime())?f:y&&!Number.isNaN(y.getTime())?y:null;if(b&&(n&&b<n||a&&b>a))return;const v=Math.round(i*100)/100;o+=v,s.push({id:c.id,cost:v,date:b})}),{total:o,items:s}}function re(t,e){const n=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:n,netProfit:(t.netProfit||0)-n}}function ae(t){const e=new Date,n=[];for(let a=5;a>=0;a-=1){const o=new Date(e.getFullYear(),e.getMonth()-a,1),s=o.getFullYear(),c=o.getMonth(),i=t.filter(b=>{const v=b?.start?new Date(b.start):null;return v&&v.getFullYear()===s&&v.getMonth()===c}),l=i.length;let d=0,m=0,u=0;i.forEach(b=>{const v=$(b);d+=v.finalTotal,m+=v.netProfit,u+=v.companyShareAmount});const h=Kt(o),f=new Date(o.getFullYear(),o.getMonth(),1),y=new Date(o.getFullYear(),o.getMonth()+1,0);n.push({label:h,count:l,revenue:d,netProfit:m,companyShare:u,periodStart:f,periodEnd:y,startInput:z(f),endInput:z(y)})}return n}function oe(t){const e={confirmed:0,pending:0,completed:0};(t||[]).forEach(c=>{const{statusValue:i,confirmed:l}=I(c);i==="completed"?e.completed+=1:i==="confirmed"||l?e.confirmed+=1:e.pending+=1});const n=Math.max(1,(t||[]).length),a=e.confirmed,o=e.pending,s=e.completed;return[{label:p("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:p("reservations.reports.status.pendingLabel","Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","Pending confirmation"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:p("reservations.reports.status.completedLabel","Ù…Ù†ØªÙ‡ÙŠØ©","Completed"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-completed",filterKey:"completed"}]}function se(t){const e=t.length||1,n=t.filter(o=>I(o).paid).length,a=t.length-n;return[{label:p("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"),value:n,percent:Math.round(n/e*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:p("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid"),value:a,percent:Math.round(a/e*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function ce(t,e){const n=new Map,a=new Map((e||[]).map(o=>[String(o.id),o]));return t.forEach(o=>{const s=String(o?.customerId??"unknown"),c=n.get(s)||{count:0,revenue:0},i=$(o);c.count+=1,c.revenue+=i.finalTotal,n.set(s,c)}),Array.from(n.entries()).map(([o,s])=>({name:a.get(o)?.customerName||p("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),count:s.count,revenue:s.revenue})).sort((o,s)=>s.revenue-o.revenue).slice(0,5)}function ie(t,e){const n=new Map,a=new Map((e||[]).map(s=>[V(s?.barcode),s])),o=p("reservations.reports.topEquipment.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…","Unnamed equipment");return t.forEach(s=>{(s?.items||[]).forEach(c=>{const i=V(c?.barcode),l=i?a.get(i):null,d=c?.desc||c?.description||c?.name||l?.desc||l?.description||l?.name||"",m=d&&d.trim()?d:o,u=Rt(m)||"unknown",h=Number(c?.qty)||1,f=Number(c?.price)||0,y=h*f,b=n.get(u)||{name:m,count:0,revenue:0};b.name=m,b.count+=h,b.revenue+=y,n.set(u,b)})}),Array.from(n.values()).sort((s,c)=>c.count!==s.count?c.count-s.count:c.revenue-s.revenue).slice(0,5)}function le(t,e,n,a,o){const s=[],c=t?.reservationId||t?.id;c&&s.push(c),t?.notes&&s.push(t.notes);const{statusValue:i,paidStatus:l}=I(t);i&&s.push(i);const d=t?.paymentStatus||t?.payment_status;d&&s.push(d),t?.paid!=null&&s.push(t.paid?"paid":"unpaid"),l&&s.push(l);const m=n.get(String(t?.customerId));m&&s.push(m.customerName,m.company_name||m.companyName,m.contact_person||"");const u=gt(t);return u&&s.push(u.title,u.code,u.status),s.push(vt(l)),(t?.items||[]).forEach(f=>{f?.desc&&s.push(f.desc),f?.barcode&&s.push(f.barcode);const y=a.get(V(f?.barcode));y&&s.push(y.desc,y.description,y.name)}),(t?.technicians||[]).forEach(f=>{const y=o.get(String(f));y&&s.push(y.name,y.role,y.department)}),yt(s.filter(Boolean).join(" ")).includes(e)}function ue(t,e,n,a,o){const{startDate:s,endDate:c}=bt(e),i=yt(e.search),l=!!i,d=new Map((n||[]).map(h=>[String(h.id),h])),m=new Map((a||[]).map(h=>[V(h?.barcode),h])),u=new Map((o||[]).map(h=>[String(h.id),h]));return(t||[]).filter(h=>{const f=h?.start?new Date(h.start):null;if(!f||Number.isNaN(f.getTime())||s&&f<s||c&&f>c)return!1;const{statusValue:y,confirmed:b,paid:v}=I(h);if(e.status==="confirmed"&&!(y==="confirmed"||y==="completed"||b)||e.status==="pending"&&y!=="pending"||e.status==="completed"&&y!=="completed"||e.payment==="paid"&&!v||e.payment==="unpaid"&&v)return!1;if(e.share&&e.share!=="all"){const T=$(h).companySharePercent>0;if(e.share==="with"&&!T||e.share==="without"&&T)return!1}return!(l&&!le(h,i,d,m,u))})}function vt(t){const e=String(t??"").toLowerCase();return e==="paid"?p("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"):e==="partial"?p("reservations.reports.payment.partialLabel","Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹","Partially paid"):p("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid")}function tt(t){if(r.loadedScripts.has(t))return r.loadedScripts.get(t);const e=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,n=new Promise((a,o)=>{const s=()=>{e&&(e.dataset.loaded="true"),a()},c=l=>o(l);if(e){if(e.dataset.loaded==="true"){a();return}e.addEventListener("load",s,{once:!0}),e.addEventListener("error",c,{once:!0});return}const i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>{i.dataset.loaded="true",a()},i.onerror=l=>o(l),document.head.appendChild(i)});return r.loadedScripts.set(t,n),n}function et(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(r.apexChartsReady||(r.apexChartsReady=tt("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),r.apexChartsReady)}function de(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(r.html2PdfReady||(r.html2PdfReady=tt("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),r.html2PdfReady)}function pe(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(r.xlsxReady||(r.xlsxReady=tt("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),r.xlsxReady)}function Y(){const t=document.documentElement;return t.classList.contains("dark")||t.dataset.theme==="dark"?"dark":"light"}function E(t,e){const n=document.getElementById(t);if(n){if(!e||e.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}n.innerHTML=e.map(a=>{const o=Math.min(Math.max(a.percent??0,0),100),s=p("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",w(a.rawCount??a.value??0)),c=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${a.label}</span>
            <span class="reports-progress-value">${w(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${c}" style="width: ${o}%;"></div>
          </div>
          <div class="reports-progress-meta">${s}</div>
        </div>
      `}).join("")}}async function me(t){const e=document.getElementById("reports-volume-chart");if(!e)return;const n=Array.isArray(t)?t:[];if(r.lastTrendData=n,!n.length){r.charts.trend&&(r.charts.trend.destroy(),r.charts.trend=null),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const a=await et();if(!a){e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const o=n.map(f=>f.label),s=n.map(f=>Math.round(f.count||0)),c=n.map(f=>Number(f.revenue||0)),i=n.map(f=>Number(f.netProfit||0)),l=s.reduce((f,y)=>f+(Number.isFinite(y)?y:0),0),d=c.reduce((f,y)=>f+(Number.isFinite(y)?y:0),0),m=i.reduce((f,y)=>f+(Number.isFinite(y)?y:0),0);if(l===0&&d===0&&m===0){r.charts.trend&&(r.charts.trend.destroy(),r.charts.trend=null),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const u=[{name:p("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:s},{name:p("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:c},{name:p("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:i,yAxisIndex:1}],h={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(f,y,b)=>{if(b?.dataPointIndex!=null){const v=r.lastTrendData[b.dataPointIndex];r.callbacks.onTrendDrilldown?.(v,b.dataPointIndex)}}}},theme:{mode:Y()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:o,labels:{style:{colors:Y()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:p("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:f=>w(f)},title:{text:p("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:p("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:f=>S(f)},title:{text:p("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(f,{seriesIndex:y})=>y===0?w(f):S(f)}}};r.charts.trend?(r.charts.trend.updateOptions({...h},!0,!0),r.charts.trend.updateSeries(u,!0)):(e.innerHTML="",r.charts.trend=new a(e,{...h,series:u}),r.charts.trend.render())}catch(a){console.error("âš ï¸ [reports] Failed to render trend chart",a),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function fe(t){const e=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(!e)return;const a=Array.isArray(t)?t:[];r.lastStatusData=a;const o=a.map(c=>Math.max(0,c.value||0)),s=o.reduce((c,i)=>c+i,0);if(!a.length||s===0){r.charts.status&&(r.charts.status.destroy(),r.charts.status=null),E(n,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const c=await et();if(!c){E(n,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const i=a.map(d=>d.label),l={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(d,m,u)=>{if(u?.dataPointIndex!=null){const h=r.lastStatusData[u.dataPointIndex];h?.filterKey&&r.callbacks.onStatusDrilldown?.(h,u.dataPointIndex)}}}},theme:{mode:Y()},labels:i,series:o,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:d=>`${Math.round(d)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:p("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>w(o.reduce((d,m)=>d+m,0))}}}}},tooltip:{y:{formatter:(d,m)=>{const u=r.lastStatusData?.[m?.seriesIndex||0],h=u?`${w(u.percent)}%`:`${w(d)}%`;return`${w(u?u.rawCount??u.value??0:d)} / ${h}`}}}};r.charts.status?(r.charts.status.updateOptions({...l},!0,!0),r.charts.status.updateSeries(o,!0)):(e.innerHTML="",r.charts.status=new c(e,{...l,series:o}),r.charts.status.render()),E(n,a)}catch(c){console.error("âš ï¸ [reports] Failed to render status chart",c),E(n,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function he(t){const e=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(!e)return;const a=Array.isArray(t)?t:[];r.lastPaymentData=a;const o=a.map(c=>Math.max(0,c.value||0)),s=o.reduce((c,i)=>c+i,0);if(!a.length||s===0){r.charts.payment&&(r.charts.payment.destroy(),r.charts.payment=null),E(n,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const c=await et();if(!c){E(n,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const i=a.map(d=>d.label),l={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(d,m,u)=>{if(u?.dataPointIndex!=null){const h=r.lastPaymentData[u.dataPointIndex];h?.filterKey&&r.callbacks.onPaymentDrilldown?.(h,u.dataPointIndex)}}}},theme:{mode:Y()},labels:i,series:o,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:d=>`${Math.round(d)}%`},tooltip:{y:{formatter:(d,m)=>{const u=r.lastPaymentData?.[m?.seriesIndex||0],h=u?`${w(u.percent)}%`:`${w(d)}%`;return`${w(u?u.rawCount??u.value??0:d)} / ${h}`}}}};r.charts.payment?(r.charts.payment.updateOptions({...l},!0,!0),r.charts.payment.updateSeries(o,!0)):(e.innerHTML="",r.charts.payment=new c(e,{...l,series:o}),r.charts.payment.render()),E(n,a)}catch(c){console.error("âš ï¸ [reports] Failed to render payment chart",c),E(n,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}function ye(t){const e=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-revenue-breakdown"),c=document.getElementById("reports-kpi-confirmed"),i=document.getElementById("reports-kpi-confirmed-meta"),l=document.getElementById("reports-kpi-paid"),d=document.getElementById("reports-kpi-paid-meta"),m=t.total||0,u=t.revenue||0,h=t.confirmed||0,f=t.paidCount||0,y=t.average||0,b=t.companyShareTotal||0,v=t.taxTotal||0,F=t.crewTotal||0,T=t.crewCostTotal||0,_=t.netProfit||0,j=t.maintenanceExpense||0,xt=m?Math.round(h/m*100):0,St=m?Math.round(f/m*100):0;if(e&&(e.textContent=w(m)),n){const C=p("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",w(t.completed||0));n.textContent=C}if(a&&(a.textContent=S(u)),o)if(m===0)o.textContent=p("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const C=p("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");o.textContent=C.replace("{net}",S(_)).replace("{share}",S(b)).replace("{average}",S(y))}if(s)if(u>0){const C=[{label:p("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:S(u)},{label:p("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:S(b)},{label:p("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:S(v)},{label:p("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:S(F)},{label:p("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:S(T)}];j>0&&C.push({label:p("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${S(j)}`}),C.push({label:p("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:S(_)}),s.innerHTML=C.map(({label:Ct,value:Dt})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${Ct}</span>
            <span class="reports-kpi-detail-value">${Dt}</span>
          </div>
        `).join(""),s.classList.remove("hidden")}else s.innerHTML="",s.classList.add("hidden");if(c&&(c.textContent=`${xt}%`),i){const C=p("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",w(h));i.textContent=C}if(l&&(l.textContent=`${St}%`),d){const C=p("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",w(f));d.textContent=C}}function D(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function X(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function ge(t,e,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!t||t.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${p("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const o=new Map((e||[]).map(i=>[String(i.id),i]));new Map((n||[]).map(i=>[String(i.id),i]));const s={code:p("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:p("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:p("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:p("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:p("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:p("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:p("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:p("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},c=[...t].sort((i,l)=>new Date(l.start||0)-new Date(i.start||0)).slice(0,20).map(i=>{const l=be(i,o),d={[s.code]:l.code.text,[s.customer]:l.customer.text,[s.date]:l.date.text,[s.status]:l.status.text,[s.payment]:l.payment.text,[s.total]:l.total.text,[s.share]:l.share.text,[s.net]:l.net.text};return{formatted:l,exportRow:d}});return a.innerHTML=c.map(({formatted:i})=>`
      <tr data-drilldown="reservation" data-search="${X(i.code.text)}">
        <td data-report-column="code">${i.code.html}</td>
        <td data-report-column="customer">${i.customer.html}</td>
        <td data-report-column="date">${i.date.html}</td>
        <td data-report-column="status">${i.status.html}</td>
        <td data-report-column="payment">${i.payment.html}</td>
        <td data-report-column="total">${i.total.html}</td>
        <td data-report-column="share">${i.share.html}</td>
        <td data-report-column="net">${i.net.html}</td>
      </tr>
    `).join(""),c.map(({exportRow:i})=>i)}function be(t,e,n){const a=t?.reservationId||t?.id||"â€”",o=k(String(a)),c=e.get(String(t?.customerId))?.customerName||p("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),i=I(t),l=ve(i.statusValue),d=we(i.statusValue,l),m=Array.isArray(t.paymentHistory)?t.paymentHistory:Array.isArray(t.payment_history)?t.payment_history:[],u=xe(i.paidStatus,m),h=m.length;let f=u.html;if(h>0){const j=p("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",w(h));f=`<div class="reports-payment-cell">${u.html}<small class="reports-payment-subtext">${D(j)}</small></div>`}const y=Wt(t?.start),b=$(t),v=S(b.finalTotal),F=b.companySharePercent>0?`${w(b.companySharePercent)}% (${S(b.companyShareAmount)})`:p("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),T=S(b.netProfit),_=D(c);return{code:{html:D(o),text:o},customer:{html:_,text:c},date:{html:D(y),text:y},status:d,payment:{html:f,text:u.text},total:{html:D(v),text:v},share:{html:D(F),text:F},net:{html:D(T),text:T}}}function ve(t){switch(t){case"completed":return q(p("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return q(p("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return q(p("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return k(t||"â€”")}}function we(t,e){const n=q(e);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(t)?t:"info"}">${D(n)}</span>`,text:n}}function xe(t,e=[]){const n=vt(t),a=String(t??"").toLowerCase(),o=a==="paid"?"paid":a==="partial"?"partial":"unpaid";let s="";const c=p("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(e)&&e.length&&(s=e.map(d=>{const m=d?.recordedAt?z(d.recordedAt):"â€”",u=Number.isFinite(Number(d?.amount))&&Number(d.amount)>0?`${k(Number(d.amount).toFixed(2))} ${c}`:"",h=Number.isFinite(Number(d?.percentage))&&Number(d.percentage)>0?`${k(Number(d.percentage).toFixed(2))}%`:"",f=[m];return u&&f.push(u),h&&f.push(h),f.filter(Boolean).join(" â€¢ ")}).join(`
`));const i=s?` title="${X(s)}"`:"";return{html:`<span class="reservation-chip status-${o}"${i}>${D(n)}</span>`,text:n}}function q(t){return k(String(t??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function nt(t){const e=z(new Date).replace(/-/g,"");return`${p("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${e}.${t}`}function Se(t,e,n){const a=new Blob([t],{type:n}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(o),4e3)}function G(t){if(!t||!t.length)return;const e=Object.keys(t[0]),n=[e.join(",")];t.forEach(o=>{const s=e.map(c=>`"${String(o[c]??"").replace(/"/g,'""')}"`);n.push(s.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;Se(a,nt("csv"),"text/csv;charset=utf-8;")}async function Ce(t){try{const e=await pe();if(!e){G(t);return}const n=e.utils.json_to_sheet(t),a=e.utils.book_new(),o=p("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");e.utils.book_append_sheet(a,n,o),e.writeFile(a,nt("xlsx"))}catch(e){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",e),G(t)}}async function De(){const t=document.getElementById("reservations-report-printable");if(!t)return;const e=await de();if(typeof e!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=nt("pdf");_t();const a=[];Ht(t,window,a),qt(t,window,a);try{await e().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(t).save()}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{jt(a)}}async function ke(t,e){switch(t){case"pdf":await De();break;case"excel":await Ce(e);break;case"csv":default:G(e);break}}function Pe(t){const e=document.getElementById("reports-top-customers");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${p("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${X(n.name)}">
        <td>${D(n.name)}</td>
        <td>${w(n.count)}</td>
        <td>${S(n.revenue)}</td>
      </tr>
    `).join("")}}function Ee(t){const e=document.getElementById("reports-top-equipment");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${p("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${X(n.name)}">
        <td>${D(n.name)}</td>
        <td>${w(n.count)}</td>
        <td>${S(n.revenue)}</td>
      </tr>
    `).join("")}}const P=r.filters;function Te(t){if(r.columnControlsBound)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(n=>{const a=n.dataset.columnToggle;a&&(n.checked=r.columnPreferences[a]!==!1,n.addEventListener("change",()=>{r.columnPreferences[a]=n.checked,t()}))}),r.columnControlsBound=!0,t())}function wt(){Object.entries(r.columnPreferences).forEach(([t,e])=>{document.querySelectorAll(`[data-report-column="${t}"]`).forEach(n=>{n.classList.toggle("hidden",!e)})})}function Ae(t){if(r.exportHandlersBound)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(n=>{n.addEventListener("click",async()=>{const{export:a=""}=n.dataset;if(a){n.disabled=!0;try{await t(a)}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{n.disabled=!1}}})}),r.exportHandlersBound=!0)}function Re(t,e){r.searchDebounceTimer&&(clearTimeout(r.searchDebounceTimer),r.searchDebounceTimer=null),r.searchDebounceTimer=setTimeout(()=>{P.search=t||"",e()},220)}function Le(t,e){t&&(P.range="custom",P.start=t.startInput||null,P.end=t.endInput||null,e())}function Me(t,e){t&&(P.status=P.status===t?"all":t,e())}function Ne(t,e){t&&(P.payment=P.payment===t?"all":t,e())}function Ie(t,e){t&&(P.search=t,e())}const g=r.filters;function ct(){W(),x(),setTimeout(()=>{W(),x(),O()},0),setTimeout(()=>{W(),x(),O()},60),O()}function M(){g.range==="custom"&&x()}function O(t,e){if(!window.flatpickr)return;t&&(r.startDateInputRef=t),e&&(r.endDateInputRef=e);const n=r.startDateInputRef,a=r.endDateInputRef;if(!n&&!a)return;const o=Fe(),s=c=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...c};return o&&(i.locale=o),i};if(r.startDatePicker&&(r.startDatePicker.destroy(),r.startDatePicker=null),r.endDatePicker&&(r.endDatePicker.destroy(),r.endDatePicker=null),n&&(r.startDatePicker=window.flatpickr(n,s({onChange(c,i){g.start=i||null,r.endDatePicker&&(c?.length?r.endDatePicker.set("minDate",c[0]):r.endDatePicker.set("minDate",null)),M()},onValueUpdate(c,i){g.start=i||null,M()}}))),a&&(r.endDatePicker=window.flatpickr(a,s({onChange(c,i){g.end=i||null,r.startDatePicker&&(c?.length?r.startDatePicker.set("maxDate",c[0]):r.startDatePicker.set("maxDate",null)),M()},onValueUpdate(c,i){g.end=i||null,M()}}))),r.startDatePicker&&n){r.startDatePicker.setDate(n.value,!1);const c=r.endDatePicker?.selectedDates?.[0]||r.endDateInputRef?.value;c&&r.startDatePicker.set("maxDate",c)}if(r.endDatePicker&&a){r.endDatePicker.setDate(a.value,!1);const c=r.startDatePicker?.selectedDates?.[0]||r.startDateInputRef?.value;c&&r.endDatePicker.set("minDate",c)}}function Fe(){return(U()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function Z(t,e){t&&(t.classList.toggle("active",!!e),t.classList.toggle("hidden",!e))}function A(){const t=document.getElementById("reports-range"),e=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),o=document.getElementById("reports-search"),s=document.getElementById("reports-start"),c=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");t&&t.value!==g.range&&(t.value=g.range),e&&e.value!==g.status&&(e.value=g.status),n&&n.value!==g.payment&&(n.value=g.payment),a&&a.value!==g.share&&(a.value=g.share),o&&o.value!==g.search&&(o.value=g.search||""),s&&s.value!==(g.start||"")&&(s.value=g.start||""),c&&c.value!==(g.end||"")&&(c.value=g.end||""),Z(i,g.range==="custom")}function Q({active:t,icon:e,title:n,subtitle:a}){const o=document.getElementById("reports-empty-state");if(!o)return;const s=o.querySelector(".reports-empty-icon"),c=o.querySelector("h4"),i=o.querySelector("p");r.emptyDefaults.icon===null&&s&&(r.emptyDefaults.icon=s.textContent),r.emptyDefaults.title===null&&c&&(r.emptyDefaults.title=c.textContent),r.emptyDefaults.subtitle===null&&i&&(r.emptyDefaults.subtitle=i.textContent),o.classList.toggle("active",!!t),o.classList.toggle("hidden",!t),!(!s||!c||!i)&&(t?(s.textContent=e!==void 0?e:r.emptyDefaults.icon??s.textContent,c.textContent=n!==void 0?n:r.emptyDefaults.title??c.textContent,i.textContent=a!==void 0?a:r.emptyDefaults.subtitle??i.textContent):(s.textContent=r.emptyDefaults.icon??s.textContent,c.textContent=r.emptyDefaults.title??c.textContent,i.textContent=r.emptyDefaults.subtitle??i.textContent))}function Be(t){Q({active:!!t})}function $e(){if(r.drilldownBound)return;const t=document.getElementById("reports-top-customers"),e=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=o=>{const s=o.target?.closest("[data-drilldown]");if(!s)return;const c=s.dataset.search||"";Ie(c,()=>{A(),x()})};t?.addEventListener("click",a),e?.addEventListener("click",a),n?.addEventListener("click",a),r.drilldownBound=!0}function L(){ht({silent:!0}).catch(t=>{console.error("âŒ [reports] Background refresh failed",t)})}function x(){if(A(),r.loading){Q({active:!0,icon:"â³",title:p("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:p("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(r.errorMessage){Q({active:!0,icon:"âš ï¸",title:r.errorMessage,subtitle:p("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:t,customers:e,equipment:n,technicians:a,maintenance:o}=r.data,s=ue(t,g,e,n,a),c=ee(s),i=ne(o,g),l=re(c,i.total),d=ae(s),m=oe(s),u=se(s),h=ce(s,e),f=ie(s,n);ye(l),me(d),fe(m),he(u),Pe(h),Ee(f);const y=ge(s,e,a);wt(),Be(s.length===0),r.lastSnapshot.filtered=s,r.lastSnapshot.metrics=l,r.lastSnapshot.trend=d,r.lastSnapshot.statusBreakdown=m,r.lastSnapshot.paymentBreakdown=u,r.lastSnapshot.tableRows=y,r.lastSnapshot.maintenance=i}function _e(){if(r.initialized)return;r.initialized=!0;const t=document.getElementById("reports-range"),e=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),o=document.getElementById("reports-start"),s=document.getElementById("reports-end"),c=document.getElementById("reports-refresh"),i=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!t)return;A(),Gt()&&x(),t.addEventListener("change",()=>{g.range=t.value,Z(i,g.range==="custom"),g.range!=="custom"&&(g.start=null,g.end=null),x()}),e?.addEventListener("change",()=>{g.status=e.value,x()}),n?.addEventListener("change",()=>{g.payment=n.value,x()}),a?.addEventListener("change",()=>{g.share=a.value,x()}),l?.addEventListener("input",()=>{const m=l.value||"";Re(m,()=>{A(),x()})}),o?.addEventListener("change",()=>{g.start=o.value||null,M()}),s?.addEventListener("change",()=>{g.end=s.value||null,M()}),c?.addEventListener("click",()=>{g.range==="custom"&&(g.start=o?.value||null,g.end=s?.value||null),x()}),O(o,s),Z(i,g.range==="custom"),r.languageListenerAttached||(document.addEventListener("language:changed",ct),document.addEventListener("language:translationsReady",ct),r.languageListenerAttached=!0),r.dataListenersAttached||(document.addEventListener("reservations:changed",L),document.addEventListener("customers:changed",L),document.addEventListener("equipment:changed",L),document.addEventListener("projects:changed",L),document.addEventListener("technicians:updated",L),window.addEventListener("maintenance:updated",L),r.dataListenersAttached=!0),Te(wt),Ae(async m=>{const u=r.lastSnapshot.tableRows||[];if(!u.length){console.warn("[reports] No reservation data to export");return}await ke(m,u)}),$e(),r.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>x(),0)}),r.themeListenerAttached=!0),Ot(x),zt(()=>{x()}),Vt(()=>{x()}),Yt(m=>{Le(m,()=>{A(),x()})}),Ut(m=>{Me(m?.filterKey,()=>{A(),x()})}),Xt(m=>{Ne(m?.filterKey,()=>{A(),x()})}),ht().catch(m=>{console.error("âŒ [reports] Failed to initialise reports data",m)})}const ze=Object.freeze(Object.defineProperty({__proto__:null,initReports:_e,renderReports:x},Symbol.toStringTag,{value:"Module"}));export{Ht as a,qt as e,_t as p,ze as r,Oe as s};
