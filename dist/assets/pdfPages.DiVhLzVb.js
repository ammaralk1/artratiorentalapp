import{t as d,r as z,f as nt,c as st,p as it,a as ct,b as I,d as K,e as lt}from"./calculations.37hi9VUg.js";import{e as pt}from"./reports.D8q2rQQA.js";import{s as dt,c as mt,d as ut,q as ht}from"./controller.CR8SjxvR.js";import{n as Y}from"./auth.D26aJb88.js";import"./reservationsService.BABq2xlS.js";import"./dashboard.C9KX9b4c.js";/* empty css              */import"./dashboardShell.DSlrRq8a.js";import"./customers.9QukT3kn.js";import"./maintenanceService.Brky0jy-.js";const U=96,X=25.4,Q=210,ft=297,$=Math.round(Q/X*U),O=Math.round(ft/X*U),F=U/X,gt=/safari/i,yt=/(iphone|ipad|ipod)/i,xt=/(crios|fxios|edgios|opios)/i;function V(){try{const e=navigator.userAgent||"";return yt.test(e)&&gt.test(e)&&!xt.test(e)}catch{return!1}}function bt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function wt(e="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",e);const r=document.createElement("style");r.textContent=String(ht).trim(),t.appendChild(r);const s=document.createElement("div");s.className="quote-preview-pages",s.setAttribute("data-quote-pages",""),t.appendChild(s);const o=document.createElement("style");return o.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; table-layout:fixed; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    .rpt-table th, .rpt-table td { vertical-align: middle !important; line-height: 1.6; }
    .rpt-table th > *, .rpt-table td > * { vertical-align: middle !important; }
    /* Use the same robust centering wrapper used by quotes, but right-justify for RTL numbers/text */
    .rpt-table .quote-cell { display:flex; align-items:center; justify-content:flex-end; width:100%; min-height:18px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(o),t}function Z(){try{const e=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct")),s=Number(localStorage.getItem("reportsPdf.textNudgePx"));return{rightMm:Number.isFinite(e)?e:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985,textNudgePx:Number.isFinite(s)?Math.max(-4,Math.min(4,s)):-3}}catch{return{rightMm:6,topMm:-10,scale:.985,textNudgePx:-3}}}function B({rightMm:e,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(e)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function vt(e){try{const t=Z(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const s="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">رفع النص(px)</span>
        <input type="number" step="0.5" min="-4" max="4" value="${t.textNudgePx}" data-rpt-text-nudge style="${s}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const o=e.querySelector("[data-quote-pages]");e.insertBefore(r,o);const f=()=>{const g=Number(r.querySelector("[data-rpt-right]").value),N=Number(r.querySelector("[data-rpt-top]").value),m=Number(r.querySelector("[data-rpt-scale]").value),u=Math.max(.9,Math.min(1,m/100)),C=Math.max(-4,Math.min(4,Number(r.querySelector("[data-rpt-text-nudge]").value)));B({rightMm:g,topMm:N,scale:u});try{localStorage.setItem("reportsPdf.textNudgePx",String(C))}catch{}const w=g*F,a=N*F;Object.assign(o.style,{transformOrigin:"top left",transform:`translate(${w}px, ${a}px) scale(${u})`});try{e.style.setProperty("--cell-text-nudge",`${C}px`)}catch{}};r.querySelector("[data-rpt-apply]").addEventListener("click",f),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,r.querySelector("[data-rpt-text-nudge]").value=-3,B({rightMm:0,topMm:0,scale:1});try{localStorage.setItem("reportsPdf.textNudgePx",String(-3))}catch{}const g=e.querySelector("[data-quote-pages]");Object.assign(g.style,{transform:"none"});try{e.style.setProperty("--cell-text-nudge","-3px")}catch{}});const l=t.rightMm*F,n=t.topMm*F;Object.assign(o.style,{transformOrigin:"top left",transform:`translate(${l}px, ${n}px) scale(${t.scale})`});try{e.style.setProperty("--cell-text-nudge",`${t.textNudgePx}px`)}catch{}}catch{}}function G({primary:e=!1}={}){const t=document.createElement("div");return t.className="quote-page",e&&t.classList.add("quote-page--primary"),t}function Pt(e){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=d("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const s=document.createElement("p");s.className="rpt-subtitle",s.textContent=`${lt(new Date)} • ${d("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(s);const o=document.createElement("div");o.className="rpt-kpis";const f=(l,n)=>{const g=document.createElement("div");return g.className="rpt-kpi",g.innerHTML=`<div class="label">${l}</div><div class="value">${n}</div>`,g};return o.appendChild(f(d("reservations.reports.kpi.total.label","الحجوزات","Reservations"),K(e.total||0))),o.appendChild(f(d("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),I(e.revenue||0))),o.appendChild(f(d("reservations.reports.kpi.net.label","صافي الربح","Net profit"),I(e.netProfit||0))),o.appendChild(f(d("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),I(e.companyShareTotal||0))),o.appendChild(f(d("reservations.reports.kpi.tax.label","الضريبة","Tax"),I(e.taxTotal||0))),o.appendChild(f(d("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),I(e.maintenanceExpense||0))),t.appendChild(o),t}function Ct(){try{const e=z?.data||{},t=z?.lastSnapshot?.filtered||e.reservations||[],r=new Map((e.customers||[]).map(n=>[String(n.id),n])),s=[...t].sort((n,g)=>new Date(g?.start||0)-new Date(n?.start||0)),o={code:d("reservations.reports.results.headers.id","الحجز","Reservation"),customer:d("reservations.reports.results.headers.customer","العميل","Customer"),date:d("reservations.reports.results.headers.date","التاريخ","Date"),status:d("reservations.reports.results.headers.status","الحالة","Status"),payment:d("reservations.reports.results.headers.payment","الدفع","Payment"),total:d("reservations.reports.results.headers.total","الإجمالي","Total"),share:d("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:d("reservations.reports.results.headers.net","صافي الربح","Net profit")},f=[o.code,o.customer,o.date,o.status,o.payment,o.total,o.share,o.net],l=s.map(n=>{const g=n?.reservationId||n?.id||"—",N=Y(String(g)),u=r.get(String(n?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),C=nt(n?.start),w=st(n),a=(()=>{switch(w.statusValue){case"completed":return String(d("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(d("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(d("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return Y(String(w.statusValue||"—"))}})(),P=it(w.paidStatus),M=ct(n),_=I(M.finalTotal),W=M.companySharePercent>0?`${K(M.companySharePercent)}% (${I(M.companyShareAmount)})`:d("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),c=I(M.netProfit);return{[o.code]:N,[o.customer]:u,[o.date]:C,[o.status]:a,[o.payment]:P,[o.total]:_,[o.share]:W,[o.net]:c}});return{headers:f,rows:l}}catch(e){return console.warn("[reports/pdf] failed to build export rows from state",e),{headers:[],rows:[]}}}function J(e){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),s=document.createElement("tr");e.forEach(f=>{const l=document.createElement("th");l.textContent=f,s.appendChild(l)}),r.appendChild(s);const o=document.createElement("tbody");return t.appendChild(r),t.appendChild(o),{table:t,tbody:o}}function Mt(e,t,r,s){const o=e.querySelector("[data-quote-pages]"),f=G({primary:!0});o.appendChild(f);const l=Pt(s);f.appendChild(l);let{table:n,tbody:g}=J(r);f.appendChild(n);const N=18,m=28,u=[];for(let a=0;a<t.length;a+=m)u.push(t.slice(a,a+m));if(u.length){const a=u[0];if(a.length>N){const P=a.splice(N);u.length>1?u[1]=P.concat(u[1]):u.push(P)}}const C=(a,P)=>{const M=document.createElement("tr");r.forEach(_=>{const W=document.createElement("td"),c=document.createElement("div");c.className="quote-cell",c.textContent=P[_]!=null?String(P[_]):"",W.appendChild(c),M.appendChild(W)}),a.appendChild(M)};(u.shift()||t).forEach(a=>C(g,a)),u.forEach(a=>{const P=G({primary:!1});o.appendChild(P);const M=J(r);P.appendChild(M.table),a.forEach(_=>C(M.tbody,_))})}function St(e=[],{context:t="preview"}={}){const s=(z.lastSnapshot||{}).metrics||{};let o,f=e&&e.length?e:null;if(f)o=Object.keys(f[0]||{});else{const g=Ct();o=g.headers,f=g.rows}const l=wt(t),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${$}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(l);try{dt(l),mt(l),ut(l)}catch{}return Mt(l,f||[],o,s),l.parentElement?.removeChild(l),n.parentElement?.removeChild(n),t==="preview"&&vt(l),l}async function Wt(e=[],{action:t="save"}={}){const r=St(e,{context:"export"}),s=document.createElement("div");Object.assign(s.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),s.appendChild(r),document.body.appendChild(s);try{if(t==="print"){if(V()){const a=window.open("","_blank");if(!a)throw new Error("Popup blocked");const P=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${d("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{a.document.open(),a.document.write(P),a.document.close()}catch{}const M=r.cloneNode(!0);try{a.document.body.appendChild(M)}catch{}try{a.document?.fonts?.ready&&await a.document.fonts.ready}catch{}await new Promise(_=>setTimeout(_,60));try{a.focus(),a.print()}catch{}return}const m=document.createElement("iframe");Object.assign(m.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0",opacity:"0",pointerEvents:"none"}),document.body.appendChild(m);const u=m.contentWindow?.document,C=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${d("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{u.open(),u.write(C),u.close()}catch{}const w=r.cloneNode(!0);try{u.body.appendChild(w)}catch{}try{u.fonts?.ready&&await u.fonts.ready}catch{}await new Promise(a=>setTimeout(a,60));try{m.contentWindow?.focus(),m.contentWindow?.print()}catch{}setTimeout(()=>{try{m.remove()}catch{}},1500);return}const l=V()&&!bt()?window.open("","_blank"):null;if(l)try{l.document.open(),l.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${d("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${d("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${d("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),l.document.close()}catch{}await pt();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const n=Z();try{r.style.setProperty("--cell-text-nudge",`${n.textNudgePx}px`)}catch{}const g=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,N=window.html2canvas;if(typeof g=="function"&&typeof N=="function"){const m=new g({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),C={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},w=Array.from(r.querySelectorAll(".quote-page"));let a=0;const P=(c,p=250)=>{try{const i=c.getContext("2d"),{width:y,height:b}=c,h=new Uint8ClampedArray(y*4),v=x=>{const k=i.getImageData(0,x,y,1).data||h;let R=0;for(let E=0;E<y;E+=1){const q=E*4,T=k[q],D=k[q+1],A=k[q+2];if((T<p||D<p||A<p)&&(R+=1,R>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let S=0;for(let x=0;x<b;x+=2)if(!v(x)){S=x;break}return S}catch{return 0}},M=(c,p=245)=>{try{const i=c.getContext("2d"),{width:y,height:b}=c,h=Math.floor(y*.55),v=Math.max(10,y-h),S=Math.max(3,Math.ceil(v*.015));for(let x=0;x<b;x+=2){const k=i.getImageData(h,x,v,1).data;let R=0;for(let E=0;E<v;E+=1){const q=E*4,T=k[q],D=k[q+1],A=k[q+2];if((T<p||D<p||A<p)&&(R+=1,R>=S))return x}}return 0}catch{return 0}},_=(c,p=250)=>{try{const i=c.getContext("2d"),{width:y,height:b}=c,h=S=>{const x=i.getImageData(0,S,y,1).data;let k=0;for(let R=0;R<y;R+=1){const E=R*4,q=x[E],T=x[E+1],D=x[E+2];if((q<p||T<p||D<p)&&(k+=1,k>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let v=0;for(let S=b-1;S>=0;S-=2)if(!h(S)){v=b-1-S;break}return v}catch{return 0}},W=(c,p,i)=>{try{const{width:y,height:b}=c,h=Math.max(0,Math.min(b-1,Math.round(p))),v=Math.max(0,Math.min(b-h,Math.round(i))),S=Math.max(1,b-h-v);if(h===0&&v===0)return c;const x=document.createElement("canvas");return x.width=y,x.height=S,x.getContext("2d").drawImage(c,0,-h),x}catch{return c}};for(let c=0;c<w.length;c+=1){const p=w[c],i=p.ownerDocument||document,y=i.createElement("div");Object.assign(y.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const b=i.createElement("div");b.id="quotation-pdf-root",b.setAttribute("data-quote-render-context","export");try{b.style.setProperty("--cell-text-nudge",`${n.textNudgePx}px`)}catch{}b.style.width=`${$}px`,b.style.maxWidth=`${$}px`,b.style.minWidth=`${$}px`,b.style.background="#ffffff";const h=p.cloneNode(!0);h.style.width=`${$}px`,h.style.maxWidth=`${$}px`,h.style.minWidth=`${$}px`,h.style.height=`${O}px`,h.style.maxHeight=`${O}px`,h.style.minHeight=`${O}px`,h.style.position="relative",h.style.background="#ffffff",h.style.overflow="hidden",b.appendChild(h),y.appendChild(b),i.body.appendChild(y);let v;try{v=await N(h,{...C,scrollX:0,scrollY:0,windowWidth:$,windowHeight:O})}finally{y.parentNode?.removeChild(y)}if(!v)continue;const S=P(v,246),x=M(v,244),k=Math.max(S,x),R=_(v,246),E=W(v,k,R),q=Math.max(.9,Math.min(1,n.scale||1)),T=Q*q,D=E.height/E.width*T;let A=Number(n.rightMm)||0;const tt=p.classList.contains("quote-page--primary")?6:12;let L=0;try{const j=p.querySelector(".rpt-header")||p.firstElementChild;if(j){const rt=j.getBoundingClientRect(),at=p.getBoundingClientRect();L=Math.max(0,rt.top-at.top)}}catch{L=0}const et=L/F;let H=(Number(n.topMm)||0)+tt-et;H<-80&&(H=-80);const ot=E.toDataURL("image/jpeg",.95);a>0&&m.addPage(),m.addImage(ot,"JPEG",A,H,T,D,`page-${a+1}`,"FAST"),a+=1,await new Promise(j=>requestAnimationFrame(j))}if(a===0)throw new Error("PDF generation produced no pages");if(t==="print"){const c=m.output("bloburl");if(l)try{l.location.href=c}catch{}else await new Promise(p=>{const i=document.createElement("iframe");Object.assign(i.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),i.onload=()=>{try{i.contentWindow?.focus(),i.contentWindow?.print()}catch{}setTimeout(()=>{i.remove(),p()},700)},i.src=c,document.body.appendChild(i)})}else try{const c=m.output("blob"),p=URL.createObjectURL(c),i=document.createElement("a");i.href=p,i.download="reservations-report.pdf",i.rel="noopener",i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{try{URL.revokeObjectURL(p),i.remove()}catch{}},1500)}catch{m.save("reservations-report.pdf")}}else{const m=window.html2pdf().set({margin:0,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const u=await m.get("pdf").then(C=>C.output("bloburl"));await new Promise(C=>{const w=document.createElement("iframe");Object.assign(w.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),w.onload=()=>{try{w.contentWindow?.focus(),w.contentWindow?.print()}catch{}setTimeout(()=>{w.remove(),C()},700)},w.src=u,document.body.appendChild(w)})}else await m.save("reservations-report.pdf")}}finally{s.remove()}}export{St as buildReportsPdfPages,Wt as exportReportsPdf};
