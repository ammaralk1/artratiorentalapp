(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();function de(){const e=typeof window<"u"?window:globalThis;return e.__APP_DATA_STORE__||(e.__APP_DATA_STORE__={customers:[],reservations:[],equipment:[],technicians:[],maintenance:[],projects:[]}),e.__APP_DATA_STORE__}function b(e,t,n){n!=null&&(e[t]=Array.isArray(n)?[...n]:n)}function fe(){const e=de();return{customers:[...e.customers],reservations:[...e.reservations],equipment:[...e.equipment],technicians:[...e.technicians],maintenance:[...e.maintenance],projects:[...e.projects]}}function De({customers:e,reservations:t,equipment:n,technicians:r,maintenance:i,projects:a}){const o=de();b(o,"customers",e),b(o,"reservations",t),b(o,"equipment",n),b(o,"technicians",r),b(o,"maintenance",i),b(o,"projects",a)}let ie=!1;function Yt(e=null){if(ie)return;const t=e||(typeof window<"u"?window.__LEGACY_DATA__:null);if(!t||typeof t!="object"){ie=!0;return}const n=de();if(["customers","reservations","equipment","technicians","maintenance","projects"].forEach(i=>{const a=t[i];Array.isArray(a)&&a.length>0&&(n[i]=[...a])}),ie=!0,!e&&typeof window<"u")try{delete window.__LEGACY_DATA__}catch{}}const X={language:"ar",theme:"light",dashboardTab:null,dashboardSubTab:null,projectsTab:null,projectsSubTab:null},d={enabled:!1,user:null,preferences:{...X},counters:{customers:1e3,equipment:2e3,technicians:3e3,reservations:4e3,maintenance:5e3,projects:6e3,users:7e3},users:[],userLogs:{}};function Q(e){try{return JSON.parse(JSON.stringify(e))}catch{return null}}function N(e){const t=Number.isFinite(d.counters[e])?d.counters[e]:1;return d.counters[e]=t+1,t}function D(e){return Array.isArray(e)?e:[]}function Xe(e){const t=new URL(e,"https://preview.local");return{pathname:t.pathname.endsWith("/")?t.pathname:`${t.pathname}/`,searchParams:t.searchParams}}function c(e){return{ok:!0,payload:e}}function S(e,t,n=null){return{ok:!1,status:e,message:t,payload:n}}function A(){return new Date().toISOString()}function ue(e){return e&&String(e).trim().toLowerCase()||"viewer"}function E(e){const t=Number.parseFloat(e);return Number.isFinite(t)?t:0}function Z(e,t=1){const n=Number.parseInt(e,10);return Number.isFinite(n)&&n>0?n:t}function U(e){const t=fe();return D(t[e])}function m(e,t){De({[e]:t})}function Qe(e={}){return d.preferences={...d.preferences,...e},Q(d.preferences)||{...X}}function F(e,t){const n=t.get("limit");if(!n)return e;const r=Number.parseInt(n,10);return!Number.isFinite(r)||r<0?e:e.slice(0,r)}function V(e){return`RSV-${String(e).padStart(4,"0")}`}function Ze(){const e=fe(),t=D(e.reservations),n=D(e.equipment),r=D(e.technicians),i=D(e.projects),a=D(e.maintenance),s=new Date().toISOString().slice(0,10);let u=0,l=0;t.forEach(g=>{const _=g.start_datetime||g.start||g.startDatetime;if(!_)return;const he=String(_).slice(0,10);he===s?u+=1:he>s&&(l+=1)});const f=n.filter(g=>{const _=String(g.status||g.status_raw||"").toLowerCase();return _==="maintenance"||_==="in_maintenance"}).length,p=r.filter(g=>String(g.status||"").toLowerCase()==="busy").length,y=i.filter(g=>{const _=String(g.status||"").toLowerCase();return _?["active","in_progress","in-progress","confirmed"].includes(_):!!g.confirmed}).length,h=a.filter(g=>{const _=String(g.status||g.status_raw||"").toLowerCase();return _!=="completed"&&_!=="cancelled"&&_!=="closed"}).length,v=a.filter(g=>String(g.priority||"").toLowerCase()==="high").length;return{customers:{total:D(e.customers).length},reservations:{total:t.length,today:u,upcoming:l},equipment:{total:n.length,maintenance:f},technicians:{total:r.length,busy:p},projects:{total:i.length,active:y},maintenance:{open:h,highPriority:v}}}function xe(){d.enabled=!0}function G(){return d.enabled}function ee(e){xe(),d.user=e?{...e}:null}function me(){return d.user?{...d.user}:null}function Xt(e={}){xe(),e.currentUser&&ee(e.currentUser),e.preferences&&typeof e.preferences=="object"&&(d.preferences={...d.preferences,...e.preferences}),Array.isArray(e.users)&&(d.users=e.users.map(n=>({...n}))),e.userLogs&&typeof e.userLogs=="object"&&(d.userLogs=Object.entries(e.userLogs).reduce((n,[r,i])=>(n[r]={sessions:Array.isArray(i.sessions)?i.sessions.map(a=>({...a})):[],activity:Array.isArray(i.activity)?i.activity.map(a=>({...a})):[]},n),{})),e.counters&&typeof e.counters=="object"&&(d.counters={...d.counters,...e.counters});const t={};["customers","equipment","reservations","technicians","maintenance","projects"].forEach(n=>{Array.isArray(e[n])&&(t[n]=e[n].map(r=>({...r})))}),Object.keys(t).length>0&&De(t)}function et(e,t){if(e==="GET")return c({data:me()});if(e==="POST"){const n=A(),r=t?.username||"preview-admin",i=ue(t?.role||"admin"),a={id:d.user?.id??1,username:r,role:i,loginAt:n};return ee(a),c({data:{...a}})}return e==="DELETE"?(ee(null),c({data:{ok:!0}})):c({data:null})}function tt(e,t){if(e==="GET")return c({data:Q(d.preferences)||{...X}});if(e==="PATCH"){const r=Qe(t&&typeof t=="object"?t:{});return c({data:r})}return c({data:Q(d.preferences)||{...X}})}function nt(e,t,n){const r=U("customers");if(e==="GET"){const a=F(r,t);return c({data:a})}if(e==="POST"){const a=N("customers"),o=A(),s=n?.full_name||n?.customerName||n?.name||"عميل جديد",u=n?.phone||"",l=n?.company||n?.companyName||"",f=n?.notes||"",p={id:a,full_name:s,customer_name:s,customerName:s,name:s,phone:u,email:n?.email||"",address:n?.address||"",company:l,notes:f,created_at:o,updated_at:o},y=[...r,p];return m("customers",y),c({data:p})}const i=t.get("id");if(e==="PATCH"){if(!i)return S(400,"Missing customer id");const a=r.map(s=>String(s.id)!==String(i)?s:{...s,...n,full_name:n?.full_name||n?.customerName||n?.name||s.full_name,customer_name:n?.full_name||n?.customerName||s.customer_name,customerName:n?.full_name||n?.customerName||s.customerName,name:n?.full_name||n?.customerName||s.name,updated_at:A()});m("customers",a);const o=a.find(s=>String(s.id)===String(i));return c({data:o})}if(e==="DELETE"){if(!i)return S(400,"Missing customer id");const a=r.filter(o=>String(o.id)!==String(i));return m("customers",a),c({data:{ok:!0}})}return c({data:r})}function _e(e,t={}){const n=A(),r=t.id??N("equipment"),i=e.description||e.desc||e.name||"عنصر",a=String(e.status||"available").toLowerCase();return{id:r,description:i,desc:i,name:e.name||i,category:e.category||"",subcategory:e.subcategory||e.sub||"",sub:e.subcategory||e.sub||"",quantity:Z(e.quantity??e.qty??1,1),qty:Z(e.quantity??e.qty??1,1),unit_price:E(e.unit_price??e.price??0),price:E(e.unit_price??e.price??0),barcode:e.barcode||"",status:a,image_url:e.image_url||e.imageUrl||e.image||"",image:e.image_url||e.imageUrl||e.image||"",created_at:t.created_at||n,updated_at:t.updated_at||n}}function rt(e,t,n){const r=U("equipment");if(e==="GET"){const a=F(r,t);return c({data:a})}if(e==="POST"){if(t.get("bulk")==="1"&&Array.isArray(n)){const s=n.map(l=>_e(l)),u=[...r,...s];return m("equipment",u),c({data:s,meta:{count:s.length}})}const a=_e(n||{}),o=[...r,a];return m("equipment",o),c({data:a})}const i=t.get("id");if(e==="PATCH"){if(!i)return S(400,"Missing equipment id");const a=r.map(s=>String(s.id)!==String(i)?s:{...s,...n,description:n?.description||n?.desc||n?.name||s.description,subcategory:n?.subcategory||n?.sub||s.subcategory,sub:n?.subcategory||n?.sub||s.sub,quantity:Z(n?.quantity??n?.qty??s.quantity,s.quantity),qty:Z(n?.quantity??n?.qty??s.qty,s.qty),unit_price:E(n?.unit_price??n?.price??s.unit_price),price:E(n?.unit_price??n?.price??s.price),barcode:n?.barcode||s.barcode,status:String(n?.status??s.status).toLowerCase(),image_url:n?.image_url??n?.image??n?.imageUrl??s.image_url,image:n?.image_url??n?.image??n?.imageUrl??s.image,updated_at:A()});m("equipment",a);const o=a.find(s=>String(s.id)===String(i));return c({data:o})}if(e==="DELETE"){if(t.get("all")==="1")return m("equipment",[]),c({data:{ok:!0}});if(!i)return S(400,"Missing equipment id");const a=r.filter(o=>String(o.id)!==String(i));return m("equipment",a),c({data:{ok:!0}})}return c({data:r})}function at(e,t={}){const n=t.id??N("technicians"),r=A();return{id:n,full_name:e.full_name||e.name||"فني جديد",name:e.full_name||e.name||"فني جديد",phone:e.phone||"",email:e.email||"",specialization:e.specialization||e.role||"",department:e.department||"",daily_wage:E(e.daily_wage??e.dailyWage??0),status:String(e.status||"available").toLowerCase(),notes:e.notes||"",active:e.active!=null?!!e.active:!0,created_at:t.created_at||r,updated_at:t.updated_at||r}}function it(e,t,n){const r=U("technicians");if(e==="GET"){const a=F(r,t);return c({data:a})}if(e==="POST"){const a=at(n||{}),o=[...r,a];return m("technicians",o),c({data:a})}const i=t.get("id");if(e==="PATCH"){if(!i)return S(400,"Missing technician id");const a=r.map(s=>String(s.id)!==String(i)?s:{...s,...n,full_name:n?.full_name||n?.name||s.full_name,name:n?.full_name||n?.name||s.name,specialization:n?.specialization||n?.role||s.specialization,status:String(n?.status??s.status).toLowerCase(),daily_wage:E(n?.daily_wage??n?.dailyWage??s.daily_wage),updated_at:A()});m("technicians",a);const o=a.find(s=>String(s.id)===String(i));return c({data:o})}if(e==="DELETE"){if(!i)return S(400,"Missing technician id");const a=r.filter(o=>String(o.id)!==String(i));return m("technicians",a),c({data:{ok:!0}})}return c({data:r})}function Se(e={}){const t=e.start_datetime||e.start||e.startDatetime||A(),n=e.end_datetime||e.end||e.endDatetime||t,r=Array.isArray(e.items)?e.items.map(a=>({...a})):[],i=Array.isArray(e.technicians)?e.technicians.map(a=>a):[];return{customer_id:e.customer_id??e.customerId??null,customer_name:e.customer_name??e.customerName??"",start_datetime:t,end_datetime:n,status:String(e.status||"pending").toLowerCase(),title:e.title||e.name||"حجز",location:e.location||"",notes:e.notes||"",project_id:e.project_id??e.projectId??null,total_amount:E(e.total_amount??e.totalAmount??0),discount:E(e.discount??0),discount_type:e.discount_type||"percent",apply_tax:!!(e.apply_tax??!1),paid_status:e.paid_status||"unpaid",confirmed:!!(e.confirmed??!1),items:r,technicians:i}}function st(e,t,n){const r=U("reservations");if(e==="GET"){const a=F(r,t);return c({data:a})}if(e==="POST"){const a=N("reservations"),o=Se(n||{}),s={id:a,reservation_code:n?.reservation_code||V(a),reservationId:n?.reservation_code||V(a),...o,technicians:o.technicians},u=[...r,s];return m("reservations",u),c({data:s})}const i=t.get("id");if(e==="PATCH"){if(!i)return S(400,"Missing reservation id");const a=r.map(s=>{if(String(s.id)!==String(i))return s;const u=Se(n||{});return{...s,...u,reservation_code:n?.reservation_code||s.reservation_code||V(s.id),reservationId:n?.reservation_code||s.reservation_code||V(s.id)}});m("reservations",a);const o=a.find(s=>String(s.id)===String(i));return c({data:o})}if(e==="DELETE"){if(!i)return S(400,"Missing reservation id");const a=r.filter(o=>String(o.id)!==String(i));return m("reservations",a),c({data:{ok:!0}})}return c({data:r})}function Ae(e={},t={}){const n=t.id??N("maintenance"),r=A();return{id:n,equipment_id:e.equipment_id??e.equipmentId??null,equipment_desc:e.equipment_desc??e.equipmentDesc??e.equipment_description??"",equipmentDesc:e.equipment_desc??e.equipmentDesc??e.equipment_description??"",equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",issue:e.issue??e.notes??"",priority:String(e.priority||"medium").toLowerCase(),status:String(e.status||"open").toLowerCase(),status_raw:e.status_raw||e.status||"open",createdAt:t.createdAt||r,reportedAt:t.reportedAt||r,scheduledAt:e.scheduled_at||e.scheduledAt||null,resolvedAt:e.resolved_at||e.resolvedAt||null,resolutionReport:e.resolution_report||e.resolutionReport||"",technicianId:e.technician_id??e.technicianId??null}}function ot(e,t,n){const r=U("maintenance");if(e==="GET"){const a=F(r,t);return c({data:a})}if(e==="POST"){const a=Ae(n||{}),o=[a,...r];return m("maintenance",o),c({data:a})}const i=t.get("id");if(e==="PATCH"){if(!i)return S(400,"Missing maintenance id");const a=r.map(s=>String(s.id)!==String(i)?s:Ae({...s,...n},{id:s.id,createdAt:s.createdAt,reportedAt:s.reportedAt}));m("maintenance",a);const o=a.find(s=>String(s.id)===String(i));return c({data:o})}if(e==="DELETE"){if(!i)return S(400,"Missing maintenance id");const a=r.filter(o=>String(o.id)!==String(i));return m("maintenance",a),c({data:{ok:!0}})}return c({data:r})}function Te(e={},t={}){const n=t.id??N("projects"),r=A();return{id:n,project_code:e.project_code||e.projectCode||`PRJ-${String(n).padStart(3,"0")}`,title:e.title||"مشروع",type:e.type||"event",client_id:e.client_id??e.clientId??null,client_company:e.client_company??e.clientCompany??"",description:e.description||"",start_datetime:e.start_datetime||e.start||e.startDatetime||r,end_datetime:e.end_datetime||e.end||e.endDatetime||null,apply_tax:!!(e.apply_tax??!1),payment_status:e.payment_status||"unpaid",equipment_estimate:E(e.equipment_estimate??0),expenses_total:E(e.expenses_total??0),tax_amount:E(e.tax_amount??0),total_with_tax:E(e.total_with_tax??0),confirmed:!!(e.confirmed??!1),technicians:Array.isArray(e.technicians)?e.technicians.map(i=>i):[],equipment:Array.isArray(e.equipment)?e.equipment.map(i=>({...i})):[],created_at:t.created_at||r,updated_at:t.updated_at||r,status:e.status||t.status||"active"}}function ct(e,t,n){const r=U("projects");if(e==="GET"){const a=F(r,t);return c({data:a})}if(e==="POST"){const a=Te(n||{}),o=[...r,a];return m("projects",o),c({data:a})}const i=t.get("id");if(e==="PATCH"){if(!i)return S(400,"Missing project id");const a=r.map(s=>String(s.id)!==String(i)?s:Te({...s,...n},{id:s.id,created_at:s.created_at,updated_at:A(),status:n?.status||s.status}));m("projects",a);const o=a.find(s=>String(s.id)===String(i));return c({data:o})}if(e==="DELETE"){if(!i)return S(400,"Missing project id");const a=r.filter(o=>String(o.id)!==String(i));return m("projects",a),c({data:{ok:!0}})}return c({data:r})}function ut(e,t,n){const r=t.get("scope"),i=t.get("user_id");if(r==="logs"){const a=d.userLogs[i]||{sessions:[],activity:[]};return c({data:Q(a)||{sessions:[],activity:[]}})}if(e==="GET")return c({data:d.users.map(a=>({...a}))});if(e==="POST"){const a=N("users"),o=n?.username||`user-${a}`,s=ue(n?.role||"viewer"),u={id:a,username:o,role:s,is_current_user:!1,created_at:A()};return d.users=[...d.users,u],c({data:u})}if(e==="PATCH"){if(!i)return S(400,"Missing user id");d.users=d.users.map(o=>String(o.id)!==String(i)?o:{...o,username:n?.username??o.username,role:ue(n?.role??o.role),updated_at:A()});const a=d.users.find(o=>String(o.id)===String(i));return c({data:{...a}})}return e==="DELETE"?i?(d.users=d.users.filter(a=>String(a.id)!==String(i)),c({data:{ok:!0}})):S(400,"Missing user id"):c({data:d.users.map(a=>({...a}))})}function lt(){const e=Ze();return c({data:e})}const dt={"/auth/":et,"/preferences/":tt,"/customers/":nt,"/equipment/":rt,"/technicians/":it,"/reservations/":st,"/maintenance/":ot,"/projects/":ct,"/users/":ut,"/summary/":lt};async function ft(e,{method:t="GET",body:n}={}){if(!G())return null;const{pathname:r,searchParams:i}=Xe(e),a=dt[r];return a?a(t.toUpperCase(),i,n):(console.warn(`⚠️ Preview API handler missing for ${t} ${r}`),c({data:null}))}const mt="/backend/api";class q extends Error{constructor(t,{status:n,payload:r}={}){super(t),this.name="ApiError",this.status=n??null,this.payload=r??null}}function pt(){const t=(typeof window<"u"?window.APP_API_BASE:null)||mt;return String(t).replace(/\/$/,"")}async function $(e,{method:t="GET",headers:n={},body:r,signal:i,credentials:a="include"}={}){const o=e.startsWith("/")?e:`/${e}`,s=`${pt()}${o}`,u=await ft(o,{method:t,body:r});if(u){if(!u.ok)throw new q(u.message||`Preview request failed for ${o}`,{status:u.status??500,payload:u.payload??null});return u.payload}const l={Accept:"application/json",...n},f={method:t,headers:l,signal:i,credentials:a};r!==void 0&&(r instanceof FormData?(delete l["Content-Type"],f.body=r):typeof r=="string"?(l["Content-Type"]=l["Content-Type"]||"application/json",f.body=r):(l["Content-Type"]=l["Content-Type"]||"application/json",f.body=JSON.stringify(r)));const p=await fetch(s,f),y=p.headers.get("content-type")||"";let h=null;if(y.includes("application/json"))try{h=await p.json()}catch{throw new q("Failed to parse server response as JSON",{status:p.status})}else{const v=await p.text();h=v?{raw:v}:null}if(!p.ok){const v=h?.error||`Request failed with status ${p.status}`;throw new q(v,{status:p.status,payload:h})}if(h&&typeof h=="object"&&h.ok===!1){const v=h.error||"API returned an error response";throw new q(v,{status:p.status,payload:h})}return h}const P=Object.freeze({language:"ar",theme:"light",dashboardTab:null,dashboardSubTab:null,projectsTab:null,projectsSubTab:null});let L=null,J=null;const le=new Set,Ne="__ART_RATIO_SKIP_PREF_FETCH__",be="__ART_RATIO_PREFERENCES__";function Oe(){try{return typeof window>"u"?!1:!!window[Ne]}catch{return!1}}function Ee(){try{typeof window<"u"&&delete window[Ne]}catch{}}function M(e={}){const t=e.language==="en"?"en":"ar",n=e.theme==="dark"?"dark":"light",r=typeof e.dashboardTab=="string"?W(e.dashboardTab):null,i=typeof e.dashboardSubTab=="string"?W(e.dashboardSubTab):null,a=typeof e.projectsTab=="string"?W(e.projectsTab):null,o=typeof e.projectsSubTab=="string"?W(e.projectsSubTab):null;return{language:t,theme:n,dashboardTab:r,dashboardSubTab:i,projectsTab:a,projectsSubTab:o}}function W(e){const t=String(e||"").trim();return t&&/^[a-z0-9\-]+$/i.test(t)?t:null}function gt(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(be);if(!e)return null;const t=JSON.parse(e);return M(t)}catch(e){return console.warn("⚠️ [preferencesService] Failed to read cached preferences",e),null}}function ht(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.setItem(be,JSON.stringify(e))}catch(t){console.warn("⚠️ [preferencesService] Failed to persist preferences",t)}}const we=gt();we&&(L=we);function _t(){const e=T();le.forEach(t=>{try{t(e)}catch(n){console.error("⚠️ [preferencesService] listener failed",n)}})}function O(e){const n={...L?{...L}:{...P},...e};L=M(n),ht(L),_t()}function T(){return L?{...L}:null}function Ie(e){if(typeof e!="function")return()=>{};if(le.add(e),L)try{e(T())}catch(t){console.error("⚠️ [preferencesService] listener failed",t)}return()=>{le.delete(e)}}function Me({refresh:e=!1}={}){return Oe()?Promise.resolve({...P}):!e&&L?Promise.resolve(T()):(J||(J=$("/preferences/").then(t=>{const n=t?.data??P;return O(n),T()}).catch(t=>t instanceof q&&t.status===401?(L=null,P):(console.warn("⚠️ [preferencesService] Failed to load preferences",t),O(P),P)).finally(()=>{J=null})),J)}function St(e=null){if(!e){const t=T();return M(t||P)}return M(e)}async function pe(e={}){if(Oe())return{...P,...e};e.language!==void 0&&e.language,e.theme!==void 0&&e.theme,e.dashboardTab!==void 0&&e.dashboardTab,e.dashboardSubTab!==void 0&&e.dashboardSubTab,e.projectsTab!==void 0&&e.projectsTab,e.projectsSubTab!==void 0&&e.projectsSubTab;const t=St(),n={...t,...e},r=M(n),i={},a={};["language","theme","dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"].forEach(l=>{if(e[l]===void 0)return;const f=r[l],p=t[l];f!==p&&(i[l]=f,(l==="language"||l==="theme")&&(a[l]=f))});const s=Object.keys(i).length>0,u=Object.keys(a).length>0;if(!u&&!s)return T();if(!u&&s)return O(r),T();try{const l=await $("/preferences/",{method:"PATCH",body:a});return O(l?.data??P),s&&O({...T(),...i}),T()}catch(l){if(l instanceof q&&l.status===422)return console.warn("⚠️ [preferencesService] Server rejected preference update (no changes)."),O(r),T();throw l}}const x="ar",At="ar",Tt="language-loading",Le="language-ready",ke=["Placeholder","Title","AriaLabel","AriaDescription","Value"],z={ar:Object.create(null),en:Object.create(null)};let R=x,te=!1,se=null;function B(e){return e==="en"?"en":"ar"}function Ue(){if(!se){const e=T();if(e?.language){const t=B(e.language);H(t,{persist:!1,dispatch:!1})}se=Me().then(t=>{const n=B(t?.language??x);return H(n,{persist:!1}),te=!0,n}).catch(t=>(console.warn("⚠️ تعذر تحميل تفضيل اللغة من الخادم",t),H(x,{persist:!1}),te=!0,x))}return se}function Et(e){if(e.dataset.i18nCached==="true")return;e.dataset.i18nHtml==="true"?e.dataset.arHtml===void 0&&(e.dataset.arHtml=e.innerHTML):e.dataset.ar===void 0&&(e.dataset.ar=e.textContent),ke.forEach(n=>{const r=n.charAt(0).toLowerCase()+n.slice(1),i=e.getAttribute(r);i!=null&&e.dataset[`ar${n}`]===void 0&&(e.dataset[`ar${n}`]=i)}),e.dataset.i18nCached="true"}function ve(e,t){if(!t)return;const n=z[e]??(z[e]=Object.create(null));Object.entries(t).forEach(([r,i])=>{typeof r=="string"&&(n[r]=i)})}function Pe(e,t){if(!t)return;const n=z[e];return n?n[t]:void 0}function wt(e,t){Et(e);const n=e.dataset.i18nHtml==="true",r=e.dataset.i18nKey,i=Pe(t,r);i!==void 0?n?e.innerHTML=i:e.textContent=i:t==="en"?n?e.dataset.enHtml!==void 0&&(e.innerHTML=e.dataset.enHtml):e.dataset.en!==void 0&&(e.textContent=e.dataset.en):n?e.innerHTML=e.dataset.arHtml??e.innerHTML:e.textContent=e.dataset.ar??e.textContent,ke.forEach(a=>{const o=a.charAt(0).toLowerCase()+a.slice(1),s=e.dataset[`i18n${a}Key`],u=Pe(t,s);if(u!==void 0){e.setAttribute(o,u);return}const l=t==="en"?`en${a}`:`ar${a}`,f=e.dataset[l];f!==void 0&&e.setAttribute(o,f)})}function Fe(e){document.querySelectorAll("[data-i18n]").forEach(n=>wt(n,e))}function Lt(e){const t=document.documentElement,n=document.body,r=e===At?"rtl":"ltr";t.setAttribute("lang",e),t.setAttribute("dir",r),n&&(n.setAttribute("dir",r),n.dataset.lang=e)}function vt(){const e=document.documentElement;e&&(e.classList.contains(Le)||(e.classList.remove(Tt),e.classList.add(Le)))}function He(e){document.querySelectorAll(".language-toggle-btn").forEach(t=>{const n=t.dataset.labelAr||"🇸🇦 العربية",r=t.dataset.labelEn||"🇬🇧 English";t.textContent=e==="en"?n:r,t.setAttribute("aria-pressed",e==="en"?"true":"false")})}function H(e,{persist:t=!1,dispatch:n=!0}={}){const r=B(e);R===r&&te&&!t||(R=r,te=!0,Lt(r),Fe(r),He(r),vt(),n&&document.dispatchEvent(new CustomEvent("language:changed",{detail:{language:r}})),t&&pe({language:r}).catch(i=>{console.warn("⚠️ تعذر حفظ تفضيل اللغة في الخادم",i)}))}function Pt(){Be(R==="ar"?"en":"ar")}function ze(){document.querySelectorAll(".language-toggle-btn").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Pt()}),t.dataset.listenerAttached="true")}),He(R)}function qt(e={}){ve("ar",e.ar),ve("en",e.en);const t=ne();Fe(t),document.dispatchEvent(new CustomEvent("language:translationsReady",{detail:{language:t}}))}function C(e,t=""){if(!e)return t;const n=R||x,r=z[n];if(r&&r[e]!==void 0)return r[e];const a=z[n==="en"?"ar":"en"];return a&&a[e]!==void 0?a[e]:t}function Be(e){const t=B(e);H(t,{persist:!0})}function Ct(){Ue().catch(()=>x).finally(()=>{ze()})}function ne(){return R}function jt(){return R==="ar"}function qe(){Ue().catch(()=>x),ze()}Ie(e=>{e&&e.language&&B(e.language)!==R&&H(e.language,{persist:!1})});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",qe,{once:!0}):qe();const Qt=Object.freeze(Object.defineProperty({__proto__:null,getCurrentLanguage:ne,initLanguageToggle:Ct,isArabic:jt,registerTranslations:qt,setLanguage:Be,t:C},Symbol.toStringTag,{value:"Module"}));function re(e,t=3e3){let n=document.getElementById("toast-container");n||(n=document.createElement("div"),n.id="toast-container",n.style.position="fixed",n.style.top="20px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.zIndex="9999",document.body.appendChild(n));const r=document.createElement("div");r.className="toast-message",r.textContent=e,r.style.background="#333",r.style.color="#fff",r.style.padding="10px 20px",r.style.marginTop="10px",r.style.borderRadius="6px",r.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",r.style.opacity="0",r.style.transition="opacity 0.3s ease",n.appendChild(r),setTimeout(()=>r.style.opacity="1",10),setTimeout(()=>{r.style.opacity="0",setTimeout(()=>r.remove(),300)},t)}const Ce="RSV",je="PRJ",Rt=4,k=(()=>{try{const e=typeof globalThis<"u"?globalThis:window;return e.__APP_SEQUENCE_STATE__=e.__APP_SEQUENCE_STATE__||{reservation:0,project:0},e.__APP_SEQUENCE_STATE__}catch{return{reservation:0,project:0}}})();function yt(){return Number.isFinite(k.reservation)?k.reservation:0}function Dt(e){k.reservation=Math.max(0,Number.parseInt(e,10)||0)}function xt(){return Number.isFinite(k.project)?k.project:0}function Nt(e){k.project=Math.max(0,Number.parseInt(e,10)||0)}function Ge(){try{const e=fe();return{reservations:Array.isArray(e?.reservations)?e.reservations:[],projects:Array.isArray(e?.projects)?e.projects:[]}}catch(e){return console.warn("⚠️ [utils] Failed to load data snapshot for code generation",e),{reservations:[],projects:[]}}}function bt(e,t){if(e==null)return 0;if(typeof e=="number")return Number.isFinite(e)?Math.max(0,Math.trunc(e)):0;const n=String(e).trim();if(!n)return 0;const r=`${t.toUpperCase()}-`,i=n.toUpperCase();let a=n;i.startsWith(r)&&(a=n.slice(r.length));const o=a.match(/(\d+)$/);if(o){const u=Number.parseInt(o[1],10);return Number.isFinite(u)?Math.max(0,u):0}const s=Number.parseInt(n,10);return Number.isFinite(s)?Math.max(0,s):0}function Ot(e){return Array.isArray(e)?e:[e]}function $e(e,t,n){return!Array.isArray(e)||e.length===0?0:e.reduce((r,i)=>{const a=n(i),s=Ot(a).reduce((u,l)=>{const f=bt(l,t);return f>u?f:u},0);return s>r?s:r},0)}function Ke(e,t){const n=Math.max(0,Number.parseInt(t,10)||0);return`${e}-${String(n).padStart(Rt,"0")}`}function Zt(){const{reservations:e}=Ge(),t=$e(e,Ce,r=>[r?.reservationCode,r?.reservation_code,r?.reservationId,r?.reservation_id,r?.id]),n=Math.max(t,yt())+1;return Dt(n),Ke(Ce,n)}function en(){const{projects:e}=Ge(),t=$e(e,je,r=>[r?.projectCode,r?.project_code,r?.code,r?.id]),n=Math.max(t,xt())+1;return Nt(n),Ke(je,n)}function tn(e,t={}){if(!e)return"-";const n=new Date(e);if(Number.isNaN(n.getTime()))return"-";const r=document?.documentElement?.getAttribute("lang")||(typeof ne=="function"?ne():null)||"ar",a=String(r).toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory":"en-US",s=new Intl.DateTimeFormat(a,{dateStyle:"short",timeStyle:"short",hour12:!0,calendar:"gregory",...t}).formatToParts(n),u=n.getHours()>=12?"PM":"AM",l=s.map(f=>f.type==="dayPeriod"?u:f.value).join("").replace(/\u200f/g,"");return It(l)}function It(e){if(e==null)return"";e=String(e);const t=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"],n=["0","1","2","3","4","5","6","7","8","9"];return e.split("").map(r=>{const i=t.indexOf(r);return i>-1?n[i]:r}).join("")}const I="dark-mode",Y=new WeakSet,Re="theme-loading",Ve="art-ratio:session-theme";let ye=!1;function Je(){return Array.from(document.querySelectorAll("[data-theme-toggle], .theme-toggle-btn"))}function We(e){return e==="dark"?"dark":"light"}function Mt(e){try{window.sessionStorage?.setItem(Ve,We(e))}catch{}}function kt(){try{const e=window.sessionStorage?.getItem(Ve);return e==="dark"?"dark":e==="light"?"light":null}catch{return null}}function Ut(){document.documentElement.classList.remove(Re);const e=document.body;e&&e.classList.remove(Re)}function ae(e,{persist:t=!0}={}){const n=We(e),r=document.documentElement,i=document.body;n==="dark"?(r.classList.add(I,"dark"),i&&i.classList.add(I,"dark")):(r.classList.remove(I,"dark"),i&&i.classList.remove(I,"dark")),r.setAttribute("data-theme",n==="dark"?"dark":"light"),Mt(n),ge(n);try{document.dispatchEvent(new CustomEvent("theme:changed",{detail:{theme:n}}))}catch(a){console.warn("⚠️ [theme.js] Failed to dispatch theme change event",a)}t&&pe({theme:n}).catch(a=>{console.warn("⚠️ تعذر حفظ تفضيل السمة في الخادم",a)})}function K(){const e=document.body;return e&&e.classList.contains(I)||document.documentElement.classList.contains(I)?"dark":"light"}function oe(){const e=K()==="dark"?"light":"dark";ae(e,{persist:!0})}function Ft(e,t){if(!e)return;const n=t==="dark",r=C("theme.toggle.toLight","☀️ الوضع العادي"),i=C("theme.toggle.toDark","🌙 الوضع الليلي"),a=C("theme.toggle.ariaLight","الوضع العادي مفعل"),o=C("theme.toggle.ariaDark","الوضع الليلي مفعل"),s=C("theme.toggle.titleLight","التبديل إلى الوضع العادي"),u=C("theme.toggle.titleDark","التبديل إلى الوضع الليلي");if(e.matches("[data-theme-toggle]")){const l=e.matches("input")?e:e.querySelector('input[type="checkbox"]'),f=n?r:i,p=n?a:o,y=n?s:u;l&&(l.checked=n,l.setAttribute("aria-label",f),l.setAttribute("aria-checked",String(n))),e.setAttribute("title",y),e.setAttribute("aria-label",p),e.setAttribute("data-theme-state",n?"dark":"light");const h=e.querySelector("[data-theme-label]");h&&(h.textContent=f)}else e.textContent=n?r:i,e.setAttribute("aria-pressed",String(n)),e.setAttribute("title",n?s:u),e.setAttribute("aria-label",n?a:o)}function ge(e){Je().forEach(t=>Ft(t,e)),Ut()}function Ht(){const e=Je();ge(K()),e.forEach(t=>{if(!(!t||Y.has(t))){if(t.matches("[data-theme-toggle]")){const n=t.matches("input")?t:t.querySelector('input[type="checkbox"]'),r=()=>{oe()};n&&!Y.has(n)?(n.addEventListener("change",r),Y.add(n)):n||t.addEventListener("click",i=>{i.preventDefault(),oe()})}else t.getAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",n=>{n.preventDefault(),oe()});Y.add(t)}})}function nn({skipRemote:e=!1}={}){const t=T(),i=(t?.theme==="dark"?"dark":t?.theme==="light"?"light":null)||kt()||zt();ae(i,{persist:!1}),Bt({skipRemote:e})}function zt(){try{if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return"dark"}catch{}return"light"}function Bt({skipRemote:e=!1}={}){ye||(ye=!0,!e&&Me().then(t=>{const n=t?.theme==="dark"?"dark":t?.theme==="light"?"light":null;n&&ae(n,{persist:!1})}).catch(t=>{console.warn("⚠️ تعذر تحميل تفضيل السمة من الخادم",t)}))}document.addEventListener("language:changed",()=>{ge(K()),Ht()});Ie(e=>{const t=e?.theme==="dark"?"dark":e?.theme==="light"?"light":null;t&&t!==K()&&ae(t,{persist:!1})});const Gt="❌ بيانات الدخول غير صحيحة";let w=null;const $t={USER_UPDATED:"auth:user-updated"};function Kt(e){if(typeof document>"u")return;const t=document.documentElement;t&&(e?t.dataset.userRole=e:delete t.dataset.userRole)}function Vt(){typeof document>"u"||document.dispatchEvent(new CustomEvent($t.USER_UPDATED,{detail:w?{...w}:null}))}function j(e){if(e&&typeof e=="object"){const t=typeof e.role=="string"?e.role.trim().toLowerCase():null;w={id:Number.isFinite(e.id)?Number(e.id):null,username:String(e.username||""),loginAt:e.loginAt??null,role:t}}else w=null;return Kt(w?.role||""),Vt(),w}function ce(e=Gt){re(e);const t=document.getElementById("login-error");t&&(t.innerText=e)}async function rn(e,t){const n=(e||"").trim(),r=t||"";if(!n||!r){ce();return}if(G()){const i=new Date().toISOString();Ye({id:1,username:n||"preview-admin",role:"admin",loginAt:i}),Ee(),window.location.href="home.html";return}try{const i=await $("/auth/",{method:"POST",body:{username:n,password:r}});j(i?.data??null);try{await pe({theme:K()})}catch(a){console.warn("⚠️ تعذر حفظ تفضيل السمة بعد تسجيل الدخول",a)}Ee(),window.location.href="home.html"}catch(i){console.error("❌ فشل تسجيل الدخول",i),j(null),i instanceof q&&i.message?ce(i.message):ce()}}async function an(){if(G()){Ye(null),re("🚪 تم تسجيل الخروج"),window.location.href="login.html";return}try{await $("/auth/",{method:"DELETE"})}catch(e){console.warn("⚠️ فشل تسجيل الخروج من الخادم",e)}finally{j(null),re("🚪 تم تسجيل الخروج"),window.location.href="login.html"}}async function Jt({refresh:e=!1}={}){if(!e&&w)return w;if(G()){const t=me();return j(t??null),w}try{const t=await $("/auth/");return j(t?.data??null),w}catch(t){throw t instanceof q&&t.status===401&&j(null),t}}function sn({redirect:e=!0}={}){if(G()){const t=me();return j(t??null),!t&&e&&(window.location.href="login.html"),Promise.resolve(w)}return Jt({refresh:!0}).then(t=>(!t&&e&&(window.location.href="login.html"),t)).catch(t=>t instanceof q&&t.status===401?(e&&(window.location.href="login.html"),null):(console.error("❌ خطأ أثناء التحقق من الجلسة",t),e&&(window.location.href="login.html"),null))}function Wt(){return w?.role||null}function on(){return Wt()==="admin"}function cn(){re(C("auth.permissions.denied","⚠️ ليس لديك صلاحية لتنفيذ هذا الإجراء"),"error")}function Ye(e){const t=j(e);ee(t??null)}export{q as A,en as B,Zt as C,Jt as D,rn as E,Qt as F,$ as a,$t as b,re as c,cn as d,pe as e,tn as f,ne as g,T as h,Me as i,Ie as j,nn as k,fe as l,sn as m,It as n,Ht as o,an as p,Xt as q,Ye as r,De as s,C as t,on as u,G as v,xe as w,me as x,qt as y,Yt as z};
