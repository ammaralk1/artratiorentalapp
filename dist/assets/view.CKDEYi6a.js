import{n as S,p as wt,t as d,v as ie}from"./auth.BLFzWQsL.js";import{a as oe,h as ce,F as Pt,c as xt,e as At,d as le}from"./reservationsService.EFzUE5dL.js";const f={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],servicesClientPriceTotal:0,filters:{search:"",status:"",payment:"",type:"",confirmed:"",range:"",startDate:"",endDate:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null,pendingLinkedToast:!1},_={};function Pe(){f.selectedTechnicians=[],f.selectedEquipment=[],f.expenses=[],f.servicesClientPriceTotal=0}function p(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function k(t){const e=Number(t)||0,a=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${S(r)} SR`}function M(t){if(!t)return"â€”";const e=new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getFullYear()),s=String(e.getMinutes()).padStart(2,"0"),o=e.getHours(),c=o>=12?"PM":"AM",l=o%12||12,b=String(l).padStart(2,"0"),u=`${n}/${a}/${r} ${b}:${s} ${c}`;return S(u)}function de(t){const e=wt(),n=S(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} Ù…Ø´Ø±ÙˆØ¹`}function St(t){_.tableCount&&(_.tableCount.dataset.count=String(t),_.tableCount.textContent=de(t))}function xe(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?d(e,n):n}const Ae="project",De="editProject",Z=3600*1e3,tt=.15,Y=6,Fe="projectsTab",Ee="projectsSubTab",Me={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab",templates:"projects-templates-tab"},ue={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed",cancelled:"Cancelled",conflict:"Conflict"};function Dt(t){if(!t)return"";if(t instanceof Date)return t.toISOString();let e=String(t).trim();return e?(e.includes(" ")&&!e.includes("T")&&(e=e.replace(" ","T")),e):""}function A(t){if(!t?.start)return Number.NaN;const e=Dt(t.start),n=new Date(e).getTime();return Number.isFinite(n)?n:Number.NaN}function E(t){if(t?.createdAt){const n=Dt(t.createdAt),a=new Date(n).getTime();if(Number.isFinite(a))return a}const e=A(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function ke(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),s=a.padStart(2,"0"),o=r.padStart(2,"0");return`${t}T${s}:${o}`}function Ft(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}â€¦`}function Ie(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function nt(t){if(!t)return d("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return d(e,t)}function Q(t){return S(String(t||"")).toLowerCase().trim()}function me(){const t=f.filters||{};return!!((t.search||"").trim()||t.status||t.payment||t.type||t.confirmed||t.startDate||t.endDate)}function $t(t,e=!1){if(!t)return null;const n=new Date(`${t}T${e?"23:59:59":"00:00:00"}`);return Number.isNaN(n.getTime())?null:n}function pe(t){try{const e=pt(t.id),n=U(t)||{},a=Number(n.subtotal||0),r=(e||[]).reduce((b,u)=>b+(Number(u?.totalAmount)||et(u)||0),0),s=n.applyTax?Number(((a+r)*tt).toFixed(2)):0,o=Number((a+r+s).toFixed(2)),c=t.paymentHistory||t.payments||[],l=xt({totalAmount:o,paidAmount:c.length?0:t.paidAmount,paidPercent:c.length?0:t.paidPercent,history:c});return At({manualStatus:null,paidAmount:l.paidAmount,paidPercent:l.paidPercent,totalAmount:o})}catch{return null}}function fe(t){const e=f.customers.find(i=>String(i.id)===String(t.clientId)),n=Q(f.filters.search),a=Q([t.title,t.description,e?.customerName,t.clientCompany,nt(t.type),t.id,t.projectCode].filter(Boolean).join(" "));if(n&&!a.includes(n))return!1;const r=Q(f.filters.type);if(r&&Q(t.type)!==r)return!1;const s=mt(t),o=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":s;if(f.filters.status&&f.filters.status!==o)return!1;const c=t.confirmed===!0||t.confirmed==="true";if(f.filters.confirmed==="yes"&&!c||f.filters.confirmed==="no"&&c||f.filters.confirmed==="closed"&&o!=="completed")return!1;const l=pe(t);if(f.filters.payment&&(!l||f.filters.payment!==l))return!1;const b=$t(f.filters.startDate),u=$t(f.filters.endDate,!0);if(b||u){const i=t.start?new Date(t.start):null;if(!i||Number.isNaN(i.getTime())||b&&i<b||u&&i>u)return!1}return!0}function Et(){return(Array.isArray(f.projects)?f.projects:[]).filter(e=>fe(e))}function Re(){if(!_.projectsTableBody)return;const t=Et();if(!t.length){const n=f.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",a=f.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",r=p(d(n,a));_.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="6" class="text-center text-muted">${r}</td></tr>`,St(0),f.visibleProjects=[],Nt([]),jt();return}const e=[...t].sort((n,a)=>{const r=E(n),s=E(a);if(Number.isFinite(r)&&Number.isFinite(s)&&r!==s)return s-r;const o=A(n),c=A(a);return Number.isFinite(o)&&Number.isFinite(c)?c-o:0});f.visibleProjects=e,St(e.length),_.projectsTableBody.innerHTML=e.map(n=>ge(n)).join(""),Nt(e),jt()}function ge(t){const n=f.customers.find(m=>String(m.id)===String(t.clientId))?.customerName||d("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),a=["commercial","coverage","photography","social"].includes(t.type)?t.type:"default",{expensesTotal:r,totalWithTax:s}=U(t),o=p(nt(t.type)),c=`<span class="project-type-chip project-type-chip--${a}">${o}</span>`,l=t.projectCode||`PRJ-${S(String(t.id))}`,b=`<span class="project-code-badge">#${p(l)}</span>`,i=ie()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${p(d("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${p(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${b}
            ${c}
          </div>
        </div>
      </td>
      <td>
        ${p(n)}
      </td>
      <td>${be(t.start,t.end)}</td>
      <td>${k(s)}</td>
      <td>${k(r)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${p(d("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${i}
      </td>
    </tr>
  `}function be(t,e){if(!t)return"â€”";const n=M(t),a=e?M(e):"",r=l=>{const b=String(l).split(" ").filter(Boolean),u=b.shift()||"",i=b.join(" ");return{date:u,time:i}},s=r(n),o=a?r(a):{date:"",time:""};if(o.date&&s.date===o.date){const l=s.time&&o.time?`Ù…Ù† ${s.time} Ø¥Ù„Ù‰ ${o.time}`:"";return`
      <div class="date-range">
        <div class="date-line">${s.date}</div>
        ${l?`<div class="time-line">${l}</div>`:""}
      </div>
    `}const c=s.time&&o.time?`Ù…Ù† ${s.time} Ø¥Ù„Ù‰ ${o.time}`:"";return`
    <div class="date-range">
      <div class="date-line">${s.date}</div>
      ${o.date?`<div class="date-line">${o.date}</div>`:""}
      ${c?`<div class="time-line">${c}</div>`:""}
    </div>
  `}function ye(t,e){if(!t)return{dateHtml:"â€”",timeText:""};const n=M(t),a=e?M(e):"",r=b=>{const u=String(b).split(" ").filter(Boolean),i=u.shift()||"",m=u.join(" ");return{date:i,time:m}},s=r(n),o=a?r(a):{date:"",time:""};let c="",l="";return o.date&&s.date===o.date?(c=`<div class="date-range"><div class="date-line">${s.date}</div></div>`,l=`Ù…Ù† ${s.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${o.time||"â€”:â€”"}`):(c=`<div class="date-range"><div class="date-line">${s.date}</div>`+(o.date?`<div class="date-line">${o.date}</div>`:"")+"</div>",l=`Ù…Ù† ${s.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${o.time||"â€”:â€”"}`),{dateHtml:c,timeText:l}}function Nt(t){if(!_.timeline)return;const n=(Array.isArray(t)?t:f.visibleProjects.length?f.visibleProjects:f.projects).map(i=>{if(!i?.start)return null;const m=new Date(i.start);if(Number.isNaN(m.getTime()))return null;let h=i.end?new Date(i.end):new Date(m);return Number.isNaN(h.getTime())&&(h=new Date(m)),h<=m&&(h=new Date(m.getTime()+Z)),{project:i,startDate:m,endDate:h}}).filter(Boolean).sort((i,m)=>i.startDate-m.startDate);if(!n.length){const i=p(d("projects.timeline.empty",_.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));_.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${i}</div>`;return}const a=n[0].startDate.getTime(),r=Math.max(...n.map(i=>i.endDate.getTime()));let s=r-a;s<=0&&(s=Z);const o=he(n),c=d("projects.timeline.range","{start} â†’ {end}"),l=d("projects.timeline.conflict","Scheduling conflict"),b=n.map(i=>{const{project:m,startDate:h,endDate:$}=i,N=$.getTime()-h.getTime();let T=(h.getTime()-a)/s*100;T=Math.max(0,Math.min(T,100));let P=N/s*100;P=Math.max(P,2.5),T+P>100&&(P=Math.max(1.5,100-T));const x=`project-timeline__item--${mt(m)}`,B=o.has(m.id),q=(m.title||"").trim()||d("projects.fallback.untitled","Untitled project"),z=Ft(q,26),R=f.customers.find(j=>String(j.id)===String(m.clientId)),D=R?.customerName||d("projects.fallback.unknownClient","Unknown client"),H=(m.clientCompany||R?.companyName||"").trim(),st=nt(m.type),V=M(h.toISOString()),G=M($.toISOString()),at=c.replace("{start}",V).replace("{end}",G),rt=H?`${D} (${H})`:D,F=`${q} â€¢ ${st} â€¢ ${rt} | ${at}`,ft=B?`<span class="project-timeline__item-conflict" title="${p(l)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${x}${B?" project-timeline__item--conflict":""}" style="left:${T}%;width:${P}%;" title="${p(F)}">
          <span class="project-timeline__item-label">${p(z)}</span>
          ${ft}
        </div>
      `}).join(""),u=`
    <div class="project-timeline__scale">
      <span>${p(M(new Date(a).toISOString()))}</span>
      <span>${p(M(new Date(r).toISOString()))}</span>
    </div>
  `;_.timeline.innerHTML=`
    ${u}
    <div class="project-timeline__track">
      ${b}
    </div>
  `}function he(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const r=t[n],s=t[a];r.startDate<s.endDate&&s.startDate<r.endDate&&(e.add(r.project.id),e.add(s.project.id))}return e}function jt(){if(!_.focusCards)return;const t=f.visibleProjects.length?f.visibleProjects:Et(),e=_e(t,{allowFallback:!me()});if(!e.length){const n=p(d("projects.focus.empty",_.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));_.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${n}</div></div>`;return}_.focusCards.innerHTML=e.join("")}function _e(t=[],e={}){const n=e.allowFallback!==!1,a=Array.isArray(t)?t:[],r=a.length?a:n?f.projects:[];if(!Array.isArray(r)||!r.length)return[];const s=r.filter(Ct),o=r.filter(u=>!Ct(u)&&ve(u)),c=[],l=new Set,b=(u,i)=>{!u||l.has(u.id)||c.length>=Y||(l.add(u.id),c.push(Te(u,i)))};if(s.sort((u,i)=>A(u)-A(i)).forEach(u=>b(u,"today")),o.sort((u,i)=>A(u)-A(i)).forEach(u=>b(u,"thisWeek")),c.length<Y){const u=Date.now();[...r].filter(m=>!l.has(m.id)).filter(m=>{const h=A(m);return Number.isFinite(h)&&h>=u}).sort((m,h)=>A(m)-A(h)).forEach(m=>b(m,"upcoming"))}return c.length<Y&&[...r].filter(i=>!l.has(i.id)).filter(i=>!Number.isFinite(A(i))).sort((i,m)=>E(m)-E(i)).forEach(i=>b(i,"recent")),c.length===0&&[...r].sort((i,m)=>E(m)-E(i)).slice(0,Y).forEach(i=>b(i,"recent")),c.length<Y&&[...r].filter(i=>!l.has(i.id)).sort((i,m)=>E(m)-E(i)).forEach(i=>b(i,"recent")),c}function Te(t,e){const n=f.customers.find(y=>String(y.id)===String(t.clientId)),a=n?.customerName||d("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");(t.clientCompany||n?.companyName||"").trim();const r=Array.isArray(t.technicians)?t.technicians.length:0,s=pt(t.id),o=s.length;Mt(t);const c=Number(t?.servicesClientPrice??0),{applyTax:l}=U(t),b=(t.description||"").trim(),u=b?Ft(b,110):d("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),i=nt(t.type),m=U(t)||{},h=Number(m.subtotal||0),$=(s||[]).reduce((y,g)=>y+(Number(g?.totalAmount)||et(g)||0),0),N=m.applyTax?Number(((h+$)*tt).toFixed(2)):0,T=Number((h+$+N).toFixed(2)),P=t.paymentHistory||t.payments||[],I=xt({totalAmount:T,paidAmount:P.length?0:t.paidAmount,paidPercent:P.length?0:t.paidPercent,history:P}),x=At({manualStatus:null,paidAmount:I.paidAmount,paidPercent:I.paidPercent,totalAmount:T}),B=d(`projects.paymentStatus.${x}`,x==="paid"?"Paid":x==="partial"?"Partially Paid":"Unpaid"),q=x==="paid"?"status-paid":x==="partial"?"status-partial":"status-unpaid",z=x==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",R=t.confirmed===!0||t.confirmed==="true",D=p(String(t.id)),H=t.projectCode||`PRJ-${S(String(t.id))}`,st=S(H);try{const g=(new URL(window.location.href).searchParams.get("paymentDebug")||"").toLowerCase();(g==="1"||g==="true"||g==="yes")&&console.debug("[PaymentDebug][card]",{projectId:t?.id,projectTaxableBase:h,combinedReservationsTotal:$,combinedTax:N,combinedTotalWithTax:T,paidAmount:I.paidAmount,paidPercent:I.paidPercent,paymentStatus:x})}catch{}const V={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},G={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},at=V[e]||V.recent;d(at,G[e]||G.recent);const rt=mt(t),F=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":rt;d(`projects.status.${F}`,ue[F]||F);const j=(()=>{try{const y=t.start?new Date(t.start):null,g=t.end?new Date(t.end):y?new Date(y.getTime()+Z):null;return!y||!g||Number.isNaN(y.getTime())||Number.isNaN(g.getTime())?!1:f.projects.some(v=>{if(!v||String(v.id)===String(t.id))return!1;const C=v.start?new Date(v.start):null,w=v.end?new Date(v.end):C?new Date(C.getTime()+Z):null;if(!C||!w||Number.isNaN(C.getTime())||Number.isNaN(w.getTime()))return!1;const W=Math.max(y.getTime(),C.getTime()),lt=Math.min(g.getTime(),w.getTime());return W<lt})}catch{return!1}})()&&(F==="upcoming"||F==="ongoing")?"conflict":F,kt=j==="upcoming"?"timeline-status-badge timeline-status-badge--upcoming":j==="ongoing"?"timeline-status-badge timeline-status-badge--ongoing":j==="completed"?"timeline-status-badge timeline-status-badge--completed":j==="cancelled"?"timeline-status-badge timeline-status-badge--cancelled":"timeline-status-badge timeline-status-badge--conflict",It=(t.title||"").trim()||d("projects.fallback.untitled","Untitled project"),it=j==="cancelled"?[]:[z];j==="cancelled"?it.push("project-focus-card--cancelled"):R&&it.push("project-focus-card--confirmed");const J=s.reduce((y,g)=>{const v=Array.isArray(g.items)?g.items:[],C=Array.isArray(g.crewAssignments)?g.crewAssignments:[],w=C.length?C:Array.isArray(g.technicians)?g.technicians:[],W=le({items:v,technicianIds:Array.isArray(w)&&!w.length?w:[],crewAssignments:Array.isArray(w)&&w.length&&typeof w[0]=="object"?w:[],discount:g.discount??0,discountType:g.discountType||"percent",applyTax:!1,start:g.start,end:g.end,companySharePercent:null}),lt=et(g),ne=(()=>{try{const{groups:Tt}=Pt(g);return(Tt||[]).reduce((dt,L)=>{if(String(L?.type||"").toLowerCase()==="package"){const ae=Array.isArray(L?.packageItems)?L.packageItems:[],re=new Set(ae.map(ut=>(ut?.normalizedBarcode||ut?.barcode||ut?.equipmentId||"").toString()));return dt+re.size}const vt=Number.isFinite(Number(L?.count))?Number(L.count):Number.isFinite(Number(L?.quantity))?Number(L.quantity):1;return dt+(vt>0?vt:1)},0)}catch{return(Array.isArray(g?.items)?g.items:[]).length||0}})(),se=(g.technicians||[]).length;return{netTotal:y.netTotal+lt,equipmentMoney:y.equipmentMoney+Number(W.equipmentTotal||0),crewMoney:y.crewMoney+Number(W.crewTotal||0),equipmentCount:y.equipmentCount+ne,crewCount:y.crewCount+se}},{netTotal:0,equipmentMoney:0,crewMoney:0,equipmentCount:0,crewCount:0}),Rt=Number(J.netTotal.toFixed(2)),Lt=J.equipmentCount,Bt=J.crewCount||r,qt=Number(c||0),X=Number((J.equipmentMoney+J.crewMoney+qt).toFixed(2)),gt=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let O=(t?.discountType==="amount"?"amount":"percent")==="amount"?gt:X*(gt/100);(!Number.isFinite(O)||O<0)&&(O=0),O>X&&(O=X);const ot=Math.max(0,X-O),Ht=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",bt=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,yt=Ht&&l&&bt>0?bt:0,ht=Number((ot*(yt/100)).toFixed(2)),Ot=l?Number(((ot+ht)*tt).toFixed(2)):0,Wt=Number((ot+ht+Ot).toFixed(2)),Ut=`<span class="project-code-badge project-focus-card__code">#${p(st)}</span>`,zt="",Jt="",Kt=d(`projects.status.${j}`,j),Yt=`<span class="${kt}">${p(Kt)}</span>`,Vt=`<span class="reservation-chip ${q} project-focus-card__payment-chip">${p(B)}</span>`,ct=(y,g,v)=>{const C=String(v||""),W=C.trim().startsWith("<");return`
      <div class="project-focus-card__row">
        <span class="project-focus-card__row-label">
          ${y?`<span class="project-focus-card__row-icon">${p(y)}</span>`:""}
          ${p(g)}
        </span>
        <span class="project-focus-card__row-value">${W?C:p(C)}</span>
      </div>
    `},{dateHtml:Gt,timeText:_t}=ye(t.start,t.end),Xt=[{icon:"ğŸ‘¤",label:d("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:a},{icon:"ğŸ·ï¸",label:d("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`<span class="project-type-chip project-type-chip--${t.type||"default"}">${p(i)}</span>`},{icon:"ğŸ“…",label:d("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Gt},_t?{icon:"â°",label:d("projects.focus.summary.time","Ø§Ù„ÙˆÙ‚Øª"),value:_t}:null].filter(Boolean).map(({icon:y,label:g,value:v})=>ct(y,g,v)).join(""),Qt=yt>0&&l?` ${d("projects.details.chips.vatOn","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)")}`:"",Zt=`${d("projects.details.summary.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")}${Qt}`,te=[{icon:"ğŸ’¼",label:d("projectCards.stats.servicesClientPrice","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"),value:k(c)},{icon:"ğŸ’µ",label:Zt,value:k(Wt)}].map(({icon:y,label:g,value:v})=>ct(y,g,v)).join(""),ee=[{icon:"ğŸ”—",label:d("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:S(String(o))},{icon:"ğŸ“¦",label:d("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:S(String(Lt))},{icon:"ğŸ˜",label:d("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:S(String(Bt))},{icon:"ğŸ’µ",label:d("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:k(Rt)}].map(({icon:y,label:g,value:v})=>ct(y,g,v)).join("");let K="";return j==="cancelled"?K=`<span class="reservation-chip status-cancelled project-focus-card__confirm-indicator">${p(d("projects.focus.cancelled","Ù…Ø´Ø±ÙˆØ¹ Ù…Ù„ØºÙŠ"))}</span>`:R?j!=="completed"?K=`<button class="btn btn-sm btn-warning project-focus-card__confirm-btn" data-action="close-project" data-id="${D}">${p(d("projects.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`:K=`<span class="reservation-chip status-completed project-focus-card__confirm-indicator">${p(d("projects.tag.closed","Ù…ØºÙ„Ù‚"))}</span>`:K=`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${D}">${p(d("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`,`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${[...it,j==="completed"?"project-focus-card--completed":""].filter(Boolean).join(" ")}" data-project-id="${D}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${Ut}
          ${zt}
          ${Jt}
          ${Yt}
          ${Vt}
        </div>
        <h6 class="project-focus-card__title">${p(It)}</h6>
        <p class="project-focus-card__description">${p(u)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${p(d("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${Xt}
            </div>
          </div>
          <!-- Show reservations above the financial summary -->
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${p(d("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${ee}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${p(d("projects.focus.summary.payment","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${te}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${K}
        </div>
      </article>
    </div>
  `}function Ct(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function ve(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const r=a.getDay(),s=r===0?6:r-1;a.setDate(a.getDate()-s);const o=new Date(a);return o.setDate(o.getDate()+7),e>=a&&e<o}function mt(t){const e=typeof t?.status=="string"?t.status.trim().toLowerCase():null,n=new Date,a=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;if(e&&(e==="cancelled"||e==="canceled"||e==="Ù…Ù„ØºÙŠ"||e==="Ù…Ù„ØºÙ‰"))return"cancelled";if(r&&!Number.isNaN(r.getTime())&&r<n)return"completed";if(e){if(e==="completed"||e==="Ù…ÙƒØªÙ…Ù„"||e==="Ù…ØºÙ„Ù‚")return"completed";if(e==="ongoing"||e==="in_progress"||e==="in-progress"||e==="Ø¬Ø§Ø±ÙŠ"||e==="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°")return"ongoing";if(e==="upcoming"||e==="Ù‚Ø§Ø¯Ù…")return"upcoming"}return a&&!Number.isNaN(a.getTime())&&a>n?"upcoming":"ongoing"}function Mt(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function U(t){const e=Number(t?.equipmentEstimate)||0,n=Mt(t),a=e+n,r=t?.applyTax===!0||t?.applyTax==="true",s=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let c=(t?.discountType==="amount"?"amount":"percent")==="amount"?s:a*(s/100);(!Number.isFinite(c)||c<0)&&(c=0),c>a&&(c=a);const l=Math.max(0,a-c),b=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",u=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,i=r||b&&u>0,m=b&&i&&u>0?u:0,h=m>0?Number((l*(m/100)).toFixed(2)):0,$=l+h;let N=i?$*tt:0;(!Number.isFinite(N)||N<0)&&(N=0),N=Number(N.toFixed(2));let T=i?Number(t?.totalWithTax):$;return i?(!Number.isFinite(T)||T<=0)&&(T=Number(($+N).toFixed(2))):T=$,{equipmentEstimate:e,expensesTotal:n,baseSubtotal:a,discountAmount:c,subtotalAfterDiscount:l,companyShareAmount:h,subtotal:$,applyTax:i,taxAmount:N,totalWithTax:T}}function Le(){const t=f.projects.length,e=f.projects.filter(r=>{const s=r.start?new Date(r.start):null;return!s||Number.isNaN(s.getTime())?!1:s>new Date}).length,n=f.projects.reduce((r,s)=>r+U(s).expensesTotal,0),a=f.projects.reduce((r,s)=>r+U(s).totalWithTax,0);_.projectsCount&&(_.projectsCount.textContent=S(String(t))),_.projectsUpcoming&&(_.projectsUpcoming.textContent=S(String(e))),_.projectsExpenses&&(_.projectsExpenses.textContent=k(n)),_.projectsBudget&&(_.projectsBudget.textContent=k(a))}function pt(t){return t?f.reservations.filter(e=>{const n=e?.projectId??e?.project_id??null;return n!=null&&String(n)===String(t)}):[]}function et(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(S(String(n)))||0,r=t.discountType||"percent",s=Array.isArray(t.crewAssignments)?t.crewAssignments:[],o=s.length?s:Array.isArray(t.technicians)?t.technicians:[],c=ce(e,a,r,!1,o,{start:t.start,end:t.end,companySharePercent:0});if(Number.isFinite(c))return c;const l=Number(S(String(t.cost??0)));return Number.isFinite(l)?Math.round(l):0}function Se(t){try{const{groups:e}=Pt(t);return(e||[]).reduce((n,a)=>{if(String(a?.type||"").toLowerCase()==="package"){const o=Array.isArray(a?.packageItems)?a.packageItems:[],c=new Set(o.map(l=>(l?.normalizedBarcode||l?.barcode||l?.equipmentId||"").toString()));return n+c.size}const s=Number.isFinite(Number(a?.count))?Number(a.count):Number.isFinite(Number(a?.quantity))?Number(a.quantity):1;return n+(s>0?s:1)},0)}catch{return(Array.isArray(t?.items)?t.items:[]).length||0}}function $e(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,r=t.status||t.state||"pending",s=String(r).toLowerCase(),{effectiveConfirmed:o}=oe(t,n),c=o?"confirmed":s,l=d(`reservations.list.status.${c}`,c==="confirmed"?"âœ… Ù…Ø¤ÙƒØ¯":c==="pending"?"â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯":c),u={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[c]||"project-reservation-card__badge--info",i=typeof n?.paymentStatus=="string"?n.paymentStatus.toLowerCase():null,m=i&&["paid","partial","unpaid"].includes(i)?i:String(t.paidStatus||t.paymentStatus||(t.paid?"paid":"unpaid")).toLowerCase(),h=m==="paid"?"paid":m==="partial"?"partial":"unpaid",$=h==="paid"?d("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"):h==="partial"?d("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"):d("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),N=h==="paid"?"project-reservation-card__badge--paid":h==="partial"?"project-reservation-card__badge--partial":"project-reservation-card__badge--unpaid",T=t.completed===!0||t.completed==="true",P=d("reservations.details.completed","Ù…ØºÙ„Ù‚"),I=T?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${p(P)}</span>`:"",x=et(t),B=k(x),q=Se(t),z=(t.technicians||[]).length,R=d("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),D=d("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),H=d("projectCards.stats.reservationTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${e}" data-reservation-index="${e}" data-project-id="${n?n.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${p(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${u}">${p(l)}</span>
          <span class="project-reservation-card__badge ${N}">${p($)}</span>
          ${I}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__meta project-reservation-card__meta--vertical">
          <span>ğŸ˜ ${p(R)}: ${S(String(z))}</span>
          <span>ğŸ“¦ ${p(D)}: ${S(String(q))}</span>
          <span>ğŸ’µ ${p(H)}: ${p(B)}</span>
        </div>
      </div>
    </article>
  `}function Be(t){const e=pt(t.id).map(s=>{const o=s?.id??s?.reservationId??s?.reservation_code??s?.reservation_id,c=f.reservations.findIndex(l=>{const b=l?.id??l?.reservationId??l?.reservation_code??l?.reservation_id;return o!=null&&b!=null&&String(b)===String(o)});return{reservation:s,index:c}}).filter(({index:s})=>Number.isInteger(s)&&s>=0).sort((s,o)=>{const c=s.reservation.start?new Date(s.reservation.start).getTime():0;return(o.reservation.start?new Date(o.reservation.start).getTime():0)-c}),n=d("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),a=d("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),r=e.length?`<div class="project-reservations-list">${e.map(({reservation:s,index:o})=>$e(s,o,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${p(a)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${p(n)}</h6>
      </div>
      ${r}
    </section>
  `}export{Fe as P,jt as a,Ee as b,Me as c,_ as d,Ae as e,M as f,De as g,tt as h,p as i,Pe as j,xe as k,k as l,et as m,pt as n,U as o,mt as p,ue as q,Re as r,f as s,Be as t,Le as u,Ie as v,ke as w};
