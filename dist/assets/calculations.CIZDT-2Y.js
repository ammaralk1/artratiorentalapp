import{n as I,r as j,i as q,p as B,l as Y,m as C}from"./reservationsService.DlFNf0bq.js";import{t as V,n as b,g as N}from"./auth.x64FkW0b.js";const y={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function X(t){y.callbacks.onRender=typeof t=="function"?t:null}function Z(t){y.callbacks.onBeforeRender=typeof t=="function"?t:null}function v(t){y.callbacks.onAfterRender=typeof t=="function"?t:null}function tt(t){y.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function et(t){y.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function nt(t){y.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function w(t,e,o=e){const n=N()==="en"?o??e:e;return V(t,n)}function at(){y.formatters.cachedLocale=null,y.formatters.numberFormatter=null}function A(){return(N()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function _(){const t=N();if(t!==y.formatters.cachedLocale||!y.formatters.numberFormatter||!y.formatters.currencyFormatter){y.formatters.cachedLocale=t;const e=A();y.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),y.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:y.formatters.numberFormatter,currencyFormatter:y.formatters.currencyFormatter}}function rt(t){const{numberFormatter:e}=_(),o=e.format(Math.round(t||0));return b(o)}function ot(t){const{currencyFormatter:e}=_(),o=Number.isFinite(Number(t))?Number(t):0,s=e.format(o);return`${b(s)} SR`}function F(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const o=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${o}-${s}-${n}`}function st(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const o=new Intl.DateTimeFormat(A(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return b(o.format(e))}function z(t){return new Intl.DateTimeFormat(A(),{month:"short"}).format(t)}const H=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),P=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),U=1440*60*1e3;function L(t){return b(String(t||"")).toLowerCase().trim()}function S(t){return(t||"").toString().trim()}function $(t,e){if(!t||!e)return 1;const o=new Date(t),s=new Date(e);if(Number.isNaN(o.getTime())||Number.isNaN(s.getTime()))return 1;const n=s.getTime()-o.getTime();return n<=0?1:Math.max(1,Math.ceil(n/U))}function T(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;$(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,o=t.discountType||t.discount_type||"percent",s=String(o).toLowerCase()==="amount"?"amount":"percent",n=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",a=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,r=a!=null?B(a):Number.NaN,p=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(r)&&r>0?r:null,f=Array.isArray(t.crewAssignments)?t.crewAssignments:[],h=f.length?f.map(d=>d?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],l=Y({items:Array.isArray(t.items)?t.items:[],technicianIds:h,crewAssignments:f,discount:e,discountType:s,applyTax:n,start:t.start,end:t.end,companySharePercent:p}),c=Number(t.cost);let m=l.finalTotal,i=l.taxAmount;if(Number.isFinite(c)&&c>0&&(m=C(c),n)){const d=m-l.taxableAmount;Number.isFinite(d)&&d>=0&&(i=C(d))}const g={rentalDays:l.rentalDays,equipmentTotal:l.equipmentTotal,crewTotal:l.crewTotal,crewCostTotal:l.crewCostTotal,discountAmount:l.discountAmount,subtotalAfterDiscount:l.subtotalAfterDiscount,taxableAmount:l.taxableAmount,taxAmount:i,finalTotal:m,companySharePercent:l.companySharePercent,companyShareAmount:l.companyShareAmount,netProfit:l.netProfit,companyShareEnabled:l.companySharePercent>0};return t.__financials=g,g}function k(t){return t?.projectId&&y.data.projectsMap.get(String(t.projectId))||null}function R(t=""){const e=String(t).toLowerCase().trim();return e?H.get(e)||e:""}function K(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const o of e){const s=String(o||"").toLowerCase().trim();if(s&&P.has(s))return P.get(s)}return t?.paid===!0||t?.paid==="true"}function D(t){const e=k(t),o=j(t,e),s=R(o.projectStatus);let n=R(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");o.projectLinked&&s&&(n=s),(!n||n==="cancelled")&&(n=o.effectiveConfirmed?"confirmed":"pending"),(q(t)||s==="completed")&&(n="completed");const a=o.effectiveConfirmed||n==="confirmed"||n==="completed";a&&n!=="completed"&&(n="confirmed");const r=K(t),u=t?.paidStatus??t?.paid_status??(r?"paid":"unpaid");return{statusValue:n,confirmed:a,paid:r,paidStatus:u}}function ct(t){const e=t.length;let o=0,s=0,n=0,a=0,r=0,u=0,p=0,f=0,h=0;t.forEach(c=>{const{statusValue:m,confirmed:i,paid:g}=D(c);m==="completed"&&(s+=1),i&&(o+=1),g&&(n+=1);const d=T(c);a+=d.finalTotal,r+=d.companyShareAmount,u+=d.taxAmount,p+=d.crewTotal,f+=d.crewCostTotal??0,h+=d.netProfit});const l=e?a/e:0;return{total:e,confirmed:o,completed:s,paidCount:n,revenue:a,average:l,companyShareTotal:r,taxTotal:u,crewTotal:p,crewCostTotal:f,netProfit:h}}function E({range:t,start:e,end:o}){const s=new Date;if(s.setHours(23,59,59,999),t==="custom"){const r=e?new Date(`${e}T00:00:00`):null,u=o?new Date(`${o}T23:59:59`):null;return{startDate:x(r)?r:null,endDate:x(u)?u:null}}let n=new Date(s),a=null;switch(t){case"last30":{a=new Date(s),a.setDate(a.getDate()-29);break}case"thisWeek":{const r=new Date(s),p=(r.getDay()-6+7)%7;r.setDate(r.getDate()-p),r.setHours(0,0,0,0);const f=new Date(r);f.setDate(r.getDate()+6),f.setHours(23,59,59,999),a=r,n=f;break}case"thisMonth":{a=new Date(s.getFullYear(),s.getMonth(),1),n=new Date(s.getFullYear(),s.getMonth()+1,0),n.setHours(23,59,59,999);break}case"thisQuarter":{const r=Math.floor(s.getMonth()/3);a=new Date(s.getFullYear(),r*3,1),n=new Date(s.getFullYear(),(r+1)*3,0),n.setHours(23,59,59,999);break}case"thisYear":{a=new Date(s.getFullYear(),0,1),n=new Date(s.getFullYear(),12,0),n.setHours(23,59,59,999);break}case"all":default:a=null,n=null;break}return a&&a.setHours(0,0,0,0),{startDate:a,endDate:n}}function x(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function lt(t,e){const{startDate:o,endDate:s}=E(e);let n=0;const a=[];return(t||[]).forEach(r=>{if(!r)return;const u=typeof r.repairCost=="number"?r.repairCost:Number.parseFloat(b(String(r.repairCost??"")));if(!Number.isFinite(u)||u<=0)return;const p=String(r.statusRaw??r.status??"").toLowerCase();if(!(p==="closed"||p==="completed"||p==="cancelled"))return;const h=r.resolvedAt??r.resolved_at??null,l=r.reportedAt??r.reported_at??null,c=r.createdAt??r.created_at??null,m=h?new Date(h):null,i=l?new Date(l):c?new Date(c):null,g=m&&!Number.isNaN(m.getTime())?m:i&&!Number.isNaN(i.getTime())?i:null;if(g&&(o&&g<o||s&&g>s))return;const d=Math.round(u*100)/100;n+=d,a.push({id:r.id,cost:d,date:g})}),{total:n,items:a}}function ut(t,e){const o=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:o,netProfit:(t.netProfit||0)-o}}function it(t){const e=new Date,o=[];for(let s=5;s>=0;s-=1){const n=new Date(e.getFullYear(),e.getMonth()-s,1),a=n.getFullYear(),r=n.getMonth(),u=t.filter(g=>{const d=g?.start?new Date(g.start):null;return d&&d.getFullYear()===a&&d.getMonth()===r}),p=u.length;let f=0,h=0,l=0;u.forEach(g=>{const d=T(g);f+=d.finalTotal,h+=d.netProfit,l+=d.companyShareAmount});const c=z(n),m=new Date(n.getFullYear(),n.getMonth(),1),i=new Date(n.getFullYear(),n.getMonth()+1,0);o.push({label:c,count:p,revenue:f,netProfit:h,companyShare:l,periodStart:m,periodEnd:i,startInput:F(m),endInput:F(i)})}return o}function mt(t){const e={confirmed:0,pending:0,completed:0};(t||[]).forEach(r=>{const{statusValue:u,confirmed:p}=D(r);u==="completed"?e.completed+=1:u==="confirmed"||p?e.confirmed+=1:e.pending+=1});const o=Math.max(1,(t||[]).length),s=e.confirmed,n=e.pending,a=e.completed;return[{label:w("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:s,percent:Math.round(s/o*100)||0,rawCount:s,className:"status-confirmed",filterKey:"confirmed"},{label:w("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:n,percent:Math.round(n/o*100)||0,rawCount:n,className:"status-pending",filterKey:"pending"},{label:w("reservations.reports.status.completedLabel","منتهية","Completed"),value:a,percent:Math.round(a/o*100)||0,rawCount:a,className:"status-completed",filterKey:"completed"}]}function dt(t){const e=t.length||1,o=t.filter(n=>D(n).paid).length,s=t.length-o;return[{label:w("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:o,percent:Math.round(o/e*100)||0,rawCount:o,className:"status-paid",filterKey:"paid"},{label:w("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:s,percent:Math.round(s/e*100)||0,rawCount:s,className:"status-unpaid",filterKey:"unpaid"}]}function pt(t,e){const o=new Map,s=new Map((e||[]).map(n=>[String(n.id),n]));return t.forEach(n=>{const a=String(n?.customerId??"unknown"),r=o.get(a)||{count:0,revenue:0},u=T(n);r.count+=1,r.revenue+=u.finalTotal,o.set(a,r)}),Array.from(o.entries()).map(([n,a])=>({name:s.get(n)?.customerName||w("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:a.count,revenue:a.revenue})).sort((n,a)=>a.revenue-n.revenue).slice(0,5)}function ft(t,e){const o=new Map,s=new Map((e||[]).map(a=>[S(a?.barcode),a])),n=w("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");return t.forEach(a=>{(a?.items||[]).forEach(r=>{const u=S(r?.barcode),p=u?s.get(u):null,f=r?.desc||r?.description||r?.name||p?.desc||p?.description||p?.name||"",h=f&&f.trim()?f:n,l=I(h)||"unknown",c=Number(r?.qty)||1,m=Number(r?.price)||0,i=c*m,g=o.get(l)||{name:h,count:0,revenue:0};g.name=h,g.count+=c,g.revenue+=i,o.set(l,g)})}),Array.from(o.values()).sort((a,r)=>r.count!==a.count?r.count-a.count:r.revenue-a.revenue).slice(0,5)}function W(t,e,o,s,n){const a=[],r=t?.reservationId||t?.id;r&&a.push(r),t?.notes&&a.push(t.notes);const{statusValue:u,paidStatus:p}=D(t);u&&a.push(u);const f=t?.paymentStatus||t?.payment_status;f&&a.push(f),t?.paid!=null&&a.push(t.paid?"paid":"unpaid"),p&&a.push(p);const h=o.get(String(t?.customerId));h&&a.push(h.customerName,h.company_name||h.companyName,h.contact_person||"");const l=k(t);return l&&a.push(l.title,l.code,l.status),a.push(O(p)),(t?.items||[]).forEach(m=>{m?.desc&&a.push(m.desc),m?.barcode&&a.push(m.barcode);const i=s.get(S(m?.barcode));i&&a.push(i.desc,i.description,i.name)}),(t?.technicians||[]).forEach(m=>{const i=n.get(String(m));i&&a.push(i.name,i.role,i.department)}),L(a.filter(Boolean).join(" ")).includes(e)}function ht(t,e,o,s,n){const{startDate:a,endDate:r}=E(e),u=L(e.search),p=!!u,f=new Map((o||[]).map(c=>[String(c.id),c])),h=new Map((s||[]).map(c=>[S(c?.barcode),c])),l=new Map((n||[]).map(c=>[String(c.id),c]));return(t||[]).filter(c=>{if(c&&c.projectId!=null&&String(c.projectId).trim()!=="")return!1;const m=c?.start?new Date(c.start):null;if(!m||Number.isNaN(m.getTime())||a&&m<a||r&&m>r)return!1;const{statusValue:i,confirmed:g,paid:d}=D(c);if(e.status==="confirmed"&&!(i==="confirmed"||i==="completed"||g)||e.status==="pending"&&i!=="pending"||e.status==="completed"&&i!=="completed"||e.payment==="paid"&&!d||e.payment==="unpaid"&&d)return!1;if(e.share&&e.share!=="all"){const M=T(c).companySharePercent>0;if(e.share==="with"&&!M||e.share==="without"&&M)return!1}return!(p&&!W(c,u,f,h,l))})}function O(t){const e=String(t??"").toLowerCase();return e==="paid"?w("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?w("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):w("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}export{ot as a,D as b,T as c,st as d,F as e,rt as f,ht as g,ct as h,lt as i,ut as j,it as k,mt as l,dt as m,pt as n,ft as o,O as p,Z as q,y as r,X as s,w as t,v as u,tt as v,et as w,nt as x,at as y};
