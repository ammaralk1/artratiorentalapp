const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.edD604YQ.js","./controller.MGjZNYWk.js","./auth.DfgKQ6UW.js","./auth.CpB-XPAW.css","./details.CmfJ4ZTt.js","./state.BUAyroAy.js","./reservationsService.4OJHoR61.js","./equipment.DHDEjvpb.js","./reservationPdf.DLwyllDI.js","./view.ClUM-wHH.js","./quotePdf.kDBbUcue.js","./canvasColorUtils.CviLtv6S.js","./reservationsActions.zx6280so.js","./projectsService.vH3JJYTw.js","./uiBridge.BLZZT8b9.js"])))=>i.map(i=>d[i]);
import{n as x,d as V,t as d,a as le,c as de,i as ue,m as me,l as fe,b as yt,A as pe,j as pt,h as et}from"./auth.DfgKQ6UW.js";import"./dashboard.D8BcbXXl.js";import{o as ye}from"./projectDetails.BDs_eRmN.js";import{g as ge,b as he,r as ve,a as $t,P as Ee}from"./projectFocusTemplates.hAucSvsi.js";import{_ as te,s as be}from"./uiBridge.BLZZT8b9.js";import{r as jt}from"./reservationPdf.DLwyllDI.js";import{d as Ie,f as vt,m as Ae}from"./state.BUAyroAy.js";import{getProjectsState as De,mapProjectFromApi as Se}from"./projectsService.vH3JJYTw.js";import{g as xe,c as Mt,m as _e}from"./reservationsService.4OJHoR61.js";import{d as Ft,s as Et}from"./view.ClUM-wHH.js";import{i as ke}from"./dashboardShell.DF2kUed9.js";import"./quotePdf.kDBbUcue.js";import"./canvasColorUtils.CviLtv6S.js";let bt={},k={initialized:!1,currentId:null,modal:{el:null,body:null}};function St(t=""){return x(String(t)).trim().toLowerCase()}function ee(t,n,e){if(!n||!e)return;const{startDate:a,endDate:r}=jt(t);n._flatpickr?a?n._flatpickr.setDate(a,!1,"Y-m-d"):n._flatpickr.clear():n.value=a||"",e._flatpickr?r?e._flatpickr.setDate(r,!1,"Y-m-d"):e._flatpickr.clear():e.value=r||""}function wt(t,{endOfDay:n=!1}={}){if(!t)return null;const e=String(t).trim();if(!e)return null;const a=e.includes("T")?e:`${e}T00:00:00`,r=new Date(a);return Number.isNaN(r.getTime())?null:(n?r.setHours(23,59,59,999):r.setHours(0,0,0,0),r)}function It(t){const n=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const e of n){if(!e)continue;const a=new Date(e);if(!Number.isNaN(a.getTime()))return a.setHours(0,0,0,0),a}return null}function gt(t){if(!document.getElementById("customer-reservations"))return;const e=document.getElementById("customer-search-reservation"),a=document.getElementById("customer-filter-start-date"),r=document.getElementById("customer-filter-end-date"),o=document.getElementById("customer-reservation-date-range"),m=document.getElementById("customer-reservation-status-filter"),p=document.getElementById("customer-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),r&&window.flatpickr(r,{dateFormat:"Y-m-d"}));const l=()=>{let g=x(a?.value||"").trim(),E=x(r?.value||"").trim(),h=o?.value||"";if(new Set(["","today","week","month"]).has(h)||(h="",o&&(o.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r._flatpickr&&r._flatpickr.clear(),r.value=""),g="",E=""),!g&&!E&&h){const{startDate:b,endDate:B}=jt(h);g=b,E=B}return{searchTerm:St(e?.value||""),startDate:g,endDate:E,status:m?.value||"",quickRange:h,customerId:t}},c=()=>{bt=l(),zt("customer-reservations",bt)};e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=x(e.value),c()}),e.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{o&&(o.value=""),c()}),a.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{o&&(o.value=""),c()}),r.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{ee(o.value,a,r),c()}),o.dataset.listenerAttached="true"),m&&!m.dataset.listenerAttached&&(m.addEventListener("change",c),m.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("click",()=>{e&&(e.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r._flatpickr&&r._flatpickr.clear(),r.value=""),o&&(o.value=""),m&&(m.value=""),c()}),p.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{zt("customer-reservations",bt)},c()}function nt(t){k.currentId=t;const{container:n}=G();n&&(k.initialized||(Be(),je(),Te(),document.addEventListener("projects:changed",()=>{k.currentId&&P()}),document.addEventListener("language:changed",()=>{k.currentId&&P()}),document.addEventListener("technicians:updated",()=>{k.currentId&&P()}),k.initialized=!0),P())}function G(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Be(){const{searchInput:t,statusSelect:n,clearBtn:e,startInput:a,endInput:r,rangeSelect:o}=G();window.flatpickr&&(a&&!a.dataset.datepickerAttached&&(window.flatpickr(a,{dateFormat:"Y-m-d"}),a.dataset.datepickerAttached="true"),r&&!r.dataset.datepickerAttached&&(window.flatpickr(r,{dateFormat:"Y-m-d"}),r.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=x(t.value),P()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{P()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.value=x(a.value),o&&(o.value=""),P()}),a.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{r.value=x(r.value),o&&(o.value=""),P()}),r.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{ee(o.value,a,r),P()}),o.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{const{searchInput:m,statusSelect:p,startInput:l,endInput:c,rangeSelect:g}=G();m&&(m.value=""),p&&(p.value=""),g&&(g.value=""),l&&(l._flatpickr&&l._flatpickr.clear(),l.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),P()}),e.dataset.listenerAttached="true")}function je(){const{container:t}=G();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Ne),t.dataset.projectModalListenerAttached="true")}function Ne(t){const n=t.target.closest(".project-focus-card");if(!n)return;const e=n.dataset.projectId?String(n.dataset.projectId):"";e&&ae(e)}function Te(){ne()}function ne(){if(k.modal?.el&&k.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),n=document.getElementById("project-details-body");if(!t||!n){const r=document.createElement("div");r.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${d("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(r.firstElementChild)}const e=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");return!e||!a?!1:(k.modal={el:e,body:a},!0)}function P(){const{container:t,searchInput:n,statusSelect:e,startInput:a,endInput:r,rangeSelect:o}=G();if(!t||!k.currentId)return;const m=St(n?.value||""),p=e?.value||"";let l=x(a?.value||"").trim(),c=x(r?.value||"").trim(),g=o?.value||"";if(new Set(["","today","week","month"]).has(g)||(g="",o&&(o.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r._flatpickr&&r._flatpickr.clear(),r.value=""),l="",c=""),!l&&!c&&g){const{startDate:f,endDate:D}=jt(g);l=f,c=D}const h=wt(l),v=wt(c,{endOfDay:!0}),{projects:b=[],technicians:B=[],reservations:L=[],customers:I=[]}=V(),N=new Map(B.map(f=>[String(f.id),f])),_=Le(L),A=I.find(f=>String(f.id)===String(k.currentId))||null,W=b.filter(f=>String(f.clientId)===String(k.currentId)).filter(f=>{if(m){const D=[f.id,f.projectId,f.project_id,f.projectCode,f.project_code].map(s=>s==null?"":x(String(s)));if(!St([f.title,f.description,f.notes,...D].filter(Boolean).join(" ")).includes(m))return!1}if(p&&Ie(f)!==p)return!1;if(h||v){const D=It(f);if(!D||h&&D<h||v&&D>v)return!1}return!0}).sort((f,D)=>{const T=It(f)?.getTime()||0;return(It(D)?.getTime()||0)-T});if(!W.length){const f=d("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${f}</div></div>`;return}t.innerHTML=W.map(f=>{const D=ge(f),T=D?_.get(D)||[]:[];return he(f,{customer:A,techniciansMap:N,reservations:T})}).join(""),t.querySelectorAll(".project-focus-card").forEach(f=>{f.dataset.customerModalListenerAttached!=="true"&&(f.addEventListener("click",D=>{const T=f.dataset.projectId?String(f.dataset.projectId):"";if(T){try{console.debug("[customer] project card click",T)}catch{}ae(T)}}),f.dataset.customerModalListenerAttached="true")})}function Le(t=[]){const n=new Map;return t.forEach(e=>{const a=e?.projectId??e?.project_id??e?.projectID;if(a==null)return;const r=String(a);n.has(r)||n.set(r,[]),n.get(r).push(e)}),n}function ae(t){const n=String(t||"").trim();if(!n||!ne())return;const{projects:e=[],reservations:a=[],customers:r=[]}=V(),o=k.modal;Ft.detailsModalEl=o.el,Ft.detailsBody=o.body;const m=De(),p=xe(),l=Array.isArray(m)?m.some(c=>String(c?.id)===n):!1;Et.projects=Array.isArray(m)&&m.length&&l?m:e||[],Et.reservations=Array.isArray(p)&&p.length?p:a||[],Et.customers=r||[],ye(n);try{if(!(window.bootstrap&&window.bootstrap.Modal)&&k.modal?.el){const c=k.modal.el;c.classList.add("show"),c.style.display="block",c.removeAttribute("aria-hidden")}}catch{}}async function zt(t,n){try{const e=await te(()=>import("./reservationsUI.edD604YQ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url);try{e.renderReservations?.(t,n)}catch(a){console.error("âŒ [customer-details] renderReservations failed",a)}}catch(e){console.error("âŒ [customer-details] Failed to load reservations UI module",e)}}le();de();ue();ke();me();const at=document.getElementById("logout-btn");at&&!at.dataset.listenerAttached&&(at.addEventListener("click",()=>fe()),at.dataset.listenerAttached="true");be({showReservationDetails(t){te(()=>import("./reservationsUI.edD604YQ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url).then(n=>{try{n.showReservationDetails?.(t)}catch(e){console.error("âŒ showReservationDetails failed",e)}}).catch(n=>console.error("âŒ Failed to load reservations UI module",n))}});const Ce=new URLSearchParams(window.location.search),S=Ce.get("id"),H=document.getElementById("customer-details"),Ut=document.getElementById("customer-hero-name"),Pe=document.getElementById("customer-hero-phone"),Re=document.getElementById("customer-hero-company"),$e=document.getElementById("customer-hero-email"),Me=document.getElementById("customer-hero-tax"),Ht=document.getElementById("customer-hero-summary"),Vt=document.getElementById("dashboard-greeting-customer-name"),qt=document.getElementById("dashboard-greeting-customer-company"),st=document.getElementById("customer-stat-projects"),rt=document.getElementById("customer-stat-projects-desc"),ot=document.getElementById("customer-stat-payment"),it=document.getElementById("customer-stat-payment-desc"),ct=document.getElementById("customer-stat-upcoming"),lt=document.getElementById("customer-stat-upcoming-desc"),Q=document.getElementById("customer-stat-activity"),dt=document.getElementById("customer-stat-activity-desc"),ut=document.getElementById("customer-stat-compliance"),J=document.getElementById("customer-stat-compliance-desc"),Ot=document.getElementById("sidebar-stat-projects"),Yt=document.getElementById("sidebar-stat-reservations"),Wt=document.getElementById("sidebar-stat-equipment"),Kt=document.getElementById("sidebar-stat-technicians"),Nt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),xt=Array.from(document.querySelectorAll("[data-customer-tab]")),Fe=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),z=document.getElementById("edit-document-file"),O=document.getElementById("edit-document-preview"),Qt=document.getElementById("edit-document-file-name"),Z=document.getElementById("edit-document-url"),tt=document.getElementById("edit-document-name");let j=null,R="idle",M=null;Nt.forEach(t=>{t.disabled=!0});let u=null,X=!1,F="",Tt="reservations";function C(t=""){const n=document.createElement("div");return n.textContent=t==null?"":String(t),n.innerHTML}function we(t=""){const n=C(t).replace(/\r/g,""),e=`
`;return n.includes(e)?n.split(e).join("<br>"):n}function ze(t=null){M=t&&typeof t=="object"?{...t}:null,j=null,R="idle",z&&(z.value=""),q()}function q(){if(!Qt||!O)return;const t=R==="uploading",n=!!j?.dataUrl;let e=d("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?e=d("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):R==="error"?e=d("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):n?e=j?.fileName||d("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):M&&(M.fileName||M.url)&&(e=M.fileName||M.url),Qt.textContent=e;const a=n||!!M?.url;O.disabled=t||!a}function Ue(){if(!z)return;const[t]=z.files||[];if(!t){R="idle",j=null,q();return}R="uploading",q();const n=new FileReader;n.onload=()=>{if(typeof n.result!="string"){R="error",j=null,q();return}j={dataUrl:n.result,fileName:t.name,mimeType:t.type,size:t.size},Z&&(Z.value=n.result),tt&&(tt.value=t.name),R="success",q()},n.onerror=()=>{R="error",j=null,q()},n.readAsDataURL(t)}z&&!z.dataset.listenerAttached&&(z.addEventListener("change",Ue),z.dataset.listenerAttached="true");O&&!O.dataset.listenerAttached&&(O.addEventListener("click",()=>{if(R==="uploading")return;const t=j?.dataUrl||M?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),O.dataset.listenerAttached="true");function mt(t,n,e,{hideWhenEmpty:a=!1}={}){if(!t)return;const r=e==null?"":String(e).trim(),o=r.length>0,m=o?r:d("common.placeholder.empty","â€”");t.textContent=`${n} ${m}`,a?t.classList.toggle("hidden",!o):t.classList.remove("hidden")}function _t(t){const n=d("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),e=d("common.placeholder.empty","â€”"),a=t?.customerName||e,r=t?.phone?x(t.phone):"",o=t?.companyName||"",m=t?.email||"",p=t?.tax_id??t?.taxId??"";if(Ut&&(Ut.textContent=a),Ht&&(Ht.textContent=a!==e?a:n),mt(Pe,"ğŸ“",r,{hideWhenEmpty:!1}),mt(Re,"ğŸ¢",o,{hideWhenEmpty:!0}),mt($e,"ğŸ“§",m,{hideWhenEmpty:!0}),mt(Me,"ğŸ§¾",p,{hideWhenEmpty:!0}),Vt&&(Vt.textContent=a),qt){const l=[];o&&l.push(o),r&&l.push(`ğŸ“ ${r}`);const c=typeof p=="string"?p.trim():String(p||"").trim();c&&l.push(`ğŸ§¾ ${c}`),qt.textContent=l.length?l.join(" â€¢ "):"â€”"}}function He(t){if(t?.preventDefault?.(),!u)return;en();const n=document.getElementById("editCustomerModal"),e=typeof bootstrap<"u"?bootstrap.Modal:null;if(!n||!e)return;(e.getInstance(n)||new e(n)).show()}function Ve(){Nt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",He),t.dataset.listenerAttached="true")})}function kt(t){Nt.forEach(n=>{n&&(n.disabled=!!t)})}Ve();function Bt(t){t&&(Tt=t,xt.forEach(n=>{const e=n?.getAttribute("data-customer-tab")===t;n&&(n.classList.toggle("tab-active",e),n.classList.toggle("active",e),n.setAttribute("aria-selected",String(e)))}),Fe.forEach((n,e)=>{n&&n.classList.toggle("hidden",e!==t)}),t==="projects"&&S&&u&&nt(S))}function qe(){xt.length&&(xt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const n=t.getAttribute("data-customer-tab");n&&Bt(n)}),t.dataset.listenerAttached="true")}),Bt(Tt))}qe();function se(t={}){if(!t||typeof t!="object")return null;const n=[t.document,t.attachment,t.file].find(_=>_&&typeof _=="object"),e=_=>{for(const A of _)if(typeof A=="string"&&A.trim()!=="")return A.trim();return""},a=_=>{for(const A of _){if(typeof A=="number"&&Number.isFinite(A))return Math.max(0,Math.trunc(A));if(typeof A=="string"&&A.trim()!==""&&/^\d+$/.test(A.trim()))return Math.max(0,parseInt(A.trim(),10))}return null},r=[t.document_url,t.documentUrl,t.url,t.href,t.link,n?.url,n?.href,n?.link],o=[t.document_path,t.documentPath,t.path,n?.path,n?.documentPath],m=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,n?.fileName,n?.filename,n?.name],p=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,n?.mimeType,n?.contentType,n?.type],l=[t.document_size,t.documentSize,t.size,n?.size,n?.length],c=[n?.data,n?.base64,n?.content,t.data,t.base64,t.content,t.document_data],g=e(r),E=e(m),h=e(p)||"application/octet-stream",v=e(o),b=e(c),B=a(l);if(!g&&!b)return null;let L=g,I=b;if(!L&&I&&I.startsWith("data:")){const _=I.indexOf(",");_!==-1&&(L=I,I=I.slice(_+1))}!L&&I&&(L=`${I.startsWith("data:")?"":`data:${h};base64,`}${I}`);const N={url:L,fileName:E,mimeType:h,path:v,data:I||null,size:B};return N.url&&/sirv\.com/i.test(N.url)&&(N.source="sirv"),N}function Oe(){return document.documentElement.getAttribute("lang")||"ar"}function $(t){const n=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(n)}catch{return String(n)}}function Jt(t){if(!t)return"â€”";const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return"â€”";const a=Oe()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(n)}catch{const o=String(n.getMonth()+1).padStart(2,"0"),m=String(n.getDate()).padStart(2,"0"),p=n.getFullYear();return`${o}/${m}/${p}`}}function Xt(t){if(!t)return"";const n=t.trim().split(/\s+/),e=n.pop()||"";return`<span class="currency-amount">${n.join(" ")}</span> <span class="currency-unit currency-unit--sm">${e}</span>`}function Gt(t,n){const e=d("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),a=d("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${e}</span>
      ${Xt(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${a}</span>
      ${Xt(n)}
    </div>
  `}const Zt={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},Ye={reservation:"Reservation",project:"Project",customer:"Client record"};function At(t=[]){let n=null;return t.forEach(e=>{if(!e)return;const a=e instanceof Date?e:new Date(e);Number.isNaN(a.getTime())||(!n||a>n)&&(n=a)}),n}function We(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function Dt({projects:t=0,reservations:n=0,equipment:e=0,technicians:a=0}={}){Ot&&(Ot.textContent=$(t)),Yt&&(Yt.textContent=$(n)),Wt&&(Wt.textContent=$(e)),Kt&&(Kt.textContent=$(a));try{window.__CUSTOMER_STATS__={projects:t,reservations:n,equipment:e,technicians:a}}catch{}}function U(){if(!u||!S){const s=vt(0);if(st&&(st.textContent="0"),rt&&(rt.textContent=d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),ot&&(ot.innerHTML=Gt(s,s)),it){const i=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),y=d("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");it.textContent=`${i} â€¢ ${y}`}ct&&(ct.textContent="0"),lt&&(lt.textContent=d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),Q&&(Q.textContent="â€”"),dt&&(dt.textContent=d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),ut&&(ut.textContent="0%"),J&&(J.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),Dt({projects:0,reservations:0,equipment:0,technicians:0});return}const t=V(),e=(Array.isArray(t.reservations)?t.reservations:[]).filter(s=>s?[s.customerId,s.customer_id,s.customer?.id].some(y=>y!=null&&String(y)===String(S)):!1),a=e.length,r=Date.now(),o=e.filter(s=>{const i=s?.start??s?.startDatetime??s?.start_datetime??s?.start_date;if(!i)return!1;const y=new Date(i);return Number.isNaN(y.getTime())?!1:y.getTime()>=r}),m=o.map(s=>s?.start??s?.startDatetime??s?.start_datetime).map(s=>new Date(s)).filter(s=>!Number.isNaN(s.getTime())).sort((s,i)=>s-i)[0]||null,l=(Array.isArray(t.projects)?t.projects:[]).filter(s=>s?[s.clientId,s.client_id,s.customer_id].some(y=>y!=null&&String(y)===String(S)):!1),c=l.length,g=e.filter(s=>{const i=String(s?.status||s?.reservationStatus||"").toLowerCase();return!(i==="cancelled"||i==="canceled"||i==="Ù…Ù„ØºÙŠ"||i==="Ù…Ù„ØºÙ‰"||i==="Ù…Ù„ØºÙŠØ©")}),E=new Map;g.forEach(s=>{const i=s?.projectId??s?.project_id??null;if(i==null)return;const y=String(i);E.has(y)||E.set(y,[]),E.get(y).push(s)});let h=0,v=0,b=0,B=0;l.forEach(s=>{const i=ve(s)||{},y=s?.id??s?.projectId??s?.project_id??null,K=(y!=null?E.get(String(y))||[]:[]).reduce((ce,Rt)=>ce+(Number(Rt?.totalAmount)||$t(Rt)||0),0),oe=i.applyTax?Number(((Number(i.subtotal||0)+K)*Ee).toFixed(2)):0,Lt=Number((Number(i.subtotal||0)+K+oe).toFixed(2)),ie=Mt({totalAmount:Lt,paidAmount:Number(s?.paidAmount)||null,paidPercent:Number(s?.paidPercent)||null}),Ct=Math.max(0,Number(ie.paidAmount||0)),Pt=Math.max(0,Number((Lt-Ct).toFixed(2)));h+=Ct,v+=Pt,B+=1,Pt<=.5&&(b+=1)}),g.filter(s=>s?.projectId==null&&s?.project_id==null).forEach(s=>{const i=Number(s?.totalAmount)||$t(s)||0,y=Mt({totalAmount:i,paidAmount:Number(s?.paidAmount)||null,paidPercent:Number(s?.paidPercent)||null,progressType:s?.paymentProgressType??null,progressValue:s?.paymentProgressValue??null,history:Array.isArray(s?.paymentHistory)?s.paymentHistory:[]}),ht=Math.max(0,Number(y.paidAmount||0)),K=Math.max(0,Number((i-ht).toFixed(2)));h+=ht,v+=K,B+=1,K<=.5&&(b+=1)});const I=B>0?Math.round(b/B*100):0,N=[];if(e.forEach(s=>{const i=At([s?.updatedAt,s?.updated_at,s?.end,s?.endDatetime,s?.end_datetime,s?.start,s?.startDatetime,s?.start_datetime,s?.createdAt,s?.created_at]);i&&N.push({date:i,type:"reservation"})}),l.forEach(s=>{const i=At([s?.updatedAt,s?.updated_at,s?.end,s?.end_datetime,s?.start,s?.start_datetime,s?.createdAt,s?.created_at]);i&&N.push({date:i,type:"project"})}),!N.length){const s=At([u?.updated_at,u?.updatedAt,u?.created_at,u?.createdAt]);s&&N.push({date:s,type:"customer"})}const _=N.reduce((s,i)=>s?i.date>s.date?i:s:i,null),A=_?.date??null,Y=_?.type??null,W=e.reduce((s,i)=>Array.isArray(i?.items)?s+i.items.length:s,0),f=new Set;e.forEach(s=>{Array.isArray(s?.technicians)&&s.technicians.forEach(i=>{const y=i!=null?String(i):"";y&&f.add(y)}),Array.isArray(s?.techniciansDetails)&&s.techniciansDetails.forEach(i=>{const y=i?.id??i?.technician_id??i?.technicianId;y!=null&&f.add(String(y))})}),Dt({projects:c,reservations:a,equipment:W,technicians:f.size}),st&&(st.textContent=$(c)),rt&&(rt.textContent=c>0?d("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const D=vt(h),T=vt(v);if(ot&&(ot.innerHTML=Gt(D,T)),it){const s=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),i=v>0?d("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",T):d("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");it.textContent=`${s} â€¢ ${i}`}if(ct&&(ct.textContent=$(o.length)),lt&&(lt.textContent=o.length>0&&m?d("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",Jt(m)):d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),Q)if(Y){const s=d(`customerDetails.stats.activityType.${Y}`,Ye[Y]||Y);Q.textContent=s}else Q.textContent="â€”";if(dt&&(dt.textContent=A?d("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",Jt(A)):d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),ut&&(ut.textContent=`${$(I)}%`),J)if(B>0){const s=I>=90?"excellent":I>=70?"good":I>=40?"average":"poor",i=s?d(`customerDetails.stats.complianceLabel.${s}`,Zt[s]||Zt.poor):"",y=d("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",$(b)).replace("{total}",$(B));J.textContent=i?`${i} â€¢ ${y}`:y}else J.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");Dt({projects:c,reservations:a,equipment:W,technicians:f.size})}function Ke(t){const{customers:n}=V();if(!Array.isArray(n))return null;const e=n.find(m=>String(m.id)===String(t));if(!e)return null;const a=e.tax_id??e.taxId??"",r=typeof a=="string"?a.trim():String(a||"").trim(),o=e.document??se(e);return{...e,tax_id:r,taxId:r,document:o}}function Qe(t={}){if(!t||typeof t!="object")return null;const n=t.id??t.customerId??t.customer_id??null,e=t.full_name??t.customerName??t.name??"",a=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",r=typeof a=="string"?a.trim():String(a||"").trim(),o=se(t);return n==null?null:{id:String(n),customerName:e,full_name:e,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:r,taxId:r,document:o,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Je(t){if(!t)return;const n=V(),e=Array.isArray(n.customers)?[...n.customers]:[],a=e.findIndex(r=>String(r.id)===String(t.id));a>=0?e[a]={...e[a],...t}:e.push(t),et({customers:e})}async function Xe(){const{technicians:t}=V();if(!(Array.isArray(t)&&t.length>0))try{const n=await yt("/technicians/"),e=Array.isArray(n?.data)?n.data.map(Ae):[];e.length>0&&et({technicians:e})}catch(n){console.warn("âš ï¸ Failed to load technicians list",n)}}async function Ge(t){if(t)try{const n=new URLSearchParams({customer_id:String(t),limit:"200"}),e=await yt(`/reservations/?${n.toString()}`),a=Array.isArray(e?.data)?e.data.map(_e):[];et({reservations:a})}catch(n){console.warn("âš ï¸ Failed to load customer reservations",n)}}async function Ze(t){if(t)try{const n=new URLSearchParams({client_id:String(t),limit:"200"}),e=await yt(`/projects/?${n.toString()}`),a=Array.isArray(e?.data)?e.data.map(Se):[];et({projects:a})}catch(n){console.warn("âš ï¸ Failed to load customer projects",n)}}async function tn(t,{showSpinner:n=!1}={}){if(t){n?(X=!0,F="",w()):(X=!0,F="");try{const e=await yt(`/customers/?id=${encodeURIComponent(t)}`),a=e?.data??e,r=Qe(a);if(!r)throw new Error("Invalid customer payload received from server");u=r,Je(r),X=!1,F="",w(),await Xe(),await Promise.all([Ge(r.id),Ze(r.id)]),gt(r.id),nt(r.id),U()}catch(e){if(X=!1,e instanceof pe&&e.status===404){u=null,F="",w();return}console.error("âš ï¸ Failed to load customer details",e);const a=d("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");u?(F="",pt(a),w()):(F=`${a}${e?.message?` (${e.message})`:""}`,w())}}}function w(){if(!H)return;if(Bt(Tt),!u){if(_t(null),kt(!0),U(),X){H.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(F){H.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${C(F)}</div>
        </div>
      `;return}const e=d("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");H.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${C(e)}</div>
      </div>
    `;return}_t(u),kt(!1);const n=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:u.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:u.phone?x(u.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:u.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:u.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:u.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:u.tax_id??u.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:u.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:u.document??null,type:"document"}].map(e=>{const a=d(e.key,e.fallback);if(e.type==="document"){const l=e.value;let c='<span class="text-base-content/50">â€”</span>';if(l&&typeof l=="object"){const g=l.fileName?.trim()||l.path?.trim()||l.url||"";if(l.url){const E=C(g||d("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),h=We(l.url),v=C(d("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));c=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${E}</span><a class="btn btn-outline btn-sm" href="${h}" target="_blank" rel="noopener noreferrer">${v}</a></div>`}else g&&(c=`<span class="text-base-content break-all">${C(g)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${C(a)}</span>
          <div class="mt-2">${c}</div>
        </article>
      `}const o=(e.value==null?"":String(e.value)).trim(),m=o.length>0?o:"â€”",p=e.multiline?we(m):C(m);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${C(a)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${p}</p>
      </article>
    `}).join("");H.innerHTML=n,U()}function en(){document.getElementById("edit-id").value=u?.id||"",document.getElementById("edit-name").value=u?.customerName||"",document.getElementById("edit-phone").value=x(u?.phone||""),document.getElementById("edit-company").value=u?.companyName||"",document.getElementById("edit-email").value=u?.email||"",document.getElementById("edit-address").value=u?.address||"",document.getElementById("edit-tax-id").value=x(u?.tax_id??u?.taxId??"");const t=u?.document??null;Z&&(Z.value=t?.url||""),tt&&(tt.value=t?.fileName||""),ze(t),document.getElementById("edit-notes").value=u?.notes||""}const ft=document.getElementById("save-edit-btn");ft&&!ft.dataset.listenerAttached&&(ft.addEventListener("click",()=>{if(!u)return;const t=document.getElementById("edit-id").value,n=document.getElementById("edit-name").value.trim(),e=x(document.getElementById("edit-phone").value.trim()),a=document.getElementById("edit-company").value.trim(),r=document.getElementById("edit-email").value.trim(),o=document.getElementById("edit-address").value.trim(),m=x(document.getElementById("edit-tax-id").value.trim()),p=(Z?.value||"").trim(),l=(tt?.value||"").trim(),c=document.getElementById("edit-notes").value.trim();if(!n||!e){pt(d("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const g=V(),E=Array.isArray(g.customers)?g.customers:[],h=E.findIndex(L=>String(L.id)===String(t));if(h===-1){pt(d("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const v=E[h]?.document??null;let b=v;j?.dataUrl?b={...v||{},url:j.dataUrl,fileName:l||j.fileName||v?.fileName||"",mimeType:j.mimeType||v?.mimeType,size:j.size??v?.size}:p?b={...v||{},url:p,fileName:l||v?.fileName||""}:l&&v?b={...v,fileName:l}:!p&&!l&&(b=v),E[h]={...E[h],customerName:n,phone:e,companyName:a,email:r,address:o,notes:c,tax_id:m,taxId:m,document:b},et({customers:E}),u=E[h],w(),gt(S),nt(S),U(),document.dispatchEvent(new CustomEvent("customers:changed")),pt(d("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),ft.dataset.listenerAttached="true");async function nn(){if(H){if(!S){_t(null),kt(!0),U(),H.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${d("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}u=Ke(S),u&&(w(),gt(S),nt(S),U()),await tn(S,{showSpinner:!u})}}nn();const re=()=>{!S||!u||U()};document.addEventListener("reservations:changed",re);document.addEventListener("projects:changed",re);document.addEventListener("language:changed",()=>{w(),S&&u&&(gt(S),nt(S),U())});
