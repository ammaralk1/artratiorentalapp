import{l as V,n as _,d as _n,a as Z,b as it,e as gi,m as hi,h as yi,i as bi,j as _i,g as Y,t as f,A as Ii,u as In,s as k,c as Ai}from"./auth.B3hKYgQo.js";const Ni=V()||{};let _e=(Ni.technicians||[]).map(Ft);function He(){return _e}function Be(e){return _e=Array.isArray(e)?e.map(Ft):[],_n({technicians:_e}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),_e}async function rt(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),i=await Z(`/technicians/${n?`?${n}`:""}`),a=i?.data??i;let c=[];Array.isArray(a)?c=a:a&&typeof a=="object"&&(Array.isArray(a.items)?c=a.items:Array.isArray(a.results)?c=a.results:Array.isArray(a.data)?c=a.data:Array.isArray(a.records)&&(c=a.records));const s=c.map(lt);return Be(s)}async function An(e){const t=await Z("/technicians/",{method:"POST",body:e}),n=lt(t?.data??{});return Be([..._e,n]),n}async function qt(e,t){const n=await Z(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=lt(n?.data??{}),a=_e.map(c=>String(c.id)===String(e)?i:c);return Be(a),i}async function Nn(e){await Z(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Be(_e.filter(t=>String(t.id)!==String(e)))}function Lt({name:e,phone:t,email:n,role:i,department:a,dailyWage:c,dailyTotal:s,status:o,notes:l,active:r=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:i??"",department:a??null,daily_wage:c??0,daily_total:s??null,status:o??"available",notes:l??null,active:r?1:0}}function lt(e={}){return Pn({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function Ft(e={}){return Pn(e)}function Pn(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",i=e.phone??"",a=e.email??null,c=e.specialization??e.role??e.position??"",s=e.department??e.team??"",o=tn(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=tn(e.daily_total??e.dailyTotal??e.total??e.total_wage??o),r=nn(e.baseStatus??e.status??"available"),u=nn(e.status??e.baseStatus??"available"),d=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:i,email:a,role:c,department:s,dailyWage:o,dailyTotal:l,status:u,baseStatus:r,notes:d,active:p}}function tn(e){const t=Number.parseFloat(_(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function nn(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function Oe(e){return e instanceof it}const io=Object.freeze(Object.defineProperty({__proto__:null,buildTechnicianPayload:Lt,createTechnicianApi:An,deleteTechnicianApi:Nn,getTechniciansState:He,isApiError:Oe,mapLegacyTechnician:Ft,mapTechnicianFromApi:lt,refreshTechniciansFromApi:rt,setTechniciansState:Be,updateTechnicianApi:qt},Symbol.toStringTag,{value:"Module"}));gi();hi();yi();document.addEventListener("DOMContentLoaded",()=>{bi();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>_i()),e.dataset.listenerAttached="true")});function at(e){const t=Number(e)||0,i=Y()==="ar"?"ar-SA-u-nu-latn":"en-US",a=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${_(a)} SR`}function ao(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function oo(e){const t=new Date,n=e?.start?new Date(e.start):null,i=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":i&&!Number.isNaN(i.getTime())&&i<t?"completed":"ongoing"}function co(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function be(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Pi="technicianPositions:updated";let te=[],Sn=!1,Re=null;function Bt(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function vn({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:a}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:i??null,label_en:a??null}}function Si(e){return te=Array.isArray(e)?e.map(Bt).filter(t=>t.name!=="").sort((t,n)=>ke(t).localeCompare(ke(n),"ar",{sensitivity:"base"})):[],Sn=!0,ut(),pe()}function ut(){try{const e={positions:pe()},t=new CustomEvent(Pi,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function ke(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function pe(){return te.map(e=>({...e}))}function kn(e){const t=String(e??"").trim().toLowerCase();return t&&te.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function vi({forceRefresh:e=!1}={}){return Sn&&!e?pe():(Re&&!e||(Re=Z("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return Si(n)}).finally(()=>{Re=null})),Re)}async function Ue({forceRefresh:e=!1}={}){try{return await vi({forceRefresh:e})}catch(t){throw t instanceof it?t:new it(t?.message||f("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function ki({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:a}){const c=vn({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:a}),s=await Z("/technician-positions/",{method:"POST",body:c}),o=Bt(s?.data??{});return te=[...te,o],te.sort((l,r)=>ke(l).localeCompare(ke(r),"ar",{sensitivity:"base"})),ut(),o}async function Ci(e,{name:t,cost:n,clientPrice:i,labelAr:a,labelEn:c}){if(!e)throw new Error("Position id is required");const s=vn({name:t,cost:n,clientPrice:i,labelAr:a,labelEn:c}),o=await Z(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:s}),l=Bt(o?.data??{});return te=te.map(r=>r.id===l.id?l:r),te.sort((r,u)=>ke(r).localeCompare(ke(u),"ar",{sensitivity:"base"})),ut(),l}async function Ei(e){if(!e)throw new Error("Position id is required");return await Z(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),te=te.filter(t=>t.id!==Number(e)),ut(),pe()}const _t="__ART_RATIO_TECH_SUB_TAB__",Cn=["technicians-management","technicians-positions"];let U=null,an=!1,tt=!1,Me="",It=!1,oe=null,Ie="technicians-management";const on=qi();on&&(Ie=on);async function En({showToastOnError:e=!0}={}){if(!tt){tt=!0,Me="",H();try{await rt(),It=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),Me=Oe(t)?t.message:f("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&k(Me,"error")}finally{tt=!1,H()}}}function Tn(){return He()}function Ze(e=""){return _(String(e)).trim().toLowerCase()}function Ti(e){return e==null?"":String(e)}function Ce(e=""){return _(String(e)).replace(/[^0-9+]/g,"")}function G(e=""){const t=_(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...i]=t.split(".");return`${n}.${i.join("")}`}function ve(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const i=e.selectionEnd;e.value=n,i!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function qi(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(_t);return e&&Cn.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function Li(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Cn.includes(e)){window.localStorage.removeItem(_t);return}window.localStorage.setItem(_t,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function qn(e,t=0,n=null){const i=String(e??"").trim(),a=i?kn(i):null;return a?{matchedPosition:a,dailyWage:Number.isFinite(a.cost)?a.cost:0,dailyTotal:a.clientPrice==null?null:Number.isFinite(a.clientPrice)?a.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Ln(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function At(e,t=Y()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Fi(e,t=Y()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function Fn(){const{container:e,body:t}=Ln();!e||!t||(t.textContent="",e.hidden=!0)}function wt(e,t={}){const{container:n,body:i}=Ln();if(!n||!i)return;const a=String(e??"").trim();if(!a){Fn();return}const c=qn(a,t?.dailyWage??0,t?.dailyTotal??null),s=at(c.dailyWage||0),o=c.dailyTotal!=null?at(c.dailyTotal):f("technicians.positionSummary.noClientPrice","â€”");c.matchedPosition?i.textContent=f("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",s).replace("{price}",o):i.textContent=f("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",s).replace("{price}",o),n.hidden=!1}function Ke(){const e=document.getElementById("technician-position-options");if(!e)return;const t=pe(),n=Y(),i=new Set,a=[];t.forEach(c=>{const s=At(c,n).trim();s&&!i.has(s.toLowerCase())&&(a.push(`<option value="${be(s)}"></option>`),i.add(s.toLowerCase()));const o=Fi(c,n).trim();o&&!i.has(o.toLowerCase())&&(a.push(`<option value="${be(o)}"></option>`),i.add(o.toLowerCase()));const l=c.name?.trim();l&&!i.has(l.toLowerCase())&&(a.push(`<option value="${be(l)}"></option>`),i.add(l.toLowerCase()))}),e.innerHTML=a.join("")}function cn(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),a=t.map(o=>o?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(o=>{if(!o)return;const r=o.getAttribute("data-tech-tab")===a;o.classList.toggle("tab-active",r),o.classList.toggle("active",r),o.setAttribute("aria-selected",r?"true":"false"),o.setAttribute("tabindex",r?"0":"-1")}),n.forEach(o=>{if(!o)return;const r=o.getAttribute("data-tech-tab-panel")===a;o.hidden=!r,o.classList.toggle("active",r)}),Ie=a,Li(a);const s=t.find(o=>o?.getAttribute("data-tech-tab")===a)?.closest("[data-tab-scroll]");s&&s.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),a==="technicians-positions"&&(ue(),Ue().then(()=>{ue()}).catch(o=>{console.error("âŒ [technicians] failed to load positions for tab switch",o),k(o?.message||f("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function Dt(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",i=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=f(n,i)}function $t(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=f("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function Rt(){Dt(U?"update":"add"),$t(!!U),H()}function Bi(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,i=Array.from(new Set(e.map(c=>(c?.role||"").trim()).filter(Boolean))).sort((c,s)=>c.localeCompare(s,"ar",{sensitivity:"base"})),a=f("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${a}</option>`+i.map(c=>`<option value="${c}">${c}</option>`).join(""),n&&i.includes(n)?t.value=n:t.value="",t.value}function dt(){const e=document.getElementById("technician-form");e&&(e.reset(),U=null,Dt("add"),$t(!1),Fn())}function wi(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),i=document.getElementById("technician-email"),a=document.getElementById("technician-role"),c=document.getElementById("technician-department"),s=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=Ce(e.phone||""),i&&(i.value=e.email||""),a.value=e.role||"",c&&(c.value=e.department||""),s&&(s.value=e.notes||""),U=String(e.id),Dt("update"),$t(!0),wt(a.value,e))}function Di(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-email"),i=document.getElementById("technician-role"),a=document.getElementById("technician-department"),c=document.getElementById("technician-notes");if(!e||!t||!i)return null;const s=e.value.trim(),o=Ce(t.value.trim());t.value=o;const l=(n?.value||"").trim(),r=i.value.trim(),u=a?.value.trim()||"",d="available",p=c?.value.trim()||"",b=U?wn(U):null,{dailyWage:g,dailyTotal:A}=qn(r,b?.dailyWage??0,b?.dailyTotal??null);return s?o?r?!Number.isFinite(g)||g<0?(k(f("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):A!=null&&(!Number.isFinite(A)||A<0)?(k(f("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(wt(r,{dailyWage:g,dailyTotal:A}),{name:s,phone:o,email:l,role:r,department:u,dailyWage:Number.isFinite(g)?g:0,dailyTotal:A==null?null:Number(A),status:d,baseStatus:d,notes:p}):(k(f("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),i.focus(),null):(k(f("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(k(f("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function $i(e){e.preventDefault();try{await Ue()}catch(i){console.error("âŒ [technicians] failed to load positions before submit",i);const a=i?.message||f("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");k(a,"error");return}const t=Di();if(!t)return;const n=Lt({name:t.name,phone:t.phone,email:t.email||null,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{U?(await qt(U,n),k(f("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await An(n),k(f("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),dt(),H()}catch(i){console.error("âŒ [technicians] handleTechnicianSubmit failed",i);const a=Oe(i)?i.message:f("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");k(a,"error")}}function Ri(){dt()}function zi(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),email:document.getElementById("edit-technician-email"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=Ce(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.email&&t.email.value!==(e.email||"")&&(t.email.value=e.email||""),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const i=G(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==i&&(t.wage.value=i);const a=G(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==a&&(t.total.value=a);const c=e.baseStatus||e.status||"available";t.status.value!==c&&(t.status.value=c),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),ve(t.phone,Ce),ve(t.wage,G),ve(t.total,G)}function xi(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),i=document.getElementById("edit-technician-email"),a=document.getElementById("edit-technician-role"),c=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),o=document.getElementById("edit-technician-total"),l=document.getElementById("edit-technician-status"),r=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!o||!l)return null;const u=e.value.trim(),d=t.value.trim(),p=Ce(n.value.trim());n.value=p;const b=(i?.value||"").trim(),g=a.value.trim(),A=c?.value.trim()||"",S=G(s.value.trim());s.value=S;const m=S===""?0:parseFloat(S),y=G(o.value.trim());o.value=y;const P=y===""?null:parseFloat(y),I=l.value||"available",v=r?.value.trim()||"";return u?d?p?g?Number.isNaN(m)||m<0?(k(f("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),s.focus(),null):P!=null&&(Number.isNaN(P)||P<0)?(k(f("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),o.focus(),null):{id:u,name:d,phone:p,email:b,role:g,department:A,dailyWage:Number.isFinite(m)?m:0,dailyTotal:P==null?null:Number(P),status:I,baseStatus:I,notes:v}:(k(f("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),a.focus(),null):(k(f("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(k(f("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(k(f("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Mi(){const e=xi();if(!e)return;const t=Lt({name:e.name,phone:e.phone,email:e.email||null,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await qt(e.id,t),k(f("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),H()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const i=Oe(n)?n.message:f("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");k(i,"error")}}function H(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Ze(t?.value||"");if(tt&&!It){const r=f("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}if(Me&&!It){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${Me}</td></tr>`;return}const i=mt(),{reservations:a=[]}=V(),c=new Date;Bi(i);const s=document.getElementById("technician-role-filter"),o=Ze(s?.value||""),l=i.filter(r=>o&&Ze(r.role||"")!==o?!1:n?Ze([r.name,r.phone,r.email,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const r=f("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}e.innerHTML=l.map(r=>{const u=U&&String(U)===String(r.id),b=(Dn(r.id,a,c)?"busy":r.status||r.baseStatus||"available")==="busy"?{label:f("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:f("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},g=f("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),A=f("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),S=In(),m=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${r.id}">${g}</button>`];return S&&m.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${r.id}">${A}</button>`),`
      <tr${u?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${r.id}" class="text-decoration-none">${r.name}</a></td>
        <td>${r.role||""}</td>
        <td>${r.department||"â€”"}</td>
        <td><span class="${b.className}"><span class="technician-status-badge__text">${b.label}</span></span></td>
        <td class="table-notes-cell">${r.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${m.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function pt(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function Bn(e="add"){const{submitBtn:t,cancelBtn:n}=pt(),i=e==="update";if(t){const a=i?"positions.form.actions.update":"positions.form.actions.submit",c=i?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=f(a,c)}n&&(n.classList.toggle("d-none",!i),n.textContent=f("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function zt(){const{form:e,idInput:t,nameArInput:n,nameEnInput:i,costInput:a,clientPriceInput:c}=pt();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),i&&(i.value=""),a&&(a.value=""),c&&(c.value=""),oe=null,Bn("add")}function ji(e){const{idInput:t,nameArInput:n,nameEnInput:i,costInput:a,clientPriceInput:c}=pt();!e||!a||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),i&&(i.value=e.labelEn||""),a.value=G(e.cost??0),c&&(c.value=e.clientPrice==null?"":G(e.clientPrice)),oe=e.id||null,Bn("update"))}function Vi(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:i}=pt();if(!n)return null;const a=e?.value.trim()||"",c=t?.value.trim()||"",s=c||a,o=oe?pe().find(p=>String(p.id)===String(oe)):null,l=G(n.value.trim());n.value=l;const r=l===""?0:parseFloat(l),u=i?G(i.value.trim()):"";i&&(i.value=u);const d=u===""?null:parseFloat(u);return s?!Number.isFinite(r)||r<0?(k(f("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):d!=null&&(!Number.isFinite(d)||d<0)?(k(f("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),i?.focus(),null):{id:oe,name:o?.name||s,cost:Number(r.toFixed(2)),clientPrice:d==null?null:Number(d.toFixed(2)),labelAr:a||null,labelEn:c||null}:(k(f("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function Ee(){const e=document.getElementById("technician-role");if(!e)return;const t=U?wn(U):null;wt(e.value,t||{})}function ue(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=pe();if(t&&(t.textContent=_(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${f("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(i=>{const a=oe&&String(oe)===String(i.id),c=at(i.cost||0),s=i.clientPrice==null?f("technicians.positionSummary.noClientPrice","â€”"):at(i.clientPrice),o=At(i,"ar")||"â€”",l=At(i,"en")||"â€”",r=f("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),u=f("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${a?' class="technician-table-row-editing"':""}>
        <td>${be(o)}</td>
        <td>${be(l)}</td>
        <td>${be(c)}</td>
        <td>${be(s)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${i.id}">${r}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${i.id}">${u}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function Hi(e){e.preventDefault();const t=Vi();if(t)try{const n=!!oe;n?await Ci(t.id,t):await ki(t);const i=n?f("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):f("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");k(i),zt(),ue(),Ke(),Ee()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const i=n?.message||f("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");k(i,"error")}}function Oi(){zt()}async function Ui(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Ue();const i=pe().find(a=>String(a.id)===String(n));if(!i){k(f("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}ji(i),ue();return}if(t.classList.contains("position-delete-btn")){if(!confirm(f("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await Ei(n),oe&&String(oe)===String(n)&&zt(),k(f("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),ue(),Ke(),Ee()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||f("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");k(n,"error")}}function Ki(e){const t=Tn().find(n=>String(n.id)===String(e));if(!t){k(f("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}wi(t),k(f("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function Qi(e){if(!In()){Ai();return}if(confirm(f("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await Nn(e),k(f("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),U&&String(U)===String(e)&&dt(),H()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=Oe(t)?t.message:f("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");k(n,"error")}}function so(){xt(),H()}function wn(e){return Tn().find(t=>String(t.id)===String(e))||null}function Wi(e){const t=new Set,n=a=>{if(a==null)return;const c=String(a).trim();c&&t.add(c)},i=a=>{Array.isArray(a)&&a.forEach(c=>{if(c!=null)if(typeof c=="object"){const s=c.id??c.technicianId??c.technician_id??(c.technician&&(c.technician.id??c.technician.technicianId??c.technician.technician_id));n(s)}else n(c)})};return i(e?.technicians),i(e?.techniciansDetails),Array.from(t)}function Gi(e){const t=e?.start??e?.startDatetime??e?.start_datetime??e?.start_date??null,n=e?.end??e?.endDatetime??e?.end_datetime??e?.end_date??null;return{start:t,end:n}}function Dn(e,t=[],n){const i=Ti(e);return i?t.some(a=>{if(!a)return!1;const c=String(a?.status||a?.reservationStatus||"").toLowerCase();if(c==="cancelled"||c==="canceled"||!Wi(a).includes(i))return!1;const{start:o,end:l}=Gi(a);if(!o||!l)return!1;const r=new Date(o),u=new Date(l);return Number.isNaN(r.getTime())||Number.isNaN(u.getTime())?!1:r<=n&&n<u}):!1}function mt(){const e=V().reservations||[],t=He();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let i=!1;const a=t.map(c=>{if(!c)return c;const s=c.baseStatus||c.status||"available";let o=s==="busy"?"busy":s;return Dn(c.id,e,n)&&(o="busy"),(o!==c.status||s!==c.baseStatus)&&(i=!0),{...c,baseStatus:s,status:o}});return i?(Be(a),a):t}document.addEventListener("reservations:changed",()=>{const e=He();if(mt()===e)try{H()}catch{}});document.addEventListener("reservations:updated",()=>{const e=He();if(mt()===e)try{H()}catch{}});function xt(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{$i(p).catch(b=>{console.error("âŒ [technicians] submit handler failed",b)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ri),n.dataset.listenerAttached="true"),ve(document.getElementById("technician-phone"),Ce);const i=document.getElementById("technician-role");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{Ee()}),i.dataset.listenerAttached="true");const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",p=>{const b=p.target;if(b instanceof HTMLElement){if(b.classList.contains("technician-edit-btn")){const g=b.dataset.id;Ki(g)}if(b.classList.contains("technician-delete-btn")){const g=b.dataset.id;Qi(g).catch(A=>{console.error("âŒ [technicians] delete handler failed",A)})}}}),a.dataset.listenerAttached="true");const c=document.getElementById("search-technician-input");c&&!c.dataset.listenerAttached&&(c.addEventListener("input",()=>{c.value=_(c.value),H()}),c.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{H()}),s.dataset.listenerAttached="true");const o=document.getElementById("save-technician-changes");o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{Mi().catch(p=>{console.error("âŒ [technicians] modal save failed",p)})}),o.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",p=>{Hi(p).catch(b=>{console.error("âŒ [technicians] position submit failed",b)})}),l.dataset.listenerAttached="true");const r=document.getElementById("position-cancel-btn");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",Oi),r.dataset.listenerAttached="true");const u=document.getElementById("positions-table");u&&!u.dataset.listenerAttached&&(u.addEventListener("click",Ui),u.dataset.listenerAttached="true"),ve(document.getElementById("position-cost"),G),ve(document.getElementById("position-client-price"),G);const d=document.querySelector("[data-tech-tabs]");d&&!d.dataset.listenerAttached&&(d.querySelectorAll("[data-tech-tab]").forEach(b=>{b&&b.addEventListener("click",()=>{const g=b.getAttribute("data-tech-tab");cn(g)})}),d.dataset.listenerAttached="true"),cn(Ie),Ue().then(()=>{Ke(),Ie==="technicians-positions"&&ue(),Ee()}).catch(p=>{console.error("âŒ [technicians] failed to load technician positions",p),k(p?.message||f("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),an||(document.addEventListener("technician:prefill",p=>{const b=p.detail;b&&zi(b)}),an=!0),t&&dt(),Ie==="technicians-positions"&&ue()}window.addEventListener("DOMContentLoaded",()=>{xt(),H(),Rt(),En()});const $n=()=>{H()};window.addEventListener("technicians:updated",$n);document.addEventListener("technicians:updated",$n);document.addEventListener("technicians:refreshRequested",()=>{xt(),H(),Rt(),En({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Rt(),Ke(),Ie==="technicians-positions"&&ue(),Ee()});document.addEventListener(Ii.USER_UPDATED,()=>{H()});const Rn=()=>{Ke(),Ie==="technicians-positions"&&ue(),Ee()};window.addEventListener("technicianPositions:updated",Rn);document.addEventListener("technicianPositions:updated",Rn);function ze(e){return _(String(e||"")).trim().toLowerCase()}function W(e){const t=String(e??"").trim().toLowerCase();return t||""}function Qe(){const{packages:e=[]}=V();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function ot(e){const t=W(e);return t&&Qe().find(i=>W(i?.id??i?.packageId??i?.package_id)===t)||null}function fe(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(o=>({barcode:o}))),n.forEach(o=>{if(!o)return;if(typeof o=="string"||typeof o=="number"){const p=ze(o);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof o!="object")return;const l=ze(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number),r=[o.equipmentId,o.equipment_id,o.itemId,o.item_id,o.id].find(p=>p!=null&&p!==""),u=[o.unit_price,o.unitPrice,o.price,o.daily_rate].find(p=>Number.isFinite(Number(p))),d=[o.quantity,o.qty,o.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:r!=null?String(r):null,barcode:o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??"",normalizedBarcode:l,qty:d!=null?Number(d):1,price:u!=null?Number(u):0,desc:o.description??o.desc??o.name??"",image:o.image??o.imageUrl??o.img??null})});const i=new Map,{equipment:a=[]}=V()||{},c=new Map,s=new Map;return(Array.isArray(a)?a:[]).forEach(o=>{if(!o||typeof o!="object")return;[o.id,o.equipment_id,o.equipmentId,o.item_id,o.itemId].map(u=>u!=null?String(u):"").filter(Boolean).forEach(u=>{c.has(u)||c.set(u,o)});const r=ze(o.barcode);r&&!s.has(r)&&s.set(r,o)}),t.forEach(o=>{if(o.equipmentId&&c.has(o.equipmentId)){const l=c.get(o.equipmentId);if(l){if(o.desc||(o.desc=l.desc||l.description||l.name||""),o.barcode||(o.barcode=l.barcode||""),o.price==null||o.price===0){const r=l.price??l.unit_price,u=Number(r);Number.isFinite(u)&&u>=0&&u<1e6&&(o.price=u)}o.image||(o.image=l.image||l.imageUrl||l.img||null)}}else if(o.normalizedBarcode&&s.has(o.normalizedBarcode)){const l=s.get(o.normalizedBarcode);if(l){if(o.desc||(o.desc=l.desc||l.description||l.name||""),o.barcode||(o.barcode=l.barcode||""),o.price==null||o.price===0){const r=l.price??l.unit_price,u=Number(r);Number.isFinite(u)&&u>=0&&u<1e6&&(o.price=u)}o.image||(o.image=l.image||l.imageUrl||l.img||null)}}}),t.forEach(o=>{const l=o.normalizedBarcode||(o.barcode?ze(o.barcode):""),r=l||(o.equipmentId?`id:${o.equipmentId}`:null);if(!r)return;if(!i.has(r)){i.set(r,{...o,normalizedBarcode:l});return}const u=i.get(r);u.qty+=o.qty,!u.price&&o.price&&(u.price=o.price),!u.desc&&o.desc&&(u.desc=o.desc),!u.image&&o.image&&(u.image=o.image)}),Array.from(i.values())}function zn(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const i of t){const a=Number(i);if(Number.isFinite(a))return a}return fe(e).reduce((i,a)=>i+(a.price||0)*(a.qty||1),0)}function xn(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Yi(){return Qe().map(t=>{const n=W(t?.id??t?.packageId??t?.package_id??t?.code),i=xn(t)||n||"package",a=zn(t);return{id:n,name:i,price:a,code:t?.package_code??t?.code??n,items:fe(t),raw:t}}).filter(t=>t.id)}function Ji(e){const t=ze(e);return t?Yi().filter(n=>n.items.some(i=>i.normalizedBarcode===t)):[]}function Zi(e){return fe(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let Te=[],Mn=[],jn=[],Vn="single";function ro(){return Te}function lo(e){Te=Array.isArray(e)?e:[]}function uo(e){Te=[...Te,e]}function po(e){Number.isInteger(e)&&e>=0&&(Te=Te.filter((t,n)=>n!==e))}function mo(){return Mn}function fo(e){Mn=Array.isArray(e)?e:[]}function go(){return jn}function ho(e){jn=Array.isArray(e)?e:[]}function yo(e){}function bo(){return Vn==="package"?"package":"single"}function _o(e){Vn=e==="package"?"package":"single"}function Io(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[i="",a=""]=n.split("T"),c=i?i.slice(0,10):"",s=a.match(/(\d{1,2}:\d{2})/);let o="";if(s){const[l="00",r="00"]=s[0].split(":");o=`${l.padStart(2,"0")}:${r.padStart(2,"0")}`}return{date:c,time:o}}function Xe(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function X(e){return _(String(e||"")).trim().toLowerCase()}const Xi=864e13;function se(e){if(!e&&e!==0)return null;if(e instanceof Date){const i=e.getTime();return Number.isNaN(i)?null:new Date(i)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const i=new Date(e);return Number.isNaN(i.getTime())?null:i}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const a=new Date(i);if(!Number.isNaN(a.getTime()))return a}}if(!t.includes("T")&&t.includes(" ")){const i=t.indexOf(" ");t=`${t.slice(0,i)}T${t.slice(i+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const i=new Date(`${t}Z`);if(!Number.isNaN(i.getTime()))return i}return null}function Ao(e,t,n,i=null){if(!e||!t||!n)return!1;const a=se(t),c=se(n);if(!a||!c||a>=c)return!1;const s=X(e);if(!s)return!1;const o=V()||{},l=Array.isArray(o.reservations)?o.reservations:[],r=Array.isArray(o.maintenance)?o.maintenance:[],u=Array.isArray(o.equipment)?o.equipment:[],d=la(u),p=Vt(i);return l.some(g=>{if(!g||Ht(g,p)||!g.start||!g.end)return!1;const A=String(g?.status||g?.reservationStatus||"").toLowerCase();if(A==="cancelled"||A==="canceled")return!1;const S=se(g.start),m=se(g.end);return!S||!m||!(S<c&&m>a)?!1:ta(g,s)})?!0:r.some(g=>{if(!aa(g)||!ca(g,d).has(s))return!1;const{start:S,end:m}=sa(g);if(!S&&!m)return!0;const y=S??new Date(0),P=m??new Date(Xi);return y<c&&P>a})}function ea(e,t,n,i=null){const a=W(e);if(!a||!t||!n)return!1;const c=se(t),s=se(n);if(!c||!s||c>=s)return!1;const o=V()||{},l=Array.isArray(o.reservations)?o.reservations:[],r=Vt(i);return l.some(u=>{if(!u?.start||!u?.end||Ht(u,r))return!1;const d=String(u?.status||u?.reservationStatus||"").toLowerCase();if(d==="cancelled"||d==="canceled")return!1;const p=se(u.start),b=se(u.end);return!p||!b||!(p<s&&b>c)?!1:na(u,a)})}function No(e,t,n,i=null){const a=X(e);if(!a||!t||!n)return[];const c=Ji(a);return c.length?c.filter(s=>ea(s.id,t,n,i)):[]}function Hn(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(i=>{const a=e[i];Array.isArray(a)&&a.length&&t.push(a)}),t}function ta(e,t){if(!t||!e||typeof e!="object")return!1;const n=X(e?.barcode);if(n&&n===t)return!0;const i=Hn(e);for(const a of i)for(const c of a)if(ia(c).has(t))return!0;return!1}function na(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const c of n){if(!c&&c!==0)continue;const s=W(c);if(s&&s===t)return!0}const i=e.packages;if(Array.isArray(i))for(const c of i){const s=W(c);if(s&&s===t)return!0}const a=Hn(e);for(const c of a)for(const s of c)if(Mt(s).has(t))return!0;return!1}function ia(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const c=X(e);return c&&t.add(c),t}if(typeof e!="object")return t;const n=X(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(c=>{const s=e[c];Array.isArray(s)&&s.forEach(o=>{if(o!=null){if(typeof o=="string"||typeof o=="number"){const l=X(o);l&&t.add(l);return}if(typeof o=="object"){const l=X(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number);l&&t.add(l)}}})});const a=Mt(e);return a.size&&a.forEach(c=>{const s=ot(c);if(!s)return;Zi(s).forEach(l=>{const r=l.normalizedBarcode??X(l.barcode);r&&t.add(r)})}),t}function Mt(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(i=>{const a=W(i);a&&t.add(a)}),e.package&&typeof e.package=="object"&&Mt(e.package).forEach(a=>t.add(a)),Array.isArray(e.packages)&&e.packages.forEach(i=>{const a=W(i);a&&t.add(a)}),t}function aa(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(ra(e))return!1;for(const n of t){const i=oa(n);if(i){if(i==="completed"||i==="cancelled"||i==="closed")return!1;if(i==="open"||i==="in_progress")return!0}}return!0}function oa(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function ca(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(s=>{const o=X(s);o&&n.add(o)});const a=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(a){const s=X(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number);s&&n.add(s)}return[e?.equipmentId,e?.equipment_id,a?.id,a?.equipmentId,a?.equipment_id].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{const o=t.get(s);if(!o)return;const l=X(o?.barcode??o?.equipmentBarcode??o?.code??o?.serial??o?.serialNumber??o?.serial_number);l&&n.add(l)}),n}function sa(e){const t=Nt([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=Nt([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function ra(e){return!!Nt([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function Nt(e=[]){for(const t of e){const n=se(t);if(n)return n}return null}function la(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(a=>a!=null?String(a):"").filter(Boolean).forEach(a=>{t.has(a)||t.set(a,n)})}),t}function jt(e,t,n,i=null){if(!e||!t||!n)return!1;const a=new Date(t),c=new Date(n);if(Number.isNaN(a.getTime())||Number.isNaN(c.getTime()))return!1;const{reservations:s=[]}=V(),o=String(e),l=Vt(i);return s.some(r=>{if(!r?.start||!r?.end||Ht(r,l))return!1;const u=String(r?.status||r?.reservationStatus||"").toLowerCase();if(u==="cancelled"||u==="canceled")return!1;const d=new Date(r.start),p=new Date(r.end);return Number.isNaN(d.getTime())||Number.isNaN(p.getTime())||!(d<c&&p>a)?!1:(Array.isArray(r.technicians)?r.technicians:[]).some(A=>String(A)===o)})}function Vt(e){return Pe(e,new Set)}function Ht(e,t){if(!t||t.size===0)return!1;const n=Pe([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const i of n)if(t.has(i))return!0;return!1}function Pe(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(c=>Pe(c,t)),t;if(Array.isArray(e))return e.forEach(c=>Pe(c,t)),t;if(typeof e=="object"){const c=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let s=!1;return c.forEach(o=>{Object.prototype.hasOwnProperty.call(e,o)&&(s=!0,Pe(e[o],t))}),s||Object.values(e).forEach(o=>Pe(o,t)),t}const n=_(String(e??"")).trim();if(!n)return t;const i=[n,n.toLowerCase(),n.toUpperCase()],a=n.replace(/\D+/g,"");if(a){i.push(a);const c=Number.parseInt(a,10);Number.isNaN(c)||i.push(String(c))}return i.forEach(c=>{c&&t.add(c)}),t}const ua=()=>f("reservations.create.summary.currency","SR");let qe=[],ae=[],re=[],le=[],D="create",On=()=>{},Un=()=>{};const nt=new Map,Pt=450;function da(e){const t=nt.get(e);return t!=null&&Date.now()-t<Pt}function pa(e){nt.set(e,Date.now()),setTimeout(()=>{const t=nt.get(e);t!=null&&Date.now()-t>=Pt&&nt.delete(e)},Pt+50)}function je(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ae(e={}){return{...e,assignmentId:e.assignmentId||je()}}function ft(e){if(!e)return null;const t=String(e),n=qe.find(a=>String(a?.id)===t);if(n)return{...n};const{technicians:i=[]}=V();return i.find(a=>String(a?.id)===t)||null}function Le(e={},t=Y()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Ot(e={},t=Y()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function Kn(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=ae.find(c=>String(c.id).trim().toLowerCase()===n);if(i)return i;const a=kn(e);return a||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function sn(e){const t=Kn(e,e?.name??""),n=Y(),i=Le(t,n)||t?.name||"",a=Ot(t,n);return St({assignmentId:je(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:a,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function St(e={}){const t={assignmentId:e.assignmentId||je(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=Kn(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=Y(),a=Le(n,i)||t.positionLabel,c=Ot(n,i);t.positionLabel=a||t.positionLabel||n?.name||"",t.positionLabelAlt=c||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=ft(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function we(){ae=pe()}function ma(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return Ae(St(t));const n=ft(t),i=n?{assignmentId:je(),positionLabel:n.role||f("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:je(),positionLabel:f("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return Ae(St(i))}).filter(Boolean):[]}function he(e="create"){return e==="edit"?le.map(Ae):re.map(Ae)}function de(e="create",t=[]){try{we()}catch{}const n=ma(t);e==="edit"?(le=n,Fe("edit-selected-technicians-list",le,"edit"),Un()):(re=n,Fe("selected-technicians-list",re,"create"),On()),Ve()}function Ut(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),r=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=o?Xe(o,r):null,p=l?Xe(l,u):null;let b=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const A=Number.parseInt(g,10);if(Number.isInteger(A)){const{reservations:S=[]}=V(),m=S?.[A];m&&(b=m.id??m.reservationId??null)}}return{start:d,end:p,ignoreReservationId:b}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00",c=t?Xe(t,i):null,s=n?Xe(n,a):null;return{start:c,end:s,ignoreReservationId:null}}function Ve(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=he(D).length;if(t){const n=f("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",_(String(t)));e.textContent=n}else e.textContent=f("technicians.picker.selectionInfo","No crew selected yet")}function ct(e){const t=Number.isFinite(e)?e:0;return`${_(t.toFixed(2))} ${ua()}`}function fa(e){const t=he(D),n=new Set(t.filter(r=>r.assignmentId!==e&&r.technicianId).map(r=>r.technicianId)),i=qe.length?qe:V().technicians||[],{start:a,end:c,ignoreReservationId:s}=Ut(D),o=!!(a&&c);return i.map(r=>{const u=String(r.id),d=n.has(u),p=o?jt(u,a,c,s):!1,b=_(r.name||r.full_name||r.fullName||r.email||u);return{id:u,label:b,disabled:d||p,conflict:p,taken:d}})}function ee(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=he(D);if(!t.length){const n=f("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=f("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}we(),e.innerHTML=t.map((n,i)=>{const a=_(String(i+1)),c=ct(n.positionClientPrice||0),s=fa(n.assignmentId),o=f("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),l=n.technicianId!=null?String(n.technicianId):"",r=n.technicianName?_(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,d=f("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),p=f("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),b=s.map(y=>{const P=l===y.id,v=y.disabled&&!P?`${y.label} ${y.conflict?p:d}`:y.label;return`
        <option value="${y.label}"
                data-id="${y.id}"
                data-disabled="${y.disabled?"true":"false"}"
                data-conflict="${y.conflict?"true":"false"}"
                data-taken="${y.taken?"true":"false"}"
                label="${v}"></option>
      `}).join("");let g=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!g||String(g).trim()===""){const y=n.positionId?ae.find(I=>String(I.id)===String(n.positionId)):null,P=!y&&n.positionKey?ae.find(I=>String(I.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(y||P){const I=y||P;g=Le(I,Y())||I?.name||""}}const A=n.positionLabelAlt?`<div class="text-muted small">${_(n.positionLabelAlt)}</div>`:"",S=f("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),m=f("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${a}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${_(g||f("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${A}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${m}">${c}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${o}"
              value="${l?r:""}"
              aria-label="${f("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${b}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${S}">
            ${S}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{Qn(n.dataset.assignmentId,D)}),n.dataset.listenerAttached="true")}),ga(e)}function ga(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,a=()=>{ha(n,i)};n.addEventListener("change",a),n.addEventListener("blur",a),n.dataset.listenerAttached="true"})}function ha(e,t){if(!t||da(t))return;pa(t);const n=e.value?.trim()??"";if(!n){et(t,"");return}const i=e.getAttribute("list"),a=i?document.getElementById(i):null,c=a?Array.from(a.options):[],s=_(n).toLowerCase(),o=c.find(r=>_(r.value).toLowerCase()===s);if(!o){k(f("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",et(t,"");return}if(o.dataset.disabled==="true"){o.dataset.conflict==="true"?k(f("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯")):k(f("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±")),e.value="";return}const l=o.dataset.id;if(!l){k(f("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",et(t,"");return}et(t,l)}function vt(){const e=document.getElementById("crew-position-list");if(!e)return;we();const t=document.getElementById("crew-position-search"),n=_(String(t?.value||"")).trim().toLowerCase(),a=he(D).reduce((o,l)=>{const r=l?.positionId!=null?String(l.positionId):null;return r&&o.set(r,(o.get(r)||0)+1),o},new Map),c=ae.filter(o=>n?[o.labelAr,o.labelEn,o.name].filter(Boolean).map(r=>_(String(r)).toLowerCase()).join(" ").includes(n):!0);if(!c.length){e.innerHTML=`<div class="text-muted">${f("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const s=Y();e.innerHTML=c.map(o=>{const l=Le(o,s)||o.name||"",r=Ot(o,s),u=ct(o.clientPrice||0),d=ct(o.cost||0),p=r?`<span class="crew-position-card__subtitle">${_(r)}</span>`:"",b=f("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=f("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),A=f("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),S=a.get(String(o.id))||0,m=f("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",_(String(S)));return`
      <article class="crew-position-card" data-position-id="${o.id}" tabindex="0" role="button" aria-label="${_(l)}">
        ${S>0?`<span class="crew-position-card__badge" aria-label="${m}">${_(String(S))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${_(l)}</h6>
            ${p}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${b}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary crew-position-add-btn" data-position-id="${o.id}">
            ${A}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.stopPropagation(),bt(o.dataset.positionId)}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(o=>{o.dataset.cardListenerAttached||(o.addEventListener("click",()=>{bt(o.dataset.positionId)}),o.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),bt(o.dataset.positionId))}),o.dataset.cardListenerAttached="true")})}function bt(e){we();const t=ae.find(a=>String(a.id)===String(e)),n=sn(t||{id:null,name:""}),i=he(D);i.push(n),de(D,i),ee(),k(f("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Qn(e,t="create"){if(!e)return;const n=he(t).filter(i=>i.assignmentId!==e);de(t,n),ee(),k(f("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function et(e,t){if(!e)return;const n=he(D),i=n.find(r=>r.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,de(D,n),ee(),k(f("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(n.find(r=>r.assignmentId!==e&&r.technicianId===t)){k(f("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),ee();return}const c=ft(t),{start:s,end:o,ignoreReservationId:l}=Ut(D);if(s&&o&&jt(String(t),s,o,l)){k(f("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯")),ee();return}c?(i.technicianId=String(c.id),i.technicianName=c.name??null,i.technicianRole=c.role??null,i.technicianPhone=c.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),de(D,n),ee(),i.technicianName?k(f("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",_(i.technicianName)),"success"):k(f("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function rn(e="create"){D=e,ee(),Ve();let t=mt();if(!Array.isArray(t)||t.length===0)try{const i=await rt();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(qe=t);try{await Ue()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}we(),vt(),ee(),Ve();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function ya(){return he(D).map(Ae)}function ba(){const e=ya(),{start:t,end:n,ignoreReservationId:i}=Ut(D);if(t&&n){const c=e.filter(s=>s.technicianId&&jt(s.technicianId,t,n,i));if(c.length>0){const s=c.map(l=>l.technicianName||l.technicianId).join(f("reservations.list.crew.separator","ØŒ ")),o=f("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",s);c.forEach(l=>{l.technicianId=null,l.technicianName=null}),de(D,e),ee(),k(o),Ve();return}}de(D,e);const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a)?.hide?.(),k(f("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function Fe(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${f("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}we(),i.innerHTML=t.map(a=>{let c=a.positionLabel??a.position_label??a.position_name??a.role??a.position??"";if(!c||String(c).trim()===""){const d=a.positionId?ae.find(b=>String(b.id)===String(a.positionId)):null,p=!d&&a.positionKey?ae.find(b=>String(b.name).toLowerCase()===String(a.positionKey).toLowerCase()):null;c=d?Le(d,Y())||d?.name||"":p&&(Le(p,Y())||p?.name)||""}const s=_(c||f("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),o=a.technicianName?`${_(a.technicianName)}`:f("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let l=Number(a.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[a.position_client_price,a.client_price,a.customer_price,a.daily_total,a.dailyTotal,a.total];for(const p of d){const b=Number(p);if(Number.isFinite(b)&&b>0){l=b;break}}}if((!Number.isFinite(l)||l<=0)&&(a.positionId||a.positionKey)){const d=a.positionId?ae.find(g=>String(g.id)===String(a.positionId)):null,p=!d&&a.positionKey?ae.find(g=>String(g.name).toLowerCase()===String(a.positionKey).toLowerCase()):null,b=d||p||null;b&&Number.isFinite(Number(b.clientPrice))&&(l=Number(b.clientPrice))}const r=ct(Number.isFinite(l)&&l>0?l:0),u=f("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${a.assignmentId}">
        <span class="technician-chip-name">${s}</span>
        <small class="technician-chip-role">${o}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${r}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${a.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",()=>{Qn(a.dataset.assignmentId,a.dataset.context)}),a.dataset.listenerAttached="true")})}}function _a(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",s=>{const o=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),r=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),p=!!(l&&r),b=!!(u&&d),g=!!o;if(!p||!b){s.preventDefault(),k(f("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){s.preventDefault(),k(f("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}rn("create")}),e.dataset.listenerAttached="true";const c=()=>{const s=document.getElementById("res-customer")?.value?.trim(),o=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),r=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(s&&o&&l&&r&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(s=>document.getElementById(s)).filter(Boolean).forEach(s=>{["input","change"].forEach(o=>s.addEventListener(o,c))}),c()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>rn("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{vt()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",ba),i.dataset.listenerAttached="true");const a=document.getElementById("selectTechniciansModal");a&&!a.dataset.listenerAttached&&window.bootstrap?.Modal&&(a.addEventListener("shown.bs.modal",async()=>{if(!qe.length&&(!V().technicians||V().technicians.length===0))try{await rt()}catch(c){console.warn("[crew-picker] fetch on show failed",c)}vt(),ee(),Ve()}),a.addEventListener("hidden.bs.modal",()=>{const c=document.getElementById("crew-position-search");c&&(c.value="")}),a.dataset.listenerAttached="true"),Fe("selected-technicians-list",re,"create"),Fe("edit-selected-technicians-list",le,"edit")}function Po({onDraftChange:e,onEditChange:t}={}){On=typeof e=="function"?e:()=>{},Un=typeof t=="function"?t:()=>{},_a()}function Ia(){return re.map(Ae)}function Aa(){return le.map(Ae)}function ln(){return re.map(e=>e.technicianId).filter(Boolean).map(String)}function un(){return le.map(e=>e.technicianId).filter(Boolean).map(String)}function So(e=[]){de("edit",e)}function vo(){de("create",[])}function ko(){de("edit",[])}function dn(e=[]){return e.map(t=>{if(t.technicianId){const n=ft(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function Co(e=[]){Array.isArray(e)&&e.length&&(qe=e),re=dn(re),le=dn(le),Fe("selected-technicians-list",re,"create"),Fe("edit-selected-technicians-list",le,"edit"),ee()}function pn(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Wn(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=_(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),a=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const c=t.includes(","),s=t.includes(".");if(c&&s){const l=t.lastIndexOf(","),r=t.lastIndexOf(".");l>r?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(c){const l=t.split(",");l.length===2&&l[1].length===3?t=l.join(""):t=t.replace(/,/g,".")}else if(s){const l=t.split(".");if(l.length===2){const[,r]=l;if(r.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(t=u)}}else l.length>2&&(t=pn(t))}if(t=t.replace(/,/g,""),t=pn(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const o=Number.parseFloat(t);return Number.isFinite(o)?a?-o:o:Number.NaN}function B(e){return Wn(e)}function x(e){const t=Wn(e);if(!Number.isFinite(t))return 0;let n=t,i=0;for(;Math.abs(n)>1e5&&i<8;)n/=10,i+=1;return Number(n.toFixed(2))}function xe(e){return _(String(e??"")).trim().toLowerCase()}function Gn(e=""){return _(String(e)).trim().toLowerCase()}const Na=2;function Pa(e){const t=B(e);return Number.isFinite(t)?t.toFixed(Na):"0.00"}function mn(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(_(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return x(i)}return 1}function Sa(e={}){const t=e?.desc||e?.description||e?.name||"",n=Gn(t),i=Pa(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function va(e=[]){const t=new Map;return e.forEach((n,i)=>{const a=Sa(n);if(!a)return;if(!t.has(a)){const s=n?.desc||n?.description||n?.name||"",o=Gn(s),l=gn(n),r=n?.image||n?.imageUrl||n?.img||"";t.set(a,{key:a,description:s,normalizedDescription:o,unitPrice:l,image:r,items:[],itemIndices:[],barcodes:[]})}const c=t.get(a);c.items.push(n),c.itemIndices.push(i),n?.barcode&&c.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,a)=>i+mn(a),0)})).map(n=>{const i=n.quantity||0,a=n.items.reduce((r,u)=>{const d=gn(u),p=mn(u);return r+d*p},0),c=x(a),s=B(n.unitPrice),o=Number.isFinite(s)?s:0,l=i>0?x(c/i):x(o);return{...n,quantity:i,count:i,totalPrice:c,unitPrice:l}})}function fn(e={}){return(fe(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??xe(n?.barcode),qty:(()=>{const i=Number.parseFloat(_(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),price:(()=>{const i=B(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})()}))}function kt(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(_(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function ka(e={},t=[],n=null){const i=e.unit_price??e.unitPrice??e.price,a=B(i);if(Number.isFinite(a)&&a>0)return x(a);const c=e.total_price??e.totalPrice??e.total,s=B(c),o=Number.parseFloat(_(String(n)).replace(/[^0-9.]/g,"")),l=Number.isFinite(o)&&o>0?o:kt(e);if(Number.isFinite(s)&&s>0&&l>0)return x(s/l);if(Array.isArray(t)&&t.length){const r=t.reduce((u,d)=>{const p=B(d.price??d.unit_price??d.unitPrice),b=Number.parseFloat(_(String(d.qty??d.quantity??1)).replace(/[^0-9.]/g,"")),g=Number.isFinite(b)&&b>0?b:1;return u+p*g},0);if(r>0&&l>0)return x(r/l)}return 0}function Eo(e={}){const t=Array.isArray(e?.items)?e.items:[],n=va(t),i=Qe(),a=new Set,c=new Map;i.forEach(m=>{const y=W(m?.id??m?.packageId??m?.package_id??m?.code);y&&a.add(y);const P=_(String(m?.package_code??m?.code??"")).trim().toLowerCase();P&&c.set(P,y||P)});const s=(m,y=0)=>{const P=W(m?.package_code??m?.packageId??m?.package_id??m?.code??m?.id??null),I=_(String(m?.package_code??m?.code??m?.barcode??"")).trim().toLowerCase();return P||(I&&c.has(I)?c.get(I):I||`pkg-${y}`)},o=new Map,l=(m,y=0,P="packages")=>{if(!m||typeof m!="object")return;const v=s(m,y)||`pkg-${y}`;if(!o.has(v)){o.set(v,{source:m,normalizedId:v,index:y,itemSource:P==="items"?m:null});return}const N=o.get(v);if(N.source||(N.source=m),P==="items"&&(N.itemSource=m,N.source&&typeof N.source=="object")){const E=Array.isArray(N.source.packageItems)&&N.source.packageItems.length>0,q=Array.isArray(m.packageItems)&&m.packageItems.length>0;!E&&q&&(N.source={...N.source,packageItems:m.packageItems}),!N.source.image&&m.image&&(N.source={...N.source,image:m.image})}};Array.isArray(e?.packages)&&e.packages.forEach((m,y)=>l(m,y,"packages")),t.forEach((m,y)=>{if(m&&typeof m=="object"&&(m.type==="package"||Array.isArray(m?.packageItems))){const P=s(m,y+o.size);l({...m,package_id:P,packageId:P,package_code:m.package_code??m.code},y+o.size,"items")}});const r=[],u=new Set,d=new Set;o.forEach(({source:m,itemSource:y=null,normalizedId:P},I)=>{const v=m||{},N=y&&typeof y=="object"?y:null;let E=fn(v);(!Array.isArray(E)||E.length===0)&&N&&(E=fn(N)),E.forEach(L=>{const Q=L?.normalizedBarcode??xe(L?.barcode);Q&&u.add(Q);const Ye=L?.equipmentId??L?.equipment_id??null;Ye!=null&&d.add(String(Ye))});let q=kt(v);if(N){const L=kt(N);Number.isFinite(L)&&L>0&&(q=L)}(!Number.isFinite(q)||q<=0)&&(q=1);let w=ka(v,E,q);const $=[N?.price,N?.unit_price,N?.unitPrice];for(const L of $){const Q=B(L);if(Number.isFinite(Q)&&Q>0){w=x(Q);break}}w=x(w);const h=[N?.total,N?.total_price,N?.totalPrice,v?.total,v?.total_price,v?.totalPrice];let R=NaN;for(const L of h){const Q=B(L);if(Number.isFinite(Q)&&Q>=0){R=Q;break}}Number.isFinite(R)||(R=w*q),R=x(R);const z=[v?.package_code,v?.code,v?.packageCode,v?.displayCode,v?.display_code,v?.barcode,N?.package_code,N?.code,N?.packageCode,N?.displayCode,N?.display_code,N?.barcode,P,I].find(L=>L==null?!1:String(L).trim().length>0),C=z!=null?_(String(z)).trim():"";if(C){const L=xe(C);L&&u.add(L)}const j=E.map(L=>_(String(L?.barcode??L?.normalizedBarcode??""))).filter(Boolean),O=[v?.name,v?.package_name,v?.title,N?.name,N?.desc,N?.package_name,C,_(String(I))].find(L=>L!=null&&String(L).trim()!=="")||_(String(C||I)),K=E.find(L=>L?.image)?.image??v?.image??N?.image??null;r.push({key:`package::${I}`,description:O,normalizedDescription:_(String(O)),unitPrice:w,totalPrice:R,quantity:q,count:q,image:K,barcodes:j,barcode:C,package_code:C,packageDisplayCode:C,items:[{type:"package",packageItems:E,packageId:P,desc:O,price:w,qty:q,barcode:C}],type:"package",packageItems:E,packageId:P})});const p=new Set(Array.from(u).map(m=>xe(m)).filter(Boolean)),b=n.filter(m=>!(m.items.some(I=>I?.type==="package")&&r.length>0||m.items.every(I=>{const v=Ca(I),N=v!=null?String(v):null;if(N&&d.has(N))return!0;const E=I?.barcode?xe(I.barcode):null;return!!(E&&p.has(E))}))),g=new Set,A=[];return r.forEach(m=>{const y=s({package_code:m?.package_code,packageId:m?.packageId,package_id:m?.packageId,code:m?.barcode,id:m?.packageId});!y||g.has(y)||(g.add(y),A.push(m))}),{groups:A.length?[...A,...b]:n,packageGroups:r,groupedItems:n,filteredGroupedItems:b,packagesMap:o}}function Ca(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function gn(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=B(n);if(Number.isFinite(i))return i}return 0}function To(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Ea(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function qo(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,a=i!=null&&i!==""&&i!=="null",c=a?Ea(t?.status??t?.status_label??t?.statusLabel??""):null,s=a&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(c));return{reservationConfirmed:n,projectLinked:a,projectStatus:c,projectConfirmed:s,effectiveConfirmed:a?s:n}}const Yn=10;function Jn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=B(n);if(Number.isFinite(i))return x(i)}return 0}function Ta(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=B(n);if(Number.isFinite(i))return x(i)}return Jn(e)}function qa(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=V();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,a)=>{const c=n.get(String(a));if(!c)return i;const s=Jn(c),o=Ta(c);return{costPerDay:i.costPerDay+(Number.isFinite(s)?s:0),totalPerDay:i.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const La=1440*60*1e3,Se=.01;function Ne(e){if(e==null||e==="")return null;const t=_(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function hn(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let a=Number.isFinite(e)?e:0;if(a<t&&(a=t),a>n&&(a=n),i!=null){const c=10**i;a=Math.round(a*c)/c}return a}function Zn(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function Kt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:a=null,history:c=[]}={}){const s=Number.isFinite(Number(e))?Number(e):0,o=t==="amount"?"amount":t==="percent"?"percent":null;let l=Ne(i),r=Ne(a);const u=Ne(n);let d=0,p=0;Array.isArray(c)&&c.length&&c.forEach(y=>{if(!y)return;const P=y.type==="amount"||y.type==="percent"?y.type:null,I=Ne(y.value),v=Ne(y.amount),N=Ne(y.percentage);if(P==="amount"){const E=v??I;E!=null&&(d+=E,s>0&&(p+=E/s*100))}else if(P==="percent"){const E=N??I;E!=null&&(p+=E,s>0&&(d+=E/100*s))}else v!=null&&(d+=v,s>0&&(p+=v/s*100)),N!=null&&(p+=N,s>0&&(d+=N/100*s))});function b(y=[]){return!Array.isArray(y)||y.length===0?{costPerDay:0,totalPerDay:0}:y.reduce((P,I)=>{const v=B(I?.positionCost??I?.position_cost??I?.cost??I?.dailyWage??I?.daily_wage??0),N=B(I?.positionClientPrice??I?.position_client_price??I?.clientPrice??I?.dailyTotal??I?.daily_total??I?.total??0),E=Number.isFinite(v)?v:0,q=Number.isFinite(N)?N:0;return{costPerDay:P.costPerDay+E,totalPerDay:P.totalPerDay+q}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=b),o==="amount"&&u!=null?l=u:o==="percent"&&u!=null?r=u:o===null&&u!=null&&(r!=null?r=u:l=u),(l==null||l<=0)&&r!=null&&r>0&&s>0&&(l=s*(r/100)),(r==null||r<=0)&&l!=null&&l>0&&s>0&&(r=l/s*100);const g=l??0,A=r??0;l=g+d,r=A+p,l=hn(l??0,{min:0,max:s>0?s:Number.POSITIVE_INFINITY,precision:2}),r=hn(r??0,{min:0,max:100,precision:2});let S=o;return S||(l>0&&s>0?S="amount":r>0&&(S="percent")),{paidAmount:l,paidPercent:r,paymentProgressType:S,paymentProgressValue:S==="amount"?l:S==="percent"?r:null}}function Qt({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const a=Zn(e),c=Number.isFinite(Number(i))?Number(i):0,s=Number.isFinite(Number(t))?Number(t):0,o=Number.isFinite(Number(n))?Number(n):0;if(a==="paid")return"paid";const l=c>0&&s>=c-Se,r=o>=100-Se*100;if(l||r)return"paid";const u=s>Se||o>Se;return a==="partial"||u?"partial":"unpaid"}function Fa(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const a=i.getTime()-n.getTime();if(a<=0)return 1;const c=a/La;return Math.max(1,Math.ceil(c))}function De({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:a="percent",applyTax:c=!1,start:s=null,end:o=null,companySharePercent:l=null}={}){const r=Fa(s,o),u=(e||[]).reduce((z,C)=>{const j=B(C?.qty??C?.quantity??C?.count??1),T=Number.isFinite(j)&&j>0?j:1,O=B(C?.price??C?.unit_price??C?.unitPrice),K=Number.isFinite(O)?O:0;return z+T*K},0),d=x(u*r),p=Array.isArray(n)?n:[],b=p.length?p.map(z=>z?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:g,totalPerDay:A}=p.length?p.reduce((z,C)=>{const j=B(C?.positionCost??C?.position_cost??C?.cost??C?.dailyWage??C?.daily_wage??0),T=B(C?.positionClientPrice??C?.position_client_price??C?.clientPrice??C?.dailyTotal??C?.daily_total??C?.total??0),O=Number.isFinite(j)?j:0,K=Number.isFinite(T)?T:0;return{costPerDay:z.costPerDay+O,totalPerDay:z.totalPerDay+K}},{costPerDay:0,totalPerDay:0}):qa(b),S=x(A*r),m=x(g*r),y=x(d+S),P=Number(i)||0;let I=a==="amount"?P:y*(P/100);(!Number.isFinite(I)||I<0)&&(I=0),I>y&&(I=y);const v=Math.max(0,y-I);let N=Number.isFinite(l)?Number(l):null;c&&(!Number.isFinite(N)||N<=0)&&(N=Yn);const E=N&&N>0?N:0,q=E>0?Math.max(0,v*(E/100)):0,w=v+q;let $=c?w*.15:0;(!Number.isFinite($)||$<0)&&($=0),$=Number($.toFixed(2));const h=w+$,R=Math.max(0,Number(h.toFixed(2))),ne=Math.max(0,Math.max(0,d+S-I)-m);return{rentalDays:r,equipmentTotal:d,crewTotal:S,crewCostTotal:m,discountAmount:I,subtotalAfterDiscount:v,taxableAmount:w,taxAmount:$,finalTotal:R,companySharePercent:E,companyShareAmount:q,netProfit:ne}}function Lo(e=[],t=0,n="percent",i=!1,a=[],{start:c=null,end:s=null,companySharePercent:o=null}={}){const l=p=>p&&typeof p=="object"&&(p.positionId!==void 0||p.position_id!==void 0||p.positionLabel!==void 0||p.position_name!==void 0||p.positionClientPrice!==void 0),r=Array.isArray(a)&&a.some(l)?a:[],u=r.length?r.map(p=>p?.technicianId).filter(Boolean):Array.isArray(a)?a:[];return De({items:e,technicianIds:u,crewAssignments:r,discount:t,discountType:n,applyTax:i,start:c,end:s,companySharePercent:o}).finalTotal}function Xn({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:a,paymentStatus:c,paidAmount:s=0,paidPercent:o=0,companySharePercent:l=null,companyShareAmount:r=null,taxAmount:u=null,netProfit:d=null,totalKey:p="reservations.summary.total",equipmentTotal:b=null,crewTotal:g=null}){const A=f("reservations.create.summary.currency","SR"),S=_(String(e)),m=_(String(t)),y=_(String(n??1)),P=_(String(i)),I=Zn(c),v=I==="paid"?"Ù…Ø¯ÙÙˆØ¹":I==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",N=f(`reservations.create.paymentStatus.${I}`,v),E=Number.isFinite(Number(s))?Math.max(0,Number(s)):0,q=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,w=E>Se||q>Se,$=f("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),h=_(E.toFixed(2)),R=_(q.toFixed(q%1?2:0)),ne=f("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),z=f("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),C=f("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),j=f("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),T=f("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),O=f("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),K=f("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),L=f(p.replace(".total",".totalLabel"),"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©"),Q=f("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),Ye=f("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),yt=Number.isFinite(d)?Math.max(0,Number(d)):null,me=[{label:ne,value:m},{label:z,value:y},{label:C,value:P}],Xt=Number.isFinite(Number(b))?Math.max(0,Number(b)):null;Xt!=null&&me.push({label:j,value:`${_(Xt.toFixed(2))} ${A}`});const en=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(en!=null&&me.push({label:T,value:`${_(en.toFixed(2))} ${A}`}),a){let ce=f("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(ce=`${_(Number(u).toFixed(2))} ${A}`),me.push({label:O,value:ce})}const Je=Number.isFinite(l)?Number(l):null;if(Je!==null&&Je>0){const ce=Number.isFinite(r)?Number(r):e*(Je/100),$e=_(String(Je)),mi=_(Number.isFinite(ce)?ce.toFixed(2):"0"),fi=`${$e}% (${mi} ${A})`;me.push({label:Q,value:fi})}if(yt!==null&&Math.abs(yt-Number(e))>.009){const ce=_(yt.toFixed(2));me.push({label:Ye,value:`${ce} ${A}`})}me.push({label:K,value:N}),w&&me.push({label:$,value:`${h} ${A} (${R}%)`});const pi=`${S} ${A}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${me.map(({label:ce,value:$e})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${ce}</span>
            ${$e?`<span class="reservation-summary-value">${$e}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${L}</span>
          <span class="reservation-summary-value">${pi}</span>
        </div>
      </div>
    </div>
  `}function Ba({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:c=null,paymentProgressValue:s=null,start:o,end:l,companySharePercent:r=null,paymentHistory:u=[]}){const d=Ia(),p=typeof ln=="function"?ln()??[]:[],b=Array.isArray(p)?p.map(String):[],g=d.length?d.map(N=>N?.technicianId).filter(Boolean).map(String):b,A=d.length||g.length,S=Number.isFinite(r)?Number(r):null,m=De({items:e,technicianIds:g,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:o,end:l,companySharePercent:S}),y=Kt({totalAmount:m.finalTotal,progressType:c,progressValue:s,history:u}),P=Qt({manualStatus:a,paidAmount:y.paidAmount,paidPercent:y.paidPercent,totalAmount:m.finalTotal}),I=Xn({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:A,applyTax:i,paymentStatus:P,paidAmount:y.paidAmount,paidPercent:y.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit,equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal}),v={paymentStatus:P,paidAmount:y.paidAmount,paidPercent:y.paidPercent,paymentProgressType:y.paymentProgressType,paymentProgressValue:y.paymentProgressValue,total:m.finalTotal};return Ba.lastResult=v,Da(I),I}function wa({items:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:c=null,paymentProgressValue:s=null,start:o,end:l,companySharePercent:r=null,paymentHistory:u=[]}){const d=Aa(),p=typeof un=="function"?un()??[]:[],b=Array.isArray(p)?p.map(String):[],g=d.length?d.map(N=>N?.technicianId).filter(Boolean).map(String):b,A=d.length||g.length,S=Number.isFinite(r)?Number(r):null,m=De({items:e,technicianIds:g,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:o,end:l,companySharePercent:S}),y=Kt({totalAmount:m.finalTotal,progressType:c,progressValue:s,history:u}),P=Qt({manualStatus:a,paidAmount:y.paidAmount,paidPercent:y.paidPercent,totalAmount:m.finalTotal}),I=Xn({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:A,applyTax:i,paymentStatus:P,paidAmount:y.paidAmount,paidPercent:y.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal}),v={html:I,paymentStatus:P,paidAmount:y.paidAmount,paidPercent:y.paidPercent,paymentProgressType:y.paymentProgressType,paymentProgressValue:y.paymentProgressValue,total:m.finalTotal};return wa.lastResult=v,I}function Da(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,yn(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,yn(n,e))}function yn(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const $a=V()||{};let ie=($a.reservations||[]).map(oi);function ye(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const ei="__reservation_packages_cache__";function ti(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function ni(){const e=ti();if(!e)return{};try{const t=e.getItem(ei);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function bn(e){const t=ti();if(t)try{t.setItem(ei,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function Ra(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=Qe();if(!Array.isArray(t)||t.length===0)return[];const n=new Map;e.forEach(a=>{if(!a||typeof a!="object")return;const c=a.equipmentId??a.equipment_id??a.id??null;if(c==null)return;const s=String(c),o=(()=>{const l=[a.qty,a.quantity,a.count,1];for(const r of l){const u=Number(r);if(Number.isFinite(u)&&u>0)return u}return 1})();n.set(s,(n.get(s)||0)+o)});const i=[];return t.forEach((a,c)=>{const s=fe(a)||[],o=new Map;let l=!0;if(s.forEach(g=>{const A=g?.equipmentId??g?.equipment_id??null,S=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(A==null){l=!1;return}const m=String(A);o.set(m,(o.get(m)||0)+S)}),!l||o.size===0)return;let r=1/0;for(const[g,A]of o.entries()){const S=n.get(g)||0,m=Math.floor(S/A);if(m<=0){r=0;break}m<r&&(r=m)}if(!Number.isFinite(r)||r<=0)return;for(const[g,A]of o.entries()){const S=n.get(g)||0;n.set(g,Math.max(0,S-r*A))}const u=W(a?.id??a?.packageId??a?.package_id??a?.code),d=Array.from(o.entries()).map(([g,A])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:A,unit_price:0})),p=(a?.package_code??a?.code??u)||`pkg-${c}`,b=xn(a)||u||`package-${c}`;i.push({package_code:p,name:b,quantity:r,unit_price:zn(a)||0,items:d})}),i}function za(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,a=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",c=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,s=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return i||a||c||s})}function xa(e){return[]}function ii(e=[]){return Array.isArray(e)?e.map((t,n)=>di(t,n)).filter(Boolean).map((t,n)=>{const i=W(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),a=st(t,i).map(r=>{const u=M(r.qty??r.quantity??r.count??r.units??r.unit_qty??r.unitQty??r.unit_count??r.unitCount??r.package_quantity??r.packageQty??1),d=ye(F(r.price??r.unit_price??0));return{...r,qty:u,quantity:u,price:d,unit_price:d}}),c=M(t.quantity??t.qty??1);let s=ye(F(t.unit_price??t.unitPrice??t.price??0));if(!s||s<=0){const r=a.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);r>0&&c>0&&(s=ye(Number((r/c).toFixed(2))))}const o=F(t.total_price??t.totalPrice??t.total??s*c),l=o>0?ye(o):ye(Number((s*c).toFixed(2)));return{...t,packageId:i,package_id:i,qty:c,quantity:c,unit_price:s,unitPrice:s,price:s,total_price:l,total:l,packageItems:a}}):[]}function We(e,t){if(!e)return;const n=ni(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],bn(n));return}n[i]=ii(t),bn(n)}function Ma(e){if(!e)return[];const t=ni(),n=String(e),i=t[n];return Array.isArray(i)?ii(i):[]}function Wt(e,t=0){if(e==null)return null;if(typeof e!="object"){const P=e!=null?String(e):null;return{assignmentId:`crew-${t}-${P??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:P,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,a=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,c=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let s=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";s||(s=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const o=e.position_label_ar??null,l=e.position_label_en??null,r=e.position_label_alt??l??o??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,p=ye(B(u)),b=ye(B(d)),g=e&&typeof e.technician=="object"?e.technician:null,A=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,S=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,m=e.role??g?.role??e.specialization??null,y=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(n),positionId:a!=null?String(a):null,positionKey:c!=null?String(c):null,positionLabel:s!=null?String(s):"",positionLabelAlt:r!=null?String(r):"",positionLabelAr:o!=null?String(o):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(p)?p:0,positionClientPrice:Number.isFinite(b)?b:0,technicianId:A!=null?String(A):null,technicianName:S!=null?String(S):null,technicianRole:m!=null?String(m):null,technicianPhone:y!=null?String(y):null,notes:e.notes??null}}function ja(){return ie}function Ge(e){ie=Array.isArray(e)?e.map(ht):[],ie.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;We(n,t.packages);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];za(i)}),ie.length?console.debug("[reservationsService] setReservationsState first paymentHistory",ie[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),_n({reservations:ie});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return ie}async function Va(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),a=(await Z(`/reservations/${n?`?${n}`:""}`))?.data;let c=[];Array.isArray(a)?c=a:a&&typeof a=="object"&&(Array.isArray(a.items)?c=a.items:Array.isArray(a.results)?c=a.results:Array.isArray(a.data)?c=a.data:Array.isArray(a.records)&&(c=a.records));const s=c.map(gt);return Ge(s)}async function Ha(e){const t=await Z("/reservations/",{method:"POST",body:e}),n=gt(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const i=Gt(e.payment_history);i.length&&(n.paymentHistory=i)}if((!Array.isArray(n.crewAssignments)||n.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const i=e.technicians.map((a,c)=>Wt(a,c)).filter(Boolean);i.length&&(n.crewAssignments=i,n.techniciansDetails=i.map((a,c)=>{const s=e.technicians[c];return typeof s=="object"?{...s,...a}:a}))}if(Array.isArray(e?.packages)&&e.packages.length){const i=Zt({packages:e.packages});n.packages=ge(n.packages,i)}{const i=Jt(n.items||[],n.packages||[]);n.items=i.items,n.packages=ge(n.packages||[],i.packages)}if(We(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const i=De({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=i.companyShareAmount,n.cost=i.finalTotal,n.totalAmount=i.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Ge([...ie,n]),n}async function ai(e,t){const n=await Z(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=gt(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const c=Gt(t.payment_history);c.length&&(i.paymentHistory=c,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const c=t.technicians.map((s,o)=>Wt(s,o)).filter(Boolean);c.length&&(i.crewAssignments=c,i.techniciansDetails=c.map((s,o)=>{const l=t.technicians[o];return typeof l=="object"?{...l,...s}:s}))}if(Array.isArray(t?.packages)&&t.packages.length){const c=Zt({packages:t.packages});i.packages=ge(i.packages,c)}{const c=Jt(i.items||[],i.packages||[]);i.items=c.items,i.packages=ge(i.packages||[],c.packages)}if(We(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const c=De({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=c.companyShareAmount,i.cost=c.finalTotal,i.totalAmount=c.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const a=ie.map(c=>String(c.id)===String(e)?i:c);return Ge(a),i}async function Oa(e){await Z(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=ie.filter(n=>String(n.id)!==String(e));Ge(t),We(e,null)}async function Ua(e){return ai(e,{status:"confirmed",confirmed:!0})}function gt(e={}){return ht({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function oi(e={}){return ht(e)}function ht(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(ci):[],a=Zt(e);const c=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let s=c.map((T,O)=>Wt(T,O)).filter(Boolean),o=s.map((T,O)=>{const K=c?.[O];return{...K&&typeof K=="object"?{...K}:K!=null?{id:K}:{},...T}});const l=s.map(T=>T.technicianId).filter(T=>T!=null&&T!=="").map(T=>Number.isNaN(Number(T))?String(T):Number(T)),r=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=F(e.total_amount??e.totalAmount??e.cost??0);const p=F(e.discount??0),b=e.discount_type??e.discountType??"percent",g=["percent","amount"].includes(b)?b:"percent",A=!!(e.apply_tax??e.applyTax??!1);let S=eo(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const m=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),y=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,P=y!=null?Number.parseFloat(_(String(y).replace("%","").trim())):NaN,I=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let v=I!=null?I===!0||I===1||I==="1"||String(I).toLowerCase()==="true":Number.isFinite(P)&&P>0,N=v&&Number.isFinite(P)?Number(P):0;const E=e.company_share_amount??e.companyShareAmount;let q=Number.isFinite(Number(E))?Number(E):NaN;A&&N<=0&&(N=Yn,v=!0);const w=De({items:i,technicianIds:l,crewAssignments:s,discount:p,discountType:g,applyTax:A,start:r,end:u,companySharePercent:N>0?N:null});(!Number.isFinite(d)||d<=0||A)&&(d=w.finalTotal),(!Number.isFinite(q)||q<0)&&(q=w.companyShareAmount),q=Number.isFinite(q)?Number(q.toFixed(2)):0,!v&&N>0&&(v=!0);const $=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],h=Qa($),R=Gt(h),ne=t??n??e.reservation_code??e.reservationId??null;if(a.length)We(ne,a);else{const T=Ma(ne);T.length&&(a=ge(a,T))}if(!a.length&&Array.isArray(i)&&i.length)try{const T=Ra(i);Array.isArray(T)&&T.length&&(a=ge(a,T))}catch(T){console.warn("[reservationsService] inference of packages from items failed",T)}const z=Jt(i,a);i=z.items,a=ge(a,z.packages);const C=Kt({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:R});S=Qt({manualStatus:S,paidAmount:C.paidAmount,paidPercent:C.paidPercent,totalAmount:d});const j=S==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:u,status:Xa(e.status??(m?"confirmed":"pending")),confirmed:m,location:e.location??"",notes:e.notes??"",discount:p,discountType:g,applyTax:A,paid:j,paidStatus:S,paidAmount:C.paidAmount,paidPercent:C.paidPercent,paymentProgressType:C.paymentProgressType,paymentProgressValue:C.paymentProgressValue,paymentHistory:R,payment_history:R,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:s,techniciansDetails:o,startDatetime:r,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:a,companySharePercent:N,companyShareAmount:q,companyShareEnabled:v}}function ci(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=F(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),a=_(String(e.barcode??e.code??e.serial??"")),c=e.description??e.desc??e.name??e.title??"",s={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:a,desc:c,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},o=si(e.type??e.item_type??e.kind??null),l=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,r=J(l),u=st(e,r);if(o==="package"||r||u.length){s.type="package";const d=r||(t!=null?String(t):s.id?J(s.id):"");d&&(s.packageId=d,s.package_id=d,s.package_code=e.package_code??e.packageCode??d),s.name=c||s.package_code||d||"",s.barcode=s.barcode||_(String(e.package_code??e.packageCode??"")),s.packageItems=u;const p=li({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},u,n);(!Number.isFinite(s.price)||s.price<=0||s.price>p*10)&&(s.price=p),s.qtyPerPackage=u.length?u[0]?.qtyPerPackage??s.qtyPerPackage:s.qtyPerPackage,s.totalQuantity=n}return s}function Ka({reservationCode:e,customerId:t,start:n,end:i,status:a,title:c,location:s,notes:o,projectId:l,totalAmount:r,discount:u,discountType:d,applyTax:p,paidStatus:b,confirmed:g,items:A,packages:S,crewAssignments:m=[],technicians:y=m,companySharePercent:P,companyShareEnabled:I,paidAmount:v,paidPercentage:N,paymentProgressType:E,paymentProgressValue:q,paymentHistory:w}){const $=Array.isArray(m)?m:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:a??"pending",title:c??null,location:s??null,notes:o??null,project_id:l||null,total_amount:r??0,discount:u??0,discount_type:d??"percent",apply_tax:p?1:0,paid_status:b??"unpaid",paid_amount:Number.isFinite(v)?F(v):0,paid_percentage:Number.isFinite(N)?Number(N.toFixed(2)):0,payment_progress_type:E??null,payment_progress_value:Number.isFinite(q)?Number(q.toFixed(2)):null,payment_history:Array.isArray(w)?w.map(h=>({type:Ct(h?.type??h?.payment_type??h?.method??h?.paymentMethod),value:h?.value!=null?F(h.value):null,amount:h?.amount!=null?F(h.amount):h?.payment_amount!=null?F(h.payment_amount):null,percentage:h?.percentage!=null?Number(h.percentage):h?.payment_percentage!=null?Number(h.payment_percentage):null,note:h?.note??h?.notes??h?.comment??h?.payment_note??null,recorded_at:h?.recordedAt??h?.recorded_at??h?.createdAt??h?.created_at??h?.payment_date??h?.date??new Date().toISOString()})):[],payments:Array.isArray(w)?w.map(h=>({type:Ct(h?.type??h?.payment_type??h?.method??h?.paymentMethod),value:h?.value!=null?F(h.value):null,amount:h?.amount!=null?F(h.amount):h?.payment_amount!=null?F(h.payment_amount):null,percentage:h?.percentage!=null?Number(h.percentage):h?.payment_percentage!=null?Number(h.payment_percentage):null,note:h?.note??h?.notes??h?.comment??h?.payment_note??null,recorded_at:h?.recordedAt??h?.recorded_at??h?.createdAt??h?.created_at??h?.payment_date??h?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:Wa(A),packages:Ga(A,S),company_share_percent:I&&Number.isFinite(P)?Number(P):null,company_share_enabled:I?1:0,technicians:$.length?$.map((h,R)=>{const ne=h.technicianId??h.technician_id??h.id??null,z=h.positionId??h.position_id??h.position??h.position_code??null,C=h.positionLabel??h.position_name??h.role??null,j=F(h.positionCost??h.position_cost??h.cost??h.daily_wage??h.dailyWage??0),T=F(h.positionClientPrice??h.position_client_price??h.client_price??h.clientPrice??h.daily_total??h.dailyTotal??h.total??0);return{id:ne,technician_id:ne,role:C??h.technicianRole??null,notes:h.notes??null,position_id:z,position_key:h.positionKey??h.position_key??null,position_name:C,position_label_ar:h.positionLabelAr??h.position_label_ar??null,position_label_en:h.positionLabelEn??h.position_label_en??null,position_cost:j,position_client_price:T,client_price:T,cost:j,assignment_id:h.assignmentId??h.assignment_id??`crew-${R}`}}):Array.isArray(y)?y.map(h=>typeof h=="object"&&h!==null?{id:h.id??h.technician_id??h.technicianId??h.ID,role:h.role??null,notes:h.notes??null}:Number.isNaN(Number(h))?String(h):Number(h)):[]}}function Gt(e){const t=Yt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,a=Ct(i),c=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,s=c!=null?Number.parseFloat(_(String(c))):null,o=n.amount!=null?Number.parseFloat(_(String(n.amount))):n.payment_amount!=null?Number.parseFloat(_(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(_(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(_(String(n.payment_percentage))):null,r=Number.isFinite(o)?o:a==="amount"&&Number.isFinite(s)?s:null,u=Number.isFinite(l)?l:a==="percent"&&Number.isFinite(s)?s:null,d=a??(r!=null?"amount":u!=null?"percent":null),p=d==="amount"?r:d==="percent"?u:Number.isFinite(s)?s:null,b=n.note??n.notes??n.comment??n.payment_note??null,g=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:p,amount:r,percentage:u,note:b,recordedAt:g}}).filter(n=>n&&n.type)}function Ct(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Yt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const s of t)if(Array.isArray(e[s]))return e[s];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(s=>Array.isArray(s));if(Array.isArray(i))return i;const a=Object.values(e);if(a.length&&a.every(s=>s&&typeof s=="object")){const s=a.map(o=>o);if(s.every(o=>!Array.isArray(o)))return s}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(s=>s in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Yt(t)}catch{return[]}return[]}function Qa(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Yt(t);if(Array.isArray(n)&&n.length)return n}return[]}function Wa(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const a=M(n.qty??n.quantity??1);n.packageItems.forEach(c=>{const s=c?.equipmentId??c?.equipment_id??c?.id??null;if(s==null)return;const o=M(c?.qty??c?.quantity??1),l=a*o;t.push({equipment_id:Et(s),quantity:l,unit_price:F(c?.price??c?.unit_price??0),notes:c?.notes??null})});return}const i=n.equipmentId??n.equipment_id??n.id??null;i!=null&&t.push({equipment_id:Et(i),quantity:M(n.qty??n.quantity??1),unit_price:F(n.price??n.unit_price??0),notes:n.notes??null})}),t}function Et(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function Ga(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const a=M(i.qty??i.quantity??1),c=Array.isArray(i.packageItems)?i.packageItems.map(s=>{const o=s?.equipmentId??s?.equipment_id??s?.id??null;return o==null?null:{equipment_id:Et(o),quantity:M(s?.qty??s?.quantity??s?.count??s?.units??s?.unit_qty??s?.unitQty??s?.unit_count??s?.unitCount??s?.package_quantity??s?.packageQty??1),unit_price:F(s?.price??s?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:a,unit_price:F(i.price??i.unit_price??0),items:c})}),n}function si(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function J(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return W(t)}function Tt(e){return e==null?"":_(String(e)).trim().toLowerCase()}function ri(e={},t=1){if(!e||typeof e!="object"){const l=_(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:l,normalizedBarcode:Tt(l),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=F(e.unit_price??e.unitPrice??e.price??0),c=_(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),s=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let o;if(s!=null)o=M(s,{fallback:1,max:99});else if(t>0){const l=i/t;Number.isFinite(l)&&l>0&&Number.isInteger(l)?o=M(l,{fallback:1,max:99}):o=Math.min(i,99)}else o=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:o,quantity:o,qtyPerPackage:o,totalQuantity:i,price:a,unit_price:a,barcode:c,normalizedBarcode:Tt(e.normalizedBarcode??c),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function Ya(e={},t={}){const n=J(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=M(e.quantity??e.qty??t.qty??t.quantity??1,{fallback:1,max:9999}),a=F(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),c=_(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:c,desc:t.desc??t.description??e.name??e.desc??e.title??c,qty:i,quantity:i,price:a,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:c,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function Jt(e=[],t=[]){const n=Ja(e),i=Array.isArray(t)?ge(t,n.packages):n.packages,a=new Map;return i.forEach(c=>{const s=J(c.packageId??c.package_id??c.id);s&&a.set(s,c)}),n.packages.forEach(c=>{const s=J(c.packageId??c.package_id??c.id);if(!s)return;const o=a.get(s);o&&((!Array.isArray(o.packageItems)||o.packageItems.length===0)&&(o.packageItems=c.packageItems),!o.name&&c.name&&(o.name=c.name),!o.image&&c.image&&(o.image=c.image))}),{items:n.items,packages:Array.from(a.values())}}function Ja(e=[]){const t=new Map;if(e.forEach(c=>{const s=J(c.packageId??c.package_id??c.packageCode??c.package_code??c.bundleId??c.bundle_id??null);if(!s)return;const o=s;t.has(o)||t.set(o,{base:c,items:[]}),t.get(o).items.push(c)}),!t.size)return{items:e,packages:[]};const n=[],i=[],a=new Set;return e.forEach(c=>{const s=J(c.packageId??c.package_id??c.packageCode??c.package_code??c.bundleId??c.bundle_id??null);if(s&&t.has(s)){if(a.has(s))return;const o=t.get(s),l=o.base||c,r=o.items.map(d=>ri(d,1)),u={packageId:s,package_id:s,package_code:l.package_code??l.packageCode??l.barcode??_(String(s)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${s}`,quantity:M(l.package_quantity??l.packageQty??l.qty??1,{fallback:1,max:9999}),unit_price:F(l.package_price??l.packagePrice??l.price??0),packageItems:r,image:l.image??null};i.push(u),n.push(Ya(u,l)),a.add(s);return}n.push(c)}),{items:n,packages:i}}function st(e={},t=""){if(!e||typeof e!="object")return[];const n=J(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let a=fe({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),c=[];if((!Array.isArray(a)||a.length===0)&&n){const r=ot(n);r&&(a=fe(r),c=Array.isArray(a)?a:[])}else if(n){const r=ot(n);r&&(c=fe(r)||[])}if(!Array.isArray(a)||a.length===0)return[];const s=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),o=a.map(r=>ri(r,s));if(c.length){const r=new Map;c.forEach(u=>{if(!u)return;const d=Tt(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&r.set(d,u)}),o.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!r.has(d))return;const p=r.get(d),b=M(p.quantity??p.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=b,u.qty=b,u.quantity=b;const g=F(p.unit_price??p.unitPrice??p.price??u.price);u.price=g,u.unit_price=g,!u.desc&&p.desc&&(u.desc=p.desc),!u.image&&p.image&&(u.image=p.image)})}const l=new Map;return o.forEach(r=>{const u=r.normalizedBarcode||(r.equipmentId?`id:${r.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=r.qty,d.quantity+=r.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=r.qtyPerPackage),(!d.price||d.price===0)&&r.price&&(d.price=r.price,d.unit_price=r.unit_price),!d.desc&&r.desc&&(d.desc=r.desc),!d.image&&r.image&&(d.image=r.image);return}l.set(u,{...r})}}),Array.from(l.values())}function li(e={},t=[],n=1){if(Array.isArray(t)&&t.length){const a=t.reduce((c,s)=>{const o=Number.isFinite(Number(s.price))?Number(s.price):0,l=Number.isFinite(Number(s.qtyPerPackage))&&Number(s.qtyPerPackage)>0?Number(s.qtyPerPackage):Number.isFinite(Number(s.qty))&&Number(s.qty)>0?Number(s.qty):1;return c+o*l},0);if(a>0)return Number(a.toFixed(2))}const i=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(i))){const a=F(i);return n>0?Number((a/n).toFixed(2)):a}return Number.isFinite(Number(e.unit_price??e.unitPrice??e.price))?F(e.unit_price??e.unitPrice??e.price):0}function ui(e,t){if(!e)return t;if(!t)return e;const n={...e},i=a=>{(n[a]===void 0||n[a]===null||n[a]==="")&&(n[a]=t[a])};return["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=Za(n.packageItems,t.packageItems),n.items=n.packageItems),n}function Za(e=[],t=[]){const n=new Map,i=a=>{a.forEach(c=>{if(!c)return;const s=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(s){if(n.has(s)){const o=n.get(s);o.qty+=c.qty??0,o.quantity+=c.quantity??0,(!Number.isFinite(o.qtyPerPackage)||o.qtyPerPackage<=0)&&Number.isFinite(c.qtyPerPackage)&&(o.qtyPerPackage=c.qtyPerPackage),(!o.price||o.price===0)&&c.price&&(o.price=c.price,o.unit_price=c.unit_price),!o.desc&&c.desc&&(o.desc=c.desc),!o.image&&c.image&&(o.image=c.image);return}n.set(s,{...c})}})};return i(e),i(t),Array.from(n.values())}function ge(e=[],t=[]){const n=[],i=new Map,a=Qe(),c=new Map;a.forEach(l=>{const r=J(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&c.set(u,r||u)});const s=l=>{const r=J(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?_(u):"";return r||(d&&c.has(d)?c.get(d):d||null)},o=l=>{Array.isArray(l)&&l.forEach(r=>{if(!r||typeof r!="object")return;const u=s(r);if(u)if(i.has(u)){const d=i.get(u);n[d]=ui(n[d],r)}else i.set(u,n.length),n.push({...r})})};return o(e),o(t),n}function di(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const d=J(e),p=d?ot(d):null,b=p?st(p,d):[],g=p?F(p.price??p.unit_price??p.unitPrice??0):0,A=1,S=Number((g*A).toFixed(2));return{id:`package::${d||t}`,packageId:d||`pkg-${t}`,package_id:d||`pkg-${t}`,package_code:_(String(e))||d||`pkg-${t}`,name:p?.name??p?.package_name??p?.packageName??_(String(e))??"",desc:p?.name??_(String(e))??"",quantity:A,qty:A,unit_price:g,unitPrice:g,price:g,total:S,total_price:S,barcode:_(String(e)),packageItems:b,items:b,type:"package",image:p?.image??null}}if(typeof e!="object")return null;const n=J(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=st(e,n),c=li(e,a,i),s=e.total_price??e.totalPrice??e.total??c*i,o=Number.isFinite(Number(s))?F(s):Number((c*i).toFixed(2)),l=e.package_code??e.packageCode??e.code??n,r=_(String(e.barcode??l??"")),u=e.image??e.cover??e.thumbnail??a.find(d=>d.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:l,name:e.name??e.package_name??e.packageName??e.title??e.description??l??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??l??n,quantity:i,qty:i,unit_price:c,unitPrice:c,price:c,total:o,total_price:o,barcode:r,packageItems:a,items:a,type:"package",image:u}}function Zt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,a=(o,l=n.length)=>{const r=di(o,l);if(!r)return;const u=r.packageId||r.package_code||r.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);n[d]=ui(n[d],r)}else i.set(u,n.length),n.push(r)};t.forEach(o=>{o.forEach((l,r)=>{a(l,r+n.length)})}),n.length===0&&e.package&&a(e.package,0);const c=Array.isArray(e.items)?e.items:[],s=(o={})=>!o||typeof o!="object"?!1:!!(si(o.type??o.item_type??o.kind??null)==="package"||o.packageItems&&Array.isArray(o.packageItems)&&o.packageItems.length||o.items&&Array.isArray(o.items)&&o.items.length&&o.items.every(r=>typeof r=="object")||o.packageId||o.package_id||o.package_code||o.packageCode||o.bundleId||o.bundle_id);return c.forEach((o,l)=>{s(o)&&a(o,n.length+l)}),n}function F(e){const t=B(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function M(e,{fallback:t=1,max:n=1e6}={}){const i=B(e);if(!Number.isFinite(i))return t;const a=Math.round(i);return a<=0||a>n?t:a}function Xa(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function eo(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function to(e){return e instanceof it}const Fo=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:Ka,confirmReservationApi:Ua,createReservationApi:Ha,deleteReservationApi:Oa,getCachedReservationCrew:xa,getReservationsState:ja,isApiError:to,mapLegacyReservation:oi,mapReservationFromApi:gt,mapReservationItem:ci,refreshReservationsFromApi:Va,setReservationsState:Ge,toInternalReservation:ht,updateReservationApi:ai},Symbol.toStringTag,{value:"Module"}));export{jt as $,X as A,Ao as B,Yi as C,Yn as D,yo as E,mo as F,Ia as G,Ba as H,Xe as I,W as J,uo as K,ea as L,fe as M,ro as N,No as O,va as P,Io as Q,ot as R,zn as S,xn as T,fo as U,go as V,Ca as W,bo as X,po as Y,Sa as Z,lo as _,Lo as a,Ka as a0,Ha as a1,vo as a2,ho as a3,_o as a4,Eo as a5,pe as a6,kn as a7,Qe as a8,ht as a9,Oa as aa,Ua as ab,wa as ac,Aa as ad,ko as ae,xa as af,So as ag,Co as ah,Po as ai,so as aj,io as ak,Fo as al,to as b,ao as c,oo as d,be as e,at as f,ja as g,Ue as h,To as i,rt as j,Va as k,De as l,x as m,Gn as n,Kt as o,B as p,Qt as q,qo as r,mt as s,co as t,ai as u,lt as v,gt as w,wn as x,Fa as y,oi as z};
