const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reports.Db7PepGB.js","./maintenance.BnsilVv3.js","./reservations.DRN0EUrN.js","./projects.LJ2hsl-k.js","./calendar.CkJh67XL.js","./dashboardMetrics.DNz2n2E8.js"])))=>i.map(i=>d[i]);
import"./app.BkkBR8h4.js";/* empty css              */import{o as $,v as K,q as ke,p as Ae,r as pe,l as G,a as W,s as _e,t as g,n as T,f as _,b as we,c as Be,i as Pe,H as Le,I as Re,d as Fe}from"./maintenance.BnsilVv3.js";import{i as Ce}from"./dashboardShell.C_ArwTjw.js";import{r as xe}from"./customers.CDqN0Nx5.js";import{S as De,h as Ne}from"./projects.LJ2hsl-k.js";import{s as Me,q as $e,E as ce,t as je,n as ge,c as Ue,m as Oe,w as Ve}from"./reservations.DRN0EUrN.js";import"./reports.Db7PepGB.js";const ze="modulepreload",He=function(e,t){return new URL(e,t).href},ue={},A=function(t,n,s){let u=Promise.resolve();if(n&&n.length>0){let p=function(b){return Promise.all(b.map(o=>Promise.resolve(o).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};const a=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),l=i?.nonce||i?.getAttribute("nonce");u=p(n.map(b=>{if(b=He(b,s),b in ue)return;ue[b]=!0;const o=b.endsWith(".css"),d=o?'[rel="stylesheet"]':"";if(s)for(let m=a.length-1;m>=0;m--){const y=a[m];if(y.href===b&&(!o||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${b}"]${d}`))return;const f=document.createElement("link");if(f.rel=o?"stylesheet":ze,o||(f.as="script"),f.crossOrigin="",f.href=b,l&&f.setAttribute("nonce",l),document.head.appendChild(f),o)return new Promise((m,y)=>{f.addEventListener("load",m),f.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${b}`)))})}))}function c(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return u.then(a=>{for(const i of a||[])i.status==="rejected"&&c(i.reason);return t().catch(c)})},Ke={},te="__ART_RATIO_LAST_DASHBOARD_TAB__",w="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Q="create-tab",he=/^[a-z0-9\-]+$/i,We=typeof import.meta<"u"&&Ke&&!1;function h(...e){We&&console.log(...e)}function ne(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const s=t.closest("[data-tab-scroll]");s&&window.requestAnimationFrame(()=>{s.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function F(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!he.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function ae(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!he.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function ye(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let R=null,q=null,C=!1,S=null,le=null,x=null,ie=null,D=null,O=null,J=null,X=null,Z=null,de=!1;function Qe(){return O||(O=A(()=>import("./reports.Db7PepGB.js").then(e=>e.r),__vite__mapDeps([0,1,2,3]),import.meta.url).then(e=>{try{typeof e.initReports=="function"&&e.initReports()}catch(t){console.error("❌ [tabs.js] Failed to initialise reports module",t)}return e}).catch(e=>{throw console.error("❌ [tabs.js] Failed to load reports module",e),O=null,e})),O}function ve(){return J||(J=A(()=>import("./reservations.DRN0EUrN.js").then(e=>e.C),__vite__mapDeps([2,1,3,0]),import.meta.url)),J}function Ge(){return X||(X=A(()=>import("./calendar.CkJh67XL.js"),__vite__mapDeps([4,3,1,2,0]),import.meta.url)),X}function Ye(){return Z||(Z=A(()=>import("./maintenance.BnsilVv3.js").then(e=>e.O),__vite__mapDeps([1,2,3,0]),import.meta.url)),Z}function Je(){h("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");h("📌 tabButtons:",e),h("📌 tabContents:",t);const n=(a,{skipStore:i=!1,skipRender:l=!1}={})=>{if(!a)return;const p=e.filter(o=>o?.getAttribute("data-tab")===a),b=document.getElementById(a);if(!(!p.length||!b)&&(e.forEach(o=>{const d=o?.getAttribute("data-tab")===a;o.classList.toggle("active",d),d?(o.setAttribute("aria-selected","true"),o.setAttribute("tabindex","0"),ne(o)):(o.setAttribute("aria-selected","false"),o.setAttribute("tabindex","-1"))}),t.forEach(o=>{const d=o.id===a;o.style.display=d?"block":"none",o.classList.toggle("active",d)}),R=a,ae(te,a),typeof document<"u"&&document.dispatchEvent(new CustomEvent("dashboard:tabChanged",{detail:{tabId:a}})),i||$({dashboardTab:a}).catch(o=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",o)}),a!=="reservations-tab"&&(q=null,S=null,ye(w),i||$({dashboardSubTab:null}).catch(o=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",o)})),!l&&a==="customers-tab"&&(h("👤 Rendering customers"),xe()),!l&&a==="equipment-tab"&&(h("📦 Rendering equipment"),pe()),!l&&a==="maintenance-tab"&&(h("🛠️ Rendering maintenance"),Ye().then(o=>{try{o.renderMaintenance?.()}catch(d){console.error("❌ [tabs.js] Failed to render maintenance",d)}}).catch(o=>console.error("❌ [tabs.js] Unable to load maintenance module",o))),!l&&a==="technicians-tab"&&(h("🛠️ Rendering technicians"),De()),a==="reservations-tab")){if(h("📅 Rendering reservations"),!l){try{Me()}catch{}try{$e()}catch{}ve().then(async o=>{try{!de&&typeof o.initializeReservationUI=="function"&&(await o.initializeReservationUI(),de=!0)}catch(d){console.error("❌ [tabs.js] Failed to initialise reservations UI",d)}}).catch(o=>console.error("❌ [tabs.js] Unable to load reservations UI module",o))}if(!S){const o=F(w);S=q||o||Q}Xe(),S&&(V(S),S=null)}};ie=n;const s=a=>{if(!a||a.dataset.tabKeyboardBound==="true")return;const i=a.getAttribute("aria-orientation")==="vertical";a.addEventListener("keydown",l=>{const p=l.key,b=Array.from(a.querySelectorAll('[role="tab"], .tab-button, .sub-tab-button')).filter(P=>P.matches("[data-tab], [data-sub-tab]"));if(!b.length)return;const o=l.target,d=Math.max(0,b.indexOf(o));let f=d;const m=()=>{f=(d-1+b.length)%b.length},y=()=>{f=(d+1)%b.length},M=()=>{f=0},Y=()=>{f=b.length-1};let k=!1;switch(p){case"ArrowLeft":i||(m(),k=!0);break;case"ArrowRight":i||(y(),k=!0);break;case"ArrowUp":i&&(m(),k=!0);break;case"ArrowDown":i&&(y(),k=!0);break;case"Home":M(),k=!0;break;case"End":Y(),k=!0;break;case"Enter":case" ":k=!0,o?.click();break}if(k){l.preventDefault();const P=b[f];P&&P!==o&&(P.focus(),P.click())}}),a.dataset.tabKeyboardBound="true"};document.querySelectorAll('[role="tablist"]').forEach(s),e.forEach(a=>{a&&(a.getAttribute("type")||a.setAttribute("type","button"),a.setAttribute("role","tab"),a.hasAttribute("tabindex")||a.setAttribute("tabindex",a.classList.contains("active")?"0":"-1"),a.addEventListener("click",()=>{const i=a.getAttribute("data-tab");if(h("🖱️ Tab clicked:",i),n(i),i==="reservations-tab"){const l=q||F(w)||Q;typeof x=="function"?x(l):S=l}else $({dashboardSubTab:null}).catch(l=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",l)})}))});const u=a=>{const i=document.querySelector("[data-tab].active"),l=F(te),p=e[0]?.getAttribute("data-tab")||null,o=[a?.dashboardTab,l,R,i?.getAttribute("data-tab"),p].filter(Boolean).find(m=>document.getElementById(m))||p;o&&(!C||o!==R)&&(h("⭐ Initial tab:",o),n(o,{skipStore:!0}));const f=[a?.dashboardSubTab,F(w)].filter(Boolean).find(m=>document.getElementById(m));f&&(R==="reservations-tab"&&typeof x=="function"?(!C||f!==q)&&x(f,{skipStore:!0}):S=f),C||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),C=!0)},c=typeof K=="function"?K():null;u(c||null),ke().then(a=>u(a||null)).catch(a=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",a),u(null)}),le||(le=Ae(a=>{if(!(!C||!a))if(a.dashboardTab&&a.dashboardTab!==R&&n(a.dashboardTab,{skipStore:!0}),R==="reservations-tab"){if(a.dashboardSubTab&&a.dashboardSubTab!==q)V(a.dashboardSubTab);else if(!a.dashboardSubTab&&q){const i=F(w);i?i!==q&&V(i):V(null)}}else a.dashboardSubTab&&(S=a.dashboardSubTab)}))}function Xe(){h("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(h("📌 subTabButtons:",e),h("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(c=>c?.getAttribute("data-sub-tab")).filter(c=>typeof c=="string"&&c.trim().length>0),s=()=>n.length?n.includes(Q)?Q:n[0]:null,u=(c,{skipStore:a=!1}={})=>{if(!n.length)return;let i=c;(!i||!n.includes(i))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:i,available:n}),i=s());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${i}"]`),p=document.getElementById(i);if(!l||!p){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:i});return}if(q===i&&l.classList.contains("active")&&p.classList.contains("active")&&p.getAttribute("aria-hidden")==="false"){p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false"),q=i,ne(l),a||(ae(w,i),$({dashboardSubTab:i}).catch(o=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",o)}));return}e.forEach(o=>{o.classList.remove("active"),o.classList.contains("tab")&&o.classList.remove("tab-active"),o.setAttribute("aria-selected","false"),o.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),ne(l),t.forEach(o=>{const d=o.id===i;o.classList.toggle("active",d),o.setAttribute("aria-hidden",d?"false":"true"),d?(o.removeAttribute("hidden"),o.style.display="block"):(o.setAttribute("hidden",""),o.style.display="none")}),q=i,ae(w,i),a||$({dashboardSubTab:i}).catch(o=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",o)}),typeof document<"u"&&document.dispatchEvent(new CustomEvent("reservations:subTabChanged",{detail:{subTabId:i}})),i==="my-reservations-tab"?(h("📋 Rendering reservations list"),setTimeout(()=>{ve().then(o=>{try{o.renderReservations?.()}catch(d){console.error("❌ [tabs.js] Failed to render reservations list",d)}}).catch(o=>console.error("❌ [tabs.js] Unable to load reservations UI module",o))},50)):i==="calendar-tab"?(h("📅 Rendering calendar view"),setTimeout(()=>{Ge().then(o=>{try{o.renderCalendar?.()}catch(d){console.error("❌ [tabs.js] Failed to render calendar",d)}}).catch(o=>console.error("❌ [tabs.js] Unable to load calendar module",o))},100)):i==="reports-tab"&&(h("📊 Rendering reports view"),Qe().then(o=>{const{renderReports:d}=o;setTimeout(()=>{try{d?.()}catch(f){console.error("❌ [tabs.js] Failed to render reports tab",f)}},50)}).catch(o=>{console.error("❌ [tabs.js] Unable to load reports tab",o)}))};if(x=(c,a={})=>{c?u(c,a):(e.forEach(i=>{i.classList.remove("active"),i.classList.contains("tab")&&i.classList.remove("tab-active"),i.setAttribute("aria-selected","false"),i.setAttribute("tabindex","-1")}),t.forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden",""),i.style.display="none"}),q=null,ye(w))},e.forEach(c=>{c.dataset.subTabListenerAttached||(c.addEventListener("click",()=>{const a=c.getAttribute("data-sub-tab");h("🖱️ Sub-tab clicked:",a),u(a)}),c.dataset.subTabListenerAttached="true")}),S)u(S,{skipStore:!0}),S=null;else{const c=document.querySelector("#reservations-tab .sub-tab-button.active"),a=s(),i=c?.getAttribute("data-sub-tab")||a;i&&(h("⭐ Initial sub-tab:",i),u(i,{skipStore:!0}))}}function V(e){typeof x=="function"?x(e,{skipStore:!0}):e&&(S=e)}function Ze(){try{if(typeof K=="function")return K()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function et({attemptsLeft:e=0}={}){if(!C||typeof ie!="function")return!1;const t=Ze(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const s=n[0]?.dataset.tab||null,c=[R,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,F(te),s].filter(Boolean).find(i=>document.getElementById(i));if(!c)return!1;const a=()=>{const i=document.querySelector(`[data-tab].active[data-tab="${c}"]`),l=document.getElementById(c);return!!(i&&l?.classList.contains("active")&&l?.style.display!=="none")};if(c==="reservations-tab"){const i=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!i.length)return!1;const l=i[0]?.getAttribute("data-sub-tab")||null,b=[q,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,F(w),l].filter(Boolean).find(m=>document.getElementById(m)),o=document.querySelector("#reservations-tab .sub-tab-button.active"),d=document.querySelector("#reservations-tab .sub-tab.active"),f=d?.id||o?.getAttribute("data-sub-tab")||null;if(b&&f===b&&a())return d&&(d.removeAttribute("hidden"),d.style.display="block",d.setAttribute("aria-hidden","false")),!0;if(b)S=b;else if(e>0)return!1}else if(a())return!0;return ie(c,{skipStore:!0,skipRender:!0}),!0}function oe(){if(!C)return;let e=0;const t=5;D&&(clearTimeout(D),D=null);const n=()=>{if(et({attemptsLeft:t-e})){D=null;return}if(e>=t){D=null;return}e+=1,D=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",oe);document.addEventListener("language:changed",oe);document.addEventListener("theme:changed",oe);let I=[],E=[],j=null,L=!1,be=!1;const r={};function tt(){r.form=document.getElementById("equipment-package-form"),r.hiddenId=document.getElementById("equipment-package-id"),r.nameInput=document.getElementById("equipment-package-name"),r.codeInput=document.getElementById("equipment-package-code"),r.priceInput=document.getElementById("equipment-package-price"),r.descriptionInput=document.getElementById("equipment-package-description"),r.openSelector=document.getElementById("equipment-package-open-selector"),r.selectionWrapper=document.getElementById("equipment-package-selection-active"),r.selectionCounter=document.getElementById("equipment-package-selection-counter"),r.applySelection=document.getElementById("equipment-package-apply-selection"),r.cancelSelection=document.getElementById("equipment-package-cancel-selection"),r.itemsTableBody=document.querySelector("#equipment-package-items-table tbody"),r.itemsEmptyMessage=document.getElementById("equipment-package-items-empty"),r.resetButton=document.getElementById("equipment-package-reset"),r.submitButton=document.getElementById("equipment-package-submit"),r.tableBody=document.getElementById("equipment-packages-table-body"),r.emptyRow=document.getElementById("equipment-packages-empty-row"),r.countBadge=document.getElementById("equipment-packages-count"),r.applySelection&&(r.applySelection.style.display="none")}function Ie(){const{equipment:e=[]}=G()||{};return Array.isArray(e)?e:[]}function se(){const e=new Map;return Ie().forEach(t=>{const n=t?.id??t?.equipment_id??t?.equipmentId??null;n!=null&&e.set(String(n),t)}),e}function nt(){const e=new Map;return Ie().forEach(t=>{const n=ge(t?.barcode);n&&!e.has(n)&&e.set(n,t)}),e}function N(e,{persist:t=!1}={}){I=Array.isArray(e)?e.map(Se):[],ut(),t&&(_e({packages:I}),document.dispatchEvent(new CustomEvent("packages:changed",{detail:{packages:I}})))}function Se(e={}){const t=at(e.items??e.equipment_ids??e.equipmentIds??[]);return{id:e.id!=null?String(e.id):"",package_code:e.package_code??e.code??e.slug??"",slug:e.slug??null,name:e.name??e.title??e.label??"",description:e.description??"",price:it(e.price??e.total_price??e.package_price??0),is_active:rt(e.is_active??e.active??!0),items:t,created_at:e.created_at??null,updated_at:e.updated_at??null}}function at(e){return Array.isArray(e)||(e=[]),e.map(t=>{if(t==null)return null;if(typeof t=="number"||typeof t=="string"){const n=String(t).trim();return n?{equipment_id:n,quantity:1,unit_price:null}:null}if(typeof t=="object"){const n=t.equipment_id??t.equipmentId??t.id??t.item_id??t.itemId??null;if(n==null)return null;const s=Number.isFinite(Number(t.quantity??t.qty))?Number(t.quantity??t.qty):1,u=Number.isFinite(Number(t.unit_price??t.price))?Number(t.unit_price??t.price):null;return{equipment_id:String(n),quantity:s>0?s:1,unit_price:u}}return null}).filter(Boolean)}function it(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function rt(e){if(e===!0||e===!1)return e;if(e==null)return!0;const t=String(e).trim().toLowerCase();return!(t==="0"||t==="false"||t==="no")}function ot(e){const t=e?.quantity??e?.qty??1,n=Number.parseFloat(T(String(t)));return!Number.isFinite(n)||n<=0?1:n}function st(e,t){const n=[e?.unit_price,e?.price];for(const u of n){if(u==null)continue;const c=Number.parseFloat(T(String(u)));if(Number.isFinite(c))return c}const s=e?.equipment_id??e?.equipmentId??e?.id;if(s!=null&&t instanceof Map){const u=t.get(String(s));if(u&&typeof u=="object"){const c=[u.unit_price,u.unitPrice,u.price,u.daily_rate,u.dailyRate];for(const a of c){if(a==null)continue;const i=Number.parseFloat(T(String(a)));if(Number.isFinite(i))return i}}}return 0}function ct(e=null){const t=e instanceof Map?e:se();return E.reduce((n,s)=>{const u=ot(s),c=st(s,t),a=Number.isFinite(u)&&u>0?u:1,i=Number.isFinite(c)&&c>0?c:0;return n+a*i},0)}function fe(e){const t=r.priceInput;if(!t)return;const n=t.dataset.autoCalculated==="false",s=!!(t.value&&t.value.trim());if(n&&s)return;if(!Number.isFinite(e)||E.length===0){t.value="",t.dataset.autoCalculated="true";return}const u=e<0?0:e,c=Math.round(u*100)/100,a=Number.isInteger(c)?String(c):c.toFixed(2);t.value=a,t.dataset.autoCalculated="true"}function U(){if(!r.itemsTableBody||!r.itemsEmptyMessage)return;if(E.length===0){r.itemsTableBody.innerHTML="",r.itemsEmptyMessage.hidden=!1,fe(0);return}const e=se(),t=E.map((s,u)=>{const c=e.get(String(s.equipment_id)),a=c?.desc||c?.name||g("equipment.packages.items.unknown","معدة بدون اسم"),i=c?.barcode?T(String(c.barcode)):"",l=T(String(s.quantity??1)),p=i?`${a} — ${i}`:a;return`
      <tr data-package-item-index="${u}">
        <td>${p}</td>
        <td>${l}</td>
        <td>
          <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-item" data-index="${u}">🗑️</button>
        </td>
      </tr>
    `});r.itemsTableBody.innerHTML=t.join(""),r.itemsEmptyMessage.hidden=!0;const n=ct(e);fe(n)}function ut(){if(!r.tableBody||!r.emptyRow)return;if(!I.length){r.tableBody.innerHTML="",r.tableBody.appendChild(r.emptyRow),r.emptyRow.hidden=!1,r.countBadge&&(r.countBadge.textContent="0");return}const e=se(),t=I.map(n=>{const s=Ne({...n,items:n.items}),u=s.map(i=>{const l=e.get(String(i.equipmentId??i.equipment_id)),p=l?.desc||l?.name||i.desc||g("equipment.packages.items.unknown","معدة بدون اسم"),b=T(String(i.qty??i.quantity??1)),o=i.barcode||l?.barcode,d=o?` (${T(String(o))})`:"";return`<li>${p}${d} × ${b}</li>`}),c=s.reduce((i,l)=>i+(Number(l.qty??l.quantity??1)||0),0),a=`${T(n.price.toFixed(2))} ${g("reservations.create.summary.currency","SR")}`;return`
      <tr data-package-id="${n.id}">
        <td>${n.name||"—"}</td>
        <td>${n.package_code||"—"}</td>
        <td>${a}</td>
        <td>
          <details>
            <summary>${T(String(c||0))}</summary>
            <ul class="equipment-package-items-summary">${u.join("")}</ul>
          </details>
        </td>
        <td>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-action="edit-package" data-id="${n.id}">✏️</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete-package" data-id="${n.id}">🗑️</button>
          </div>
        </td>
      </tr>
    `});r.tableBody.innerHTML=t.join(""),r.emptyRow.hidden=!0,r.countBadge&&(r.countBadge.textContent=T(String(I.length)))}function Te(){j=null,E=[],r.hiddenId&&(r.hiddenId.value=""),r.nameInput&&(r.nameInput.value=""),r.codeInput&&(r.codeInput.value=""),r.priceInput&&(r.priceInput.value="",r.priceInput.dataset.autoCalculated="true"),r.descriptionInput&&(r.descriptionInput.value=""),r.submitButton&&(r.submitButton.textContent=g("equipment.packages.form.actions.save","💾 حفظ الحزمة")),U(),B(!1)}function lt(e){j=e.id||null,E=e.items.map(t=>({...t})),r.hiddenId&&(r.hiddenId.value=j||""),r.nameInput&&(r.nameInput.value=e.name||""),r.codeInput&&(r.codeInput.value=e.package_code||""),r.priceInput&&(r.priceInput.value=e.price!=null?String(e.price):"",r.priceInput.dataset.autoCalculated=e.price!=null?"false":"true"),r.descriptionInput&&(r.descriptionInput.value=e.description||""),r.submitButton&&(r.submitButton.textContent=g("equipment.packages.form.actions.update","💾 تحديث الحزمة")),U(),B(!1)}function B(e=L){L=e,r.selectionWrapper&&(L?r.selectionWrapper.hidden=!1:r.selectionWrapper.hidden=!0),r.openSelector&&(r.openSelector.disabled=L),r.cancelSelection&&(r.cancelSelection.disabled=!L),qe()}function qe(){if(r.selectionCounter){if(!L){r.selectionCounter.textContent=g("equipment.packages.selection.counter","لم يتم اختيار عناصر بعد.");return}r.selectionCounter.textContent=g("equipment.packages.selection.autoMode","أي معدة تختارها ستُضاف مباشرة إلى الحزمة. استخدم زر إلغاء للخروج من وضع الاختيار.")}}function dt(e){const t=e?.detail||{},n=!!t.active,s=t.selection||t.previous||{},u=s?.mode||s?.source||"";if(u!=="package-manager"&&u!=="equipment-packages"){!n&&L&&(B(!1),re());return}if(n){B(!0);return}B(!1),re()}function bt(e){const t=e?.detail;if(!t)return;const n=t.selection||{},s=n?.mode||n?.source||"";if(s!=="package-manager"&&s!=="equipment-packages")return;const u=Array.isArray(t.barcodes)?t.barcodes:[],c=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,a=u.length?u:t.barcode?[t.barcode]:[];if(!a.length)return;const i=nt(),l=[],p=new Set;a.forEach(f=>{const m=ge(f);m&&!p.has(m)&&(p.add(m),l.push(m))});const b=Math.min(l.length,c);let o=0;const d=[];for(let f=0;f<b;f+=1){const m=l[f],y=i.get(m);if(!y)continue;const M=y?.id??y?.equipment_id??y?.equipmentId??null;if(M==null)continue;const Y=y?.desc||y?.name||m,k=E.find(P=>P.equipment_id===String(M));k?k.quantity+=1:E.push({equipment_id:String(M),quantity:1,unit_price:Number.isFinite(Number(y?.price))?Number(y.price):null}),o+=1,d.push(Y)}if(o>0){U(),qe();const f=o===1?g("equipment.packages.selection.itemAddedSingle","✅ تمت إضافة {name} إلى الحزمة"):g("equipment.packages.selection.itemAddedMulti","✅ تمت إضافة {count} معدات إلى الحزمة"),m=o===1?f.replace("{name}",d[0]||""):f.replace("{count}",T(String(o)));_(m)}else _(g("equipment.packages.selection.noMatch","⚠️ تعذر ربط المعدات المختارة بالحزم، تحقق من بيانات المعدات"),4e3)}function ft(){B(!1),Ue("package-cancel"),re()}function re(){r.form&&(r.form.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{r.nameInput?.focus()},200))}function ee(e){const t=r.priceInput;if(!t)return;const n=t.value;if(n==null)return;const s=n.replace(/[\u066B\u066C\u060C،,]/gu,".");let c=T(s).replace(/[^0-9.]/gu,"");const a=c.indexOf(".");if(a!==-1){const i=c.slice(0,a+1),l=c.slice(a+1).replace(/\./g,"");c=`${i}${l}`}if(c!==n&&(t.value=c,typeof t.setSelectionRange=="function")){const i=c.length;try{t.setSelectionRange(i,i)}catch{}}e?.type==="input"&&(t.dataset.autoCalculated=c.trim()?"false":"true")}function mt(){const e=r.nameInput?.value.trim(),t=r.codeInput?.value.trim(),n=r.descriptionInput?.value.trim()??"",s=r.priceInput?.value??"",u=Number.parseFloat(T(s));if(!e)return _(g("equipment.packages.validation.nameRequired","⚠️ يرجى إدخال اسم الحزمة")),null;if(!t)return _(g("equipment.packages.validation.codeRequired","⚠️ يرجى إدخال كود الحزمة")),null;if(!E.length)return _(g("equipment.packages.validation.itemsRequired","⚠️ أضف عنصرًا واحدًا على الأقل للحزمة")),null;const c=E.map(a=>({equipment_id:a.equipment_id,quantity:Number.isFinite(Number(a.quantity))?Number(a.quantity):1,unit_price:a.unit_price!=null&&Number.isFinite(Number(a.unit_price))?Number(a.unit_price):null}));return{package_code:t,name:e,description:n,price:Number.isFinite(u)?u:0,is_active:!0,items:c}}async function pt(e){if(e.preventDefault(),!r.form)return;const t=mt();if(t)try{let n;j?(n=await W(`/packages/?id=${encodeURIComponent(j)}`,{method:"PATCH",body:t}),_(g("equipment.packages.toast.updated","✅ تم تحديث الحزمة بنجاح"))):(n=await W("/packages/",{method:"POST",body:t}),_(g("equipment.packages.toast.created","✅ تم إنشاء الحزمة بنجاح")));const s=Se(n?.data??n),u=I.findIndex(c=>c.id===s.id);u>=0?I.splice(u,1,s):I=[s,...I],N(I,{persist:!0}),Te()}catch(n){console.error("[equipmentPackagesManager] handlePackageSubmit error",n);const s=n?.message||g("equipment.packages.toast.saveFailed","❌ تعذر حفظ الحزمة");_(s,4e3)}}function gt(e){const t=e.target.closest('[data-action="remove-item"]');if(!t)return;const n=Number(t.dataset.index);Number.isNaN(n)||(E=E.filter((s,u)=>u!==n),U())}async function ht(e){const t=e.target.closest('[data-action="edit-package"]');if(t){const s=t.dataset.id;if(!s)return;const u=I.find(c=>c.id===s);if(!u)return;lt(u);return}const n=e.target.closest('[data-action="delete-package"]');if(n){const s=n.dataset.id;if(!s||!window.confirm(g("equipment.packages.confirm.delete","هل أنت متأكد من حذف الحزمة؟")))return;try{await W(`/packages/?id=${encodeURIComponent(s)}`,{method:"DELETE"}),I=I.filter(c=>c.id!==s),N(I,{persist:!0}),_(g("equipment.packages.toast.deleted","🗑️ تم حذف الحزمة بنجاح"))}catch(c){console.error("[equipmentPackagesManager] delete package error",c),_(g("equipment.packages.toast.deleteFailed","❌ تعذر حذف الحزمة"),4e3)}}}async function yt(){try{const e=await W("/packages/?all=1"),t=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];N(t,{persist:!0})}catch(e){console.warn("[equipmentPackagesManager] Failed to fetch packages from API, falling back to cache",e);const{packages:t=[]}=G()||{};N(t,{persist:!1})}}function vt(){const{packages:e=[]}=G()||{};Array.isArray(e)&&e.length?N(e,{persist:!1}):N([],{persist:!1}),U(),B(!1)}function It(){if(L){B(!0);return}B(!0),je({mode:"package-manager",source:"equipment-packages",activatedAt:Date.now()});const e=document.querySelector('[data-tab="equipment-tab"]');e&&e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus();const t=document.getElementById("equipment-list");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},200)})}function St(){r.form&&(r.form.addEventListener("submit",pt),r.itemsTableBody?.addEventListener("click",gt),r.resetButton?.addEventListener("click",()=>{Te()}),r.tableBody?.addEventListener("click",ht),r.openSelector?.addEventListener("click",e=>{e.preventDefault(),It()}),r.cancelSelection?.addEventListener("click",e=>{e.preventDefault(),ft()}),r.priceInput&&!r.priceInput.dataset.normalizedAttached&&(r.priceInput.addEventListener("input",ee),r.priceInput.addEventListener("blur",ee),r.priceInput.dataset.normalizedAttached="true",ee()),be||(document.addEventListener(ce.change,dt),document.addEventListener(ce.requestAdd,bt),be=!0))}function Tt(){typeof document>"u"||(tt(),r.form&&(vt(),St(),yt()))}we();let v=null,z=null,H=null;function qt(){return H||(H=A(()=>import("./dashboardMetrics.DNz2n2E8.js"),__vite__mapDeps([5,1,2,3,0]),import.meta.url).then(e=>{try{typeof e.initDashboardMetrics=="function"&&e.initDashboardMetrics()}catch(t){console.error("❌ Failed to initialise dashboard metrics",t)}return e}).catch(e=>{throw console.error("❌ Failed to load dashboard metrics module",e),H=null,e})),H}function Et(){const e=()=>{qt()};typeof window<"u"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>{e()},{timeout:1500}):setTimeout(e,0)}function kt(){const e=async()=>{try{const t=[];t.push(A(()=>import("./projects.LJ2hsl-k.js").then(n=>n.a7),__vite__mapDeps([3,1,2,0]),import.meta.url).then(n=>n.refreshProjectsFromApi().catch(()=>{})).catch(()=>{})),t.push(A(()=>import("./reservations.DRN0EUrN.js").then(n=>n.B),__vite__mapDeps([2,1,3,0]),import.meta.url).then(n=>n.refreshReservationsFromApi().catch(()=>{})).catch(()=>{})),t.push(A(()=>import("./projects.LJ2hsl-k.js").then(n=>n.a6),__vite__mapDeps([3,1,2,0]),import.meta.url).then(n=>n.refreshTechniciansFromApi().catch(()=>{})).catch(()=>{})),t.push(A(()=>import("./maintenance.BnsilVv3.js").then(n=>n.N),__vite__mapDeps([1,2,3,0]),import.meta.url).then(n=>n.refreshMaintenanceFromApi().catch(()=>{})).catch(()=>{})),t.push(A(()=>import("./maintenance.BnsilVv3.js").then(n=>n.M),__vite__mapDeps([1,2,3,0]),import.meta.url).then(n=>n.refreshEquipmentFromApi({showToastOnError:!1}).catch(()=>{})).catch(()=>{})),await Promise.allSettled(t)}catch{}};typeof window<"u"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>{e()},{timeout:2500}):setTimeout(e,500)}async function me(){if(!await Be())return;Ce(),Je(),Pe(),pe(),Tt(),Le(),Et(),kt();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async s=>{const u=s.target.files&&s.target.files[0];u&&(await Re(u),s.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",s=>{s.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",Fe),At(),_t()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{me().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):me().catch(e=>{console.error("❌ Failed to initialise app",e)});function At(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,s]=t.split("T"),[u]=s.split(":"),c=`${u.padStart(2,"0")}:00`,a=`${n}T${c}`;e.value!==a&&(e.value=a,setTimeout(()=>e.blur(),150))})})}function _t(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;v={reservationId:t,reservationIndex:n!=null?Number(n):null},Ee(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const s=e.toString(),u=`${window.location.pathname}${s?`?${s}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,u)}function wt(e){const t=document.getElementById(e);return!!(t?.classList.contains("active")&&t?.style.display!=="none")}function Bt(e){return new Promise(t=>{if(wt(e)){t();return}const n=u=>{u?.detail?.tabId===e&&(document.removeEventListener("dashboard:tabChanged",n),t())};document.addEventListener("dashboard:tabChanged",n),document.querySelector(`[data-tab="${e}"]`)?.click()})}function Pt(e){const t=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`),n=document.getElementById(e);return!!(t?.classList.contains("active")&&n?.classList.contains("active")&&n?.getAttribute("aria-hidden")==="false")}function Lt(e){return new Promise(t=>{if(Pt(e)){t();return}const n=u=>{u?.detail?.subTabId===e&&(document.removeEventListener("reservations:subTabChanged",n),t())};document.addEventListener("reservations:subTabChanged",n),document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`)?.click()})}async function Rt(){const e=Oe("openReservationEditor");if(typeof e=="function")return e;const t=await Ve("openReservationEditor");if(typeof t=="function")return t;throw new Error("Reservation editor handler is unavailable")}async function Ee(){if(!v)return;if(z)return z;const e=(async()=>{const n=G().reservations||[];let s=null;if(v.reservationId){const i=n.findIndex(l=>String(l?.id)===v.reservationId||String(l?.reservationId)===v.reservationId);i!==-1&&(s=i)}if(s===null&&typeof v.reservationIndex=="number"&&!Number.isNaN(v.reservationIndex)&&v.reservationIndex>=0&&v.reservationIndex<n.length&&(s=v.reservationIndex),s===null)return;const u="my-reservations-tab",c="reservations-tab",a=v;v=null;try{await Bt(c),await Lt(u);const i=await Rt();typeof i=="function"?i(s):(console.warn("⚠️ Pending reservation edit skipped: editor is not available"),v=a)}catch(i){console.error("❌ Failed to open pending reservation editor",i),v=a}})();z=e;try{await e}finally{z=null}}document.addEventListener("reservations:changed",()=>{v&&Ee()});
