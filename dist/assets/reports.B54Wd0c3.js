const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdfPages.Wyc22Qox.js","./calculations.DbvBPHSl.js","./reservationsService.QpciUGKb.js","./auth.BJwwXf3l.js","./auth.DFEtlrMt.css","./state.Bb3-3qE7.js","./quotePdf.kDBbUcue.js","./canvasColorUtils.CviLtv6S.js","./a4Unified.DHvGw6wR.js","./preview.DJqy4cXR.js"])))=>i.map(i=>d[i]);
import{_ as V}from"./uiBridge.D3fMSh06.js";import{r as a,b as me,d as Ce,t as i,f as te,g as E,h as k,c as R,i as oe,j as we,p as he,k as le,a as $e,m as Le,n as Ae,o as Te,q as Me,s as Ie,u as Pe,v as De,w as Be,x as Re,y as Ne,z as _e,A as He,B as qe,C as Fe,D as je,E as ze,F as Oe,G as Ue,H as Ve,I as ne}from"./calculations.DbvBPHSl.js";import{d as We,b as F,A as Ge,n as Y,p as Ye}from"./auth.BJwwXf3l.js";import{K as Ke,m as Xe}from"./reservationsService.QpciUGKb.js";import{m as fe}from"./state.Bb3-3qE7.js";import{mapMaintenanceFromApi as ye}from"./maintenanceService.CYPIFbMe.js";import"./canvasColorUtils.CviLtv6S.js";function ge(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ve(e={}){const t=String(e?.barcode??"").trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function be(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",o=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:o,confirmed:s}}function Qe(){let e;try{e=We()}catch(y){return console.warn("âš ï¸ [reports] Failed to access cached data",y),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:o=[],technicians:s=[],projects:r=[],maintenance:c=[]}=e;if(!(t.length||n.length||o.length||s.length||r.length))return!1;a.data.reservations=Array.isArray(t)?t.map(Ke):[],a.data.customers=Array.isArray(n)?n.map(ge):[],a.data.equipment=Array.isArray(o)?o.map(ve):[],a.data.technicians=Array.isArray(s)?s.map(fe):[],a.data.projects=Array.isArray(r)?r.map(be):[],a.data.projectsMap=new Map(a.data.projects.map(y=>[y.id,y])),a.data.maintenance=Array.isArray(c)?c.map(ye):[],a.techniciansIndex=new Map((a.data.technicians||[]).map(y=>[String(y.id),y]));try{me()}catch{}return!0}async function W({silent:e=!1}={}){if(!a.loading){a.loading=!0,a.errorMessage="",e||a.callbacks.onBeforeRender?.();try{const{startDate:t,endDate:n}=Ce(a.filters||{}),o=f=>{if(!f)return null;const b=f.getFullYear(),C=String(f.getMonth()+1).padStart(2,"0"),g=String(f.getDate()).padStart(2,"0");return`${b}-${C}-${g}`},s=o(t),r=o(n),c=200;let u=0,y=[];const h=50;for(let f=0;f<h;f+=1){const b=new URLSearchParams;b.set("limit",String(c)),b.set("offset",String(u)),s&&b.set("start_date",s),r&&b.set("end_date",r);const C=a.filters||{};C?.status&&C.status!=="all"&&b.set("status",String(C.status)),C?.search&&b.set("search",String(C.search));const g=await F(`/reservations/?${b.toString()}`),w=Array.isArray(g?.data)?g.data:[];if(y=y.concat(w),w.length<c)break;u+=c}const[p,x,l,m,S]=await Promise.all([F("/customers/?limit=500"),F("/equipment/?limit=500"),F("/technicians/?limit=500"),F("/projects/?limit=500"),F("/maintenance/?limit=500")]);a.data.reservations=Array.isArray(y)?y.map(f=>Xe(f)):[],a.data.customers=Array.isArray(p?.data)?p.data.map(ge):[],a.data.equipment=Array.isArray(x?.data)?x.data.map(ve):[],a.data.technicians=Array.isArray(l?.data)?l.data.map(fe):[],a.data.projects=Array.isArray(m?.data)?m.data.map(be):[],a.data.projectsMap=new Map(a.data.projects.map(f=>[f.id,f])),a.data.maintenance=Array.isArray(S?.data)?S.data.map(ye):[],a.techniciansIndex=new Map((a.data.technicians||[]).map(f=>[String(f.id),f]));try{me()}catch{}}catch(t){console.error("âŒ [reports] Failed to load reports data",t),a.errorMessage=t instanceof Ge?t.message:i("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!a.data.projectsMap||!(a.data.projectsMap instanceof Map))&&(a.data.projectsMap=new Map)}finally{a.loading=!1,e||a.callbacks.onAfterRender?.()}}}function H(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function N(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}n.innerHTML=t.map(o=>{const s=Math.min(Math.max(o.percent??0,0),100),r=i("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",E(o.rawCount??o.value??0)),c=o.className?`reports-progress-fill ${o.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${o.label}</span>
            <span class="reports-progress-value">${E(o.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${c}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}function T(e,t){const n=document.querySelector(`[data-chart-loading="${e}"]`);n&&(n.style.display=t?"":"none")}async function Je(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const n=Array.isArray(e)?e:[];if(a.lastTrendData=n,T("volume",!0),!n.length){a.charts.trend&&(a.charts.trend.destroy(),a.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("volume",!1);return}try{const o=await te();if(!o){t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("volume",!1);return}const s=n.map(g=>g.label),r=n.map(g=>Math.round(g.count||0)),c=n.map(g=>Number(g.revenue||0)),u=n.map(g=>Number(g.netProfit||0)),y=n.map(g=>g.movingAvgRevenue!=null?Number(g.movingAvgRevenue):null),h=r.reduce((g,w)=>g+(Number.isFinite(w)?w:0),0),p=c.reduce((g,w)=>g+(Number.isFinite(w)?w:0),0),x=u.reduce((g,w)=>g+(Number.isFinite(w)?w:0),0);if(h===0&&p===0&&x===0){a.charts.trend&&(a.charts.trend.destroy(),a.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const l=[{name:i("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:r},{name:i("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:c,yAxisIndex:1},{name:i("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:u,yAxisIndex:1},{name:i("reservations.reports.chart.volume.series.movingAvg","Ù…ØªÙˆØ³Ø· Ù…ØªØ­Ø±Ùƒ (Ù£ Ø£Ø´Ù‡Ø±)","3-mo Moving Avg"),type:"line",data:y,yAxisIndex:1}],m={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(g,w,P)=>{if(P?.dataPointIndex!=null){const M=a.lastTrendData[P.dataPointIndex];a.callbacks.onTrendDrilldown?.(M,P.dataPointIndex)}}}},theme:{mode:H()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,4,4,0]},colors:["#6366f1","#22c55e","#f97316","#0ea5e9"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},stroke:{curve:"smooth",width:[0,2,2,2],dashArray:[0,0,0,6]},xaxis:{categories:s,labels:{style:{colors:H()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:i("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:g=>E(g)},title:{text:i("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:i("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:g=>k(g)},title:{text:i("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,custom:({series:g,dataPointIndex:w,w:P})=>{const M=a.lastTrendData?.[w]||{},K=s?.[w]||"",D=[],q=g?.[0]?.[w];q!=null&&D.push(`<div><span>ğŸ“¦</span> ${E(q)}</div>`);const X=g?.[1]?.[w];if(X!=null){const _=Number.isFinite(M.yoyChange)?`${M.yoyChange>=0?"+":""}${E(Math.round(M.yoyChange))}% YoY`:"",ae=Number.isFinite(M.momChange)?`${M.momChange>=0?"+":""}${E(Math.round(M.momChange))}% MoM`:"",J=[_,ae].filter(Boolean).join(" Â· ");D.push(`<div><span>ğŸ’°</span> ${k(X)}${J?` <small class="text-base-content/60">(${J})</small>`:""}</div>`)}const Q=g?.[2]?.[w];Q!=null&&D.push(`<div><span>ğŸ§®</span> ${k(Q)}</div>`);const A=g?.[3]?.[w];return A!=null&&D.push(`<div><span>ğŸ“ˆ</span> ${k(A)}</div>`),`
            <div class="apex-tooltip">
              <div class="mb-1 font-semibold">${K}</div>
              ${D.join("")}
            </div>
          `}}},S=H(),f=String(s.join("|")),b=a.chartsMeta.trend,C=a.charts.trend&&b.theme===S&&b.categoriesSig===f;a.charts.trend&&C?a.charts.trend.updateSeries(l,!0):a.charts.trend?(a.charts.trend.updateOptions({...m},!0,!0),a.charts.trend.updateSeries(l,!0)):(t.innerHTML="",a.charts.trend=new o(t,{...m,series:l}),a.charts.trend.render()),a.chartsMeta.trend={categoriesSig:f,theme:S},T("volume",!1)}catch(o){console.error("âš ï¸ [reports] Failed to render trend chart",o),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("volume",!1)}}async function Ze(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(!t)return;const o=Array.isArray(e)?e:[];a.lastStatusData=o,T("status",!0);const s=o.map(c=>Math.max(0,c.value||0)),r=s.reduce((c,u)=>c+u,0);if(!o.length||r===0){a.charts.status&&(a.charts.status.destroy(),a.charts.status=null),N(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("status",!1);return}try{const c=await te();if(!c){N(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("status",!1);return}const u=o.map(m=>m.label),y={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(m,S,f)=>{if(f?.dataPointIndex!=null){const b=a.lastStatusData[f.dataPointIndex];b?.filterKey&&a.callbacks.onStatusDrilldown?.(b,f.dataPointIndex)}}}},theme:{mode:H()},labels:u,series:s,colors:["#22c55e","#f97316","#6366f1","#ef4444"],legend:{position:"bottom"},dataLabels:{formatter:m=>`${Math.round(m)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:i("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>E(s.reduce((m,S)=>m+S,0))}}}}},tooltip:{y:{formatter:(m,S)=>{const f=a.lastStatusData?.[S?.seriesIndex||0],b=f?`${E(f.percent)}%`:`${E(m)}%`;return`${f?E(f.rawCount??f.value??0):E(m)} / ${b}`}}}},h=H(),p=String(u.join("|")),x=a.chartsMeta.status,l=a.charts.status&&x.theme===h&&x.labelsSig===p;a.charts.status&&l?a.charts.status.updateSeries(s,!0):a.charts.status?(a.charts.status.updateOptions({...y},!0,!0),a.charts.status.updateSeries(s,!0)):(t.innerHTML="",a.charts.status=new c(t,{...y,series:s}),a.charts.status.render()),N(n,o),a.chartsMeta.status={labelsSig:p,theme:h},T("status",!1)}catch(c){console.error("âš ï¸ [reports] Failed to render status chart",c),N(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("status",!1)}}async function et(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(!t)return;const o=Array.isArray(e)?e:[];a.lastPaymentData=o,T("payment",!0);const s=o.map(c=>Math.max(0,c.value||0)),r=s.reduce((c,u)=>c+u,0);if(!o.length||r===0){a.charts.payment&&(a.charts.payment.destroy(),a.charts.payment=null),N(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("payment",!1);return}try{const c=await te();if(!c){N(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("payment",!1);return}const u=o.map(m=>m.label),y={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(m,S,f)=>{if(f?.dataPointIndex!=null){const b=a.lastPaymentData[f.dataPointIndex];b?.filterKey&&a.callbacks.onPaymentDrilldown?.(b,f.dataPointIndex)}}}},theme:{mode:H()},labels:u,series:s,colors:["#00ac69","#f59e0b","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:m=>`${Math.round(m)}%`},tooltip:{y:{formatter:(m,S)=>{const f=a.lastPaymentData?.[S?.seriesIndex||0],b=f?`${E(f.percent)}%`:`${E(m)}%`;return`${f?E(f.rawCount??f.value??0):E(m)} / ${b}`}}}},h=H(),p=String(u.join("|")),x=a.chartsMeta.payment,l=a.charts.payment&&x.theme===h&&x.labelsSig===p;a.charts.payment&&l?a.charts.payment.updateSeries(s,!0):a.charts.payment?(a.charts.payment.updateOptions({...y},!0,!0),a.charts.payment.updateSeries(s,!0)):(t.innerHTML="",a.charts.payment=new c(t,{...y,series:s}),a.charts.payment.render()),N(n,o),a.chartsMeta.payment={labelsSig:p,theme:h},T("payment",!1)}catch(c){console.error("âš ï¸ [reports] Failed to render payment chart",c),N(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,T("payment",!1)}}async function tt(e){const t=document.getElementById("reports-status-stacked-chart");if(!t)return;const n=Array.isArray(e)?e:[];if(!n.length){t.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await te(),s=n.map(p=>p.label),r=n.map(p=>p.confirmed||0),c=n.map(p=>p.cancelled||0),u=[{name:i("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),data:r},{name:i("reservations.reports.status.cancelledLabel","Ù…Ù„ØºØ§Ø©","Cancelled"),data:c}],y={chart:{type:"bar",height:320,stacked:!0,toolbar:{show:!1}},series:u,xaxis:{categories:s},plotOptions:{bar:{columnWidth:"55%",borderRadius:6}},colors:["#22c55e","#ef4444"],dataLabels:{enabled:!1},legend:{position:"bottom"}};t.innerHTML="",new o(t,y).render()}catch(o){console.error("[reports] failed to render stacked status chart",o)}}function at(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),o=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reservations-revenue-breakdown"),c=document.getElementById("reports-kpi-outstanding"),u=document.getElementById("reports-kpi-outstanding-meta"),y=document.getElementById("reports-kpi-crew-cost"),h=document.getElementById("reports-kpi-crew-cost-meta"),p=document.getElementById("reports-kpi-margin"),x=document.getElementById("reports-kpi-margin-meta"),l=document.getElementById("reports-kpi-net"),m=document.getElementById("reports-kpi-net-meta"),S=e.total||0,f=e.cancelled||0;e.activeTotal!=null?e.activeTotal:Math.max(0,S-f);const b=e.revenue||0;e.confirmed;const C=e.paidCount||0,g=e.unpaidCount||Math.max(0,(e.activeTotal||0)-C);e.average;const w=e.companyShareTotal||0,P=e.taxTotal||0,M=e.crewTotal||0,K=e.crewCostTotal||0,D=e.netProfit||0,q=e.maintenanceExpense||0,X=b>0?Math.round(D/b*100):0,Q=e.outstandingTotal||0;if(t&&(t.textContent=E(S)),n){const A=i("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…ØºÙ„Ù‚Ø©","Includes {count} closed").replace("{count}",E(e.completed||0)),_=f>0?" "+i("reservations.reports.kpi.total.cancelledPart","â€¢ {count} Ù…Ù„ØºØ§Ø©","â€¢ {count} cancelled").replace("{count}",E(f)):"";n.textContent=A+_}if(o&&(o.textContent=k(b)),s)if(S===0)s.textContent=i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const _=i("reservations.reports.kpi.revenue.metaLite","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share}","Company share {share}").replace("{share}",k(w));s.textContent=_}if(r)if(b>0){const A=[{label:i("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:k(b),hint:i("reservations.reports.kpi.revenue.details.grossHint","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)","Total bookings value (before discounts)")},{label:i("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:k(w),hint:i("reservations.reports.kpi.revenue.details.shareHint","ØªÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…ØŒ ÙˆØªÙØ¶Ø§Ù Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Applied after discount and added to total")},{label:i("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:k(P),hint:i("reservations.reports.kpi.revenue.details.taxHint","Ø¶Ø±ÙŠØ¨Ø© 15% Ø¹Ù„Ù‰ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… + Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©)","15% VAT on (after-discount total + company share)")},{label:i("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:k(M),hint:i("reservations.reports.kpi.revenue.details.crewGrossHint","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ø§Ù‚Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„","Crew price billed to client")},{label:i("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:k(K),hint:i("reservations.reports.kpi.revenue.details.crewHint","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©","Crew cost to company")}];q>0&&A.push({label:i("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${k(q)}`}),A.push({label:i("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:k(D)}),r.innerHTML=A.map(({label:_,value:ae,hint:J})=>`
          <div class="reports-kpi-detail-row" title="${J||""}">
            <span class="reports-kpi-detail-label">${_}</span>
            <span class="reports-kpi-detail-value">${ae}</span>
          </div>
        `).join(""),r.classList.remove("hidden")}else r.innerHTML="",r.classList.add("hidden");if(c&&(c.textContent=k(Q)),u){const A=i("reservations.reports.kpi.outstanding.meta","{count} Ø­Ø¬Ø² ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹/Ø¬Ø²Ø¦ÙŠØ§Ù‹","{count} unpaid/partial reservations").replace("{count}",E(g));u.textContent=A}if(y&&(y.textContent=k(K)),h){const A=i("reservations.reports.kpi.crewCost.meta","Ø§Ù„Ù…ÙÙˆØªØ±Ø© {billable}","Billed {billable}").replace("{billable}",k(M));h.textContent=A}if(p&&(p.textContent=`${X}%`),x){const A=i("reservations.reports.kpi.margin.meta","ØµØ§ÙÙŠ {net} / Ø¥ÙŠØ±Ø§Ø¯Ø§Øª {rev}","Net {net} / Revenue {rev}").replace("{net}",k(D)).replace("{rev}",k(b));x.textContent=A}if(l&&(l.textContent=k(D)),m){const A=i("reservations.reports.kpi.net.meta","Ø¨Ø¹Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø© âˆ’ {maint}","After maintenance âˆ’ {maint}").replace("{maint}",k(q));m.textContent=A}}function L(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function U(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function nt(e,t,n){const o=document.getElementById("reports-reservations-body");if(!o)return[];if(!e||e.length===0)return o.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const s=new Map((t||[]).map(l=>[String(l.id),l]));new Map((n||[]).map(l=>[String(l.id),l]));const r={code:i("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:i("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),company:i("reservations.reports.results.headers.company","Ø§Ù„Ø´Ø±ÙƒØ©","Company"),phone:i("reservations.reports.results.headers.phone","Ø§Ù„Ù‡Ø§ØªÙ","Phone"),date:i("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:i("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:i("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),paymentsCount:i("reservations.reports.results.headers.paymentsCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª","Payments count"),days:i("reservations.reports.results.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…","Days"),equipment:i("reservations.reports.results.headers.equipment","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª","Equipment"),crewGross:i("reservations.reports.results.headers.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),crewCost:i("reservations.reports.results.headers.crewCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),discount:i("reservations.reports.results.headers.discount","Ø§Ù„Ø®ØµÙ…","Discount"),tax:i("reservations.reports.results.headers.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),total:i("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:i("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),sharePercent:i("reservations.reports.results.headers.sharePercent","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© %","Company share %"),shareAmount:i("reservations.reports.results.headers.shareAmount","Ù…Ø¨Ù„Øº Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share amount"),net:i("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},c=st([...e]),{page:u,pageSize:y}=a.pagination,h=Math.max(0,(u-1)*y),x=c.slice(h,h+y).map(l=>{const m=ct(l,s),S=s.get(String(l?.customerId)),b=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).length,C=R(l),g={[r.code]:m.code.text,[r.customer]:m.customer.text,[r.company]:S?.companyName||"",[r.phone]:S?.phone||"",[r.date]:m.date.text,[r.status]:m.status.text,[r.payment]:m.payment.text,[r.paymentsCount]:String(b),[r.days]:String(C.rentalDays??0),[r.equipment]:k(C.equipmentTotal),[r.crewGross]:k(C.crewTotal),[r.crewCost]:k(C.crewCostTotal??0),[r.discount]:k(C.discountAmount??0),[r.tax]:k(C.taxAmount??0),[r.total]:m.total.text,[r.share]:m.share.text,[r.sharePercent]:`${E(C.companySharePercent??0)}%`,[r.shareAmount]:k(C.companyShareAmount??0),[r.net]:m.net.text},w=i("common.placeholder.empty","â€”","â€”");return Object.keys(g).forEach(P=>{String(g[P]??"").trim()===""&&(g[P]=w)}),{formatted:m,exportRow:g}});return o.innerHTML=x.map(({formatted:l})=>`
      <tr data-drilldown="reservation" data-search="${U(l.code.text)}">
        <td data-report-column="code">${l.code.html}</td>
        <td data-report-column="customer">${l.customer.html}</td>
        <td data-report-column="date">${l.date.html}</td>
        <td data-report-column="status">${l.status.html}</td>
        <td data-report-column="payment">${l.payment.html}</td>
        <td data-report-column="total">${l.total.html}</td>
        <td data-report-column="share">${l.share.html}</td>
        <td data-report-column="net">${l.net.html}</td>
      </tr>
    `).join(""),it(c.length),rt(),x.map(({exportRow:l})=>l)}function rt(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(t=>{t.dataset.sortBound!=="true"&&(t.addEventListener("click",()=>{const n=t.dataset.sortKey;n&&(a.sort.key===n?a.sort.dir=a.sort.dir==="asc"?"desc":"asc":(a.sort.key=n,a.sort.dir="asc"),a.pagination.page=1,a.callbacks.onRender?.())}),t.dataset.sortBound="true")})}function st(e){const{key:t,dir:n}=a.sort||{key:"date",dir:"desc"},o=n==="asc"?1:-1;return e.sort((s,r)=>o*ot(s,r,t))}function ot(e,t,n){switch(n){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(t?.reservationId??t?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(t?.customerName??t?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(t?.start||0);case"status":{const o=oe(e)?.statusValue||"",s=oe(t)?.statusValue||"";return String(o).localeCompare(String(s),"ar")}case"total":{const o=R(e)?.finalTotal||0,s=R(t)?.finalTotal||0;return o-s}case"share":{const o=R(e)?.companyShareAmount||0,s=R(t)?.companyShareAmount||0;return o-s}case"net":{const o=R(e)?.netProfit||0,s=R(t)?.netProfit||0;return o-s}default:return new Date(e?.start||0)-new Date(t?.start||0)}}function it(e){const t=document.getElementById("reports-table-pagination");if(!t)return;const{page:n,pageSize:o}=a.pagination,s=Math.max(1,Math.ceil(e/o)),r=n<=1?"disabled":"",c=n>=s?"disabled":"",u=e===0?0:(n-1)*o+1,y=Math.min(n*o,e);if(e<=o){t.innerHTML=`<div class="page-info">${E(u)}â€“${E(y)} / ${E(e)}</div>`;return}t.innerHTML=`
    <div class="pager">
      <button type="button" ${r} data-page="prev">â—€</button>
      <button type="button" ${c} data-page="next">â–¶</button>
    </div>
    <div class="page-info">${E(u)}â€“${E(y)} / ${E(e)}</div>
    <div class="pager page-size">
      <label>${i("reservations.reports.pageSize","Ù„ÙƒÙ„ ØµÙØ­Ø©","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,t.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{a.pagination.page>1&&(a.pagination.page-=1,a.callbacks.onRender?.())}),t.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const h=Math.max(1,Math.ceil(e/a.pagination.pageSize));a.pagination.page<h&&(a.pagination.page+=1,a.callbacks.onRender?.())}),t.querySelectorAll("[data-size]")?.forEach(h=>{h.addEventListener("click",()=>{const p=Number(h.dataset.size);Number.isFinite(p)&&p>0&&(a.pagination.pageSize=p,a.pagination.page=1,a.callbacks.onRender?.())})})}function ct(e,t,n){const o=e?.reservationId||e?.id||i("common.placeholder.empty","â€”","â€”"),s=Y(String(o)),c=t.get(String(e?.customerId))?.customerName||i("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),u=oe(e),y=lt(u.statusValue),h=dt(u.statusValue,y),p=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],x=ut(u.paidStatus,p),l=p.length;let m=x.html;if(l>0){const P=i("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",E(l));m=`<div class="reports-payment-cell">${x.html}<small class="reports-payment-subtext">${L(P)}</small></div>`}const S=we(e?.start),f=R(e),b=k(f.finalTotal),C=f.companySharePercent>0?`${E(f.companySharePercent)}% (${k(f.companyShareAmount)})`:i("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),g=k(f.netProfit),w=L(c);return{code:{html:L(s),text:s},customer:{html:w,text:c},date:{html:L(S),text:S},status:h,payment:{html:m,text:x.text},total:{html:L(b),text:b},share:{html:L(C),text:C},net:{html:L(g),text:g}}}function lt(e){switch(e){case"completed":return G(i("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚","Closed"));case"confirmed":return G(i("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return G(i("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));case"cancelled":return G(i("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ","Cancelled"));default:return Y(e||i("common.placeholder.empty","â€”","â€”"))}}function dt(e,t){const n=G(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending","cancelled"].includes(e)?e:"info"}">${L(n)}</span>`,text:n}}function ut(e,t=[]){const n=he(e),o=String(e??"").toLowerCase(),s=o==="paid"?"paid":o==="partial"?"partial":"unpaid";let r="";const c=i("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(t)&&t.length&&(r=t.map(h=>{const p=h?.recordedAt?le(h.recordedAt):i("common.placeholder.empty","â€”","â€”"),x=Number.isFinite(Number(h?.amount))&&Number(h.amount)>0?`${Y(Number(h.amount).toFixed(2))} ${c}`:"",l=Number.isFinite(Number(h?.percentage))&&Number(h.percentage)>0?`${Y(Number(h.percentage).toFixed(2))}%`:"",m=[p];return x&&m.push(x),l&&m.push(l),m.filter(Boolean).join(" â€¢ ")}).join(`
`));const u=r?` title="${U(r)}"`:"";return{html:`<span class="reservation-chip status-${s}"${u}>${L(n)}</span>`,text:n}}function G(e){return Y(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||i("common.placeholder.empty","â€”","â€”")}function xe(e){const t=le(new Date).replace(/-/g,"");return`${i("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${t}.${e}`}function pt(e,t,n){const o=new Blob([e],{type:n}),s=URL.createObjectURL(o),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function ie(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(s=>{const r=t.map(c=>`"${String(s[c]??"").replace(/"/g,'""')}"`);n.push(r.join(","))});const o=`\uFEFF${n.join(`\r
`)}\r
`;pt(o,xe("csv"),"text/csv;charset=utf-8;")}async function mt(e){try{const t=await $e();if(!t){ie(e);return}const n=t.utils.json_to_sheet(e),o=t.utils.book_new(),s=i("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");t.utils.book_append_sheet(o,n,s),t.writeFile(o,xe("xlsx"))}catch(t){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",t),ie(e)}}async function ht(e=[],t={}){const{exportReportsPdf:n}=await V(async()=>{const{exportReportsPdf:s}=await import("./pdfPages.Wyc22Qox.js");return{exportReportsPdf:s}},__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url),o=t?.action==="print"?"print":"save";await n(e,{action:o})}async function ft(e,t){switch(e){case"pdf":await ht(t);break;case"excel":await mt(t);break;case"csv":default:ie(t);break}}function yt(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${U(n.name)}">
        <td>${L(n.name)}</td>
        <td>${E(n.count)}</td>
        <td>${k(n.revenue)}</td>
      </tr>
    `).join("")}}function gt(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${U(n.name)}">
        <td>${L(n.name)}</td>
        <td>${E(n.count)}</td>
        <td>${k(n.revenue)}</td>
      </tr>
    `).join("")}}function vt(e){const t=document.getElementById("reports-crew-work");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="technician" data-search="${U(n.name)}">
        <td>${L(n.name)}</td>
        <td>${E(n.days)}</td>
        <td>${k(n.billable)}</td>
        <td>${k(n.cost)}</td>
        <td>${k(n.billable-n.cost)}</td>
      </tr>
    `).join("")}}function bt(e){const t=document.getElementById("reports-payment-forecast");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.date}</td>
        <td>${i("reservations.reports.forecast.count","{count} Ø­Ø¬ÙˆØ²Ø§Øª","{count} reservations").replace("{count}",String(n.count||0))}</td>
        <td>${k(n.amount||0)}</td>
      </tr>
    `).join("")}}function xt(e){const t=document.getElementById("reports-top-outstanding");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="reservation" data-search="${U(n.code)}">
        <td>#${L(String(n.code))} â€” ${L(n.customer||"")}</td>
        <td>${L(he(n.paidStatus))}</td>
        <td>${k(n.outstanding)}</td>
      </tr>
    `).join("")}}function kt(e,t=[]){const n=document.getElementById("reports-maintenance-costs");if(!n)return;const o=Array.isArray(e?.items)?e.items:[],s=Array.isArray(t)?t:[];if(!o.length){n.innerHTML=`<tr><td colspan="5" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}const r=i("reservations.reports.maintenance.noEquipment","Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©","Unknown equipment"),c=i("reservations.reports.maintenance.noStatus","ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©","Not specified"),u=h=>{if(!h)return 0;const p=new Date(h).getTime();return Number.isFinite(p)?p:0},y=o.map(h=>{const p=s.find(S=>String(S.id)===String(h.id)),x=p?.equipmentDesc||p?.equipmentBarcode||r,l=p?.statusLabel||p?.status||c,m=p?.equipmentBarcode||"";return{...h,equipment:x,status:l,barcode:m}}).sort((h,p)=>u(p?.date)-u(h?.date));n.innerHTML=y.map(h=>{const p=h?.id!=null?`#${L(String(h.id))}`:i("common.placeholder.empty","â€”","â€”"),x=h?.date?le(h.date):i("common.placeholder.empty","â€”","â€”"),l=L(h.equipment||r),m=L(h.status||c),S=h.barcode?`<div class="text-xs text-base-content/70">${L(h.barcode)}</div>`:"";return`
        <tr>
          <td>${p}</td>
          <td>${l}${S}</td>
          <td>${m}</td>
          <td>${x}</td>
          <td>${k(h.cost||0)}</td>
        </tr>
      `}).join("")}const v=a.filters;function St(e){if(a.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(n=>{const o=n.dataset.columnToggle;o&&(n.checked=a.columnPreferences[o]!==!1,n.addEventListener("change",()=>{a.columnPreferences[o]=n.checked,e()}))}),a.columnControlsBound=!0,e())}function ke(){Object.entries(a.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{n.classList.toggle("hidden",!t)})})}function Et(e){if(a.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(n=>{n.addEventListener("click",async()=>{const{export:o=""}=n.dataset;if(o){n.disabled=!0;try{await e(o)}catch(s){console.error("âš ï¸ [reports] export failed",s)}finally{n.disabled=!1}}})}),a.exportHandlersBound=!0)}function Ct(e,t){a.searchDebounceTimer&&(clearTimeout(a.searchDebounceTimer),a.searchDebounceTimer=null),a.searchDebounceTimer=setTimeout(()=>{v.search=e||"",t()},220)}function wt(e,t){e&&(v.range="custom",v.start=e.startInput||null,v.end=e.endInput||null,t())}function $t(e,t){e&&(v.status=v.status===e?"all":e,t())}function Lt(e,t){e&&(v.payment=v.payment===e?"all":e,t())}function At(e,t){e&&(v.search=e,t())}function Tt({onClear:e}={}){const t=document.getElementById("reservations-active-filters");if(!t)return;const n=[],o=(s,r,c)=>{n.push(`<span class="filter-chip" data-chip="${s}">${r} <button type="button" aria-label="clear" data-clear="${s}">âœ•</button></span>`)};if(v.range&&v.range!=="all"){let s="";switch(v.range){case"last30":s=i("reservations.reports.filters.range.last30","Ø¢Ø®Ø± 30 ÙŠÙˆÙ…","Last 30 days");break;case"thisWeek":s=i("reservations.reports.filters.range.thisWeek","Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","This week");break;case"thisMonth":s=i("reservations.reports.filters.range.thisMonth","Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±","This month");break;case"thisQuarter":s=i("reservations.reports.filters.range.thisQuarter","Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹","This quarter");break;case"thisYear":s=i("reservations.reports.filters.range.thisYear","Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…","This year");break;case"custom":s=`${i("reservations.reports.filters.range.custom","Ù…Ø®ØµØµ","Custom")} (${v.start||i("common.placeholder.empty","â€”","â€”")} â†’ ${v.end||i("common.placeholder.empty","â€”","â€”")})`;break;default:s=v.range}o("range",s)}if(v.status&&v.status!=="all"){const s=i(`reservations.reports.filters.status.${v.status}`,v.status,v.status);o("status",s)}if(v.payment&&v.payment!=="all"){const s=i(`reservations.reports.filters.payment.${v.payment}`,v.payment,v.payment);o("payment",s)}if(v.share&&v.share!=="all"){const s=i(`reservations.reports.filters.share.${v.share}`,v.share,v.share);o("share",s)}v.search&&v.search.trim().length&&o("search",`ğŸ” ${v.search.trim()}`),t.innerHTML=n.join(""),t.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const r=s.dataset.clear;r&&(r==="range"?(v.range="all",v.start=null,v.end=null):r in v&&(r==="search"?v.search="":v[r]="all"),e?.(r))})})}function Mt(e=[],t=[]){const n=document.getElementById("reports-quick-chips");if(!n)return;const o=Array.isArray(e)?e:[],s=Array.isArray(t)?t:[],r=v.status||"all",c=v.payment||"all",u=(l,m,S,f,b)=>`<button type="button" class="${`chip ${b?"chip-active":""}`}" data-quick-${f}="${l}" title="${m}">${m} <span class="chip-count">${S}</span></button>`,y=(l,m)=>l.find(S=>(S.filterKey||"").toLowerCase()===m),h=[];["confirmed","pending","completed","cancelled"].forEach(l=>{const m=y(o,l)||{label:l,rawCount:0};h.push(u(l,m.label||l,m.rawCount||0,"status",r===l))}),h.push('<span style="padding:0 6px;opacity:.6;">|</span>'),["paid","partial","unpaid"].forEach(l=>{const m=y(s,l)||{label:l,rawCount:0};h.push(u(l,m.label||l,m.rawCount||0,"payment",c===l))}),n.innerHTML=h.join("")}const d=a.filters;function O(){try{const e=document.querySelector(".dashboard-header"),t=Math.max(0,Math.round(e?.getBoundingClientRect()?.height||64));document.documentElement.style.setProperty("--reports-sticky-offset",`${t}px`)}catch{}}const Se="reports.presets.v1";function Z(){try{const e=JSON.parse(localStorage.getItem(Se)||"[]");return Array.isArray(e)?e:[]}catch{return[]}}function de(e){try{localStorage.setItem(Se,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function It(e){if(!e||!e.filters)return;const t=e.filters;d.range=t.range??d.range,d.status=t.status??d.status,d.payment=t.payment??d.payment,d.share=t.share??d.share,d.search=t.search??"",d.start=t.start??null,d.end=t.end??null,B(),I(),$()}function re(){const e=document.getElementById("reports-preset-select");if(!e)return;const t=Z();e.innerHTML='<option value="">â€”</option>'+t.map((n,o)=>`<option value="${o}">${n.name||"Preset"}</option>`).join("")}function Pt(){const e=document.getElementById("reports-preset-select"),t=document.getElementById("reports-preset-save"),n=document.getElementById("reports-preset-delete"),o=document.getElementById("reports-preset-share");!e||e.dataset.bound||(re(),e.addEventListener("change",()=>{const s=Number(e.value),r=Z();Number.isInteger(s)&&s>=0&&s<r.length&&It(r[s])}),t?.addEventListener("click",()=>{const s=window.prompt(i("reservations.reports.presets.savePrompt","Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨","Enter preset name"),"Ù‚Ø§Ù„Ø¨");if(!s)return;const r=Z(),c={range:d.range,status:d.status,payment:d.payment,share:d.share,search:d.search||"",start:d.start||null,end:d.end||null},u=r.findIndex(y=>(y.name||"").toLowerCase()===s.toLowerCase());u>=0?r[u]={name:s,filters:c}:r.push({name:s,filters:c}),de(r),re()}),n?.addEventListener("click",()=>{const s=Number(e.value),r=Z();!Number.isInteger(s)||s<0||s>=r.length||window.confirm(i("reservations.reports.presets.deleteConfirm","Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±ØŸ","Delete selected preset?"))&&(r.splice(s,1),de(r),re(),e.value="")}),o?.addEventListener("click",async()=>{try{I(),await new Promise(r=>setTimeout(r,140));const s=window.location.href;await(navigator.clipboard?.writeText?navigator.clipboard.writeText(s):Promise.reject()),console.log("[reports] Link copied")}catch{try{const r=document.createElement("a");r.href=window.location.href,r.target="_blank",document.body.appendChild(r),r.click(),r.remove()}catch{}}}),e.dataset.bound="true")}function ue(){ne(),$(),setTimeout(()=>{ne(),$(),ee(),O()},0),setTimeout(()=>{ne(),$(),ee(),O()},60),ee(),O()}function z(){d.range==="custom"&&$()}function ee(e,t){if(!window.flatpickr)return;e&&(a.startDateInputRef=e),t&&(a.endDateInputRef=t);const n=a.startDateInputRef,o=a.endDateInputRef;if(!n&&!o)return;const s=Dt(),r=c=>{const u={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...c};return s&&(u.locale=s),u};if(a.startDatePicker&&(a.startDatePicker.destroy(),a.startDatePicker=null),a.endDatePicker&&(a.endDatePicker.destroy(),a.endDatePicker=null),n&&(a.startDatePicker=window.flatpickr(n,r({onChange(c,u){d.start=u||null,a.endDatePicker&&(c?.length?a.endDatePicker.set("minDate",c[0]):a.endDatePicker.set("minDate",null)),z()},onValueUpdate(c,u){d.start=u||null,z()}}))),o&&(a.endDatePicker=window.flatpickr(o,r({onChange(c,u){d.end=u||null,a.startDatePicker&&(c?.length?a.startDatePicker.set("maxDate",c[0]):a.startDatePicker.set("maxDate",null)),z()},onValueUpdate(c,u){d.end=u||null,z()}}))),a.startDatePicker&&n){a.startDatePicker.setDate(n.value,!1);const c=a.endDatePicker?.selectedDates?.[0]||a.endDateInputRef?.value;c&&a.startDatePicker.set("maxDate",c)}if(a.endDatePicker&&o){a.endDatePicker.setDate(o.value,!1);const c=a.startDatePicker?.selectedDates?.[0]||a.startDateInputRef?.value;c&&a.endDatePicker.set("minDate",c)}}function Dt(){return(Ye()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function ce(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function B(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),o=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),r=document.getElementById("reports-start"),c=document.getElementById("reports-end"),u=document.getElementById("reports-custom-range");e&&e.value!==d.range&&(e.value=d.range),t&&t.value!==d.status&&(t.value=d.status),n&&n.value!==d.payment&&(n.value=d.payment),o&&o.value!==d.share&&(o.value=d.share),s&&s.value!==d.search&&(s.value=d.search||""),r&&r.value!==(d.start||"")&&(r.value=d.start||""),c&&c.value!==(d.end||"")&&(c.value=d.end||""),ce(u,d.range==="custom")}function Bt(){try{const e=new URLSearchParams(window.location.search),t=o=>e.get(o),n=o=>o==null||o===""?null:o;d.range=t("range")||d.range,d.status=t("status")||d.status,d.payment=t("payment")||d.payment,d.share=t("share")||d.share,d.search=t("search")||"",d.start=n(t("start")),d.end=n(t("end")),d.range!=="custom"&&(d.start=null,d.end=null)}catch{}}let se=null;function I(){se&&clearTimeout(se),se=setTimeout(()=>{try{const e=new URLSearchParams,t=(s,r,c)=>{r!=null&&r!==""&&r!==c&&e.set(s,r)};t("range",d.range,"all"),t("status",d.status,"all"),t("payment",d.payment,"all"),t("share",d.share,"all"),t("search",d.search,""),d.range==="custom"&&(t("start",d.start,null),t("end",d.end,null));const n=e.toString(),o=n?`${location.pathname}?${n}`:location.pathname;window.history.replaceState({},"",o)}catch{}},120)}function Ee({active:e,icon:t,title:n,subtitle:o}){const s=document.getElementById("reports-empty-state");if(!s)return;const r=s.querySelector(".reports-empty-icon"),c=s.querySelector("h4"),u=s.querySelector("p");a.emptyDefaults.icon===null&&r&&(a.emptyDefaults.icon=r.textContent),a.emptyDefaults.title===null&&c&&(a.emptyDefaults.title=c.textContent),a.emptyDefaults.subtitle===null&&u&&(a.emptyDefaults.subtitle=u.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!r||!c||!u)&&(e?(r.textContent=t!==void 0?t:a.emptyDefaults.icon??r.textContent,c.textContent=n!==void 0?n:a.emptyDefaults.title??c.textContent,u.textContent=o!==void 0?o:a.emptyDefaults.subtitle??u.textContent):(r.textContent=a.emptyDefaults.icon??r.textContent,c.textContent=a.emptyDefaults.title??c.textContent,u.textContent=a.emptyDefaults.subtitle??u.textContent))}function Rt(e){Ee({active:!!e})}function pe(e){const t=document.getElementById("reports-kpi-skeleton"),n=document.getElementById("reservations-reports-kpis"),o=document.getElementById("reports-table-skeleton"),s=document.getElementById("reports-reservations-table"),r=document.getElementById("reservations-revenue-skeleton"),c=document.getElementById("reservations-revenue-breakdown");t&&n&&(t.style.display=e?"":"none",n.style.opacity=e?"0.4":"1"),o&&s&&(o.style.display=e?"":"none",s.style.opacity=e?"0.4":"1"),r&&c&&(r.style.display=e?"":"none",c.style.opacity=e?"0.4":"1")}function Nt(){if(a.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),o=document.getElementById("reports-quick-chips"),s=r=>{const c=r.target?.closest("[data-drilldown]");if(!c)return;const u=c.dataset.search||"";At(u,()=>{B(),$()})};e?.addEventListener("click",s),t?.addEventListener("click",s),n?.addEventListener("click",s),o?.addEventListener("click",r=>{const c=r.target?.closest("[data-quick-status], [data-quick-payment]");if(c){if(c.hasAttribute("data-quick-status")){const u=c.getAttribute("data-quick-status")||"all";d.status=d.status===u?"all":u}else if(c.hasAttribute("data-quick-payment")){const u=c.getAttribute("data-quick-payment")||"all";d.payment=d.payment===u?"all":u}B(),I(),$()}}),a.drilldownBound=!0}function j(){W({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function $(){if(B(),I(),Tt({onClear:()=>{B(),I(),$()}}),a.loading){pe(!0);return}if(a.errorMessage){Ee({active:!0,icon:"âš ï¸",title:a.errorMessage,subtitle:i("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}pe(!1);const{reservations:e,customers:t,equipment:n,technicians:o,maintenance:s}=a.data,r=Le(e,d,t,n,o),c=Ae(r),u=Te(s,d),y=Me(c,u.total),h=Ie(r),p=Pe(r),x=De(r),l=Be(r),m=Re(r,t),S=Ne(r,n),f=_e(r,o),b=He(r),C=qe(r,t,5);at(y),Je(h),Ze(p),tt(x),et(l),Mt(p,l),yt(m),gt(S),xt(C),vt(f),kt(u,s);try{bt(b)}catch{}const g=nt(r,t,o);ke(),Rt(r.length===0),a.lastSnapshot.filtered=r,a.lastSnapshot.metrics=y,a.lastSnapshot.trend=h,a.lastSnapshot.statusBreakdown=p,a.lastSnapshot.paymentBreakdown=l,a.lastSnapshot.tableRows=g,a.lastSnapshot.maintenance=u,a.lastSnapshot.outstanding=C,a.lastSnapshot.crewWork=f,a.lastSnapshot.paymentForecast=b}function Ut(){if(a.initialized)return;a.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),o=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),r=document.getElementById("reports-end"),c=document.getElementById("reports-custom-range"),u=document.getElementById("reports-search");if(!e)return;Bt(),B(),O(),Qe()&&$(),e.addEventListener("change",()=>{d.range=e.value,ce(c,d.range==="custom"),d.range!=="custom"&&(d.start=null,d.end=null),I(),$(),W({silent:!0}).catch(()=>{})}),t?.addEventListener("change",()=>{d.status=t.value,I(),$()}),n?.addEventListener("change",()=>{d.payment=n.value,I(),$()}),o?.addEventListener("change",()=>{d.share=o.value,I(),$()}),u?.addEventListener("input",()=>{const p=u.value||"";Ct(p,()=>{B(),I(),$()})}),s?.addEventListener("change",()=>{d.start=s.value||null,I(),z(),d.range==="custom"&&W({silent:!0}).catch(()=>{})}),r?.addEventListener("change",()=>{d.end=r.value||null,I(),z(),d.range==="custom"&&W({silent:!0}).catch(()=>{})}),ee(s,r),ce(c,d.range==="custom"),Pt(),a.languageListenerAttached||(document.addEventListener("language:changed",ue),document.addEventListener("language:translationsReady",ue),a.languageListenerAttached=!0),a.dataListenersAttached||(document.addEventListener("reservations:changed",j),document.addEventListener("customers:changed",j),document.addEventListener("equipment:changed",j),document.addEventListener("projects:changed",j),document.addEventListener("technicians:updated",j),window.addEventListener("maintenance:updated",j),a.dataListenersAttached=!0),St?.(ke),Et(async p=>{const x=a.lastSnapshot.tableRows||[];if(!x.length){console.warn("[reports] No reservation data to export");return}if(p==="pdf")try{const{exportA4ReportPdf:l}=await V(async()=>{const{exportA4ReportPdf:m}=await import("./a4Unified.DHvGw6wR.js");return{exportA4ReportPdf:m}},__vite__mapDeps([8,1,2,3,4,5]),import.meta.url);await l(x,{action:"save",strict:!0});return}catch(l){console.warn("[reports] page-based PDF export failed, falling back to legacy",l)}else if(p==="excel")try{const{exportA4ReportExcel:l}=await V(async()=>{const{exportA4ReportExcel:m}=await import("./a4Unified.DHvGw6wR.js");return{exportA4ReportExcel:m}},__vite__mapDeps([8,1,2,3,4,5]),import.meta.url);await l(x);return}catch(l){console.warn("[reports] A4-based Excel export failed, falling back to legacy",l)}else if(p==="csv")try{const{exportA4ReportCsv:l}=await V(async()=>{const{exportA4ReportCsv:m}=await import("./a4Unified.DHvGw6wR.js");return{exportA4ReportCsv:m}},__vite__mapDeps([8,1,2,3,4,5]),import.meta.url);await l(x);return}catch(l){console.warn("[reports] A4-based CSV export failed, falling back to legacy",l)}await ft(p,x)});const h=document.getElementById("reports-preview-pdf");if(h&&!h.dataset.bound&&(h.addEventListener("click",async()=>{try{const p=await V(()=>import("./preview.DJqy4cXR.js"),__vite__mapDeps([9,1,2,3,4,5,8]),import.meta.url),x=a.lastSnapshot.tableRows||[];p.openReportsPdfPreview(x)}catch(p){console.error("âš ï¸ [reports] Failed to open PDF preview",p)}}),h.dataset.bound="true"),Nt(),a.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>{$(),O()},0)}),a.themeListenerAttached=!0),!a.stickyOffsetListenerAttached){const p=()=>O();window.addEventListener("resize",p),setTimeout(p,100),setTimeout(p,500),a.stickyOffsetListenerAttached=!0}Fe($),je(()=>{$()}),ze(()=>{$()}),Oe(p=>{wt(p,()=>{B(),$()})}),Ue(p=>{$t(p?.filterKey,()=>{B(),$()})}),Ve(p=>{Lt(p?.filterKey,()=>{B(),$()})}),W().catch(p=>{console.error("âŒ [reports] Failed to initialise reports data",p)})}export{Ut as initReports,$ as renderReports};
