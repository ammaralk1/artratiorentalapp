import{d as N,n as _,h as nt,b as P,A as re,a as at,m as it,c as st,i as ot,l as ct,p as ee,t as u,q as rt,w as qe,j as g,x as lt}from"./auth.B1HeefuR.js";const dt=N()||{};let $=(dt.technicians||[]).map(he);function G(){return $}function O(e){return $=Array.isArray(e)?e.map(he):[],nt({technicians:$}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),$}async function Fe(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,l])=>{l!=null&&l!==""&&t.set(a,String(l))});const n=t.toString(),i=await P(`/technicians/${n?`?${n}`:""}`),s=i?.data??i;let o=[];Array.isArray(s)?o=s:s&&typeof s=="object"&&(Array.isArray(s.items)?o=s.items:Array.isArray(s.results)?o=s.results:Array.isArray(s.data)?o=s.data:Array.isArray(s.records)&&(o=s.records));const c=o.map(te);return O(c)}async function ze(e){const t=await P("/technicians/",{method:"POST",body:e}),n=te(t?.data??{});return O([...$,n]),n}async function me(e,t){const n=await P(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=te(n?.data??{}),s=$.map(o=>String(o.id)===String(e)?i:o);return O(s),i}async function De(e){await P(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),O($.filter(t=>String(t.id)!==String(e)))}function pe({name:e,phone:t,email:n,role:i,department:s,dailyWage:o,dailyTotal:c,status:a,notes:l,active:r=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:i??"",department:s??null,daily_wage:o??0,daily_total:c??null,status:a??"available",notes:l??null,active:r?1:0}}function te(e={}){return $e({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function he(e={}){return $e(e)}function $e(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",i=e.phone??"",s=e.email??null,o=e.specialization??e.role??e.position??"",c=e.department??e.team??"",a=Ce(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=Ce(e.daily_total??e.dailyTotal??e.total??e.total_wage??a),r=we(e.baseStatus??e.status??"available"),d=we(e.status??e.baseStatus??"available"),p=e.notes??"",f=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:i,email:s,role:o,department:c,dailyWage:a,dailyTotal:l,status:d,baseStatus:r,notes:p,active:f}}function Ce(e){const t=Number.parseFloat(_(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function we(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function Z(e){return e instanceof re}const sn=Object.freeze(Object.defineProperty({__proto__:null,buildTechnicianPayload:pe,createTechnicianApi:ze,deleteTechnicianApi:De,getTechniciansState:G,isApiError:Z,mapLegacyTechnician:he,mapTechnicianFromApi:te,refreshTechniciansFromApi:Fe,setTechniciansState:O,updateTechnicianApi:me},Symbol.toStringTag,{value:"Module"}));at();it();st();document.addEventListener("DOMContentLoaded",()=>{ot();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ct()),e.dataset.listenerAttached="true")});function Y(e){const t=Number(e)||0,i=ee()==="ar"?"ar-SA-u-nu-latn":"en-US",s=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${_(s)} SR`}function on(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function cn(e){const t=new Date,n=e?.start?new Date(e.start):null,i=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":i&&!Number.isNaN(i.getTime())&&i<t?"completed":"ongoing"}function rn(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function D(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const ut="technicianPositions:updated";let B=[],Me=!1,W=null;function ge(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function Re({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:i??null,label_en:s??null}}function ft(e){return B=Array.isArray(e)?e.map(ge).filter(t=>t.name!=="").sort((t,n)=>j(t).localeCompare(j(n),"ar",{sensitivity:"base"})):[],Me=!0,ne(),q()}function ne(){try{const e={positions:q()},t=new CustomEvent(ut,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function j(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function q(){return B.map(e=>({...e}))}function mt(e){const t=String(e??"").trim().toLowerCase();return t&&B.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function pt({forceRefresh:e=!1}={}){return Me&&!e?q():(W&&!e||(W=P("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return ft(n)}).finally(()=>{W=null})),W)}async function ae({forceRefresh:e=!1}={}){try{return await pt({forceRefresh:e})}catch(t){throw t instanceof re?t:new re(t?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function ht({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}){const o=Re({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}),c=await P("/technician-positions/",{method:"POST",body:o}),a=ge(c?.data??{});return B=[...B,a],B.sort((l,r)=>j(l).localeCompare(j(r),"ar",{sensitivity:"base"})),ne(),a}async function gt(e,{name:t,cost:n,clientPrice:i,labelAr:s,labelEn:o}){if(!e)throw new Error("Position id is required");const c=Re({name:t,cost:n,clientPrice:i,labelAr:s,labelEn:o}),a=await P(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:c}),l=ge(a?.data??{});return B=B.map(r=>r.id===l.id?l:r),B.sort((r,d)=>j(r).localeCompare(j(d),"ar",{sensitivity:"base"})),ne(),l}async function bt(e){if(!e)throw new Error("Position id is required");return await P(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),B=B.filter(t=>t.id!==Number(e)),ne(),q()}const le="__ART_RATIO_TECH_SUB_TAB__",xe=["technicians-management","technicians-positions"];let v=null,Ne=!1,X=!1,K="",de=!1,C=null,M="technicians-management";const Le=It();Le&&(M=Le);async function je({showToastOnError:e=!0}={}){if(!X){X=!0,K="",I();try{await Fe(),de=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),K=Z(t)?t.message:u("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&g(K,"error")}finally{X=!1,I()}}}function Ue(){return G()}function Q(e=""){return _(String(e)).trim().toLowerCase()}function yt(e){return e==null?"":String(e)}function U(e=""){return _(String(e)).replace(/[^0-9+]/g,"")}function A(e=""){const t=_(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...i]=t.split(".");return`${n}.${i.join("")}`}function x(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const i=e.selectionEnd;e.value=n,i!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function It(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(le);return e&&xe.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function vt(e){try{if(typeof window>"u"||!window.localStorage)return;if(!xe.includes(e)){window.localStorage.removeItem(le);return}window.localStorage.setItem(le,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function Ve(e,t=0,n=null){const i=String(e??"").trim(),s=i?mt(i):null;return s?{matchedPosition:s,dailyWage:Number.isFinite(s.cost)?s.cost:0,dailyTotal:s.clientPrice==null?null:Number.isFinite(s.clientPrice)?s.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function He(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function ue(e,t=ee()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Et(e,t=ee()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function Oe(){const{container:e,body:t}=He();!e||!t||(t.textContent="",e.hidden=!0)}function be(e,t={}){const{container:n,body:i}=He();if(!n||!i)return;const s=String(e??"").trim();if(!s){Oe();return}const o=Ve(s,t?.dailyWage??0,t?.dailyTotal??null),c=Y(o.dailyWage||0),a=o.dailyTotal!=null?Y(o.dailyTotal):u("technicians.positionSummary.noClientPrice","â€”");o.matchedPosition?i.textContent=u("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",a):i.textContent=u("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",a),n.hidden=!1}function J(){const e=document.getElementById("technician-position-options");if(!e)return;const t=q(),n=ee(),i=new Set,s=[];t.forEach(o=>{const c=ue(o,n).trim();c&&!i.has(c.toLowerCase())&&(s.push(`<option value="${D(c)}"></option>`),i.add(c.toLowerCase()));const a=Et(o,n).trim();a&&!i.has(a.toLowerCase())&&(s.push(`<option value="${D(a)}"></option>`),i.add(a.toLowerCase()));const l=o.name?.trim();l&&!i.has(l.toLowerCase())&&(s.push(`<option value="${D(l)}"></option>`),i.add(l.toLowerCase()))}),e.innerHTML=s.join("")}function Pe(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),s=t.map(a=>a?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(a=>{if(!a)return;const r=a.getAttribute("data-tech-tab")===s;a.classList.toggle("tab-active",r),a.classList.toggle("active",r),a.setAttribute("aria-selected",r?"true":"false"),a.setAttribute("tabindex",r?"0":"-1")}),n.forEach(a=>{if(!a)return;const r=a.getAttribute("data-tech-tab-panel")===s;a.hidden=!r,a.classList.toggle("active",r)}),M=s,vt(s);const c=t.find(a=>a?.getAttribute("data-tech-tab")===s)?.closest("[data-tab-scroll]");c&&c.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),s==="technicians-positions"&&(w(),ae().then(()=>{w()}).catch(a=>{console.error("âŒ [technicians] failed to load positions for tab switch",a),g(a?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function ye(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",i=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=u(n,i)}function Ie(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=u("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function ve(){ye(v?"update":"add"),Ie(!!v),I()}function St(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,i=Array.from(new Set(e.map(o=>(o?.role||"").trim()).filter(Boolean))).sort((o,c)=>o.localeCompare(c,"ar",{sensitivity:"base"})),s=u("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${s}</option>`+i.map(o=>`<option value="${o}">${o}</option>`).join(""),n&&i.includes(n)?t.value=n:t.value="",t.value}function ie(){const e=document.getElementById("technician-form");e&&(e.reset(),v=null,ye("add"),Ie(!1),Oe())}function At(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),i=document.getElementById("technician-email"),s=document.getElementById("technician-role"),o=document.getElementById("technician-department"),c=document.getElementById("technician-notes");!t||!n||!s||(t.value=e.name||"",n.value=U(e.phone||""),i&&(i.value=e.email||""),s.value=e.role||"",o&&(o.value=e.department||""),c&&(c.value=e.notes||""),v=String(e.id),ye("update"),Ie(!0),be(s.value,e))}function Tt(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-email"),i=document.getElementById("technician-role"),s=document.getElementById("technician-department"),o=document.getElementById("technician-notes");if(!e||!t||!i)return null;const c=e.value.trim(),a=U(t.value.trim());t.value=a;const l=(n?.value||"").trim(),r=i.value.trim(),d=s?.value.trim()||"",p="available",f=o?.value.trim()||"",h=v?ke(v):null,{dailyWage:m,dailyTotal:b}=Ve(r,h?.dailyWage??0,h?.dailyTotal??null);return c?a?r?!Number.isFinite(m)||m<0?(g(u("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):b!=null&&(!Number.isFinite(b)||b<0)?(g(u("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(be(r,{dailyWage:m,dailyTotal:b}),{name:c,phone:a,email:l,role:r,department:d,dailyWage:Number.isFinite(m)?m:0,dailyTotal:b==null?null:Number(b),status:p,baseStatus:p,notes:f}):(g(u("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),i.focus(),null):(g(u("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(g(u("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function Bt(e){e.preventDefault();try{await ae()}catch(i){console.error("âŒ [technicians] failed to load positions before submit",i);const s=i?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(s,"error");return}const t=Tt();if(!t)return;const n=pe({name:t.name,phone:t.phone,email:t.email||null,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{v?(await me(v,n),g(u("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await ze(n),g(u("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),ie(),I()}catch(i){console.error("âŒ [technicians] handleTechnicianSubmit failed",i);const s=Z(i)?i.message:u("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(s,"error")}}function _t(){ie()}function Ct(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),email:document.getElementById("edit-technician-email"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=U(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.email&&t.email.value!==(e.email||"")&&(t.email.value=e.email||""),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const i=A(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==i&&(t.wage.value=i);const s=A(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==s&&(t.total.value=s);const o=e.baseStatus||e.status||"available";t.status.value!==o&&(t.status.value=o),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),x(t.phone,U),x(t.wage,A),x(t.total,A)}function wt(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),i=document.getElementById("edit-technician-email"),s=document.getElementById("edit-technician-role"),o=document.getElementById("edit-technician-department"),c=document.getElementById("edit-technician-wage"),a=document.getElementById("edit-technician-total"),l=document.getElementById("edit-technician-status"),r=document.getElementById("edit-technician-notes");if(!e||!t||!n||!s||!c||!a||!l)return null;const d=e.value.trim(),p=t.value.trim(),f=U(n.value.trim());n.value=f;const h=(i?.value||"").trim(),m=s.value.trim(),b=o?.value.trim()||"",y=A(c.value.trim());c.value=y;const E=y===""?0:parseFloat(y),F=A(a.value.trim());a.value=F;const z=F===""?null:parseFloat(F),_e=l.value||"available",tt=r?.value.trim()||"";return d?p?f?m?Number.isNaN(E)||E<0?(g(u("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),c.focus(),null):z!=null&&(Number.isNaN(z)||z<0)?(g(u("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),a.focus(),null):{id:d,name:p,phone:f,email:h,role:m,department:b,dailyWage:Number.isFinite(E)?E:0,dailyTotal:z==null?null:Number(z),status:_e,baseStatus:_e,notes:tt}:(g(u("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),s.focus(),null):(g(u("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(g(u("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(g(u("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Nt(){const e=wt();if(!e)return;const t=pe({name:e.name,phone:e.phone,email:e.email||null,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await me(e.id,t),g(u("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),I()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const i=Z(n)?n.message:u("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");g(i,"error")}}function I(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Q(t?.value||"");if(X&&!de){const r=u("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}if(K&&!de){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${K}</td></tr>`;return}const i=Se(),{reservations:s=[]}=N(),o=new Date;St(i);const c=document.getElementById("technician-role-filter"),a=Q(c?.value||""),l=i.filter(r=>a&&Q(r.role||"")!==a?!1:n?Q([r.name,r.phone,r.email,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const r=u("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}e.innerHTML=l.map(r=>{const d=v&&String(v)===String(r.id),h=(Ke(r.id,s,o)?"busy":r.status||r.baseStatus||"available")==="busy"?{label:u("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:u("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},m=u("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),b=u("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),y=qe(),E=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${r.id}">${m}</button>`];return y&&E.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${r.id}">${b}</button>`),`
      <tr${d?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${r.id}" class="text-decoration-none">${r.name}</a></td>
        <td>${r.role||""}</td>
        <td>${r.department||"â€”"}</td>
        <td><span class="${h.className}"><span class="technician-status-badge__text">${h.label}</span></span></td>
        <td class="table-notes-cell">${r.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${E.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function se(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function We(e="add"){const{submitBtn:t,cancelBtn:n}=se(),i=e==="update";if(t){const s=i?"positions.form.actions.update":"positions.form.actions.submit",o=i?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=u(s,o)}n&&(n.classList.toggle("d-none",!i),n.textContent=u("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function Ee(){const{form:e,idInput:t,nameArInput:n,nameEnInput:i,costInput:s,clientPriceInput:o}=se();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),i&&(i.value=""),s&&(s.value=""),o&&(o.value=""),C=null,We("add")}function Lt(e){const{idInput:t,nameArInput:n,nameEnInput:i,costInput:s,clientPriceInput:o}=se();!e||!s||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),i&&(i.value=e.labelEn||""),s.value=A(e.cost??0),o&&(o.value=e.clientPrice==null?"":A(e.clientPrice)),C=e.id||null,We("update"))}function Pt(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:i}=se();if(!n)return null;const s=e?.value.trim()||"",o=t?.value.trim()||"",c=o||s,a=C?q().find(f=>String(f.id)===String(C)):null,l=A(n.value.trim());n.value=l;const r=l===""?0:parseFloat(l),d=i?A(i.value.trim()):"";i&&(i.value=d);const p=d===""?null:parseFloat(d);return c?!Number.isFinite(r)||r<0?(g(u("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):p!=null&&(!Number.isFinite(p)||p<0)?(g(u("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),i?.focus(),null):{id:C,name:a?.name||c,cost:Number(r.toFixed(2)),clientPrice:p==null?null:Number(p.toFixed(2)),labelAr:s||null,labelEn:o||null}:(g(u("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function V(){const e=document.getElementById("technician-role");if(!e)return;const t=v?ke(v):null;be(e.value,t||{})}function w(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=q();if(t&&(t.textContent=_(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${u("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(i=>{const s=C&&String(C)===String(i.id),o=Y(i.cost||0),c=i.clientPrice==null?u("technicians.positionSummary.noClientPrice","â€”"):Y(i.clientPrice),a=ue(i,"ar")||"â€”",l=ue(i,"en")||"â€”",r=u("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),d=u("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${s?' class="technician-table-row-editing"':""}>
        <td>${D(a)}</td>
        <td>${D(l)}</td>
        <td>${D(o)}</td>
        <td>${D(c)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${i.id}">${r}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${i.id}">${d}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function qt(e){e.preventDefault();const t=Pt();if(t)try{const n=!!C;n?await gt(t.id,t):await ht(t);const i=n?u("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):u("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");g(i),Ee(),w(),J(),V()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const i=n?.message||u("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(i,"error")}}function Ft(){Ee()}async function zt(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await ae();const i=q().find(s=>String(s.id)===String(n));if(!i){g(u("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}Lt(i),w();return}if(t.classList.contains("position-delete-btn")){if(!confirm(u("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await bt(n),C&&String(C)===String(n)&&Ee(),g(u("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),w(),J(),V()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(n,"error")}}function Dt(e){const t=Ue().find(n=>String(n.id)===String(e));if(!t){g(u("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}At(t),g(u("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function $t(e){if(!qe()){lt();return}if(confirm(u("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await De(e),g(u("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),v&&String(v)===String(e)&&ie(),I()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=Z(t)?t.message:u("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(n,"error")}}function ln(){Ae(),I()}function ke(e){return Ue().find(t=>String(t.id)===String(e))||null}function Mt(e){const t=new Set,n=s=>{if(s==null)return;const o=String(s).trim();o&&t.add(o)},i=s=>{Array.isArray(s)&&s.forEach(o=>{if(o!=null)if(typeof o=="object"){const c=o.id??o.technicianId??o.technician_id??(o.technician&&(o.technician.id??o.technician.technicianId??o.technician.technician_id));n(c)}else n(o)})};return i(e?.technicians),i(e?.techniciansDetails),Array.from(t)}function Rt(e){const t=e?.start??e?.startDatetime??e?.start_datetime??e?.start_date??null,n=e?.end??e?.endDatetime??e?.end_datetime??e?.end_date??null;return{start:t,end:n}}function Ke(e,t=[],n){const i=yt(e);return i?t.some(s=>{if(!s)return!1;const o=String(s?.status||s?.reservationStatus||"").toLowerCase();if(o==="cancelled"||o==="canceled"||!Mt(s).includes(i))return!1;const{start:a,end:l}=Rt(s);if(!a||!l)return!1;const r=new Date(a),d=new Date(l);return Number.isNaN(r.getTime())||Number.isNaN(d.getTime())?!1:r<=n&&n<d}):!1}function Se(){const e=N().reservations||[],t=G();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let i=!1;const s=t.map(o=>{if(!o)return o;const c=o.baseStatus||o.status||"available";let a=c==="busy"?"busy":c;return Ke(o.id,e,n)&&(a="busy"),(a!==o.status||c!==o.baseStatus)&&(i=!0),{...o,baseStatus:c,status:a}});return i?(O(s),s):t}document.addEventListener("reservations:changed",()=>{const e=G();if(Se()===e)try{I()}catch{}});document.addEventListener("reservations:updated",()=>{const e=G();if(Se()===e)try{I()}catch{}});function Ae(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",f=>{Bt(f).catch(h=>{console.error("âŒ [technicians] submit handler failed",h)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",_t),n.dataset.listenerAttached="true"),x(document.getElementById("technician-phone"),U);const i=document.getElementById("technician-role");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{V()}),i.dataset.listenerAttached="true");const s=document.getElementById("technicians-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",f=>{const h=f.target;if(h instanceof HTMLElement){if(h.classList.contains("technician-edit-btn")){const m=h.dataset.id;Dt(m)}if(h.classList.contains("technician-delete-btn")){const m=h.dataset.id;$t(m).catch(b=>{console.error("âŒ [technicians] delete handler failed",b)})}}}),s.dataset.listenerAttached="true");const o=document.getElementById("search-technician-input");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",()=>{o.value=_(o.value),I()}),o.dataset.listenerAttached="true");const c=document.getElementById("technician-role-filter");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{I()}),c.dataset.listenerAttached="true");const a=document.getElementById("save-technician-changes");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{Nt().catch(f=>{console.error("âŒ [technicians] modal save failed",f)})}),a.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",f=>{qt(f).catch(h=>{console.error("âŒ [technicians] position submit failed",h)})}),l.dataset.listenerAttached="true");const r=document.getElementById("position-cancel-btn");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",Ft),r.dataset.listenerAttached="true");const d=document.getElementById("positions-table");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",zt),d.dataset.listenerAttached="true"),x(document.getElementById("position-cost"),A),x(document.getElementById("position-client-price"),A);const p=document.querySelector("[data-tech-tabs]");p&&!p.dataset.listenerAttached&&(p.querySelectorAll("[data-tech-tab]").forEach(h=>{h&&h.addEventListener("click",()=>{const m=h.getAttribute("data-tech-tab");Pe(m)})}),p.dataset.listenerAttached="true"),Pe(M),ae().then(()=>{J(),M==="technicians-positions"&&w(),V()}).catch(f=>{console.error("âŒ [technicians] failed to load technician positions",f),g(f?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),Ne||(document.addEventListener("technician:prefill",f=>{const h=f.detail;h&&Ct(h)}),Ne=!0),t&&ie(),M==="technicians-positions"&&w()}window.addEventListener("DOMContentLoaded",()=>{Ae(),I(),ve(),je()});const Ge=()=>{I()};window.addEventListener("technicians:updated",Ge);document.addEventListener("technicians:updated",Ge);document.addEventListener("technicians:refreshRequested",()=>{Ae(),I(),ve(),je({showToastOnError:!1})});document.addEventListener("language:changed",()=>{ve(),J(),M==="technicians-positions"&&w(),V()});document.addEventListener(rt.USER_UPDATED,()=>{I()});const Ze=()=>{J(),M==="technicians-positions"&&w(),V()};window.addEventListener("technicianPositions:updated",Ze);document.addEventListener("technicianPositions:updated",Ze);function k(e){return _(String(e||"")).trim().toLowerCase()}function xt(e){const t=Number.parseFloat(_(String(e??"1")));return!Number.isFinite(t)||t<=0||t>50?1:Math.max(1,Math.round(t))}function L(e){const t=String(e??"").trim().toLowerCase();return t||""}function Je(){const{packages:e=[]}=N();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function jt(e){const t=L(e);return t&&Je().find(i=>L(i?.id??i?.packageId??i?.package_id)===t)||null}function Te(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(a=>({barcode:a}))),n.forEach(a=>{if(!a)return;if(typeof a=="string"||typeof a=="number"){const f=k(a);if(!f)return;t.push({equipmentId:null,barcode:f,normalizedBarcode:f,qty:1,price:0,desc:""});return}if(typeof a!="object")return;const l=k(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number),r=[a.equipmentId,a.equipment_id,a.itemId,a.item_id,a.id].find(f=>f!=null&&f!==""),d=[a.unit_price,a.unitPrice,a.price,a.daily_rate].find(f=>Number.isFinite(Number(f))),p=[a.quantity,a.qty,a.count].find(f=>f!=null&&String(f).trim()!=="");t.push({equipmentId:r!=null?String(r):null,barcode:a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??"",normalizedBarcode:l,qty:xt(p),price:d!=null?Number(d):0,desc:a.description??a.desc??a.name??"",image:a.image??a.imageUrl??a.img??null})});const i=new Map,{equipment:s=[]}=N()||{},o=new Map,c=new Map;return(Array.isArray(s)?s:[]).forEach(a=>{if(!a||typeof a!="object")return;[a.id,a.equipment_id,a.equipmentId,a.item_id,a.itemId].map(d=>d!=null?String(d):"").filter(Boolean).forEach(d=>{o.has(d)||o.set(d,a)});const r=k(a.barcode);r&&!c.has(r)&&c.set(r,a)}),t.forEach(a=>{if(a.equipmentId&&o.has(a.equipmentId)){const l=o.get(a.equipmentId);if(l){if(a.desc||(a.desc=l.desc||l.description||l.name||""),a.barcode||(a.barcode=l.barcode||""),a.price==null||a.price===0){const r=l.price??l.unit_price,d=Number(r);Number.isFinite(d)&&d>=0&&d<1e6&&(a.price=d)}a.image||(a.image=l.image||l.imageUrl||l.img||null)}}else if(a.normalizedBarcode&&c.has(a.normalizedBarcode)){const l=c.get(a.normalizedBarcode);if(l){if(a.desc||(a.desc=l.desc||l.description||l.name||""),a.barcode||(a.barcode=l.barcode||""),a.price==null||a.price===0){const r=l.price??l.unit_price,d=Number(r);Number.isFinite(d)&&d>=0&&d<1e6&&(a.price=d)}a.image||(a.image=l.image||l.imageUrl||l.img||null)}}}),t.forEach(a=>{const l=a.normalizedBarcode||(a.barcode?k(a.barcode):""),r=l||(a.equipmentId?`id:${a.equipmentId}`:null);if(!r)return;if(!i.has(r)){i.set(r,{...a,normalizedBarcode:l});return}const d=i.get(r);d.qty+=a.qty,!d.price&&a.price&&(d.price=a.price),!d.desc&&a.desc&&(d.desc=a.desc),!d.image&&a.image&&(d.image=a.image)}),Array.from(i.values())}function Ut(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const i of t){const s=Number(i);if(Number.isFinite(s))return s}return Te(e).reduce((i,s)=>i+(s.price||0)*(s.qty||1),0)}function Vt(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Ht(){return Je().map(t=>{const n=L(t?.id??t?.packageId??t?.package_id??t?.code),i=Vt(t)||n||"package",s=Ut(t);return{id:n,name:i,price:s,code:t?.package_code??t?.code??n,items:Te(t),raw:t}}).filter(t=>t.id)}function Ot(e){const t=k(e);return t?Ht().filter(n=>n.items.some(i=>i.normalizedBarcode===t)):[]}function Wt(e){return Te(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let H=[],Qe=[],Xe=[],Ye="single";function dn(){return H}function un(e){H=Array.isArray(e)?e:[]}function fn(e){H=[...H,e]}function mn(e){Number.isInteger(e)&&e>=0&&(H=H.filter((t,n)=>n!==e))}function pn(){return Qe}function hn(e){Qe=Array.isArray(e)?e:[]}function gn(){return Xe}function bn(e){Xe=Array.isArray(e)?e:[]}function yn(e){}function In(){return Ye==="package"?"package":"single"}function vn(e){Ye=e==="package"?"package":"single"}function En(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[i="",s=""]=n.split("T"),o=i?i.slice(0,10):"",c=s.match(/(\d{1,2}:\d{2})/);let a="";if(c){const[l="00",r="00"]=c[0].split(":");a=`${l.padStart(2,"0")}:${r.padStart(2,"0")}`}return{date:o,time:a}}function Sn(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function T(e){return _(String(e||"")).trim().toLowerCase()}const kt=864e13;function S(e){if(!e&&e!==0)return null;if(e instanceof Date){const i=e.getTime();return Number.isNaN(i)?null:new Date(i)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const i=new Date(e);return Number.isNaN(i.getTime())?null:i}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const s=new Date(i);if(!Number.isNaN(s.getTime()))return s}}if(!t.includes("T")&&t.includes(" ")){const i=t.indexOf(" ");t=`${t.slice(0,i)}T${t.slice(i+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const i=new Date(`${t}Z`);if(!Number.isNaN(i.getTime()))return i}return null}function An(e,t,n,i=null){if(!e||!t||!n)return!1;const s=S(t),o=S(n);if(!s||!o||s>=o)return!1;const c=T(e);if(!c)return!1;const a=N()||{},l=Array.isArray(a.reservations)?a.reservations:[],r=Array.isArray(a.maintenance)?a.maintenance:[],d=Array.isArray(a.equipment)?a.equipment:[],p=nn(d),f=oe(i);return l.some(m=>{if(!m||ce(m,f)||!m.start||!m.end)return!1;const b=String(m?.status||m?.reservationStatus||"").toLowerCase();if(b==="cancelled"||b==="canceled")return!1;const y=S(m.start),E=S(m.end);return!y||!E||!(y<o&&E>s)?!1:Gt(m,c)})?!0:r.some(m=>{if(!Qt(m)||!Yt(m,p).has(c))return!1;const{start:y,end:E}=en(m);if(!y&&!E)return!0;const F=y??new Date(0),z=E??new Date(kt);return F<o&&z>s})}function Kt(e,t,n,i=null){const s=L(e);if(!s||!t||!n)return!1;const o=S(t),c=S(n);if(!o||!c||o>=c)return!1;const a=N()||{},l=Array.isArray(a.reservations)?a.reservations:[],r=oe(i);return l.some(d=>{if(!d?.start||!d?.end||ce(d,r))return!1;const p=String(d?.status||d?.reservationStatus||"").toLowerCase();if(p==="cancelled"||p==="canceled")return!1;const f=S(d.start),h=S(d.end);return!f||!h||!(f<c&&h>o)?!1:Zt(d,s)})}function Tn(e,t,n,i=null){const s=T(e);if(!s||!t||!n)return[];const o=Ot(s);return o.length?o.filter(c=>Kt(c.id,t,n,i)):[]}function et(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(i=>{const s=e[i];Array.isArray(s)&&s.length&&t.push(s)}),t}function Gt(e,t){if(!t||!e||typeof e!="object")return!1;const n=T(e?.barcode);if(n&&n===t)return!0;const i=et(e);for(const s of i)for(const o of s)if(Jt(o).has(t))return!0;return!1}function Zt(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const o of n){if(!o&&o!==0)continue;const c=L(o);if(c&&c===t)return!0}const i=e.packages;if(Array.isArray(i))for(const o of i){const c=L(o);if(c&&c===t)return!0}const s=et(e);for(const o of s)for(const c of o)if(Be(c).has(t))return!0;return!1}function Jt(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const o=T(e);return o&&t.add(o),t}if(typeof e!="object")return t;const n=T(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(o=>{const c=e[o];Array.isArray(c)&&c.forEach(a=>{if(a!=null){if(typeof a=="string"||typeof a=="number"){const l=T(a);l&&t.add(l);return}if(typeof a=="object"){const l=T(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number);l&&t.add(l)}}})});const s=Be(e);return s.size&&s.forEach(o=>{const c=jt(o);if(!c)return;Wt(c).forEach(l=>{const r=l.normalizedBarcode??T(l.barcode);r&&t.add(r)})}),t}function Be(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(i=>{const s=L(i);s&&t.add(s)}),e.package&&typeof e.package=="object"&&Be(e.package).forEach(s=>t.add(s)),Array.isArray(e.packages)&&e.packages.forEach(i=>{const s=L(i);s&&t.add(s)}),t}function Qt(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(tn(e))return!1;for(const n of t){const i=Xt(n);if(i){if(i==="completed"||i==="cancelled"||i==="closed")return!1;if(i==="open"||i==="in_progress")return!0}}return!0}function Xt(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function Yt(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(c=>{const a=T(c);a&&n.add(a)});const s=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(s){const c=T(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);c&&n.add(c)}return[e?.equipmentId,e?.equipment_id,s?.id,s?.equipmentId,s?.equipment_id].map(c=>c!=null?String(c):"").filter(Boolean).forEach(c=>{const a=t.get(c);if(!a)return;const l=T(a?.barcode??a?.equipmentBarcode??a?.code??a?.serial??a?.serialNumber??a?.serial_number);l&&n.add(l)}),n}function en(e){const t=fe([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=fe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function tn(e){return!!fe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function fe(e=[]){for(const t of e){const n=S(t);if(n)return n}return null}function nn(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{t.has(s)||t.set(s,n)})}),t}function Bn(e,t,n,i=null){if(!e||!t||!n)return!1;const s=new Date(t),o=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:c=[]}=N(),a=String(e),l=oe(i);return c.some(r=>{if(!r?.start||!r?.end||ce(r,l))return!1;const d=String(r?.status||r?.reservationStatus||"").toLowerCase();if(d==="cancelled"||d==="canceled")return!1;const p=new Date(r.start),f=new Date(r.end);return Number.isNaN(p.getTime())||Number.isNaN(f.getTime())||!(p<o&&f>s)?!1:(Array.isArray(r.technicians)?r.technicians:[]).some(b=>String(b)===a)})}function _n(e,t,n,i=null){if(!e||!t||!n)return[];const s=S(t),o=S(n);if(!s||!o||s>=o)return[];const{reservations:c=[]}=N(),a=String(e),l=oe(i),r=[];return c.forEach(d=>{if(!d?.start||!d?.end||ce(d,l))return;const p=String(d?.status||d?.reservationStatus||"").toLowerCase();if(p==="cancelled"||p==="canceled")return;const f=S(d.start),h=S(d.end);if(!f||!h||!(f<o&&h>s)||!(Array.isArray(d.technicians)?d.technicians:[]).some(y=>String(y)===a))return;const b=d.reservationCode||d.reservation_code||null;if(b)r.push(String(b));else if(d.id!=null||d.reservationId!=null){const y=d.id??d.reservationId;r.push(`#${String(y)}`)}}),Array.from(new Set(r))}function oe(e){return R(e,new Set)}function ce(e,t){if(!t||t.size===0)return!1;const n=R([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const i of n)if(t.has(i))return!0;return!1}function R(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(o=>R(o,t)),t;if(Array.isArray(e))return e.forEach(o=>R(o,t)),t;if(typeof e=="object"){const o=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return o.forEach(a=>{Object.prototype.hasOwnProperty.call(e,a)&&(c=!0,R(e[a],t))}),c||Object.values(e).forEach(a=>R(a,t)),t}const n=_(String(e??"")).trim();if(!n)return t;const i=[n,n.toLowerCase(),n.toUpperCase()],s=n.replace(/\D+/g,"");if(s){i.push(s);const o=Number.parseInt(s,10);Number.isNaN(o)||i.push(String(o))}return i.forEach(o=>{o&&t.add(o)}),t}export{En as A,L as B,un as C,jt as D,Ut as E,Vt as F,bn as G,vn as H,hn as I,q as J,mt as K,Je as L,ae as M,sn as N,ln as a,Te as b,on as c,cn as d,D as e,Y as f,ke as g,pn as h,Ht as i,yn as j,dn as k,Sn as l,te as m,T as n,gn as o,Tn as p,An as q,Fe as r,Se as s,rn as t,fn as u,In as v,mn as w,Kt as x,Bn as y,_n as z};
