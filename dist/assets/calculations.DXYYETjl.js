import{n as J,E as j,F as k,a as at,z as ot,d as rt}from"./reservationsService.D8CkOg2K.js";import{t as Y,n as A,p as V}from"./auth.BLFzWQsL.js";const g={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,lastFetchSignature:null,lastFetchAt:0,pendingFetchSignature:null,pendingFetchForce:!1,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function ft(t){g.callbacks.onRender=typeof t=="function"?t:null}function ht(t){g.callbacks.onBeforeRender=typeof t=="function"?t:null}function gt(t){g.callbacks.onAfterRender=typeof t=="function"?t:null}function yt(t){g.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function wt(t){g.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function bt(t){g.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function L(t){if(g.loadedScripts.has(t))return g.loadedScripts.get(t);const e=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,r=new Promise((a,s)=>{const n=()=>{e&&(e.dataset.loaded="true"),a()},o=l=>s(l);if(e){if(e.dataset.loaded==="true"){a();return}e.addEventListener("load",n,{once:!0}),e.addEventListener("error",o,{once:!0});return}const i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>{i.dataset.loaded="true",a()},i.onerror=l=>s(l),document.head.appendChild(i)});return g.loadedScripts.set(t,r),r}function St(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(g.apexChartsReady||(g.apexChartsReady=L("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),g.apexChartsReady)}function K(t,e=1500){return new Promise((r,a)=>{const s=setTimeout(()=>r(null),Math.max(200,e));t.then(n=>{clearTimeout(s),r(n)},n=>{clearTimeout(s),r(null)})})}async function st(){try{const t=await fetch("/vendor/html2pdf.bundle.min.js",{method:"GET",cache:"no-cache"});if(!t.ok)return!1;const e=(t.headers.get("content-type")||"").toLowerCase();if(!(e.includes("javascript")||e.includes("ecmascript")))return!1;const r=await t.text();if(!r||/<\s*!doctype\s+html/i.test(r))return!1;const a=new Blob([r],{type:"text/javascript"}),s=URL.createObjectURL(a);await L(s);try{URL.revokeObjectURL(s)}catch{}return typeof window.html2pdf<"u"}catch{return!1}}function Nt(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(g.html2PdfReady||(g.html2PdfReady=(async()=>await K(st(),1200)&&window.html2pdf?window.html2pdf:(await K(L("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"),2e3),window.html2pdf||null))()),g.html2PdfReady)}function Dt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(g.xlsxReady||(g.xlsxReady=L("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),g.xlsxReady)}function Mt(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(g.jsZipReady||(g.jsZipReady=L("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),g.jsZipReady)}function S(t,e,r=e){const s=V()==="en"?r??e:e;return Y(t,s)}function Tt(){g.formatters.cachedLocale=null,g.formatters.numberFormatter=null}function z(){return(V()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function G(){const t=V();if(t!==g.formatters.cachedLocale||!g.formatters.numberFormatter||!g.formatters.currencyFormatter){g.formatters.cachedLocale=t;const e=z();g.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),g.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:g.formatters.numberFormatter,currencyFormatter:g.formatters.currencyFormatter}}function Ct(t){const{numberFormatter:e}=G(),r=e.format(Math.round(t||0));return A(r)}function Ft(t){const{currencyFormatter:e}=G(),r=Number.isFinite(Number(t))?Number(t):0,a=e.format(r);return`${A(a)} SR`}function I(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const r=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${r}-${a}-${s}`}function At(t){if(!t)return Y("common.placeholder.empty","—");const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return Y("common.placeholder.empty","—");const r=new Intl.DateTimeFormat(z(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return A(r.format(e))}function Q(t){return new Intl.DateTimeFormat(z(),{month:"short"}).format(t)}const ct=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["مغلق","completed"],["مغلقة","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),O=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),$=1440*60*1e3,N={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map,equipmentCost:new Map};function x(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const r=t[0]||{},a=t[e-1]||{},s=`${r.id??r.reservationId??""}-${r.start??""}`,n=`${a.id??a.reservationId??""}-${a.start??""}`,o=g.formatters?.cachedLocale||"ar";return`${e}|${s}|${n}|${o}`}function P(t,e){return t.get(e)}function E(t,e,r){if(t.set(e,r),t.size>64){const a=t.keys().next().value;t.delete(a)}return r}function tt(t){return A(String(t||"")).toLowerCase().trim()}function _(t){return(t||"").toString().trim()}function H(t,e){if(!t||!e)return 1;const r=new Date(t),a=new Date(e);if(Number.isNaN(r.getTime())||Number.isNaN(a.getTime()))return 1;const s=a.getTime()-r.getTime();return s<=0?1:Math.max(1,Math.ceil(s/$))}function X(t){return t?(g.techniciansIndex||(g.techniciansIndex=new Map((g.data.technicians||[]).map(e=>[String(e.id),e]))),g.techniciansIndex.get(String(t))||null):null}function B(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const r of e){if(r==null)continue;const a=Number.parseFloat(A(String(r)));if(Number.isFinite(a))return a}return 0}function Z(t={}){const e=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const r of e){if(r==null)continue;const a=Number.parseFloat(A(String(r)));if(Number.isFinite(a))return a}return B(t)}function R(t){if(!t)return{rentalDays:1,equipmentTotal:0,equipmentCostTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;H(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,r=t.discountType||t.discount_type||"percent",a=String(r).toLowerCase()==="amount"?"amount":"percent",s=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",n=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,o=n!=null?j(n):Number.NaN,l=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(o)&&o>0?o:null,d=Array.isArray(t.crewAssignments)?t.crewAssignments:[],m=d.length?d.map(y=>y?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],c=rt({items:Array.isArray(t.items)?t.items:[],technicianIds:m,crewAssignments:d,discount:e,discountType:a,applyTax:s,start:t.start,end:t.end,companySharePercent:l}),u=Number(t.cost);let p=c.finalTotal,f=c.taxAmount;if(Number.isFinite(u)&&u>0&&(p=k(u),s)){const y=p-c.taxableAmount;Number.isFinite(y)&&y>=0&&(f=k(y))}const h={rentalDays:c.rentalDays,equipmentTotal:c.equipmentTotal,equipmentCostTotal:c.equipmentCostTotal,crewTotal:c.crewTotal,crewCostTotal:c.crewCostTotal,discountAmount:c.discountAmount,subtotalAfterDiscount:c.subtotalAfterDiscount,taxableAmount:c.taxableAmount,taxAmount:f,finalTotal:p,companySharePercent:c.companySharePercent,companyShareAmount:c.companyShareAmount,netProfit:c.netProfit,companyShareEnabled:c.companySharePercent>0};return t.__financials=h,h}function et(t){return t?.projectId&&g.data.projectsMap.get(String(t.projectId))||null}function W(t=""){const e=String(t).toLowerCase().trim();return e?ct.get(e)||e:""}function lt(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const r of e){const a=String(r||"").toLowerCase().trim();if(a&&O.has(a))return O.get(a)}return t?.paid===!0||t?.paid==="true"}function D(t){const e=et(t),r=at(t,e),a=W(r.projectStatus);let s=W(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");r.projectLinked&&a&&s!=="cancelled"&&(s=a),s||(s=r.effectiveConfirmed?"confirmed":"pending"),s!=="cancelled"&&(ot(t)||a==="completed")&&(s="completed");let n=r.effectiveConfirmed||s==="confirmed"||s==="completed";s==="cancelled"&&(n=!1),n&&s!=="completed"&&s!=="cancelled"&&(s="confirmed");const o=lt(t),i=t?.paidStatus??t?.paid_status??(o?"paid":"unpaid");return{statusValue:s,confirmed:n,paid:o,paidStatus:i}}function Rt(t){const e=t.length;let r=0,a=0,s=0,n=0,o=0,i=0,l=0,d=0,m=0,c=0,u=0,p=0,f=0,h=0;t.forEach(b=>{const{statusValue:w,confirmed:T,paid:C,paidStatus:M}=D(b);if(w==="completed"&&(a+=1),w==="cancelled"&&(s+=1),T&&(r+=1),C&&w!=="cancelled"&&(n+=1),w!=="cancelled"&&M!=="paid"&&(o+=1),w!=="cancelled"){const F=R(b);i+=F.finalTotal,l+=F.companyShareAmount,d+=F.taxAmount,m+=F.crewTotal,c+=F.crewCostTotal??0,u+=F.equipmentTotal??0,p+=F.equipmentCostTotal??0,f+=F.netProfit;const q=U(b);Number.isFinite(q)&&q>0&&(h+=q)}});const y=e?i/e:0;return{total:e,confirmed:r,completed:a,cancelled:s,activeTotal:Math.max(0,e-s),paidCount:n,unpaidCount:o,outstandingTotal:h,revenue:i,average:y,companyShareTotal:l,taxTotal:d,crewTotal:m,crewCostTotal:c,equipmentTotal:u,equipmentCostTotal:p,netProfit:f}}function nt({range:t,start:e,end:r}){const a=new Date;if(a.setHours(23,59,59,999),t==="custom"||e||r){const o=e?new Date(`${e}T00:00:00`):null,i=r?new Date(`${r}T23:59:59`):null;return{startDate:v(o)?o:null,endDate:v(i)?i:null}}let s=new Date(a),n=null;switch(t){case"thisWeek":{const o=new Date(a),l=(o.getDay()-6+7)%7;o.setDate(o.getDate()-l),o.setHours(0,0,0,0);const d=new Date(o);d.setDate(o.getDate()+6),d.setHours(23,59,59,999),n=o,s=d;break}case"thisMonth":{n=new Date(a.getFullYear(),a.getMonth(),1),s=new Date(a.getFullYear(),a.getMonth()+1,0),s.setHours(23,59,59,999);break}case"thisQuarter":{const o=Math.floor(a.getMonth()/3);n=new Date(a.getFullYear(),o*3,1),s=new Date(a.getFullYear(),(o+1)*3,0),s.setHours(23,59,59,999);break}case"thisYear":{n=new Date(a.getFullYear(),0,1),s=new Date(a.getFullYear(),12,0),s.setHours(23,59,59,999);break}case"all":default:n=null,s=null;break}return n&&n.setHours(0,0,0,0),{startDate:n,endDate:s}}function v(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function xt(t,e){const{startDate:r,endDate:a}=nt(e);let s=0;const n=[];return(t||[]).forEach(o=>{if(!o)return;const i=typeof o.repairCost=="number"?o.repairCost:Number.parseFloat(A(String(o.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const l=String(o.statusRaw??o.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const m=o.resolvedAt??o.resolved_at??null,c=o.reportedAt??o.reported_at??null,u=o.createdAt??o.created_at??null,p=m?new Date(m):null,f=c?new Date(c):u?new Date(u):null,h=p&&!Number.isNaN(p.getTime())?p:f&&!Number.isNaN(f.getTime())?f:null;if(h&&(r&&h<r||a&&h>a))return;const y=Math.round(i*100)/100;s+=y,n.push({id:o.id,cost:y,date:h})}),{total:s,items:n}}function Pt(t,e){const r=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:r,netProfit:(t.netProfit||0)-r}}function Et(t){const e=`trend:${x(t)}`,r=P(N.trend,e);if(r)return r;const a=new Date,s=[],n=(t||[]).map(l=>l?.start?new Date(l.start):null).filter(l=>l&&!Number.isNaN(l.getTime()));let o=6,i=new Date(a.getFullYear(),a.getMonth(),1);if(n.length){const l=new Date(Math.min(...n.map(f=>f.getTime()))),d=new Date(Math.max(...n.map(f=>f.getTime()))),m=new Date(l.getFullYear(),l.getMonth(),1);i=new Date(d.getFullYear(),d.getMonth(),1);const c=i.getFullYear()-m.getFullYear(),u=i.getMonth()-m.getMonth(),p=c*12+u;o=Math.min(12,Math.max(6,p+1))}for(let l=o-1;l>=0;l-=1){const d=new Date(i.getFullYear(),i.getMonth()-l,1),m=d.getFullYear(),c=d.getMonth(),u=t.filter(C=>{const M=C?.start?new Date(C.start):null;return M&&M.getFullYear()===m&&M.getMonth()===c}).filter(C=>D(C).statusValue!=="cancelled"),p=u.length;let f=0,h=0,y=0;u.forEach(C=>{const M=R(C);f+=M.finalTotal,h+=M.netProfit,y+=M.companyShareAmount});const b=Q(d),w=new Date(d.getFullYear(),d.getMonth(),1),T=new Date(d.getFullYear(),d.getMonth()+1,0);s.push({label:b,count:p,revenue:f,netProfit:h,companyShare:y,periodStart:w,periodEnd:T,startInput:I(w),endInput:I(T)})}try{const l=new Map;(t||[]).forEach(c=>{if(D(c).statusValue==="cancelled")return;const u=c?.start?new Date(c.start):null;if(!u||Number.isNaN(u.getTime()))return;const p=`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`,f=R(c),h=l.get(p)||0;l.set(p,h+(Number(f.finalTotal)||0))});const d=s.map(c=>Number(c.revenue||0)),m=s.map((c,u)=>u<2?null:(d[u]+d[u-1]+d[u-2])/3);s.forEach((c,u)=>{const p=u>0?Number(s[u-1]?.revenue||0):null;let f=null;p!=null&&Number.isFinite(p)&&p>0&&(f=(Number(c.revenue||0)-p)/p*100);const h=c.periodStart instanceof Date?c.periodStart:null;let y=null;if(h&&!Number.isNaN(h.getTime())){const b=`${h.getFullYear()-1}-${String(h.getMonth()+1).padStart(2,"0")}`,w=l.get(b);Number.isFinite(w)&&w>0&&(y=(Number(c.revenue||0)-w)/w*100)}c.momChange=f,c.yoyChange=y,c.movingAvgRevenue=m[u]})}catch{}return E(N.trend,e,s)}function kt(t){const e=new Date,r=(t||[]).map(o=>o?.start?new Date(o.start):null).filter(o=>o&&!Number.isNaN(o.getTime()));let a=6,s=new Date(e.getFullYear(),e.getMonth(),1);if(r.length){const o=new Date(Math.min(...r.map(u=>u.getTime()))),i=new Date(Math.max(...r.map(u=>u.getTime()))),l=new Date(o.getFullYear(),o.getMonth(),1);s=new Date(i.getFullYear(),i.getMonth(),1);const d=s.getFullYear()-l.getFullYear(),m=s.getMonth()-l.getMonth(),c=d*12+m;a=Math.min(12,Math.max(6,c+1))}const n=[];for(let o=a-1;o>=0;o-=1){const i=new Date(s.getFullYear(),s.getMonth()-o,1),l=i.getFullYear(),d=i.getMonth();let m=0,c=0;(t||[]).forEach(u=>{const p=u?.start?new Date(u.start):null;if(!p||p.getFullYear()!==l||p.getMonth()!==d)return;const{statusValue:f,confirmed:h}=D(u);f==="cancelled"?c+=1:(h||f==="confirmed"||f==="completed")&&(m+=1)}),n.push({label:Q(i),confirmed:m,cancelled:c})}return n}function Lt(t){const e=`status:${x(t)}`,r=P(N.status,e);if(r)return r;const a={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(m=>{const{statusValue:c,confirmed:u}=D(m);c==="completed"?a.completed+=1:c==="cancelled"?a.cancelled+=1:c==="confirmed"||u?a.confirmed+=1:a.pending+=1});const s=Math.max(1,(t||[]).length),n=a.confirmed,o=a.pending,i=a.completed,l=a.cancelled,d=[{label:S("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:n,percent:Math.round(n/s*100)||0,rawCount:n,className:"status-confirmed",filterKey:"confirmed"},{label:S("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:o,percent:Math.round(o/s*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:S("reservations.reports.status.completedLabel","مغلقة","Closed"),value:i,percent:Math.round(i/s*100)||0,rawCount:i,className:"status-completed",filterKey:"completed"},{label:S("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:l,percent:Math.round(l/s*100)||0,rawCount:l,className:"status-cancelled",filterKey:"cancelled"}];return E(N.status,e,d)}function _t(t){const e=`payment:${x(t)}`,r=P(N.payment,e);if(r)return r;const a=t.length||1;let s=0,n=0,o=0;(t||[]).forEach(l=>{const{paidStatus:d}=D(l);d==="paid"?s+=1:d==="partial"?n+=1:o+=1});const i=[{label:S("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:s,percent:Math.round(s/a*100)||0,rawCount:s,className:"status-paid",filterKey:"paid"},{label:S("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:n,percent:Math.round(n/a*100)||0,rawCount:n,className:"status-partial",filterKey:"partial"},{label:S("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-unpaid",filterKey:"unpaid"}];return E(N.payment,e,i)}function qt(t,e){const r=`topCustomers:${x(t)}`,a=P(N.topCustomers,r);if(a)return a;const s=new Map,n=new Map((e||[]).map(i=>[String(i.id),i]));t.forEach(i=>{const{statusValue:l}=D(i);if(l==="cancelled")return;const d=String(i?.customerId??"unknown"),m=s.get(d)||{count:0,revenue:0},c=R(i);m.count+=1,m.revenue+=c.finalTotal,s.set(d,m)});const o=Array.from(s.entries()).map(([i,l])=>({name:n.get(i)?.customerName||S("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:l.count,revenue:l.revenue})).sort((i,l)=>l.revenue-i.revenue).slice(0,5);return E(N.topCustomers,r,o)}function jt(t,e){const r=`topEquipment:${x(t)}`,a=P(N.topEquipment,r);if(a)return a;const s=new Map,n=new Map((e||[]).map(l=>[_(l?.barcode),l])),o=S("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(l=>{(l?.items||[]).forEach(d=>{const m=_(d?.barcode),c=m?n.get(m):null,u=d?.desc||d?.description||d?.name||c?.desc||c?.description||c?.name||"",p=u&&u.trim()?u:o,f=J(p)||"unknown",h=Number(d?.qty)||1,y=Number(d?.price)||0,b=h*y,w=s.get(f)||{name:p,count:0,revenue:0};w.name=p,w.count+=h,w.revenue+=b,s.set(f,w)})});const i=Array.from(s.values()).sort((l,d)=>d.count!==l.count?d.count-l.count:d.revenue-l.revenue).slice(0,5);return E(N.topEquipment,r,i)}function Yt(t){const e=`equipmentCost:${x(t)}`,r=P(N.equipmentCost,e);if(r)return r;const a=new Map,s=S("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");(t||[]).forEach(o=>{const{statusValue:i}=D(o);if(i==="cancelled")return;const l=Math.max(1,H(o?.start,o?.end));(Array.isArray(o?.items)?o.items:[]).forEach(m=>{const c=m?.desc||m?.description||m?.name||"",u=c&&c.trim()?c:s,p=J(u)||u,f=Number(m?.qty??m?.quantity??1)||1,h=j(m?.price??m?.unit_price??m?.unitPrice??0),y=j(m?.unitCost??m?.unit_cost??m?.cost??0),b=k(f*h*l),w=k(f*y*l),T=a.get(p)||{name:u,quantity:0,billable:0,cost:0};T.name=u,T.quantity+=f,T.billable+=b,T.cost+=w,a.set(p,T)})});const n=Array.from(a.values()).map(o=>({...o,net:k(o.billable-o.cost)})).sort((o,i)=>i.cost!==o.cost?i.cost-o.cost:i.billable!==o.billable?i.billable-o.billable:(i.quantity||0)-(o.quantity||0)).slice(0,10);return E(N.equipmentCost,e,n)}function It(){Object.values(N).forEach(t=>t.clear())}function it(t,e,r,a,s){const n=[],o=t?.reservationId||t?.id;o&&n.push(o),t?.notes&&n.push(t.notes);const{statusValue:i,paidStatus:l}=D(t);i&&n.push(i);const d=t?.paymentStatus||t?.payment_status;d&&n.push(d),t?.paid!=null&&n.push(t.paid?"paid":"unpaid"),l&&n.push(l);const m=r.get(String(t?.customerId));m&&n.push(m.customerName,m.company_name||m.companyName,m.contact_person||"");const c=et(t);return c&&n.push(c.title,c.code,c.status),n.push(ut(l)),(t?.items||[]).forEach(p=>{p?.desc&&n.push(p.desc),p?.barcode&&n.push(p.barcode);const f=a.get(_(p?.barcode));f&&n.push(f.desc,f.description,f.name)}),(t?.technicians||[]).forEach(p=>{const f=s.get(String(p));f&&n.push(f.name,f.role,f.department)}),tt(n.filter(Boolean).join(" ")).includes(e)}function $t(t,e,r,a,s){const{startDate:n,endDate:o}=nt(e),i=tt(e.search),l=!!i,d=new Map((r||[]).map(u=>[String(u.id),u])),m=new Map((a||[]).map(u=>[_(u?.barcode),u])),c=new Map((s||[]).map(u=>[String(u.id),u]));return(t||[]).filter(u=>{if(u&&u.projectId!=null&&String(u.projectId).trim()!=="")return!1;const p=u?.start?new Date(u.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let f=u?.end?new Date(u.end):p;if(Number.isNaN(f.getTime())&&(f=p),n&&f<n||o&&p>o)return!1;const{statusValue:h,confirmed:y,paid:b,paidStatus:w}=D(u);if(!(h==="confirmed"||h==="completed")||e.status==="confirmed"&&!(h==="confirmed"||h==="completed"||y)||e.status==="pending"&&h!=="pending"||e.status==="completed"&&h!=="completed"||e.status==="cancelled"&&h!=="cancelled"||e.payment==="paid"&&!b||e.payment==="unpaid"&&b||e.payment==="partial"&&w!=="partial")return!1;if(e.share&&e.share!=="all"){const M=R(u).companySharePercent>0;if(e.share==="with"&&!M||e.share==="without"&&M)return!1}return!(l&&!it(u,i,d,m,c))})}function ut(t){const e=String(t??"").toLowerCase();return e==="paid"?S("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?S("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):S("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Bt(t,e){const r=new Map((e||[]).map(n=>[String(n.id),n])),a=new Map;return(t||[]).forEach(n=>{const{statusValue:o}=D(n);if(o==="cancelled")return;const i=H(n.start,n.end),l=Array.isArray(n.crewAssignments)?n.crewAssignments:[];if(l.length){l.forEach(m=>{const c=m?.technicianId!=null?String(m.technicianId):null;if(!c)return;const u=r.get(c)||X(c)||{},p=Number.isFinite(Number(m?.positionClientPrice))&&Number(m.positionClientPrice)>0?Number(m.positionClientPrice):Z(u),f=Number.isFinite(Number(m?.positionCost))&&Number(m.positionCost)>0?Number(m.positionCost):B(u),h=p*i,y=f*i,b=a.get(c)||{id:c,name:u?.name||String(c),days:0,billable:0,cost:0};b.days+=i,b.billable+=h,b.cost+=y,a.set(c,b)});return}(Array.isArray(n.technicians)?n.technicians.map(m=>String(m)):[]).forEach(m=>{const c=r.get(m)||X(m)||{},u=Z(c),p=B(c),f=u*i,h=p*i,y=a.get(m)||{id:m,name:c?.name||String(m),days:0,billable:0,cost:0};y.days+=i,y.billable+=f,y.cost+=h,a.set(m,y)})}),Array.from(a.values()).map(n=>({...n,net:n.billable-n.cost})).sort((n,o)=>o.net-n.net)}function mt(t=[]){if(!Array.isArray(t)||!t.length)return 0;let e=0;return t.forEach(r=>{const a=Number(r?.amount);Number.isFinite(a)&&a>0&&(e+=a)}),e}function U(t){const e=R(t),r=Number(e.finalTotal||0);let a=Number(t?.paidAmount);if(!Number.isFinite(a)||a<=0){const n=mt(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(n)&&n>0&&(a=n)}if((!Number.isFinite(a)||a<=0)&&Number.isFinite(Number(t?.paidPercent))){const n=Number(t.paidPercent);n>0&&n<=100&&(a=n/100*r)}return Number.isFinite(a)||(a=0),Math.max(0,Math.round((r-a)*100)/100)}function Vt(t,e,r=5){const a=new Map((e||[]).map(n=>[String(n.id),n])),s=[];return(t||[]).forEach(n=>{const{paidStatus:o,statusValue:i}=D(n);if(i==="cancelled"||o!=="unpaid"&&o!=="partial")return;const l=U(n);if(!Number.isFinite(l)||l<=0)return;const d=a.get(String(n.customerId));s.push({id:n.id||n.reservationId||"",code:n.reservationCode||n.reservationId||n.id||"",customer:d?.customerName||n.customerName||"",outstanding:l,paidStatus:o})}),s.sort((n,o)=>o.outstanding-n.outstanding).slice(0,r)}function zt(t,{horizonDays:e=90}={}){const r=new Date,a=new Date(r.getTime()+e*$),s=new Map;return(t||[]).forEach(n=>{const{statusValue:o,paidStatus:i}=D(n);if(o==="cancelled"||i==="paid")return;const l=U(n);if(!Number.isFinite(l)||l<=0)return;const d=n?.start?new Date(n.start):null,m=n?.end?new Date(n.end):d;let c=m&&!Number.isNaN(m.getTime())?m:d;if((!c||Number.isNaN(c.getTime()))&&(c=new Date(r.getTime()+7*$)),c<r||c>a)return;const u=I(new Date(c.getFullYear(),c.getMonth(),c.getDate())),p=s.get(u)||{date:u,amount:0,count:0};p.amount+=l,p.count+=1,s.set(u,p)}),Array.from(s.values()).sort((n,o)=>n.date<o.date?-1:1)}export{Yt as A,zt as B,Vt as C,ft as D,ht as E,gt as F,yt as G,wt as H,bt as I,Tt as J,Mt as K,Dt as a,It as b,R as c,nt as d,Nt as e,St as f,Ct as g,Ft as h,D as i,At as j,I as k,L as l,$t as m,Rt as n,xt as o,ut as p,Pt as q,g as r,Et as s,S as t,Lt as u,kt as v,_t as w,qt as x,jt as y,Bt as z};
