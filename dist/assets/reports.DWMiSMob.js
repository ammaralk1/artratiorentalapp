import{r as t,t as l,f as v,a as b,b as oe,d as ie,c as ce,p as le,e as V,g as de,h as ue,i as pe,j as me,k as fe,l as he,m as ye,n as ve,o as ge,s as xe,q as be,u as ke,v as we,w as Ce,x as Ee,y as q}from"./calculations.D337kgAz.js";import{l as Se,a as R,b as Le,n as $,g as De}from"./auth.D_x7ncGJ.js";import{z as Re,v as K,w as Ie}from"./reservationsService.DdN8SWfL.js";import{mapMaintenanceFromApi as Y}from"./maintenanceService.D7muvgvz.js";import{C as Pe,D as $e,E as Te,F as Ae}from"./controller.3zhEQolh.js";function Z(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function J(e={}){const n=String(e?.barcode??"").trim(),r=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:n,desc:r,description:r,name:e?.name??r,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function Q(e={}){const n=e?.title??e?.name??"",r=e?.project_code??e?.projectCode??"",a=e?.status??"",c=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:n,code:r,status:a,confirmed:c}}function Me(){let e;try{e=Se()}catch(d){return console.warn("⚠️ [reports] Failed to access cached data",d),!1}if(!e||typeof e!="object")return!1;const{reservations:n=[],customers:r=[],equipment:a=[],technicians:c=[],projects:o=[],maintenance:i=[]}=e;return n.length||r.length||a.length||c.length||o.length?(t.data.reservations=Array.isArray(n)?n.map(Re):[],t.data.customers=Array.isArray(r)?r.map(Z):[],t.data.equipment=Array.isArray(a)?a.map(J):[],t.data.technicians=Array.isArray(c)?c.map(K):[],t.data.projects=Array.isArray(o)?o.map(Q):[],t.data.projectsMap=new Map(t.data.projects.map(d=>[d.id,d])),t.data.maintenance=Array.isArray(i)?i.map(Y):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(d=>[String(d.id),d])),!0):!1}async function ee({silent:e=!1}={}){if(!t.loading){t.loading=!0,t.errorMessage="",e||t.callbacks.onBeforeRender?.();try{const[n,r,a,c,o,i]=await Promise.all([R("/reservations/?limit=500"),R("/customers/?limit=500"),R("/equipment/?limit=500"),R("/technicians/?limit=500"),R("/projects/?limit=500"),R("/maintenance/?limit=500")]);t.data.reservations=Array.isArray(n?.data)?n.data.map(s=>Ie(s)):[],t.data.customers=Array.isArray(r?.data)?r.data.map(Z):[],t.data.equipment=Array.isArray(a?.data)?a.data.map(J):[],t.data.technicians=Array.isArray(c?.data)?c.data.map(K):[],t.data.projects=Array.isArray(o?.data)?o.data.map(Q):[],t.data.projectsMap=new Map(t.data.projects.map(s=>[s.id,s])),t.data.maintenance=Array.isArray(i?.data)?i.data.map(Y):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(s=>[String(s.id),s]))}catch(n){console.error("❌ [reports] Failed to load reports data",n),t.errorMessage=n instanceof Le?n.message:l("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),(!t.data.projectsMap||!(t.data.projectsMap instanceof Map))&&(t.data.projectsMap=new Map)}finally{t.loading=!1,e||t.callbacks.onAfterRender?.()}}}function X(e){if(t.loadedScripts.has(e))return t.loadedScripts.get(e);const n=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,r=new Promise((a,c)=>{const o=()=>{n&&(n.dataset.loaded="true"),a()},i=d=>c(d);if(n){if(n.dataset.loaded==="true"){a();return}n.addEventListener("load",o,{once:!0}),n.addEventListener("error",i,{once:!0});return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>{s.dataset.loaded="true",a()},s.onerror=d=>c(d),document.head.appendChild(s)});return t.loadedScripts.set(e,r),r}function U(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(t.apexChartsReady||(t.apexChartsReady=X("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),t.apexChartsReady)}function Be(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(t.html2PdfReady||(t.html2PdfReady=X("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),t.html2PdfReady)}function Ne(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(t.xlsxReady||(t.xlsxReady=X("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),t.xlsxReady)}function F(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function S(e,n){const r=document.getElementById(e);if(r){if(!n||n.length===0){r.innerHTML=`<div class="text-sm text-base-content/60">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}r.innerHTML=n.map(a=>{const c=Math.min(Math.max(a.percent??0,0),100),o=l("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",v(a.rawCount??a.value??0)),i=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${a.label}</span>
            <span class="reports-progress-value">${v(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${c}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}async function je(e){const n=document.getElementById("reports-volume-chart");if(!n)return;const r=Array.isArray(e)?e:[];if(t.lastTrendData=r,!r.length){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await U();if(!a){n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const c=r.map(h=>h.label),o=r.map(h=>Math.round(h.count||0)),i=r.map(h=>Number(h.revenue||0)),s=r.map(h=>Number(h.netProfit||0)),d=o.reduce((h,x)=>h+(Number.isFinite(x)?x:0),0),u=i.reduce((h,x)=>h+(Number.isFinite(x)?x:0),0),m=s.reduce((h,x)=>h+(Number.isFinite(x)?x:0),0);if(d===0&&u===0&&m===0){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const p=[{name:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:o},{name:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:i},{name:l("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:s,yAxisIndex:1}],y={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(h,x,k)=>{if(k?.dataPointIndex!=null){const D=t.lastTrendData[k.dataPointIndex];t.callbacks.onTrendDrilldown?.(D,k.dataPointIndex)}}}},theme:{mode:F()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:c,labels:{style:{colors:F()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:h=>v(h)},title:{text:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:h=>b(h)},title:{text:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(h,{seriesIndex:x})=>x===0?v(h):b(h)}}};t.charts.trend?(t.charts.trend.updateOptions({...y},!0,!0),t.charts.trend.updateSeries(p,!0)):(n.innerHTML="",t.charts.trend=new a(n,{...y,series:p}),t.charts.trend.render())}catch(a){console.error("⚠️ [reports] Failed to render trend chart",a),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}async function Fe(e){const n=document.getElementById("reports-status-chart"),r="reports-status-breakdown";if(!n)return;const a=Array.isArray(e)?e:[];t.lastStatusData=a;const c=a.map(i=>Math.max(0,i.value||0)),o=c.reduce((i,s)=>i+s,0);if(!a.length||o===0){t.charts.status&&(t.charts.status.destroy(),t.charts.status=null),S(r,[]),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const i=await U();if(!i){S(r,[]),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=a.map(u=>u.label),d={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,m,p)=>{if(p?.dataPointIndex!=null){const y=t.lastStatusData[p.dataPointIndex];y?.filterKey&&t.callbacks.onStatusDrilldown?.(y,p.dataPointIndex)}}}},theme:{mode:F()},labels:s,series:c,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:l("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>v(c.reduce((u,m)=>u+m,0))}}}}},tooltip:{y:{formatter:(u,m)=>{const p=t.lastStatusData?.[m?.seriesIndex||0],y=p?`${v(p.percent)}%`:`${v(u)}%`;return`${p?v(p.rawCount??p.value??0):v(u)} / ${y}`}}}};t.charts.status?(t.charts.status.updateOptions({...d},!0,!0),t.charts.status.updateSeries(c,!0)):(n.innerHTML="",t.charts.status=new i(n,{...d,series:c}),t.charts.status.render()),S(r,a)}catch(i){console.error("⚠️ [reports] Failed to render status chart",i),S(r,[]),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}async function He(e){const n=document.getElementById("reports-payment-chart"),r="reports-payment-breakdown";if(!n)return;const a=Array.isArray(e)?e:[];t.lastPaymentData=a;const c=a.map(i=>Math.max(0,i.value||0)),o=c.reduce((i,s)=>i+s,0);if(!a.length||o===0){t.charts.payment&&(t.charts.payment.destroy(),t.charts.payment=null),S(r,[]),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const i=await U();if(!i){S(r,[]),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=a.map(u=>u.label),d={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,m,p)=>{if(p?.dataPointIndex!=null){const y=t.lastPaymentData[p.dataPointIndex];y?.filterKey&&t.callbacks.onPaymentDrilldown?.(y,p.dataPointIndex)}}}},theme:{mode:F()},labels:s,series:c,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},tooltip:{y:{formatter:(u,m)=>{const p=t.lastPaymentData?.[m?.seriesIndex||0],y=p?`${v(p.percent)}%`:`${v(u)}%`;return`${p?v(p.rawCount??p.value??0):v(u)} / ${y}`}}}};t.charts.payment?(t.charts.payment.updateOptions({...d},!0,!0),t.charts.payment.updateSeries(c,!0)):(n.innerHTML="",t.charts.payment=new i(n,{...d,series:c}),t.charts.payment.render()),S(r,a)}catch(i){console.error("⚠️ [reports] Failed to render payment chart",i),S(r,[]),n.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}function qe(e){const n=document.getElementById("reports-kpi-total"),r=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),c=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),s=document.getElementById("reports-kpi-confirmed-meta"),d=document.getElementById("reports-kpi-paid"),u=document.getElementById("reports-kpi-paid-meta"),m=e.total||0,p=e.revenue||0,y=e.confirmed||0,h=e.paidCount||0,x=e.average||0,k=e.companyShareTotal||0,D=e.taxTotal||0,T=e.crewTotal||0,A=e.crewCostTotal||0,M=e.netProfit||0,B=e.maintenanceExpense||0,ne=m?Math.round(y/m*100):0,re=m?Math.round(h/m*100):0;if(n&&(n.textContent=v(m)),r){const w=l("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",v(e.completed||0));r.textContent=w}if(a&&(a.textContent=b(p)),c)if(m===0)c.textContent=l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.");else{const w=l("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");c.textContent=w.replace("{net}",b(M)).replace("{share}",b(k)).replace("{average}",b(x))}if(o)if(p>0){const w=[{label:l("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:b(p)},{label:l("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:b(k)},{label:l("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:b(D)},{label:l("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:b(T)},{label:l("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:b(A)}];B>0&&w.push({label:l("reservations.reports.kpi.revenue.details.maintenance","مصاريف الصيانة","Maintenance expenses"),value:`−${b(B)}`}),w.push({label:l("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:b(M)}),o.innerHTML=w.map(({label:ae,value:se})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${ae}</span>
            <span class="reports-kpi-detail-value">${se}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(i&&(i.textContent=`${ne}%`),s){const w=l("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",v(y));s.textContent=w}if(d&&(d.textContent=`${re}%`),u){const w=l("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",v(h));u.textContent=w}}function C(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function H(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function _e(e,n,r){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const c=new Map((n||[]).map(s=>[String(s.id),s]));new Map((r||[]).map(s=>[String(s.id),s]));const o={code:l("reservations.reports.results.headers.id","الحجز","Reservation"),customer:l("reservations.reports.results.headers.customer","العميل","Customer"),date:l("reservations.reports.results.headers.date","التاريخ","Date"),status:l("reservations.reports.results.headers.status","الحالة","Status"),payment:l("reservations.reports.results.headers.payment","الدفع","Payment"),total:l("reservations.reports.results.headers.total","الإجمالي","Total"),share:l("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:l("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=[...e].sort((s,d)=>new Date(d.start||0)-new Date(s.start||0)).slice(0,20).map(s=>{const d=ze(s,c),u={[o.code]:d.code.text,[o.customer]:d.customer.text,[o.date]:d.date.text,[o.status]:d.status.text,[o.payment]:d.payment.text,[o.total]:d.total.text,[o.share]:d.share.text,[o.net]:d.net.text};return{formatted:d,exportRow:u}});return a.innerHTML=i.map(({formatted:s})=>`
      <tr data-drilldown="reservation" data-search="${H(s.code.text)}">
        <td data-report-column="code">${s.code.html}</td>
        <td data-report-column="customer">${s.customer.html}</td>
        <td data-report-column="date">${s.date.html}</td>
        <td data-report-column="status">${s.status.html}</td>
        <td data-report-column="payment">${s.payment.html}</td>
        <td data-report-column="total">${s.total.html}</td>
        <td data-report-column="share">${s.share.html}</td>
        <td data-report-column="net">${s.net.html}</td>
      </tr>
    `).join(""),i.map(({exportRow:s})=>s)}function ze(e,n,r){const a=e?.reservationId||e?.id||"—",c=$(String(a)),i=n.get(String(e?.customerId))?.customerName||l("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),s=oe(e),d=Oe(s.statusValue),u=Xe(s.statusValue,d),m=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],p=Ue(s.paidStatus,m),y=m.length;let h=p.html;if(y>0){const B=l("reservations.paymentHistory.countLabel","{count} دفعة","{count} payments").replace("{count}",v(y));h=`<div class="reports-payment-cell">${p.html}<small class="reports-payment-subtext">${C(B)}</small></div>`}const x=ie(e?.start),k=ce(e),D=b(k.finalTotal),T=k.companySharePercent>0?`${v(k.companySharePercent)}% (${b(k.companyShareAmount)})`:l("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),A=b(k.netProfit),M=C(i);return{code:{html:C(c),text:c},customer:{html:M,text:i},date:{html:C(x),text:x},status:u,payment:{html:h,text:p.text},total:{html:C(D),text:D},share:{html:C(T),text:T},net:{html:C(A),text:A}}}function Oe(e){switch(e){case"completed":return N(l("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return N(l("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return N(l("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return $(e||"—")}}function Xe(e,n){const r=N(n);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${C(r)}</span>`,text:r}}function Ue(e,n=[]){const r=le(e),a=String(e??"").toLowerCase(),c=a==="paid"?"paid":a==="partial"?"partial":"unpaid";let o="";const i=l("reservations.create.summary.currency","ريال","SR");Array.isArray(n)&&n.length&&(o=n.map(u=>{const m=u?.recordedAt?V(u.recordedAt):"—",p=Number.isFinite(Number(u?.amount))&&Number(u.amount)>0?`${$(Number(u.amount).toFixed(2))} ${i}`:"",y=Number.isFinite(Number(u?.percentage))&&Number(u.percentage)>0?`${$(Number(u.percentage).toFixed(2))}%`:"",h=[m];return p&&h.push(p),y&&h.push(y),h.filter(Boolean).join(" • ")}).join(`
`));const s=o?` title="${H(o)}"`:"";return{html:`<span class="reservation-chip status-${c}"${s}>${C(r)}</span>`,text:r}}function N(e){return $(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function W(e){const n=V(new Date).replace(/-/g,"");return`${l("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${n}.${e}`}function We(e,n,r){const a=new Blob([e],{type:r}),c=URL.createObjectURL(a),o=document.createElement("a");o.href=c,o.download=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(c),4e3)}function _(e){if(!e||!e.length)return;const n=Object.keys(e[0]),r=[n.join(",")];e.forEach(c=>{const o=n.map(i=>`"${String(c[i]??"").replace(/"/g,'""')}"`);r.push(o.join(","))});const a=`\uFEFF${r.join(`\r
`)}\r
`;We(a,W("csv"),"text/csv;charset=utf-8;")}async function Ge(e){try{const n=await Ne();if(!n){_(e);return}const r=n.utils.json_to_sheet(e),a=n.utils.book_new(),c=l("reservations.reports.export.sheetName","الحجوزات","Reservations");n.utils.book_append_sheet(a,r,c),n.writeFile(a,W("xlsx"))}catch(n){console.error("⚠️ [reports] Excel export failed, falling back to CSV",n),_(e)}}async function Ve(){const e=document.getElementById("reservations-report-printable");if(!e)return;const n=await Be();if(typeof n!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const r=W("pdf");Pe();const a=[];$e(e,window,a),Te(e,window,a);try{await n().set({margin:10,filename:r,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(c){console.error("⚠️ [reports] export failed",c)}finally{Ae(a)}}async function Ke(e,n){switch(e){case"pdf":await Ve();break;case"excel":await Ge(n);break;case"csv":default:_(n);break}}function Ye(e){const n=document.getElementById("reports-top-customers");if(n){if(!e||e.length===0){n.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}n.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${H(r.name)}">
        <td>${C(r.name)}</td>
        <td>${v(r.count)}</td>
        <td>${b(r.revenue)}</td>
      </tr>
    `).join("")}}function Ze(e){const n=document.getElementById("reports-top-equipment");if(n){if(!e||e.length===0){n.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}n.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${H(r.name)}">
        <td>${C(r.name)}</td>
        <td>${v(r.count)}</td>
        <td>${b(r.revenue)}</td>
      </tr>
    `).join("")}}const E=t.filters;function Je(e){if(t.columnControlsBound)return;const n=document.getElementById("reports-column-controls");n&&(n.querySelectorAll("input[data-column-toggle]").forEach(r=>{const a=r.dataset.columnToggle;a&&(r.checked=t.columnPreferences[a]!==!1,r.addEventListener("change",()=>{t.columnPreferences[a]=r.checked,e()}))}),t.columnControlsBound=!0,e())}function te(){Object.entries(t.columnPreferences).forEach(([e,n])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(r=>{r.classList.toggle("hidden",!n)})})}function Qe(e){if(t.exportHandlersBound)return;const n=document.querySelectorAll("[data-export]");n.length&&(n.forEach(r=>{r.addEventListener("click",async()=>{const{export:a=""}=r.dataset;if(a){r.disabled=!0;try{await e(a)}catch(c){console.error("⚠️ [reports] export failed",c)}finally{r.disabled=!1}}})}),t.exportHandlersBound=!0)}function et(e,n){t.searchDebounceTimer&&(clearTimeout(t.searchDebounceTimer),t.searchDebounceTimer=null),t.searchDebounceTimer=setTimeout(()=>{E.search=e||"",n()},220)}function tt(e,n){e&&(E.range="custom",E.start=e.startInput||null,E.end=e.endInput||null,n())}function nt(e,n){e&&(E.status=E.status===e?"all":e,n())}function rt(e,n){e&&(E.payment=E.payment===e?"all":e,n())}function at(e,n){e&&(E.search=e,n())}const f=t.filters;function G(){q(),g(),setTimeout(()=>{q(),g(),j()},0),setTimeout(()=>{q(),g(),j()},60),j()}function P(){f.range==="custom"&&g()}function j(e,n){if(!window.flatpickr)return;e&&(t.startDateInputRef=e),n&&(t.endDateInputRef=n);const r=t.startDateInputRef,a=t.endDateInputRef;if(!r&&!a)return;const c=st(),o=i=>{const s={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return c&&(s.locale=c),s};if(t.startDatePicker&&(t.startDatePicker.destroy(),t.startDatePicker=null),t.endDatePicker&&(t.endDatePicker.destroy(),t.endDatePicker=null),r&&(t.startDatePicker=window.flatpickr(r,o({onChange(i,s){f.start=s||null,t.endDatePicker&&(i?.length?t.endDatePicker.set("minDate",i[0]):t.endDatePicker.set("minDate",null)),P()},onValueUpdate(i,s){f.start=s||null,P()}}))),a&&(t.endDatePicker=window.flatpickr(a,o({onChange(i,s){f.end=s||null,t.startDatePicker&&(i?.length?t.startDatePicker.set("maxDate",i[0]):t.startDatePicker.set("maxDate",null)),P()},onValueUpdate(i,s){f.end=s||null,P()}}))),t.startDatePicker&&r){t.startDatePicker.setDate(r.value,!1);const i=t.endDatePicker?.selectedDates?.[0]||t.endDateInputRef?.value;i&&t.startDatePicker.set("maxDate",i)}if(t.endDatePicker&&a){t.endDatePicker.setDate(a.value,!1);const i=t.startDatePicker?.selectedDates?.[0]||t.startDateInputRef?.value;i&&t.endDatePicker.set("minDate",i)}}function st(){return(De()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function z(e,n){e&&(e.classList.toggle("active",!!n),e.classList.toggle("hidden",!n))}function L(){const e=document.getElementById("reports-range"),n=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),c=document.getElementById("reports-search"),o=document.getElementById("reports-start"),i=document.getElementById("reports-end"),s=document.getElementById("reports-custom-range");e&&e.value!==f.range&&(e.value=f.range),n&&n.value!==f.status&&(n.value=f.status),r&&r.value!==f.payment&&(r.value=f.payment),a&&a.value!==f.share&&(a.value=f.share),c&&c.value!==f.search&&(c.value=f.search||""),o&&o.value!==(f.start||"")&&(o.value=f.start||""),i&&i.value!==(f.end||"")&&(i.value=f.end||""),z(s,f.range==="custom")}function O({active:e,icon:n,title:r,subtitle:a}){const c=document.getElementById("reports-empty-state");if(!c)return;const o=c.querySelector(".reports-empty-icon"),i=c.querySelector("h4"),s=c.querySelector("p");t.emptyDefaults.icon===null&&o&&(t.emptyDefaults.icon=o.textContent),t.emptyDefaults.title===null&&i&&(t.emptyDefaults.title=i.textContent),t.emptyDefaults.subtitle===null&&s&&(t.emptyDefaults.subtitle=s.textContent),c.classList.toggle("active",!!e),c.classList.toggle("hidden",!e),!(!o||!i||!s)&&(e?(o.textContent=n!==void 0?n:t.emptyDefaults.icon??o.textContent,i.textContent=r!==void 0?r:t.emptyDefaults.title??i.textContent,s.textContent=a!==void 0?a:t.emptyDefaults.subtitle??s.textContent):(o.textContent=t.emptyDefaults.icon??o.textContent,i.textContent=t.emptyDefaults.title??i.textContent,s.textContent=t.emptyDefaults.subtitle??s.textContent))}function ot(e){O({active:!!e})}function it(){if(t.drilldownBound)return;const e=document.getElementById("reports-top-customers"),n=document.getElementById("reports-top-equipment"),r=document.getElementById("reports-reservations-body"),a=c=>{const o=c.target?.closest("[data-drilldown]");if(!o)return;const i=o.dataset.search||"";at(i,()=>{L(),g()})};e?.addEventListener("click",a),n?.addEventListener("click",a),r?.addEventListener("click",a),t.drilldownBound=!0}function I(){ee({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function g(){if(L(),t.loading){O({active:!0,icon:"⏳",title:l("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:l("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(t.errorMessage){O({active:!0,icon:"⚠️",title:t.errorMessage,subtitle:l("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:n,equipment:r,technicians:a,maintenance:c}=t.data,o=de(e,f,n,r,a),i=ue(o),s=pe(c,f),d=me(i,s.total),u=fe(o),m=he(o),p=ye(o),y=ve(o,n),h=ge(o,r);qe(d),je(u),Fe(m),He(p),Ye(y),Ze(h);const x=_e(o,n,a);te(),ot(o.length===0),t.lastSnapshot.filtered=o,t.lastSnapshot.metrics=d,t.lastSnapshot.trend=u,t.lastSnapshot.statusBreakdown=m,t.lastSnapshot.paymentBreakdown=p,t.lastSnapshot.tableRows=x,t.lastSnapshot.maintenance=s}function mt(){if(t.initialized)return;t.initialized=!0;const e=document.getElementById("reports-range"),n=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),c=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),s=document.getElementById("reports-custom-range"),d=document.getElementById("reports-search");if(!e)return;L(),Me()&&g(),e.addEventListener("change",()=>{f.range=e.value,z(s,f.range==="custom"),f.range!=="custom"&&(f.start=null,f.end=null),g()}),n?.addEventListener("change",()=>{f.status=n.value,g()}),r?.addEventListener("change",()=>{f.payment=r.value,g()}),a?.addEventListener("change",()=>{f.share=a.value,g()}),d?.addEventListener("input",()=>{const m=d.value||"";et(m,()=>{L(),g()})}),c?.addEventListener("change",()=>{f.start=c.value||null,P()}),o?.addEventListener("change",()=>{f.end=o.value||null,P()}),i?.addEventListener("click",()=>{f.range==="custom"&&(f.start=c?.value||null,f.end=o?.value||null),g()}),j(c,o),z(s,f.range==="custom"),t.languageListenerAttached||(document.addEventListener("language:changed",G),document.addEventListener("language:translationsReady",G),t.languageListenerAttached=!0),t.dataListenersAttached||(document.addEventListener("reservations:changed",I),document.addEventListener("customers:changed",I),document.addEventListener("equipment:changed",I),document.addEventListener("projects:changed",I),document.addEventListener("technicians:updated",I),window.addEventListener("maintenance:updated",I),t.dataListenersAttached=!0),Je(te),Qe(async m=>{const p=t.lastSnapshot.tableRows||[];if(!p.length){console.warn("[reports] No reservation data to export");return}await Ke(m,p)}),it(),t.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>g(),0)}),t.themeListenerAttached=!0),xe(g),be(()=>{g()}),ke(()=>{g()}),we(m=>{tt(m,()=>{L(),g()})}),Ce(m=>{nt(m?.filterKey,()=>{L(),g()})}),Ee(m=>{rt(m?.filterKey,()=>{L(),g()})}),ee().catch(m=>{console.error("❌ [reports] Failed to initialise reports data",m)})}export{mt as initReports,g as renderReports};
