import{r as B,a as k,c as j,g as M,j as l,t as m,b as v}from"./auth.CoLto2Rb.js";import{i as w}from"./dashboardShell.DF2kUed9.js";B({ar:{notifications:{title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",header:"ğŸ”” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",subtitle:"Ø£Ø±Ø³Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„ÙØ±ÙŠÙ‚ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª/Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.",form:{entityType:"Ø§Ù„Ù†ÙˆØ¹",entity:{reservation:"Ø­Ø¬Ø²",project:"Ù…Ø´Ø±ÙˆØ¹"},search:"Ø¨Ø­Ø«","search.placeholder":"Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"},table:{headers:{code:"Ø§Ù„ÙƒÙˆØ¯",title:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",when:"Ø§Ù„ÙˆÙ‚Øª",customer:"Ø§Ù„Ø¹Ù…ÙŠÙ„",actions:"Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"},loading:"â³ Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«â€¦",select:"Ø§Ø®ØªÙŠØ§Ø±"},channels:{email:"Ø¥ÙŠÙ…ÙŠÙ„",whatsapp:"ÙˆØ§ØªØ³Ø§Ø¨"},compose:{title:"âœ‰ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø©",recipients:"Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†",toTechnicians:"Ø§Ù„ÙÙ†ÙŠÙˆÙ† Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†ÙˆÙ†",toAdmins:"Ø§Ù„Ø¥Ø¯Ù…Ù†",subject:"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹",body:"Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©",templates:{reminder:"ğŸ“Œ ØªØ°ÙƒÙŠØ±",note:"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©"},send:"ğŸš€ Ø¥Ø±Ø³Ø§Ù„",sentOk:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"},logs:{title:"ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",subtitle:"ØªØ§Ø¨Ø¹ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ­Ø§Ù„Ø© ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©.",refresh:"ğŸ”„ ØªØ­Ø¯ÙŠØ«",clear:"ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„",prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚",next:"Ø§Ù„ØªØ§Ù„ÙŠ",filters:{allEntities:"ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹",allChannels:"ÙƒÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª",allStatuses:"ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª",sent:"Ù…Ø±Ø³Ù„Ø©",failed:"ÙØ§Ø´Ù„Ø©","q.placeholder":"Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/Ø§Ù„Ø±Ù‚Ù…"},headers:{time:"Ø§Ù„ÙˆÙ‚Øª",event:"Ø§Ù„Ø­Ø¯Ø«",entity:"Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø¹Ø±Ù",recipient:"Ø§Ù„Ù…Ø³ØªÙ„Ù…",channel:"Ø§Ù„Ù‚Ù†Ø§Ø©",status:"Ø§Ù„Ø­Ø§Ù„Ø©",error:"Ø§Ù„Ø®Ø·Ø£"},empty:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.",loading:"â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"}}}});k();w();const t={};let b=null,y=null;function o(n){return document.querySelector(n)}function P(){t.entityType=o("#notif-entity-type"),t.search=o("#notif-search"),t.resultsBody=o("#notif-results-body"),t.composeSection=o("#notif-compose-section"),t.selectedSummary=o("#notif-selected-summary"),t.chEmail=o("#notif-channel-email"),t.chWhatsapp=o("#notif-channel-whatsapp"),t.toTechs=o("#notif-to-techs"),t.toAdmins=o("#notif-to-admins"),t.extraEmails=o("#notif-extra-emails"),t.extraPhones=o("#notif-extra-phones"),t.subject=o("#notif-subject"),t.body=o("#notif-body"),t.sendBtn=o("#notif-send-btn"),t.tReminder=o("#notif-template-reminder"),t.tNote=o("#notif-template-note"),t.logEntity=o("#log-filter-entity"),t.logChannel=o("#log-filter-channel"),t.logStatus=o("#log-filter-status"),t.logQ=o("#log-filter-q"),t.logRefresh=o("#log-refresh-btn"),t.logClear=o("#log-clear-btn"),t.logBody=o("#notif-logs-body"),t.logPagination=o("#log-pagination")}function T(n,e){const a=n.start_datetime||n.startDate||"",s=n.end_datetime||n.endDate||"";return a&&s&&a!==s?`${a} â€” ${s}`:a||s||""}function A(n,e){if(!Array.isArray(n)||n.length===0){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${m("notifications.table.loading","Ù„Ø§ Ù†ØªØ§Ø¦Ø¬")}</td></tr>`;return}t.resultsBody.innerHTML=n.map(a=>{const s=e==="reservation"?a.reservation_code||"":a.project_code||"",i=a.title||"",c=T(a),d=e==="reservation"?a.customer_name||"":a.client_name||"";return`
      <tr>
        <td>${s||"â€”"}</td>
        <td>${i||"â€”"}</td>
        <td>${c||"â€”"}</td>
        <td>${d||"â€”"}</td>
        <td><button type="button" class="btn btn-sm btn-primary" data-select-id="${a.id}" data-select-type="${e}">${m("notifications.table.select","Ø§Ø®ØªÙŠØ§Ø±")}</button></td>
      </tr>
    `}).join("")}async function E(){const n=t.entityType.value,e=(t.search.value||"").trim();try{const a=n==="reservation"?"/reservations/":"/projects/",s=new URLSearchParams;e!==""&&s.set("search",e),s.set("limit","20");const i=await v(`${a}?${s.toString()}`);A(i?.data??[],n)}catch(a){console.error(a),t.resultsBody.innerHTML='<tr><td colspan="5" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</td></tr>'}}function N(){y&&clearTimeout(y),y=setTimeout(E,350)}function C(n,e){const a=n==="reservation"?e.reservation_code||"":e.project_code||"",s=e.title||a||n,i=T(e),c=e.location||"",d=n==="reservation"?e.customer_name||"":e.client_name||"";return[a?`Ø§Ù„ÙƒÙˆØ¯: ${a}`:"",`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${s}`,i?`Ø§Ù„ÙˆÙ‚Øª: ${i}`:"",c?`Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${c}`:"",d?`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${d}`:""].filter(Boolean).join(" | ")}async function H(n,e){try{const i=(await v(`${e==="reservation"?"/reservations/":"/projects/"}?id=${encodeURIComponent(n)}`))?.data;if(!i)throw new Error("Not found");b={type:e,id:Number(i.id),summary:C(e,i)},t.selectedSummary.textContent=b.summary,t.composeSection.hidden=!1}catch(a){console.error(a),l("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯")}}async function R(){if(!b){l("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}const n={email:!!t.chEmail.checked,whatsapp:!!t.chWhatsapp.checked};if(!n.email&&!n.whatsapp){l("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");return}const e={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(s=>s.trim()).filter(Boolean),additional_phones:(t.extraPhones.value||"").split(",").map(s=>s.trim()).filter(Boolean)},a={subject:(t.subject.value||"ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ").trim(),text:(t.body.value||"").trim()};if(!a.text){l("Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");return}try{const s=await v("/notifications/send.php",{method:"POST",body:{entity_type:b.type,entity_id:b.id,channels:n,recipients:e,message:a}}),i=s?.data||{},c=i?.sent||{email:0,whatsapp:0},d=Number(c.email||0)+Number(c.whatsapp||0),p=i?.targets||{email:0,whatsapp:0},u=Number(p.email||0)+Number(p.whatsapp||0);if(d>0||u>0||s?.ok===!0)l(m("notifications.compose.sentOk","ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"));else{const r=i?.errors?.last_email_error;r?l(`ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${r}`):l("Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† ÙˆØ§Ù„Ù‚Ù†ÙˆØ§Øª.")}g()}catch(s){console.error(s);const i=s&&s.message?String(s.message):"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";l(i)}}function q(){t.search.addEventListener("input",N),t.entityType.addEventListener("change",()=>{t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${m("notifications.table.loading","Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«â€¦")}</td></tr>`,E()}),t.resultsBody.addEventListener("click",e=>{const a=e.target.closest("[data-select-id]");a&&H(a.getAttribute("data-select-id"),a.getAttribute("data-select-type"))}),t.tReminder.addEventListener("click",()=>{const e=`ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø­Ø¬Ø²/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:
ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ ÙˆØ§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù….`;t.body.value=e}),t.tNote.addEventListener("click",()=>{const e=`Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:
ÙŠØ±Ø¬Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.`;t.body.value=e}),t.sendBtn.addEventListener("click",R);const n=()=>{f=1,g()};["change","input"].forEach(e=>{t.logEntity.addEventListener(e,n),t.logChannel.addEventListener(e,n),t.logStatus.addEventListener(e,n),t.logQ.addEventListener(e,()=>{y&&clearTimeout(y),y=setTimeout(()=>{f=1,g()},350)})}),t.logRefresh.addEventListener("click",g),t.logClear&&t.logClear.addEventListener("click",async()=>{if(window.confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±."))try{const a=x();await v(`/notifications/logs.php?${a.toString()}`,{method:"DELETE"}),l("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„"),f=1,g()}catch(a){console.error(a),l("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„")}}),t.logPagination&&t.logPagination.addEventListener("click",e=>{const a=e.target.closest("[data-page]");if(!a)return;const s=Number(a.getAttribute("data-page"))||1;s!==f&&(f=s,g())})}let f=1;const S=20;function x(){const n=new URLSearchParams;return t.logEntity.value&&n.set("entity_type",t.logEntity.value),t.logChannel.value&&n.set("channel",t.logChannel.value),t.logStatus.value&&n.set("status",t.logStatus.value),(t.logQ.value||"").trim()&&n.set("q",t.logQ.value.trim()),n.set("limit",String(S)),n.set("page",String(f)),n}function O(n){const e=Number(n?.total||0),a=Number(n?.pages||1),s=Number(n?.page||1);if(!t.logPagination)return;if(e<=S){t.logPagination.innerHTML="";return}const i=(r,h,_=!1,L=!1)=>{const $=["btn","btn-sm"];return L?$.push("btn-primary"):$.push("btn-outline"),_&&$.push("btn-disabled"),`<button type="button" class="${$.join(" ")}" data-page="${h}" ${_?"disabled":""}>${r}</button>`};let c="";c+=i(m("notifications.logs.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"),Math.max(1,s-1),s<=1);const d=7,p=(r,h)=>Array.from({length:h-r+1},(_,L)=>r+L);let u=[];if(a<=d)u=p(1,a);else{const r=Math.max(2,s-1),h=Math.min(a-1,s+1);u=[1,...p(r,h),a]}for(const r of u){if(r<1||r>a)continue;const h=r===s;c+=i(String(r),r,!1,h)}c+=i(m("notifications.logs.next","Ø§Ù„ØªØ§Ù„ÙŠ"),Math.min(a,s+1),s>=a),t.logPagination.innerHTML=c}function D(n){return{reservation_created:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø²",reservation_reminder_24h:"ØªØ°ÙƒÙŠØ± 24 Ø³Ø§Ø¹Ø©",reservation_reminder_1h:"ØªØ°ÙƒÙŠØ± Ø³Ø§Ø¹Ø©",reservation_technician_assigned:"ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ (Ø­Ø¬Ø²)",reservation_status_changed:"ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø­Ø¬Ø²",project_created:"Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹",project_technician_assigned:"ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ (Ù…Ø´Ø±ÙˆØ¹)",manual_notification:"Ø¥Ø±Ø³Ø§Ù„ ÙŠØ¯ÙˆÙŠ"}[n]||n}function Q(n){if(!Array.isArray(n)||n.length===0){t.logBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted">${m("notifications.logs.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.")}</td></tr>`;return}t.logBody.innerHTML=n.map(e=>{const a=e.created_at||"â€”",s=D(e.event_type||""),i=`${e.entity_type||""} #${e.entity_id||""}`,c=`${e.recipient_type||""}: ${e.recipient_identifier||""}`,d=e.channel||"",p=e.status||"",u=(e.error||"").toString().slice(0,140);return`
      <tr>
        <td>${a}</td>
        <td>${s}</td>
        <td>${i}</td>
        <td>${c}</td>
        <td>${d}</td>
        <td>${p==="sent"?'<span class="badge bg-primary-subtle">Ù…Ø±Ø³Ù„Ø©</span>':'<span class="badge bg-danger-subtle">ÙØ§Ø´Ù„Ø©</span>'}</td>
        <td title="${u}">${u}</td>
      </tr>
    `}).join("")}async function g(){try{t.logBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted">${m("notifications.logs.loading","â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦")}</td></tr>`;const n=x(),e=await v(`/notifications/logs.php?${n.toString()}`);Q(e?.data??[]),O(e?.meta||{})}catch(n){console.error(n),t.logBody.innerHTML='<tr><td colspan="7" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</td></tr>'}}(async function(){await j();const e=await M();if(!e||e.role!=="admin"){l("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·"),window.location.href="home.html";return}P(),q(),E(),g()})();
