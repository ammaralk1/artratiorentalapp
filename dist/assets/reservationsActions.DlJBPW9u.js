import{d as He,n as u,p as bn,t as a,v as Be,y as Ee,w as ma,j as W}from"./auth.CfSWwk88.js";import{a as ze,h as fa,k as Oe,c as Ue,e as Ve,d as hn,C as ya,s as B,p as rt,b as ba,N as on,g as kt,f as ha,z as ce,O as va,P as ga,u as _a,r as $a}from"./reservationsService.xTOvDkMk.js";import{n as Ut,i as ae,j as cn,s as Sa}from"./state.r7LAfWRX.js";import{s as Aa,r as Na}from"./uiBridge.COTfT8h5.js";const Ta=new Map([["available","available"],["Ù…ØªØ§Ø­","available"],["Ù…ØªÙˆÙØ±","available"],["Ø¬Ø§Ù‡Ø²","available"],["ready","available"],["reserved","reserved"],["Ù…Ø­Ø¬ÙˆØ²","reserved"],["Ù…Ø­Ø¬ÙˆØ²Ø©","reserved"],["maintenance","maintenance"],["ØµÙŠØ§Ù†Ø©","maintenance"],["under_maintenance","maintenance"],["retired","retired"],["Ù…ØªÙˆÙ‚Ù","retired"],["Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©","retired"]]);function wa(t){const n=String(t??"").trim().toLowerCase();return n&&Ta.get(n)||"available"}function Ca(t){return t?typeof t=="object"?t:Pa(t):null}function Qa(t){const n=Ca(t);return n?wa(n.status||n.state||n.statusLabel||n.status_label):"available"}function xa(t={}){return t.image||t.imageUrl||t.img||""}function Ya(t={}){const n=[t.cost,t.unit_cost,t.unitCost,t.rental_cost,t.rentalCost,t.purchase_price,t.purchasePrice];for(const s of n){const i=Number(s);if(Number.isFinite(i))return i}return 0}function Xa(t){if(!t)return null;const n=Ut(t),{equipment:s=[]}=He();return(s||[]).find(i=>Ut(i?.barcode)===n)||null}function Pa(t){const n=Ut(t);if(!n)return null;const{equipment:s=[]}=He();return(s||[]).find(i=>Ut(i?.barcode)===n)||null}const $={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],servicesClientPriceTotal:0,filters:{search:"",status:"",payment:"",type:"",confirmed:"",range:"",startDate:"",endDate:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null,pendingLinkedToast:!1},R={};function Za(){$.selectedTechnicians=[],$.selectedEquipment=[],$.expenses=[],$.servicesClientPriceTotal=0}function _(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Nt(t){const n=Number(t)||0,i=bn()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(n));return`${u(r)} SR`}function At(t){if(!t)return"â€”";const n=new Date(t);if(Number.isNaN(n.getTime()))return"â€”";const s=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getFullYear()),o=String(n.getMinutes()).padStart(2,"0"),c=n.getHours(),d=c>=12?"PM":"AM",m=c%12||12,b=String(m).padStart(2,"0"),f=`${s}/${i}/${r} ${b}:${o} ${d}`;return u(f)}function Fa(t){const n=bn(),s=u(String(t));return n==="en"?`${s} ${t===1?"project":"projects"}`:`${s} Ù…Ø´Ø±ÙˆØ¹`}function ln(t){R.tableCount&&(R.tableCount.dataset.count=String(t),R.tableCount.textContent=Fa(t))}function ts(t){if(!t)return"";const n=t.dataset.emptyKey,s=t.dataset.empty||"";return n?a(n,s):s}const es="project",ns="editProject",ie=3600*1e3,re=.15,Ot=6,as="projectsTab",ss="projectsSubTab",is={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab",templates:"projects-templates-tab"},Da={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed",cancelled:"Cancelled",conflict:"Conflict"};function vn(t){if(!t)return"";if(t instanceof Date)return t.toISOString();let n=String(t).trim();return n?(n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T")),n):""}function ct(t){if(!t?.start)return Number.NaN;const n=vn(t.start),s=new Date(n).getTime();return Number.isFinite(s)?s:Number.NaN}function St(t){if(t?.createdAt){const s=vn(t.createdAt),i=new Date(s).getTime();if(Number.isFinite(i))return i}const n=ct(t);return Number.isFinite(n)?n:Number.NEGATIVE_INFINITY}function rs(t,n){if(!t)return"";const s=n&&/\d{1,2}:\d{2}/.test(n)?n:"00:00",[i="00",r="00"]=s.split(":"),o=i.padStart(2,"0"),c=r.padStart(2,"0");return`${t}T${o}:${c}`}function gn(t,n){const s=String(t||"");return s.length<=n?s:`${s.slice(0,Math.max(0,n-1))}â€¦`}function os(t){if(!t||typeof t!="string")return{date:"",time:""};let n=t.trim();if(!n)return{date:"",time:""};if(n.includes(" ")&&(n=n.replace(" ","T")),!n.includes("T"))return{date:n,time:""};const[s,i=""]=n.split("T");return{date:s,time:i}}function le(t){if(!t)return a("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const n={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return a(n,t)}function se(t){return u(String(t||"")).toLowerCase().trim()}function ja(){const t=$.filters||{};return!!((t.search||"").trim()||t.status||t.payment||t.type||t.confirmed||t.startDate||t.endDate)}function dn(t,n=!1){if(!t)return null;const s=new Date(`${t}T${n?"23:59:59":"00:00:00"}`);return Number.isNaN(s.getTime())?null:s}function ka(t){try{const n=Ke(t.id),s=Rt(t)||{},i=Number(s.subtotal||0),r=(n||[]).reduce((b,f)=>b+(Number(f?.totalAmount)||oe(f)||0),0),o=s.applyTax?Number(((i+r)*re).toFixed(2)):0,c=Number((i+r+o).toFixed(2)),d=t.paymentHistory||t.payments||[],m=Ue({totalAmount:c,paidAmount:d.length?0:t.paidAmount,paidPercent:d.length?0:t.paidPercent,history:d});return Ve({manualStatus:null,paidAmount:m.paidAmount,paidPercent:m.paidPercent,totalAmount:c})}catch{return null}}function La(t){const n=$.customers.find(p=>String(p.id)===String(t.clientId)),s=se($.filters.search),i=se([t.title,t.description,n?.customerName,t.clientCompany,le(t.type),t.id,t.projectCode].filter(Boolean).join(" "));if(s&&!i.includes(s))return!1;const r=se($.filters.type);if(r&&se(t.type)!==r)return!1;const o=We(t),c=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":o;if($.filters.status&&$.filters.status!==c)return!1;const d=t.confirmed===!0||t.confirmed==="true";if($.filters.confirmed==="yes"&&!d||$.filters.confirmed==="no"&&d||$.filters.confirmed==="closed"&&c!=="completed")return!1;const m=ka(t);if($.filters.payment&&(!m||$.filters.payment!==m))return!1;const b=dn($.filters.startDate),f=dn($.filters.endDate,!0);if(b||f){const p=t.start?new Date(t.start):null;if(!p||Number.isNaN(p.getTime())||b&&p<b||f&&p>f)return!1}return!0}function _n(){return(Array.isArray($.projects)?$.projects:[]).filter(n=>La(n))}function cs(){if(!R.projectsTableBody)return;const t=_n();if(!t.length){const s=$.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",i=$.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",r=_(a(s,i));R.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="6" class="text-center text-muted">${r}</td></tr>`,ln(0),$.visibleProjects=[],un([]),pn();return}const n=[...t].sort((s,i)=>{const r=St(s),o=St(i);if(Number.isFinite(r)&&Number.isFinite(o)&&r!==o)return o-r;const c=ct(s),d=ct(i);return Number.isFinite(c)&&Number.isFinite(d)?d-c:0});$.visibleProjects=n,ln(n.length),R.projectsTableBody.innerHTML=n.map(s=>Ia(s)).join(""),un(n),pn()}function Ia(t){const s=$.customers.find(h=>String(h.id)===String(t.clientId))?.customerName||a("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),i=["commercial","coverage","photography","social"].includes(t.type)?t.type:"default",{expensesTotal:r,totalWithTax:o}=Rt(t),c=_(le(t.type)),d=`<span class="project-type-chip project-type-chip--${i}">${c}</span>`,m=t.projectCode||`PRJ-${u(String(t.id))}`,b=`<span class="project-code-badge">#${_(m)}</span>`,p=Be()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${_(a("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${_(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${b}
            ${d}
          </div>
        </div>
      </td>
      <td>
        ${_(s)}
      </td>
      <td>${qa(t.start,t.end)}</td>
      <td>${Nt(o)}</td>
      <td>${Nt(r)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${_(a("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${p}
      </td>
    </tr>
  `}function qa(t,n){if(!t)return"â€”";const s=At(t),i=n?At(n):"",r=m=>{const b=String(m).split(" ").filter(Boolean),f=b.shift()||"",p=b.join(" ");return{date:f,time:p}},o=r(s),c=i?r(i):{date:"",time:""};if(c.date&&o.date===c.date){const m=o.time&&c.time?`Ù…Ù† ${o.time} Ø¥Ù„Ù‰ ${c.time}`:"";return`
      <div class="date-range">
        <div class="date-line">${o.date}</div>
        ${m?`<div class="time-line">${m}</div>`:""}
      </div>
    `}const d=o.time&&c.time?`Ù…Ù† ${o.time} Ø¥Ù„Ù‰ ${c.time}`:"";return`
    <div class="date-range">
      <div class="date-line">${o.date}</div>
      ${c.date?`<div class="date-line">${c.date}</div>`:""}
      ${d?`<div class="time-line">${d}</div>`:""}
    </div>
  `}function Ra(t,n){if(!t)return{dateHtml:"â€”",timeText:""};const s=At(t),i=n?At(n):"",r=b=>{const f=String(b).split(" ").filter(Boolean),p=f.shift()||"",h=f.join(" ");return{date:p,time:h}},o=r(s),c=i?r(i):{date:"",time:""};let d="",m="";return c.date&&o.date===c.date?(d=`<div class="date-range"><div class="date-line">${o.date}</div></div>`,m=`Ù…Ù† ${o.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${c.time||"â€”:â€”"}`):(d=`<div class="date-range"><div class="date-line">${o.date}</div>`+(c.date?`<div class="date-line">${c.date}</div>`:"")+"</div>",m=`Ù…Ù† ${o.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${c.time||"â€”:â€”"}`),{dateHtml:d,timeText:m}}function un(t){if(!R.timeline)return;const s=(Array.isArray(t)?t:$.visibleProjects.length?$.visibleProjects:$.projects).map(p=>{if(!p?.start)return null;const h=new Date(p.start);if(Number.isNaN(h.getTime()))return null;let S=p.end?new Date(p.end):new Date(h);return Number.isNaN(S.getTime())&&(S=new Date(h)),S<=h&&(S=new Date(h.getTime()+ie)),{project:p,startDate:h,endDate:S}}).filter(Boolean).sort((p,h)=>p.startDate-h.startDate);if(!s.length){const p=_(a("projects.timeline.empty",R.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));R.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${p}</div>`;return}const i=s[0].startDate.getTime(),r=Math.max(...s.map(p=>p.endDate.getTime()));let o=r-i;o<=0&&(o=ie);const c=Ea(s),d=a("projects.timeline.range","{start} â†’ {end}"),m=a("projects.timeline.conflict","Scheduling conflict"),b=s.map(p=>{const{project:h,startDate:S,endDate:E}=p,K=E.getTime()-S.getTime();let O=(S.getTime()-i)/o*100;O=Math.max(0,Math.min(O,100));let J=K/o*100;J=Math.max(J,2.5),O+J>100&&(J=Math.max(1.5,100-O));const V=`project-timeline__item--${We(h)}`,ht=c.has(h.id),M=(h.title||"").trim()||a("projects.fallback.untitled","Untitled project"),Tt=gn(M,26),lt=$.customers.find(Q=>String(Q.id)===String(h.clientId)),dt=lt?.customerName||a("projects.fallback.unknownClient","Unknown client"),vt=(h.clientCompany||lt?.companyName||"").trim(),Et=le(h.type),wt=At(S.toISOString()),Ct=At(E.toISOString()),Vt=d.replace("{start}",wt).replace("{end}",Ct),Lt=vt?`${dt} (${vt})`:dt,tt=`${M} â€¢ ${Et} â€¢ ${Lt} | ${Vt}`,ue=ht?`<span class="project-timeline__item-conflict" title="${_(m)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${V}${ht?" project-timeline__item--conflict":""}" style="left:${O}%;width:${J}%;" title="${_(tt)}">
          <span class="project-timeline__item-label">${_(Tt)}</span>
          ${ue}
        </div>
      `}).join(""),f=`
    <div class="project-timeline__scale">
      <span>${_(At(new Date(i).toISOString()))}</span>
      <span>${_(At(new Date(r).toISOString()))}</span>
    </div>
  `;R.timeline.innerHTML=`
    ${f}
    <div class="project-timeline__track">
      ${b}
    </div>
  `}function Ea(t){const n=new Set;for(let s=0;s<t.length;s+=1)for(let i=s+1;i<t.length;i+=1){const r=t[s],o=t[i];r.startDate<o.endDate&&o.startDate<r.endDate&&(n.add(r.project.id),n.add(o.project.id))}return n}function pn(){if(!R.focusCards)return;const t=$.visibleProjects.length?$.visibleProjects:_n(),n=Ma(t,{allowFallback:!ja()});if(!n.length){const s=_(a("projects.focus.empty",R.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));R.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${s}</div></div>`;return}R.focusCards.innerHTML=n.join("")}function Ma(t=[],n={}){const s=n.allowFallback!==!1,i=Array.isArray(t)?t:[],r=i.length?i:s?$.projects:[];if(!Array.isArray(r)||!r.length)return[];const o=r.filter(mn),c=r.filter(f=>!mn(f)&&Ba(f)),d=[],m=new Set,b=(f,p)=>{!f||m.has(f.id)||d.length>=Ot||(m.add(f.id),d.push(Ha(f,p)))};if(o.sort((f,p)=>ct(f)-ct(p)).forEach(f=>b(f,"today")),c.sort((f,p)=>ct(f)-ct(p)).forEach(f=>b(f,"thisWeek")),d.length<Ot){const f=Date.now();[...r].filter(h=>!m.has(h.id)).filter(h=>{const S=ct(h);return Number.isFinite(S)&&S>=f}).sort((h,S)=>ct(h)-ct(S)).forEach(h=>b(h,"upcoming"))}return d.length<Ot&&[...r].filter(p=>!m.has(p.id)).filter(p=>!Number.isFinite(ct(p))).sort((p,h)=>St(h)-St(p)).forEach(p=>b(p,"recent")),d.length===0&&[...r].sort((p,h)=>St(h)-St(p)).slice(0,Ot).forEach(p=>b(p,"recent")),d.length<Ot&&[...r].filter(p=>!m.has(p.id)).sort((p,h)=>St(h)-St(p)).forEach(p=>b(p,"recent")),d}function Ha(t,n){const s=$.customers.find(C=>String(C.id)===String(t.clientId)),i=s?.customerName||a("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");(t.clientCompany||s?.companyName||"").trim();const r=Array.isArray(t.technicians)?t.technicians.length:0,o=Ke(t.id),c=o.length;$n(t);const d=Number(t?.servicesClientPrice??0),{applyTax:m}=Rt(t),b=(t.description||"").trim(),f=b?gn(b,110):a("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),p=le(t.type),h=Rt(t)||{},S=Number(h.subtotal||0),E=(o||[]).reduce((C,v)=>C+(Number(v?.totalAmount)||oe(v)||0),0),K=h.applyTax?Number(((S+E)*re).toFixed(2)):0,O=Number((S+E+K).toFixed(2)),J=t.paymentHistory||t.payments||[],bt=Ue({totalAmount:O,paidAmount:J.length?0:t.paidAmount,paidPercent:J.length?0:t.paidPercent,history:J}),V=Ve({manualStatus:null,paidAmount:bt.paidAmount,paidPercent:bt.paidPercent,totalAmount:O}),ht=a(`projects.paymentStatus.${V}`,V==="paid"?"Paid":V==="partial"?"Partially Paid":"Unpaid"),M=V==="paid"?"status-paid":V==="partial"?"status-partial":"status-unpaid",Tt=V==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",lt=t.confirmed===!0||t.confirmed==="true",dt=_(String(t.id)),vt=t.projectCode||`PRJ-${u(String(t.id))}`,Et=u(vt);try{const v=(new URL(window.location.href).searchParams.get("paymentDebug")||"").toLowerCase();(v==="1"||v==="true"||v==="yes")&&console.debug("[PaymentDebug][card]",{projectId:t?.id,projectTaxableBase:S,combinedReservationsTotal:E,combinedTax:K,combinedTotalWithTax:O,paidAmount:bt.paidAmount,paidPercent:bt.paidPercent,paymentStatus:V})}catch{}const wt={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},Ct={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},Vt=wt[n]||wt.recent;a(Vt,Ct[n]||Ct.recent);const Lt=We(t),tt=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":Lt;a(`projects.status.${tt}`,Da[tt]||tt);const Q=(()=>{try{const C=t.start?new Date(t.start):null,v=t.end?new Date(t.end):C?new Date(C.getTime()+ie):null;return!C||!v||Number.isNaN(C.getTime())||Number.isNaN(v.getTime())?!1:$.projects.some(U=>{if(!U||String(U.id)===String(t.id))return!1;const X=U.start?new Date(U.start):null,Z=U.end?new Date(U.end):X?new Date(X.getTime()+ie):null;if(!X||!Z||Number.isNaN(X.getTime())||Number.isNaN(Z.getTime()))return!1;const _t=Math.max(C.getTime(),X.getTime()),Ht=Math.min(v.getTime(),Z.getTime());return _t<Ht})}catch{return!1}})()&&(tt==="upcoming"||tt==="ongoing")?"conflict":tt,pe=Q==="upcoming"?"timeline-status-badge timeline-status-badge--upcoming":Q==="ongoing"?"timeline-status-badge timeline-status-badge--ongoing":Q==="completed"?"timeline-status-badge timeline-status-badge--completed":Q==="cancelled"?"timeline-status-badge timeline-status-badge--cancelled":"timeline-status-badge timeline-status-badge--conflict",Y=(t.title||"").trim()||a("projects.fallback.untitled","Untitled project"),xt=Q==="cancelled"?[]:[Tt];Q==="cancelled"?xt.push("project-focus-card--cancelled"):lt&&xt.push("project-focus-card--confirmed");const Pt=o.reduce((C,v)=>{const U=Array.isArray(v.items)?v.items:[],X=Array.isArray(v.crewAssignments)?v.crewAssignments:[],Z=X.length?X:Array.isArray(v.technicians)?v.technicians:[],_t=hn({items:U,technicianIds:Array.isArray(Z)&&!Z.length?Z:[],crewAssignments:Array.isArray(Z)&&Z.length&&typeof Z[0]=="object"?Z:[],discount:v.discount??0,discountType:v.discountType||"percent",applyTax:!1,start:v.start,end:v.end,companySharePercent:null}),Ht=oe(v),Pe=(()=>{try{const{groups:Zt}=Oe(v);return(Zt||[]).reduce((Bt,mt)=>{if(String(mt?.type||"").toLowerCase()==="package"){const De=Array.isArray(mt?.packageItems)?mt.packageItems:[],je=new Set(De.map(zt=>(zt?.normalizedBarcode||zt?.barcode||zt?.equipmentId||"").toString()));return Bt+je.size}const te=Number.isFinite(Number(mt?.count))?Number(mt.count):Number.isFinite(Number(mt?.quantity))?Number(mt.quantity):1;return Bt+(te>0?te:1)},0)}catch{return(Array.isArray(v?.items)?v.items:[]).length||0}})(),Fe=(v.technicians||[]).length;return{netTotal:C.netTotal+Ht,equipmentMoney:C.equipmentMoney+Number(_t.equipmentTotal||0),crewMoney:C.crewMoney+Number(_t.crewTotal||0),equipmentCount:C.equipmentCount+Pe,crewCount:C.crewCount+Fe}},{netTotal:0,equipmentMoney:0,crewMoney:0,equipmentCount:0,crewCount:0}),Wt=Number(Pt.netTotal.toFixed(2)),me=Pt.equipmentCount,Mt=Pt.crewCount||r,fe=Number(d||0),gt=Number((Pt.equipmentMoney+Pt.crewMoney+fe).toFixed(2)),It=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let Ft=(t?.discountType==="amount"?"amount":"percent")==="amount"?It:gt*(It/100);(!Number.isFinite(Ft)||Ft<0)&&(Ft=0),Ft>gt&&(Ft=gt);const et=Math.max(0,gt-Ft),Gt=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",Jt=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,Qt=Gt&&m&&Jt>0?Jt:0,Yt=Number((et*(Qt/100)).toFixed(2)),ye=m?Number(((et+Yt)*re).toFixed(2)):0,be=Number((et+Yt+ye).toFixed(2)),he=`<span class="project-code-badge project-focus-card__code">#${_(Et)}</span>`,ve="",ge="",_e=a(`projects.status.${Q}`,Q),$e=`<span class="${pe}">${_(_e)}</span>`,Se=`<span class="reservation-chip ${M} project-focus-card__payment-chip">${_(ht)}</span>`,P=(C,v,U)=>{const X=String(U||""),_t=X.trim().startsWith("<");return`
      <div class="project-focus-card__row">
        <span class="project-focus-card__row-label">
          ${C?`<span class="project-focus-card__row-icon">${_(C)}</span>`:""}
          ${_(v)}
        </span>
        <span class="project-focus-card__row-value">${_t?X:_(X)}</span>
      </div>
    `},{dateHtml:Ae,timeText:Xt}=Ra(t.start,t.end),Ne=[{icon:"ğŸ‘¤",label:a("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:i},{icon:"ğŸ·ï¸",label:a("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`<span class="project-type-chip project-type-chip--${t.type||"default"}">${_(p)}</span>`},{icon:"ğŸ“…",label:a("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Ae},Xt?{icon:"â°",label:a("projects.focus.summary.time","Ø§Ù„ÙˆÙ‚Øª"),value:Xt}:null].filter(Boolean).map(({icon:C,label:v,value:U})=>P(C,v,U)).join(""),Te=Qt>0&&m?` ${a("projects.details.chips.vatOn","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)")}`:"",we=`${a("projects.details.summary.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")}${Te}`,Ce=[{icon:"ğŸ’¼",label:a("projectCards.stats.servicesClientPrice","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"),value:Nt(d)},{icon:"ğŸ’µ",label:we,value:Nt(be)}].map(({icon:C,label:v,value:U})=>P(C,v,U)).join(""),xe=[{icon:"ğŸ”—",label:a("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:u(String(c))},{icon:"ğŸ“¦",label:a("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:u(String(me))},{icon:"ğŸ˜",label:a("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:u(String(Mt))},{icon:"ğŸ’µ",label:a("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:Nt(Wt)}].map(({icon:C,label:v,value:U})=>P(C,v,U)).join("");let Dt="";return Q==="cancelled"?Dt=`<span class="reservation-chip status-cancelled project-focus-card__confirm-indicator">${_(a("projects.focus.cancelled","Ù…Ø´Ø±ÙˆØ¹ Ù…Ù„ØºÙŠ"))}</span>`:lt?Q!=="completed"?Dt=`<button class="btn btn-sm btn-warning project-focus-card__confirm-btn" data-action="close-project" data-id="${dt}">${_(a("projects.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`:Dt=`<span class="reservation-chip status-completed project-focus-card__confirm-indicator">${_(a("projects.tag.closed","Ù…ØºÙ„Ù‚"))}</span>`:Dt=`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${dt}">${_(a("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`,`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${[...xt,Q==="completed"?"project-focus-card--completed":""].filter(Boolean).join(" ")}" data-project-id="${dt}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${he}
          ${ve}
          ${ge}
          ${$e}
          ${Se}
        </div>
        <h6 class="project-focus-card__title">${_(Y)}</h6>
        <p class="project-focus-card__description">${_(f)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${_(a("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${Ne}
            </div>
          </div>
          <!-- Show reservations above the financial summary -->
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${_(a("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${xe}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${_(a("projects.focus.summary.payment","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${Ce}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${Dt}
        </div>
      </article>
    </div>
  `}function mn(t){if(!t?.start)return!1;const n=new Date(t.start);if(Number.isNaN(n.getTime()))return!1;const s=new Date;return n.getFullYear()===s.getFullYear()&&n.getMonth()===s.getMonth()&&n.getDate()===s.getDate()}function Ba(t){if(!t?.start)return!1;const n=new Date(t.start);if(Number.isNaN(n.getTime()))return!1;const s=new Date,i=new Date(s);i.setHours(0,0,0,0);const r=i.getDay(),o=r===0?6:r-1;i.setDate(i.getDate()-o);const c=new Date(i);return c.setDate(c.getDate()+7),n>=i&&n<c}function We(t){const n=typeof t?.status=="string"?t.status.trim().toLowerCase():null,s=new Date,i=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;if(n&&(n==="cancelled"||n==="canceled"||n==="Ù…Ù„ØºÙŠ"||n==="Ù…Ù„ØºÙ‰"))return"cancelled";if(r&&!Number.isNaN(r.getTime())&&r<s)return"completed";if(n){if(n==="completed"||n==="Ù…ÙƒØªÙ…Ù„"||n==="Ù…ØºÙ„Ù‚")return"completed";if(n==="ongoing"||n==="in_progress"||n==="in-progress"||n==="Ø¬Ø§Ø±ÙŠ"||n==="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°")return"ongoing";if(n==="upcoming"||n==="Ù‚Ø§Ø¯Ù…")return"upcoming"}return i&&!Number.isNaN(i.getTime())&&i>s?"upcoming":"ongoing"}function $n(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((n,s)=>n+(Number(s.amount)||0),0):0}function Rt(t){const n=Number(t?.equipmentEstimate)||0,s=$n(t),i=n+s,r=t?.applyTax===!0||t?.applyTax==="true",o=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let d=(t?.discountType==="amount"?"amount":"percent")==="amount"?o:i*(o/100);(!Number.isFinite(d)||d<0)&&(d=0),d>i&&(d=i);const m=Math.max(0,i-d),b=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",f=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,p=r||b&&f>0,h=b&&p&&f>0?f:0,S=h>0?Number((m*(h/100)).toFixed(2)):0,E=m+S;let K=p?E*re:0;(!Number.isFinite(K)||K<0)&&(K=0),K=Number(K.toFixed(2));let O=p?Number(t?.totalWithTax):E;return p?(!Number.isFinite(O)||O<=0)&&(O=Number((E+K).toFixed(2))):O=E,{equipmentEstimate:n,expensesTotal:s,baseSubtotal:i,discountAmount:d,subtotalAfterDiscount:m,companyShareAmount:S,subtotal:E,applyTax:p,taxAmount:K,totalWithTax:O}}function ls(){const t=$.projects.length,n=$.projects.filter(r=>{const o=r.start?new Date(r.start):null;return!o||Number.isNaN(o.getTime())?!1:o>new Date}).length,s=$.projects.reduce((r,o)=>r+Rt(o).expensesTotal,0),i=$.projects.reduce((r,o)=>r+Rt(o).totalWithTax,0);R.projectsCount&&(R.projectsCount.textContent=u(String(t))),R.projectsUpcoming&&(R.projectsUpcoming.textContent=u(String(n))),R.projectsExpenses&&(R.projectsExpenses.textContent=Nt(s)),R.projectsBudget&&(R.projectsBudget.textContent=Nt(i))}function Ke(t){return t?$.reservations.filter(n=>{const s=n?.projectId??n?.project_id??null;return s!=null&&String(s)===String(t)}):[]}function oe(t){if(!t)return 0;const n=Array.isArray(t.items)?t.items:[],s=t.discount??0,i=Number(u(String(s)))||0,r=t.discountType||"percent",o=Array.isArray(t.crewAssignments)?t.crewAssignments:[],c=o.length?o:Array.isArray(t.technicians)?t.technicians:[],d=fa(n,i,r,!1,c,{start:t.start,end:t.end,companySharePercent:0});if(Number.isFinite(d))return d;const m=Number(u(String(t.cost??0)));return Number.isFinite(m)?Math.round(m):0}function za(t){try{const{groups:n}=Oe(t);return(n||[]).reduce((s,i)=>{if(String(i?.type||"").toLowerCase()==="package"){const c=Array.isArray(i?.packageItems)?i.packageItems:[],d=new Set(c.map(m=>(m?.normalizedBarcode||m?.barcode||m?.equipmentId||"").toString()));return s+d.size}const o=Number.isFinite(Number(i?.count))?Number(i.count):Number.isFinite(Number(i?.quantity))?Number(i.quantity):1;return s+(o>0?o:1)},0)}catch{return(Array.isArray(t?.items)?t.items:[]).length||0}}function Oa(t,n,s=null){if(!t)return"";const i=t.reservationId||t.id||`RES-${n+1}`,r=t.status||t.state||"pending",o=String(r).toLowerCase(),{effectiveConfirmed:c}=ze(t,s),d=c?"confirmed":o,m=a(`reservations.list.status.${d}`,d==="confirmed"?"âœ… Ù…Ø¤ÙƒØ¯":d==="pending"?"â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯":d),f={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[d]||"project-reservation-card__badge--info",p=typeof s?.paymentStatus=="string"?s.paymentStatus.toLowerCase():null,h=p&&["paid","partial","unpaid"].includes(p)?p:String(t.paidStatus||t.paymentStatus||(t.paid?"paid":"unpaid")).toLowerCase(),S=h==="paid"?"paid":h==="partial"?"partial":"unpaid",E=S==="paid"?a("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"):S==="partial"?a("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"):a("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),K=S==="paid"?"project-reservation-card__badge--paid":S==="partial"?"project-reservation-card__badge--partial":"project-reservation-card__badge--unpaid",O=t.completed===!0||t.completed==="true",J=a("reservations.details.completed","Ù…ØºÙ„Ù‚"),bt=O?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${_(J)}</span>`:"",V=oe(t),ht=Nt(V),M=za(t),Tt=(t.technicians||[]).length,lt=a("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),dt=a("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),vt=a("projectCards.stats.reservationTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${n}" data-reservation-index="${n}" data-project-id="${s?s.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${_(i)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${f}">${_(m)}</span>
          <span class="project-reservation-card__badge ${K}">${_(E)}</span>
          ${bt}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__meta project-reservation-card__meta--vertical">
          <span>ğŸ˜ ${_(lt)}: ${u(String(Tt))}</span>
          <span>ğŸ“¦ ${_(dt)}: ${u(String(M))}</span>
          <span>ğŸ’µ ${_(vt)}: ${_(ht)}</span>
        </div>
      </div>
    </article>
  `}function ds(t){const n=Ke(t.id).map(o=>{const c=o?.id??o?.reservationId??o?.reservation_code??o?.reservation_id,d=$.reservations.findIndex(m=>{const b=m?.id??m?.reservationId??m?.reservation_code??m?.reservation_id;return c!=null&&b!=null&&String(b)===String(c)});return{reservation:o,index:d}}).filter(({index:o})=>Number.isInteger(o)&&o>=0).sort((o,c)=>{const d=o.reservation.start?new Date(o.reservation.start).getTime():0;return(c.reservation.start?new Date(c.reservation.start).getTime():0)-d}),s=a("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),i=a("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),r=n.length?`<div class="project-reservations-list">${n.map(({reservation:o,index:c})=>Oa(o,c,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${_(i)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${_(s)}</h6>
      </div>
      ${r}
    </section>
  `}function z(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Me(t){if(t==null)return"";const n=String(t).trim();return n?u(n):""}function us(t,n,s=[],i,r=null){const{projectLinked:o,effectiveConfirmed:c}=ze(t,r);t.paid===!0||t.paid;const d=ya(t),m=t.items||[];let{groups:b}=Oe(t);const f=e=>!!(e&&typeof e=="object"&&(e.type==="package"||Array.isArray(e.packageItems)&&e.packageItems.length||Array.isArray(e.items)&&e.items.some(l=>l&&l.type==="package"))),p=e=>{const l=(e?.package_code??e?.packageDisplayCode??e?.barcode??e?.description??(Array.isArray(e?.items)&&e.items[0]?.barcode)??"").toString().trim().toLowerCase();return u(l)},h=(e,l)=>{const A=k=>{const H=Array.isArray(k?.items)?k.items[0]:null,D=[H?.price,H?.unit_price,H?.unitPrice,k?.unitPrice,k?.totalPrice];for(const st of D){const g=rt(st);if(Number.isFinite(g)&&g>0)return g}return 0},F=A(e),I=A(l);return F&&I?F<=I?e:l:F?e:l},S=[],E=new Map;b.forEach(e=>{if(!f(e)){S.push(e);return}const l=p(e);if(!l){if(!E.has("__unknown__"))E.set("__unknown__",S.length),S.push(e);else{const A=E.get("__unknown__");S[A]=h(S[A],e)}return}if(!E.has(l))E.set(l,S.length),S.push(e);else{const A=E.get(l);S[A]=h(S[A],e)}}),b=S;const{technicians:K=[]}=He(),O=[].concat(Array.isArray(s)?s:[]).concat(Array.isArray(K)?K:[]),J=new Map;O.forEach(e=>{if(!e||e.id==null)return;const l=String(e.id),A=J.get(l)||{};J.set(l,{...A,...e})});const V=(Array.isArray(t.crewAssignments)&&t.crewAssignments.length?t.crewAssignments:Array.isArray(t.techniciansDetails)&&t.techniciansDetails.length?t.techniciansDetails:(t.technicians||[]).map(e=>({technicianId:e}))).map((e,l)=>{const A=e?.technicianId!=null?J.get(String(e.technicianId)):null;let F=e.positionLabel??e.position_name??e.position_label??e.role??e.position??"";(!F||F.trim()==="")&&(F=e.positionLabelAr??e.position_label_ar??e.positionLabelEn??e.position_label_en??e.position_name_ar??e.position_name_en??"");const I=e.positionLabelAlt??e.position_label_alt??e.positionLabelEn??e.position_label_en??e.positionLabelAr??e.position_label_ar??"";let k=F,H=I;if(!k||k.trim()==="")try{const g=ae?ae():[];let y=null;if(e.positionId!=null&&(y=g.find(T=>String(T.id)===String(e.positionId))||null),!y){const T=e.positionKey??e.position_key??e.positionName??e.position_name??e.position??"";if(T&&(y=typeof cn=="function"?cn(T):null,!y&&g.length)){const x=String(T).trim().toLowerCase();y=g.find(nt=>[nt.name,nt.labelAr,nt.labelEn].filter(Boolean).map(L=>String(L).toLowerCase()).includes(x))||null}}y&&(k=y.labelAr||y.labelEn||y.name||"",(!H||String(H).trim()==="")&&(y.labelAr&&y.labelEn?H=k===y.labelAr?y.labelEn:y.labelAr:H=y.labelAr||y.labelEn||""))}catch{}const D=B(rt(e.positionCost??e.position_cost??e.cost??e.daily_wage??e.dailyWage??A?.dailyWage??A?.wage??0)),st=B(rt(e.positionClientPrice??e.position_client_price??e.client_price??e.clientPrice??e.daily_total??e.dailyTotal??e.total??A?.dailyTotal??A?.total??A?.total_wage??0));return{assignmentId:e.assignmentId??e.assignment_id??`crew-${l}`,positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_key??e.positionName??e.position_name??e.position??null,positionLabel:k,positionLabelAlt:H,positionLabelAr:e.positionLabelAr??e.position_label_ar??null,positionLabelEn:e.positionLabelEn??e.position_label_en??null,positionCost:D,positionClientPrice:st,technicianId:e.technicianId!=null?String(e.technicianId):A?.id!=null?String(A.id):null,technicianName:e.technicianName??e.technician_name??A?.name??null,technicianRole:e.technicianRole??A?.role??null,technicianPhone:e.technicianPhone??A?.phone??null,notes:e.notes??null}}),ht=Be(),M=ba(t.start,t.end),Tt=t.discount??t.discountValue??t.discount_value??t.discountAmount??0,lt=rt(Tt),dt=Number.isFinite(lt)?lt:0,vt=t.discountType??t.discount_type??t.discountMode??"percent",Et=String(vt).toLowerCase()==="amount"?"amount":"percent",wt=!!(t.applyTax??t.apply_tax??t.taxApplied),Ct=rt(t.cost??t.total??t.finalTotal);Number.isFinite(Ct)&&B(Ct);const Lt=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share,tt=Lt!=null?rt(Lt):Number.NaN,pe=((t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied)===!0||Number.isFinite(tt)&&tt>0)&&Number.isFinite(tt)?tt:0,Y=hn({items:m,technicianIds:t.technicians||[],crewAssignments:V,discount:dt,discountType:Et,applyTax:wt,start:t.start,end:t.end,companySharePercent:pe,groupingSource:t}),xt=B(Y.equipmentTotal),Pt=B(Y.equipmentCostTotal),Wt=B(Y.crewTotal),me=B(Y.crewCostTotal),Mt=B(Y.discountAmount),fe=B(Y.subtotalAfterDiscount),gt=Number.isFinite(Y.companySharePercent)?Y.companySharePercent:0;let It=B(Y.companyShareAmount);It=gt>0?B(Math.max(0,It)):0;const Kt=B(Y.taxAmount),et=B(Y.finalTotal),Gt=B(Y.netProfit),Jt=u(String(t.reservationId??t.id??"")),Qt=t.start?u(Ee(t.start)):"-",Yt=t.end?u(Ee(t.end)):"-",ye=u(String(V.length)),be=u(xt.toFixed(2)),he=u(Pt.toFixed(2)),ve=u(Mt.toFixed(2)),ge=u(fe.toFixed(2)),_e=u(Kt.toFixed(2)),$e=u((Number.isFinite(et)?et:0).toFixed(2)),Se=u(String(M)),P=a("reservations.create.summary.currency","SR"),Ae=a("reservations.details.labels.discount","Ø§Ù„Ø®ØµÙ…"),Xt=a("reservations.details.labels.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)"),Ne=a("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),Te=a("reservations.details.labels.subtotalAfterDiscount","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"),we=a("reservations.details.labels.duration","Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),Ce=a("reservations.details.labels.companyShare","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),xe=a("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),Dt=a("reservations.details.labels.equipmentCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),C=a("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),v={item:a("reservations.equipment.table.item","Ø§Ù„Ù…Ø¹Ø¯Ø©"),quantity:a("reservations.equipment.table.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),unitPrice:a("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©"),unitCost:a("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©"),total:a("reservations.equipment.table.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"),actions:a("reservations.equipment.table.actions","Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª")},U=a("reservations.details.noItems","ğŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø­Ø§Ù„ÙŠØ§Ù‹."),X=a("reservations.details.noCrew","ğŸ˜ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø².");a("reservations.details.technicians.roleUnknown","ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const Z=a("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±");a("reservations.details.technicians.wage","{amount} {currency} / Ø§Ù„ÙŠÙˆÙ…");const _t=a("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),Ht=a("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),Pe=a("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),Fe=a("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),Zt=a("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),Bt=a("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),mt=a("reservations.details.labels.id","ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"),Ge=a("reservations.details.section.bookingInfo","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"),te=a("reservations.details.section.paymentSummary","Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹"),De=a("reservations.details.labels.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),je=a("reservations.details.section.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ"),zt=a("reservations.details.crew.count","{count} Ø¹Ø¶Ùˆ"),Sn=a("reservations.details.section.items","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),An=a("reservations.details.items.count","{count} Ø¹Ù†ØµØ±"),Nn=a("reservations.details.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),Tn=a("reservations.details.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),wn=a("reservations.details.labels.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„"),Cn=a("reservations.details.labels.contact","Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„"),xn=a("reservations.details.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·");a("reservations.details.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙŠ Ù…Ø´Ø±ÙˆØ¹.");const Pn=a("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),Fn=a("reservations.details.actions.openProject","ğŸ“ ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),Dn=a("reservations.details.labels.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),jn=a("reservations.details.labels.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),kn=a("reservations.details.labels.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),Ln=a("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),In=a("reservations.details.labels.itemsCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),qn=a("reservations.details.labels.itemsTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),Rn=Dt,En=a("reservations.paymentHistory.title","Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª"),Mn=a("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©"),Hn=a("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),Je=!o||!r?[]:Array.isArray(r?.paymentHistory)?r.paymentHistory:Array.isArray(r?.payment_history)?r.payment_history:Array.isArray(r?.payments)?r.payments:Array.isArray(r?.paymentLogs)?r.paymentLogs:[],Bn=Array.isArray(t?.paymentHistory)?t.paymentHistory:Array.isArray(t?.payment_history)?t.payment_history:Array.isArray(t?.paymentLogs)?t.paymentLogs:[],ke=Je.length?Je:Bn,zn=ke.length?0:Number(t.paidAmount??t.paid_amount)||0,On=ke.length?0:Number(t.paidPercent??t.paid_percentage)||0,Qe=Ue({totalAmount:Number.isFinite(Number(et))?Number(et):0,paidAmount:zn,paidPercent:On,history:ke}),ee=Ve({manualStatus:null,paidAmount:Qe.paidAmount,paidPercent:Qe.paidPercent,totalAmount:Number.isFinite(Number(et))?Number(et):0}),Le=ee==="partial",Ye=ee==="paid"?Pe:Le?Zt:Fe;function Un(e){if(e==null)return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;const l=String(e).replace(/[^0-9.+-]/g,""),A=Number(l);return Number.isFinite(A)?A:Number.NaN}const Ie=(e={})=>{const l=String(e.type??e.kind??e.category??"").toLowerCase();return!!(["package","bundle","pack"].includes(l)||Array.isArray(e.packageItems)&&e.packageItems.length)},Vn=(e={})=>[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id].some(l=>l!=null&&l!==""),Wn=(e={})=>!e||typeof e!="object"?!1:!Ie(e)&&Vn(e);let qe=Array.isArray(b)&&b.length?b.length:(Array.isArray(m)?m.filter(e=>e&&typeof e=="object"&&!Wn(e)).length:0)||1;qe=Math.max(1,Math.round(qe));const Kn=u(String(qe)),Xe=An.replace("{count}",Kn),Gn=zt.replace("{count}",ye),Jn=t.notes?u(t.notes):Ln,Qn=u(Wt.toFixed(2)),Yn=u(me.toFixed(2)),Xn=u(String(gt)),Zn=u(It.toFixed(2)),ta=`${Xn}% (${Zn} ${P})`,ea=Number.isFinite(Gt)?Math.max(0,Gt):0,na=u(ea.toFixed(2)),ut=[{icon:"ğŸ’¼",label:qn,value:`${be} ${P}`}];ut.push({icon:"ğŸ’¸",label:Rn,value:`${he} ${P}`}),ut.push({icon:"ğŸ˜",label:Ne,value:`${Qn} ${P}`});const aa=a("reservations.details.labels.crewCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ±ÙŠÙ‚");ut.push({icon:"ğŸ’µ",label:aa,value:`${Yn} ${P}`}),Mt>0&&ut.push({icon:"ğŸ’¸",label:Ae,value:`${ve} ${P}`}),ut.push({icon:"ğŸ“Š",label:Te,value:`${ge} ${P}`}),wt&&Kt>0&&ut.push({icon:"ğŸ§¾",label:Xt,value:`${_e} ${P}`}),gt>0&&ut.push({icon:"ğŸ¦",label:Ce,value:ta}),ut.push({icon:"ğŸ’µ",label:xe,value:`${na} ${P}`}),ut.push({icon:"ğŸ’°",label:De,value:`${$e} ${P}`});const sa=ut.map(({icon:e,label:l,value:A})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${e} ${l}</span>
      <span class="summary-details-value">${A}</span>
    </div>
  `).join("");let Ze="";try{const l=new URL(window.location.href).searchParams.get("debugFinance");if(l==="1"||l==="true"){const A=g=>(g?.type||"").toLowerCase()==="package"&&String(g?.pricingMode||"").toLowerCase()==="fixed"?"fixed":"daily",F=g=>{if((g?.type||"").toLowerCase()==="package")return!1;const y=Array.isArray(g?.items)?g.items:[];if(!y.length)return!1;if(y.some(L=>L?.reservation_id!=null||L?.reservationId!=null))return!0;const x=y.every(L=>L?.unit_price!=null||L?.unitPrice!=null),nt=y.some(L=>L?.daily_rate!=null||L?.dailyRate!=null||L?.unit_rate!=null||L?.unitRate!=null||L?.price!=null);return x&&!nt};let I=0,k=0,H=0,D=0;const st=(Array.isArray(b)?b:[]).map((g,y)=>{const T=Number.isFinite(Number(g?.quantity))?Number(g.quantity):0,x=Number.isFinite(Number(g?.unitPrice))?Number(g.unitPrice):0,nt=A(g);let L=nt==="fixed"?T*x:T*x*M,pt="";if((g?.type||"").toLowerCase()==="package")try{const it={package_code:g?.package_code||g?.packageDisplayCode||g?.barcode||g?.packageId||g?.key,packageItems:Array.isArray(g?.packageItems)?g.packageItems:void 0},yt=Number(g?.unitPrice);let $t;if(Number.isFinite(yt)&&yt>0)$t=T*yt;else{const G=on(it,{packageQuantity:T,days:M});$t=Number.isFinite(Number(G.perDayTotal))?Number(G.perDayTotal):T*x}L=$t*M,I+=$t,k+=L;const ne=(pricing.lines||[]).map((G,rn)=>`
              <tr>
                <td colspan="2"></td>
                <td>â€¢ ${z(String(G.desc||G.barcode||"item"))}</td>
                <td>${u(String(G.qtyPerPackage))} Ã— ${u(String(T))} Ã— ${u(String(M))}</td>
                <td>${u(String((G.unitPrice||0).toFixed?G.unitPrice.toFixed(2):G.unitPrice))}</td>
                <td>${u(String((G.perDayTotal*M).toFixed?(G.perDayTotal*M).toFixed(2):G.perDayTotal*M))}</td>
              </tr>`).join("");pt=ne||""}catch{}else{const it=F(g),yt=it?0:T*x,$t=it?T*x:yt*M;H+=yt,D+=$t}return`
          <tr>
            <td>${y+1}</td>
            <td>${z(String(g?.description||"-"))}</td>
            <td>${nt}</td>
            <td>${u(String(T))}</td>
            <td>${u(String(x.toFixed?x.toFixed(2):x))}</td>
            <td>${u(String(L.toFixed?L.toFixed(2):L))}</td>
          </tr>${pt}`}).join("");Ze=`
        <details class="reservation-finance-debug" style="margin-top:12px">
          <summary>Debug: ØªÙØµÙŠÙ„ Ø§Ù„ØªØ³Ø¹ÙŠØ±</summary>
          <div style="padding:8px 0; font-size: 12px">
            <div>Ø§Ù„Ø£ÙŠØ§Ù…: ${u(String(M))}</div>
            <div style="margin-top:6px"><strong>Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø³Ø±ÙŠØ¹Ø©:</strong></div>
            <div>Ù…Ù† Ø§Ù„Ø­ÙØ²Ù… (ÙŠÙˆÙ…ÙŠ): ${u(String(I.toFixed(2)))} ${P}</div>
            <div>Ù…Ù† Ø§Ù„Ø­ÙØ²Ù… (ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¯Ø©): ${u(String(k.toFixed(2)))} ${P}</div>
            <div>Ù…ÙØ±Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙØ²Ù… (ÙŠÙˆÙ…ÙŠ): ${u(String(H.toFixed(2)))} ${P}</div>
            <div>Ù…ÙØ±Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙØ²Ù… (ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¯Ø©): ${u(String(D.toFixed(2)))} ${P}</div>
            <div style="margin-top:4px">Equipment Total (breakdown): ${u(String(xt.toFixed(2)))} ${P}</div>
            <table class="table table-xs" style="width:100%; margin-top:8px">
              <thead>
                <tr>
                  <th>#</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø©</th>
                </tr>
              </thead>
              <tbody>${st}</tbody>
            </table>
          </div>
        </details>`,console.debug("[finance-debug] groups",b,{rentalDays:M,equipmentTotal:xt,crewTotal:Wt,discountAmount:Mt,taxAmount:Kt})}}catch{}console.debug("[reservations/details] payment history raw",t.paymentHistory,t.payment_history);let at=[];o&&r&&(Array.isArray(r.paymentHistory)?at=r.paymentHistory:Array.isArray(r.payment_history)?at=r.payment_history:Array.isArray(r.payments)?at=r.payments:Array.isArray(r.paymentLogs)&&(at=r.paymentLogs)),(!Array.isArray(at)||at.length===0)&&(Array.isArray(t.paymentHistory)?at=t.paymentHistory:Array.isArray(t.payment_history)?at=t.payment_history:Array.isArray(t.paymentLogs)?at=t.paymentLogs:at=[]);const tn=Array.isArray(at)?at:[],ia=tn.length?`<ul class="reservation-payment-history-list">${tn.map(e=>{const l=typeof e?.type=="string"?e.type.toLowerCase():"",A=l==="amount"?a("reservations.paymentHistory.type.amount","Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©"):l==="percent"?a("reservations.paymentHistory.type.percent","Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©"):a("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©"),F=Number.isFinite(Number(e?.percentage))&&Number(e.percentage)>0?Number(e.percentage):Number.isFinite(Number(e?.value))&&l==="percent"?Number(e.value):null,I=F!=null&&Number.isFinite(Number(et))&&Number(et)>0?Math.round(Number(et)*(F/100)*100)/100:null,k=Number.isFinite(Number(e?.amount))&&Number(e.amount)>0?Number(e.amount):null,H=l==="percent"&&I!=null?I:k,D=H!=null?`${u(H.toFixed(2))} ${P}`:"â€”",st=F!=null?`${u(F.toFixed(2))}%`:"â€”",g=e?.recordedAt?u(Ee(e.recordedAt)):"â€”",y=e?.note?`<div class="payment-history-note">${z(u(e.note))}</div>`:"";return`
          <li>
            <div class="payment-history-entry">
              <span class="payment-history-entry__type">${z(A)}</span>
              <span class="payment-history-entry__amount">${D}</span>
              <span class="payment-history-entry__percent">${st}</span>
              <span class="payment-history-entry__date">${g}</span>
            </div>
            ${y}
          </li>
        `}).join("")}</ul>`:`<div class="reservation-payment-history-empty">${z(Mn)}</div>`,en=String(t?.status||t?.reservationStatus||"").toLowerCase(),nn=en==="cancelled"||en==="canceled",an=nn?[{text:a("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ"),className:"status-cancelled"},{text:Ye,className:ee==="paid"?"status-paid":Le?"status-partial":"status-unpaid"}]:[{text:c?_t:Ht,className:c?"status-confirmed":"status-pending"},{text:Ye,className:ee==="paid"?"status-paid":Le?"status-partial":"status-unpaid"}];d&&!nn&&an.push({text:Bt,className:"status-completed"});const ra=an.map(({text:e,className:l})=>`<span class="status-chip ${l}">${e}</span>`).join(""),jt=(e,l,A)=>`
    <div class="res-info-row">
      <span class="label">${e} ${l}</span>
      <span class="value">${A}</span>
    </div>
  `;let Re="";if(t.projectId){let e=z(Pn);if(r){const l=r.title||a("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");e=`${z(l)} <button type="button" class="btn btn-sm btn-outline-primary" data-action="open-project" data-project-id="${r.id}">${z(Fn)}</button>`}Re=`
      <div class="res-info-row">
        <span class="label">ğŸ“ ${xn}</span>
        <span class="value">${e}</span>
      </div>
    `}const ft=[];ft.push(jt("ğŸ‘¤",wn,n?.customerName||t.customerName||Hn)),ft.push(jt("ğŸ“",Cn,n?.phone||"â€”")),ft.push(jt("ğŸ—“ï¸",Dn,Qt)),ft.push(jt("ğŸ—“ï¸",jn,Yt)),ft.push(jt("ğŸ“¦",In,Xe)),ft.push(jt("â±ï¸",we,Se)),ft.push(jt("ğŸ“",kn,Jn)),Re&&ft.push(Re);const oa=ft.join(""),ca=b.length?b.map(e=>{const l=e.items[0]||{},A=xa(l)||e.image,F=A?`<img src="${A}" alt="${C}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>';let I=[];if(Array.isArray(e.packageItems)&&e.packageItems.length)I=[...e.packageItems];else{const N=[];e.items.forEach(q=>{Array.isArray(q?.packageItems)&&q.packageItems.length&&N.push(...q.packageItems)}),I=N}if(Array.isArray(I)&&I.length>1){const N=new Set;I=I.filter(q=>{const w=q?.normalizedBarcode&&String(q.normalizedBarcode).toLowerCase()||q?.barcode&&String(q.barcode).toLowerCase()||(q?.equipmentId!=null?`id:${q.equipmentId}`:null);return w?N.has(w)?!1:(N.add(w),!0):!0})}const k=Ie(e)||e.items.some(N=>Ie(N))||I.length>0,H=(N,{fallback:q=1,max:w=1e3}={})=>{const j=Un(N);return Number.isFinite(j)&&j>0?Math.min(w,j):q};let D;if(k){const N=H(l?.qty??l?.quantity??l?.count,{fallback:NaN,max:999});Number.isFinite(N)&&N>0?D=N:D=H(e.quantity??e.count??1,{fallback:1,max:999})}else D=H(e.quantity??e.count??l?.qty??l?.quantity??l?.count??0,{fallback:1,max:9999});const st=u(String(D)),g=(N,{preferPositive:q=!1}={})=>{let w=Number.NaN;for(const j of N){const ot=rt(j);if(Number.isFinite(ot)){if(q&&ot>0)return ot;Number.isFinite(w)||(w=ot)}}return w};let y,T,x;if(k){const N=[l?.price,l?.unit_price,l?.unitPrice,e.unitPrice];if(y=g(N,{preferPositive:!0}),!Number.isFinite(y)||y<0){const j=rt(e.totalPrice??l?.total??l?.total_price);Number.isFinite(j)&&D>0&&(y=j/D)}Number.isFinite(y)||(y=0);const q=[l?.cost,l?.unit_cost,l?.unitCost,e.unitCost];T=g(q,{preferPositive:!0}),Number.isFinite(T)||(T=0);const w=[l?.total,l?.total_price,e.totalPrice];if(x=g(w),!Number.isFinite(x))x=y*D;else{const j=y*D;Number.isFinite(j)&&j>0&&Math.abs(x-j)>j*.25&&(x=j)}}else{const N=[l?.price,l?.unit_price,l?.unitPrice,e.unitPrice];if(y=g(N,{preferPositive:!0}),!Number.isFinite(y)||y<0){const w=rt(e.totalPrice??l?.total??l?.total_price);Number.isFinite(w)&&D>0&&(y=w/D)}Number.isFinite(y)||(y=0);const q=[l?.cost,l?.unit_cost,l?.unitCost,e.unitCost];T=g(q,{preferPositive:!0}),(!Number.isFinite(T)||T<0)&&(T=0),x=rt(e.totalPrice??l?.total??l?.total_price),Number.isFinite(x)||(x=y*D)}y=B(y),T=B(T),x=B(x);const nt=`${u(y.toFixed(2))} ${P}`,L=`${u(T.toFixed(2))} ${P}`;`${u(x.toFixed(2))}${P}`;const pt=e.barcodes.map(N=>u(String(N||""))).filter(Boolean),it=pt.length?`<details class="reservation-item-barcodes">
              <summary>${a("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
              <ul class="reservation-barcode-list">
                ${pt.map(N=>`<li>${N}</li>`).join("")}
              </ul>
            </details>`:"";let yt="";if(I.length){const N=new Map,q=w=>1;if(I.forEach(w=>{if(!w)return;const j=Ut(w.barcode||w.normalizedBarcode||w.desc||Math.random());if(!j)return;const ot=N.get(j),qt=q();if(ot){ot.qty=qt,ot.total=qt;return}N.set(j,{desc:w.desc||w.barcode||a("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Math.max(1,Math.min(qt,99)),total:Math.max(1,Math.min(qt,99)),barcode:w.barcode??w.normalizedBarcode??""})}),N.size){const w=Array.from(N.values()).map(j=>{const ot=u(String(j.qty>0?Math.min(j.qty,99):1)),qt=z(j.desc||""),pa=j.barcode?` <span class="reservation-package-items__barcode">(${z(u(String(j.barcode)))})</span>`:"";return`<li>${qt}${pa} Ã— ${ot}</li>`}).join("");yt=`
              <details class="reservation-package-items">
                <summary>${a("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
                <ul class="reservation-package-items__list">
                  ${w}
                </ul>
              </details>
            `}}const $t=k?`${yt||""}${it||""}`:it,ne=u(String(M));let G;if(k){let N=y;if(!Number.isFinite(N)||N<=0){const q={package_code:e?.package_code||e?.packageDisplayCode||e?.barcode||e?.packageId||e?.key,packageItems:Array.isArray(e?.packageItems)?e.packageItems:void 0};try{const w=on(q,{packageQuantity:Number.isFinite(D)?D:1,days:1});Number.isFinite(Number(w.perDayTotal))&&(N=Number(w.perDayTotal))}catch{}}G=B(N*M)}else G=B(y*D*M);const rn=`${u(G.toFixed(2))} ${P}`;return`
          <tr>
            <td class="reservation-modal-items-table__cell reservation-modal-items-table__cell--item">
              <div class="reservation-item-info">
                <div class="reservation-item-thumb-wrapper">${F}</div>
                <div class="reservation-item-copy">
                  <div class="reservation-item-title">${z(l.desc||l.description||l.name||e.description||"-")}</div>
                  ${$t}
                </div>
              </div>
            </td>
            <td class="reservation-modal-items-table__cell" data-label="${z(v.quantity)}">
              <div class="reservation-quantity-control reservation-quantity-control--static">
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">âˆ’</button>
                <span class="reservation-qty-value">${st}</span>
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">+</button>
              </div>
            </td>
            <td class="reservation-modal-items-table__cell" data-label="${z(a("reservations.details.table.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…"))}">${ne}</td>
            <td class="reservation-modal-items-table__cell" data-label="${z(v.unitPrice)}">${nt}</td>
            <td class="reservation-modal-items-table__cell" data-label="${z(v.unitCost)}">${L}</td>
            <td class="reservation-modal-items-table__cell" data-label="${z(v.total)}">${rn}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${U}</td></tr>`,la=`
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>${v.item}</th>
            <th>${v.quantity}</th>
            <th>${a("reservations.details.table.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…")}</th>
            <th>${v.unitPrice}</th>
            <th>${v.unitCost}</th>
            <th>${v.total}</th>
          </tr>
        </thead>
        <tbody>${ca}</tbody>
      </table>
    </div>
  `,sn=V.map((e,l)=>{const A=u(String(l+1));let F=e.positionLabel??e.position_name??e.position_label??e.position_title??e.role??e.position??null;if((!F||F.trim()==="")&&(F=e.positionLabelAr??e.position_label_ar??e.position_title_ar??e.positionLabelEn??e.position_label_en??e.position_name_ar??e.position_title_en??e.position_name_en??null),!F||F.trim()==="")try{const x=typeof ae=="function"?ae():[],nt=e.positionId?x.find(it=>String(it.id)===String(e.positionId)):null,L=!nt&&e.positionKey?x.find(it=>String(it.name).toLowerCase()===String(e.positionKey).toLowerCase()):null,pt=nt||L||null;pt&&(F=pt.labelAr||pt.labelEn||pt.name||F)}catch{}const I=Me(F)||a("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),k=Me(e.positionLabelAlt??e.position_label_alt??e.positionLabelEn??e.position_label_en??e.positionLabelAr??e.position_label_ar??e.position_name_en??e.position_name_ar??""),H=Me(e.technicianName)||a("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),D=e.technicianPhone||Z,st=B(rt(e.positionCost??e.position_cost??e.cost??e.daily_wage??e.dailyWage??e.internal_cost??0)),g=B(rt(e.positionClientPrice??e.position_client_price??e.client_price??e.customer_price??e.position_price??e.clientPrice??e.daily_total??e.dailyTotal??e.total??0)),y=`${u(g.toFixed(2))} ${P}`,T=st>0?`${u(st.toFixed(2))} ${P}`:null;return`
      <div class="reservation-technician-card">
        <div class="technician-card-head">
          <span class="technician-index">${A}</span>
          <div class="d-flex flex-column">
            <span class="technician-name">${H}</span>
            <small class="text-muted">ğŸ·ï¸ ${I}${k?` â€” ${k}`:""}</small>
            <small class="text-muted">ğŸ’¼ ${y}</small>
          </div>
        </div>
        <div class="technician-card-body">
          <div>ğŸ“ ${D}</div>
          ${T?`<div>ğŸ’µ ${a("reservations.details.technicians.costLabel","Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©")}: ${T}</div>`:""}
        </div>
      </div>
    `}).join(""),da=Array.isArray(V)&&V.length>4,ua=V.length?da?`
          <div class="reservation-technicians-slider" data-tech-slider>
            <button type="button" class="slider-btn slider-btn--prev" data-slider-prev aria-label="${z(a("reservations.details.slider.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"))}" title="${z(a("reservations.details.slider.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"))}">â€¹</button>
            <div class="reservation-technicians-track" data-slider-track>
              ${sn}
            </div>
            <button type="button" class="slider-btn slider-btn--next" data-slider-next aria-label="${z(a("reservations.details.slider.next","Ø§Ù„ØªØ§Ù„ÙŠ"))}" title="${z(a("reservations.details.slider.next","Ø§Ù„ØªØ§Ù„ÙŠ"))}">â€º</button>
          </div>
        `:`<div class="reservation-technicians-grid">${sn}</div>`:`<ul class="reservation-modal-technicians"><li>${X}</li></ul>`;return`
    <div class="reservation-modal">
      <div class="reservation-modal-header">
        <div class="reservation-modal-id">
          <span>${mt}</span>
          <strong>${Jt}</strong>
        </div>
        <div class="status-chips">
          ${ra}
        </div>
      </div>

      <div class="reservation-modal-grid">
        <div class="reservation-info-card">
          <h6>${Ge}</h6>
          ${oa}
        </div>
      </div>
      <div class="reservation-summary-card">
        <div class="summary-icon">ğŸ’³</div>
        <div class="summary-body">
          <h6 class="summary-heading">${te}</h6>
          <div class="summary-content">
            <div class="summary-details">
              ${sa}
            </div>
            <div class="reservation-payment-history-modal">
              <h6 class="history-heading">${En}</h6>
              ${ia}
            </div>
            ${Ze}
          </div>
        </div>
      </div>

      <div class="reservation-technicians-section">
        <div class="section-title">
          <span>${je}</span>
          <span class="count">${Gn}</span>
        </div>
        ${ua}
      </div>

      <div class="reservation-items-section">
        <div class="section-title">
          <span>${Sn}</span>
          <span class="count">${Xe}</span>
        </div>
        ${la}
      </div>

      <div class="reservation-modal-actions">
        <button type="button" class="modal-action-btn modal-action-btn--ghost" id="reservation-details-export-btn" data-index="${i}">
          ${a("reservations.details.actions.exportPdf","Ø¹Ø±Ø¶ Ø³Ø¹Ø±")}
        </button>
        <button type="button" class="modal-action-btn modal-action-btn--ghost" id="reservation-details-checklist-btn" data-index="${i}">
          ${a("reservations.details.actions.exportChecklist","ğŸ“‹ Ù„Ø³ØªØ© Ù…Ø¹Ø¯Ø§Øª ÙˆÙÙ†ÙŠÙŠÙ†")}
        </button>
        <button type="button" class="modal-action-btn modal-action-btn--primary" id="reservation-details-edit-btn" data-index="${i}">${Nn}</button>
        ${ht?`<button type="button" class="modal-action-btn modal-action-btn--danger" id="reservation-details-delete-btn" data-index="${i}">${Tn}</button>`:""}
      </div>
    </div>
  `}function de(){const t=()=>{Aa(),Na(),Sa()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(t,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(t);return}}t()}let fn=!1,yn=null;function Ua(t){if(!t||typeof t!="object")return"";const n=Object.entries(t).filter(([s,i])=>i!=null).map(([s,i])=>[s,String(i)]);return n.length===0?"":JSON.stringify(n.sort(([s],[i])=>s.localeCompare(i)))}async function ps(t={}){const{suppressError:n=!0,params:s=null,force:i=!1}=t??{},r=Ua(s);if(!i&&fn&&kt().length>0&&r===yn)return kt();try{const o=await $a(s||{});return fn=!0,yn=r,o}catch(o){if(console.error("âŒ [reservationsActions] Failed to load reservations from API",o),!n)throw o;return kt()}}async function ms(t,{onAfterChange:n}={}){if(!Be())return ma(),!1;const i=kt()[t];if(!i)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const r=i.id||i.reservationId;if(!r)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;try{return await ha(r),de(),n?.({type:"deleted",reservation:i}),W(a("reservations.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²")),!0}catch(o){console.error("âŒ [reservationsActions] deleteReservation failed",o);const c=ce(o)?o.message:a("reservations.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return W(c,"error"),!1}}async function fs(t,{onAfterChange:n}={}){const i=kt()[t];if(!i)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const r=i.id||i.reservationId;if(!r)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const{projectLinked:o}=ze(i);if(o)return W(a("reservations.toast.confirmBlockedByProject","âš ï¸ Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² ØªØªØ­ÙƒÙ… Ø¨Ù‡Ø§ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø· ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ£ÙƒÙŠØ¯Ù‡ Ù…Ù† Ù‡Ù†Ø§"),"info"),!1;try{const c=await va(r);return de(),n?.({type:"confirmed",reservation:c}),W(a("reservations.toast.confirmed","âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²")),!0}catch(c){console.error("âŒ [reservationsActions] confirmReservation failed",c);const d=ce(c)?c.message:a("reservations.toast.confirmFailed","ØªØ¹Ø°Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return W(d,"error"),!1}}async function ys(t,n="",{onAfterChange:s}={}){const r=kt()[t];if(!r)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const o=r.id||r.reservationId;if(!o)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;if(String(r.status||"").toLowerCase()==="completed")return W(a("reservations.toast.alreadyClosed","âœ… Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ù…ØºÙ„Ù‚ Ù…Ø³Ø¨Ù‚Ø§Ù‹")),!1;try{let d=r.notes?String(r.notes).trim():"";const m=(n||"").trim();if(m){const f=a("reservations.closeModal.notePrefix","Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥ØºÙ„Ø§Ù‚");d=d?`${d}
${f}: ${m}`:`${f}: ${m}`}const b=await ga(o,d);return de(),s?.({type:"closed",reservation:b}),W(a("reservations.toast.closed","âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²")),!0}catch(d){console.error("âŒ [reservationsActions] closeReservation failed",d);const m=ce(d)?d.message:a("reservations.toast.closeFailed","ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return W(m,"error"),!1}}function Va(t=""){const n=String(t||"");if(!n.trim())return"";const s=["Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥ØºÙ„Ø§Ù‚","Close note"];let i=-1;for(const o of s){const c=n.lastIndexOf(o);c>i&&(i=c)}return i===-1?"":n.slice(0,i).replace(/\n$/,"")}async function bs(t,{onAfterChange:n}={}){const i=kt()[t];if(!i)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const r=i.id||i.reservationId;if(!r)return W(a("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;try{const o=Va(i.notes||""),c=await _a(r,{status:"confirmed",confirmed:!0,notes:o});return de(),n?.({type:"reopened",reservation:c}),W(a("reservations.toast.reopened","â†©ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚")),!0}catch(o){console.error("âŒ [reservationsActions] reopenReservation failed",o);const c=ce(o)?o.message:a("reservations.toast.reopenFailed","ØªØ¹Ø°Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return W(c,"error"),!1}}export{Pa as A,Xa as B,Ya as C,us as D,ys as E,bs as F,ms as G,fs as H,as as P,pn as a,ss as b,is as c,R as d,ps as e,At as f,es as g,ns as h,re as i,_ as j,Za as k,ts as l,Nt as m,oe as n,Ke as o,Rt as p,We as q,cs as r,$ as s,Da as t,ls as u,ds as v,os as w,rs as x,Qa as y,xa as z};
