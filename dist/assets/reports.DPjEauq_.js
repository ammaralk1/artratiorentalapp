import{r as t,a as J,t as l,f as x,b as w,d as X,e as he,c as A,p as fe,g as ee,h as ye,i as ge,j as ve,k as be,l as xe,m as ke,n as Se,o as we,q as Ee,s as Ce,u as Le,v as $e,w as De,x as Me,y as Ie,z as O}from"./calculations.DUWbZ6mk.js";import{l as Re,a as N,b as Te,n as F,g as Ae}from"./auth.DeRd8Lwk.js";import{z as Be,v as te,w as Pe}from"./reservationsService.uHRkBvfi.js";import{mapMaintenanceFromApi as ae}from"./maintenanceService.C8F2r3-g.js";import{C as Ne,D as He,E as je,F as Fe,G as qe,H as ze,I as _e}from"./controller.CTQSP90Y.js";function re(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ne(e={}){const a=String(e?.barcode??"").trim(),r=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:a,desc:r,description:r,name:e?.name??r,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function se(e={}){const a=e?.title??e?.name??"",r=e?.project_code??e?.projectCode??"",n=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:a,code:r,status:n,confirmed:s}}function Oe(){let e;try{e=Re()}catch(f){return console.warn("⚠️ [reports] Failed to access cached data",f),!1}if(!e||typeof e!="object")return!1;const{reservations:a=[],customers:r=[],equipment:n=[],technicians:s=[],projects:o=[],maintenance:i=[]}=e;if(!(a.length||r.length||n.length||s.length||o.length))return!1;t.data.reservations=Array.isArray(a)?a.map(Be):[],t.data.customers=Array.isArray(r)?r.map(re):[],t.data.equipment=Array.isArray(n)?n.map(ne):[],t.data.technicians=Array.isArray(s)?s.map(te):[],t.data.projects=Array.isArray(o)?o.map(se):[],t.data.projectsMap=new Map(t.data.projects.map(f=>[f.id,f])),t.data.maintenance=Array.isArray(i)?i.map(ae):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(f=>[String(f.id),f]));try{J()}catch{}return!0}async function oe({silent:e=!1}={}){if(!t.loading){t.loading=!0,t.errorMessage="",e||t.callbacks.onBeforeRender?.();try{const[a,r,n,s,o,i]=await Promise.all([N("/reservations/?limit=500"),N("/customers/?limit=500"),N("/equipment/?limit=500"),N("/technicians/?limit=500"),N("/projects/?limit=500"),N("/maintenance/?limit=500")]);t.data.reservations=Array.isArray(a?.data)?a.data.map(c=>Pe(c)):[],t.data.customers=Array.isArray(r?.data)?r.data.map(re):[],t.data.equipment=Array.isArray(n?.data)?n.data.map(ne):[],t.data.technicians=Array.isArray(s?.data)?s.data.map(te):[],t.data.projects=Array.isArray(o?.data)?o.data.map(se):[],t.data.projectsMap=new Map(t.data.projects.map(c=>[c.id,c])),t.data.maintenance=Array.isArray(i?.data)?i.data.map(ae):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(c=>[String(c.id),c]));try{J()}catch{}}catch(a){console.error("❌ [reports] Failed to load reports data",a),t.errorMessage=a instanceof Te?a.message:l("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),(!t.data.projectsMap||!(t.data.projectsMap instanceof Map))&&(t.data.projectsMap=new Map)}finally{t.loading=!1,e||t.callbacks.onAfterRender?.()}}}function V(e){if(t.loadedScripts.has(e))return t.loadedScripts.get(e);const a=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,r=new Promise((n,s)=>{const o=()=>{a&&(a.dataset.loaded="true"),n()},i=f=>s(f);if(a){if(a.dataset.loaded==="true"){n();return}a.addEventListener("load",o,{once:!0}),a.addEventListener("error",i,{once:!0});return}const c=document.createElement("script");c.src=e,c.async=!0,c.onload=()=>{c.dataset.loaded="true",n()},c.onerror=f=>s(f),document.head.appendChild(c)});return t.loadedScripts.set(e,r),r}function K(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(t.apexChartsReady||(t.apexChartsReady=V("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),t.apexChartsReady)}function Ue(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(t.html2PdfReady||(t.html2PdfReady=V("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),t.html2PdfReady)}function Xe(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(t.xlsxReady||(t.xlsxReady=V("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),t.xlsxReady)}function B(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function T(e,a){const r=document.getElementById(e);if(r){if(!a||a.length===0){r.innerHTML=`<div class="text-sm text-base-content/60">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}r.innerHTML=a.map(n=>{const s=Math.min(Math.max(n.percent??0,0),100),o=l("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",x(n.rawCount??n.value??0)),i=n.className?`reports-progress-fill ${n.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${n.label}</span>
            <span class="reports-progress-value">${x(n.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}function L(e,a){const r=document.querySelector(`[data-chart-loading="${e}"]`);r&&(r.style.display=a?"":"none")}async function Ge(e){const a=document.getElementById("reports-volume-chart");if(!a)return;const r=Array.isArray(e)?e:[];if(t.lastTrendData=r,L("volume",!0),!r.length){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("volume",!1);return}try{const n=await K();if(!n){a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("volume",!1);return}const s=r.map(b=>b.label),o=r.map(b=>Math.round(b.count||0)),i=r.map(b=>Number(b.revenue||0)),c=r.map(b=>Number(b.netProfit||0)),f=o.reduce((b,C)=>b+(Number.isFinite(C)?C:0),0),y=i.reduce((b,C)=>b+(Number.isFinite(C)?C:0),0),v=c.reduce((b,C)=>b+(Number.isFinite(C)?C:0),0);if(f===0&&y===0&&v===0){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const m=[{name:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:o},{name:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:i},{name:l("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:c,yAxisIndex:1}],p={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(b,C,I)=>{if(I?.dataPointIndex!=null){const P=t.lastTrendData[I.dataPointIndex];t.callbacks.onTrendDrilldown?.(P,I.dataPointIndex)}}}},theme:{mode:B()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:s,labels:{style:{colors:B()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:b=>x(b)},title:{text:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:b=>w(b)},title:{text:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(b,{seriesIndex:C})=>C===0?x(b):w(b)}}},u=B(),S=String(s.join("|")),g=t.chartsMeta.trend,E=t.charts.trend&&g.theme===u&&g.categoriesSig===S;t.charts.trend&&E?t.charts.trend.updateSeries(m,!0):t.charts.trend?(t.charts.trend.updateOptions({...p},!0,!0),t.charts.trend.updateSeries(m,!0)):(a.innerHTML="",t.charts.trend=new n(a,{...p,series:m}),t.charts.trend.render()),t.chartsMeta.trend={categoriesSig:S,theme:u},L("volume",!1)}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("volume",!1)}}async function We(e){const a=document.getElementById("reports-status-chart"),r="reports-status-breakdown";if(!a)return;const n=Array.isArray(e)?e:[];t.lastStatusData=n,L("status",!0);const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,c)=>i+c,0);if(!n.length||o===0){t.charts.status&&(t.charts.status.destroy(),t.charts.status=null),T(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("status",!1);return}try{const i=await K();if(!i){T(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("status",!1);return}const c=n.map(u=>u.label),f={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,S,g)=>{if(g?.dataPointIndex!=null){const E=t.lastStatusData[g.dataPointIndex];E?.filterKey&&t.callbacks.onStatusDrilldown?.(E,g.dataPointIndex)}}}},theme:{mode:B()},labels:c,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:l("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>x(s.reduce((u,S)=>u+S,0))}}}}},tooltip:{y:{formatter:(u,S)=>{const g=t.lastStatusData?.[S?.seriesIndex||0],E=g?`${x(g.percent)}%`:`${x(u)}%`;return`${g?x(g.rawCount??g.value??0):x(u)} / ${E}`}}}},y=B(),v=String(c.join("|")),m=t.chartsMeta.status,p=t.charts.status&&m.theme===y&&m.labelsSig===v;t.charts.status&&p?t.charts.status.updateSeries(s,!0):t.charts.status?(t.charts.status.updateOptions({...f},!0,!0),t.charts.status.updateSeries(s,!0)):(a.innerHTML="",t.charts.status=new i(a,{...f,series:s}),t.charts.status.render()),T(r,n),t.chartsMeta.status={labelsSig:v,theme:y},L("status",!1)}catch(i){console.error("⚠️ [reports] Failed to render status chart",i),T(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("status",!1)}}async function Ve(e){const a=document.getElementById("reports-payment-chart"),r="reports-payment-breakdown";if(!a)return;const n=Array.isArray(e)?e:[];t.lastPaymentData=n,L("payment",!0);const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,c)=>i+c,0);if(!n.length||o===0){t.charts.payment&&(t.charts.payment.destroy(),t.charts.payment=null),T(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("payment",!1);return}try{const i=await K();if(!i){T(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("payment",!1);return}const c=n.map(u=>u.label),f={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,S,g)=>{if(g?.dataPointIndex!=null){const E=t.lastPaymentData[g.dataPointIndex];E?.filterKey&&t.callbacks.onPaymentDrilldown?.(E,g.dataPointIndex)}}}},theme:{mode:B()},labels:c,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},tooltip:{y:{formatter:(u,S)=>{const g=t.lastPaymentData?.[S?.seriesIndex||0],E=g?`${x(g.percent)}%`:`${x(u)}%`;return`${g?x(g.rawCount??g.value??0):x(u)} / ${E}`}}}},y=B(),v=String(c.join("|")),m=t.chartsMeta.payment,p=t.charts.payment&&m.theme===y&&m.labelsSig===v;t.charts.payment&&p?t.charts.payment.updateSeries(s,!0):t.charts.payment?(t.charts.payment.updateOptions({...f},!0,!0),t.charts.payment.updateSeries(s,!0)):(a.innerHTML="",t.charts.payment=new i(a,{...f,series:s}),t.charts.payment.render()),T(r,n),t.chartsMeta.payment={labelsSig:v,theme:y},L("payment",!1)}catch(i){console.error("⚠️ [reports] Failed to render payment chart",i),T(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("payment",!1)}}function Ke(e){const a=document.getElementById("reports-kpi-total"),r=document.getElementById("reports-kpi-total-meta"),n=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),f=document.getElementById("reports-kpi-paid"),y=document.getElementById("reports-kpi-paid-meta"),v=e.total||0,m=e.revenue||0,p=e.confirmed||0,u=e.paidCount||0,S=e.average||0,g=e.companyShareTotal||0,E=e.taxTotal||0,b=e.crewTotal||0,C=e.crewCostTotal||0,I=e.netProfit||0,P=e.maintenanceExpense||0,le=v?Math.round(p/v*100):0,de=v?Math.round(u/v*100):0;if(a&&(a.textContent=x(v)),r){const $=l("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",x(e.completed||0));r.textContent=$}if(n&&(n.textContent=w(m)),s)if(v===0)s.textContent=l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.");else{const $=l("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");s.textContent=$.replace("{net}",w(I)).replace("{share}",w(g)).replace("{average}",w(S))}if(o)if(m>0){const $=[{label:l("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:w(m),hint:l("reservations.reports.kpi.revenue.details.grossHint","إجمالي قيمة الحجوزات (قبل الخصومات)","Total bookings value (before discounts)")},{label:l("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:w(g),hint:l("reservations.reports.kpi.revenue.details.shareHint","تُحسب بعد الخصم، وتُضاف للإجمالي","Applied after discount and added to total")},{label:l("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:w(E),hint:l("reservations.reports.kpi.revenue.details.taxHint","ضريبة 15% على (الإجمالي بعد الخصم + نسبة الشركة)","15% VAT on (after-discount total + company share)")},{label:l("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:w(b),hint:l("reservations.reports.kpi.revenue.details.crewGrossHint","قيمة الطاقم للعميل","Crew price billed to client")},{label:l("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:w(C),hint:l("reservations.reports.kpi.revenue.details.crewHint","تكلفة الطاقم على الشركة","Crew cost to company")}];P>0&&$.push({label:l("reservations.reports.kpi.revenue.details.maintenance","مصاريف الصيانة","Maintenance expenses"),value:`−${w(P)}`}),$.push({label:l("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:w(I)}),o.innerHTML=$.map(({label:ue,value:pe,hint:me})=>`
          <div class="reports-kpi-detail-row" title="${me||""}">
            <span class="reports-kpi-detail-label">${ue}</span>
            <span class="reports-kpi-detail-value">${pe}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(i&&(i.textContent=`${le}%`),c){const $=l("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",x(p));c.textContent=$}if(f&&(f.textContent=`${de}%`),y){const $=l("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",x(u));y.textContent=$}}function D(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ye(e,a,r){const n=document.getElementById("reports-reservations-body");if(!n)return[];if(!e||e.length===0)return n.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const s=new Map((a||[]).map(p=>[String(p.id),p]));new Map((r||[]).map(p=>[String(p.id),p]));const o={code:l("reservations.reports.results.headers.id","الحجز","Reservation"),customer:l("reservations.reports.results.headers.customer","العميل","Customer"),date:l("reservations.reports.results.headers.date","التاريخ","Date"),status:l("reservations.reports.results.headers.status","الحالة","Status"),payment:l("reservations.reports.results.headers.payment","الدفع","Payment"),total:l("reservations.reports.results.headers.total","الإجمالي","Total"),share:l("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:l("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=Ze([...e]),{page:c,pageSize:f}=t.pagination,y=Math.max(0,(c-1)*f),m=i.slice(y,y+f).map(p=>{const u=tt(p,s),S={[o.code]:u.code.text,[o.customer]:u.customer.text,[o.date]:u.date.text,[o.status]:u.status.text,[o.payment]:u.payment.text,[o.total]:u.total.text,[o.share]:u.share.text,[o.net]:u.net.text};return{formatted:u,exportRow:S}});return n.innerHTML=m.map(({formatted:p})=>`
      <tr data-drilldown="reservation" data-search="${_(p.code.text)}">
        <td data-report-column="code">${p.code.html}</td>
        <td data-report-column="customer">${p.customer.html}</td>
        <td data-report-column="date">${p.date.html}</td>
        <td data-report-column="status">${p.status.html}</td>
        <td data-report-column="payment">${p.payment.html}</td>
        <td data-report-column="total">${p.total.html}</td>
        <td data-report-column="share">${p.share.html}</td>
        <td data-report-column="net">${p.net.html}</td>
      </tr>
    `).join(""),et(i.length),Qe(),m.map(({exportRow:p})=>p)}function Qe(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(a=>{a.dataset.sortBound!=="true"&&(a.addEventListener("click",()=>{const r=a.dataset.sortKey;r&&(t.sort.key===r?t.sort.dir=t.sort.dir==="asc"?"desc":"asc":(t.sort.key=r,t.sort.dir="asc"),t.pagination.page=1,t.callbacks.onRender?.())}),a.dataset.sortBound="true")})}function Ze(e){const{key:a,dir:r}=t.sort||{key:"date",dir:"desc"},n=r==="asc"?1:-1;return e.sort((s,o)=>n*Je(s,o,a))}function Je(e,a,r){switch(r){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(a?.reservationId??a?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(a?.customerName??a?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(a?.start||0);case"status":{const n=X(e)?.statusValue||"",s=X(a)?.statusValue||"";return String(n).localeCompare(String(s),"ar")}case"total":{const n=A(e)?.finalTotal||0,s=A(a)?.finalTotal||0;return n-s}case"share":{const n=A(e)?.companyShareAmount||0,s=A(a)?.companyShareAmount||0;return n-s}case"net":{const n=A(e)?.netProfit||0,s=A(a)?.netProfit||0;return n-s}default:return new Date(e?.start||0)-new Date(a?.start||0)}}function et(e){const a=document.getElementById("reports-table-pagination");if(!a)return;const{page:r,pageSize:n}=t.pagination,s=Math.max(1,Math.ceil(e/n)),o=r<=1?"disabled":"",i=r>=s?"disabled":"",c=e===0?0:(r-1)*n+1,f=Math.min(r*n,e);a.innerHTML=`
    <div class="pager">
      <button type="button" ${o} data-page="prev">◀</button>
      <button type="button" ${i} data-page="next">▶</button>
    </div>
    <div class="page-info">${x(c)}–${x(f)} / ${x(e)}</div>
    <div class="pager page-size">
      <label>${l("reservations.reports.pageSize","لكل صفحة","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,a.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{t.pagination.page>1&&(t.pagination.page-=1,t.callbacks.onRender?.())}),a.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const y=Math.max(1,Math.ceil(e/t.pagination.pageSize));t.pagination.page<y&&(t.pagination.page+=1,t.callbacks.onRender?.())}),a.querySelectorAll("[data-size]")?.forEach(y=>{y.addEventListener("click",()=>{const v=Number(y.dataset.size);Number.isFinite(v)&&v>0&&(t.pagination.pageSize=v,t.pagination.page=1,t.callbacks.onRender?.())})})}function tt(e,a,r){const n=e?.reservationId||e?.id||"—",s=F(String(n)),i=a.get(String(e?.customerId))?.customerName||l("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),c=X(e),f=at(c.statusValue),y=rt(c.statusValue,f),v=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],m=nt(c.paidStatus,v),p=v.length;let u=m.html;if(p>0){const P=l("reservations.paymentHistory.countLabel","{count} دفعة","{count} payments").replace("{count}",x(p));u=`<div class="reports-payment-cell">${m.html}<small class="reports-payment-subtext">${D(P)}</small></div>`}const S=he(e?.start),g=A(e),E=w(g.finalTotal),b=g.companySharePercent>0?`${x(g.companySharePercent)}% (${w(g.companyShareAmount)})`:l("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),C=w(g.netProfit),I=D(i);return{code:{html:D(s),text:s},customer:{html:I,text:i},date:{html:D(S),text:S},status:y,payment:{html:u,text:m.text},total:{html:D(E),text:E},share:{html:D(b),text:b},net:{html:D(C),text:C}}}function at(e){switch(e){case"completed":return q(l("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return q(l("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return q(l("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return F(e||"—")}}function rt(e,a){const r=q(a);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${D(r)}</span>`,text:r}}function nt(e,a=[]){const r=fe(e),n=String(e??"").toLowerCase(),s=n==="paid"?"paid":n==="partial"?"partial":"unpaid";let o="";const i=l("reservations.create.summary.currency","ريال","SR");Array.isArray(a)&&a.length&&(o=a.map(y=>{const v=y?.recordedAt?ee(y.recordedAt):"—",m=Number.isFinite(Number(y?.amount))&&Number(y.amount)>0?`${F(Number(y.amount).toFixed(2))} ${i}`:"",p=Number.isFinite(Number(y?.percentage))&&Number(y.percentage)>0?`${F(Number(y.percentage).toFixed(2))}%`:"",u=[v];return m&&u.push(m),p&&u.push(p),u.filter(Boolean).join(" • ")}).join(`
`));const c=o?` title="${_(o)}"`:"";return{html:`<span class="reservation-chip status-${s}"${c}>${D(r)}</span>`,text:r}}function q(e){return F(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function Y(e){const a=ee(new Date).replace(/-/g,"");return`${l("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${a}.${e}`}function st(e,a,r){const n=new Blob([e],{type:r}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=a,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function G(e){if(!e||!e.length)return;const a=Object.keys(e[0]),r=[a.join(",")];e.forEach(s=>{const o=a.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);r.push(o.join(","))});const n=`\uFEFF${r.join(`\r
`)}\r
`;st(n,Y("csv"),"text/csv;charset=utf-8;")}async function ot(e){try{const a=await Xe();if(!a){G(e);return}const r=a.utils.json_to_sheet(e),n=a.utils.book_new(),s=l("reservations.reports.export.sheetName","الحجوزات","Reservations");a.utils.book_append_sheet(n,r,s),a.writeFile(n,Y("xlsx"))}catch(a){console.error("⚠️ [reports] Excel export failed, falling back to CSV",a),G(e)}}async function it(){const e=document.getElementById("reservations-report-printable");if(!e)return;const a=await Ue();if(typeof a!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const r=Y("pdf");Ne();const n=[],s=He(e);je(e,window,n),Fe(e,window,n),qe(e);try{await a().set({margin:10,filename:r,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(o){console.error("⚠️ [reports] export failed",o)}finally{ze(n),_e(e,s)}}async function ct(e,a){switch(e){case"pdf":await it();break;case"excel":await ot(a);break;case"csv":default:G(a);break}}function lt(e){const a=document.getElementById("reports-top-customers");if(a){if(!e||e.length===0){a.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}a.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${_(r.name)}">
        <td>${D(r.name)}</td>
        <td>${x(r.count)}</td>
        <td>${w(r.revenue)}</td>
      </tr>
    `).join("")}}function dt(e){const a=document.getElementById("reports-top-equipment");if(a){if(!e||e.length===0){a.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}a.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${_(r.name)}">
        <td>${D(r.name)}</td>
        <td>${x(r.count)}</td>
        <td>${w(r.revenue)}</td>
      </tr>
    `).join("")}}const h=t.filters;function ut(e){if(t.columnControlsBound)return;const a=document.getElementById("reports-column-controls");a&&(a.querySelectorAll("input[data-column-toggle]").forEach(r=>{const n=r.dataset.columnToggle;n&&(r.checked=t.columnPreferences[n]!==!1,r.addEventListener("change",()=>{t.columnPreferences[n]=r.checked,e()}))}),t.columnControlsBound=!0,e())}function ie(){Object.entries(t.columnPreferences).forEach(([e,a])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(r=>{r.classList.toggle("hidden",!a)})})}function pt(e){if(t.exportHandlersBound)return;const a=document.querySelectorAll("[data-export]");a.length&&(a.forEach(r=>{r.addEventListener("click",async()=>{const{export:n=""}=r.dataset;if(n){r.disabled=!0;try{await e(n)}catch(s){console.error("⚠️ [reports] export failed",s)}finally{r.disabled=!1}}})}),t.exportHandlersBound=!0)}function mt(e,a){t.searchDebounceTimer&&(clearTimeout(t.searchDebounceTimer),t.searchDebounceTimer=null),t.searchDebounceTimer=setTimeout(()=>{h.search=e||"",a()},220)}function ht(e,a){e&&(h.range="custom",h.start=e.startInput||null,h.end=e.endInput||null,a())}function ft(e,a){e&&(h.status=h.status===e?"all":e,a())}function yt(e,a){e&&(h.payment=h.payment===e?"all":e,a())}function gt(e,a){e&&(h.search=e,a())}function vt({onClear:e}={}){const a=document.getElementById("reservations-active-filters");if(!a)return;const r=[],n=(s,o,i)=>{r.push(`<span class="filter-chip" data-chip="${s}">${o} <button type="button" aria-label="clear" data-clear="${s}">✕</button></span>`)};if(h.range&&h.range!=="all"){let s="";switch(h.range){case"last30":s=l("reservations.reports.filters.range.last30","آخر 30 يوم","Last 30 days");break;case"thisWeek":s=l("reservations.reports.filters.range.thisWeek","هذا الأسبوع","This week");break;case"thisMonth":s=l("reservations.reports.filters.range.thisMonth","هذا الشهر","This month");break;case"thisQuarter":s=l("reservations.reports.filters.range.thisQuarter","هذا الربع","This quarter");break;case"thisYear":s=l("reservations.reports.filters.range.thisYear","هذا العام","This year");break;case"custom":s=`${l("reservations.reports.filters.range.custom","مخصص","Custom")} (${h.start||"—"} → ${h.end||"—"})`;break;default:s=h.range}n("range",s)}if(h.status&&h.status!=="all"){const s=l(`reservations.reports.filters.status.${h.status}`,h.status,h.status);n("status",s)}if(h.payment&&h.payment!=="all"){const s=l(`reservations.reports.filters.payment.${h.payment}`,h.payment,h.payment);n("payment",s)}if(h.share&&h.share!=="all"){const s=l(`reservations.reports.filters.share.${h.share}`,h.share,h.share);n("share",s)}h.search&&h.search.trim().length&&n("search",`🔍 ${h.search.trim()}`),a.innerHTML=r.join(""),a.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.clear;o&&(o==="range"?(h.range="all",h.start=null,h.end=null):o in h&&(o==="search"?h.search="":h[o]="all"),e?.(o))})})}const d=t.filters;function Q(){O(),k(),setTimeout(()=>{O(),k(),z()},0),setTimeout(()=>{O(),k(),z()},60),z()}function j(){d.range==="custom"&&k()}function z(e,a){if(!window.flatpickr)return;e&&(t.startDateInputRef=e),a&&(t.endDateInputRef=a);const r=t.startDateInputRef,n=t.endDateInputRef;if(!r&&!n)return;const s=bt(),o=i=>{const c={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(c.locale=s),c};if(t.startDatePicker&&(t.startDatePicker.destroy(),t.startDatePicker=null),t.endDatePicker&&(t.endDatePicker.destroy(),t.endDatePicker=null),r&&(t.startDatePicker=window.flatpickr(r,o({onChange(i,c){d.start=c||null,t.endDatePicker&&(i?.length?t.endDatePicker.set("minDate",i[0]):t.endDatePicker.set("minDate",null)),j()},onValueUpdate(i,c){d.start=c||null,j()}}))),n&&(t.endDatePicker=window.flatpickr(n,o({onChange(i,c){d.end=c||null,t.startDatePicker&&(i?.length?t.startDatePicker.set("maxDate",i[0]):t.startDatePicker.set("maxDate",null)),j()},onValueUpdate(i,c){d.end=c||null,j()}}))),t.startDatePicker&&r){t.startDatePicker.setDate(r.value,!1);const i=t.endDatePicker?.selectedDates?.[0]||t.endDateInputRef?.value;i&&t.startDatePicker.set("maxDate",i)}if(t.endDatePicker&&n){t.endDatePicker.setDate(n.value,!1);const i=t.startDatePicker?.selectedDates?.[0]||t.startDateInputRef?.value;i&&t.endDatePicker.set("minDate",i)}}function bt(){return(Ae()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function W(e,a){e&&(e.classList.toggle("active",!!a),e.classList.toggle("hidden",!a))}function R(){const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),o=document.getElementById("reports-start"),i=document.getElementById("reports-end"),c=document.getElementById("reports-custom-range");e&&e.value!==d.range&&(e.value=d.range),a&&a.value!==d.status&&(a.value=d.status),r&&r.value!==d.payment&&(r.value=d.payment),n&&n.value!==d.share&&(n.value=d.share),s&&s.value!==d.search&&(s.value=d.search||""),o&&o.value!==(d.start||"")&&(o.value=d.start||""),i&&i.value!==(d.end||"")&&(i.value=d.end||""),W(c,d.range==="custom")}function xt(){try{const e=new URLSearchParams(window.location.search),a=n=>e.get(n),r=n=>n==null||n===""?null:n;d.range=a("range")||d.range,d.status=a("status")||d.status,d.payment=a("payment")||d.payment,d.share=a("share")||d.share,d.search=a("search")||"",d.start=r(a("start")),d.end=r(a("end")),d.range!=="custom"&&(d.start=null,d.end=null)}catch{}}let U=null;function M(){U&&clearTimeout(U),U=setTimeout(()=>{try{const e=new URLSearchParams,a=(s,o,i)=>{o!=null&&o!==""&&o!==i&&e.set(s,o)};a("range",d.range,"all"),a("status",d.status,"all"),a("payment",d.payment,"all"),a("share",d.share,"all"),a("search",d.search,""),d.range==="custom"&&(a("start",d.start,null),a("end",d.end,null));const r=e.toString(),n=r?`${location.pathname}?${r}`:location.pathname;window.history.replaceState({},"",n)}catch{}},120)}function ce({active:e,icon:a,title:r,subtitle:n}){const s=document.getElementById("reports-empty-state");if(!s)return;const o=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),c=s.querySelector("p");t.emptyDefaults.icon===null&&o&&(t.emptyDefaults.icon=o.textContent),t.emptyDefaults.title===null&&i&&(t.emptyDefaults.title=i.textContent),t.emptyDefaults.subtitle===null&&c&&(t.emptyDefaults.subtitle=c.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!o||!i||!c)&&(e?(o.textContent=a!==void 0?a:t.emptyDefaults.icon??o.textContent,i.textContent=r!==void 0?r:t.emptyDefaults.title??i.textContent,c.textContent=n!==void 0?n:t.emptyDefaults.subtitle??c.textContent):(o.textContent=t.emptyDefaults.icon??o.textContent,i.textContent=t.emptyDefaults.title??i.textContent,c.textContent=t.emptyDefaults.subtitle??c.textContent))}function kt(e){ce({active:!!e})}function Z(e){const a=document.getElementById("reports-kpi-skeleton"),r=document.getElementById("reservations-reports-kpis"),n=document.getElementById("reports-table-skeleton"),s=document.getElementById("reports-reservations-table"),o=document.getElementById("reservations-revenue-skeleton"),i=document.getElementById("reservations-revenue-breakdown");a&&r&&(a.style.display=e?"":"none",r.style.opacity=e?"0.4":"1"),n&&s&&(n.style.display=e?"":"none",s.style.opacity=e?"0.4":"1"),o&&i&&(o.style.display=e?"":"none",i.style.opacity=e?"0.4":"1")}function St(){if(t.drilldownBound)return;const e=document.getElementById("reports-top-customers"),a=document.getElementById("reports-top-equipment"),r=document.getElementById("reports-reservations-body"),n=s=>{const o=s.target?.closest("[data-drilldown]");if(!o)return;const i=o.dataset.search||"";gt(i,()=>{R(),k()})};e?.addEventListener("click",n),a?.addEventListener("click",n),r?.addEventListener("click",n),t.drilldownBound=!0}function H(){oe({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function k(){if(R(),M(),vt({onClear:()=>{R(),M(),k()}}),t.loading){Z(!0);return}if(t.errorMessage){ce({active:!0,icon:"⚠️",title:t.errorMessage,subtitle:l("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}Z(!1);const{reservations:e,customers:a,equipment:r,technicians:n,maintenance:s}=t.data,o=ye(e,d,a,r,n),i=ge(o),c=ve(s,d),f=be(i,c.total),y=xe(o),v=ke(o),m=Se(o),p=we(o,a),u=Ee(o,r);Ke(f),Ge(y),We(v),Ve(m),lt(p),dt(u);const S=Ye(o,a,n);ie(),kt(o.length===0),t.lastSnapshot.filtered=o,t.lastSnapshot.metrics=f,t.lastSnapshot.trend=y,t.lastSnapshot.statusBreakdown=v,t.lastSnapshot.paymentBreakdown=m,t.lastSnapshot.tableRows=S,t.lastSnapshot.maintenance=c}function Dt(){if(t.initialized)return;t.initialized=!0;const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),c=document.getElementById("reports-print"),f=document.getElementById("reports-custom-range"),y=document.getElementById("reports-search");if(!e)return;xt(),R(),Oe()&&k(),e.addEventListener("change",()=>{d.range=e.value,W(f,d.range==="custom"),d.range!=="custom"&&(d.start=null,d.end=null),M(),k()}),a?.addEventListener("change",()=>{d.status=a.value,M(),k()}),r?.addEventListener("change",()=>{d.payment=r.value,M(),k()}),n?.addEventListener("change",()=>{d.share=n.value,M(),k()}),y?.addEventListener("input",()=>{const m=y.value||"";mt(m,()=>{R(),M(),k()})}),s?.addEventListener("change",()=>{d.start=s.value||null,M(),j()}),o?.addEventListener("change",()=>{d.end=o.value||null,M(),j()}),i?.addEventListener("click",()=>{d.range==="custom"&&(d.start=s?.value||null,d.end=o?.value||null),M(),k()}),c?.addEventListener("click",()=>{try{window.print()}catch{}}),z(s,o),W(f,d.range==="custom"),t.languageListenerAttached||(document.addEventListener("language:changed",Q),document.addEventListener("language:translationsReady",Q),t.languageListenerAttached=!0),t.dataListenersAttached||(document.addEventListener("reservations:changed",H),document.addEventListener("customers:changed",H),document.addEventListener("equipment:changed",H),document.addEventListener("projects:changed",H),document.addEventListener("technicians:updated",H),window.addEventListener("maintenance:updated",H),t.dataListenersAttached=!0),ut(ie),pt(async m=>{const p=t.lastSnapshot.tableRows||[];if(!p.length){console.warn("[reports] No reservation data to export");return}await ct(m,p)}),St(),t.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>k(),0)}),t.themeListenerAttached=!0),Ce(k),Le(()=>{k()}),$e(()=>{k()}),De(m=>{ht(m,()=>{R(),k()})}),Me(m=>{ft(m?.filterKey,()=>{R(),k()})}),Ie(m=>{yt(m?.filterKey,()=>{R(),k()})}),oe().catch(m=>{console.error("❌ [reports] Failed to initialise reports data",m)})}export{Dt as initReports,k as renderReports};
