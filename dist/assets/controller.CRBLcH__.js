import{d as fe,n as A,t as c,j as x,z as Or,v as at,b as zr,h as Vr,B as is,w as Kr,x as Ur,u as Qr}from"./auth.BFR8Y3ym.js";import{g as ot,r as Lt,f as aa,a as Gr,i as os,b as Ta}from"./details.C1JJR7_F.js";import{l as cs,o as Na,n as ze,p as sa,D as gt,q as Et,s as Xt,e as ra,c as ia,d as oa,t as ls,v as Wr,w as ds,x as Jr,i as us,a as Bt,y as vt,z as jt,b as ca,f as Xr,A as Dt,g as Sn,r as ms,B as Ln,C as Bn,E as Yr,F as Zr,G as ei,u as ti,H as ni,k as ai}from"./reservationsService.BV-Ogqe7.js";import{h as la,i as ps,j as si,k as Ye,n as ee,l as Gt,o as fs,p as da,q as st,u as wn,v as on,w as ri,x as ys,s as Ct,y as bs,z as St,A as hs,B as ii,b as ua,C as ma,D as oi,E as ci,F as gs,G as li,H as di,I as La,J as Ba,K as vs,L as Ss}from"./state.uepyuVVl.js";import{s as pa,E as ws,a as ui,c as mi,b as pi,r as fi}from"./equipment.Dy1tRg0o.js";import{c as Es,g as yi}from"./constants.DKjS7WK1.js";import{q as bi}from"./quotePdf.C2lQPEPC.js";import{s as qs,a as Is,e as As,p as hi}from"./canvasColorUtils.CviLtv6S.js";import{d as gi,c as vi}from"./reservationsActions.BwZYj5H1.js";import{ensureProjectsLoaded as Si}from"./projectsService.Cwss6WRR.js";import{s as wi}from"./uiBridge.Dv6JMAlF.js";const Ei="__DEBUG_CREW__";function qi(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Ei);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function Da(e,t){if(qi())try{console.log(`🪵 [crew-debug:create] ${e}`,t)}catch{}}const ks="projects:create:draft",Ps="projects.html#projects-section";let Dn=null,xs=[],Fn=new Map,Rn=new Map,cn=new Map,Cn=!1,en=null,Fa=!1,$s=[];function Ii(e){if(!e)return null;let t=$s.find(a=>a.id===e)||null;if(t)return t;const n=ma(e);return n?(t={id:e,name:ci(n)||e,price:oi(n),items:ua(n),raw:n},t):null}function ln(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function dn(e){return A(String(e||"")).trim().toLowerCase()}function Ai(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=A(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function js(e){const t=A(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Cs(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function _s(e){if(!e)return null;const t=A(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Ts(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=A(String(t))}}function wt(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","⚠️ هذه المعدة قيد الصيانة ولا يمكن إضافتها حالياً");case"reserved":return c("reservations.toast.equipmentReserved","⚠️ هذه المعدة محجوزة حالياً ولا يمكن إضافتها");case"retired":return c("reservations.toast.equipmentRetired","⚠️ هذه المعدة خارج الخدمة حالياً");default:return c("reservations.toast.equipmentUnavailable","⚠️ هذه المعدة غير متاحة حالياً")}}function fa(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function qt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function Oe(){const{input:e,hidden:t}=qt();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function bt(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const r=document.querySelector(`label[for="${e.id}"]`);r&&n.add(r)}const s=r=>{t()&&x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error")};n.forEach(r=>{!r||r.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{r.addEventListener(i,s,{capture:!0})}),r.dataset.linkedGuardAttached="true")})}function Ns(e,t,{allowPartial:n=!1}={}){const a=ze(t);if(!a)return null;const s=e.get(a);if(s)return s;if(!n)return null;const r=[];return e.forEach((i,o)=>{o.includes(a)&&r.push(i)}),r.length===1?r[0]:null}function Mn(e,t={}){return Ns(Fn,e,t)}function Hn(e,t={}){return Ns(Rn,e,t)}function Ve(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Ls(e){xs=Array.isArray(e)?[...e]:[]}function ya(){return xs}function ba(e){return e&&ya().find(t=>String(t.id)===String(e))||null}function Ra(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","مشروع بدون اسم")}function _t(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??gt,a=A(String(n).replace("%","").trim()),s=parseFloat(a);return Number.isFinite(s)?s:gt}function Qe(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??gt,a=A(String(n).replace("%","").trim()),s=parseFloat(a);(!Number.isFinite(s)||s<=0)&&(s=gt),t.dataset.companyShare=String(s),t.checked=!0}function On(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(Cn){ce();return}Cn=!0;const a=()=>{Cn=!1,ce()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(gt)),t.disabled){n.checked=!1,x(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة")),a();return}t.checked||(t.checked=!0),Qe()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Qe():n.checked&&(n.checked=!1));a()}function ki(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function Ma(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const s=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${s}`}return""}function Ha(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function tt({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:s}=fa();if(!n||!a||!s)return;const r=la()||[],i=c("reservations.create.placeholders.client","اختر عميلًا (اختياري)"),o=c("customers.fallback.unnamed","عميل بدون اسم");n.setAttribute("placeholder",i);const d=new Set;Fn=new Map;const u=r.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:Ha(m)||o})).filter(m=>{if(!m.label)return!1;const p=ze(m.label);return!p||d.has(p)?!1:(d.add(p),Fn.set(p,m),!0)}).sort((m,p)=>m.label.localeCompare(p.label,void 0,{sensitivity:"base"}));s.innerHTML=u.map(m=>`<option value="${ln(m.label)}"></option>`).join("");const l=t?"":n.value,y=e?String(e):a.value?String(a.value):"",f=y?r.find(m=>String(m.id)===y):null;if(f){const m=Ha(f)||o;a.value=String(f.id),n.value=m,n.dataset.selectedId=String(f.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":l}function Tt({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:s,list:r}=qt();if(!a||!s||!r)return;const i=Array.isArray(t)?t:ya()||[],o=c("reservations.create.placeholders.project","اختر مشروعاً (اختياري)");a.setAttribute("placeholder",o);const d=[...i].filter(h=>h&&h.id!=null).sort((h,w)=>String(w.createdAt||w.start||"").localeCompare(String(h.createdAt||h.start||""))),u=n?"":a.value,l=c("projects.fallback.untitled","مشروع بدون اسم"),y=new Set;Rn=new Map;const f=d.map(h=>{const w=Ra(h)||l;return{id:String(h.id),label:w}}).filter(h=>{if(!h.label)return!1;const w=ze(h.label);return!w||y.has(w)?!1:(y.add(w),Rn.set(w,h),!0)});r.innerHTML=f.map(h=>`<option value="${ln(h.label)}"></option>`).join("");const m=e?String(e):s.value?String(s.value):"",p=m?d.find(h=>String(h.id)===m):null;if(p){const h=Ra(p)||l;s.value=String(p.id),a.value=h,a.dataset.selectedId=String(p.id)}else s.value="",a.dataset.selectedId="",a.value=n?"":u}function un(e,t,n){const{date:a,time:s}=bs(n),r=document.getElementById(e),i=document.getElementById(t);if(r){if(a)if(r._flatpickr){const o=r._flatpickr.config?.dateFormat||"Y-m-d";r._flatpickr.setDate(a,!1,o)}else r.value=a;else r._flatpickr?r._flatpickr.clear():r.value="";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(s)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(s,!1,o)}else i.value=s;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function Bs(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||Tt({selectedValue:a});const r=(la()||[]).find(l=>String(l.id)===String(e.clientId)),i=r?.id!=null?String(r.id):"";tt(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=Ma(e,"start"),d=Ma(e,"end");o&&un("res-start","res-start-time",o),d&&un("res-end","res-end-time",d);const u=document.getElementById("res-notes");u&&e.description&&(t||!u.value)&&(u.value=e.description),ce(),ct()}function Ds({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:fe(),s=Array.isArray(a)?a:[];Ls(s);const r=t!=null?String(t):n.value?String(n.value):"";Tt({selectedValue:r,projectsList:s}),ct(),ce()}function ct(){const{input:e,hidden:t}=qt(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),s=document.getElementById("res-payment-status"),r=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),u=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),y=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(bt(n,Oe),a&&bt(a,Oe)),s&&bt(s,Oe),r&&bt(r,Oe),i&&bt(i,Oe),o&&bt(o,Oe),d&&bt(d,Oe),y)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),s&&(s.value="unpaid",Ve(s,"unpaid"),s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=u);else{if(n){const f=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",f&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}On("tax"),ce()}function ha(){const{input:e,hidden:t}=qt();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Hn(s,{allowPartial:a}):null;if(r){t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id);const i=ba(r.id);i?Bs(i,{skipProjectSelectUpdate:!0}):(ct(),ce())}else t.value="",e.dataset.selectedId="",ct(),ce()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Hn(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function ga(){const{input:e,hidden:t}=fa();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Mn(s,{allowPartial:a}):null;r?(t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id)):(t.value="",e.dataset.selectedId=""),ce()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Mn(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Pi(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){Vt({clearValue:!0});return}let n=null;try{const u=decodeURIComponent(t);n=JSON.parse(u)}catch(u){console.warn("⚠️ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,s),Vt({clearValue:!1}),!n)return;n.fromProjectForm&&(en={draftStorageKey:n.draftStorageKey||ks,returnUrl:n.returnUrl||Ps});const r=document.getElementById("res-project");if(n.projectId){r&&(Tt({selectedValue:String(n.projectId)}),ct());const u=ba(n.projectId);u?Bs(u,{forceNotes:!!n.forceNotes}):ce(),Vt()}else{r&&Tt({selectedValue:""});const u=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","سيتم الربط بعد حفظ المشروع الحالي");Oi(c("reservations.create.project.pendingTooltip","سيتم تفعيل اختيار المشروع بعد حفظ المشروع الحالي"),u)}n.start&&un("res-start","res-start-time",n.start),n.end&&un("res-end","res-end-time",n.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(n.customerId){const l=(la()||[]).find(y=>String(y.id)===String(n.customerId));l?.id!=null&&(tt({selectedValue:String(l.id)}),o&&(o.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else n.customerName&&i?(tt({selectedValue:""}),i.value=n.customerName,i.dataset.selectedId="",o&&(o.value="")):tt({selectedValue:""});const d=document.getElementById("res-notes");d&&n.description&&!d.value&&(d.value=n.description),ce()}function It(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Gt(e,n),end:Gt(t,a)}}function Fs(e){const t=dn(e);if(t){const o=cn.get(t);if(o)return o}const{description:n,barcode:a}=js(e);if(a){const o=aa(a);if(o)return o}const s=ze(n||e);if(!s)return null;let r=fs();if(!r?.length){const o=fe();r=Array.isArray(o?.equipment)?o.equipment:[],r.length&&gs(r)}const i=r.find(o=>ze(o?.desc||o?.description||"")===s);return i||r.find(o=>ze(o?.desc||o?.description||"").includes(s))||null}function Rs(e,t="equipment-description-options"){const n=dn(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(d=>dn(d.value)===n)||cn.has(n))return!0;const{description:s}=js(e);if(!s)return!1;const r=ze(s);return r?(fs()||[]).some(o=>ze(o?.desc||o?.description||"")===r):!1}const xi={available:0,reserved:1,maintenance:2,retired:3};function $i(e){return xi[e]??5}function Oa(e){switch(e){case"available":return c("reservations.equipment.status.available","متاح");case"reserved":return c("reservations.equipment.status.reserved","محجوز");case"maintenance":return c("reservations.equipment.status.maintenance","صيانة");case"retired":return c("reservations.equipment.status.retired","خارج الخدمة");default:return c("reservations.equipment.status.unknown","الحالة غير معروفة")}}function ji(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(s=>s!=="available")||e.bestStatus;if(n==="available")return`${t} — ${Oa(n)}`;const a=c("reservations.equipment.status.unavailable","غير متاح");return`${t} — ${a} (${Oa(n)})`}function lt(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=pa(),a=fe(),s=Array.isArray(n)&&n.length?n:a?.equipment||[],r=Array.isArray(s)?s:[];gs(r);const i=new Map;r.forEach(u=>{const l=Ai(u),y=dn(l);if(!y||!l)return;const f=ot(u),m=$i(f),p=i.get(y);if(!p){i.set(y,{normalized:y,value:l,bestItem:u,bestStatus:f,bestPriority:m,statuses:new Set([f])});return}p.statuses.add(f),m<p.bestPriority&&(p.bestItem=u,p.bestStatus=f,p.bestPriority=m,p.value=l)}),cn=new Map;const d=Array.from(i.values()).sort((u,l)=>u.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(u=>{cn.set(u.normalized,u.bestItem);const l=ji(u),y=ln(u.value);if(l===u.value)return`<option value="${y}"></option>`;const f=ln(l);return`<option value="${y}" label="${f}"></option>`}).join("");e&&(e.innerHTML=d),t&&(t.innerHTML=d)}function Ms(e,t,n={}){const{silent:a=!1}=n,s=ee(e);if(!s)return{success:!1,message:null};const{start:r,end:i}=It();if(!r||!i){const p=c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات");return a||x(p),{success:!1,message:p}}const o=Ye();if(va(o).has(s)){const p=c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز");return a||x(p),{success:!1,message:p}}const u=da(s,r,i);if(u.length){const p=u.map(w=>w.name).join(", "),h=c("reservations.toast.equipmentBlockedByPackage",`⚠️ لا يمكن إضافة هذه المعدة لأنها جزء من حزمة محجوزة: ${p}`);return a||x(h),{success:!1,message:h}}if(st(s,r,i)){const p=c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية");return a||x(p),{success:!1,message:p}}const l=aa(s);if(!l){const p=c("reservations.toast.barcodeNotFound","❌ الباركود غير موجود");return a||x(p),{success:!1,message:p}}const y=ot(l);if(y==="maintenance"||y==="retired"){const p=wt(y);return a||x(p),{success:!1,message:p}}const f=Et(l);if(!f){const p=c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف");return a||x(p),{success:!1,message:p}}wn({id:f,equipmentId:f,barcode:s,desc:l.desc,qty:1,price:l.price,image:Lt(l)}),t&&(t.value=""),rt(),ce();const m=c("reservations.toast.equipmentAdded","✅ تم إضافة المعدة بنجاح");return a||x(m),{success:!0,message:m,barcode:s}}function zn(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Fs(t);if(!n){x(c("reservations.toast.equipmentNameNotFound","❌ لم يتم العثور على معدة بالاسم المدخل"));return}const a=Gr(n.barcode),s=ot(a||n);if(s==="maintenance"||s==="retired"){x(wt(s));return}const r=ee(n.barcode);if(!r){x(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const i=Et(n);if(!i){x(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const o={id:i,equipmentId:i,barcode:r,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,image:Lt(n)},{start:d,end:u}=It();if(!d||!u){x(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const l=Ye();if(va(l).has(r)){x(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const f=da(r,d,u);if(f.length){const m=f.map(p=>p.name).join(", ");x(c("reservations.toast.equipmentBlockedByPackage",`⚠️ لا يمكن إضافة هذه المعدة لأنها جزء من حزمة محجوزة: ${m}`));return}if(st(r,d,u)){x(c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية"));return}wn(o),rt(),ce(),x(c("reservations.toast.equipmentAdded","✅ تم إضافة المعدة بنجاح")),e.value=""}function Ci(){lt();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),zn(e))});const t=()=>{Rs(e.value,"equipment-description-options")&&zn(e)};e.addEventListener("focus",()=>{if(lt(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function za(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function va(e=Ye()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=ee(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(s=>{const r=ee(s?.normalizedBarcode??s?.barcode);r&&t.add(r)})}),t}function _i(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=It();if(!t||!n){x(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}ui({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):x(c("reservations.toast.equipmentTabUnavailable","⚠️ تعذر فتح تبويب المعدات حالياً"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(ws.change,t=>{za(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),za(e,pi()))}function Ti(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],s=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=a.length?a:t.barcode?[t.barcode]:[];if(!r.length)return;let i=0,o=null;const d=[],u=new Set;r.forEach(y=>{const f=ee(y);f&&!u.has(f)&&(u.add(f),d.push(f))});const l=Math.min(s,d.length);for(let y=0;y<l;y+=1){const f=d[y],m=Ms(f,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const f=c("reservations.toast.equipmentAddedBulk","✅ تم إضافة {count} معدة إلى الحجز").replace("{count}",A(String(i)));x(f)}else o&&x(o)}function Hs(){_i(),!(Fa||typeof document>"u")&&(document.addEventListener(ws.requestAdd,Ti),Fa=!0)}function Yt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),s=document.getElementById("reservation-package-hint"),r=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:s,packageAddButton:r}}function Vn(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:s}=Yt();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const r=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=t==="package";r&&(r.disabled=o),i&&(i.disabled=o),s&&(s.disabled=t!=="package"||s.options.length===0),li(t),t==="package"&&En()}function En(){const{packageSelect:e,packageHint:t}=Yt();if(!e)return;const n=ps();$s=n,si(n.map(o=>o.raw??o));const a=c("reservations.create.summary.currency","SR"),s=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","اختر الحزمة")}</option>`,r=n.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,u=A(d.toFixed(2)),l=`${o.name} — ${u} ${a}`;return`<option value="${o.id}">${l}</option>`}).join("");e.innerHTML=`${s}${r}`,e.selectedIndex=0;const i=n.length>0;e.disabled=!i,t&&(i?(t.textContent=c("reservations.create.packages.hint","سيتم إضافة الحزمة مباشرة بمجرد اختيارها."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","لا توجد حزم معرفة حالياً. يمكنك إضافتها لاحقاً من لوحة التحكم."),t.dataset.state="empty")),Vs()}function Ni(e,t){const n=e?.name||c("reservations.create.packages.genericName","الحزمة"),a=c("reservations.toast.packageItemsConflict",`⚠️ لا يمكن إضافة ${n} لأن العناصر التالية غير متاحة:`),s=t.map(({item:r,blockingPackages:i})=>{const o=r?.desc||A(String(r?.barcode??r?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","عنصر بدون اسم");if(Array.isArray(i)&&i.length){const d=i.map(u=>u.name).join(", ");return`• ${o} (${c("reservations.create.packages.blockedByPackage","محجوز ضمن الحزم")}: ${d})`}return`• ${o} (${c("reservations.create.packages.blockedDirect","محجوز في الفترة المختارة")})`});return[a,...s].join(`
`)}function Os(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:s=null}={}){const r=St(e);if(!r)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")};const i=Ii(r);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","⚠️ تعذر العثور على بيانات الحزمة المحددة")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات")};if(t.some(m=>m?.type==="package"&&St(m.packageId)===r))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","⚠️ هذه الحزمة مضافة بالفعل إلى الحجز")};if(ii(r,n,a,s)){const m=i.name||r;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`⚠️ الحزمة ${m} محجوزة بالفعل في الفترة المختارة`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:ua(i.raw??{}),d=va(t),u=[],l=new Set;if(o.forEach(m=>{const p=ee(m?.normalizedBarcode??m?.barcode);if(p){if(l.has(p)){u.push({item:m,type:"internal"});return}l.add(p),d.has(p)&&u.push({item:m,type:"external"})}}),u.length){const m=u.map(({item:h})=>h?.desc||h?.description||h?.name||h?.barcode||h?.normalizedBarcode||c("equipment.packages.items.unknown","معدة بدون اسم")).map(h=>A(String(h))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(h=>h.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","⚠️ لا يمكن إضافة الحزمة لأن العناصر التالية موجودة مسبقاً في الحجز: {items}").replace("{items}",m):c("reservations.toast.packageDuplicateEquipmentInternal","⚠️ بيانات الحزمة تحتوي على عناصر مكررة: {items}").replace("{items}",m),duplicates:u}}const y=[];return o.forEach(m=>{const p=ee(m?.normalizedBarcode??m?.barcode);if(p&&st(p,n,a,s)){const h=da(p,n,a,s);y.push({item:m,blockingPackages:h})}}),y.length?{success:!1,reason:"item_conflict",message:Ni(i,y),conflicts:y}:{success:!0,package:{id:`package::${r}`,packageId:r,type:"package",desc:i.name||`Package ${r}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,barcode:i.code||i.raw?.package_code||`pkg-${r}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:ee(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function zs(e,{silent:t=!1}={}){const n=St(e);if(!n)return t||x(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),{success:!1,reason:"invalid"};const{start:a,end:s}=It(),r=Ye(),i=Os(n,{existingItems:r,start:a,end:s});if(!i.success){if(!t){const d={invalid:c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً"),not_found:c("reservations.toast.packageNotFound","⚠️ تعذر العثور على بيانات الحزمة المحددة"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"),duplicate:c("reservations.toast.packageDuplicate","⚠️ هذه الحزمة مضافة بالفعل إلى الحجز")}[i.reason]||c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً");x(i.message||d)}return i}return wn(i.package),rt(),ce(),t||x(c("reservations.toast.packageAdded","✅ تم إضافة الحزمة بنجاح")),{success:!0,package:i.package}}function Vs(){const{packageSelect:e}=Yt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;zs(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Li(){const{packageAddButton:e,packageSelect:t}=Yt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){x(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً"));return}zs(n)}),e.dataset.listenerAttached="true")}function Ks(){const{modeRadios:e}=Yt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",s=>{s.target.checked&&Vn(s.target.value)}),a.dataset.listenerAttached="true")}),Li(),Vs();const t=on(),n=e.find(a=>a.value===t);n&&(n.checked=!0),Vn(t)}function rt(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=Ye(),a=c("reservations.create.equipment.noneAdded","لا توجد معدات مضافة"),s=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","صورة"),i=c("reservations.equipment.actions.increase","زيادة الكمية"),o=c("reservations.equipment.actions.decrease","تقليل الكمية"),d=c("reservations.equipment.actions.remove","إزالة البند");if(n.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${a}</td></tr>`;return}const u=sa(n);t.innerHTML=u.map(l=>{const y=l.items[0]||{},f=Lt(y)||l.image,m=f?`<img src="${f}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',p=A(String(l.count)),h=Number.isFinite(Number(l.unitPrice))?Number(l.unitPrice):0,w=Number.isFinite(Number(l.totalPrice))?Number(l.totalPrice):h*l.count,j=`${A(h.toFixed(2))} ${s}`,v=`${A(w.toFixed(2))} ${s}`,_=l.items.some(k=>k?.type==="package"),P=l.barcodes.map(k=>A(String(k||""))).filter(Boolean),H=P.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
            <ul class="reservation-barcode-list">
              ${P.map(k=>`<li>${k}</li>`).join("")}
            </ul>
          </details>`:"";let E="";if(_){const k=new Map;if(l.items.forEach(D=>{Array.isArray(D?.packageItems)&&D.packageItems.forEach(L=>{if(!L)return;const J=ee(L.barcode||L.desc||Math.random()),$=k.get(J);if($){$.qty+=Number.isFinite(Number(L.qty))?Number(L.qty):1;return}k.set(J,{desc:L.desc||L.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:Number.isFinite(Number(L.qty))?Number(L.qty):1,barcode:L.barcode??L.normalizedBarcode??""})})}),k.size){const D=Array.from(k.values()).map(L=>{const J=A(String(L.qty)),$=L.desc||A(String(L.barcode||"")),B=L.barcode?` <span class="reservation-package-items__barcode">(${A(String(L.barcode))})</span>`:"";return`<li>${$}${B} × ${J}</li>`}).join("");E=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
              <ul class="reservation-package-items__list">
                ${D}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${_?`${E||""}${H||""}`:H}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${l.key}" aria-label="${o}" ${_?"disabled":""}>−</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${l.key}" aria-label="${i}" ${_?"disabled":""}>+</button>
            </div>
          </td>
          <td>${j}</td>
          <td>${v}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${l.key}" aria-label="${d}">🗑️</button>
          </td>
        </tr>
      `}).join("")}function Bi(e){const t=Ye(),a=sa(t).find(r=>r.key===e);if(!a)return;const s=a.itemIndices[a.itemIndices.length-1];s!=null&&(ri(s),rt(),ce())}function Di(e){const t=Ye(),n=t.filter(a=>Xt(a)!==e);n.length!==t.length&&(hs(n),rt(),ce())}function Fi(e){const t=Ye(),a=sa(t).find(y=>y.key===e);if(!a)return;const{start:s,end:r}=It();if(!s||!r){x(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const i=new Set(t.map(y=>ee(y.barcode))),{equipment:o=[]}=fe(),d=(o||[]).find(y=>{const f=ee(y?.barcode);return!f||i.has(f)||Xt({desc:y?.desc||y?.description||y?.name||"",price:Number(y?.price)||0})!==e||!os(y)?!1:!st(f,s,r)});if(!d){x(c("reservations.toast.noAdditionalUnits","⚠️ لا توجد وحدات إضافية متاحة حالياً"));return}const u=ee(d.barcode),l=Et(d);if(!l){x(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}wn({id:l,equipmentId:l,barcode:u,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,image:Lt(d)}),rt(),ce()}function ce(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(A(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",s=e?"percent":a,r=document.getElementById("res-tax"),i=e?!1:r?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:u,end:l}=It();i&&Qe();const y=_t(),f=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),p=Cs(f),h=_s(m);cs(),Na({selectedItems:Ye(),discount:n,discountType:s,applyTax:i,paidStatus:d,paymentProgressType:p,paymentProgressValue:h,start:u,end:l,companySharePercent:y,paymentHistory:[]});const w=Na.lastResult;w?(Ts(m,w.paymentProgressValue),o&&(o.value=w.paymentStatus,Ve(o,w.paymentStatus))):Ve(o,d)}function Ri(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=A(o.target.value),ce()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",ce),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(Oe()){n.checked=!1,x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}On("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(Oe()){a.checked=!1,x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}On("share")}),a.dataset.listenerAttached="true");const s=document.getElementById("res-payment-status");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{if(Oe()){s.value="unpaid",Ve(s,"unpaid"),x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}Ve(s),ce()}),s.dataset.listenerAttached="true");const r=document.getElementById("res-payment-progress-type");r&&!r.dataset.listenerAttached?(r.dataset.userSelected!=="true"&&(r.value="percent"),r.addEventListener("change",o=>{if(Oe()){r.value="percent",x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}r.dataset.userSelected="true",ce()}),r.dataset.listenerAttached="true"):r&&r.dataset.userSelected!=="true"&&!r.value&&(r.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(Oe()){i.value="",x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}o.target.value=A(o.target.value),ce()}),i.dataset.listenerAttached="true"),ce()}function Mi(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;let n=!1;const a=()=>{const s=e.value?.trim();if(!s){ce();return}const r=t.dataset.syncedWithStart;(!t.value?.trim()||r!=="false")&&(n=!0,t.value=s,t.dataset.syncedWithStart="true",t.dataset.syncedValue=s,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),ce()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{n||(t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false")}),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Va(){const{input:e,hidden:t}=fa(),{input:n,hidden:a}=qt(),{customers:s}=fe();let r=t?.value?String(t.value):"";if(!r&&e?.value){const K=Mn(e.value,{allowPartial:!0});K&&(r=String(K.id),t&&(t.value=r),e.value=K.label,e.dataset.selectedId=r)}const i=s.find(K=>String(K.id)===r);if(!i){x(c("reservations.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&n?.value){const K=Hn(n.value,{allowPartial:!0});K&&(d=String(K.id),a&&(a.value=d),n.value=K.label,n.dataset.selectedId=d)}const u=document.getElementById("res-start").value,l=document.getElementById("res-end").value,y=document.getElementById("res-start-time")?.value||"00:00",f=document.getElementById("res-end-time")?.value||"00:00";if(!u||!l){x(c("reservations.toast.requireDates","⚠️ يرجى تحديد تاريخ البداية والنهاية"));return}const m=`${u}T${y}`,p=`${l}T${f}`,h=new Date(m),w=new Date(p);if(Number.isNaN(h.getTime())||Number.isNaN(w.getTime())||h>=w){x(c("reservations.toast.invalidDateRange","⚠️ تأكد من أن تاريخ ووقت البداية يسبق تاريخ ووقت النهاية"));return}const j=cs();j.map(K=>K.technicianId).filter(Boolean);const v=Ye();if(v.length===0&&j.length===0){x(c("reservations.toast.noItems","⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل"));return}const _=document.getElementById("res-notes")?.value||"",P=parseFloat(A(document.getElementById("res-discount")?.value))||0,H=document.getElementById("res-discount-type")?.value||"percent",E=document.getElementById("res-payment-status"),k=E?.value||"unpaid",D=document.getElementById("res-payment-progress-type"),L=document.getElementById("res-payment-progress-value"),J=Cs(D),$=_s(L),B=d?ba(d):null,U=ki(B);if(d&&!B){x(c("reservations.toast.projectNotFound","⚠️ لم يتم العثور على المشروع المحدد. حاول تحديث الصفحة."));return}for(const K of v){const se=ot(K.barcode);if(se==="maintenance"||se==="retired"){x(wt(se));return}}for(const K of v){const se=ee(K.barcode);if(st(se,m,p)){x(c("reservations.toast.cannotCreateEquipmentConflict","⚠️ لا يمكن إتمام الحجز، إحدى المعدات محجوزة في نفس الفترة الزمنية"));return}}for(const K of j)if(K?.technicianId&&ys(K.technicianId,m,p)){x(c("reservations.toast.cannotCreateCrewConflict","⚠️ لا يمكن إتمام الحجز، أحد أعضاء الطاقم مرتبط بحجز آخر في نفس الفترة"));return}const T=document.getElementById("res-tax"),N=document.getElementById("res-company-share"),F=!!d;F?(T&&(T.checked=!1,T.disabled=!0,T.classList.add("disabled"),T.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تعديل الضريبة من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),N&&(N.checked=!1,N.disabled=!0,N.classList.add("disabled"),N.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تعديل نسبة الشركة من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),E&&(E.value="unpaid",E.disabled=!0,Ve(E,"unpaid"),E.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تغيير حالة الدفع من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),D&&(D.disabled=!0,D.classList.add("disabled")),L&&(L.value="",L.disabled=!0,L.classList.add("disabled"))):(T&&(T.disabled=!1,T.classList.remove("disabled"),T.title=""),N&&(N.disabled=!1,N.classList.remove("disabled"),N.title=""),E&&(E.disabled=!1,E.title=""),D&&(D.disabled=!1,D.classList.remove("disabled")),L&&(L.disabled=!1,L.classList.remove("disabled")));const Y=F?!1:T?.checked||!1,G=!!N?.checked;if(!F&&G!==Y){x(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"));return}let R=G?_t():null;G&&(!Number.isFinite(R)||R<=0)&&(Qe(),R=_t());const W=G&&Y&&Number.isFinite(R)&&R>0;Y&&Qe();const M=ra(v,P,H,Y,j,{start:m,end:p,companySharePercent:W?R:0}),ne=Or(),Z=ia({totalAmount:M,progressType:J,progressValue:$,history:[]});L&&Ts(L,Z.paymentProgressValue);const ae=[];Z.paymentProgressValue!=null&&Z.paymentProgressValue>0&&ae.push({type:Z.paymentProgressType||J,value:Z.paymentProgressValue,amount:Z.paidAmount,percentage:Z.paidPercent,recordedAt:new Date().toISOString()});const me=oa({manualStatus:k,paidAmount:Z.paidAmount,paidPercent:Z.paidPercent,totalAmount:M});E&&(E.value=me,Ve(E,me));const ue=typeof B?.paymentStatus=="string"?B.paymentStatus.toLowerCase():null,Ee=ue&&["paid","partial","unpaid"].includes(ue)?ue:"unpaid",xe=ls({reservationCode:ne,customerId:o,start:m,end:p,status:U?"confirmed":"pending",title:null,location:null,notes:_,projectId:d||null,totalAmount:M,discount:F?0:P,discountType:F?"percent":H,applyTax:Y,paidStatus:F?Ee:me,confirmed:U,items:v.map(K=>({...K,equipmentId:K.equipmentId??K.id})),crewAssignments:j,companySharePercent:F||!W?null:R,companyShareEnabled:F?!1:W,paidAmount:F?0:Z.paidAmount,paidPercentage:F?0:Z.paidPercent,paymentProgressType:F?null:Z.paymentProgressType,paymentProgressValue:F?null:Z.paymentProgressValue,paymentHistory:F?[]:ae});try{Da("about to submit",{crewAssignments:j,techniciansPayload:xe?.technicians,payload:xe});const K=await Wr(xe);Da("server response",{reservation:K?.id??K?.reservationId??K?.reservation_code,technicians:K?.technicians,crewAssignments:K?.crewAssignments,techniciansDetails:K?.techniciansDetails}),pa(),lt(),Ct(),zi(),x(c("reservations.toast.created","✅ تم إنشاء الحجز"));try{const se=document.getElementById("sub-tab-trigger-my-reservations-tab");se&&typeof se.click=="function"&&setTimeout(()=>se.click(),0)}catch{}typeof Dn=="function"&&Dn({type:"created",reservation:K}),Hi(K)}catch(K){console.error("❌ [reservations/createForm] Failed to create reservation",K);const se=ds(K)?K.message:c("reservations.toast.createFailed","تعذر إنشاء الحجز، حاول مرة أخرى");x(se,"error"),F&&(x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ التعديلات من شاشة المشروع."),"error"),Vt({clearValue:!1}))}}function Hi(e){if(!en)return;const{draftStorageKey:t=ks,returnUrl:n=Ps}=en,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const s=window.sessionStorage.getItem(t),r=s?JSON.parse(s)||{}:{},i=Array.isArray(r.linkedReservationIds)?r.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),r.linkedReservationIds=i,window.sessionStorage.setItem(t,JSON.stringify(r))}catch(s){console.warn("⚠️ [reservations] Unable to persist linked reservation draft state",s)}en=null,n&&(window.location.href=n)}function Vt({clearValue:e=!1}={}){const{input:t,hidden:n}=qt();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,ct())}function Oi(e,t=""){const{input:n,hidden:a}=qt();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),ct())}function zi(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),tt({selectedValue:"",resetInput:!0}),document.getElementById("res-start").value="",document.getElementById("res-start-time").value="",document.getElementById("res-end").value="",document.getElementById("res-end-time").value="",document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),Vt({clearValue:!1}),Tt({selectedValue:"",resetInput:!0});const s=document.getElementById("equipment-description");s&&(s.value="");const r=document.getElementById("res-payment-status");r&&(r.value="unpaid",Ve(r,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),Jr(),hs([]),mi("form-reset"),rt(),ct(),ce()}function Vi(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s}=n.dataset;if(a==="decrease-group"&&s){Bi(s);return}if(a==="increase-group"&&s){Fi(s);return}if(a==="remove-group"&&s){Di(s);return}}),e.dataset.listenerAttached="true")}function Ki(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(on()!=="single")return;const s=e.value;s?.trim()&&(clearTimeout(t),t=null,Ms(s,e))};e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||on()!=="single")return;const{start:r,end:i}=It();!r||!i||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function Ui(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async n=>{n.preventDefault(),await Va()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async n=>{n.preventDefault(),await Va()}),t.dataset.listenerAttached="true")}function Qc({onAfterSubmit:e}={}){Dn=typeof e=="function"?e:null;const{customers:t,projects:n}=fe();di(t||[]),tt(),ga(),Ls(n||[]),Ds({projectsList:n}),ha(),lt(),En(),Ci(),Hs(),Ks(),Mi(),Ri(),Vi(),Ki(),Ui(),Pi(),ce(),rt()}function Us(){lt(),En(),Ds(),tt(),ga(),ha(),Hs(),Ks(),rt(),ce()}if(typeof document<"u"){const e=()=>{tt(),Tt({projectsList:ya()}),ga(),ha(),ce()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{lt()}),document.addEventListener("packages:changed",()=>{En(),on()==="package"&&Vn("package")})}typeof window<"u"&&(window.getCompanySharePercent=_t);function Zt(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function Qi(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],s=Number.parseInt(a,10);return Number.isFinite(s)?s:null}function Gi(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=Qi(n);if(a!==null)return a}return null}function Ka(e,t=0){const n=Gi(e);if(n!=null)return n;const a=Zt(e.createdAt??e.created_at);if(a!=null)return a;const s=Zt(e.updatedAt??e.updated_at);if(s!=null)return s;const r=Zt(e.start);if(r!=null)return r;const i=Zt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(t)?t:0}function Wi({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:s}){const r=e.map((v,_)=>({reservation:v,index:_})),i=t.searchTerm||"",o=t.searchReservationId||"",d=t.searchCustomerName||"",u=t.searchProjectId||"",l=t.startDate||"",y=t.endDate||"",f=t.status||"",m=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,p=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,h=l?new Date(`${l}T00:00:00`):null,w=y?new Date(`${y}T23:59:59`):null,j=r.filter(({reservation:v})=>{const _=n.get(String(v.customerId)),P=s?.get?.(String(v.projectId)),H=v.start?new Date(v.start):null,E=us(v),{effectiveConfirmed:k}=Bt(v,P);if(m!=null&&String(v.customerId)!==String(m)||p!=null&&!(Array.isArray(v.technicians)?v.technicians.map(B=>String(B)):[]).includes(String(p))||f==="confirmed"&&!k||f==="pending"&&k||f==="completed"&&!E)return!1;if(f==="cancelled"){const $=String(v?.status||v?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes($))return!1}if(h&&H&&H<h||w&&H&&H>w)return!1;if(o){const $=[v.reservationId,v.id,v.reservation_id,v.reservationCode,v.reservation_code,v.code,v.reference,v.referenceNumber,v.reference_number],B=ze($.filter(T=>T!=null&&T!=="").map(String).join(" ")).replace(/\s+/g,""),U=o.replace(/\s+/g,"");if(!B.includes(U))return!1}if(d&&!ze(_?.customerName||"").includes(d))return!1;if(u){const $=[v.projectId,v.project_id,v.projectID,P?.id,P?.projectCode,P?.project_code],B=ze($.filter(T=>T!=null&&T!=="").map(String).join(" ")).replace(/\s+/g,""),U=u.replace(/\s+/g,"");if(!B.includes(U))return!1}if(!i)return!0;const D=v.items?.map?.($=>`${$.barcode} ${$.desc}`).join(" ")||"",L=(v.technicians||[]).map($=>a.get(String($))?.name).filter(Boolean).join(" ");return ze([v.reservationId,_?.customerName,v.notes,D,L,P?.title].filter(Boolean).join(" ")).includes(i)});return j.sort((v,_)=>{const P=Ka(v.reservation,v.index),H=Ka(_.reservation,_.index);return P!==H?H-P:_.index-v.index}),j}function Ji({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const s=c("reservations.create.summary.currency","SR"),r=c("reservations.list.taxIncludedShort","(شامل الضريبة)"),i=c("reservations.list.unknownCustomer","غير معروف"),o=c("reservations.list.noNotes","لا توجد ملاحظات"),d=c("reservations.list.itemsCountShort","{count} عنصر"),u=c("reservations.list.crew.separator","، "),l=c("reservations.list.status.confirmed","✅ مؤكد"),y=c("reservations.list.status.pending","⏳ غير مؤكد"),f=c("reservations.list.status.completed","📁 منتهي"),m=c("reservations.list.payment.paid","💳 مدفوع"),p=c("reservations.list.payment.unpaid","💳 غير مدفوع"),h=c("reservations.list.payment.partial","💳 مدفوع جزئياً"),w=c("reservations.list.actions.confirm","✔️ تأكيد"),j=c("reservations.list.project.unlinked","غير مرتبط بمشروع"),v=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),_={client:c("reservations.list.labels.client","👤 العميل"),project:c("reservations.list.labels.project","📁 المشروع"),start:c("reservations.list.labels.start","🗓️ بداية الحجز"),end:c("reservations.list.labels.end","🗓️ نهاية الحجز"),cost:c("reservations.list.labels.cost","💵 الإجمالي النهائي"),equipment:c("reservations.list.labels.equipment","📦 المعدات"),crew:c("reservations.list.labels.crew","😎 الفريق")};return e.map(({reservation:P,index:H})=>{const E=t.get(String(P.customerId)),k=P.projectId?a?.get?.(String(P.projectId)):null,D=us(P),L=typeof k?.paymentStatus=="string"?k.paymentStatus.toLowerCase():null,J=P.paidStatus??P.paid_status??(P.paid===!0||P.paid==="paid"?"paid":"unpaid"),$=L&&["paid","partial","unpaid"].includes(L)?L:J,B=$==="paid",U=$==="partial",{effectiveConfirmed:T,projectLinked:N}=Bt(P,k),F=T?"status-confirmed":"status-pending",Y=B?"status-paid":U?"status-partial":"status-unpaid";let G=`<span class="reservation-chip status-chip ${F}">${T?l:y}</span>`;const R=B?m:U?h:p;let W=`<span class="reservation-chip status-chip ${Y}">${R}</span>`,M=B?" tile-paid":U?" tile-partial":" tile-unpaid";D&&(M+=" tile-completed");let ne="";D&&(G=`<span class="reservation-chip status-chip status-completed">${f}</span>`,W=`<span class="reservation-chip status-chip status-completed">${R}</span>`,ne=` data-completed-label="${c("reservations.list.ribbon.completed","منتهي").replace(/"/g,"&quot;")}"`);let Z=!N&&!T?`<button class="tile-confirm" data-reservation-index="${H}" data-action="confirm">${w}</button>`:"";{const b=String(P?.status||P?.reservationStatus||"").toLowerCase();(b==="cancelled"||b==="canceled")&&(G=`<span class="reservation-chip status-chip status-cancelled">${c("reservations.list.status.cancelled","❌ ملغي")}</span>`,M=" tile-cancelled",ne="",typeof Z<"u"&&(Z=""))}const ae=Z?`<div class="tile-actions">${Z}</div>`:"",me=P.items?.length||0,ue=Array.isArray(P.crewAssignments)?P.crewAssignments:[],Ee=(P.technicians||[]).map(b=>n.get(String(b))).filter(Boolean),xe=ue.length?ue.map(b=>{const z=b.positionLabel??b.position_name??b.role??c("reservations.crew.positionFallback","منصب بدون اسم"),S=b.technicianName??n.get(String(b.technicianId??""))?.name??null;return S?`${A(z)} (${A(S)})`:A(z)}):Ee.map(b=>b.name),K=xe.length?xe.join(u):"—",se=A(String(P.reservationId??"")),_e=P.start?A(at(P.start)):"-",qe=P.end?A(at(P.end)):"-",Fe=A(String(P.cost??0)),Ie=A(String(me)),we=P.notes?A(P.notes):o,Ae=d.replace("{count}",Ie),Le=P.applyTax?`<small>${r}</small>`:"";let je=j;return P.projectId&&(je=k?.title?A(k.title):v),`
      <div class="${Z?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${M}"${ne} data-reservation-index="${H}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${se}</div>
          <div class="tile-badges">
            ${G}
            ${W}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${_.client}</span>
            <span class="tile-value">${E?.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${_.project}</span>
            <span class="tile-value">${je}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${_.start}</span>
            <span class="tile-value tile-inline">${_e}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${_.end}</span>
            <span class="tile-value tile-inline">${qe}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${_.cost}</span>
            <span class="tile-value">${Fe} ${s} ${Le}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${_.equipment}</span>
            <span class="tile-value">${Ae}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${_.crew}</span>
            <span class="tile-value">${xe.length?K:"—"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">📝 ${we}</span>
          </div>
        </div>
        ${ae}
      </div>
    `}).join("")}const Xi=""+new URL("Tajawal-400.ttf",import.meta.url).href,Yi=""+new URL("Tajawal-500.ttf",import.meta.url).href,Ua=""+new URL("Tajawal-700.ttf",import.meta.url).href,Qs="reservations.quote.sequence",Qa={reservation:"reservations.quote.togglePrefs.v1",project:"projects.quote.togglePrefs.v1"},Gs="https://help.artratio.sa/guide/quote-preview",Pe={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",commercialRegistry:"4030485240",beneficiaryName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",bankName:"مصرف الراجحي",accountNumber:"٣٥٨٠٠٠٠١٠٠٠٦٠٨٦٠٦٥٧٠٦",iban:"SA1680000358608016065706",approvalNote:"الموافقة على هذا العرض تعتبر موافقة على جميع الشروط والأحكام."},Zi=["يوم العمل هو 12 ساعة، ويتم احتساب نصف يوم إضافي بعد 20 ساعة، ثم يوم كامل بعد ذلك.","يمنع استخدام المعدات في أنشطة غير قانونية.","يتحمل المستأجر مسؤولية أي تلف أو فقدان.","يجب إعادة المعدات في حالتها الأصلية.","يتم فرض رسوم على الإلغاء إذا لم يتم الإبلاغ قبل 24 ساعة."],Re=[...Zi],eo=["يتم دفع 50% من قيمة المشروع عند الموافقة على عرض السعر، ويتم استكمال الـ 50% المتبقية قبل التسليم النهائي.","يحصل العميل على حقوق استخدام النسخة النهائية في أي مكان يراه مناسباً، بينما تحتفظ الشركة بالمواد الخام ولا تستخدمها إلا بعد موافقة العميل ما لم يُتفق على غير ذلك.","يتم الاتفاق على جدول زمني للتنفيذ، وأي تعديلات إضافية خارج النطاق المتفق عليه تخضع لرسوم إضافية.","العميل مسؤول عن توفير التصاريح اللازمة للتصوير في المواقع المحددة، وأي تأخير ناتج عن ذلك قد يؤثر على مواعيد التسليم.","تُحفَظ المواد النهائية للمشروع لمدة 12 شهراً في أرشيف الشركة، ويمكن للعميل طلب نسخ إضافية خلال تلك الفترة.","يتحمّل العميل مسؤولية توفير بيئة عمل آمنة للفريق الفني والمعدات في موقع التصوير، ويضمن اتخاذ كافة الاحتياطات اللازمة للحفاظ على سلامتهم."];function Kn(e){return e?e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0):[...Re]}function to(){const e=document.getElementById("reservation-terms");if(e&&e.value.trim().length>0){const a=Kn(e.value);if(a.length)return a}const t=document.getElementById("edit-res-terms");if(t&&t.value.trim().length>0){const a=Kn(t.value);if(a.length)return a}const n=Re.join(`
`);return e&&e.value.trim().length===0&&(e.value=n),t&&t.value.trim().length===0&&(t.value=n),[...Re]}const no=[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"بيانات العميل",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"تفاصيل الحجز",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"بيانات المشروع",defaultSelected:!0},{id:"financialSummary",labelKey:"reservations.quote.sections.financial",fallback:"الملخص المالي",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"قائمة المعدات",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"طاقم العمل",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"ملاحظات الحجز",defaultSelected:!0}],qn=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>g(A(String(t+1)))},{id:"code",labelKey:"reservations.details.table.headers.code",fallback:"الكود",render:e=>{if(e?.isPackage){const t=e?.packageCodeResolved||e?.barcode||"";return g(t||"-")}return g(e?.barcode||"-")}},{id:"description",labelKey:"reservations.details.table.headers.description",fallback:"الوصف",render:e=>{const t=String(e?.desc||e?.description||"-");return`<div class="quote-cell quote-cell--desc">${g(t)}</div>`}},{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:e=>g(A(String(e?.qty||1)))},{id:"unitPrice",labelKey:null,fallback:"لكل يوم",render:e=>g(A(Number(e?.unitPriceValue||0).toFixed(2)))},{id:"price",labelKey:null,fallback:"المجموع",render:e=>g(A(Number(e?.price||0).toFixed(2)))}],In=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>g(A(String(t+1)))},{id:"position",labelKey:"reservations.details.crew.position",fallback:"المنصب",render:e=>g(A(e?.positionLabel??e?.position_name??e?.role??c("reservations.crew.positionFallback","منصب بدون اسم")))},{id:"unitPrice",labelKey:null,fallback:"لكل يوم",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return g(`${A(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}},{id:"price",labelKey:null,fallback:"المجموع",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return g(`${A(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}}],Un={customerInfo:[{id:"customerName",labelKey:"reservations.details.labels.customer",fallback:"العميل"},{id:"customerCompany",labelKey:"reservations.details.labels.company",fallback:"الشركة"},{id:"customerPhone",labelKey:"reservations.details.labels.phone",fallback:"الهاتف"},{id:"customerEmail",labelKey:"reservations.details.labels.email",fallback:"البريد"}],reservationInfo:[{id:"reservationId",labelKey:"reservations.details.labels.reservationId",fallback:"رقم الحجز"},{id:"reservationStart",labelKey:"reservations.details.labels.start",fallback:"بداية الحجز"},{id:"reservationEnd",labelKey:"reservations.details.labels.end",fallback:"نهاية الحجز"},{id:"reservationDuration",labelKey:"reservations.details.labels.duration",fallback:"عدد الأيام"}],projectInfo:[{id:"projectTitle",labelKey:"reservations.details.labels.project",fallback:"المشروع"},{id:"projectCode",labelKey:"reservations.details.labels.code",fallback:"الرمز"}],financialSummary:[{id:"discountAmount",labelKey:"reservations.details.labels.discount",fallback:"الخصم"},{id:"taxAmount",labelKey:"reservations.details.labels.tax",fallback:"الضريبة"},{id:"finalTotal",labelKey:"reservations.details.labels.total",fallback:"الإجمالي النهائي"}],payment:[{id:"beneficiary",labelKey:"reservations.quote.labels.beneficiary",fallback:"اسم المستفيد"},{id:"bank",labelKey:"reservations.quote.labels.bank",fallback:"اسم البنك"},{id:"account",labelKey:"reservations.quote.labels.account",fallback:"رقم الحساب"},{id:"iban",labelKey:"reservations.quote.labels.iban",fallback:"رقم الآيبان"}],items:[...qn.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"إجمالي المعدات"}],crew:[...In.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"groupByPosition",labelKey:null,fallback:"تجميع حسب المنصب",default:!1},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"إجمالي الفريق"}]},Ws=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>g(A(String(t+1)))},{id:"label",labelKey:null,fallback:"البند",render:e=>g(e?.label||"-")},{id:"amount",labelKey:null,fallback:"المبلغ",render:e=>g(e?.displayAmount||"—")},{id:"note",labelKey:null,fallback:"ملاحظات",render:e=>g(e?.note||"-")}],ao=[{id:"customerInfo",labelKey:"projects.quote.sections.customer",fallback:"بيانات العميل",defaultSelected:!0},{id:"projectInfo",labelKey:"projects.quote.sections.project",fallback:"بيانات المشروع",defaultSelected:!0},{id:"projectExpenses",labelKey:"projects.quote.sections.expenses",fallback:"الخدمات الإنتاجية",defaultSelected:!0},{id:"projectCrew",labelKey:"projects.quote.sections.crew",fallback:"طاقم العمل",defaultSelected:!0},{id:"financialSummary",labelKey:"projects.quote.sections.financial",fallback:"الملخص المالي",defaultSelected:!0},{id:"projectEquipment",labelKey:"projects.quote.sections.equipment",fallback:"المعدات",defaultSelected:!0},{id:"projectNotes",labelKey:"projects.quote.sections.notes",fallback:"ملاحظات المشروع",defaultSelected:!0}],so={customerInfo:Un.customerInfo,projectInfo:[{id:"projectTitle",labelKey:"projects.details.overview.heading",fallback:"معلومات المشروع"},{id:"projectCode",labelKey:"projects.details.labels.code",fallback:"رقم المشروع"},{id:"projectType",labelKey:"projects.details.type",fallback:"نوع المشروع"},{id:"projectStart",labelKey:"projects.details.start",fallback:"بداية المشروع"},{id:"projectEnd",labelKey:"projects.details.end",fallback:"نهاية المشروع"},{id:"projectDuration",labelKey:"projects.details.duration",fallback:"مدة المشروع"},{id:"projectStatus",labelKey:"projects.details.status",fallback:"حالة المشروع"}],financialSummary:[{id:"reservationsTotal",labelKey:"projects.details.reservationsTotal",fallback:"إجمالي الحجوزات"},{id:"discountAmount",labelKey:"projects.details.summary.discount",fallback:"الخصم"},{id:"taxAmount",labelKey:"projects.details.summary.combinedTax",fallback:"الضريبة"},{id:"overallTotal",labelKey:"projects.details.summary.overallTotal",fallback:"الإجمالي الكلي"}],payment:Un.payment,projectExpenses:[...Ws.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"expensesSubtotal",labelKey:"projects.details.expensesTotal",fallback:"إجمالي الخدمات الإنتاجية"}],projectCrew:[...In.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية"},{id:"days",labelKey:null,fallback:"الأيام"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"إجمالي الفريق"}],projectEquipment:[...qn.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:null,fallback:"الأيام"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"إجمالي المعدات"}],projectNotes:[]},_n=new Map;function An(e="reservation"){if(_n.has(e))return _n.get(e);const t=e==="project"?ao:no,n=e==="project"?so:Un,a=new Set(t.map(({id:i})=>i)),s=Object.fromEntries(Object.entries(n).map(([i,o=[]])=>[i,new Set(o.map(d=>d.id))])),r={sectionDefs:t,fieldDefs:n,sectionIdSet:a,fieldIdMap:s};return _n.set(e,r),r}function kn(e="reservation"){return An(e).sectionDefs}function Js(e="reservation"){return An(e).fieldDefs}function Xs(e="reservation"){return An(e).sectionIdSet}function Ys(e="reservation"){return An(e).fieldIdMap}function Zs(e){switch(e){case"export":return c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...");case"render":default:return c("reservations.quote.status.rendering","جاري تحديث المعاينة...")}}const ro="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",io="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",oo="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",er=bi.trim(),tr=`
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 400; font-display: swap; src: url(${JSON.stringify(Xi)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 500; font-display: swap; src: url(${JSON.stringify(Yi)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 600; font-display: swap; src: url(${JSON.stringify(Ua)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 700; font-display: swap; src: url(${JSON.stringify(Ua)}) format('truetype'); }
`,nr=/^data:image\/svg\+xml/i,co=/\.svg($|[?#])/i,zt=512,Qn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/B8AAusB9YwpClgAAAAASUVORK5CYII=",ar=96,sr=25.4,Gn=210,tn=297,nn=Math.round(Gn/sr*ar),an=Math.round(tn/sr*ar);function Se(e){const t=Number(e),n=Number.isFinite(t)?t:0;try{const a=Math.abs(n%1)>1e-9;return A(n.toLocaleString("en-US",{minimumFractionDigits:a?2:0,maximumFractionDigits:2}))}catch{return Number.isInteger(n)?A(String(n)):A(n.toFixed(2))}}let mn=!1,pn=null;function rr(){mn||(pn=async function(){try{if(!I||!Q?.modal?.classList.contains("show")||(I.context||"reservation")!=="reservation")return;const n=I.reservation;if(!n)return;const a=[n.id,n.reservationId,n.reservation_id,n.reservationCode,n.reservation_code].map(l=>l==null?"":String(l)).filter(l=>l.length>0);if(!a.length)return;const s=Sn(),r=(Array.isArray(s)?s:[]).find(l=>[l?.id,l?.reservationId,l?.reservation_id,l?.reservationCode,l?.reservation_code].map(f=>f==null?"":String(f)).filter(f=>f.length>0).some(f=>a.includes(f)));if(!r)return;const i=ka(r),{totalsDisplay:o,totals:d,rentalDays:u}=vr(r,i,I.project);I.reservation=r,I.crewAssignments=i,I.totals=d,I.totalsDisplay=o,I.rentalDays=u,Pr(),dt()}catch(t){console.warn("[reservationPdf] live update failed",t)}},document.addEventListener("reservations:changed",pn),mn=!0)}function ir(){if(mn){try{document.removeEventListener("reservations:changed",pn)}catch{}pn=null,mn=!1}}const or=2,cr=/safari/i,lo=/(iphone|ipad|ipod)/i,Ga=/(iphone|ipad|ipod)/i,uo=/(crios|fxios|edgios|opios)/i,fn="[reservations/pdf]";let Q=null,I=null,Je=1,Mt=null,Ht=null,it=null,Pt=null,Kt=!1;function ht(e="render",{message:t,actionLabel:n,onAction:a,showSpinner:s=e!=="error"}={}){if(!Q?.statusIndicator||!Q?.statusText)return;Q.statusKind=e;const r=t||Zs(e);Q.statusText.textContent=r,Q.statusSpinner&&(Q.statusSpinner.hidden=!s),Q.statusAction&&(Q.statusAction.hidden=!0,Q.statusAction.onclick=null,n&&typeof a=="function"&&(Q.statusAction.textContent=n,Q.statusAction.hidden=!1,Q.statusAction.onclick=i=>{i.preventDefault(),a()})),Q.statusIndicator.hidden=!1,requestAnimationFrame(()=>{Q.statusIndicator.classList.add("is-visible")})}function xt(e){try{return String(e||"").toLowerCase().normalize("NFKD").replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,"").replace(/\s+/g," ").trim()}catch{return String(e||"").trim().toLowerCase()}}function Ut(e){!Q?.statusIndicator||!Q?.statusText||(Q.statusKind=null,Q.statusIndicator.classList.remove("is-visible"),setTimeout(()=>{Q?.statusIndicator&&(Q.statusIndicator.hidden=!0,Q.statusAction&&(Q.statusAction.hidden=!0,Q.statusAction.onclick=null),Q.statusSpinner&&(Q.statusSpinner.hidden=!1))},220))}function Wn(){return!!window?.bootstrap?.Modal}function mo(e){if(e&&!e.classList.contains("show")){e.classList.add("show"),e.style.display="block",e.removeAttribute("aria-hidden"),e.setAttribute("aria-modal","true"),e.getAttribute("role")||e.setAttribute("role","dialog"),document.body.classList.add("modal-open"),it||(it=document.createElement("div"),it.className="modal-backdrop fade show",it.dataset.quotePdfFallbackBackdrop="true",document.body.appendChild(it)),Pt||(Pt=t=>{t.key==="Escape"&&Jn(e)},document.addEventListener("keydown",Pt));try{e.focus({preventScroll:!0})}catch{}}}function Jn(e){if(!(!e||!e.classList.contains("show"))){try{const t=e.ownerDocument?.activeElement;if(t&&e.contains(t)){try{t.blur()}catch{}try{e.ownerDocument?.body?.focus({preventScroll:!0})}catch{}}}catch{}e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal"),document.body.classList.remove("modal-open"),it&&(it.remove(),it=null),Pt&&(document.removeEventListener("keydown",Pt),Pt=null);try{ir()}catch{}}}function po(e){if(e){if(Wn()){const t=window.bootstrap.Modal.getOrCreateInstance(e);try{const n=()=>{try{const a=document.activeElement;if(a&&e.contains(a)){try{a.blur()}catch{}try{document.body?.focus({preventScroll:!0})}catch{}}}catch{}try{ir()}catch{}try{e.removeEventListener("hidden.bs.modal",n)}catch{}};e.addEventListener("hidden.bs.modal",n,{once:!0}),e.addEventListener("hide.bs.modal",()=>{try{const a=document.activeElement;if(a&&e.contains(a))try{a.blur()}catch{}}catch{}})}catch{}t.show();return}mo(e)}}function fo(){if(Kt)return;Kt=!0;const e=c("reservations.quote.toast.viewGuide","📘 عرض دليل الحل السريع"),t=c("reservations.quote.toast.retry","إعادة المحاولة"),n=c("reservations.quote.toast.assetsFailed","⚠️ تعذر تحميل بعض الصور ضمن عرض السعر."),a=!!Q?.modal?.classList.contains("show"),s=()=>{Q?.modal?.classList.contains("show")&&(ht("render"),Kt=!1,dt())};is({message:n,duration:9e3,actionLabel:a?t:void 0,onAction:a?s:void 0,linkLabel:e,linkHref:Gs}),a&&ht("error",{message:n,actionLabel:t,onAction:s,showSpinner:!1})}function Pn(e="reservation"){const t={},n=Js(e);return Object.entries(n).forEach(([a,s=[]])=>{t[a]=new Set(s.filter(r=>r?.default!==!1).map(r=>r.id))}),t}function Sa(e={}){const t={};return Object.entries(e).forEach(([n,a])=>{t[n]=new Set(Array.from(a||[]))}),t}function yo(e={},t){if(t)return e[t]||(e[t]=new Set),e[t]}function wa(e={},t,n){const a=e?.[t];return a?a instanceof Set?a.has(n):Array.isArray(a)?a.includes(n):!!a?.[n]:!0}function Ea(e="reservation"){return Object.fromEntries(kn(e).map(({id:t})=>[t,!1]))}function qa(e,t){return e.sectionExpansions||(e.sectionExpansions=Ea(e.context||"reservation")),t&&typeof e.sectionExpansions[t]!="boolean"&&(e.sectionExpansions[t]=!1),e.sectionExpansions}function bo(e,t){return qa(e,t)?.[t]!==!1}function Ia(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches}function ho(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||navigator.platform||"";return lo.test(e)}function go(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=cr.test(e),n=e.includes("Chrome")||e.includes("CriOS")||e.includes("Chromium"),a=e.includes("Edg");return t&&!n&&!a}function lr(){return ho()&&go()}function xn(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=navigator.platform||"",n=Number.isFinite(navigator.maxTouchPoints)?navigator.maxTouchPoints:0,a=Ga.test(e)||Ga.test(t),s=/Macintosh/i.test(e)&&n>1;return cr.test(e)&&!uo.test(e)&&(a||s)}function Tn(e,...t){try{console.log(`${fn} ${e}`,...t)}catch{}}function nt(e,...t){try{console.warn(`${fn} ${e}`,...t)}catch{}}function vo(e,t,...n){try{t?console.error(`${fn} ${e}`,t,...n):console.error(`${fn} ${e}`,...n)}catch{}}function ve(e,{blockType:t="section",extraAttributes:n=""}={}){if(!e)return"";const a=n?` ${n.trim()}`:"";return e.replace(/^(<\w+)/,`$1 data-quote-block data-block-type="${t}"${a}`)}function So(e,t="لا توجد بيانات للعرض."){const n=g(c(e,t));return ve(`<section class="quote-section quote-placeholder">${n}</section>`,{blockType:"placeholder"})}function yn(e,t){return Array.isArray(e)&&e.length?e:[So(t)]}const wo=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;function dr(e=""){return wo.test(e)}function Eo(){const e=window.CanvasRenderingContext2D?.prototype;if(!e||e.__artRatioDirectionPatched)return;const t=n=>{const a=e[n];typeof a=="function"&&(e[n]=function(r,...i){if(typeof r!="string"||!dr(r))return a.call(this,r,...i);let o,d=!1;try{"direction"in this&&(o=this.direction,o!=="rtl"&&(this.direction="rtl"),d=!0)}catch{}try{if(!d){const u=this.canvas;u&&u.style?.direction!=="rtl"&&(u.__artRatioOriginalDirection=u.style.direction,u.style.direction="rtl")}return a.call(this,r,...i)}finally{if(d&&o!==void 0&&o!=="rtl")try{this.direction=o}catch{}else if(!d){const u=this.canvas;u&&u.__artRatioOriginalDirection!==void 0&&(u.style.direction=u.__artRatioOriginalDirection,delete u.__artRatioOriginalDirection)}}})};t("fillText"),t("strokeText"),e.__artRatioDirectionPatched=!0}function Wa(e,t=zt){if(typeof e!="string"&&typeof e!="number")return t;const n=parseFloat(String(e).replace(/[^0-9.+-]/g,""));return Number.isFinite(n)&&n>0?n:t}function qo(e){if(!e)return{width:zt,height:zt};const t=e.getAttribute?.("width"),n=e.getAttribute?.("height");let a=t?Wa(t,0):0,s=n?Wa(n,0):0;if(a>0&&s>0)return{width:a,height:s};const r=e.getAttribute?.("viewBox");if(r){const i=r.trim().split(/[\s,]+/).map(o=>parseFloat(o||"0"));if(i.length>=4){const[,,o,d]=i;a=a||(Number.isFinite(o)&&o>0?o:0),s=s||(Number.isFinite(d)&&d>0?d:0)}}return{width:a||zt,height:s||zt}}function ur(e=""){return typeof e!="string"?!1:nr.test(e)||co.test(e)}function Io(e=""){const t=e.indexOf(",");if(t===-1)return"";const n=e.slice(0,t),a=e.slice(t+1);try{return/;base64/i.test(n)?typeof atob=="function"?atob(a):"":decodeURIComponent(a)}catch(s){return console.warn("[reservations/pdf] failed to decode SVG data URI",s),""}}function Ao(e,{crossOrigin:t}={}){return new Promise((n,a)=>{const s=new Image;t&&(s.crossOrigin=t),s.onload=()=>n(s),s.onerror=r=>{const i=r?.message||`Unable to load image from ${e}`;a(new Error(i))},s.src=e})}async function mr(e,t={}){if(!e)return null;const n=document,a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a);try{const r=await Ao(s),i=n.createElement("canvas"),o=Math.max(t.width||r.naturalWidth||r.width||0,1),d=Math.max(t.height||r.naturalHeight||r.height||o,1);i.width=o,i.height=d;const u=i.getContext("2d");return u.clearRect(0,0,o,d),u.drawImage(r,0,0,o,d),i.toDataURL("image/png")}catch(r){return console.warn("[reservations/pdf] failed to rasterize SVG content",r),null}finally{URL.revokeObjectURL(s)}}async function ko(e){if(!e)return null;if(nr.test(e))return Io(e);try{const t=await fetch(e,{mode:"cors",credentials:"omit",cache:"default"});return t.ok?await t.text():(console.warn("[reservations/pdf] failed to fetch SVG image",e,t.status),null)}catch(t){return console.warn("[reservations/pdf] error fetching SVG image",e,t),null}}async function Po(e){if(!e)return!1;const t=e.getAttribute?.("src")||"";if(!ur(t))return!1;const n=await ko(t);if(!n)return e.dataset.svgRasterization="failed",e.setAttribute("src",Qn),!1;const a=await mr(n);return a?(e.dataset.svgOriginalSrc=t,e.setAttribute("src",a),e.setAttribute("data-rasterized","true"),!0):(e.dataset.svgRasterization="failed",e.setAttribute("src",Qn),!1)}async function xo(e){if(!e||e.tagName?.toLowerCase()!=="svg")return!1;const n=new XMLSerializer().serializeToString(e),a=qo(e),s=await mr(n,a),i=(e.ownerDocument||document).createElement("img");i.setAttribute("src",s||Qn),i.setAttribute("alt",e.getAttribute("aria-label")||e.getAttribute("title")||""),i.setAttribute("data-svg-replaced","true"),e.hasAttribute("class")&&i.setAttribute("class",e.getAttribute("class")),e.hasAttribute("style")&&i.setAttribute("style",e.getAttribute("style"));const o=e.getAttribute("width"),d=e.getAttribute("height");return o&&i.setAttribute("width",o),d&&i.setAttribute("height",d),e.parentNode?.replaceChild(i,e),!!s}async function pr(e){if(!e)return;const t=Array.from(e.querySelectorAll?.("img")||[]),n=Array.from(e.querySelectorAll?.("svg")||[]),a=[];t.forEach(s=>{ur(s.getAttribute?.("src"))&&a.push(Po(s))}),n.forEach(s=>{a.push(xo(s))}),a.length&&await Promise.allSettled(a)}function $o(e,{pixelRatio:t=1}={}){if(!e)return null;const n=e.ownerDocument||document,s=(n.defaultView||window).getComputedStyle?.(e);if(!s)return null;const r=(R,W=0)=>{const M=parseFloat(R);return Number.isFinite(M)?M:W},i=r(s.paddingTop),o=r(s.paddingBottom),d=r(s.paddingRight),u=r(s.paddingLeft),l=r(s.borderRadius),y=r(s.fontSize,14),f=(()=>{const R=s.lineHeight;if(!R||R==="normal")return y*1.6;const W=r(R,y*1.6);return W>0?W:y*1.6})(),m=Math.max(e.clientWidth||0,e.scrollWidth||0,r(s.width,0));if(m<=0)return null;const p=Math.max(1,m-u-d),h=e.textContent||"",w=h.split(/\r?\n/),j=n.createElement("canvas"),v=j.getContext("2d");if(!v)return null;const _=s.fontStyle||"normal",P=s.fontVariant||"normal",H=s.fontWeight||"400",E=s.fontFamily||"sans-serif",k=s.fontStretch||"normal",D=R=>R.join(" "),L=[],J=R=>v.measureText(R).width;v.font=`${_} ${P} ${H} ${k} ${y}px ${E}`,w.forEach(R=>{const W=R.trim();if(W.length===0){L.push("");return}const M=W.split(/\s+/);let ne=[];M.forEach((Z,ae)=>{const me=Z.trim();if(!me)return;const ue=D(ne.concat(me));if(J(ue)<=p||ne.length===0){ne.push(me);return}L.push(D(ne)),ne=[me]}),ne.length&&L.push(D(ne))}),L.length||L.push("");const $=i+o+L.length*f,B=Math.ceil(Math.max(1,m)*t),U=Math.ceil(Math.max(1,$)*t);j.width=B,j.height=U,j.style.width=`${Math.max(1,m)}px`,j.style.height=`${Math.max(1,$)}px`,v.scale(t,t);const T=s.backgroundColor&&s.backgroundColor!=="rgba(0, 0, 0, 0)"?s.backgroundColor:"#ffffff";if(l>0){v.save(),v.beginPath();const R=Math.max(1,m),W=Math.max(1,$),M=Math.min(l,R/2,W/2);v.moveTo(M,0),v.lineTo(R-M,0),v.quadraticCurveTo(R,0,R,M),v.lineTo(R,W-M),v.quadraticCurveTo(R,W,R-M,W),v.lineTo(M,W),v.quadraticCurveTo(0,W,0,W-M),v.lineTo(0,M),v.quadraticCurveTo(0,0,M,0),v.closePath(),v.clip()}if(v.fillStyle=T,v.fillRect(0,0,Math.max(1,m),Math.max(1,$)),v.font=`${_} ${P} ${H} ${k} ${y}px ${E}`,v.fillStyle=s.color||"#000000",v.textBaseline="top",v.textAlign="right","direction"in v)try{v.direction="rtl"}catch{}const N=Math.max(0,m-d);let F=i;L.forEach(R=>{const W=R.length?R:" ";v.fillText(W,N,F,p),F+=f});const Y=n.createElement("img");let G;try{G=j.toDataURL("image/png")}catch(R){return nt("note canvas toDataURL failed",R),null}return Y.src=G,Y.alt=h,Y.style.width=`${Math.max(1,m)}px`,Y.style.height=`${Math.max(1,$)}px`,Y.style.display="block",Y.setAttribute("data-quote-note-image","true"),{image:Y,canvas:j,totalHeight:$,width:m}}function jo(e,{pixelRatio:t=1}={}){if(!e||!xn())return;Array.from(e.querySelectorAll?.(".quote-notes")||[]).forEach(a=>{if(!a||a.dataset.quoteNoteRasterized==="true"||!dr(a.textContent||""))return;let s;try{s=$o(a,{pixelRatio:t})}catch(r){nt("failed to rasterize note content",r),s=null}s&&(a.dataset.quoteNoteRasterized="true",a.innerHTML="",a.appendChild(s.image))})}function Xn(e,t="export",{toastMessage:n,suppressToast:a=!1}={}){vo(`${t} failed`,e);const s=!!(e&&e.__artRatioPdfNotified);if(!a&&!s){const r=c("reservations.quote.errors.exportFailed","⚠️ تعذر إنشاء ملف PDF، يرجى المحاولة مرة أخرى."),i=n||r,o=c("reservations.quote.toast.viewGuide","📘 عرض دليل الحل السريع"),d=c("reservations.quote.toast.retry","إعادة المحاولة"),u=["exportQuoteAsPdf","renderQuotePreview","layoutQuoteDocument","pageCapture"].includes(t),l=()=>{t==="exportQuoteAsPdf"?(ht("export"),xr()):(ht("render"),Kt=!1,dt())};if(is({message:i,duration:9e3,actionLabel:u?d:void 0,onAction:u?l:void 0,linkLabel:o,linkHref:Gs}),Q?.modal?.classList.contains("show")&&ht("error",{message:i,actionLabel:u?d:void 0,onAction:u?l:void 0,showSpinner:!1}),e&&typeof e=="object")try{Object.defineProperty(e,"__artRatioPdfNotified",{value:!0,writable:!1,enumerable:!1,configurable:!0})}catch{}}}function Yn({container:e,safariWindowRef:t,mobileWindowRef:n}={}){try{n&&!n.closed&&n.close()}catch(a){nt("failed to close mobile window",a)}try{t&&!t.closed&&t.close()}catch(a){nt("failed to close safari window",a)}e&&e.parentNode&&e.parentNode.removeChild(e)}function Aa(e){return new Promise((t,n)=>{const a=document.querySelector(`script[src="${e}"]`);if(a){a.addEventListener("load",()=>t()),a.addEventListener("error",r=>n(r)),a.readyState==="complete"&&t();return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>t(),s.onerror=r=>n(r),document.head.appendChild(s)})}function Ja(){const e=[window.jspdf?.jsPDF,typeof window.jspdf=="function"?window.jspdf:null,window.jsPDF?.jsPDF,typeof window.jsPDF=="function"?window.jsPDF:null].filter(t=>typeof t=="function");return e.length?e[0]:null}function Xa(){return typeof window.html2canvas=="function"?window.html2canvas:null}async function Co(){const e=Xa();return e||(Ht||(Ht=Aa(io).catch(t=>{throw Ht=null,t}).then(()=>{const t=Xa();if(!t)throw Ht=null,new Error("تعذر تحميل مكتبة html2canvas المطلوبة.");return t})),Ht)}async function _o(){const e=Ja();return e||(Mt||(Mt=Aa(oo).catch(t=>{throw Mt=null,t}).then(()=>{const t=Ja();if(!t)throw Mt=null,new Error("تعذر تحميل مكتبة jsPDF المطلوبة.");return t})),Mt)}async function To(){if(window.html2pdf||await Aa(ro),window.html2pdf&&!window.html2pdf.__artRatioConfigured){const e=window.html2pdf.defaultOptions||window.html2pdf.defaultOpt||{},t={...e.html2canvas||{}};t.useCORS=!0,t.allowTaint=!1,t.logging=!0;const n={unit:"mm",format:"a4",orientation:"portrait",compress:!0,...e.jsPDF||{}},a={image:{type:"jpeg",quality:.95,...e.image||{}},margin:e.margin??[0,0,0,0],filename:e.filename||"document.pdf",html2canvas:t,jsPDF:n};window.html2pdf.defaultOptions=a,window.html2pdf.defaultOpt=a,window.html2pdf.__artRatioConfigured=!0}hi(),Eo()}function g(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function No(e="reservation"){return e==="project"?"QP":"Q"}function Lo(e,t="reservation"){const n=Number(e),a=No(t);return!Number.isFinite(n)||n<=0?`${a}-0001`:`${a}-${String(n).padStart(4,"0")}`}function Bo(){const e=window.localStorage?.getItem?.(Qs),t=parseInt(e??"",10);return Number.isFinite(t)&&t>0?t:0}function fr(e="reservation"){const n=Bo()+1;return{sequence:n,quoteNumber:Lo(n,e)}}function Do(e){try{const t=Number(e);if(!Number.isFinite(t)||t<=0)return;window.localStorage?.setItem?.(Qs,String(t))}catch(t){console.warn("⚠️ [reservations/pdf] failed to persist quote sequence",t)}}function yr(e="reservation"){return Qa[e]||Qa.reservation}function Fo(e="reservation"){try{const t=yr(e),n=window.localStorage?.getItem?.(t);if(!n)return null;const a=JSON.parse(n);return a&&typeof a=="object"?a:null}catch(t){return console.warn("⚠️ [reservations/pdf] failed to read toggle preferences",t),null}}function Ro(e,t="reservation"){try{const n=yr(t);if(!e){window.localStorage?.removeItem?.(n);return}window.localStorage?.setItem?.(n,JSON.stringify(e))}catch(n){console.warn("⚠️ [reservations/pdf] failed to persist toggle preferences",n)}}function Mo(e){if(!e)return{ids:null,emptyExplicitly:!1};if(e instanceof Set)return{ids:Array.from(e),emptyExplicitly:e.size===0};if(Array.isArray(e))return{ids:e.slice(),emptyExplicitly:e.length===0};if(typeof e=="object"){const t=Object.entries(e).filter(([,n])=>!!n);return{ids:t.map(([n])=>n),emptyExplicitly:t.length===0}}return{ids:null,emptyExplicitly:!1}}function Ho(e,t="reservation"){if(!e)return null;const n=Xs(t),a=Ys(t),s=Array.from(e.sections instanceof Set?e.sections:new Set(e.sections||[])).filter(o=>n.has(o)),r={},i=e.fields||{};return Object.entries(a).forEach(([o,d])=>{const u=i[o];if(u==null)return;const{ids:l,emptyExplicitly:y}=Mo(u);if(!l&&!y)return;const f=Array.isArray(l)?l.filter(m=>d.has(m)):[];(f.length>0||y)&&(r[o]=f)}),{version:1,sections:s,fields:r}}function br(e){if(!e)return;const t=e.context||"reservation",n=Ho(e,t);n&&Ro(n,t)}function hr(e){if(!e)return;const t=e.context||"reservation",n=Fo(t);if(!n)return;const a=Xs(t),s=Array.isArray(n.sections)?n.sections.filter(r=>a.has(r)):[];if(s.length&&(e.sections=new Set(s)),n.fields&&typeof n.fields=="object"){const r=Sa(e.fields||Pn(t)),i=Ys(t);Object.entries(n.fields).forEach(([o,d])=>{const u=i[o];if(!u)return;const l=Array.isArray(d)?d.filter(y=>u.has(y)):[];r[o]=new Set(l)}),e.fields=r}}function gr(e=new Date){try{return e.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return e.toISOString().slice(0,10)}}function ka(e){const t=Ct()||[],{technicians:n=[]}=fe(),a=[].concat(Array.isArray(t)?t:[]).concat(Array.isArray(n)?n:[]),s=new Map;return a.forEach(i=>{if(!i||i.id==null)return;const o=String(i.id),d=s.get(o)||{};s.set(o,{...d,...i})}),(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(i=>({technicianId:i}))).map((i,o)=>{const d=i?.technicianId!=null?s.get(String(i.technicianId)):null;let u=i.positionLabel??i.position_name??i.position_label??i.role??i.position??d?.role??c("reservations.crew.positionFallback","منصب بدون اسم");(!u||u.trim()==="")&&(u=i.positionLabelAr??i.position_label_ar??i.positionLabelEn??i.position_label_en??i.position_name_ar??i.position_name_en??d?.role??c("reservations.crew.positionFallback","منصب بدون اسم"));try{const f=typeof La=="function"?La()||[]:[];let m=null;if(i?.positionId!=null&&(m=f.find(p=>String(p?.id)===String(i.positionId))||null),!m){const p=i.positionKey??i.position_key??i.positionName??i.position_name??i.position??"";if(p&&(m=typeof Ba=="function"&&Ba(p)||null,!m&&f.length)){const h=String(p).trim().toLowerCase();m=f.find(w=>[w.name,w.labelAr,w.labelEn].filter(Boolean).map(j=>String(j).toLowerCase()).includes(h))||null}}if(m){const p=m.labelAr||m.labelEn||m.name||"";p&&p.trim()&&(u=p)}}catch{}const l=vt(jt(i.positionCost??i.position_cost??i.cost??i.daily_wage??i.dailyWage??d?.dailyWage??d?.wage??0)),y=vt(jt(i.positionClientPrice??i.position_client_price??i.client_price??i.clientPrice??i.daily_total??i.dailyTotal??i.total??d?.dailyTotal??d?.total??d?.total_wage??0));return{assignmentId:i.assignmentId??i.assignment_id??`crew-${o}`,positionId:i.positionId??i.position_id??null,positionLabel:u,positionLabelAlt:i.positionLabelAlt??i.position_label_alt??"",positionCost:l,positionClientPrice:y,technicianId:i.technicianId!=null?String(i.technicianId):d?.id!=null?String(d.id):null,technicianName:i.technicianName??i.technician_name??d?.name??null,technicianRole:i.technicianRole??d?.role??null}})}function vr(e,t,n){const{projectLinked:a}=Bt(e,n);ca(e.start,e.end);const s=e.discount??e.discountValue??0,r=Number(A(String(s)))||0,i=e.discountType??e.discount_type??"percent",o=String(i).toLowerCase()==="amount"?"amount":"percent",d=a?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),u=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,l=u!=null?jt(u):Number.NaN,f=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied)===!0&&Number.isFinite(l)&&l>0?l:null,m=Array.isArray(t)?t.map(P=>P?.technicianId).filter(Boolean):[],p=Xr({items:Array.isArray(e.items)?e.items:[],technicianIds:m,crewAssignments:Array.isArray(t)?t:[],discount:r,discountType:o,applyTax:d,start:e.start,end:e.end,companySharePercent:f}),h=jt(e.cost??e.total??e.finalTotal),w=Number.isFinite(h),j=a?p.finalTotal:w?vt(h):p.finalTotal,v={equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,crewCostTotal:p.crewCostTotal,discountAmount:p.discountAmount,subtotalAfterDiscount:p.subtotalAfterDiscount,taxableAmount:p.taxableAmount,taxAmount:p.taxAmount,finalTotal:j,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,netProfit:p.netProfit},_={equipmentTotal:Se(p.equipmentTotal),crewTotal:Se(p.crewTotal),discountAmount:Se(p.discountAmount),subtotalAfterDiscount:Se(p.subtotalAfterDiscount),taxableAmount:Se(p.taxableAmount),taxAmount:Se(p.taxAmount),finalTotal:Se(j),companySharePercent:A((Number.isFinite(p.companySharePercent)?p.companySharePercent:0).toFixed(2)),companyShareAmount:Se(p.companyShareAmount),netProfit:A(p.netProfit.toFixed(2))};return{totals:v,totalsDisplay:_,rentalDays:p.rentalDays}}function Nt(e){if(e==null||e==="")return null;const t=Number.parseFloat(A(String(e)));return Number.isFinite(t)?t:null}function Sr(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function Oo(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n!=="percent"&&(n="amount");const a=Nt(e.amount??(n==="amount"?e.value:null)),s=Nt(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,i=e.note??e.memo??null,o=Sr(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:i,recordedAt:o}}function zo(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(Oo).filter(Boolean);if(n.length>0)return n;const a=Nt(e.paidPercent??e.paid_percent),s=Nt(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,i=Sr(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:i}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:i}]:[]}function Vo(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function Ko(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function Uo(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function Qo(e){const t=Number(e?.equipmentEstimate)||0,n=Uo(e),a=t+n,s=e?.applyTax===!0||e?.applyTax==="true",r=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let o=(e?.discountType==="amount"?"amount":"percent")==="amount"?r:a*(r/100);(!Number.isFinite(o)||o<0)&&(o=0),o>a&&(o=a);const d=Math.max(0,a-o),u=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",l=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,y=u&&s&&l>0?l:0,f=y>0?Number((d*(y/100)).toFixed(2)):0,m=d+f;let p=s?m*Es:0;(!Number.isFinite(p)||p<0)&&(p=0),p=Number(p.toFixed(2));let h=s?Number(e?.totalWithTax):m;return s?(!Number.isFinite(h)||h<=0)&&(h=Number((m+p).toFixed(2))):h=m,{equipmentEstimate:t,expensesTotal:n,baseSubtotal:a,discountAmount:o,subtotalAfterDiscount:d,companyShareAmount:f,subtotal:m,applyTax:s,taxAmount:p,totalWithTax:h}}function Go(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(A(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=ra(t,a,s,!1,i,{start:e.start,end:e.end});if(Number.isFinite(o))return o;const d=Number(A(String(e.cost??0)));return Number.isFinite(d)?Math.round(d):0}function Wo(e,t){if(!e)return"—";const n=at(e);return t?`${n} - ${at(t)}`:n}function oe(e,t="SR",n=2){const a=Number(e);return`${Se(a)} ${t}`}function Ya(e,t=2){if(!Number.isFinite(Number(e)))return"0%";const n=Number.isInteger(t)?t:2;return`${A(Number(e).toFixed(n))}%`}function Jo(e){if(!e?.start)return null;if(!e?.end)return 1;const t=ca(e.start,e.end);return Number.isFinite(t)?t:1}function Xo(e){return Number.isFinite(e)?e<=1?"يوم واحد":`${A(String(Math.round(e)))} أيام`:"غير محدد"}function Za(e){const t=c("reservations.create.summary.currency","SR"),n=fe()||{},a=Array.isArray(n.customers)?n.customers:[],s=Array.isArray(n.projects)?n.projects:[],r=Array.isArray(n.technicians)?n.technicians:[];let i=[];try{const S=Sn?.()||[];i=Array.isArray(S)&&S.length?S:n.reservations||[]}catch{i=n.reservations||[]}const o=e?.id!=null?s.find(S=>String(S.id)===String(e.id))||e:e||null,d={projectStatusLabel:c("projects.status.ongoing","قيد التنفيذ"),paymentStatusLabel:c("projects.paymentStatus.unpaid","غير مدفوع")};if(!o)return{project:null,customer:null,clientInfo:{name:"-",company:"-",phone:"-",email:"-"},projectInfo:{title:"-",code:"-",typeLabel:"-",startDisplay:"-",endDisplay:"-",durationLabel:"-",statusLabel:d.projectStatusLabel},expenses:[],equipment:[],reservations:[],totals:{equipmentEstimate:0,expensesTotal:0,baseSubtotal:0,discountAmount:0,subtotalAfterDiscount:0,companyShareAmount:0,subtotal:0,applyTax:!1,taxAmount:0,totalWithTax:0},totalsDisplay:{projectSubtotal:oe(0,t),expensesTotal:oe(0,t),reservationsTotal:oe(0,t),discountAmount:oe(0,t),taxAmount:oe(0,t),overallTotal:oe(0,t),paidAmount:oe(0,t),remainingAmount:oe(0,t)},projectTotals:{combinedTaxAmount:0,overallTotal:0,reservationsTotal:0,paidAmount:0,paidPercent:0,remainingAmount:0,paymentStatus:"unpaid"},paymentSummary:{status:"unpaid",statusLabel:d.paymentStatusLabel,paidAmount:0,paidPercent:0,remainingAmount:0,paidAmountDisplay:oe(0,t),remainingAmountDisplay:oe(0,t),paidPercentDisplay:Ya(0)},notes:"",currencyLabel:t,projectStatus:"ongoing",projectStatusLabel:d.projectStatusLabel,projectDurationDays:null,projectDurationLabel:"غير محدد",paymentHistory:[]};const u=o.clientId??o.customerId??o.client_id??o.customer_id??null,l=u!=null&&a.find(S=>String(S.id)===String(u))||null,y=l?.customerName??l?.name??o.clientName??o.customerName??c("projects.fallback.unknownClient","عميل غير معروف"),f=(o.clientCompany||l?.companyName||l?.company||"").trim(),m=l?.phone??l?.customerPhone??o.clientPhone??o.customerPhone??"",p=m?A(String(m).trim()):c("projects.details.client.noPhone","لا يوجد رقم متاح"),h=l?.email??o.clientEmail??o.customerEmail??"",w=h?String(h).trim():c("projects.details.client.noEmail","لا يوجد بريد متاح"),j=o.projectCode||`PRJ-${A(String(o.id??""))}`,v=A(String(j)),_=(o.title||"").trim()||c("projects.fallback.untitled","مشروع بدون عنوان"),P=Vo(o.type),H=o.start?at(o.start):"—",E=o.end?at(o.end):"—",k=Jo(o),D=k!=null?Xo(k):"غير محدد",L=Ko(o),J={upcoming:"قادم",ongoing:"قيد التنفيذ",completed:"مكتمل"},$=c(`projects.status.${L}`,J[L]||L),B=o.id!=null?String(o.id):null,U=B?i.filter(S=>{const V=S?.projectId??S?.project_id??null;return V!=null&&String(V)===B}):[],N=U.map(S=>{const V=S.reservationId||S.id||"",C=S.status||S.state||"pending",O=String(C).toLowerCase(),X=c(`reservations.status.${O}`,O),te=Go(S),ke=S.start?new Date(S.start).getTime():0;return{reservationId:A(String(V||"-")),status:O,statusLabel:X,total:te,totalLabel:oe(te,t),dateRange:Wo(S.start,S.end),startTimestamp:Number.isNaN(ke)?0:ke}}).sort((S,V)=>V.startTimestamp-S.startTimestamp).map(({startTimestamp:S,...V})=>V).reduce((S,V)=>S+(Number(V.total)||0),0),F=[];try{U.forEach(S=>{const{groups:V}=Dt(S);V.forEach(C=>{const O=Number(C?.count??C?.quantity??1)||1,X=Number(C?.unitPrice);let te=Number.isFinite(X)?X:0;if(!te||te<=0){const ge=Number(C?.totalPrice);Number.isFinite(ge)&&O>0&&(te=Number((ge/O).toFixed(2)))}Number.isFinite(te)||(te=0);const ke=C?.type==="package"||Array.isArray(C?.items)&&C.items.some(ge=>ge?.type==="package"),Te=Array.isArray(C?.barcodes)&&C.barcodes.length?C.barcodes[0]:Array.isArray(C?.items)&&C.items.length?C.items[0]?.barcode:null;let ye=C?.packageDisplayCode??C?.package_code??C?.code??C?.packageCode??(Array.isArray(C?.items)&&C.items.length?C.items[0]?.package_code??C.items[0]?.code??C.items[0]?.packageCode:null);const ft=ge=>{const Be=(ge==null?"":String(ge)).trim();return!!(!Be||/^pkg-/i.test(Be)||/^\d+$/.test(Be)&&Be.length<=4)};if(!ye||ft(ye)){const ge=C?.packageId??C?.package_id??(Array.isArray(C?.items)&&C.items.length?C.items[0]?.packageId??C.items[0]?.package_id:null);if(ge)try{const Be=ma(ge);Be&&Be.package_code&&(ye=Be.package_code)}catch{}}if(!ye||ft(ye))try{const ge=xt(C?.description||"");if(ge){const Be=vs();let yt=Be.find(Ze=>xt(Ze?.name||Ze?.title||Ze?.label||"")===ge);yt||(yt=Be.find(Ze=>{const q=xt(Ze?.name||Ze?.title||Ze?.label||"");return q.includes(ge)||ge.includes(q)})),yt&&yt.package_code&&(ye=yt.package_code)}}catch{}const At=ke?ye??Te??"":C?.barcode??Te??"",Ge=At!=null?String(At):"",Rt=Number.isFinite(Number(C?.totalPrice))?Number(C.totalPrice):Number((te*O).toFixed(2));F.push({...C,isPackage:ke,desc:C?.description,barcode:Ge,packageCodeResolved:ye||"",qty:O,price:te,totalPrice:vt(Rt),unitPriceValue:te})})})}catch{}const Y=new Map;U.forEach(S=>{const V=Array.isArray(S.items)?S.items:[],C=ca(S.start,S.end),O=S.reservationId||S.id||"";V.forEach((X,te)=>{if(!X)return;const ke=X.barcode||X.code||X.id||X.desc||X.description||`item-${te}`,Te=String(ke||`item-${te}`),ye=Y.get(Te)||{description:X.desc||X.description||X.name||X.barcode||`#${A(String(te+1))}`,totalQuantity:0,reservationsCount:0,reservationIds:new Set,totalCost:0},ft=Number(X.qty)||1,At=Number(X.price)||0;ye.totalQuantity+=ft,ye.reservationIds.add(String(O));const Ge=At*ft*Math.max(1,C);Number.isFinite(Ge)&&(ye.totalCost+=Ge),Y.set(Te,ye)})});const G=Array.from(Y.values()).map(S=>({description:S.description,totalQuantity:S.totalQuantity,reservationsCount:S.reservationIds.size,displayCost:oe(S.totalCost,t)})),R=new Map((r||[]).filter(Boolean).map(S=>[String(S.id),S])),W=new Map,M=S=>{if(!S)return;let V=null;typeof S=="object"?V=S.id??S.technicianId??S.technician_id??S.userId??S.user_id??null:(typeof S=="string"||typeof S=="number")&&(V=S);const C=V!=null?String(V):null,O=C&&R.has(C)?R.get(C):typeof S=="object"?S:null,X=O?.name||O?.full_name||O?.fullName||O?.displayName||(typeof S=="string"?S:null),te=O?.role||O?.title||null,ke=O?.phone||O?.mobile||O?.contact||null;if(!X&&!C)return;const Te=C||X;W.has(Te)||W.set(Te,{id:C,name:X||"-",role:te||null,phone:ke||null})};Array.isArray(o?.technicians)&&o.technicians.forEach(S=>M(S)),U.forEach(S=>{(Array.isArray(S.crewAssignments)&&S.crewAssignments.length?S.crewAssignments:Array.isArray(S.technicians)?S.technicians.map(C=>({technicianId:C})):[]).forEach(C=>M(C))});const ne=Array.from(W.values()),Z=Array.isArray(o.expenses)?o.expenses.map(S=>{const V=Number(S?.amount)||0;return{label:S?.label||S?.name||"-",amount:V,displayAmount:oe(V,t),note:S?.note||S?.description||""}}):[],ae=Qo(o),me=ae.applyTax?Number(((ae.subtotal+N)*Es).toFixed(2)):0,ue=Number((ae.subtotal+N+me).toFixed(2)),Ee=zo(o),xe=Nt(o.paidAmount??o.paid_amount)||0,K=Nt(o.paidPercent??o.paid_percent)||0,se=ia({totalAmount:ue,paidAmount:xe,paidPercent:K,history:Ee}),_e=typeof o.paymentStatus=="string"?o.paymentStatus.toLowerCase():"",qe=oa({manualStatus:_e,paidAmount:se.paidAmount,paidPercent:se.paidPercent,totalAmount:ue}),Fe={paid:"مدفوع",partial:"مدفوع جزئياً",unpaid:"غير مدفوع"},Ie=c(`projects.paymentStatus.${qe}`,Fe[qe]||qe),we=Number(se.paidAmount||0),Ae=Number(se.paidPercent||0),Le=Math.max(0,Number((ue-we).toFixed(2))),je={projectSubtotal:oe(ae.subtotal,t),expensesTotal:oe(ae.expensesTotal,t),reservationsTotal:oe(N,t),discountAmount:oe(ae.discountAmount,t),taxAmount:oe(me,t),overallTotal:oe(ue,t),paidAmount:oe(we,t),remainingAmount:oe(Le,t)},Me={status:qe,statusLabel:Ie,paidAmount:we,paidPercent:Ae,remainingAmount:Le,paidAmountDisplay:oe(we,t),remainingAmountDisplay:oe(Le,t),paidPercentDisplay:Ya(Ae)},b=(o.description||"").trim();return{project:o,customer:l,clientInfo:{name:y,company:f||"—",phone:p,email:w},projectInfo:{title:_,code:v,typeLabel:P,startDisplay:H,endDisplay:E,durationLabel:D,statusLabel:$},expenses:Z,equipment:G,crew:ne,equipmentItems:F,crewAssignments:U.flatMap(S=>ka(S)),totals:ae,totalsDisplay:je,projectTotals:{combinedTaxAmount:me,overallTotal:ue,reservationsTotal:N,paidAmount:we,paidPercent:Ae,remainingAmount:Le,paymentStatus:qe},paymentSummary:Me,notes:b,currencyLabel:t,projectStatus:L,projectStatusLabel:$,projectDurationDays:k,projectDurationLabel:D,paymentHistory:Ee}}function Yo({project:e,clientInfo:t={},projectInfo:n={},projectCrew:a=[],projectExpenses:s=[],projectEquipment:r=[],totalsDisplay:i={},projectTotals:o={},paymentSummary:d={},currencyLabel:u="SR",sections:l,fieldSelections:y={},quoteNumber:f,quoteDate:m,terms:p=Re}){const h=Sa(y),w=(b,z)=>wa(h,b,z),j=b=>l?.has?.(b),v=`<div class="quote-placeholder">${g(c("reservations.quote.placeholder.noFields","لم يتم اختيار أي معلومات للعرض في هذا القسم."))}</div>`,_=(b,z)=>`<div class="info-plain__item">
      <span class="info-plain__label">${g(b)}</span>
      <span class="info-plain__separator">:</span>
      <span class="info-plain__value">${g(z)}</span>
    </div>`,P=(b,z,{variant:S="inline"}={})=>S==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${g(b)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${g(z)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${g(b)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${g(z)}</span>
    </span>`,H=(b,z)=>`<div class="payment-row">
      <span class="payment-row__label">${g(b)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${g(z)}</span>
    </div>`,E=[];w("customerInfo","customerName")&&E.push(_(c("projects.details.client","العميل"),t.name||"-")),w("customerInfo","customerCompany")&&E.push(_(c("projects.details.company","شركة العميل"),t.company||"—")),w("customerInfo","customerPhone")&&E.push(_(c("projects.details.labels.clientPhone","رقم العميل"),t.phone||"-")),w("customerInfo","customerEmail")&&E.push(_(c("projects.details.labels.clientEmail","البريد الإلكتروني"),t.email||"-"));const k=j("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${g(c("projects.quote.sections.customer","بيانات العميل"))}</h3>
        ${E.length?`<div class="info-plain">${E.join("")}</div>`:v}
      </section>`:"",D=[];w("projectInfo","projectType")&&D.push(_(c("projects.details.type","نوع المشروع"),n.typeLabel||"-")),w("projectInfo","projectTitle")&&D.push(_(c("projects.details.projectTitle","اسم المشروع"),n.title||"-")),w("projectInfo","projectCode")&&D.push(_(c("projects.details.labels.code","رقم المشروع"),n.code||"-")),w("projectInfo","projectStart")&&D.push(_(c("projects.details.start","بداية المشروع"),n.startDisplay||"-")),w("projectInfo","projectEnd")&&D.push(_(c("projects.details.end","نهاية المشروع"),n.endDisplay||"-")),w("projectInfo","projectDuration")&&D.push(_(c("projects.details.duration","مدة المشروع"),n.durationLabel||"-")),w("projectInfo","projectStatus")&&D.push(_(c("projects.details.status","حالة المشروع"),n.statusLabel||"-"));const L=j("projectInfo")?`<section class="quote-section quote-section--plain quote-section--project">
        <h3 class="quote-section__title">${g(c("projects.quote.sections.project","بيانات المشروع"))}</h3>
        ${D.length?`<div class="info-plain">${D.join("")}</div>`:v}
      </section>`:"",J=In.filter(b=>w("projectCrew",b.id)),$=Array.isArray(I?.crewAssignments)?I.crewAssignments:[],B=b=>{const z=b&&b.positionId!=null?`id:${String(b.positionId)}`:(()=>{const C=(b?.positionLabel||b?.position_name||b?.position||"").trim().toLowerCase();return C?`label:${C}`:""})(),S=Number.isFinite(Number(b?.positionClientPrice))?Number(b.positionClientPrice):0,V=S>0?`|p:${S.toFixed(2)}`:"";return`${z}${V}`};(()=>{const b=new Map;return $.forEach(z=>{const S=B(z);S&&b.set(S,(b.get(S)||0)+1)}),b})();const U=(()=>{const b=[];if(J.forEach(O=>{O.id==="position"?(b.push({...O,render:X=>{const te=X?.positionLabel??X?.position_name??X?.role??c("reservations.crew.positionFallback","منصب بدون اسم");return g(A(String(te)))}}),w("projectCrew","quantity")&&b.push({id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:X=>g(A(String(Math.max(1,Number(X?.__count||1)))))})):O.id==="price"?b.push({...O,render:X=>{const te=Number.isFinite(Number(X?.positionClientPrice))?Number(X.positionClientPrice):0,ke=Math.max(1,Number(X?.__count||1)),Te=Math.max(1,Number(I?.rentalDays||1)),ye=te*ke*Te;return g(`${Se(ye)} ${c("reservations.create.summary.currency","SR")}`)}}):O.id==="unitPrice"?b.push({...O,render:X=>{const te=Number.isFinite(Number(X?.positionClientPrice))?Number(X.positionClientPrice):0;return g(`${Se(te)} ${c("reservations.create.summary.currency","SR")}`)}}):b.push(O)}),w("projectCrew","days")){const O=Math.max(1,Number(I?.rentalDays||1)),X=b.findIndex(ke=>ke.id==="price"),te=Math.max(0,X);b.splice(te,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>g(A(String(O)))})}const z=new Map(b.map(O=>[O.id,O])),S=new Set,V=[],C=O=>{const X=z.get(O);X&&!S.has(O)&&(V.push(X),S.add(O))};return C("rowNumber"),C("position"),C("unitPrice"),C("quantity"),C("days"),C("price"),b.forEach(O=>{S.has(O.id)||(V.push(O),S.add(O.id))}),V})(),T=(()=>{const b=new Map;return $.forEach(z=>{const S=B(z);if(!S)return;const V=b.get(S);V?V.__count+=1:b.set(S,{...z,__count:1})}),Array.from(b.values())})(),N=(()=>{try{const b=Math.max(1,Number(I?.rentalDays||1)),z=(T||[]).reduce((S,V)=>{const C=Number.isFinite(Number(V?.positionClientPrice))?Number(V.positionClientPrice):0,O=Math.max(1,Number(V?.__count||1));return S+C*O*b},0);return Se(z)}catch{return"0.00"}})(),F=j("projectCrew")?U.length?`<section class="quote-section quote-section--table">
            <h3>${g(c("projects.quote.sections.crew","طاقم العمل"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${U.map(b=>`<th>${g(b.labelKey?c(b.labelKey,b.fallback):b.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${T.length?T.map((b,z)=>`<tr>${U.map(S=>`<td><div class="quote-cell">${S.render(b,z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(U.length,1)}" class="empty">${g(c("projects.details.crew.empty","لا يوجد طاقم فني مرتبط."))}</td></tr>`}
              </tbody>
            </table>
            ${w("projectCrew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${g(c("reservations.details.labels.crewTotal","إجمالي الفريق"))}</span>
                  <span class="quote-table-subtotal__value">${g(`${N} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${g(c("projects.quote.sections.crew","طاقم العمل"))}</h3>
            ${v}
          </section>`:"",Y=[];w("financialSummary","reservationsTotal")&&Y.push(P(c("projects.details.reservationsTotal","إجمالي الحجوزات"),i.reservationsTotal||oe(0,u))),w("financialSummary","discountAmount")&&Y.push(P(c("reservations.details.labels.discount","الخصم"),i.discountAmount||oe(0,u))),w("financialSummary","taxAmount")&&Y.push(P(c("projects.details.summary.combinedTax","إجمالي الضريبة"),i.taxAmount||oe(0,u)));const G=[];w("financialSummary","overallTotal")&&G.push(P(c("projects.details.summary.overallTotal","الإجمالي الكلي"),i.overallTotal||oe(0,u),{variant:"final"}));const R=j("financialSummary")?!Y.length&&!G.length?`<section class="quote-section quote-section--financial">${v}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${g(c("projects.quote.sections.financial","الملخص المالي"))}</h3>
            ${Y.length?`<div class="totals-inline">${Y.join("")}</div>`:""}
            ${G.length?`<div class="totals-final">${G.join("")}</div>`:""}
          </div>
        </section>`:"",W=Ws.filter(b=>w("projectExpenses",b.id)),M=j("projectExpenses")?W.length?`<section class="quote-section quote-section--table">
            <h3>${g(c("projects.quote.sections.expenses","الخدمات الإنتاجية"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${W.map(b=>`<th>${g(b.labelKey?c(b.labelKey,b.fallback):b.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${s.length?s.map((b,z)=>`<tr>${W.map(S=>`<td><div class="quote-cell">${S.render(b,z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(W.length,1)}" class="empty">${g(c("projects.details.expenses.empty","لا توجد متطلبات مسجلة."))}</td></tr>`}
              </tbody>
            </table>
            ${w("projectExpenses","expensesSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${g(c("projects.details.expensesTotal","إجمالي الخدمات الإنتاجية"))}</span>
                  <span class="quote-table-subtotal__value">${g(i.expensesTotal||oe(0,u))}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${g(c("projects.quote.sections.expenses","الخدمات الإنتاجية"))}</h3>
            ${v}
          </section>`:"",ne=qn.filter(b=>w("projectEquipment",b.id)),Z=(()=>{let b=[];if(ne.forEach(C=>{C.id==="price"?b.push({...C,render:O=>{const X=Number.isFinite(Number(O?.unitPriceValue))?Number(O.unitPriceValue):0,te=Number.isFinite(Number(O?.qty))?Math.max(1,Number(O.qty)):1,ke=Math.max(1,Number(I?.rentalDays||1)),Te=X*te*ke;return g(`${Se(Te)} ${c("reservations.create.summary.currency","SR")}`)}}):C.id==="unitPrice"?b.push({...C,render:O=>{const X=Number.isFinite(Number(O?.unitPriceValue))?Number(O.unitPriceValue):0;return g(`${Se(X)} ${c("reservations.create.summary.currency","SR")}`)}}):b.push(C)}),w("projectEquipment","days")){const C=Math.max(1,Number(I?.rentalDays||1)),O=b.findIndex(te=>te.id==="price"),X=Math.max(0,O);b.splice(X,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>g(A(String(C)))})}const z=new Map(b.map(C=>[C.id,C])),S=b.filter(C=>!["unitPrice","quantity","days","price"].includes(C.id)),V=["unitPrice","quantity","days","price"].map(C=>z.get(C)).filter(Boolean);return b=[...S,...V],b})(),ae=Array.isArray(I?.equipmentItems)?I.equipmentItems:[],me=(()=>{try{const b=Math.max(1,Number(I?.rentalDays||1)),z=(ae||[]).reduce((S,V)=>{const C=Number.isFinite(Number(V?.unitPriceValue))?Number(V.unitPriceValue):0,O=Number.isFinite(Number(V?.qty))?Math.max(1,Number(V.qty)):1;return S+C*O*b},0);return Se(z)}catch{return"0.00"}})(),ue=j("projectEquipment")?Z.length?`<section class="quote-section quote-section--table">
            <h3>${g(c("projects.quote.sections.equipment","المعدات"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Z.map(b=>`<th>${g(b.labelKey?c(b.labelKey,b.fallback):b.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${ae.length?ae.map((b,z)=>`<tr>${Z.map(S=>`<td><div class="quote-cell">${S.render(b,z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(Z.length,1)}" class="empty">${g(c("projects.details.equipment.empty","لا توجد معدات مرتبطة حالياً."))}</td></tr>`}
              </tbody>
            </table>
            ${w("projectEquipment","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${g(c("reservations.details.labels.equipmentTotal","إجمالي المعدات"))}</span>
                  <span class="quote-table-subtotal__value">${g(`${me} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${g(c("projects.quote.sections.equipment","المعدات"))}</h3>
            ${v}
          </section>`:"",Ee=(e?.description||"").trim()||"",xe=j("projectNotes")?`<section class="quote-section">
        <h3>${g(c("projects.quote.sections.notes","ملاحظات المشروع"))}</h3>
        <div class="quote-notes">${g(Ee||c("projects.fallback.noDescription","لا يوجد وصف للمشروع."))}</div>
      </section>`:"",K=[];w("payment","beneficiary")&&K.push(H(c("reservations.quote.labels.beneficiary","اسم المستفيد"),Pe.beneficiaryName)),w("payment","bank")&&K.push(H(c("reservations.quote.labels.bank","اسم البنك"),Pe.bankName)),w("payment","account")&&K.push(H(c("reservations.quote.labels.account","رقم الحساب"),A(Pe.accountNumber))),w("payment","iban")&&K.push(H(c("reservations.quote.labels.iban","رقم الآيبان"),A(Pe.iban)));const se=`<section class="quote-section">
      <div class="payment-block">
        <h3>${g(c("reservations.quote.sections.payment","بيانات الدفع"))}</h3>
        <div class="payment-rows">${K.length?K.join(""):v}</div>
      </div>
      <p class="quote-approval-note">${g(Pe.approvalNote)}</p>
    </section>`,_e=Array.isArray(p)&&p.length?p:Re,qe=`<footer class="quote-footer">
        <h4>${g(c("reservations.quote.labels.terms","الشروط العامة"))}</h4>
        <ul>${_e.map(b=>`<li>${g(b)}</li>`).join("")}</ul>
      </footer>`,Fe=[],Ie=[];if(L&&Ie.push({key:"project",html:L}),k&&Ie.push({key:"customer",html:k}),Ie.length>1){const b=Ie.find(V=>V.key==="project"),z=Ie.find(V=>V.key==="customer"),S=[];b?.html&&S.push(b.html),z?.html&&S.push(z.html),Fe.push(ve(`<div class="quote-section-row quote-section-row--primary">${S.join("")}</div>`,{blockType:"group"}))}else Ie.length===1&&Fe.push(ve(Ie[0].html));const we=[];F&&we.push(ve(F,{blockType:"table",extraAttributes:'data-table-id="project-crew"'})),M&&we.push(ve(M,{blockType:"table",extraAttributes:'data-table-id="project-expenses"'})),ue&&we.push(ve(ue,{blockType:"table",extraAttributes:'data-table-id="project-equipment"'}));const Ae=[];R&&Ae.push(ve(R,{blockType:"summary"})),xe&&Ae.push(ve(xe));const Le=[ve(se,{blockType:"payment"}),ve(qe,{blockType:"footer"})],je=[...yn(Fe,"projects.quote.placeholder.primary"),...we,...yn(Ae,"projects.quote.placeholder.summary"),...Le],Me=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${g(Pe.logoUrl)}" alt="${g(Pe.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${g(c("projects.quote.title","عرض سعر"))}</h1>
        <p class="quote-company-name">${g(Pe.companyName)}</p>
        <p class="quote-company-cr">${g(c("reservations.quote.labels.cr","السجل التجاري"))}: ${g(Pe.commercialRegistry)}</p>
        <p class="quote-company-license">ترخيص إعلامي: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${g(c("reservations.details.labels.reservationId","رقم العرض"))}</span>
          <strong>${g(f)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${g(c("projects.quote.labels.date","التاريخ"))}</span>
          <strong>${g(m)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
        <style>${tr}${er}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${Me}
          ${je.join("")}
        </div>
      </div>
    </div>
  `}function wr(e){if(e?.context==="project")return Yo(e);const{reservation:t,customer:n,project:a,crewAssignments:s,totals:r,totalsDisplay:i,rentalDays:o,currencyLabel:d,sections:u,fieldSelections:l={},quoteNumber:y,quoteDate:f,terms:m=Re}=e,p=A(String(t?.reservationId??t?.id??"")),h=t.start?A(at(t.start)):"-",w=t.end?A(at(t.end)):"-",j=n?.customerName||n?.full_name||n?.name||"-",v=n?.phone||"-",_=n?.email||"-",P=n?.company||n?.company_name||"-",H=A(v),E=a?.title||a?.name||c("reservations.details.project.none","غير مرتبط بمشروع"),k=a?.code||a?.projectCode||"",D=A(String(o)),L=t?.notes||"",J=Array.isArray(m)&&m.length?m:Re,$=Sa(l),B=(q,re)=>wa($,q,re),U=q=>u?.has?.(q),T=`<div class="quote-placeholder">${g(c("reservations.quote.placeholder.noFields","لم يتم اختيار أي معلومات للعرض في هذا القسم."))}</div>`,N=(q,re)=>`<div class="info-plain__item">${g(q)} <span class="info-plain__slash">/</span> <strong class="info-plain__value">${g(re)}</strong></div>`,F=(q,re,{variant:pe="inline"}={})=>pe==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${g(q)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${g(re)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${g(q)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${g(re)}</span>
    </span>`,Y=(q,re)=>`<div class="payment-row">
      <span class="payment-row__label">${g(q)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${g(re)}</span>
    </div>`,G=[];B("customerInfo","customerName")&&G.push(N(c("reservations.details.labels.customer","العميل"),j)),B("customerInfo","customerCompany")&&G.push(N(c("reservations.details.labels.company","الشركة"),P)),B("customerInfo","customerPhone")&&G.push(N(c("reservations.details.labels.phone","الهاتف"),H)),B("customerInfo","customerEmail")&&G.push(N(c("reservations.details.labels.email","البريد"),_));const R=U("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${g(c("reservations.quote.sections.customer","بيانات العميل"))}</h3>
        ${G.length?`<div class="info-plain">${G.join("")}</div>`:T}
      </section>`:"",W=[];B("reservationInfo","reservationId")&&W.push(N(c("reservations.details.labels.reservationId","رقم الحجز"),p||"-")),B("reservationInfo","reservationStart")&&W.push(N(c("reservations.details.labels.start","بداية الحجز"),h)),B("reservationInfo","reservationEnd")&&W.push(N(c("reservations.details.labels.end","نهاية الحجز"),w)),B("reservationInfo","reservationDuration")&&W.push(N(c("reservations.details.labels.duration","عدد الأيام"),D));const M=U("reservationInfo")?`<section class="quote-section quote-section--plain quote-section--reservation">
        <h3 class="quote-section__title">${g(c("reservations.quote.sections.reservation","تفاصيل الحجز"))}</h3>
        ${W.length?`<div class="info-plain">${W.join("")}</div>`:T}
      </section>`:"",ne=[];B("projectInfo","projectTitle")&&ne.push(N(c("reservations.details.labels.project","المشروع"),E)),B("projectInfo","projectCode")&&ne.push(N(c("reservations.details.labels.code","الرمز"),k||"-"));const Z=U("projectInfo")?`<section class="quote-section quote-section--plain">
        <h3 class="quote-section__title">${g(c("reservations.quote.sections.project","بيانات المشروع"))}</h3>
        ${ne.length?`<div class="info-plain">${ne.join("")}</div>`:T}
      </section>`:"",ae=[];ae.push(F(c("reservations.details.labels.subtotalBeforeTax","الإجمالي قبل الضريبة"),`${i.taxableAmount} ${d}`)),B("financialSummary","discountAmount")&&ae.push(F(c("reservations.details.labels.discount","الخصم"),`${i.discountAmount} ${d}`)),B("financialSummary","taxAmount")&&ae.push(F(c("reservations.details.labels.tax","الضريبة"),`${i.taxAmount} ${d}`));const me=B("financialSummary","finalTotal"),ue=[];me&&ue.push(F(c("reservations.details.labels.total","الإجمالي النهائي"),`${i.finalTotal} ${d}`,{variant:"final"}));const Ee=ue.length?`<div class="totals-final">${ue.join("")}</div>`:"",xe=U("financialSummary")?!ae.length&&!me?`<section class="quote-section quote-section--financial">${T}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${g(c("reservations.details.labels.summary","الملخص المالي"))}</h3>
            ${ae.length?`<div class="totals-inline">${ae.join("")}</div>`:""}
            ${Ee}
          </div>
        </section>`:"",{groups:K}=Dt(t),se=K.map(q=>{const re=Number(q?.count??q?.quantity??1)||1,pe=Number(q?.unitPrice);let Ce=Number.isFinite(pe)?pe:0;if(!Ce||Ce<=0){const ie=Number(q?.totalPrice);Number.isFinite(ie)&&re>0&&(Ce=Number((ie/re).toFixed(2)))}Number.isFinite(Ce)||(Ce=0);const et=q?.type==="package"||Array.isArray(q?.items)&&q.items.some(ie=>ie?.type==="package"),kt=Array.isArray(q?.barcodes)&&q.barcodes.length?q.barcodes[0]:Array.isArray(q?.items)&&q.items.length?q.items[0]?.barcode:null;let Ne=q?.packageDisplayCode??q?.package_code??q?.code??q?.packageCode??(Array.isArray(q?.items)&&q.items.length?q.items[0]?.package_code??q.items[0]?.code??q.items[0]?.packageCode:null);const be=ie=>{const he=(ie==null?"":String(ie)).trim();return!!(!he||/^pkg-/i.test(he)||/^\d+$/.test(he)&&he.length<=4)};if(!Ne||be(Ne)){const ie=q?.packageId??q?.package_id??(Array.isArray(q?.items)&&q.items.length?q.items[0]?.packageId??q.items[0]?.package_id:null);if(ie)try{const he=ma(ie);he&&he.package_code&&(Ne=he.package_code)}catch{}}if(!Ne||be(Ne))try{const ie=xt(q?.description||"");if(ie){const he=vs();let He=he.find(Ue=>xt(Ue?.name||Ue?.title||Ue?.label||"")===ie);He||(He=he.find(Ue=>{const _a=xt(Ue?.name||Ue?.title||Ue?.label||"");return _a.includes(ie)||ie.includes(_a)})),He&&He.package_code&&(Ne=He.package_code)}}catch{}const $e=et?Ne??kt??"":q?.barcode??kt??"",le=$e!=null?String($e):"";let de=Number.isFinite(Number(q?.totalPrice))?Number(q.totalPrice):Number((Ce*re).toFixed(2));return de=vt(de),{...q,isPackage:et,desc:q?.description,barcode:le,packageCodeResolved:Ne||"",qty:re,price:de,totalPrice:de,unitPriceValue:Ce}}),_e=qn.filter(q=>B("items",q.id)),qe=(()=>{let q=[];_e.forEach(be=>{be.id==="price"?q.push({...be,render:$e=>{const le=Number.isFinite(Number($e?.unitPriceValue))?Number($e.unitPriceValue):0,de=Number.isFinite(Number($e?.qty))?Math.max(1,Number($e.qty)):1,ie=Math.max(1,Number(I?.rentalDays||1)),he=le*de*ie;return g(`${Se(he)} ${c("reservations.create.summary.currency","SR")}`)}}):be.id==="unitPrice"?q.push({...be,render:$e=>{const le=Number.isFinite(Number($e?.unitPriceValue))?Number($e.unitPriceValue):0;return g(`${Se(le)} ${c("reservations.create.summary.currency","SR")}`)}}):q.push(be)});const re=Math.max(1,Number(I?.rentalDays||1)),pe=q.findIndex(be=>be.id==="price"),Ce=Math.max(0,pe);q.splice(Ce,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>g(A(String(re)))});const et=new Map(q.map(be=>[be.id,be])),kt=q.filter(be=>!["unitPrice","quantity","days","price"].includes(be.id)),Ne=["unitPrice","quantity","days","price"].map(be=>et.get(be)).filter(Boolean);return q=[...kt,...Ne],q})(),Fe=qe.length>0,Ie=Fe?qe.map(q=>`<th>${g(q.labelKey?c(q.labelKey,q.fallback):q.fallback)}</th>`).join(""):"",Ae=se.length>0?se.map((q,re)=>`<tr>${qe.map(pe=>`<td><div class="quote-cell">${pe.render(q,re)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(qe.length,1)}" class="empty">${g(c("reservations.details.noItems","📦 لا توجد معدات ضمن هذا الحجز حالياً."))}</td></tr>`,Le=U("items")?Fe?`<section class="quote-section quote-section--table">
            <h3>${g(c("reservations.details.items.title","المعدات"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Ie}</tr>
              </thead>
              <tbody>${Ae}</tbody>
            </table>
            ${B("items","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${g(c("reservations.details.labels.equipmentTotal","إجمالي المعدات"))}</span>
                  <span class="quote-table-subtotal__value">${g(`${i.equipmentTotal} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${g(c("reservations.details.items.title","المعدات"))}</h3>
            ${T}
          </section>`:"",je=In.filter(q=>B("crew",q.id)),Me=B("crew","groupByPosition"),b=je.length>0,z=Array.isArray(s)?s:[],S=q=>{const re=q&&q.positionId!=null?`id:${String(q.positionId)}`:(()=>{const et=(q?.positionLabel||q?.position_name||q?.position||"").trim().toLowerCase();return et?`label:${et}`:""})(),pe=Number.isFinite(Number(q?.positionClientPrice))?Number(q.positionClientPrice):0,Ce=pe>0?`|p:${pe.toFixed(2)}`:"";return`${re}${Ce}`},V=(()=>{const q=new Map;return z.forEach(re=>{const pe=S(re);pe&&q.set(pe,(q.get(pe)||0)+1)}),q})(),C=(()=>{let q=[],re=null;je.forEach(le=>{le.id==="position"?(q.push({...le,render:de=>{const ie=de?.positionLabel??de?.position_name??de?.role??c("reservations.crew.positionFallback","منصب بدون اسم");if(Me)return g(A(String(ie)));const he=S(de),He=he&&V.get(he)||0,Ue=He>1?` × ${A(String(He))}`:"";return g(A(String(ie))+Ue)}}),re={id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:de=>{const ie=Number(de?.__count||1);return g(A(String(Math.max(1,ie))))}}):le.id==="price"?Me?q.push({...le,render:de=>{const ie=Number.isFinite(Number(de?.positionClientPrice))?Number(de.positionClientPrice):0,he=Math.max(1,Number(de?.__count||1)),He=Math.max(1,Number(I?.rentalDays||1)),Ue=ie*he*He;return g(`${Se(Ue)} ${c("reservations.create.summary.currency","SR")}`)}}):q.push({...le,render:de=>{const ie=Number.isFinite(Number(de?.positionClientPrice))?Number(de.positionClientPrice):0,he=Math.max(1,Number(I?.rentalDays||1)),He=ie*he;return g(`${Se(He)} ${c("reservations.create.summary.currency","SR")}`)}}):le.id==="unitPrice"?q.push({...le,render:de=>{const ie=Number.isFinite(Number(de?.positionClientPrice))?Number(de.positionClientPrice):0;return g(`${Se(ie)} ${c("reservations.create.summary.currency","SR")}`)}}):q.push(le)}),re&&q.push(re);const pe=Math.max(1,Number(I?.rentalDays||1)),Ce=q.findIndex(le=>le.id==="price"),et=Math.max(0,Ce);q.splice(et,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>g(A(String(pe)))});const kt=new Map(q.map(le=>[le.id,le])),Ne=new Set,be=[],$e=le=>{const de=kt.get(le);de&&!Ne.has(le)&&(be.push(de),Ne.add(le))};return $e("rowNumber"),$e("position"),$e("unitPrice"),$e("quantity"),$e("days"),$e("price"),q.forEach(le=>{Ne.has(le.id)||(be.push(le),Ne.add(le.id))}),q=be,q})(),O=b?C.map(q=>`<th>${g(q.labelKey?c(q.labelKey,q.fallback):q.fallback)}</th>`).join(""):"",X=Me?(()=>{const q=new Map;return z.forEach(re=>{const pe=S(re);if(!pe)return;const Ce=q.get(pe);Ce?Ce.__count+=1:q.set(pe,{...re,__count:1})}),Array.from(q.values())})():z,te=X.length?X.map((q,re)=>`<tr>${C.map(pe=>`<td><div class="quote-cell">${pe.render(q,re)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(C.length,1)}" class="empty">${g(c("reservations.details.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز."))}</td></tr>`,ke=U("crew")?b?`<section class="quote-section quote-section--table">
            <h3>${g(c("reservations.details.technicians.title","طاقم العمل"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${O}</tr>
              </thead>
              <tbody>${te}</tbody>
            </table>
            ${B("crew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${g(c("reservations.details.labels.crewTotal","إجمالي الفريق"))}</span>
                  <span class="quote-table-subtotal__value">${g(`${i.crewTotal} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${g(c("reservations.details.technicians.title","طاقم العمل"))}</h3>
            ${T}
          </section>`:"",Te=U("notes")?`<section class="quote-section">
        <h3>${g(c("reservations.details.labels.notes","ملاحظات الحجز"))}</h3>
        <div class="quote-notes">${g(L||c("reservations.quote.emptyNotes","لا توجد ملاحظات إضافية."))}</div>
      </section>`:"",ye=[];B("payment","beneficiary")&&ye.push(Y(c("reservations.quote.labels.beneficiary","اسم المستفيد"),Pe.beneficiaryName)),B("payment","bank")&&ye.push(Y(c("reservations.quote.labels.bank","اسم البنك"),Pe.bankName)),B("payment","account")&&ye.push(Y(c("reservations.quote.labels.account","رقم الحساب"),A(Pe.accountNumber))),B("payment","iban")&&ye.push(Y(c("reservations.quote.labels.iban","رقم الآيبان"),A(Pe.iban)));const ft=`<section class="quote-section">
      <div class="payment-block">
        <h3>${g(c("reservations.quote.sections.payment","بيانات الدفع"))}</h3>
        <div class="payment-rows">${ye.length?ye.join(""):T}</div>
      </div>
      <p class="quote-approval-note">${g(Pe.approvalNote)}</p>
    </section>`,At=`<footer class="quote-footer">
        <h4>${g(c("reservations.quote.labels.terms","الشروط العامة"))}</h4>
        <ul>${J.map(q=>`<li>${g(q)}</li>`).join("")}</ul>
      </footer>`,Ge=[];R&&M?Ge.push(ve(`<div class="quote-section-row">${R}${M}</div>`,{blockType:"group"})):(M&&Ge.push(ve(M)),R&&Ge.push(ve(R))),Z&&Ge.push(ve(Z));const Rt=[];Le&&Rt.push(ve(Le,{blockType:"table",extraAttributes:'data-table-id="items"'})),ke&&Rt.push(ve(ke,{blockType:"table",extraAttributes:'data-table-id="crew"'}));const ge=[];xe&&ge.push(ve(xe,{blockType:"summary"})),Te&&ge.push(ve(Te));const Be=[ve(ft,{blockType:"payment"}),ve(At,{blockType:"footer"})],yt=[...yn(Ge,"reservations.quote.placeholder.page1"),...Rt,...yn(ge,"reservations.quote.placeholder.page2"),...Be],Ze=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${g(Pe.logoUrl)}" alt="${g(Pe.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${g(c("reservations.quote.title","عرض السعر"))}</h1>
        <p class="quote-company-name">${g(Pe.companyName)}</p>
        <p class="quote-company-cr">${g(c("reservations.quote.labels.cr","السجل التجاري"))}: ${g(Pe.commercialRegistry)}</p>
        <p class="quote-company-license">ترخيص إعلامي: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>رقم العرض</span>
          <strong>${g(y)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>التاريخ</span>
          <strong>${g(f)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
      <style>${tr}${er}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${Ze}
          ${yt.join("")}
        </div>
      </div>
    </div>
  `}async function Er(){try{const e=fe();if((Array.isArray(e?.packages)?e.packages:[]).length>0)return;const n=await zr("/packages/?all=1"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];a.length&&(Vr({packages:a}),document.dispatchEvent?.(new CustomEvent("packages:changed",{detail:{packages:a}})))}catch{}}function Zo(e){return e?e.complete?e.naturalHeight===0?Promise.reject(new Error(`image failed to load: ${e.src||"unknown"}`)):Promise.resolve():new Promise((t,n)=>{const a=()=>{r(),t()},s=()=>{r(),n(new Error(`image failed to load: ${e.src||"unknown"}`))},r=()=>{e.removeEventListener("load",a),e.removeEventListener("error",s)};e.addEventListener("load",a,{once:!0}),e.addEventListener("error",s,{once:!0})}):Promise.resolve()}async function Wt(e){if(!e)return;const t=e.ownerDocument||document,n=t.defaultView||window,a=Array.from(e.querySelectorAll?.("img")||[]),s=t.fonts?.ready?t.fonts.ready:Promise.resolve(),r=a.map(o=>Zo(o)),i=[s,...r].map(o=>o.catch(d=>(nt("asset load failed",d),fo(),null)));await Promise.all(i),await new Promise(o=>n.requestAnimationFrame(()=>o()))}async function bn(e,{context:t="preview"}={}){if(!e)return;const n=t==="preview",a=e.ownerDocument||document;e.setAttribute("data-quote-render-context",t);const s=e.querySelector("[data-quote-pages]"),r=e.querySelector("[data-quote-source]"),i=r?.querySelector("[data-quote-header-template]");if(!s||!r||!i)return;s.style.display="block",s.style.margin="0",s.style.padding="0",s.style.gap="0px",s.style.rowGap="0px",s.style.columnGap="0px",s.style.alignItems="stretch",s.style.justifyContent="flex-start",await pr(r),await Wt(r),s.innerHTML="";const o=Array.from(r.querySelectorAll(":scope > [data-quote-block]"));let d=null,u=null;const l=E=>{E.style.margin="0 auto",E.style.breakInside="avoid",E.style.pageBreakInside="avoid",E.style.pageBreakAfter="auto",E.style.breakAfter="auto"},y=()=>{const E=a.createElement("div"),k=s.childElementCount===0;if(E.className="quote-page",E.dataset.pageIndex=String(s.childElementCount),k){E.classList.add("quote-page--primary");const L=i.cloneNode(!0);L.removeAttribute("data-quote-header-template"),E.appendChild(L)}else E.classList.add("quote-page--continuation");const D=a.createElement("main");D.className="quote-body",E.appendChild(D),s.appendChild(E),l(E),d=E,u=D},f=()=>{(!d||!u||!u.isConnected)&&y()},m=()=>{if(!d||!u||u.childElementCount>0)return;const E=d;d=null,u=null,E.parentNode&&E.parentNode.removeChild(E)},p=()=>{d=null,u=null},h=()=>d?d.scrollHeight-d.clientHeight>or:!1,w=(E,{allowOverflow:k=!1}={})=>(f(),u.appendChild(E),h()&&!k?(u.removeChild(E),m(),!1):!0),j=E=>{const k=E.cloneNode(!0);k.removeAttribute?.("data-quote-block"),k.removeAttribute?.("data-block-type"),k.removeAttribute?.("data-table-id"),!w(k)&&(p(),!w(k)&&w(k,{allowOverflow:!0}))},v=E=>{const k=E.querySelector("table");if(!k){j(E);return}const D=E.querySelector("h3"),L=k.querySelector("thead"),J=Array.from(k.querySelectorAll("tbody tr"));if(!J.length){j(E);return}let $=null,B=0;const U=(N=!1)=>{const F=E.cloneNode(!1);F.removeAttribute("data-quote-block"),F.removeAttribute("data-block-type"),F.removeAttribute("data-table-id"),F.classList.add("quote-section--table-fragment"),N&&F.classList.add("quote-section--table-fragment--continued");const Y=D?D.cloneNode(!0):null;Y&&F.appendChild(Y);const G=k.cloneNode(!1);G.classList.add("quote-table--fragment"),L&&G.appendChild(L.cloneNode(!0));const R=a.createElement("tbody");return G.appendChild(R),F.appendChild(G),{section:F,body:R}},T=(N=!1)=>$||($=U(N),w($.section)||(p(),w($.section)||w($.section,{allowOverflow:!0})),$);J.forEach(N=>{T(B>0);const F=N.cloneNode(!0);if($.body.appendChild(F),h()&&($.body.removeChild(F),$.body.childElementCount||(u.removeChild($.section),$=null,m()),p(),$=null,T(B>0),$.body.appendChild(F),h())){$.section.classList.add("quote-section--table-fragment--overflow"),B+=1;return}B+=1}),$=null;try{const N=E.querySelector(":scope > .quote-table-subtotal");N&&j(N)}catch{}};if(!o.length)return;o.forEach(E=>{E.getAttribute("data-block-type")==="table"?v(E):j(E)});const _=Array.from(s.children),P=[];if(_.forEach((E,k)=>{const D=E.querySelector(".quote-body");if(k!==0&&(!D||D.childElementCount===0)){E.remove();return}P.push(E)}),!n){const E=a.defaultView||window,k=Math.min(3,Math.max(1,E.devicePixelRatio||1)),D=xn()?Math.min(2,k):k;P.forEach(L=>jo(L,{pixelRatio:D}))}P.forEach((E,k)=>{const D=k===0;E.style.pageBreakAfter="auto",E.style.breakAfter="auto",E.style.pageBreakBefore=D?"auto":"always",E.style.breakBefore=D?"auto":"page",n?E.style.boxShadow="":E.style.boxShadow="none"});const H=P[P.length-1]||null;d=H,u=H?.querySelector(".quote-body")||null,await Wt(s),n&&(s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="flex-start",s.style.rowGap="18px",s.style.columnGap="0px",s.style.gap="18px")}function qr(e=0){return e<=0?new Promise(t=>requestAnimationFrame(()=>t())):new Promise(t=>setTimeout(t,e))}function Ir(e){return e?Array.from(e.querySelectorAll(".quote-page")).some(n=>n.scrollHeight-n.clientHeight>or):!1}function Pa(e,t="#000000"){if(!e)return;e.querySelectorAll('[style*="color"], [class*="text"], h1, h2, h3, h4, h5, h6, p, span, th, td, li, strong, em, label, dt, dd, caption, div').forEach(a=>{a instanceof HTMLElement&&a.style.setProperty("color",t,"important")})}async function ec(e,{filename:t,safariWindowRef:n=null,mobileWindowRef:a=null}){if(!e)return;const s=Array.from(e.querySelectorAll(".quote-page"));if(!s.length)throw new Error("لا توجد صفحات لتصديرها.");const[r,i]=await Promise.all([_o(),Co()]),o=e.ownerDocument||document,d=o?.defaultView?.getComputedStyle?.(e)?.direction,l=[e.getAttribute?.("dir"),e.style?.direction,d,o?.documentElement?.getAttribute?.("dir")].some(E=>typeof E=="string"&&E.toLowerCase().startsWith("rtl")),y=typeof window<"u"&&window.devicePixelRatio||1,f=Ia(),m=lr(),p=xn();let h;p?h=1.5:m?h=Math.min(1.7,Math.max(1.2,y*1.1)):f?h=Math.min(1.8,Math.max(1.25,y*1.2)):h=Math.min(2,Math.max(1.6,y*1.4));const w=p||m?.9:f?.92:.95,j=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),v={scale:h,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!l,removeContainer:!1,logging:!0};let _=0;const P=c("reservations.quote.errors.browserLimit","تعذر إتمام عملية التحويل بسبب قيود المتصفح، يرجى إعادة المحاولة أو تقليل حجم المحتوى.");try{for(let E=0;E<s.length;E+=1){const k=s[E];await pr(k),await Wt(k);const D=k.ownerDocument||document,L=D.createElement("div");Object.assign(L.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const J=k.cloneNode(!0);J.style.width=`${nn}px`,J.style.maxWidth=`${nn}px`,J.style.minWidth=`${nn}px`,J.style.height=`${an}px`,J.style.maxHeight=`${an}px`,J.style.minHeight=`${an}px`,J.style.position="relative",J.style.background="#ffffff",Pa(J),L.appendChild(J),D.body.appendChild(L);let $;try{await Wt(J),$=await i(J,{...v,scale:h,backgroundColor:"#ffffff",scrollX:0,scrollY:0})}catch(R){throw Xn(R,"pageCapture",{toastMessage:P}),R}finally{L.parentNode?.removeChild(L)}if(!$)continue;const B=$.width||1,T=($.height||1)/B;let N=Gn,F=N*T,Y=0;if(F>tn){const R=tn/F;F=tn,N=N*R,Y=Math.max(0,(Gn-N)/2)}const G=$.toDataURL("image/jpeg",w);_>0&&j.addPage(),j.addImage(G,"JPEG",Y,0,N,F,`page-${_+1}`,"FAST"),_+=1,await new Promise(R=>window.requestAnimationFrame(R))}}catch(E){throw Yn({safariWindowRef:n,mobileWindowRef:a}),E}if(_===0)throw Yn({safariWindowRef:n,mobileWindowRef:a}),new Error("PDF generation produced no pages.");if(m||p){const E=j.output("blob");if(p){const k=URL.createObjectURL(E);Ut();try{window.location.assign(k)}catch(D){nt("mobile safari blob navigation failed",D)}finally{setTimeout(()=>URL.revokeObjectURL(k),6e4)}}else{const k=URL.createObjectURL(E),D=()=>m&&n&&!n.closed?n:a&&!a.closed?a:null,L=($,B)=>{if(Ut(),!$){window.location.assign(B);return}try{$.location.replace(B),$.focus?.()}catch(U){nt("direct blob navigation failed",U);try{$.document.open(),$.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${g(c("reservations.quote.actions.export","تنزيل PDF"))}</title><style>html,body{margin:0;height:100%;background:#0f172a;color:#f8fafc;font-family:'Tajawal',sans-serif;} iframe{border:none;width:100%;height:100%;display:block;}</style></head><body><iframe src="${B}" title="PDF preview"></iframe></body></html>`),$.document.close()}catch(T){nt("iframe blob delivery failed",T),window.location.assign(B)}}},J=D();L(J,k),setTimeout(()=>URL.revokeObjectURL(k),6e4)}}else{Ut();const E=j.output("bloburl"),k=document.createElement("a");k.href=E,k.download=t,k.rel="noopener",k.style.display="none",document.body.appendChild(k),k.click(),setTimeout(()=>{URL.revokeObjectURL(E),k.remove()},2e3)}}function dt(){if(!I||!Q)return;const{previewFrame:e}=Q;if(!e)return;const t=I.context||"reservation",n=wr({context:t,reservation:I.reservation,customer:I.customer,project:I.project,crewAssignments:I.crewAssignments,totals:I.totals,totalsDisplay:I.totalsDisplay,rentalDays:I.rentalDays,currencyLabel:I.currencyLabel,sections:I.sections,fieldSelections:I.fields,quoteNumber:I.quoteNumber,quoteDate:I.quoteDateLabel,terms:I.terms,projectCrew:I.projectCrew,projectExpenses:I.projectExpenses,projectEquipment:I.projectEquipment,projectInfo:I.projectInfo,clientInfo:I.clientInfo,paymentSummary:I.paymentSummary,projectTotals:I.projectTotals});ht("render"),e.srcdoc=`<!DOCTYPE html>${n}`,e.addEventListener("load",async()=>{try{const a=e.contentDocument,s=a?.defaultView||window,r=a?.documentElement||a;r&&(qs(r),Is(r,s),As(r,s));const i=a?.getElementById("quotation-pdf-root");try{i&&(await bn(i,{context:"preview"}),await qr(120),Ir(i)&&await bn(i,{context:"preview"}),Pa(i))}catch(m){console.error("[reservations/pdf] failed to layout preview document",m)}const o=Array.from(a?.querySelectorAll?.(".quote-page")||[]),d=a?.querySelector(".quote-preview-pages"),u=nn;let l=18;if(d&&a?.defaultView){const m=a.defaultView.getComputedStyle(d),p=parseFloat(m.rowGap||m.gap||`${l}`);Number.isFinite(p)&&p>=0&&(l=p)}const y=an,f=o.length?o.length*y+Math.max(0,(o.length-1)*l):y;if(e.dataset.baseWidth=String(u),e.dataset.baseHeight=String(f),e.style.width=`${u}px`,e.style.minWidth=`${u}px`,e.style.height=`${f}px`,e.style.minHeight=`${f}px`,Q?.previewFrameWrapper&&!Q?.userAdjustedZoom){const m=Q.previewFrameWrapper.clientWidth-24;m>0&&m<u?Je=Math.max(m/u,.3):Je=1}kr(Je)}finally{Ut()}},{once:!0})}function tc(e){if(!I)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(t.checked?I.sections.add(n):I.sections.delete(n),br(I),Ar(),dt())}function nc(e){if(!I)return;const t=e.currentTarget,n=t?.dataset?.sectionId,a=t?.dataset?.fieldId;if(!n||!a)return;const s=I.context||"reservation",r=I.fields||(I.fields=Pn(s)),i=yo(r,n);t.checked?i.add(a):i.delete(a),br(I),dt()}function ac(e){if(!I)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(qa(I,n),I.sectionExpansions[n]=t.open)}function Ar(){if(!Q?.toggles||!I)return;const{toggles:e}=Q,t=I.fields||{},n=I.context||"reservation";qa(I);const a=kn(n),s=Js(n),r=a.map(({id:i,labelKey:o,fallback:d})=>{const u=c(o,d),l=I.sections.has(i),y=s[i]||[],f=bo(I,i),m=y.length?`<div class="quote-toggle-sublist">
          ${y.map(p=>{const h=wa(t,i,p.id),w=l?"":"disabled",j=p.labelKey?c(p.labelKey,p.fallback):p.fallback;return`
              <label class="quote-toggle quote-toggle--field">
                <input type="checkbox" data-field-toggle data-section-id="${i}" data-field-id="${p.id}" ${h?"checked":""} ${w}>
                <span>${g(j)}</span>
              </label>
            `}).join("")}
        </div>`:"";return`
      <details class="quote-toggle-group" data-section-group data-section-id="${i}" ${f?"open":""}>
        <summary class="quote-toggle-summary">
          <label class="quote-toggle quote-toggle--section">
            <input type="checkbox" data-section-toggle data-section-id="${i}" ${l?"checked":""}>
            <span>${g(u)}</span>
          </label>
          ${y.length?'<span class="quote-toggle-caret" aria-hidden="true"></span>':""}
        </summary>
        ${m}
      </details>
    `}).join("");e.innerHTML=r,e.querySelectorAll("input[data-section-toggle]").forEach(i=>{i.addEventListener("change",tc)}),e.querySelectorAll("input[data-field-toggle]").forEach(i=>{i.addEventListener("change",nc)}),e.querySelectorAll("details[data-section-group]").forEach(i=>{i.addEventListener("toggle",ac)})}function sc(){if(Q?.modal)return Q;const e=document.createElement("div");e.id="reservationQuoteModal",e.className="modal fade quote-preview-modal",e.tabIndex=-1,e.setAttribute("aria-labelledby","reservationQuoteModalLabel"),e.setAttribute("aria-hidden","true"),e.style.display="none",e.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationQuoteModalLabel">${g(c("reservations.quote.previewTitle","معاينة عرض السعر"))}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="quote-preview-layout">
            <aside class="quote-preview-sidebar">
              <h6>${g(c("reservations.quote.toggleHeading","حدد المعلومات المراد تصديرها"))}</h6>
              <div class="quote-toggle-list" data-quote-toggles></div>
              <div class="quote-meta-info" data-quote-meta></div>
              <div class="quote-terms-editor" data-quote-terms-editor>
                <label class="quote-terms-editor__label" for="quote-terms-input">${g(c("reservations.quote.termsEditor.title","الشروط العامة (قابلة للتعديل)"))}</label>
                <textarea id="quote-terms-input" class="quote-terms-editor__textarea" rows="6" data-quote-terms-input placeholder="${g(c("reservations.quote.termsEditor.placeholder","اكتب كل شرط في سطر مستقل"))}"></textarea>
                <button type="button" class="quote-terms-reset" data-quote-terms-reset>${g(c("reservations.quote.termsEditor.reset","استعادة الشروط الافتراضية"))}</button>
              </div>
            </aside>
            <section class="quote-preview-panel">
              <div class="quote-preview" data-quote-preview></div>
            </section>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">${g(c("reservations.quote.actions.close","إغلاق"))}</button>
          <button type="button" class="btn btn-primary" data-quote-download>
            ${g(c("reservations.quote.actions.export","📄 تنزيل PDF"))}
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector("[data-quote-toggles]"),n=e.querySelector("[data-quote-preview]"),a=e.querySelector("[data-quote-meta]"),s=e.querySelector("[data-quote-terms-input]"),r=e.querySelector("[data-quote-terms-reset]"),i=e.querySelector("[data-quote-download]"),o=e.querySelector(".modal-header"),d=o?.querySelector(".btn-close"),u=Array.from(e.querySelectorAll('[data-bs-dismiss="modal"]')),l=document.createElement("div");l.className="quote-preview-header-actions",o&&o.insertBefore(l,d||null);const y=document.createElement("iframe");y.className="quote-preview-frame",y.setAttribute("title",c("reservations.quote.previewTitle","معاينة عرض السعر")),y.setAttribute("loading","lazy"),y.setAttribute("frameborder","0");const f=document.createElement("div");f.className="quote-preview-zoom-controls",f.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-zoom-out title="${g(c("reservations.quote.zoom.out","تصغير"))}">−</button>
    <span class="quote-preview-zoom-value" data-zoom-value>100%</span>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-in title="${g(c("reservations.quote.zoom.in","تكبير"))}">+</button>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-reset title="${g(c("reservations.quote.zoom.reset","إعادة الضبط"))}">1:1</button>
  `;const m=document.createElement("div");m.className="quote-preview-frame-wrapper",m.appendChild(y),n.innerHTML="";const p=document.createElement("div");p.className="quote-preview-scroll",p.appendChild(m),n.appendChild(p);const h=document.createElement("div");h.className="quote-preview-status",h.setAttribute("role","status"),h.setAttribute("aria-live","polite"),h.hidden=!0,h.innerHTML=`
    <span class="quote-preview-spinner" data-quote-status-spinner aria-hidden="true"></span>
    <span data-quote-status-text>${g(Zs("render"))}</span>
    <button type="button" class="quote-preview-status-action" data-quote-status-action hidden></button>
  `,n.appendChild(h),l.appendChild(f),i?.addEventListener("click",async()=>{if(I){i.disabled=!0;try{await xr()}finally{i.disabled=!1}}});const w=()=>{Wn()||Jn(e)};u.forEach(P=>{P?.addEventListener("click",w)}),d&&!u.includes(d)&&d.addEventListener("click",w),e.addEventListener("click",P=>{Wn()||P.target===e&&Jn(e)}),Q={modal:e,toggles:t,preview:n,previewScroll:p,previewFrameWrapper:m,zoomControls:f,zoomValue:f.querySelector("[data-zoom-value]"),previewFrame:y,meta:a,downloadBtn:i,statusIndicator:h,statusText:h.querySelector("[data-quote-status-text]"),statusSpinner:h.querySelector("[data-quote-status-spinner]"),statusAction:h.querySelector("[data-quote-status-action]"),termsInput:s,termsReset:r,statusKind:null,userAdjustedZoom:!1};const j=f.querySelector("[data-zoom-out]"),v=f.querySelector("[data-zoom-in]"),_=f.querySelector("[data-zoom-reset]");return j?.addEventListener("click",()=>es(-.1)),v?.addEventListener("click",()=>es(.1)),_?.addEventListener("click",()=>hn(1,{markManual:!0})),s&&s.addEventListener("input",rc),r&&r.addEventListener("click",ic),hn(Je),Q}function hn(e,{silent:t=!1,markManual:n=!1}={}){Je=Math.min(Math.max(e,.25),2.2),n&&Q&&(Q.userAdjustedZoom=!0),kr(Je),!t&&Q?.zoomValue&&(Q.zoomValue.textContent=`${Math.round(Je*100)}%`)}function es(e){hn(Je+e,{markManual:!0})}function kr(e){if(!Q?.previewFrame||!Q.previewFrameWrapper)return;const t=Q.previewFrame,n=Q.previewFrameWrapper,a=Number(t.dataset.baseWidth)||794,s=Number(t.dataset.baseHeight)||t.contentDocument?.body?.scrollHeight||1123;t.style.transform=`scale(${e})`,t.style.transformOrigin="top center",Ia()?(n.style.width="100%",n.style.maxWidth="100%",n.style.minWidth="0"):(n.style.width=`${a}px`,n.style.maxWidth=`${a}px`,n.style.minWidth=`${a}px`),n.style.minHeight=`${s}px`,n.style.height=`${s}px`}function Pr(){if(!Q?.meta||!I)return;const{meta:e}=Q;e.innerHTML=`
    <div class="quote-meta-card">
      <div><span>${g(c("reservations.quote.labels.number","رقم عرض السعر"))}</span><strong>${g(I.quoteNumber)}</strong></div>
      <div><span>${g(c("reservations.quote.labels.dateGregorian","التاريخ الميلادي"))}</span><strong>${g(I.quoteDateLabel)}</strong></div>
    </div>
  `}function xa(){if(!Q?.termsInput)return;const e=(I?.terms&&I.terms.length?I.terms:Re).join(`
`);Q.termsInput.value!==e&&(Q.termsInput.value=e)}function rc(e){if(!I)return;const t=Kn(e?.target?.value??"");if(t.length){I.terms=t;const n=document.getElementById("reservation-terms");n&&(n.value=e.target.value);const a=document.getElementById("edit-res-terms");a&&(a.value=e.target.value)}else{I.terms=[...Re],xa();const n=Re.join(`
`),a=document.getElementById("reservation-terms");a&&(a.value=n);const s=document.getElementById("edit-res-terms");s&&(s.value=n)}dt()}function ic(e){if(e?.preventDefault?.(),!I)return;I.terms=[...Re];const t=document.getElementById("reservation-terms");t&&(t.value=Re.join(`
`));const n=document.getElementById("edit-res-terms");n&&(n.value=Re.join(`
`)),xa(),dt()}async function xr(){if(!I)return;ht("export");const t=!Ia()&&lr(),n=xn(),a=null,s=!n&&t?window.open("","_blank"):null;(d=>{if(d)try{d.document.open(),d.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${g(c("reservations.quote.status.exporting","جاري تجهيز ملف PDF..."))}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${g(c("reservations.quote.status.exporting","جاري تجهيز ملف PDF..."))}</h1><p>${g(c("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار..."))}</p></div></body></html>`),d.document.close()}catch(u){nt("failed to prime download window",u)}})(s);let i=null;const o=c("reservations.quote.errors.browserLimit","تعذر إتمام عملية التحويل بسبب قيود المتصفح، يرجى إعادة المحاولة أو تقليل حجم المحتوى.");try{await To(),Tn("html2pdf ensured");const d=I.context||"reservation",u=wr({context:d,reservation:I.reservation,customer:I.customer,project:I.project,crewAssignments:I.crewAssignments,totals:I.totals,totalsDisplay:I.totalsDisplay,rentalDays:I.rentalDays,currencyLabel:I.currencyLabel,sections:I.sections,fieldSelections:I.fields,quoteNumber:I.quoteNumber,quoteDate:I.quoteDateLabel,terms:I.terms,projectCrew:I.projectCrew,projectExpenses:I.projectExpenses,projectEquipment:I.projectEquipment,projectInfo:I.projectInfo,clientInfo:I.clientInfo,paymentSummary:I.paymentSummary,projectTotals:I.projectTotals});i=document.createElement("div"),i.innerHTML=u,Object.assign(i.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(i),qs(i),Is(i),As(i),Tn("export container prepared");const l=i.firstElementChild;if(l){l.setAttribute("dir","rtl"),l.style.direction="rtl",l.style.textAlign="right",l.setAttribute("data-theme","light"),l.classList.remove("dark","dark-mode"),l.style.margin="0",l.style.padding="0",l.style.width="210mm",l.style.maxWidth="210mm",l.style.marginLeft="auto",l.style.marginRight="auto",l.scrollTop=0,l.scrollLeft=0;try{await bn(l,{context:"export"}),await qr(120),Ir(l)&&await bn(l,{context:"export"}),await Wt(l),Pa(l),Tn("layout complete for export document")}catch(f){Xn(f,"layoutQuoteDocument",{suppressToast:!0})}}const y=`quotation-${I.quoteNumber}.pdf`;await ec(l,{filename:y,safariWindowRef:s,mobileWindowRef:a}),I.sequenceCommitted||(Do(I.quoteSequence),I.sequenceCommitted=!0)}catch(d){Yn({container:i,safariWindowRef:s,mobileWindowRef:a}),i=null,Xn(d,"exportQuoteAsPdf",{toastMessage:o})}finally{i&&i.parentNode&&i.parentNode.removeChild(i),Ut()}}function $r(){const e=sc();e?.modal&&(Kt=!1,Je=1,Q&&(Q.userAdjustedZoom=!1),hn(Je,{silent:!0}),Ar(),Pr(),xa(),dt(),po(e.modal))}async function oc({reservation:e,customer:t,project:n}){if(!e){x(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز"));return}await Er();const a=ka(e),{totalsDisplay:s,totals:r,rentalDays:i}=vr(e,a,n),o=c("reservations.create.summary.currency","SR"),{sequence:d,quoteNumber:u}=fr("reservation"),l=new Date,y=to();I={context:"reservation",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:i,currencyLabel:o,projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(kn("reservation").filter(f=>f.defaultSelected).map(f=>f.id)),sectionExpansions:Ea("reservation"),fields:Pn("reservation"),terms:y,quoteSequence:d,quoteNumber:u,quoteDate:l,quoteDateLabel:gr(l),sequenceCommitted:!1},hr(I),$r();try{rr()}catch{}}async function Gc({project:e}){if(!e){x(c("projects.toast.notFound","⚠️ تعذر العثور على بيانات المشروع"));return}await Er();let t=Za(e);const{project:n}=t;if(!n){x(c("projects.toast.notFound","⚠️ تعذر العثور على بيانات المشروع"));return}try{(!Array.isArray(t.equipmentItems)||t.equipmentItems.length===0)&&n?.id!=null&&(await ms({project_id:n.id}),t=Za(n))}catch(o){console.warn("[reservationPdf] refreshReservationsForProject failed, proceeding with snapshot/state",o)}const{sequence:a,quoteNumber:s}=fr("project"),r=new Date,i=[...eo];I={context:"project",reservation:null,customer:t.customer,project:n,technicians:t.crew||[],clientInfo:t.clientInfo,projectInfo:t.projectInfo,projectCrew:t.crew,projectExpenses:t.expenses,projectEquipment:t.equipment,equipmentItems:t.equipmentItems||[],crewAssignments:t.crewAssignments||[],totals:t.totals,projectTotals:t.projectTotals,totalsDisplay:t.totalsDisplay,rentalDays:t.projectDurationDays,currencyLabel:t.currencyLabel,sections:new Set(kn("project").filter(o=>o.defaultSelected).map(o=>o.id)),sectionExpansions:Ea("project"),fields:Pn("project"),terms:i,quoteSequence:a,quoteNumber:s,quoteDate:r,quoteDateLabel:gr(r),sequenceCommitted:!1,paymentSummary:t.paymentSummary,projectNotes:t.notes,paymentHistory:t.paymentHistory},hr(I),$r();try{rr()}catch{}}function cc({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a}={}){const s=Ct(),{reservations:r=[],customers:i=[],technicians:o=[],projects:d=[]}=fe(),u=r.map(v=>{const _=Ln(v);return{..._,id:v.id??_.id,reservationId:v.reservationId??v.reservation_id??_.reservationId,reservationCode:v.reservationCode??v.reservation_code??_.reservationCode}}),l=u,y=Array.isArray(s)?s:o||[],f=new Map((d||[]).map(v=>[String(v.id),v])),m=document.getElementById(e);if(!m){console.warn("⚠️ [reservations/renderers] container not found",e);return}if(!l||l.length===0){m.innerHTML=`<p>${c("reservations.list.empty","⚠️ لا توجد حجوزات بعد.")}</p>`;return}const p=t||yi(),h=new Map(i.map(v=>[String(v.id),v])),w=new Map(y.map(v=>[String(v.id),v])),j=Wi({reservations:u,filters:p,customersMap:h,techniciansMap:w,projectsMap:f});if(j.length===0){m.innerHTML=`<p>${c("reservations.list.noResults","🔍 لا توجد حجوزات مطابقة للبحث.")}</p>`;return}m.innerHTML=`<div class="reservations-grid">${Ji({entries:j,customersMap:h,techniciansMap:w,projectsMap:f})}</div>`,m.querySelectorAll('[data-action="details"]').forEach(v=>{const _=Number(v.dataset.reservationIndex);Number.isNaN(_)||v.addEventListener("click",()=>{typeof n=="function"&&n(_)})}),m.querySelectorAll('button[data-action="confirm"]').forEach(v=>{const _=Number(v.dataset.reservationIndex);Number.isNaN(_)||v.addEventListener("click",P=>{P.stopPropagation(),typeof a=="function"&&a(_,P)})})}function lc(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:s=[],customers:r=[],projects:i=[]}=fe(),o=s.map(h=>{const w=Ln(h);return{...w,id:h.id??w.id,reservationId:h.reservationId??h.reservation_id??w.reservationId,reservationCode:h.reservationCode??h.reservation_code??w.reservationCode}}),d=s[e];if(!d)return x(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const u=o[e]??Ln(d),l=r.find(h=>String(h.id)===String(d.customerId)),y=d.projectId?i.find(h=>String(h.id)===String(d.projectId)):null,f=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),p=()=>{const h=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},w=document.getElementById("reservation-details-edit-btn");w&&(w.onclick=()=>{h(),typeof t=="function"&&t(e,{reservation:d,customer:l,getEditContext:a})});const j=document.getElementById("reservation-details-delete-btn");j&&(j.onclick=()=>{h(),typeof n=="function"&&n(e,{reservation:d,customer:l})});const v=f?.querySelector('[data-action="open-project"]');v&&y&&v.addEventListener("click",()=>{h();const P=y?.id!=null?String(y.id):"",H=P?`projects.html?project=${encodeURIComponent(P)}`:"projects.html";window.location.href=H});const _=document.getElementById("reservation-details-export-btn");_&&(_.onclick=async P=>{P?.preventDefault?.(),P?.stopPropagation?.(),_.blur();try{await oc({reservation:d,customer:l,project:y})}catch(H){console.error("❌ [reservations] export to PDF failed",H),x(c("reservations.details.actions.exportFailed","⚠️ تعذر تصدير الحجز إلى PDF"),"error")}});try{const P=f?.querySelector("[data-tech-slider]");if(P){const H=P.querySelector("[data-slider-track]"),E=P.querySelector("[data-slider-prev]"),k=P.querySelector("[data-slider-next]");if(H&&(E||k)){const D=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",L=()=>{const B=H.querySelector(".reservation-technician-card"),U=B&&B.getBoundingClientRect().width||220,T=12,N=Math.max(1,Math.floor(H.clientWidth/(U+T)));return Math.max(U+T,Math.floor(N*(U+T)*.9))},J=()=>{const B=Math.max(0,H.scrollWidth-H.clientWidth-2),U=H.scrollLeft<=1,T=H.scrollLeft>=B;E&&(E.disabled=U),k&&(k.disabled=T)},$=B=>{const U=L()*B,T=D?-U:U;H.scrollBy({left:T,behavior:"smooth"})};E?.addEventListener("click",()=>$(-1)),k?.addEventListener("click",()=>$(1)),H.addEventListener("scroll",J,{passive:!0}),window.addEventListener("resize",J,{passive:!0}),setTimeout(J,0)}}}catch{}};if(f){const h=Ct()||[];f.innerHTML=Ta(u,l,h,e,y),p(),Ss().then(()=>{const w=Ct()||[];f.innerHTML=Ta(u,l,w,e,y),p()}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function Ft(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Gt(e,n),end:Gt(t,a)}}function gn(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function $a(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function jr(){const{container:e,select:t,hint:n,addButton:a}=$a();if(!t)return;const s=t.value,r=ps(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","اختر الحزمة")}</option>`,d=r.map(l=>{const y=Number.isFinite(Number(l.price))?Number(l.price):0,f=A(y.toFixed(2)),m=`${l.name} — ${f} ${i}`;return`<option value="${gn(l.id)}">${gn(m)}</option>`}).join("");t.innerHTML=`${o}${d}`;const u=r.length>0;t.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),n&&(u?(n.textContent=c("reservations.create.packages.hint","حدد الحزمة ثم اضغط على الزر لإضافتها للحجز."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","لا توجد حزم معرفة حالياً. يمكنك إضافتها لاحقاً من لوحة التحكم."),n.dataset.state="empty")),u&&s&&r.some(l=>l.id===s)?t.value=s:t.selectedIndex=0}function dc(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||x(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),{success:!1,reason:"invalid"};const{index:a,items:s=[]}=mt(),{start:r,end:i}=Ft(),{reservations:o=[]}=fe(),d=a!=null&&o[a]||null,u=d?.id??d?.reservationId??null,l=Os(n,{existingItems:s,start:r,end:i,ignoreReservationId:u});if(!l.success)return t||x(l.message||c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),l;const y=[...s,l.package];return pt(a,y),ut(y),Ke(),t||x(c("reservations.toast.packageAdded","✅ تم إضافة الحزمة بنجاح")),l}function ts(){const{select:e}=$a();if(!e)return;const t=e.value||"";dc(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function uc(){const{addButton:e,select:t}=$a();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{ts()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),ts())}),t.dataset.listenerAttached="true"),jr()}function ut(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","لا توجد معدات"),a=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","صورة"),r=c("reservations.equipment.actions.increase","زيادة الكمية"),i=c("reservations.equipment.actions.decrease","تقليل الكمية"),o=c("reservations.equipment.actions.remove","إزالة البند");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${n}</td></tr>`,as(t);return}const{groups:d}=Dt({items:e});t.innerHTML=d.map(u=>{const l=u.items[0]||{},y=Lt(l)||u.image,f=y?`<img src="${y}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',m=String(u?.type||"").toLowerCase()==="package"||u.items.some($=>$?.type==="package"),p=A(String(u.count)),h=jt(u.unitPrice),w=Number.isFinite(h)?vt(h):0,j=jt(u.totalPrice),v=Number.isFinite(j)?j:w*(Number.isFinite(u.count)?u.count:1),_=vt(v),P=`${A(w.toFixed(2))} ${a}`,H=`${A(_.toFixed(2))} ${a}`,E=u.barcodes.map($=>A(String($||""))).filter(Boolean),k=E.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
            <ul class="reservation-barcode-list">
              ${E.map($=>`<li>${$}</li>`).join("")}
            </ul>
          </details>`:"";let D="";if(m){const $=new Map,B=T=>{const N=Number.parseFloat(A(String(T??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(N)||N<=0||N>99?1:Math.round(N)},U=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&U.push(...u.packageItems),u.items.forEach(T=>{Array.isArray(T?.packageItems)&&U.push(...T.packageItems)}),U.forEach(T=>{if(!T)return;const N=ee(T.barcode||T.normalizedBarcode||T.desc||Math.random());if(!N)return;const F=$.get(N),Y=B(T.qtyPerPackage??T.perPackageQty??T.quantityPerPackage??T.qty??T.quantity??1),G=Math.max(1,Math.min(Y,99));if(F){F.qty=G;return}$.set(N,{desc:T.desc||T.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:G,barcode:T.barcode??T.normalizedBarcode??""})}),$.size){const T=Array.from($.values()).map(N=>{const F=A(String(N.qty>0?Math.min(N.qty,99):1)),Y=gn(N.desc||""),G=N.barcode?` <span class="reservation-package-items__barcode">(${gn(A(String(N.barcode)))})</span>`:"";return`<li>${Y}${G} × ${F}</li>`}).join("");D=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
              <ul class="reservation-package-items__list">
                ${T}
              </ul>
            </details>
          `}}const L=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",J=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${f}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${m?`${D||""}${k||""}`:k}
              </div>
            </div>
          </td>
          <td>
            <div class="${L}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${i}"${J}>−</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${r}"${J}>+</button>
            </div>
          </td>
          <td>${P}</td>
          <td>${H}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${o}">🗑️</button>
          </td>
        </tr>
      `}).join(""),as(t)}function mc(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","💵 دفعة مالية");case"percent":return c("reservations.paymentHistory.type.percent","٪ دفعة نسبة");default:return c("reservations.paymentHistory.type.unknown","دفعة")}}function $n(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let t=jn();const n=document.getElementById("edit-res-project")?.value||"";if(n)try{const i=(fe()?.projects||[]).find(d=>String(d.id)===String(n)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(t=o)}catch{}if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة")}</div>`,ns();return}const a=c("reservations.create.summary.currency","SR"),s=t.map((r,i)=>{const o=Number.isFinite(Number(r?.amount))&&Number(r.amount)>0?`${A(Number(r.amount).toFixed(2))} ${a}`:"—",d=Number.isFinite(Number(r?.percentage))&&Number(r.percentage)>0?`${A(Number(r.percentage).toFixed(2))}%`:"—",u=r?.recordedAt?A(at(r.recordedAt)):"—",l=mc(r?.type),y=r?.note?A(r.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${u}</td>
        <td>${y}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${c("reservations.paymentHistory.actions.delete","حذف الدفعة")}">🗑️</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","نوع الدفعة")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","المبلغ")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","النسبة")}</th>
            <th>${c("reservations.paymentHistory.headers.date","التاريخ")}</th>
            <th>${c("reservations.paymentHistory.headers.note","ملاحظات")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${s}</tbody>
      </table>
    </div>
  `,ns()}function pc(){if(Jt()){x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=Tr(e);let a=Nr(t);if(!Number.isFinite(a)||a<=0){x(c("reservations.toast.paymentInvalid","⚠️ يرجى إدخال قيمة دفعة صحيحة"));return}const s=Bn.lastResult,r=Number(s?.total)||0,i=Number(s?.paidPercent)||0,o=Number(s?.paidAmount)||0,d=c("reservations.create.summary.currency","SR");let u=null,l=null;if(n==="percent"){const f=Math.max(0,100-i);if(f<=1e-4){x(c("reservations.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة"));return}const m=Math.min(a,f);if(m!==a){const p=A(m.toFixed(2));x(c("reservations.toast.paymentCappedPercent","ℹ️ تم ضبط الدفعة إلى {value}% لاستكمال 100%").replace("{value}",p)),a=m}l=Number(a.toFixed(2)),r>0&&(u=a/100*r)}else{const f=Math.max(0,r-o);if(f<=1e-4){x(c("reservations.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة"));return}const m=Math.min(a,f);if(m!==a){const p=`${A(m.toFixed(2))} ${d}`;x(c("reservations.toast.paymentCappedAmount","ℹ️ تم ضبط الدفعة إلى {amount} لاستكمال المبلغ المتبقي").replace("{amount}",p)),a=m}u=Number(a.toFixed(2)),r>0&&(l=u/r*100)}u!=null&&(u=Number(u.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const y={type:n,value:a,amount:u,percentage:l,recordedAt:new Date().toISOString()};Ac(y),ja(jn()),$n(),Ke(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),x(c("reservations.toast.paymentAdded","✅ تم تسجيل الدفعة"))}function ns(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(Jt()){n.preventDefault(),x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}pc()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(Jt()){n.preventDefault(),x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}const s=Number(a.dataset.index);Number.isNaN(s)||(kc(s),ja(jn()),$n(),Ke(),x(c("reservations.toast.paymentRemoved","🗑️ تم حذف الدفعة")))}),t.dataset.listenerAttached="true")}function fc(e){const{index:t,items:n}=mt(),{groups:a}=Dt({items:n}),s=a.find(o=>o.key===e);if(!s||s.items.some(o=>o?.type==="package"))return;let r=-1;for(let o=n.length-1;o>=0;o-=1){const d=n[o];if(Xt(d)===e&&d?.type!=="package"){r=o;break}}if(r<0)return;const i=n.filter((o,d)=>d!==r);pt(t,i),ut(i),Ke()}function yc(e){const{index:t,items:n}=mt(),{groups:a}=Dt({items:n}),s=a.find(o=>o.key===e);if(!s)return;let r=n.filter(o=>Xt(o)!==e);if(s.items.some(o=>o&&o.type==="package")){const o=St(s.packageId??s.items.find(y=>y?.type==="package")?.packageId??""),d=ee(s.package_code??s.packageDisplayCode??s.barcode??"");r=r.filter(y=>{if(!y||typeof y!="object"||y.type!=="package")return!0;const f=St(y.packageId??y.package_id??y.id??""),m=ee(y.barcode??y.package_code??"");return!(o&&f===o||d&&m&&m===d)});const u=new Set,l=new Set;s.items.forEach(y=>{(Array.isArray(y?.packageItems)?y.packageItems:[]).forEach(m=>{const p=ee(m?.barcode||m?.normalizedBarcode||"");p&&u.add(p);const h=m?.equipmentId??m?.equipment_id??null;h!=null&&l.add(String(h))})}),(u.size||l.size)&&(r=r.filter(y=>{const f=ee(y?.barcode||""),m=y?.equipmentId??y?.id??null;return!(f&&u.has(f)||m!=null&&l.has(String(m)))}))}r.length!==n.length&&(pt(t,r),ut(r),Ke())}function bc(e){const{index:t,items:n}=mt(),{groups:a}=Dt({items:n}),s=a.find(w=>w.key===e);if(!s||s.items.some(w=>w?.type==="package"))return;const{start:r,end:i}=Ft();if(!r||!i){x(c("reservations.toast.requireOverallDates","⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات"));return}const{reservations:o=[]}=fe(),d=t!=null&&o[t]||null,u=d?.id??d?.reservationId??null,l=new Set(n.map(w=>ee(w.barcode))),{equipment:y=[]}=fe(),f=(y||[]).find(w=>{const j=ee(w?.barcode);return!j||l.has(j)||Xt({desc:w?.desc||w?.description||w?.name||"",price:Number(w?.price)||0})!==e||!os(w)?!1:!st(j,r,i,u)});if(!f){x(c("reservations.toast.noAdditionalUnits","⚠️ لا توجد وحدات إضافية متاحة حالياً"));return}const m=ee(f.barcode),p=Et(f);if(!p){x(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const h=[...n,{id:p,equipmentId:p,barcode:m,desc:f.desc||f.description||f.name||s.description||"",qty:1,price:Number.isFinite(Number(f.price))?Number(f.price):s.unitPrice,image:Lt(f)}];pt(t,h),ut(h),Ke()}function as(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s,itemIndex:r}=n.dataset;if(a==="decrease-edit-group"&&s){fc(s);return}if(a==="increase-edit-group"&&s){bc(s);return}if(a==="remove-edit-group"&&s){yc(s);return}if(a==="remove-edit-item"){const i=Number(r);Number.isNaN(i)||vc(i)}}),e.dataset.groupListenerAttached="true")}function Jt(){return!!document.getElementById("edit-res-project")?.value}function hc(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{Jt()&&(x(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(s=>a.addEventListener(s,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function gc(e){const t=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),s=document.getElementById("edit-res-paid"),r=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([n,a,s,r,i,o,d].forEach(hc),e){if(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),s){const u=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(u)try{const f=(fe()?.projects||[]).find(p=>String(p.id)===String(u)),m=typeof f?.paymentStatus=="string"?f.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(l=m)}catch{}s.value=l,s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t,s.dataset&&delete s.dataset.userSelected}r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),d&&(d.dataset.linkedDisabled="true")}else n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function Ke(){const e=document.getElementById("edit-res-summary");if(!e)return;$n();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),Ve(a),Ke()}),a.dataset.listenerAttached="true");const s=A(t?.value||"0");t&&(t.value=s);const r=parseFloat(s)||0,i=n?.value||"percent",o=Jt();gc(o);const d=document.getElementById("edit-res-tax"),u=o?!1:d?.checked||!1,l=!o&&a?.dataset?.userSelected==="true";let y="unpaid";if(o){const _=document.getElementById("edit-res-project")?.value||"";if(_)try{const H=(fe()?.projects||[]).find(k=>String(k.id)===String(_)),E=typeof H?.paymentStatus=="string"?H.paymentStatus.toLowerCase():null;E&&["paid","partial","unpaid"].includes(E)&&(y=E)}catch{}}else y=l&&a?.value||"unpaid";let f=null;!o&&u&&(Qe("edit-res-company-share"),f=_t("edit-res-company-share"),(!Number.isFinite(f)||f<=0)&&(Qe("edit-res-company-share"),f=_t("edit-res-company-share")));const{items:m=[],payments:p=[]}=mt(),{start:h,end:w}=Ft(),j=Bn({items:m,discount:r,discountType:i,applyTax:u,paidStatus:y,start:h,end:w,companySharePercent:f,paymentHistory:p});e.innerHTML=j;const v=Bn.lastResult;if(v&&a){const _=v.paymentStatus;l?Ve(a,a.value):(a.value!==_&&(a.value=_),a.dataset&&delete a.dataset.userSelected,Ve(a,_))}else a&&Ve(a,a.value)}function vc(e){if(e==null)return;const{index:t,items:n}=mt();if(!Array.isArray(n))return;const a=n.filter((s,r)=>r!==e);pt(t,a),ut(a),Ke()}function Sc(e){const t=e?.value??"",n=ee(t);if(!n)return;const a=aa(n);if(!a){x(c("reservations.toast.barcodeNotInCatalog","❌ الباركود غير موجود ضمن المعدات"));return}const s=ot(a);if(s==="maintenance"||s==="retired"){x(wt(s));return}const r=ee(n),{index:i,items:o=[]}=mt();if(o.findIndex(w=>ee(w.barcode)===r)>-1){x(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const{start:u,end:l}=Ft();if(!u||!l){x(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const{reservations:y=[]}=fe(),f=i!=null&&y[i]||null,m=f?.id??f?.reservationId??null;if(st(r,u,l,m)){x(c("reservations.toast.equipmentTimeConflictSimple","⚠️ هذه المعدة محجوزة في نفس الفترة الزمنية"));return}const p=Et(a);if(!p){x(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const h=[...o,{id:p,equipmentId:p,barcode:r,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];pt(i,h),e&&(e.value=""),ut(h),Ke()}function vn(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Fs(t),a=ee(n?.barcode||t);if(!n||!a){x(c("reservations.toast.equipmentNameNotFound","❌ لم يتم العثور على معدة بالاسم المدخل"));return}const s=ot(n);if(s==="maintenance"||s==="retired"){x(wt(s));return}const{start:r,end:i}=Ft();if(!r||!i){x(c("reservations.toast.requireOverallDates","⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات"));return}const{index:o,items:d=[]}=mt();if(d.some(h=>ee(h.barcode)===a)){x(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const{reservations:l=[]}=fe(),y=o!=null&&l[o]||null,f=y?.id??y?.reservationId??null;if(st(a,r,i,f)){x(c("reservations.toast.equipmentTimeConflictSimple","⚠️ هذه المعدة محجوزة في نفس الفترة الزمنية"));return}const m=Et(n);if(!m){x(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const p=[...d,{id:m,equipmentId:m,barcode:a,desc:n.desc,qty:1,price:n.price,image:n.image||n.imageUrl||n.img||null}];pt(o,p),ut(p),Ke(),e.value=""}function Cr(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),vn(e))});const t=()=>{Rs(e.value,"edit-res-equipment-description-options")&&vn(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{Ke()});const e=()=>{uc()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{jr()})}typeof window<"u"&&(window.getEditReservationDateRange=Ft,window.renderEditPaymentHistory=$n);function wc(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){zn(e);return}vn(e)}}function Wc(){lt(),Cr()}function Ec(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let $t=null,We=[],Xe=[],Zn=null,De={},Nn=!1;const qc="__DEBUG_CREW__";function Ic(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(qc);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function ss(e,t){if(Ic())try{console.log(`🪵 [crew-debug:edit] ${e}`,t)}catch{}}function Qt(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),s=document.getElementById("edit-res-confirmed-wrapper"),r=!!e;if(n&&(n.value=r?"true":"false"),a){const i=a.dataset.confirmLabel||"✅ تم التأكيد",o=a.dataset.pendingLabel||"⏳ بانتظار التأكيد";a.innerHTML=r?i:o,a.dataset.state=r?"confirmed":"pending",a.classList.toggle("btn-success",r&&!t),a.classList.toggle("btn-outline-secondary",!r||t),a.disabled=t,a.setAttribute("aria-pressed",r?"true":"false")}s&&s.classList.toggle("is-disabled",t)}function sn(){return document.getElementById("edit-res-confirmed")?.value==="true"}function mt(){return{index:$t,items:We,payments:Xe}}function pt(e,t,n=Xe){$t=typeof e=="number"?e:null,We=Array.isArray(t)?[...t]:[],Xe=Array.isArray(n)?[...n]:[]}function _r(){$t=null,We=[],ni(),Xe=[]}function jn(){return[...Xe]}function ja(e){Xe=Array.isArray(e)?[...e]:[]}function Ac(e){e&&(Xe=[...Xe,e])}function kc(e){!Number.isInteger(e)||e<0||(Xe=Xe.filter((t,n)=>n!==e))}function rn(e,t=1){const n=Number.parseFloat(A(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function ea(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(A(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function Pc(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?ee(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:rn(e.qty??e.quantity??e.count??1),price:ea(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function xc(e,t=0){if(!e||typeof e!="object")return null;const n=St(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=1,r=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:ua(e)).map(f=>Pc(f)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=ea(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const f=ea(i,0);f>0&&a>0&&(o=Number((f/a).toFixed(2)))}const d=e.package_code??e.packageCode??e.barcode??null,l=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,d,n].find(f=>f!=null&&String(f).trim()!=="")||`Package ${n}`,y=e.image??e.cover??e.thumbnail??r.find(f=>f?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:A(String(l)),name:A(String(l)),qty:a,price:o,barcode:d,packageItems:r,image:y}}function $c(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const s=e.get(a);if(s==null)return;const r=s-n;e.set(a,r>0?r:0)})}function jc(e={},t=[]){const n=Array.isArray(t)?t.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return n;const s=a.map((o,d)=>xc(o,d)).filter(Boolean);if(!s.length)return n;const r=new Map;s.forEach(o=>{const d=rn(o.qty??o.quantity??1);if(o.barcode){const u=ee(o.barcode);if(u){const l=`package::${u}`;r.set(l,(r.get(l)??0)+d)}}(o.packageItems||[]).forEach(u=>{if(!u)return;const l=d*rn(u.qty??u.quantity??1),y=u.equipmentId??null,f=u.normalizedBarcode||(u.barcode?ee(u.barcode):null);if(y!=null){const m=`equipment::${String(y)}`;r.set(m,(r.get(m)??0)+l)}if(f){const m=`barcode::${f}`;r.set(m,(r.get(m)??0)+l)}})});const i=[];return n.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const w=St(o.packageId??o.package_id??o.id??"");s.some(v=>v.packageId===w)||i.push({...o});return}const d=rn(o.qty??o.quantity??1),u=Et(o),l=o.barcode?ee(o.barcode):null,y=[];u!=null&&y.push(`equipment::${String(u)}`),l&&y.push(`barcode::${l}`);const f=y.map(w=>r.get(w)??0).filter(w=>w>0);if(!f.length){i.push({...o});return}const m=Math.min(...f);if(m<=0){i.push({...o});return}const p=Math.min(m,d);if($c(r,y,p),p>=d)return;const h=d-p;i.push({...o,qty:h,quantity:h})}),[...i,...s.map(o=>({...o}))]}function Cc(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Tr(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Nr(e){if(!e)return null;const t=A(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function _c(e,t){if(e){e.value="";return}}function Ot(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Lr(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(A(String(e.value??""))),a=Number.parseFloat(A(String(e.amount??""))),s=Number.parseFloat(A(String(e.percentage??""))),r=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,i=Number.isFinite(s)?s:t==="percent"&&Number.isFinite(n)?n:null,o=t??(Number.isFinite(r)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?r??null:o==="percent"?i??null:Number.isFinite(n)?n:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(r)?r:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:u}}function Tc(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","اختر مشروعاً (اختياري)"),s=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),r=t?.projectId?String(t.projectId):"",i=Array.isArray(e)?[...e].sort((d,u)=>String(u.createdAt||u.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${Ot(a)}</option>`];i.forEach(d=>{o.push(`<option value="${Ot(d.id)}">${Ot(d.title||a)}</option>`)}),r&&!i.some(d=>String(d.id)===r)&&o.push(`<option value="${Ot(r)}">${Ot(s)}</option>`),n.innerHTML=o.join(""),r?n.value=r:n.value=""}function Br(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),s=document.getElementById("edit-res-discount-type"),r=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=r),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=r),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=r),s&&(s.value="percent",s.disabled=!0,s.classList.add("disabled","reservation-input-disabled"),s.title=r);else{if(t){const d=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",d&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("disabled","reservation-input-disabled"),s.title="")}ta("tax");const o=De?.updateEditReservationSummary;typeof o=="function"&&o()}function ta(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const r=De?.updateEditReservationSummary;typeof r=="function"&&r()};if(Nn){a();return}Nn=!0;const s=()=>{Nn=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(gt)),t.disabled){n.checked=!1,x(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة")),s();return}t.checked||(t.checked=!0),Qe("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Qe("edit-res-company-share"):n.checked&&(n.checked=!1));s()}async function rs(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:s,updateEditReservationSummary:r,ensureModal:i}={}){const{customers:o,projects:d}=fe(),l=Sn()?.[e];if(!l){x(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز"));return}De={...De,reservation:l,projects:d||[]},t?.(),Tc(d||[],l);const y=l.projectId&&d?.find?.(M=>String(M.id)===String(l.projectId))||null,{effectiveConfirmed:f,projectLinked:m}=Bt(l,y),p=l.items?l.items.map(M=>({...M,equipmentId:M.equipmentId??M.equipment_id??M.id,barcode:ee(M?.barcode)})):[],h=jc(l,p),j=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map(M=>Lr(M)).filter(Boolean);pt(e,h,j);const v=c("reservations.list.unknownCustomer","غير معروف"),_=o?.find?.(M=>String(M.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const P=document.getElementById("edit-res-id");P&&(P.value=l.reservationId||l.id);const H=document.getElementById("edit-res-customer");H&&(H.value=_?.customerName||v);const E=typeof a=="function"?a(l.start):{date:"",time:""},k=typeof a=="function"?a(l.end):{date:"",time:""};n?.("edit-res-start",E.date),n?.("edit-res-start-time",E.time),n?.("edit-res-end",k.date),n?.("edit-res-end-time",k.time);const D=document.getElementById("edit-res-notes");D&&(D.value=l.notes||"");const L=document.getElementById("edit-res-discount");if(L){const M=m?0:l.discount??0;L.value=A(M)}const J=document.getElementById("edit-res-discount-type");J&&(J.value=m?"percent":l.discountType||"percent");const $=l.projectId?!1:!!l.applyTax,B=document.getElementById("edit-res-tax");B&&(B.checked=$);const U=document.getElementById("edit-res-company-share");if(U){const M=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,ne=M!=null?Number.parseFloat(A(String(M).replace("%","").trim())):NaN,Z=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,ae=Z!=null?Z===!0||Z===1||Z==="1"||String(Z).toLowerCase()==="true":Number.isFinite(ne)&&ne>0,me=ae&&Number.isFinite(ne)&&ne>0?ne:gt,ue=$||ae;U.checked=ue,U.dataset.companyShare=String(me)}Qt(f,{disable:m});const T=document.getElementById("edit-res-paid"),N=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");T&&(T.value=N,T.dataset&&delete T.dataset.userSelected);const F=document.getElementById("edit-res-payment-progress-type"),Y=document.getElementById("edit-res-payment-progress-value");F?.dataset?.userSelected&&delete F.dataset.userSelected,F&&(F.value="percent"),_c(Y);const G=document.getElementById("edit-res-cancelled");if(G){const M=String(l?.status||l?.reservationStatus||"").toLowerCase();G.checked=["cancelled","canceled"].includes(M),G.checked&&Qt(f,{disable:!0})}let R=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map(M=>String(M));if(!Array.isArray(R)||R.length===0){const M=Yr(l.id??l.reservationId??l.reservation_code??null);Array.isArray(M)&&M.length&&(R=M)}try{await Ss()}catch(M){console.warn("[reservationsEdit] positions load failed (non-fatal)",M)}if(Zr(R),s?.(h),typeof window<"u"){const M=window?.renderEditPaymentHistory;typeof M=="function"&&M()}Br(),r?.();const W=document.getElementById("editReservationModal");Zn=Cc(W,i),Zn?.show?.()}async function Nc({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:s,renderReservations:r,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if($t===null){console.warn("⚠️ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),y=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",f=document.getElementById("edit-res-notes")?.value||"",m=A(document.getElementById("edit-res-discount")?.value||"0");let p=parseFloat(m)||0,h=document.getElementById("edit-res-discount-type")?.value||"percent";const w=sn(),j=document.getElementById("edit-res-paid"),v=j?.dataset?.userSelected==="true",_=v&&j?.value||"unpaid",P=document.getElementById("edit-res-payment-progress-type"),H=document.getElementById("edit-res-payment-progress-value"),E=Tr(P),k=Nr(H),D=document.getElementById("edit-res-project")?.value||"",J=document.getElementById("edit-res-cancelled")?.checked===!0,$=ei();$.map(b=>b?.technicianId).filter(Boolean);const B=document.getElementById("edit-res-company-share"),U=document.getElementById("edit-res-tax");if(!d||!l){x(c("reservations.toast.requireDates","⚠️ يرجى تحديد تاريخ البداية والنهاية"));return}const T=typeof e=="function"?e:(b,z)=>`${b}T${z||"00:00"}`,N=T(d,u),F=T(l,y);if(N&&F&&new Date(N)>new Date(F)){x(c("reservations.toast.invalidDateOrder","⚠️ تاريخ البداية لا يمكن أن يكون بعد تاريخ النهاية"));return}const G=Sn()?.[$t];if(!G){x(c("reservations.toast.reservationMissing","⚠️ تعذر العثور على الحجز المطلوب"));return}if(!Array.isArray(We)||We.length===0&&$.length===0){x(c("reservations.toast.updateNoItems","⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل للحجز"));return}const R=typeof t=="function"?t:()=>!1,W=G.id??G.reservationId;for(const b of We){if(b?.type==="package"&&Array.isArray(b.packageItems)){for(const S of b.packageItems){const V=S?.barcode??S?.normalizedBarcode??"";if(!V)continue;const C=ot(V);if(C==="reserved"){const O=ee(V);if(!R(O,N,F,W))continue}if(C!=="available"){x(wt(C));return}}continue}const z=ot(b.barcode);if(z==="reserved"){const S=ee(b.barcode);if(!R(S,N,F,W))continue}if(z!=="available"){x(wt(z));return}}for(const b of We){if(b?.type==="package"&&Array.isArray(b.packageItems)){for(const S of b.packageItems){const V=ee(S?.barcode??S?.normalizedBarcode??"");if(V&&R(V,N,F,W)){const C=S?.desc||S?.barcode||c("reservations.create.packages.unnamedItem","معدة بدون اسم"),O=`${c("reservations.toast.updateEquipmentConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات")} (${A(String(C))})`;x(O);return}}continue}const z=ee(b.barcode);if(R(z,N,F,W)){x(c("reservations.toast.updateEquipmentConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات"));return}}const M=typeof n=="function"?n:()=>!1;for(const b of We){if(b?.type!=="package")continue;const z=b.packageId??b.package_id??null;if(z&&M(z,N,F,W)){const S=b.desc||b.packageName||c("reservations.create.packages.genericName","الحزمة");x(c("reservations.toast.packageTimeConflict",`⚠️ الحزمة ${A(String(S))} محجوزة بالفعل في الفترة المختارة`));return}}const ne=typeof a=="function"?a:()=>!1;for(const b of $)if(b?.technicianId&&ne(b.technicianId,N,F,W)){x(c("reservations.toast.updateCrewConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في جدول أحد أعضاء الطاقم"));return}const Z=Array.isArray(De.projects)&&De.projects.length?De.projects:fe().projects||[],ae=D&&Z.find(b=>String(b.id)===String(D))||null,me={...G,projectId:D?String(D):null,confirmed:w},{effectiveConfirmed:ue,projectLinked:Ee,projectStatus:xe}=Bt(me,ae);let K=!!B?.checked,se=!!U?.checked;if(Ee&&(K&&(B.checked=!1,K=!1),se=!1),!Ee&&K!==se){x(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"));return}se&&(Qe("edit-res-company-share"),K=!!B?.checked);let _e=K?getCompanySharePercent("edit-res-company-share"):null;K&&(!Number.isFinite(_e)||_e<=0)&&(Qe("edit-res-company-share"),_e=getCompanySharePercent("edit-res-company-share"));const qe=K&&se&&Number.isFinite(_e)&&_e>0,Fe=Ee?!1:se;Ee&&(p=0,h="percent");const Ie=ra(We,p,h,Fe,$,{start:N,end:F,companySharePercent:qe?_e:0});let we=jn();if(Number.isFinite(k)&&k>0){const b=Ie;let z=null,S=null;E==="amount"?(z=k,b>0&&(S=k/b*100)):(S=k,b>0&&(z=k/100*b));const V=Lr({type:E,value:k,amount:z,percentage:S,recordedAt:new Date().toISOString()});V&&(we=[...we,V],ja(we)),H&&(H.value="")}const Ae=ia({totalAmount:Ie,history:we}),Le=oa({manualStatus:_,paidAmount:Ae.paidAmount,paidPercent:Ae.paidPercent,totalAmount:Ie});j&&!v&&(j.value=Le,j.dataset&&delete j.dataset.userSelected);let je=G.status??"pending";Ee?je=ae?.status??xe??je:J?je="cancelled":["completed","cancelled"].includes(String(je).toLowerCase())||(je=w?"confirmed":"pending");const Me=ls({reservationCode:G.reservationCode??G.reservationId??null,customerId:G.customerId,start:N,end:F,status:je,title:G.title??null,location:G.location??null,notes:f,projectId:D?String(D):null,totalAmount:Ie,discount:p,discountType:h,applyTax:Fe,paidStatus:Le,confirmed:ue,items:We.map(b=>({...b,equipmentId:b.equipmentId??b.id})),crewAssignments:$,companySharePercent:qe?_e:null,companyShareEnabled:qe,paidAmount:Ae.paidAmount,paidPercentage:Ae.paidPercent,paymentProgressType:Ae.paymentProgressType,paymentProgressValue:Ae.paymentProgressValue,paymentHistory:we});try{ss("about to submit",{editingIndex:$t,crewAssignments:$,techniciansPayload:Me?.technicians,payload:Me});const b=await ti(G.id||G.reservationId,Me);ss("server response",{reservation:b?.id??b?.reservationId??b?.reservation_code,technicians:b?.technicians,crewAssignments:b?.crewAssignments,techniciansDetails:b?.techniciansDetails}),await ms(),pa(),Ct(),fi(),x(c("reservations.toast.updated","✅ تم حفظ التعديلات على الحجز")),s?.(),_r(),o?.({type:"updated",reservation:b}),r?.(),i?.(),Zn?.hide?.()}catch(b){console.error("❌ [reservationsEdit] Failed to update reservation",b);const z=ds(b)?b.message:c("reservations.toast.updateFailed","تعذر تحديث بيانات الحجز");x(z,"error")}}function Jc(e={}){De={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:s}=De,r=document.getElementById("edit-res-discount");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=A(r.value),t?.()}),r.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>t?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{ta("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{ta("share")}),d.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",t?.()}),u.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=A(l.value)}),l.dataset.listenerAttached="true"),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const y=document.getElementById("edit-res-project");y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>{Br();const j=Array.isArray(De.projects)&&De.projects.length?De.projects:fe().projects||[],v=y.value&&j.find(k=>String(k.id)===String(y.value))||null,P={...De?.reservation??{},projectId:y.value||null,confirmed:sn()},{effectiveConfirmed:H,projectLinked:E}=Bt(P,v);Qt(H,{disable:E}),t?.()}),y.dataset.listenerAttached="true");const f=document.getElementById("edit-res-confirmed-btn");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{if(f.disabled)return;const j=!sn();Qt(j),t?.()}),f.dataset.listenerAttached="true");const m=document.getElementById("edit-res-cancelled");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&Qt(sn(),{disable:m.checked}),t?.()}),m.dataset.listenerAttached="true");const p=document.getElementById("save-reservation-changes");p&&!p.dataset.listenerAttached&&(p.addEventListener("click",()=>{Nc(De).catch(j=>{console.error("❌ [reservationsEdit] saveReservationChanges failed",j)})}),p.dataset.listenerAttached="true");const h=document.getElementById("edit-res-equipment-barcode");if(h&&!h.dataset.listenerAttached){let j=null;const v=()=>{h.value?.trim()&&(clearTimeout(j),j=null,n?.(h))};h.addEventListener("keydown",P=>{P.key==="Enter"&&(P.preventDefault(),v())});const _=()=>{if(clearTimeout(j),!h.value?.trim())return;const{start:P,end:H}=getEditReservationDateRange();!P||!H||(j=setTimeout(()=>{v()},150))};h.addEventListener("input",_),h.addEventListener("change",v),h.dataset.listenerAttached="true"}Cr?.();const w=document.getElementById("editReservationModal");w&&!w.dataset.cleanupAttached&&(w.addEventListener("hidden.bs.modal",()=>{_r(),t?.(),s?.([])}),w.dataset.cleanupAttached="true")}function Xc(){return Si().catch(e=>{console.warn("⚠️ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=fe()||{};ai(e||[]),Us()})}function Ca(e=null){Us(),Dr(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function Lc(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function na(){return{populateEquipmentDescriptionLists:lt,setFlatpickrValue:Ec,splitDateTime:bs,renderEditItems:ut,updateEditReservationSummary:Ke,addEquipmentByDescription:wc,addEquipmentToEditingReservation:Sc,addEquipmentToEditingByDescription:vn,combineDateTime:Gt,hasEquipmentConflict:st,hasTechnicianConflict:ys,renderReservations:Dr,handleReservationsMutation:Ca,ensureModal:Lc}}function Dr(e="reservations-list",t=null){cc({containerId:e,filters:t,onShowDetails:Fr,onConfirmReservation:Mr})}function Fr(e){return lc(e,{getEditContext:na,onEdit:(t,{reservation:n})=>{Hr(t,n)},onDelete:Rr})}function Rr(e){return Kr()?window.confirm(c("reservations.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا الحجز؟"))?gi(e,{onAfterChange:Ca}):!1:(Ur(),!1)}function Mr(e){return vi(e,{onAfterChange:Ca})}function Hr(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("⚠️ [reservations/controller] Unable to clear pending edit id (inline form)",r)}rs(e,na());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("⚠️ [reservations/controller] Unable to clear pending edit id (modal)",r)}rs(e,na());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const r=t.id??t.reservationId;n.set("reservationEditId",String(r));try{localStorage.setItem("pendingReservationEditId",String(r)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("⚠️ [reservations/controller] Unable to persist pending edit id",i)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(r){console.warn("⚠️ [reservations/controller] Unable to persist pending edit index",r)}}Qr({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(r=>{console.warn("⚠️ [reservations/controller] Failed to persist tab preference",r)});const a=n.toString(),s=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=s}function Yc(){wi({showReservationDetails:Fr,deleteReservation:Rr,confirmReservation:Mr,openReservationEditor:Hr})}export{Wc as a,Dr as b,Us as c,ce as d,Gc as e,Fr as f,na as g,Ca as h,Qc as i,Rr as j,Mr as k,Xc as l,Ec as m,Hr as o,Yc as r,Jc as s,Ke as u};
