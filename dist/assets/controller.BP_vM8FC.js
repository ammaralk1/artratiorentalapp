import{d as xe,n as q,t as c,j as I,b as Ue,z as Gr,y as ot,h as Wr,B as ls,v as Jr,w as Xr,u as Yr}from"./auth.B4XUmSYg.js";import{g as ut,r as Lt,f as ra,a as Zr,i as ds,b as Na}from"./details.CL-8mPyt.js";import{l as us,o as La,n as We,p as ia,D as St,q as Et,s as Yt,f as oa,c as Qt,d as Gt,t as ms,v as ei,w as ps,x as ti,i as fs,a as Bt,e as ca,y as wt,z as _t,b as la,A as Dt,g as An,r as ys,B as Dn,C as Fn,E as ni,F as ai,G as si,u as ri,H as ii,k as oi}from"./reservationsService.DnZIJFFB.js";import{l as da,o as gs,p as ci,q as st,n as le,u as Wt,v as bs,w as ua,x as ct,y as qn,z as cn,A as li,B as hs,C as vs,D as Ss,s as jt,E as ws,F as At,G as As,b as ma,H as pa,I as di,J as ui,K as qs,L as mi,M as pi,i as Ba,j as Da,N as Es,k as Is,O as Fa}from"./state.DnWIUPO4.js";import{s as fa,E as ks,a as fi,c as yi,b as gi,r as bi}from"./equipment.9WuoT98d.js";import{f as hi,h as vi,z as Si}from"./view.Bv3IP4JA.js";import{q as wi}from"./quotePdf.C2lQPEPC.js";import{s as Ps,a as $s,e as xs,p as Ai}from"./canvasColorUtils.CviLtv6S.js";import{d as qi,c as Ei}from"./reservationsActions.D1CLOm-Q.js";import{ensureProjectsLoaded as Ii}from"./projectsService.GA8uKd8c.js";import{s as ki}from"./uiBridge.BLZZT8b9.js";const Pi="__DEBUG_CREW__";function $i(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Pi);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function Ra(e,t){if($i())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,t)}catch{}}const _s="projects:create:draft",js="projects.html#projects-section";let Rn=null,Cs=[],Mn=new Map,Hn=new Map,ln=new Map,Tn=!1,tn=null,Ma=!1,Ts=[];function xi(e){if(!e)return null;let t=Ts.find(a=>a.id===e)||null;if(t)return t;const n=pa(e);return n?(t={id:e,name:ui(n)||e,price:di(n),items:ma(n),raw:n},t):null}function dn(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function un(e){return q(String(e||"")).trim().toLowerCase()}function _i(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=q(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function Ns(e){const t=q(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Ls(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Bs(e){if(!e)return null;const t=q(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Ds(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=q(String(t))}}function qt(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function ya(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function It(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function Ge(){const{input:e,hidden:t}=It();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function ht(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const r=document.querySelector(`label[for="${e.id}"]`);r&&n.add(r)}const s=r=>{t()&&I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};n.forEach(r=>{!r||r.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{r.addEventListener(i,s,{capture:!0})}),r.dataset.linkedGuardAttached="true")})}function Fs(e,t,{allowPartial:n=!1}={}){const a=We(t);if(!a)return null;const s=e.get(a);if(s)return s;if(!n)return null;const r=[];return e.forEach((i,o)=>{o.includes(a)&&r.push(i)}),r.length===1?r[0]:null}function zn(e,t={}){return Fs(Mn,e,t)}function On(e,t={}){return Fs(Hn,e,t)}function Je(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Rs(e){Cs=Array.isArray(e)?[...e]:[]}function ga(){return Cs}function ba(e){return e&&ga().find(t=>String(t.id)===String(e))||null}function Ha(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function Ct(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??St,a=q(String(n).replace("%","").trim()),s=parseFloat(a);return Number.isFinite(s)?s:St}function Ze(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??St,a=q(String(n).replace("%","").trim()),s=parseFloat(a);(!Number.isFinite(s)||s<=0)&&(s=St),t.dataset.companyShare=String(s),t.checked=!0}function Vn(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(Tn){he();return}Tn=!0;const a=()=>{Tn=!1,he()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(St)),t.disabled){n.checked=!1,I(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}t.checked||(t.checked=!0),Ze()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Ze():n.checked&&(n.checked=!1));a()}function ji(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function za(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const s=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${s}`}return""}function Oa(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function it({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:s}=ya();if(!n||!a||!s)return;const r=da()||[],i=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");n.setAttribute("placeholder",i);const d=new Set;Mn=new Map;const u=r.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:Oa(m)||o})).filter(m=>{if(!m.label)return!1;const p=We(m.label);return!p||d.has(p)?!1:(d.add(p),Mn.set(p,m),!0)}).sort((m,p)=>m.label.localeCompare(p.label,void 0,{sensitivity:"base"}));s.innerHTML=u.map(m=>`<option value="${dn(m.label)}"></option>`).join("");const l=t?"":n.value,y=e?String(e):a.value?String(a.value):"",f=y?r.find(m=>String(m.id)===y):null;if(f){const m=Oa(f)||o;a.value=String(f.id),n.value=m,n.dataset.selectedId=String(f.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":l}function Tt({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:s,list:r}=It();if(!a||!s||!r)return;const i=Array.isArray(t)?t:ga()||[],o=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const d=[...i].filter(g=>g&&g.id!=null).sort((g,h)=>String(h.createdAt||h.start||"").localeCompare(String(g.createdAt||g.start||""))),u=n?"":a.value,l=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),y=new Set;Hn=new Map;const f=d.map(g=>{const h=Ha(g)||l;return{id:String(g.id),label:h}}).filter(g=>{if(!g.label)return!1;const h=We(g.label);return!h||y.has(h)?!1:(y.add(h),Hn.set(h,g),!0)});r.innerHTML=f.map(g=>`<option value="${dn(g.label)}"></option>`).join("");const m=e?String(e):s.value?String(s.value):"",p=m?d.find(g=>String(g.id)===m):null;if(p){const g=Ha(p)||l;s.value=String(p.id),a.value=g,a.dataset.selectedId=String(p.id)}else s.value="",a.dataset.selectedId="",a.value=n?"":u}function mn(e,t,n){const{date:a,time:s}=ws(n),r=document.getElementById(e),i=document.getElementById(t);if(r){if(a)if(r._flatpickr){const o=r._flatpickr.config?.dateFormat||"Y-m-d";r._flatpickr.setDate(a,!1,o)}else r.value=a;else r._flatpickr?r._flatpickr.clear():r.value="";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(s)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(s,!1,o)}else i.value=s;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function Ms(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||Tt({selectedValue:a});const r=(da()||[]).find(l=>String(l.id)===String(e.clientId)),i=r?.id!=null?String(r.id):"";it(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=za(e,"start"),d=za(e,"end");o&&mn("res-start","res-start-time",o),d&&mn("res-end","res-end-time",d);const u=document.getElementById("res-notes");u&&e.description&&(t||!u.value)&&(u.value=e.description),he(),mt()}function Hs({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:xe(),s=Array.isArray(a)?a:[];Rs(s);const r=t!=null?String(t):n.value?String(n.value):"";Tt({selectedValue:r,projectsList:s}),mt(),he()}function mt(){const{input:e,hidden:t}=It(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),s=document.getElementById("res-payment-status"),r=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),u=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),y=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(ht(n,Ge),a&&ht(a,Ge)),s&&ht(s,Ge),r&&ht(r,Ge),i&&ht(i,Ge),o&&ht(o,Ge),d&&ht(d,Ge),y)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),s&&(s.value="unpaid",Je(s,"unpaid"),s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=u);else{if(n){const f=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",f&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}Vn("tax"),he()}function ha(){const{input:e,hidden:t}=It();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?On(s,{allowPartial:a}):null;if(r){t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id);const i=ba(r.id);i?Ms(i,{skipProjectSelectUpdate:!0}):(mt(),he())}else t.value="",e.dataset.selectedId="",mt(),he()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?On(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function va(){const{input:e,hidden:t}=ya();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?zn(s,{allowPartial:a}):null;r?(t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id)):(t.value="",e.dataset.selectedId=""),he()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?zn(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Ci(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){Ot({clearValue:!0});return}let n=null;try{const u=decodeURIComponent(t);n=JSON.parse(u)}catch(u){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,s),Ot({clearValue:!1}),!n)return;n.fromProjectForm&&(tn={draftStorageKey:n.draftStorageKey||_s,returnUrl:n.returnUrl||js});const r=document.getElementById("res-project");if(n.projectId){r&&(Tt({selectedValue:String(n.projectId)}),mt());const u=ba(n.projectId);u?Ms(u,{forceNotes:!!n.forceNotes}):he(),Ot()}else{r&&Tt({selectedValue:""});const u=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");Qi(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),u)}n.start&&mn("res-start","res-start-time",n.start),n.end&&mn("res-end","res-end-time",n.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(n.customerId){const l=(da()||[]).find(y=>String(y.id)===String(n.customerId));l?.id!=null&&(it({selectedValue:String(l.id)}),o&&(o.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else n.customerName&&i?(it({selectedValue:""}),i.value=n.customerName,i.dataset.selectedId="",o&&(o.value="")):it({selectedValue:""});const d=document.getElementById("res-notes");d&&n.description&&!d.value&&(d.value=n.description),he()}function kt(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Wt(e,n),end:Wt(t,a)}}function zs(e){const t=un(e);if(t){const o=ln.get(t);if(o)return o}const{description:n,barcode:a}=Ns(e);if(a){const o=ra(a);if(o)return o}const s=We(n||e);if(!s)return null;let r=bs();if(!r?.length){const o=xe();r=Array.isArray(o?.equipment)?o.equipment:[],r.length&&qs(r)}const i=r.find(o=>We(o?.desc||o?.description||"")===s);return i||r.find(o=>We(o?.desc||o?.description||"").includes(s))||null}function Os(e,t="equipment-description-options"){const n=un(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(d=>un(d.value)===n)||ln.has(n))return!0;const{description:s}=Ns(e);if(!s)return!1;const r=We(s);return r?(bs()||[]).some(o=>We(o?.desc||o?.description||"")===r):!1}const Ti={available:0,reserved:1,maintenance:2,retired:3};function Ni(e){return Ti[e]??5}function Va(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Li(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(s=>s!=="available")||e.bestStatus;if(n==="available")return`${t} â€” ${Va(n)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${t} â€” ${a} (${Va(n)})`}function pt(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=fa(),a=xe(),s=Array.isArray(n)&&n.length?n:a?.equipment||[],r=Array.isArray(s)?s:[];qs(r);const i=new Map;r.forEach(u=>{const l=_i(u),y=un(l);if(!y||!l)return;const f=ut(u),m=Ni(f),p=i.get(y);if(!p){i.set(y,{normalized:y,value:l,bestItem:u,bestStatus:f,bestPriority:m,statuses:new Set([f])});return}p.statuses.add(f),m<p.bestPriority&&(p.bestItem=u,p.bestStatus=f,p.bestPriority=m,p.value=l)}),ln=new Map;const d=Array.from(i.values()).sort((u,l)=>u.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(u=>{ln.set(u.normalized,u.bestItem);const l=Li(u),y=dn(u.value);if(l===u.value)return`<option value="${y}"></option>`;const f=dn(l);return`<option value="${y}" label="${f}"></option>`}).join("");e&&(e.innerHTML=d),t&&(t.innerHTML=d)}function Vs(e,t,n={}){const{silent:a=!1}=n,s=le(e);if(!s)return{success:!1,message:null};const{start:r,end:i}=kt();if(!r||!i){const p=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||I(p),{success:!1,message:p}}const o=st();if(Sa(o).has(s)){const p=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||I(p),{success:!1,message:p}}const u=ua(s,r,i);if(u.length){const p=u.map(h=>h.name).join(", "),g=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${p}`);return a||I(g),{success:!1,message:g}}if(ct(s,r,i)){const p=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const g=new URLSearchParams({type:"equipment",id:s,start:r,end:i});Ue(`/reservations/availability.php?${g.toString()}`).then(h=>{const x=Array.isArray(h?.conflicts)?h.conflicts:[],b=Array.from(new Set(x.map(S=>S?.reservation_code||(S?.reservation_id!=null?`#${S.reservation_id}`:null)).filter(Boolean))),j=b.length?`${p}: ${b.join("ØŒ ")}`:p;I(j)}).catch(()=>I(p))}catch{I(p)}return{success:!1,message:p}}const l=ra(s);if(!l){const p=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||I(p),{success:!1,message:p}}const y=ut(l);if(y==="maintenance"||y==="retired"){const p=qt(y);return a||I(p),{success:!1,message:p}}const f=Et(l);if(!f){const p=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||I(p),{success:!1,message:p}}qn({id:f,equipmentId:f,barcode:s,desc:l.desc,qty:1,price:l.price,image:Lt(l)}),t&&(t.value=""),lt(),he();const m=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||I(m),{success:!0,message:m,barcode:s}}function Un(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=zs(t);if(!n){I(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Zr(n.barcode),s=ut(a||n);if(s==="maintenance"||s==="retired"){I(qt(s));return}const r=le(n.barcode);if(!r){I(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=Et(n);if(!i){I(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:r,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,image:Lt(n)},{start:d,end:u}=kt();if(!d||!u){I(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const l=st();if(Sa(l).has(r)){I(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const f=ua(r,d,u);if(f.length){const m=f.map(p=>p.name).join(", ");I(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(ct(r,d,u)){const m=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const p=new URLSearchParams({type:"equipment",id:r,start:d,end:u});Ue(`/reservations/availability.php?${p.toString()}`).then(g=>{const h=Array.isArray(g?.conflicts)?g.conflicts:[],x=Array.from(new Set(h.map(j=>j?.reservation_code||(j?.reservation_id!=null?`#${j.reservation_id}`:null)).filter(Boolean))),b=x.length?`${m}: ${x.join("ØŒ ")}`:m;I(b)}).catch(()=>I(m))}catch{I(m)}return}qn(o),lt(),he(),I(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function Bi(){pt();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Un(e))});const t=()=>{Os(e.value,"equipment-description-options")&&Un(e)};e.addEventListener("focus",()=>{if(pt(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function Ua(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function Sa(e=st()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=le(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(s=>{const r=le(s?.normalizedBarcode??s?.barcode);r&&t.add(r)})}),t}function Di(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=kt();if(!t||!n){I(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}fi({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):I(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(ks.change,t=>{Ua(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),Ua(e,gi()))}function Fi(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],s=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=a.length?a:t.barcode?[t.barcode]:[];if(!r.length)return;let i=0,o=null;const d=[],u=new Set;r.forEach(y=>{const f=le(y);f&&!u.has(f)&&(u.add(f),d.push(f))});const l=Math.min(s,d.length);for(let y=0;y<l;y+=1){const f=d[y],m=Vs(f,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const f=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",q(String(i)));I(f)}else o&&I(o)}function Us(){Di(),!(Ma||typeof document>"u")&&(document.addEventListener(ks.requestAdd,Fi),Ma=!0)}function Zt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),s=document.getElementById("reservation-package-hint"),r=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:s,packageAddButton:r}}function Kn(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:s}=Zt();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const r=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=t==="package";r&&(r.disabled=o),i&&(i.disabled=o),s&&(s.disabled=t!=="package"||s.options.length===0),mi(t),t==="package"&&En()}function En(){const{packageSelect:e,packageHint:t}=Zt();if(!e)return;const n=gs();Ts=n,ci(n.map(o=>o.raw??o));const a=c("reservations.create.summary.currency","SR"),s=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,r=n.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,u=q(d.toFixed(2)),l=`${o.name} â€” ${u} ${a}`;return`<option value="${o.id}">${l}</option>`}).join("");e.innerHTML=`${s}${r}`,e.selectedIndex=0;const i=n.length>0;e.disabled=!i,t&&(i?(t.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),Gs()}function Ri(e,t){const n=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${n} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),s=t.map(({item:r,blockingPackages:i})=>{const o=r?.desc||q(String(r?.barcode??r?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const d=i.map(u=>u.name).join(", ");return`â€¢ ${o} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${d})`}return`â€¢ ${o} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...s].join(`
`)}function Ks(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:s=null}={}){const r=At(e);if(!r)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=xi(r);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(t.some(m=>m?.type==="package"&&At(m.packageId)===r))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(hs(r,n,a,s)){const m=i.name||r;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:ma(i.raw??{}),d=Sa(t),u=[],l=new Set;if(o.forEach(m=>{const p=le(m?.normalizedBarcode??m?.barcode);if(p){if(l.has(p)){u.push({item:m,type:"internal"});return}l.add(p),d.has(p)&&u.push({item:m,type:"external"})}}),u.length){const m=u.map(({item:g})=>g?.desc||g?.description||g?.name||g?.barcode||g?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(g=>q(String(g))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(g=>g.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:u}}const y=[];return o.forEach(m=>{const p=le(m?.normalizedBarcode??m?.barcode);if(p&&ct(p,n,a,s)){const g=ua(p,n,a,s);y.push({item:m,blockingPackages:g})}}),y.length?{success:!1,reason:"item_conflict",message:Ri(i,y),conflicts:y}:{success:!0,package:{id:`package::${r}`,packageId:r,type:"package",desc:i.name||`Package ${r}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,barcode:i.code||i.raw?.package_code||`pkg-${r}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:le(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function Qs(e,{silent:t=!1}={}){const n=At(e);if(!n)return t||I(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:s}=kt(),r=st(),i=Ks(n,{existingItems:r,start:a,end:s});if(!i.success){if(!t){const d={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");I(i.message||d)}return i}return qn(i.package),lt(),he(),t||I(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function Gs(){const{packageSelect:e}=Zt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;Qs(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Mi(){const{packageAddButton:e,packageSelect:t}=Zt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){I(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Qs(n)}),e.dataset.listenerAttached="true")}function Ws(){const{modeRadios:e}=Zt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",s=>{s.target.checked&&Kn(s.target.value)}),a.dataset.listenerAttached="true")}),Mi(),Gs();const t=cn(),n=e.find(a=>a.value===t);n&&(n.checked=!0),Kn(t)}function lt(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=st(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),s=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),d=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(n.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${a}</td></tr>`;return}const u=ia(n);t.innerHTML=u.map(l=>{const y=l.items[0]||{},f=Lt(y)||l.image,m=f?`<img src="${f}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',p=q(String(l.count)),g=Number.isFinite(Number(l.unitPrice))?Number(l.unitPrice):0,h=Number.isFinite(Number(l.totalPrice))?Number(l.totalPrice):g*l.count,x=`${q(g.toFixed(2))} ${s}`,b=`${q(h.toFixed(2))} ${s}`,j=l.items.some(k=>k?.type==="package"),S=l.barcodes.map(k=>q(String(k||""))).filter(Boolean),z=S.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${S.map(k=>`<li>${k}</li>`).join("")}
            </ul>
          </details>`:"";let A="";if(j){const k=new Map;if(l.items.forEach(M=>{Array.isArray(M?.packageItems)&&M.packageItems.forEach(L=>{if(!L)return;const ne=le(L.barcode||L.desc||Math.random()),C=k.get(ne);if(C){C.qty+=Number.isFinite(Number(L.qty))?Number(L.qty):1;return}k.set(ne,{desc:L.desc||L.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(L.qty))?Number(L.qty):1,barcode:L.barcode??L.normalizedBarcode??""})})}),k.size){const M=Array.from(k.values()).map(L=>{const ne=q(String(L.qty)),C=L.desc||q(String(L.barcode||"")),F=L.barcode?` <span class="reservation-package-items__barcode">(${q(String(L.barcode))})</span>`:"";return`<li>${C}${F} Ã— ${ne}</li>`}).join("");A=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${M}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${j?`${A||""}${z||""}`:z}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${l.key}" aria-label="${o}" ${j?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${l.key}" aria-label="${i}" ${j?"disabled":""}>+</button>
            </div>
          </td>
          <td>${x}</td>
          <td>${b}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${l.key}" aria-label="${d}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Hi(e){const t=st(),a=ia(t).find(r=>r.key===e);if(!a)return;const s=a.itemIndices[a.itemIndices.length-1];s!=null&&(li(s),lt(),he())}function zi(e){const t=st(),n=t.filter(a=>Yt(a)!==e);n.length!==t.length&&(As(n),lt(),he())}function Oi(e){const t=st(),a=ia(t).find(y=>y.key===e);if(!a)return;const{start:s,end:r}=kt();if(!s||!r){I(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(t.map(y=>le(y.barcode))),{equipment:o=[]}=xe(),d=(o||[]).find(y=>{const f=le(y?.barcode);return!f||i.has(f)||Yt({desc:y?.desc||y?.description||y?.name||"",price:Number(y?.price)||0})!==e||!ds(y)?!1:!ct(f,s,r)});if(!d){I(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=le(d.barcode),l=Et(d);if(!l){I(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}qn({id:l,equipmentId:l,barcode:u,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,image:Lt(d)}),lt(),he()}function he(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(q(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",s=e?"percent":a,r=document.getElementById("res-tax"),i=e?!1:r?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:u,end:l}=kt();i&&Ze();const y=Ct(),f=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),p=Ls(f),g=Bs(m);us(),La({selectedItems:st(),discount:n,discountType:s,applyTax:i,paidStatus:d,paymentProgressType:p,paymentProgressValue:g,start:u,end:l,companySharePercent:y,paymentHistory:[]});const h=La.lastResult;h?(Ds(m,h.paymentProgressValue),o&&(o.value=h.paymentStatus,Je(o,h.paymentStatus))):Je(o,d)}function Vi(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=q(o.target.value),he()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",he),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(Ge()){n.checked=!1,I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Vn("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(Ge()){a.checked=!1,I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Vn("share")}),a.dataset.listenerAttached="true");const s=document.getElementById("res-payment-status");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{if(Ge()){s.value="unpaid",Je(s,"unpaid"),I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Je(s),he()}),s.dataset.listenerAttached="true");const r=document.getElementById("res-payment-progress-type");r&&!r.dataset.listenerAttached?(r.dataset.userSelected!=="true"&&(r.value="percent"),r.addEventListener("change",o=>{if(Ge()){r.value="percent",I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}r.dataset.userSelected="true",he()}),r.dataset.listenerAttached="true"):r&&r.dataset.userSelected!=="true"&&!r.value&&(r.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(Ge()){i.value="",I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=q(o.target.value),he()}),i.dataset.listenerAttached="true"),he()}function Ui(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;let n=!1;const a=()=>{const s=e.value?.trim();if(!s){he();return}const r=t.dataset.syncedWithStart;(!t.value?.trim()||r!=="false")&&(n=!0,t.value=s,t.dataset.syncedWithStart="true",t.dataset.syncedValue=s,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),he()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{n||(t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false")}),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Ka(){const{input:e,hidden:t}=ya(),{input:n,hidden:a}=It(),{customers:s}=xe();let r=t?.value?String(t.value):"";if(!r&&e?.value){const H=zn(e.value,{allowPartial:!0});H&&(r=String(H.id),t&&(t.value=r),e.value=H.label,e.dataset.selectedId=r)}const i=s.find(H=>String(H.id)===r);if(!i){I(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&n?.value){const H=On(n.value,{allowPartial:!0});H&&(d=String(H.id),a&&(a.value=d),n.value=H.label,n.dataset.selectedId=d)}const u=document.getElementById("res-start").value,l=document.getElementById("res-end").value,y=document.getElementById("res-start-time")?.value||"00:00",f=document.getElementById("res-end-time")?.value||"00:00";if(!u||!l){I(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const m=`${u}T${y}`,p=`${l}T${f}`,g=new Date(m),h=new Date(p);if(Number.isNaN(g.getTime())||Number.isNaN(h.getTime())||g>=h){I(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const x=us();x.map(H=>H.technicianId).filter(Boolean);const b=st();if(b.length===0&&x.length===0){I(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const j=document.getElementById("res-notes")?.value||"",S=parseFloat(q(document.getElementById("res-discount")?.value))||0,z=document.getElementById("res-discount-type")?.value||"percent",A=document.getElementById("res-payment-status"),k=A?.value||"unpaid",M=document.getElementById("res-payment-progress-type"),L=document.getElementById("res-payment-progress-value"),ne=Ls(M),C=Bs(L),F=d?ba(d):null,J=ji(F);if(d&&!F){I(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const H of b){const ae=ut(H.barcode);if(ae==="maintenance"||ae==="retired"){I(qt(ae));return}}const N=[];for(const H of b){const ae=le(H.barcode);if(ct(ae,m,p)){const ye=H?.desc||H?.name||H?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");N.push({label:q(String(ye)),barcode:ae})}}if(N.length){const H=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let ae=null;try{const oe=Array.from(new Set(N.map(pe=>pe.barcode).filter(Boolean))),Ie=new Map;await Promise.all(oe.map(async pe=>{const _e=new URLSearchParams({type:"equipment",id:pe,start:m,end:p}),Ce=await Ue(`/reservations/availability.php?${_e.toString()}`),Me=Array.isArray(Ce?.conflicts)?Ce.conflicts:[],P=Array.from(new Set(Me.map($=>$?.reservation_code||($?.reservation_id!=null?`#${$.reservation_id}`:null)).filter(Boolean)));Ie.set(pe,P)})),ae=N.map(({label:pe,barcode:_e})=>{const Ce=Ie.get(_e)||[];return Ce.length?`${pe} (${Ce.join("ØŒ ")})`:pe}).join("ØŒ ")}catch{}const ye=ae||N.map(oe=>oe.label).filter(Boolean).map(String).join("ØŒ ");I(`${H}: ${ye}`,"warning",6e3);return}const B=[];for(const H of b){if(H?.type!=="package")continue;const ae=H.packageId??H.package_id??null;if(ae&&hs(ae,m,p)){const ye=H.desc||H.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let oe=[];try{const Ie=new URLSearchParams({type:"package",id:String(ae),start:m,end:p}),pe=await Ue(`/reservations/availability.php?${Ie.toString()}`),_e=Array.isArray(pe?.conflicts)?pe.conflicts:[];oe=Array.from(new Set(_e.map(Ce=>Ce?.reservation_code||(Ce?.reservation_id!=null?`#${Ce.reservation_id}`:null)).filter(Boolean)))}catch{}B.push({label:q(String(ye)),codes:oe})}}if(B.length){const H=B.map(({label:ye,codes:oe})=>oe&&oe.length?`${ye} (${oe.join("ØŒ ")})`:ye).join("ØŒ "),ae=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");I(`${ae}: ${H}`,"warning",6e3);return}const O=[];for(const H of x){if(!H?.technicianId||!vs(H.technicianId,m,p))continue;const ae=H?.technicianName||H?.positionLabel||String(H.technicianId);let ye=[];try{ye=Ss(H.technicianId,m,p,null)}catch{}O.push({label:q(String(ae)),codes:ye})}if(O.length){const H=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),ae=O.map(({label:ye,codes:oe})=>oe&&oe.length?`${ye} (${oe.join("ØŒ ")})`:ye).join("ØŒ ");I(`${H}: ${ae}`);return}const Y=document.getElementById("res-tax"),G=document.getElementById("res-company-share"),D=!!d;D?(Y&&(Y.checked=!1,Y.disabled=!0,Y.classList.add("disabled"),Y.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),G&&(G.checked=!1,G.disabled=!0,G.classList.add("disabled"),G.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),A&&(A.value="unpaid",A.disabled=!0,Je(A,"unpaid"),A.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),M&&(M.disabled=!0,M.classList.add("disabled")),L&&(L.value="",L.disabled=!0,L.classList.add("disabled"))):(Y&&(Y.disabled=!1,Y.classList.remove("disabled"),Y.title=""),G&&(G.disabled=!1,G.classList.remove("disabled"),G.title=""),A&&(A.disabled=!1,A.title=""),M&&(M.disabled=!1,M.classList.remove("disabled")),L&&(L.disabled=!1,L.classList.remove("disabled")));const W=D?!1:Y?.checked||!1,R=!!G?.checked;if(!D&&R!==W){I(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let ie=R?Ct():null;R&&(!Number.isFinite(ie)||ie<=0)&&(Ze(),ie=Ct());const ve=R&&W&&Number.isFinite(ie)&&ie>0;W&&Ze();const Se=oa(b,S,z,W,x,{start:m,end:p,companySharePercent:ve?ie:0}),je=Gr(),me=Qt({totalAmount:Se,progressType:ne,progressValue:C,history:[]});L&&Ds(L,me.paymentProgressValue);const Ve=[];me.paymentProgressValue!=null&&me.paymentProgressValue>0&&Ve.push({type:me.paymentProgressType||ne,value:me.paymentProgressValue,amount:me.paidAmount,percentage:me.paidPercent,recordedAt:new Date().toISOString()});const ze=Gt({manualStatus:k,paidAmount:me.paidAmount,paidPercent:me.paidPercent,totalAmount:Se});A&&(A.value=ze,Je(A,ze));const qe=typeof F?.paymentStatus=="string"?F.paymentStatus.toLowerCase():null,Le=qe&&["paid","partial","unpaid"].includes(qe)?qe:"unpaid",Be=ms({reservationCode:je,customerId:o,start:m,end:p,status:J?"confirmed":"pending",title:null,location:null,notes:j,projectId:d||null,totalAmount:Se,discount:D?0:S,discountType:D?"percent":z,applyTax:W,paidStatus:D?Le:ze,confirmed:J,items:b.map(H=>({...H,equipmentId:H.equipmentId??H.id})),crewAssignments:x,companySharePercent:D||!ve?null:ie,companyShareEnabled:D?!1:ve,paidAmount:D?0:me.paidAmount,paidPercentage:D?0:me.paidPercent,paymentProgressType:D?null:me.paymentProgressType,paymentProgressValue:D?null:me.paymentProgressValue,paymentHistory:D?[]:Ve});try{Ra("about to submit",{crewAssignments:x,techniciansPayload:Be?.technicians,payload:Be});const H=await ei(Be);Ra("server response",{reservation:H?.id??H?.reservationId??H?.reservation_code,technicians:H?.technicians,crewAssignments:H?.crewAssignments,techniciansDetails:H?.techniciansDetails}),fa(),pt(),jt(),Gi(),I(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const ae=document.getElementById("sub-tab-trigger-my-reservations-tab");ae&&typeof ae.click=="function"&&setTimeout(()=>ae.click(),0)}catch{}typeof Rn=="function"&&Rn({type:"created",reservation:H}),Ki(H)}catch(H){console.error("âŒ [reservations/createForm] Failed to create reservation",H);const ae=ps(H)?H.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");I(ae,"error"),D&&(I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),Ot({clearValue:!1}))}}function Ki(e){if(!tn)return;const{draftStorageKey:t=_s,returnUrl:n=js}=tn,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const s=window.sessionStorage.getItem(t),r=s?JSON.parse(s)||{}:{},i=Array.isArray(r.linkedReservationIds)?r.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),r.linkedReservationIds=i,window.sessionStorage.setItem(t,JSON.stringify(r))}catch(s){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",s)}tn=null,n&&(window.location.href=n)}function Ot({clearValue:e=!1}={}){const{input:t,hidden:n}=It();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,mt())}function Qi(e,t=""){const{input:n,hidden:a}=It();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),mt())}function Gi(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),it({selectedValue:"",resetInput:!0}),document.getElementById("res-start").value="",document.getElementById("res-start-time").value="",document.getElementById("res-end").value="",document.getElementById("res-end-time").value="",document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),Ot({clearValue:!1}),Tt({selectedValue:"",resetInput:!0});const s=document.getElementById("equipment-description");s&&(s.value="");const r=document.getElementById("res-payment-status");r&&(r.value="unpaid",Je(r,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),ti(),As([]),yi("form-reset"),lt(),mt(),he()}function Wi(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s}=n.dataset;if(a==="decrease-group"&&s){Hi(s);return}if(a==="increase-group"&&s){Oi(s);return}if(a==="remove-group"&&s){zi(s);return}}),e.dataset.listenerAttached="true")}function Ji(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(cn()!=="single")return;const s=e.value;s?.trim()&&(clearTimeout(t),t=null,Vs(s,e))};e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||cn()!=="single")return;const{start:r,end:i}=kt();!r||!i||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function Xi(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async n=>{n.preventDefault(),await Ka()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async n=>{n.preventDefault(),await Ka()}),t.dataset.listenerAttached="true")}function Xc({onAfterSubmit:e}={}){Rn=typeof e=="function"?e:null;const{customers:t,projects:n}=xe();pi(t||[]),it(),va(),Rs(n||[]),Hs({projectsList:n}),ha(),pt(),En(),Bi(),Us(),Ws(),Ui(),Vi(),Wi(),Ji(),Xi(),Ci(),he(),lt()}function Js(){pt(),En(),Hs(),it(),va(),ha(),Us(),Ws(),lt(),he()}if(typeof document<"u"){const e=()=>{it(),Tt({projectsList:ga()}),va(),ha(),he()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{pt()}),document.addEventListener("packages:changed",()=>{En(),cn()==="package"&&Kn("package")})}typeof window<"u"&&(window.getCompanySharePercent=Ct);function en(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function Yi(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],s=Number.parseInt(a,10);return Number.isFinite(s)?s:null}function Zi(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=Yi(n);if(a!==null)return a}return null}function Qa(e,t=0){const n=Zi(e);if(n!=null)return n;const a=en(e.createdAt??e.created_at);if(a!=null)return a;const s=en(e.updatedAt??e.updated_at);if(s!=null)return s;const r=en(e.start);if(r!=null)return r;const i=en(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(t)?t:0}function eo({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:s}){const r=e.map((b,j)=>({reservation:b,index:j})),i=t.searchTerm||"",o=t.searchReservationId||"",d=t.searchCustomerName||"",u=t.searchProjectId||"",l=t.startDate||"",y=t.endDate||"",f=t.status||"",m=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,p=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,g=l?new Date(`${l}T00:00:00`):null,h=y?new Date(`${y}T23:59:59`):null,x=r.filter(({reservation:b})=>{const j=n.get(String(b.customerId)),S=s?.get?.(String(b.projectId)),z=b.start?new Date(b.start):null,A=fs(b),{effectiveConfirmed:k}=Bt(b,S);if(m!=null&&String(b.customerId)!==String(m)||p!=null&&!(Array.isArray(b.technicians)?b.technicians.map(F=>String(F)):[]).includes(String(p))||f==="confirmed"&&!k||f==="pending"&&k||f==="completed"&&!A)return!1;if(f==="cancelled"){const C=String(b?.status||b?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(C))return!1}if(g&&z&&z<g||h&&z&&z>h)return!1;if(o){const C=[b.reservationId,b.id,b.reservation_id,b.reservationCode,b.reservation_code,b.code,b.reference,b.referenceNumber,b.reference_number],F=We(C.filter(N=>N!=null&&N!=="").map(String).join(" ")).replace(/\s+/g,""),J=o.replace(/\s+/g,"");if(!F.includes(J))return!1}if(d&&!We(j?.customerName||b.customerName||"").includes(d))return!1;if(u){const C=[b.projectId,b.project_id,b.projectID,S?.id,S?.projectCode,S?.project_code],F=We(C.filter(N=>N!=null&&N!=="").map(String).join(" ")).replace(/\s+/g,""),J=u.replace(/\s+/g,"");if(!F.includes(J))return!1}if(!i)return!0;const M=b.items?.map?.(C=>`${C.barcode} ${C.desc}`).join(" ")||"",L=(b.technicians||[]).map(C=>a.get(String(C))?.name).filter(Boolean).join(" ");return We([b.reservationId,j?.customerName||b.customerName,b.notes,M,L,S?.title].filter(Boolean).join(" ")).includes(i)});return x.sort((b,j)=>{const S=Qa(b.reservation,b.index),z=Qa(j.reservation,j.index);return S!==z?z-S:j.index-b.index}),x}function to({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const s=c("reservations.create.summary.currency","SR"),r=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),d=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),u=c("reservations.list.crew.separator","ØŒ "),l=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),y=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),f=c("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ"),m=c("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),p=c("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),g=c("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),h=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),x=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),b=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),j={client:c("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:S,index:z})=>{const A=t.get(String(S.customerId)),k=S.projectId?a?.get?.(String(S.projectId)):null,M=fs(S),L=Qt({totalAmount:Q,paidAmount:S.paidAmount,paidPercent:S.paidPercent,history:S.paymentHistory||S.payment_history||[]});let C=Gt({manualStatus:S.paidStatus||S.paid_status||(S.paid?"paid":"unpaid"),paidAmount:L.paidAmount,paidPercent:L.paidPercent,totalAmount:Q});if(k)try{const{totalWithTax:ee}=hi(k)||{totalWithTax:0},V=Qt({totalAmount:ee,paidAmount:k.paidAmount,paidPercent:k.paidPercent,history:k.paymentHistory||k.payments||[]}),be=Gt({manualStatus:k.paymentStatus||"unpaid",paidAmount:V.paidAmount,paidPercent:V.paidPercent,totalAmount:ee});be&&(C=be)}catch{}const F=C==="paid",J=C==="partial",{effectiveConfirmed:N,projectLinked:B}=Bt(S,k),O=N?"status-confirmed":"status-pending",Y=F?"status-paid":J?"status-partial":"status-unpaid";let G=`<span class="reservation-chip status-chip ${O}">${N?l:y}</span>`;const D=F?m:J?g:p;let W=`<span class="reservation-chip status-chip ${Y}">${D}</span>`,R=F?" tile-paid":J?" tile-partial":" tile-unpaid";M&&(R+=" tile-completed");let ie="";M&&(G=`<span class="reservation-chip status-chip status-completed">${f}</span>`,W=`<span class="reservation-chip status-chip status-completed">${D}</span>`,ie=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…Ù†ØªÙ‡ÙŠ").replace(/"/g,"&quot;")}"`);let ve=!B&&!N?`<button class="tile-confirm" data-reservation-index="${z}" data-action="confirm">${h}</button>`:"";{const ee=String(S?.status||S?.reservationStatus||"").toLowerCase();(ee==="cancelled"||ee==="canceled")&&(G=`<span class="reservation-chip status-chip status-cancelled">${c("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ")}</span>`,R=" tile-cancelled",ie="",typeof ve<"u"&&(ve=""))}const Se=ve?`<div class="tile-actions">${ve}</div>`:"",je=S.items?.length||0,me=Array.isArray(S.crewAssignments)?S.crewAssignments:[],Ve=(S.technicians||[]).map(ee=>n.get(String(ee))).filter(Boolean),ze=me.length?me.map(ee=>{const V=ee.positionLabel??ee.position_name??ee.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),be=ee.technicianName??n.get(String(ee.technicianId??""))?.name??null;return be?`${q(V)} (${q(be)})`:q(V)}):Ve.map(ee=>ee.name),qe=ze.length?ze.join(u):"â€”",Le=q(String(S.reservationId??"")),Be=S.start?q(ot(S.start)):"-",H=S.end?q(ot(S.end)):"-",ae=S.discount??S.discountValue??S.discount_value??S.discountAmount??0,ye=Number.parseFloat(q(String(ae))),oe=Number.isFinite(ye)?ye:0,Ie=S.discountType??S.discount_type??S.discountMode??"percent",pe=String(Ie).toLowerCase()==="amount"?"amount":"percent",_e=!!(S.applyTax??S.apply_tax??S.taxApplied),Ce=S.companySharePercent??S.company_share_percent??S.companyShare??S.company_share,Me=S.companyShareEnabled??S.company_share_enabled??S.companyShareApplied,P=Number.parseFloat(q(String(Ce))),T=(Me===!0||Number.isFinite(P)&&P>0)&&Number.isFinite(P)?P:0;let K=0;try{const ee=ca({items:S.items||[],technicianIds:S.technicians||[],crewAssignments:Array.isArray(S.crewAssignments)?S.crewAssignments:[],discount:oe,discountType:pe,applyTax:_e,start:S.start,end:S.end,companySharePercent:T,groupingSource:S}),V=Number(ee?.finalTotal||0);K=Number.isFinite(V)?Number(V.toFixed(2)):0}catch{K=0}const U=Number.parseFloat(q(String(S.cost??0)))||0,Q=K>0?K:U,Z=q(Q.toFixed(2)),re=q(String(je)),ce=S.notes?q(S.notes):o,Pe=d.replace("{count}",re),He=S.applyTax?`<small>${r}</small>`:"";let we=x;return S.projectId&&(we=k?.title?q(k.title):b),`
      <div class="${ve?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${R}"${ie} data-reservation-index="${z}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${Le}</div>
          <div class="tile-badges">
            ${G}
            ${W}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${j.client}</span>
            <span class="tile-value">${A?.customerName||S.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${j.project}</span>
            <span class="tile-value">${we}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${j.start}</span>
            <span class="tile-value tile-inline">${Be}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${j.end}</span>
            <span class="tile-value tile-inline">${H}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${j.cost}</span>
            <span class="tile-value">${Z} ${s} ${He}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${j.equipment}</span>
            <span class="tile-value">${Pe}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${j.crew}</span>
            <span class="tile-value">${ze.length?qe:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${ce}</span>
          </div>
        </div>
        ${Se}
      </div>
    `}).join("")}const no=""+new URL("Tajawal-400.ttf",import.meta.url).href,ao=""+new URL("Tajawal-500.ttf",import.meta.url).href,Ga=""+new URL("Tajawal-700.ttf",import.meta.url).href,Xs="reservations.quote.sequence",Wa={reservation:"reservations.quote.togglePrefs.v1",project:"projects.quote.togglePrefs.v1"},Ys="https://help.artratio.sa/guide/quote-preview",Re={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"Ø´Ø±ÙƒØ© ÙÙˆØ¯ Ø¢Ø±Øª Ù„Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø´Ø±ÙƒØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯)",commercialRegistry:"4030485240",beneficiaryName:"Ø´Ø±ÙƒØ© ÙÙˆØ¯ Ø¢Ø±Øª Ù„Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø´Ø±ÙƒØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯)",bankName:"Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ",accountNumber:"Ù£Ù¥Ù¨Ù Ù Ù Ù Ù¡Ù Ù Ù Ù¦Ù Ù¨Ù¦Ù Ù¦Ù¥Ù§Ù Ù¦",iban:"SA1680000358608016065706",approvalNote:"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ØªØ¹ØªØ¨Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…."},so=["ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„ Ù‡Ùˆ 12 Ø³Ø§Ø¹Ø©ØŒ ÙˆÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù†ØµÙ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ 20 Ø³Ø§Ø¹Ø©ØŒ Ø«Ù… ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.","ÙŠÙ…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ø£Ù†Ø´Ø·Ø© ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©.","ÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø£ÙŠ ØªÙ„Ù Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù†.","ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©.","ÙŠØªÙ… ÙØ±Ø¶ Ø±Ø³ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù‚Ø¨Ù„ 24 Ø³Ø§Ø¹Ø©."],Ke=[...so],ro=["ÙŠØªÙ… Ø¯ÙØ¹ 50% Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±ØŒ ÙˆÙŠØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù€ 50% Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.","ÙŠØ­ØµÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ±Ø§Ù‡ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ØŒ Ø¨ÙŠÙ†Ù…Ø§ ØªØ­ØªÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… ÙˆÙ„Ø§ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø§ Ù„Ù… ÙŠÙØªÙÙ‚ Ø¹Ù„Ù‰ ØºÙŠØ± Ø°Ù„Ùƒ.","ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ù„Ù„ØªÙ†ÙÙŠØ°ØŒ ÙˆØ£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ ØªØ®Ø¶Ø¹ Ù„Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©.","Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ØªÙˆÙÙŠØ± Ø§Ù„ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„ØªØµÙˆÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙˆØ£ÙŠ ØªØ£Ø®ÙŠØ± Ù†Ø§ØªØ¬ Ø¹Ù† Ø°Ù„Ùƒ Ù‚Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….","ØªÙØ­ÙÙØ¸ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù…Ø¯Ø© 12 Ø´Ù‡Ø±Ø§Ù‹ ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ø±ÙƒØ©ØŒ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø·Ù„Ø¨ Ù†Ø³Ø® Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ù„Ø§Ù„ ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©.","ÙŠØªØ­Ù…Ù‘Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„ Ø¢Ù…Ù†Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØµÙˆÙŠØ±ØŒ ÙˆÙŠØ¶Ù…Ù† Ø§ØªØ®Ø§Ø° ÙƒØ§ÙØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…ØªÙ‡Ù…."];function Qn(e){return e?e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0):[...Ke]}function io(){const e=document.getElementById("reservation-terms");if(e&&e.value.trim().length>0){const a=Qn(e.value);if(a.length)return a}const t=document.getElementById("edit-res-terms");if(t&&t.value.trim().length>0){const a=Qn(t.value);if(a.length)return a}const n=Ke.join(`
`);return e&&e.value.trim().length===0&&(e.value=n),t&&t.value.trim().length===0&&(t.value=n),[...Ke]}const oo=[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"financialSummary",labelKey:"reservations.quote.sections.financial",fallback:"Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"payment",labelKey:"reservations.quote.sections.payment",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹",defaultSelected:!1}],In=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>v(q(String(t+1)))},{id:"code",labelKey:"reservations.details.table.headers.code",fallback:"Ø§Ù„ÙƒÙˆØ¯",render:e=>{if(e?.isPackage){const t=e?.packageCodeResolved||e?.barcode||"";return v(t||"-")}return v(e?.barcode||"-")}},{id:"description",labelKey:"reservations.details.table.headers.description",fallback:"Ø§Ù„ÙˆØµÙ",render:e=>{const t=String(e?.desc||e?.description||"-");return`<div class="quote-cell quote-cell--desc">${v(t)}</div>`}},{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:e=>v(q(String(e?.qty||1)))},{id:"unitPrice",labelKey:null,fallback:"Ù„ÙƒÙ„ ÙŠÙˆÙ…",render:e=>v(q(Number(e?.unitPriceValue||0).toFixed(2)))},{id:"price",labelKey:null,fallback:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",render:e=>v(q(Number(e?.price||0).toFixed(2)))}],kn=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>v(q(String(t+1)))},{id:"position",labelKey:"reservations.details.crew.position",fallback:"Ø§Ù„Ù…Ù†ØµØ¨",render:e=>v(q(e?.positionLabel??e?.position_name??e?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")))},{id:"unitPrice",labelKey:null,fallback:"Ù„ÙƒÙ„ ÙŠÙˆÙ…",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return v(`${q(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}},{id:"price",labelKey:null,fallback:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return v(`${q(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}}],Gn={customerInfo:[{id:"customerName",labelKey:"reservations.details.labels.customer",fallback:"Ø§Ù„Ø¹Ù…ÙŠÙ„"},{id:"customerCompany",labelKey:"reservations.details.labels.company",fallback:"Ø§Ù„Ø´Ø±ÙƒØ©"},{id:"customerPhone",labelKey:"reservations.details.labels.phone",fallback:"Ø§Ù„Ù‡Ø§ØªÙ"},{id:"customerEmail",labelKey:"reservations.details.labels.email",fallback:"Ø§Ù„Ø¨Ø±ÙŠØ¯"}],reservationInfo:[{id:"reservationId",labelKey:"reservations.details.labels.reservationId",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationStart",labelKey:"reservations.details.labels.start",fallback:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationEnd",labelKey:"reservations.details.labels.end",fallback:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationDuration",labelKey:"reservations.details.labels.duration",fallback:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"}],projectInfo:[{id:"projectTitle",labelKey:"reservations.details.labels.project",fallback:"Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectCode",labelKey:"reservations.details.labels.code",fallback:"Ø§Ù„Ø±Ù…Ø²"}],financialSummary:[{id:"discountAmount",labelKey:"reservations.details.labels.discount",fallback:"Ø§Ù„Ø®ØµÙ…"},{id:"subtotalBeforeTax",labelKey:"reservations.details.labels.subtotalBeforeTax",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"taxAmount",labelKey:"reservations.details.labels.tax",fallback:"Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"finalTotal",labelKey:"reservations.details.labels.total",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"}],payment:[{id:"beneficiary",labelKey:"reservations.quote.labels.beneficiary",fallback:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"},{id:"bank",labelKey:"reservations.quote.labels.bank",fallback:"Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"},{id:"account",labelKey:"reservations.quote.labels.account",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"},{id:"iban",labelKey:"reservations.quote.labels.iban",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"}],items:[...In.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"}],crew:[...kn.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"}]},Zs=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>v(q(String(t+1)))},{id:"label",labelKey:null,fallback:"Ø§Ù„Ø¨Ù†Ø¯",render:e=>v(e?.label||"-")},{id:"amount",labelKey:null,fallback:"Ø§Ù„Ø³Ø¹Ø±",render:e=>{const t=Number.isFinite(Number(e?.salePrice??e?.sale_price))?Number(e?.salePrice??e?.sale_price):Number(e?.amount??0)||0;return v(ge(t,c("reservations.create.summary.currency","SR")))}},{id:"note",labelKey:null,fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª",render:e=>v(e?.note||"-")}],co=[{id:"customerInfo",labelKey:"projects.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"projectInfo",labelKey:"projects.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"projectExpenses",labelKey:"projects.quote.sections.expenses",fallback:"Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©",defaultSelected:!0},{id:"projectCrew",labelKey:"projects.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0},{id:"financialSummary",labelKey:"projects.quote.sections.financial",fallback:"Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",defaultSelected:!0},{id:"projectEquipment",labelKey:"projects.quote.sections.equipment",fallback:"Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"projectNotes",labelKey:"projects.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"payment",labelKey:"reservations.quote.sections.payment",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹",defaultSelected:!1}],lo={customerInfo:Gn.customerInfo,projectInfo:[{id:"projectTitle",labelKey:"projects.details.overview.heading",fallback:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectCode",labelKey:"projects.details.labels.code",fallback:"Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectType",labelKey:"projects.details.type",fallback:"Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectStart",labelKey:"projects.details.start",fallback:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectEnd",labelKey:"projects.details.end",fallback:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectDuration",labelKey:"projects.details.duration",fallback:"Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectStatus",labelKey:"projects.details.status",fallback:"Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"}],financialSummary:[{id:"reservationsTotal",labelKey:"projects.details.reservationsTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"},{id:"discountAmount",labelKey:"projects.details.summary.discount",fallback:"Ø§Ù„Ø®ØµÙ…"},{id:"taxAmount",labelKey:"projects.details.summary.combinedTax",fallback:"Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"overallTotal",labelKey:"projects.details.summary.overallTotal",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"}],payment:Gn.payment,projectExpenses:[...Zs.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"expensesSubtotal",labelKey:"projects.details.expensesTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"}],projectCrew:[...kn.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©"},{id:"days",labelKey:null,fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"}],projectEquipment:[...In.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:null,fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"}],projectNotes:[]},Nn=new Map;function Pn(e="reservation"){if(Nn.has(e))return Nn.get(e);const t=e==="project"?co:oo,n=e==="project"?lo:Gn,a=new Set(t.map(({id:i})=>i)),s=Object.fromEntries(Object.entries(n).map(([i,o=[]])=>[i,new Set(o.map(d=>d.id))])),r={sectionDefs:t,fieldDefs:n,sectionIdSet:a,fieldIdMap:s};return Nn.set(e,r),r}function $n(e="reservation"){return Pn(e).sectionDefs}function er(e="reservation"){return Pn(e).fieldDefs}function tr(e="reservation"){return Pn(e).sectionIdSet}function nr(e="reservation"){return Pn(e).fieldIdMap}function ar(e){switch(e){case"export":return c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF...");case"render":default:return c("reservations.quote.status.rendering","Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...")}}const uo="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",mo="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",po="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",sr=wi.trim(),rr=`
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 400; font-display: swap; src: url(${JSON.stringify(no)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 500; font-display: swap; src: url(${JSON.stringify(ao)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 600; font-display: swap; src: url(${JSON.stringify(Ga)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 700; font-display: swap; src: url(${JSON.stringify(Ga)}) format('truetype'); }
`,ir=/^data:image\/svg\+xml/i,fo=/\.svg($|[?#])/i,zt=512,Wn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/B8AAusB9YwpClgAAAAASUVORK5CYII=",or=96,cr=25.4,Jn=210,nn=297,an=Math.round(Jn/cr*or),sn=Math.round(nn/cr*or);function Fe(e){const t=Number(e),n=Number.isFinite(t)?t:0;try{const a=Math.abs(n%1)>1e-9;return q(n.toLocaleString("en-US",{minimumFractionDigits:a?2:0,maximumFractionDigits:2}))}catch{return Number.isInteger(n)?q(String(n)):q(n.toFixed(2))}}let pn=!1,fn=null;function lr(){pn||(fn=async function(){try{if(!E||!X?.modal?.classList.contains("show")||(E.context||"reservation")!=="reservation")return;const n=E.reservation;if(!n)return;const a=[n.id,n.reservationId,n.reservation_id,n.reservationCode,n.reservation_code].map(l=>l==null?"":String(l)).filter(l=>l.length>0);if(!a.length)return;const s=An(),r=(Array.isArray(s)?s:[]).find(l=>[l?.id,l?.reservationId,l?.reservation_id,l?.reservationCode,l?.reservation_code].map(f=>f==null?"":String(f)).filter(f=>f.length>0).some(f=>a.includes(f)));if(!r)return;const i=Pa(r),{totalsDisplay:o,totals:d,rentalDays:u}=Er(r,i,E.project);E.reservation=r,E.crewAssignments=i,E.totals=d,E.totalsDisplay=o,E.rentalDays=u,Cr(),ft()}catch(t){console.warn("[reservationPdf] live update failed",t)}},document.addEventListener("reservations:changed",fn),pn=!0)}function dr(){if(pn){try{document.removeEventListener("reservations:changed",fn)}catch{}fn=null,pn=!1}}const ur=2,mr=/safari/i,yo=/(iphone|ipad|ipod)/i,Ja=/(iphone|ipad|ipod)/i,go=/(crios|fxios|edgios|opios)/i,yn="[reservations/pdf]";let X=null,E=null,tt=1,Rt=null,Mt=null,dt=null,Pt=null,Vt=!1;function vt(e="render",{message:t,actionLabel:n,onAction:a,showSpinner:s=e!=="error"}={}){if(!X?.statusIndicator||!X?.statusText)return;X.statusKind=e;const r=t||ar(e);X.statusText.textContent=r,X.statusSpinner&&(X.statusSpinner.hidden=!s),X.statusAction&&(X.statusAction.hidden=!0,X.statusAction.onclick=null,n&&typeof a=="function"&&(X.statusAction.textContent=n,X.statusAction.hidden=!1,X.statusAction.onclick=i=>{i.preventDefault(),a()})),X.statusIndicator.hidden=!1,requestAnimationFrame(()=>{X.statusIndicator.classList.add("is-visible")})}function $t(e){try{return String(e||"").toLowerCase().normalize("NFKD").replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,"").replace(/\s+/g," ").trim()}catch{return String(e||"").trim().toLowerCase()}}function Ut(e){!X?.statusIndicator||!X?.statusText||(X.statusKind=null,X.statusIndicator.classList.remove("is-visible"),setTimeout(()=>{X?.statusIndicator&&(X.statusIndicator.hidden=!0,X.statusAction&&(X.statusAction.hidden=!0,X.statusAction.onclick=null),X.statusSpinner&&(X.statusSpinner.hidden=!1))},220))}function Xn(){return!!window?.bootstrap?.Modal}function bo(e){if(e&&!e.classList.contains("show")){e.classList.add("show"),e.style.display="block",e.removeAttribute("aria-hidden"),e.setAttribute("aria-modal","true"),e.getAttribute("role")||e.setAttribute("role","dialog"),document.body.classList.add("modal-open"),dt||(dt=document.createElement("div"),dt.className="modal-backdrop fade show",dt.dataset.quotePdfFallbackBackdrop="true",document.body.appendChild(dt)),Pt||(Pt=t=>{t.key==="Escape"&&Yn(e)},document.addEventListener("keydown",Pt));try{e.focus({preventScroll:!0})}catch{}}}function Yn(e){if(!(!e||!e.classList.contains("show"))){try{const t=e.ownerDocument?.activeElement;if(t&&e.contains(t)){try{t.blur()}catch{}try{e.ownerDocument?.body?.focus({preventScroll:!0})}catch{}}}catch{}e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal"),document.body.classList.remove("modal-open"),dt&&(dt.remove(),dt=null),Pt&&(document.removeEventListener("keydown",Pt),Pt=null);try{dr()}catch{}}}function ho(e){if(e){if(Xn()){const t=window.bootstrap.Modal.getOrCreateInstance(e);try{const n=()=>{try{const a=document.activeElement;if(a&&e.contains(a)){try{a.blur()}catch{}try{document.body?.focus({preventScroll:!0})}catch{}}}catch{}try{dr()}catch{}try{e.removeEventListener("hidden.bs.modal",n)}catch{}};e.addEventListener("hidden.bs.modal",n,{once:!0}),e.addEventListener("hide.bs.modal",()=>{try{const a=document.activeElement;if(a&&e.contains(a))try{a.blur()}catch{}}catch{}})}catch{}t.show();return}bo(e)}}function vo(){if(Vt)return;Vt=!0;const e=c("reservations.quote.toast.viewGuide","ğŸ“˜ Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹"),t=c("reservations.quote.toast.retry","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"),n=c("reservations.quote.toast.assetsFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± Ø¶Ù…Ù† Ø¹Ø±Ø¶ Ø³Ø¹Ø±."),a=!!X?.modal?.classList.contains("show"),s=()=>{X?.modal?.classList.contains("show")&&(vt("render"),Vt=!1,ft())};ls({message:n,duration:9e3,actionLabel:a?t:void 0,onAction:a?s:void 0,linkLabel:e,linkHref:Ys}),a&&vt("error",{message:n,actionLabel:t,onAction:s,showSpinner:!1})}function xn(e="reservation"){const t={},n=er(e);return Object.entries(n).forEach(([a,s=[]])=>{t[a]=new Set(s.filter(r=>r?.default!==!1).map(r=>r.id))}),t}function wa(e={}){const t={};return Object.entries(e).forEach(([n,a])=>{t[n]=new Set(Array.from(a||[]))}),t}function So(e={},t){if(t)return e[t]||(e[t]=new Set),e[t]}function Aa(e={},t,n){const a=e?.[t];return a?a instanceof Set?a.has(n):Array.isArray(a)?a.includes(n):!!a?.[n]:!0}function qa(e="reservation"){return Object.fromEntries($n(e).map(({id:t})=>[t,!1]))}function Ea(e,t){return e.sectionExpansions||(e.sectionExpansions=qa(e.context||"reservation")),t&&typeof e.sectionExpansions[t]!="boolean"&&(e.sectionExpansions[t]=!1),e.sectionExpansions}function wo(e,t){return Ea(e,t)?.[t]!==!1}function Ia(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches}function Ao(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||navigator.platform||"";return yo.test(e)}function qo(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=mr.test(e),n=e.includes("Chrome")||e.includes("CriOS")||e.includes("Chromium"),a=e.includes("Edg");return t&&!n&&!a}function pr(){return Ao()&&qo()}function _n(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=navigator.platform||"",n=Number.isFinite(navigator.maxTouchPoints)?navigator.maxTouchPoints:0,a=Ja.test(e)||Ja.test(t),s=/Macintosh/i.test(e)&&n>1;return mr.test(e)&&!go.test(e)&&(a||s)}function Ln(e,...t){try{console.log(`${yn} ${e}`,...t)}catch{}}function nt(e,...t){try{console.warn(`${yn} ${e}`,...t)}catch{}}function Eo(e,t,...n){try{t?console.error(`${yn} ${e}`,t,...n):console.error(`${yn} ${e}`,...n)}catch{}}function Ne(e,{blockType:t="section",extraAttributes:n=""}={}){if(!e)return"";const a=n?` ${n.trim()}`:"";return e.replace(/^(<\w+)/,`$1 data-quote-block data-block-type="${t}"${a}`)}function Io(e,t="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶."){const n=v(c(e,t));return Ne(`<section class="quote-section quote-placeholder">${n}</section>`,{blockType:"placeholder"})}function gn(e,t){return Array.isArray(e)&&e.length?e:[Io(t)]}const ko=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;function fr(e=""){return ko.test(e)}function Po(){const e=window.CanvasRenderingContext2D?.prototype;if(!e||e.__artRatioDirectionPatched)return;const t=n=>{const a=e[n];typeof a=="function"&&(e[n]=function(r,...i){if(typeof r!="string"||!fr(r))return a.call(this,r,...i);let o,d=!1;try{"direction"in this&&(o=this.direction,o!=="rtl"&&(this.direction="rtl"),d=!0)}catch{}try{if(!d){const u=this.canvas;u&&u.style?.direction!=="rtl"&&(u.__artRatioOriginalDirection=u.style.direction,u.style.direction="rtl")}return a.call(this,r,...i)}finally{if(d&&o!==void 0&&o!=="rtl")try{this.direction=o}catch{}else if(!d){const u=this.canvas;u&&u.__artRatioOriginalDirection!==void 0&&(u.style.direction=u.__artRatioOriginalDirection,delete u.__artRatioOriginalDirection)}}})};t("fillText"),t("strokeText"),e.__artRatioDirectionPatched=!0}function Xa(e,t=zt){if(typeof e!="string"&&typeof e!="number")return t;const n=parseFloat(String(e).replace(/[^0-9.+-]/g,""));return Number.isFinite(n)&&n>0?n:t}function $o(e){if(!e)return{width:zt,height:zt};const t=e.getAttribute?.("width"),n=e.getAttribute?.("height");let a=t?Xa(t,0):0,s=n?Xa(n,0):0;if(a>0&&s>0)return{width:a,height:s};const r=e.getAttribute?.("viewBox");if(r){const i=r.trim().split(/[\s,]+/).map(o=>parseFloat(o||"0"));if(i.length>=4){const[,,o,d]=i;a=a||(Number.isFinite(o)&&o>0?o:0),s=s||(Number.isFinite(d)&&d>0?d:0)}}return{width:a||zt,height:s||zt}}function yr(e=""){return typeof e!="string"?!1:ir.test(e)||fo.test(e)}function xo(e=""){const t=e.indexOf(",");if(t===-1)return"";const n=e.slice(0,t),a=e.slice(t+1);try{return/;base64/i.test(n)?typeof atob=="function"?atob(a):"":decodeURIComponent(a)}catch(s){return console.warn("[reservations/pdf] failed to decode SVG data URI",s),""}}function _o(e,{crossOrigin:t}={}){return new Promise((n,a)=>{const s=new Image;t&&(s.crossOrigin=t),s.onload=()=>n(s),s.onerror=r=>{const i=r?.message||`Unable to load image from ${e}`;a(new Error(i))},s.src=e})}async function gr(e,t={}){if(!e)return null;const n=document,a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a);try{const r=await _o(s),i=n.createElement("canvas"),o=Math.max(t.width||r.naturalWidth||r.width||0,1),d=Math.max(t.height||r.naturalHeight||r.height||o,1);i.width=o,i.height=d;const u=i.getContext("2d");return u.clearRect(0,0,o,d),u.drawImage(r,0,0,o,d),i.toDataURL("image/png")}catch(r){return console.warn("[reservations/pdf] failed to rasterize SVG content",r),null}finally{URL.revokeObjectURL(s)}}async function jo(e){if(!e)return null;if(ir.test(e))return xo(e);try{const t=await fetch(e,{mode:"cors",credentials:"omit",cache:"default"});return t.ok?await t.text():(console.warn("[reservations/pdf] failed to fetch SVG image",e,t.status),null)}catch(t){return console.warn("[reservations/pdf] error fetching SVG image",e,t),null}}async function Co(e){if(!e)return!1;const t=e.getAttribute?.("src")||"";if(!yr(t))return!1;const n=await jo(t);if(!n)return e.dataset.svgRasterization="failed",e.setAttribute("src",Wn),!1;const a=await gr(n);return a?(e.dataset.svgOriginalSrc=t,e.setAttribute("src",a),e.setAttribute("data-rasterized","true"),!0):(e.dataset.svgRasterization="failed",e.setAttribute("src",Wn),!1)}async function To(e){if(!e||e.tagName?.toLowerCase()!=="svg")return!1;const n=new XMLSerializer().serializeToString(e),a=$o(e),s=await gr(n,a),i=(e.ownerDocument||document).createElement("img");i.setAttribute("src",s||Wn),i.setAttribute("alt",e.getAttribute("aria-label")||e.getAttribute("title")||""),i.setAttribute("data-svg-replaced","true"),e.hasAttribute("class")&&i.setAttribute("class",e.getAttribute("class")),e.hasAttribute("style")&&i.setAttribute("style",e.getAttribute("style"));const o=e.getAttribute("width"),d=e.getAttribute("height");return o&&i.setAttribute("width",o),d&&i.setAttribute("height",d),e.parentNode?.replaceChild(i,e),!!s}async function br(e){if(!e)return;const t=Array.from(e.querySelectorAll?.("img")||[]),n=Array.from(e.querySelectorAll?.("svg")||[]),a=[];t.forEach(s=>{yr(s.getAttribute?.("src"))&&a.push(Co(s))}),n.forEach(s=>{a.push(To(s))}),a.length&&await Promise.allSettled(a)}function No(e,{pixelRatio:t=1}={}){if(!e)return null;const n=e.ownerDocument||document,s=(n.defaultView||window).getComputedStyle?.(e);if(!s)return null;const r=(D,W=0)=>{const R=parseFloat(D);return Number.isFinite(R)?R:W},i=r(s.paddingTop),o=r(s.paddingBottom),d=r(s.paddingRight),u=r(s.paddingLeft),l=r(s.borderRadius),y=r(s.fontSize,14),f=(()=>{const D=s.lineHeight;if(!D||D==="normal")return y*1.6;const W=r(D,y*1.6);return W>0?W:y*1.6})(),m=Math.max(e.clientWidth||0,e.scrollWidth||0,r(s.width,0));if(m<=0)return null;const p=Math.max(1,m-u-d),g=e.textContent||"",h=g.split(/\r?\n/),x=n.createElement("canvas"),b=x.getContext("2d");if(!b)return null;const j=s.fontStyle||"normal",S=s.fontVariant||"normal",z=s.fontWeight||"400",A=s.fontFamily||"sans-serif",k=s.fontStretch||"normal",M=D=>D.join(" "),L=[],ne=D=>b.measureText(D).width;b.font=`${j} ${S} ${z} ${k} ${y}px ${A}`,h.forEach(D=>{const W=D.trim();if(W.length===0){L.push("");return}const R=W.split(/\s+/);let ie=[];R.forEach((ve,Se)=>{const je=ve.trim();if(!je)return;const me=M(ie.concat(je));if(ne(me)<=p||ie.length===0){ie.push(je);return}L.push(M(ie)),ie=[je]}),ie.length&&L.push(M(ie))}),L.length||L.push("");const C=i+o+L.length*f,F=Math.ceil(Math.max(1,m)*t),J=Math.ceil(Math.max(1,C)*t);x.width=F,x.height=J,x.style.width=`${Math.max(1,m)}px`,x.style.height=`${Math.max(1,C)}px`,b.scale(t,t);const N=s.backgroundColor&&s.backgroundColor!=="rgba(0, 0, 0, 0)"?s.backgroundColor:"#ffffff";if(l>0){b.save(),b.beginPath();const D=Math.max(1,m),W=Math.max(1,C),R=Math.min(l,D/2,W/2);b.moveTo(R,0),b.lineTo(D-R,0),b.quadraticCurveTo(D,0,D,R),b.lineTo(D,W-R),b.quadraticCurveTo(D,W,D-R,W),b.lineTo(R,W),b.quadraticCurveTo(0,W,0,W-R),b.lineTo(0,R),b.quadraticCurveTo(0,0,R,0),b.closePath(),b.clip()}if(b.fillStyle=N,b.fillRect(0,0,Math.max(1,m),Math.max(1,C)),b.font=`${j} ${S} ${z} ${k} ${y}px ${A}`,b.fillStyle=s.color||"#000000",b.textBaseline="top",b.textAlign="right","direction"in b)try{b.direction="rtl"}catch{}const B=Math.max(0,m-d);let O=i;L.forEach(D=>{const W=D.length?D:" ";b.fillText(W,B,O,p),O+=f});const Y=n.createElement("img");let G;try{G=x.toDataURL("image/png")}catch(D){return nt("note canvas toDataURL failed",D),null}return Y.src=G,Y.alt=g,Y.style.width=`${Math.max(1,m)}px`,Y.style.height=`${Math.max(1,C)}px`,Y.style.display="block",Y.setAttribute("data-quote-note-image","true"),{image:Y,canvas:x,totalHeight:C,width:m}}function Lo(e,{pixelRatio:t=1}={}){if(!e||!_n())return;Array.from(e.querySelectorAll?.(".quote-notes")||[]).forEach(a=>{if(!a||a.dataset.quoteNoteRasterized==="true"||!fr(a.textContent||""))return;let s;try{s=No(a,{pixelRatio:t})}catch(r){nt("failed to rasterize note content",r),s=null}s&&(a.dataset.quoteNoteRasterized="true",a.innerHTML="",a.appendChild(s.image))})}function Zn(e,t="export",{toastMessage:n,suppressToast:a=!1}={}){Eo(`${t} failed`,e);const s=!!(e&&e.__artRatioPdfNotified);if(!a&&!s){const r=c("reservations.quote.errors.exportFailed","âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDFØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."),i=n||r,o=c("reservations.quote.toast.viewGuide","ğŸ“˜ Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹"),d=c("reservations.quote.toast.retry","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"),u=["exportQuoteAsPdf","renderQuotePreview","layoutQuoteDocument","pageCapture"].includes(t),l=()=>{t==="exportQuoteAsPdf"?(vt("export"),Tr()):(vt("render"),Vt=!1,ft())};if(ls({message:i,duration:9e3,actionLabel:u?d:void 0,onAction:u?l:void 0,linkLabel:o,linkHref:Ys}),X?.modal?.classList.contains("show")&&vt("error",{message:i,actionLabel:u?d:void 0,onAction:u?l:void 0,showSpinner:!1}),e&&typeof e=="object")try{Object.defineProperty(e,"__artRatioPdfNotified",{value:!0,writable:!1,enumerable:!1,configurable:!0})}catch{}}}function ea({container:e,safariWindowRef:t,mobileWindowRef:n}={}){try{n&&!n.closed&&n.close()}catch(a){nt("failed to close mobile window",a)}try{t&&!t.closed&&t.close()}catch(a){nt("failed to close safari window",a)}e&&e.parentNode&&e.parentNode.removeChild(e)}function ka(e){return new Promise((t,n)=>{const a=document.querySelector(`script[src="${e}"]`);if(a){a.addEventListener("load",()=>t()),a.addEventListener("error",r=>n(r)),a.readyState==="complete"&&t();return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>t(),s.onerror=r=>n(r),document.head.appendChild(s)})}function Ya(){const e=[window.jspdf?.jsPDF,typeof window.jspdf=="function"?window.jspdf:null,window.jsPDF?.jsPDF,typeof window.jsPDF=="function"?window.jsPDF:null].filter(t=>typeof t=="function");return e.length?e[0]:null}function Za(){return typeof window.html2canvas=="function"?window.html2canvas:null}async function Bo(){const e=Za();return e||(Mt||(Mt=ka(mo).catch(t=>{throw Mt=null,t}).then(()=>{const t=Za();if(!t)throw Mt=null,new Error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© html2canvas Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");return t})),Mt)}async function Do(){const e=Ya();return e||(Rt||(Rt=ka(po).catch(t=>{throw Rt=null,t}).then(()=>{const t=Ya();if(!t)throw Rt=null,new Error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© jsPDF Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");return t})),Rt)}async function Fo(){if(window.html2pdf||await ka(uo),window.html2pdf&&!window.html2pdf.__artRatioConfigured){const e=window.html2pdf.defaultOptions||window.html2pdf.defaultOpt||{},t={...e.html2canvas||{}};t.useCORS=!0,t.allowTaint=!1,t.logging=!0;const n={unit:"mm",format:"a4",orientation:"portrait",compress:!0,...e.jsPDF||{}},a={image:{type:"jpeg",quality:.95,...e.image||{}},margin:e.margin??[0,0,0,0],filename:e.filename||"document.pdf",html2canvas:t,jsPDF:n};window.html2pdf.defaultOptions=a,window.html2pdf.defaultOpt=a,window.html2pdf.__artRatioConfigured=!0}Ai(),Po()}function v(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ro(e="reservation"){return e==="project"?"QP":"Q"}function bn(e,t="reservation"){const n=Number(e),a=Ro(t);return!Number.isFinite(n)||n<=0?`${a}-0001`:`${a}-${String(n).padStart(4,"0")}`}function hr(e="reservation"){return e==="project"?"quote_project":"quote_reservation"}async function Mo(e="reservation"){const t=hr(e);try{const n=await Ue(`/sequence/?name=${encodeURIComponent(t)}`,{method:"POST"}),a=Number(n?.value),s=Number.isFinite(a)&&a>0?a:1;return{sequence:s,quoteNumber:bn(s,e)}}catch(n){console.warn("âš ï¸ [reservations/pdf] sequence reservation failed, falling back to local",n);const a=window.localStorage?.getItem?.(Xs),r=(Number.isFinite(parseInt(a??"",10))?parseInt(a??"",10):0)+1;return{sequence:r,quoteNumber:bn(r,e)}}}async function vr(e="reservation"){const t=hr(e);try{const n=await Ue(`/sequence/?name=${encodeURIComponent(t)}`,{method:"GET"}),a=Number(n?.value),s=Number.isFinite(a)&&a>=0?a+1:1;return{sequence:s,quoteNumber:bn(s,e)}}catch(n){return console.warn("âš ï¸ [reservations/pdf] sequence peek failed, falling back to 1",n),{sequence:1,quoteNumber:bn(1,e)}}}function Sr(e="reservation"){return Wa[e]||Wa.reservation}function Ho(){try{window.localStorage?.removeItem?.(Xs)}catch{}}function zo(e="reservation"){try{Ho();const t=Sr(e),n=window.localStorage?.getItem?.(t);if(!n)return null;const a=JSON.parse(n);return a&&typeof a=="object"?a:null}catch(t){return console.warn("âš ï¸ [reservations/pdf] failed to read toggle preferences",t),null}}function Oo(e,t="reservation"){try{const n=Sr(t);if(!e){window.localStorage?.removeItem?.(n);return}window.localStorage?.setItem?.(n,JSON.stringify(e))}catch(n){console.warn("âš ï¸ [reservations/pdf] failed to persist toggle preferences",n)}}function Vo(e){if(!e)return{ids:null,emptyExplicitly:!1};if(e instanceof Set)return{ids:Array.from(e),emptyExplicitly:e.size===0};if(Array.isArray(e))return{ids:e.slice(),emptyExplicitly:e.length===0};if(typeof e=="object"){const t=Object.entries(e).filter(([,n])=>!!n);return{ids:t.map(([n])=>n),emptyExplicitly:t.length===0}}return{ids:null,emptyExplicitly:!1}}function Uo(e,t="reservation"){if(!e)return null;const n=tr(t),a=nr(t),s=Array.from(e.sections instanceof Set?e.sections:new Set(e.sections||[])).filter(o=>n.has(o)),r={},i=e.fields||{};return Object.entries(a).forEach(([o,d])=>{const u=i[o];if(u==null)return;const{ids:l,emptyExplicitly:y}=Vo(u);if(!l&&!y)return;const f=Array.isArray(l)?l.filter(m=>d.has(m)):[];(f.length>0||y)&&(r[o]=f)}),{version:1,sections:s,fields:r}}function wr(e){if(!e)return;const t=e.context||"reservation",n=Uo(e,t);n&&Oo(n,t)}function Ar(e){if(!e)return;const t=e.context||"reservation",n=zo(t);if(!n)return;const a=tr(t),s=Array.isArray(n.sections)?n.sections.filter(r=>a.has(r)):[];if(s.length&&(e.sections=new Set(s)),n.fields&&typeof n.fields=="object"){const r=wa(e.fields||xn(t)),i=nr(t);Object.entries(n.fields).forEach(([o,d])=>{const u=i[o];if(!u)return;const l=Array.isArray(d)?d.filter(y=>u.has(y)):[];r[o]=new Set(l)}),e.fields=r}}function qr(e=new Date){try{return e.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return e.toISOString().slice(0,10)}}function Pa(e){const t=jt()||[],{technicians:n=[]}=xe(),a=[].concat(Array.isArray(t)?t:[]).concat(Array.isArray(n)?n:[]),s=new Map;return a.forEach(i=>{if(!i||i.id==null)return;const o=String(i.id),d=s.get(o)||{};s.set(o,{...d,...i})}),(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(i=>({technicianId:i}))).map((i,o)=>{const d=i?.technicianId!=null?s.get(String(i.technicianId)):null;let u=i.positionLabel??i.position_name??i.position_label??i.role??i.position??d?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");(!u||u.trim()==="")&&(u=i.positionLabelAr??i.position_label_ar??i.positionLabelEn??i.position_label_en??i.position_name_ar??i.position_name_en??d?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"));try{const f=typeof Ba=="function"?Ba()||[]:[];let m=null;if(i?.positionId!=null&&(m=f.find(p=>String(p?.id)===String(i.positionId))||null),!m){const p=i.positionKey??i.position_key??i.positionName??i.position_name??i.position??"";if(p&&(m=typeof Da=="function"&&Da(p)||null,!m&&f.length)){const g=String(p).trim().toLowerCase();m=f.find(h=>[h.name,h.labelAr,h.labelEn].filter(Boolean).map(x=>String(x).toLowerCase()).includes(g))||null}}if(m){const p=m.labelAr||m.labelEn||m.name||"";p&&p.trim()&&(u=p)}}catch{}const l=wt(_t(i.positionCost??i.position_cost??i.cost??i.daily_wage??i.dailyWage??d?.dailyWage??d?.wage??0)),y=wt(_t(i.positionClientPrice??i.position_client_price??i.client_price??i.clientPrice??i.daily_total??i.dailyTotal??i.total??d?.dailyTotal??d?.total??d?.total_wage??0));return{assignmentId:i.assignmentId??i.assignment_id??`crew-${o}`,positionId:i.positionId??i.position_id??null,positionLabel:u,positionLabelAlt:i.positionLabelAlt??i.position_label_alt??"",positionCost:l,positionClientPrice:y,technicianId:i.technicianId!=null?String(i.technicianId):d?.id!=null?String(d.id):null,technicianName:i.technicianName??i.technician_name??d?.name??null,technicianRole:i.technicianRole??d?.role??null}})}function Er(e,t,n){const{projectLinked:a}=Bt(e,n);la(e.start,e.end);const s=e.discount??e.discountValue??0,r=Number(q(String(s)))||0,i=e.discountType??e.discount_type??"percent",o=String(i).toLowerCase()==="amount"?"amount":"percent",d=a?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),u=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,l=u!=null?_t(u):Number.NaN,f=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied)===!0&&Number.isFinite(l)&&l>0?l:null,m=Array.isArray(t)?t.map(S=>S?.technicianId).filter(Boolean):[],p=ca({items:Array.isArray(e.items)?e.items:[],technicianIds:m,crewAssignments:Array.isArray(t)?t:[],discount:r,discountType:o,applyTax:d,start:e.start,end:e.end,companySharePercent:f,groupingSource:e}),g=_t(e.cost??e.total??e.finalTotal),h=Number.isFinite(g),x=a?p.finalTotal:h?wt(g):p.finalTotal,b={equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,crewCostTotal:p.crewCostTotal,discountAmount:p.discountAmount,subtotalAfterDiscount:p.subtotalAfterDiscount,taxableAmount:p.taxableAmount,taxAmount:p.taxAmount,finalTotal:x,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,netProfit:p.netProfit},j={equipmentTotal:Fe(p.equipmentTotal),crewTotal:Fe(p.crewTotal),discountAmount:Fe(p.discountAmount),subtotalAfterDiscount:Fe(p.subtotalAfterDiscount),taxableAmount:Fe(p.taxableAmount),taxAmount:Fe(p.taxAmount),finalTotal:Fe(x),companySharePercent:q((Number.isFinite(p.companySharePercent)?p.companySharePercent:0).toFixed(2)),companyShareAmount:Fe(p.companyShareAmount),netProfit:q(p.netProfit.toFixed(2))};return{totals:b,totalsDisplay:j,rentalDays:p.rentalDays}}function Nt(e){if(e==null||e==="")return null;const t=Number.parseFloat(q(String(e)));return Number.isFinite(t)?t:null}function Ir(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function Ko(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n!=="percent"&&(n="amount");const a=Nt(e.amount??(n==="amount"?e.value:null)),s=Nt(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,i=e.note??e.memo??null,o=Ir(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:i,recordedAt:o}}function Qo(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(Ko).filter(Boolean);if(n.length>0)return n;const a=Nt(e.paidPercent??e.paid_percent),s=Nt(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,i=Ir(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:i}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:i}]:[]}function Go(e){if(!e)return c("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function Wo(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function Jo(e){if(Array.isArray(e?.expenses)&&e.expenses.some(a=>Number.isFinite(Number(a?.salePrice??a?.sale_price))))return e.expenses.reduce((a,s)=>a+(Number(s?.salePrice??s?.sale_price)||0),0);const t=Number(e?.servicesClientPrice??e?.services_client_price);return Number.isFinite(t)&&t>=0?t:typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((n,a)=>n+(Number(a?.amount)||0),0):0}function Xo(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(q(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=oa(t,a,s,!1,i,{start:e.start,end:e.end,companySharePercent:0});if(Number.isFinite(o))return o;const d=Number(q(String(e.cost??0)));return Number.isFinite(d)?Math.round(d):0}function Yo(e,t){if(!e)return"â€”";const n=ot(e);return t?`${n} - ${ot(t)}`:n}function ge(e,t="SR",n=2){const a=Number(e);return`${Fe(a)} ${t}`}function es(e,t=2){if(!Number.isFinite(Number(e)))return"0%";const n=Number.isInteger(t)?t:2;return`${q(Number(e).toFixed(n))}%`}function Zo(e){if(!e?.start)return null;if(!e?.end)return 1;const t=la(e.start,e.end);return Number.isFinite(t)?t:1}function ec(e){return Number.isFinite(e)?e<=1?"ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯":`${q(String(Math.round(e)))} Ø£ÙŠØ§Ù…`:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}function ts(e){const t=c("reservations.create.summary.currency","SR"),n=xe()||{},a=Array.isArray(n.customers)?n.customers:[],s=Array.isArray(n.projects)?n.projects:[],r=Array.isArray(n.technicians)?n.technicians:[];let i=[];try{const _=An?.()||[];i=Array.isArray(_)&&_.length?_:n.reservations||[]}catch{i=n.reservations||[]}const o=e?.id!=null?s.find(_=>String(_.id)===String(e.id))||e:e||null,d={projectStatusLabel:c("projects.status.ongoing","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"),paymentStatusLabel:c("projects.paymentStatus.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹")};if(!o)return{project:null,customer:null,clientInfo:{name:"-",company:"-",phone:"-",email:"-"},projectInfo:{title:"-",code:"-",typeLabel:"-",startDisplay:"-",endDisplay:"-",durationLabel:"-",statusLabel:d.projectStatusLabel},expenses:[],equipment:[],reservations:[],totals:{equipmentEstimate:0,expensesTotal:0,baseSubtotal:0,discountAmount:0,subtotalAfterDiscount:0,companyShareAmount:0,subtotal:0,applyTax:!1,taxAmount:0,totalWithTax:0},totalsDisplay:{projectSubtotal:ge(0,t),expensesTotal:ge(0,t),reservationsTotal:ge(0,t),discountAmount:ge(0,t),taxAmount:ge(0,t),overallTotal:ge(0,t),paidAmount:ge(0,t),remainingAmount:ge(0,t)},projectTotals:{combinedTaxAmount:0,overallTotal:0,reservationsTotal:0,paidAmount:0,paidPercent:0,remainingAmount:0,paymentStatus:"unpaid"},paymentSummary:{status:"unpaid",statusLabel:d.paymentStatusLabel,paidAmount:0,paidPercent:0,remainingAmount:0,paidAmountDisplay:ge(0,t),remainingAmountDisplay:ge(0,t),paidPercentDisplay:es(0)},notes:"",currencyLabel:t,projectStatus:"ongoing",projectStatusLabel:d.projectStatusLabel,projectDurationDays:null,projectDurationLabel:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",paymentHistory:[]};const u=o.clientId??o.customerId??o.client_id??o.customer_id??null,l=u!=null&&a.find(_=>String(_.id)===String(u))||null,y=l?.customerName??l?.name??o.clientName??o.customerName??c("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),f=(o.clientCompany||l?.companyName||l?.company||"").trim(),m=l?.phone??l?.customerPhone??o.clientPhone??o.customerPhone??"",p=m?q(String(m).trim()):c("projects.details.client.noPhone","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…ØªØ§Ø­"),g=l?.email??o.clientEmail??o.customerEmail??"",h=g?String(g).trim():c("projects.details.client.noEmail","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ù…ØªØ§Ø­"),x=o.projectCode||`PRJ-${q(String(o.id??""))}`,b=q(String(x)),j=(o.title||"").trim()||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"),S=Go(o.type),z=o.start?ot(o.start):"â€”",A=o.end?ot(o.end):"â€”",k=Zo(o),M=k!=null?ec(k):"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",L=Wo(o),ne={upcoming:"Ù‚Ø§Ø¯Ù…",ongoing:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",completed:"Ù…ÙƒØªÙ…Ù„"},C=c(`projects.status.${L}`,ne[L]||L),F=o.id!=null?String(o.id):null,J=F?i.filter(_=>{const ee=_?.projectId??_?.project_id??null;return ee!=null&&String(ee)===F}):[];J.map(_=>{const ee=_.reservationId||_.id||"",V=_.status||_.state||"pending",be=String(V).toLowerCase(),w=c(`reservations.status.${be}`,be),te=Xo(_),ue=_.start?new Date(_.start).getTime():0;return{reservationId:q(String(ee||"-")),status:be,statusLabel:w,total:te,totalLabel:ge(te,t),dateRange:Yo(_.start,_.end),startTimestamp:Number.isNaN(ue)?0:ue}}).sort((_,ee)=>ee.startTimestamp-_.startTimestamp).map(({startTimestamp:_,...ee})=>ee);let N=0,B=0;try{J.forEach(_=>{const ee=ca({items:Array.isArray(_.items)?_.items:[],technicianIds:Array.isArray(_.technicians)?_.technicians:[],crewAssignments:Array.isArray(_.crewAssignments)?_.crewAssignments:[],discount:Number(_.discount??0)||0,discountType:_.discountType||"percent",applyTax:!1,start:_.start,end:_.end,groupingSource:_,companySharePercent:0});N+=Number(ee.equipmentTotal||0),B+=Number(ee.crewTotal||0)})}catch{}const O=Jo(o),Y=Number(N+B+O),G=[];try{J.forEach(_=>{const{groups:ee}=Dt(_);ee.forEach(V=>{const be=Number(V?.count??V?.quantity??1)||1,w=Number(V?.unitPrice);let te=Number.isFinite(w)?w:0;if(!te||te<=0){const se=Number(V?.totalPrice);Number.isFinite(se)&&be>0&&(te=Number((se/be).toFixed(2)))}Number.isFinite(te)||(te=0);const ue=V?.type==="package"||Array.isArray(V?.items)&&V.items.some(se=>se?.type==="package"),Ee=Array.isArray(V?.barcodes)&&V.barcodes.length?V.barcodes[0]:Array.isArray(V?.items)&&V.items.length?V.items[0]?.barcode:null;let $e=V?.packageDisplayCode??V?.package_code??V?.code??V?.packageCode??(Array.isArray(V?.items)&&V.items.length?V.items[0]?.package_code??V.items[0]?.code??V.items[0]?.packageCode:null);const Qe=se=>{const de=(se==null?"":String(se)).trim();return!!(!de||/^pkg-/i.test(de)||/^\d+$/.test(de)&&de.length<=4)};if(!$e||Qe($e)){const se=V?.packageId??V?.package_id??(Array.isArray(V?.items)&&V.items.length?V.items[0]?.packageId??V.items[0]?.package_id:null);if(se)try{const de=pa(se);de&&de.package_code&&($e=de.package_code)}catch{}}if(!$e||Qe($e))try{const se=$t(V?.description||"");if(se){const de=Es();let fe=de.find(ke=>$t(ke?.name||ke?.title||ke?.label||"")===se);fe||(fe=de.find(ke=>{const et=$t(ke?.name||ke?.title||ke?.label||"");return et.includes(se)||se.includes(et)})),fe&&fe.package_code&&($e=fe.package_code)}}catch{}const Te=ue?$e??Ee??"":V?.barcode??Ee??"",Ae=Te!=null?String(Te):"",De=Number.isFinite(Number(V?.totalPrice))?Number(V.totalPrice):Number((te*be).toFixed(2));G.push({...V,isPackage:ue,desc:V?.description,barcode:Ae,packageCodeResolved:$e||"",qty:be,price:te,totalPrice:wt(De),unitPriceValue:te})})})}catch{}const D=new Map;J.forEach(_=>{const ee=Array.isArray(_.items)?_.items:[],V=la(_.start,_.end),be=_.reservationId||_.id||"";ee.forEach((w,te)=>{if(!w)return;const ue=w.barcode||w.code||w.id||w.desc||w.description||`item-${te}`,Ee=String(ue||`item-${te}`),$e=D.get(Ee)||{description:w.desc||w.description||w.name||w.barcode||`#${q(String(te+1))}`,totalQuantity:0,reservationsCount:0,reservationIds:new Set,totalCost:0},Qe=Number(w.qty)||1,Te=Number(w.price)||0;$e.totalQuantity+=Qe,$e.reservationIds.add(String(be));const Ae=Te*Qe*Math.max(1,V);Number.isFinite(Ae)&&($e.totalCost+=Ae),D.set(Ee,$e)})});const W=Array.from(D.values()).map(_=>({description:_.description,totalQuantity:_.totalQuantity,reservationsCount:_.reservationIds.size,displayCost:ge(_.totalCost,t)})),R=new Map((r||[]).filter(Boolean).map(_=>[String(_.id),_])),ie=new Map,ve=_=>{if(!_)return;let ee=null;typeof _=="object"?ee=_.id??_.technicianId??_.technician_id??_.userId??_.user_id??null:(typeof _=="string"||typeof _=="number")&&(ee=_);const V=ee!=null?String(ee):null,be=V&&R.has(V)?R.get(V):typeof _=="object"?_:null,w=be?.name||be?.full_name||be?.fullName||be?.displayName||(typeof _=="string"?_:null),te=be?.role||be?.title||null,ue=be?.phone||be?.mobile||be?.contact||null;if(!w&&!V)return;const Ee=V||w;ie.has(Ee)||ie.set(Ee,{id:V,name:w||"-",role:te||null,phone:ue||null})};Array.isArray(o?.technicians)&&o.technicians.forEach(_=>ve(_)),J.forEach(_=>{(Array.isArray(_.crewAssignments)&&_.crewAssignments.length?_.crewAssignments:Array.isArray(_.technicians)?_.technicians.map(V=>({technicianId:V})):[]).forEach(V=>ve(V))});const Se=Array.from(ie.values()),je=Array.isArray(o.expenses)?o.expenses.map(_=>{const ee=Number(_?.salePrice??_?.sale_price??_?.amount)||0;return{label:_?.label||_?.name||"-",amount:ee,displayAmount:ge(ee,t),note:_?.note||_?.description||""}}):[],me=o?.applyTax===!0||o?.applyTax==="true",Ve=Number.parseFloat(o?.discount??o?.discountValue??0)||0;let qe=(o?.discountType==="amount"?"amount":"percent")==="amount"?Ve:Y*(Ve/100);(!Number.isFinite(qe)||qe<0)&&(qe=0),qe>Y&&(qe=Y);const Le=Math.max(0,Y-qe),Be=o?.companyShareEnabled===!0||o?.company_share_enabled===!0||o?.companyShareApplied===!0||o?.company_share_applied===!0,H=Number.parseFloat(o?.companySharePercent??o?.company_share_percent??o?.companyShare??o?.company_share??0)||0,ae=Be&&H>0?H:0,ye=ae>0?Number((Le*(ae/100)).toFixed(2)):0,oe=Number((Le+ye).toFixed(2)),Ie=me?Number((oe*vi).toFixed(2)):0,pe=Number((oe+Ie).toFixed(2)),_e=Qo(o),Ce=Nt(o.paidAmount??o.paid_amount)||0,Me=Nt(o.paidPercent??o.paid_percent)||0,P=Qt({totalAmount:pe,paidAmount:Ce,paidPercent:Me,history:_e}),$=typeof o.paymentStatus=="string"?o.paymentStatus.toLowerCase():"",T=Gt({manualStatus:$,paidAmount:P.paidAmount,paidPercent:P.paidPercent,totalAmount:pe}),K={paid:"Ù…Ø¯ÙÙˆØ¹",partial:"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹",unpaid:"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"},U=c(`projects.paymentStatus.${T}`,K[T]||T),Q=Number(P.paidAmount||0),Z=Number(P.paidPercent||0),re=Math.max(0,Number((pe-Q).toFixed(2))),ce={projectSubtotal:ge(oe,t),expensesTotal:ge(O,t),reservationsTotal:ge(oe,t),discountAmount:ge(qe,t),taxAmount:ge(Ie,t),overallTotal:ge(pe,t),paidAmount:ge(Q,t),remainingAmount:ge(re,t)},Pe={status:T,statusLabel:U,paidAmount:Q,paidPercent:Z,remainingAmount:re,paidAmountDisplay:ge(Q,t),remainingAmountDisplay:ge(re,t),paidPercentDisplay:es(Z)},He=(o.description||"").trim();return{project:o,customer:l,clientInfo:{name:y,company:f||"â€”",phone:p,email:h},projectInfo:{title:j,code:b,typeLabel:S,startDisplay:z,endDisplay:A,durationLabel:M,statusLabel:C},expenses:je,equipment:W,crew:Se,equipmentItems:G,crewAssignments:J.flatMap(_=>Pa(_)),totals:{equipmentEstimate:N,expensesTotal:O,baseSubtotal:Y,discountAmount:qe,subtotalAfterDiscount:Le,companyShareAmount:ye,subtotal:oe,applyTax:me,taxAmount:Ie,totalWithTax:pe},totalsDisplay:ce,projectTotals:{combinedTaxAmount:Ie,overallTotal:pe,reservationsTotal:oe,paidAmount:Q,paidPercent:Z,remainingAmount:re,paymentStatus:T},paymentSummary:Pe,notes:He,currencyLabel:t,projectStatus:L,projectStatusLabel:C,projectDurationDays:k,projectDurationLabel:M,paymentHistory:_e}}function tc({project:e,clientInfo:t={},projectInfo:n={},projectCrew:a=[],projectExpenses:s=[],projectEquipment:r=[],totalsDisplay:i={},projectTotals:o={},paymentSummary:d={},currencyLabel:u="SR",sections:l,fieldSelections:y={},quoteNumber:f,quoteDate:m,terms:p=Ke}){const g=wa(y),h=(P,$)=>Aa(g,P,$),x=P=>l?.has?.(P),b=`<div class="quote-placeholder">${v(c("reservations.quote.placeholder.noFields","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."))}</div>`,j=(P,$)=>`<div class="info-plain__item">
      <span class="info-plain__label">${v(P)}</span>
      <span class="info-plain__separator">:</span>
      <span class="info-plain__value">${v($)}</span>
    </div>`,S=(P,$,{variant:T="inline"}={})=>T==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${v(P)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${v($)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${v(P)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${v($)}</span>
    </span>`,z=(P,$)=>`<div class="payment-row">
      <span class="payment-row__label">${v(P)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${v($)}</span>
    </div>`,A=[];h("customerInfo","customerName")&&A.push(j(c("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.name||"-")),h("customerInfo","customerCompany")&&A.push(j(c("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.company||"â€”")),h("customerInfo","customerPhone")&&A.push(j(c("projects.details.labels.clientPhone","Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.phone||"-")),h("customerInfo","customerEmail")&&A.push(j(c("projects.details.labels.clientEmail","Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"),t.email||"-"));const k=x("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${v(c("projects.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"))}</h3>
        ${A.length?`<div class="info-plain">${A.join("")}</div>`:b}
      </section>`:"",M=[];h("projectInfo","projectType")&&M.push(j(c("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.typeLabel||"-")),h("projectInfo","projectTitle")&&M.push(j(c("projects.details.projectTitle","Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.title||"-")),h("projectInfo","projectCode")&&M.push(j(c("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.code||"-")),h("projectInfo","projectStart")&&M.push(j(c("projects.details.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.startDisplay||"-")),h("projectInfo","projectEnd")&&M.push(j(c("projects.details.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.endDisplay||"-")),h("projectInfo","projectDuration")&&M.push(j(c("projects.details.duration","Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.durationLabel||"-")),h("projectInfo","projectStatus")&&M.push(j(c("projects.details.status","Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.statusLabel||"-"));const L=x("projectInfo")?`<section class="quote-section quote-section--plain quote-section--project">
        <h3 class="quote-section__title">${v(c("projects.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>
        ${M.length?`<div class="info-plain">${M.join("")}</div>`:b}
      </section>`:"",ne=kn.filter(P=>h("projectCrew",P.id)),C=Array.isArray(E?.crewAssignments)?E.crewAssignments:[],F=P=>{const $=P&&P.positionId!=null?`id:${String(P.positionId)}`:(()=>{const U=(P?.positionLabel||P?.position_name||P?.position||"").trim().toLowerCase();return U?`label:${U}`:""})(),T=Number.isFinite(Number(P?.positionClientPrice))?Number(P.positionClientPrice):0,K=T>0?`|p:${T.toFixed(2)}`:"";return`${$}${K}`};(()=>{const P=new Map;return C.forEach($=>{const T=F($);T&&P.set(T,(P.get(T)||0)+1)}),P})();const J=(()=>{const P=[];if(ne.forEach(Q=>{Q.id==="position"?(P.push({...Q,render:Z=>{const re=Z?.positionLabel??Z?.position_name??Z?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return v(q(String(re)))}}),h("projectCrew","quantity")&&P.push({id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:Z=>v(q(String(Math.max(1,Number(Z?.__count||1)))))})):Q.id==="price"?P.push({...Q,render:Z=>{const re=Number.isFinite(Number(Z?.positionClientPrice))?Number(Z.positionClientPrice):0,ce=Math.max(1,Number(Z?.__count||1)),Pe=Math.max(1,Number(E?.rentalDays||1)),He=re*ce*Pe;return v(`${Fe(He)} ${c("reservations.create.summary.currency","SR")}`)}}):Q.id==="unitPrice"?P.push({...Q,render:Z=>{const re=Number.isFinite(Number(Z?.positionClientPrice))?Number(Z.positionClientPrice):0;return v(`${Fe(re)} ${c("reservations.create.summary.currency","SR")}`)}}):P.push(Q)}),h("projectCrew","days")){const Q=Math.max(1,Number(E?.rentalDays||1)),Z=P.findIndex(ce=>ce.id==="price"),re=Math.max(0,Z);P.splice(re,0,{id:"days",labelKey:null,fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>v(q(String(Q)))})}const $=new Map(P.map(Q=>[Q.id,Q])),T=new Set,K=[],U=Q=>{const Z=$.get(Q);Z&&!T.has(Q)&&(K.push(Z),T.add(Q))};return U("rowNumber"),U("position"),U("unitPrice"),U("quantity"),U("days"),U("price"),P.forEach(Q=>{T.has(Q.id)||(K.push(Q),T.add(Q.id))}),K})(),N=(()=>{const P=new Map;return C.forEach($=>{const T=F($);if(!T)return;const K=P.get(T);K?K.__count+=1:P.set(T,{...$,__count:1})}),Array.from(P.values())})(),B=(()=>{try{const P=Math.max(1,Number(E?.rentalDays||1)),$=(N||[]).reduce((T,K)=>{const U=Number.isFinite(Number(K?.positionClientPrice))?Number(K.positionClientPrice):0,Q=Math.max(1,Number(K?.__count||1));return T+U*Q*P},0);return Fe($)}catch{return"0.00"}})(),O=x("projectCrew")?J.length?`<section class="quote-section quote-section--table">
            <h3>${v(c("projects.quote.sections.crew","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${J.map(P=>`<th>${v(P.labelKey?c(P.labelKey,P.fallback):P.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${N.length?N.map((P,$)=>`<tr>${J.map(T=>`<td><div class="quote-cell">${T.render(P,$)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(J.length,1)}" class="empty">${v(c("projects.details.crew.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù‚Ù… ÙÙ†ÙŠ Ù…Ø±ØªØ¨Ø·."))}</td></tr>`}
              </tbody>
            </table>
            ${h("projectCrew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${v(c("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"))}</span>
                  <span class="quote-table-subtotal__value">${v(`${B} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${v(c("projects.quote.sections.crew","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            ${b}
          </section>`:"",Y=[];h("financialSummary","discountAmount")&&Y.push(S(c("reservations.details.labels.discount","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…"),i.discountAmount||ge(0,u)));const G=c("projects.details.summary.preTaxTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©");h("financialSummary","reservationsTotal")&&Y.push(S(G,i.reservationsTotal||ge(0,u))),h("financialSummary","taxAmount")&&Y.push(S(c("projects.details.summary.combinedTax","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),i.taxAmount||ge(0,u)));const D=[];h("financialSummary","overallTotal")&&D.push(S(c("projects.details.summary.overallTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"),i.overallTotal||ge(0,u),{variant:"final"}));const W=x("financialSummary")?!Y.length&&!D.length?`<section class="quote-section quote-section--financial">${b}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${v(c("projects.quote.sections.financial","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</h3>
            ${Y.length?`<div class="totals-inline">${Y.join("")}</div>`:""}
            ${D.length?`<div class="totals-final">${D.join("")}</div>`:""}
          </div>
        </section>`:"",R=Zs.filter(P=>h("projectExpenses",P.id)),ie=x("projectExpenses")?R.length?`<section class="quote-section quote-section--table">
            <h3>${v(c("projects.quote.sections.expenses","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${R.map(P=>`<th>${v(P.labelKey?c(P.labelKey,P.fallback):P.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${s.length?s.map((P,$)=>`<tr>${R.map(T=>`<td><div class="quote-cell">${T.render(P,$)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(R.length,1)}" class="empty">${v(c("projects.details.expenses.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©."))}</td></tr>`}
              </tbody>
            </table>
            ${h("projectExpenses","expensesSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${v(c("projects.details.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</span>
                  <span class="quote-table-subtotal__value">${v(i.expensesTotal||ge(0,u))}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${v(c("projects.quote.sections.expenses","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</h3>
            ${b}
          </section>`:"",ve=In.filter(P=>h("projectEquipment",P.id)),Se=(()=>{let P=[];if(ve.forEach(U=>{U.id==="price"?P.push({...U,render:Q=>{const Z=Number.isFinite(Number(Q?.unitPriceValue))?Number(Q.unitPriceValue):0,re=Number.isFinite(Number(Q?.qty))?Math.max(1,Number(Q.qty)):1,ce=Math.max(1,Number(E?.rentalDays||1)),Pe=Z*re*ce;return v(`${Fe(Pe)} ${c("reservations.create.summary.currency","SR")}`)}}):U.id==="unitPrice"?P.push({...U,render:Q=>{const Z=Number.isFinite(Number(Q?.unitPriceValue))?Number(Q.unitPriceValue):0;return v(`${Fe(Z)} ${c("reservations.create.summary.currency","SR")}`)}}):P.push(U)}),h("projectEquipment","days")){const U=Math.max(1,Number(E?.rentalDays||1)),Q=P.findIndex(re=>re.id==="price"),Z=Math.max(0,Q);P.splice(Z,0,{id:"days",labelKey:null,fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>v(q(String(U)))})}const $=new Map(P.map(U=>[U.id,U])),T=P.filter(U=>!["unitPrice","quantity","days","price"].includes(U.id)),K=["unitPrice","quantity","days","price"].map(U=>$.get(U)).filter(Boolean);return P=[...T,...K],P})(),je=Array.isArray(E?.equipmentItems)?E.equipmentItems:[],me=(()=>{try{const P=Math.max(1,Number(E?.rentalDays||1)),$=(je||[]).reduce((T,K)=>{const U=Number.isFinite(Number(K?.unitPriceValue))?Number(K.unitPriceValue):0,Q=Number.isFinite(Number(K?.qty))?Math.max(1,Number(K.qty)):1;return T+U*Q*P},0);return Fe($)}catch{return"0.00"}})(),Ve=x("projectEquipment")?Se.length?`<section class="quote-section quote-section--table">
            <h3>${v(c("projects.quote.sections.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Se.map(P=>`<th>${v(P.labelKey?c(P.labelKey,P.fallback):P.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${je.length?je.map((P,$)=>`<tr>${Se.map(T=>`<td><div class="quote-cell">${T.render(P,$)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(Se.length,1)}" class="empty">${v(c("projects.details.equipment.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."))}</td></tr>`}
              </tbody>
            </table>
            ${h("projectEquipment","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${v(c("reservations.details.labels.equipmentTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</span>
                  <span class="quote-table-subtotal__value">${v(`${me} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${v(c("projects.quote.sections.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            ${b}
          </section>`:"",ze=(e?.description||"").trim()||"",qe=x("projectNotes")?`<section class="quote-section">
        <h3>${v(c("projects.quote.sections.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>
        <div class="quote-notes">${v(ze||c("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹."))}</div>
      </section>`:"",Le=[];h("payment","beneficiary")&&Le.push(z(c("reservations.quote.labels.beneficiary","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"),Re.beneficiaryName)),h("payment","bank")&&Le.push(z(c("reservations.quote.labels.bank","Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"),Re.bankName)),h("payment","account")&&Le.push(z(c("reservations.quote.labels.account","Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"),q(Re.accountNumber))),h("payment","iban")&&Le.push(z(c("reservations.quote.labels.iban","Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"),q(Re.iban)));const Be=`<section class="quote-section">
      <div class="payment-block">
        <h3>${v(c("reservations.quote.sections.payment","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹"))}</h3>
        <div class="payment-rows">${Le.length?Le.join(""):b}</div>
      </div>
      <p class="quote-approval-note">${v(Re.approvalNote)}</p>
    </section>`,H=Array.isArray(p)&&p.length?p:Ke,ae=`<footer class="quote-footer">
        <h4>${v(c("reservations.quote.labels.terms","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©"))}</h4>
        <ul>${H.map(P=>`<li>${v(P)}</li>`).join("")}</ul>
      </footer>`,ye=[],oe=[];if(L&&oe.push({key:"project",html:L}),k&&oe.push({key:"customer",html:k}),oe.length>1){const P=oe.find(K=>K.key==="project"),$=oe.find(K=>K.key==="customer"),T=[];P?.html&&T.push(P.html),$?.html&&T.push($.html),ye.push(Ne(`<div class="quote-section-row quote-section-row--primary">${T.join("")}</div>`,{blockType:"group"}))}else oe.length===1&&ye.push(Ne(oe[0].html));const Ie=[];O&&Ie.push(Ne(O,{blockType:"table",extraAttributes:'data-table-id="project-crew"'})),ie&&Ie.push(Ne(ie,{blockType:"table",extraAttributes:'data-table-id="project-expenses"'})),Ve&&Ie.push(Ne(Ve,{blockType:"table",extraAttributes:'data-table-id="project-equipment"'}));const pe=[];W&&pe.push(Ne(W,{blockType:"summary"})),qe&&pe.push(Ne(qe));const _e=[...x("payment")?[Ne(Be,{blockType:"payment"})]:[],Ne(ae,{blockType:"footer"})],Ce=[...gn(ye,"projects.quote.placeholder.primary"),...Ie,...gn(pe,"projects.quote.placeholder.summary"),..._e],Me=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${v(Re.logoUrl)}" alt="${v(Re.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${v(c("projects.quote.title","Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h1>
        <p class="quote-company-name">${v(Re.companyName)}</p>
        <p class="quote-company-cr">${v(c("reservations.quote.labels.cr","Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"))}: ${v(Re.commercialRegistry)}</p>
        <p class="quote-company-license">ØªØ±Ø®ÙŠØµ Ø¥Ø¹Ù„Ø§Ù…ÙŠ: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${v(c("reservations.details.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶"))}</span>
          <strong>${v(f)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${v(c("projects.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${v(m)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
        <style>${rr}${sr}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${Me}
          ${Ce.join("")}
        </div>
      </div>
    </div>
  `}function kr(e){if(e?.context==="project")return tc(e);const{reservation:t,customer:n,project:a,crewAssignments:s,totals:r,totalsDisplay:i,rentalDays:o,currencyLabel:d,sections:u,fieldSelections:l={},quoteNumber:y,quoteDate:f,terms:m=Ke}=e,p=q(String(t?.reservationId??t?.id??"")),g=t.start?q(ot(t.start)):"-",h=t.end?q(ot(t.end)):"-",x=n?.customerName||n?.full_name||n?.name||"-",b=n?.phone||"-",j=n?.email||"-",S=n?.company||n?.company_name||"-",z=q(b),A=a?.title||a?.name||c("reservations.details.project.none","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),k=a?.code||a?.projectCode||"",M=q(String(o)),L=t?.notes||"",ne=Array.isArray(m)&&m.length?m:Ke,C=wa(l),F=(w,te)=>Aa(C,w,te),J=w=>u?.has?.(w),N=`<div class="quote-placeholder">${v(c("reservations.quote.placeholder.noFields","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."))}</div>`,B=(w,te)=>`<div class="info-plain__item">${v(w)} <span class="info-plain__slash">/</span> <strong class="info-plain__value">${v(te)}</strong></div>`,O=(w,te,{variant:ue="inline"}={})=>ue==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${v(w)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${v(te)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${v(w)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${v(te)}</span>
    </span>`,Y=(w,te)=>`<div class="payment-row">
      <span class="payment-row__label">${v(w)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${v(te)}</span>
    </div>`,G=[];F("customerInfo","customerName")&&G.push(B(c("reservations.details.labels.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„"),x)),F("customerInfo","customerCompany")&&G.push(B(c("reservations.details.labels.company","Ø§Ù„Ø´Ø±ÙƒØ©"),S)),F("customerInfo","customerPhone")&&G.push(B(c("reservations.details.labels.phone","Ø§Ù„Ù‡Ø§ØªÙ"),z)),F("customerInfo","customerEmail")&&G.push(B(c("reservations.details.labels.email","Ø§Ù„Ø¨Ø±ÙŠØ¯"),j));const D=J("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${v(c("reservations.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"))}</h3>
        ${G.length?`<div class="info-plain">${G.join("")}</div>`:N}
      </section>`:"",W=[];F("reservationInfo","reservationId")&&W.push(B(c("reservations.details.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"),p||"-")),F("reservationInfo","reservationStart")&&W.push(B(c("reservations.details.labels.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),g)),F("reservationInfo","reservationEnd")&&W.push(B(c("reservations.details.labels.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),h)),F("reservationInfo","reservationDuration")&&W.push(B(c("reservations.details.labels.duration","Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),M));const R=J("reservationInfo")?`<section class="quote-section quote-section--plain quote-section--reservation">
        <h3 class="quote-section__title">${v(c("reservations.quote.sections.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"))}</h3>
        ${W.length?`<div class="info-plain">${W.join("")}</div>`:N}
      </section>`:"",ie=[];F("projectInfo","projectTitle")&&ie.push(B(c("reservations.details.labels.project","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),A)),F("projectInfo","projectCode")&&ie.push(B(c("reservations.details.labels.code","Ø§Ù„Ø±Ù…Ø²"),k||"-"));const ve=J("projectInfo")?`<section class="quote-section quote-section--plain">
        <h3 class="quote-section__title">${v(c("reservations.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>
        ${ie.length?`<div class="info-plain">${ie.join("")}</div>`:N}
      </section>`:"",Se=[];F("financialSummary","discountAmount")&&Se.push(O(c("reservations.details.labels.discount","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…"),`${i.discountAmount} ${d}`)),F("financialSummary","subtotalBeforeTax")&&Se.push(O(c("reservations.details.labels.subtotalBeforeTax","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),`${i.taxableAmount} ${d}`)),F("financialSummary","taxAmount")&&Se.push(O(c("reservations.details.labels.tax","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),`${i.taxAmount} ${d}`));const je=F("financialSummary","finalTotal"),me=[];je&&me.push(O(c("reservations.details.labels.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),`${i.finalTotal} ${d}`,{variant:"final"}));const Ve=me.length?`<div class="totals-final">${me.join("")}</div>`:"",ze=J("financialSummary")?!Se.length&&!je?`<section class="quote-section quote-section--financial">${N}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${v(c("reservations.details.labels.summary","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</h3>
            ${Se.length?`<div class="totals-inline">${Se.join("")}</div>`:""}
            ${Ve}
          </div>
        </section>`:"",{groups:qe}=Dt(t),Le=qe.map(w=>{const te=Number(w?.count??w?.quantity??1)||1,ue=Number(w?.unitPrice);let Ee=Number.isFinite(ue)?ue:0;if(!Ee||Ee<=0){const fe=Number(w?.totalPrice);Number.isFinite(fe)&&te>0&&(Ee=Number((fe/te).toFixed(2)))}Number.isFinite(Ee)||(Ee=0);const $e=w?.type==="package"||Array.isArray(w?.items)&&w.items.some(fe=>fe?.type==="package"),Qe=Array.isArray(w?.barcodes)&&w.barcodes.length?w.barcodes[0]:Array.isArray(w?.items)&&w.items.length?w.items[0]?.barcode:null;let Te=w?.packageDisplayCode??w?.package_code??w?.code??w?.packageCode??(Array.isArray(w?.items)&&w.items.length?w.items[0]?.package_code??w.items[0]?.code??w.items[0]?.packageCode:null);const Ae=fe=>{const ke=(fe==null?"":String(fe)).trim();return!!(!ke||/^pkg-/i.test(ke)||/^\d+$/.test(ke)&&ke.length<=4)};if(!Te||Ae(Te)){const fe=w?.packageId??w?.package_id??(Array.isArray(w?.items)&&w.items.length?w.items[0]?.packageId??w.items[0]?.package_id:null);if(fe)try{const ke=pa(fe);ke&&ke.package_code&&(Te=ke.package_code)}catch{}}if(!Te||Ae(Te))try{const fe=$t(w?.description||"");if(fe){const ke=Es();let et=ke.find(rt=>$t(rt?.name||rt?.title||rt?.label||"")===fe);et||(et=ke.find(rt=>{const Ta=$t(rt?.name||rt?.title||rt?.label||"");return Ta.includes(fe)||fe.includes(Ta)})),et&&et.package_code&&(Te=et.package_code)}}catch{}const De=$e?Te??Qe??"":w?.barcode??Qe??"",se=De!=null?String(De):"";let de=Number.isFinite(Number(w?.totalPrice))?Number(w.totalPrice):Number((Ee*te).toFixed(2));return de=wt(de),{...w,isPackage:$e,desc:w?.description,barcode:se,packageCodeResolved:Te||"",qty:te,price:de,totalPrice:de,unitPriceValue:Ee}}),Be=In.filter(w=>F("items",w.id)),H=(()=>{let w=[];Be.forEach(Ae=>{Ae.id==="price"?w.push({...Ae,render:De=>{const se=Number.isFinite(Number(De?.unitPriceValue))?Number(De.unitPriceValue):0,de=Number.isFinite(Number(De?.qty))?Math.max(1,Number(De.qty)):1,fe=Math.max(1,Number(E?.rentalDays||1)),ke=se*de*fe;return v(`${Fe(ke)} ${c("reservations.create.summary.currency","SR")}`)}}):Ae.id==="unitPrice"?w.push({...Ae,render:De=>{const se=Number.isFinite(Number(De?.unitPriceValue))?Number(De.unitPriceValue):0;return v(`${Fe(se)} ${c("reservations.create.summary.currency","SR")}`)}}):w.push(Ae)});const te=Math.max(1,Number(E?.rentalDays||1)),ue=w.findIndex(Ae=>Ae.id==="price"),Ee=Math.max(0,ue);w.splice(Ee,0,{id:"days",labelKey:null,fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>v(q(String(te)))});const $e=new Map(w.map(Ae=>[Ae.id,Ae])),Qe=w.filter(Ae=>!["unitPrice","quantity","days","price"].includes(Ae.id)),Te=["unitPrice","quantity","days","price"].map(Ae=>$e.get(Ae)).filter(Boolean);return w=[...Qe,...Te],w})(),ae=H.length>0,ye=ae?H.map(w=>`<th>${v(w.labelKey?c(w.labelKey,w.fallback):w.fallback)}</th>`).join(""):"",Ie=Le.length>0?Le.map((w,te)=>`<tr>${H.map(ue=>`<td><div class="quote-cell">${ue.render(w,te)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(H.length,1)}" class="empty">${v(c("reservations.details.noItems","ğŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø­Ø§Ù„ÙŠØ§Ù‹."))}</td></tr>`,pe=J("items")?ae?`<section class="quote-section quote-section--table">
            <h3>${v(c("reservations.details.items.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${ye}</tr>
              </thead>
              <tbody>${Ie}</tbody>
            </table>
            ${F("items","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${v(c("reservations.details.labels.equipmentTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</span>
                  <span class="quote-table-subtotal__value">${v(`${i.equipmentTotal} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${v(c("reservations.details.items.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            ${N}
          </section>`:"",_e=kn.filter(w=>F("crew",w.id)),Ce=_e.length>0,Me=Array.isArray(s)?s:[],P=w=>{const te=w&&w.positionId!=null?`id:${String(w.positionId)}`:(()=>{const $e=(w?.positionLabel||w?.position_name||w?.position||"").trim().toLowerCase();return $e?`label:${$e}`:""})(),ue=Number.isFinite(Number(w?.positionClientPrice))?Number(w.positionClientPrice):0,Ee=ue>0?`|p:${ue.toFixed(2)}`:"";return`${te}${Ee}`};(()=>{const w=new Map;return Me.forEach(te=>{const ue=P(te);ue&&w.set(ue,(w.get(ue)||0)+1)}),w})();const $=(()=>{let w=[],te=null;_e.forEach(se=>{se.id==="position"?(w.push({...se,render:de=>{const fe=de?.positionLabel??de?.position_name??de?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return v(q(String(fe)))}}),te={id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:de=>{const fe=Number(de?.__count||1);return v(q(String(Math.max(1,fe))))}}):se.id==="price"?w.push({...se,render:de=>{const fe=Number.isFinite(Number(de?.positionClientPrice))?Number(de.positionClientPrice):0,ke=Math.max(1,Number(de?.__count||1)),et=Math.max(1,Number(E?.rentalDays||1)),rt=fe*ke*et;return v(`${Fe(rt)} ${c("reservations.create.summary.currency","SR")}`)}}):se.id==="unitPrice"?w.push({...se,render:de=>{const fe=Number.isFinite(Number(de?.positionClientPrice))?Number(de.positionClientPrice):0;return v(`${Fe(fe)} ${c("reservations.create.summary.currency","SR")}`)}}):w.push(se)}),te&&w.push(te);const ue=Math.max(1,Number(E?.rentalDays||1)),Ee=w.findIndex(se=>se.id==="price"),$e=Math.max(0,Ee);w.splice($e,0,{id:"days",labelKey:null,fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>v(q(String(ue)))});const Qe=new Map(w.map(se=>[se.id,se])),Te=new Set,Ae=[],De=se=>{const de=Qe.get(se);de&&!Te.has(se)&&(Ae.push(de),Te.add(se))};return De("rowNumber"),De("position"),De("unitPrice"),De("quantity"),De("days"),De("price"),w.forEach(se=>{Te.has(se.id)||(Ae.push(se),Te.add(se.id))}),w=Ae,w})(),T=Ce?$.map(w=>`<th>${v(w.labelKey?c(w.labelKey,w.fallback):w.fallback)}</th>`).join(""):"",K=(()=>{const w=new Map;return Me.forEach(te=>{const ue=P(te);if(!ue)return;const Ee=w.get(ue);Ee?Ee.__count+=1:w.set(ue,{...te,__count:1})}),Array.from(w.values())})(),U=K.length?K.map((w,te)=>`<tr>${$.map(ue=>`<td><div class="quote-cell">${ue.render(w,te)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max($.length,1)}" class="empty">${v(c("reservations.details.noCrew","ğŸ˜ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²."))}</td></tr>`,Q=J("crew")?Ce?`<section class="quote-section quote-section--table">
            <h3>${v(c("reservations.details.technicians.title","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${T}</tr>
              </thead>
              <tbody>${U}</tbody>
            </table>
            ${F("crew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${v(c("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"))}</span>
                  <span class="quote-table-subtotal__value">${v(`${i.crewTotal} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${v(c("reservations.details.technicians.title","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            ${N}
          </section>`:"",Z=J("notes")?`<section class="quote-section">
        <h3>${v(c("reservations.details.labels.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²"))}</h3>
        <div class="quote-notes">${v(L||c("reservations.quote.emptyNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©."))}</div>
      </section>`:"",re=[];F("payment","beneficiary")&&re.push(Y(c("reservations.quote.labels.beneficiary","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"),Re.beneficiaryName)),F("payment","bank")&&re.push(Y(c("reservations.quote.labels.bank","Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"),Re.bankName)),F("payment","account")&&re.push(Y(c("reservations.quote.labels.account","Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"),q(Re.accountNumber))),F("payment","iban")&&re.push(Y(c("reservations.quote.labels.iban","Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"),q(Re.iban)));const ce=`<section class="quote-section">
      <div class="payment-block">
        <h3>${v(c("reservations.quote.sections.payment","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹"))}</h3>
        <div class="payment-rows">${re.length?re.join(""):N}</div>
      </div>
      <p class="quote-approval-note">${v(Re.approvalNote)}</p>
    </section>`,Pe=`<footer class="quote-footer">
        <h4>${v(c("reservations.quote.labels.terms","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©"))}</h4>
        <ul>${ne.map(w=>`<li>${v(w)}</li>`).join("")}</ul>
      </footer>`,He=[];D&&R?He.push(Ne(`<div class="quote-section-row">${D}${R}</div>`,{blockType:"group"})):(R&&He.push(Ne(R)),D&&He.push(Ne(D))),ve&&He.push(Ne(ve));const we=[];pe&&we.push(Ne(pe,{blockType:"table",extraAttributes:'data-table-id="items"'})),Q&&we.push(Ne(Q,{blockType:"table",extraAttributes:'data-table-id="crew"'}));const _=[];ze&&_.push(Ne(ze,{blockType:"summary"})),Z&&_.push(Ne(Z));const ee=[...J("payment")?[Ne(ce,{blockType:"payment"})]:[],Ne(Pe,{blockType:"footer"})],V=[...gn(He,"reservations.quote.placeholder.page1"),...we,...gn(_,"reservations.quote.placeholder.page2"),...ee],be=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${v(Re.logoUrl)}" alt="${v(Re.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${v(c("reservations.quote.title","Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h1>
        <p class="quote-company-name">${v(Re.companyName)}</p>
        <p class="quote-company-cr">${v(c("reservations.quote.labels.cr","Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"))}: ${v(Re.commercialRegistry)}</p>
        <p class="quote-company-license">ØªØ±Ø®ÙŠØµ Ø¥Ø¹Ù„Ø§Ù…ÙŠ: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶</span>
          <strong>${v(y)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
          <strong>${v(f)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
      <style>${rr}${sr}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${be}
          ${V.join("")}
        </div>
      </div>
    </div>
  `}async function Pr(){try{const e=xe();if((Array.isArray(e?.packages)?e.packages:[]).length>0)return;const n=await Ue("/packages/?all=1"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];a.length&&(Wr({packages:a}),document.dispatchEvent?.(new CustomEvent("packages:changed",{detail:{packages:a}})))}catch{}}function nc(e){return e?e.complete?e.naturalHeight===0?Promise.reject(new Error(`image failed to load: ${e.src||"unknown"}`)):Promise.resolve():new Promise((t,n)=>{const a=()=>{r(),t()},s=()=>{r(),n(new Error(`image failed to load: ${e.src||"unknown"}`))},r=()=>{e.removeEventListener("load",a),e.removeEventListener("error",s)};e.addEventListener("load",a,{once:!0}),e.addEventListener("error",s,{once:!0})}):Promise.resolve()}async function Jt(e){if(!e)return;const t=e.ownerDocument||document,n=t.defaultView||window,a=Array.from(e.querySelectorAll?.("img")||[]),s=t.fonts?.ready?t.fonts.ready:Promise.resolve(),r=a.map(o=>nc(o)),i=[s,...r].map(o=>o.catch(d=>(nt("asset load failed",d),vo(),null)));await Promise.all(i),await new Promise(o=>n.requestAnimationFrame(()=>o()))}async function hn(e,{context:t="preview"}={}){if(!e)return;const n=t==="preview",a=e.ownerDocument||document;e.setAttribute("data-quote-render-context",t);const s=e.querySelector("[data-quote-pages]"),r=e.querySelector("[data-quote-source]"),i=r?.querySelector("[data-quote-header-template]");if(!s||!r||!i)return;s.style.display="block",s.style.margin="0",s.style.padding="0",s.style.gap="0px",s.style.rowGap="0px",s.style.columnGap="0px",s.style.alignItems="stretch",s.style.justifyContent="flex-start",await br(r),await Jt(r),s.innerHTML="";const o=Array.from(r.querySelectorAll(":scope > [data-quote-block]"));let d=null,u=null;const l=A=>{A.style.margin="0 auto",A.style.breakInside="avoid",A.style.pageBreakInside="avoid",A.style.pageBreakAfter="auto",A.style.breakAfter="auto"},y=()=>{const A=a.createElement("div"),k=s.childElementCount===0;if(A.className="quote-page",A.dataset.pageIndex=String(s.childElementCount),k){A.classList.add("quote-page--primary");const L=i.cloneNode(!0);L.removeAttribute("data-quote-header-template"),A.appendChild(L)}else A.classList.add("quote-page--continuation");const M=a.createElement("main");M.className="quote-body",A.appendChild(M),s.appendChild(A),l(A),d=A,u=M},f=()=>{(!d||!u||!u.isConnected)&&y()},m=()=>{if(!d||!u||u.childElementCount>0)return;const A=d;d=null,u=null,A.parentNode&&A.parentNode.removeChild(A)},p=()=>{d=null,u=null},g=()=>d?d.scrollHeight-d.clientHeight>ur:!1,h=(A,{allowOverflow:k=!1}={})=>(f(),u.appendChild(A),g()&&!k?(u.removeChild(A),m(),!1):!0),x=A=>{const k=A.cloneNode(!0);k.removeAttribute?.("data-quote-block"),k.removeAttribute?.("data-block-type"),k.removeAttribute?.("data-table-id"),!h(k)&&(p(),!h(k)&&h(k,{allowOverflow:!0}))},b=A=>{const k=A.querySelector("table");if(!k){x(A);return}const M=A.querySelector("h3"),L=k.querySelector("thead"),ne=Array.from(k.querySelectorAll("tbody tr"));if(!ne.length){x(A);return}let C=null,F=0;const J=(B=!1)=>{const O=A.cloneNode(!1);O.removeAttribute("data-quote-block"),O.removeAttribute("data-block-type"),O.removeAttribute("data-table-id"),O.classList.add("quote-section--table-fragment"),B&&O.classList.add("quote-section--table-fragment--continued");const Y=M?M.cloneNode(!0):null;Y&&O.appendChild(Y);const G=k.cloneNode(!1);G.classList.add("quote-table--fragment"),L&&G.appendChild(L.cloneNode(!0));const D=a.createElement("tbody");return G.appendChild(D),O.appendChild(G),{section:O,body:D}},N=(B=!1)=>C||(C=J(B),h(C.section)||(p(),h(C.section)||h(C.section,{allowOverflow:!0})),C);ne.forEach(B=>{N(F>0);const O=B.cloneNode(!0);if(C.body.appendChild(O),g()&&(C.body.removeChild(O),C.body.childElementCount||(u.removeChild(C.section),C=null,m()),p(),C=null,N(F>0),C.body.appendChild(O),g())){C.section.classList.add("quote-section--table-fragment--overflow"),F+=1;return}F+=1}),C=null;try{const B=A.querySelector(":scope > .quote-table-subtotal");B&&x(B)}catch{}};if(!o.length)return;o.forEach(A=>{A.getAttribute("data-block-type")==="table"?b(A):x(A)});const j=Array.from(s.children),S=[];if(j.forEach((A,k)=>{const M=A.querySelector(".quote-body");if(k!==0&&(!M||M.childElementCount===0)){A.remove();return}S.push(A)}),!n){const A=a.defaultView||window,k=Math.min(3,Math.max(1,A.devicePixelRatio||1)),M=_n()?Math.min(2,k):k;S.forEach(L=>Lo(L,{pixelRatio:M}))}S.forEach((A,k)=>{const M=k===0;A.style.pageBreakAfter="auto",A.style.breakAfter="auto",A.style.pageBreakBefore=M?"auto":"always",A.style.breakBefore=M?"auto":"page",n?A.style.boxShadow="":A.style.boxShadow="none"});const z=S[S.length-1]||null;d=z,u=z?.querySelector(".quote-body")||null,await Jt(s),n&&(s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="flex-start",s.style.rowGap="18px",s.style.columnGap="0px",s.style.gap="18px")}function $r(e=0){return e<=0?new Promise(t=>requestAnimationFrame(()=>t())):new Promise(t=>setTimeout(t,e))}function xr(e){return e?Array.from(e.querySelectorAll(".quote-page")).some(n=>n.scrollHeight-n.clientHeight>ur):!1}function $a(e,t="#000000"){if(!e)return;e.querySelectorAll('[style*="color"], [class*="text"], h1, h2, h3, h4, h5, h6, p, span, th, td, li, strong, em, label, dt, dd, caption, div').forEach(a=>{a instanceof HTMLElement&&a.style.setProperty("color",t,"important")})}async function ac(e,{filename:t,safariWindowRef:n=null,mobileWindowRef:a=null}){if(!e)return;const s=Array.from(e.querySelectorAll(".quote-page"));if(!s.length)throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙØ­Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");const[r,i]=await Promise.all([Do(),Bo()]),o=e.ownerDocument||document,d=o?.defaultView?.getComputedStyle?.(e)?.direction,l=[e.getAttribute?.("dir"),e.style?.direction,d,o?.documentElement?.getAttribute?.("dir")].some(A=>typeof A=="string"&&A.toLowerCase().startsWith("rtl")),y=typeof window<"u"&&window.devicePixelRatio||1,f=Ia(),m=pr(),p=_n();let g;p?g=1.5:m?g=Math.min(1.7,Math.max(1.2,y*1.1)):f?g=Math.min(1.8,Math.max(1.25,y*1.2)):g=Math.min(2,Math.max(1.6,y*1.4));const h=p||m?.9:f?.92:.95,x=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),b={scale:g,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!l,removeContainer:!1,logging:!0};let j=0;const S=c("reservations.quote.errors.browserLimit","ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");try{for(let A=0;A<s.length;A+=1){const k=s[A];await br(k),await Jt(k);const M=k.ownerDocument||document,L=M.createElement("div");Object.assign(L.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const ne=k.cloneNode(!0);ne.style.width=`${an}px`,ne.style.maxWidth=`${an}px`,ne.style.minWidth=`${an}px`,ne.style.height=`${sn}px`,ne.style.maxHeight=`${sn}px`,ne.style.minHeight=`${sn}px`,ne.style.position="relative",ne.style.background="#ffffff",$a(ne),L.appendChild(ne),M.body.appendChild(L);let C;try{await Jt(ne),C=await i(ne,{...b,scale:g,backgroundColor:"#ffffff",scrollX:0,scrollY:0})}catch(D){throw Zn(D,"pageCapture",{toastMessage:S}),D}finally{L.parentNode?.removeChild(L)}if(!C)continue;const F=C.width||1,N=(C.height||1)/F;let B=Jn,O=B*N,Y=0;if(O>nn){const D=nn/O;O=nn,B=B*D,Y=Math.max(0,(Jn-B)/2)}const G=C.toDataURL("image/jpeg",h);j>0&&x.addPage(),x.addImage(G,"JPEG",Y,0,B,O,`page-${j+1}`,"FAST"),j+=1,await new Promise(D=>window.requestAnimationFrame(D))}}catch(A){throw ea({safariWindowRef:n,mobileWindowRef:a}),A}if(j===0)throw ea({safariWindowRef:n,mobileWindowRef:a}),new Error("PDF generation produced no pages.");if(m||p){const A=x.output("blob");if(p){const k=URL.createObjectURL(A);Ut();try{window.location.assign(k)}catch(M){nt("mobile safari blob navigation failed",M)}finally{setTimeout(()=>URL.revokeObjectURL(k),6e4)}}else{const k=URL.createObjectURL(A),M=()=>m&&n&&!n.closed?n:a&&!a.closed?a:null,L=(C,F)=>{if(Ut(),!C){window.location.assign(F);return}try{C.location.replace(F),C.focus?.()}catch(J){nt("direct blob navigation failed",J);try{C.document.open(),C.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${v(c("reservations.quote.actions.export","ØªÙ†Ø²ÙŠÙ„ PDF"))}</title><style>html,body{margin:0;height:100%;background:#0f172a;color:#f8fafc;font-family:'Tajawal',sans-serif;} iframe{border:none;width:100%;height:100%;display:block;}</style></head><body><iframe src="${F}" title="PDF preview"></iframe></body></html>`),C.document.close()}catch(N){nt("iframe blob delivery failed",N),window.location.assign(F)}}},ne=M();L(ne,k),setTimeout(()=>URL.revokeObjectURL(k),6e4)}}else{Ut();const A=x.output("bloburl"),k=document.createElement("a");k.href=A,k.download=t,k.rel="noopener",k.style.display="none",document.body.appendChild(k),k.click(),setTimeout(()=>{URL.revokeObjectURL(A),k.remove()},2e3)}}function ft(){if(!E||!X)return;const{previewFrame:e}=X;if(!e)return;const t=E.context||"reservation",n=kr({context:t,reservation:E.reservation,customer:E.customer,project:E.project,crewAssignments:E.crewAssignments,totals:E.totals,totalsDisplay:E.totalsDisplay,rentalDays:E.rentalDays,currencyLabel:E.currencyLabel,sections:E.sections,fieldSelections:E.fields,quoteNumber:E.quoteNumber,quoteDate:E.quoteDateLabel,terms:E.terms,projectCrew:E.projectCrew,projectExpenses:E.projectExpenses,projectEquipment:E.projectEquipment,projectInfo:E.projectInfo,clientInfo:E.clientInfo,paymentSummary:E.paymentSummary,projectTotals:E.projectTotals});vt("render"),e.srcdoc=`<!DOCTYPE html>${n}`,e.addEventListener("load",async()=>{try{const a=e.contentDocument,s=a?.defaultView||window,r=a?.documentElement||a;r&&(Ps(r),$s(r,s),xs(r,s));const i=a?.getElementById("quotation-pdf-root");try{i&&(await hn(i,{context:"preview"}),await $r(120),xr(i)&&await hn(i,{context:"preview"}),$a(i))}catch(m){console.error("[reservations/pdf] failed to layout preview document",m)}const o=Array.from(a?.querySelectorAll?.(".quote-page")||[]),d=a?.querySelector(".quote-preview-pages"),u=an;let l=18;if(d&&a?.defaultView){const m=a.defaultView.getComputedStyle(d),p=parseFloat(m.rowGap||m.gap||`${l}`);Number.isFinite(p)&&p>=0&&(l=p)}const y=sn,f=o.length?o.length*y+Math.max(0,(o.length-1)*l):y;if(e.dataset.baseWidth=String(u),e.dataset.baseHeight=String(f),e.style.width=`${u}px`,e.style.minWidth=`${u}px`,e.style.height=`${f}px`,e.style.minHeight=`${f}px`,X?.previewFrameWrapper&&!X?.userAdjustedZoom){const m=X.previewFrameWrapper.clientWidth-24;m>0&&m<u?tt=Math.max(m/u,.3):tt=1}jr(tt)}finally{Ut()}},{once:!0})}function sc(e){if(!E)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(t.checked?E.sections.add(n):E.sections.delete(n),wr(E),_r(),ft())}function rc(e){if(!E)return;const t=e.currentTarget,n=t?.dataset?.sectionId,a=t?.dataset?.fieldId;if(!n||!a)return;const s=E.context||"reservation",r=E.fields||(E.fields=xn(s)),i=So(r,n);t.checked?i.add(a):i.delete(a),wr(E),ft()}function ic(e){if(!E)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(Ea(E,n),E.sectionExpansions[n]=t.open)}function _r(){if(!X?.toggles||!E)return;const{toggles:e}=X,t=E.fields||{},n=E.context||"reservation";Ea(E);const a=$n(n),s=er(n),r=a.map(({id:i,labelKey:o,fallback:d})=>{const u=c(o,d),l=E.sections.has(i),y=s[i]||[],f=wo(E,i),m=y.length?`<div class="quote-toggle-sublist">
          ${y.map(p=>{const g=Aa(t,i,p.id),h=l?"":"disabled",x=p.labelKey?c(p.labelKey,p.fallback):p.fallback;return`
              <label class="quote-toggle quote-toggle--field">
                <input type="checkbox" data-field-toggle data-section-id="${i}" data-field-id="${p.id}" ${g?"checked":""} ${h}>
                <span>${v(x)}</span>
              </label>
            `}).join("")}
        </div>`:"";return`
      <details class="quote-toggle-group" data-section-group data-section-id="${i}" ${f?"open":""}>
        <summary class="quote-toggle-summary">
          <label class="quote-toggle quote-toggle--section">
            <input type="checkbox" data-section-toggle data-section-id="${i}" ${l?"checked":""}>
            <span>${v(u)}</span>
          </label>
          ${y.length?'<span class="quote-toggle-caret" aria-hidden="true"></span>':""}
        </summary>
        ${m}
      </details>
    `}).join("");e.innerHTML=r,e.querySelectorAll("input[data-section-toggle]").forEach(i=>{i.addEventListener("change",sc)}),e.querySelectorAll("input[data-field-toggle]").forEach(i=>{i.addEventListener("change",rc)}),e.querySelectorAll("details[data-section-group]").forEach(i=>{i.addEventListener("toggle",ic)})}function oc(){if(X?.modal)return X;const e=document.createElement("div");e.id="reservationQuoteModal",e.className="modal fade quote-preview-modal",e.tabIndex=-1,e.setAttribute("aria-labelledby","reservationQuoteModalLabel"),e.setAttribute("aria-hidden","true"),e.style.display="none",e.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationQuoteModalLabel">${v(c("reservations.quote.previewTitle","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="quote-preview-layout">
            <aside class="quote-preview-sidebar">
              <h6>${v(c("reservations.quote.toggleHeading","Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØµØ¯ÙŠØ±Ù‡Ø§"))}</h6>
              <div class="quote-toggle-list" data-quote-toggles></div>
              <div class="quote-meta-info" data-quote-meta></div>
              <div class="quote-terms-editor" data-quote-terms-editor>
                <label class="quote-terms-editor__label" for="quote-terms-input">${v(c("reservations.quote.termsEditor.title","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)"))}</label>
                <textarea id="quote-terms-input" class="quote-terms-editor__textarea" rows="6" data-quote-terms-input placeholder="${v(c("reservations.quote.termsEditor.placeholder","Ø§ÙƒØªØ¨ ÙƒÙ„ Ø´Ø±Ø· ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„"))}"></textarea>
                <button type="button" class="quote-terms-reset" data-quote-terms-reset>${v(c("reservations.quote.termsEditor.reset","Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"))}</button>
              </div>
            </aside>
            <section class="quote-preview-panel">
              <div class="quote-preview" data-quote-preview></div>
            </section>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">${v(c("reservations.quote.actions.close","Ø¥ØºÙ„Ø§Ù‚"))}</button>
          <button type="button" class="btn btn-primary" data-quote-download>
            ${v(c("reservations.quote.actions.export","ğŸ“„ ØªÙ†Ø²ÙŠÙ„ PDF"))}
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector("[data-quote-toggles]"),n=e.querySelector("[data-quote-preview]"),a=e.querySelector("[data-quote-meta]"),s=e.querySelector("[data-quote-terms-input]"),r=e.querySelector("[data-quote-terms-reset]"),i=e.querySelector("[data-quote-download]"),o=e.querySelector(".modal-header"),d=o?.querySelector(".btn-close"),u=Array.from(e.querySelectorAll('[data-bs-dismiss="modal"]')),l=document.createElement("div");l.className="quote-preview-header-actions",o&&o.insertBefore(l,d||null);const y=document.createElement("iframe");y.className="quote-preview-frame",y.setAttribute("title",c("reservations.quote.previewTitle","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø±Ø¶ Ø³Ø¹Ø±")),y.setAttribute("loading","lazy"),y.setAttribute("frameborder","0");const f=document.createElement("div");f.className="quote-preview-zoom-controls",f.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-zoom-out title="${v(c("reservations.quote.zoom.out","ØªØµØºÙŠØ±"))}">âˆ’</button>
    <span class="quote-preview-zoom-value" data-zoom-value>100%</span>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-in title="${v(c("reservations.quote.zoom.in","ØªÙƒØ¨ÙŠØ±"))}">+</button>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-reset title="${v(c("reservations.quote.zoom.reset","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·"))}">1:1</button>
  `;const m=document.createElement("div");m.className="quote-preview-frame-wrapper",m.appendChild(y),n.innerHTML="";const p=document.createElement("div");p.className="quote-preview-scroll",p.appendChild(m),n.appendChild(p);const g=document.createElement("div");g.className="quote-preview-status",g.setAttribute("role","status"),g.setAttribute("aria-live","polite"),g.hidden=!0,g.innerHTML=`
    <span class="quote-preview-spinner" data-quote-status-spinner aria-hidden="true"></span>
    <span data-quote-status-text>${v(ar("render"))}</span>
    <button type="button" class="quote-preview-status-action" data-quote-status-action hidden></button>
  `,n.appendChild(g),l.appendChild(f),i?.addEventListener("click",async()=>{if(E){i.disabled=!0;try{await Tr()}finally{i.disabled=!1}}});const h=()=>{Xn()||Yn(e)};u.forEach(S=>{S?.addEventListener("click",h)}),d&&!u.includes(d)&&d.addEventListener("click",h),e.addEventListener("click",S=>{Xn()||S.target===e&&Yn(e)}),X={modal:e,toggles:t,preview:n,previewScroll:p,previewFrameWrapper:m,zoomControls:f,zoomValue:f.querySelector("[data-zoom-value]"),previewFrame:y,meta:a,downloadBtn:i,statusIndicator:g,statusText:g.querySelector("[data-quote-status-text]"),statusSpinner:g.querySelector("[data-quote-status-spinner]"),statusAction:g.querySelector("[data-quote-status-action]"),termsInput:s,termsReset:r,statusKind:null,userAdjustedZoom:!1};const x=f.querySelector("[data-zoom-out]"),b=f.querySelector("[data-zoom-in]"),j=f.querySelector("[data-zoom-reset]");return x?.addEventListener("click",()=>ns(-.1)),b?.addEventListener("click",()=>ns(.1)),j?.addEventListener("click",()=>vn(1,{markManual:!0})),s&&s.addEventListener("input",cc),r&&r.addEventListener("click",lc),vn(tt),X}function vn(e,{silent:t=!1,markManual:n=!1}={}){tt=Math.min(Math.max(e,.25),2.2),n&&X&&(X.userAdjustedZoom=!0),jr(tt),!t&&X?.zoomValue&&(X.zoomValue.textContent=`${Math.round(tt*100)}%`)}function ns(e){vn(tt+e,{markManual:!0})}function jr(e){if(!X?.previewFrame||!X.previewFrameWrapper)return;const t=X.previewFrame,n=X.previewFrameWrapper,a=Number(t.dataset.baseWidth)||794,s=Number(t.dataset.baseHeight)||t.contentDocument?.body?.scrollHeight||1123;t.style.transform=`scale(${e})`,t.style.transformOrigin="top center",Ia()?(n.style.width="100%",n.style.maxWidth="100%",n.style.minWidth="0"):(n.style.width=`${a}px`,n.style.maxWidth=`${a}px`,n.style.minWidth=`${a}px`),n.style.minHeight=`${s}px`,n.style.height=`${s}px`}function Cr(){if(!X?.meta||!E)return;const{meta:e}=X;e.innerHTML=`
    <div class="quote-meta-card">
      <div><span>${v(c("reservations.quote.labels.number","Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</span><strong>${v(E.quoteNumber)}</strong></div>
      <div><span>${v(c("reservations.quote.labels.dateGregorian","Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ"))}</span><strong>${v(E.quoteDateLabel)}</strong></div>
    </div>
  `}function xa(){if(!X?.termsInput)return;const e=(E?.terms&&E.terms.length?E.terms:Ke).join(`
`);X.termsInput.value!==e&&(X.termsInput.value=e)}function cc(e){if(!E)return;const t=Qn(e?.target?.value??"");if(t.length){E.terms=t;const n=document.getElementById("reservation-terms");n&&(n.value=e.target.value);const a=document.getElementById("edit-res-terms");a&&(a.value=e.target.value)}else{E.terms=[...Ke],xa();const n=Ke.join(`
`),a=document.getElementById("reservation-terms");a&&(a.value=n);const s=document.getElementById("edit-res-terms");s&&(s.value=n)}ft()}function lc(e){if(e?.preventDefault?.(),!E)return;E.terms=[...Ke];const t=document.getElementById("reservation-terms");t&&(t.value=Ke.join(`
`));const n=document.getElementById("edit-res-terms");n&&(n.value=Ke.join(`
`)),xa(),ft()}async function Tr(){if(!E)return;vt("export");const t=!Ia()&&pr(),n=_n(),a=null,s=!n&&t?window.open("","_blank"):null;(d=>{if(d)try{d.document.open(),d.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${v(c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF..."))}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${v(c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF..."))}</h1><p>${v(c("reservations.quote.status.exportingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±..."))}</p></div></body></html>`),d.document.close()}catch(u){nt("failed to prime download window",u)}})(s);let i=null;const o=c("reservations.quote.errors.browserLimit","ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");try{await Fo(),Ln("html2pdf ensured");const d=E.context||"reservation";try{const{sequence:f,quoteNumber:m}=await Mo(d);E.quoteSequence=f,E.quoteNumber=m,E.sequenceCommitted=!0}catch(f){nt("failed to reserve sequence at export time, proceeding with preview number",f)}const u=kr({context:d,reservation:E.reservation,customer:E.customer,project:E.project,crewAssignments:E.crewAssignments,totals:E.totals,totalsDisplay:E.totalsDisplay,rentalDays:E.rentalDays,currencyLabel:E.currencyLabel,sections:E.sections,fieldSelections:E.fields,quoteNumber:E.quoteNumber,quoteDate:E.quoteDateLabel,terms:E.terms,projectCrew:E.projectCrew,projectExpenses:E.projectExpenses,projectEquipment:E.projectEquipment,projectInfo:E.projectInfo,clientInfo:E.clientInfo,paymentSummary:E.paymentSummary,projectTotals:E.projectTotals});i=document.createElement("div"),i.innerHTML=u,Object.assign(i.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(i),Ps(i),$s(i),xs(i),Ln("export container prepared");const l=i.firstElementChild;if(l){l.setAttribute("dir","rtl"),l.style.direction="rtl",l.style.textAlign="right",l.setAttribute("data-theme","light"),l.classList.remove("dark","dark-mode"),l.style.margin="0",l.style.padding="0",l.style.width="210mm",l.style.maxWidth="210mm",l.style.marginLeft="auto",l.style.marginRight="auto",l.scrollTop=0,l.scrollLeft=0;try{await hn(l,{context:"export"}),await $r(120),xr(l)&&await hn(l,{context:"export"}),await Jt(l),$a(l),Ln("layout complete for export document")}catch(f){Zn(f,"layoutQuoteDocument",{suppressToast:!0})}}const y=`quotation-${E.quoteNumber}.pdf`;await ac(l,{filename:y,safariWindowRef:s,mobileWindowRef:a})}catch(d){ea({container:i,safariWindowRef:s,mobileWindowRef:a}),i=null,Zn(d,"exportQuoteAsPdf",{toastMessage:o})}finally{i&&i.parentNode&&i.parentNode.removeChild(i),Ut()}}function Nr(){const e=oc();e?.modal&&(Vt=!1,tt=1,X&&(X.userAdjustedZoom=!1),vn(tt,{silent:!0}),_r(),Cr(),xa(),ft(),ho(e.modal))}async function dc({reservation:e,customer:t,project:n}){if(!e){I(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}await Pr();const a=Pa(e),{totalsDisplay:s,totals:r,rentalDays:i}=Er(e,a,n),o=c("reservations.create.summary.currency","SR"),{sequence:d,quoteNumber:u}=await vr("reservation"),l=new Date,y=io();E={context:"reservation",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:i,currencyLabel:o,projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set($n("reservation").filter(f=>f.defaultSelected).map(f=>f.id)),sectionExpansions:qa("reservation"),fields:xn("reservation"),terms:y,quoteSequence:d,quoteNumber:u,quoteDate:l,quoteDateLabel:qr(l),sequenceCommitted:!1},Ar(E),Nr();try{lr()}catch{}}async function Yc({project:e}){if(!e){I(c("projects.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));return}await Pr();let t=ts(e);const{project:n}=t;if(!n){I(c("projects.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));return}try{(!Array.isArray(t.equipmentItems)||t.equipmentItems.length===0)&&n?.id!=null&&(await ys({project_id:n.id}),t=ts(n))}catch(o){console.warn("[reservationPdf] refreshReservationsForProject failed, proceeding with snapshot/state",o)}const{sequence:a,quoteNumber:s}=await vr("project"),r=new Date,i=[...ro];E={context:"project",reservation:null,customer:t.customer,project:n,technicians:t.crew||[],clientInfo:t.clientInfo,projectInfo:t.projectInfo,projectCrew:t.crew,projectExpenses:t.expenses,projectEquipment:t.equipment,equipmentItems:t.equipmentItems||[],crewAssignments:t.crewAssignments||[],totals:t.totals,projectTotals:t.projectTotals,totalsDisplay:t.totalsDisplay,rentalDays:t.projectDurationDays,currencyLabel:t.currencyLabel,sections:new Set($n("project").filter(o=>o.defaultSelected).map(o=>o.id)),sectionExpansions:qa("project"),fields:xn("project"),terms:i,quoteSequence:a,quoteNumber:s,quoteDate:r,quoteDateLabel:qr(r),sequenceCommitted:!1,paymentSummary:t.paymentSummary,projectNotes:t.notes,paymentHistory:t.paymentHistory},Ar(E),Nr();try{lr()}catch{}}function uc({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a}={}){const s=jt(),{reservations:r=[],customers:i=[],technicians:o=[],projects:d=[]}=xe(),u=r.map(b=>{const j=Dn(b);return{...j,id:b.id??j.id,reservationId:b.reservationId??b.reservation_id??j.reservationId,reservationCode:b.reservationCode??b.reservation_code??j.reservationCode}}),l=u,y=Array.isArray(s)?s:o||[],f=new Map((d||[]).map(b=>[String(b.id),b])),m=document.getElementById(e);if(!m){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!l||l.length===0){m.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const p=t||Si(),g=new Map(i.map(b=>[String(b.id),b])),h=new Map(y.map(b=>[String(b.id),b])),x=eo({reservations:u,filters:p,customersMap:g,techniciansMap:h,projectsMap:f});if(x.length===0){m.innerHTML=`<p>${c("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}m.innerHTML=`<div class="reservations-grid">${to({entries:x,customersMap:g,techniciansMap:h,projectsMap:f})}</div>`,m.querySelectorAll('[data-action="details"]').forEach(b=>{const j=Number(b.dataset.reservationIndex);Number.isNaN(j)||b.addEventListener("click",()=>{typeof n=="function"&&n(j)})}),m.querySelectorAll('button[data-action="confirm"]').forEach(b=>{const j=Number(b.dataset.reservationIndex);Number.isNaN(j)||b.addEventListener("click",S=>{S.stopPropagation(),typeof a=="function"&&a(j,S)})})}function mc(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:s=[],customers:r=[],projects:i=[]}=xe(),o=s.map(g=>{const h=Dn(g);return{...h,id:g.id??h.id,reservationId:g.reservationId??g.reservation_id??h.reservationId,reservationCode:g.reservationCode??g.reservation_code??h.reservationCode}}),d=s[e];if(!d)return I(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const u=o[e]??Dn(d),l=r.find(g=>String(g.id)===String(d.customerId)),y=d.projectId?i.find(g=>String(g.id)===String(d.projectId)):null,f=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),p=()=>{const g=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},h=document.getElementById("reservation-details-edit-btn");h&&(h.onclick=()=>{g(),typeof t=="function"&&t(e,{reservation:d,customer:l,getEditContext:a})});const x=document.getElementById("reservation-details-delete-btn");x&&(x.onclick=()=>{g(),typeof n=="function"&&n(e,{reservation:d,customer:l})});const b=f?.querySelector('[data-action="open-project"]');b&&y&&b.addEventListener("click",()=>{g();const S=y?.id!=null?String(y.id):"",z=S?`projects.html?project=${encodeURIComponent(S)}`:"projects.html";window.location.href=z});const j=document.getElementById("reservation-details-export-btn");j&&(j.onclick=async S=>{S?.preventDefault?.(),S?.stopPropagation?.(),j.blur();try{await dc({reservation:d,customer:l,project:y})}catch(z){console.error("âŒ [reservations] export to PDF failed",z),I(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const S=f?.querySelector("[data-tech-slider]");if(S){const z=S.querySelector("[data-slider-track]"),A=S.querySelector("[data-slider-prev]"),k=S.querySelector("[data-slider-next]");if(z&&(A||k)){const M=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",L=()=>{const F=z.querySelector(".reservation-technician-card"),J=F&&F.getBoundingClientRect().width||220,N=12,B=Math.max(1,Math.floor(z.clientWidth/(J+N)));return Math.max(J+N,Math.floor(B*(J+N)*.9))},ne=()=>{const F=Math.max(0,z.scrollWidth-z.clientWidth-2),J=z.scrollLeft<=1,N=z.scrollLeft>=F;A&&(A.disabled=J),k&&(k.disabled=N)},C=F=>{const J=L()*F,N=M?-J:J;z.scrollBy({left:N,behavior:"smooth"})};A?.addEventListener("click",()=>C(-1)),k?.addEventListener("click",()=>C(1)),z.addEventListener("scroll",ne,{passive:!0}),window.addEventListener("resize",ne,{passive:!0}),setTimeout(ne,0)}}}catch{}};if(f){const g=jt()||[];f.innerHTML=Na(u,l,g,e,y),p(),Is().then(()=>{const h=jt()||[];f.innerHTML=Na(u,l,h,e,y),p()}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function Ft(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Wt(e,n),end:Wt(t,a)}}function Sn(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _a(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Lr(){const{container:e,select:t,hint:n,addButton:a}=_a();if(!t)return;const s=t.value,r=gs(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,d=r.map(l=>{const y=Number.isFinite(Number(l.price))?Number(l.price):0,f=q(y.toFixed(2)),m=`${l.name} â€” ${f} ${i}`;return`<option value="${Sn(l.id)}">${Sn(m)}</option>`}).join("");t.innerHTML=`${o}${d}`;const u=r.length>0;t.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),n&&(u?(n.textContent=c("reservations.create.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),u&&s&&r.some(l=>l.id===s)?t.value=s:t.selectedIndex=0}function pc(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||I(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:s=[]}=gt(),{start:r,end:i}=Ft(),{reservations:o=[]}=xe(),d=a!=null&&o[a]||null,u=d?.id??d?.reservationId??null,l=Ks(n,{existingItems:s,start:r,end:i,ignoreReservationId:u});if(!l.success)return t||I(l.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),l;const y=[...s,l.package];return bt(a,y),yt(y),Xe(),t||I(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),l}function as(){const{select:e}=_a();if(!e)return;const t=e.value||"";pc(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function fc(){const{addButton:e,select:t}=_a();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{as()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),as())}),t.dataset.listenerAttached="true"),Lr()}function yt(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),r=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${n}</td></tr>`,rs(t);return}const{groups:d}=Dt({items:e});t.innerHTML=d.map(u=>{const l=u.items[0]||{},y=Lt(l)||u.image,f=y?`<img src="${y}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',m=String(u?.type||"").toLowerCase()==="package"||u.items.some(C=>C?.type==="package"),p=q(String(u.count)),g=_t(u.unitPrice),h=Number.isFinite(g)?wt(g):0,x=_t(u.totalPrice),b=Number.isFinite(x)?x:h*(Number.isFinite(u.count)?u.count:1),j=wt(b),S=`${q(h.toFixed(2))} ${a}`,z=`${q(j.toFixed(2))} ${a}`,A=u.barcodes.map(C=>q(String(C||""))).filter(Boolean),k=A.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${A.map(C=>`<li>${C}</li>`).join("")}
            </ul>
          </details>`:"";let M="";if(m){const C=new Map,F=N=>{const B=Number.parseFloat(q(String(N??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(B)||B<=0||B>99?1:Math.round(B)},J=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&J.push(...u.packageItems),u.items.forEach(N=>{Array.isArray(N?.packageItems)&&J.push(...N.packageItems)}),J.forEach(N=>{if(!N)return;const B=le(N.barcode||N.normalizedBarcode||N.desc||Math.random());if(!B)return;const O=C.get(B),Y=F(N.qtyPerPackage??N.perPackageQty??N.quantityPerPackage??N.qty??N.quantity??1),G=Math.max(1,Math.min(Y,99));if(O){O.qty=G;return}C.set(B,{desc:N.desc||N.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:G,barcode:N.barcode??N.normalizedBarcode??""})}),C.size){const N=Array.from(C.values()).map(B=>{const O=q(String(B.qty>0?Math.min(B.qty,99):1)),Y=Sn(B.desc||""),G=B.barcode?` <span class="reservation-package-items__barcode">(${Sn(q(String(B.barcode)))})</span>`:"";return`<li>${Y}${G} Ã— ${O}</li>`}).join("");M=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${N}
              </ul>
            </details>
          `}}const L=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",ne=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${f}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${m?`${M||""}${k||""}`:k}
              </div>
            </div>
          </td>
          <td>
            <div class="${L}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${i}"${ne}>âˆ’</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${r}"${ne}>+</button>
            </div>
          </td>
          <td>${S}</td>
          <td>${z}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${o}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),rs(t)}function yc(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function jn(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let t=Cn();const n=document.getElementById("edit-res-project")?.value||"";if(n)try{const i=(xe()?.projects||[]).find(d=>String(d.id)===String(n)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(t=o)}catch{}if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,ss();return}const a=c("reservations.create.summary.currency","SR"),s=t.map((r,i)=>{const o=Number.isFinite(Number(r?.amount))&&Number(r.amount)>0?`${q(Number(r.amount).toFixed(2))} ${a}`:"â€”",d=Number.isFinite(Number(r?.percentage))&&Number(r.percentage)>0?`${q(Number(r.percentage).toFixed(2))}%`:"â€”",u=r?.recordedAt?q(ot(r.recordedAt)):"â€”",l=yc(r?.type),y=r?.note?q(r.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${u}</td>
        <td>${y}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${s}</tbody>
      </table>
    </div>
  `,ss()}function gc(){if(Xt()){I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=Fr(e);let a=Rr(t);if(!Number.isFinite(a)||a<=0){I(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const s=Fn.lastResult,r=Number(s?.total)||0,i=Number(s?.paidPercent)||0,o=Number(s?.paidAmount)||0,d=c("reservations.create.summary.currency","SR");let u=null,l=null;if(n==="percent"){const f=Math.max(0,100-i);if(f<=1e-4){I(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,f);if(m!==a){const p=q(m.toFixed(2));I(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",p)),a=m}l=Number(a.toFixed(2)),r>0&&(u=a/100*r)}else{const f=Math.max(0,r-o);if(f<=1e-4){I(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,f);if(m!==a){const p=`${q(m.toFixed(2))} ${d}`;I(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",p)),a=m}u=Number(a.toFixed(2)),r>0&&(l=u/r*100)}u!=null&&(u=Number(u.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const y={type:n,value:a,amount:u,percentage:l,recordedAt:new Date().toISOString()};xc(y),ja(Cn()),jn(),Xe(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),I(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function ss(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(Xt()){n.preventDefault(),I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}gc()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(Xt()){n.preventDefault(),I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const s=Number(a.dataset.index);Number.isNaN(s)||(_c(s),ja(Cn()),jn(),Xe(),I(c("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),t.dataset.listenerAttached="true")}function bc(e){const{index:t,items:n}=gt(),{groups:a}=Dt({items:n}),s=a.find(o=>o.key===e);if(!s||s.items.some(o=>o?.type==="package"))return;let r=-1;for(let o=n.length-1;o>=0;o-=1){const d=n[o];if(Yt(d)===e&&d?.type!=="package"){r=o;break}}if(r<0)return;const i=n.filter((o,d)=>d!==r);bt(t,i),yt(i),Xe()}function hc(e){const{index:t,items:n}=gt(),{groups:a}=Dt({items:n}),s=a.find(o=>o.key===e);if(!s)return;let r=n.filter(o=>Yt(o)!==e);if(s.items.some(o=>o&&o.type==="package")){const o=At(s.packageId??s.items.find(y=>y?.type==="package")?.packageId??""),d=le(s.package_code??s.packageDisplayCode??s.barcode??"");r=r.filter(y=>{if(!y||typeof y!="object"||y.type!=="package")return!0;const f=At(y.packageId??y.package_id??y.id??""),m=le(y.barcode??y.package_code??"");return!(o&&f===o||d&&m&&m===d)});const u=new Set,l=new Set;s.items.forEach(y=>{(Array.isArray(y?.packageItems)?y.packageItems:[]).forEach(m=>{const p=le(m?.barcode||m?.normalizedBarcode||"");p&&u.add(p);const g=m?.equipmentId??m?.equipment_id??null;g!=null&&l.add(String(g))})}),(u.size||l.size)&&(r=r.filter(y=>{const f=le(y?.barcode||""),m=y?.equipmentId??y?.id??null;return!(f&&u.has(f)||m!=null&&l.has(String(m)))}))}r.length!==n.length&&(bt(t,r),yt(r),Xe())}function vc(e){const{index:t,items:n}=gt(),{groups:a}=Dt({items:n}),s=a.find(h=>h.key===e);if(!s||s.items.some(h=>h?.type==="package"))return;const{start:r,end:i}=Ft();if(!r||!i){I(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=xe(),d=t!=null&&o[t]||null,u=d?.id??d?.reservationId??null,l=new Set(n.map(h=>le(h.barcode))),{equipment:y=[]}=xe(),f=(y||[]).find(h=>{const x=le(h?.barcode);return!x||l.has(x)||Yt({desc:h?.desc||h?.description||h?.name||"",price:Number(h?.price)||0})!==e||!ds(h)?!1:!ct(x,r,i,u)});if(!f){I(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=le(f.barcode),p=Et(f);if(!p){I(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=[...n,{id:p,equipmentId:p,barcode:m,desc:f.desc||f.description||f.name||s.description||"",qty:1,price:Number.isFinite(Number(f.price))?Number(f.price):s.unitPrice,image:Lt(f)}];bt(t,g),yt(g),Xe()}function rs(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s,itemIndex:r}=n.dataset;if(a==="decrease-edit-group"&&s){bc(s);return}if(a==="increase-edit-group"&&s){vc(s);return}if(a==="remove-edit-group"&&s){hc(s);return}if(a==="remove-edit-item"){const i=Number(r);Number.isNaN(i)||Ac(i)}}),e.dataset.groupListenerAttached="true")}function Xt(){return!!document.getElementById("edit-res-project")?.value}function Sc(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{Xt()&&(I(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(s=>a.addEventListener(s,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function wc(e){const t=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),s=document.getElementById("edit-res-paid"),r=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([n,a,s,r,i,o,d].forEach(Sc),e){if(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),s){const u=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(u)try{const f=(xe()?.projects||[]).find(p=>String(p.id)===String(u)),m=typeof f?.paymentStatus=="string"?f.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(l=m)}catch{}s.value=l,s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t,s.dataset&&delete s.dataset.userSelected}r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),d&&(d.dataset.linkedDisabled="true")}else n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function Xe(){const e=document.getElementById("edit-res-summary");if(!e)return;jn();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),Je(a),Xe()}),a.dataset.listenerAttached="true");const s=q(t?.value||"0");t&&(t.value=s);const r=parseFloat(s)||0,i=n?.value||"percent",o=Xt();wc(o);const d=document.getElementById("edit-res-tax"),u=o?!1:d?.checked||!1,l=!o&&a?.dataset?.userSelected==="true";let y="unpaid";if(o){const j=document.getElementById("edit-res-project")?.value||"";if(j)try{const z=(xe()?.projects||[]).find(k=>String(k.id)===String(j)),A=typeof z?.paymentStatus=="string"?z.paymentStatus.toLowerCase():null;A&&["paid","partial","unpaid"].includes(A)&&(y=A)}catch{}}else y=l&&a?.value||"unpaid";let f=null;!o&&u&&(Ze("edit-res-company-share"),f=Ct("edit-res-company-share"),(!Number.isFinite(f)||f<=0)&&(Ze("edit-res-company-share"),f=Ct("edit-res-company-share")));const{items:m=[],payments:p=[]}=gt(),{start:g,end:h}=Ft(),x=Fn({items:m,discount:r,discountType:i,applyTax:u,paidStatus:y,start:g,end:h,companySharePercent:f,paymentHistory:p});e.innerHTML=x;const b=Fn.lastResult;if(b&&a){const j=b.paymentStatus;l?Je(a,a.value):(a.value!==j&&(a.value=j),a.dataset&&delete a.dataset.userSelected,Je(a,j))}else a&&Je(a,a.value)}function Ac(e){if(e==null)return;const{index:t,items:n}=gt();if(!Array.isArray(n))return;const a=n.filter((s,r)=>r!==e);bt(t,a),yt(a),Xe()}async function qc(e){const t=e?.value??"",n=le(t);if(!n)return;const a=ra(n);if(!a){I(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const s=ut(a);if(s==="maintenance"||s==="retired"){I(qt(s));return}const r=le(n),{index:i,items:o=[]}=gt();if(o.findIndex(h=>le(h.barcode)===r)>-1){I(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:u,end:l}=Ft();if(!u||!l){I(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:y=[]}=xe(),f=i!=null&&y[i]||null,m=f?.id??f?.reservationId??null;if(ct(r,u,l,m)){try{const h=new URLSearchParams({type:"equipment",id:r,start:u,end:l});m!=null&&h.set("ignore",String(m));const x=await Ue(`/reservations/availability.php?${h.toString()}`),b=Array.isArray(x?.conflicts)?x.conflicts:[],j=Array.from(new Set(b.map(z=>z?.reservation_code||(z?.reservation_id!=null?`#${z.reservation_id}`:null)).filter(Boolean))),S=j.length?`: ${j.join("ØŒ ")}`:"";I(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+S,"warning",6e3)}catch{I(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const p=Et(a);if(!p){I(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=[...o,{id:p,equipmentId:p,barcode:r,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];bt(i,g),e&&(e.value=""),yt(g),Xe()}async function wn(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=zs(t),a=le(n?.barcode||t);if(!n||!a){I(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const s=ut(n);if(s==="maintenance"||s==="retired"){I(qt(s));return}const{start:r,end:i}=Ft();if(!r||!i){I(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:d=[]}=gt();if(d.some(g=>le(g.barcode)===a)){I(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:l=[]}=xe(),y=o!=null&&l[o]||null,f=y?.id??y?.reservationId??null;if(ct(a,r,i,f)){try{const g=new URLSearchParams({type:"equipment",id:a,start:r,end:i});f!=null&&g.set("ignore",String(f));const h=await Ue(`/reservations/availability.php?${g.toString()}`),x=Array.isArray(h?.conflicts)?h.conflicts:[],b=Array.from(new Set(x.map(S=>S?.reservation_code||(S?.reservation_id!=null?`#${S.reservation_id}`:null)).filter(Boolean))),j=b.length?`: ${b.join("ØŒ ")}`:"";I(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+j,"warning",6e3)}catch{I(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const m=Et(n);if(!m){I(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const p=[...d,{id:m,equipmentId:m,barcode:a,desc:n.desc,qty:1,price:n.price,image:n.image||n.imageUrl||n.img||null}];bt(o,p),yt(p),Xe(),e.value=""}function Br(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),wn(e))});const t=()=>{Os(e.value,"edit-res-equipment-description-options")&&wn(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{Xe()});const e=()=>{fc()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Lr()})}typeof window<"u"&&(window.getEditReservationDateRange=Ft,window.renderEditPaymentHistory=jn);function Ec(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){Un(e);return}wn(e)}}function Zc(){pt(),Br()}function Ic(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let xt=null,Ye=[],at=[],ta=null,Oe={},Bn=!1,is=!1;function kc(){if(!is)try{document.addEventListener("click",e=>{const t=e.target?.closest?.("#save-reservation-changes");if(t){try{if(t.dataset.listenerAttached==="true")return}catch{}try{t.dataset.saving||(t.dataset.saving="true",setTimeout(()=>{try{delete t.dataset.saving}catch{}},1200))}catch{}try{zr(Oe).catch(n=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",n)})}catch(n){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",n)}}},!0),is=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Pc="__DEBUG_CREW__";function $c(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Pc);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function os(e,t){if($c())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,t)}catch{}}function Kt(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),s=document.getElementById("edit-res-confirmed-wrapper"),r=!!e;if(n&&(n.value=r?"true":"false"),a){const i=a.dataset.confirmLabel||"âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯",o=a.dataset.pendingLabel||"â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯";a.innerHTML=r?i:o,a.dataset.state=r?"confirmed":"pending",a.classList.toggle("btn-success",r&&!t),a.classList.toggle("btn-outline-secondary",!r||t),a.disabled=t,a.setAttribute("aria-pressed",r?"true":"false")}s&&s.classList.toggle("is-disabled",t)}function rn(){return document.getElementById("edit-res-confirmed")?.value==="true"}function gt(){return{index:xt,items:Ye,payments:at}}function bt(e,t,n=at){xt=typeof e=="number"?e:null,Ye=Array.isArray(t)?[...t]:[],at=Array.isArray(n)?[...n]:[]}function Dr(){xt=null,Ye=[],ii(),at=[]}function Cn(){return[...at]}function ja(e){at=Array.isArray(e)?[...e]:[]}function xc(e){e&&(at=[...at,e])}function _c(e){!Number.isInteger(e)||e<0||(at=at.filter((t,n)=>n!==e))}function on(e,t=1){const n=Number.parseFloat(q(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function na(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(q(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function jc(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?le(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:on(e.qty??e.quantity??e.count??1),price:na(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function Cc(e,t=0){if(!e||typeof e!="object")return null;const n=At(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=1,r=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:ma(e)).map(f=>jc(f)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=na(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const f=na(i,0);f>0&&a>0&&(o=Number((f/a).toFixed(2)))}const d=e.package_code??e.packageCode??e.barcode??null,l=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,d,n].find(f=>f!=null&&String(f).trim()!=="")||`Package ${n}`,y=e.image??e.cover??e.thumbnail??r.find(f=>f?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:q(String(l)),name:q(String(l)),qty:a,price:o,barcode:d,packageItems:r,image:y}}function Tc(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const s=e.get(a);if(s==null)return;const r=s-n;e.set(a,r>0?r:0)})}function Nc(e={},t=[]){const n=Array.isArray(t)?t.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return n;const s=a.map((o,d)=>Cc(o,d)).filter(Boolean);if(!s.length)return n;const r=new Map;s.forEach(o=>{const d=on(o.qty??o.quantity??1);if(o.barcode){const u=le(o.barcode);if(u){const l=`package::${u}`;r.set(l,(r.get(l)??0)+d)}}(o.packageItems||[]).forEach(u=>{if(!u)return;const l=d*on(u.qty??u.quantity??1),y=u.equipmentId??null,f=u.normalizedBarcode||(u.barcode?le(u.barcode):null);if(y!=null){const m=`equipment::${String(y)}`;r.set(m,(r.get(m)??0)+l)}if(f){const m=`barcode::${f}`;r.set(m,(r.get(m)??0)+l)}})});const i=[];return n.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const h=At(o.packageId??o.package_id??o.id??"");s.some(b=>b.packageId===h)||i.push({...o});return}const d=on(o.qty??o.quantity??1),u=Et(o),l=o.barcode?le(o.barcode):null,y=[];u!=null&&y.push(`equipment::${String(u)}`),l&&y.push(`barcode::${l}`);const f=y.map(h=>r.get(h)??0).filter(h=>h>0);if(!f.length){i.push({...o});return}const m=Math.min(...f);if(m<=0){i.push({...o});return}const p=Math.min(m,d);if(Tc(r,y,p),p>=d)return;const g=d-p;i.push({...o,qty:g,quantity:g})}),[...i,...s.map(o=>({...o}))]}function Lc(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Fr(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Rr(e){if(!e)return null;const t=q(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Bc(e,t){if(e){e.value="";return}}function Ht(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Mr(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(q(String(e.value??""))),a=Number.parseFloat(q(String(e.amount??""))),s=Number.parseFloat(q(String(e.percentage??""))),r=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,i=Number.isFinite(s)?s:t==="percent"&&Number.isFinite(n)?n:null,o=t??(Number.isFinite(r)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?r??null:o==="percent"?i??null:Number.isFinite(n)?n:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(r)?r:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:u}}function Dc(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),s=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),r=t?.projectId?String(t.projectId):"",i=Array.isArray(e)?[...e].sort((d,u)=>String(u.createdAt||u.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${Ht(a)}</option>`];i.forEach(d=>{o.push(`<option value="${Ht(d.id)}">${Ht(d.title||a)}</option>`)}),r&&!i.some(d=>String(d.id)===r)&&o.push(`<option value="${Ht(r)}">${Ht(s)}</option>`),n.innerHTML=o.join(""),r?n.value=r:n.value=""}function Hr(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),s=document.getElementById("edit-res-discount-type"),r=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=r),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=r),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=r),s&&(s.value="percent",s.disabled=!0,s.classList.add("disabled","reservation-input-disabled"),s.title=r);else{if(t){const d=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",d&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("disabled","reservation-input-disabled"),s.title="")}aa("tax");const o=Oe?.updateEditReservationSummary;typeof o=="function"&&o()}function aa(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const r=Oe?.updateEditReservationSummary;typeof r=="function"&&r()};if(Bn){a();return}Bn=!0;const s=()=>{Bn=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(St)),t.disabled){n.checked=!1,I(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),s();return}t.checked||(t.checked=!0),Ze("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Ze("edit-res-company-share"):n.checked&&(n.checked=!1));s()}async function cs(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:s,updateEditReservationSummary:r,ensureModal:i}={}){const{customers:o,projects:d}=xe(),l=An()?.[e];if(!l){I(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}Oe={...Oe,reservation:l,projects:d||[]},t?.(),Dc(d||[],l);const y=l.projectId&&d?.find?.(R=>String(R.id)===String(l.projectId))||null,{effectiveConfirmed:f,projectLinked:m}=Bt(l,y),p=l.items?l.items.map(R=>({...R,equipmentId:R.equipmentId??R.equipment_id??R.id,barcode:le(R?.barcode)})):[],g=Nc(l,p),x=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map(R=>Mr(R)).filter(Boolean);bt(e,g,x);const b=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),j=o?.find?.(R=>String(R.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const S=document.getElementById("edit-res-id");S&&(S.value=l.reservationId||l.id);const z=document.getElementById("edit-res-customer");z&&(z.value=j?.customerName||b);const A=typeof a=="function"?a(l.start):{date:"",time:""},k=typeof a=="function"?a(l.end):{date:"",time:""};n?.("edit-res-start",A.date),n?.("edit-res-start-time",A.time),n?.("edit-res-end",k.date),n?.("edit-res-end-time",k.time);const M=document.getElementById("edit-res-notes");M&&(M.value=l.notes||"");const L=document.getElementById("edit-res-discount");if(L){const R=m?0:l.discount??0;L.value=q(R)}const ne=document.getElementById("edit-res-discount-type");ne&&(ne.value=m?"percent":l.discountType||"percent");const C=l.projectId?!1:!!l.applyTax,F=document.getElementById("edit-res-tax");F&&(F.checked=C);const J=document.getElementById("edit-res-company-share");if(J){const R=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,ie=R!=null?Number.parseFloat(q(String(R).replace("%","").trim())):NaN,ve=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,Se=ve!=null?ve===!0||ve===1||ve==="1"||String(ve).toLowerCase()==="true":Number.isFinite(ie)&&ie>0,je=Se&&Number.isFinite(ie)&&ie>0?ie:St,me=C||Se;J.checked=me,J.dataset.companyShare=String(je)}Kt(f,{disable:m});const N=document.getElementById("edit-res-paid"),B=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");N&&(N.value=B,N.dataset&&delete N.dataset.userSelected);const O=document.getElementById("edit-res-payment-progress-type"),Y=document.getElementById("edit-res-payment-progress-value");O?.dataset?.userSelected&&delete O.dataset.userSelected,O&&(O.value="percent"),Bc(Y);const G=document.getElementById("edit-res-cancelled");if(G){const R=String(l?.status||l?.reservationStatus||"").toLowerCase();G.checked=["cancelled","canceled"].includes(R),G.checked&&Kt(f,{disable:!0})}let D=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map(R=>String(R));if(!Array.isArray(D)||D.length===0){const R=ni(l.id??l.reservationId??l.reservation_code??null);Array.isArray(R)&&R.length&&(D=R)}try{await Is()}catch(R){console.warn("[reservationsEdit] positions load failed (non-fatal)",R)}if(ai(D),s?.(g),typeof window<"u"){const R=window?.renderEditPaymentHistory;typeof R=="function"&&R()}Hr(),r?.();const W=document.getElementById("editReservationModal");ta=Lc(W,i),ta?.show?.();try{Fc?.(Oe)}catch(R){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",R)}kc()}async function zr({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:s,renderReservations:r,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(xt===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),y=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",f=document.getElementById("edit-res-notes")?.value||"",m=q(document.getElementById("edit-res-discount")?.value||"0");let p=parseFloat(m)||0,g=document.getElementById("edit-res-discount-type")?.value||"percent";const h=rn(),x=document.getElementById("edit-res-paid"),b=x?.dataset?.userSelected==="true",j=b&&x?.value||"unpaid",S=document.getElementById("edit-res-payment-progress-type"),z=document.getElementById("edit-res-payment-progress-value"),A=Fr(S),k=Rr(z),M=document.getElementById("edit-res-project")?.value||"",ne=document.getElementById("edit-res-cancelled")?.checked===!0,C=si();C.map($=>$?.technicianId).filter(Boolean);const F=document.getElementById("edit-res-company-share"),J=document.getElementById("edit-res-tax");if(!d||!l){I(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const N=typeof e=="function"?e:($,T)=>`${$}T${T||"00:00"}`,B=N(d,u),O=N(l,y);if(B&&O&&new Date(B)>new Date(O)){I(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const G=An()?.[xt];if(!G){I(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(Ye)||Ye.length===0&&C.length===0){I(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const D=typeof t=="function"?t:()=>!1,W=G.id??G.reservationId;for(const $ of Ye){if($?.type==="package"&&Array.isArray($.packageItems)){for(const K of $.packageItems){const U=K?.barcode??K?.normalizedBarcode??"";if(!U)continue;const Q=ut(U);if(Q!=="reserved"&&Q!=="available"){I(qt(Q));return}}continue}const T=ut($.barcode);if(T!=="reserved"&&T!=="available"){I(qt(T));return}}{const $=typeof n=="function"?n:()=>!1;for(const T of Ye){if(T?.type!=="package")continue;const K=T.packageId??T.package_id??null,U=T.desc||T.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(K&&$(K,B,O,W)){const Q=Array.isArray(T?.packageItems)?T.packageItems.map(ce=>le(ce?.barcode??ce?.normalizedBarcode??"")).filter(Boolean):[];let Z=Fa(Q,B,O,W);if(!Z.length)try{const ce=new URLSearchParams;ce.set("type","package"),ce.set("id",String(K)),ce.set("start",B),ce.set("end",O),W!=null&&ce.set("ignore",String(W));const Pe=await Ue(`/reservations/availability.php?${ce.toString()}`),He=Array.isArray(Pe?.conflicts)?Pe.conflicts:[];Z=Array.from(new Set(He.map(we=>we?.reservation_code||(we?.reservation_id!=null?`#${we.reservation_id}`:null)).filter(Boolean)))}catch{}const re=Z.length?` (${Z.join("ØŒ ")})`:"";I(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${q(String(U))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+re,"warning",-1);return}if(Array.isArray(T?.packageItems)&&T.packageItems.length){const Q=(T.packageItems||[]).map(ce=>le(ce?.barcode??ce?.normalizedBarcode??"")).filter(Boolean),Z=Q.length,re=Q.filter(ce=>D(ce,B,O,W)).length;if(Z>0&&re>=Z){const ce=(T.packageItems||[]).map(we=>le(we?.barcode??we?.normalizedBarcode??"")).filter(Boolean);let Pe=Fa(ce,B,O,W);if(!Pe.length)try{const we=new URLSearchParams;we.set("type","package"),K!=null&&we.set("id",String(K)),we.set("start",B),we.set("end",O),W!=null&&we.set("ignore",String(W));const _=await Ue(`/reservations/availability.php?${we.toString()}`),ee=Array.isArray(_?.conflicts)?_.conflicts:[];Pe=Array.from(new Set(ee.map(V=>V?.reservation_code||(V?.reservation_id!=null?`#${V.reservation_id}`:null)).filter(Boolean)))}catch{}const He=Pe.length?` (${Pe.join("ØŒ ")})`:"";I(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${q(String(U))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+He,"warning",6e3);return}}}}const R=[];for(const $ of Ye){if($?.type==="package"&&Array.isArray($.packageItems)){for(const K of $.packageItems){const U=le(K?.barcode??K?.normalizedBarcode??"");if(U&&D(U,B,O,W)){const Q=K?.desc||K?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");R.push({label:q(String(Q)),barcode:U})}}continue}const T=le($.barcode);if(D(T,B,O,W)){const K=$?.desc||$?.name||$?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");R.push({label:q(String(K)),barcode:T})}}if(R.length){const $=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let T=null;try{const U=Array.from(new Set(R.map(Z=>Z.barcode).filter(Boolean))),Q=new Map;await Promise.all(U.map(async Z=>{const re=new URLSearchParams;re.set("type","equipment"),re.set("id",Z),re.set("start",B),re.set("end",O),W!=null&&re.set("ignore",String(W));const ce=await Ue(`/reservations/availability.php?${re.toString()}`),Pe=Array.isArray(ce?.conflicts)?ce.conflicts:[],He=Array.from(new Set(Pe.map(we=>we?.reservation_code||(we?.reservation_id!=null?`#${we.reservation_id}`:null)).filter(Boolean)));Q.set(Z,He)})),T=R.map(({label:Z,barcode:re})=>{const ce=Q.get(re)||[];return ce.length?`${Z} (${ce.join("ØŒ ")})`:Z}).join("ØŒ ")}catch{}const K=T||R.map(U=>U.label).filter(Boolean).map(String).join("ØŒ ");I(`${$}: ${K}`,"warning",6e3);return}const ie=typeof n=="function"?n:()=>!1;for(const $ of Ye){if($?.type!=="package")continue;const T=$.packageId??$.package_id??null;if(T&&ie(T,B,O,W)){const K=$.desc||$.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const U=new URLSearchParams;U.set("type","package"),U.set("id",String(T)),U.set("start",B),U.set("end",O),W!=null&&U.set("ignore",String(W));const Q=await Ue(`/reservations/availability.php?${U.toString()}`),Z=Array.isArray(Q?.conflicts)?Q.conflicts:[],re=Array.from(new Set(Z.map(Pe=>Pe?.reservation_code||(Pe?.reservation_id!=null?`#${Pe.reservation_id}`:null)).filter(Boolean))),ce=re.length?` (${re.join("ØŒ ")})`:"";I(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${q(String(K))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ce,"warning",6e3)}catch{I(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${q(String(K))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const ve=typeof a=="function"?a:()=>!1,Se=[];for(const $ of C){if(!$?.technicianId||!ve($.technicianId,B,O,W))continue;const T=$?.technicianName||$?.positionLabel||String($.technicianId);let K=[];try{K=Ss($.technicianId,B,O,W)}catch{}Se.push({label:q(String(T)),codes:K})}if(Se.length){const $=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),T=Se.map(({label:K,codes:U})=>U&&U.length?`${K} (${U.join("ØŒ ")})`:K).join("ØŒ ");I(`${$}: ${T}`,"warning",6e3);return}const je=Array.isArray(Oe.projects)&&Oe.projects.length?Oe.projects:xe().projects||[],me=M&&je.find($=>String($.id)===String(M))||null,Ve={...G,projectId:M?String(M):null,confirmed:h},{effectiveConfirmed:ze,projectLinked:qe,projectStatus:Le}=Bt(Ve,me);let Be=!!F?.checked,H=!!J?.checked;if(qe&&(Be&&(F.checked=!1,Be=!1),H=!1),!qe&&Be!==H){I(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}H&&(Ze("edit-res-company-share"),Be=!!F?.checked);let ae=Be?getCompanySharePercent("edit-res-company-share"):null;Be&&(!Number.isFinite(ae)||ae<=0)&&(Ze("edit-res-company-share"),ae=getCompanySharePercent("edit-res-company-share"));const ye=Be&&H&&Number.isFinite(ae)&&ae>0,oe=qe?!1:H;qe&&(p=0,g="percent");const Ie=oa(Ye,p,g,oe,C,{start:B,end:O,companySharePercent:ye?ae:0});let pe=Cn();if(Number.isFinite(k)&&k>0){const $=Ie;let T=null,K=null;A==="amount"?(T=k,$>0&&(K=k/$*100)):(K=k,$>0&&(T=k/100*$));const U=Mr({type:A,value:k,amount:T,percentage:K,recordedAt:new Date().toISOString()});U&&(pe=[...pe,U],ja(pe)),z&&(z.value="")}const _e=Qt({totalAmount:Ie,history:pe}),Ce=Gt({manualStatus:j,paidAmount:_e.paidAmount,paidPercent:_e.paidPercent,totalAmount:Ie});x&&!b&&(x.value=Ce,x.dataset&&delete x.dataset.userSelected);let Me=G.status??"pending";qe?Me=me?.status??Le??Me:ne?Me="cancelled":["completed","cancelled"].includes(String(Me).toLowerCase())||(Me=h?"confirmed":"pending");const P=ms({reservationCode:G.reservationCode??G.reservationId??null,customerId:G.customerId,start:B,end:O,status:Me,title:G.title??null,location:G.location??null,notes:f,projectId:M?String(M):null,totalAmount:Ie,discount:p,discountType:g,applyTax:oe,paidStatus:Ce,confirmed:ze,items:Ye.map($=>({...$,equipmentId:$.equipmentId??$.id})),crewAssignments:C,companySharePercent:ye?ae:null,companyShareEnabled:ye,paidAmount:_e.paidAmount,paidPercentage:_e.paidPercent,paymentProgressType:_e.paymentProgressType,paymentProgressValue:_e.paymentProgressValue,paymentHistory:pe});try{os("about to submit",{editingIndex:xt,crewAssignments:C,techniciansPayload:P?.technicians,payload:P});const $=await ri(G.id||G.reservationId,P);os("server response",{reservation:$?.id??$?.reservationId??$?.reservation_code,technicians:$?.technicians,crewAssignments:$?.crewAssignments,techniciansDetails:$?.techniciansDetails}),await ys(),fa(),jt(),bi(),I(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),s?.(),Dr(),o?.({type:"updated",reservation:$}),r?.(),i?.(),ta?.hide?.()}catch($){console.error("âŒ [reservationsEdit] Failed to update reservation",$);const T=ps($)?$.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");I(T,"error")}}function Fc(e={}){Oe={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:s}=Oe,r=document.getElementById("edit-res-discount");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=q(r.value),t?.()}),r.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>t?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{aa("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{aa("share")}),d.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",t?.()}),u.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=q(l.value)}),l.dataset.listenerAttached="true"),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const y=document.getElementById("edit-res-project");y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>{Hr();const x=Array.isArray(Oe.projects)&&Oe.projects.length?Oe.projects:xe().projects||[],b=y.value&&x.find(k=>String(k.id)===String(y.value))||null,S={...Oe?.reservation??{},projectId:y.value||null,confirmed:rn()},{effectiveConfirmed:z,projectLinked:A}=Bt(S,b);Kt(z,{disable:A}),t?.()}),y.dataset.listenerAttached="true");const f=document.getElementById("edit-res-confirmed-btn");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{if(f.disabled)return;const x=!rn();Kt(x),t?.()}),f.dataset.listenerAttached="true");const m=document.getElementById("edit-res-cancelled");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&Kt(rn(),{disable:m.checked}),t?.()}),m.dataset.listenerAttached="true");const p=document.getElementById("save-reservation-changes");p&&!p.dataset.listenerAttached&&(p.addEventListener("click",()=>{zr(Oe).catch(x=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",x)})}),p.dataset.listenerAttached="true");const g=document.getElementById("edit-res-equipment-barcode");if(g&&!g.dataset.listenerAttached){let x=null;const b=()=>{g.value?.trim()&&(clearTimeout(x),x=null,n?.(g))};g.addEventListener("keydown",S=>{S.key==="Enter"&&(S.preventDefault(),b())});const j=()=>{if(clearTimeout(x),!g.value?.trim())return;const{start:S,end:z}=getEditReservationDateRange();!S||!z||(x=setTimeout(()=>{b()},150))};g.addEventListener("input",j),g.addEventListener("change",b),g.dataset.listenerAttached="true"}Br?.();const h=document.getElementById("editReservationModal");h&&!h.dataset.cleanupAttached&&(h.addEventListener("hidden.bs.modal",()=>{Dr(),t?.(),s?.([])}),h.dataset.cleanupAttached="true")}function el(){return Ii().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=xe()||{};oi(e||[]),Js()})}function Ca(e=null){Js(),Or(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function Rc(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function sa(){return{populateEquipmentDescriptionLists:pt,setFlatpickrValue:Ic,splitDateTime:ws,renderEditItems:yt,updateEditReservationSummary:Xe,addEquipmentByDescription:Ec,addEquipmentToEditingReservation:qc,addEquipmentToEditingByDescription:wn,combineDateTime:Wt,hasEquipmentConflict:ct,hasTechnicianConflict:vs,renderReservations:Or,handleReservationsMutation:Ca,ensureModal:Rc}}function Or(e="reservations-list",t=null){uc({containerId:e,filters:t,onShowDetails:Vr,onConfirmReservation:Kr})}function Vr(e){return mc(e,{getEditContext:sa,onEdit:(t,{reservation:n})=>{Qr(t,n)},onDelete:Ur})}function Ur(e){return Jr()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?qi(e,{onAfterChange:Ca}):!1:(Xr(),!1)}function Kr(e){return Ei(e,{onAfterChange:Ca})}function Qr(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",r)}cs(e,sa());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",r)}cs(e,sa());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const r=t.id??t.reservationId;n.set("reservationEditId",String(r));try{localStorage.setItem("pendingReservationEditId",String(r)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",r)}}Yr({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(r=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",r)});const a=n.toString(),s=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=s}function tl(){ki({showReservationDetails:Vr,deleteReservation:Ur,confirmReservation:Kr,openReservationEditor:Qr})}export{Zc as a,Or as b,Js as c,he as d,Yc as e,Vr as f,sa as g,Ca as h,Xc as i,Ur as j,Kr as k,el as l,Ic as m,Qr as o,tl as r,Fc as s,Xe as u};
