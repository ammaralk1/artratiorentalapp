import{d as D,n as B,b as $,A as ee,s as te,f as ne,t as l,h as u,o as ae,j as U}from"./auth.js";const ie=D()||{};let y=(ie.technicians||[]).map(J);function O(){return y}function T(e){return y=Array.isArray(e)?e.map(J):[],te({technicians:y}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),y}async function se(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,c])=>{c!=null&&c!==""&&t.set(s,String(c))});const n=t.toString(),a=await $(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(R):[];return T(i)}async function ce(e){const t=await $("/technicians/",{method:"POST",body:e}),n=R(t?.data??{});return T([...y,n]),n}async function q(e,t){const n=await $(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=R(n?.data??{}),i=y.map(s=>String(s.id)===String(e)?a:s);return T(i),a}async function oe(e){await $(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),T(y.filter(t=>String(t.id)!==String(e)))}function G({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,status:c,notes:d,active:r=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,status:c??"available",notes:d??null,active:r?1:0}}function R(e={}){return K({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,status:e.status,notes:e.notes,active:e.active})}function J(e={}){return K(e)}function K(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",c=e.department??e.team??"",d=le(e.daily_wage??e.dailyWage??e.wage??e.rate??0),r=H(e.baseStatus??e.status??"available"),o=H(e.status??e.baseStatus??"available"),m=e.notes??"",f=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:c,dailyWage:d,status:o,baseStatus:r,notes:m,active:f}}function le(e){const t=Number.parseFloat(B(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function H(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function z(e){return e instanceof ee}let p=null,x=!1,w=!1,S="",M=!1;async function Q({showToastOnError:e=!0}={}){if(!w){w=!0,S="",h();try{await se(),M=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),S=z(t)?t.message:l("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&u(S,"error")}finally{w=!1,h()}}}function X(){return O()}function L(e=""){return B(String(e)).trim().toLowerCase()}function j(e){return e==null?"":String(e)}function b(e=""){return B(String(e)).replace(/[^0-9+]/g,"")}function E(e=""){const t=B(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function N(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function W(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=l(n,a)}function P(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=l("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function _(){W(p?"update":"add"),P(!!p),h()}function de(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,c)=>s.localeCompare(c,"ar",{sensitivity:"base"})),i=l("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function F(){const e=document.getElementById("technician-form");e&&(e.reset(),p=null,W("add"),P(!1))}function re(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-wage"),c=document.getElementById("technician-notes");!t||!n||!a||!s||(t.value=e.name||"",n.value=b(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s.value=E(e.dailyWage!=null?e.dailyWage:""),c&&(c.value=e.notes||""),p=String(e.id),W("update"),P(!0))}function ue(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-wage"),s=document.getElementById("technician-notes");if(!e||!t||!n||!i)return null;const c=e.value.trim(),d=b(t.value.trim());t.value=d;const r=n.value.trim(),o=a?.value.trim()||"",m=E(i.value.trim());i.value=m;const f=m===""?0:parseFloat(m),I="available",g=s?.value.trim()||"";return c?d?r?Number.isNaN(f)||f<0?(u(l("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),i.focus(),null):{name:c,phone:d,role:r,department:o,dailyWage:Number.isFinite(f)?f:0,status:I,baseStatus:I,notes:g}:(u(l("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),n.focus(),null):(u(l("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(u(l("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function me(e){e.preventDefault();const t=ue();if(!t)return;const n=G({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,status:t.status,notes:t.notes,active:!0});try{p?(await q(p,n),u(l("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await ce(n),u(l("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),F(),h()}catch(a){console.error("âŒ [technicians] handleTechnicianSubmit failed",a);const i=z(a)?a.message:l("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");u(i,"error")}}function he(){F()}function fe(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=b(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=E(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=e.baseStatus||e.status||"available";t.status.value!==i&&(t.status.value=i),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),N(t.phone,b),N(t.wage,E)}function pe(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),c=document.getElementById("edit-technician-status"),d=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!c)return null;const r=e.value.trim(),o=t.value.trim(),m=b(n.value.trim());n.value=m;const f=a.value.trim(),I=i?.value.trim()||"",g=E(s.value.trim());s.value=g;const v=g===""?0:parseFloat(g),A=c.value||"available",C=d?.value.trim()||"";return r?o?m?f?Number.isNaN(v)||v<0?(u(l("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),s.focus(),null):{id:r,name:o,phone:m,role:f,department:I,dailyWage:Number.isFinite(v)?v:0,status:A,baseStatus:A,notes:C}:(u(l("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),a.focus(),null):(u(l("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(u(l("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(u(l("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function ge(){const e=pe();if(!e)return;const t=G({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,status:e.status,notes:e.notes,active:!0});try{await q(e.id,t),u(l("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),h()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const a=z(n)?n.message:l("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");u(a,"error")}}function h(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=L(t?.value||"");if(w&&!M){const o=l("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${o}</td></tr>`;return}if(S&&!M){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${S}</td></tr>`;return}const a=be(),{reservations:i=[]}=D(),s=new Date;de(a);const c=document.getElementById("technician-role-filter"),d=L(c?.value||""),r=a.filter(o=>d&&L(o.role||"")!==d?!1:n?L([o.name,o.phone,o.role,o.department,o.notes].filter(Boolean).join(" ")).includes(n):!0);if(r.length===0){const o=l("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${o}</td></tr>`;return}e.innerHTML=r.map(o=>{const m=p&&String(p)===String(o.id),g=(Y(o.id,i,s)?"busy":o.status||o.baseStatus||"available")==="busy"?{label:l("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:l("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},v=l("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),A=l("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),C=U(),k=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${o.id}">${v}</button>`];return C&&k.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${o.id}">${A}</button>`),`
      <tr${m?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${o.id}" class="text-decoration-none">${o.name}</a></td>
        <td>${o.role||""}</td>
        <td>${o.department||"â€”"}</td>
        <td><span class="${g.className}"><span class="technician-status-badge__text">${g.label}</span></span></td>
        <td class="table-notes-cell">${o.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${k.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function ye(e){const t=X().find(n=>String(n.id)===String(e));if(!t){u(l("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}re(t),u(l("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function ve(e){if(!U()){ae();return}if(confirm(l("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await oe(e),u(l("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),p&&String(p)===String(e)&&F(),h()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=z(t)?t.message:l("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");u(n,"error")}}function Se(){V(),h()}function Be(e){return X().find(t=>String(t.id)===String(e))||null}function Y(e,t=[],n){const a=j(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(r=>j(r)===a))return!1;const c=new Date(i.start),d=new Date(i.end);return Number.isNaN(c.getTime())||Number.isNaN(d.getTime())?!1:c<=n&&n<d}):!1}function be(){const e=D().reservations||[],t=O();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const c=s.baseStatus||s.status||"available";let d=c==="busy"?"busy":c;return Y(s.id,e,n)&&(d="busy"),(d!==s.status||c!==s.baseStatus)&&(a=!0),{...s,baseStatus:c,status:d}});return a?(T(i),i):t}function V(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",d=>{me(d).catch(r=>{console.error("âŒ [technicians] submit handler failed",r)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",he),n.dataset.listenerAttached="true"),N(document.getElementById("technician-phone"),b),N(document.getElementById("technician-wage"),E);const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",d=>{const r=d.target;if(r instanceof HTMLElement){if(r.classList.contains("technician-edit-btn")){const o=r.dataset.id;ye(o)}if(r.classList.contains("technician-delete-btn")){const o=r.dataset.id;ve(o).catch(m=>{console.error("âŒ [technicians] delete handler failed",m)})}}}),a.dataset.listenerAttached="true");const i=document.getElementById("search-technician-input");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{i.value=B(i.value),h()}),i.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{h()}),s.dataset.listenerAttached="true");const c=document.getElementById("save-technician-changes");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",()=>{ge().catch(d=>{console.error("âŒ [technicians] modal save failed",d)})}),c.dataset.listenerAttached="true"),x||(document.addEventListener("technician:prefill",d=>{const r=d.detail;r&&fe(r)}),x=!0),t&&F()}window.addEventListener("DOMContentLoaded",()=>{V(),h(),_(),Q()});const Z=()=>{h()};window.addEventListener("technicians:updated",Z);document.addEventListener("technicians:updated",Z);document.addEventListener("technicians:refreshRequested",()=>{V(),h(),_(),Q({showToastOnError:!1})});document.addEventListener("language:changed",()=>{_()});document.addEventListener(ne.USER_UPDATED,()=>{h()});export{Se as a,Be as g,R as m,se as r,be as s};
