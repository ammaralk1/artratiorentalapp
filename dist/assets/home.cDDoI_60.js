const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./projectsService.Ze40Q0O8.js","./auth.CCQxMlul.js","./auth.YjxhaAY7.css"])))=>i.map(i=>d[i]);
import{a as W,c as J,i as O,m as Q,t as f,l as X,g as Y,b as Z,A as ee,n as H,d as te,u as P}from"./auth.CCQxMlul.js";import"./dashboard.Dz6rMBll.js";import{r as ae,_ as ne,d as se,s as re}from"./technicians.DG4ImpgD.js";import{i as ie}from"./dashboardShell.DF2kUed9.js";import{r as oe}from"./reservationsService.BZ_B5ddX.js";W();J();ie();O();Q();let C="",k="",b=null,x=!1,D="";function A(){const e=document.querySelectorAll("[data-home-greeting]");if(!e.length)return;const t=f("home.hero.title","Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ"),a=C?f("home.hero.greetingUser","Ù…Ø±Ø­Ø¨Ø§Ù‹ {name}").replace("{name}",C):t;e.forEach(n=>{n.textContent=a})}function q(){const e=k==="admin";document.querySelectorAll("[data-admin-card]").forEach(t=>{e?t.classList.remove("hidden"):t.classList.add("hidden")})}function ce(e){if(!e||typeof e!="object")return null;const t=a=>{const n=Number.parseInt(String(a??"0"),10);return Number.isFinite(n)?n:0};return{customers:{total:t(e?.customers?.total)},reservations:{total:t(e?.reservations?.total),today:t(e?.reservations?.today),upcoming:t(e?.reservations?.upcoming)},equipment:{total:t(e?.equipment?.total),maintenance:t(e?.equipment?.maintenance)},technicians:{total:t(e?.technicians?.total),busy:t(e?.technicians?.busy)},projects:{total:t(e?.projects?.total),active:t(e?.projects?.active)},maintenance:{open:t(e?.maintenance?.open),highPriority:t(e?.maintenance?.highPriority)}}}function z(){return{customers:{total:0},reservations:{total:0,today:0,upcoming:0},equipment:{total:0,maintenance:0},technicians:{total:0,busy:0},projects:{total:0,active:0},maintenance:{open:0,highPriority:0}}}function ue(e){if(e==null)return null;if(typeof e=="object"){const a=[e.id,e.technicianId,e.technician_id,e.technician?.id,e.value];for(const n of a)if(n!=null&&String(n).trim()!=="")return String(n).trim();return null}const t=String(e).trim();return t===""?null:t}function F(e){const t=te(),a=e?{...e}:z(),n=Array.isArray(t.customers)?t.customers:[],d=Array.isArray(t.reservations)?t.reservations:[],p=Array.isArray(t.equipment)?t.equipment:[],S=Array.isArray(t.maintenance)?t.maintenance:[],g=Array.isArray(t.projects)?t.projects:[];if(n.length&&(a.customers={...a.customers,total:n.length}),p.length){const h=p.filter(r=>{const c=String(r?.status||r?.state||"").toLowerCase();return c.includes("maintenance")||c.includes("repair")}).length;a.equipment={...a.equipment,total:p.length,maintenance:h}}if(g.length){const h=g.filter(r=>{const c=se(r),u=String(r?.status||"").toLowerCase(),v=r?.cancelled===!0||String(r?.cancelled).toLowerCase()==="true"||u==="cancelled"||u==="canceled"||c==="cancelled",m=u==="completed"||u==="closed"||c==="completed";return!(!(r?.confirmed===!0||r?.confirmed==="true")||v||m)}).length;a.projects={...a.projects,total:Math.max(a.projects?.total??0,g.length),active:h}}if(S.length){const h=S.filter(c=>{const u=String(c?.status||c?.state||"").toLowerCase();return!u||["open","pending","in-progress","progress","scheduled"].includes(u)}).length,r=S.filter(c=>{const u=String(c?.priority||c?.severity||"").toLowerCase();return["high","urgent","critical"].includes(u)}).length;a.maintenance={...a.maintenance,open:Math.max(a.maintenance?.open??0,h),highPriority:Math.max(a.maintenance?.highPriority??0,r)}}if(d.length){const h=new Date,r=new Date(h);r.setHours(0,0,0,0);const c=new Date(r);c.setDate(c.getDate()+1);const u=s=>{const i=String(s?.status||s?.reservationStatus||"").toLowerCase();return["cancelled","canceled"].includes(i)},v=(s,i)=>{const o=String(s||"").trim(),l=String(i||"").trim();return!o&&!l?null:o&&l?`${o}T${l}`:o?`${o}T00:00:00`:null},m=s=>{if(!s)return null;if(s instanceof Date)return Number.isNaN(s.getTime())?null:s;let i=String(s).trim();if(!i)return null;/^\d{4}-\d{2}-\d{2}$/.test(i)?i=`${i}T00:00:00`:i.includes(" ")&&(i=i.replace(" ","T"));const o=new Date(i);return Number.isNaN(o.getTime())?null:o},j=s=>{const i=[s?.start,s?.startDatetime,s?.start_datetime,s?.start_date,s?.startDate,v(s?.startDate,s?.startTime),v(s?.start_date,s?.start_time)];for(const o of i){const l=m(o);if(l)return l}return null},V=s=>{const i=[s?.end,s?.endDatetime,s?.end_datetime,s?.end_date,s?.endDate,v(s?.endDate,s?.endTime),v(s?.end_date,s?.end_time)];for(const o of i){const l=m(o);if(l)return l}return null},U=d.filter(s=>{if(u(s))return!1;const i=j(s);return i?i>=r&&i<c:!1}).length,K=d.filter(s=>{if(u(s))return!1;const i=String(s?.status||s?.reservationStatus||"").toLowerCase();if(i==="completed"||i==="closed"||!(s?.confirmed===!0||s?.confirmed==="true"))return!1;const l=j(s);return l?l>=r:!1}).length,M=new Set;d.forEach(s=>{if(u(s))return;const i=j(s);let o=V(s);if(!i||((!o||o<=i)&&(o=new Date(i.getTime()+14400*1e3)),!i||!o)||i>h||o<=h)return;(Array.isArray(s.technicians)?s.technicians:[]).forEach(G=>{const $=ue(G);$&&M.add($)})}),a.reservations={...a.reservations,total:Math.max(a.reservations?.total??0,d.length),today:U,upcoming:K},a.technicians={...a.technicians,busy:Math.max(a.technicians?.busy??0,M.size)}}const T=re(),B=Array.isArray(t.technicians)?t.technicians:[],_=Array.isArray(T)&&T.length>0?T:B;if(_.length){const h=_.filter(r=>{if(!r)return!1;if(r.isBusy===!0||r.busy===!0)return!0;const u=[r?.status,r?.baseStatus,r?.currentStatus,r?.availability,r?.state,r?.status_label,r?.statusLabel,r?.statusText,r?.status_text].map(m=>String(m??"").trim().toLowerCase()).filter(m=>m.length>0).map(m=>m.replace(/[\u2700-\u27bf\u1f300-\u1f64f\u1f680-\u1f6ff\u2600-\u26ff]/g,"").replace(/[^\p{L}\p{N}\s_-]+/gu," ").replace(/\s+/g," ").trim());if(!u.length)return!1;const v=["busy","Ù…Ø´ØºÙˆÙ„","ØºÙŠØ± Ù…ØªØ§Ø­","Ù…Ø´ØºÙˆÙ„Ø©","occupied","in use","in-use","working","assigned","Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„","assigned crew"];return u.some(m=>v.some(j=>m.includes(j)))}).length;a.technicians={...a.technicians,total:Math.max(a.technicians?.total??0,_.length),busy:Math.max(a.technicians?.busy??0,h)}}return a}function de(e){return[{key:"customers.total",label:f("home.summary.customers","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"),value:e.customers.total,icon:"ğŸ‘¥",accent:"primary",href:"dashboard.html#customers-tab",dashboardTab:"customers-tab"},{key:"reservations.today",label:f("home.summary.reservationsToday","Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…"),value:e.reservations.today,icon:"ğŸ›ï¸",accent:"success",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"},{key:"reservations.upcoming",label:f("home.summary.reservationsUpcoming","Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©"),value:e.reservations.upcoming,icon:"ğŸ””",accent:"info",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"calendar-tab"},{key:"projects.active",label:f("home.summary.projectsActive","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©"),value:e.projects.active,icon:"ğŸ—ï¸",accent:"warning",href:"projects.html#projects-section",projectsTab:"projects-section",projectsSubTab:"projects-list-tab"},{key:"equipment.maintenance",label:f("home.summary.equipmentMaintenance","Ù…Ø¹Ø¯Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),value:e.equipment.maintenance,icon:"ğŸ› ï¸",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"maintenance.highPriority",label:f("home.summary.maintenanceHigh","Ø¨Ù„Ø§ØºØ§Øª ØµÙŠØ§Ù†Ø© Ø¹Ø§Ø¬Ù„Ø©"),value:e.maintenance.highPriority,icon:"âš¡",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"technicians.busy",label:f("home.summary.techniciansBusy","Ø£Ø¹Ø¶Ø§Ø¡ Ø·Ø§Ù‚Ù… Ù…Ø´ØºÙˆÙ„ÙˆÙ†"),value:e.technicians.busy,icon:"ğŸ‘·",accent:"secondary",href:"dashboard.html#technicians-tab",dashboardTab:"technicians-tab"}]}const N={primary:"bg-primary/10 text-primary",success:"bg-success/10 text-success",info:"bg-info/10 text-info",warning:"bg-warning/10 text-warning",error:"bg-error/10 text-error",secondary:"bg-secondary/10 text-secondary"},le={projects:["sidebar-stat-projects"],reservations:["sidebar-stat-reservations"],equipment:["sidebar-stat-equipment"],technicians:["sidebar-stat-technicians"]};function E(e){const t=e??z(),a={projects:t?.projects?.total??0,reservations:t?.reservations?.total??0,equipment:t?.equipment?.total??0,technicians:t?.technicians?.total??0};Object.entries(a).forEach(([n,d])=>{const p=le[n];if(!Array.isArray(p))return;const S=H(String(d??0));p.forEach(g=>{if(!g)return;const T=document.getElementById(g);T&&(T.textContent=S)})})}function me(e){if(typeof P!="function")return;const t=["dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"],a={};if(t.forEach(n=>{Object.prototype.hasOwnProperty.call(e,n)&&(a[n]=e[n]??null)}),Object.keys(a).length!==0)try{const n=P(a);n&&typeof n.catch=="function"&&n.catch(d=>{console.warn("âš ï¸ [home] Failed to persist navigation preference",d)})}catch(n){console.warn("âš ï¸ [home] Failed to persist navigation preference",n)}}function fe(e){e.querySelectorAll("[data-summary-card]").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{const a={};t.dataset.dashboardTab!==void 0&&(a.dashboardTab=t.dataset.dashboardTab||null),t.dataset.dashboardSubtab!==void 0&&(a.dashboardSubTab=t.dataset.dashboardSubtab||null),t.dataset.projectsTab!==void 0&&(a.projectsTab=t.dataset.projectsTab||null),t.dataset.projectsSubtab!==void 0&&(a.projectsSubTab=t.dataset.projectsSubtab||null),Object.keys(a).length>0&&me(a)}),t.dataset.listenerAttached="true")})}function he(e){const t=["glass-card","summary-card","flex","flex-col","items-center","gap-2","p-5","text-center","transition","duration-200","hover:-translate-y-1","focus-visible:outline","focus-visible:outline-2","focus-visible:outline-offset-2","focus-visible:outline-primary"],a=["data-summary-card"],n=g=>String(g??"").replace(/"/g,"&quot;");e.href&&a.push(`href="${n(e.href)}"`),e.dashboardTab!==void 0&&a.push(`data-dashboard-tab="${n(e.dashboardTab??"")}"`),e.dashboardSubTab!==void 0&&a.push(`data-dashboard-subtab="${n(e.dashboardSubTab??"")}"`),e.projectsTab!==void 0&&a.push(`data-projects-tab="${n(e.projectsTab??"")}"`),e.projectsSubTab!==void 0&&a.push(`data-projects-subtab="${n(e.projectsSubTab??"")}"`);const d=H(String(e.value??0)),p=n(e.label),S=N[e.accent]||N.primary;return`
    <a ${a.join(" ")} class="${t.join(" ")}" aria-label="${p}">
      <span class="summary-card__icon flex h-12 w-12 items-center justify-center rounded-2xl text-2xl ${S}">${e.icon}</span>
      <span class="summary-card__label text-sm font-medium text-base-content/70">${e.label}</span>
      <span class="summary-card__value text-3xl font-bold text-base-content">${d}</span>
    </a>
  `}function L(){const e=document.querySelector("[data-home-summary]");if(!e)return;if(x){e.innerHTML=`
      <div class="w-full text-center text-base-content/60" data-i18n data-i18n-key="home.summary.loading">
        ${f("home.summary.loading","â³ Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…...")}
      </div>
    `,E(b);return}if(D){e.innerHTML=`
      <div class="alert alert-warning" role="alert">
        ${D}
      </div>
    `,E(b);return}if(!b){e.innerHTML=`
      <div class="w-full text-center text-base-content/60">
        ${f("home.summary.empty","Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª.")} 
      </div>
    `,E(b);return}const t=de(b);e.innerHTML=t.map(he).join(""),fe(e),E(b)}async function I({silent:e=!1}={}){if(!x){x=!0,e||L();try{const t=await Z("/summary/");b=ce(t?.data??null),b=F(b),D=""}catch(t){console.error("âŒ [home] Failed to load summary data",t),b=F(null),D=t instanceof ee?t.message:f("home.summary.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹")}finally{x=!1,L()}}}function y(){I({silent:!0}).catch(e=>{console.error("âŒ [home] Summary refresh failed",e)})}const w=document.getElementById("home-refresh-summary");w&&!w.dataset.listenerAttached&&(w.addEventListener("click",()=>{y()}),w.dataset.listenerAttached="true");document.addEventListener("language:translationsReady",()=>{A(),L()});document.addEventListener("language:changed",()=>{A(),L()});function R(){O();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>X()),e.dataset.listenerAttached="true"),Promise.resolve(Y({refresh:!0})).then(n=>{C=n?.username||"",k=(n?.role||"").toLowerCase(),A(),q()}).catch(()=>{C="",k="",A(),q()}),A(),q(),L(),I(),document.addEventListener("customers:changed",y,{passive:!0}),document.addEventListener("reservations:changed",y,{passive:!0}),document.addEventListener("equipment:changed",y,{passive:!0}),document.addEventListener("maintenance:updated",y,{passive:!0}),document.addEventListener("technicians:updated",y,{passive:!0}),document.addEventListener("projects:changed",y,{passive:!0}),typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("technicians:updated",y,{passive:!0});const t=()=>{y()},a=(n,d)=>{!n||typeof n.then!="function"||n.then(()=>{t()}).catch(p=>{console.warn(`âš ï¸ [home] Failed to prefetch ${d} for summary`,p)})};try{a(ae(),"technicians")}catch(n){console.warn("âš ï¸ [home] Failed to kick off technicians prefetch",n)}try{a(oe(),"reservations")}catch(n){console.warn("âš ï¸ [home] Failed to kick off reservations prefetch",n)}try{ne(async()=>{const{refreshProjectsFromApi:n}=await import("./projectsService.Ze40Q0O8.js");return{refreshProjectsFromApi:n}},__vite__mapDeps([0,1,2]),import.meta.url).then(({refreshProjectsFromApi:n})=>{typeof n=="function"&&a(n(),"projects")}).catch(n=>{console.warn("âš ï¸ [home] Failed to kick off projects prefetch",n)})}catch(n){console.warn("âš ï¸ [home] Failed to kick off projects prefetch",n)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{R()},{once:!0}):R();
