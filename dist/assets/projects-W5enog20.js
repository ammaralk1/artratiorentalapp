import{l as we,n as b,d as Jt,t as r,k as Kt,r as Pe,q as Ce,p as Yt,u as wt,e as dt,x as Gt,j as y,o as Ie,h as Ae,a as Le,m as Be,c as qe,i as De}from"./auth-CXJ9BVF7.js";/* empty css              *//* empty css                */import"./common-DiVDZi68.js";import{b as _e}from"./controller-LpJaSmaZ.js";import"./projects-rKsBJ178.js";import"./customers-C_bDRz6Y.js";import{q as Qt,y as nt,g as O,z as lt,A as Ne,B as Xt,C as ke,D as mt,r as Me,t as Zt,k as te,l as Pt,E as Fe,e as Re}from"./projectsService-CtD7Jyhk.js";const d={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},s={};function Ue(){d.selectedTechnicians=[],d.selectedEquipment=[],d.expenses=[]}function He(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Oe(){s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.submitBtn=s.form?.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function Ve(){const t=He();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:iK",time_24hr:!1,defaultHour:9,defaultMinute:0}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:iK",time_24hr:!1,defaultHour:9,defaultMinute:0}]];[...e,...n].forEach(([a,o])=>{document.querySelector(a)&&t(a,o)})}function ee(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function ze(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>we()),t.dataset.listenerAttached="true")}const St="project",Tt="editProject",Dt=3600*1e3,ut=.15,yt=6,Ct="projectsTab",It="projectsSubTab",_t={create:"create-project-tab",list:"projects-list-tab"},ne={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},We={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function c(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function A(t){const e=Number(t)||0,n=Jt(),a=n==="ar"?"ar-SA":"en-US",o=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e)),i=n==="ar"?"ر.س":"SAR";return`${b(o)} ${i}`}function et(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),l=e.getHours(),u=l>=12?"PM":"AM",m=l%12||12,v=String(m).padStart(2,"0"),$=`${n}/${a}/${o} ${v}:${i} ${u}`;return b($)}function Je(t){const e=Jt(),n=b(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function Nt(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=Je(t))}function Ke(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?r(e,n):n}function K(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function kt(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=K(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function Mt(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),l=o.padStart(2,"0");return`${t}T${i}:${l}`}function Ye(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}…`}function Ft(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function ft(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function M(){if(!s.projectsTableBody)return;const t=d.filters.search,e=d.projects.filter(a=>{if(!t)return!0;const o=d.customers.find(l=>String(l.id)===String(a.clientId));return b([a.title,a.description,o?.customerName,a.clientCompany,ft(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=d.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",o=d.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",i=c(r(a,o));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,Nt(0),d.visibleProjects=[],Rt([]);return}const n=[...e].sort((a,o)=>new Date(o.start||0)-new Date(a.start||0));d.visibleProjects=n,Nt(n.length),s.projectsTableBody.innerHTML=n.map(a=>Ge(a)).join(""),Rt(n),V()}function Ge(t){const e=d.customers.find(C=>String(C.id)===String(t.clientId)),n=e?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),a=(t.clientCompany||e?.companyName||"").trim(),o=t.technicians?.length||0,i=(t.equipment||[]).reduce((C,w)=>C+(w.qty||0),0),{expensesTotal:l,totalWithTax:u}=it(t),v=bt(t.id).length,g=r("projects.table.reservationsCount","{count} حجوزات").replace("{count}",b(String(v))),p=v?`<span class="badge rounded-pill project-reservations-chip">${c(g)}</span>`:"",T=`<span class="badge project-type-badge">${c(ft(t.type))}</span>`,j=t.projectCode||`PRJ-${b(String(t.id))}`,f=`<span class="project-code-badge">#${c(j)}</span>`,B=Kt()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${c(r("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${c(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${f}
            ${T}
          </div>
        </div>
        ${p}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${c(n)}</span><small class="text-muted">${c(a)}</small></div>`:c(n)}
      </td>
      <td>${At(t.start,t.end)}</td>
      <td>${b(String(o))}</td>
      <td>${b(String(i))}</td>
      <td>${A(u)}</td>
      <td>${A(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${c(r("actions.view","عرض"))}</button>
        ${B}
      </td>
    </tr>
  `}function At(t,e){if(!t)return"—";const n=et(t);return e?`${n} - ${et(e)}`:n}function Rt(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:d.visibleProjects.length?d.visibleProjects:d.projects).map(g=>{if(!g?.start)return null;const p=new Date(g.start);if(Number.isNaN(p.getTime()))return null;let h=g.end?new Date(g.end):new Date(p);return Number.isNaN(h.getTime())&&(h=new Date(p)),h<=p&&(h=new Date(p.getTime()+Dt)),{project:g,startDate:p,endDate:h}}).filter(Boolean).sort((g,p)=>g.startDate-p.startDate);if(!n.length){const g=c(r("projects.timeline.empty",s.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${g}</div>`;return}const a=n[0].startDate.getTime(),o=Math.max(...n.map(g=>g.endDate.getTime()));let i=o-a;i<=0&&(i=Dt);const l=Qe(n),u=r("projects.timeline.range","{start} → {end}"),m=r("projects.timeline.conflict","Scheduling conflict"),v=n.map(g=>{const{project:p,startDate:h,endDate:T}=g,j=T.getTime()-h.getTime();let f=(h.getTime()-a)/i*100;f=Math.max(0,Math.min(f,100));let E=j/i*100;E=Math.max(E,2.5),f+E>100&&(E=Math.max(1.5,100-f));const C=`project-timeline__item--${Lt(p)}`,w=l.has(p.id),D=(p.title||"").trim()||r("projects.fallback.untitled","Untitled project"),W=Ye(D,26),_=d.customers.find(J=>String(J.id)===String(p.clientId)),F=_?.customerName||r("projects.fallback.unknownClient","Unknown client"),I=(p.clientCompany||_?.companyName||"").trim(),L=ft(p.type),N=et(h.toISOString()),R=et(T.toISOString()),k=u.replace("{start}",N).replace("{end}",R),S=I?`${F} (${I})`:F,P=`${D} • ${L} • ${S} | ${k}`,st=w?`<span class="project-timeline__item-conflict" title="${c(m)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${C}${w?" project-timeline__item--conflict":""}" style="left:${f}%;width:${E}%;" title="${c(P)}">
          <span class="project-timeline__item-label">${c(W)}</span>
          ${st}
        </div>
      `}).join(""),$=`
    <div class="project-timeline__scale">
      <span>${c(et(new Date(a).toISOString()))}</span>
      <span>${c(et(new Date(o).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${$}
    <div class="project-timeline__track">
      ${v}
    </div>
  `}function Qe(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const o=t[n],i=t[a];o.startDate<i.endDate&&i.startDate<o.endDate&&(e.add(o.project.id),e.add(i.project.id))}return e}function V(){if(!s.focusCards)return;const t=Xe();if(!t.length){const e=c(r("projects.focus.empty",s.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));s.focusCards.innerHTML=`<div class="col-12"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function Xe(){if(!Array.isArray(d.projects)||!d.projects.length)return[];const t=d.projects.filter(Ut),e=d.projects.filter(i=>!Ut(i)&&tn(i)),n=[],a=new Set,o=(i,l)=>{!i||a.has(i.id)||n.length>=yt||(a.add(i.id),n.push(Ze(i,l)))};if(t.sort((i,l)=>K(i)-K(l)).forEach(i=>o(i,"today")),e.sort((i,l)=>K(i)-K(l)).forEach(i=>o(i,"thisWeek")),n.length<yt){const i=Date.now();[...d.projects].filter(u=>!a.has(u.id)).filter(u=>{const m=K(u);return Number.isFinite(m)&&m>=i}).sort((u,m)=>K(u)-K(m)).forEach(u=>o(u,"upcoming"))}return n.length<yt&&[...d.projects].filter(l=>!a.has(l.id)).sort((l,u)=>kt(u)-kt(l)).forEach(l=>o(l,"recent")),n}function Ze(t,e){const n=d.customers.find(H=>String(H.id)===String(t.clientId)),a=n?.customerName||r("projects.fallback.unknownClient","Unknown client"),o=(t.clientCompany||n?.companyName||"").trim();Array.isArray(t.technicians)&&t.technicians.length;const i=bt(t.id);i.length;const l=se(t),{subtotal:u,applyTax:m}=it(t),v=(t.description||"").trim(),$=ft(t.type),g=t.paymentStatus==="paid"?"paid":"unpaid",p=r(`projects.paymentStatus.${g}`,g==="paid"?"Paid":"Unpaid"),h=g==="paid"?"status-paid":"status-unpaid",T=g==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",j=t.confirmed===!0||t.confirmed==="true",f=c(String(t.id)),E=t.projectCode||`PRJ-${b(String(t.id))}`,B=b(E),C={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},w={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},D=C[e]||C.recent,W=r(D,w[e]||w.recent),_=Lt(t),F=r(`projects.status.${_}`,ne[_]),I=We[_]||"bg-secondary",L=(t.title||"").trim()||r("projects.fallback.untitled","Untitled project"),N=[T];j&&N.push("project-focus-card--confirmed");const R=r("projects.focus.actions.confirm","✔️ تأكيد المشروع"),k=r("projects.focus.confirmed","✅ مشروع مؤكد"),S=i.reduce((H,Q)=>{const rt=ae(Q),Te=(Q.items||[]).reduce((xe,Ee)=>xe+(Number(Ee?.qty)||1),0),$e=(Q.technicians||[]).length;return{total:H.total+rt,equipment:H.equipment+Te,crew:H.crew+$e}},{total:0,equipment:0,crew:0}),P=Number(S.total.toFixed(2)),st=S.equipment,J=S.crew,U=m?Number(((u+P)*ut).toFixed(2)):0,G=Number((u+P+U).toFixed(2)),tt=`<span class="project-code-badge project-focus-card__code">#${c(B)}</span>`,at=`<span class="badge project-focus-card__badge ${I}">${c(W)}</span>`,ot=`<span class="project-focus-card__status-chip ${I}">${c(F)}</span>`,x=`<span class="reservation-chip ${h} project-focus-card__payment-chip">${c(p)}</span>`,q=[{icon:"📦",label:r("projectCards.stats.equipmentCount","عدد المعدات"),value:b(String(st))},{icon:"😎",label:r("projectCards.stats.crewCount","عدد الطاقم"),value:b(String(J))},{icon:"💵",label:r("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:A(P)}],je=[{icon:"💳",label:r("projectCards.stats.paymentStatus","حالة الدفع"),value:p},{icon:"💸",label:r("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:A(l)},{icon:"🧮",label:r("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:A(G)}].map(({icon:H,label:Q,value:rt})=>`<div class="project-focus-card__row"><span>${H} ${c(Q)}</span><span>${c(rt)}</span></div>`).join(""),ye=q.map(({icon:H,label:Q,value:rt})=>`<div class="project-focus-card__row"><span>${H} ${c(Q)}</span><span>${c(rt)}</span></div>`).join(""),he=j?`<span class="project-focus-card__chip status-confirmed">${c(k)}</span>`:`<button class="btn btn-sm btn-success" data-action="confirm-project" data-id="${f}">${c(R)}</button>`,ve=r("projects.focus.actions.highlight","🔍 عرض في القائمة"),Se=r("projects.focus.actions.view","👁️ عرض التفاصيل");return`
    <div class="col-lg-6">
      <article class="project-focus-card ${N.join(" ")}" data-project-id="${f}">
        <header class="project-focus-card__header">
          <div>
            <h5 class="project-focus-card__title">${c(L)}</h5>
            <div class="project-focus-card__meta">
              ${tt}
              ${at}
              ${ot}
              ${x}
            </div>
          </div>
          <div class="project-focus-card__actions">
            ${he}
            <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${f}">${c(ve)}</button>
            <button class="btn btn-sm btn-primary" data-action="view" data-id="${f}">${c(Se)}</button>
          </div>
        </header>
        <section class="project-focus-card__section">
          <h6 class="project-focus-card__section-title">${c(r("projects.focus.summary.project","ملخص المشروع"))}</h6>
          <div class="project-focus-card__rows">
            <div class="project-focus-card__row"><span>👤 ${c(r("projects.details.client","العميل"))}</span><span>${c(a)}</span></div>
            ${o?`<div class="project-focus-card__row"><span>🏢 ${c(r("projects.details.company","شركة العميل"))}</span><span>${c(o)}</span></div>`:""}
            <div class="project-focus-card__row"><span>🏷️ ${c(r("projects.details.type","نوع المشروع"))}</span><span>${c($)}</span></div>
            <div class="project-focus-card__row"><span>📅 ${c(r("projects.focus.summary.range","الفترة الزمنية"))}</span><span>${At(t.start,t.end)}</span></div>
          </div>
        </section>
        <section class="project-focus-card__section">
          <h6 class="project-focus-card__section-title">${c(r("projects.focus.summary.payment","الجانب المالي"))}</h6>
          <div class="project-focus-card__rows">${je}</div>
        </section>
        <section class="project-focus-card__section">
          <h6 class="project-focus-card__section-title">${c(r("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</h6>
          <div class="project-focus-card__rows">${ye}</div>
        </section>
        ${v?`<footer class="project-focus-card__footer">${c(v)}</footer>`:""}
      </article>
    </div>
  `}function Ut(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function tn(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const o=a.getDay(),i=o===0?6:o-1;a.setDate(a.getDate()-i);const l=new Date(a);return l.setDate(l.getDate()+7),e>=a&&e<l}function Lt(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function se(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function it(t){const e=Number(t?.equipmentEstimate)||0,n=se(t),a=e+n,o=Number(a.toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true";let l=i?Number(t?.taxAmount):0;i?(!Number.isFinite(l)||l<0)&&(l=Number((o*ut).toFixed(2))):l=0;let u=i?Number(t?.totalWithTax):o;return i?(!Number.isFinite(u)||u<=0)&&(u=Number((o+l).toFixed(2))):u=o,{equipmentEstimate:e,expensesTotal:n,subtotal:o,applyTax:i,taxAmount:l,totalWithTax:u}}function z(){const t=d.projects.length,e=d.projects.filter(o=>{const i=o.start?new Date(o.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=d.projects.reduce((o,i)=>o+it(i).expensesTotal,0),a=d.projects.reduce((o,i)=>o+it(i).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=b(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=b(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=A(n)),s.projectsBudget&&(s.projectsBudget.textContent=A(a))}function bt(t){return t?d.reservations.filter(e=>String(e.projectId)===String(t)):[]}function ae(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(b(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Qt(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(b(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function en(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,o=t.status||t.state||"pending",i=r(`reservations.status.${o}`,o),l=`status-${o.toLowerCase()}`,u=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",m=u?r("reservations.details.paid","مدفوع"):r("reservations.details.unpaid","غير مدفوع"),v=u?"status-paid":"status-unpaid",$=t.completed===!0||t.completed==="true",g=r("reservations.details.completed","مكتمل"),p=$?`<span class="badge project-reservation-card__badge status-completed">${c(g)}</span>`:"",h=At(t.start,t.end),T=ae(t),j=A(T),f=r("projects.details.reservations.items","{count} عناصر").replace("{count}",b(String((t.items||[]).length))),E=r("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",b(String((t.technicians||[]).length))),B=r("projects.details.reservations.view","👁️ عرض الحجز");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${c(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="badge project-reservation-card__badge ${l}">${c(i)}</span>
          <span class="badge project-reservation-card__badge ${v}">${c(m)}</span>
          ${p}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${c(h)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${c(j)}</span>
          <span>📦 ${c(f)}</span>
          <span>😎 ${c(E)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${c(B)}</button>
      </div>
    </article>
  `}function nn(t){const e=bt(t.id).map(j=>({reservation:j,index:d.reservations.findIndex(f=>f===j)})).filter(({index:j})=>Number.isInteger(j)&&j>=0).sort((j,f)=>{const E=j.reservation.start?new Date(j.reservation.start).getTime():0;return(f.reservation.start?new Date(f.reservation.start).getTime():0)-E}),n=r("projects.details.reservations.title","الحجوزات المرتبطة"),a=r("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),o=r("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=r("projects.details.reservations.count","{count} حجوزات"),l=e.length?`<span class="badge project-reservations-count">${c(i.replace("{count}",b(String(e.length))))}</span>`:"",u=e.length>0,m=c(String(t.id)),v=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${m}"`];u&&v.push("disabled",'aria-disabled="true"');const $=`<button ${v.join(" ")}>${c(a)}</button>`,g=r("projects.details.actions.edit","✏️ تعديل المشروع"),p=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${m}">${c(g)}</button>`,h=`<div class="d-flex flex-wrap gap-2">${$}${p}</div>`,T=e.length?`<div class="project-reservations-list">${e.map(({reservation:j,index:f})=>en(j,f,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${c(o)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${c(n)}</h6>
          ${l}
        </div>
        ${h}
      </div>
      ${T}
    </section>
  `}let Ht=null;function sn(t){t&&oe()!==t&&wt({[Ct]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function oe(){return Yt()?.[Ct]||""}function re(t){t&&$t()!==t&&wt({[It]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function $t(){return Yt()?.[It]||""}function an(t){if(!t)return"";const e=t.trim();return e?Object.values(_t).includes(e)?e:_t[e]||"":""}function on(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=an(e);if(n)return n}}catch{}return""}function ie(t,e){!t||!s.tabPanes||!s.tabButtons||(s.tabButtons.forEach(n=>{n===e?n.classList.add("active"):n.classList.remove("active")}),s.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&sn(t))}function rn(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const o=n.dataset.tabTarget;o&&(ie(o,n),o==="projects-section"&&(d.filters.search="",s.search&&(s.search.value=""),M(),V(),z()))}),n.dataset.tabListenerAttached="true")});const t=oe(),e=t&&s.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function Bt(t,e){!t||!s.projectSubTabButtons||!s.projectSubTabPanes||(s.projectSubTabButtons.forEach(n=>{n===e?n.classList.add("active"):n.classList.remove("active")}),s.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function cn(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||(s.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(Bt(n,t),re(n))}),t.dataset.tabListenerAttached="true")}),dn())}function dn(){const e=on()||$t();if(!e)return;const n=s.projectSubTabButtons?.[0],a=s.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===e)||n,o=a?.dataset.projectSubtabTarget;o&&(e!==$t()&&re(o),Bt(o,a))}function ln(){return s.tabButtons?s.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Ot(t={}){if(t){if(s.tabButtons&&s.tabButtons.length){const n=s.tabButtons.find(o=>o.classList.contains("active"))?.dataset.tabTarget||"",a=t[Ct];if(a&&a!==n){const o=s.tabButtons.find(i=>i.dataset.tabTarget===a);o&&ie(a,o)}}if(s.projectSubTabButtons&&s.projectSubTabButtons.length&&ln()){const n=s.projectSubTabButtons.find(o=>o.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=t[It];if(a&&a!==n){const o=s.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===a);o&&Bt(a,o)}}}}function un(){Ht||(Ht=Pe(t=>{Ot(t)})),Ce().then(t=>{Ot(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function pn(){if(!Array.isArray(d.projects)||d.projects.length===0)return;let t=!1;const e=d.projects.map(n=>{if(n.projectCode)return n;const a=Gt();return t=!0,{...n,projectCode:a}});t&&(d.projects=e)}function mn(){const{customers:t,technicians:e,equipment:n}=dt();d.customers=Array.isArray(t)?t:[],d.technicians=Array.isArray(e)?e:[],d.equipment=Array.isArray(n)?n:[],d.reservations=O(),d.projects=lt(),pn()}function gt(){if(ce(),s.technicianSelect){const t=s.technicianSelect.value,e=c(r("projects.form.selectTechnician","اختر عضو الطاقم"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+d.technicians.map(n=>{const a=r("projects.fallback.technicianName","عضو {id}"),o=n.name||a.replace("{id}",b(String(n.id||"")));return`<option value="${n.id}">${c(o)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=c(r("projects.form.selectEquipment","اختر المعدة"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+d.equipment.map(n=>{const a=n.desc||n.description||n.name||r("projects.fallback.unknownEquipment","معدة");return`<option value="${c(n.barcode||"")}">${c(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function X(t){if(!s.clientCompany)return;const e=t?.companyName||t?.company||"";s.clientCompany.value=e}function ce(){if(!s.client)return;fn();const t=s.client.dataset?.customerId;if(t){const e=d.customers.find(n=>String(n.id)===String(t));e?X(e):(s.client.dataset.customerId="",X(null))}else X(null);document.activeElement===s.client&&xt()}function fn(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",xt(),X(null)}),s.client.addEventListener("focus",()=>{xt()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>ct(),150)}),s.client.dataset.autocompleteAttached="true")}function ct(){s.clientSuggestions&&(s.clientSuggestions.style.display="none",s.clientSuggestions.innerHTML="")}function xt(){if(!s.client||!s.clientSuggestions)return;const t=bn(),e=nt(s.client.value||""),n=e?t.filter(a=>{const o=nt(a.name).includes(e),i=nt(a.company||"").includes(e);return o||i}).slice(0,10):t.slice(0,10);if(!n.length){ct();return}s.clientSuggestions.innerHTML=n.map(a=>{const o=a.company?`<div class="suggestion-item__meta">${c(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${c(String(a.id))}" data-name="${c(a.name)}" data-company="${c(a.company||"")}">
          <div class="suggestion-item__primary">${c(a.name)}</div>
          ${o}
        </div>
      `}).join(""),s.clientSuggestions.style.display="block",s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",o=>{o.preventDefault();const{id:i,name:l}=o.currentTarget.dataset;s.client&&(s.client.value=l||"",s.client.dataset.customerId=i||"");const u=o.currentTarget.dataset.company||"";X({companyName:u}),ct()})})}function bn(){return Array.isArray(d.customers)?d.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function gn(t,e=""){if(!Array.isArray(d.customers)||d.customers.length===0)return null;if(e){const o=d.customers.find(i=>String(i.id)===String(e));if(o)return o}const n=nt(t||"");if(!n)return null;const a=d.customers.find(o=>nt(o.customerName||o.name||"")===n);return a||d.customers.find(o=>nt(o.customerName||o.name||"").includes(n))||null}async function jn(t){if(d.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(r("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await Ne(t),await Xt(),await ke(),d.projects=lt(),d.reservations=O(),M(),z(),V(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),y(r("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=mt(n)?n.message:r("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");y(a,"error")}}async function yn(t,e){if(!t)return!1;const a=O().filter(u=>String(u.projectId)===String(t));if(!a.length)return!1;const o=e==="paid",i=o?"paid":"unpaid";let l=!1;for(const u of a){const m=u.id??u.reservationId;if(!m)continue;const v=u.paid===!0||u.paid==="paid",$=u.paidStatus||u.paymentStatus||(v?"paid":"unpaid");v===o&&$===i||(await Zt(m,{paid_status:i,paid:o}),l=!0)}return l&&(d.reservations=O()),l}async function hn(t){if(!t)return!1;const e=O(),n=d.projects.find(i=>String(i.id)===String(t))||(dt().projects||[]).find?.(i=>String(i.id)===String(t))||null,a=e.filter(i=>String(i.projectId)===String(t));if(!a.length)return!1;let o=!1;for(const i of a){const l=i.id??i.reservationId;if(!l)continue;const u=Me({...i,projectId:t},n);if(u.effectiveConfirmed)continue;const m=n?.status??u.projectStatus??"confirmed";await Zt(l,{confirmed:!0,status:m}),o=!0}return o&&(d.reservations=O()),o}async function Et(t,e){if(!t)return!1;const n=await yn(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let ht=!1;function vn(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",_n),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),ct(),ee(),s.type&&(s.type.value=""),X(null),de()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{d.filters.search=b(s.search.value||"").trim().toLowerCase(),M()}),s.search.dataset.listenerAttached="true")}function de(){Ue(),d.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),Y(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),jt()}function Sn(){s.addTechnicianBtn&&s.addTechnicianBtn.dataset.listenerAttached!=="true"&&(s.addTechnicianBtn.addEventListener("click",Cn),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&s.addEquipmentBtn.dataset.listenerAttached!=="true"&&(s.addEquipmentBtn.addEventListener("click",In),s.addEquipmentBtn.dataset.listenerAttached="true")}function Tn(){vt(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;d.selectedTechnicians=d.selectedTechnicians.filter(n=>n!==e),le()}}),vt(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;d.selectedEquipment=d.selectedEquipment.filter(n=>n.barcode!==e),ue()}}),vt(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;d.expenses=d.expenses.filter(n=>String(n.id)!==String(e)),pe(),z()}})}function $n(){s.addExpenseBtn&&s.addExpenseBtn.dataset.listenerAttached!=="true"&&(s.addExpenseBtn.addEventListener("click",An),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&s.expenseAmount.dataset.normalizeAttached!=="true"&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=b(e.value||"");if(e.value=a,n!=null){const o=Math.min(a.length,n);e.setSelectionRange(o,o)}}),s.expenseAmount.dataset.normalizeAttached="true")}function vt(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function xn({onViewDetails:t}){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached==="true"||(s.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;t?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!Kt()){Ie();return}const a=n.dataset.id;jn(a)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function En(){const{customers:t}=dt();d.customers=Array.isArray(t)?t:[],Y(),M(),V()}function wn(){const{technicians:t}=dt();d.technicians=Array.isArray(t)?t:[],Y(),M(),V()}function Pn(t){const{reservations:e}=dt();d.reservations=Array.isArray(e)?e:[],M();const n=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),a=s.detailsBody?.dataset.projectId;n&&a&&d.projects.find(i=>String(i.id)===String(a))&&t?.(a)}function Cn(){const t=s.technicianSelect?.value;if(!t){y(r("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(d.selectedTechnicians.includes(t)){y(r("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}d.selectedTechnicians.push(t),Y(),y(r("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function In(){const t=s.equipmentSelect?.value;if(!t){y(r("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(s.equipmentQty?.value||"1",10)||1),n=d.selectedEquipment.find(a=>a.barcode===t);n?n.qty+=e:d.selectedEquipment.push({barcode:t,qty:e}),Y(),y(r("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function An(){const t=(s.expenseLabel?.value||"").trim(),e=b(s.expenseAmount?.value||"0"),n=Number(e);if(!t){y(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){y(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}d.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=b(String(e))),Y(),z()}function Y(){le(),ue(),pe(),jt()}function le(){s.technicianList&&qt(s.technicianList,d.selectedTechnicians,t=>{const n=d.technicians.find(a=>String(a.id)===String(t))?.name||r("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${c(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${c(String(t))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function ue(){s.equipmentList&&qt(s.equipmentList,d.selectedEquipment,t=>{const e=d.equipment.find(o=>String(o.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||r("projects.fallback.unknownEquipment","معدة"),a=b(String(t.qty||1));return`
      <span class="chip">
        ${c(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${c(String(t.barcode))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function pe(){s.expenseList&&qt(s.expenseList,d.expenses,t=>`
      <div class="expense-item">
        <span>${c(t.label)}</span>
        <span>${A(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${c(String(t.id))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function qt(t,e,n){if(t){if(!e||e.length===0){const a=c(Ke(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function jt(){if(!s.submitBtn)return;const t=!!d.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";s.submitBtn.textContent=r(e,n)}function Ln(){return d.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function Vt(t){return b(String(t||"")).trim().toLowerCase()}function Bn(){if(!Array.isArray(d.selectedEquipment)||d.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((d.equipment||[]).map(a=>[Vt(a?.barcode),a])),e=[],n=[];return d.selectedEquipment.forEach(a=>{const o=Vt(a?.barcode);if(!o){e.push(a?.barcode||"");return}const i=t.get(o);if(!i||i.id==null){e.push(a?.barcode||o);return}const l=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:i.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:n,missing:e}}function qn(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,a=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function Dn(){return d.selectedEquipment.reduce((t,e)=>{const n=d.equipment.find(o=>String(o.barcode||"")===String(e.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+a*(e.qty||1)},0)}async function _n(t){if(t.preventDefault(),ht)return;const e=s.title?.value.trim(),n=s.type?.value||"",a=s.client?.value?.trim()||"",o=s.client?.dataset?.customerId||"",i=s.startDate?.value?.trim()||"",l=s.startTime?.value?.trim()||"";if(!e||!n||!i){y(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const u=gn(a,o);if(!u){y(r("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),s.client?.focus();return}const m=String(u.id);s.client&&(s.client.dataset.customerId=m,s.client.value=u.customerName||u.name||s.client.value),X(u);const v=s.endDate?.value?.trim()||"",$=s.endTime?.value?.trim()||"",g=zt(i,l),p=v?zt(v,$):"",h=new Date(g),T=p?new Date(p):null;if(T&&h>T){y(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}s.expenseAmount&&(s.expenseAmount.value=b(s.expenseAmount.value||""));const j=Ln(),f=Dn(),E=s.taxCheckbox?.checked===!0,C=(s.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",w=f+j,D=E?Number((w*ut).toFixed(2)):0,W=Number((w+D).toFixed(2)),{items:_,missing:F}=Bn();if(F.length){y(r("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const I=!!d.editingProjectId,L=I?d.projects.find(S=>String(S.id)===String(d.editingProjectId)):null;if(I&&!L){y(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const N=u.companyName||u.company||"",R=s.description?.value.trim()||"",k=te({projectCode:L?.projectCode||(I?null:Gt()),title:e,type:n,clientId:m,clientCompany:N,description:R,start:g,end:p||null,applyTax:E,paymentStatus:C,equipmentEstimate:f,expenses:d.expenses.map(S=>({id:S.id,label:S.label,amount:S.amount})),taxAmount:D,totalWithTax:W,confirmed:L?.confirmed??!1,technicians:d.selectedTechnicians,equipment:_});ht=!0;try{let S=L?.projectId??L?.id??null;if(I){const P=await Pt(S??d.editingProjectId,k);S=P?.projectId??P?.id??S,await Et(S,C),y(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const P=await Fe(k);S=P?.projectId??P?.id??null,await Et(S,C),y(r("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}d.editingProjectId=null,s.form.reset(),de(),ee(),ct(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),d.projects=lt(),d.reservations=O(),M(),z(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(S){console.error("❌ [projects] handleSubmitProject failed",S);const P=mt(S)?S.message:r("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");y(P,"error")}finally{ht=!1}}function zt(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),l=o.padStart(2,"0");return`${t}T${i}:${l}`}function Z(t){const e=d.projects.find(x=>String(x.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view",s.detailsBody.dataset.projectId=String(e.id);const n=d.customers.find(x=>String(x.id)===String(e.clientId)),a=be(e.type),i=e.description?.trim()||r("projects.fallback.noDescription","لا يوجد وصف"),l=n?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),u=(e.clientCompany||n?.companyName||"").trim(),m=e.projectCode||`PRJ-${b(String(e.id))}`,v=b(m),$=bt(e.id),g=$.reduce((x,q)=>x+Vn(q),0),p=Number(g.toFixed(2)),h=$.length,{subtotal:T,applyTax:j,expensesTotal:f}=it(e),E=T,B=j?Number(((E+p)*ut).toFixed(2)):0,C=Number((E+p+B).toFixed(2)),w=Lt(e),D=r(`projects.status.${w}`,ne[w]||w),_={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[w]||"status-confirmed",F=j?r("projects.details.chips.vatOn","شامل الضريبة 15٪"):r("projects.details.chips.vatOff","غير شامل الضريبة"),I=j?"status-paid":"status-unpaid",L=r("projects.details.chips.reservations","{count} حجوزات").replace("{count}",b(String(h))),N=e.paymentStatus==="paid"?"paid":"unpaid",R=r(`projects.paymentStatus.${N}`,N==="paid"?"Paid":"Unpaid"),k=N==="paid"?"status-paid":"status-unpaid",S=r("projects.focus.confirmed","✅ مشروع مؤكد"),P=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${c(S)}</span>`:"",J=[{icon:"💳",label:r("projects.details.summary.paymentStatus","حالة الدفع"),value:R},{icon:"💼",label:r("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:A(E)},{icon:"🔗",label:r("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:A(p)},{icon:"🧮",label:r("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:A(B)},{icon:"💰",label:r("projects.details.summary.overallTotal","الإجمالي الكلي"),value:A(C)}].map(({icon:x,label:q,value:pt})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${x} ${c(q)}</span>
      <span class="summary-details-value">${c(pt)}</span>
    </div>
  `).join(""),U=[];U.push({icon:"🆔",label:r("projects.details.labels.code","رقم المشروع"),value:`#${v}`}),U.push({icon:"👤",label:r("projects.details.client","العميل"),value:l}),u&&U.push({icon:"🏢",label:r("projects.details.company","شركة العميل"),value:u}),U.push({icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:a}),U.push({icon:"📅",label:r("projects.details.range","الفترة الزمنية"),value:formatDateRange(e.start,e.end)});const G=U.map(({icon:x,label:q,value:pt})=>`
    <div class="project-info-row">
      <span>${x} ${c(q)}</span>
      <span>${c(pt)}</span>
    </div>
  `).join(""),tt=[`<span class="reservation-chip ${_}">${c(D)}</span>`,`<span class="reservation-chip ${I}">${c(F)}</span>`,`<span class="reservation-chip status-info">${c(L)}</span>`,`<span class="reservation-chip ${k}">${c(R)}</span>`,P].filter(Boolean).join(""),at=r("projects.details.expensesTotal","إجمالي المصاريف"),ot=r("projects.details.reservationsTotal","إجمالي الحجوزات");s.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${c(e.title)}</h4>
          <div class="project-details-chips">${tt}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${c(r("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${G}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${c(r("projects.details.summary.title","ملخص مالي"))}</h6>
            ${J}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${c(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${c(at)}</span>
          <strong>${A(f)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${c(ot)}</span>
          <strong>${A(p)}</strong>
        </div>
      </div>
    </section>
    ${nn(e)}
  `,Mn(e),s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function Nn({onOpenProject:t}){!s.focusCards||s.focusCards.dataset.listenerAttached==="true"||(s.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:o,id:i}=n.dataset;if(o==="confirm-project"){e.preventDefault(),e.stopPropagation(),Un(i);return}o==="view"?t?.(i):o==="highlight"&&kn(i);return}const a=e.target.closest(".project-focus-card");a?.dataset.projectId&&t?.(a.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function kn(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){y(r("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function Mn(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]'),n=s.detailsBody.querySelector('[data-action="edit-project"]'),a=s.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",o=>{o.preventDefault(),Rn(t)}),n&&t&&n.addEventListener("click",o=>{o.preventDefault(),me(t)}),a&&a.addEventListener("click",o=>{const i=o.target.closest('[data-action="view-reservation"]');if(!i)return;const l=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(l)||l<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(l):window.location.href="dashboard.html#reservations")})}function me(t){if(!t||!s.detailsBody)return;const e=d.projects.find(i=>String(i.id)===String(t.id));if(!e)return;const n=d.customers.find(i=>String(i.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const o={expenses:Array.isArray(e.expenses)?e.expenses.map((i,l)=>({id:i?.id||`expense-${e.id}-${l}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=Hn(e,o),Fn(e,o)}function Fn(t,e={expenses:[]}){const n=s.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",h=>{h.preventDefault(),Z(t.id)});const o=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),l=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),m=n.querySelector('[name="project-start-date"]'),v=n.querySelector('[name="project-start-time"]'),$=n.querySelector('[name="project-end-date"]'),g=n.querySelector('[name="project-end-time"]');function p(){u&&(u.innerHTML=fe(e.expenses))}p(),l&&l.addEventListener("click",h=>{h.preventDefault();const T=o?.value.trim()||"",j=b(i?.value||"0"),f=Number(j);if(!T){y(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),o?.focus();return}if(!Number.isFinite(f)||f<=0){y(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),i?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:T,amount:f}),o&&(o.value=""),i&&(i.value=""),p()}),u&&u.addEventListener("click",h=>{const T=h.target.closest('[data-action="remove-expense"]');if(!T)return;const{id:j}=T.dataset;e.expenses=e.expenses.filter(f=>String(f.id)!==String(j)),p()}),n.addEventListener("submit",async h=>{if(h.preventDefault(),n.dataset.submitting==="true")return;const T=n.querySelector('[name="project-title"]'),j=n.querySelector('[name="project-type"]'),f=n.querySelector('[name="project-description"]'),E=n.querySelector('[name="project-payment-status"]'),B=n.querySelector('[name="project-apply-tax"]'),C=T?.value.trim()||"",w=j?.value||"",D=m?.value.trim()||"",W=v?.value.trim()||"",_=f?.value.trim()||"",F=E?.value==="paid"?"paid":"unpaid",I=B?.checked===!0;if(!C||!w||!D){y(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),T?.focus();return}const L=$?.value.trim()||"",N=g?.value.trim()||"",R=Mt(D,W),k=L?Mt(L,N):"",S=new Date(R),P=k?new Date(k):null;if(P&&S>P){y(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),$?.focus();return}if(d.projects.findIndex(x=>String(x.id)===String(t.id))===-1){y(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const J=Number(t.equipmentEstimate)||0,U=e.expenses.reduce((x,q)=>x+(Number(q.amount)||0),0),G=J+U,tt=I?Number((G*ut).toFixed(2)):0,at=I?Number((G+tt).toFixed(2)):G,ot=te({projectCode:t.projectCode,title:C,type:w,clientId:t.clientId,clientCompany:t.clientCompany,description:_,start:R,end:k||null,applyTax:I,paymentStatus:F,equipmentEstimate:J,expenses:e.expenses,taxAmount:tt,totalWithTax:at,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:qn(t)});n.dataset.submitting="true";try{const x=await Pt(t.projectId??t.id,ot),q=x?.projectId??x?.id??t.id;await Et(q,F),d.projects=lt(),d.reservations=O(),y(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),M(),V(),z(),Z(t.id)}catch(x){console.error("❌ [projects] Failed to update project from details view",x);const q=mt(x)?x.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");y(q,"error")}finally{delete n.dataset.submitting}})}function Rn(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};wt({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(o=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",o)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(o){console.warn("⚠️ [projects] Unable to encode reservation context",o)}s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function Un(t){if(!t)return;const e=d.projects.find(n=>String(n.id)===String(t));if(!e){y(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(e.confirmed===!0||e.confirmed==="true"){y(r("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await Pt(e.projectId??e.id,{confirmed:!0});const n=await hn(t);d.projects=lt(),d.reservations=O(),M(),V(),z(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&s.detailsBody?.dataset.projectId===String(t)&&Z(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),y(r("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=mt(n)?n.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");y(a,"error")}}function Hn(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=Ft(t.start||""),{date:o,time:i}=Ft(t.end||""),l=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${c(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${On(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${c(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${c(a)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${c(o)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${c(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${c(r("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${c(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${c(r("projects.paymentStatus.unpaid","قيد الانتظار"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${c(r("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${l?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${c(r("projects.form.labels.applyTax","تطبيق الضريبة 15٪"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${c(r("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${c(r("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${c(r("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${c(r("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${fe(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${c(r("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${c(r("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function On(t){return["commercial","coverage","photography","social"].map(n=>{const a=be(n),o=n===t?"selected":"";return`<option value="${c(n)}" ${o}>${c(a)}</option>`}).join("")}function fe(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${c(r("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=c(r("actions.remove","إزالة"));return t.map(n=>{const a=c(n?.label||""),o=c(A(n?.amount||0)),i=c(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${o}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function be(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function Vn(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(b(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Qt(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(b(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function ge(t){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(t);if(a)return a}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const a=new URLSearchParams(e).get(t);if(a)return a}catch{}return null}function zn(){return ge(St)}function Wn(){return ge(Tt)}function Jn(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[St,Tt].forEach(m=>{t.has(m)&&(t.delete(m),n=!0)});let a=e,o=!1;if(e)try{const m=new URLSearchParams(e);let v=!1;[St,Tt].forEach($=>{m.has($)&&(m.delete($),v=!0)}),v&&(a=m.toString(),o=!0)}catch{}if(!n&&!o)return;const i=window.location.pathname,l=t.toString(),u=`${i}${l?`?${l}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",u)}catch{}}function Kn(){const t=zn(),e=Wn();t&&(d.pendingProjectDetailId=t),e&&(d.pendingProjectEditId=e,d.pendingProjectDetailId||(d.pendingProjectDetailId=e)),(t||e)&&Jn()}function Yn(){if(!d.pendingProjectDetailId)return;const t=d.pendingProjectDetailId,e=String(t),n=d.projects.find(o=>[o?.id,o?.projectId,o?.project_id].some(l=>l!=null&&String(l)===e));if(!n)return;d.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??e;if(Z(a),d.pendingProjectEditId!=null){const o=String(d.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(l=>l!=null&&String(l)===o)&&(d.pendingProjectEditId=null,setTimeout(()=>me(n),0))}}function Gn(){document.addEventListener("DOMContentLoaded",()=>{un(),Kn(),Oe(),jt(),Ve(),rn(),cn(),ze(),vn(),Sn(),Tn(),$n(),xn({onViewDetails:Z}),Nn({onOpenProject:Z}),ce(),Qn()}),document.addEventListener("language:changed",Wt),document.addEventListener("language:translationsReady",Wt),document.addEventListener("customers:changed",Xn),document.addEventListener("technicians:updated",Zn),document.addEventListener("reservations:changed",()=>Pn(Z)),document.addEventListener(Ae.USER_UPDATED,()=>{M()})}async function Qn(){try{await Re({suppressError:!0}),await Xt()}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||r("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");y(e,"error")}finally{mn(),gt(),Y(),M(),z(),V(),Yn()}}function Wt(){gt(),Y(),M(),z(),V(),jt()}function Xn(){En(),gt()}function Zn(){wn(),gt()}Le();Be();qe();_e();Gn();document.addEventListener("DOMContentLoaded",()=>{De()});
