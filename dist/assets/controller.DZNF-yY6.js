import{d as re,n as S,t as l,j as v,b as Me,z as Wa,y as Qt,v as Ja,w as Qa,u as Ya}from"./auth.BLFzWQsL.js";import{g as Oe,r as lt,f as un,a as Xa,b as Ye,i as Hn,c as Za}from"./details.jChFDB-I.js";import{k as mn,l as An,n as ke,s as Bn,o as nt,b as Yt,D as Xe,p as at,q as He,h as On,c as $t,e as Nt,t as Un,v as es,w as Gn,x as ts,y as ns,z as Kn,a as Et,d as as,A as Xt,B as Wn,C as Jn,E as Zt,F as zt,G as je,H as Te,g as Qn,I as ss,J as rs,K as is,u as os,r as cs,L as ds,j as ls}from"./reservationsService.Pw_P_bOW.js";import{o as pn,p as Yn,q as us,u as Ze,v as St,w as Ie,n as O,x as Xn,y as fn,l as De,z as Vt,A as xt,B as ms,C as Zn,D as ea,E as ta,s as bt,F as na,G as Pe,b as yn,H as ps,I as fs,J as ys,K as aa,L as gs,M as vs,k as sa,N as Pn}from"./state.BK2rhNHf.js";import{d as gn,E as ra,a as hs,c as bs,e as Is,r as Es,s as Ss}from"./uiBridge.DRZiKs3I.js";import{g as ks,a as ws,b as As}from"./reservationPdf.YehlIFtt.js";import{o as Bs}from"./view.fI-qe2m5.js";import{c as ia,r as oa,d as Ps,a as Ls}from"./reservationsActions.B8jzpHNC.js";import{ensureProjectsLoaded as _s}from"./projectsService.Do5PYtuQ.js";const Cs="__DEBUG_CREW__";function qs(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Cs);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Ln(e,n){if(qs())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const ca="projects:create:draft",da="projects.html#projects-section";let en=null,la=[],tn=new Map,nn=new Map,jt=new Map,Wt=!1,Lt=null,_n=!1,ua=[];const ze="reservations:create:draft";let ot=!1;function Ht(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function vn(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function $s(){if(typeof document>"u"||!Ht())return null;try{const{input:n,hidden:t}=dt(),{input:a,hidden:r}=Fe(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",o=document.getElementById("res-start-time")?.value||"",d=document.getElementById("res-end-time")?.value||"",c=document.getElementById("res-notes")?.value||"",u=document.getElementById("res-discount")?.value||"",f=document.getElementById("res-discount-type")?.value||"percent",y=!!document.getElementById("res-tax")?.checked,p=!!document.getElementById("res-company-share")?.checked,g=p?tt("res-company-share"):null,b=document.getElementById("res-payment-status")?.value||"unpaid",B=document.getElementById("res-payment-progress-type")?.value||"percent",E=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:o,endTime:d,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:c,discount:String(u||""),discountType:f,taxEnabled:y,companyShareEnabled:p,companySharePercent:g,paymentStatus:b,paymentProgressType:B,paymentProgressValue:String(E||""),items:Ie()||[],technicianIds:ns()||[],crewAssignments:mn()||[]}}catch{return null}}function Ve(){if(ot)return;const e=Ht(),n=vn();if(!e&&!n)return;const t=$s();if(t){try{const r=(()=>{const i=e?e.getItem(ze):null,o=!i&&n?n.getItem(ze):null,d=i||o;return d?JSON.parse(d):null})(),s=i=>{if(!i)return!1;const o=Array.isArray(i.items)&&i.items.length>0,d=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,c=!!(i.startDate||i.endDate||i.startTime||i.endTime),u=!!(i.customerId||i.customerLabel);return o||d||c||u};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(ze,a),n&&n!==e&&n.setItem(ze,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function ma(){const e=Ht(),n=vn();if(!(!e&&!n))try{e&&e.removeItem(ze),n&&n!==e&&n.removeItem(ze)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function Ns(){const e=Ht(),n=vn();if(!e&&!n)return;ot=!0;let t=null;try{const a=e?e.getItem(ze):null,r=!a&&n?n.getItem(ze):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),ot=!1;return}if(t)try{if(t.startDate||t.startTime){const i=Ze(t.startDate||"",t.startTime||"");Ge("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=Ze(t.endDate||"",t.endTime||"");Ge("res-end","res-end-time",i)}if(t.customerId){Ae({selectedValue:String(t.customerId)});const{input:i,hidden:o}=dt();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){Ae({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=dt();i&&(i.value=t.customerLabel),o&&(o.value="");try{const d=Dt(t.customerLabel,{allowPartial:!0});d&&(o.value=String(d.id),i.value=d.label,i.dataset.selectedId=String(d.id))}catch{}}if(t.projectId)Ue({selectedValue:String(t.projectId)});else if(t.projectLabel){Ue({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=Fe();i&&(i.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",be(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(St(t.items),me()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{Bn(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{Bn(t.technicianIds)}catch{}Re();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}K()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{ot=!1}}function xs(e){if(!e)return null;let n=ua.find(a=>a.id===e)||null;if(n)return n;const t=ps(e);return t?(n={id:e,name:ys(t)||e,price:fs(t),items:yn(t),raw:t},n):null}function Tt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Rt(e){return S(String(e||"")).trim().toLowerCase()}function js(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=S(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function pa(e){const n=S(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function fa(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function ya(e){if(!e)return null;const n=S(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function ga(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=S(String(n))}}function et(e){switch(e){case"maintenance":return l("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return l("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return l("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return l("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function dt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function Fe(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function Se(){const{input:e,hidden:n}=Fe();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function Qe(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function va(e,n,{allowPartial:t=!1}={}){const a=ke(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,o)=>{o.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function Dt(e,n={}){return va(tn,e,n)}function an(e,n={}){return va(nn,e,n)}function be(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function ha(e){la=Array.isArray(e)?[...e]:[]}function hn(){return la}function bn(e){return e&&hn().find(n=>String(n.id)===String(e))||null}function Cn(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||l("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function tt(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??Xe,a=S(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:Xe}function Be(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??Xe,a=S(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=Xe),n.dataset.companyShare=String(r),n.checked=!0}function sn(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Wt){K();return}Wt=!0;const a=()=>{Wt=!1,K()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Xe)),n.disabled){t.checked=!1,v(l("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),Be()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Be():t.checked&&(t.checked=!1));a()}function Ts(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function qn(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function $n(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function Ae({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=dt();if(!t||!a||!r)return;const s=pn()||[],i=l("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=l("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const d=new Set;tn=new Map;const c=s.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:$n(m)||o})).filter(m=>{if(!m.label)return!1;const p=ke(m.label);return!p||d.has(p)?!1:(d.add(p),tn.set(p,m),!0)}).sort((m,p)=>m.label.localeCompare(p.label,void 0,{sensitivity:"base"}));r.innerHTML=c.map(m=>`<option value="${Tt(m.label)}"></option>`).join("");const u=n?"":t.value,f=e?String(e):a.value?String(a.value):"",y=f?s.find(m=>String(m.id)===f):null;if(y){const m=$n(y)||o;a.value=String(y.id),t.value=m,t.dataset.selectedId=String(y.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":u}function Ue({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=Fe();if(!a||!r||!s)return;const i=Array.isArray(n)?n:hn()||[],o=l("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const d=[...i].filter(g=>g&&g.id!=null).sort((g,b)=>String(b.createdAt||b.start||"").localeCompare(String(g.createdAt||g.start||""))),c=t?"":a.value,u=l("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),f=new Set;nn=new Map;const y=d.map(g=>{const b=Cn(g)||u;return{id:String(g.id),label:b}}).filter(g=>{if(!g.label)return!1;const b=ke(g.label);return!b||f.has(b)?!1:(f.add(b),nn.set(b,g),!0)});s.innerHTML=y.map(g=>`<option value="${Tt(g.label)}"></option>`).join("");const m=e?String(e):r.value?String(r.value):"",p=m?d.find(g=>String(g.id)===m):null;if(p){const g=Cn(p)||u;r.value=String(p.id),a.value=g,a.dataset.selectedId=String(p.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":c}function Ge(e,n,t){const{date:a,time:r}=na(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const o=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,o)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,o)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function ba(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||Ue({selectedValue:a});const s=(pn()||[]).find(u=>String(u.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";Ae(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=qn(e,"start"),d=qn(e,"end");o&&Ge("res-start","res-start-time",o),d&&Ge("res-end","res-end-time",d);const c=document.getElementById("res-notes");c&&e.description&&(n||!c.value)&&(c.value=e.description),K(),Re()}function Ia({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:re(),r=Array.isArray(a)?a:[];ha(r);const s=n!=null?String(n):t.value?String(t.value):"";Ue({selectedValue:s,projectsList:r}),Re(),K()}function Re(){const{input:e,hidden:n}=Fe(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),c=l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),f=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(Qe(t,Se),a&&Qe(a,Se)),r&&Qe(r,Se),s&&Qe(s,Se),i&&Qe(i,Se),o&&Qe(o,Se),d&&Qe(d,Se),f)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=c),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=c),r&&(r.value="unpaid",be(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=c),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=c),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=c),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=c),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=c);else{if(t){const y=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",y&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}sn("tax"),K()}function In(){const{input:e,hidden:n}=Fe();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?an(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=bn(s.id);i?ba(i,{skipProjectSelectUpdate:!0}):(Re(),K())}else n.value="",e.dataset.selectedId="",Re(),K()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?an(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Ve()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function En(){const{input:e,hidden:n}=dt();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Dt(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),K()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Dt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Ve()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function Rs(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){gt({clearValue:!0});return}let t=null;try{const c=decodeURIComponent(n);t=JSON.parse(c)}catch(c){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",c)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),gt({clearValue:!1}),!t)return;t.fromProjectForm&&(Lt={draftStorageKey:t.draftStorageKey||ca,returnUrl:t.returnUrl||da});const s=document.getElementById("res-project");if(t.projectId){s&&(Ue({selectedValue:String(t.projectId)}),Re());const c=bn(t.projectId);c?ba(c,{forceNotes:!!t.forceNotes}):K(),gt()}else{s&&Ue({selectedValue:""});const c=t.projectTitle?t.projectTitle:l("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");er(l("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),c)}t.start&&Ge("res-start","res-start-time",t.start),t.end&&Ge("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(t.customerId){const u=(pn()||[]).find(f=>String(f.id)===String(t.customerId));u?.id!=null&&(Ae({selectedValue:String(u.id)}),o&&(o.value=String(u.id)),i&&(i.value=u.customerName||u.name||i.value))}else t.customerName&&i?(Ae({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",o&&(o.value="")):Ae({selectedValue:""});const d=document.getElementById("res-notes");d&&t.description&&!d.value&&(d.value=t.description),K()}function We(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Ze(e,t),end:Ze(n,a)}}function Ea(e){const n=Rt(e);if(n){const o=jt.get(n);if(o)return o}const{description:t,barcode:a}=pa(e);if(a){const o=un(a);if(o)return o}const r=ke(t||e);if(!r)return null;let s=Xn();if(!s?.length){const o=re();s=Array.isArray(o?.equipment)?o.equipment:[],s.length&&aa(s)}const i=s.find(o=>ke(o?.desc||o?.description||"")===r);return i||s.find(o=>ke(o?.desc||o?.description||"").includes(r))||null}function Sa(e,n="equipment-description-options"){const t=Rt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(d=>Rt(d.value)===t)||jt.has(t))return!0;const{description:r}=pa(e);if(!r)return!1;const s=ke(r);return s?(Xn()||[]).some(o=>ke(o?.desc||o?.description||"")===s):!1}const Ds={available:0,reserved:1,maintenance:2,retired:3};function Fs(e){return Ds[e]??5}function Nn(e){switch(e){case"available":return l("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return l("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return l("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return l("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return l("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Ms(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${Nn(t)}`;const a=l("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${Nn(t)})`}function Ke(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=gn(),a=re(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];aa(s);const i=new Map;s.forEach(c=>{const u=js(c),f=Rt(u);if(!f||!u)return;const y=Oe(c),m=Fs(y),p=i.get(f);if(!p){i.set(f,{normalized:f,value:u,bestItem:c,bestStatus:y,bestPriority:m,statuses:new Set([y])});return}p.statuses.add(y),m<p.bestPriority&&(p.bestItem=c,p.bestStatus=y,p.bestPriority=m,p.value=u)}),jt=new Map;const d=Array.from(i.values()).sort((c,u)=>c.value.localeCompare(u.value,"ar",{sensitivity:"base"})).map(c=>{jt.set(c.normalized,c.bestItem);const u=Ms(c),f=Tt(c.value);if(u===c.value)return`<option value="${f}"></option>`;const y=Tt(u);return`<option value="${f}" label="${y}"></option>`}).join("");e&&(e.innerHTML=d),n&&(n.innerHTML=d)}function ka(e,n,t={}){const{silent:a=!1}=t,r=O(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=We();if(!s||!i){const p=l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||v(p),{success:!1,message:p}}const o=Ie();if(Sn(o).has(r)){const p=l("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||v(p),{success:!1,message:p}}const c=fn(r,s,i);if(c.length){const p=c.map(b=>b.name).join(", "),g=l("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${p}`);return a||v(g),{success:!1,message:g}}if(De(r,s,i)){const p=l("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const g=new URLSearchParams({type:"equipment",id:r,start:s,end:i});Me(`/reservations/availability.php?${g.toString()}`).then(b=>{const B=Array.isArray(b?.conflicts)?b.conflicts:[],E=Array.from(new Set(B.map(A=>A?.reservation_code||(A?.reservation_id!=null?`#${A.reservation_id}`:null)).filter(Boolean))),x=E.length?`${p}: ${E.join("ØŒ ")}`:p;v(x)}).catch(()=>v(p))}catch{v(p)}return{success:!1,message:p}}const u=un(r);if(!u){const p=l("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||v(p),{success:!1,message:p}}const f=Oe(u);if(f==="maintenance"||f==="retired"){const p=et(f);return a||v(p),{success:!1,message:p}}const y=at(u);if(!y){const p=l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||v(p),{success:!1,message:p}}Vt({id:y,equipmentId:y,barcode:r,desc:u.desc,qty:1,price:u.price,cost:Ye(u),image:lt(u)}),n&&(n.value=""),me(),K();const m=l("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||v(m),{success:!0,message:m,barcode:r}}function rn(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=Ea(n);if(!t){v(l("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Xa(t.barcode),r=Oe(a||t);if(r==="maintenance"||r==="retired"){v(et(r));return}const s=O(t.barcode);if(!s){v(l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=at(t);if(!i){v(l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,cost:Ye(t),image:lt(t)},{start:d,end:c}=We();if(!d||!c){v(l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const u=Ie();if(Sn(u).has(s)){v(l("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const y=fn(s,d,c);if(y.length){const m=y.map(p=>p.name).join(", ");v(l("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(De(s,d,c)){const m=l("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const p=new URLSearchParams({type:"equipment",id:s,start:d,end:c});Me(`/reservations/availability.php?${p.toString()}`).then(g=>{const b=Array.isArray(g?.conflicts)?g.conflicts:[],B=Array.from(new Set(b.map(x=>x?.reservation_code||(x?.reservation_id!=null?`#${x.reservation_id}`:null)).filter(Boolean))),E=B.length?`${m}: ${B.join("ØŒ ")}`:m;v(E)}).catch(()=>v(m))}catch{v(m)}return}Vt(o),me(),K(),v(l("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function zs(){Ke();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),rn(e))});const n=()=>{Sa(e.value,"equipment-description-options")&&rn(e)};e.addEventListener("focus",()=>{if(Ke(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function xn(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function Sn(e=Ie()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=O(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=O(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function Vs(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=We();if(!n||!t){v(l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}hs({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):v(l("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(ra.change,n=>{xn(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),xn(e,Is()))}function Hs(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,o=null;const d=[],c=new Set;s.forEach(f=>{const y=O(f);y&&!c.has(y)&&(c.add(y),d.push(y))});const u=Math.min(r,d.length);for(let f=0;f<u;f+=1){const y=d[f],m=ka(y,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const y=l("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",S(String(i)));v(y)}else o&&v(o)}function wa(){Vs(),!(_n||typeof document>"u")&&(document.addEventListener(ra.requestAdd,Hs),_n=!0)}function kt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function on(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=kt();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=n==="package";s&&(s.disabled=o),i&&(i.disabled=o),r&&(r.disabled=n!=="package"||r.options.length===0),gs(n),n==="package"&&Ot()}function Ot(){const{packageSelect:e,packageHint:n}=kt();if(!e)return;const t=Yn();ua=t,us(t.map(o=>o.raw??o));const a=l("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${l("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,c=S(d.toFixed(2)),u=`${o.name} â€” ${c} ${a}`;return`<option value="${o.id}">${u}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=l("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=l("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),Pa()}function Os(e,n){const t=e?.name||l("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=l("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const o=s?.desc||S(String(s?.barcode??s?.normalizedBarcode??""))||l("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const d=i.map(c=>c.name).join(", ");return`â€¢ ${o} (${l("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${d})`}return`â€¢ ${o} (${l("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function Aa(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=Pe(e);if(!s)return{success:!1,reason:"invalid",message:l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=xs(s);if(!i)return{success:!1,reason:"not_found",message:l("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(m=>m?.type==="package"&&Pe(m.packageId)===s))return{success:!1,reason:"duplicate",message:l("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(Zn(s,t,a,r)){const m=i.name||s;return{success:!1,reason:"package_conflict",message:l("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:yn(i.raw??{}),d=Sn(n),c=[],u=new Set;if(o.forEach(m=>{const p=O(m?.normalizedBarcode??m?.barcode);if(p){if(u.has(p)){c.push({item:m,type:"internal"});return}u.add(p),d.has(p)&&c.push({item:m,type:"external"})}}),c.length){const m=c.map(({item:g})=>g?.desc||g?.description||g?.name||g?.barcode||g?.normalizedBarcode||l("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(g=>S(String(g))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:c.some(g=>g.type==="external")?l("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):l("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:c}}const f=[];return o.forEach(m=>{const p=O(m?.normalizedBarcode??m?.barcode);if(p&&De(p,t,a,r)){const g=fn(p,t,a,r);f.push({item:m,blockingPackages:g})}}),f.length?{success:!1,reason:"item_conflict",message:Os(i,f),conflicts:f}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,cost:Number.isFinite(Number(i.cost))?Number(i.cost):0,barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:O(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0,cost:0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function Ba(e,{silent:n=!1}={}){const t=Pe(e);if(!t)return n||v(l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=We(),s=Ie(),i=Aa(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const d={invalid:l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:l("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:l("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");v(i.message||d)}return i}return Vt(i.package),me(),K(),n||v(l("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function Pa(){const{packageSelect:e}=kt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;Ba(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Us(){const{packageAddButton:e,packageSelect:n}=kt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){v(l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Ba(t)}),e.dataset.listenerAttached="true")}function La(){const{modeRadios:e}=kt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&on(r.target.value)}),a.dataset.listenerAttached="true")}),Us(),Pa();const n=xt(),t=e.find(a=>a.value===n);t&&(t.checked=!0),on(n)}function me(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=Ie(),a=l("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=l("reservations.create.summary.currency","SR"),s=l("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=l("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=l("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),d=l("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;return}const c=nt(t);n.innerHTML=c.map(u=>{const f=u.items[0]||{},y=lt(f)||u.image,m=y?`<img src="${y}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',p=S(String(u.count)),g=Number.isFinite(Number(u.unitPrice))?Number(u.unitPrice):0,b=(()=>{try{const{start:G,end:T}=We(),C=Yt(G,T);return Number.isFinite(C)&&C>0?C:1}catch{return 1}})(),B=S(String(b)),E=g*u.count*b,x=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${u.key}"
          min="0"
          step="0.01"
          value="${S(String(g))}"
          aria-label="${l("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,A=`${S(E.toFixed(2))} ${r}`,h=Number.isFinite(Number(u.unitCost))?Number(u.unitCost):0;`${S(h.toFixed(2))}${r}`;const w=u.items.some(G=>G?.type==="package"),P=u.barcodes.map(G=>S(String(G||""))).filter(Boolean),j=P.length?`<details class="reservation-item-barcodes">
            <summary>${l("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${P.map(G=>`<li>${G}</li>`).join("")}
            </ul>
          </details>`:"";let q="";if(w){const G=new Map;if(u.items.forEach(T=>{Array.isArray(T?.packageItems)&&T.packageItems.forEach(C=>{if(!C)return;const W=O(C.barcode||C.desc||Math.random()),U=G.get(W);if(U){U.qty+=Number.isFinite(Number(C.qty))?Number(C.qty):1;return}G.set(W,{desc:C.desc||C.barcode||l("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(C.qty))?Number(C.qty):1,barcode:C.barcode??C.normalizedBarcode??""})})}),G.size){const T=Array.from(G.values()).map(C=>{const W=S(String(C.qty)),U=C.desc||S(String(C.barcode||"")),M=C.barcode?` <span class="reservation-package-items__barcode">(${S(String(C.barcode))})</span>`:"";return`<li>${U}${M} Ã— ${W}</li>`}).join("");q=`
            <details class="reservation-package-items">
              <summary>${l("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${T}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${w?`${q||""}${j||""}`:j}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${u.key}" aria-label="${o}" ${w?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${u.key}" aria-label="${i}" ${w?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${B}</span></td>
          <td>${x}</td>
          <td><input type="number" class="form-control form-control-sm reservation-unit-cost-input" data-group-key="${u.key}" min="0" step="0.01" value="${S(String(h))}" aria-label="${l("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"></td>
          <td>${A}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${u.key}" aria-label="${d}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Gs(e){const n=Ie(),a=nt(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(ms(r),me(),K())}function Ks(e){const n=Ie(),t=n.filter(a=>He(a)!==e);t.length!==n.length&&(St(t),me(),K())}function Ws(e,n){const t=_a(n),a=Number.isFinite(t)&&t>=0?Ca(t):0,r=Ie(),i=nt(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(d=>{o[d]&&(o[d]={...o[d],price:a,unit_price:a})}),St(o),me(),K()}function Js(e,n){const t=_a(n),a=Number.isFinite(t)&&t>=0?Ca(t):0,r=Ie(),i=nt(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(d=>{if(o[d]){const c={...o[d],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};o[d]=c}}),St(o),me(),K()}function _a(e){const n=S(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),t=Number.parseFloat(n);return Number.isFinite(t)?t:NaN}function Ca(e){const n=Number(e);return!Number.isFinite(n)||n<0?0:Number(n.toFixed(2))}function Qs(e){const n=Ie(),a=nt(n).find(f=>f.key===e);if(!a)return;const{start:r,end:s}=We();if(!r||!s){v(l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(f=>O(f.barcode))),{equipment:o=[]}=re(),d=(o||[]).find(f=>{const y=O(f?.barcode);return!y||i.has(y)||He({desc:f?.desc||f?.description||f?.name||"",price:Number(f?.price)||0})!==e||!Hn(f)?!1:!De(y,r,s)});if(!d){v(l("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const c=O(d.barcode),u=at(d);if(!u){v(l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}Vt({id:u,equipmentId:u,barcode:c,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,cost:Number.isFinite(Number(d.cost))?Number(d.cost):Number.isFinite(Number(d.unit_cost))?Number(d.unit_cost):Number(a.unitCost)||0,image:lt(d)}),me(),K()}function K(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(S(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:c,end:u}=We();i&&Be();const f=tt(),y=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),p=fa(y),g=ya(m);mn(),An({selectedItems:Ie(),discount:t,discountType:r,applyTax:i,paidStatus:d,paymentProgressType:p,paymentProgressValue:g,start:c,end:u,companySharePercent:f,paymentHistory:[]});const b=An.lastResult;b?(ga(m,b.paymentProgressValue),o&&(o.value=b.paymentStatus,be(o,b.paymentStatus))):be(o,d);try{Ve()}catch{}}function Ys(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=S(o.target.value),K()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",K),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if(Se()){t.checked=!1,v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}sn("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(Se()){a.checked=!1,v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}sn("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(Se()){r.value="unpaid",be(r,"unpaid"),v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}be(r),K()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",o=>{if(Se()){s.value="percent",v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",K()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(Se()){i.value="",v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=S(o.target.value),K()}),i.dataset.listenerAttached="true"),K()}function Xs(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const o=()=>{try{Ve()}catch{}},d=()=>{try{me(),K()}catch{}};s.addEventListener("input",o),s.addEventListener("change",o),s.addEventListener("input",d),s.addEventListener("change",d),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const o=()=>{try{Ve()}catch{}},d=()=>{try{me(),K()}catch{}};i.addEventListener("input",o),i.addEventListener("change",o),i.addEventListener("input",d),i.addEventListener("change",d),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){K();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),K();try{me()}catch{}};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{Ve()}catch{}try{me(),K()}catch{}}});const r=()=>{try{Ve()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function jn(){const{input:e,hidden:n}=dt(),{input:t,hidden:a}=Fe(),{customers:r}=re();let s=n?.value?String(n.value):"";if(!s&&e?.value){const L=Dt(e.value,{allowPartial:!0});L&&(s=String(L.id),n&&(n.value=s),e.value=L.label,e.dataset.selectedId=s)}const i=r.find(L=>String(L.id)===s);if(!i){v(l("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&t?.value){const L=an(t.value,{allowPartial:!0});L&&(d=String(L.id),a&&(a.value=d),t.value=L.label,t.dataset.selectedId=d)}const c=document.getElementById("res-start").value,u=document.getElementById("res-end").value,f=document.getElementById("res-start-time")?.value||"00:00",y=document.getElementById("res-end-time")?.value||"00:00";if(!c||!u){v(l("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const m=`${c}T${f}`,p=`${u}T${y}`,g=new Date(m),b=new Date(p);if(Number.isNaN(g.getTime())||Number.isNaN(b.getTime())||g>=b){v(l("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const B=mn();B.map(L=>L.technicianId).filter(Boolean);const E=Ie();if(E.length===0&&B.length===0){v(l("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const x=document.getElementById("res-notes")?.value||"",A=parseFloat(S(document.getElementById("res-discount")?.value))||0,h=document.getElementById("res-discount-type")?.value||"percent",w=document.getElementById("res-payment-status"),P=w?.value||"unpaid",j=document.getElementById("res-payment-progress-type"),q=document.getElementById("res-payment-progress-value"),G=fa(j),T=ya(q),C=d?bn(d):null,W=Ts(C);if(d&&!C){v(l("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const L of E){const V=Oe(L.barcode);if(V==="maintenance"||V==="retired"){v(et(V));return}}const U=[];for(const L of E){const V=O(L.barcode);if(De(V,m,p)){const ie=L?.desc||L?.name||L?.barcode||l("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");U.push({label:S(String(ie)),barcode:V})}}if(U.length){const L=l("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let V=null;try{const ne=Array.from(new Set(U.map(se=>se.barcode).filter(Boolean))),ge=new Map;await Promise.all(ne.map(async se=>{const ue=new URLSearchParams({type:"equipment",id:se,start:m,end:p}),le=await Me(`/reservations/availability.php?${ue.toString()}`),rt=Array.isArray(le?.conflicts)?le.conflicts:[],it=Array.from(new Set(rt.map($e=>$e?.reservation_code||($e?.reservation_id!=null?`#${$e.reservation_id}`:null)).filter(Boolean)));ge.set(se,it)})),V=U.map(({label:se,barcode:ue})=>{const le=ge.get(ue)||[];return le.length?`${se} (${le.join("ØŒ ")})`:se}).join("ØŒ ")}catch{}const ie=V||U.map(ne=>ne.label).filter(Boolean).map(String).join("ØŒ ");v(`${L}: ${ie}`,"warning",6e3);return}const M=[];for(const L of E){if(L?.type!=="package")continue;const V=L.packageId??L.package_id??null;if(V&&Zn(V,m,p)){const ie=L.desc||L.packageName||l("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let ne=[];try{const ge=new URLSearchParams({type:"package",id:String(V),start:m,end:p}),se=await Me(`/reservations/availability.php?${ge.toString()}`),ue=Array.isArray(se?.conflicts)?se.conflicts:[];ne=Array.from(new Set(ue.map(le=>le?.reservation_code||(le?.reservation_id!=null?`#${le.reservation_id}`:null)).filter(Boolean)))}catch{}M.push({label:S(String(ie)),codes:ne})}}if(M.length){const L=M.map(({label:ie,codes:ne})=>ne&&ne.length?`${ie} (${ne.join("ØŒ ")})`:ie).join("ØŒ "),V=l("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");v(`${V}: ${L}`,"warning",6e3);return}const $=[];for(const L of B){if(!L?.technicianId||!ea(L.technicianId,m,p))continue;const V=L?.technicianName||L?.positionLabel||String(L.technicianId);let ie=[];try{ie=ta(L.technicianId,m,p,null)}catch{}$.push({label:S(String(V)),codes:ie})}if($.length){const L=l("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),V=$.map(({label:ie,codes:ne})=>ne&&ne.length?`${ie} (${ne.join("ØŒ ")})`:ie).join("ØŒ ");v(`${L}: ${V}`);return}const ae=document.getElementById("res-tax"),z=document.getElementById("res-company-share"),D=!!d;D?(ae&&(ae.checked=!1,ae.disabled=!0,ae.classList.add("disabled"),ae.title=l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),z&&(z.checked=!1,z.disabled=!0,z.classList.add("disabled"),z.title=l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),w&&(w.value="unpaid",w.disabled=!0,be(w,"unpaid"),w.title=l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),j&&(j.disabled=!0,j.classList.add("disabled")),q&&(q.value="",q.disabled=!0,q.classList.add("disabled"))):(ae&&(ae.disabled=!1,ae.classList.remove("disabled"),ae.title=""),z&&(z.disabled=!1,z.classList.remove("disabled"),z.title=""),w&&(w.disabled=!1,w.title=""),j&&(j.disabled=!1,j.classList.remove("disabled")),q&&(q.disabled=!1,q.classList.remove("disabled")));const F=D?!1:ae?.checked||!1,te=!!z?.checked;if(!D&&te!==F){v(l("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let de=te?tt():null;te&&(!Number.isFinite(de)||de<=0)&&(Be(),de=tt());const N=te&&F&&Number.isFinite(de)&&de>0;F&&Be();const pe=On(E,A,h,F,B,{start:m,end:p,companySharePercent:N?de:0}),we=Wa(),ee=$t({totalAmount:pe,progressType:G,progressValue:T,history:[]});q&&ga(q,ee.paymentProgressValue);const Je=[];ee.paymentProgressValue!=null&&ee.paymentProgressValue>0&&Je.push({type:ee.paymentProgressType||G,value:ee.paymentProgressValue,amount:ee.paidAmount,percentage:ee.paidPercent,recordedAt:new Date().toISOString()});const qe=Nt({manualStatus:P,paidAmount:ee.paidAmount,paidPercent:ee.paidPercent,totalAmount:pe});w&&(w.value=qe,be(w,qe));const ye=typeof C?.paymentStatus=="string"?C.paymentStatus.toLowerCase():null,ut=ye&&["paid","partial","unpaid"].includes(ye)?ye:"unpaid",fe=Un({reservationCode:we,customerId:o,start:m,end:p,status:W?"confirmed":"pending",title:null,location:null,notes:x,projectId:d||null,totalAmount:pe,discount:D?0:A,discountType:D?"percent":h,applyTax:F,paidStatus:D?ut:qe,confirmed:W,items:E.map(L=>({...L,equipmentId:L.equipmentId??L.id})),crewAssignments:B,companySharePercent:D||!N?null:de,companyShareEnabled:D?!1:N,paidAmount:D?0:ee.paidAmount,paidPercentage:D?0:ee.paidPercent,paymentProgressType:D?null:ee.paymentProgressType,paymentProgressValue:D?null:ee.paymentProgressValue,paymentHistory:D?[]:Je});try{Ln("about to submit",{crewAssignments:B,techniciansPayload:fe?.technicians,payload:fe});const L=await es(fe);Ln("server response",{reservation:L?.id??L?.reservationId??L?.reservation_code,technicians:L?.technicians,crewAssignments:L?.crewAssignments,techniciansDetails:L?.techniciansDetails}),gn(),Ke(),bt(),qa(),v(l("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const V=document.getElementById("sub-tab-trigger-my-reservations-tab");V&&typeof V.click=="function"&&setTimeout(()=>V.click(),0)}catch{}typeof en=="function"&&en({type:"created",reservation:L}),Zs(L)}catch(L){console.error("âŒ [reservations/createForm] Failed to create reservation",L);const V=Gn(L)?L.message:l("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(V,"error"),D&&(v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),gt({clearValue:!1}))}}function Zs(e){if(!Lt)return;const{draftStorageKey:n=ca,returnUrl:t=da}=Lt,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}Lt=null,t&&(window.location.href=t)}function gt({clearValue:e=!1}={}){const{input:n,hidden:t}=Fe();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,Re())}function er(e,n=""){const{input:t,hidden:a}=Fe();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),Re())}function qa(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),Ae({selectedValue:"",resetInput:!0});try{Ge("res-start","res-start-time","")}catch{}try{Ge("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),gt({clearValue:!1}),Ue({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",be(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),ts(),St([]),bs("form-reset"),me(),Re(),K(),ma()}function tr(){const e=document.getElementById("reservation-items");if(!e||e.dataset.listenerAttached)return;e.addEventListener("click",t=>{const a=t.target.closest("button[data-action]");if(!a)return;const{action:r,groupKey:s}=a.dataset;if(r==="decrease-group"&&s){Gs(s);return}if(r==="increase-group"&&s){Qs(s);return}if(r==="remove-group"&&s){Ks(s);return}});const n=t=>{const a=t.target.closest(".reservation-unit-price-input");if(a){const s=a.dataset.groupKey;s&&Ws(s,a.value);return}const r=t.target.closest(".reservation-unit-cost-input");if(r){const s=r.dataset.groupKey;s&&Js(s,r.value)}};e.addEventListener("change",n),e.addEventListener("input",n),e.dataset.listenerAttached="true"}function nr(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(xt()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,ka(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||xt()!=="single")return;const{start:s,end:i}=We();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function ar(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await jn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await jn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),qa();try{ma()}catch{}v(l("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function Qr({onAfterSubmit:e}={}){en=typeof e=="function"?e:null,ot=!0;const{customers:n,projects:t}=re();vs(n||[]),Ae(),En(),ha(t||[]),Ia({projectsList:t}),In(),Ke(),Ot(),zs(),wa(),La(),Xs(),Ys(),tr(),nr(),ar(),Ns(),Rs(),K(),me();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Ve()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}ot=!1}function $a(){Ke(),Ot(),Ia(),Ae(),En(),In(),wa(),La(),me(),K()}if(typeof document<"u"){const e=()=>{Ae(),Ue({projectsList:hn()}),En(),In(),K()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Ke()}),document.addEventListener("packages:changed",()=>{Ot(),xt()==="package"&&on("package")})}typeof window<"u"&&(window.getCompanySharePercent=tt);function Pt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function sr(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function rr(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=sr(t);if(a!==null)return a}return null}function Tn(e,n=0){const t=rr(e);if(t!=null)return t;const a=Pt(e.createdAt??e.created_at);if(a!=null)return a;const r=Pt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=Pt(e.start);if(s!=null)return s;const i=Pt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(n)?n:0}function ir({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((E,x)=>({reservation:E,index:x})),i=n.searchTerm||"",o=n.searchReservationId||"",d=n.searchCustomerName||"",c=n.searchProjectId||"",u=n.startDate||"",f=n.endDate||"",y=n.status||"",m=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,p=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,g=u?new Date(`${u}T00:00:00`):null,b=f?new Date(`${f}T23:59:59`):null,B=s.filter(({reservation:E})=>{const x=t.get(String(E.customerId)),A=r?.get?.(String(E.projectId)),h=E.start?new Date(E.start):null,w=Kn(E),{effectiveConfirmed:P}=Et(E,A);if(m!=null&&String(E.customerId)!==String(m)||p!=null&&!(Array.isArray(E.technicians)?E.technicians.map(C=>String(C)):[]).includes(String(p))||y==="confirmed"&&!P||y==="pending"&&P||y==="completed"&&!w)return!1;if(y==="cancelled"){const T=String(E?.status||E?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(T))return!1}if(g&&h&&h<g||b&&h&&h>b)return!1;if(o){const T=[E.reservationId,E.id,E.reservation_id,E.reservationCode,E.reservation_code,E.code,E.reference,E.referenceNumber,E.reference_number],C=ke(T.filter(U=>U!=null&&U!=="").map(String).join(" ")).replace(/\s+/g,""),W=o.replace(/\s+/g,"");if(!C.includes(W))return!1}if(d&&!ke(x?.customerName||E.customerName||"").includes(d))return!1;if(c){const T=[E.projectId,E.project_id,E.projectID,A?.id,A?.projectCode,A?.project_code],C=ke(T.filter(U=>U!=null&&U!=="").map(String).join(" ")).replace(/\s+/g,""),W=c.replace(/\s+/g,"");if(!C.includes(W))return!1}if(!i)return!0;const j=E.items?.map?.(T=>`${T.barcode} ${T.desc}`).join(" ")||"",q=(E.technicians||[]).map(T=>a.get(String(T))?.name).filter(Boolean).join(" ");return ke([E.reservationId,x?.customerName||E.customerName,E.notes,j,q,A?.title].filter(Boolean).join(" ")).includes(i)});return B.sort((E,x)=>{const A=Tn(E.reservation,E.index),h=Tn(x.reservation,x.index);return A!==h?h-A:x.index-E.index}),B}function or({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=l("reservations.create.summary.currency","SR"),s=l("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=l("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=l("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),d=l("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),c=l("reservations.list.crew.separator","ØŒ "),u=l("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),f=l("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),y=l("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),m=l("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),p=l("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),g=l("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),b=l("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),B=l("reservations.list.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),E=l("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),x=l("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),A={client:l("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:l("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:l("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:l("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:l("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:l("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:l("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:h,index:w})=>{const P=n.get(String(h.customerId)),j=h.projectId?a?.get?.(String(h.projectId)):null,q=Kn(h),G=h.items?.length||0,T=Array.isArray(h.crewAssignments)?h.crewAssignments:[],C=(h.technicians||[]).map(H=>t.get(String(H))).filter(Boolean),W=T.length?T.map(H=>{const oe=H.positionLabel??H.position_name??H.role??l("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),Z=H.technicianName??t.get(String(H.technicianId??""))?.name??null;return Z?`${S(oe)} (${S(Z)})`:S(oe)}):C.map(H=>H.name),U=W.length?W.join(c):"â€”",M=S(String(h.reservationId??"")),$=h.start?S(Qt(h.start)):"-",ae=h.end?S(Qt(h.end)):"-",z=h.discount??h.discountValue??h.discount_value??h.discountAmount??0,D=Number.parseFloat(S(String(z))),F=Number.isFinite(D)?D:0,te=h.discountType??h.discount_type??h.discountMode??"percent",de=String(te).toLowerCase()==="amount"?"amount":"percent",N=!!(h.applyTax??h.apply_tax??h.taxApplied),pe=h.companySharePercent??h.company_share_percent??h.companyShare??h.company_share,we=h.companyShareEnabled??h.company_share_enabled??h.companyShareApplied,ee=Number.parseFloat(S(String(pe))),qe=(we===!0||Number.isFinite(ee)&&ee>0)&&Number.isFinite(ee)?ee:0;let ye=0;try{const H=as({items:h.items||[],technicianIds:h.technicians||[],crewAssignments:Array.isArray(h.crewAssignments)?h.crewAssignments:[],discount:F,discountType:de,applyTax:N,start:h.start,end:h.end,companySharePercent:qe,groupingSource:h}),oe=Number(H?.finalTotal||0);ye=Number.isFinite(oe)?Number(oe.toFixed(2)):0}catch{ye=0}const ut=Number.parseFloat(S(String(h.cost??0)))||0,fe=ye>0?ye:ut,L=h.paymentHistory||h.payment_history||[],V=$t({totalAmount:fe,paidAmount:L.length?0:h.paidAmount,paidPercent:L.length?0:h.paidPercent,history:L});let ne=Nt({manualStatus:null,paidAmount:V.paidAmount,paidPercent:V.paidPercent,totalAmount:fe});if(j)try{const{totalWithTax:H}=Bs(j)||{totalWithTax:0},oe=j.paymentHistory||j.payments||[],Z=$t({totalAmount:H,paidAmount:oe.length?0:j.paidAmount,paidPercent:oe.length?0:j.paidPercent,history:oe}),pt=Nt({manualStatus:null,paidAmount:Z.paidAmount,paidPercent:Z.paidPercent,totalAmount:H});pt&&(ne=pt)}catch{}const ge=ne==="paid",se=ne==="partial",{effectiveConfirmed:ue,projectLinked:le}=Et(h,j),rt=ue?"status-confirmed":"status-pending",it=ge?"status-paid":se?"status-partial":"status-unpaid";let $e=`<span class="reservation-chip status-chip ${rt}">${ue?u:f}</span>`;const mt=ge?m:se?g:p;let Ne=`<span class="reservation-chip status-chip ${it}">${mt}</span>`,At=ge?" tile-paid":se?" tile-partial":" tile-unpaid";q&&(At+=" tile-completed");let Bt="";q&&($e=`<span class="reservation-chip status-chip status-completed">${y}</span>`,Ne=`<span class="reservation-chip status-chip status-completed">${mt}</span>`,Bt=` data-completed-label="${l("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`);let xe="";le||(ue?q||(xe=`<button class="tile-confirm" data-reservation-index="${w}" data-action="close">${B}</button>`):xe=`<button class="tile-confirm" data-reservation-index="${w}" data-action="confirm">${b}</button>`);const I=xe?`<div class="tile-actions">${xe}</div>`:"",_=S(fe.toFixed(2)),k=S(String(G)),R=h.notes?S(h.notes):o,Q=d.replace("{count}",k),Y=h.applyTax?`<small>${s}</small>`:"";let X=E;return h.projectId&&(X=j?.title?S(j.title):x),`
      <div class="${xe?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${At}"${Bt} data-reservation-index="${w}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${M}</div>
          <div class="tile-badges">
            ${$e}
            ${Ne}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${A.client}</span>
            <span class="tile-value">${P?.customerName||h.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.project}</span>
            <span class="tile-value">${X}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.start}</span>
            <span class="tile-value tile-inline">${$}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.end}</span>
            <span class="tile-value tile-inline">${ae}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.cost}</span>
            <span class="tile-value">${_} ${r} ${Y}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.equipment}</span>
            <span class="tile-value">${Q}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.crew}</span>
            <span class="tile-value">${W.length?U:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${R}</span>
          </div>
        </div>
        ${I}
      </div>
    `}).join("")}function cr({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a,onCloseReservation:r,onReopenReservation:s}={}){const i=bt(),{reservations:o=[],customers:d=[],technicians:c=[],projects:u=[]}=re(),f=o.map(A=>{const h=Xt(A);return{...h,id:A.id??h.id,reservationId:A.reservationId??A.reservation_id??h.reservationId,reservationCode:A.reservationCode??A.reservation_code??h.reservationCode}}),y=f,m=Array.isArray(i)?i:c||[],p=new Map((u||[]).map(A=>[String(A.id),A])),g=document.getElementById(e);if(!g){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!y||y.length===0){g.innerHTML=`<p>${l("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const b=n||ks(),B=new Map(d.map(A=>[String(A.id),A])),E=new Map(m.map(A=>[String(A.id),A])),x=ir({reservations:f,filters:b,customersMap:B,techniciansMap:E,projectsMap:p});if(x.length===0){g.innerHTML=`<p>${l("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}g.innerHTML=`<div class="reservations-grid">${or({entries:x,customersMap:B,techniciansMap:E,projectsMap:p})}</div>`,g.querySelectorAll('[data-action="details"]').forEach(A=>{const h=Number(A.dataset.reservationIndex);Number.isNaN(h)||A.addEventListener("click",()=>{typeof t=="function"&&t(h)})}),g.querySelectorAll('button[data-action="confirm"]').forEach(A=>{const h=Number(A.dataset.reservationIndex);Number.isNaN(h)||A.addEventListener("click",w=>{w.stopPropagation(),typeof a=="function"&&a(h,w)})}),g.querySelectorAll('button[data-action="close"]').forEach(A=>{const h=Number(A.dataset.reservationIndex);Number.isNaN(h)||A.addEventListener("click",w=>{w.stopPropagation(),typeof r=="function"&&r(h,w)})})}function dr(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=re(),o=r.map(b=>{const B=Xt(b);return{...B,id:b.id??B.id,reservationId:b.reservationId??b.reservation_id??B.reservationId,reservationCode:b.reservationCode??b.reservation_code??B.reservationCode}}),d=r[e];if(!d)return v(l("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;let c=o[e]??Xt(d);const u=s.find(b=>String(b.id)===String(d.customerId)),f=d.projectId?i.find(b=>String(b.id)===String(d.projectId)):null,y=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),p=(b,B=null)=>{if(y){const E=B??(bt()||[]);y.innerHTML=Za(b,u,E,e,f)}},g=()=>{const b=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},B=document.getElementById("reservation-details-edit-btn");B&&(B.onclick=()=>{b(),typeof n=="function"&&n(e,{reservation:d,customer:u,getEditContext:a})});const E=document.getElementById("reservation-details-delete-btn");E&&(E.onclick=()=>{b(),typeof t=="function"&&t(e,{reservation:d,customer:u})});const x=y?.querySelector('[data-action="open-project"]');x&&f&&x.addEventListener("click",()=>{b();const w=f?.id!=null?String(f.id):"",P=w?`projects.html?project=${encodeURIComponent(w)}`:"projects.html";window.location.href=P});const A=document.getElementById("reservation-details-export-btn");A&&(A.onclick=async w=>{w?.preventDefault?.(),w?.stopPropagation?.(),A.blur();try{await ws({reservation:d,customer:u,project:f})}catch(P){console.error("âŒ [reservations] export to PDF failed",P),v(l("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const h=document.getElementById("reservation-details-checklist-btn");h&&(h.onclick=async w=>{w?.preventDefault?.(),w?.stopPropagation?.(),h.blur();try{await As({reservation:d,customer:u,project:f})}catch(P){console.error("âŒ [reservations] export checklist PDF failed",P),v(l("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const w=y?.querySelector("[data-tech-slider]");if(w){const P=w.querySelector("[data-slider-track]"),j=w.querySelector("[data-slider-prev]"),q=w.querySelector("[data-slider-next]");if(P&&(j||q)){const G=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",T=()=>{const U=P.querySelector(".reservation-technician-card"),M=U&&U.getBoundingClientRect().width||220,$=12,ae=Math.max(1,Math.floor(P.clientWidth/(M+$)));return Math.max(M+$,Math.floor(ae*(M+$)*.9))},C=()=>{const U=Math.max(0,P.scrollWidth-P.clientWidth-2),M=P.scrollLeft<=1,$=P.scrollLeft>=U;j&&(j.disabled=M),q&&(q.disabled=$)},W=U=>{const M=T()*U,$=G?-M:M;P.scrollBy({left:$,behavior:"smooth"})};j?.addEventListener("click",()=>W(-1)),q?.addEventListener("click",()=>W(1)),P.addEventListener("scroll",C,{passive:!0}),window.addEventListener("resize",C,{passive:!0}),setTimeout(C,0)}}}catch{}};if(y&&(p(c),g(),sa().then(()=>{const b=bt()||[];p(c,b),g()}).catch(()=>{})),Wn(c)){const b=c.id||c.reservationId||c.reservation_code;Jn(b).then(B=>{B&&(c=B,p(c),g())}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function st(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";if(!e||!n)return{start:null,end:null};const r=`${e}T${t}`,s=`${n}T${a}`;return{start:Ze(e,t)||r,end:Ze(n,a)||s}}function Ft(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function kn(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function _t(){const{container:e,select:n,hint:t,addButton:a}=kn();if(!n)return;const r=n.value,s=Yn(),i=l("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${l("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,d=s.map(u=>{const f=Number.isFinite(Number(u.price))?Number(u.price):0,y=S(f.toFixed(2)),m=`${u.name} â€” ${y} ${i}`;return`<option value="${Ft(u.id)}">${Ft(m)}</option>`}).join("");n.innerHTML=`${o}${d}`;const c=s.length>0;n.disabled=!c,a&&(a.disabled=!c),e&&(e.hidden=!c,e.setAttribute("aria-hidden",c?"false":"true")),t&&(c?(t.textContent=l("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=l("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),c&&r&&s.some(u=>u.id===r)?n.value=r:n.selectedIndex=0}function lr(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||v(l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=ve(),{start:s,end:i}=st(),{reservations:o=[]}=re(),d=a!=null&&o[a]||null,c=d?.id??d?.reservationId??null,u=Aa(t,{existingItems:r,start:s,end:i,ignoreReservationId:c});if(!u.success)return n||v(u.message||l("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),u;const f=[...r,u.package];return Ce(a,f),_e(f),he(),n||v(l("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),u}function Rn(){const{select:e}=kn();if(!e)return;const n=e.value||"";lr(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function ur(){const{addButton:e,select:n}=kn();n&&!n.dataset.langRefreshAttached&&(document.addEventListener("language:changed",_t),document.addEventListener("language:translationsReady",_t),n.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Rn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Rn())}),n.dataset.listenerAttached="true"),_t()}function _e(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=l("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=l("reservations.create.summary.currency","SR"),r=l("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=l("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=l("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=l("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${t}</td></tr>`,Fn(n);return}const{groups:d}=zt({items:e});n.innerHTML=d.map(c=>{const u=c.items[0]||{},f=lt(u)||c.image,y=f?`<img src="${f}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',m=String(c?.type||"").toLowerCase()==="package"||c.items.some($=>$?.type==="package"),p=S(String(c.count)),g=je(c.unitPrice),b=Number.isFinite(g)?Te(g):0,B=je(c.unitCost),E=Number.isFinite(B)?Te(B):0,x=(()=>{try{const{start:$,end:ae}=st(),z=typeof Yt=="function"?Yt($,ae):1;return Number.isFinite(z)&&z>0?z:1}catch{return 1}})(),A=je(c.totalPrice),h=Number.isFinite(A)?A:b*(Number.isFinite(c.count)?c.count:1)*x,w=Te(h),P=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${c.key}"
          min="0"
          step="0.01"
          value="${S(String(b))}"
          aria-label="${l("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,q=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${`edit-unit-cost-${c.key}`}"
          data-group-key="${c.key}"
          min="0"
          step="0.01"
          value="${S(String(E))}"
          aria-label="${l("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,G=`${S(w.toFixed(2))} ${a}`,T=c.barcodes.map($=>S(String($||""))).filter(Boolean),C=T.length?`<details class="reservation-item-barcodes">
            <summary>${l("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${T.map($=>`<li>${$}</li>`).join("")}
            </ul>
          </details>`:"";let W="";if(m){const $=new Map,ae=D=>{const F=Number.parseFloat(S(String(D??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(F)||F<=0||F>99?1:Math.round(F)},z=[];if(Array.isArray(c.packageItems)&&c.packageItems.length&&z.push(...c.packageItems),c.items.forEach(D=>{Array.isArray(D?.packageItems)&&z.push(...D.packageItems)}),z.forEach(D=>{if(!D)return;const F=O(D.barcode||D.normalizedBarcode||D.desc||Math.random());if(!F)return;const te=$.get(F),de=ae(D.qtyPerPackage??D.perPackageQty??D.quantityPerPackage??D.qty??D.quantity??1),N=Math.max(1,Math.min(de,99));if(te){te.qty=N;return}$.set(F,{desc:D.desc||D.barcode||l("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:N,barcode:D.barcode??D.normalizedBarcode??""})}),$.size){const D=Array.from($.values()).map(F=>{const te=S(String(F.qty>0?Math.min(F.qty,99):1)),de=Ft(F.desc||""),N=F.barcode?` <span class="reservation-package-items__barcode">(${Ft(S(String(F.barcode)))})</span>`:"";return`<li>${de}${N} Ã— ${te}</li>`}).join("");W=`
            <details class="reservation-package-items">
              <summary>${l("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${D}
              </ul>
            </details>
          `}}const U=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",M=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${c.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${y}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${c.description||"-"}</div>
                ${m?`${W||""}${C||""}`:C}
              </div>
            </div>
          </td>
          <td>
            <div class="${U}" data-group-key="${c.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${c.key}" aria-label="${i}"${M}>âˆ’</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${c.key}" aria-label="${s}"${M}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${S(String(x))}</span></td>
          <td>${P}</td>
          <td>${q}</td>
          <td>${G}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${c.key}" aria-label="${o}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Fn(n)}function mr(e){switch(e){case"amount":return l("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return l("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return l("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Ut(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Gt();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(re()?.projects||[]).find(d=>String(d.id)===String(t)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(n=o)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${l("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Dn();return}const a=l("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const o=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${S(Number(s.amount).toFixed(2))} ${a}`:"â€”",d=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${S(Number(s.percentage).toFixed(2))}%`:"â€”",c=s?.recordedAt?S(Qt(s.recordedAt)):"â€”",u=mr(s?.type),f=s?.note?S(s.note):"";return`
      <tr>
        <td>${u}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${c}</td>
        <td>${f}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${l("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${l("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${l("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${l("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${l("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${l("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Dn()}function pr(){if(It()){v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=ja(e);let a=Ta(n);if(!Number.isFinite(a)||a<=0){v(l("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=Zt.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,o=Number(r?.paidAmount)||0,d=l("reservations.create.summary.currency","SR");let c=null,u=null;if(t==="percent"){const y=Math.max(0,100-i);if(y<=1e-4){v(l("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,y);if(m!==a){const p=S(m.toFixed(2));v(l("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",p)),a=m}u=Number(a.toFixed(2)),s>0&&(c=a/100*s)}else{const y=Math.max(0,s-o);if(y<=1e-4){v(l("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,y);if(m!==a){const p=`${S(m.toFixed(2))} ${d}`;v(l("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",p)),a=m}c=Number(a.toFixed(2)),s>0&&(u=c/s*100)}c!=null&&(c=Number(c.toFixed(2))),u!=null&&(u=Number(u.toFixed(2)));const f={type:t,value:a,amount:c,percentage:u,recordedAt:new Date().toISOString()};Lr(f),wn(Gt()),Ut(),he(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),v(l("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Dn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(It()){t.preventDefault(),v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}pr()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(It()){t.preventDefault(),v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(_r(r),wn(Gt()),Ut(),he(),v(l("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function fr(e){const{index:n,items:t}=ve(),{groups:a}=zt({items:t}),r=a.find(o=>o.key===e);if(!r||r.items.some(o=>o?.type==="package"))return;let s=-1;for(let o=t.length-1;o>=0;o-=1){const d=t[o];if(He(d)===e&&d?.type!=="package"){s=o;break}}if(s<0)return;const i=t.filter((o,d)=>d!==s);Ce(n,i),_e(i),he()}function yr(e){const{index:n,items:t}=ve(),{groups:a}=zt({items:t}),r=a.find(o=>o.key===e);if(!r)return;let s=t.filter(o=>He(o)!==e);if(r.items.some(o=>o&&o.type==="package")){const o=Pe(r.packageId??r.items.find(f=>f?.type==="package")?.packageId??""),d=O(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(f=>{if(!f||typeof f!="object"||f.type!=="package")return!0;const y=Pe(f.packageId??f.package_id??f.id??""),m=O(f.barcode??f.package_code??"");return!(o&&y===o||d&&m&&m===d)});const c=new Set,u=new Set;r.items.forEach(f=>{(Array.isArray(f?.packageItems)?f.packageItems:[]).forEach(m=>{const p=O(m?.barcode||m?.normalizedBarcode||"");p&&c.add(p);const g=m?.equipmentId??m?.equipment_id??null;g!=null&&u.add(String(g))})}),(c.size||u.size)&&(s=s.filter(f=>{const y=O(f?.barcode||""),m=f?.equipmentId??f?.id??null;return!(y&&c.has(y)||m!=null&&u.has(String(m)))}))}s.length!==t.length&&(Ce(n,s),_e(s),he())}function gr(e){const{index:n,items:t}=ve(),{groups:a}=zt({items:t}),r=a.find(b=>b.key===e);if(!r||r.items.some(b=>b?.type==="package"))return;const{start:s,end:i}=st();if(!s||!i){v(l("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=re(),d=n!=null&&o[n]||null,c=d?.id??d?.reservationId??null,u=new Set(t.map(b=>O(b.barcode))),{equipment:f=[]}=re(),y=(f||[]).find(b=>{const B=O(b?.barcode);return!B||u.has(B)||He({desc:b?.desc||b?.description||b?.name||"",price:Number(b?.price)||0})!==e||!Hn(b)?!1:!De(B,s,i,c)});if(!y){v(l("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=O(y.barcode),p=at(y);if(!p){v(l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=[...t,{id:p,equipmentId:p,barcode:m,desc:y.desc||y.description||y.name||r.description||"",qty:1,price:Number.isFinite(Number(y.price))?Number(y.price):r.unitPrice,cost:Ye(y),image:lt(y)}];Ce(n,g),_e(g),he()}function vr(e,n){const t=je(n),a=Number.isFinite(t)&&t>=0?Te(t):0,{index:r,items:s}=ve();if(!Array.isArray(s))return;const o=nt(s).find(c=>c.key===e);if(!o||!Array.isArray(o.itemIndices))return;const d=[...s];o.itemIndices.forEach(c=>{if(d[c]){const u={...d[c],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};d[c]=u}}),Ce(r,d),_e(d),he()}function hr(e,n){const t=je(n),a=Number.isFinite(t)&&t>=0?Te(t):0,{index:r,items:s}=ve();if(!Array.isArray(s))return;const o=nt(s).find(c=>c.key===e);if(!o||!Array.isArray(o.itemIndices))return;const d=[...s];o.itemIndices.forEach(c=>{d[c]&&(d[c]={...d[c],price:a,unit_price:a})}),Ce(r,d),_e(d),he()}function Fn(e){if(!e||e.dataset.groupListenerAttached)return;e.addEventListener("click",a=>{const r=a.target.closest("button[data-action]");if(!r)return;const{action:s,groupKey:i,itemIndex:o}=r.dataset;if(s==="decrease-edit-group"&&i){fr(i);return}if(s==="increase-edit-group"&&i){gr(i);return}if(s==="remove-edit-group"&&i){yr(i);return}if(s==="remove-edit-item"){const d=Number(o);Number.isNaN(d)||Er(d)}});const n=a=>{const r=a.target.closest(".reservation-unit-cost-input");if(!r)return;const s=r.dataset.groupKey;s&&vr(s,r.value)},t=a=>{const r=a.target.closest(".reservation-unit-price-input");if(!r)return;const s=r.dataset.groupKey;s&&hr(s,r.value)};e.addEventListener("change",n),e.addEventListener("input",n),e.addEventListener("change",t),e.addEventListener("input",t),e.dataset.groupListenerAttached="true"}function It(){return!!document.getElementById("edit-res-project")?.value}function br(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{It()&&(v(l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function Ir(e){const n=l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,o,d].forEach(br),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const c=document.getElementById("edit-res-project")?.value||"";let u="unpaid";if(c)try{const y=(re()?.projects||[]).find(p=>String(p.id)===String(c)),m=typeof y?.paymentStatus=="string"?y.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(u=m)}catch{}r.value=u,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=n),d&&(d.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function he(){const e=document.getElementById("edit-res-summary");if(!e)return;Ut();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),be(a),he()}),a.dataset.listenerAttached="true");const r=S(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",o=It();Ir(o);const d=document.getElementById("edit-res-tax"),c=o?!1:d?.checked||!1,u=!o&&a?.dataset?.userSelected==="true";let f="unpaid";if(o){const x=document.getElementById("edit-res-project")?.value||"";if(x)try{const h=(re()?.projects||[]).find(P=>String(P.id)===String(x)),w=typeof h?.paymentStatus=="string"?h.paymentStatus.toLowerCase():null;w&&["paid","partial","unpaid"].includes(w)&&(f=w)}catch{}}else f=u&&a?.value||"unpaid";let y=null;!o&&c&&(Be("edit-res-company-share"),y=tt("edit-res-company-share"),(!Number.isFinite(y)||y<=0)&&(Be("edit-res-company-share"),y=tt("edit-res-company-share")));const{items:m=[],payments:p=[]}=ve(),{start:g,end:b}=st(),B=Zt({items:m,discount:s,discountType:i,applyTax:c,paidStatus:f,start:g,end:b,companySharePercent:y,paymentHistory:p});e.innerHTML=B;const E=Zt.lastResult;if(E&&a){const x=E.paymentStatus;u?be(a,a.value):(a.value!==x&&(a.value=x),a.dataset&&delete a.dataset.userSelected,be(a,x))}else a&&be(a,a.value)}function Er(e){if(e==null)return;const{index:n,items:t}=ve();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);Ce(n,a),_e(a),he()}async function Sr(e){const n=e?.value??"",t=O(n)||S(String(n)).trim().toLowerCase();if(!t)return;const a=un(t);if(!a){v(l("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Oe(a);if(r==="maintenance"||r==="retired"){v(et(r));return}const s=O(t),{index:i,items:o=[]}=ve();if(o.findIndex(B=>O(B.barcode)===s)>-1){v(l("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:c,end:u}=st();if(!c||!u){v(l("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:f=[]}=re(),y=i!=null&&f[i]||null,m=y?.id??y?.reservationId??null;if(De(s,c,u,m)){v(l("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const p=at(a);if(!p){v(l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=typeof Ye=="function"?Ye(a):Number.isFinite(Number(a?.cost))?Number(a.cost):0,b=[...o,{id:p,equipmentId:p,barcode:s,desc:a.desc,qty:1,price:a.price,cost:g,image:a.image||a.imageUrl||a.img||null}];Ce(i,b),e&&(e.value=""),_e(b),he()}async function Mt(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=Ea(n),a=O(t?.barcode||n)||S(String(t?.barcode||n)).trim().toLowerCase();if(!t||!a){v(l("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Oe(t);if(r==="maintenance"||r==="retired"){v(et(r));return}const{start:s,end:i}=st();if(!s||!i){v(l("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:d=[]}=ve();if(d.some(b=>O(b.barcode)===a)){v(l("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:u=[]}=re(),f=o!=null&&u[o]||null,y=f?.id??f?.reservationId??null;if(De(a,s,i,y)){v(l("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const m=at(t);if(!m){v(l("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const p=typeof Ye=="function"?Ye(t):Number.isFinite(Number(t?.cost))?Number(t.cost):0,g=[...d,{id:m,equipmentId:m,barcode:a,desc:t.desc,qty:1,price:t.price,cost:p,image:t.image||t.imageUrl||t.img||null}];Ce(o,g),_e(g),he(),e.value=""}function Na(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Mt(e))});const n=()=>{Sa(e.value,"edit-res-equipment-description-options")&&Mt(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{he()});const e=()=>{ur()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{_t()})}typeof window<"u"&&(window.getEditReservationDateRange=st,window.renderEditPaymentHistory=Ut);function kr(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){rn(e);return}Mt(e)}}function Yr(){Ke(),Na()}function wr(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let ct=null,Ee=[],Le=[],cn=null,ce={},Jt=!1,Mn=!1;function Ar(){if(!Mn)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{Fa(ce).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Mn=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Br="__DEBUG_CREW__";function Pr(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Br);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function zn(e,n){if(Pr())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function vt(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=l("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),o=l("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=s?i:o,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function yt(){return document.getElementById("edit-res-confirmed")?.value==="true"}function ve(){return{index:ct,items:Ee,payments:Le}}function Ce(e,n,t=Le){ct=typeof e=="number"?e:null,Ee=Array.isArray(n)?[...n]:[],Le=Array.isArray(t)?[...t]:[]}function xa(){ct=null,Ee=[],ds(),Le=[]}function Gt(){return[...Le]}function wn(e){Le=Array.isArray(e)?[...e]:[]}function Lr(e){e&&(Le=[...Le,e])}function _r(e){!Number.isInteger(e)||e<0||(Le=Le.filter((n,t)=>t!==e))}function Ct(e,n=1){const t=Number.parseFloat(S(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function ht(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(S(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function Cr(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?O(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:Ct(e.qty??e.quantity??e.count??1),price:ht(e.price??e.unit_price??e.unitPrice??0),cost:ht(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.purchase_price??0),image:e.image??e.image_url??e.imageUrl??null}}function qr(e,n=0){if(!e||typeof e!="object")return null;const t=Pe(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:yn(e)).map(m=>Cr(m)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=ht(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const m=ht(i,0);m>0&&a>0&&(o=Number((m/a).toFixed(2)))}let d=ht(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??null,0);(!d||d===0)&&s.length&&(d=0);const c=e.package_code??e.packageCode??e.barcode??null,f=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,c,t].find(m=>m!=null&&String(m).trim()!=="")||`Package ${t}`,y=e.image??e.cover??e.thumbnail??s.find(m=>m?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:S(String(f)),name:S(String(f)),qty:a,price:o,cost:d,unit_cost:d,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,barcode:c,packageItems:s,image:y}}function $r(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function Nr(e={},n=[]){const t=Array.isArray(n)?n.map(c=>({...c})):[],a=new Map;Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(c=>{if(!c||typeof c!="object")return;const u=Pe(c.packageId??c.package_id??c.package_code??c.packageCode??c.code??c.id??"");u&&a.set(u,c)});const s=(Array.isArray(e?.packages)?e.packages:[]).map(c=>{const u=Pe(c.packageId??c.package_id??c.package_code??c.packageCode??c.code??c.id??"");if(!u||!a.has(u))return c;const f=je(c.unit_cost??c.unitCost??c.cost??c.rental_cost??c.purchase_price??c.internal_cost??c.equipment_cost??c.item_cost);if(Number.isFinite(f)&&f>0)return c;const y=a.get(u),m=je(y.unit_cost??y.unitCost??y.cost??y.package_cost??y.rental_cost??y.purchase_price??y.internal_cost??y.equipment_cost??y.item_cost);if(!Number.isFinite(m)||m<=0)return c;const p=Te(m);return{...c,unit_cost:p,unitCost:p,cost:p,rental_cost:c.rental_cost??p,purchase_price:c.purchase_price??p,internal_cost:c.internal_cost??p,equipment_cost:c.equipment_cost??p,item_cost:c.item_cost??p}});if(!s.length)return t;const i=s.map((c,u)=>qr(c,u)).filter(Boolean);if(!i.length)return t;const o=new Map;i.forEach(c=>{const u=Ct(c.qty??c.quantity??1);if(c.barcode){const f=O(c.barcode);if(f){const y=`package::${f}`;o.set(y,(o.get(y)??0)+u)}}(c.packageItems||[]).forEach(f=>{if(!f)return;const y=u*Ct(f.qty??f.quantity??1),m=f.equipmentId??null,p=f.normalizedBarcode||(f.barcode?O(f.barcode):null);if(m!=null){const g=`equipment::${String(m)}`;o.set(g,(o.get(g)??0)+y)}if(p){const g=`barcode::${p}`;o.set(g,(o.get(g)??0)+y)}})});const d=[];return t.forEach(c=>{if(!c||typeof c!="object"){d.push(c);return}if(c.type==="package"){const E=Pe(c.packageId??c.package_id??c.id??"");i.some(A=>A.packageId===E)||d.push({...c});return}const u=Ct(c.qty??c.quantity??1),f=at(c),y=c.barcode?O(c.barcode):null,m=[];f!=null&&m.push(`equipment::${String(f)}`),y&&m.push(`barcode::${y}`);const p=m.map(E=>o.get(E)??0).filter(E=>E>0);if(!p.length){d.push({...c});return}const g=Math.min(...p);if(g<=0){d.push({...c});return}const b=Math.min(g,u);if($r(o,m,b),b>=u)return;const B=u-b;d.push({...c,qty:B,quantity:B})}),[...d,...i.map(c=>({...c}))]}function xr(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function ja(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function Ta(e){if(!e)return null;const n=S(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function jr(e,n){if(e){e.value="";return}}function ft(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ra(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(S(String(e.value??""))),a=Number.parseFloat(S(String(e.amount??""))),r=Number.parseFloat(S(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,o=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?s??null:o==="percent"?i??null:Number.isFinite(t)?t:null,c=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:c}}function Tr(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=l("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=l("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((d,c)=>String(c.createdAt||c.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${ft(a)}</option>`];i.forEach(d=>{o.push(`<option value="${ft(d.id)}">${ft(d.title||a)}</option>`)}),s&&!i.some(d=>String(d.id)===s)&&o.push(`<option value="${ft(s)}">${ft(r)}</option>`),t.innerHTML=o.join(""),s?t.value=s:t.value=""}function Da(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=l("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const d=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",d&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}dn("tax");const o=ce?.updateEditReservationSummary;typeof o=="function"&&o()}function dn(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=ce?.updateEditReservationSummary;typeof s=="function"&&s()};if(Jt){a();return}Jt=!0;const r=()=>{Jt=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Xe)),n.disabled){t.checked=!1,v(l("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),Be("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Be("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function Vn(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:o,projects:d}=re();let u=Qn()?.[e];if(!u){v(l("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}if(Wn(u))try{const N=await Jn(u.id||u.reservationId||u.reservation_code);N&&(u=N)}catch(N){console.warn("[reservationsEdit] Failed to hydrate reservation packages",N)}ce={...ce,reservation:u,projects:d||[]},n?.(),Tr(d||[],u);const f=u.projectId&&d?.find?.(N=>String(N.id)===String(u.projectId))||null,{effectiveConfirmed:y,projectLinked:m}=Et(u,f),p=u.items?u.items.map(N=>({...N,equipmentId:N.equipmentId??N.equipment_id??N.id,barcode:O(N?.barcode)})):[],g=Nr(u,p),B=(Array.isArray(u.paymentHistory)?u.paymentHistory:Array.isArray(u.payment_history)?u.payment_history:[]).map(N=>Ra(N)).filter(Boolean);Ce(e,g,B);const E=l("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),x=o?.find?.(N=>String(N.id)===String(u.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const A=document.getElementById("edit-res-id");A&&(A.value=u.reservationId||u.id);const h=document.getElementById("edit-res-customer");h&&(h.value=x?.customerName||E);const w=typeof a=="function"?a(u.start):{date:"",time:""},P=typeof a=="function"?a(u.end):{date:"",time:""};t?.("edit-res-start",w.date),t?.("edit-res-start-time",w.time),t?.("edit-res-end",P.date),t?.("edit-res-end-time",P.time);const j=document.getElementById("edit-res-notes");j&&(j.value=u.notes||"");const q=document.getElementById("edit-res-discount");if(q){const N=m?0:u.discount??0;q.value=S(N)}const G=document.getElementById("edit-res-discount-type");G&&(G.value=m?"percent":u.discountType||"percent");const T=u.projectId?!1:!!u.applyTax,C=document.getElementById("edit-res-tax");C&&(C.checked=T);const W=document.getElementById("edit-res-company-share");if(W){const N=u.companySharePercent??u.company_share_percent??u.companyShare??u.company_share??null,pe=N!=null?Number.parseFloat(S(String(N).replace("%","").trim())):NaN,we=u.companyShareEnabled??u.company_share_enabled??u.companyShareApplied??u.company_share_applied??null,ee=we!=null?we===!0||we===1||we==="1"||String(we).toLowerCase()==="true":Number.isFinite(pe)&&pe>0,Je=ee&&Number.isFinite(pe)&&pe>0?pe:Xe,qe=T||ee;W.checked=qe,W.dataset.companyShare=String(Je)}vt(y,{disable:m});const U=document.getElementById("edit-res-close-btn"),M=document.getElementById("edit-res-reopen-btn");U&&(U.disabled=!(y&&!m)||String(u.status||"").toLowerCase()==="completed"),M&&(M.disabled=String(u.status||"").toLowerCase()!=="completed");const $=document.getElementById("edit-res-paid"),ae=u.paidStatus??(u.paid===!0||u.paid==="paid"?"paid":"unpaid");$&&($.value=ae,$.dataset&&delete $.dataset.userSelected);const z=document.getElementById("edit-res-payment-progress-type"),D=document.getElementById("edit-res-payment-progress-value");z?.dataset?.userSelected&&delete z.dataset.userSelected,z&&(z.value="percent"),jr(D);const F=document.getElementById("edit-res-cancelled");if(F){const N=String(u?.status||u?.reservationStatus||"").toLowerCase();F.checked=["cancelled","canceled"].includes(N),F.checked&&vt(y,{disable:!0})}let te=Array.isArray(u.crewAssignments)&&u.crewAssignments.length?u.crewAssignments:Array.isArray(u.techniciansDetails)&&u.techniciansDetails.length?u.techniciansDetails:(u.technicians||[]).map(N=>String(N));if(!Array.isArray(te)||te.length===0){const N=ss(u.id??u.reservationId??u.reservation_code??null);Array.isArray(N)&&N.length&&(te=N)}try{await sa()}catch(N){console.warn("[reservationsEdit] positions load failed (non-fatal)",N)}if(rs(te),r?.(g),typeof window<"u"){const N=window?.renderEditPaymentHistory;typeof N=="function"&&N()}Da(),s?.();const de=document.getElementById("editReservationModal");cn=xr(de,i),cn?.show?.();try{Rr?.(ce)}catch(N){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",N)}Ar()}async function Fa({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(ct===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end")?.value?.trim(),f=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",y=document.getElementById("edit-res-notes")?.value||"",m=S(document.getElementById("edit-res-discount")?.value||"0");let p=parseFloat(m)||0,g=document.getElementById("edit-res-discount-type")?.value||"percent";const b=yt(),B=document.getElementById("edit-res-paid"),E=B?.dataset?.userSelected==="true",x=E&&B?.value||"unpaid",A=document.getElementById("edit-res-payment-progress-type"),h=document.getElementById("edit-res-payment-progress-value"),w=ja(A),P=Ta(h),j=document.getElementById("edit-res-project")?.value||"",G=document.getElementById("edit-res-cancelled")?.checked===!0,T=is();T.map(I=>I?.technicianId).filter(Boolean);const C=document.getElementById("edit-res-company-share"),W=document.getElementById("edit-res-tax");if(!d||!u){v(l("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const U=typeof e=="function"?e:(I,_)=>`${I}T${_||"00:00"}`,M=U(d,c),$=U(u,f);if(M&&$&&new Date(M)>new Date($)){v(l("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const z=Qn()?.[ct];if(!z){v(l("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(Ee)||Ee.length===0&&T.length===0){v(l("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const D=typeof n=="function"?n:()=>!1,F=z.id??z.reservationId;for(const I of Ee){if(I?.type==="package"&&Array.isArray(I.packageItems)){for(const k of I.packageItems){const R=k?.barcode??k?.normalizedBarcode??"";if(!R)continue;const Q=Oe(R);if(Q!=="reserved"&&Q!=="available"){v(et(Q));return}}continue}const _=Oe(I.barcode);if(_!=="reserved"&&_!=="available"){v(et(_));return}}{const I=typeof t=="function"?t:()=>!1;for(const _ of Ee){if(_?.type!=="package")continue;const k=_.packageId??_.package_id??null,R=_.desc||_.packageName||l("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(k&&I(k,M,$,F)){const Q=Array.isArray(_?.packageItems)?_.packageItems.map(J=>O(J?.barcode??J?.normalizedBarcode??"")).filter(Boolean):[];let Y=Pn(Q,M,$,F);if(!Y.length)try{const J=new URLSearchParams;J.set("type","package"),J.set("id",String(k)),J.set("start",M),J.set("end",$),F!=null&&J.set("ignore",String(F));const H=await Me(`/reservations/availability.php?${J.toString()}`),oe=Array.isArray(H?.conflicts)?H.conflicts:[];Y=Array.from(new Set(oe.map(Z=>Z?.reservation_code||(Z?.reservation_id!=null?`#${Z.reservation_id}`:null)).filter(Boolean)))}catch{}const X=Y.length?` (${Y.join("ØŒ ")})`:"";v(l("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(R))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+X,"warning",-1);return}if(Array.isArray(_?.packageItems)&&_.packageItems.length){const Q=(_.packageItems||[]).map(J=>O(J?.barcode??J?.normalizedBarcode??"")).filter(Boolean),Y=Q.length,X=Q.filter(J=>D(J,M,$,F)).length;if(Y>0&&X>=Y){const J=(_.packageItems||[]).map(Z=>O(Z?.barcode??Z?.normalizedBarcode??"")).filter(Boolean);let H=Pn(J,M,$,F);if(!H.length)try{const Z=new URLSearchParams;Z.set("type","package"),k!=null&&Z.set("id",String(k)),Z.set("start",M),Z.set("end",$),F!=null&&Z.set("ignore",String(F));const pt=await Me(`/reservations/availability.php?${Z.toString()}`),Ka=Array.isArray(pt?.conflicts)?pt.conflicts:[];H=Array.from(new Set(Ka.map(Kt=>Kt?.reservation_code||(Kt?.reservation_id!=null?`#${Kt.reservation_id}`:null)).filter(Boolean)))}catch{}const oe=H.length?` (${H.join("ØŒ ")})`:"";v(l("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(R))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+oe,"warning",6e3);return}}}}const te=[];for(const I of Ee){if(I?.type==="package"&&Array.isArray(I.packageItems)){for(const k of I.packageItems){const R=O(k?.barcode??k?.normalizedBarcode??"");if(R&&D(R,M,$,F)){const Q=k?.desc||k?.barcode||l("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");te.push({label:S(String(Q)),barcode:R})}}continue}const _=O(I.barcode);if(D(_,M,$,F)){const k=I?.desc||I?.name||I?.barcode||l("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");te.push({label:S(String(k)),barcode:_})}}if(te.length){const I=l("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let _=null;try{const R=Array.from(new Set(te.map(Y=>Y.barcode).filter(Boolean))),Q=new Map;await Promise.all(R.map(async Y=>{const X=new URLSearchParams;X.set("type","equipment"),X.set("id",Y),X.set("start",M),X.set("end",$),F!=null&&X.set("ignore",String(F));const J=await Me(`/reservations/availability.php?${X.toString()}`),H=Array.isArray(J?.conflicts)?J.conflicts:[],oe=Array.from(new Set(H.map(Z=>Z?.reservation_code||(Z?.reservation_id!=null?`#${Z.reservation_id}`:null)).filter(Boolean)));Q.set(Y,oe)})),_=te.map(({label:Y,barcode:X})=>{const J=Q.get(X)||[];return J.length?`${Y} (${J.join("ØŒ ")})`:Y}).join("ØŒ ")}catch{}const k=_||te.map(R=>R.label).filter(Boolean).map(String).join("ØŒ ");v(`${I}: ${k}`,"warning",6e3);return}const de=typeof t=="function"?t:()=>!1;for(const I of Ee){if(I?.type!=="package")continue;const _=I.packageId??I.package_id??null;if(_&&de(_,M,$,F)){const k=I.desc||I.packageName||l("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const R=new URLSearchParams;R.set("type","package"),R.set("id",String(_)),R.set("start",M),R.set("end",$),F!=null&&R.set("ignore",String(F));const Q=await Me(`/reservations/availability.php?${R.toString()}`),Y=Array.isArray(Q?.conflicts)?Q.conflicts:[],X=Array.from(new Set(Y.map(H=>H?.reservation_code||(H?.reservation_id!=null?`#${H.reservation_id}`:null)).filter(Boolean))),J=X.length?` (${X.join("ØŒ ")})`:"";v(l("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(k))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+J,"warning",6e3)}catch{v(l("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(k))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const N=typeof a=="function"?a:()=>!1,pe=[];for(const I of T){if(!I?.technicianId||!N(I.technicianId,M,$,F))continue;const _=I?.technicianName||I?.positionLabel||String(I.technicianId);let k=[];try{k=ta(I.technicianId,M,$,F)}catch{}pe.push({label:S(String(_)),codes:k})}if(pe.length){const I=l("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),_=pe.map(({label:k,codes:R})=>R&&R.length?`${k} (${R.join("ØŒ ")})`:k).join("ØŒ ");v(`${I}: ${_}`,"warning",6e3);return}const we=Array.isArray(ce.projects)&&ce.projects.length?ce.projects:re().projects||[],ee=j&&we.find(I=>String(I.id)===String(j))||null,Je={...z,projectId:j?String(j):null,confirmed:b},{effectiveConfirmed:qe,projectLinked:ye,projectStatus:ut}=Et(Je,ee);let fe=!!C?.checked,L=!!W?.checked;if(ye&&(fe&&(C.checked=!1,fe=!1),L=!1),!ye&&fe!==L){v(l("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}L&&(Be("edit-res-company-share"),fe=!!C?.checked);let V=fe?getCompanySharePercent("edit-res-company-share"):null;fe&&(!Number.isFinite(V)||V<=0)&&(Be("edit-res-company-share"),V=getCompanySharePercent("edit-res-company-share"));const ie=fe&&L&&Number.isFinite(V)&&V>0,ne=ye?!1:L;ye&&(p=0,g="percent");const ge=On(Ee,p,g,ne,T,{start:M,end:$,companySharePercent:ie?V:0});let se=Gt();if(Number.isFinite(P)&&P>0){const I=ge;let _=null,k=null;w==="amount"?(_=P,I>0&&(k=P/I*100)):(k=P,I>0&&(_=P/100*I));const R=Ra({type:w,value:P,amount:_,percentage:k,recordedAt:new Date().toISOString()});R&&(se=[...se,R],wn(se)),h&&(h.value="")}const ue=$t({totalAmount:ge,history:se}),le=new Map,rt=document.getElementById("editReservationModal"),it=rt?rt.querySelectorAll(".reservation-unit-cost-input[data-group-key]"):document.querySelectorAll(".reservation-unit-cost-input[data-group-key]");it.forEach(I=>{const _=I.dataset.groupKey;if(!_)return;const k=je(I.value),R=Number.isFinite(k)&&k>=0?Te(k):null;R!==null&&le.set(_,R)}),Ee.forEach(I=>{if(String(I?.type||"").toLowerCase()!=="package")return;const _=He(I);if(!_||le.has(_))return;const R=Array.from(it).find(Q=>(Q.dataset.groupKey||"")===_);if(R){const Q=je(R.value),Y=Number.isFinite(Q)&&Q>=0?Te(Q):null;Y!==null&&le.set(_,Y)}});const $e=Ee.map(I=>{const _=He(I);if(!_)return I;const k=le.get(_);return k===void 0?I:{...I,cost:k,unit_cost:k,rental_cost:k,purchase_price:k,internal_cost:k,equipment_cost:k}}),mt=Nt({manualStatus:x,paidAmount:ue.paidAmount,paidPercent:ue.paidPercent,totalAmount:ge});B&&!E&&(B.value=mt,B.dataset&&delete B.dataset.userSelected);let Ne=z.status??"pending";ye?Ne=ee?.status??ut??Ne:G?Ne="cancelled":["completed","cancelled"].includes(String(Ne).toLowerCase())||(Ne=b?"confirmed":"pending");const At=I=>{const _=Pe(I.packageId??I.package_id??I.package_code??I.packageCode??I.barcode??I.id??null);if(_)return _;const k=I.package_code??I.packageCode??I.barcode??null;return k?S(String(k)).trim().toLowerCase():null},Bt=(()=>{const I=[];$e.filter(k=>String(k?.type||"").toLowerCase()==="package").forEach((k,R)=>{const Q=Number.isFinite(Number(k.qty??k.quantity))?Number(k.qty??k.quantity):1,Y=Number.isFinite(Number(k.unit_price??k.price))?Number(k.unit_price??k.price):0;let X=Number.isFinite(Number(k.unit_cost??k.cost))?Number(k.unit_cost??k.cost):0;const J=He(k),H=J!==void 0?le.get(J):void 0;H!==void 0&&Number.isFinite(H)&&(X=Te(H));const oe=At(k),Z=H!==void 0?2:Number.isFinite(X)&&X>0?1:0;I.push({__dedupeKey:oe??`pkg-${R}`,__priority:Z,package_code:k.package_code??k.packageCode??k.barcode??k.code??null,name:k.name??k.desc??k.package_name??null,quantity:Q,unit_price:Y,unit_cost:X,package_cost:X,packageCost:X,cost:X,items:Array.isArray(k.packageItems)?k.packageItems:[]})});const _=new Map;return I.forEach(k=>{const R=k.__dedupeKey;(!_.has(R)||(k.__priority??0)>=(_.get(R).__priority??0))&&_.set(R,k)}),Array.from(_.values()).map(k=>{const{__dedupeKey:R,__priority:Q,...Y}=k;return Y})})(),xe=Un({reservationCode:z.reservationCode??z.reservationId??null,customerId:z.customerId,start:M,end:$,status:Ne,title:z.title??null,location:z.location??null,notes:y,projectId:j?String(j):null,totalAmount:ge,discount:p,discountType:g,applyTax:ne,paidStatus:mt,confirmed:qe,items:$e.map(I=>({...I,equipmentId:I.equipmentId??I.id})),crewAssignments:T,companySharePercent:ie?V:null,companyShareEnabled:ie,paidAmount:ue.paidAmount,paidPercentage:ue.paidPercent,paymentProgressType:ue.paymentProgressType,paymentProgressValue:ue.paymentProgressValue,paymentHistory:se,packages:Bt});try{zn("about to submit",{editingIndex:ct,crewAssignments:T,techniciansPayload:xe?.technicians,payload:xe});const I=await os(z.id||z.reservationId,xe);zn("server response",{reservation:I?.id??I?.reservationId??I?.reservation_code,technicians:I?.technicians,crewAssignments:I?.crewAssignments,techniciansDetails:I?.techniciansDetails}),await cs(),gn(),bt(),Es(),v(l("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),xa(),o?.({type:"updated",reservation:I}),s?.(),i?.(),cn?.hide?.()}catch(I){console.error("âŒ [reservationsEdit] Failed to update reservation",I);const _=Gn(I)?I.message:l("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");v(_,"error")}}function Rr(e={}){ce={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=ce,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=S(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{dn("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{dn("share")}),d.dataset.listenerAttached="true");const c=document.getElementById("edit-res-payment-progress-type");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{c.dataset.userSelected="true",n?.()}),c.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-value");u&&!u.dataset.listenerAttached&&(u.addEventListener("input",()=>{u.value=S(u.value)}),u.dataset.listenerAttached="true");const f=["edit-res-start","edit-res-end"],y=["edit-res-start-time","edit-res-end-time"],m=w=>{const P=document.getElementById(w);if(!P||P.dataset.editDateListenerAttached==="true")return;const j=()=>{try{n?.()}catch{}try{const q=typeof ve=="function"?ve().items:[];r?.(q)}catch{}};P.addEventListener("input",j),P.addEventListener("change",j),P.dataset.editDateListenerAttached="true"};f.forEach(m),y.forEach(m),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const p=document.getElementById("edit-res-project");p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>{Da();const w=Array.isArray(ce.projects)&&ce.projects.length?ce.projects:re().projects||[],P=p.value&&w.find(C=>String(C.id)===String(p.value))||null,q={...ce?.reservation??{},projectId:p.value||null,confirmed:yt()},{effectiveConfirmed:G,projectLinked:T}=Et(q,P);vt(G,{disable:T}),n?.()}),p.dataset.listenerAttached="true");const g=document.getElementById("edit-res-confirmed-btn");g&&!g.dataset.listenerAttached&&(g.addEventListener("click",()=>{if(g.disabled)return;const w=!yt();vt(w);const P=document.getElementById("edit-res-close-btn");P&&(P.disabled=!w),n?.()}),g.dataset.listenerAttached="true");const b=document.getElementById("edit-res-cancelled");b&&!b.dataset.listenerAttached&&(b.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&vt(yt(),{disable:b.checked});const P=document.getElementById("edit-res-close-btn");P&&(P.disabled=b.checked||!yt()),n?.()}),b.dataset.listenerAttached="true");const B=document.getElementById("save-reservation-changes");B&&!B.dataset.listenerAttached&&(B.addEventListener("click",()=>{Fa(ce).catch(w=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",w)})}),B.dataset.listenerAttached="true");const E=document.getElementById("edit-res-close-btn");E&&!E.dataset.listenerAttached&&(E.addEventListener("click",()=>{try{const{index:w}=ve(),P=document.getElementById("closeReservationModal"),j=document.getElementById("close-reservation-notes"),q=document.getElementById("close-reservation-submit"),G=document.getElementById("edit-res-notes")?.value||"";if(j&&(j.value=G),q&&q.__tmpCloseListener&&(q.removeEventListener("click",q.__tmpCloseListener),q.__tmpCloseListener=null),q){const T=async()=>{const C=j?.value||"";try{await ia(w,C,{onAfterChange:ce?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(P)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(P))?.hide?.()}catch{}}};q.__tmpCloseListener=T,q.addEventListener("click",T,{once:!0})}P&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(P).show()}catch(w){console.warn("[reservationsEdit] failed to open close modal",w)}}),E.dataset.listenerAttached="true");const x=document.getElementById("edit-res-reopen-btn");x&&!x.dataset.listenerAttached&&(x.addEventListener("click",async()=>{try{const{index:w}=ve();await oa(w,{onAfterChange:ce?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{x.disabled=!0}catch{}}catch(w){console.warn("[reservationsEdit] failed to reopen reservation",w)}}),x.dataset.listenerAttached="true");const A=document.getElementById("edit-res-equipment-barcode");if(A&&!A.dataset.listenerAttached){let w=null;const P=()=>{A.value?.trim()&&(clearTimeout(w),w=null,t?.(A))};A.addEventListener("keydown",q=>{q.key==="Enter"&&(q.preventDefault(),P())});const j=()=>{if(clearTimeout(w),!A.value?.trim())return;const{start:q,end:G}=getEditReservationDateRange();!q||!G||(w=setTimeout(()=>{P()},150))};A.addEventListener("input",j),A.addEventListener("change",P),A.dataset.listenerAttached="true"}Na?.();const h=document.getElementById("editReservationModal");h&&!h.dataset.cleanupAttached&&(h.addEventListener("hidden.bs.modal",()=>{xa(),n?.(),r?.([])}),h.dataset.cleanupAttached="true")}function Xr(){return _s().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=re()||{};ls(e||[]),$a()})}function wt(e=null){$a(),Ma(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function Dr(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function ln(){return{populateEquipmentDescriptionLists:Ke,setFlatpickrValue:wr,splitDateTime:na,renderEditItems:_e,updateEditReservationSummary:he,addEquipmentByDescription:kr,addEquipmentToEditingReservation:Sr,addEquipmentToEditingByDescription:Mt,combineDateTime:Ze,hasEquipmentConflict:De,hasTechnicianConflict:ea,renderReservations:Ma,handleReservationsMutation:wt,ensureModal:Dr}}function Ma(e="reservations-list",n=null){cr({containerId:e,filters:n,onShowDetails:za,onConfirmReservation:Ha,onCloseReservation:Fr,onReopenReservation:Oa})}function za(e){return dr(e,{getEditContext:ln,onEdit:(n,{reservation:t})=>{Ga(n,t)},onDelete:Va})}function Va(e){return Ja()?window.confirm(l("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?Ps(e,{onAfterChange:wt}):!1:(Qa(),!1)}function Ha(e){return Ls(e,{onAfterChange:wt})}function Oa(e){return oa(e,{onAfterChange:wt})}let qt=null;function Ua(){const e=document.getElementById("closeReservationModal"),n=document.getElementById("close-reservation-notes"),t=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:n,submit:t,cancel:a}}function Fr(e){qt=e;const{modal:n,note:t}=Ua();t&&(t.value=""),n&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(n).show()}function Mr(){const{modal:e,note:n,submit:t,cancel:a}=Ua();e&&(t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async()=>{const r=n?.value||"";try{await ia(qt,r,{onAfterChange:wt})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}qt=null}}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{qt=null}),a.dataset.listenerAttached="true"))}function Ga(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}Vn(e,ln());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}Vn(e,ln());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}Ya({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function Zr(){Ss({showReservationDetails:za,deleteReservation:Va,confirmReservation:Ha,openReservationEditor:Ga,reopenReservation:Oa});try{Mr()}catch{}}export{Yr as a,Ma as b,$a as c,K as d,za as e,Va as f,ln as g,wt as h,Qr as i,Ha as j,wr as k,Xr as l,Ga as o,Zr as r,Rr as s,he as u};
