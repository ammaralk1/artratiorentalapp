import{x as be,t as d,n as v,d as Lt,h as j,b as jt,a as ve,c as De,i as Ee,l as Ie}from"./auth.js";import{i as we}from"./dashboardShell.js";import"./projects2.js";/* empty css   */import{g as ie,s as Pt,r as Fe,e as ce,f as Ae}from"./reservationsService.js";import{r as $t,a as se,s as Se}from"./controller.js";import"./events.js";import{e as oe,r as qt,d as Te,f as ke}from"./projectsService.js";import{g as ft,b as xe,e as Le,a as je,c as Pe,d as Vt,P as Be,s as Ne,f as Me}from"./projectFocusTemplates.js";import{c as Ce}from"./projectsCommon.js";be({ar:{"technicianDetails.pageTitle":"معلومات عضو الطاقم","technicianDetails.title":"😎 بيانات عضو الطاقم","technicianDetails.actions.back":"⬅️ العودة","technicianDetails.actions.edit":"✏️ تعديل عضو الطاقم","technicianDetails.hero.subtitle":"راجع نشاط عضو الطاقم ومهامه الحالية.","technicianDetails.hero.helper":"استخدم هذه الصفحة لمتابعة حجوزات ومشاريع عضو الطاقم.","technicianTabs.reservations":"📅 حجوزات الفني","technicianTabs.projects":"📁 مشاريع الفني","technicianFinancial.stats.total":"💼 إجمالي المستحقات","technicianFinancial.stats.paid":"💰 المبالغ المدفوعة","technicianFinancial.stats.outstanding":"🧾 المبلغ المتبقي","technicianFinancial.stats.totalDesc":"مرتبطة بـ {count} مهام","technicianFinancial.stats.paidDesc":"تم تسجيل {count} دفعات","technicianFinancial.stats.outstandingDesc":"المتبقي {amount}","technicianFinancial.actions.viewDetails":"📊 عرض التفاصيل","technicianFinancial.modal.title":"📊 الملخص المالي للفني","technicianFinancial.modal.subtitle":"نظرة تفصيلية على مستحقات العضو والمدفوعات السابقة والحالية.","technicianFinancial.list.title":"تفاصيل الحجوزات والمشاريع","technicianFinancial.assignments.empty":"لا توجد حجوزات أو مشاريع مرتبطة لعرضها.","technicianFinancial.list.reservation":"الحجز / المشروع","technicianFinancial.list.period":"الفترة","technicianFinancial.list.due":"المستحق","technicianFinancial.list.status":"حالة الدفع","technicianFinancial.list.outstanding":"المتبقي","technicianFinancial.list.settled":"لا يوجد","technicianFinancial.list.reservationFallback":"حجز رقم {id}","technicianFinancial.list.projectReference":"مشروع #{id}","technicianFinancial.status.paid":"مدفوع","technicianFinancial.status.partial":"مدفوع جزئياً","technicianFinancial.status.unpaid":"غير مدفوع","technicianFinancial.payouts.title":"💸 سجل الدفعات الداخلية","technicianFinancial.payouts.helper":"سجّل المبالغ التي تم دفعها لهذا العضو من الشركة لضمان تتبع السداد.","technicianFinancial.payouts.empty":"لا توجد دفعات مسجلة بعد.","technicianFinancial.payouts.form.amount":"💰 المبلغ","technicianFinancial.payouts.form.date":"📅 تاريخ الدفع","technicianFinancial.payouts.form.note":"📝 ملاحظات (اختياري)","technicianFinancial.payouts.form.submit":"💸 تسجيل الدفعة","technicianFinancial.payouts.confirmDelete":"❌ هل تريد حذف هذه الدفعة؟","technicianFinancial.payouts.confirmTitle":"🗑️ حذف الدفعة","technicianFinancial.payouts.confirmMessage":"هل أنت متأكد من حذف هذه الدفعة؟ لا يمكن التراجع عن هذا الإجراء.","technicianFinancial.payouts.confirmCancel":"إلغاء","technicianFinancial.payouts.confirmAccept":"🗑️ حذف","technicianFinancial.payouts.toast.added":"✅ تم تسجيل الدفعة.","technicianFinancial.payouts.toast.removed":"🗑️ تم حذف الدفعة.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ أدخل قيمة صحيحة للمبلغ.","technicianFinancial.payouts.toast.failed":"⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ لا يمكن تحديد عضو الطاقم حالياً.","technicianDetails.filters.search":"🔍 ابحث باسم العميل أو اكتب رقم الحجز (مثل #123) أو المشروع...","technicianDetails.fields.role":"👔 الوظيفة:","technicianDetails.fields.department":"🧩 القسم:","technicianDetails.fields.phone":"📞 الجوال:","technicianDetails.fields.wage":"💰 الأجر اليومي:","technicianDetails.fields.total":"💼 التكلفة الإجمالية:","technicianDetails.fields.baseStatus":"⚙️ الحالة الأساسية:","technicianDetails.fields.notes":"📝 الملاحظات:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"غير محدد","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ لا يوجد معرف عضو طاقم في الرابط.","technicianDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العضو.","technicianDetails.errors.loadFailed":"❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.","technicianDetails.errors.reservationsLoadFailed":"❌ تعذر تحميل حجوزات هذا العضو حالياً.","technicianDetails.status.loading":"⏳ جارٍ تحميل بيانات عضو الطاقم...","technicianDetails.edit.modalTitle":"✏️ تعديل بيانات عضو الطاقم","technicians.picker.actions.apply":"تم","technicianProjects.title":"📁 مشاريع الفني","technicianReservations.title":"📅 حجوزات الفني","technicianProjects.empty":"لا توجد مشاريع مرتبطة بهذا العضو."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"😎 Crew Member Profile","technicianDetails.actions.back":"⬅️ Back","technicianDetails.actions.edit":"✏️ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew member’s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"📅 Technician Reservations","technicianTabs.projects":"📁 Technician Projects","technicianFinancial.stats.total":"💼 Total Due","technicianFinancial.stats.paid":"💰 Paid Amount","technicianFinancial.stats.outstanding":"🧾 Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"📊 View details","technicianFinancial.modal.title":"📊 Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"💸 Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"💰 Amount","technicianFinancial.payouts.form.date":"📅 Payment date","technicianFinancial.payouts.form.note":"📝 Notes (optional)","technicianFinancial.payouts.form.submit":"💸 Record payout","technicianFinancial.payouts.confirmDelete":"❌ Delete this payout?","technicianFinancial.payouts.confirmTitle":"🗑️ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"🗑️ Delete","technicianFinancial.payouts.toast.added":"✅ Payout logged successfully.","technicianFinancial.payouts.toast.removed":"🗑️ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"⚠️ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ Unable to determine the crew member right now.","technicianDetails.filters.search":"🔍 Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"👔 Role:","technicianDetails.fields.department":"🧩 Department:","technicianDetails.fields.phone":"📞 Phone:","technicianDetails.fields.wage":"💰 Daily Rate:","technicianDetails.fields.total":"💼 Total Charge:","technicianDetails.fields.baseStatus":"⚙️ Base Status:","technicianDetails.fields.notes":"📝 Notes:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"⚠️ Crew member not found.","technicianDetails.errors.loadFailed":"❌ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"❌ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"⏳ Loading crew member details...","technicianDetails.edit.modalTitle":"✏️ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"📁 Technician Projects","technicianReservations.title":"📅 Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let vt={},b={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},zt=!1;function At(t=""){return v(String(t)).replace(/[٬،]/g,"").trim().toLowerCase()}function re(t,e,n){if(!e||!n)return;const{startDate:a,endDate:c}=se(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?c?n._flatpickr.setDate(c,!1,"Y-m-d"):n._flatpickr.clear():n.value=c||""}function H(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function le(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!zt){try{await oe({suppressError:!1,force:!0})}catch(f){console.error("❌ [technician-details] Failed to hydrate reservations list",f),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${d("technicianDetails.errors.reservationsLoadFailed","❌ تعذر تحميل حجوزات هذا العضو حالياً.")}</p>`;return}zt=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),c=document.getElementById("technician-filter-end-date"),i=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),r=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),c&&window.flatpickr(c,{dateFormat:"Y-m-d"}));const u=()=>{let f=v(a?.value||"").trim(),A=v(c?.value||"").trim(),D=i?.value||"";if(new Set(["","today","week","month"]).has(D)||(D="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),f="",A=""),!f&&!A&&D){const{startDate:_,endDate:o}=se(D);f=_,A=o}return{searchTerm:At(n?.value||""),startDate:f,endDate:A,status:l?.value||"",quickRange:D,technicianId:t}},h=()=>{vt=u(),$t("technician-reservations",vt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=v(n.value),h()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),h()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{i&&(i.value=""),h()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{re(i.value,a,c),h()}),i.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",h),l.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),i&&(i.value=""),l&&(l.value=""),h()}),r.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{$t("technician-reservations",vt)},h()}function de(t){b.currentId=t;const{container:e}=at();e&&(b.initialized||(Re(),_e(),Ve(),document.addEventListener("projects:changed",()=>{b.currentId&&N()}),document.addEventListener("language:changed",()=>{b.currentId&&N()}),document.addEventListener("customers:changed",()=>{b.currentId&&N()}),document.addEventListener("technicians:updated",()=>{b.currentId&&N()}),b.initialized=!0),N())}function at(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function Re(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:c,rangeSelect:i}=at();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=v(t.value),N()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{i&&(i.value=""),N()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(c,{dateFormat:"Y-m-d"}),c.addEventListener("change",()=>{i&&(i.value=""),N()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{re(i.value,a,c),N()}),i.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{N()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:l,statusSelect:r,startInput:u,endInput:h,rangeSelect:f}=at();l&&(l.value=""),r&&(r.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),h&&(h._flatpickr&&h._flatpickr.clear(),h.value=""),f&&(f.value=""),N()}),n.dataset.listenerAttached="true")}function _e(){const{container:t}=at();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",qe),t.dataset.projectModalListenerAttached="true")}function $e(){const{container:t}=at();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const c=e.dataset.projectId?String(e.dataset.projectId):"";c&&pt(c)}),e.dataset.technicianModalListenerAttached="true")})}function qe(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&pt(a)}function Ve(){Bt()}function Bt(){if(b.modal?.el&&b.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(b.modal={el:t,body:e},!0)}function N(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:c}=at();if(!t||!b.currentId)return;const i=At(e?.value||""),l=n?.value||"",r=a?.value||"",u=c?.value||"",h=r?new Date(`${r}T00:00:00`):null,f=u?new Date(`${u}T23:59:59`):null,{projects:A=[],customers:D=[],technicians:L=[],reservations:$=[]}=Lt(),_=new Map(D.map(s=>[String(s.id),s])),o=new Map(L.map(s=>[String(s.id),s])),m=new Map(A.map(s=>[String(s.id),s])),F=ze($),E=String(b.currentId),S=new Map,V=(s,p=null)=>{if(!s)return;const g=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(g&&!S.has(g)){const y=p??H(s?.technicians);S.set(g,{...s,technicians:y})}};A.forEach(s=>{const p=H(s?.technicians);p.length&&p.includes(E)&&V({...s,technicians:p},p)}),$.forEach(s=>{if(!s?.projectId)return;const p=H(s.technicians);if(!p.includes(E))return;const g=String(s.projectId),y=S.get(g),I=m.get(g),{effectiveConfirmed:w}=qt(s,I??y??null);if(y){const C=H(y.technicians),W=Array.from(new Set([...C,...p]));S.set(g,{...y,technicians:W,confirmed:y.confirmed||w});return}if(I){const C=H(I?.technicians),W=Array.from(new Set([...C,...p]));V({...I,technicians:W,confirmed:qt(s,I).effectiveConfirmed},W);return}V({id:g,title:s.projectTitle||s.title||s.project_title||`#${g}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:p,clientId:s.projectClientId??s.customerId??null,confirmed:w,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},p)});const Q=Array.from(S.values());b.projectsMap=S,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:S,keys:()=>Array.from(S.keys())}});const O=Q.filter(s=>{if(i){const p=_.get(String(s.clientId))?.customerName||"",g=[s.id,s.projectId,s.project_id,s.projectCode,s.project_code,s.reference,s.reference_code,s.code,ft(s)];if(!At([s.title,s.description,p,g.filter(I=>I!=null&&I!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(i))return!1}if(l&&Ke(s)!==l)return!1;if(h||f){const p=s.start||s.createdAt||s.created_at||null,g=s.end||s.projectEnd||s.project_end||null,y=p?new Date(p):null,I=g?new Date(g):y;if(h&&y&&y<h||f&&I&&I>f)return!1}return!0}).sort((s,p)=>{const g=new Date(s.start||s.createdAt||0).getTime();return new Date(p.start||p.createdAt||0).getTime()-g});if(!O.length){const s=d("technicianProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العضو.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=O.map(s=>{const p=ft(s),g=p?F.get(p)||[]:[],y=_.get(String(s.clientId))||null;return xe(s,{customer:y,techniciansMap:o,reservations:g})}).join(""),$e()}function ze(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const c=String(a);e.has(c)||e.set(c,[]),e.get(c).push(n)}),e}function pt(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!Bt())return;const n=b.modal;if(!n?.body)return;const{projects:a=[],reservations:c=[],customers:i=[]}=Lt(),l=b.projectsMap?.get(e)||null;let r=l??Ut(a,e);if(r||(r=Ut(a,e)),!r)return;const u=String(b.currentId||"");let h=H(r.technicians);if(!h.length&&l&&(h=H(l.technicians),r={...l,...r}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:u,normalizedTechnicians:h}}}),u&&!h.includes(u)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:e,activeTechnicianId:u,normalizedTechnicians:h});return}r={...r,technicians:h};const f=i.find(D=>String(D.id)===String(r.clientId))||null,A=c.filter(D=>{const L=Le(D);return L&&L===e});n.body.dataset.mode="view",n.body.innerHTML=je(r,{customer:f,reservations:A}),Ue(r),He(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function Ue(t){if(!t||!b.modal?.body)return;const e=b.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",n=>{n.preventDefault(),Oe(t)})}function He(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const c=ie();let i=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const l=n.dataset.reservationId;l&&(i=c.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(f=>f!=null&&String(f)===l)))}Number.isInteger(i)&&i>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(i):j(d("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),n.dataset.listenerAttached="true")})}function Oe(t){if(!t||!Bt())return;const e=b.modal;if(!e?.body)return;const{customers:n=[]}=Lt(),a=n.find(r=>String(r.id)===String(t.clientId))||null,c=a?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||a?.companyName||a?.company||"",l=Array.isArray(t?.expenses)?t.expenses.map((r,u)=>({id:r?.id||`expense-${t.id}-${u}-${Date.now()}`,label:r?.label||"",amount:Number(r?.amount)||0})):[];e.body.dataset.mode="edit",e.body.innerHTML=Pe(t,{clientName:c,clientCompany:i}),We(t,{clientName:c,clientCompany:i,expenses:l})}function We(t,{clientName:e="",clientCompany:n="",expenses:a=[]}={}){const c={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},i=b.modal?.body?.querySelector("#project-details-edit-form");if(!i)return;const l=i.querySelector('[data-action="cancel-edit"]');l&&l.addEventListener("click",o=>{o.preventDefault(),pt(t.id)});const r=i.querySelector("#project-edit-expense-label"),u=i.querySelector("#project-edit-expense-amount"),h=i.querySelector('[data-action="add-expense"]'),f=i.querySelector("#project-edit-expense-list"),A=i.querySelector('[name="project-start-date"]'),D=i.querySelector('[name="project-start-time"]'),L=i.querySelector('[name="project-end-date"]'),$=i.querySelector('[name="project-end-time"]');function _(){f&&(f.innerHTML=Me(c.expenses))}_(),h&&h.addEventListener("click",o=>{o.preventDefault();const m=r?.value.trim()||"",F=v(u?.value||"0"),E=Number(F);if(!m){j(d("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),r?.focus();return}if(!Number.isFinite(E)||E<=0){j(d("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),u?.focus();return}c.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:m,amount:E}),r&&(r.value=""),u&&(u.value=""),_()}),f&&f.addEventListener("click",o=>{const m=o.target.closest('[data-action="remove-expense"]');if(!m)return;const{id:F}=m.dataset;c.expenses=c.expenses.filter(E=>String(E.id)!==String(F)),_()}),i.addEventListener("submit",async o=>{if(o.preventDefault(),i.dataset.submitting==="true")return;const m=i.querySelector('[name="project-title"]'),F=i.querySelector('[name="project-type"]'),E=i.querySelector('[name="project-description"]'),S=i.querySelector('[name="project-payment-status"]'),V=i.querySelector('[name="project-apply-tax"]'),Q=m?.value.trim()||"",O=F?.value||"",s=A?.value.trim()||"",p=D?.value.trim()||"",g=E?.value.trim()||"",y=S?.value==="paid"?"paid":"unpaid",I=V?.checked===!0;if(!Q||!O||!s){j(d("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),m?.focus();return}const w=L?.value.trim()||"",C=$?.value.trim()||"",W=Vt(s,p),yt=w?Vt(w,C):"";if(yt){const z=new Date(W),K=new Date(yt);if(!Number.isNaN(z.getTime())&&!Number.isNaN(K.getTime())&&z>K){j(d("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),L?.focus();return}}const rt=ft(t);if(!rt){j(d("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const Rt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,pe=Ce({...t,expenses:c.expenses}),bt=Number((Rt+pe).toFixed(2)),_t=I?Number((bt*Be).toFixed(2)):0,ge=I?Number((bt+_t).toFixed(2)):bt,ye=Te({projectCode:t.projectCode,title:Q,type:O,clientId:t.clientId,clientCompany:c.clientCompany,description:g,start:W,end:yt||null,applyTax:I,paymentStatus:y,equipmentEstimate:Rt,expenses:c.expenses,taxAmount:_t,totalWithTax:ge,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),R=i.querySelector('button[type="submit"]');R&&(R.disabled=!0,R.dataset.originalText=R.textContent||"",R.textContent=d("projects.details.edit.saving","جاري الحفظ...")),i.dataset.submitting="true";try{const z=await ke(rt,ye);await Ne(rt,y),document.dispatchEvent(new CustomEvent("projects:changed")),j(d("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),N();const K=ft(z)||rt;K&&pt(K)}catch(z){console.error("❌ [technicianDetails] Failed to update project from modal",z);const K=typeof z?.message=="string"?z.message:d("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");j(K)}finally{delete i.dataset.submitting,R&&(R.disabled=!1,R.dataset.originalText&&(R.textContent=R.dataset.originalText,delete R.dataset.originalText))}})}function Ut(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(i=>i!=null&&String(i)===n))||null}function Ke(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}async function Ye(t,{signal:e}={}){const n=new URLSearchParams;t&&n.set("technician_id",t);const a=n.toString(),c=await jt(`/technician-payouts/${a?`?${a}`:""}`,{signal:e});return Array.isArray(c?.data)?c.data:[]}async function Ge({technicianId:t,amount:e,note:n,paidAt:a}){return(await jt("/technician-payouts/",{method:"POST",body:{technician_id:t,amount:e,note:n,paid_at:a}}))?.data??null}async function Qe(t){return(await jt(`/technician-payouts/?id=${encodeURIComponent(t)}`,{method:"DELETE"}))?.data??null}ve();De();we();const Je=new URLSearchParams(window.location.search),x=Je.get("id"),q=document.getElementById("technician-details"),Ht=document.getElementById("technician-hero-name"),Xe=document.getElementById("technician-hero-status"),Ot=document.getElementById("technician-hero-role"),lt=document.getElementById("dashboard-greeting-technician-name"),it=document.getElementById("dashboard-greeting-technician-role"),Ze=document.getElementById("dashboard-greeting-technician-status"),Wt=document.getElementById("dashboard-greeting-technician-role-badge"),Kt=document.getElementById("sidebar-stat-projects"),Yt=document.getElementById("sidebar-stat-reservations"),Gt=document.getElementById("sidebar-stat-equipment"),Qt=document.getElementById("sidebar-stat-technicians"),B={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},k=document.getElementById("technician-financial-modal"),dt=document.getElementById("technician-financial-open"),Jt=document.getElementById("technician-financial-modal-total"),Xt=document.getElementById("technician-financial-modal-paid"),Zt=document.getElementById("technician-financial-modal-outstanding"),Dt=document.getElementById("technician-financial-modal-empty"),Et=document.getElementById("technician-financial-modal-table-wrapper"),It=document.getElementById("technician-financial-modal-rows"),tn=Array.from(document.querySelectorAll("[data-financial-modal-close]")),X=document.getElementById("technician-payout-form"),T=document.getElementById("technician-payout-amount"),tt=document.getElementById("technician-payout-date"),en=document.getElementById("technician-payout-note"),G=document.getElementById("technician-payouts-list"),wt=document.getElementById("technician-payouts-empty"),et=document.getElementById("technician-payout-confirm-modal"),U=document.getElementById("technician-payout-confirm-yes"),nn=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),St=Array.from(document.querySelectorAll("[data-technician-tab]")),an=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let Nt="reservations",P=null,Y={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Ft=[],gt=null;Ee();function Mt(){return document.documentElement.getAttribute("lang")||"ar"}function ut(t){const e=Number(t)||0,a=Mt()==="ar"?"ar-SA-u-nu-latn":"en-US";try{return new Intl.NumberFormat(a,{maximumFractionDigits:0}).format(e)}catch{return v(String(e))||"0"}}function ct({projects:t=0,reservations:e=0,equipment:n=0,technicians:a=0}={}){Kt&&(Kt.textContent=ut(t)),Yt&&(Yt.textContent=ut(e)),Gt&&(Gt.textContent=ut(n)),Qt&&(Qt.textContent=ut(a))}function cn(t){if(!t||typeof t!="object")return 0;const e=[t.quantity,t.qty,t.count];for(const n of e){if(n==null||n==="")continue;const a=Number(v(String(n)));if(Number.isFinite(a))return a>0?a:0}return 1}function sn(t,e){if(!Array.isArray(t)||!t.length)return{projects:0,reservations:0,equipment:0,technicians:e?1:0};const n=new Set,a=new Set;e&&a.add(String(e));let c=0;return t.forEach(i=>{if(!i)return;i.projectId!=null&&n.add(String(i.projectId)),H(i.technicians).forEach(r=>a.add(r)),Array.isArray(i.items)&&i.items.forEach(r=>{c+=cn(r)})}),{projects:n.size,reservations:t.length,equipment:c,technicians:a.size||(e?1:0)}}function M(t){const e=Number(t)||0,a=Mt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const c=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${v(c)} SR`}catch{const i=Math.round(e);return`${v(String(i))} SR`}}function Tt(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const a=Mt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),r=e.getFullYear();return`${i}/${l}/${r}`}}function nt(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function te(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(v(String(n)));if(Number.isFinite(a))return a}return 0}function on(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="technician-payment-badge technician-payment-badge--unpaid";return e==="paid"?(n="technicianFinancial.status.paid",a="technician-payment-badge technician-payment-badge--paid"):e==="partial"&&(n="technicianFinancial.status.partial",a="technician-payment-badge technician-payment-badge--partial"),`<span class="${a}" data-i18n data-i18n-key="${n}">${d(n,n)}</span>`}function ee(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),c=Number(n.payoutsCount??0),i=d("technicianFinancial.stats.totalDesc","مرتبطة بـ {count} مهام").replace("{count}",v(String(a))),l=d("technicianFinancial.stats.paidDesc","{count} دفعات مسجلة").replace("{count}",v(String(c))),r=d("technicianFinancial.stats.outstandingDesc","المتبقي {amount}"),u=e.outstanding>0?r.replace("{amount}",M(e.outstanding)):"—";B.total&&(B.total.textContent=M(e.total)),B.totalDesc&&(B.totalDesc.textContent=a>0?i:"—"),B.paid&&(B.paid.textContent=M(e.paid)),B.paidDesc&&(B.paidDesc.textContent=c>0?l:"—"),B.outstanding&&(B.outstanding.textContent=M(e.outstanding)),B.outstandingDesc&&(B.outstandingDesc.textContent=u)}function kt(t){const{totals:e,breakdown:n,payouts:a}=t;if(Jt&&(Jt.textContent=M(e.total)),Xt&&(Xt.textContent=M(e.paid)),Zt&&(Zt.textContent=M(e.outstanding)),!(!It||!Et||!Dt)){if(!n.length)It.innerHTML="",Et.classList.add("hidden"),Dt.classList.remove("hidden");else{Dt.classList.add("hidden"),Et.classList.remove("hidden");const c=n.map(i=>{const l=i.period||"—",r=i.outstandingAmount>0?M(i.outstandingAmount):`<span class="text-success">${d("technicianFinancial.list.settled","لا يوجد")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${nt(i.label)}</div>
            <div class="text-xs text-base-content/60">${nt(i.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${nt(l)}</td>
          <td>${M(i.dueAmount)}</td>
          <td>${on(i.paidStatus)}</td>
          <td>${r}</td>
        </tr>
      `}).join("");It.innerHTML=c}rn(a)}}function rn(t=[]){if(!G||!wt)return;if(!Array.isArray(t)||t.length===0){G.innerHTML="",wt.classList.remove("hidden");return}const e=t.map(n=>{const a=M(n.amount||0),c=Tt(n.paidAt||n.createdAt),i=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${nt(n.note)}</p>`:"",l=d("actions.delete","🗑️ حذف");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${nt(c)}</span>
          </div>
          ${i}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${nt(n.id)}" data-i18n data-i18n-key="actions.delete">${l}</button>
      </li>
    `}).join("");G.innerHTML=e,wt.classList.add("hidden")}function ue(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function ln(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function dn(t){const e=v(String(t??""));if(!e)return"";const c=e.replace(/[٬،]/g,"").replace(/[٫,]/g,".").replace(/[^0-9.]/g,"").split("."),i=c[0]||"",l=c.length>1?c.slice(1).join(""):"",r=i.replace(/^0+(\d)/,"$1"),u=r.length?r:l?"0":"",h=l?l.replace(/\D/g,"").slice(0,2):"";return h?`${u}.${h}`:u}function un(t){if(t.preventDefault(),!x){j(d("technicianFinancial.payouts.toast.invalidTechnician","⚠️ لا يمكن تحديد عضو الطاقم حالياً."));return}const e=T?.value??"",n=Number.parseFloat(v(String(e)));if(!Number.isFinite(n)||n<=0){j(d("technicianFinancial.payouts.toast.invalidAmount","⚠️ أدخل قيمة صحيحة للمبلغ.")),T?.focus();return}const a=en?.value?.trim()||"",c=ln(tt?.value||null),i=X?.querySelector('button[type="submit"]');i&&(i.disabled=!0),Ge({technicianId:x,amount:Number(n.toFixed(2)),note:a,paidAt:c.toISOString()}).then(l=>{j(d("technicianFinancial.payouts.toast.added","✅ تم تسجيل الدفعة.")),X?.reset(),tt&&(tt.value=ue(l?.paidAt||new Date)),P&&ot(P)}).catch(l=>{console.error("❌ [technician-page] Failed to create technician payout",l);const r=l?.message||d("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.");j(r)}).finally(()=>{i&&(i.disabled=!1)})}function mn(t){t&&fn(t)}function hn(){k&&(k.classList.remove("hidden"),k.classList.add("show"),k.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),tt&&!tt.value&&(tt.value=ue(new Date)))}function Ct(){k&&(k.classList.remove("show"),k.classList.remove("modal-open"),k.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function fn(t){et&&(gt=t||null,et.classList.remove("hidden"),et.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function xt(){et&&(et.classList.remove("show","modal-open"),et.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),gt=null,U&&(U.disabled=!1))}function me(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function pn(t){if(t.preventDefault(),!P)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...P}}))}catch(a){console.error("⚠️ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function he(){me().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",pn),t.dataset.listenerAttached="true")})}async function ot(t){if(Y={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},ee(Y),kt(Y),ct(),!x||!t)return;try{await oe({suppressError:!0})}catch(o){console.error("⚠️ [technician-page] Failed to load reservations for financial summary",o)}const n=ie(),a=String(x);try{const o=await Ye(a);Ft=Array.isArray(o)?o:[]}catch(o){console.error("⚠️ [technician-page] Failed to load technician payouts from API",o),Ft=[]}const c=n.filter(o=>!o||String(o.status||"").toLowerCase()==="cancelled"?!1:(Array.isArray(o.technicians)?o.technicians.map(F=>String(F)):[]).includes(a)),i=sn(c,a);ct(i);const l=c.map((o,m)=>{const F=Array.isArray(o.techniciansDetails)?o.techniciansDetails.find(w=>{const C=w?.id??w?.technician_id??w?.technicianId??w?.ID;return C!=null&&String(C)===a}):null,E=te(F)||te(t),S=Math.max(1,Ae(o.start,o.end)),V=Math.max(0,Math.round(E*S)),Q=d("technicianFinancial.list.reservationFallback","حجز رقم {id}").replace("{id}",v(String(o.reservationId||o.id||"?"))),O=o.title&&o.title.trim().length?o.title.trim():Q,s=[];if(o.reservationId||o.id){const w=o.reservationId||o.id;s.push(`#${v(String(w))}`)}if(o.projectId&&s.push(d("technicianFinancial.list.projectReference","مشروع #{id}").replace("{id}",v(String(o.projectId)))),o.status){const w=`reservations.status.${o.status}`;s.push(d(w,o.status))}const p=Tt(o.start),g=Tt(o.end),y=p===g?p:`${p} – ${g}`,I=(()=>{const w=o.start||o.startDatetime||o.createdAt||o.created_at,C=w?new Date(w).getTime():NaN;return Number.isNaN(C)?m:C})();return{label:O,reference:s.join(" • ")||"—",period:y,dueAmount:V,paidAmount:0,outstandingAmount:V,paidStatus:"unpaid",sortKey:I,originalIndex:m}}),r=Ft.map(o=>({...o,amount:Number(o.amount)||0}));let u=r.reduce((o,m)=>o+m.amount,0);const f=[...l].sort((o,m)=>o.sortKey===m.sortKey?o.originalIndex-m.originalIndex:o.sortKey-m.sortKey).map(o=>{const m={...o},F=Number(o.dueAmount)||0,E=Math.min(F,Math.max(0,Number(u.toFixed(2))));E>0&&(u=Number((u-E).toFixed(2))),m.paidAmount=Number(E.toFixed(2));const S=Math.max(0,Number((F-E).toFixed(2)));return m.outstandingAmount=S,S<=.009?(m.paidStatus="paid",m.outstandingAmount=0):E>0?m.paidStatus="partial":m.paidStatus="unpaid",m}).sort((o,m)=>o.originalIndex-m.originalIndex).map(({sortKey:o,originalIndex:m,...F})=>F),A=f.reduce((o,m)=>o+m.dueAmount,0),D=r.reduce((o,m)=>o+(Number(m.amount)||0),0),L=Math.max(0,Number((A-D).toFixed(2))),$={total:Math.max(0,Number(A.toFixed(2))),paid:Math.max(0,Number(D.toFixed(2))),outstanding:L},_={assignments:f.length,payoutsCount:r.length,outstandingAmount:L};Y={totals:$,metrics:_,breakdown:f,payouts:r},ee(Y),kt(Y)}function J(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const c=n==null?"":String(n).trim(),i=c.length>0;t.textContent=i?`${e} ${c}`:`${e} —`,a?t.classList.toggle("hidden",!i):i||t.classList.remove("hidden")}function ne(t){const e=[Xe,Ze].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(r=>{r.className="technician-badge hidden",r.textContent="—"});return}const a=n==="busy",c=["technician-badge"];c.push(a?"technician-badge--status-busy":"technician-badge--status-available");const i=a?"technicians.status.busy":"technicians.status.available",l=a?"⛔ مشغول":"✅ متاح";e.forEach(r=>{r.className=c.join(" "),r.classList.remove("hidden"),r.setAttribute("data-i18n",""),r.setAttribute("data-i18n-key",i),r.textContent=d(i,l)})}function Z(t){if(!t){J(Ht,"😎","—"),J(Ot,"🎯","",{hideWhenEmpty:!0}),lt&&(lt.textContent="—"),it&&(it.textContent="—"),J(Wt,"🎯","",{hideWhenEmpty:!0}),ne(null);return}if(J(Ht,"😎",t.name||"—"),J(Ot,"🎯",t.role||"",{hideWhenEmpty:!0}),lt&&(lt.textContent=t.name||"—"),it){const e=t.role?t.role:"";if(e)it.textContent=`🎯 ${e}`;else{const n=d("technicianDetails.fallback.role","غير محدد");it.textContent=`🎯 ${n}`}}J(Wt,"🎯",t.role||"",{hideWhenEmpty:!0}),ne(t.status||t.baseStatus||"available")}function st(t){me().forEach(e=>{e.disabled=!!t})}function ht(t){t&&(Nt=t,St.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),an.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&x&&de(x),t==="reservations"&&x&&le(x))}function gn(){St.length&&(St.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&ht(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&ht(n)}),t.dataset.listenerAttached="true")}),ht(Nt))}Z(null);st(!0);gn();he();dt&&!dt.dataset.listenerAttached&&(dt.addEventListener("click",()=>{kt(Y),hn()}),dt.dataset.listenerAttached="true");tn.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{Ct()}),t.dataset.listenerAttached="true")});X&&!X.dataset.listenerAttached&&(X.addEventListener("submit",un),X.dataset.listenerAttached="true");G&&!G.dataset.listenerAttached&&(G.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");mn(n)}),G.dataset.listenerAttached="true");if(T&&!T.dataset.normalizerAttached){const t=()=>{const e=dn(T.value);if(e!==T.value){const n=e.length;T.value=e,T.setSelectionRange&&T.setSelectionRange(n,n)}};T.addEventListener("input",t),T.addEventListener("blur",()=>{if(t(),T.value){const e=Number.parseFloat(T.value);Number.isFinite(e)&&(T.value=e.toFixed(2))}}),T.dataset.normalizerAttached="true"}nn.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",xt),t.dataset.listenerAttached="true")});U&&!U.dataset.listenerAttached&&(U.addEventListener("click",()=>{if(!gt){xt();return}U.disabled=!0,Qe(gt).then(()=>{j(d("technicianFinancial.payouts.toast.removed","🗑️ تم حذف الدفعة.")),xt(),P&&ot(P)}).catch(t=>{console.error("❌ [technician-page] Failed to remove technician payout",t);const e=t?.message||d("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.");j(e),U.disabled=!1})}),U.dataset.listenerAttached="true");k&&!k.dataset.listenerAttached&&(k.addEventListener("click",t=>{t.target===k&&Ct()}),k.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&k&&k.classList.contains("modal-open")&&Ct()});window.showReservationDetails=Se;const mt=document.getElementById("logout-btn");mt&&!mt.dataset.listenerAttached&&(mt.addEventListener("click",()=>Ie()),mt.dataset.listenerAttached="true");function yn(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function bn(t){const e=Number(t??0);if(!Number.isFinite(e)||e<=0)return"";const n=d("technicians.badge.perDay","/اليوم");return`${M(e)} ${n}`}function ae(t){const e=Number(t??0);return!Number.isFinite(e)||e<=0?"":M(e)}function fe(t){if(!q)return;if(Z(t),!t){q.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,st(!0);return}const e=t.phone?v(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${d("reservations.details.technicians.phoneUnknown","غير متوفر")}</span>`,n=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${d("technicianDetails.fallback.role","غير محدد")}</span>`,a=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${d("technicianDetails.fallback.department","—")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${d("technicianDetails.fallback.notes","—")}</span>`,l=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${d("reservations.create.summary.currency","SR")}</span>`,r=bn(t.dailyWage)||`${yn(t.dailyWage)} ${l}`,u=ae(t.dailyTotal),h=r,f=u||ae(t.dailyWage)||r;console.debug("[technician] amounts",{id:t.id,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,wageValue:h,totalValue:f});const D=[{key:"technicianDetails.fields.role",value:n},{key:"technicianDetails.fields.department",value:a},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.wage",value:h},{key:"technicianDetails.fields.total",value:f||`0 ${l}`},{key:"technicianDetails.fields.notes",value:c}].map(({key:L,value:$})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${L}">${d(L)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${$}</p>
    </article>
  `).join("");q.innerHTML=D,he(),st(!1),ht(Nt)}async function vn(){if(!q)return;if(!x){Z(null),ct(),st(!0),P=null,q.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${d("technicianDetails.errors.missingId","⚠️ لا يوجد معرف عضو طاقم في الرابط.")}</p>`;return}q.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${d("technicianDetails.status.loading","⏳ جارٍ تحميل بيانات عضو الطاقم...")}</p>`,st(!0),Z(null);let t=null,e=null;try{await Fe(),Pt()}catch(n){e=n,console.error("❌ [technician-details] Failed to refresh technician from API",n)}if(t=ce(x),!t){e?q.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${d("technicianDetails.errors.loadFailed","❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.")}</p>`:q.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,Z(null),ct(),P=null;return}if(!t){q.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,Z(null),ct(),P=null;return}P=t,await ot(t),fe(t),le(x),de(x)}Pt();vn();const Dn=async()=>{if(!x)return;Pt();const t=ce(x);t&&(P=t,await ot(t),fe(t))};window.addEventListener("technicians:updated",Dn);const En=()=>{!x||!P||ot(P)};document.addEventListener("reservations:changed",En,{passive:!0});
