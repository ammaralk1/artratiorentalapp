import{x as Pe,t as l,n as _,e as te,h as P,a as Be,c as _e,i as Me,l as Re}from"./auth.js";import"./dashboard2.js";import"./projects2.js";/* empty css   */import{e as Ne,r as le,g as Ce,k as Fe,l as qe,s as ve,p as J,q as $e}from"./projectsService.js";import{r as de,a as De,s as He}from"./controller.js";import"./events.js";import{g as X,b as Ue,e as Ve,a as ze,c as Oe,d as ue,P as We,s as Ge,f as Ye}from"./projectFocusTemplates.js";import{c as Ke}from"./projectsCommon.js";import{i as Qe}from"./dashboardShell.js";Pe({ar:{"technicianDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.title":"ğŸ˜ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","technicianDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.hero.subtitle":"Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø§Ø· Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… ÙˆÙ…Ù‡Ø§Ù…Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianDetails.hero.helper":"Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù….","technicianDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²...","technicianDetails.fields.role":"ğŸ‘” Ø§Ù„ÙˆØ¸ÙŠÙØ©:","technicianDetails.fields.department":"ğŸ§© Ø§Ù„Ù‚Ø³Ù…:","technicianDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","technicianDetails.fields.wage":"ğŸ’° Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:","technicianDetails.fields.baseStatus":"âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:","technicianDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"ØºÙŠØ± Ù…Ø­Ø¯Ø¯","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","technicianDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.","technicianDetails.errors.loadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.","technicianDetails.errors.reservationsLoadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...","technicianDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicians.picker.actions.apply":"ØªÙ…","technicianProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ø§Ù‚Ù…","technicianProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"ğŸ˜ Crew Member Profile","technicianDetails.actions.back":"â¬…ï¸ Back","technicianDetails.actions.edit":"âœï¸ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew memberâ€™s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianDetails.filters.search":"ğŸ” Search by client or reservation ID...","technicianDetails.fields.role":"ğŸ‘” Role:","technicianDetails.fields.department":"ğŸ§© Department:","technicianDetails.fields.phone":"ğŸ“ Phone:","technicianDetails.fields.wage":"ğŸ’° Daily Rate:","technicianDetails.fields.baseStatus":"âš™ï¸ Base Status:","technicianDetails.fields.notes":"ğŸ“ Notes:","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"âš ï¸ Crew member not found.","technicianDetails.errors.loadFailed":"âŒ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"âŒ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"â³ Loading crew member details...","technicianDetails.edit.modalTitle":"âœï¸ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"ğŸ“ Crew Projects","technicianProjects.empty":"No projects are linked to this crew member."}});let Q={},f={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},me=!1;function Z(e=""){return _(String(e)).trim().toLowerCase()}function Je(e,t,n){if(!t||!n)return;const{startDate:a,endDate:c}=De(e);t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a||"",n._flatpickr?c?n._flatpickr.setDate(c,!1,"Y-m-d"):n._flatpickr.clear():n.value=c||""}function R(e){if(!Array.isArray(e))return[];const t=new Set;return e.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||t.has(n)?!1:(t.add(n),!0))}async function we(e){const t=document.getElementById("technician-reservations");if(!t)return;if(!me){try{await Ne({suppressError:!1,force:!0})}catch(h){console.error("âŒ [technician-details] Failed to hydrate reservations list",h),t.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${l("technicianDetails.errors.reservationsLoadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.")}</p>`;return}me=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),c=document.getElementById("technician-filter-end-date"),i=document.getElementById("technician-reservation-date-range"),d=document.getElementById("technician-reservation-status-filter"),r=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),c&&window.flatpickr(c,{dateFormat:"Y-m-d"}));const m=()=>{let h=_(a?.value||"").trim(),w=_(c?.value||"").trim(),g=i?.value||"";if(new Set(["","today","week","month"]).has(g)||(g="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),h="",w=""),!h&&!w&&g){const{startDate:I,endDate:v}=De(g);h=I,w=v}const y=n?.value||"",b=Z(y);return{searchTerm:b,searchReservationId:b,searchCustomerName:b,startDate:h,endDate:w,status:d?.value||"",quickRange:g,technicianId:e}},u=()=>{Q=m(),de("technician-reservations",Q)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=_(n.value),u()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),u()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{i&&(i.value=""),u()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Je(i.value,a,c),u()}),i.dataset.listenerAttached="true"),d&&!d.dataset.listenerAttached&&(d.addEventListener("change",u),d.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),i&&(i.value=""),d&&(d.value=""),u()}),r.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{de("technician-reservations",Q)},u()}function Ee(e){f.currentId=e;const{container:t}=$();t&&(f.initialized||(Xe(),Ze(),nt(),document.addEventListener("projects:changed",()=>{f.currentId&&S()}),document.addEventListener("language:changed",()=>{f.currentId&&S()}),document.addEventListener("customers:changed",()=>{f.currentId&&S()}),document.addEventListener("technicians:updated",()=>{f.currentId&&S()}),f.initialized=!0),S())}function $(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function Xe(){const{searchInput:e,statusSelect:t,clearBtn:n}=$();e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=_(e.value),S()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{S()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:a,statusSelect:c}=$();a&&(a.value=""),c&&(c.value=""),S()}),n.dataset.listenerAttached="true")}function Ze(){const{container:e}=$();!e||e.dataset.projectModalListenerAttached==="true"||(e.addEventListener("click",tt),e.dataset.projectModalListenerAttached="true")}function et(){const{container:e}=$();e&&e.querySelectorAll(".project-focus-card").forEach(t=>{t.dataset.technicianModalListenerAttached!=="true"&&(t.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const c=t.dataset.projectId?String(t.dataset.projectId):"";c&&W(c)}),t.dataset.technicianModalListenerAttached="true")})}function tt(e){const t=e.target.closest(".project-focus-card");if(!t||(console.debug("[technician] card click",t.dataset.projectId),!t)||e.target.closest("[data-ignore-project-modal]"))return;const a=t.dataset.projectId?String(t.dataset.projectId):"";a&&W(a)}function nt(){ne()}function ne(){if(f.modal?.el&&f.modal?.body)return!0;const e=document.getElementById("projectDetailsModal"),t=document.getElementById("project-details-body");return!e||!t?!1:(f.modal={el:e,body:t},!0)}function S(){const{container:e,searchInput:t,statusSelect:n}=$();if(!e||!f.currentId)return;const a=Z(t?.value||""),c=n?.value||"",{projects:i=[],customers:d=[],technicians:r=[],reservations:m=[]}=te(),u=new Map(d.map(s=>[String(s.id),s])),h=new Map(r.map(s=>[String(s.id),s])),w=new Map(i.map(s=>[String(s.id),s])),g=at(m),E=String(f.currentId),y=new Map,b=(s,o=null)=>{if(!s)return;const p=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(p&&!y.has(p)){const D=o??R(s?.technicians);y.set(p,{...s,technicians:D})}};i.forEach(s=>{const o=R(s?.technicians);o.length&&o.includes(E)&&b({...s,technicians:o},o)}),m.forEach(s=>{if(!s?.projectId)return;const o=R(s.technicians);if(!o.includes(E))return;const p=String(s.projectId),D=y.get(p),A=w.get(p),{effectiveConfirmed:H}=le(s,A??D??null);if(D){const C=R(D.technicians),F=Array.from(new Set([...C,...o]));y.set(p,{...D,technicians:F,confirmed:D.confirmed||H});return}if(A){const C=R(A?.technicians),F=Array.from(new Set([...C,...o]));b({...A,technicians:F,confirmed:le(s,A).effectiveConfirmed},F);return}b({id:p,title:s.projectTitle||s.title||s.project_title||`#${p}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:o,clientId:s.projectClientId??s.customerId??null,confirmed:H,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},o)});const I=Array.from(y.values());f.projectsMap=y,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:y,keys:()=>Array.from(y.keys())}});const v=I.filter(s=>{if(a){const o=u.get(String(s.clientId))?.customerName||"";if(!Z([s.title,s.description,o].filter(Boolean).join(" ")).includes(a))return!1}return!(c&&ot(s)!==c)}).sort((s,o)=>{const p=new Date(s.start||s.createdAt||0).getTime();return new Date(o.start||o.createdAt||0).getTime()-p});if(!v.length){const s=l("technicianProjects.empty",e.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.");e.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}e.innerHTML=v.map(s=>{const o=X(s),p=o?g.get(o)||[]:[],D=u.get(String(s.clientId))||null;return Ue(s,{customer:D,techniciansMap:h,reservations:p})}).join(""),et()}function at(e=[]){const t=new Map;return e.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const c=String(a);t.has(c)||t.set(c,[]),t.get(c).push(n)}),t}function W(e){const t=String(e||"").trim();if(console.debug("[technician] open details",t),!t||!ne())return;const n=f.modal;if(!n?.body)return;const{projects:a=[],reservations:c=[],customers:i=[]}=te(),d=f.projectsMap?.get(t)||null;let r=d??he(a,t);if(r||(r=he(a,t)),!r)return;const m=String(f.currentId||"");let u=R(r.technicians);if(!u.length&&d&&(u=R(d.technicians),r={...d,...r}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:t,activeTechnicianId:m,normalizedTechnicians:u}}}),m&&!u.includes(m)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:t,activeTechnicianId:m,normalizedTechnicians:u});return}r={...r,technicians:u};const h=i.find(g=>String(g.id)===String(r.clientId))||null,w=c.filter(g=>{const E=Ve(g);return E&&E===t});n.body.dataset.mode="view",n.body.innerHTML=ze(r,{customer:h,reservations:w}),it(r),st(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function it(e){if(!e||!f.modal?.body)return;const t=f.modal.body.querySelector('[data-action="edit-project"]');t&&t.addEventListener("click",n=>{n.preventDefault(),ct(e)})}function st(e){if(!e)return;const t=e.querySelectorAll('[data-action="view-reservation"]');t.length&&t.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const c=Ce();let i=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const d=n.dataset.reservationId;d&&(i=c.findIndex(m=>[m?.id,m?.reservationId,m?.reservation_id].some(h=>h!=null&&String(h)===d)))}Number.isInteger(i)&&i>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(i):P(l("projects.details.reservations.viewUnavailable","ØªØ¹Ø°Ø± ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"))}),n.dataset.listenerAttached="true")})}function ct(e){if(!e||!ne())return;const t=f.modal;if(!t?.body)return;const{customers:n=[]}=te(),a=n.find(r=>String(r.id)===String(e.clientId))||null,c=a?.customerName||e.clientName||e.customerName||"",i=e.clientCompany||a?.companyName||a?.company||"",d=Array.isArray(e?.expenses)?e.expenses.map((r,m)=>({id:r?.id||`expense-${e.id}-${m}-${Date.now()}`,label:r?.label||"",amount:Number(r?.amount)||0})):[];t.body.dataset.mode="edit",t.body.innerHTML=Oe(e,{clientName:c,clientCompany:i}),rt(e,{clientName:c,clientCompany:i,expenses:d})}function rt(e,{clientName:t="",clientCompany:n="",expenses:a=[]}={}){const c={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},i=f.modal?.body?.querySelector("#project-details-edit-form");if(!i)return;const d=i.querySelector('[data-action="cancel-edit"]');d&&d.addEventListener("click",I=>{I.preventDefault(),W(e.id)});const r=i.querySelector("#project-edit-expense-label"),m=i.querySelector("#project-edit-expense-amount"),u=i.querySelector('[data-action="add-expense"]'),h=i.querySelector("#project-edit-expense-list"),w=i.querySelector('[name="project-start-date"]'),g=i.querySelector('[name="project-start-time"]'),E=i.querySelector('[name="project-end-date"]'),y=i.querySelector('[name="project-end-time"]');function b(){h&&(h.innerHTML=Ye(c.expenses))}b(),u&&u.addEventListener("click",I=>{I.preventDefault();const v=r?.value.trim()||"",s=_(m?.value||"0"),o=Number(s);if(!v){P(l("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),r?.focus();return}if(!Number.isFinite(o)||o<=0){P(l("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),m?.focus();return}c.expenses.push({id:`expense-${e.id}-${Date.now()}`,label:v,amount:o}),r&&(r.value=""),m&&(m.value=""),b()}),h&&h.addEventListener("click",I=>{const v=I.target.closest('[data-action="remove-expense"]');if(!v)return;const{id:s}=v.dataset;c.expenses=c.expenses.filter(o=>String(o.id)!==String(s)),b()}),i.addEventListener("submit",async I=>{if(I.preventDefault(),i.dataset.submitting==="true")return;const v=i.querySelector('[name="project-title"]'),s=i.querySelector('[name="project-type"]'),o=i.querySelector('[name="project-description"]'),p=i.querySelector('[name="project-payment-status"]'),D=i.querySelector('[name="project-apply-tax"]'),A=v?.value.trim()||"",H=s?.value||"",C=w?.value.trim()||"",F=g?.value.trim()||"",Se=o?.value.trim()||"",ie=p?.value==="paid"?"paid":"unpaid",G=D?.checked===!0;if(!A||!H||!C){P(l("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")),v?.focus();return}const se=E?.value.trim()||"",Ae=y?.value.trim()||"",ce=ue(C,F),Y=se?ue(se,Ae):"";if(Y){const j=new Date(ce),M=new Date(Y);if(!Number.isNaN(j.getTime())&&!Number.isNaN(M.getTime())&&j>M){P(l("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©")),E?.focus();return}}const V=X(e);if(!V){P(l("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const re=Number(e?.equipmentEstimate??e?.equipment_estimate??0)||0,je=Ke({...e,expenses:c.expenses}),K=Number((re+je).toFixed(2)),oe=G?Number((K*We).toFixed(2)):0,xe=G?Number((K+oe).toFixed(2)):K,Le=Fe({projectCode:e.projectCode,title:A,type:H,clientId:e.clientId,clientCompany:c.clientCompany,description:Se,start:ce,end:Y||null,applyTax:G,paymentStatus:ie,equipmentEstimate:re,expenses:c.expenses,taxAmount:oe,totalWithTax:xe,confirmed:e.confirmed,technicians:Array.isArray(e?.technicians)?e.technicians:[],equipment:Array.isArray(e?.equipment)?e.equipment:[]}),k=i.querySelector('button[type="submit"]');k&&(k.disabled=!0,k.dataset.originalText=k.textContent||"",k.textContent=l("projects.details.edit.saving","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...")),i.dataset.submitting="true";try{const j=await qe(V,Le);await Ge(V,ie),document.dispatchEvent(new CustomEvent("projects:changed")),P(l("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),S();const M=X(j)||V;M&&W(M)}catch(j){console.error("âŒ [technicianDetails] Failed to update project from modal",j);const M=typeof j?.message=="string"?j.message:l("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(M)}finally{delete i.dataset.submitting,k&&(k.disabled=!1,k.dataset.originalText&&(k.textContent=k.dataset.originalText,delete k.dataset.originalText))}})}function he(e=[],t){const n=String(t);return e.find(a=>[a?.id,a?.projectId,a?.project_id].some(i=>i!=null&&String(i)===n))||null}function ot(e){const t=new Date,n=e.start?new Date(e.start):null,a=e.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}Be();_e();Qe();const lt=new URLSearchParams(window.location.search),T=lt.get("id"),B=document.getElementById("technician-details"),fe=document.getElementById("technician-hero-name"),x=document.getElementById("technician-hero-status"),pe=document.getElementById("technician-hero-role"),ge=document.getElementById("technician-hero-phone"),ye=document.getElementById("technician-hero-department"),ee=Array.from(document.querySelectorAll("[data-technician-tab]")),dt=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(e=>[e.getAttribute("data-technician-tab-panel"),e]));let ae="reservations",N=null;Me();function Ie(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function ut(e){if(e.preventDefault(),!N)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...N}}))}catch(a){console.error("âš ï¸ [technician-page] Failed to prefill technician edit modal",a)}const t=document.getElementById("editTechnicianModal");if(!t||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(t).show()}function ke(){Ie().forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",ut),e.dataset.listenerAttached="true")})}function L(e,t,n,{hideWhenEmpty:a=!1}={}){if(!e)return;const c=n==null?"":String(n).trim(),i=c.length>0;e.textContent=i?`${t} ${c}`:`${t} â€”`,a?e.classList.toggle("hidden",!i):i||e.classList.remove("hidden")}function be(e){if(!x)return;const t=typeof e=="string"?e.toLowerCase():"";if(!t){x.className="badge badge-outline hidden",x.textContent="â€”";return}const n=t==="busy",a=["badge","px-3","py-2","text-sm","font-semibold"];n?a.push("badge-warning"):a.push("badge-success"),x.className=a.join(" "),x.classList.remove("hidden");const c=n?"technicians.status.busy":"technicians.status.available",i=n?"Ù…Ø´ØºÙˆÙ„":"Ù…ØªØ§Ø­";x.setAttribute("data-i18n",""),x.setAttribute("data-i18n-key",c),x.textContent=l(c,i)}function q(e){if(!e){L(fe,"ğŸ˜","â€”"),L(pe,"ğŸ¯","",{hideWhenEmpty:!0}),L(ge,"ğŸ“","",{hideWhenEmpty:!0}),L(ye,"ğŸ¢","",{hideWhenEmpty:!0}),be(null);return}L(fe,"ğŸ˜",e.name||"â€”"),L(pe,"ğŸ¯",e.role||"",{hideWhenEmpty:!0}),L(ge,"ğŸ“",e.phone?_(e.phone):"",{hideWhenEmpty:!0}),L(ye,"ğŸ¢",e.department||"",{hideWhenEmpty:!0}),be(e.status||e.baseStatus||"available")}function U(e){Ie().forEach(t=>{t.disabled=!!e})}function O(e){e&&(ae=e,ee.forEach(t=>{if(!t)return;const n=t.getAttribute("data-technician-tab")===e;t.classList.toggle("tab-active",n),t.classList.toggle("active",n),t.setAttribute("aria-selected",String(n))}),dt.forEach((t,n)=>{t&&t.classList.toggle("hidden",n!==e)}),e==="projects"&&T&&Ee(T),e==="reservations"&&T&&we(T))}function mt(){ee.length&&(ee.forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=e.getAttribute("data-technician-tab");t&&O(t)}),e.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("data-technician-tab-trigger");n&&O(n)}),e.dataset.listenerAttached="true")}),O(ae))}q(null);U(!0);mt();ke();window.showReservationDetails=He;const z=document.getElementById("logout-btn");z&&!z.dataset.listenerAttached&&(z.addEventListener("click",()=>Re()),z.dataset.listenerAttached="true");function ht(e){const t=Number(e??0);return Number.isFinite(t)?t.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function Te(e){if(!B)return;if(q(e),!e){B.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${l("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,U(!0);return}const t=e.phone?_(e.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${l("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±")}</span>`,n=e.role?e.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${l("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯")}</span>`,a=e.department?e.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${l("technicianDetails.fallback.department","â€”")}</span>`,c=e.notes?e.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${l("technicianDetails.fallback.notes","â€”")}</span>`,d=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${l("reservations.create.summary.currency","Ø±ÙŠØ§Ù„")}</span>`,r=`${ht(e.dailyWage)} ${d}`,m=e.baseStatus||e.status||"available",u=m==="busy"?"technicians.status.busy":"technicians.status.available",h=`<span class="badge ${m==="busy"?"badge-warning":"badge-success"}" data-i18n data-i18n-key="${u}">${l(u)}</span>`,g=[{key:"technicianDetails.fields.role",value:n},{key:"technicianDetails.fields.department",value:a},{key:"technicianDetails.fields.phone",value:t},{key:"technicianDetails.fields.wage",value:r},{key:"technicianDetails.fields.baseStatus",value:h},{key:"technicianDetails.fields.notes",value:c}].map(({key:y,value:b})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${y}">${l(y)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${b}</p>
    </article>
  `).join(""),E=l("technicianDetails.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");B.innerHTML=`
    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
      ${g}
    </div>
    <div class="mt-6 flex flex-wrap items-center gap-2">
      <button type="button" class="btn btn-warning" id="edit-technician-btn" data-technician-edit data-i18n data-i18n-key="technicianDetails.actions.edit">${E}</button>
    </div>
  `,ke(),U(!1),O(ae)}async function ft(){if(!B)return;if(!T){q(null),U(!0),N=null,B.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${l("technicianDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}B.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${l("technicianDetails.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...")}</p>`,U(!0),q(null);let e=J(T);if(!e){try{await $e()}catch(t){console.error("âŒ [technician-details] Failed to load technician from API",t),B.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${l("technicianDetails.errors.loadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.")}</p>`,q(null),N=null;return}e=J(T)}if(!e){B.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${l("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,q(null),N=null;return}N=e,Te(e),we(T),Ee(T)}ve();ft();const pt=()=>{if(!T)return;ve();const e=J(T);e&&(N=e,Te(e))};window.addEventListener("technicians:updated",pt);
