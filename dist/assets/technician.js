import{x as pe,t as d,n as E,e as Lt,h as L,b as xt,a as fe,c as ge,i as ye,l as be}from"./auth.js";import{i as ve}from"./dashboardShell.js";import"./projects2.js";/* empty css   */import{e as Zt,r as Rt,g as te,k as De,l as Ee,s as ee,p as wt,q as Ie,t as we}from"./projectsService.js";import{r as Ct,a as ne,s as Ae}from"./controller.js";import"./events.js";import{g as mt,b as Fe,e as Se,a as Te,c as ke,d as _t,P as Le,s as xe,f as je}from"./projectFocusTemplates.js";import{c as Pe}from"./projectsCommon.js";pe({ar:{"technicianDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.title":"ğŸ˜ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","technicianDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.hero.subtitle":"Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø§Ø· Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… ÙˆÙ…Ù‡Ø§Ù…Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianDetails.hero.helper":"Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù….","technicianTabs.reservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianTabs.projects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianFinancial.stats.total":"ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª","technicianFinancial.stats.paid":"ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©","technicianFinancial.stats.outstanding":"ğŸ§¾ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.stats.totalDesc":"Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…","technicianFinancial.stats.paidDesc":"ØªÙ… ØªØ³Ø¬ÙŠÙ„ {count} Ø¯ÙØ¹Ø§Øª","technicianFinancial.stats.outstandingDesc":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„","technicianFinancial.modal.title":"ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„ÙÙ†ÙŠ","technicianFinancial.modal.subtitle":"Ù†Ø¸Ø±Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianFinancial.list.title":"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","technicianFinancial.assignments.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø£Ùˆ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.","technicianFinancial.list.reservation":"Ø§Ù„Ø­Ø¬Ø² / Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","technicianFinancial.list.period":"Ø§Ù„ÙØªØ±Ø©","technicianFinancial.list.due":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","technicianFinancial.list.status":"Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹","technicianFinancial.list.outstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.list.settled":"Ù„Ø§ ÙŠÙˆØ¬Ø¯","technicianFinancial.list.reservationFallback":"Ø­Ø¬Ø² Ø±Ù‚Ù… {id}","technicianFinancial.list.projectReference":"Ù…Ø´Ø±ÙˆØ¹ #{id}","technicianFinancial.status.paid":"Ù…Ø¯ÙÙˆØ¹","technicianFinancial.status.partial":"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹","technicianFinancial.status.unpaid":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹","technicianFinancial.payouts.title":"ğŸ’¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©","technicianFinancial.payouts.helper":"Ø³Ø¬Ù‘Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªÙŠ ØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ø¶Ù…Ø§Ù† ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø¯Ø§Ø¯.","technicianFinancial.payouts.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.","technicianFinancial.payouts.form.amount":"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº","technicianFinancial.payouts.form.date":"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹","technicianFinancial.payouts.form.note":"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","technicianFinancial.payouts.form.submit":"ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmDelete":"âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmMessage":"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.","technicianFinancial.payouts.confirmCancel":"Ø¥Ù„ØºØ§Ø¡","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Ø­Ø°Ù","technicianFinancial.payouts.toast.added":"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.","technicianFinancial.payouts.toast.failed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² (Ù…Ø«Ù„ #123) Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...","technicianDetails.fields.role":"ğŸ‘” Ø§Ù„ÙˆØ¸ÙŠÙØ©:","technicianDetails.fields.department":"ğŸ§© Ø§Ù„Ù‚Ø³Ù…:","technicianDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","technicianDetails.fields.wage":"ğŸ’° Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:","technicianDetails.fields.baseStatus":"âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:","technicianDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"ØºÙŠØ± Ù…Ø­Ø¯Ø¯","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","technicianDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.","technicianDetails.errors.loadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.","technicianDetails.errors.reservationsLoadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...","technicianDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicians.picker.actions.apply":"ØªÙ…","technicianProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianReservations.title":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"ğŸ˜ Crew Member Profile","technicianDetails.actions.back":"â¬…ï¸ Back","technicianDetails.actions.edit":"âœï¸ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew memberâ€™s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"ğŸ“… Technician Reservations","technicianTabs.projects":"ğŸ“ Technician Projects","technicianFinancial.stats.total":"ğŸ’¼ Total Due","technicianFinancial.stats.paid":"ğŸ’° Paid Amount","technicianFinancial.stats.outstanding":"ğŸ§¾ Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š View details","technicianFinancial.modal.title":"ğŸ“Š Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"ğŸ’¸ Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"ğŸ’° Amount","technicianFinancial.payouts.form.date":"ğŸ“… Payment date","technicianFinancial.payouts.form.note":"ğŸ“ Notes (optional)","technicianFinancial.payouts.form.submit":"ğŸ’¸ Record payout","technicianFinancial.payouts.confirmDelete":"âŒ Delete this payout?","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Delete","technicianFinancial.payouts.toast.added":"âœ… Payout logged successfully.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"âš ï¸ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Unable to determine the crew member right now.","technicianDetails.filters.search":"ğŸ” Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"ğŸ‘” Role:","technicianDetails.fields.department":"ğŸ§© Department:","technicianDetails.fields.phone":"ğŸ“ Phone:","technicianDetails.fields.wage":"ğŸ’° Daily Rate:","technicianDetails.fields.baseStatus":"âš™ï¸ Base Status:","technicianDetails.fields.notes":"ğŸ“ Notes:","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"âš ï¸ Crew member not found.","technicianDetails.errors.loadFailed":"âŒ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"âŒ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"â³ Loading crew member details...","technicianDetails.edit.modalTitle":"âœï¸ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"ğŸ“ Technician Projects","technicianReservations.title":"ğŸ“… Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let yt={},v={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},$t=!1;function At(t=""){return E(String(t)).replace(/[Ù¬ØŒ]/g,"").trim().toLowerCase()}function ae(t,e,n){if(!e||!n)return;const{startDate:a,endDate:c}=ne(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?c?n._flatpickr.setDate(c,!1,"Y-m-d"):n._flatpickr.clear():n.value=c||""}function Y(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function ie(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!$t){try{await Zt({suppressError:!1,force:!0})}catch(f){console.error("âŒ [technician-details] Failed to hydrate reservations list",f),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${d("technicianDetails.errors.reservationsLoadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.")}</p>`;return}$t=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),c=document.getElementById("technician-filter-end-date"),i=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),r=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),c&&window.flatpickr(c,{dateFormat:"Y-m-d"}));const h=()=>{let f=E(a?.value||"").trim(),A=E(c?.value||"").trim(),I=i?.value||"";if(new Set(["","today","week","month"]).has(I)||(I="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),f="",A=""),!f&&!A&&I){const{startDate:o,endDate:m}=ne(I);f=o,A=m}return{searchTerm:At(n?.value||""),startDate:f,endDate:A,status:l?.value||"",quickRange:I,technicianId:t}},u=()=>{yt=h(),Ct("technician-reservations",yt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=E(n.value),u()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),u()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{i&&(i.value=""),u()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ae(i.value,a,c),u()}),i.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",u),l.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),i&&(i.value=""),l&&(l.value=""),u()}),r.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{Ct("technician-reservations",yt)},u()}function ce(t){v.currentId=t;const{container:e}=nt();e&&(v.initialized||(Be(),Me(),Ce(),document.addEventListener("projects:changed",()=>{v.currentId&&N()}),document.addEventListener("language:changed",()=>{v.currentId&&N()}),document.addEventListener("customers:changed",()=>{v.currentId&&N()}),document.addEventListener("technicians:updated",()=>{v.currentId&&N()}),v.initialized=!0),N())}function nt(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function Be(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:c,rangeSelect:i}=nt();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=E(t.value),N()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{i&&(i.value=""),N()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(c,{dateFormat:"Y-m-d"}),c.addEventListener("change",()=>{i&&(i.value=""),N()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ae(i.value,a,c),N()}),i.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{N()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:l,statusSelect:r,startInput:h,endInput:u,rangeSelect:f}=nt();l&&(l.value=""),r&&(r.value=""),h&&(h._flatpickr&&h._flatpickr.clear(),h.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),f&&(f.value=""),N()}),n.dataset.listenerAttached="true")}function Me(){const{container:t}=nt();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Re),t.dataset.projectModalListenerAttached="true")}function Ne(){const{container:t}=nt();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const c=e.dataset.projectId?String(e.dataset.projectId):"";c&&ht(c)}),e.dataset.technicianModalListenerAttached="true")})}function Re(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&ht(a)}function Ce(){jt()}function jt(){if(v.modal?.el&&v.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(v.modal={el:t,body:e},!0)}function N(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:c}=nt();if(!t||!v.currentId)return;const i=At(e?.value||""),l=n?.value||"",r=a?.value||"",h=c?.value||"",u=r?new Date(`${r}T00:00:00`):null,f=h?new Date(`${h}T23:59:59`):null,{projects:A=[],customers:I=[],technicians:x=[],reservations:q=[]}=Lt(),o=new Map(I.map(s=>[String(s.id),s])),m=new Map(x.map(s=>[String(s.id),s])),D=new Map(A.map(s=>[String(s.id),s])),F=_e(q),S=String(v.currentId),j=new Map,H=(s,p=null)=>{if(!s)return;const y=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(y&&!j.has(y)){const b=p??Y(s?.technicians);j.set(y,{...s,technicians:b})}};A.forEach(s=>{const p=Y(s?.technicians);p.length&&p.includes(S)&&H({...s,technicians:p},p)}),q.forEach(s=>{if(!s?.projectId)return;const p=Y(s.technicians);if(!p.includes(S))return;const y=String(s.projectId),b=j.get(y),g=D.get(y),{effectiveConfirmed:R}=Rt(s,g??b??null);if(b){const at=Y(b.technicians),O=Array.from(new Set([...at,...p]));j.set(y,{...b,technicians:O,confirmed:b.confirmed||R});return}if(g){const at=Y(g?.technicians),O=Array.from(new Set([...at,...p]));H({...g,technicians:O,confirmed:Rt(s,g).effectiveConfirmed},O);return}H({id:y,title:s.projectTitle||s.title||s.project_title||`#${y}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:p,clientId:s.projectClientId??s.customerId??null,confirmed:R,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},p)});const Q=Array.from(j.values());v.projectsMap=j,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:j,keys:()=>Array.from(j.keys())}});const _=Q.filter(s=>{if(i){const p=o.get(String(s.clientId))?.customerName||"",y=[s.id,s.projectId,s.project_id,s.projectCode,s.project_code,s.reference,s.reference_code,s.code,mt(s)];if(!At([s.title,s.description,p,y.filter(g=>g!=null&&g!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(i))return!1}if(l&&ze(s)!==l)return!1;if(u||f){const p=s.start||s.createdAt||s.created_at||null,y=s.end||s.projectEnd||s.project_end||null,b=p?new Date(p):null,g=y?new Date(y):b;if(u&&b&&b<u||f&&g&&g>f)return!1}return!0}).sort((s,p)=>{const y=new Date(s.start||s.createdAt||0).getTime();return new Date(p.start||p.createdAt||0).getTime()-y});if(!_.length){const s=d("technicianProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=_.map(s=>{const p=mt(s),y=p?F.get(p)||[]:[],b=o.get(String(s.clientId))||null;return Fe(s,{customer:b,techniciansMap:m,reservations:y})}).join(""),Ne()}function _e(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const c=String(a);e.has(c)||e.set(c,[]),e.get(c).push(n)}),e}function ht(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!jt())return;const n=v.modal;if(!n?.body)return;const{projects:a=[],reservations:c=[],customers:i=[]}=Lt(),l=v.projectsMap?.get(e)||null;let r=l??qt(a,e);if(r||(r=qt(a,e)),!r)return;const h=String(v.currentId||"");let u=Y(r.technicians);if(!u.length&&l&&(u=Y(l.technicians),r={...l,...r}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:h,normalizedTechnicians:u}}}),h&&!u.includes(h)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:e,activeTechnicianId:h,normalizedTechnicians:u});return}r={...r,technicians:u};const f=i.find(I=>String(I.id)===String(r.clientId))||null,A=c.filter(I=>{const x=Se(I);return x&&x===e});n.body.dataset.mode="view",n.body.innerHTML=Te(r,{customer:f,reservations:A}),$e(r),qe(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function $e(t){if(!t||!v.modal?.body)return;const e=v.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",n=>{n.preventDefault(),Ue(t)})}function qe(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const c=te();let i=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const l=n.dataset.reservationId;l&&(i=c.findIndex(h=>[h?.id,h?.reservationId,h?.reservation_id].some(f=>f!=null&&String(f)===l)))}Number.isInteger(i)&&i>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(i):L(d("projects.details.reservations.viewUnavailable","ØªØ¹Ø°Ø± ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"))}),n.dataset.listenerAttached="true")})}function Ue(t){if(!t||!jt())return;const e=v.modal;if(!e?.body)return;const{customers:n=[]}=Lt(),a=n.find(r=>String(r.id)===String(t.clientId))||null,c=a?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||a?.companyName||a?.company||"",l=Array.isArray(t?.expenses)?t.expenses.map((r,h)=>({id:r?.id||`expense-${t.id}-${h}-${Date.now()}`,label:r?.label||"",amount:Number(r?.amount)||0})):[];e.body.dataset.mode="edit",e.body.innerHTML=ke(t,{clientName:c,clientCompany:i}),Ve(t,{clientName:c,clientCompany:i,expenses:l})}function Ve(t,{clientName:e="",clientCompany:n="",expenses:a=[]}={}){const c={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},i=v.modal?.body?.querySelector("#project-details-edit-form");if(!i)return;const l=i.querySelector('[data-action="cancel-edit"]');l&&l.addEventListener("click",m=>{m.preventDefault(),ht(t.id)});const r=i.querySelector("#project-edit-expense-label"),h=i.querySelector("#project-edit-expense-amount"),u=i.querySelector('[data-action="add-expense"]'),f=i.querySelector("#project-edit-expense-list"),A=i.querySelector('[name="project-start-date"]'),I=i.querySelector('[name="project-start-time"]'),x=i.querySelector('[name="project-end-date"]'),q=i.querySelector('[name="project-end-time"]');function o(){f&&(f.innerHTML=je(c.expenses))}o(),u&&u.addEventListener("click",m=>{m.preventDefault();const D=r?.value.trim()||"",F=E(h?.value||"0"),S=Number(F);if(!D){L(d("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),r?.focus();return}if(!Number.isFinite(S)||S<=0){L(d("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),h?.focus();return}c.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:D,amount:S}),r&&(r.value=""),h&&(h.value=""),o()}),f&&f.addEventListener("click",m=>{const D=m.target.closest('[data-action="remove-expense"]');if(!D)return;const{id:F}=D.dataset;c.expenses=c.expenses.filter(S=>String(S.id)!==String(F)),o()}),i.addEventListener("submit",async m=>{if(m.preventDefault(),i.dataset.submitting==="true")return;const D=i.querySelector('[name="project-title"]'),F=i.querySelector('[name="project-type"]'),S=i.querySelector('[name="project-description"]'),j=i.querySelector('[name="project-payment-status"]'),H=i.querySelector('[name="project-apply-tax"]'),Q=D?.value.trim()||"",_=F?.value||"",s=A?.value.trim()||"",p=I?.value.trim()||"",y=S?.value.trim()||"",b=j?.value==="paid"?"paid":"unpaid",g=H?.checked===!0;if(!Q||!_||!s){L(d("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")),D?.focus();return}const R=x?.value.trim()||"",at=q?.value.trim()||"",O=_t(s,p),ft=R?_t(R,at):"";if(ft){const U=new Date(O),W=new Date(ft);if(!Number.isNaN(U.getTime())&&!Number.isNaN(W.getTime())&&U>W){L(d("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©")),x?.focus();return}}const ot=mt(t);if(!ot){L(d("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const Mt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,ue=Pe({...t,expenses:c.expenses}),gt=Number((Mt+ue).toFixed(2)),Nt=g?Number((gt*Le).toFixed(2)):0,me=g?Number((gt+Nt).toFixed(2)):gt,he=De({projectCode:t.projectCode,title:Q,type:_,clientId:t.clientId,clientCompany:c.clientCompany,description:y,start:O,end:ft||null,applyTax:g,paymentStatus:b,equipmentEstimate:Mt,expenses:c.expenses,taxAmount:Nt,totalWithTax:me,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),C=i.querySelector('button[type="submit"]');C&&(C.disabled=!0,C.dataset.originalText=C.textContent||"",C.textContent=d("projects.details.edit.saving","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...")),i.dataset.submitting="true";try{const U=await Ee(ot,he);await xe(ot,b),document.dispatchEvent(new CustomEvent("projects:changed")),L(d("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),N();const W=mt(U)||ot;W&&ht(W)}catch(U){console.error("âŒ [technicianDetails] Failed to update project from modal",U);const W=typeof U?.message=="string"?U.message:d("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");L(W)}finally{delete i.dataset.submitting,C&&(C.disabled=!1,C.dataset.originalText&&(C.textContent=C.dataset.originalText,delete C.dataset.originalText))}})}function qt(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(i=>i!=null&&String(i)===n))||null}function ze(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}async function He(t,{signal:e}={}){const n=new URLSearchParams;t&&n.set("technician_id",t);const a=n.toString(),c=await xt(`/technician-payouts/${a?`?${a}`:""}`,{signal:e});return Array.isArray(c?.data)?c.data:[]}async function Oe({technicianId:t,amount:e,note:n,paidAt:a}){return(await xt("/technician-payouts/",{method:"POST",body:{technician_id:t,amount:e,note:n,paid_at:a}}))?.data??null}async function We(t){return(await xt(`/technician-payouts/?id=${encodeURIComponent(t)}`,{method:"DELETE"}))?.data??null}fe();ge();ve();const Ke=new URLSearchParams(window.location.search),w=Ke.get("id"),z=document.getElementById("technician-details"),Ut=document.getElementById("technician-hero-name"),Ye=document.getElementById("technician-hero-status"),Vt=document.getElementById("technician-hero-role"),zt=document.getElementById("technician-hero-phone"),Ht=document.getElementById("technician-hero-department"),rt=document.getElementById("dashboard-greeting-technician-name"),it=document.getElementById("dashboard-greeting-technician-role"),Ge=document.getElementById("dashboard-greeting-technician-status"),Ot=document.getElementById("dashboard-greeting-technician-phone"),Wt=document.getElementById("dashboard-greeting-technician-department"),B={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},k=document.getElementById("technician-financial-modal"),lt=document.getElementById("technician-financial-open"),Kt=document.getElementById("technician-financial-modal-total"),Yt=document.getElementById("technician-financial-modal-paid"),Gt=document.getElementById("technician-financial-modal-outstanding"),bt=document.getElementById("technician-financial-modal-empty"),vt=document.getElementById("technician-financial-modal-table-wrapper"),Dt=document.getElementById("technician-financial-modal-rows"),Qe=Array.from(document.querySelectorAll("[data-financial-modal-close]")),J=document.getElementById("technician-payout-form"),T=document.getElementById("technician-payout-amount"),Z=document.getElementById("technician-payout-date"),Je=document.getElementById("technician-payout-note"),G=document.getElementById("technician-payouts-list"),Et=document.getElementById("technician-payouts-empty"),tt=document.getElementById("technician-payout-confirm-modal"),V=document.getElementById("technician-payout-confirm-yes"),Xe=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),Ft=Array.from(document.querySelectorAll("[data-technician-tab]")),Ze=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let Pt="reservations",P=null,K={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},It=[],pt=null;ye();function se(){return document.documentElement.getAttribute("lang")||"ar"}function $(t){const e=Number(t)||0,a=se()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const c=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${E(c)} SR`}catch{const i=Math.round(e);return`${E(String(i))} SR`}}function St(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const a=se()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),r=e.getFullYear();return`${i}/${l}/${r}`}}function et(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Qt(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(E(String(n)));if(Number.isFinite(a))return a}return 0}function tn(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="badge badge-outline badge-warning";return e==="paid"?(n="technicianFinancial.status.paid",a="badge badge-success"):e==="partial"&&(n="technicianFinancial.status.partial",a="badge badge-info"),`<span class="${a}">${d(n,n)}</span>`}function Jt(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),c=Number(n.payoutsCount??0),i=d("technicianFinancial.stats.totalDesc","Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…").replace("{count}",E(String(a))),l=d("technicianFinancial.stats.paidDesc","{count} Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©").replace("{count}",E(String(c))),r=d("technicianFinancial.stats.outstandingDesc","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}"),h=e.outstanding>0?r.replace("{amount}",$(e.outstanding)):"â€”";B.total&&(B.total.textContent=$(e.total)),B.totalDesc&&(B.totalDesc.textContent=a>0?i:"â€”"),B.paid&&(B.paid.textContent=$(e.paid)),B.paidDesc&&(B.paidDesc.textContent=c>0?l:"â€”"),B.outstanding&&(B.outstanding.textContent=$(e.outstanding)),B.outstandingDesc&&(B.outstandingDesc.textContent=h)}function Tt(t){const{totals:e,breakdown:n,payouts:a}=t;if(Kt&&(Kt.textContent=$(e.total)),Yt&&(Yt.textContent=$(e.paid)),Gt&&(Gt.textContent=$(e.outstanding)),!(!Dt||!vt||!bt)){if(!n.length)Dt.innerHTML="",vt.classList.add("hidden"),bt.classList.remove("hidden");else{bt.classList.add("hidden"),vt.classList.remove("hidden");const c=n.map(i=>{const l=i.period||"â€”",r=i.outstandingAmount>0?$(i.outstandingAmount):`<span class="text-success">${d("technicianFinancial.list.settled","Ù„Ø§ ÙŠÙˆØ¬Ø¯")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${et(i.label)}</div>
            <div class="text-xs text-base-content/60">${et(i.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${et(l)}</td>
          <td>${$(i.dueAmount)}</td>
          <td>${tn(i.paidStatus)}</td>
          <td>${r}</td>
        </tr>
      `}).join("");Dt.innerHTML=c}en(a)}}function en(t=[]){if(!G||!Et)return;if(!Array.isArray(t)||t.length===0){G.innerHTML="",Et.classList.remove("hidden");return}const e=t.map(n=>{const a=$(n.amount||0),c=St(n.paidAt||n.createdAt),i=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${et(n.note)}</p>`:"",l=d("actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${et(c)}</span>
          </div>
          ${i}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${et(n.id)}" data-i18n data-i18n-key="actions.delete">${l}</button>
      </li>
    `}).join("");G.innerHTML=e,Et.classList.add("hidden")}function oe(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function nn(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function an(t){const e=E(String(t??""));if(!e)return"";const c=e.replace(/[Ù¬ØŒ]/g,"").replace(/[Ù«,]/g,".").replace(/[^0-9.]/g,"").split("."),i=c[0]||"",l=c.length>1?c.slice(1).join(""):"",r=i.replace(/^0+(\d)/,"$1"),h=r.length?r:l?"0":"",u=l?l.replace(/\D/g,"").slice(0,2):"";return u?`${h}.${u}`:h}function cn(t){if(t.preventDefault(),!w){L(d("technicianFinancial.payouts.toast.invalidTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹."));return}const e=T?.value??"",n=Number.parseFloat(E(String(e)));if(!Number.isFinite(n)||n<=0){L(d("technicianFinancial.payouts.toast.invalidAmount","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.")),T?.focus();return}const a=Je?.value?.trim()||"",c=nn(Z?.value||null),i=J?.querySelector('button[type="submit"]');i&&(i.disabled=!0),Oe({technicianId:w,amount:Number(n.toFixed(2)),note:a,paidAt:c.toISOString()}).then(l=>{L(d("technicianFinancial.payouts.toast.added","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.")),J?.reset(),Z&&(Z.value=oe(l?.paidAt||new Date)),P&&st(P)}).catch(l=>{console.error("âŒ [technician-page] Failed to create technician payout",l);const r=l?.message||d("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");L(r)}).finally(()=>{i&&(i.disabled=!1)})}function sn(t){t&&rn(t)}function on(){k&&(k.classList.remove("hidden"),k.classList.add("show"),k.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),Z&&!Z.value&&(Z.value=oe(new Date)))}function Bt(){k&&(k.classList.remove("show"),k.classList.remove("modal-open"),k.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function rn(t){tt&&(pt=t||null,tt.classList.remove("hidden"),tt.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function kt(){tt&&(tt.classList.remove("show","modal-open"),tt.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),pt=null,V&&(V.disabled=!1))}function re(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function ln(t){if(t.preventDefault(),!P)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...P}}))}catch(a){console.error("âš ï¸ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function le(){re().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",ln),t.dataset.listenerAttached="true")})}async function st(t){if(K={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Jt(K),Tt(K),!w||!t)return;try{await Zt({suppressError:!0})}catch(o){console.error("âš ï¸ [technician-page] Failed to load reservations for financial summary",o)}const n=te(),a=String(w);try{const o=await He(a);It=Array.isArray(o)?o:[]}catch(o){console.error("âš ï¸ [technician-page] Failed to load technician payouts from API",o),It=[]}const i=n.filter(o=>!o||String(o.status||"").toLowerCase()==="cancelled"?!1:(Array.isArray(o.technicians)?o.technicians.map(D=>String(D)):[]).includes(a)).map((o,m)=>{const D=Array.isArray(o.techniciansDetails)?o.techniciansDetails.find(g=>{const R=g?.id??g?.technician_id??g?.technicianId??g?.ID;return R!=null&&String(R)===a}):null,F=Qt(D)||Qt(t),S=Math.max(1,we(o.start,o.end)),j=Math.max(0,Math.round(F*S)),H=d("technicianFinancial.list.reservationFallback","Ø­Ø¬Ø² Ø±Ù‚Ù… {id}").replace("{id}",E(String(o.reservationId||o.id||"?"))),Q=o.title&&o.title.trim().length?o.title.trim():H,_=[];if(o.reservationId||o.id){const g=o.reservationId||o.id;_.push(`#${E(String(g))}`)}if(o.projectId&&_.push(d("technicianFinancial.list.projectReference","Ù…Ø´Ø±ÙˆØ¹ #{id}").replace("{id}",E(String(o.projectId)))),o.status){const g=`reservations.status.${o.status}`;_.push(d(g,o.status))}const s=St(o.start),p=St(o.end),y=s===p?s:`${s} â€“ ${p}`,b=(()=>{const g=o.start||o.startDatetime||o.createdAt||o.created_at,R=g?new Date(g).getTime():NaN;return Number.isNaN(R)?m:R})();return{label:Q,reference:_.join(" â€¢ ")||"â€”",period:y,dueAmount:j,paidAmount:0,outstandingAmount:j,paidStatus:"unpaid",sortKey:b,originalIndex:m}}),l=It.map(o=>({...o,amount:Number(o.amount)||0}));let r=l.reduce((o,m)=>o+m.amount,0);const u=[...i].sort((o,m)=>o.sortKey===m.sortKey?o.originalIndex-m.originalIndex:o.sortKey-m.sortKey).map(o=>{const m={...o},D=Number(o.dueAmount)||0,F=Math.min(D,Math.max(0,Number(r.toFixed(2))));F>0&&(r=Number((r-F).toFixed(2))),m.paidAmount=Number(F.toFixed(2));const S=Math.max(0,Number((D-F).toFixed(2)));return m.outstandingAmount=S,S<=.009?(m.paidStatus="paid",m.outstandingAmount=0):F>0?m.paidStatus="partial":m.paidStatus="unpaid",m}).sort((o,m)=>o.originalIndex-m.originalIndex).map(({sortKey:o,originalIndex:m,...D})=>D),f=u.reduce((o,m)=>o+m.dueAmount,0),A=l.reduce((o,m)=>o+(Number(m.amount)||0),0),I=Math.max(0,Number((f-A).toFixed(2))),x={total:Math.max(0,Number(f.toFixed(2))),paid:Math.max(0,Number(A.toFixed(2))),outstanding:I},q={assignments:u.length,payoutsCount:l.length,outstandingAmount:I};K={totals:x,metrics:q,breakdown:u,payouts:l},Jt(K),Tt(K)}function M(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const c=n==null?"":String(n).trim(),i=c.length>0;t.textContent=i?`${e} ${c}`:`${e} â€”`,a?t.classList.toggle("hidden",!i):i||t.classList.remove("hidden")}function Xt(t){const e=[Ye,Ge].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(r=>{r.className="technician-badge hidden",r.textContent="â€”"});return}const a=n==="busy",c=["technician-badge"];c.push(a?"technician-badge--status-busy":"technician-badge--status-available");const i=a?"technicians.status.busy":"technicians.status.available",l=a?"â›” Ù…Ø´ØºÙˆÙ„":"âœ… Ù…ØªØ§Ø­";e.forEach(r=>{r.className=c.join(" "),r.classList.remove("hidden"),r.setAttribute("data-i18n",""),r.setAttribute("data-i18n-key",i),r.textContent=d(i,l)})}function X(t){if(!t){M(Ut,"ğŸ˜","â€”"),M(Vt,"ğŸ¯","",{hideWhenEmpty:!0}),M(zt,"ğŸ“","",{hideWhenEmpty:!0}),M(Ht,"ğŸ¢","",{hideWhenEmpty:!0}),rt&&(rt.textContent="â€”"),it&&(it.textContent="â€”"),M(Ot,"ğŸ“","",{hideWhenEmpty:!0}),M(Wt,"ğŸ¢","",{hideWhenEmpty:!0}),Xt(null);return}if(M(Ut,"ğŸ˜",t.name||"â€”"),M(Vt,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),M(zt,"ğŸ“",t.phone?E(t.phone):"",{hideWhenEmpty:!0}),M(Ht,"ğŸ¢",t.department||"",{hideWhenEmpty:!0}),rt&&(rt.textContent=t.name||"â€”"),it){const e=t.role?t.role:"";if(e)it.textContent=`ğŸ¯ ${e}`;else{const n=d("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯");it.textContent=`ğŸ¯ ${n}`}}M(Ot,"ğŸ“",t.phone?E(t.phone):"",{hideWhenEmpty:!0}),M(Wt,"ğŸ¢",t.department||"",{hideWhenEmpty:!0}),Xt(t.status||t.baseStatus||"available")}function ct(t){re().forEach(e=>{e.disabled=!!t})}function ut(t){t&&(Pt=t,Ft.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Ze.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&w&&ce(w),t==="reservations"&&w&&ie(w))}function dn(){Ft.length&&(Ft.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&ut(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&ut(n)}),t.dataset.listenerAttached="true")}),ut(Pt))}X(null);ct(!0);dn();le();lt&&!lt.dataset.listenerAttached&&(lt.addEventListener("click",()=>{Tt(K),on()}),lt.dataset.listenerAttached="true");Qe.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{Bt()}),t.dataset.listenerAttached="true")});J&&!J.dataset.listenerAttached&&(J.addEventListener("submit",cn),J.dataset.listenerAttached="true");G&&!G.dataset.listenerAttached&&(G.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");sn(n)}),G.dataset.listenerAttached="true");if(T&&!T.dataset.normalizerAttached){const t=()=>{const e=an(T.value);if(e!==T.value){const n=e.length;T.value=e,T.setSelectionRange&&T.setSelectionRange(n,n)}};T.addEventListener("input",t),T.addEventListener("blur",()=>{if(t(),T.value){const e=Number.parseFloat(T.value);Number.isFinite(e)&&(T.value=e.toFixed(2))}}),T.dataset.normalizerAttached="true"}Xe.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",kt),t.dataset.listenerAttached="true")});V&&!V.dataset.listenerAttached&&(V.addEventListener("click",()=>{if(!pt){kt();return}V.disabled=!0,We(pt).then(()=>{L(d("technicianFinancial.payouts.toast.removed","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.")),kt(),P&&st(P)}).catch(t=>{console.error("âŒ [technician-page] Failed to remove technician payout",t);const e=t?.message||d("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");L(e),V.disabled=!1})}),V.dataset.listenerAttached="true");k&&!k.dataset.listenerAttached&&(k.addEventListener("click",t=>{t.target===k&&Bt()}),k.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&k&&k.classList.contains("modal-open")&&Bt()});window.showReservationDetails=Ae;const dt=document.getElementById("logout-btn");dt&&!dt.dataset.listenerAttached&&(dt.addEventListener("click",()=>be()),dt.dataset.listenerAttached="true");function un(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function de(t){if(!z)return;if(X(t),!t){z.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,ct(!0);return}const e=t.phone?E(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${d("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±")}</span>`,n=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${d("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯")}</span>`,a=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${d("technicianDetails.fallback.department","â€”")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${d("technicianDetails.fallback.notes","â€”")}</span>`,l=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${d("reservations.create.summary.currency","SR")}</span>`,r=`${un(t.dailyWage)} ${l}`,h=t.baseStatus||t.status||"available",u=h==="busy"?"technicians.status.busy":"technicians.status.available",f=`<span class="badge ${h==="busy"?"badge-warning":"badge-success"}" data-i18n data-i18n-key="${u}">${d(u)}</span>`,I=[{key:"technicianDetails.fields.role",value:n},{key:"technicianDetails.fields.department",value:a},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.wage",value:r},{key:"technicianDetails.fields.baseStatus",value:f},{key:"technicianDetails.fields.notes",value:c}].map(({key:x,value:q})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${x}">${d(x)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${q}</p>
    </article>
  `).join("");z.innerHTML=I,le(),ct(!1),ut(Pt)}async function mn(){if(!z)return;if(!w){X(null),ct(!0),P=null,z.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${d("technicianDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}z.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${d("technicianDetails.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...")}</p>`,ct(!0),X(null);let t=wt(w);if(!t){try{await Ie()}catch(e){console.error("âŒ [technician-details] Failed to load technician from API",e),z.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${d("technicianDetails.errors.loadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.")}</p>`,X(null),P=null;return}t=wt(w)}if(!t){z.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,X(null),P=null;return}P=t,await st(t),de(t),ie(w),ce(w)}ee();mn();const hn=async()=>{if(!w)return;ee();const t=wt(w);t&&(P=t,await st(t),de(t))};window.addEventListener("technicians:updated",hn);const pn=()=>{!w||!P||st(P)};document.addEventListener("reservations:changed",pn,{passive:!0});
