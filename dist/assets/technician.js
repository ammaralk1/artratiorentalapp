import{x as me,t as d,n as v,e as rt,h as F,a as he,c as pe,i as fe,l as ge,s as ye}from"./auth.js";import{i as be}from"./dashboardShell.js";import"./projects2.js";/* empty css   */import{e as Kt,r as Bt,g as Qt,k as De,l as ve,s as Jt,p as yt,q as Ee,t as we}from"./projectsService.js";import{r as Mt,a as Xt,s as Ie}from"./controller.js";import"./events.js";import{g as bt,b as Se,e as Ae,a as Fe,c as Te,d as Nt,P as ke,s as xe,f as Le}from"./projectFocusTemplates.js";import{c as je}from"./projectsCommon.js";me({ar:{"technicianDetails.pageTitle":"معلومات عضو الطاقم","technicianDetails.title":"😎 بيانات عضو الطاقم","technicianDetails.actions.back":"⬅️ العودة","technicianDetails.actions.edit":"✏️ تعديل عضو الطاقم","technicianDetails.hero.subtitle":"راجع نشاط عضو الطاقم ومهامه الحالية.","technicianDetails.hero.helper":"استخدم هذه الصفحة لمتابعة حجوزات ومشاريع عضو الطاقم.","technicianFinancial.stats.total":"💼 إجمالي المستحقات","technicianFinancial.stats.paid":"💰 المبالغ المدفوعة","technicianFinancial.stats.outstanding":"🧾 المبلغ المتبقي","technicianFinancial.stats.totalDesc":"مرتبطة بـ {count} مهام","technicianFinancial.stats.paidDesc":"تم تسجيل {count} دفعات","technicianFinancial.stats.outstandingDesc":"المتبقي {amount}","technicianFinancial.actions.viewDetails":"📊 عرض التفاصيل","technicianFinancial.modal.title":"📊 الملخص المالي للفني","technicianFinancial.modal.subtitle":"نظرة تفصيلية على مستحقات العضو والمدفوعات السابقة والحالية.","technicianFinancial.list.title":"تفاصيل الحجوزات والمشاريع","technicianFinancial.assignments.empty":"لا توجد حجوزات أو مشاريع مرتبطة لعرضها.","technicianFinancial.list.reservation":"الحجز / المشروع","technicianFinancial.list.period":"الفترة","technicianFinancial.list.due":"المستحق","technicianFinancial.list.status":"حالة الدفع","technicianFinancial.list.outstanding":"المتبقي","technicianFinancial.list.settled":"لا يوجد","technicianFinancial.list.reservationFallback":"حجز رقم {id}","technicianFinancial.list.projectReference":"مشروع #{id}","technicianFinancial.status.paid":"مدفوع","technicianFinancial.status.partial":"مدفوع جزئياً","technicianFinancial.status.unpaid":"غير مدفوع","technicianFinancial.payouts.title":"💸 سجل الدفعات الداخلية","technicianFinancial.payouts.helper":"سجّل المبالغ التي تم دفعها لهذا العضو من الشركة لضمان تتبع السداد.","technicianFinancial.payouts.empty":"لا توجد دفعات مسجلة بعد.","technicianFinancial.payouts.form.amount":"💰 المبلغ","technicianFinancial.payouts.form.date":"📅 تاريخ الدفع","technicianFinancial.payouts.form.note":"📝 ملاحظات (اختياري)","technicianFinancial.payouts.form.submit":"💸 تسجيل الدفعة","technicianFinancial.payouts.confirmDelete":"❌ هل تريد حذف هذه الدفعة؟","technicianFinancial.payouts.toast.added":"✅ تم تسجيل الدفعة.","technicianFinancial.payouts.toast.removed":"🗑️ تم حذف الدفعة.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ أدخل قيمة صحيحة للمبلغ.","technicianFinancial.payouts.toast.failed":"⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ لا يمكن تحديد عضو الطاقم حالياً.","technicianDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","technicianDetails.fields.role":"👔 الوظيفة:","technicianDetails.fields.department":"🧩 القسم:","technicianDetails.fields.phone":"📞 الجوال:","technicianDetails.fields.wage":"💰 الأجر اليومي:","technicianDetails.fields.baseStatus":"⚙️ الحالة الأساسية:","technicianDetails.fields.notes":"📝 الملاحظات:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"غير محدد","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ لا يوجد معرف عضو طاقم في الرابط.","technicianDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العضو.","technicianDetails.errors.loadFailed":"❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.","technicianDetails.errors.reservationsLoadFailed":"❌ تعذر تحميل حجوزات هذا العضو حالياً.","technicianDetails.status.loading":"⏳ جارٍ تحميل بيانات عضو الطاقم...","technicianDetails.edit.modalTitle":"✏️ تعديل بيانات عضو الطاقم","technicians.picker.actions.apply":"تم","technicianProjects.title":"📁 مشاريع مرتبطة بالطاقم","technicianProjects.empty":"لا توجد مشاريع مرتبطة بهذا العضو."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"😎 Crew Member Profile","technicianDetails.actions.back":"⬅️ Back","technicianDetails.actions.edit":"✏️ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew member’s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianFinancial.stats.total":"💼 Total Due","technicianFinancial.stats.paid":"💰 Paid Amount","technicianFinancial.stats.outstanding":"🧾 Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"📊 View details","technicianFinancial.modal.title":"📊 Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"💸 Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"💰 Amount","technicianFinancial.payouts.form.date":"📅 Payment date","technicianFinancial.payouts.form.note":"📝 Notes (optional)","technicianFinancial.payouts.form.submit":"💸 Record payout","technicianFinancial.payouts.confirmDelete":"❌ Delete this payout?","technicianFinancial.payouts.toast.added":"✅ Payout logged successfully.","technicianFinancial.payouts.toast.removed":"🗑️ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"⚠️ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ Unable to determine the crew member right now.","technicianDetails.filters.search":"🔍 Search by client or reservation ID...","technicianDetails.fields.role":"👔 Role:","technicianDetails.fields.department":"🧩 Department:","technicianDetails.fields.phone":"📞 Phone:","technicianDetails.fields.wage":"💰 Daily Rate:","technicianDetails.fields.baseStatus":"⚙️ Base Status:","technicianDetails.fields.notes":"📝 Notes:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"⚠️ Crew member not found.","technicianDetails.errors.loadFailed":"❌ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"❌ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"⏳ Loading crew member details...","technicianDetails.edit.modalTitle":"✏️ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"📁 Crew Projects","technicianProjects.empty":"No projects are linked to this crew member."}});let mt={},f={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},Ct=!1;function Dt(t=""){return v(String(t)).trim().toLowerCase()}function Pe(t,e,n){if(!e||!n)return;const{startDate:a,endDate:c}=Xt(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?c?n._flatpickr.setDate(c,!1,"Y-m-d"):n._flatpickr.clear():n.value=c||""}function z(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function Zt(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!Ct){try{await Kt({suppressError:!1,force:!0})}catch(p){console.error("❌ [technician-details] Failed to hydrate reservations list",p),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${d("technicianDetails.errors.reservationsLoadFailed","❌ تعذر تحميل حجوزات هذا العضو حالياً.")}</p>`;return}Ct=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),c=document.getElementById("technician-filter-end-date"),i=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),o=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),c&&window.flatpickr(c,{dateFormat:"Y-m-d"}));const m=()=>{let p=v(a?.value||"").trim(),T=v(c?.value||"").trim(),r=i?.value||"";if(new Set(["","today","week","month"]).has(r)||(r="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),p="",T=""),!p&&!T&&r){const{startDate:w,endDate:E}=Xt(r);p=w,T=E}const y=n?.value||"",k=Dt(y);return{searchTerm:k,searchReservationId:k,searchCustomerName:k,startDate:p,endDate:T,status:l?.value||"",quickRange:r,technicianId:t}},h=()=>{mt=m(),Mt("technician-reservations",mt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=v(n.value),h()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),h()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{i&&(i.value=""),h()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Pe(i.value,a,c),h()}),i.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",h),l.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),i&&(i.value=""),l&&(l.value=""),h()}),o.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{Mt("technician-reservations",mt)},h()}function te(t){f.currentId=t;const{container:e}=K();e&&(f.initialized||(Be(),Me(),Re(),document.addEventListener("projects:changed",()=>{f.currentId&&$()}),document.addEventListener("language:changed",()=>{f.currentId&&$()}),document.addEventListener("customers:changed",()=>{f.currentId&&$()}),document.addEventListener("technicians:updated",()=>{f.currentId&&$()}),f.initialized=!0),$())}function K(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function Be(){const{searchInput:t,statusSelect:e,clearBtn:n}=K();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=v(t.value),$()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{$()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:a,statusSelect:c}=K();a&&(a.value=""),c&&(c.value=""),$()}),n.dataset.listenerAttached="true")}function Me(){const{container:t}=K();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Ce),t.dataset.projectModalListenerAttached="true")}function Ne(){const{container:t}=K();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const c=e.dataset.projectId?String(e.dataset.projectId):"";c&&ct(c)}),e.dataset.technicianModalListenerAttached="true")})}function Ce(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&ct(a)}function Re(){It()}function It(){if(f.modal?.el&&f.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(f.modal={el:t,body:e},!0)}function $(){const{container:t,searchInput:e,statusSelect:n}=K();if(!t||!f.currentId)return;const a=Dt(e?.value||""),c=n?.value||"",{projects:i=[],customers:l=[],technicians:o=[],reservations:m=[]}=rt(),h=new Map(l.map(s=>[String(s.id),s])),p=new Map(o.map(s=>[String(s.id),s])),T=new Map(i.map(s=>[String(s.id),s])),r=$e(m),g=String(f.currentId),y=new Map,k=(s,u=null)=>{if(!s)return;const b=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(b&&!y.has(b)){const A=u??z(s?.technicians);y.set(b,{...s,technicians:A})}};i.forEach(s=>{const u=z(s?.technicians);u.length&&u.includes(g)&&k({...s,technicians:u},u)}),m.forEach(s=>{if(!s?.projectId)return;const u=z(s.technicians);if(!u.includes(g))return;const b=String(s.projectId),A=y.get(b),x=T.get(b),{effectiveConfirmed:N}=Bt(s,x??A??null);if(A){const C=z(A.technicians),_=Array.from(new Set([...C,...u]));y.set(b,{...A,technicians:_,confirmed:A.confirmed||N});return}if(x){const C=z(x?.technicians),_=Array.from(new Set([...C,...u]));k({...x,technicians:_,confirmed:Bt(s,x).effectiveConfirmed},_);return}k({id:b,title:s.projectTitle||s.title||s.project_title||`#${b}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:u,clientId:s.projectClientId??s.customerId??null,confirmed:N,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},u)});const w=Array.from(y.values());f.projectsMap=y,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:y,keys:()=>Array.from(y.keys())}});const E=w.filter(s=>{if(a){const u=h.get(String(s.clientId))?.customerName||"";if(!Dt([s.title,s.description,u].filter(Boolean).join(" ")).includes(a))return!1}return!(c&&ze(s)!==c)}).sort((s,u)=>{const b=new Date(s.start||s.createdAt||0).getTime();return new Date(u.start||u.createdAt||0).getTime()-b});if(!E.length){const s=d("technicianProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العضو.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=E.map(s=>{const u=bt(s),b=u?r.get(u)||[]:[],A=h.get(String(s.clientId))||null;return Se(s,{customer:A,techniciansMap:p,reservations:b})}).join(""),Ne()}function $e(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const c=String(a);e.has(c)||e.set(c,[]),e.get(c).push(n)}),e}function ct(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!It())return;const n=f.modal;if(!n?.body)return;const{projects:a=[],reservations:c=[],customers:i=[]}=rt(),l=f.projectsMap?.get(e)||null;let o=l??Rt(a,e);if(o||(o=Rt(a,e)),!o)return;const m=String(f.currentId||"");let h=z(o.technicians);if(!h.length&&l&&(h=z(l.technicians),o={...l,...o}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:m,normalizedTechnicians:h}}}),m&&!h.includes(m)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:e,activeTechnicianId:m,normalizedTechnicians:h});return}o={...o,technicians:h};const p=i.find(r=>String(r.id)===String(o.clientId))||null,T=c.filter(r=>{const g=Ae(r);return g&&g===e});n.body.dataset.mode="view",n.body.innerHTML=Fe(o,{customer:p,reservations:T}),_e(o),qe(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function _e(t){if(!t||!f.modal?.body)return;const e=f.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",n=>{n.preventDefault(),Ue(t)})}function qe(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const c=Qt();let i=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const l=n.dataset.reservationId;l&&(i=c.findIndex(m=>[m?.id,m?.reservationId,m?.reservation_id].some(p=>p!=null&&String(p)===l)))}Number.isInteger(i)&&i>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(i):F(d("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),n.dataset.listenerAttached="true")})}function Ue(t){if(!t||!It())return;const e=f.modal;if(!e?.body)return;const{customers:n=[]}=rt(),a=n.find(o=>String(o.id)===String(t.clientId))||null,c=a?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||a?.companyName||a?.company||"",l=Array.isArray(t?.expenses)?t.expenses.map((o,m)=>({id:o?.id||`expense-${t.id}-${m}-${Date.now()}`,label:o?.label||"",amount:Number(o?.amount)||0})):[];e.body.dataset.mode="edit",e.body.innerHTML=Te(t,{clientName:c,clientCompany:i}),He(t,{clientName:c,clientCompany:i,expenses:l})}function He(t,{clientName:e="",clientCompany:n="",expenses:a=[]}={}){const c={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},i=f.modal?.body?.querySelector("#project-details-edit-form");if(!i)return;const l=i.querySelector('[data-action="cancel-edit"]');l&&l.addEventListener("click",w=>{w.preventDefault(),ct(t.id)});const o=i.querySelector("#project-edit-expense-label"),m=i.querySelector("#project-edit-expense-amount"),h=i.querySelector('[data-action="add-expense"]'),p=i.querySelector("#project-edit-expense-list"),T=i.querySelector('[name="project-start-date"]'),r=i.querySelector('[name="project-start-time"]'),g=i.querySelector('[name="project-end-date"]'),y=i.querySelector('[name="project-end-time"]');function k(){p&&(p.innerHTML=Le(c.expenses))}k(),h&&h.addEventListener("click",w=>{w.preventDefault();const E=o?.value.trim()||"",s=v(m?.value||"0"),u=Number(s);if(!E){F(d("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),o?.focus();return}if(!Number.isFinite(u)||u<=0){F(d("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),m?.focus();return}c.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:E,amount:u}),o&&(o.value=""),m&&(m.value=""),k()}),p&&p.addEventListener("click",w=>{const E=w.target.closest('[data-action="remove-expense"]');if(!E)return;const{id:s}=E.dataset;c.expenses=c.expenses.filter(u=>String(u.id)!==String(s)),k()}),i.addEventListener("submit",async w=>{if(w.preventDefault(),i.dataset.submitting==="true")return;const E=i.querySelector('[name="project-title"]'),s=i.querySelector('[name="project-type"]'),u=i.querySelector('[name="project-description"]'),b=i.querySelector('[name="project-payment-status"]'),A=i.querySelector('[name="project-apply-tax"]'),x=E?.value.trim()||"",N=s?.value||"",C=T?.value.trim()||"",_=r?.value.trim()||"",B=u?.value.trim()||"",J=b?.value==="paid"?"paid":"unpaid",lt=A?.checked===!0;if(!x||!N||!C){F(d("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),E?.focus();return}const xt=g?.value.trim()||"",re=y?.value.trim()||"",Lt=Nt(C,_),dt=xt?Nt(xt,re):"";if(dt){const q=new Date(Lt),H=new Date(dt);if(!Number.isNaN(q.getTime())&&!Number.isNaN(H.getTime())&&q>H){F(d("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),g?.focus();return}}const tt=bt(t);if(!tt){F(d("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const jt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,le=je({...t,expenses:c.expenses}),ut=Number((jt+le).toFixed(2)),Pt=lt?Number((ut*ke).toFixed(2)):0,de=lt?Number((ut+Pt).toFixed(2)):ut,ue=De({projectCode:t.projectCode,title:x,type:N,clientId:t.clientId,clientCompany:c.clientCompany,description:B,start:Lt,end:dt||null,applyTax:lt,paymentStatus:J,equipmentEstimate:jt,expenses:c.expenses,taxAmount:Pt,totalWithTax:de,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),P=i.querySelector('button[type="submit"]');P&&(P.disabled=!0,P.dataset.originalText=P.textContent||"",P.textContent=d("projects.details.edit.saving","جاري الحفظ...")),i.dataset.submitting="true";try{const q=await ve(tt,ue);await xe(tt,J),document.dispatchEvent(new CustomEvent("projects:changed")),F(d("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),$();const H=bt(q)||tt;H&&ct(H)}catch(q){console.error("❌ [technicianDetails] Failed to update project from modal",q);const H=typeof q?.message=="string"?q.message:d("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");F(H)}finally{delete i.dataset.submitting,P&&(P.disabled=!1,P.dataset.originalText&&(P.textContent=P.dataset.originalText,delete P.dataset.originalText))}})}function Rt(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(i=>i!=null&&String(i)===n))||null}function ze(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}he();pe();be();const Oe=new URLSearchParams(window.location.search),D=Oe.get("id"),U=document.getElementById("technician-details"),$t=document.getElementById("technician-hero-name"),Ve=document.getElementById("technician-hero-status"),_t=document.getElementById("technician-hero-role"),qt=document.getElementById("technician-hero-phone"),Ut=document.getElementById("technician-hero-department"),et=document.getElementById("dashboard-greeting-technician-name"),X=document.getElementById("dashboard-greeting-technician-role"),We=document.getElementById("dashboard-greeting-technician-status"),Ht=document.getElementById("dashboard-greeting-technician-phone"),zt=document.getElementById("dashboard-greeting-technician-department"),L={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},I=document.getElementById("technician-financial-modal"),nt=document.getElementById("technician-financial-open"),Ot=document.getElementById("technician-financial-modal-total"),Vt=document.getElementById("technician-financial-modal-paid"),Wt=document.getElementById("technician-financial-modal-outstanding"),ht=document.getElementById("technician-financial-modal-empty"),pt=document.getElementById("technician-financial-modal-table-wrapper"),ft=document.getElementById("technician-financial-modal-rows"),Ge=Array.from(document.querySelectorAll("[data-financial-modal-close]")),V=document.getElementById("technician-payout-form"),st=document.getElementById("technician-payout-amount"),G=document.getElementById("technician-payout-date"),Ye=document.getElementById("technician-payout-note"),O=document.getElementById("technician-payouts-list"),gt=document.getElementById("technician-payouts-empty"),vt=Array.from(document.querySelectorAll("[data-technician-tab]")),Ke=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let St="reservations",S=null,R={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]};fe();function ee(){return document.documentElement.getAttribute("lang")||"ar"}function M(t){const e=Number(t)||0,a=ee()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const c=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${v(c)} SR`}catch{const i=Math.round(e);return`${v(String(i))} SR`}}function Et(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const a=ee()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),o=e.getFullYear();return`${i}/${l}/${o}`}}function Qe(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`payout-${Date.now()}-${Math.floor(Math.random()*1e6)}`}function ne(t={}){if(!t)return null;const e=Number(t.amount);if(!Number.isFinite(e))return null;const n=t.technicianId!=null?String(t.technicianId):"";return n?{id:t.id?String(t.id):Qe(),technicianId:n,amount:Math.max(0,Number(e.toFixed(2))),note:t.note?String(t.note).trim():"",paidAt:t.paidAt?new Date(t.paidAt).toISOString():new Date().toISOString(),createdAt:t.createdAt?new Date(t.createdAt).toISOString():new Date().toISOString(),recordedBy:t.recordedBy?String(t.recordedBy):null}:null}function At(){try{const{technicianPayouts:t}=rt();return Array.isArray(t)?t.map(ne).filter(Boolean):[]}catch(t){return console.error("⚠️ [technician-page] Failed to load technician payouts from storage",t),[]}}function ae(t){try{ye({technicianPayouts:t}),typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("technicians:payoutsUpdated"))}catch(e){console.error("⚠️ [technician-page] Failed to persist technician payouts",e)}}function Ft(t){const e=t!=null?String(t):"";return e?At().filter(n=>n&&String(n.technicianId)===e).sort((n,a)=>new Date(a.paidAt).getTime()-new Date(n.paidAt).getTime()):[]}function Je(t,{amount:e,note:n,paidAt:a}){const c=t!=null?String(t):"";if(!c)return null;const i=ne({technicianId:c,amount:e,note:n,paidAt:a});if(!i)return null;const l=At();return l.push(i),ae(l),i}function Xe(t){if(!t)return!1;const e=At(),n=e.filter(a=>a.id!==t);return n.length===e.length?!1:(ae(n),!0)}function Y(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Gt(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(v(String(n)));if(Number.isFinite(a))return a}return 0}function Ze(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="badge badge-outline badge-warning";return e==="paid"?(n="technicianFinancial.status.paid",a="badge badge-success"):e==="partial"&&(n="technicianFinancial.status.partial",a="badge badge-info"),`<span class="${a}">${d(n,n)}</span>`}function wt(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),c=Number(n.payoutsCount??0),i=d("technicianFinancial.stats.totalDesc","مرتبطة بـ {count} مهام").replace("{count}",v(String(a))),l=d("technicianFinancial.stats.paidDesc","{count} دفعات مسجلة").replace("{count}",v(String(c))),o=d("technicianFinancial.stats.outstandingDesc","المتبقي {amount}"),m=e.outstanding>0?o.replace("{amount}",M(e.outstanding)):"—";L.total&&(L.total.textContent=M(e.total)),L.totalDesc&&(L.totalDesc.textContent=a>0?i:"—"),L.paid&&(L.paid.textContent=M(e.paid)),L.paidDesc&&(L.paidDesc.textContent=c>0?l:"—"),L.outstanding&&(L.outstanding.textContent=M(e.outstanding)),L.outstandingDesc&&(L.outstandingDesc.textContent=m)}function ot(t){const{totals:e,breakdown:n,payouts:a}=t;if(Ot&&(Ot.textContent=M(e.total)),Vt&&(Vt.textContent=M(e.paid)),Wt&&(Wt.textContent=M(e.outstanding)),!(!ft||!pt||!ht)){if(!n.length)ft.innerHTML="",pt.classList.add("hidden"),ht.classList.remove("hidden");else{ht.classList.add("hidden"),pt.classList.remove("hidden");const c=n.map(i=>{const l=i.period||"—",o=i.outstandingAmount>0?M(i.outstandingAmount):`<span class="text-success">${d("technicianFinancial.list.settled","لا يوجد")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${Y(i.label)}</div>
            <div class="text-xs text-base-content/60">${Y(i.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${Y(l)}</td>
          <td>${M(i.dueAmount)}</td>
          <td>${Ze(i.paidStatus)}</td>
          <td>${o}</td>
        </tr>
      `}).join("");ft.innerHTML=c}Tt(a)}}function Tt(t=[]){if(!O||!gt)return;if(!Array.isArray(t)||t.length===0){O.innerHTML="",gt.classList.remove("hidden");return}const e=t.map(n=>{const a=M(n.amount||0),c=Et(n.paidAt||n.createdAt),i=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${Y(n.note)}</p>`:"",l=d("actions.delete","🗑️ حذف");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${Y(c)}</span>
          </div>
          ${i}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${Y(n.id)}" data-i18n data-i18n-key="actions.delete">${l}</button>
      </li>
    `}).join("");O.innerHTML=e,gt.classList.add("hidden")}function ie(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function tn(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function en(t){if(t.preventDefault(),!D){F(d("technicianFinancial.payouts.toast.invalidTechnician","⚠️ لا يمكن تحديد عضو الطاقم حالياً."));return}const e=st?.value??"",n=Number.parseFloat(v(String(e)));if(!Number.isFinite(n)||n<=0){F(d("technicianFinancial.payouts.toast.invalidAmount","⚠️ أدخل قيمة صحيحة للمبلغ.")),st?.focus();return}const a=Ye?.value?.trim()||"",c=tn(G?.value||null),i=Je(D,{amount:n,note:a,paidAt:c.toISOString()});if(!i){F(d("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى."));return}if(F(d("technicianFinancial.payouts.toast.added","✅ تم تسجيل الدفعة.")),V&&V.reset(),G&&(G.value=ie(i.paidAt)),S)Q(S);else{const l=Ft(D);Tt(l)}}function nn(t){if(!t)return;const e=d("technicianFinancial.payouts.confirmDelete","❌ هل تريد حذف هذه الدفعة؟");if(!window.confirm(e))return;if(!Xe(t)){F(d("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى."));return}if(F(d("technicianFinancial.payouts.toast.removed","🗑️ تم حذف الدفعة.")),S)Q(S);else{const c=Ft(D);Tt(c)}}function an(){I&&(I.classList.remove("hidden"),I.classList.add("show"),I.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),G&&!G.value&&(G.value=ie(new Date)),st&&st.setAttribute("min","0"))}function kt(){I&&(I.classList.remove("show"),I.classList.remove("modal-open"),I.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function ce(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function cn(t){if(t.preventDefault(),!S)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...S}}))}catch(a){console.error("⚠️ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function se(){ce().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",cn),t.dataset.listenerAttached="true")})}async function Q(t){if(R={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},wt(R),ot(R),!D||!t)return;try{await Kt({suppressError:!0})}catch(r){console.error("⚠️ [technician-page] Failed to load reservations for financial summary",r)}const n=Qt(),a=String(D),i=n.filter(r=>!r||String(r.status||"").toLowerCase()==="cancelled"?!1:(Array.isArray(r.technicians)?r.technicians.map(y=>String(y)):[]).includes(a)).map(r=>{const g=Array.isArray(r.techniciansDetails)?r.techniciansDetails.find(B=>{const J=B?.id??B?.technician_id??B?.technicianId??B?.ID;return J!=null&&String(J)===a}):null,y=Gt(g)||Gt(t),k=Math.max(1,we(r.start,r.end)),w=Math.max(0,Math.round(y*k)),E=r.paidStatus||"unpaid",s=E==="paid"?w:0,u=Math.max(0,w-s),b=d("technicianFinancial.list.reservationFallback","حجز رقم {id}").replace("{id}",v(String(r.reservationId||r.id||"?"))),A=r.title&&r.title.trim().length?r.title.trim():b,x=[];if(r.reservationId||r.id){const B=r.reservationId||r.id;x.push(`#${v(String(B))}`)}if(r.projectId&&x.push(d("technicianFinancial.list.projectReference","مشروع #{id}").replace("{id}",v(String(r.projectId)))),r.status){const B=`reservations.status.${r.status}`;x.push(d(B,r.status))}const N=Et(r.start),C=Et(r.end),_=N===C?N:`${N} – ${C}`;return{label:A,reference:x.join(" • ")||"—",period:_,dueAmount:w,paidAmount:s,outstandingAmount:u,paidStatus:E}}),l=i.reduce((r,g)=>r+g.dueAmount,0),o=Ft(a),m=o.reduce((r,g)=>r+(Number(g.amount)||0),0),h=Math.max(0,Number((l-m).toFixed(2))),p={total:Math.max(0,Number(l.toFixed(2))),paid:Math.max(0,Number(m.toFixed(2))),outstanding:h},T={assignments:i.length,payoutsCount:o.length,outstandingAmount:h};R={totals:p,metrics:T,breakdown:i,payouts:o},wt(R),ot(R)}function j(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const c=n==null?"":String(n).trim(),i=c.length>0;t.textContent=i?`${e} ${c}`:`${e} —`,a?t.classList.toggle("hidden",!i):i||t.classList.remove("hidden")}function Yt(t){const e=[Ve,We].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(o=>{o.className="badge badge-outline badge-lg hidden",o.textContent="—"});return}const a=n==="busy",c=["badge","badge-outline","badge-lg","font-semibold"];c.push(a?"text-warning":"text-success");const i=a?"technicians.status.busy":"technicians.status.available",l=a?"⛔ مشغول":"✅ متاح";e.forEach(o=>{o.className=c.join(" "),o.classList.remove("hidden"),o.setAttribute("data-i18n",""),o.setAttribute("data-i18n-key",i),o.textContent=d(i,l)})}function W(t){if(!t){j($t,"😎","—"),j(_t,"🎯","",{hideWhenEmpty:!0}),j(qt,"📞","",{hideWhenEmpty:!0}),j(Ut,"🏢","",{hideWhenEmpty:!0}),et&&(et.textContent="—"),X&&(X.textContent="—"),j(Ht,"📞","",{hideWhenEmpty:!0}),j(zt,"🏢","",{hideWhenEmpty:!0}),Yt(null);return}if(j($t,"😎",t.name||"—"),j(_t,"🎯",t.role||"",{hideWhenEmpty:!0}),j(qt,"📞",t.phone?v(t.phone):"",{hideWhenEmpty:!0}),j(Ut,"🏢",t.department||"",{hideWhenEmpty:!0}),et&&(et.textContent=t.name||"—"),X){const e=t.role?t.role:"";if(e)X.textContent=`🎯 ${e}`;else{const n=d("technicianDetails.fallback.role","غير محدد");X.textContent=`🎯 ${n}`}}j(Ht,"📞",t.phone?v(t.phone):"",{hideWhenEmpty:!0}),j(zt,"🏢",t.department||"",{hideWhenEmpty:!0}),Yt(t.status||t.baseStatus||"available")}function Z(t){ce().forEach(e=>{e.disabled=!!t})}function it(t){t&&(St=t,vt.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Ke.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&D&&te(D),t==="reservations"&&D&&Zt(D))}function sn(){vt.length&&(vt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&it(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&it(n)}),t.dataset.listenerAttached="true")}),it(St))}W(null);Z(!0);sn();se();nt&&!nt.dataset.listenerAttached&&(nt.addEventListener("click",()=>{ot(R),an()}),nt.dataset.listenerAttached="true");Ge.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{kt()}),t.dataset.listenerAttached="true")});V&&!V.dataset.listenerAttached&&(V.addEventListener("submit",en),V.dataset.listenerAttached="true");O&&!O.dataset.listenerAttached&&(O.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");nn(n)}),O.dataset.listenerAttached="true");I&&!I.dataset.listenerAttached&&(I.addEventListener("click",t=>{t.target===I&&kt()}),I.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&I&&I.classList.contains("modal-open")&&kt()});window.showReservationDetails=Ie;const at=document.getElementById("logout-btn");at&&!at.dataset.listenerAttached&&(at.addEventListener("click",()=>ge()),at.dataset.listenerAttached="true");function on(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function oe(t){if(!U)return;if(W(t),!t){U.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,Z(!0);return}const e=t.phone?v(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${d("reservations.details.technicians.phoneUnknown","غير متوفر")}</span>`,n=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${d("technicianDetails.fallback.role","غير محدد")}</span>`,a=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${d("technicianDetails.fallback.department","—")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${d("technicianDetails.fallback.notes","—")}</span>`,l=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${d("reservations.create.summary.currency","SR")}</span>`,o=`${on(t.dailyWage)} ${l}`,m=t.baseStatus||t.status||"available",h=m==="busy"?"technicians.status.busy":"technicians.status.available",p=`<span class="badge ${m==="busy"?"badge-warning":"badge-success"}" data-i18n data-i18n-key="${h}">${d(h)}</span>`,r=[{key:"technicianDetails.fields.role",value:n},{key:"technicianDetails.fields.department",value:a},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.wage",value:o},{key:"technicianDetails.fields.baseStatus",value:p},{key:"technicianDetails.fields.notes",value:c}].map(({key:g,value:y})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${g}">${d(g)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${y}</p>
    </article>
  `).join("");U.innerHTML=r,se(),Z(!1),it(St)}async function rn(){if(!U)return;if(!D){W(null),Z(!0),S=null,U.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${d("technicianDetails.errors.missingId","⚠️ لا يوجد معرف عضو طاقم في الرابط.")}</p>`;return}U.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${d("technicianDetails.status.loading","⏳ جارٍ تحميل بيانات عضو الطاقم...")}</p>`,Z(!0),W(null);let t=yt(D);if(!t){try{await Ee()}catch(e){console.error("❌ [technician-details] Failed to load technician from API",e),U.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${d("technicianDetails.errors.loadFailed","❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.")}</p>`,W(null),S=null;return}t=yt(D)}if(!t){U.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,W(null),S=null;return}S=t,await Q(t),oe(t),Zt(D),te(D)}Jt();rn();const ln=async()=>{if(!D)return;Jt();const t=yt(D);t&&(S=t,await Q(t),oe(t))};window.addEventListener("technicians:updated",ln);const dn=()=>{!D||!S||Q(S)};document.addEventListener("reservations:changed",dn,{passive:!0});window.addEventListener("technicians:payoutsUpdated",()=>{S?Q(S):(wt(R),ot(R))});
