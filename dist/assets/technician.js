import{x as Xt,t as d,n as D,e as ut,h as R,a as Zt,c as te,i as ee,l as ne}from"./auth.js";import{i as ae}from"./dashboardShell.js";import"./projects2.js";/* empty css   */import{e as _t,r as Et,g as $t,k as ie,l as ce,s as Nt,p as st,q as se,t as re}from"./projectsService.js";import{r as wt,a as qt,s as oe}from"./controller.js";import"./events.js";import{g as rt,b as le,e as de,a as ue,c as me,d as St,P as he,s as fe,f as pe}from"./projectFocusTemplates.js";import{c as ge}from"./projectsCommon.js";Xt({ar:{"technicianDetails.pageTitle":"معلومات عضو الطاقم","technicianDetails.title":"😎 بيانات عضو الطاقم","technicianDetails.actions.back":"⬅️ العودة","technicianDetails.actions.edit":"✏️ تعديل عضو الطاقم","technicianDetails.hero.subtitle":"راجع نشاط عضو الطاقم ومهامه الحالية.","technicianDetails.hero.helper":"استخدم هذه الصفحة لمتابعة حجوزات ومشاريع عضو الطاقم.","technicianFinancial.stats.total":"💼 إجمالي المستحقات","technicianFinancial.stats.paid":"💰 المبالغ المدفوعة","technicianFinancial.stats.outstanding":"🧾 المبلغ المتبقي","technicianFinancial.stats.totalDesc":"مرتبطة بـ {count} مهام","technicianFinancial.stats.paidDesc":"مدفوعة بالكامل في {count} حالات","technicianFinancial.stats.outstandingDesc":"بحاجة متابعة في {count} حجوزات","technicianFinancial.actions.viewDetails":"📊 عرض التفاصيل","technicianFinancial.modal.title":"📊 الملخص المالي للفني","technicianFinancial.modal.subtitle":"نظرة تفصيلية على مستحقات العضو والمدفوعات السابقة والحالية.","technicianFinancial.list.title":"تفاصيل الحجوزات والمشاريع","technicianFinancial.assignments.empty":"لا توجد حجوزات أو مشاريع مرتبطة لعرضها.","technicianFinancial.list.reservation":"الحجز / المشروع","technicianFinancial.list.period":"الفترة","technicianFinancial.list.due":"المستحق","technicianFinancial.list.status":"حالة الدفع","technicianFinancial.list.outstanding":"المتبقي","technicianFinancial.list.settled":"لا يوجد","technicianFinancial.list.reservationFallback":"حجز رقم {id}","technicianFinancial.list.projectReference":"مشروع #{id}","technicianFinancial.status.paid":"مدفوع","technicianFinancial.status.partial":"مدفوع جزئياً","technicianFinancial.status.unpaid":"غير مدفوع","technicianDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","technicianDetails.fields.role":"👔 الوظيفة:","technicianDetails.fields.department":"🧩 القسم:","technicianDetails.fields.phone":"📞 الجوال:","technicianDetails.fields.wage":"💰 الأجر اليومي:","technicianDetails.fields.baseStatus":"⚙️ الحالة الأساسية:","technicianDetails.fields.notes":"📝 الملاحظات:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"غير محدد","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ لا يوجد معرف عضو طاقم في الرابط.","technicianDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العضو.","technicianDetails.errors.loadFailed":"❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.","technicianDetails.errors.reservationsLoadFailed":"❌ تعذر تحميل حجوزات هذا العضو حالياً.","technicianDetails.status.loading":"⏳ جارٍ تحميل بيانات عضو الطاقم...","technicianDetails.edit.modalTitle":"✏️ تعديل بيانات عضو الطاقم","technicians.picker.actions.apply":"تم","technicianProjects.title":"📁 مشاريع مرتبطة بالطاقم","technicianProjects.empty":"لا توجد مشاريع مرتبطة بهذا العضو."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"😎 Crew Member Profile","technicianDetails.actions.back":"⬅️ Back","technicianDetails.actions.edit":"✏️ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew member’s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianFinancial.stats.total":"💼 Total Due","technicianFinancial.stats.paid":"💰 Paid Amount","technicianFinancial.stats.outstanding":"🧾 Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"Fully settled in {count} cases","technicianFinancial.stats.outstandingDesc":"Pending follow-up in {count} bookings","technicianFinancial.actions.viewDetails":"📊 View details","technicianFinancial.modal.title":"📊 Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianDetails.filters.search":"🔍 Search by client or reservation ID...","technicianDetails.fields.role":"👔 Role:","technicianDetails.fields.department":"🧩 Department:","technicianDetails.fields.phone":"📞 Phone:","technicianDetails.fields.wage":"💰 Daily Rate:","technicianDetails.fields.baseStatus":"⚙️ Base Status:","technicianDetails.fields.notes":"📝 Notes:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"⚠️ Crew member not found.","technicianDetails.errors.loadFailed":"❌ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"❌ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"⏳ Loading crew member details...","technicianDetails.edit.modalTitle":"✏️ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"📁 Crew Projects","technicianProjects.empty":"No projects are linked to this crew member."}});let et={},f={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},It=!1;function ot(t=""){return D(String(t)).trim().toLowerCase()}function ye(t,e,n){if(!e||!n)return;const{startDate:a,endDate:c}=qt(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?c?n._flatpickr.setDate(c,!1,"Y-m-d"):n._flatpickr.clear():n.value=c||""}function U(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function Ut(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!It){try{await _t({suppressError:!1,force:!0})}catch(h){console.error("❌ [technician-details] Failed to hydrate reservations list",h),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${d("technicianDetails.errors.reservationsLoadFailed","❌ تعذر تحميل حجوزات هذا العضو حالياً.")}</p>`;return}It=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),c=document.getElementById("technician-filter-end-date"),i=document.getElementById("technician-reservation-date-range"),u=document.getElementById("technician-reservation-status-filter"),o=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),c&&window.flatpickr(c,{dateFormat:"Y-m-d"}));const r=()=>{let h=D(a?.value||"").trim(),A=D(c?.value||"").trim(),p=i?.value||"";if(new Set(["","today","week","month"]).has(p)||(p="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),h="",A=""),!h&&!A&&p){const{startDate:k,endDate:E}=qt(p);h=k,A=E}const y=n?.value||"",v=ot(y);return{searchTerm:v,searchReservationId:v,searchCustomerName:v,startDate:h,endDate:A,status:u?.value||"",quickRange:p,technicianId:t}},m=()=>{et=r(),wt("technician-reservations",et)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=D(n.value),m()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),m()}),a.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{i&&(i.value=""),m()}),c.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ye(i.value,a,c),m()}),i.dataset.listenerAttached="true"),u&&!u.dataset.listenerAttached&&(u.addEventListener("change",m),u.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),i&&(i.value=""),u&&(u.value=""),m()}),o.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{wt("technician-reservations",et)},m()}function Ht(t){f.currentId=t;const{container:e}=O();e&&(f.initialized||(be(),De(),we(),document.addEventListener("projects:changed",()=>{f.currentId&&x()}),document.addEventListener("language:changed",()=>{f.currentId&&x()}),document.addEventListener("customers:changed",()=>{f.currentId&&x()}),document.addEventListener("technicians:updated",()=>{f.currentId&&x()}),f.initialized=!0),x())}function O(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function be(){const{searchInput:t,statusSelect:e,clearBtn:n}=O();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=D(t.value),x()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{x()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:a,statusSelect:c}=O();a&&(a.value=""),c&&(c.value=""),x()}),n.dataset.listenerAttached="true")}function De(){const{container:t}=O();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Ee),t.dataset.projectModalListenerAttached="true")}function ve(){const{container:t}=O();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const c=e.dataset.projectId?String(e.dataset.projectId):"";c&&J(c)}),e.dataset.technicianModalListenerAttached="true")})}function Ee(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&J(a)}function we(){mt()}function mt(){if(f.modal?.el&&f.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(f.modal={el:t,body:e},!0)}function x(){const{container:t,searchInput:e,statusSelect:n}=O();if(!t||!f.currentId)return;const a=ot(e?.value||""),c=n?.value||"",{projects:i=[],customers:u=[],technicians:o=[],reservations:r=[]}=ut(),m=new Map(u.map(s=>[String(s.id),s])),h=new Map(o.map(s=>[String(s.id),s])),A=new Map(i.map(s=>[String(s.id),s])),p=Se(r),w=String(f.currentId),y=new Map,v=(s,l=null)=>{if(!s)return;const g=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(g&&!y.has(g)){const S=l??U(s?.technicians);y.set(g,{...s,technicians:S})}};i.forEach(s=>{const l=U(s?.technicians);l.length&&l.includes(w)&&v({...s,technicians:l},l)}),r.forEach(s=>{if(!s?.projectId)return;const l=U(s.technicians);if(!l.includes(w))return;const g=String(s.projectId),S=y.get(g),b=A.get(g),{effectiveConfirmed:P}=Et(s,b??S??null);if(S){const H=U(S.technicians),z=Array.from(new Set([...H,...l]));y.set(g,{...S,technicians:z,confirmed:S.confirmed||P});return}if(b){const H=U(b?.technicians),z=Array.from(new Set([...H,...l]));v({...b,technicians:z,confirmed:Et(s,b).effectiveConfirmed},z);return}v({id:g,title:s.projectTitle||s.title||s.project_title||`#${g}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:l,clientId:s.projectClientId??s.customerId??null,confirmed:P,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},l)});const k=Array.from(y.values());f.projectsMap=y,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:y,keys:()=>Array.from(y.keys())}});const E=k.filter(s=>{if(a){const l=m.get(String(s.clientId))?.customerName||"";if(!ot([s.title,s.description,l].filter(Boolean).join(" ")).includes(a))return!1}return!(c&&Fe(s)!==c)}).sort((s,l)=>{const g=new Date(s.start||s.createdAt||0).getTime();return new Date(l.start||l.createdAt||0).getTime()-g});if(!E.length){const s=d("technicianProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العضو.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=E.map(s=>{const l=rt(s),g=l?p.get(l)||[]:[],S=m.get(String(s.clientId))||null;return le(s,{customer:S,techniciansMap:h,reservations:g})}).join(""),ve()}function Se(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const c=String(a);e.has(c)||e.set(c,[]),e.get(c).push(n)}),e}function J(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!mt())return;const n=f.modal;if(!n?.body)return;const{projects:a=[],reservations:c=[],customers:i=[]}=ut(),u=f.projectsMap?.get(e)||null;let o=u??At(a,e);if(o||(o=At(a,e)),!o)return;const r=String(f.currentId||"");let m=U(o.technicians);if(!m.length&&u&&(m=U(u.technicians),o={...u,...o}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:r,normalizedTechnicians:m}}}),r&&!m.includes(r)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:e,activeTechnicianId:r,normalizedTechnicians:m});return}o={...o,technicians:m};const h=i.find(p=>String(p.id)===String(o.clientId))||null,A=c.filter(p=>{const w=de(p);return w&&w===e});n.body.dataset.mode="view",n.body.innerHTML=ue(o,{customer:h,reservations:A}),Ie(o),Ae(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function Ie(t){if(!t||!f.modal?.body)return;const e=f.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",n=>{n.preventDefault(),ke(t)})}function Ae(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const c=$t();let i=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const u=n.dataset.reservationId;u&&(i=c.findIndex(r=>[r?.id,r?.reservationId,r?.reservation_id].some(h=>h!=null&&String(h)===u)))}Number.isInteger(i)&&i>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(i):R(d("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),n.dataset.listenerAttached="true")})}function ke(t){if(!t||!mt())return;const e=f.modal;if(!e?.body)return;const{customers:n=[]}=ut(),a=n.find(o=>String(o.id)===String(t.clientId))||null,c=a?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||a?.companyName||a?.company||"",u=Array.isArray(t?.expenses)?t.expenses.map((o,r)=>({id:o?.id||`expense-${t.id}-${r}-${Date.now()}`,label:o?.label||"",amount:Number(o?.amount)||0})):[];e.body.dataset.mode="edit",e.body.innerHTML=me(t,{clientName:c,clientCompany:i}),Te(t,{clientName:c,clientCompany:i,expenses:u})}function Te(t,{clientName:e="",clientCompany:n="",expenses:a=[]}={}){const c={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},i=f.modal?.body?.querySelector("#project-details-edit-form");if(!i)return;const u=i.querySelector('[data-action="cancel-edit"]');u&&u.addEventListener("click",k=>{k.preventDefault(),J(t.id)});const o=i.querySelector("#project-edit-expense-label"),r=i.querySelector("#project-edit-expense-amount"),m=i.querySelector('[data-action="add-expense"]'),h=i.querySelector("#project-edit-expense-list"),A=i.querySelector('[name="project-start-date"]'),p=i.querySelector('[name="project-start-time"]'),w=i.querySelector('[name="project-end-date"]'),y=i.querySelector('[name="project-end-time"]');function v(){h&&(h.innerHTML=pe(c.expenses))}v(),m&&m.addEventListener("click",k=>{k.preventDefault();const E=o?.value.trim()||"",s=D(r?.value||"0"),l=Number(s);if(!E){R(d("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),o?.focus();return}if(!Number.isFinite(l)||l<=0){R(d("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),r?.focus();return}c.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:E,amount:l}),o&&(o.value=""),r&&(r.value=""),v()}),h&&h.addEventListener("click",k=>{const E=k.target.closest('[data-action="remove-expense"]');if(!E)return;const{id:s}=E.dataset;c.expenses=c.expenses.filter(l=>String(l.id)!==String(s)),v()}),i.addEventListener("submit",async k=>{if(k.preventDefault(),i.dataset.submitting==="true")return;const E=i.querySelector('[name="project-title"]'),s=i.querySelector('[name="project-type"]'),l=i.querySelector('[name="project-description"]'),g=i.querySelector('[name="project-payment-status"]'),S=i.querySelector('[name="project-apply-tax"]'),b=E?.value.trim()||"",P=s?.value||"",H=A?.value.trim()||"",z=p?.value.trim()||"",Gt=l?.value.trim()||"",gt=g?.value==="paid"?"paid":"unpaid",X=S?.checked===!0;if(!b||!P||!H){R(d("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),E?.focus();return}const yt=w?.value.trim()||"",Yt=y?.value.trim()||"",bt=St(H,z),Z=yt?St(yt,Yt):"";if(Z){const M=new Date(bt),N=new Date(Z);if(!Number.isNaN(M.getTime())&&!Number.isNaN(N.getTime())&&M>N){R(d("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),w?.focus();return}}const G=rt(t);if(!G){R(d("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const Dt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,Kt=ge({...t,expenses:c.expenses}),tt=Number((Dt+Kt).toFixed(2)),vt=X?Number((tt*he).toFixed(2)):0,Qt=X?Number((tt+vt).toFixed(2)):tt,Jt=ie({projectCode:t.projectCode,title:b,type:P,clientId:t.clientId,clientCompany:c.clientCompany,description:Gt,start:bt,end:Z||null,applyTax:X,paymentStatus:gt,equipmentEstimate:Dt,expenses:c.expenses,taxAmount:vt,totalWithTax:Qt,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),j=i.querySelector('button[type="submit"]');j&&(j.disabled=!0,j.dataset.originalText=j.textContent||"",j.textContent=d("projects.details.edit.saving","جاري الحفظ...")),i.dataset.submitting="true";try{const M=await ce(G,Jt);await fe(G,gt),document.dispatchEvent(new CustomEvent("projects:changed")),R(d("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),x();const N=rt(M)||G;N&&J(N)}catch(M){console.error("❌ [technicianDetails] Failed to update project from modal",M);const N=typeof M?.message=="string"?M.message:d("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");R(N)}finally{delete i.dataset.submitting,j&&(j.disabled=!1,j.dataset.originalText&&(j.textContent=j.dataset.originalText,delete j.dataset.originalText))}})}function At(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(i=>i!=null&&String(i)===n))||null}function Fe(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}Zt();te();ae();const je=new URLSearchParams(window.location.search),I=je.get("id"),_=document.getElementById("technician-details"),kt=document.getElementById("technician-hero-name"),B=document.getElementById("technician-hero-status"),Tt=document.getElementById("technician-hero-role"),Ft=document.getElementById("technician-hero-phone"),jt=document.getElementById("technician-hero-department"),F={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},T=document.getElementById("technician-financial-modal"),Y=document.getElementById("technician-financial-open"),xt=document.getElementById("technician-financial-modal-total"),Lt=document.getElementById("technician-financial-modal-paid"),Pt=document.getElementById("technician-financial-modal-outstanding"),nt=document.getElementById("technician-financial-modal-empty"),at=document.getElementById("technician-financial-modal-table-wrapper"),it=document.getElementById("technician-financial-modal-rows"),xe=Array.from(document.querySelectorAll("[data-financial-modal-close]")),lt=Array.from(document.querySelectorAll("[data-technician-tab]")),Le=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let ht="reservations",L=null,q={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,paidCount:0,outstandingCount:0},breakdown:[]};ee();function zt(){return document.documentElement.getAttribute("lang")||"ar"}function $(t){const e=Number(t)||0,a=zt()==="ar"?"ar-SA-u-ca-gregory":"en-US";try{const c=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${D(c)} SR`}catch{const i=Math.round(e);return`${D(String(i))} SR`}}function Mt(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const a=zt()==="ar"?"ar-SA-u-ca-gregory":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),u=String(e.getDate()).padStart(2,"0"),o=e.getFullYear();return`${i}/${u}/${o}`}}function ct(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Bt(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(D(String(n)));if(Number.isFinite(a))return a}return 0}function Pe(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="badge badge-outline badge-warning";return e==="paid"?(n="technicianFinancial.status.paid",a="badge badge-success"):e==="partial"&&(n="technicianFinancial.status.partial",a="badge badge-info"),`<span class="${a}">${d(n,n)}</span>`}function Ct(t){const{totals:e,metrics:n}=t,a=d("technicianFinancial.stats.totalDesc","مرتبطة بـ {count} مهام").replace("{count}",D(String(n.assignments))),c=d("technicianFinancial.stats.paidDesc","مدفوعة بالكامل في {count} حالات").replace("{count}",D(String(n.paidCount))),i=d("technicianFinancial.stats.outstandingDesc","بحاجة متابعة في {count} حجوزات").replace("{count}",D(String(n.outstandingCount)));F.total&&(F.total.textContent=$(e.total)),F.totalDesc&&(F.totalDesc.textContent=n.assignments>0?a:"—"),F.paid&&(F.paid.textContent=$(e.paid)),F.paidDesc&&(F.paidDesc.textContent=n.paidCount>0?c:"—"),F.outstanding&&(F.outstanding.textContent=$(e.outstanding)),F.outstandingDesc&&(F.outstandingDesc.textContent=n.outstandingCount>0?i:"—")}function dt(t){const{totals:e,breakdown:n}=t;if(xt&&(xt.textContent=$(e.total)),Lt&&(Lt.textContent=$(e.paid)),Pt&&(Pt.textContent=$(e.outstanding)),!it||!at||!nt)return;if(!n.length){it.innerHTML="",at.classList.add("hidden"),nt.classList.remove("hidden");return}const a=n.map(c=>{const i=c.period||"—",u=c.outstandingAmount>0?$(c.outstandingAmount):`<span class="text-success">${d("technicianFinancial.list.settled","لا يوجد")}</span>`;return`
      <tr>
        <td>
          <div class="font-semibold text-base-content">${ct(c.label)}</div>
          <div class="text-xs text-base-content/60">${ct(c.reference)}</div>
        </td>
        <td class="whitespace-nowrap">${ct(i)}</td>
        <td>${$(c.dueAmount)}</td>
        <td>${Pe(c.paidStatus)}</td>
        <td>${u}</td>
      </tr>
    `}).join("");it.innerHTML=a,at.classList.remove("hidden"),nt.classList.add("hidden")}function Me(){T&&(T.classList.remove("hidden"),T.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function ft(){T&&(T.classList.add("hidden"),T.classList.remove("modal-open"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function Vt(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function Be(t){if(t.preventDefault(),!L)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...L}}))}catch(a){console.error("⚠️ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function Ot(){Vt().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Be),t.dataset.listenerAttached="true")})}async function pt(t){if(q={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,paidCount:0,outstandingCount:0},breakdown:[]},Ct(q),dt(q),!I||!t)return;try{await _t({suppressError:!0})}catch(r){console.error("⚠️ [technician-page] Failed to load reservations for financial summary",r)}const n=$t(),a=String(I),i=n.filter(r=>!r||String(r.status||"").toLowerCase()==="cancelled"?!1:(Array.isArray(r.technicians)?r.technicians.map(h=>String(h)):[]).includes(a)).map(r=>{const m=Array.isArray(r.techniciansDetails)?r.techniciansDetails.find(b=>{const P=b?.id??b?.technician_id??b?.technicianId??b?.ID;return P!=null&&String(P)===a}):null,h=Bt(m)||Bt(t),A=Math.max(1,re(r.start,r.end)),p=Math.max(0,Math.round(h*A)),w=r.paidStatus||"unpaid",y=w==="paid"?p:0,v=Math.max(0,p-y),k=d("technicianFinancial.list.reservationFallback","حجز رقم {id}").replace("{id}",D(String(r.reservationId||r.id||"?"))),E=r.title&&r.title.trim().length?r.title.trim():k,s=[];if(r.reservationId||r.id){const b=r.reservationId||r.id;s.push(`#${D(String(b))}`)}if(r.projectId&&s.push(d("technicianFinancial.list.projectReference","مشروع #{id}").replace("{id}",D(String(r.projectId)))),r.status){const b=`reservations.status.${r.status}`;s.push(d(b,r.status))}const l=Mt(r.start),g=Mt(r.end),S=l===g?l:`${l} – ${g}`;return{label:E,reference:s.join(" • ")||"—",period:S,dueAmount:p,paidAmount:y,outstandingAmount:v,paidStatus:w}}),u=i.reduce((r,m)=>(r.total+=m.dueAmount,r.paid+=m.paidAmount,r.outstanding+=m.outstandingAmount,r),{total:0,paid:0,outstanding:0}),o={assignments:i.length,paidCount:i.filter(r=>r.paidStatus==="paid").length,outstandingCount:i.filter(r=>r.outstandingAmount>0).length};q={totals:u,metrics:o,breakdown:i},Ct(q),dt(q)}function C(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const c=n==null?"":String(n).trim(),i=c.length>0;t.textContent=i?`${e} ${c}`:`${e} —`,a?t.classList.toggle("hidden",!i):i||t.classList.remove("hidden")}function Rt(t){if(!B)return;const e=typeof t=="string"?t.toLowerCase():"";if(!e){B.className="badge badge-outline hidden",B.textContent="—";return}const n=e==="busy",a=["badge","px-3","py-2","text-sm","font-semibold"];n?a.push("badge-warning"):a.push("badge-success"),B.className=a.join(" "),B.classList.remove("hidden");const c=n?"technicians.status.busy":"technicians.status.available",i=n?"مشغول":"متاح";B.setAttribute("data-i18n",""),B.setAttribute("data-i18n-key",c),B.textContent=d(c,i)}function V(t){if(!t){C(kt,"😎","—"),C(Tt,"🎯","",{hideWhenEmpty:!0}),C(Ft,"📞","",{hideWhenEmpty:!0}),C(jt,"🏢","",{hideWhenEmpty:!0}),Rt(null);return}C(kt,"😎",t.name||"—"),C(Tt,"🎯",t.role||"",{hideWhenEmpty:!0}),C(Ft,"📞",t.phone?D(t.phone):"",{hideWhenEmpty:!0}),C(jt,"🏢",t.department||"",{hideWhenEmpty:!0}),Rt(t.status||t.baseStatus||"available")}function W(t){Vt().forEach(e=>{e.disabled=!!t})}function Q(t){t&&(ht=t,lt.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Le.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&I&&Ht(I),t==="reservations"&&I&&Ut(I))}function Ce(){lt.length&&(lt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&Q(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&Q(n)}),t.dataset.listenerAttached="true")}),Q(ht))}V(null);W(!0);Ce();Ot();Y&&!Y.dataset.listenerAttached&&(Y.addEventListener("click",()=>{dt(q),Me()}),Y.dataset.listenerAttached="true");xe.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{ft()}),t.dataset.listenerAttached="true")});T&&!T.dataset.listenerAttached&&(T.addEventListener("click",t=>{t.target===T&&ft()}),T.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&T&&T.classList.contains("modal-open")&&ft()});window.showReservationDetails=oe;const K=document.getElementById("logout-btn");K&&!K.dataset.listenerAttached&&(K.addEventListener("click",()=>ne()),K.dataset.listenerAttached="true");function Re(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function Wt(t){if(!_)return;if(V(t),!t){_.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,W(!0);return}const e=t.phone?D(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${d("reservations.details.technicians.phoneUnknown","غير متوفر")}</span>`,n=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${d("technicianDetails.fallback.role","غير محدد")}</span>`,a=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${d("technicianDetails.fallback.department","—")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${d("technicianDetails.fallback.notes","—")}</span>`,u=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${d("reservations.create.summary.currency","SR")}</span>`,o=`${Re(t.dailyWage)} ${u}`,r=t.baseStatus||t.status||"available",m=r==="busy"?"technicians.status.busy":"technicians.status.available",h=`<span class="badge ${r==="busy"?"badge-warning":"badge-success"}" data-i18n data-i18n-key="${m}">${d(m)}</span>`,p=[{key:"technicianDetails.fields.role",value:n},{key:"technicianDetails.fields.department",value:a},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.wage",value:o},{key:"technicianDetails.fields.baseStatus",value:h},{key:"technicianDetails.fields.notes",value:c}].map(({key:y,value:v})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${y}">${d(y)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${v}</p>
    </article>
  `).join(""),w=d("technicianDetails.actions.edit","✏️ تعديل عضو الطاقم");_.innerHTML=`
    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
      ${p}
    </div>
    <div class="mt-6 flex flex-wrap items-center gap-2">
      <button type="button" class="btn btn-warning" id="edit-technician-btn" data-technician-edit data-i18n data-i18n-key="technicianDetails.actions.edit">${w}</button>
    </div>
  `,Ot(),W(!1),Q(ht)}async function _e(){if(!_)return;if(!I){V(null),W(!0),L=null,_.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${d("technicianDetails.errors.missingId","⚠️ لا يوجد معرف عضو طاقم في الرابط.")}</p>`;return}_.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${d("technicianDetails.status.loading","⏳ جارٍ تحميل بيانات عضو الطاقم...")}</p>`,W(!0),V(null);let t=st(I);if(!t){try{await se()}catch(e){console.error("❌ [technician-details] Failed to load technician from API",e),_.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${d("technicianDetails.errors.loadFailed","❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.")}</p>`,V(null),L=null;return}t=st(I)}if(!t){_.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,V(null),L=null;return}L=t,await pt(t),Wt(t),Ut(I),Ht(I)}Nt();_e();const $e=async()=>{if(!I)return;Nt();const t=st(I);t&&(L=t,await pt(t),Wt(t))};window.addEventListener("technicians:updated",$e);const Ne=()=>{!I||!L||pt(L)};document.addEventListener("reservations:changed",Ne,{passive:!0});
