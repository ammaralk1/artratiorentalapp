import{s as m,t as i,n as u,u as U,f as R,l as ue,c as ae,A as Te}from"./auth.D09_E0J1.js";import{r as Ne,a as Fe}from"./controller.Dmes3TuD.js";import{getMaintenanceState as G,refreshMaintenanceFromApi as De,isApiError as V,buildMaintenancePayload as ze,createMaintenanceRequest as xe,categorizeMaintenanceStatus as Re,deleteMaintenanceRequest as He,updateMaintenanceRequest as Oe}from"./maintenanceService.DLPgwUA9.js";import"./reservationsService.DwVbVNH4.js";function ee(t){if(!t)return null;const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return null;const e=String(n.getDate()).padStart(2,"0"),a=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getFullYear()).slice(-2);return`${e}/${a}/${r}`}let M=G(),k=[],H=null,N=!1,T="",w=M.length>0,q={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},ie=null,y=null,v=null,h=null,F=null,O=null,D=null,g=null;async function j({showToastOnError:t=!0}={}){if(!N){N=!0,T="",_();try{await De(),w=!0}catch(n){n&&typeof n=="object"&&Number(n.status)===401?(w=M.length>0,T=""):(w=M.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",n),T=V(n)?n.message:i("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),t&&m(T,"error"))}finally{N=!1,M=G(),_()}}}function te(){return i("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function B(t){return u(String(t||"")).trim().toLowerCase()}function se(t=""){return u(String(t)).trim().toLowerCase()}function Ve(t={}){const n=String(t?.desc??"").trim(),e=u(String(t?.displayBarcode??t?.barcode??"")).trim();return e?`${n} | ${e}`:n}function je(t){const n=u(String(t||""));if(!n.trim())return{description:"",barcode:""};const[e,...a]=n.split("|");return{description:e.trim(),barcode:a.join("|").trim()}}function Q(t){return u(String(t||"")).trim().toLowerCase()}function p(t=""){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Pe(t=new Date){const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return null;const e=a=>String(a).padStart(2,"0");return`${n.getFullYear()}-${e(n.getMonth()+1)}-${e(n.getDate())} ${e(n.getHours())}:${e(n.getMinutes())}:${e(n.getSeconds())}`}function C(){return M=G(),M}function me(t){return C().find(e=>Number(e.id)===Number(t))||null}function pe(t){const n=String(t??"").trim().toLowerCase();return n?["maintenance","صيانة"].includes(n)?"maintenance":["reserved","محجوز"].includes(n)?"reserved":["retired","متوقف","خارج الخدمة"].includes(n)?"retired":"available":"available"}function re(){const{equipment:t=[]}=ue(),n=i("maintenance.table.noName","بدون اسم");return k=(t||[]).map(e=>{const a=String(e?.barcode??"").trim(),r=B(a),c=Number.parseInt(e?.qty??e?.quantity??0,10),s=Number.isFinite(c)?Math.max(c,0):1,o=e?.image||e?.imageUrl||e?.image_url||"",l=e?.status||"متاح",d=e?.desc||e?.description||e?.name||n,b=Ve({desc:d,displayBarcode:a,barcode:r});return{id:e?.id??e?.equipment_id??e?.equipmentId??null,barcode:r,displayBarcode:a,desc:d,status:l,statusNormalized:pe(l),price:Number(e?.price||e?.unit_price)||0,category:e?.category||"",quantity:s,image:o,searchValue:b,searchValueNormalized:Q(b),descriptionNormalized:se(d)}}),k.sort((e,a)=>e.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),k}function oe(){const t=new Set,n=new Map;return C().filter(e=>e.status==="open").forEach(e=>{const a=B(e.equipmentBarcode);a&&(t.add(a),n.set(a,(n.get(a)||0)+1))}),{set:t,map:n}}function fe(t){const n=B(t);if(!n)return 0;const{map:e}=oe();return e.get(n)||0}function J(t){const n=B(t);return n&&(k.length?k:re()).find(a=>a.barcode===n)||null}function Ue(t){const n=k.length?k:re();if(!n.length)return null;const e=Q(t);if(e){const o=n.find(l=>l.searchValueNormalized===e);if(o)return o}const{description:a,barcode:r}=je(t);if(r){const o=B(r);if(o){const l=n.find(d=>d.barcode===o);if(l)return l}}const c=se(a||t);if(!c)return null;const s=n.find(o=>o.descriptionNormalized===c);return s||n.find(o=>o.descriptionNormalized.includes(c))||null}function ne(t,n=null){if(!t)return!0;const e=t.barcode,a=Number.isFinite(t.quantity)?t.quantity:0,c=(n||oe().map).get(e)||0;return a<=0?!0:a===1?t.statusNormalized==="maintenance"||c>=1:c>=a}function A({keepInputs:t=!1,silent:n=!1}={}){const e=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search"),c=document.getElementById("maintenance-selected-info");e&&(e.value=""),t||(a&&(a.value=""),r&&(r.value="")),c&&(c.textContent=te(),c.classList.remove("maintenance-selected-info--has-selection")),H=null}function be(t){const n=document.getElementById("maintenance-selected-info");if(!n)return;const e=i("maintenance.info.barcodeLabel","باركود"),a=i("maintenance.report.notAvailable","غير متوفر"),r=i("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),c=i("maintenance.info.categoryLabel","القسم"),s=t.displayBarcode||t.barcode||a,o=t.barcode,l=Number.isFinite(t.quantity)?t.quantity:0,d=fe(o),b=Math.max(l-d,0),f=t.category?`
    <div class="maintenance-selected-info__meta">${c}: <strong>${p(t.category)}</strong></div>
  `:"",$=l>0?`
    <div class="maintenance-selected-info__meta">
      ${r}: <strong>${b}</strong> / ${l}
    </div>
  `:"",L=t.image?`<img class="maintenance-selected-info__image" src="${p(t.image)}" alt="${p(t.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';n.innerHTML=`
    <div class="maintenance-selected-info__media">${L}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${p(t.desc)}</div>
      <div class="maintenance-selected-info__meta">${e}: <strong>${p(s)}</strong></div>
      ${$}
      ${f}
    </div>
  `,n.classList.add("maintenance-selected-info--has-selection")}function ce(t,{silent:n=!1}={}){if(!t)return!1;if(ne(t))return n||m(i("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const e=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search");return e&&(e.value=t.barcode),a&&(a.value=t.displayBarcode||t.barcode),r&&(r.value=t.searchValue||t.desc),be(t),H=t,!0}function ve(t,{showFeedback:n=!0}={}){const e=J(t);return e?ce(e,{silent:!n}):(n&&m(i("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function ge(t,{showFeedback:n=!0}={}){const e=Ue(t);return e?ce(e,{silent:!n}):(n&&m(i("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function le(){const t=document.getElementById("maintenance-equipment-options"),n=document.getElementById("maintenance-equipment-barcode"),e=document.getElementById("maintenance-equipment-search"),a=re(),{map:r}=oe();t&&(t.innerHTML=a.map(s=>`<option value="${p(s.searchValue||s.desc)}"></option>`).join(""));const c=document.getElementById("maintenance-selected-barcode");if(c&&c.value){const s=J(c.value);!s||ne(s,r)?(A({keepInputs:!0,silent:!0}),s&&ne(s,r)&&m(i("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):ce(s,{silent:!0})}else A({keepInputs:!0,silent:!0});if(n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),ve(n.value)||A({keepInputs:!0,silent:!0}))}),n.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached){const s=()=>{if(!e.value){A({keepInputs:!0,silent:!0});return}ge(e.value)||A({keepInputs:!0,silent:!0})};e.addEventListener("change",s),e.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),s())}),e.dataset.listenerAttached="true"}}async function Y(){try{await Ne({showToastOnError:!1})}catch(t){console.error("❌ [maintenance] refreshEquipmentData failed",t)}finally{Fe(),le()}}function ye(){const t=document.getElementById("closeMaintenanceModal");if(!t)return!1;const n=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!n?.Modal)return!1;ie=n.Modal.getOrCreateInstance(t),y||(y=t.querySelector("#maintenance-close-report")),v||(v=t.querySelector("#maintenance-close-cost")),v&&v.dataset.normalizeAttached!=="true"&&(v.addEventListener("input",a=>{Qe(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),v.dataset.normalizeAttached="true"),h||(h=t.querySelector("#maintenance-close-submit")),F||(F=t.querySelector("#maintenance-close-modal-details"));const e=t.querySelector("#maintenance-close-form");return e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",Ge),e.dataset.listenerAttached="true"),t.dataset.listenerAttached||(t.addEventListener("hidden.bs.modal",he),t.dataset.listenerAttached="true"),!0}function he(){q={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},y&&(y.value="",y.classList.remove("is-invalid")),v&&(v.value="",v.classList.remove("is-invalid")),F&&(F.innerHTML=""),P(!1);const t=document.getElementById("closeMaintenanceModal");if(t){const n=t.querySelector("#maintenance-close-modal-title"),e=t.querySelector(".maintenance-close-modal__subtitle");n&&(n.textContent=i("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),e&&(e.textContent=i("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.")),h&&(h.textContent=i("maintenance.closeModal.confirm","إغلاق التذكرة"))}}function Ee(){const t=document.getElementById("maintenanceReportModal");if(!t)return!1;const n=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return n?.Modal?(O=n.Modal.getOrCreateInstance(t),D||(D=t.querySelector("#maintenance-report-modal-content")),g||(g=t.querySelector("#maintenance-report-edit")),t.dataset.listenerAttached||(t.addEventListener("hidden.bs.modal",qe),t.dataset.listenerAttached="true"),g&&g.dataset.listenerAttached!=="true"&&(g.addEventListener("click",et),g.dataset.listenerAttached="true"),!0):!1}function qe(){D&&(D.innerHTML=""),g&&(g.hidden=!0,g.disabled=!1,delete g.dataset.id)}function P(t){if(!h)return;const n=q.mode==="edit",e=n?i("maintenance.closeModal.editSaving","⏳ جاري الحفظ..."):i("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),a=n?i("maintenance.closeModal.editConfirm","حفظ التعديلات"):i("maintenance.closeModal.confirm","إغلاق التذكرة");t?(h.disabled=!0,h.dataset.loading="true",h.textContent=e):(h.disabled=!1,h.removeAttribute("data-loading"),h.textContent=a)}function Qe(t){if(!t)return;const n=t.value;if(typeof n!="string")return;const e=u(n).replace(/٫/g,".").replace(/٬/g,",");if(e!==n){const{selectionStart:a,selectionEnd:r}=t;if(t.value=e,a!==null&&r!==null)try{t.setSelectionRange(a,r)}catch{}}}function Ye(t,n){const e=typeof t=="string"?t.trim():"",a=Number.isFinite(n);if(!e)return{provided:a,value:null,error:null};const c=u(e).replace(/٫/g,".").replace(/٬/g,",").replace(/[^0-9.,-]/g,"");if(!c)return{provided:!0,value:null,error:"invalid"};const s=c.includes(","),o=c.includes(".");let l=c;s&&!o?l=c.replace(",","."):s&&o&&(l=c.replace(/,/g,""));const d=Number.parseFloat(l);return!Number.isFinite(d)||d<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(d*100)/100,error:null}}function _e(t,{mode:n="close"}={}){const e=me(t);if(!e){m(i("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!ye()){const l=prompt(i("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(l===null)return;const d=l.trim();if(!d){m(i("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}$e(t,d);return}const a=e.repairCost!=null&&e.repairCost!==""?Number.parseFloat(u(String(e.repairCost))):null,r=Number.isFinite(a)?Math.round(a*100)/100:null,c=n==="edit"?"edit":"close";if(q={id:e.id,equipmentDesc:e.equipmentDesc||"",equipmentBarcode:e.equipmentBarcode||"",repairCost:r,resolvedAt:e.resolvedAt||null,mode:c},y&&(y.value=e.resolutionReport||"",y.classList.remove("is-invalid")),v&&(r!==null?v.value=u(r.toFixed(2)):v.value="",v.classList.remove("is-invalid")),F){const l=i("maintenance.report.barcode","الباركود"),d=i("maintenance.report.notAvailable","غير متوفر"),b=q.equipmentDesc||d,f=q.equipmentBarcode?u(q.equipmentBarcode):d;F.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${b}</div>
          <div class="maintenance-close-modal__ticket-meta">${l}: <span>${f}</span></div>
        </div>
      </div>
    `}P(!1);const s=c==="edit";h&&(h.textContent=s?i("maintenance.closeModal.editConfirm","حفظ التعديلات"):i("maintenance.closeModal.confirm","إغلاق التذكرة"));const o=document.getElementById("closeMaintenanceModal");if(o){const l=o.querySelector("#maintenance-close-modal-title"),d=o.querySelector(".maintenance-close-modal__subtitle");l&&(l.textContent=s?i("maintenance.closeModal.editTitle","✏️ تعديل بيانات الإغلاق"):i("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),d&&(d.textContent=s?i("maintenance.closeModal.editSubtitle","يمكنك تحديث تقرير الإصلاح وتكلفته."):i("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة."))}ie?.show(),setTimeout(()=>{y?.focus(),y?.setSelectionRange(y.value.length,y.value.length)},150)}async function Ge(t){if(t?.preventDefault(),!q.id){m(i("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!y)return;const n=y.value.trim();if(!n){m(i("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),y.focus();return}v&&v.classList.remove("is-invalid");const e=v?Ye(v.value,q.repairCost):{provided:!1,value:null,error:null};if(e.error){m(i("maintenance.toast.invalidRepairCost","⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح"),"error"),v?.classList.add("is-invalid"),v?.focus();return}P(!0),(await $e(q.id,n,{repairCost:e.value,repairCostProvided:e.provided,mode:q.mode,resolvedAt:q.resolvedAt})).success?ie?.hide():P(!1)}function Je(t){const n=document.getElementById("maintenance-stats");if(!n)return;const e=t.length,a=t.filter(f=>f.status==="open").length,r=e-a,c=f=>u(String(f)),s=i("maintenance.stats.summaryTitle","ملخص الصيانة"),o=i("maintenance.filters.status.open","قيد الصيانة"),l=i("maintenance.filters.status.closed","مغلقة"),d=i("maintenance.stats.totalLabel","إجمالي التذاكر"),b=(f,$,L)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${L}">
      <span class="maintenance-summary__value">${c(f)}</span>
      <span class="maintenance-summary__label">${$}</span>
    </div>
  `;n.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${s}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${b(a,o,"open")}
        ${b(r,l,"closed")}
        ${b(e,d,"total")}
      </div>
    </section>
  `}function Ke(t){const e=String(t?.statusRaw??t?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Re(e)||"open",r={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},c=r[a]??r.open,s=c?i(c.key,c.fallback):i("maintenance.status.open","قيد الصيانة"),o=t?.statusLabel&&String(t.statusLabel).trim()?String(t.statusLabel).trim():s,l=["maintenance-status-badge","maintenance-status-tag"];return c?.className&&l.push(c.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${e}`),`<span class="${l.filter(Boolean).join(" ")}">${o}</span>`}function We(t){const n=document.getElementById("maintenance-table-body"),e=document.getElementById("maintenance-empty-state");if(n){if(!t||t.length===0){const a=i("maintenance.empty.title","لا توجد تذاكر صيانة"),r=i("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");n.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${r}</p>
        </td>
      </tr>
    `,e&&e.classList.add("active");return}e&&e.classList.remove("active"),n.innerHTML=t.map(a=>{const r=Ke(a),c=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",s=(()=>{const X=i("maintenance.priority.high","مرتفعة"),E=i("maintenance.priority.medium","متوسطة"),Z=i("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${X}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${Z}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${E}</span>`}})(),o=[],l=i("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),d=i("maintenance.actions.view","👁️ عرض التقرير"),b=i("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?o.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):o.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${d}</button>`),U()&&o.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${b}</button>`);const f=o.join(""),$=i("maintenance.table.noBarcode","بدون باركود"),L=i("maintenance.report.none","—"),z=a.equipmentBarcode?u(a.equipmentBarcode):$,I=a.issue?u(a.issue):L,S=a.repairCost!=null?Number.parseFloat(u(String(a.repairCost))):null,K=a.status==="closed"&&Number.isFinite(S)?`<div class="maintenance-repair-cost">${p(i("maintenance.table.repairCost","💰 تكلفة الإصلاح: {amount}").replace("{amount}",u(S.toFixed(2))))}</div>`:"",W=a.createdAt?u(ee(a.createdAt)||R(a.createdAt)):"—";return`
        <tr class="${c}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${z}</small>
          </td>
          <td class="maintenance-issue-text">${I}${K}</td>
          <td>${s}</td>
          <td>${W}</td>
          <td>${r}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${f}
            </div>
          </td>
        </tr>
      `}).join("")}}function Xe(t){if(!w||N){m(i("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const n=t.target.closest("button[data-action]");if(!n)return;const e=n.getAttribute("data-action"),a=Number(n.getAttribute("data-id"));if(a){if(e==="close")_e(a);else if(e==="view")Ze(a);else if(e==="delete"){if(!U()){ae();return}tt(a).catch(r=>{console.error("❌ [maintenance] deleteTicket failed",r)})}}}async function $e(t,n,e={}){const a=me(t);if(!a)return m(i("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const r=(n??"").trim();if(!r)return m(i("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const c=e?.mode==="edit"&&e?.resolvedAt?e.resolvedAt:Pe(new Date)||new Date().toISOString(),s={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:r,resolved_at:c};e?.repairCostProvided&&(s.repair_cost=e.repairCost!=null?Math.round(e.repairCost*100)/100:null);try{await Oe(t,s),await j({showToastOnError:!1});const o=document.getElementById("maintenance-status-filter");return o&&o.value==="open"&&(o.value="all"),await Y(),_(),m(i("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(o){if(console.error("❌ [maintenance] closeTicket failed",o),V(o)&&o.status===404)return await j({showToastOnError:!1}),await Y(),_(),m(i("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const l=V(o)?o.message:i("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return m(l,"error"),{success:!1,error:o}}}function Ze(t){const e=C().find(E=>Number(E.id)===Number(t));if(!e)return;if(e.id,!Ee()){const E=i("maintenance.report.equipment","المعدة"),Z=i("maintenance.report.barcode","الباركود"),Le=i("maintenance.report.issue","الوصف"),Be=i("maintenance.report.createdAt","تاريخ الإنشاء"),Me=i("maintenance.report.closedAt","تاريخ الإغلاق"),Ce=i("maintenance.report.summary","التقرير"),Se=i("maintenance.report.repairCost","تكلفة الإصلاح"),Ae=i("maintenance.report.currencyLabel","ريال"),de=Number.parseFloat(u(String(e.repairCost??""))),ke=Number.isFinite(de)?`${u(de.toFixed(2))} ${Ae}`:x,we=i("maintenance.report.notAvailable","غير متوفر"),x=i("maintenance.report.none","—"),Ie=[`${E}: ${e.equipmentDesc}`,`${Z}: ${e.equipmentBarcode?u(e.equipmentBarcode):we}`,`${Le}: ${e.issue?u(e.issue):x}`,`${Be}: ${e.createdAt?u(ee(e.createdAt)||R(e.createdAt)):x}`,`${Me}: ${e.resolvedAt?u(R(e.resolvedAt)):x}`,`${Se}: ${ke}`,`${Ce}: ${e.resolutionReport?u(e.resolutionReport):x}`].join(`
`);alert(Ie);return}const a=i("maintenance.report.equipment","المعدة"),r=i("maintenance.report.barcode","الباركود"),c=i("maintenance.report.issue","الوصف"),s=i("maintenance.report.createdAt","تاريخ الإنشاء"),o=i("maintenance.report.closedAt","تاريخ الإغلاق"),l=i("maintenance.report.repairCost","تكلفة الإصلاح"),d=i("maintenance.report.summary","التقرير"),b=i("maintenance.report.notAvailable","غير متوفر"),f=i("maintenance.report.none","—"),$=Number.parseFloat(u(String(e.repairCost??""))),L=Number.isFinite($)?u($.toFixed(2)):null,z=i("maintenance.report.currencyLabel","ريال"),I=[{label:a,value:`<span class="maintenance-report-modal__value">${p(e.equipmentDesc||f)}</span>`},{label:r,value:e.equipmentBarcode?`<span class="maintenance-report-modal__value">${p(u(e.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${p(b)}</span>`},{label:c,value:e.issue?`<span class="maintenance-report-modal__value">${p(u(e.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${p(f)}</span>`},{label:s,value:e.createdAt?`<span class="maintenance-report-modal__value">${p(u(ee(e.createdAt)||R(e.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${p(f)}</span>`},{label:o,value:e.resolvedAt?`<span class="maintenance-report-modal__value">${p(u(R(e.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${p(f)}</span>`},{label:l,value:L?`<span class="maintenance-report-modal__value">${p(L)} ${p(z)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${p(f)}</span>`}],S=e.resolutionReport?u(e.resolutionReport):"",K=S?`<p>${p(S).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${p(f)}</p>`,W=I.map(E=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${p(E.label)}</span>
        ${E.value}
      </div>
    `).join(""),X=`
    <div class="maintenance-report-modal__summary">
      <h6>${p(d)}</h6>
      ${K}
    </div>
  `;if(D&&(D.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${W}
        </div>
        ${X}
      </div>
    `),g){const E=U()&&e.status==="closed";g.hidden=!E,g.disabled=!E,g.textContent=i("maintenance.actions.editClosed","✏️ تعديل بيانات الإغلاق"),E?g.dataset.id=String(e.id):delete g.dataset.id}O?.show()}function et(){if(!g)return;const t=Number(g.dataset.id);if(!t){O?.hide();return}if(!U()){O?.hide(),ae();return}O?.hide(),setTimeout(()=>{_e(t,{mode:"edit"})},220)}async function tt(t){if(!U()){ae();return}if(!C().find(a=>Number(a.id)===Number(t))){m(i("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(i("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await He(t),await j({showToastOnError:!1}),await Y(),m(i("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const r=V(a)?a.message:i("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");m(r,"error")}}async function nt(t){t.preventDefault();try{const n=document.getElementById("maintenance-equipment-barcode"),e=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),r=document.getElementById("maintenance-issue"),c=document.getElementById("maintenance-priority");let s=H,o=B(a?.value);if(!s&&o&&(s=J(o)),!s&&n?.value&&ve(n.value,{showFeedback:!0})&&(s=H,o=B(s?.barcode)),!s&&e?.value&&ge(e.value,{showFeedback:!0})&&(s=H,o=B(s?.barcode)),!s||!o){m(i("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=ue();let d=(l||[]).find(S=>B(S?.barcode)===o);if(!d&&s&&(d={id:s.id,barcode:s.barcode,desc:s.desc,name:s.desc,status:s.status||"متاح",quantity:s.quantity,qty:s.quantity}),!d||d.id==null){m(i("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),A();return}const b=Number.parseInt(d.qty??d.quantity??s?.quantity??1,10),f=Number.isFinite(b)&&b>0?b:1,$=fe(o);if(pe(d.status||s?.status)==="maintenance"&&f<=1){m(i("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if($>=f){m(i("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const z=ze({equipmentId:d.id,technicianId:null,issue:r?.value.trim()||"",priority:c?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await xe(z),await j({showToastOnError:!1}),await Y(),m(i("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),A(),r&&(r.value=""),c&&(c.value="medium");const I=document.getElementById("maintenance-status-filter");I&&(I.value="all")}catch(n){console.error("❌ [maintenance] Failed to create ticket",n);const e=V(n)?n.message:i("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");m(e,"error")}}function at({status:t="all",query:n="",priority:e="all"}={}){let r=C();t!=="all"&&(r=r.filter(s=>s.status===t)),e!=="all"&&(r=r.filter(s=>String(s.priority||"medium")===e));const c=Q(n||"");return c&&(r=r.filter(s=>{const o=se(s.equipmentDesc||""),l=Q(s.equipmentBarcode||"");return o.includes(c)||l.includes(c)})),r}function _(){const t=C();le(),Je(t);const n=document.getElementById("maintenance-status-filter");n&&!n.value&&(n.value="all");const e=n?.value||"all",r=document.getElementById("maintenance-search")?.value||"",s=document.getElementById("maintenance-priority-filter")?.value||"all",o=document.getElementById("maintenance-table-body"),l=document.getElementById("maintenance-empty-state");if(!o)return;if(N&&!w){const b=i("maintenance.table.loading","جاري التحميل...");o.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${b}</td></tr>`,l&&l.classList.remove("active");return}if(T&&!w){o.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${T}</td></tr>`,l&&l.classList.remove("active");return}const d=at({status:e,query:r,priority:s});We(d)}function ct(){C(),le(),w=M.length>0,N=!1,_(),j({showToastOnError:!1}),ye()&&he(),Ee()&&qe();const t=document.getElementById("maintenance-form");t&&!t.dataset.listenerAttached&&(t.addEventListener("submit",c=>{nt(c).catch(s=>{console.error("❌ [maintenance] submit handler failed",s)})}),t.dataset.listenerAttached="true");const n=document.getElementById("maintenance-status-filter");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{_()}),n.dataset.listenerAttached="true");const e=document.getElementById("maintenance-priority-filter");e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{_()}),e.dataset.listenerAttached="true");const a=document.getElementById("maintenance-search");if(a&&!a.dataset.listenerAttached){const c=()=>_();a.addEventListener("input",c),a.addEventListener("change",c),a.dataset.listenerAttached="true"}const r=document.querySelector(".maintenance-table");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",Xe),r.dataset.listenerAttached="true")}C();document.addEventListener("language:changed",()=>{const t=document.getElementById("maintenance-selected-barcode"),n=document.getElementById("maintenance-selected-info");if(t?.value){const e=J(t.value);e?be(e):n&&(n.textContent=te())}else n&&(n.textContent=te());_(),P(!1)});document.addEventListener(Te.USER_UPDATED,()=>{_()});window.addEventListener("maintenance:updated",()=>{M=G(),_()});export{ct as initMaintenance,_ as renderMaintenance};
