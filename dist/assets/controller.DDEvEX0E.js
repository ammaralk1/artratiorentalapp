import{d as te,n as k,t as c,j as b,b as Ce,z as Ua,y as Kt,v as Ga,w as Ka,u as Wa}from"./auth.g2-5obuT.js";import{g as Fe,r as st,f as dn,a as Qa,b as ft,i as Hn,c as wn}from"./details.75cGr1ku.js";import{k as ln,l as An,n as Se,s as Bn,o as rt,b as Wt,D as We,p as Ze,q as gt,h as On,c as $t,e as qt,t as Un,v as Ja,w as Gn,x as Ya,y as Xa,z as Kn,a as yt,d as Za,A as Qt,B as Jt,C as Ft,E as wt,F as At,g as Wn,G as es,H as ts,I as ns,u as as,r as ss,J as rs,j as is}from"./reservationsService.Dgh4u2C9.js";import{o as un,p as Qn,q as os,u as Qe,v as vt,w as be,n as z,x as Jn,y as mn,l as _e,z as Mt,A as Nt,B as cs,C as Yn,D as Xn,E as Zn,s as mt,F as ea,G as Je,b as pn,H as ds,I as ls,J as us,K as ta,L as ms,M as ps,k as na,N as Pn}from"./state.CYuafVY6.js";import{d as fn,E as aa,a as fs,c as gs,e as ys,r as vs,s as hs}from"./uiBridge.a0wQwCk9.js";import{g as bs,a as Is,b as Es}from"./reservationPdf.DnuCOueF.js";import{o as Ss}from"./view.B-GfEcne.js";import{c as sa,r as ra,d as ks,a as ws}from"./reservationsActions.DFLYfZXP.js";import{ensureProjectsLoaded as As}from"./projectsService.CzzziWDY.js";const Bs="__DEBUG_CREW__";function Ps(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Bs);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Ln(e,n){if(Ps())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const ia="projects:create:draft",oa="projects.html#projects-section";let Yt=null,ca=[],Xt=new Map,Zt=new Map,_t=new Map,Ut=!1,Bt=null,Cn=!1,da=[];const Re="reservations:create:draft";let tt=!1;function Vt(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function gn(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function Ls(){if(typeof document>"u"||!Vt())return null;try{const{input:n,hidden:t}=at(),{input:a,hidden:r}=xe(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",o=document.getElementById("res-start-time")?.value||"",d=document.getElementById("res-end-time")?.value||"",u=document.getElementById("res-notes")?.value||"",l=document.getElementById("res-discount")?.value||"",g=document.getElementById("res-discount-type")?.value||"percent",p=!!document.getElementById("res-tax")?.checked,m=!!document.getElementById("res-company-share")?.checked,y=m?Xe("res-company-share"):null,h=document.getElementById("res-payment-status")?.value||"unpaid",B=document.getElementById("res-payment-progress-type")?.value||"percent",I=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:o,endTime:d,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:u,discount:String(l||""),discountType:g,taxEnabled:p,companyShareEnabled:m,companySharePercent:y,paymentStatus:h,paymentProgressType:B,paymentProgressValue:String(I||""),items:be()||[],technicianIds:Xa()||[],crewAssignments:ln()||[]}}catch{return null}}function De(){if(tt)return;const e=Vt(),n=gn();if(!e&&!n)return;const t=Ls();if(t){try{const r=(()=>{const i=e?e.getItem(Re):null,o=!i&&n?n.getItem(Re):null,d=i||o;return d?JSON.parse(d):null})(),s=i=>{if(!i)return!1;const o=Array.isArray(i.items)&&i.items.length>0,d=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,u=!!(i.startDate||i.endDate||i.startTime||i.endTime),l=!!(i.customerId||i.customerLabel);return o||d||u||l};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(Re,a),n&&n!==e&&n.setItem(Re,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function la(){const e=Vt(),n=gn();if(!(!e&&!n))try{e&&e.removeItem(Re),n&&n!==e&&n.removeItem(Re)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function Cs(){const e=Vt(),n=gn();if(!e&&!n)return;tt=!0;let t=null;try{const a=e?e.getItem(Re):null,r=!a&&n?n.getItem(Re):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),tt=!1;return}if(t)try{if(t.startDate||t.startTime){const i=Qe(t.startDate||"",t.startTime||"");Ve("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=Qe(t.endDate||"",t.endTime||"");Ve("res-end","res-end-time",i)}if(t.customerId){Ae({selectedValue:String(t.customerId)});const{input:i,hidden:o}=at();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){Ae({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=at();i&&(i.value=t.customerLabel),o&&(o.value="");try{const d=Tt(t.customerLabel,{allowPartial:!0});d&&(o.value=String(d.id),i.value=d.label,i.dataset.selectedId=String(d.id))}catch{}}if(t.projectId)Me({selectedValue:String(t.projectId)});else if(t.projectLabel){Me({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=xe();i&&(i.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",ve(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(vt(t.items),le()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{Bn(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{Bn(t.technicianIds)}catch{}Ne();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}O()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{tt=!1}}function $s(e){if(!e)return null;let n=da.find(a=>a.id===e)||null;if(n)return n;const t=ds(e);return t?(n={id:e,name:us(t)||e,price:ls(t),items:pn(t),raw:t},n):null}function xt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function jt(e){return k(String(e||"")).trim().toLowerCase()}function qs(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=k(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function ua(e){const n=k(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function ma(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function pa(e){if(!e)return null;const n=k(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function fa(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=k(String(n))}}function Ye(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function at(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function xe(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function Ee(){const{input:e,hidden:n}=xe();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function Ke(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function ga(e,n,{allowPartial:t=!1}={}){const a=Se(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,o)=>{o.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function Tt(e,n={}){return ga(Xt,e,n)}function en(e,n={}){return ga(Zt,e,n)}function ve(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function ya(e){ca=Array.isArray(e)?[...e]:[]}function yn(){return ca}function vn(e){return e&&yn().find(n=>String(n.id)===String(e))||null}function $n(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function Xe(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??We,a=k(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:We}function Be(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??We,a=k(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=We),n.dataset.companyShare=String(r),n.checked=!0}function tn(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Ut){O();return}Ut=!0;const a=()=>{Ut=!1,O()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(We)),n.disabled){t.checked=!1,b(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),Be()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Be():t.checked&&(t.checked=!1));a()}function Ns(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function qn(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function Nn(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function Ae({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=at();if(!t||!a||!r)return;const s=un()||[],i=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const d=new Set;Xt=new Map;const u=s.filter(f=>f&&f.id!=null).map(f=>({id:String(f.id),label:Nn(f)||o})).filter(f=>{if(!f.label)return!1;const m=Se(f.label);return!m||d.has(m)?!1:(d.add(m),Xt.set(m,f),!0)}).sort((f,m)=>f.label.localeCompare(m.label,void 0,{sensitivity:"base"}));r.innerHTML=u.map(f=>`<option value="${xt(f.label)}"></option>`).join("");const l=n?"":t.value,g=e?String(e):a.value?String(a.value):"",p=g?s.find(f=>String(f.id)===g):null;if(p){const f=Nn(p)||o;a.value=String(p.id),t.value=f,t.dataset.selectedId=String(p.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":l}function Me({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=xe();if(!a||!r||!s)return;const i=Array.isArray(n)?n:yn()||[],o=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const d=[...i].filter(y=>y&&y.id!=null).sort((y,h)=>String(h.createdAt||h.start||"").localeCompare(String(y.createdAt||y.start||""))),u=t?"":a.value,l=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),g=new Set;Zt=new Map;const p=d.map(y=>{const h=$n(y)||l;return{id:String(y.id),label:h}}).filter(y=>{if(!y.label)return!1;const h=Se(y.label);return!h||g.has(h)?!1:(g.add(h),Zt.set(h,y),!0)});s.innerHTML=p.map(y=>`<option value="${xt(y.label)}"></option>`).join("");const f=e?String(e):r.value?String(r.value):"",m=f?d.find(y=>String(y.id)===f):null;if(m){const y=$n(m)||l;r.value=String(m.id),a.value=y,a.dataset.selectedId=String(m.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":u}function Ve(e,n,t){const{date:a,time:r}=ea(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const o=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,o)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,o)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function va(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||Me({selectedValue:a});const s=(un()||[]).find(l=>String(l.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";Ae(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=qn(e,"start"),d=qn(e,"end");o&&Ve("res-start","res-start-time",o),d&&Ve("res-end","res-end-time",d);const u=document.getElementById("res-notes");u&&e.description&&(n||!u.value)&&(u.value=e.description),O(),Ne()}function ha({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:te(),r=Array.isArray(a)?a:[];ya(r);const s=n!=null?String(n):t.value?String(t.value):"";Me({selectedValue:s,projectsList:r}),Ne(),O()}function Ne(){const{input:e,hidden:n}=xe(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),u=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),g=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(Ke(t,Ee),a&&Ke(a,Ee)),r&&Ke(r,Ee),s&&Ke(s,Ee),i&&Ke(i,Ee),o&&Ke(o,Ee),d&&Ke(d,Ee),g)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),r&&(r.value="unpaid",ve(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=u);else{if(t){const p=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",p&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}tn("tax"),O()}function hn(){const{input:e,hidden:n}=xe();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?en(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=vn(s.id);i?va(i,{skipProjectSelectUpdate:!0}):(Ne(),O())}else n.value="",e.dataset.selectedId="",Ne(),O()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?en(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{De()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function bn(){const{input:e,hidden:n}=at();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Tt(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),O()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Tt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{De()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function _s(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){lt({clearValue:!0});return}let t=null;try{const u=decodeURIComponent(n);t=JSON.parse(u)}catch(u){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),lt({clearValue:!1}),!t)return;t.fromProjectForm&&(Bt={draftStorageKey:t.draftStorageKey||ia,returnUrl:t.returnUrl||oa});const s=document.getElementById("res-project");if(t.projectId){s&&(Me({selectedValue:String(t.projectId)}),Ne());const u=vn(t.projectId);u?va(u,{forceNotes:!!t.forceNotes}):O(),lt()}else{s&&Me({selectedValue:""});const u=t.projectTitle?t.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");Js(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),u)}t.start&&Ve("res-start","res-start-time",t.start),t.end&&Ve("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(t.customerId){const l=(un()||[]).find(g=>String(g.id)===String(t.customerId));l?.id!=null&&(Ae({selectedValue:String(l.id)}),o&&(o.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else t.customerName&&i?(Ae({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",o&&(o.value="")):Ae({selectedValue:""});const d=document.getElementById("res-notes");d&&t.description&&!d.value&&(d.value=t.description),O()}function He(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Qe(e,t),end:Qe(n,a)}}function ba(e){const n=jt(e);if(n){const o=_t.get(n);if(o)return o}const{description:t,barcode:a}=ua(e);if(a){const o=dn(a);if(o)return o}const r=Se(t||e);if(!r)return null;let s=Jn();if(!s?.length){const o=te();s=Array.isArray(o?.equipment)?o.equipment:[],s.length&&ta(s)}const i=s.find(o=>Se(o?.desc||o?.description||"")===r);return i||s.find(o=>Se(o?.desc||o?.description||"").includes(r))||null}function Ia(e,n="equipment-description-options"){const t=jt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(d=>jt(d.value)===t)||_t.has(t))return!0;const{description:r}=ua(e);if(!r)return!1;const s=Se(r);return s?(Jn()||[]).some(o=>Se(o?.desc||o?.description||"")===s):!1}const xs={available:0,reserved:1,maintenance:2,retired:3};function js(e){return xs[e]??5}function _n(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Ts(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${_n(t)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${_n(t)})`}function ze(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=fn(),a=te(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];ta(s);const i=new Map;s.forEach(u=>{const l=qs(u),g=jt(l);if(!g||!l)return;const p=Fe(u),f=js(p),m=i.get(g);if(!m){i.set(g,{normalized:g,value:l,bestItem:u,bestStatus:p,bestPriority:f,statuses:new Set([p])});return}m.statuses.add(p),f<m.bestPriority&&(m.bestItem=u,m.bestStatus=p,m.bestPriority=f,m.value=l)}),_t=new Map;const d=Array.from(i.values()).sort((u,l)=>u.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(u=>{_t.set(u.normalized,u.bestItem);const l=Ts(u),g=xt(u.value);if(l===u.value)return`<option value="${g}"></option>`;const p=xt(l);return`<option value="${g}" label="${p}"></option>`}).join("");e&&(e.innerHTML=d),n&&(n.innerHTML=d)}function Ea(e,n,t={}){const{silent:a=!1}=t,r=z(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=He();if(!s||!i){const m=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||b(m),{success:!1,message:m}}const o=be();if(In(o).has(r)){const m=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||b(m),{success:!1,message:m}}const u=mn(r,s,i);if(u.length){const m=u.map(h=>h.name).join(", "),y=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`);return a||b(y),{success:!1,message:y}}if(_e(r,s,i)){const m=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const y=new URLSearchParams({type:"equipment",id:r,start:s,end:i});Ce(`/reservations/availability.php?${y.toString()}`).then(h=>{const B=Array.isArray(h?.conflicts)?h.conflicts:[],I=Array.from(new Set(B.map(E=>E?.reservation_code||(E?.reservation_id!=null?`#${E.reservation_id}`:null)).filter(Boolean))),L=I.length?`${m}: ${I.join("ØŒ ")}`:m;b(L)}).catch(()=>b(m))}catch{b(m)}return{success:!1,message:m}}const l=dn(r);if(!l){const m=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||b(m),{success:!1,message:m}}const g=Fe(l);if(g==="maintenance"||g==="retired"){const m=Ye(g);return a||b(m),{success:!1,message:m}}const p=Ze(l);if(!p){const m=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||b(m),{success:!1,message:m}}Mt({id:p,equipmentId:p,barcode:r,desc:l.desc,qty:1,price:l.price,cost:ft(l),image:st(l)}),n&&(n.value=""),le(),O();const f=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||b(f),{success:!0,message:f,barcode:r}}function nn(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=ba(n);if(!t){b(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Qa(t.barcode),r=Fe(a||t);if(r==="maintenance"||r==="retired"){b(Ye(r));return}const s=z(t.barcode);if(!s){b(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=Ze(t);if(!i){b(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,cost:ft(t),image:st(t)},{start:d,end:u}=He();if(!d||!u){b(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const l=be();if(In(l).has(s)){b(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const p=mn(s,d,u);if(p.length){const f=p.map(m=>m.name).join(", ");b(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${f}`));return}if(_e(s,d,u)){const f=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const m=new URLSearchParams({type:"equipment",id:s,start:d,end:u});Ce(`/reservations/availability.php?${m.toString()}`).then(y=>{const h=Array.isArray(y?.conflicts)?y.conflicts:[],B=Array.from(new Set(h.map(L=>L?.reservation_code||(L?.reservation_id!=null?`#${L.reservation_id}`:null)).filter(Boolean))),I=B.length?`${f}: ${B.join("ØŒ ")}`:f;b(I)}).catch(()=>b(f))}catch{b(f)}return}Mt(o),le(),O(),b(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function Rs(){ze();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),nn(e))});const n=()=>{Ia(e.value,"equipment-description-options")&&nn(e)};e.addEventListener("focus",()=>{if(ze(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function xn(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function In(e=be()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=z(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=z(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function Ds(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=He();if(!n||!t){b(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}fs({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):b(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(aa.change,n=>{xn(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),xn(e,ys()))}function Fs(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,o=null;const d=[],u=new Set;s.forEach(g=>{const p=z(g);p&&!u.has(p)&&(u.add(p),d.push(p))});const l=Math.min(r,d.length);for(let g=0;g<l;g+=1){const p=d[g],f=Ea(p,null,{silent:!0});f.success&&(i+=1),f.message&&(o=f.message)}if(i>0){const p=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",k(String(i)));b(p)}else o&&b(o)}function Sa(){Ds(),!(Cn||typeof document>"u")&&(document.addEventListener(aa.requestAdd,Fs),Cn=!0)}function ht(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function an(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=ht();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=n==="package";s&&(s.disabled=o),i&&(i.disabled=o),r&&(r.disabled=n!=="package"||r.options.length===0),ms(n),n==="package"&&zt()}function zt(){const{packageSelect:e,packageHint:n}=ht();if(!e)return;const t=Qn();da=t,os(t.map(o=>o.raw??o));const a=c("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,u=k(d.toFixed(2)),l=`${o.name} â€” ${u} ${a}`;return`<option value="${o.id}">${l}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),Aa()}function Ms(e,n){const t=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const o=s?.desc||k(String(s?.barcode??s?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const d=i.map(u=>u.name).join(", ");return`â€¢ ${o} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${d})`}return`â€¢ ${o} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function ka(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=Je(e);if(!s)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=$s(s);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(m=>m?.type==="package"&&Je(m.packageId)===s))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(Yn(s,t,a,r)){const m=i.name||s;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:pn(i.raw??{}),d=In(n),u=[],l=new Set;if(o.forEach(m=>{const y=z(m?.normalizedBarcode??m?.barcode);if(y){if(l.has(y)){u.push({item:m,type:"internal"});return}l.add(y),d.has(y)&&u.push({item:m,type:"external"})}}),u.length){const m=u.map(({item:h})=>h?.desc||h?.description||h?.name||h?.barcode||h?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(h=>k(String(h))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(h=>h.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:u}}const g=[];if(o.forEach(m=>{const y=z(m?.normalizedBarcode??m?.barcode);if(y&&_e(y,t,a,r)){const h=mn(y,t,a,r);g.push({item:m,blockingPackages:h})}}),g.length)return{success:!1,reason:"item_conflict",message:Ms(i,g),conflicts:g};const p=o.reduce((m,y)=>{const h=Number(y?.cost),B=Number.isFinite(Number(y?.qty))?Number(y.qty):1,I=Number.isFinite(B)&&B>0?B:1;return m+(Number.isFinite(h)?h:0)*I},0);return{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,cost:Number.isFinite(Number(i.cost))?Number(i.cost):Number(p.toFixed(2)),barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:z(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0,cost:Number.isFinite(Number(m?.cost))?Number(m.cost):0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function wa(e,{silent:n=!1}={}){const t=Je(e);if(!t)return n||b(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=He(),s=be(),i=ka(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const d={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");b(i.message||d)}return i}return Mt(i.package),le(),O(),n||b(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function Aa(){const{packageSelect:e}=ht();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;wa(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Vs(){const{packageAddButton:e,packageSelect:n}=ht();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){b(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}wa(t)}),e.dataset.listenerAttached="true")}function Ba(){const{modeRadios:e}=ht();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&an(r.target.value)}),a.dataset.listenerAttached="true")}),Vs(),Aa();const n=Nt(),t=e.find(a=>a.value===n);t&&(t.checked=!0),an(n)}function le(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=be(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),d=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;return}const u=rt(t);n.innerHTML=u.map(l=>{const g=l.items[0]||{},p=st(g)||l.image,f=p?`<img src="${p}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',m=k(String(l.count)),y=Number.isFinite(Number(l.unitPrice))?Number(l.unitPrice):0,h=(()=>{try{const{start:H,end:N}=He(),C=Wt(H,N);return Number.isFinite(C)&&C>0?C:1}catch{return 1}})(),B=k(String(h)),I=y*l.count*h,L=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${l.key}"
          min="0"
          step="0.01"
          value="${k(y.toFixed(2))}"
          aria-label="${c("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,E=`${k(I.toFixed(2))} ${r}`,v=Number.isFinite(Number(l.unitCost))?Number(l.unitCost):0;`${k(v.toFixed(2))}${r}`;const S=l.items.some(H=>H?.type==="package"),P=l.barcodes.map(H=>k(String(H||""))).filter(Boolean),$=P.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${P.map(H=>`<li>${H}</li>`).join("")}
            </ul>
          </details>`:"";let q="";if(S){const H=new Map;if(l.items.forEach(N=>{Array.isArray(N?.packageItems)&&N.packageItems.forEach(C=>{if(!C)return;const U=z(C.barcode||C.desc||Math.random()),M=H.get(U);if(M){M.qty+=Number.isFinite(Number(C.qty))?Number(C.qty):1;return}H.set(U,{desc:C.desc||C.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(C.qty))?Number(C.qty):1,barcode:C.barcode??C.normalizedBarcode??""})})}),H.size){const N=Array.from(H.values()).map(C=>{const U=k(String(C.qty)),M=C.desc||k(String(C.barcode||"")),D=C.barcode?` <span class="reservation-package-items__barcode">(${k(String(C.barcode))})</span>`:"";return`<li>${M}${D} Ã— ${U}</li>`}).join("");q=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${N}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${f}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${S?`${q||""}${$||""}`:$}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${l.key}" aria-label="${o}" ${S?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${m}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${l.key}" aria-label="${i}" ${S?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${B}</span></td>
          <td>${L}</td>
          <td><input type="number" class="form-control form-control-sm reservation-unit-cost-input" data-group-key="${l.key}" min="0" step="0.01" value="${k(v.toFixed(2))}" aria-label="${c("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"></td>
          <td>${E}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${l.key}" aria-label="${d}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function zs(e){const n=be(),a=rt(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(cs(r),le(),O())}function Hs(e){const n=be(),t=n.filter(a=>gt(a)!==e);t.length!==n.length&&(vt(t),le(),O())}function Os(e,n){const t=Pa(n),a=Number.isFinite(t)&&t>=0?La(t):0,r=be(),i=rt(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(d=>{o[d]&&(o[d]={...o[d],price:a,unit_price:a})}),vt(o),le(),O()}function Us(e,n){const t=Pa(n),a=Number.isFinite(t)&&t>=0?La(t):0,r=be(),i=rt(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(d=>{o[d]&&(o[d]={...o[d],cost:a,unit_cost:a})}),vt(o),le(),O()}function Pa(e){const n=k(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),t=Number.parseFloat(n);return Number.isFinite(t)?t:NaN}function La(e){const n=Number(e);return!Number.isFinite(n)||n<0?0:Number(n.toFixed(2))}function Gs(e){const n=be(),a=rt(n).find(g=>g.key===e);if(!a)return;const{start:r,end:s}=He();if(!r||!s){b(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(g=>z(g.barcode))),{equipment:o=[]}=te(),d=(o||[]).find(g=>{const p=z(g?.barcode);return!p||i.has(p)||gt({desc:g?.desc||g?.description||g?.name||"",price:Number(g?.price)||0})!==e||!Hn(g)?!1:!_e(p,r,s)});if(!d){b(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=z(d.barcode),l=Ze(d);if(!l){b(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}Mt({id:l,equipmentId:l,barcode:u,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,cost:Number.isFinite(Number(d.cost))?Number(d.cost):Number.isFinite(Number(d.unit_cost))?Number(d.unit_cost):Number(a.unitCost)||0,image:st(d)}),le(),O()}function O(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(k(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:u,end:l}=He();i&&Be();const g=Xe(),p=document.getElementById("res-payment-progress-type"),f=document.getElementById("res-payment-progress-value"),m=ma(p),y=pa(f);ln(),An({selectedItems:be(),discount:t,discountType:r,applyTax:i,paidStatus:d,paymentProgressType:m,paymentProgressValue:y,start:u,end:l,companySharePercent:g,paymentHistory:[]});const h=An.lastResult;h?(fa(f,h.paymentProgressValue),o&&(o.value=h.paymentStatus,ve(o,h.paymentStatus))):ve(o,d);try{De()}catch{}}function Ks(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=k(o.target.value),O()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",O),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if(Ee()){t.checked=!1,b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}tn("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(Ee()){a.checked=!1,b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}tn("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(Ee()){r.value="unpaid",ve(r,"unpaid"),b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ve(r),O()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",o=>{if(Ee()){s.value="percent",b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",O()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(Ee()){i.value="",b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=k(o.target.value),O()}),i.dataset.listenerAttached="true"),O()}function Ws(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const o=()=>{try{De()}catch{}},d=()=>{try{le(),O()}catch{}};s.addEventListener("input",o),s.addEventListener("change",o),s.addEventListener("input",d),s.addEventListener("change",d),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const o=()=>{try{De()}catch{}},d=()=>{try{le(),O()}catch{}};i.addEventListener("input",o),i.addEventListener("change",o),i.addEventListener("input",d),i.addEventListener("change",d),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){O();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),O();try{le()}catch{}};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{De()}catch{}try{le(),O()}catch{}}});const r=()=>{try{De()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function jn(){const{input:e,hidden:n}=at(),{input:t,hidden:a}=xe(),{customers:r}=te();let s=n?.value?String(n.value):"";if(!s&&e?.value){const A=Tt(e.value,{allowPartial:!0});A&&(s=String(A.id),n&&(n.value=s),e.value=A.label,e.dataset.selectedId=s)}const i=r.find(A=>String(A.id)===s);if(!i){b(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&t?.value){const A=en(t.value,{allowPartial:!0});A&&(d=String(A.id),a&&(a.value=d),t.value=A.label,t.dataset.selectedId=d)}const u=document.getElementById("res-start").value,l=document.getElementById("res-end").value,g=document.getElementById("res-start-time")?.value||"00:00",p=document.getElementById("res-end-time")?.value||"00:00";if(!u||!l){b(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const f=`${u}T${g}`,m=`${l}T${p}`,y=new Date(f),h=new Date(m);if(Number.isNaN(y.getTime())||Number.isNaN(h.getTime())||y>=h){b(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const B=ln();B.map(A=>A.technicianId).filter(Boolean);const I=be();if(I.length===0&&B.length===0){b(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const L=document.getElementById("res-notes")?.value||"",E=parseFloat(k(document.getElementById("res-discount")?.value))||0,v=document.getElementById("res-discount-type")?.value||"percent",S=document.getElementById("res-payment-status"),P=S?.value||"unpaid",$=document.getElementById("res-payment-progress-type"),q=document.getElementById("res-payment-progress-value"),H=ma($),N=pa(q),C=d?vn(d):null,U=Ns(C);if(d&&!C){b(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const A of I){const V=Fe(A.barcode);if(V==="maintenance"||V==="retired"){b(Ye(V));return}}const M=[];for(const A of I){const V=z(A.barcode);if(_e(V,f,m)){const ae=A?.desc||A?.name||A?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");M.push({label:k(String(ae)),barcode:V})}}if(M.length){const A=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let V=null;try{const Y=Array.from(new Set(M.map(Z=>Z.barcode).filter(Boolean))),ge=new Map;await Promise.all(Y.map(async Z=>{const de=new URLSearchParams({type:"equipment",id:Z,start:f,end:m}),ye=await Ce(`/reservations/availability.php?${de.toString()}`),Pe=Array.isArray(ye?.conflicts)?ye.conflicts:[],Ue=Array.from(new Set(Pe.map(w=>w?.reservation_code||(w?.reservation_id!=null?`#${w.reservation_id}`:null)).filter(Boolean)));ge.set(Z,Ue)})),V=M.map(({label:Z,barcode:de})=>{const ye=ge.get(de)||[];return ye.length?`${Z} (${ye.join("ØŒ ")})`:Z}).join("ØŒ ")}catch{}const ae=V||M.map(Y=>Y.label).filter(Boolean).map(String).join("ØŒ ");b(`${A}: ${ae}`,"warning",6e3);return}const D=[];for(const A of I){if(A?.type!=="package")continue;const V=A.packageId??A.package_id??null;if(V&&Yn(V,f,m)){const ae=A.desc||A.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let Y=[];try{const ge=new URLSearchParams({type:"package",id:String(V),start:f,end:m}),Z=await Ce(`/reservations/availability.php?${ge.toString()}`),de=Array.isArray(Z?.conflicts)?Z.conflicts:[];Y=Array.from(new Set(de.map(ye=>ye?.reservation_code||(ye?.reservation_id!=null?`#${ye.reservation_id}`:null)).filter(Boolean)))}catch{}D.push({label:k(String(ae)),codes:Y})}}if(D.length){const A=D.map(({label:ae,codes:Y})=>Y&&Y.length?`${ae} (${Y.join("ØŒ ")})`:ae).join("ØŒ "),V=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");b(`${V}: ${A}`,"warning",6e3);return}const _=[];for(const A of B){if(!A?.technicianId||!Xn(A.technicianId,f,m))continue;const V=A?.technicianName||A?.positionLabel||String(A.technicianId);let ae=[];try{ae=Zn(A.technicianId,f,m,null)}catch{}_.push({label:k(String(V)),codes:ae})}if(_.length){const A=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),V=_.map(({label:ae,codes:Y})=>Y&&Y.length?`${ae} (${Y.join("ØŒ ")})`:ae).join("ØŒ ");b(`${A}: ${V}`);return}const ne=document.getElementById("res-tax"),F=document.getElementById("res-company-share"),x=!!d;x?(ne&&(ne.checked=!1,ne.disabled=!0,ne.classList.add("disabled"),ne.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),F&&(F.checked=!1,F.disabled=!0,F.classList.add("disabled"),F.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),S&&(S.value="unpaid",S.disabled=!0,ve(S,"unpaid"),S.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),$&&($.disabled=!0,$.classList.add("disabled")),q&&(q.value="",q.disabled=!0,q.classList.add("disabled"))):(ne&&(ne.disabled=!1,ne.classList.remove("disabled"),ne.title=""),F&&(F.disabled=!1,F.classList.remove("disabled"),F.title=""),S&&(S.disabled=!1,S.title=""),$&&($.disabled=!1,$.classList.remove("disabled")),q&&(q.disabled=!1,q.classList.remove("disabled")));const j=x?!1:ne?.checked||!1,J=!!F?.checked;if(!x&&J!==j){b(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let ie=J?Xe():null;J&&(!Number.isFinite(ie)||ie<=0)&&(Be(),ie=Xe());const T=J&&j&&Number.isFinite(ie)&&ie>0;j&&Be();const ue=On(I,E,v,j,B,{start:f,end:m,companySharePercent:T?ie:0}),ke=Ua(),Q=$t({totalAmount:ue,progressType:H,progressValue:N,history:[]});q&&fa(q,Q.paymentProgressValue);const Oe=[];Q.paymentProgressValue!=null&&Q.paymentProgressValue>0&&Oe.push({type:Q.paymentProgressType||H,value:Q.paymentProgressValue,amount:Q.paidAmount,percentage:Q.paidPercent,recordedAt:new Date().toISOString()});const qe=qt({manualStatus:P,paidAmount:Q.paidAmount,paidPercent:Q.paidPercent,totalAmount:ue});S&&(S.value=qe,ve(S,qe));const fe=typeof C?.paymentStatus=="string"?C.paymentStatus.toLowerCase():null,it=fe&&["paid","partial","unpaid"].includes(fe)?fe:"unpaid",me=Un({reservationCode:ke,customerId:o,start:f,end:m,status:U?"confirmed":"pending",title:null,location:null,notes:L,projectId:d||null,totalAmount:ue,discount:x?0:E,discountType:x?"percent":v,applyTax:j,paidStatus:x?it:qe,confirmed:U,items:I.map(A=>({...A,equipmentId:A.equipmentId??A.id})),crewAssignments:B,companySharePercent:x||!T?null:ie,companyShareEnabled:x?!1:T,paidAmount:x?0:Q.paidAmount,paidPercentage:x?0:Q.paidPercent,paymentProgressType:x?null:Q.paymentProgressType,paymentProgressValue:x?null:Q.paymentProgressValue,paymentHistory:x?[]:Oe});try{Ln("about to submit",{crewAssignments:B,techniciansPayload:me?.technicians,payload:me});const A=await Ja(me);Ln("server response",{reservation:A?.id??A?.reservationId??A?.reservation_code,technicians:A?.technicians,crewAssignments:A?.crewAssignments,techniciansDetails:A?.techniciansDetails}),fn(),ze(),mt(),Ca(),b(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const V=document.getElementById("sub-tab-trigger-my-reservations-tab");V&&typeof V.click=="function"&&setTimeout(()=>V.click(),0)}catch{}typeof Yt=="function"&&Yt({type:"created",reservation:A}),Qs(A)}catch(A){console.error("âŒ [reservations/createForm] Failed to create reservation",A);const V=Gn(A)?A.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");b(V,"error"),x&&(b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),lt({clearValue:!1}))}}function Qs(e){if(!Bt)return;const{draftStorageKey:n=ia,returnUrl:t=oa}=Bt,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}Bt=null,t&&(window.location.href=t)}function lt({clearValue:e=!1}={}){const{input:n,hidden:t}=xe();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,Ne())}function Js(e,n=""){const{input:t,hidden:a}=xe();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),Ne())}function Ca(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),Ae({selectedValue:"",resetInput:!0});try{Ve("res-start","res-start-time","")}catch{}try{Ve("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),lt({clearValue:!1}),Me({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",ve(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),Ya(),vt([]),gs("form-reset"),le(),Ne(),O(),la()}function Ys(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",n=>{const t=n.target.closest("button[data-action]");if(!t)return;const{action:a,groupKey:r}=t.dataset;if(a==="decrease-group"&&r){zs(r);return}if(a==="increase-group"&&r){Gs(r);return}if(a==="remove-group"&&r){Hs(r);return}}),e.addEventListener("input",n=>{const t=n.target.closest(".reservation-unit-price-input");if(t){const r=t.dataset.groupKey;r&&Os(r,t.value);return}const a=n.target.closest(".reservation-unit-cost-input");if(a){const r=a.dataset.groupKey;r&&Us(r,a.value)}}),e.dataset.listenerAttached="true")}function Xs(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(Nt()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,Ea(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||Nt()!=="single")return;const{start:s,end:i}=He();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function Zs(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await jn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await jn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),Ca();try{la()}catch{}b(c("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function Ur({onAfterSubmit:e}={}){Yt=typeof e=="function"?e:null,tt=!0;const{customers:n,projects:t}=te();ps(n||[]),Ae(),bn(),ya(t||[]),ha({projectsList:t}),hn(),ze(),zt(),Rs(),Sa(),Ba(),Ws(),Ks(),Ys(),Xs(),Zs(),Cs(),_s(),O(),le();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{De()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}tt=!1}function $a(){ze(),zt(),ha(),Ae(),bn(),hn(),Sa(),Ba(),le(),O()}if(typeof document<"u"){const e=()=>{Ae(),Me({projectsList:yn()}),bn(),hn(),O()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{ze()}),document.addEventListener("packages:changed",()=>{zt(),Nt()==="package"&&an("package")})}typeof window<"u"&&(window.getCompanySharePercent=Xe);function kt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function er(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function tr(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=er(t);if(a!==null)return a}return null}function Tn(e,n=0){const t=tr(e);if(t!=null)return t;const a=kt(e.createdAt??e.created_at);if(a!=null)return a;const r=kt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=kt(e.start);if(s!=null)return s;const i=kt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(n)?n:0}function nr({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((I,L)=>({reservation:I,index:L})),i=n.searchTerm||"",o=n.searchReservationId||"",d=n.searchCustomerName||"",u=n.searchProjectId||"",l=n.startDate||"",g=n.endDate||"",p=n.status||"",f=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,m=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,y=l?new Date(`${l}T00:00:00`):null,h=g?new Date(`${g}T23:59:59`):null,B=s.filter(({reservation:I})=>{const L=t.get(String(I.customerId)),E=r?.get?.(String(I.projectId)),v=I.start?new Date(I.start):null,S=Kn(I),{effectiveConfirmed:P}=yt(I,E);if(f!=null&&String(I.customerId)!==String(f)||m!=null&&!(Array.isArray(I.technicians)?I.technicians.map(C=>String(C)):[]).includes(String(m))||p==="confirmed"&&!P||p==="pending"&&P||p==="completed"&&!S)return!1;if(p==="cancelled"){const N=String(I?.status||I?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(N))return!1}if(y&&v&&v<y||h&&v&&v>h)return!1;if(o){const N=[I.reservationId,I.id,I.reservation_id,I.reservationCode,I.reservation_code,I.code,I.reference,I.referenceNumber,I.reference_number],C=Se(N.filter(M=>M!=null&&M!=="").map(String).join(" ")).replace(/\s+/g,""),U=o.replace(/\s+/g,"");if(!C.includes(U))return!1}if(d&&!Se(L?.customerName||I.customerName||"").includes(d))return!1;if(u){const N=[I.projectId,I.project_id,I.projectID,E?.id,E?.projectCode,E?.project_code],C=Se(N.filter(M=>M!=null&&M!=="").map(String).join(" ")).replace(/\s+/g,""),U=u.replace(/\s+/g,"");if(!C.includes(U))return!1}if(!i)return!0;const $=I.items?.map?.(N=>`${N.barcode} ${N.desc}`).join(" ")||"",q=(I.technicians||[]).map(N=>a.get(String(N))?.name).filter(Boolean).join(" ");return Se([I.reservationId,L?.customerName||I.customerName,I.notes,$,q,E?.title].filter(Boolean).join(" ")).includes(i)});return B.sort((I,L)=>{const E=Tn(I.reservation,I.index),v=Tn(L.reservation,L.index);return E!==v?v-E:L.index-I.index}),B}function ar({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=c("reservations.create.summary.currency","SR"),s=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),d=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),u=c("reservations.list.crew.separator","ØŒ "),l=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),g=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),p=c("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),f=c("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),m=c("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),y=c("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),h=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),B=c("reservations.list.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),I=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),L=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),E={client:c("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:v,index:S})=>{const P=n.get(String(v.customerId)),$=v.projectId?a?.get?.(String(v.projectId)):null,q=Kn(v),H=v.items?.length||0,N=Array.isArray(v.crewAssignments)?v.crewAssignments:[],C=(v.technicians||[]).map(ce=>t.get(String(ce))).filter(Boolean),U=N.length?N.map(ce=>{const Le=ce.positionLabel??ce.position_name??ce.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),ot=ce.technicianName??t.get(String(ce.technicianId??""))?.name??null;return ot?`${k(Le)} (${k(ot)})`:k(Le)}):C.map(ce=>ce.name),M=U.length?U.join(u):"â€”",D=k(String(v.reservationId??"")),_=v.start?k(Kt(v.start)):"-",ne=v.end?k(Kt(v.end)):"-",F=v.discount??v.discountValue??v.discount_value??v.discountAmount??0,x=Number.parseFloat(k(String(F))),j=Number.isFinite(x)?x:0,J=v.discountType??v.discount_type??v.discountMode??"percent",ie=String(J).toLowerCase()==="amount"?"amount":"percent",T=!!(v.applyTax??v.apply_tax??v.taxApplied),ue=v.companySharePercent??v.company_share_percent??v.companyShare??v.company_share,ke=v.companyShareEnabled??v.company_share_enabled??v.companyShareApplied,Q=Number.parseFloat(k(String(ue))),qe=(ke===!0||Number.isFinite(Q)&&Q>0)&&Number.isFinite(Q)?Q:0;let fe=0;try{const ce=Za({items:v.items||[],technicianIds:v.technicians||[],crewAssignments:Array.isArray(v.crewAssignments)?v.crewAssignments:[],discount:j,discountType:ie,applyTax:T,start:v.start,end:v.end,companySharePercent:qe,groupingSource:v}),Le=Number(ce?.finalTotal||0);fe=Number.isFinite(Le)?Number(Le.toFixed(2)):0}catch{fe=0}const it=Number.parseFloat(k(String(v.cost??0)))||0,me=fe>0?fe:it,A=v.paymentHistory||v.payment_history||[],V=$t({totalAmount:me,paidAmount:A.length?0:v.paidAmount,paidPercent:A.length?0:v.paidPercent,history:A});let Y=qt({manualStatus:null,paidAmount:V.paidAmount,paidPercent:V.paidPercent,totalAmount:me});if($)try{const{totalWithTax:ce}=Ss($)||{totalWithTax:0},Le=$.paymentHistory||$.payments||[],ot=$t({totalAmount:ce,paidAmount:Le.length?0:$.paidAmount,paidPercent:Le.length?0:$.paidPercent,history:Le}),kn=qt({manualStatus:null,paidAmount:ot.paidAmount,paidPercent:ot.paidPercent,totalAmount:ce});kn&&(Y=kn)}catch{}const ge=Y==="paid",Z=Y==="partial",{effectiveConfirmed:de,projectLinked:ye}=yt(v,$),Pe=de?"status-confirmed":"status-pending",Ue=ge?"status-paid":Z?"status-partial":"status-unpaid";let w=`<span class="reservation-chip status-chip ${Pe}">${de?l:g}</span>`;const R=ge?f:Z?y:m;let G=`<span class="reservation-chip status-chip ${Ue}">${R}</span>`,K=ge?" tile-paid":Z?" tile-partial":" tile-unpaid";q&&(K+=" tile-completed");let se="";q&&(w=`<span class="reservation-chip status-chip status-completed">${p}</span>`,G=`<span class="reservation-chip status-chip status-completed">${R}</span>`,se=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`);let X="";ye||(de?q||(X=`<button class="tile-confirm" data-reservation-index="${S}" data-action="close">${B}</button>`):X=`<button class="tile-confirm" data-reservation-index="${S}" data-action="confirm">${h}</button>`);const oe=X?`<div class="tile-actions">${X}</div>`:"",W=k(me.toFixed(2)),pe=k(String(H)),Ge=v.notes?k(v.notes):o,ee=d.replace("{count}",pe),It=v.applyTax?`<small>${s}</small>`:"";let Et=I;return v.projectId&&(Et=$?.title?k($.title):L),`
      <div class="${X?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${K}"${se} data-reservation-index="${S}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${D}</div>
          <div class="tile-badges">
            ${w}
            ${G}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${E.client}</span>
            <span class="tile-value">${P?.customerName||v.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.project}</span>
            <span class="tile-value">${Et}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.start}</span>
            <span class="tile-value tile-inline">${_}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.end}</span>
            <span class="tile-value tile-inline">${ne}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.cost}</span>
            <span class="tile-value">${W} ${r} ${It}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.equipment}</span>
            <span class="tile-value">${ee}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.crew}</span>
            <span class="tile-value">${U.length?M:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${Ge}</span>
          </div>
        </div>
        ${oe}
      </div>
    `}).join("")}function sr({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a,onCloseReservation:r,onReopenReservation:s}={}){const i=mt(),{reservations:o=[],customers:d=[],technicians:u=[],projects:l=[]}=te(),g=o.map(E=>{const v=Qt(E);return{...v,id:E.id??v.id,reservationId:E.reservationId??E.reservation_id??v.reservationId,reservationCode:E.reservationCode??E.reservation_code??v.reservationCode}}),p=g,f=Array.isArray(i)?i:u||[],m=new Map((l||[]).map(E=>[String(E.id),E])),y=document.getElementById(e);if(!y){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!p||p.length===0){y.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const h=n||bs(),B=new Map(d.map(E=>[String(E.id),E])),I=new Map(f.map(E=>[String(E.id),E])),L=nr({reservations:g,filters:h,customersMap:B,techniciansMap:I,projectsMap:m});if(L.length===0){y.innerHTML=`<p>${c("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}y.innerHTML=`<div class="reservations-grid">${ar({entries:L,customersMap:B,techniciansMap:I,projectsMap:m})}</div>`,y.querySelectorAll('[data-action="details"]').forEach(E=>{const v=Number(E.dataset.reservationIndex);Number.isNaN(v)||E.addEventListener("click",()=>{typeof t=="function"&&t(v)})}),y.querySelectorAll('button[data-action="confirm"]').forEach(E=>{const v=Number(E.dataset.reservationIndex);Number.isNaN(v)||E.addEventListener("click",S=>{S.stopPropagation(),typeof a=="function"&&a(v,S)})}),y.querySelectorAll('button[data-action="close"]').forEach(E=>{const v=Number(E.dataset.reservationIndex);Number.isNaN(v)||E.addEventListener("click",S=>{S.stopPropagation(),typeof r=="function"&&r(v,S)})})}function rr(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=te(),o=r.map(y=>{const h=Qt(y);return{...h,id:y.id??h.id,reservationId:y.reservationId??y.reservation_id??h.reservationId,reservationCode:y.reservationCode??y.reservation_code??h.reservationCode}}),d=r[e];if(!d)return b(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const u=o[e]??Qt(d),l=s.find(y=>String(y.id)===String(d.customerId)),g=d.projectId?i.find(y=>String(y.id)===String(d.projectId)):null,p=document.getElementById("reservation-details-body"),f=document.getElementById("reservationDetailsModal"),m=()=>{const y=()=>{f&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(f)?.hide()},h=document.getElementById("reservation-details-edit-btn");h&&(h.onclick=()=>{y(),typeof n=="function"&&n(e,{reservation:d,customer:l,getEditContext:a})});const B=document.getElementById("reservation-details-delete-btn");B&&(B.onclick=()=>{y(),typeof t=="function"&&t(e,{reservation:d,customer:l})});const I=p?.querySelector('[data-action="open-project"]');I&&g&&I.addEventListener("click",()=>{y();const v=g?.id!=null?String(g.id):"",S=v?`projects.html?project=${encodeURIComponent(v)}`:"projects.html";window.location.href=S});const L=document.getElementById("reservation-details-export-btn");L&&(L.onclick=async v=>{v?.preventDefault?.(),v?.stopPropagation?.(),L.blur();try{await Is({reservation:d,customer:l,project:g})}catch(S){console.error("âŒ [reservations] export to PDF failed",S),b(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const E=document.getElementById("reservation-details-checklist-btn");E&&(E.onclick=async v=>{v?.preventDefault?.(),v?.stopPropagation?.(),E.blur();try{await Es({reservation:d,customer:l,project:g})}catch(S){console.error("âŒ [reservations] export checklist PDF failed",S),b(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const v=p?.querySelector("[data-tech-slider]");if(v){const S=v.querySelector("[data-slider-track]"),P=v.querySelector("[data-slider-prev]"),$=v.querySelector("[data-slider-next]");if(S&&(P||$)){const q=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",H=()=>{const U=S.querySelector(".reservation-technician-card"),M=U&&U.getBoundingClientRect().width||220,D=12,_=Math.max(1,Math.floor(S.clientWidth/(M+D)));return Math.max(M+D,Math.floor(_*(M+D)*.9))},N=()=>{const U=Math.max(0,S.scrollWidth-S.clientWidth-2),M=S.scrollLeft<=1,D=S.scrollLeft>=U;P&&(P.disabled=M),$&&($.disabled=D)},C=U=>{const M=H()*U,D=q?-M:M;S.scrollBy({left:D,behavior:"smooth"})};P?.addEventListener("click",()=>C(-1)),$?.addEventListener("click",()=>C(1)),S.addEventListener("scroll",N,{passive:!0}),window.addEventListener("resize",N,{passive:!0}),setTimeout(N,0)}}}catch{}};if(p){const y=mt()||[];p.innerHTML=wn(u,l,y,e,g),m(),na().then(()=>{const h=mt()||[];p.innerHTML=wn(u,l,h,e,g),m()}).catch(()=>{})}return f&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(f).show(),!0}function et(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Qe(e,t),end:Qe(n,a)}}function Rt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function En(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Pt(){const{container:e,select:n,hint:t,addButton:a}=En();if(!n)return;const r=n.value,s=Qn(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,d=s.map(l=>{const g=Number.isFinite(Number(l.price))?Number(l.price):0,p=k(g.toFixed(2)),f=`${l.name} â€” ${p} ${i}`;return`<option value="${Rt(l.id)}">${Rt(f)}</option>`}).join("");n.innerHTML=`${o}${d}`;const u=s.length>0;n.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),t&&(u?(t.textContent=c("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),u&&r&&s.some(l=>l.id===r)?n.value=r:n.selectedIndex=0}function ir(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||b(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=he(),{start:s,end:i}=et(),{reservations:o=[]}=te(),d=a!=null&&o[a]||null,u=d?.id??d?.reservationId??null,l=ka(t,{existingItems:r,start:s,end:i,ignoreReservationId:u});if(!l.success)return n||b(l.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),l;const g=[...r,l.package];return Te(a,g),je(g),Ie(),n||b(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),l}function Rn(){const{select:e}=En();if(!e)return;const n=e.value||"";ir(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function or(){const{addButton:e,select:n}=En();n&&!n.dataset.langRefreshAttached&&(document.addEventListener("language:changed",Pt),document.addEventListener("language:translationsReady",Pt),n.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Rn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Rn())}),n.dataset.listenerAttached="true"),Pt()}function je(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${t}</td></tr>`,Fn(n);return}const{groups:d}=Ft({items:e});n.innerHTML=d.map(u=>{const l=u.items[0]||{},g=st(l)||u.image,p=g?`<img src="${g}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',f=String(u?.type||"").toLowerCase()==="package"||u.items.some(_=>_?.type==="package"),m=k(String(u.count)),y=wt(u.unitPrice),h=Number.isFinite(y)?At(y):0,B=wt(u.unitCost),I=Number.isFinite(B)?At(B):0,L=(()=>{try{const{start:_,end:ne}=et(),F=typeof Wt=="function"?Wt(_,ne):1;return Number.isFinite(F)&&F>0?F:1}catch{return 1}})(),E=wt(u.totalPrice),v=Number.isFinite(E)?E:h*(Number.isFinite(u.count)?u.count:1)*L,S=At(v),P=`${k(h.toFixed(2))} ${a}`,q=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${`edit-unit-cost-${u.key}`}"
          data-group-key="${u.key}"
          min="0"
          step="0.01"
          value="${k(I.toFixed(2))}"
          aria-label="${c("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,H=`${k(S.toFixed(2))} ${a}`,N=u.barcodes.map(_=>k(String(_||""))).filter(Boolean),C=N.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${N.map(_=>`<li>${_}</li>`).join("")}
            </ul>
          </details>`:"";let U="";if(f){const _=new Map,ne=x=>{const j=Number.parseFloat(k(String(x??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(j)||j<=0||j>99?1:Math.round(j)},F=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&F.push(...u.packageItems),u.items.forEach(x=>{Array.isArray(x?.packageItems)&&F.push(...x.packageItems)}),F.forEach(x=>{if(!x)return;const j=z(x.barcode||x.normalizedBarcode||x.desc||Math.random());if(!j)return;const J=_.get(j),ie=ne(x.qtyPerPackage??x.perPackageQty??x.quantityPerPackage??x.qty??x.quantity??1),T=Math.max(1,Math.min(ie,99));if(J){J.qty=T;return}_.set(j,{desc:x.desc||x.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:T,barcode:x.barcode??x.normalizedBarcode??""})}),_.size){const x=Array.from(_.values()).map(j=>{const J=k(String(j.qty>0?Math.min(j.qty,99):1)),ie=Rt(j.desc||""),T=j.barcode?` <span class="reservation-package-items__barcode">(${Rt(k(String(j.barcode)))})</span>`:"";return`<li>${ie}${T} Ã— ${J}</li>`}).join("");U=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${x}
              </ul>
            </details>
          `}}const M=f?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",D=f?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${p}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${f?`${U||""}${C||""}`:C}
              </div>
            </div>
          </td>
          <td>
            <div class="${M}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${i}"${D}>âˆ’</button>
              <span class="reservation-qty-value">${m}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${s}"${D}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${k(String(L))}</span></td>
          <td>${P}</td>
          <td>${q}</td>
          <td>${H}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${o}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Fn(n)}function cr(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Ht(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Ot();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(te()?.projects||[]).find(d=>String(d.id)===String(t)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(n=o)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Dn();return}const a=c("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const o=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${k(Number(s.amount).toFixed(2))} ${a}`:"â€”",d=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${k(Number(s.percentage).toFixed(2))}%`:"â€”",u=s?.recordedAt?k(Kt(s.recordedAt)):"â€”",l=cr(s?.type),g=s?.note?k(s.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${u}</td>
        <td>${g}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Dn()}function dr(){if(pt()){b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=_a(e);let a=xa(n);if(!Number.isFinite(a)||a<=0){b(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=Jt.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,o=Number(r?.paidAmount)||0,d=c("reservations.create.summary.currency","SR");let u=null,l=null;if(t==="percent"){const p=Math.max(0,100-i);if(p<=1e-4){b(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const f=Math.min(a,p);if(f!==a){const m=k(f.toFixed(2));b(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",m)),a=f}l=Number(a.toFixed(2)),s>0&&(u=a/100*s)}else{const p=Math.max(0,s-o);if(p<=1e-4){b(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const f=Math.min(a,p);if(f!==a){const m=`${k(f.toFixed(2))} ${d}`;b(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",m)),a=f}u=Number(a.toFixed(2)),s>0&&(l=u/s*100)}u!=null&&(u=Number(u.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const g={type:t,value:a,amount:u,percentage:l,recordedAt:new Date().toISOString()};kr(g),Sn(Ot()),Ht(),Ie(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),b(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Dn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(pt()){t.preventDefault(),b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}dr()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(pt()){t.preventDefault(),b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(wr(r),Sn(Ot()),Ht(),Ie(),b(c("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function lr(e){const{index:n,items:t}=he(),{groups:a}=Ft({items:t}),r=a.find(o=>o.key===e);if(!r||r.items.some(o=>o?.type==="package"))return;let s=-1;for(let o=t.length-1;o>=0;o-=1){const d=t[o];if(gt(d)===e&&d?.type!=="package"){s=o;break}}if(s<0)return;const i=t.filter((o,d)=>d!==s);Te(n,i),je(i),Ie()}function ur(e){const{index:n,items:t}=he(),{groups:a}=Ft({items:t}),r=a.find(o=>o.key===e);if(!r)return;let s=t.filter(o=>gt(o)!==e);if(r.items.some(o=>o&&o.type==="package")){const o=Je(r.packageId??r.items.find(g=>g?.type==="package")?.packageId??""),d=z(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(g=>{if(!g||typeof g!="object"||g.type!=="package")return!0;const p=Je(g.packageId??g.package_id??g.id??""),f=z(g.barcode??g.package_code??"");return!(o&&p===o||d&&f&&f===d)});const u=new Set,l=new Set;r.items.forEach(g=>{(Array.isArray(g?.packageItems)?g.packageItems:[]).forEach(f=>{const m=z(f?.barcode||f?.normalizedBarcode||"");m&&u.add(m);const y=f?.equipmentId??f?.equipment_id??null;y!=null&&l.add(String(y))})}),(u.size||l.size)&&(s=s.filter(g=>{const p=z(g?.barcode||""),f=g?.equipmentId??g?.id??null;return!(p&&u.has(p)||f!=null&&l.has(String(f)))}))}s.length!==t.length&&(Te(n,s),je(s),Ie())}function mr(e){const{index:n,items:t}=he(),{groups:a}=Ft({items:t}),r=a.find(h=>h.key===e);if(!r||r.items.some(h=>h?.type==="package"))return;const{start:s,end:i}=et();if(!s||!i){b(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=te(),d=n!=null&&o[n]||null,u=d?.id??d?.reservationId??null,l=new Set(t.map(h=>z(h.barcode))),{equipment:g=[]}=te(),p=(g||[]).find(h=>{const B=z(h?.barcode);return!B||l.has(B)||gt({desc:h?.desc||h?.description||h?.name||"",price:Number(h?.price)||0})!==e||!Hn(h)?!1:!_e(B,s,i,u)});if(!p){b(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const f=z(p.barcode),m=Ze(p);if(!m){b(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=[...t,{id:m,equipmentId:m,barcode:f,desc:p.desc||p.description||p.name||r.description||"",qty:1,price:Number.isFinite(Number(p.price))?Number(p.price):r.unitPrice,cost:ft(p),image:st(p)}];Te(n,y),je(y),Ie()}function pr(e,n){const t=wt(n),a=Number.isFinite(t)&&t>=0?At(t):0,{index:r,items:s}=he();if(!Array.isArray(s))return;const o=rt(s).find(u=>u.key===e);if(!o||!Array.isArray(o.itemIndices))return;const d=[...s];o.itemIndices.forEach(u=>{d[u]&&(d[u]={...d[u],cost:a,unit_cost:a})}),Te(r,d),je(d),Ie()}function Fn(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",n=>{const t=n.target.closest("button[data-action]");if(!t)return;const{action:a,groupKey:r,itemIndex:s}=t.dataset;if(a==="decrease-edit-group"&&r){lr(r);return}if(a==="increase-edit-group"&&r){mr(r);return}if(a==="remove-edit-group"&&r){ur(r);return}if(a==="remove-edit-item"){const i=Number(s);Number.isNaN(i)||yr(i)}}),e.addEventListener("input",n=>{const t=n.target.closest(".reservation-unit-cost-input");if(!t)return;const a=t.dataset.groupKey;a&&pr(a,t.value)}),e.dataset.groupListenerAttached="true")}function pt(){return!!document.getElementById("edit-res-project")?.value}function fr(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{pt()&&(b(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function gr(e){const n=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,o,d].forEach(fr),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const u=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(u)try{const p=(te()?.projects||[]).find(m=>String(m.id)===String(u)),f=typeof p?.paymentStatus=="string"?p.paymentStatus.toLowerCase():null;f&&["paid","partial","unpaid"].includes(f)&&(l=f)}catch{}r.value=l,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=n),d&&(d.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function Ie(){const e=document.getElementById("edit-res-summary");if(!e)return;Ht();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),ve(a),Ie()}),a.dataset.listenerAttached="true");const r=k(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",o=pt();gr(o);const d=document.getElementById("edit-res-tax"),u=o?!1:d?.checked||!1,l=!o&&a?.dataset?.userSelected==="true";let g="unpaid";if(o){const L=document.getElementById("edit-res-project")?.value||"";if(L)try{const v=(te()?.projects||[]).find(P=>String(P.id)===String(L)),S=typeof v?.paymentStatus=="string"?v.paymentStatus.toLowerCase():null;S&&["paid","partial","unpaid"].includes(S)&&(g=S)}catch{}}else g=l&&a?.value||"unpaid";let p=null;!o&&u&&(Be("edit-res-company-share"),p=Xe("edit-res-company-share"),(!Number.isFinite(p)||p<=0)&&(Be("edit-res-company-share"),p=Xe("edit-res-company-share")));const{items:f=[],payments:m=[]}=he(),{start:y,end:h}=et(),B=Jt({items:f,discount:s,discountType:i,applyTax:u,paidStatus:g,start:y,end:h,companySharePercent:p,paymentHistory:m});e.innerHTML=B;const I=Jt.lastResult;if(I&&a){const L=I.paymentStatus;l?ve(a,a.value):(a.value!==L&&(a.value=L),a.dataset&&delete a.dataset.userSelected,ve(a,L))}else a&&ve(a,a.value)}function yr(e){if(e==null)return;const{index:n,items:t}=he();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);Te(n,a),je(a),Ie()}async function vr(e){const n=e?.value??"",t=z(n);if(!t)return;const a=dn(t);if(!a){b(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Fe(a);if(r==="maintenance"||r==="retired"){b(Ye(r));return}const s=z(t),{index:i,items:o=[]}=he();if(o.findIndex(h=>z(h.barcode)===s)>-1){b(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:u,end:l}=et();if(!u||!l){b(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:g=[]}=te(),p=i!=null&&g[i]||null,f=p?.id??p?.reservationId??null;if(_e(s,u,l,f)){try{const h=new URLSearchParams({type:"equipment",id:s,start:u,end:l});f!=null&&h.set("ignore",String(f));const B=await Ce(`/reservations/availability.php?${h.toString()}`),I=Array.isArray(B?.conflicts)?B.conflicts:[],L=Array.from(new Set(I.map(v=>v?.reservation_code||(v?.reservation_id!=null?`#${v.reservation_id}`:null)).filter(Boolean))),E=L.length?`: ${L.join("ØŒ ")}`:"";b(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+E,"warning",6e3)}catch{b(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const m=Ze(a);if(!m){b(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=[...o,{id:m,equipmentId:m,barcode:s,desc:a.desc,qty:1,price:a.price,cost:ft(a),image:a.image||a.imageUrl||a.img||null}];Te(i,y),e&&(e.value=""),je(y),Ie()}async function Dt(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=ba(n),a=z(t?.barcode||n);if(!t||!a){b(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Fe(t);if(r==="maintenance"||r==="retired"){b(Ye(r));return}const{start:s,end:i}=et();if(!s||!i){b(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:d=[]}=he();if(d.some(y=>z(y.barcode)===a)){b(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:l=[]}=te(),g=o!=null&&l[o]||null,p=g?.id??g?.reservationId??null;if(_e(a,s,i,p)){try{const y=new URLSearchParams({type:"equipment",id:a,start:s,end:i});p!=null&&y.set("ignore",String(p));const h=await Ce(`/reservations/availability.php?${y.toString()}`),B=Array.isArray(h?.conflicts)?h.conflicts:[],I=Array.from(new Set(B.map(E=>E?.reservation_code||(E?.reservation_id!=null?`#${E.reservation_id}`:null)).filter(Boolean))),L=I.length?`: ${I.join("ØŒ ")}`:"";b(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+L,"warning",6e3)}catch{b(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const f=Ze(t);if(!f){b(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const m=[...d,{id:f,equipmentId:f,barcode:a,desc:t.desc,qty:1,price:t.price,cost:ft(t),image:t.image||t.imageUrl||t.img||null}];Te(o,m),je(m),Ie(),e.value=""}function qa(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Dt(e))});const n=()=>{Ia(e.value,"edit-res-equipment-description-options")&&Dt(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{Ie()});const e=()=>{or()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Pt()})}typeof window<"u"&&(window.getEditReservationDateRange=et,window.renderEditPaymentHistory=Ht);function hr(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){nn(e);return}Dt(e)}}function Gr(){ze(),qa()}function br(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let nt=null,we=[],$e=[],sn=null,re={},Gt=!1,Mn=!1;function Ir(){if(!Mn)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{Ra(re).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Mn=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Er="__DEBUG_CREW__";function Sr(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Er);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Vn(e,n){if(Sr())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function ut(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=c("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),o=c("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=s?i:o,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function dt(){return document.getElementById("edit-res-confirmed")?.value==="true"}function he(){return{index:nt,items:we,payments:$e}}function Te(e,n,t=$e){nt=typeof e=="number"?e:null,we=Array.isArray(n)?[...n]:[],$e=Array.isArray(t)?[...t]:[]}function Na(){nt=null,we=[],rs(),$e=[]}function Ot(){return[...$e]}function Sn(e){$e=Array.isArray(e)?[...e]:[]}function kr(e){e&&($e=[...$e,e])}function wr(e){!Number.isInteger(e)||e<0||($e=$e.filter((n,t)=>t!==e))}function Lt(e,n=1){const t=Number.parseFloat(k(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function rn(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(k(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function Ar(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?z(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:Lt(e.qty??e.quantity??e.count??1),price:rn(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function Br(e,n=0){if(!e||typeof e!="object")return null;const t=Je(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:pn(e)).map(p=>Ar(p)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=rn(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const p=rn(i,0);p>0&&a>0&&(o=Number((p/a).toFixed(2)))}const d=e.package_code??e.packageCode??e.barcode??null,l=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,d,t].find(p=>p!=null&&String(p).trim()!=="")||`Package ${t}`,g=e.image??e.cover??e.thumbnail??s.find(p=>p?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:k(String(l)),name:k(String(l)),qty:a,price:o,barcode:d,packageItems:s,image:g}}function Pr(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function Lr(e={},n=[]){const t=Array.isArray(n)?n.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return t;const r=a.map((o,d)=>Br(o,d)).filter(Boolean);if(!r.length)return t;const s=new Map;r.forEach(o=>{const d=Lt(o.qty??o.quantity??1);if(o.barcode){const u=z(o.barcode);if(u){const l=`package::${u}`;s.set(l,(s.get(l)??0)+d)}}(o.packageItems||[]).forEach(u=>{if(!u)return;const l=d*Lt(u.qty??u.quantity??1),g=u.equipmentId??null,p=u.normalizedBarcode||(u.barcode?z(u.barcode):null);if(g!=null){const f=`equipment::${String(g)}`;s.set(f,(s.get(f)??0)+l)}if(p){const f=`barcode::${p}`;s.set(f,(s.get(f)??0)+l)}})});const i=[];return t.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const h=Je(o.packageId??o.package_id??o.id??"");r.some(I=>I.packageId===h)||i.push({...o});return}const d=Lt(o.qty??o.quantity??1),u=Ze(o),l=o.barcode?z(o.barcode):null,g=[];u!=null&&g.push(`equipment::${String(u)}`),l&&g.push(`barcode::${l}`);const p=g.map(h=>s.get(h)??0).filter(h=>h>0);if(!p.length){i.push({...o});return}const f=Math.min(...p);if(f<=0){i.push({...o});return}const m=Math.min(f,d);if(Pr(s,g,m),m>=d)return;const y=d-m;i.push({...o,qty:y,quantity:y})}),[...i,...r.map(o=>({...o}))]}function Cr(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function _a(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function xa(e){if(!e)return null;const n=k(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function $r(e,n){if(e){e.value="";return}}function ct(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ja(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(k(String(e.value??""))),a=Number.parseFloat(k(String(e.amount??""))),r=Number.parseFloat(k(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,o=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?s??null:o==="percent"?i??null:Number.isFinite(t)?t:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:u}}function qr(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((d,u)=>String(u.createdAt||u.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${ct(a)}</option>`];i.forEach(d=>{o.push(`<option value="${ct(d.id)}">${ct(d.title||a)}</option>`)}),s&&!i.some(d=>String(d.id)===s)&&o.push(`<option value="${ct(s)}">${ct(r)}</option>`),t.innerHTML=o.join(""),s?t.value=s:t.value=""}function Ta(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const d=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",d&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}on("tax");const o=re?.updateEditReservationSummary;typeof o=="function"&&o()}function on(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=re?.updateEditReservationSummary;typeof s=="function"&&s()};if(Gt){a();return}Gt=!0;const r=()=>{Gt=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(We)),n.disabled){t.checked=!1,b(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),Be("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Be("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function zn(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:o,projects:d}=te(),l=Wn()?.[e];if(!l){b(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}re={...re,reservation:l,projects:d||[]},n?.(),qr(d||[],l);const g=l.projectId&&d?.find?.(T=>String(T.id)===String(l.projectId))||null,{effectiveConfirmed:p,projectLinked:f}=yt(l,g),m=l.items?l.items.map(T=>({...T,equipmentId:T.equipmentId??T.equipment_id??T.id,barcode:z(T?.barcode)})):[],y=Lr(l,m),B=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map(T=>ja(T)).filter(Boolean);Te(e,y,B);const I=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),L=o?.find?.(T=>String(T.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const E=document.getElementById("edit-res-id");E&&(E.value=l.reservationId||l.id);const v=document.getElementById("edit-res-customer");v&&(v.value=L?.customerName||I);const S=typeof a=="function"?a(l.start):{date:"",time:""},P=typeof a=="function"?a(l.end):{date:"",time:""};t?.("edit-res-start",S.date),t?.("edit-res-start-time",S.time),t?.("edit-res-end",P.date),t?.("edit-res-end-time",P.time);const $=document.getElementById("edit-res-notes");$&&($.value=l.notes||"");const q=document.getElementById("edit-res-discount");if(q){const T=f?0:l.discount??0;q.value=k(T)}const H=document.getElementById("edit-res-discount-type");H&&(H.value=f?"percent":l.discountType||"percent");const N=l.projectId?!1:!!l.applyTax,C=document.getElementById("edit-res-tax");C&&(C.checked=N);const U=document.getElementById("edit-res-company-share");if(U){const T=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,ue=T!=null?Number.parseFloat(k(String(T).replace("%","").trim())):NaN,ke=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,Q=ke!=null?ke===!0||ke===1||ke==="1"||String(ke).toLowerCase()==="true":Number.isFinite(ue)&&ue>0,Oe=Q&&Number.isFinite(ue)&&ue>0?ue:We,qe=N||Q;U.checked=qe,U.dataset.companyShare=String(Oe)}ut(p,{disable:f});const M=document.getElementById("edit-res-close-btn"),D=document.getElementById("edit-res-reopen-btn");M&&(M.disabled=!(p&&!f)||String(l.status||"").toLowerCase()==="completed"),D&&(D.disabled=String(l.status||"").toLowerCase()!=="completed");const _=document.getElementById("edit-res-paid"),ne=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");_&&(_.value=ne,_.dataset&&delete _.dataset.userSelected);const F=document.getElementById("edit-res-payment-progress-type"),x=document.getElementById("edit-res-payment-progress-value");F?.dataset?.userSelected&&delete F.dataset.userSelected,F&&(F.value="percent"),$r(x);const j=document.getElementById("edit-res-cancelled");if(j){const T=String(l?.status||l?.reservationStatus||"").toLowerCase();j.checked=["cancelled","canceled"].includes(T),j.checked&&ut(p,{disable:!0})}let J=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map(T=>String(T));if(!Array.isArray(J)||J.length===0){const T=es(l.id??l.reservationId??l.reservation_code??null);Array.isArray(T)&&T.length&&(J=T)}try{await na()}catch(T){console.warn("[reservationsEdit] positions load failed (non-fatal)",T)}if(ts(J),r?.(y),typeof window<"u"){const T=window?.renderEditPaymentHistory;typeof T=="function"&&T()}Ta(),s?.();const ie=document.getElementById("editReservationModal");sn=Cr(ie,i),sn?.show?.();try{Nr?.(re)}catch(T){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",T)}Ir()}async function Ra({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(nt===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),g=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-notes")?.value||"",f=k(document.getElementById("edit-res-discount")?.value||"0");let m=parseFloat(f)||0,y=document.getElementById("edit-res-discount-type")?.value||"percent";const h=dt(),B=document.getElementById("edit-res-paid"),I=B?.dataset?.userSelected==="true",L=I&&B?.value||"unpaid",E=document.getElementById("edit-res-payment-progress-type"),v=document.getElementById("edit-res-payment-progress-value"),S=_a(E),P=xa(v),$=document.getElementById("edit-res-project")?.value||"",H=document.getElementById("edit-res-cancelled")?.checked===!0,N=ns();N.map(w=>w?.technicianId).filter(Boolean);const C=document.getElementById("edit-res-company-share"),U=document.getElementById("edit-res-tax");if(!d||!l){b(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const M=typeof e=="function"?e:(w,R)=>`${w}T${R||"00:00"}`,D=M(d,u),_=M(l,g);if(D&&_&&new Date(D)>new Date(_)){b(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const F=Wn()?.[nt];if(!F){b(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(we)||we.length===0&&N.length===0){b(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const x=typeof n=="function"?n:()=>!1,j=F.id??F.reservationId;for(const w of we){if(w?.type==="package"&&Array.isArray(w.packageItems)){for(const G of w.packageItems){const K=G?.barcode??G?.normalizedBarcode??"";if(!K)continue;const se=Fe(K);if(se!=="reserved"&&se!=="available"){b(Ye(se));return}}continue}const R=Fe(w.barcode);if(R!=="reserved"&&R!=="available"){b(Ye(R));return}}{const w=typeof t=="function"?t:()=>!1;for(const R of we){if(R?.type!=="package")continue;const G=R.packageId??R.package_id??null,K=R.desc||R.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(G&&w(G,D,_,j)){const se=Array.isArray(R?.packageItems)?R.packageItems.map(W=>z(W?.barcode??W?.normalizedBarcode??"")).filter(Boolean):[];let X=Pn(se,D,_,j);if(!X.length)try{const W=new URLSearchParams;W.set("type","package"),W.set("id",String(G)),W.set("start",D),W.set("end",_),j!=null&&W.set("ignore",String(j));const pe=await Ce(`/reservations/availability.php?${W.toString()}`),Ge=Array.isArray(pe?.conflicts)?pe.conflicts:[];X=Array.from(new Set(Ge.map(ee=>ee?.reservation_code||(ee?.reservation_id!=null?`#${ee.reservation_id}`:null)).filter(Boolean)))}catch{}const oe=X.length?` (${X.join("ØŒ ")})`:"";b(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String(K))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+oe,"warning",-1);return}if(Array.isArray(R?.packageItems)&&R.packageItems.length){const se=(R.packageItems||[]).map(W=>z(W?.barcode??W?.normalizedBarcode??"")).filter(Boolean),X=se.length,oe=se.filter(W=>x(W,D,_,j)).length;if(X>0&&oe>=X){const W=(R.packageItems||[]).map(ee=>z(ee?.barcode??ee?.normalizedBarcode??"")).filter(Boolean);let pe=Pn(W,D,_,j);if(!pe.length)try{const ee=new URLSearchParams;ee.set("type","package"),G!=null&&ee.set("id",String(G)),ee.set("start",D),ee.set("end",_),j!=null&&ee.set("ignore",String(j));const It=await Ce(`/reservations/availability.php?${ee.toString()}`),Et=Array.isArray(It?.conflicts)?It.conflicts:[];pe=Array.from(new Set(Et.map(St=>St?.reservation_code||(St?.reservation_id!=null?`#${St.reservation_id}`:null)).filter(Boolean)))}catch{}const Ge=pe.length?` (${pe.join("ØŒ ")})`:"";b(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String(K))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+Ge,"warning",6e3);return}}}}const J=[];for(const w of we){if(w?.type==="package"&&Array.isArray(w.packageItems)){for(const G of w.packageItems){const K=z(G?.barcode??G?.normalizedBarcode??"");if(K&&x(K,D,_,j)){const se=G?.desc||G?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");J.push({label:k(String(se)),barcode:K})}}continue}const R=z(w.barcode);if(x(R,D,_,j)){const G=w?.desc||w?.name||w?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");J.push({label:k(String(G)),barcode:R})}}if(J.length){const w=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let R=null;try{const K=Array.from(new Set(J.map(X=>X.barcode).filter(Boolean))),se=new Map;await Promise.all(K.map(async X=>{const oe=new URLSearchParams;oe.set("type","equipment"),oe.set("id",X),oe.set("start",D),oe.set("end",_),j!=null&&oe.set("ignore",String(j));const W=await Ce(`/reservations/availability.php?${oe.toString()}`),pe=Array.isArray(W?.conflicts)?W.conflicts:[],Ge=Array.from(new Set(pe.map(ee=>ee?.reservation_code||(ee?.reservation_id!=null?`#${ee.reservation_id}`:null)).filter(Boolean)));se.set(X,Ge)})),R=J.map(({label:X,barcode:oe})=>{const W=se.get(oe)||[];return W.length?`${X} (${W.join("ØŒ ")})`:X}).join("ØŒ ")}catch{}const G=R||J.map(K=>K.label).filter(Boolean).map(String).join("ØŒ ");b(`${w}: ${G}`,"warning",6e3);return}const ie=typeof t=="function"?t:()=>!1;for(const w of we){if(w?.type!=="package")continue;const R=w.packageId??w.package_id??null;if(R&&ie(R,D,_,j)){const G=w.desc||w.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const K=new URLSearchParams;K.set("type","package"),K.set("id",String(R)),K.set("start",D),K.set("end",_),j!=null&&K.set("ignore",String(j));const se=await Ce(`/reservations/availability.php?${K.toString()}`),X=Array.isArray(se?.conflicts)?se.conflicts:[],oe=Array.from(new Set(X.map(pe=>pe?.reservation_code||(pe?.reservation_id!=null?`#${pe.reservation_id}`:null)).filter(Boolean))),W=oe.length?` (${oe.join("ØŒ ")})`:"";b(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String(G))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+W,"warning",6e3)}catch{b(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String(G))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const T=typeof a=="function"?a:()=>!1,ue=[];for(const w of N){if(!w?.technicianId||!T(w.technicianId,D,_,j))continue;const R=w?.technicianName||w?.positionLabel||String(w.technicianId);let G=[];try{G=Zn(w.technicianId,D,_,j)}catch{}ue.push({label:k(String(R)),codes:G})}if(ue.length){const w=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),R=ue.map(({label:G,codes:K})=>K&&K.length?`${G} (${K.join("ØŒ ")})`:G).join("ØŒ ");b(`${w}: ${R}`,"warning",6e3);return}const ke=Array.isArray(re.projects)&&re.projects.length?re.projects:te().projects||[],Q=$&&ke.find(w=>String(w.id)===String($))||null,Oe={...F,projectId:$?String($):null,confirmed:h},{effectiveConfirmed:qe,projectLinked:fe,projectStatus:it}=yt(Oe,Q);let me=!!C?.checked,A=!!U?.checked;if(fe&&(me&&(C.checked=!1,me=!1),A=!1),!fe&&me!==A){b(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}A&&(Be("edit-res-company-share"),me=!!C?.checked);let V=me?getCompanySharePercent("edit-res-company-share"):null;me&&(!Number.isFinite(V)||V<=0)&&(Be("edit-res-company-share"),V=getCompanySharePercent("edit-res-company-share"));const ae=me&&A&&Number.isFinite(V)&&V>0,Y=fe?!1:A;fe&&(m=0,y="percent");const ge=On(we,m,y,Y,N,{start:D,end:_,companySharePercent:ae?V:0});let Z=Ot();if(Number.isFinite(P)&&P>0){const w=ge;let R=null,G=null;S==="amount"?(R=P,w>0&&(G=P/w*100)):(G=P,w>0&&(R=P/100*w));const K=ja({type:S,value:P,amount:R,percentage:G,recordedAt:new Date().toISOString()});K&&(Z=[...Z,K],Sn(Z)),v&&(v.value="")}const de=$t({totalAmount:ge,history:Z}),ye=qt({manualStatus:L,paidAmount:de.paidAmount,paidPercent:de.paidPercent,totalAmount:ge});B&&!I&&(B.value=ye,B.dataset&&delete B.dataset.userSelected);let Pe=F.status??"pending";fe?Pe=Q?.status??it??Pe:H?Pe="cancelled":["completed","cancelled"].includes(String(Pe).toLowerCase())||(Pe=h?"confirmed":"pending");const Ue=Un({reservationCode:F.reservationCode??F.reservationId??null,customerId:F.customerId,start:D,end:_,status:Pe,title:F.title??null,location:F.location??null,notes:p,projectId:$?String($):null,totalAmount:ge,discount:m,discountType:y,applyTax:Y,paidStatus:ye,confirmed:qe,items:we.map(w=>({...w,equipmentId:w.equipmentId??w.id})),crewAssignments:N,companySharePercent:ae?V:null,companyShareEnabled:ae,paidAmount:de.paidAmount,paidPercentage:de.paidPercent,paymentProgressType:de.paymentProgressType,paymentProgressValue:de.paymentProgressValue,paymentHistory:Z});try{Vn("about to submit",{editingIndex:nt,crewAssignments:N,techniciansPayload:Ue?.technicians,payload:Ue});const w=await as(F.id||F.reservationId,Ue);Vn("server response",{reservation:w?.id??w?.reservationId??w?.reservation_code,technicians:w?.technicians,crewAssignments:w?.crewAssignments,techniciansDetails:w?.techniciansDetails}),await ss(),fn(),mt(),vs(),b(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),Na(),o?.({type:"updated",reservation:w}),s?.(),i?.(),sn?.hide?.()}catch(w){console.error("âŒ [reservationsEdit] Failed to update reservation",w);const R=Gn(w)?w.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");b(R,"error")}}function Nr(e={}){re={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=re,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=k(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{on("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{on("share")}),d.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",n?.()}),u.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=k(l.value)}),l.dataset.listenerAttached="true");const g=["edit-res-start","edit-res-end"],p=["edit-res-start-time","edit-res-end-time"],f=S=>{const P=document.getElementById(S);if(!P||P.dataset.editDateListenerAttached==="true")return;const $=()=>{try{n?.()}catch{}try{const q=typeof he=="function"?he().items:[];r?.(q)}catch{}};P.addEventListener("input",$),P.addEventListener("change",$),P.dataset.editDateListenerAttached="true"};g.forEach(f),p.forEach(f),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const m=document.getElementById("edit-res-project");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{Ta();const S=Array.isArray(re.projects)&&re.projects.length?re.projects:te().projects||[],P=m.value&&S.find(C=>String(C.id)===String(m.value))||null,q={...re?.reservation??{},projectId:m.value||null,confirmed:dt()},{effectiveConfirmed:H,projectLinked:N}=yt(q,P);ut(H,{disable:N}),n?.()}),m.dataset.listenerAttached="true");const y=document.getElementById("edit-res-confirmed-btn");y&&!y.dataset.listenerAttached&&(y.addEventListener("click",()=>{if(y.disabled)return;const S=!dt();ut(S);const P=document.getElementById("edit-res-close-btn");P&&(P.disabled=!S),n?.()}),y.dataset.listenerAttached="true");const h=document.getElementById("edit-res-cancelled");h&&!h.dataset.listenerAttached&&(h.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&ut(dt(),{disable:h.checked});const P=document.getElementById("edit-res-close-btn");P&&(P.disabled=h.checked||!dt()),n?.()}),h.dataset.listenerAttached="true");const B=document.getElementById("save-reservation-changes");B&&!B.dataset.listenerAttached&&(B.addEventListener("click",()=>{Ra(re).catch(S=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",S)})}),B.dataset.listenerAttached="true");const I=document.getElementById("edit-res-close-btn");I&&!I.dataset.listenerAttached&&(I.addEventListener("click",()=>{try{const{index:S}=he(),P=document.getElementById("closeReservationModal"),$=document.getElementById("close-reservation-notes"),q=document.getElementById("close-reservation-submit"),H=document.getElementById("edit-res-notes")?.value||"";if($&&($.value=H),q&&q.__tmpCloseListener&&(q.removeEventListener("click",q.__tmpCloseListener),q.__tmpCloseListener=null),q){const N=async()=>{const C=$?.value||"";try{await sa(S,C,{onAfterChange:re?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(P)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(P))?.hide?.()}catch{}}};q.__tmpCloseListener=N,q.addEventListener("click",N,{once:!0})}P&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(P).show()}catch(S){console.warn("[reservationsEdit] failed to open close modal",S)}}),I.dataset.listenerAttached="true");const L=document.getElementById("edit-res-reopen-btn");L&&!L.dataset.listenerAttached&&(L.addEventListener("click",async()=>{try{const{index:S}=he();await ra(S,{onAfterChange:re?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{L.disabled=!0}catch{}}catch(S){console.warn("[reservationsEdit] failed to reopen reservation",S)}}),L.dataset.listenerAttached="true");const E=document.getElementById("edit-res-equipment-barcode");if(E&&!E.dataset.listenerAttached){let S=null;const P=()=>{E.value?.trim()&&(clearTimeout(S),S=null,t?.(E))};E.addEventListener("keydown",q=>{q.key==="Enter"&&(q.preventDefault(),P())});const $=()=>{if(clearTimeout(S),!E.value?.trim())return;const{start:q,end:H}=getEditReservationDateRange();!q||!H||(S=setTimeout(()=>{P()},150))};E.addEventListener("input",$),E.addEventListener("change",P),E.dataset.listenerAttached="true"}qa?.();const v=document.getElementById("editReservationModal");v&&!v.dataset.cleanupAttached&&(v.addEventListener("hidden.bs.modal",()=>{Na(),n?.(),r?.([])}),v.dataset.cleanupAttached="true")}function Kr(){return As().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=te()||{};is(e||[]),$a()})}function bt(e=null){$a(),Da(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function _r(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function cn(){return{populateEquipmentDescriptionLists:ze,setFlatpickrValue:br,splitDateTime:ea,renderEditItems:je,updateEditReservationSummary:Ie,addEquipmentByDescription:hr,addEquipmentToEditingReservation:vr,addEquipmentToEditingByDescription:Dt,combineDateTime:Qe,hasEquipmentConflict:_e,hasTechnicianConflict:Xn,renderReservations:Da,handleReservationsMutation:bt,ensureModal:_r}}function Da(e="reservations-list",n=null){sr({containerId:e,filters:n,onShowDetails:Fa,onConfirmReservation:Va,onCloseReservation:xr,onReopenReservation:za})}function Fa(e){return rr(e,{getEditContext:cn,onEdit:(n,{reservation:t})=>{Oa(n,t)},onDelete:Ma})}function Ma(e){return Ga()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?ks(e,{onAfterChange:bt}):!1:(Ka(),!1)}function Va(e){return ws(e,{onAfterChange:bt})}function za(e){return ra(e,{onAfterChange:bt})}let Ct=null;function Ha(){const e=document.getElementById("closeReservationModal"),n=document.getElementById("close-reservation-notes"),t=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:n,submit:t,cancel:a}}function xr(e){Ct=e;const{modal:n,note:t}=Ha();t&&(t.value=""),n&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(n).show()}function jr(){const{modal:e,note:n,submit:t,cancel:a}=Ha();e&&(t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async()=>{const r=n?.value||"";try{await sa(Ct,r,{onAfterChange:bt})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}Ct=null}}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{Ct=null}),a.dataset.listenerAttached="true"))}function Oa(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}zn(e,cn());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}zn(e,cn());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}Wa({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function Wr(){hs({showReservationDetails:Fa,deleteReservation:Ma,confirmReservation:Va,openReservationEditor:Oa,reopenReservation:za});try{jr()}catch{}}export{Gr as a,Da as b,$a as c,O as d,Fa as e,Ma as f,cn as g,bt as h,Ur as i,Va as j,br as k,Kr as l,Oa as o,Wr as r,Nr as s,Ie as u};
