import{d as re,n as E,t as d,j as y,b as De,z as Ga,y as Wt,v as Ka,w as Wa,u as Ja}from"./auth.BLFzWQsL.js";import{g as Oe,r as mt,f as dn,a as Qa,b as Ye,i as zn,c as Ya}from"./details.C_GhfpJj.js";import{k as ln,l as wn,n as Ae,s as An,o as at,b as Jt,D as Xe,p as st,q as Ve,h as Hn,c as $t,e as _t,t as On,v as Xa,w as Un,x as Za,y as es,z as Gn,a as Et,d as ts,A as Qt,B as Kn,C as Wn,E as Yt,F as Mt,G as ze,H as He,g as Jn,I as ns,J as as,K as ss,u as rs,r as is,L as os,j as cs}from"./reservationsService.CiZsQwfK.js";import{o as un,p as Qn,q as ds,u as Ze,v as St,w as Ee,n as H,x as Yn,y as mn,l as Te,z as Vt,A as Nt,B as ls,C as Xn,D as Zn,E as ea,s as bt,F as ta,G as et,b as pn,H as us,I as ms,J as ps,K as na,L as fs,M as gs,k as aa,N as Bn}from"./state.BK2rhNHf.js";import{d as fn,E as sa,a as ys,c as vs,e as hs,r as bs,s as Is}from"./uiBridge.DRZiKs3I.js";import{g as Es,a as Ss,b as ks}from"./reservationPdf.D_8b39V2.js";import{o as ws}from"./view.C6UW2vEo.js";import{c as ra,r as ia,d as As,a as Bs}from"./reservationsActions.B5dQZML9.js";import{ensureProjectsLoaded as Ps}from"./projectsService.Do5PYtuQ.js";const Ls="__DEBUG_CREW__";function Cs(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Ls);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Pn(e,n){if(Cs())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const oa="projects:create:draft",ca="projects.html#projects-section";let Xt=null,da=[],Zt=new Map,en=new Map,xt=new Map,Gt=!1,Pt=null,Ln=!1,la=[];const Fe="reservations:create:draft";let dt=!1;function zt(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function gn(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function qs(){if(typeof document>"u"||!zt())return null;try{const{input:n,hidden:t}=ut(),{input:a,hidden:r}=Re(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",o=document.getElementById("res-start-time")?.value||"",c=document.getElementById("res-end-time")?.value||"",u=document.getElementById("res-notes")?.value||"",l=document.getElementById("res-discount")?.value||"",p=document.getElementById("res-discount-type")?.value||"percent",g=!!document.getElementById("res-tax")?.checked,f=!!document.getElementById("res-company-share")?.checked,h=f?nt("res-company-share"):null,b=document.getElementById("res-payment-status")?.value||"unpaid",P=document.getElementById("res-payment-progress-type")?.value||"percent",S=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:o,endTime:c,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:u,discount:String(l||""),discountType:p,taxEnabled:g,companyShareEnabled:f,companySharePercent:h,paymentStatus:b,paymentProgressType:P,paymentProgressValue:String(S||""),items:Ee()||[],technicianIds:es()||[],crewAssignments:ln()||[]}}catch{return null}}function Me(){if(dt)return;const e=zt(),n=gn();if(!e&&!n)return;const t=qs();if(t){try{const r=(()=>{const i=e?e.getItem(Fe):null,o=!i&&n?n.getItem(Fe):null,c=i||o;return c?JSON.parse(c):null})(),s=i=>{if(!i)return!1;const o=Array.isArray(i.items)&&i.items.length>0,c=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,u=!!(i.startDate||i.endDate||i.startTime||i.endTime),l=!!(i.customerId||i.customerLabel);return o||c||u||l};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(Fe,a),n&&n!==e&&n.setItem(Fe,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function ua(){const e=zt(),n=gn();if(!(!e&&!n))try{e&&e.removeItem(Fe),n&&n!==e&&n.removeItem(Fe)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function $s(){const e=zt(),n=gn();if(!e&&!n)return;dt=!0;let t=null;try{const a=e?e.getItem(Fe):null,r=!a&&n?n.getItem(Fe):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),dt=!1;return}if(t)try{if(t.startDate||t.startTime){const i=Ze(t.startDate||"",t.startTime||"");Ge("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=Ze(t.endDate||"",t.endTime||"");Ge("res-end","res-end-time",i)}if(t.customerId){Le({selectedValue:String(t.customerId)});const{input:i,hidden:o}=ut();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){Le({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=ut();i&&(i.value=t.customerLabel),o&&(o.value="");try{const c=Rt(t.customerLabel,{allowPartial:!0});c&&(o.value=String(c.id),i.value=c.label,i.dataset.selectedId=String(c.id))}catch{}}if(t.projectId)Ue({selectedValue:String(t.projectId)});else if(t.projectLabel){Ue({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=Re();i&&(i.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",Ie(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(St(t.items),me()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{An(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{An(t.technicianIds)}catch{}je();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}G()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{dt=!1}}function _s(e){if(!e)return null;let n=la.find(a=>a.id===e)||null;if(n)return n;const t=us(e);return t?(n={id:e,name:ps(t)||e,price:ms(t),items:pn(t),raw:t},n):null}function jt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Tt(e){return E(String(e||"")).trim().toLowerCase()}function Ns(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=E(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function ma(e){const n=E(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function pa(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function fa(e){if(!e)return null;const n=E(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function ga(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=E(String(n))}}function tt(e){switch(e){case"maintenance":return d("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return d("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return d("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return d("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function ut(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function Re(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function we(){const{input:e,hidden:n}=Re();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function Qe(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function ya(e,n,{allowPartial:t=!1}={}){const a=Ae(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,o)=>{o.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function Rt(e,n={}){return ya(Zt,e,n)}function tn(e,n={}){return ya(en,e,n)}function Ie(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function va(e){da=Array.isArray(e)?[...e]:[]}function yn(){return da}function vn(e){return e&&yn().find(n=>String(n.id)===String(e))||null}function Cn(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||d("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function nt(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??Xe,a=E(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:Xe}function Ce(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??Xe,a=E(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=Xe),n.dataset.companyShare=String(r),n.checked=!0}function nn(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Gt){G();return}Gt=!0;const a=()=>{Gt=!1,G()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Xe)),n.disabled){t.checked=!1,y(d("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),Ce()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Ce():t.checked&&(t.checked=!1));a()}function xs(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function qn(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function $n(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function Le({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=ut();if(!t||!a||!r)return;const s=un()||[],i=d("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=d("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const c=new Set;Zt=new Map;const u=s.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:$n(m)||o})).filter(m=>{if(!m.label)return!1;const f=Ae(m.label);return!f||c.has(f)?!1:(c.add(f),Zt.set(f,m),!0)}).sort((m,f)=>m.label.localeCompare(f.label,void 0,{sensitivity:"base"}));r.innerHTML=u.map(m=>`<option value="${jt(m.label)}"></option>`).join("");const l=n?"":t.value,p=e?String(e):a.value?String(a.value):"",g=p?s.find(m=>String(m.id)===p):null;if(g){const m=$n(g)||o;a.value=String(g.id),t.value=m,t.dataset.selectedId=String(g.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":l}function Ue({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=Re();if(!a||!r||!s)return;const i=Array.isArray(n)?n:yn()||[],o=d("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const c=[...i].filter(h=>h&&h.id!=null).sort((h,b)=>String(b.createdAt||b.start||"").localeCompare(String(h.createdAt||h.start||""))),u=t?"":a.value,l=d("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),p=new Set;en=new Map;const g=c.map(h=>{const b=Cn(h)||l;return{id:String(h.id),label:b}}).filter(h=>{if(!h.label)return!1;const b=Ae(h.label);return!b||p.has(b)?!1:(p.add(b),en.set(b,h),!0)});s.innerHTML=g.map(h=>`<option value="${jt(h.label)}"></option>`).join("");const m=e?String(e):r.value?String(r.value):"",f=m?c.find(h=>String(h.id)===m):null;if(f){const h=Cn(f)||l;r.value=String(f.id),a.value=h,a.dataset.selectedId=String(f.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":u}function Ge(e,n,t){const{date:a,time:r}=ta(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const o=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,o)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,o)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function ha(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||Ue({selectedValue:a});const s=(un()||[]).find(l=>String(l.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";Le(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=qn(e,"start"),c=qn(e,"end");o&&Ge("res-start","res-start-time",o),c&&Ge("res-end","res-end-time",c);const u=document.getElementById("res-notes");u&&e.description&&(n||!u.value)&&(u.value=e.description),G(),je()}function ba({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:re(),r=Array.isArray(a)?a:[];va(r);const s=n!=null?String(n):t.value?String(t.value):"";Ue({selectedValue:s,projectsList:r}),je(),G()}function je(){const{input:e,hidden:n}=Re(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),c=document.getElementById("res-discount-type"),u=d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),p=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(Qe(t,we),a&&Qe(a,we)),r&&Qe(r,we),s&&Qe(s,we),i&&Qe(i,we),o&&Qe(o,we),c&&Qe(c,we),p)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),r&&(r.value="unpaid",Ie(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),c&&(c.value="percent",c.disabled=!0,c.classList.add("reservation-input-disabled"),c.title=u);else{if(t){const g=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",g&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),c&&(c.disabled=!1,c.classList.remove("reservation-input-disabled"),c.title="")}nn("tax"),G()}function hn(){const{input:e,hidden:n}=Re();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?tn(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=vn(s.id);i?ha(i,{skipProjectSelectUpdate:!0}):(je(),G())}else n.value="",e.dataset.selectedId="",je(),G()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?tn(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Me()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function bn(){const{input:e,hidden:n}=ut();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Rt(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),G()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Rt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Me()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function js(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){yt({clearValue:!0});return}let t=null;try{const u=decodeURIComponent(n);t=JSON.parse(u)}catch(u){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),yt({clearValue:!1}),!t)return;t.fromProjectForm&&(Pt={draftStorageKey:t.draftStorageKey||oa,returnUrl:t.returnUrl||ca});const s=document.getElementById("res-project");if(t.projectId){s&&(Ue({selectedValue:String(t.projectId)}),je());const u=vn(t.projectId);u?ha(u,{forceNotes:!!t.forceNotes}):G(),yt()}else{s&&Ue({selectedValue:""});const u=t.projectTitle?t.projectTitle:d("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");Xs(d("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),u)}t.start&&Ge("res-start","res-start-time",t.start),t.end&&Ge("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(t.customerId){const l=(un()||[]).find(p=>String(p.id)===String(t.customerId));l?.id!=null&&(Le({selectedValue:String(l.id)}),o&&(o.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else t.customerName&&i?(Le({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",o&&(o.value="")):Le({selectedValue:""});const c=document.getElementById("res-notes");c&&t.description&&!c.value&&(c.value=t.description),G()}function We(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Ze(e,t),end:Ze(n,a)}}function Ia(e){const n=Tt(e);if(n){const o=xt.get(n);if(o)return o}const{description:t,barcode:a}=ma(e);if(a){const o=dn(a);if(o)return o}const r=Ae(t||e);if(!r)return null;let s=Yn();if(!s?.length){const o=re();s=Array.isArray(o?.equipment)?o.equipment:[],s.length&&na(s)}const i=s.find(o=>Ae(o?.desc||o?.description||"")===r);return i||s.find(o=>Ae(o?.desc||o?.description||"").includes(r))||null}function Ea(e,n="equipment-description-options"){const t=Tt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(c=>Tt(c.value)===t)||xt.has(t))return!0;const{description:r}=ma(e);if(!r)return!1;const s=Ae(r);return s?(Yn()||[]).some(o=>Ae(o?.desc||o?.description||"")===s):!1}const Ts={available:0,reserved:1,maintenance:2,retired:3};function Rs(e){return Ts[e]??5}function _n(e){switch(e){case"available":return d("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return d("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return d("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return d("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return d("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Ds(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${_n(t)}`;const a=d("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${_n(t)})`}function Ke(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=fn(),a=re(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];na(s);const i=new Map;s.forEach(u=>{const l=Ns(u),p=Tt(l);if(!p||!l)return;const g=Oe(u),m=Rs(g),f=i.get(p);if(!f){i.set(p,{normalized:p,value:l,bestItem:u,bestStatus:g,bestPriority:m,statuses:new Set([g])});return}f.statuses.add(g),m<f.bestPriority&&(f.bestItem=u,f.bestStatus=g,f.bestPriority=m,f.value=l)}),xt=new Map;const c=Array.from(i.values()).sort((u,l)=>u.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(u=>{xt.set(u.normalized,u.bestItem);const l=Ds(u),p=jt(u.value);if(l===u.value)return`<option value="${p}"></option>`;const g=jt(l);return`<option value="${p}" label="${g}"></option>`}).join("");e&&(e.innerHTML=c),n&&(n.innerHTML=c)}function Sa(e,n,t={}){const{silent:a=!1}=t,r=H(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=We();if(!s||!i){const f=d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||y(f),{success:!1,message:f}}const o=Ee();if(In(o).has(r)){const f=d("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||y(f),{success:!1,message:f}}const u=mn(r,s,i);if(u.length){const f=u.map(b=>b.name).join(", "),h=d("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${f}`);return a||y(h),{success:!1,message:h}}if(Te(r,s,i)){const f=d("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const h=new URLSearchParams({type:"equipment",id:r,start:s,end:i});De(`/reservations/availability.php?${h.toString()}`).then(b=>{const P=Array.isArray(b?.conflicts)?b.conflicts:[],S=Array.from(new Set(P.map(w=>w?.reservation_code||(w?.reservation_id!=null?`#${w.reservation_id}`:null)).filter(Boolean))),j=S.length?`${f}: ${S.join("ØŒ ")}`:f;y(j)}).catch(()=>y(f))}catch{y(f)}return{success:!1,message:f}}const l=dn(r);if(!l){const f=d("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||y(f),{success:!1,message:f}}const p=Oe(l);if(p==="maintenance"||p==="retired"){const f=tt(p);return a||y(f),{success:!1,message:f}}const g=st(l);if(!g){const f=d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||y(f),{success:!1,message:f}}Vt({id:g,equipmentId:g,barcode:r,desc:l.desc,qty:1,price:l.price,cost:Ye(l),image:mt(l)}),n&&(n.value=""),me(),G();const m=d("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||y(m),{success:!0,message:m,barcode:r}}function an(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=Ia(n);if(!t){y(d("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Qa(t.barcode),r=Oe(a||t);if(r==="maintenance"||r==="retired"){y(tt(r));return}const s=H(t.barcode);if(!s){y(d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=st(t);if(!i){y(d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,cost:Ye(t),image:mt(t)},{start:c,end:u}=We();if(!c||!u){y(d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const l=Ee();if(In(l).has(s)){y(d("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const g=mn(s,c,u);if(g.length){const m=g.map(f=>f.name).join(", ");y(d("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(Te(s,c,u)){const m=d("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const f=new URLSearchParams({type:"equipment",id:s,start:c,end:u});De(`/reservations/availability.php?${f.toString()}`).then(h=>{const b=Array.isArray(h?.conflicts)?h.conflicts:[],P=Array.from(new Set(b.map(j=>j?.reservation_code||(j?.reservation_id!=null?`#${j.reservation_id}`:null)).filter(Boolean))),S=P.length?`${m}: ${P.join("ØŒ ")}`:m;y(S)}).catch(()=>y(m))}catch{y(m)}return}Vt(o),me(),G(),y(d("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function Fs(){Ke();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),an(e))});const n=()=>{Ea(e.value,"equipment-description-options")&&an(e)};e.addEventListener("focus",()=>{if(Ke(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function Nn(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function In(e=Ee()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=H(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=H(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function Ms(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=We();if(!n||!t){y(d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}ys({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):y(d("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(sa.change,n=>{Nn(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),Nn(e,hs()))}function Vs(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,o=null;const c=[],u=new Set;s.forEach(p=>{const g=H(p);g&&!u.has(g)&&(u.add(g),c.push(g))});const l=Math.min(r,c.length);for(let p=0;p<l;p+=1){const g=c[p],m=Sa(g,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const g=d("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",E(String(i)));y(g)}else o&&y(o)}function ka(){Ms(),!(Ln||typeof document>"u")&&(document.addEventListener(sa.requestAdd,Vs),Ln=!0)}function kt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function sn(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=kt();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=n==="package";s&&(s.disabled=o),i&&(i.disabled=o),r&&(r.disabled=n!=="package"||r.options.length===0),fs(n),n==="package"&&Ht()}function Ht(){const{packageSelect:e,packageHint:n}=kt();if(!e)return;const t=Qn();la=t,ds(t.map(o=>o.raw??o));const a=d("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${d("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(o=>{const c=Number.isFinite(Number(o.price))?Number(o.price):0,u=E(c.toFixed(2)),l=`${o.name} â€” ${u} ${a}`;return`<option value="${o.id}">${l}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=d("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=d("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),Ba()}function zs(e,n){const t=e?.name||d("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=d("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const o=s?.desc||E(String(s?.barcode??s?.normalizedBarcode??""))||d("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const c=i.map(u=>u.name).join(", ");return`â€¢ ${o} (${d("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${c})`}return`â€¢ ${o} (${d("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function wa(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=et(e);if(!s)return{success:!1,reason:"invalid",message:d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=_s(s);if(!i)return{success:!1,reason:"not_found",message:d("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(m=>m?.type==="package"&&et(m.packageId)===s))return{success:!1,reason:"duplicate",message:d("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(Xn(s,t,a,r)){const m=i.name||s;return{success:!1,reason:"package_conflict",message:d("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:pn(i.raw??{}),c=In(n),u=[],l=new Set;if(o.forEach(m=>{const f=H(m?.normalizedBarcode??m?.barcode);if(f){if(l.has(f)){u.push({item:m,type:"internal"});return}l.add(f),c.has(f)&&u.push({item:m,type:"external"})}}),u.length){const m=u.map(({item:h})=>h?.desc||h?.description||h?.name||h?.barcode||h?.normalizedBarcode||d("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(h=>E(String(h))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(h=>h.type==="external")?d("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):d("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:u}}const p=[];return o.forEach(m=>{const f=H(m?.normalizedBarcode??m?.barcode);if(f&&Te(f,t,a,r)){const h=mn(f,t,a,r);p.push({item:m,blockingPackages:h})}}),p.length?{success:!1,reason:"item_conflict",message:zs(i,p),conflicts:p}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,cost:Number.isFinite(Number(i.cost))?Number(i.cost):0,barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:H(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0,cost:0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function Aa(e,{silent:n=!1}={}){const t=et(e);if(!t)return n||y(d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=We(),s=Ee(),i=wa(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const c={invalid:d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:d("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:d("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");y(i.message||c)}return i}return Vt(i.package),me(),G(),n||y(d("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function Ba(){const{packageSelect:e}=kt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;Aa(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Hs(){const{packageAddButton:e,packageSelect:n}=kt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){y(d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Aa(t)}),e.dataset.listenerAttached="true")}function Pa(){const{modeRadios:e}=kt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&sn(r.target.value)}),a.dataset.listenerAttached="true")}),Hs(),Ba();const n=Nt(),t=e.find(a=>a.value===n);t&&(t.checked=!0),sn(n)}function me(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=Ee(),a=d("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=d("reservations.create.summary.currency","SR"),s=d("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=d("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=d("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),c=d("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;return}const u=at(t);n.innerHTML=u.map(l=>{const p=l.items[0]||{},g=mt(p)||l.image,m=g?`<img src="${g}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',f=E(String(l.count)),h=Number.isFinite(Number(l.unitPrice))?Number(l.unitPrice):0,b=(()=>{try{const{start:U,end:T}=We(),C=Jt(U,T);return Number.isFinite(C)&&C>0?C:1}catch{return 1}})(),P=E(String(b)),S=h*l.count*b,j=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${l.key}"
          min="0"
          step="0.01"
          value="${E(String(h))}"
          aria-label="${d("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,w=`${E(S.toFixed(2))} ${r}`,I=Number.isFinite(Number(l.unitCost))?Number(l.unitCost):0;`${E(I.toFixed(2))}${r}`;const k=l.items.some(U=>U?.type==="package"),A=l.barcodes.map(U=>E(String(U||""))).filter(Boolean),x=A.length?`<details class="reservation-item-barcodes">
            <summary>${d("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${A.map(U=>`<li>${U}</li>`).join("")}
            </ul>
          </details>`:"";let $="";if(k){const U=new Map;if(l.items.forEach(T=>{Array.isArray(T?.packageItems)&&T.packageItems.forEach(C=>{if(!C)return;const W=H(C.barcode||C.desc||Math.random()),O=U.get(W);if(O){O.qty+=Number.isFinite(Number(C.qty))?Number(C.qty):1;return}U.set(W,{desc:C.desc||C.barcode||d("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(C.qty))?Number(C.qty):1,barcode:C.barcode??C.normalizedBarcode??""})})}),U.size){const T=Array.from(U.values()).map(C=>{const W=E(String(C.qty)),O=C.desc||E(String(C.barcode||"")),M=C.barcode?` <span class="reservation-package-items__barcode">(${E(String(C.barcode))})</span>`:"";return`<li>${O}${M} Ã— ${W}</li>`}).join("");$=`
            <details class="reservation-package-items">
              <summary>${d("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${T}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${k?`${$||""}${x||""}`:x}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${l.key}" aria-label="${o}" ${k?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${l.key}" aria-label="${i}" ${k?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${P}</span></td>
          <td>${j}</td>
          <td><input type="number" class="form-control form-control-sm reservation-unit-cost-input" data-group-key="${l.key}" min="0" step="0.01" value="${E(String(I))}" aria-label="${d("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"></td>
          <td>${w}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${l.key}" aria-label="${c}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Os(e){const n=Ee(),a=at(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(ls(r),me(),G())}function Us(e){const n=Ee(),t=n.filter(a=>Ve(a)!==e);t.length!==n.length&&(St(t),me(),G())}function Gs(e,n){const t=La(n),a=Number.isFinite(t)&&t>=0?Ca(t):0,r=Ee(),i=at(r).find(c=>c.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(c=>{o[c]&&(o[c]={...o[c],price:a,unit_price:a})}),St(o),me(),G()}function Ks(e,n){const t=La(n),a=Number.isFinite(t)&&t>=0?Ca(t):0,r=Ee(),i=at(r).find(c=>c.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(c=>{if(o[c]){const u={...o[c],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};o[c]=u}}),St(o),me(),G()}function La(e){const n=E(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),t=Number.parseFloat(n);return Number.isFinite(t)?t:NaN}function Ca(e){const n=Number(e);return!Number.isFinite(n)||n<0?0:Number(n.toFixed(2))}function Ws(e){const n=Ee(),a=at(n).find(p=>p.key===e);if(!a)return;const{start:r,end:s}=We();if(!r||!s){y(d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(p=>H(p.barcode))),{equipment:o=[]}=re(),c=(o||[]).find(p=>{const g=H(p?.barcode);return!g||i.has(g)||Ve({desc:p?.desc||p?.description||p?.name||"",price:Number(p?.price)||0})!==e||!zn(p)?!1:!Te(g,r,s)});if(!c){y(d("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=H(c.barcode),l=st(c);if(!l){y(d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}Vt({id:l,equipmentId:l,barcode:u,desc:c.desc||c.description||c.name||a.description||"",qty:1,price:Number.isFinite(Number(c.price))?Number(c.price):a.unitPrice,cost:Number.isFinite(Number(c.cost))?Number(c.cost):Number.isFinite(Number(c.unit_cost))?Number(c.unit_cost):Number(a.unitCost)||0,image:mt(c)}),me(),G()}function G(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(E(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,o=document.getElementById("res-payment-status"),c=o?.value||"unpaid",{start:u,end:l}=We();i&&Ce();const p=nt(),g=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),f=pa(g),h=fa(m);ln(),wn({selectedItems:Ee(),discount:t,discountType:r,applyTax:i,paidStatus:c,paymentProgressType:f,paymentProgressValue:h,start:u,end:l,companySharePercent:p,paymentHistory:[]});const b=wn.lastResult;b?(ga(m,b.paymentProgressValue),o&&(o.value=b.paymentStatus,Ie(o,b.paymentStatus))):Ie(o,c);try{Me()}catch{}}function Js(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=E(o.target.value),G()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",G),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if(we()){t.checked=!1,y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}nn("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(we()){a.checked=!1,y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}nn("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(we()){r.value="unpaid",Ie(r,"unpaid"),y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Ie(r),G()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",o=>{if(we()){s.value="percent",y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",G()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(we()){i.value="",y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=E(o.target.value),G()}),i.dataset.listenerAttached="true"),G()}function Qs(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const o=()=>{try{Me()}catch{}},c=()=>{try{me(),G()}catch{}};s.addEventListener("input",o),s.addEventListener("change",o),s.addEventListener("input",c),s.addEventListener("change",c),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const o=()=>{try{Me()}catch{}},c=()=>{try{me(),G()}catch{}};i.addEventListener("input",o),i.addEventListener("change",o),i.addEventListener("input",c),i.addEventListener("change",c),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){G();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),G();try{me()}catch{}};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{Me()}catch{}try{me(),G()}catch{}}});const r=()=>{try{Me()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function xn(){const{input:e,hidden:n}=ut(),{input:t,hidden:a}=Re(),{customers:r}=re();let s=n?.value?String(n.value):"";if(!s&&e?.value){const B=Rt(e.value,{allowPartial:!0});B&&(s=String(B.id),n&&(n.value=s),e.value=B.label,e.dataset.selectedId=s)}const i=r.find(B=>String(B.id)===s);if(!i){y(d("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let c=a?.value?String(a.value):"";if(!c&&t?.value){const B=tn(t.value,{allowPartial:!0});B&&(c=String(B.id),a&&(a.value=c),t.value=B.label,t.dataset.selectedId=c)}const u=document.getElementById("res-start").value,l=document.getElementById("res-end").value,p=document.getElementById("res-start-time")?.value||"00:00",g=document.getElementById("res-end-time")?.value||"00:00";if(!u||!l){y(d("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const m=`${u}T${p}`,f=`${l}T${g}`,h=new Date(m),b=new Date(f);if(Number.isNaN(h.getTime())||Number.isNaN(b.getTime())||h>=b){y(d("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const P=ln();P.map(B=>B.technicianId).filter(Boolean);const S=Ee();if(S.length===0&&P.length===0){y(d("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const j=document.getElementById("res-notes")?.value||"",w=parseFloat(E(document.getElementById("res-discount")?.value))||0,I=document.getElementById("res-discount-type")?.value||"percent",k=document.getElementById("res-payment-status"),A=k?.value||"unpaid",x=document.getElementById("res-payment-progress-type"),$=document.getElementById("res-payment-progress-value"),U=pa(x),T=fa($),C=c?vn(c):null,W=xs(C);if(c&&!C){y(d("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const B of S){const z=Oe(B.barcode);if(z==="maintenance"||z==="retired"){y(tt(z));return}}const O=[];for(const B of S){const z=H(B.barcode);if(Te(z,m,f)){const ie=B?.desc||B?.name||B?.barcode||d("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");O.push({label:E(String(ie)),barcode:z})}}if(O.length){const B=d("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let z=null;try{const Z=Array.from(new Set(O.map(se=>se.barcode).filter(Boolean))),ye=new Map;await Promise.all(Z.map(async se=>{const ue=new URLSearchParams({type:"equipment",id:se,start:m,end:f}),le=await De(`/reservations/availability.php?${ue.toString()}`),it=Array.isArray(le?.conflicts)?le.conflicts:[],ot=Array.from(new Set(it.map(be=>be?.reservation_code||(be?.reservation_id!=null?`#${be.reservation_id}`:null)).filter(Boolean)));ye.set(se,ot)})),z=O.map(({label:se,barcode:ue})=>{const le=ye.get(ue)||[];return le.length?`${se} (${le.join("ØŒ ")})`:se}).join("ØŒ ")}catch{}const ie=z||O.map(Z=>Z.label).filter(Boolean).map(String).join("ØŒ ");y(`${B}: ${ie}`,"warning",6e3);return}const M=[];for(const B of S){if(B?.type!=="package")continue;const z=B.packageId??B.package_id??null;if(z&&Xn(z,m,f)){const ie=B.desc||B.packageName||d("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let Z=[];try{const ye=new URLSearchParams({type:"package",id:String(z),start:m,end:f}),se=await De(`/reservations/availability.php?${ye.toString()}`),ue=Array.isArray(se?.conflicts)?se.conflicts:[];Z=Array.from(new Set(ue.map(le=>le?.reservation_code||(le?.reservation_id!=null?`#${le.reservation_id}`:null)).filter(Boolean)))}catch{}M.push({label:E(String(ie)),codes:Z})}}if(M.length){const B=M.map(({label:ie,codes:Z})=>Z&&Z.length?`${ie} (${Z.join("ØŒ ")})`:ie).join("ØŒ "),z=d("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");y(`${z}: ${B}`,"warning",6e3);return}const _=[];for(const B of P){if(!B?.technicianId||!Zn(B.technicianId,m,f))continue;const z=B?.technicianName||B?.positionLabel||String(B.technicianId);let ie=[];try{ie=ea(B.technicianId,m,f,null)}catch{}_.push({label:E(String(z)),codes:ie})}if(_.length){const B=d("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),z=_.map(({label:ie,codes:Z})=>Z&&Z.length?`${ie} (${Z.join("ØŒ ")})`:ie).join("ØŒ ");y(`${B}: ${z}`);return}const ne=document.getElementById("res-tax"),V=document.getElementById("res-company-share"),R=!!c;R?(ne&&(ne.checked=!1,ne.disabled=!0,ne.classList.add("disabled"),ne.title=d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),V&&(V.checked=!1,V.disabled=!0,V.classList.add("disabled"),V.title=d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),k&&(k.value="unpaid",k.disabled=!0,Ie(k,"unpaid"),k.title=d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),x&&(x.disabled=!0,x.classList.add("disabled")),$&&($.value="",$.disabled=!0,$.classList.add("disabled"))):(ne&&(ne.disabled=!1,ne.classList.remove("disabled"),ne.title=""),V&&(V.disabled=!1,V.classList.remove("disabled"),V.title=""),k&&(k.disabled=!1,k.title=""),x&&(x.disabled=!1,x.classList.remove("disabled")),$&&($.disabled=!1,$.classList.remove("disabled")));const D=R?!1:ne?.checked||!1,X=!!V?.checked;if(!R&&X!==D){y(d("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let de=X?nt():null;X&&(!Number.isFinite(de)||de<=0)&&(Ce(),de=nt());const N=X&&D&&Number.isFinite(de)&&de>0;D&&Ce();const pe=Hn(S,w,I,D,P,{start:m,end:f,companySharePercent:N?de:0}),Be=Ga(),Y=$t({totalAmount:pe,progressType:U,progressValue:T,history:[]});$&&ga($,Y.paymentProgressValue);const Je=[];Y.paymentProgressValue!=null&&Y.paymentProgressValue>0&&Je.push({type:Y.paymentProgressType||U,value:Y.paymentProgressValue,amount:Y.paidAmount,percentage:Y.paidPercent,recordedAt:new Date().toISOString()});const Ne=_t({manualStatus:A,paidAmount:Y.paidAmount,paidPercent:Y.paidPercent,totalAmount:pe});k&&(k.value=Ne,Ie(k,Ne));const ge=typeof C?.paymentStatus=="string"?C.paymentStatus.toLowerCase():null,pt=ge&&["paid","partial","unpaid"].includes(ge)?ge:"unpaid",fe=On({reservationCode:Be,customerId:o,start:m,end:f,status:W?"confirmed":"pending",title:null,location:null,notes:j,projectId:c||null,totalAmount:pe,discount:R?0:w,discountType:R?"percent":I,applyTax:D,paidStatus:R?pt:Ne,confirmed:W,items:S.map(B=>({...B,equipmentId:B.equipmentId??B.id})),crewAssignments:P,companySharePercent:R||!N?null:de,companyShareEnabled:R?!1:N,paidAmount:R?0:Y.paidAmount,paidPercentage:R?0:Y.paidPercent,paymentProgressType:R?null:Y.paymentProgressType,paymentProgressValue:R?null:Y.paymentProgressValue,paymentHistory:R?[]:Je});try{Pn("about to submit",{crewAssignments:P,techniciansPayload:fe?.technicians,payload:fe});const B=await Xa(fe);Pn("server response",{reservation:B?.id??B?.reservationId??B?.reservation_code,technicians:B?.technicians,crewAssignments:B?.crewAssignments,techniciansDetails:B?.techniciansDetails}),fn(),Ke(),bt(),qa(),y(d("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const z=document.getElementById("sub-tab-trigger-my-reservations-tab");z&&typeof z.click=="function"&&setTimeout(()=>z.click(),0)}catch{}typeof Xt=="function"&&Xt({type:"created",reservation:B}),Ys(B)}catch(B){console.error("âŒ [reservations/createForm] Failed to create reservation",B);const z=Un(B)?B.message:d("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");y(z,"error"),R&&(y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),yt({clearValue:!1}))}}function Ys(e){if(!Pt)return;const{draftStorageKey:n=oa,returnUrl:t=ca}=Pt,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}Pt=null,t&&(window.location.href=t)}function yt({clearValue:e=!1}={}){const{input:n,hidden:t}=Re();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,je())}function Xs(e,n=""){const{input:t,hidden:a}=Re();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),je())}function qa(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),Le({selectedValue:"",resetInput:!0});try{Ge("res-start","res-start-time","")}catch{}try{Ge("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),yt({clearValue:!1}),Ue({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",Ie(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),Za(),St([]),vs("form-reset"),me(),je(),G(),ua()}function Zs(){const e=document.getElementById("reservation-items");if(!e||e.dataset.listenerAttached)return;e.addEventListener("click",t=>{const a=t.target.closest("button[data-action]");if(!a)return;const{action:r,groupKey:s}=a.dataset;if(r==="decrease-group"&&s){Os(s);return}if(r==="increase-group"&&s){Ws(s);return}if(r==="remove-group"&&s){Us(s);return}});const n=t=>{const a=t.target.closest(".reservation-unit-price-input");if(a){const s=a.dataset.groupKey;s&&Gs(s,a.value);return}const r=t.target.closest(".reservation-unit-cost-input");if(r){const s=r.dataset.groupKey;s&&Ks(s,r.value)}};e.addEventListener("change",n),e.addEventListener("input",n),e.dataset.listenerAttached="true"}function er(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(Nt()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,Sa(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||Nt()!=="single")return;const{start:s,end:i}=We();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function tr(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await xn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await xn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),qa();try{ua()}catch{}y(d("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function Wr({onAfterSubmit:e}={}){Xt=typeof e=="function"?e:null,dt=!0;const{customers:n,projects:t}=re();gs(n||[]),Le(),bn(),va(t||[]),ba({projectsList:t}),hn(),Ke(),Ht(),Fs(),ka(),Pa(),Qs(),Js(),Zs(),er(),tr(),$s(),js(),G(),me();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Me()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}dt=!1}function $a(){Ke(),Ht(),ba(),Le(),bn(),hn(),ka(),Pa(),me(),G()}if(typeof document<"u"){const e=()=>{Le(),Ue({projectsList:yn()}),bn(),hn(),G()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Ke()}),document.addEventListener("packages:changed",()=>{Ht(),Nt()==="package"&&sn("package")})}typeof window<"u"&&(window.getCompanySharePercent=nt);function Bt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function nr(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function ar(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=nr(t);if(a!==null)return a}return null}function jn(e,n=0){const t=ar(e);if(t!=null)return t;const a=Bt(e.createdAt??e.created_at);if(a!=null)return a;const r=Bt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=Bt(e.start);if(s!=null)return s;const i=Bt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(n)?n:0}function sr({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((S,j)=>({reservation:S,index:j})),i=n.searchTerm||"",o=n.searchReservationId||"",c=n.searchCustomerName||"",u=n.searchProjectId||"",l=n.startDate||"",p=n.endDate||"",g=n.status||"",m=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,f=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,h=l?new Date(`${l}T00:00:00`):null,b=p?new Date(`${p}T23:59:59`):null,P=s.filter(({reservation:S})=>{const j=t.get(String(S.customerId)),w=r?.get?.(String(S.projectId)),I=S.start?new Date(S.start):null,k=Gn(S),{effectiveConfirmed:A}=Et(S,w);if(m!=null&&String(S.customerId)!==String(m)||f!=null&&!(Array.isArray(S.technicians)?S.technicians.map(C=>String(C)):[]).includes(String(f))||g==="confirmed"&&!A||g==="pending"&&A||g==="completed"&&!k)return!1;if(g==="cancelled"){const T=String(S?.status||S?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(T))return!1}if(h&&I&&I<h||b&&I&&I>b)return!1;if(o){const T=[S.reservationId,S.id,S.reservation_id,S.reservationCode,S.reservation_code,S.code,S.reference,S.referenceNumber,S.reference_number],C=Ae(T.filter(O=>O!=null&&O!=="").map(String).join(" ")).replace(/\s+/g,""),W=o.replace(/\s+/g,"");if(!C.includes(W))return!1}if(c&&!Ae(j?.customerName||S.customerName||"").includes(c))return!1;if(u){const T=[S.projectId,S.project_id,S.projectID,w?.id,w?.projectCode,w?.project_code],C=Ae(T.filter(O=>O!=null&&O!=="").map(String).join(" ")).replace(/\s+/g,""),W=u.replace(/\s+/g,"");if(!C.includes(W))return!1}if(!i)return!0;const x=S.items?.map?.(T=>`${T.barcode} ${T.desc}`).join(" ")||"",$=(S.technicians||[]).map(T=>a.get(String(T))?.name).filter(Boolean).join(" ");return Ae([S.reservationId,j?.customerName||S.customerName,S.notes,x,$,w?.title].filter(Boolean).join(" ")).includes(i)});return P.sort((S,j)=>{const w=jn(S.reservation,S.index),I=jn(j.reservation,j.index);return w!==I?I-w:j.index-S.index}),P}function rr({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=d("reservations.create.summary.currency","SR"),s=d("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=d("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=d("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),c=d("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),u=d("reservations.list.crew.separator","ØŒ "),l=d("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),p=d("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),g=d("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),m=d("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),f=d("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),h=d("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),b=d("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),P=d("reservations.list.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),S=d("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),j=d("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),w={client:d("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:d("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:d("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:d("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:d("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:d("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:d("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:I,index:k})=>{const A=n.get(String(I.customerId)),x=I.projectId?a?.get?.(String(I.projectId)):null,$=Gn(I),U=I.items?.length||0,T=Array.isArray(I.crewAssignments)?I.crewAssignments:[],C=(I.technicians||[]).map(ee=>t.get(String(ee))).filter(Boolean),W=T.length?T.map(ee=>{const Se=ee.positionLabel??ee.position_name??ee.role??d("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),xe=ee.technicianName??t.get(String(ee.technicianId??""))?.name??null;return xe?`${E(Se)} (${E(xe)})`:E(Se)}):C.map(ee=>ee.name),O=W.length?W.join(u):"â€”",M=E(String(I.reservationId??"")),_=I.start?E(Wt(I.start)):"-",ne=I.end?E(Wt(I.end)):"-",V=I.discount??I.discountValue??I.discount_value??I.discountAmount??0,R=Number.parseFloat(E(String(V))),D=Number.isFinite(R)?R:0,X=I.discountType??I.discount_type??I.discountMode??"percent",de=String(X).toLowerCase()==="amount"?"amount":"percent",N=!!(I.applyTax??I.apply_tax??I.taxApplied),pe=I.companySharePercent??I.company_share_percent??I.companyShare??I.company_share,Be=I.companyShareEnabled??I.company_share_enabled??I.companyShareApplied,Y=Number.parseFloat(E(String(pe))),Ne=(Be===!0||Number.isFinite(Y)&&Y>0)&&Number.isFinite(Y)?Y:0;let ge=0;try{const ee=ts({items:I.items||[],technicianIds:I.technicians||[],crewAssignments:Array.isArray(I.crewAssignments)?I.crewAssignments:[],discount:D,discountType:de,applyTax:N,start:I.start,end:I.end,companySharePercent:Ne,groupingSource:I}),Se=Number(ee?.finalTotal||0);ge=Number.isFinite(Se)?Number(Se.toFixed(2)):0}catch{ge=0}const pt=Number.parseFloat(E(String(I.cost??0)))||0,fe=ge>0?ge:pt,B=I.paymentHistory||I.payment_history||[],z=$t({totalAmount:fe,paidAmount:B.length?0:I.paidAmount,paidPercent:B.length?0:I.paidPercent,history:B});let Z=_t({manualStatus:null,paidAmount:z.paidAmount,paidPercent:z.paidPercent,totalAmount:fe});if(x)try{const{totalWithTax:ee}=ws(x)||{totalWithTax:0},Se=x.paymentHistory||x.payments||[],xe=$t({totalAmount:ee,paidAmount:Se.length?0:x.paidAmount,paidPercent:Se.length?0:x.paidPercent,history:Se}),kn=_t({manualStatus:null,paidAmount:xe.paidAmount,paidPercent:xe.paidPercent,totalAmount:ee});kn&&(Z=kn)}catch{}const ye=Z==="paid",se=Z==="partial",{effectiveConfirmed:ue,projectLinked:le}=Et(I,x),it=ue?"status-confirmed":"status-pending",ot=ye?"status-paid":se?"status-partial":"status-unpaid";let be=`<span class="reservation-chip status-chip ${it}">${ue?l:p}</span>`;const At=ye?m:se?h:f;let ct=`<span class="reservation-chip status-chip ${ot}">${At}</span>`,v=ye?" tile-paid":se?" tile-partial":" tile-unpaid";$&&(v+=" tile-completed");let L="";$&&(be=`<span class="reservation-chip status-chip status-completed">${g}</span>`,ct=`<span class="reservation-chip status-chip status-completed">${At}</span>`,L=` data-completed-label="${d("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`);let q="";le||(ue?$||(q=`<button class="tile-confirm" data-reservation-index="${k}" data-action="close">${P}</button>`):q=`<button class="tile-confirm" data-reservation-index="${k}" data-action="confirm">${b}</button>`);const F=q?`<div class="tile-actions">${q}</div>`:"",J=E(fe.toFixed(2)),Q=E(String(U)),oe=I.notes?E(I.notes):o,K=c.replace("{count}",Q),ae=I.applyTax?`<small>${s}</small>`:"";let Pe=S;return I.projectId&&(Pe=x?.title?E(x.title):j),`
      <div class="${q?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${v}"${L} data-reservation-index="${k}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${M}</div>
          <div class="tile-badges">
            ${be}
            ${ct}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${w.client}</span>
            <span class="tile-value">${A?.customerName||I.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.project}</span>
            <span class="tile-value">${Pe}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.start}</span>
            <span class="tile-value tile-inline">${_}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.end}</span>
            <span class="tile-value tile-inline">${ne}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.cost}</span>
            <span class="tile-value">${J} ${r} ${ae}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.equipment}</span>
            <span class="tile-value">${K}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.crew}</span>
            <span class="tile-value">${W.length?O:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${oe}</span>
          </div>
        </div>
        ${F}
      </div>
    `}).join("")}function ir({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a,onCloseReservation:r,onReopenReservation:s}={}){const i=bt(),{reservations:o=[],customers:c=[],technicians:u=[],projects:l=[]}=re(),p=o.map(w=>{const I=Qt(w);return{...I,id:w.id??I.id,reservationId:w.reservationId??w.reservation_id??I.reservationId,reservationCode:w.reservationCode??w.reservation_code??I.reservationCode}}),g=p,m=Array.isArray(i)?i:u||[],f=new Map((l||[]).map(w=>[String(w.id),w])),h=document.getElementById(e);if(!h){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!g||g.length===0){h.innerHTML=`<p>${d("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const b=n||Es(),P=new Map(c.map(w=>[String(w.id),w])),S=new Map(m.map(w=>[String(w.id),w])),j=sr({reservations:p,filters:b,customersMap:P,techniciansMap:S,projectsMap:f});if(j.length===0){h.innerHTML=`<p>${d("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}h.innerHTML=`<div class="reservations-grid">${rr({entries:j,customersMap:P,techniciansMap:S,projectsMap:f})}</div>`,h.querySelectorAll('[data-action="details"]').forEach(w=>{const I=Number(w.dataset.reservationIndex);Number.isNaN(I)||w.addEventListener("click",()=>{typeof t=="function"&&t(I)})}),h.querySelectorAll('button[data-action="confirm"]').forEach(w=>{const I=Number(w.dataset.reservationIndex);Number.isNaN(I)||w.addEventListener("click",k=>{k.stopPropagation(),typeof a=="function"&&a(I,k)})}),h.querySelectorAll('button[data-action="close"]').forEach(w=>{const I=Number(w.dataset.reservationIndex);Number.isNaN(I)||w.addEventListener("click",k=>{k.stopPropagation(),typeof r=="function"&&r(I,k)})})}function or(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=re(),o=r.map(b=>{const P=Qt(b);return{...P,id:b.id??P.id,reservationId:b.reservationId??b.reservation_id??P.reservationId,reservationCode:b.reservationCode??b.reservation_code??P.reservationCode}}),c=r[e];if(!c)return y(d("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;let u=o[e]??Qt(c);const l=s.find(b=>String(b.id)===String(c.customerId)),p=c.projectId?i.find(b=>String(b.id)===String(c.projectId)):null,g=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),f=(b,P=null)=>{if(g){const S=P??(bt()||[]);g.innerHTML=Ya(b,l,S,e,p)}},h=()=>{const b=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},P=document.getElementById("reservation-details-edit-btn");P&&(P.onclick=()=>{b(),typeof n=="function"&&n(e,{reservation:c,customer:l,getEditContext:a})});const S=document.getElementById("reservation-details-delete-btn");S&&(S.onclick=()=>{b(),typeof t=="function"&&t(e,{reservation:c,customer:l})});const j=g?.querySelector('[data-action="open-project"]');j&&p&&j.addEventListener("click",()=>{b();const k=p?.id!=null?String(p.id):"",A=k?`projects.html?project=${encodeURIComponent(k)}`:"projects.html";window.location.href=A});const w=document.getElementById("reservation-details-export-btn");w&&(w.onclick=async k=>{k?.preventDefault?.(),k?.stopPropagation?.(),w.blur();try{await Ss({reservation:c,customer:l,project:p})}catch(A){console.error("âŒ [reservations] export to PDF failed",A),y(d("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const I=document.getElementById("reservation-details-checklist-btn");I&&(I.onclick=async k=>{k?.preventDefault?.(),k?.stopPropagation?.(),I.blur();try{await ks({reservation:c,customer:l,project:p})}catch(A){console.error("âŒ [reservations] export checklist PDF failed",A),y(d("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const k=g?.querySelector("[data-tech-slider]");if(k){const A=k.querySelector("[data-slider-track]"),x=k.querySelector("[data-slider-prev]"),$=k.querySelector("[data-slider-next]");if(A&&(x||$)){const U=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",T=()=>{const O=A.querySelector(".reservation-technician-card"),M=O&&O.getBoundingClientRect().width||220,_=12,ne=Math.max(1,Math.floor(A.clientWidth/(M+_)));return Math.max(M+_,Math.floor(ne*(M+_)*.9))},C=()=>{const O=Math.max(0,A.scrollWidth-A.clientWidth-2),M=A.scrollLeft<=1,_=A.scrollLeft>=O;x&&(x.disabled=M),$&&($.disabled=_)},W=O=>{const M=T()*O,_=U?-M:M;A.scrollBy({left:_,behavior:"smooth"})};x?.addEventListener("click",()=>W(-1)),$?.addEventListener("click",()=>W(1)),A.addEventListener("scroll",C,{passive:!0}),window.addEventListener("resize",C,{passive:!0}),setTimeout(C,0)}}}catch{}};if(g&&(f(u),h(),aa().then(()=>{const b=bt()||[];f(u,b),h()}).catch(()=>{})),Kn(u)){const b=u.id||u.reservationId||u.reservation_code;Wn(b).then(P=>{P&&(u=P,f(u),h())}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function rt(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";if(!e||!n)return{start:null,end:null};const r=`${e}T${t}`,s=`${n}T${a}`;return{start:Ze(e,t)||r,end:Ze(n,a)||s}}function Dt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function En(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Lt(){const{container:e,select:n,hint:t,addButton:a}=En();if(!n)return;const r=n.value,s=Qn(),i=d("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${d("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,c=s.map(l=>{const p=Number.isFinite(Number(l.price))?Number(l.price):0,g=E(p.toFixed(2)),m=`${l.name} â€” ${g} ${i}`;return`<option value="${Dt(l.id)}">${Dt(m)}</option>`}).join("");n.innerHTML=`${o}${c}`;const u=s.length>0;n.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),t&&(u?(t.textContent=d("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=d("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),u&&r&&s.some(l=>l.id===r)?n.value=r:n.selectedIndex=0}function cr(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||y(d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=ve(),{start:s,end:i}=rt(),{reservations:o=[]}=re(),c=a!=null&&o[a]||null,u=c?.id??c?.reservationId??null,l=wa(t,{existingItems:r,start:s,end:i,ignoreReservationId:u});if(!l.success)return n||y(l.message||d("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),l;const p=[...r,l.package];return _e(a,p),$e(p),he(),n||y(d("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),l}function Tn(){const{select:e}=En();if(!e)return;const n=e.value||"";cr(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function dr(){const{addButton:e,select:n}=En();n&&!n.dataset.langRefreshAttached&&(document.addEventListener("language:changed",Lt),document.addEventListener("language:translationsReady",Lt),n.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Tn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Tn())}),n.dataset.listenerAttached="true"),Lt()}function $e(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=d("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=d("reservations.create.summary.currency","SR"),r=d("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=d("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=d("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=d("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${t}</td></tr>`,Dn(n);return}const{groups:c}=Mt({items:e});n.innerHTML=c.map(u=>{const l=u.items[0]||{},p=mt(l)||u.image,g=p?`<img src="${p}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',m=String(u?.type||"").toLowerCase()==="package"||u.items.some(_=>_?.type==="package"),f=E(String(u.count)),h=ze(u.unitPrice),b=Number.isFinite(h)?He(h):0,P=ze(u.unitCost),S=Number.isFinite(P)?He(P):0,j=(()=>{try{const{start:_,end:ne}=rt(),V=typeof Jt=="function"?Jt(_,ne):1;return Number.isFinite(V)&&V>0?V:1}catch{return 1}})(),w=ze(u.totalPrice),I=Number.isFinite(w)?w:b*(Number.isFinite(u.count)?u.count:1)*j,k=He(I),A=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${u.key}"
          min="0"
          step="0.01"
          value="${E(String(b))}"
          aria-label="${d("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,$=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${`edit-unit-cost-${u.key}`}"
          data-group-key="${u.key}"
          min="0"
          step="0.01"
          value="${E(String(S))}"
          aria-label="${d("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,U=`${E(k.toFixed(2))} ${a}`,T=u.barcodes.map(_=>E(String(_||""))).filter(Boolean),C=T.length?`<details class="reservation-item-barcodes">
            <summary>${d("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${T.map(_=>`<li>${_}</li>`).join("")}
            </ul>
          </details>`:"";let W="";if(m){const _=new Map,ne=R=>{const D=Number.parseFloat(E(String(R??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(D)||D<=0||D>99?1:Math.round(D)},V=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&V.push(...u.packageItems),u.items.forEach(R=>{Array.isArray(R?.packageItems)&&V.push(...R.packageItems)}),V.forEach(R=>{if(!R)return;const D=H(R.barcode||R.normalizedBarcode||R.desc||Math.random());if(!D)return;const X=_.get(D),de=ne(R.qtyPerPackage??R.perPackageQty??R.quantityPerPackage??R.qty??R.quantity??1),N=Math.max(1,Math.min(de,99));if(X){X.qty=N;return}_.set(D,{desc:R.desc||R.barcode||d("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:N,barcode:R.barcode??R.normalizedBarcode??""})}),_.size){const R=Array.from(_.values()).map(D=>{const X=E(String(D.qty>0?Math.min(D.qty,99):1)),de=Dt(D.desc||""),N=D.barcode?` <span class="reservation-package-items__barcode">(${Dt(E(String(D.barcode)))})</span>`:"";return`<li>${de}${N} Ã— ${X}</li>`}).join("");W=`
            <details class="reservation-package-items">
              <summary>${d("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${R}
              </ul>
            </details>
          `}}const O=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",M=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${g}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${m?`${W||""}${C||""}`:C}
              </div>
            </div>
          </td>
          <td>
            <div class="${O}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${i}"${M}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${s}"${M}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${E(String(j))}</span></td>
          <td>${A}</td>
          <td>${$}</td>
          <td>${U}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${o}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Dn(n)}function lr(e){switch(e){case"amount":return d("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return d("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return d("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Ot(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Ut();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(re()?.projects||[]).find(c=>String(c.id)===String(t)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(n=o)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${d("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Rn();return}const a=d("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const o=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${E(Number(s.amount).toFixed(2))} ${a}`:"â€”",c=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${E(Number(s.percentage).toFixed(2))}%`:"â€”",u=s?.recordedAt?E(Wt(s.recordedAt)):"â€”",l=lr(s?.type),p=s?.note?E(s.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${o}</td>
        <td>${c}</td>
        <td>${u}</td>
        <td>${p}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${d("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${d("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${d("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${d("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${d("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${d("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Rn()}function ur(){if(It()){y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=xa(e);let a=ja(n);if(!Number.isFinite(a)||a<=0){y(d("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=Yt.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,o=Number(r?.paidAmount)||0,c=d("reservations.create.summary.currency","SR");let u=null,l=null;if(t==="percent"){const g=Math.max(0,100-i);if(g<=1e-4){y(d("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const f=E(m.toFixed(2));y(d("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",f)),a=m}l=Number(a.toFixed(2)),s>0&&(u=a/100*s)}else{const g=Math.max(0,s-o);if(g<=1e-4){y(d("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const f=`${E(m.toFixed(2))} ${c}`;y(d("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",f)),a=m}u=Number(a.toFixed(2)),s>0&&(l=u/s*100)}u!=null&&(u=Number(u.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const p={type:t,value:a,amount:u,percentage:l,recordedAt:new Date().toISOString()};Br(p),Sn(Ut()),Ot(),he(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),y(d("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Rn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(It()){t.preventDefault(),y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ur()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(It()){t.preventDefault(),y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(Pr(r),Sn(Ut()),Ot(),he(),y(d("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function mr(e){const{index:n,items:t}=ve(),{groups:a}=Mt({items:t}),r=a.find(o=>o.key===e);if(!r||r.items.some(o=>o?.type==="package"))return;let s=-1;for(let o=t.length-1;o>=0;o-=1){const c=t[o];if(Ve(c)===e&&c?.type!=="package"){s=o;break}}if(s<0)return;const i=t.filter((o,c)=>c!==s);_e(n,i),$e(i),he()}function pr(e){const{index:n,items:t}=ve(),{groups:a}=Mt({items:t}),r=a.find(o=>o.key===e);if(!r)return;let s=t.filter(o=>Ve(o)!==e);if(r.items.some(o=>o&&o.type==="package")){const o=et(r.packageId??r.items.find(p=>p?.type==="package")?.packageId??""),c=H(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(p=>{if(!p||typeof p!="object"||p.type!=="package")return!0;const g=et(p.packageId??p.package_id??p.id??""),m=H(p.barcode??p.package_code??"");return!(o&&g===o||c&&m&&m===c)});const u=new Set,l=new Set;r.items.forEach(p=>{(Array.isArray(p?.packageItems)?p.packageItems:[]).forEach(m=>{const f=H(m?.barcode||m?.normalizedBarcode||"");f&&u.add(f);const h=m?.equipmentId??m?.equipment_id??null;h!=null&&l.add(String(h))})}),(u.size||l.size)&&(s=s.filter(p=>{const g=H(p?.barcode||""),m=p?.equipmentId??p?.id??null;return!(g&&u.has(g)||m!=null&&l.has(String(m)))}))}s.length!==t.length&&(_e(n,s),$e(s),he())}function fr(e){const{index:n,items:t}=ve(),{groups:a}=Mt({items:t}),r=a.find(b=>b.key===e);if(!r||r.items.some(b=>b?.type==="package"))return;const{start:s,end:i}=rt();if(!s||!i){y(d("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=re(),c=n!=null&&o[n]||null,u=c?.id??c?.reservationId??null,l=new Set(t.map(b=>H(b.barcode))),{equipment:p=[]}=re(),g=(p||[]).find(b=>{const P=H(b?.barcode);return!P||l.has(P)||Ve({desc:b?.desc||b?.description||b?.name||"",price:Number(b?.price)||0})!==e||!zn(b)?!1:!Te(P,s,i,u)});if(!g){y(d("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=H(g.barcode),f=st(g);if(!f){y(d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const h=[...t,{id:f,equipmentId:f,barcode:m,desc:g.desc||g.description||g.name||r.description||"",qty:1,price:Number.isFinite(Number(g.price))?Number(g.price):r.unitPrice,cost:Ye(g),image:mt(g)}];_e(n,h),$e(h),he()}function gr(e,n){const t=ze(n),a=Number.isFinite(t)&&t>=0?He(t):0,{index:r,items:s}=ve();if(!Array.isArray(s))return;const o=at(s).find(u=>u.key===e);if(!o||!Array.isArray(o.itemIndices))return;const c=[...s];o.itemIndices.forEach(u=>{if(c[u]){const l={...c[u],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};c[u]=l}}),_e(r,c),$e(c),he()}function yr(e,n){const t=ze(n),a=Number.isFinite(t)&&t>=0?He(t):0,{index:r,items:s}=ve();if(!Array.isArray(s))return;const o=at(s).find(u=>u.key===e);if(!o||!Array.isArray(o.itemIndices))return;const c=[...s];o.itemIndices.forEach(u=>{c[u]&&(c[u]={...c[u],price:a,unit_price:a})}),_e(r,c),$e(c),he()}function Dn(e){if(!e||e.dataset.groupListenerAttached)return;e.addEventListener("click",a=>{const r=a.target.closest("button[data-action]");if(!r)return;const{action:s,groupKey:i,itemIndex:o}=r.dataset;if(s==="decrease-edit-group"&&i){mr(i);return}if(s==="increase-edit-group"&&i){fr(i);return}if(s==="remove-edit-group"&&i){pr(i);return}if(s==="remove-edit-item"){const c=Number(o);Number.isNaN(c)||br(c)}});const n=a=>{const r=a.target.closest(".reservation-unit-cost-input");if(!r)return;const s=r.dataset.groupKey;s&&gr(s,r.value)},t=a=>{const r=a.target.closest(".reservation-unit-price-input");if(!r)return;const s=r.dataset.groupKey;s&&yr(s,r.value)};e.addEventListener("change",n),e.addEventListener("input",n),e.addEventListener("change",t),e.addEventListener("input",t),e.dataset.groupListenerAttached="true"}function It(){return!!document.getElementById("edit-res-project")?.value}function vr(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{It()&&(y(d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function hr(e){const n=d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),c=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,o,c].forEach(vr),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const u=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(u)try{const g=(re()?.projects||[]).find(f=>String(f.id)===String(u)),m=typeof g?.paymentStatus=="string"?g.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(l=m)}catch{}r.value=l,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=n),c&&(c.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),c&&(c.dataset.linkedDisabled="false")}function he(){const e=document.getElementById("edit-res-summary");if(!e)return;Ot();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),Ie(a),he()}),a.dataset.listenerAttached="true");const r=E(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",o=It();hr(o);const c=document.getElementById("edit-res-tax"),u=o?!1:c?.checked||!1,l=!o&&a?.dataset?.userSelected==="true";let p="unpaid";if(o){const j=document.getElementById("edit-res-project")?.value||"";if(j)try{const I=(re()?.projects||[]).find(A=>String(A.id)===String(j)),k=typeof I?.paymentStatus=="string"?I.paymentStatus.toLowerCase():null;k&&["paid","partial","unpaid"].includes(k)&&(p=k)}catch{}}else p=l&&a?.value||"unpaid";let g=null;!o&&u&&(Ce("edit-res-company-share"),g=nt("edit-res-company-share"),(!Number.isFinite(g)||g<=0)&&(Ce("edit-res-company-share"),g=nt("edit-res-company-share")));const{items:m=[],payments:f=[]}=ve(),{start:h,end:b}=rt(),P=Yt({items:m,discount:s,discountType:i,applyTax:u,paidStatus:p,start:h,end:b,companySharePercent:g,paymentHistory:f});e.innerHTML=P;const S=Yt.lastResult;if(S&&a){const j=S.paymentStatus;l?Ie(a,a.value):(a.value!==j&&(a.value=j),a.dataset&&delete a.dataset.userSelected,Ie(a,j))}else a&&Ie(a,a.value)}function br(e){if(e==null)return;const{index:n,items:t}=ve();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);_e(n,a),$e(a),he()}async function Ir(e){const n=e?.value??"",t=H(n)||E(String(n)).trim().toLowerCase();if(!t)return;const a=dn(t);if(!a){y(d("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Oe(a);if(r==="maintenance"||r==="retired"){y(tt(r));return}const s=H(t),{index:i,items:o=[]}=ve();if(o.findIndex(P=>H(P.barcode)===s)>-1){y(d("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:u,end:l}=rt();if(!u||!l){y(d("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:p=[]}=re(),g=i!=null&&p[i]||null,m=g?.id??g?.reservationId??null;if(Te(s,u,l,m)){y(d("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const f=st(a);if(!f){y(d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const h=typeof Ye=="function"?Ye(a):Number.isFinite(Number(a?.cost))?Number(a.cost):0,b=[...o,{id:f,equipmentId:f,barcode:s,desc:a.desc,qty:1,price:a.price,cost:h,image:a.image||a.imageUrl||a.img||null}];_e(i,b),e&&(e.value=""),$e(b),he()}async function Ft(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=Ia(n),a=H(t?.barcode||n)||E(String(t?.barcode||n)).trim().toLowerCase();if(!t||!a){y(d("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Oe(t);if(r==="maintenance"||r==="retired"){y(tt(r));return}const{start:s,end:i}=rt();if(!s||!i){y(d("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:c=[]}=ve();if(c.some(b=>H(b.barcode)===a)){y(d("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:l=[]}=re(),p=o!=null&&l[o]||null,g=p?.id??p?.reservationId??null;if(Te(a,s,i,g)){y(d("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const m=st(t);if(!m){y(d("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const f=typeof Ye=="function"?Ye(t):Number.isFinite(Number(t?.cost))?Number(t.cost):0,h=[...c,{id:m,equipmentId:m,barcode:a,desc:t.desc,qty:1,price:t.price,cost:f,image:t.image||t.imageUrl||t.img||null}];_e(o,h),$e(h),he(),e.value=""}function _a(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Ft(e))});const n=()=>{Ea(e.value,"edit-res-equipment-description-options")&&Ft(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{he()});const e=()=>{dr()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Lt()})}typeof window<"u"&&(window.getEditReservationDateRange=rt,window.renderEditPaymentHistory=Ot);function Er(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){an(e);return}Ft(e)}}function Jr(){Ke(),_a()}function Sr(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let lt=null,ke=[],qe=[],rn=null,ce={},Kt=!1,Fn=!1;function kr(){if(!Fn)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{Da(ce).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Fn=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const wr="__DEBUG_CREW__";function Ar(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(wr);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Mn(e,n){if(Ar())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function vt(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=d("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),o=d("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=s?i:o,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function gt(){return document.getElementById("edit-res-confirmed")?.value==="true"}function ve(){return{index:lt,items:ke,payments:qe}}function _e(e,n,t=qe){lt=typeof e=="number"?e:null,ke=Array.isArray(n)?[...n]:[],qe=Array.isArray(t)?[...t]:[]}function Na(){lt=null,ke=[],os(),qe=[]}function Ut(){return[...qe]}function Sn(e){qe=Array.isArray(e)?[...e]:[]}function Br(e){e&&(qe=[...qe,e])}function Pr(e){!Number.isInteger(e)||e<0||(qe=qe.filter((n,t)=>t!==e))}function Ct(e,n=1){const t=Number.parseFloat(E(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function ht(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(E(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function Lr(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?H(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:Ct(e.qty??e.quantity??e.count??1),price:ht(e.price??e.unit_price??e.unitPrice??0),cost:ht(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.purchase_price??0),image:e.image??e.image_url??e.imageUrl??null}}function Cr(e,n=0){if(!e||typeof e!="object")return null;const t=et(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:pn(e)).map(m=>Lr(m)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=ht(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const m=ht(i,0);m>0&&a>0&&(o=Number((m/a).toFixed(2)))}let c=ht(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??null,0);(!c||c===0)&&s.length&&(c=0);const u=e.package_code??e.packageCode??e.barcode??null,p=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,u,t].find(m=>m!=null&&String(m).trim()!=="")||`Package ${t}`,g=e.image??e.cover??e.thumbnail??s.find(m=>m?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:E(String(p)),name:E(String(p)),qty:a,price:o,cost:c,unit_cost:c,rental_cost:c,purchase_price:c,internal_cost:c,equipment_cost:c,barcode:u,packageItems:s,image:g}}function qr(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function $r(e={},n=[]){const t=Array.isArray(n)?n.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return t;const r=a.map((o,c)=>Cr(o,c)).filter(Boolean);if(!r.length)return t;const s=new Map;r.forEach(o=>{const c=Ct(o.qty??o.quantity??1);if(o.barcode){const u=H(o.barcode);if(u){const l=`package::${u}`;s.set(l,(s.get(l)??0)+c)}}(o.packageItems||[]).forEach(u=>{if(!u)return;const l=c*Ct(u.qty??u.quantity??1),p=u.equipmentId??null,g=u.normalizedBarcode||(u.barcode?H(u.barcode):null);if(p!=null){const m=`equipment::${String(p)}`;s.set(m,(s.get(m)??0)+l)}if(g){const m=`barcode::${g}`;s.set(m,(s.get(m)??0)+l)}})});const i=[];return t.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const b=et(o.packageId??o.package_id??o.id??"");r.some(S=>S.packageId===b)||i.push({...o});return}const c=Ct(o.qty??o.quantity??1),u=st(o),l=o.barcode?H(o.barcode):null,p=[];u!=null&&p.push(`equipment::${String(u)}`),l&&p.push(`barcode::${l}`);const g=p.map(b=>s.get(b)??0).filter(b=>b>0);if(!g.length){i.push({...o});return}const m=Math.min(...g);if(m<=0){i.push({...o});return}const f=Math.min(m,c);if(qr(s,p,f),f>=c)return;const h=c-f;i.push({...o,qty:h,quantity:h})}),[...i,...r.map(o=>({...o}))]}function _r(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function xa(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function ja(e){if(!e)return null;const n=E(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function Nr(e,n){if(e){e.value="";return}}function ft(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ta(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(E(String(e.value??""))),a=Number.parseFloat(E(String(e.amount??""))),r=Number.parseFloat(E(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,o=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),c=o==="amount"?s??null:o==="percent"?i??null:Number.isFinite(t)?t:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:c,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:u}}function xr(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=d("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=d("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((c,u)=>String(u.createdAt||u.start||"").localeCompare(String(c.createdAt||c.start||""))):[],o=[`<option value="">${ft(a)}</option>`];i.forEach(c=>{o.push(`<option value="${ft(c.id)}">${ft(c.title||a)}</option>`)}),s&&!i.some(c=>String(c.id)===s)&&o.push(`<option value="${ft(s)}">${ft(r)}</option>`),t.innerHTML=o.join(""),s?t.value=s:t.value=""}function Ra(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=d("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const c=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",c&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}on("tax");const o=ce?.updateEditReservationSummary;typeof o=="function"&&o()}function on(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=ce?.updateEditReservationSummary;typeof s=="function"&&s()};if(Kt){a();return}Kt=!0;const r=()=>{Kt=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Xe)),n.disabled){t.checked=!1,y(d("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),Ce("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Ce("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function Vn(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:o,projects:c}=re();let l=Jn()?.[e];if(!l){y(d("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}if(Kn(l))try{const N=await Wn(l.id||l.reservationId||l.reservation_code);N&&(l=N)}catch(N){console.warn("[reservationsEdit] Failed to hydrate reservation packages",N)}ce={...ce,reservation:l,projects:c||[]},n?.(),xr(c||[],l);const p=l.projectId&&c?.find?.(N=>String(N.id)===String(l.projectId))||null,{effectiveConfirmed:g,projectLinked:m}=Et(l,p),f=l.items?l.items.map(N=>({...N,equipmentId:N.equipmentId??N.equipment_id??N.id,barcode:H(N?.barcode)})):[],h=$r(l,f),P=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map(N=>Ta(N)).filter(Boolean);_e(e,h,P);const S=d("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),j=o?.find?.(N=>String(N.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const w=document.getElementById("edit-res-id");w&&(w.value=l.reservationId||l.id);const I=document.getElementById("edit-res-customer");I&&(I.value=j?.customerName||S);const k=typeof a=="function"?a(l.start):{date:"",time:""},A=typeof a=="function"?a(l.end):{date:"",time:""};t?.("edit-res-start",k.date),t?.("edit-res-start-time",k.time),t?.("edit-res-end",A.date),t?.("edit-res-end-time",A.time);const x=document.getElementById("edit-res-notes");x&&(x.value=l.notes||"");const $=document.getElementById("edit-res-discount");if($){const N=m?0:l.discount??0;$.value=E(N)}const U=document.getElementById("edit-res-discount-type");U&&(U.value=m?"percent":l.discountType||"percent");const T=l.projectId?!1:!!l.applyTax,C=document.getElementById("edit-res-tax");C&&(C.checked=T);const W=document.getElementById("edit-res-company-share");if(W){const N=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,pe=N!=null?Number.parseFloat(E(String(N).replace("%","").trim())):NaN,Be=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,Y=Be!=null?Be===!0||Be===1||Be==="1"||String(Be).toLowerCase()==="true":Number.isFinite(pe)&&pe>0,Je=Y&&Number.isFinite(pe)&&pe>0?pe:Xe,Ne=T||Y;W.checked=Ne,W.dataset.companyShare=String(Je)}vt(g,{disable:m});const O=document.getElementById("edit-res-close-btn"),M=document.getElementById("edit-res-reopen-btn");O&&(O.disabled=!(g&&!m)||String(l.status||"").toLowerCase()==="completed"),M&&(M.disabled=String(l.status||"").toLowerCase()!=="completed");const _=document.getElementById("edit-res-paid"),ne=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");_&&(_.value=ne,_.dataset&&delete _.dataset.userSelected);const V=document.getElementById("edit-res-payment-progress-type"),R=document.getElementById("edit-res-payment-progress-value");V?.dataset?.userSelected&&delete V.dataset.userSelected,V&&(V.value="percent"),Nr(R);const D=document.getElementById("edit-res-cancelled");if(D){const N=String(l?.status||l?.reservationStatus||"").toLowerCase();D.checked=["cancelled","canceled"].includes(N),D.checked&&vt(g,{disable:!0})}let X=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map(N=>String(N));if(!Array.isArray(X)||X.length===0){const N=ns(l.id??l.reservationId??l.reservation_code??null);Array.isArray(N)&&N.length&&(X=N)}try{await aa()}catch(N){console.warn("[reservationsEdit] positions load failed (non-fatal)",N)}if(as(X),r?.(h),typeof window<"u"){const N=window?.renderEditPaymentHistory;typeof N=="function"&&N()}Ra(),s?.();const de=document.getElementById("editReservationModal");rn=_r(de,i),rn?.show?.();try{jr?.(ce)}catch(N){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",N)}kr()}async function Da({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(lt===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const c=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",g=document.getElementById("edit-res-notes")?.value||"",m=E(document.getElementById("edit-res-discount")?.value||"0");let f=parseFloat(m)||0,h=document.getElementById("edit-res-discount-type")?.value||"percent";const b=gt(),P=document.getElementById("edit-res-paid"),S=P?.dataset?.userSelected==="true",j=S&&P?.value||"unpaid",w=document.getElementById("edit-res-payment-progress-type"),I=document.getElementById("edit-res-payment-progress-value"),k=xa(w),A=ja(I),x=document.getElementById("edit-res-project")?.value||"",U=document.getElementById("edit-res-cancelled")?.checked===!0,T=ss();T.map(v=>v?.technicianId).filter(Boolean);const C=document.getElementById("edit-res-company-share"),W=document.getElementById("edit-res-tax");if(!c||!l){y(d("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const O=typeof e=="function"?e:(v,L)=>`${v}T${L||"00:00"}`,M=O(c,u),_=O(l,p);if(M&&_&&new Date(M)>new Date(_)){y(d("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const V=Jn()?.[lt];if(!V){y(d("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(ke)||ke.length===0&&T.length===0){y(d("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const R=typeof n=="function"?n:()=>!1,D=V.id??V.reservationId;for(const v of ke){if(v?.type==="package"&&Array.isArray(v.packageItems)){for(const q of v.packageItems){const F=q?.barcode??q?.normalizedBarcode??"";if(!F)continue;const J=Oe(F);if(J!=="reserved"&&J!=="available"){y(tt(J));return}}continue}const L=Oe(v.barcode);if(L!=="reserved"&&L!=="available"){y(tt(L));return}}{const v=typeof t=="function"?t:()=>!1;for(const L of ke){if(L?.type!=="package")continue;const q=L.packageId??L.package_id??null,F=L.desc||L.packageName||d("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(q&&v(q,M,_,D)){const J=Array.isArray(L?.packageItems)?L.packageItems.map(K=>H(K?.barcode??K?.normalizedBarcode??"")).filter(Boolean):[];let Q=Bn(J,M,_,D);if(!Q.length)try{const K=new URLSearchParams;K.set("type","package"),K.set("id",String(q)),K.set("start",M),K.set("end",_),D!=null&&K.set("ignore",String(D));const ae=await De(`/reservations/availability.php?${K.toString()}`),Pe=Array.isArray(ae?.conflicts)?ae.conflicts:[];Q=Array.from(new Set(Pe.map(te=>te?.reservation_code||(te?.reservation_id!=null?`#${te.reservation_id}`:null)).filter(Boolean)))}catch{}const oe=Q.length?` (${Q.join("ØŒ ")})`:"";y(d("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(F))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+oe,"warning",-1);return}if(Array.isArray(L?.packageItems)&&L.packageItems.length){const J=(L.packageItems||[]).map(K=>H(K?.barcode??K?.normalizedBarcode??"")).filter(Boolean),Q=J.length,oe=J.filter(K=>R(K,M,_,D)).length;if(Q>0&&oe>=Q){const K=(L.packageItems||[]).map(te=>H(te?.barcode??te?.normalizedBarcode??"")).filter(Boolean);let ae=Bn(K,M,_,D);if(!ae.length)try{const te=new URLSearchParams;te.set("type","package"),q!=null&&te.set("id",String(q)),te.set("start",M),te.set("end",_),D!=null&&te.set("ignore",String(D));const ee=await De(`/reservations/availability.php?${te.toString()}`),Se=Array.isArray(ee?.conflicts)?ee.conflicts:[];ae=Array.from(new Set(Se.map(xe=>xe?.reservation_code||(xe?.reservation_id!=null?`#${xe.reservation_id}`:null)).filter(Boolean)))}catch{}const Pe=ae.length?` (${ae.join("ØŒ ")})`:"";y(d("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(F))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+Pe,"warning",6e3);return}}}}const X=[];for(const v of ke){if(v?.type==="package"&&Array.isArray(v.packageItems)){for(const q of v.packageItems){const F=H(q?.barcode??q?.normalizedBarcode??"");if(F&&R(F,M,_,D)){const J=q?.desc||q?.barcode||d("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");X.push({label:E(String(J)),barcode:F})}}continue}const L=H(v.barcode);if(R(L,M,_,D)){const q=v?.desc||v?.name||v?.barcode||d("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");X.push({label:E(String(q)),barcode:L})}}if(X.length){const v=d("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let L=null;try{const F=Array.from(new Set(X.map(Q=>Q.barcode).filter(Boolean))),J=new Map;await Promise.all(F.map(async Q=>{const oe=new URLSearchParams;oe.set("type","equipment"),oe.set("id",Q),oe.set("start",M),oe.set("end",_),D!=null&&oe.set("ignore",String(D));const K=await De(`/reservations/availability.php?${oe.toString()}`),ae=Array.isArray(K?.conflicts)?K.conflicts:[],Pe=Array.from(new Set(ae.map(te=>te?.reservation_code||(te?.reservation_id!=null?`#${te.reservation_id}`:null)).filter(Boolean)));J.set(Q,Pe)})),L=X.map(({label:Q,barcode:oe})=>{const K=J.get(oe)||[];return K.length?`${Q} (${K.join("ØŒ ")})`:Q}).join("ØŒ ")}catch{}const q=L||X.map(F=>F.label).filter(Boolean).map(String).join("ØŒ ");y(`${v}: ${q}`,"warning",6e3);return}const de=typeof t=="function"?t:()=>!1;for(const v of ke){if(v?.type!=="package")continue;const L=v.packageId??v.package_id??null;if(L&&de(L,M,_,D)){const q=v.desc||v.packageName||d("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const F=new URLSearchParams;F.set("type","package"),F.set("id",String(L)),F.set("start",M),F.set("end",_),D!=null&&F.set("ignore",String(D));const J=await De(`/reservations/availability.php?${F.toString()}`),Q=Array.isArray(J?.conflicts)?J.conflicts:[],oe=Array.from(new Set(Q.map(ae=>ae?.reservation_code||(ae?.reservation_id!=null?`#${ae.reservation_id}`:null)).filter(Boolean))),K=oe.length?` (${oe.join("ØŒ ")})`:"";y(d("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(q))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+K,"warning",6e3)}catch{y(d("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(q))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const N=typeof a=="function"?a:()=>!1,pe=[];for(const v of T){if(!v?.technicianId||!N(v.technicianId,M,_,D))continue;const L=v?.technicianName||v?.positionLabel||String(v.technicianId);let q=[];try{q=ea(v.technicianId,M,_,D)}catch{}pe.push({label:E(String(L)),codes:q})}if(pe.length){const v=d("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),L=pe.map(({label:q,codes:F})=>F&&F.length?`${q} (${F.join("ØŒ ")})`:q).join("ØŒ ");y(`${v}: ${L}`,"warning",6e3);return}const Be=Array.isArray(ce.projects)&&ce.projects.length?ce.projects:re().projects||[],Y=x&&Be.find(v=>String(v.id)===String(x))||null,Je={...V,projectId:x?String(x):null,confirmed:b},{effectiveConfirmed:Ne,projectLinked:ge,projectStatus:pt}=Et(Je,Y);let fe=!!C?.checked,B=!!W?.checked;if(ge&&(fe&&(C.checked=!1,fe=!1),B=!1),!ge&&fe!==B){y(d("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}B&&(Ce("edit-res-company-share"),fe=!!C?.checked);let z=fe?getCompanySharePercent("edit-res-company-share"):null;fe&&(!Number.isFinite(z)||z<=0)&&(Ce("edit-res-company-share"),z=getCompanySharePercent("edit-res-company-share"));const ie=fe&&B&&Number.isFinite(z)&&z>0,Z=ge?!1:B;ge&&(f=0,h="percent");const ye=Hn(ke,f,h,Z,T,{start:M,end:_,companySharePercent:ie?z:0});let se=Ut();if(Number.isFinite(A)&&A>0){const v=ye;let L=null,q=null;k==="amount"?(L=A,v>0&&(q=A/v*100)):(q=A,v>0&&(L=A/100*v));const F=Ta({type:k,value:A,amount:L,percentage:q,recordedAt:new Date().toISOString()});F&&(se=[...se,F],Sn(se)),I&&(I.value="")}const ue=$t({totalAmount:ye,history:se}),le=new Map;document.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(v=>{const L=v.dataset.groupKey;if(!L)return;const q=ze(v.value),F=Number.isFinite(q)&&q>=0?He(q):null;F!==null&&le.set(L,F)}),ke.forEach(v=>{if(String(v?.type||"").toLowerCase()!=="package")return;const L=Ve(v);if(!L||le.has(L))return;const F=Array.from(document.querySelectorAll(".reservation-unit-cost-input[data-group-key]")).find(J=>(J.dataset.groupKey||"")===L);if(F){const J=ze(F.value),Q=Number.isFinite(J)&&J>=0?He(J):null;Q!==null&&le.set(L,Q)}});const it=ke.map(v=>{const L=Ve(v);if(!L)return v;const q=le.get(L);return q===void 0?v:{...v,cost:q,unit_cost:q,rental_cost:q,purchase_price:q,internal_cost:q,equipment_cost:q}}),ot=_t({manualStatus:j,paidAmount:ue.paidAmount,paidPercent:ue.paidPercent,totalAmount:ye});P&&!S&&(P.value=ot,P.dataset&&delete P.dataset.userSelected);let be=V.status??"pending";ge?be=Y?.status??pt??be:U?be="cancelled":["completed","cancelled"].includes(String(be).toLowerCase())||(be=b?"confirmed":"pending");const At=it.filter(v=>String(v?.type||"").toLowerCase()==="package").map(v=>{const L=Number.isFinite(Number(v.qty??v.quantity))?Number(v.qty??v.quantity):1,q=Number.isFinite(Number(v.unit_price??v.price))?Number(v.unit_price??v.price):0;let F=Number.isFinite(Number(v.unit_cost??v.cost))?Number(v.unit_cost??v.cost):0;const J=Ve(v);if(F===0&&J){const Q=le.get(J);if(Q!==void 0&&Number.isFinite(Q))F=Q;else{const K=Array.from(document.querySelectorAll(".reservation-unit-cost-input")).find(ae=>{const Pe=(ae.closest("tr")?.textContent||"").toLowerCase(),te=(v.package_code||"").toLowerCase(),ee=(v.name||v.desc||v.package_name||"").toLowerCase();return te&&Pe.includes(te)||ee&&Pe.includes(ee)});if(K){const ae=ze(K.value);Number.isFinite(ae)&&ae>=0&&(F=He(ae))}}}return{package_code:v.package_code??v.packageCode??v.barcode??v.code??null,name:v.name??v.desc??v.package_name??null,quantity:L,unit_price:q,unit_cost:F,cost:F,items:Array.isArray(v.packageItems)?v.packageItems:[]}}),ct=On({reservationCode:V.reservationCode??V.reservationId??null,customerId:V.customerId,start:M,end:_,status:be,title:V.title??null,location:V.location??null,notes:g,projectId:x?String(x):null,totalAmount:ye,discount:f,discountType:h,applyTax:Z,paidStatus:ot,confirmed:Ne,items:it.map(v=>({...v,equipmentId:v.equipmentId??v.id})),crewAssignments:T,companySharePercent:ie?z:null,companyShareEnabled:ie,paidAmount:ue.paidAmount,paidPercentage:ue.paidPercent,paymentProgressType:ue.paymentProgressType,paymentProgressValue:ue.paymentProgressValue,paymentHistory:se,packages:At});try{Mn("about to submit",{editingIndex:lt,crewAssignments:T,techniciansPayload:ct?.technicians,payload:ct});const v=await rs(V.id||V.reservationId,ct);Mn("server response",{reservation:v?.id??v?.reservationId??v?.reservation_code,technicians:v?.technicians,crewAssignments:v?.crewAssignments,techniciansDetails:v?.techniciansDetails}),await is(),fn(),bt(),bs(),y(d("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),Na(),o?.({type:"updated",reservation:v}),s?.(),i?.(),rn?.hide?.()}catch(v){console.error("âŒ [reservationsEdit] Failed to update reservation",v);const L=Un(v)?v.message:d("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");y(L,"error")}}function jr(e={}){ce={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=ce,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=E(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{on("tax")}),o.dataset.listenerAttached="true");const c=document.getElementById("edit-res-company-share");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{on("share")}),c.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",n?.()}),u.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=E(l.value)}),l.dataset.listenerAttached="true");const p=["edit-res-start","edit-res-end"],g=["edit-res-start-time","edit-res-end-time"],m=k=>{const A=document.getElementById(k);if(!A||A.dataset.editDateListenerAttached==="true")return;const x=()=>{try{n?.()}catch{}try{const $=typeof ve=="function"?ve().items:[];r?.($)}catch{}};A.addEventListener("input",x),A.addEventListener("change",x),A.dataset.editDateListenerAttached="true"};p.forEach(m),g.forEach(m),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const f=document.getElementById("edit-res-project");f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>{Ra();const k=Array.isArray(ce.projects)&&ce.projects.length?ce.projects:re().projects||[],A=f.value&&k.find(C=>String(C.id)===String(f.value))||null,$={...ce?.reservation??{},projectId:f.value||null,confirmed:gt()},{effectiveConfirmed:U,projectLinked:T}=Et($,A);vt(U,{disable:T}),n?.()}),f.dataset.listenerAttached="true");const h=document.getElementById("edit-res-confirmed-btn");h&&!h.dataset.listenerAttached&&(h.addEventListener("click",()=>{if(h.disabled)return;const k=!gt();vt(k);const A=document.getElementById("edit-res-close-btn");A&&(A.disabled=!k),n?.()}),h.dataset.listenerAttached="true");const b=document.getElementById("edit-res-cancelled");b&&!b.dataset.listenerAttached&&(b.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&vt(gt(),{disable:b.checked});const A=document.getElementById("edit-res-close-btn");A&&(A.disabled=b.checked||!gt()),n?.()}),b.dataset.listenerAttached="true");const P=document.getElementById("save-reservation-changes");P&&!P.dataset.listenerAttached&&(P.addEventListener("click",()=>{Da(ce).catch(k=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",k)})}),P.dataset.listenerAttached="true");const S=document.getElementById("edit-res-close-btn");S&&!S.dataset.listenerAttached&&(S.addEventListener("click",()=>{try{const{index:k}=ve(),A=document.getElementById("closeReservationModal"),x=document.getElementById("close-reservation-notes"),$=document.getElementById("close-reservation-submit"),U=document.getElementById("edit-res-notes")?.value||"";if(x&&(x.value=U),$&&$.__tmpCloseListener&&($.removeEventListener("click",$.__tmpCloseListener),$.__tmpCloseListener=null),$){const T=async()=>{const C=x?.value||"";try{await ra(k,C,{onAfterChange:ce?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(A)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(A))?.hide?.()}catch{}}};$.__tmpCloseListener=T,$.addEventListener("click",T,{once:!0})}A&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(A).show()}catch(k){console.warn("[reservationsEdit] failed to open close modal",k)}}),S.dataset.listenerAttached="true");const j=document.getElementById("edit-res-reopen-btn");j&&!j.dataset.listenerAttached&&(j.addEventListener("click",async()=>{try{const{index:k}=ve();await ia(k,{onAfterChange:ce?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{j.disabled=!0}catch{}}catch(k){console.warn("[reservationsEdit] failed to reopen reservation",k)}}),j.dataset.listenerAttached="true");const w=document.getElementById("edit-res-equipment-barcode");if(w&&!w.dataset.listenerAttached){let k=null;const A=()=>{w.value?.trim()&&(clearTimeout(k),k=null,t?.(w))};w.addEventListener("keydown",$=>{$.key==="Enter"&&($.preventDefault(),A())});const x=()=>{if(clearTimeout(k),!w.value?.trim())return;const{start:$,end:U}=getEditReservationDateRange();!$||!U||(k=setTimeout(()=>{A()},150))};w.addEventListener("input",x),w.addEventListener("change",A),w.dataset.listenerAttached="true"}_a?.();const I=document.getElementById("editReservationModal");I&&!I.dataset.cleanupAttached&&(I.addEventListener("hidden.bs.modal",()=>{Na(),n?.(),r?.([])}),I.dataset.cleanupAttached="true")}function Qr(){return Ps().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=re()||{};cs(e||[]),$a()})}function wt(e=null){$a(),Fa(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function Tr(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function cn(){return{populateEquipmentDescriptionLists:Ke,setFlatpickrValue:Sr,splitDateTime:ta,renderEditItems:$e,updateEditReservationSummary:he,addEquipmentByDescription:Er,addEquipmentToEditingReservation:Ir,addEquipmentToEditingByDescription:Ft,combineDateTime:Ze,hasEquipmentConflict:Te,hasTechnicianConflict:Zn,renderReservations:Fa,handleReservationsMutation:wt,ensureModal:Tr}}function Fa(e="reservations-list",n=null){ir({containerId:e,filters:n,onShowDetails:Ma,onConfirmReservation:za,onCloseReservation:Rr,onReopenReservation:Ha})}function Ma(e){return or(e,{getEditContext:cn,onEdit:(n,{reservation:t})=>{Ua(n,t)},onDelete:Va})}function Va(e){return Ka()?window.confirm(d("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?As(e,{onAfterChange:wt}):!1:(Wa(),!1)}function za(e){return Bs(e,{onAfterChange:wt})}function Ha(e){return ia(e,{onAfterChange:wt})}let qt=null;function Oa(){const e=document.getElementById("closeReservationModal"),n=document.getElementById("close-reservation-notes"),t=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:n,submit:t,cancel:a}}function Rr(e){qt=e;const{modal:n,note:t}=Oa();t&&(t.value=""),n&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(n).show()}function Dr(){const{modal:e,note:n,submit:t,cancel:a}=Oa();e&&(t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async()=>{const r=n?.value||"";try{await ra(qt,r,{onAfterChange:wt})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}qt=null}}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{qt=null}),a.dataset.listenerAttached="true"))}function Ua(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}Vn(e,cn());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}Vn(e,cn());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}Ja({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function Yr(){Is({showReservationDetails:Ma,deleteReservation:Va,confirmReservation:za,openReservationEditor:Ua,reopenReservation:Ha});try{Dr()}catch{}}export{Jr as a,Fa as b,$a as c,G as d,Ma as e,Va as f,cn as g,wt as h,Wr as i,za as j,Sr as k,Qr as l,Ua as o,Yr as r,jr as s,he as u};
