import{r as Dt,n as y,t as p,g as Se,l as Q,y as Xe,j as Lt,u as Ze,s as x,c as Rt,o as et}from"./auth.D26aJb88.js";import{o as Fe,O as xe,M as De,t as Me,v as Bt,D as Ft,A as tt,p as st,i as Mt,u as Vt,E as Ht}from"./controller.97wW5gmN.js";import{n as ae,g as $,a as Ut,b as Ot,r as rt,z as zt,l as nt,u as ge,D as Y,o as Wt,q as Kt}from"./reservationsService.BnprjwAK.js";Dt({ar:{"projects.nav.brand":"نظام التأجير","projects.nav.projects":"المشاريع","projects.nav.customers":"العملاء","projects.nav.technicians":"طاقم العمل","projects.hero.title":"إدارة المشاريع","projects.hero.subtitle":"أنشئ ونسّق المشاريع، ووزّع المهام على الطاقم والمعدات، وتتبع المصاريف.","projects.form.title":"إنشاء مشروع جديد","projects.form.labels.type":"نوع المشروع","projects.form.labels.title":"اسم المشروع","projects.form.labels.client":"العميل","projects.form.labels.clientCompany":"شركة العميل","projects.form.labels.paymentStatus":"حالة الدفع","projects.form.labels.startDate":"📅 تاريخ البداية","projects.form.labels.startTime":"⏰ وقت البداية","projects.form.labels.endDate":"📅 تاريخ النهاية","projects.form.labels.endTime":"⏰ وقت النهاية","projects.form.labels.description":"تفاصيل المشروع","projects.form.labels.technician":"إضافة عضو طاقم","projects.form.labels.equipment":"إضافة معدة","projects.form.labels.quantity":"الكمية","projects.form.labels.expenses":"الخدمات الإنتاجية","projects.form.labels.expenseLabel":"خدمات إنتاجية","projects.form.labels.expenseAmount":"التكلفة (SR)","projects.form.labels.servicesClientTotal":"إجمالي سعر البيع","projects.form.labels.salePrice":"سعر البيع","projects.expenses.table.headers.service":"الخدمة","projects.expenses.table.headers.cost":"التكلفة (SR)","projects.expenses.table.headers.sale":"سعر البيع (SR)","projects.expenses.table.headers.actions":"الإجراءات","projects.form.placeholders.title":"مثال: تصوير منتج جديد","projects.form.placeholders.description":"ملخص عن المشروع والمتطلبات","projects.form.placeholders.type":"اختر نوع المشروع","projects.form.placeholders.clientCompany":"تعبأ تلقائيًا","projects.form.placeholders.startDate":"اختر تاريخ البداية","projects.form.placeholders.startTime":"اختر وقت البداية","projects.form.placeholders.endDate":"اختر تاريخ النهاية","projects.form.placeholders.endTime":"اختر وقت النهاية","projects.form.placeholders.client":"اكتب اسم العميل...","projects.form.placeholders.expenseLabel":"مثال: متطلب إضافي (رسوم موقع، معدات إضافية...)","projects.form.linkedReservation.title":"إنشاء حجز مرتبط","projects.form.linkedReservation.description":"أنشئ حجزًا مرتبطًا بالمشروع الحالي وسيتم تعبئة تفاصيله تلقائيًا.","projects.form.linkedReservation.button":"➕ إنشاء حجز مرتبط","projects.form.linkedReservation.missingClient":"⚠️ يرجى اختيار العميل قبل إنشاء الحجز المرتبط","projects.form.linkedReservation.missingSchedule":"⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إنشاء الحجز المرتبط","projects.form.linkedReservation.empty":"لم يتم إنشاء حجوزات مرتبطة بعد.","projects.form.linkedReservation.pendingItem":"سيتم ربط هذا الحجز تلقائيًا بعد حفظ المشروع.","projects.form.linkedReservation.buttonDisabled":"تم إنشاء حجز مرتبط لهذا المشروع. يمكنك متابعة التعديلات من شاشة الحجز.","projects.form.linkedReservation.meta.equipment":"عدد المعدات: {count}","projects.form.linkedReservation.meta.crew":"عدد الفريق: {count}","projects.form.linkedReservation.meta.crewNames":"أسماء الفريق: {names}","projects.form.linkedReservation.meta.total":"إجمالي الحجز: {amount}","projects.form.labels.discount":"الخصم","projects.form.labels.companyShare":"نسبة الشركة والضريبة","projects.form.labels.applyTax":"تطبيق الضريبة 15٪","projects.form.discount.percent":"٪ نسبة","projects.form.discount.amount":"💵 مبلغ","projects.form.companyShareToggle":"إضافة نسبة الشركة (10٪)","projects.form.selectClient":"اختر العميل","projects.form.selectTechnician":"اختر عضو الطاقم","projects.form.selectEquipment":"اختر المعدة","projects.form.types.commercial":"تصوير إعلان","projects.form.types.coverage":"تصوير تغطية","projects.form.types.photography":"تصوير فوتوغرافي","projects.form.types.social":"تصوير للتواصل الاجتماعي","projects.form.types.unknown":"نوع غير محدد","projects.form.buttons.addTechnician":"➕ إضافة للطاقم","projects.form.buttons.addEquipment":"➕ إضافة للمشروع","projects.form.buttons.addExpense":"➕ إضافة خدمة","projects.form.buttons.save":"🆕 إنشاء المشروع","projects.form.buttons.update":"🔁 تحديث المشروع","projects.form.taxLabel":"شامل الضريبة (15٪)","projects.form.paymentStatus.paid":"مدفوع","projects.form.paymentStatus.unpaid":"غير مدفوع","projects.form.paymentStatus.partial":"مدفوع جزئياً","projects.form.paymentProgress.label":"💰 الدفعة المستلمة","projects.form.paymentProgress.amount":"💵 مبلغ","projects.form.paymentProgress.percent":"٪ نسبة","projects.form.paymentProgress.placeholder":"0","projects.form.paymentProgress.hint":"أدخل المبلغ أو النسبة التي تم استلامها من قيمة المشروع","projects.paymentStatus.paid":"مدفوع","projects.paymentStatus.unpaid":"غير مدفوع","projects.paymentStatus.partial":"مدفوع جزئياً","projects.selected.emptyTechnicians":"لم يتم اختيار أي عضو بعد","projects.selected.emptyEquipment":"لم يتم اختيار أي معدات","projects.selected.emptyExpenses":"لم يتم تسجيل أي مصروف","projects.summary.title":"ملخص سريع","projects.summary.totalProjects":"إجمالي المشاريع","projects.summary.upcoming":"مشاريع قادمة","projects.summary.expenses":"إجمالي المصروفات","projects.summary.budget":"القيمة التقديرية (مع الضريبة)","projects.focus.title":"📌 نظرة سريعة على المشاريع","projects.focus.legend":"اختر بطاقة للاطلاع على التفاصيل أو التعديل السريع.","projects.focus.today":"مشاريع اليوم","projects.focus.thisWeek":"مشاريع هذا الأسبوع","projects.focus.upcoming":"مشاريع قادمة","projects.focus.recent":"أحدث المشاريع","projects.focus.empty":"لا توجد مشاريع لليوم أو هذا الأسبوع.","projects.focus.view":"عرض التفاصيل","projects.focus.edit":"تعديل","projects.focus.actions.confirm":"✔️ تأكيد المشروع","projects.focus.confirmed":"✅ مشروع مؤكد","projects.focus.toastNotFound":"⚠️ تعذّر العثور على المشروع في القائمة","projects.toast.linkReservationFailed":"⚠️ تعذّر ربط بعض الحجوزات بالمشروع، يرجى التحقق يدويًا","projects.toast.companyShareRequiresTax":"⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة","projects.timeline.title":"الجدول الزمني للمشاريع","projects.timeline.legend":"يُظهر الشريط مواعيد البداية والنهاية، والألوان تُمثّل حالة المشروع.","projects.timeline.legend.upcoming":"قادم","projects.timeline.legend.ongoing":"قيد التنفيذ","projects.timeline.legend.completed":"مكتمل","projects.timeline.legend.conflict":"تعارض","projects.timeline.empty":"لا توجد مشاريع ببيانات زمنية صالحة.","projects.timeline.conflict":"تعارض في التوقيت","projects.timeline.range":"{start} → {end}","projects.search.title":"بحث سريع","projects.search.placeholder":"ابحث عن مشروع بالاسم أو العميل","projects.subtabs.create":"إنشاء مشروع","projects.subtabs.list":"مشاريعي","projects.subtabs.reports":"تقارير المشاريع","projects.subtabs.expenses":"مصاريف المشاريع","projects.table.title":"قائمة المشاريع","projects.table.count":"{count} مشروع","projects.table.reservationsCount":"{count} حجوزات","projects.table.headers.project":"المشروع","projects.table.headers.client":"العميل","projects.table.headers.period":"الفترة","projects.table.headers.crew":"الطاقم","projects.table.headers.equipment":"المعدات","projects.table.headers.total":"الإجمالي (مع الضريبة)","projects.table.headers.expenses":"مصروفات (SR)","projects.table.emptyInitial":"لم يتم إنشاء مشاريع بعد.","projects.table.emptyFiltered":"لا توجد مشاريع مطابقة.","projects.modal.title":"تفاصيل المشروع","projects.details.overview.heading":"معلومات المشروع","projects.reports.pageTitle":"تقارير المشاريع - نظام التأجير","projects.reports.title":"لوحة تقارير المشاريع","projects.reports.subtitle":"تحليلات تفصيلية لأداء المشاريع، المواعيد النهائية، ونسب التنفيذ.","projects.reports.filters.search":"بحث","projects.reports.filters.searchPlaceholder":"بحث باسم المشروع أو العميل","projects.reports.filters.status":"حالة المشروع","projects.reports.filters.payment":"حالة الدفع","projects.reports.filters.paymentAll":"كل الحالات","projects.reports.filters.dateRange":"نطاق التاريخ","projects.reports.filters.range.all":"كل الوقت","projects.reports.filters.range.30":"آخر 30 يوم","projects.reports.filters.range.90":"آخر 90 يوم","projects.reports.filters.range.365":"آخر سنة","projects.reports.filters.range.custom":"تاريخ مخصص","projects.reports.filters.start":"من","projects.reports.filters.end":"إلى","projects.reports.filters.refresh":"تحديث","projects.reports.charts.status":"توزيع الحالات","projects.reports.charts.statusHint":"نسبة المشاريع حسب حالة التنفيذ","projects.reports.charts.timeline":"الإيرادات عبر الزمن","projects.reports.charts.timelineHint":"إجمالي قيمة المشاريع شهريًا","projects.reports.charts.expenses":"تكلفة الخدمات الإنتاجية مقابل القيمة","projects.reports.charts.expensesHint":"مقارنة تكلفة الخدمات الإنتاجية مع إجمالي قيمة المشروع","projects.reports.charts.clients":"أفضل العملاء","projects.reports.charts.clientsHint":"أعلى العملاء حسب قيمة المشاريع","projects.reports.loading.chart":"جارٍ تحديث الرسم...","projects.reports.table.title":"قائمة المشاريع","projects.reports.table.columns.project":"المشروع","projects.reports.table.columns.client":"العميل","projects.reports.table.columns.status":"الحالة","projects.reports.table.columns.period":"الفترة","projects.reports.table.columns.value":"القيمة","projects.reports.table.columns.payment":"الدفع","projects.reports.table.empty":"لا توجد مشاريع مطابقة للبحث الحالي.","projects.reports.table.meta":"عرض {count} من أصل {total} مشروع","projects.reports.kpi.totalProjects":"إجمالي المشاريع","projects.reports.kpi.totalProjectsMeta":"بعد تطبيق الفلاتر الحالية","projects.reports.kpi.totalValue":"القيمة الإجمالية","projects.reports.kpi.totalValueMeta":"يشمل المشاريع والحجوزات المرتبطة","projects.reports.kpi.unpaidValue":"قيمة غير مدفوعة","projects.reports.kpi.unpaidValueMeta":"مشاريع لم تُسدَّد بالكامل بعد","projects.reports.kpi.expenses":"تكلفة الخدمات الإنتاجية","projects.reports.kpi.expensesMeta":"تكلفة الخدمات الإنتاجية للمشاريع المحددة","projects.reports.datasets.value":"القيمة الإجمالية","projects.reports.datasets.expenses":"تكلفة الخدمات الإنتاجية","projects.reports.kpi.revenue.details.projectExpenses":"تكلفة الخدمات الإنتاجية","projects.expenses.pageTitle":"مصاريف المشاريع - نظام التأجير","projects.expenses.title":"إدارة مصاريف المشاريع","projects.expenses.subtitle":"تابع المصاريف المرتبطة بالحجوزات والمشاريع مع إمكانية الربط مع فواتير العملاء.","projects.expenses.placeholder":"ستتم إضافة لوحة مخصصة لربط مصاريف المشاريع بالحجوزات قريباً.","projects.expenses.placeholderHint":"جهز الفواتير والفئات الآن لتسريع الإطلاق القادم.","projects.expenses.actions.addExpense":"➕ إضافة خدمة","projects.expenses.actions.importInvoice":"🧾 رفع فاتورة","projects.expenses.actions.export":"⬇️ تصدير","projects.expenses.kpi.total":"إجمالي المصاريف","projects.expenses.kpi.total.meta":"المصاريف المسجلة خلال الفترة الحالية","projects.expenses.kpi.pending":"بانتظار الموافقة","projects.expenses.kpi.pending.meta":"مصاريف تحتاج اعتماد المدير المالي","projects.expenses.kpi.approved":"تمت الموافقة","projects.expenses.kpi.approved.meta":"آخر المصروفات التي تم اعتمادها","projects.expenses.kpi.average":"متوسط المصروف لكل مشروع","projects.expenses.kpi.average.meta":"قيمة تقريبية استناداً للمشاريع النشطة","projects.expenses.breakdown.title":"توزيع المصاريف حسب التصنيف","projects.expenses.breakdown.hint":"راقب الصرف على المعدات، الطاقم، والتنقلات.","projects.expenses.breakdown.empty":"لم يتم تسجيل مصاريف مصنفة حتى الآن.","projects.expenses.timeline.title":"المصاريف عبر الجدول الزمني","projects.expenses.timeline.hint":"سجل المصاريف خلال الأشهر الماضية لمراقبة الاتجاهات.","projects.expenses.timeline.empty":"أضف مصروفات لعرض الرسم البياني التفاعلي.","projects.expenses.table.title":"سجل المصاريف التفصيلي","projects.expenses.table.hint":"استعرض المصاريف المرتبطة بكل مشروع مع حالة الموافقات.","projects.expenses.table.columns.project":"المشروع","projects.expenses.table.columns.category":"التصنيف","projects.expenses.table.columns.description":"الوصف","projects.expenses.table.columns.amount":"المبلغ","projects.expenses.table.columns.status":"الحالة","projects.expenses.table.columns.date":"تاريخ التسجيل","projects.expenses.table.empty":"ستظهر المصاريف المسجلة هنا فور إضافتها.","projects.toast.selectTechnician":"⚠️ يرجى اختيار عضو الطاقم","projects.toast.technicianAlreadyAdded":"⚠️ العضو مضاف بالفعل","projects.toast.technicianAdded":"✅ تمت إضافة عضو الطاقم","projects.toast.selectEquipment":"⚠️ يرجى اختيار المعدة","projects.toast.equipmentAdded":"✅ تمت إضافة المعدة للمشروع","projects.toast.missingExpenseLabel":"⚠️ يرجى إدخال وصف المصروف","projects.toast.invalidExpenseAmount":"⚠️ يرجى إدخال مبلغ صحيح","projects.toast.customerNotFound":"⚠️ لم يتم العثور على العميل بالاسم المدخل","projects.toast.missingRequiredFields":"⚠️ يرجى تعبئة البيانات المطلوبة","projects.toast.invalidDateRange":"⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية","projects.toast.saved":"✅ تم حفظ المشروع بنجاح","projects.toast.editReady":"✏️ تم تجهيز المشروع للتعديل. عدّل الحقول ثم احفظ التغييرات.","projects.toast.updated":"✅ تم تحديث المشروع بنجاح","projects.toast.editMissing":"⚠️ تعذّر العثور على المشروع المطلوب تعديله","projects.toast.confirmed":"✅ تم تأكيد المشروع","projects.toast.alreadyConfirmed":"ℹ️ المشروع مؤكّد مسبقًا","projects.toast.deleted":"🗑️ تم حذف المشروع","projects.confirm.delete":"هل أنت متأكد من حذف هذا المشروع؟","projects.fallback.unknownClient":"عميل غير معروف","projects.fallback.unknownEquipment":"معدة","projects.fallback.noDescription":"لا يوجد وصف","projects.fallback.untitled":"مشروع بدون اسم","projects.fallback.emptyList":"لا يوجد","projects.fallback.technicianName":"عضو {id}","projects.status.upcoming":"قادم","projects.status.ongoing":"قيد التنفيذ","projects.status.completed":"مكتمل","projects.status.conflict":"تعارض","projects.status.cancelled":"ملغي","projects.form.labels.cancelled":"إلغاء المشروع","projects.form.hints.cancelled":"سيتم وسم المشروع كملغي وتحديث حالة جميع الحجوزات المرتبطة إلى ملغي.","projectCards.filters.search":"🔍 ابحث باسم المشروع أو الوصف...","projectCards.filters.status.all":"⚙️ كل الحالات","projectCards.filters.status.upcoming":"📅 مشاريع قادمة","projectCards.filters.status.ongoing":"⚙️ مشاريع قيد التنفيذ","projectCards.filters.status.completed":"✅ مشاريع منتهية","projectCards.stats.crew":"👥 عدد الطاقم: {count}","projectCards.stats.reservations":"🔗 الحجوزات: {count}","projectCards.stats.client":"👤 العميل: {name}","projectCards.stats.type":"🏷️ النوع: {label}","projectCards.stats.budget":"💰 التكلفة التقديرية (مع الضريبة): {amount}","projectCards.stats.expenses":"💸 المصروفات: {amount}","projectCards.stats.crewShort":"طاقم العمل","projectCards.stats.reservationsShort":"الحجوزات","projectCards.stats.budgetShort":"ميزانية المشروع","projectCards.stats.expensesShort":"إجمالي المصروفات","projectCards.stats.paymentStatus":"حالة الدفع","projectCards.stats.equipmentCount":"عدد المعدات","projectCards.stats.crewCount":"عدد الطاقم","projectCards.stats.reservationValue":"إجمالي الحجوزات","projectCards.stats.expensesTotal":"إجمالي المصاريف","projectCards.stats.reservationTotal":"إجمالي الحجز","projectCards.stats.taxTotal":"الضريبة","projectCards.stats.overallTotal":"المجموع الكلي","projectCards.groups.meta":"بيانات المشروع","projectCards.groups.reservations":"موجز الحجز","projectCards.groups.payment":"ملخص الدفع","projectCards.meta.code":"رقم المشروع","projectCards.meta.client":"العميل","projectCards.meta.company":"شركة العميل","projectCards.meta.type":"نوع المشروع","projectCards.meta.startDate":"تاريخ البداية","projectCards.meta.endDate":"تاريخ النهاية","projects.details.type":"نوع المشروع","projects.details.company":"شركة العميل","projects.details.client":"العميل","projects.details.crew":"الطاقم الفني ({count})","projects.details.equipment":"المعدات ({count})","projects.details.expenses":"خدمات إنتاجية ({amount})","projects.details.subtotal":"الإجمالي قبل الضريبة:","projects.details.tax":"ضريبة القيمة المضافة (15٪):","projects.details.total":"الإجمالي بعد الضريبة:","projects.details.labels.projectTitle":"اسم المشروع","projects.details.labels.code":"رقم المشروع","projects.details.summary.projectSubtotal":"إجمالي المشروع","projects.details.summary.paymentStatus":"حالة الدفع","projects.details.summary.projectTax":"ضريبة المشروع (15٪)","projects.details.summary.projectTotal":"إجمالي المشروع بعد الضريبة","projects.details.summary.reservationsTotal":"إجمالي المعدات / طاقم العمل","projects.details.summary.combinedTax":"إجمالي الضريبة الكلية (15٪)","projects.details.summary.reservationsCount":"{count} حجوزات مرتبطة","projects.details.summary.overallTotal":"الإجمالي الكلي","projects.details.summary.equipmentTotal":"إجمالي المعدات","projects.details.summary.crewTotal":"إجمالي الفريق","projects.details.summary.crewCostTotal":"تكلفة الفريق","projects.details.summary.expensesTotal":"تكلفة الخدمات الإنتاجية","projects.details.summary.gross":"الإجمالي","projects.details.summary.discount":"الخصم","projects.details.summary.companyShare":"نسبة الشركة","projects.details.summary.tax":"الضريبة (15٪)","projects.details.summary.grossAfterDiscount":"الإجمالي بعد الخصم","projects.details.summary.netProfit":"صافي الربح","projects.details.summary.finalTotal":"المجموع النهائي","projects.details.labels.start":"تاريخ البداية","projects.details.labels.end":"تاريخ النهاية","projects.details.labels.crewCount":"عدد الطاقم","projects.details.labels.equipmentCount":"عدد المعدات","projects.details.labels.reservationsCount":"عدد الحجوزات","projects.details.labels.notes":"ملاحظات المشروع","projects.details.chips.vatOn":"شامل الضريبة 15٪","projects.details.chips.vatOff":"غير شامل الضريبة","projects.details.chips.reservations":"{count} حجوزات","projects.details.chips.linkedReservation":"مربوط بحجز","projects.details.chips.notLinkedReservation":"غير مربوط بحجز","projects.details.noItems":"لا يوجد","projects.details.quantity":"{qty} قطعة","projects.details.reservations.title":"الحجوزات المرتبطة","projects.details.reservations.empty":"لا توجد حجوزات مرتبطة بهذا المشروع بعد.","projects.details.reservations.create":"➕ إنشاء حجز مرتبط","projects.details.actions.edit":"✏️ تعديل المشروع","projects.details.actions.delete":"🗑️ حذف المشروع","projects.details.reservations.view":"عرض الحجز","projects.details.reservations.count":"{count} حجوزات","projects.details.reservations.itemsCount":"{count} معدة","projects.details.reservations.crewCount":"{count} من الطاقم","projects.details.edit.heading":"تعديل المشروع","projects.details.edit.subheading":"قم بتحديث بيانات المشروع ثم احفظ التغييرات.","projects.details.edit.save":"💾 حفظ التعديلات","projects.details.edit.cancel":"إلغاء","projects.quote.sections.customer":"بيانات العميل","projects.quote.sections.project":"بيانات المشروع","projects.quote.sections.expenses":"الخدمات الإنتاجية","projects.quote.sections.crew":"طاقم العمل","projects.quote.sections.financial":"الملخص المالي","projects.quote.sections.equipment":"المعدات","projects.quote.sections.notes":"ملاحظات المشروع"},en:{"projects.nav.brand":"Rental System","projects.nav.projects":"Projects","projects.nav.customers":"Clients","projects.nav.technicians":"Crew","projects.hero.title":"Projects Management","projects.hero.subtitle":"Create and coordinate projects, assign crew and equipment, and track expenses.","projects.form.title":"Create New Project","projects.form.labels.type":"Project Type","projects.form.labels.title":"Project Name","projects.form.labels.client":"Client","projects.form.labels.clientCompany":"Client Company","projects.form.labels.paymentStatus":"Payment Status","projects.form.labels.startDate":"📅 Start Date","projects.form.labels.startTime":"⏰ Start Time","projects.form.labels.endDate":"📅 End Date","projects.form.labels.endTime":"⏰ End Time","projects.form.labels.description":"Project Details","projects.form.labels.technician":"Add Crew Member","projects.form.labels.equipment":"Add Equipment","projects.form.labels.quantity":"Quantity","projects.form.labels.expenses":"Production services","projects.form.labels.expenseLabel":"Expense Name","projects.form.labels.expenseAmount":"Amount (SR)","projects.form.labels.servicesClientTotal":"Sales total","projects.form.labels.salePrice":"Sale price","projects.expenses.table.headers.service":"Service","projects.expenses.table.headers.cost":"Cost (SR)","projects.expenses.table.headers.sale":"Sale price (SR)","projects.expenses.table.headers.actions":"Actions","projects.form.placeholders.title":"Example: New product shoot","projects.form.placeholders.description":"Project brief and requirements","projects.form.placeholders.type":"Choose a project type","projects.form.placeholders.clientCompany":"Auto-filled from client record","projects.form.placeholders.startDate":"Select the start date","projects.form.placeholders.startTime":"Select the start time","projects.form.placeholders.endDate":"Select the end date (optional)","projects.form.placeholders.endTime":"Select the end time (optional)","projects.form.placeholders.client":"Type the client name...","projects.form.placeholders.expenseLabel":"Example: Location permit or extra gear","projects.form.linkedReservation.title":"Create Linked Reservation","projects.form.linkedReservation.description":"Create a reservation for this project and we'll pre-fill the matching details.","projects.form.linkedReservation.button":"➕ Create Linked Reservation","projects.form.linkedReservation.missingClient":"⚠️ Please select the client before creating the linked reservation.","projects.form.linkedReservation.missingSchedule":"⚠️ Please provide both start and end date/time before creating the linked reservation.","projects.form.linkedReservation.empty":"No linked reservations yet.","projects.form.linkedReservation.pendingItem":"This reservation will be linked automatically once the project is saved.","projects.form.linkedReservation.buttonDisabled":"A linked reservation was created. Manage further changes from the reservation itself.","projects.form.linkedReservation.meta.equipment":"Equipment count: {count}","projects.form.linkedReservation.meta.crew":"Crew count: {count}","projects.form.linkedReservation.meta.crewNames":"Crew names: {names}","projects.form.linkedReservation.meta.total":"Reservation total: {amount}","projects.form.labels.discount":"Discount","projects.form.labels.companyShare":"Company share & VAT","projects.form.labels.applyTax":"Apply VAT 15%","projects.form.discount.percent":"% Percent","projects.form.discount.amount":"💵 Amount","projects.form.companyShareToggle":"Include company share (10%)","projects.form.selectClient":"Select client","projects.form.selectTechnician":"Select crew member","projects.form.selectEquipment":"Select equipment","projects.form.types.commercial":"Commercial shoot","projects.form.types.coverage":"Event coverage","projects.form.types.photography":"Photography","projects.form.types.social":"Social media content","projects.form.types.unknown":"Unspecified type","projects.form.buttons.addTechnician":"➕ Add to Crew","projects.form.buttons.addEquipment":"➕ Add to Project","projects.form.buttons.addExpense":"➕ Add Expense","projects.form.buttons.save":"🆕 Create Project","projects.form.buttons.update":"🔁 Update Project","projects.form.taxLabel":"Include VAT (15%)","projects.form.paymentStatus.paid":"Paid","projects.form.paymentStatus.unpaid":"Unpaid","projects.form.paymentStatus.partial":"Partially Paid","projects.form.paymentProgress.label":"💰 Received Payment","projects.form.paymentProgress.amount":"💵 Amount","projects.form.paymentProgress.percent":"% Percent","projects.form.paymentProgress.placeholder":"0","projects.form.paymentProgress.hint":"Enter the amount or percentage received from the project total","projects.paymentStatus.paid":"Paid","projects.paymentStatus.unpaid":"Unpaid","projects.paymentStatus.partial":"Partially Paid","projects.selected.emptyTechnicians":"No crew members selected yet","projects.selected.emptyEquipment":"No equipment selected","projects.selected.emptyExpenses":"No expenses recorded","projects.summary.title":"Quick Overview","projects.summary.totalProjects":"Total Projects","projects.summary.upcoming":"Upcoming Projects","projects.summary.expenses":"Total Expenses","projects.summary.budget":"Estimated Value (with VAT)","projects.focus.title":"📌 Focus Projects","projects.focus.legend":"Tap a card to review details or jump to editing.","projects.focus.today":"Today's Projects","projects.focus.thisWeek":"This Week","projects.focus.upcoming":"Upcoming Projects","projects.focus.recent":"Latest Projects","projects.focus.empty":"No projects scheduled for today or this week.","projects.focus.view":"View details","projects.focus.edit":"Edit","projects.focus.actions.confirm":"✔️ Confirm project","projects.focus.confirmed":"✅ Project confirmed","projects.focus.toastNotFound":"⚠️ Could not find this project in the list","projects.toast.linkReservationFailed":"⚠️ Unable to link some reservations to the project. Please review them manually.","projects.toast.companyShareRequiresTax":"⚠️ Company share requires VAT to be enabled first.","projects.timeline.title":"Projects Timeline","projects.timeline.legend":"The bar shows project start and end, with colors reflecting status.","projects.timeline.legend.upcoming":"Upcoming","projects.timeline.legend.ongoing":"In Progress","projects.timeline.legend.completed":"Completed","projects.timeline.legend.conflict":"Conflict","projects.timeline.empty":"No projects with valid schedule to display.","projects.timeline.conflict":"Scheduling conflict","projects.timeline.range":"{start} → {end}","projects.search.title":"Quick Search","projects.search.placeholder":"Search by project name or client","projects.subtabs.create":"Create Project","projects.subtabs.list":"My Projects","projects.subtabs.reports":"Project Reports","projects.subtabs.expenses":"Project Expenses","projects.table.title":"Projects List","projects.table.count":"{count} project","projects.table.reservationsCount":"{count} reservations","projects.table.headers.project":"Project","projects.table.headers.client":"Client","projects.table.headers.period":"Schedule","projects.table.headers.crew":"Crew","projects.table.headers.equipment":"Equipment","projects.table.headers.total":"Total (with VAT)","projects.table.headers.expenses":"Expenses (SR)","projects.table.emptyInitial":"No projects have been created yet.","projects.table.emptyFiltered":"No matching projects found.","projects.modal.title":"Project Details","projects.details.overview.heading":"Project Information","projects.reports.pageTitle":"Project Reports - Rental System","projects.reports.title":"Project Reporting Dashboard","projects.reports.subtitle":"Detailed analytics for project performance, deadlines, and completion rates.","projects.reports.filters.search":"Search","projects.reports.filters.searchPlaceholder":"Search by project or client name","projects.reports.filters.status":"Project status","projects.reports.filters.payment":"Payment status","projects.reports.filters.paymentAll":"All payments","projects.reports.filters.dateRange":"Date range","projects.reports.filters.range.all":"All time","projects.reports.filters.range.30":"Last 30 days","projects.reports.filters.range.90":"Last 90 days","projects.reports.filters.range.365":"Last year","projects.reports.filters.range.custom":"Custom range","projects.reports.filters.start":"From","projects.reports.filters.end":"To","projects.reports.filters.refresh":"Refresh","projects.reports.charts.status":"Status distribution","projects.reports.charts.statusHint":"Share of projects per execution status","projects.reports.charts.timeline":"Revenue over time","projects.reports.charts.timelineHint":"Total project value by month","projects.reports.charts.expenses":"Expenses vs. value","projects.reports.charts.expensesHint":"Compare spend against total project value","projects.reports.charts.clients":"Top clients","projects.reports.charts.clientsHint":"Highest clients by project value","projects.reports.loading.chart":"Refreshing chart…","projects.reports.table.title":"Project list","projects.reports.table.columns.project":"Project","projects.reports.table.columns.client":"Client","projects.reports.table.columns.status":"Status","projects.reports.table.columns.period":"Period","projects.reports.table.columns.value":"Value","projects.reports.table.columns.payment":"Payment","projects.reports.table.empty":"No projects match the current filters.","projects.reports.table.meta":"Showing {count} of {total} projects","projects.reports.kpi.totalProjects":"Total projects","projects.reports.kpi.totalProjectsMeta":"After applying the current filters","projects.reports.kpi.totalValue":"Total value","projects.reports.kpi.totalValueMeta":"Includes projects and linked reservations","projects.reports.kpi.unpaidValue":"Outstanding value","projects.reports.kpi.unpaidValueMeta":"Projects not fully paid yet","projects.reports.kpi.expenses":"Total expenses","projects.reports.kpi.expensesMeta":"Expenses for included projects","projects.reports.datasets.value":"Total value","projects.reports.datasets.expenses":"Expenses","projects.expenses.pageTitle":"Project Expenses - Rental System","projects.expenses.title":"Manage Project Expenses","projects.expenses.subtitle":"Track expenses linked to bookings and projects with full invoicing visibility.","projects.expenses.placeholder":"A dedicated board for linking project expenses to bookings is coming soon.","projects.expenses.placeholderHint":"Prepare invoices and categories now to accelerate the upcoming release.","projects.expenses.actions.addExpense":"➕ Add expense","projects.expenses.actions.importInvoice":"🧾 Upload invoice","projects.expenses.actions.export":"⬇️ Export","projects.expenses.kpi.total":"Total expenses","projects.expenses.kpi.total.meta":"Expenses recorded during the current period","projects.expenses.kpi.pending":"Pending approval","projects.expenses.kpi.pending.meta":"Expenses awaiting financial manager approval","projects.expenses.kpi.approved":"Approved","projects.expenses.kpi.approved.meta":"Latest expenses that were approved","projects.expenses.kpi.average":"Average per project","projects.expenses.kpi.average.meta":"Estimated value based on active projects","projects.expenses.breakdown.title":"Expenses by category","projects.expenses.breakdown.hint":"Track spend on equipment, crew, and logistics.","projects.expenses.breakdown.empty":"No categorized expenses recorded yet.","projects.expenses.timeline.title":"Expenses over time","projects.expenses.timeline.hint":"Review spend across recent months to spot trends.","projects.expenses.timeline.empty":"Add expenses to unlock the interactive timeline.","projects.expenses.table.title":"Detailed expense ledger","projects.expenses.table.hint":"Review project expenses together with approval status.","projects.expenses.table.columns.project":"Project","projects.expenses.table.columns.category":"Category","projects.expenses.table.columns.description":"Description","projects.expenses.table.columns.amount":"Amount","projects.expenses.table.columns.status":"Status","projects.expenses.table.columns.date":"Logged on","projects.expenses.table.empty":"Registered expenses will appear here as soon as you add them.","projects.toast.selectTechnician":"⚠️ Please select a crew member","projects.toast.technicianAlreadyAdded":"⚠️ Crew member already added","projects.toast.technicianAdded":"✅ Crew member added","projects.toast.selectEquipment":"⚠️ Please select equipment","projects.toast.equipmentAdded":"✅ Equipment added to project","projects.toast.missingExpenseLabel":"⚠️ Please enter an expense description","projects.toast.invalidExpenseAmount":"⚠️ Please enter a valid amount","projects.toast.customerNotFound":"⚠️ Client name not found. Please select an existing client.","projects.toast.missingRequiredFields":"⚠️ Please fill in the required fields","projects.toast.invalidDateRange":"⚠️ End date must be after the start date","projects.toast.saved":"✅ Project saved successfully","projects.toast.editReady":"✏️ Project loaded for editing. Update the fields, then save.","projects.toast.updated":"✅ Project updated successfully","projects.toast.editMissing":"⚠️ Unable to find the project you tried to edit","projects.toast.confirmed":"✅ Project confirmed","projects.toast.alreadyConfirmed":"ℹ️ Project already confirmed","projects.toast.deleted":"🗑️ Project deleted","projects.confirm.delete":"Are you sure you want to delete this project?","projects.fallback.unknownClient":"Unknown client","projects.fallback.unknownEquipment":"Equipment","projects.fallback.noDescription":"No description","projects.fallback.untitled":"Untitled project","projects.fallback.emptyList":"None","projects.fallback.technicianName":"Member {id}","projects.status.upcoming":"Upcoming","projects.status.ongoing":"In Progress","projects.status.completed":"Completed","projects.status.conflict":"Conflict","projects.status.cancelled":"Cancelled","projects.form.labels.cancelled":"Cancel project","projects.form.hints.cancelled":"Marks the project as cancelled and updates all linked reservations to cancelled.","projectCards.filters.search":"🔍 Search by project name or description...","projectCards.filters.status.all":"⚙️ All statuses","projectCards.filters.status.upcoming":"📅 Upcoming projects","projectCards.filters.status.ongoing":"⚙️ In-progress projects","projectCards.filters.status.completed":"✅ Completed projects","projectCards.stats.crew":"👥 Crew members: {count}","projectCards.stats.reservations":"🔗 Reservations: {count}","projectCards.stats.client":"👤 Client: {name}","projectCards.stats.type":"🏷️ Type: {label}","projectCards.stats.budget":"💰 Estimated budget (with VAT): {amount}","projectCards.stats.expenses":"💸 Expenses: {amount}","projectCards.stats.crewShort":"Crew","projectCards.stats.reservationsShort":"Reservations","projectCards.stats.budgetShort":"Project budget","projectCards.stats.expensesShort":"Total expenses","projectCards.stats.paymentStatus":"Payment status","projectCards.stats.equipmentCount":"Equipment count","projectCards.stats.crewCount":"Crew count","projectCards.stats.reservationValue":"Reservation total","projectCards.stats.expensesTotal":"Expenses total","projectCards.stats.reservationTotal":"Linked reservation total","projectCards.stats.taxTotal":"VAT","projectCards.stats.overallTotal":"Grand total","projectCards.groups.meta":"Project info","projectCards.groups.reservations":"Reservation snapshot","projectCards.groups.payment":"Payment summary","projectCards.meta.code":"Project ID","projectCards.meta.client":"Client","projectCards.meta.company":"Client company","projectCards.meta.type":"Project type","projectCards.meta.startDate":"Start date","projectCards.meta.endDate":"End date","projects.details.type":"Project type","projects.details.company":"Client company","projects.details.client":"Client","projects.details.crew":"Crew ({count})","projects.details.equipment":"Equipment ({count})","projects.details.expenses":"Expenses ({amount})","projects.details.subtotal":"Subtotal before tax:","projects.details.tax":"VAT 15%:","projects.details.total":"Total with VAT:","projects.details.labels.projectTitle":"Project Name","projects.details.labels.code":"Project ID","projects.details.summary.projectSubtotal":"Project total","projects.details.summary.paymentStatus":"Payment status","projects.details.summary.projectTax":"Project VAT (15%)","projects.details.summary.projectTotal":"Project total (after VAT)","projects.details.summary.reservationsTotal":"Equipment / crew total","projects.details.summary.combinedTax":"Total VAT on combined amount (15%)","projects.details.summary.reservationsCount":"{count} linked reservations","projects.details.summary.overallTotal":"Overall total","projects.details.summary.equipmentTotal":"Equipment total","projects.details.summary.crewTotal":"Crew total","projects.details.summary.crewCostTotal":"Crew cost","projects.details.summary.expensesTotal":"Project expenses","projects.details.summary.gross":"Gross","projects.details.summary.discount":"Discount","projects.details.summary.companyShare":"Company share","projects.details.summary.tax":"VAT (15%)","projects.details.summary.grossAfterDiscount":"Total after discount","projects.details.summary.netProfit":"Net profit","projects.details.summary.finalTotal":"Final total","projects.details.labels.start":"Start date","projects.details.labels.end":"End date","projects.details.labels.crewCount":"Crew count","projects.details.labels.equipmentCount":"Equipment quantity","projects.details.labels.reservationsCount":"Reservations count","projects.details.labels.notes":"Project notes","projects.details.chips.vatOn":"VAT enabled 15%","projects.details.chips.vatOff":"VAT disabled","projects.details.chips.reservations":"{count} reservations","projects.details.chips.linkedReservation":"Linked to reservation","projects.details.chips.notLinkedReservation":"Not linked to reservation","projects.details.noItems":"None","projects.details.quantity":"{qty} pcs","projects.details.reservations.title":"Linked reservations","projects.details.reservations.empty":"No reservations linked to this project yet.","projects.details.reservations.create":"➕ Create linked reservation","projects.details.reservations.view":"View reservation","projects.details.actions.edit":"✏️ Edit Project","projects.details.actions.delete":"🗑️ Delete Project","projects.details.reservations.count":"{count} reservations","projects.details.reservations.itemsCount":"{count} item(s)","projects.details.reservations.crewCount":"{count} crew member(s)","projects.details.edit.heading":"Edit Project","projects.details.edit.subheading":"Update the project details, then save your changes.","projects.details.edit.save":"💾 Save Changes","projects.details.edit.cancel":"Cancel","projects.quote.sections.customer":"Customer info","projects.quote.sections.project":"Project info","projects.quote.sections.expenses":"Production services","projects.quote.sections.crew":"Crew","projects.quote.sections.financial":"Financial summary","projects.quote.sections.equipment":"Equipment","projects.quote.sections.notes":"Project notes"}});const i={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],servicesClientPriceTotal:0,filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null,pendingLinkedToast:!1},t={};function Jt(){i.selectedTechnicians=[],i.selectedEquipment=[],i.expenses=[],i.servicesClientPriceTotal=0}function u(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function D(e){const s=Number(e)||0,n=Se()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.NumberFormat(n,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(s));return`${y(o)} SR`}function W(e){if(!e)return"—";const s=new Date(e);if(Number.isNaN(s.getTime()))return"—";const r=String(s.getDate()).padStart(2,"0"),n=String(s.getMonth()+1).padStart(2,"0"),o=String(s.getFullYear()),a=String(s.getMinutes()).padStart(2,"0"),l=s.getHours(),c=l>=12?"PM":"AM",d=l%12||12,f=String(d).padStart(2,"0"),j=`${r}/${n}/${o} ${f}:${a} ${c}`;return y(j)}function Yt(e){const s=Se(),r=y(String(e));return s==="en"?`${r} ${e===1?"project":"projects"}`:`${r} مشروع`}function ze(e){t.tableCount&&(t.tableCount.dataset.count=String(e),t.tableCount.textContent=Yt(e))}function at(e){if(!e)return"";const s=e.dataset.emptyKey,r=e.dataset.empty||"";return s?p(s,r):r}function Gt(){if(!Array.isArray(i.projects)||i.projects.length===0)return;let e=!1;const s=i.projects.map(r=>{if(r.projectCode)return r;const n=Xe();return e=!0,{...r,projectCode:n}});e&&(i.projects=s)}function $s(){const{customers:e,technicians:s,equipment:r}=Q();i.customers=Array.isArray(e)?e:[],i.technicians=Array.isArray(s)?s:[],i.equipment=Array.isArray(r)?r:[],i.reservations=$(),i.projects=Fe(),Gt()}function qs(){if(Qt(),t.technicianSelect){const e=t.technicianSelect.value,s=u(p("projects.form.selectTechnician","اختر عضو الطاقم"));t.technicianSelect.innerHTML=`<option value="">${s}</option>`+i.technicians.map(r=>{const n=p("projects.fallback.technicianName","عضو {id}"),o=r.name||n.replace("{id}",y(String(r.id||"")));return`<option value="${r.id}">${u(o)}</option>`}).join(""),e&&(t.technicianSelect.value=e)}if(t.equipmentSelect){const e=t.equipmentSelect.value,s=u(p("projects.form.selectEquipment","اختر المعدة"));t.equipmentSelect.innerHTML=`<option value="">${s}</option>`+i.equipment.map(r=>{const n=r.desc||r.description||r.name||p("projects.fallback.unknownEquipment","معدة");return`<option value="${u(r.barcode||"")}">${u(n)}</option>`}).join(""),e&&(t.equipmentSelect.value=e)}}function G(e){if(!t.clientCompany)return;const s=e?.companyName||e?.company||"";t.clientCompany.value=s}function Qt(){if(!t.client)return;Xt();const e=t.client.dataset?.customerId;if(e){const s=i.customers.find(r=>String(r.id)===String(e));s?G(s):(t.client.dataset.customerId="",G(null))}else G(null);document.activeElement===t.client&&Be()}function Xt(){!t.client||!t.clientSuggestions||t.client.dataset.autocompleteAttached!=="true"&&(t.client.addEventListener("input",()=>{t.client.dataset.customerId="",Be(),G(null)}),t.client.addEventListener("focus",()=>{Be()}),t.client.addEventListener("blur",()=>{window.setTimeout(()=>ye(),150)}),t.client.dataset.autocompleteAttached="true")}function ye(){t.clientSuggestions&&(t.clientSuggestions.classList.remove("is-visible"),t.clientSuggestions.hidden=!0,t.clientSuggestions.innerHTML="")}function Be(){if(!t.client||!t.clientSuggestions)return;if(!Array.isArray(i.customers)||i.customers.length===0){const n=Q();Array.isArray(n?.customers)&&n.customers.length&&(i.customers=n.customers)}const e=Zt(),s=ae(t.client.value||""),r=s?e.filter(n=>{const o=ae(n.name).includes(s),a=ae(n.company||"").includes(s);return o||a}).slice(0,10):e.slice(0,10);if(!r.length){ye();return}t.clientSuggestions.innerHTML=r.map(n=>{const o=n.company?`<div class="suggestion-item__meta">${u(n.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${u(String(n.id))}" data-name="${u(n.name)}" data-company="${u(n.company||"")}">
          <div class="suggestion-item__primary">${u(n.name)}</div>
          ${o}
        </div>
      `}).join(""),t.clientSuggestions.hidden=!1,t.clientSuggestions.classList.add("is-visible"),t.clientSuggestions.scrollTop=0,t.clientSuggestions.querySelectorAll(".suggestion-item").forEach(n=>{n.addEventListener("mousedown",o=>{o.preventDefault();const{id:a,name:l}=o.currentTarget.dataset;t.client&&(t.client.value=l||"",t.client.dataset.customerId=a||"");const c=o.currentTarget.dataset.company||"";G({companyName:c}),ye()})})}function Zt(){return Array.isArray(i.customers)?i.customers.map(e=>{const s=(e.customerName||e.name||"").trim();return s?{id:e.id,name:s,company:(e.companyName||e.company||"").trim()}:null}).filter(Boolean):[]}function es(e,s=""){if(!Array.isArray(i.customers)||i.customers.length===0)return null;if(s){const o=i.customers.find(a=>String(a.id)===String(s));if(o)return o}const r=ae(e||"");if(!r)return null;const n=i.customers.find(o=>ae(o.customerName||o.name||"")===r);return n||i.customers.find(o=>ae(o.customerName||o.name||"").includes(r))||null}function ts(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Ds(){t.form=document.getElementById("project-form"),t.title=document.getElementById("project-title"),t.type=document.getElementById("project-type"),t.client=document.getElementById("project-client"),t.clientSuggestions=document.getElementById("project-customer-suggestions"),t.clientCompany=document.getElementById("project-client-company"),t.paymentStatus=document.getElementById("project-payment-status"),t.startDate=document.getElementById("project-start-date"),t.startTime=document.getElementById("project-start-time"),t.endDate=document.getElementById("project-end-date"),t.endTime=document.getElementById("project-end-time"),t.description=document.getElementById("project-description"),t.technicianSelect=document.getElementById("project-technician-select"),t.addTechnicianBtn=document.getElementById("add-technician-btn"),t.technicianList=document.getElementById("project-technician-list"),t.equipmentSelect=document.getElementById("project-equipment-select"),t.equipmentQty=document.getElementById("project-equipment-qty"),t.addEquipmentBtn=document.getElementById("add-equipment-btn"),t.equipmentList=document.getElementById("project-equipment-list"),t.expenseLabel=document.getElementById("project-expense-label"),t.expenseAmount=document.getElementById("project-expense-amount"),t.expenseNote=document.getElementById("project-expense-note"),t.addExpenseBtn=document.getElementById("add-expense-btn"),t.expenseList=document.getElementById("project-expense-list"),t.servicesClientTotalIndicator=document.getElementById("project-services-client-total-indicator"),t.servicesClientTotalValue=document.getElementById("project-services-client-total-value"),t.discountType=document.getElementById("project-discount-type"),t.discountValue=document.getElementById("project-discount"),t.servicesClientPrice=document.getElementById("project-services-client-price"),t.paymentAddButton=document.getElementById("project-payment-add"),t.paymentHistory=document.getElementById("project-payment-history"),t.companyShare=document.getElementById("project-company-share"),t.paymentProgressType=document.getElementById("project-payment-progress-type"),t.paymentProgressValue=document.getElementById("project-payment-progress-value"),t.taxCheckbox=document.getElementById("project-tax"),t.linkedReservationBtn=document.getElementById("project-linked-reservation-btn"),t.submitBtn=t.form?.querySelector('[type="submit"]'),t.projectsTableBody=document.getElementById("project-table-body"),t.projectsCount=document.getElementById("projects-count"),t.projectsUpcoming=document.getElementById("projects-upcoming"),t.projectsExpenses=document.getElementById("projects-expenses"),t.projectsBudget=document.getElementById("projects-budget"),t.tableCount=document.getElementById("project-table-count"),t.search=document.getElementById("project-search"),t.detailsModalEl=document.getElementById("projectDetailsModal"),t.detailsBody=document.getElementById("project-details-body"),t.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),t.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),t.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),t.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),t.timeline=document.getElementById("project-timeline"),t.focusCards=document.getElementById("project-focus-cards"),t.detailsModalEl&&!t.detailsModalEl.dataset.projectListenerAttached&&(t.detailsModalEl.addEventListener("hidden.bs.modal",()=>{t.detailsBody&&(t.detailsBody.dataset.projectId="")}),t.detailsModalEl.dataset.projectListenerAttached="true")}function Ls(){const e=ts();if(!e)return;const s=[["#project-start-date",{dateFormat:"Y-m-d",allowInput:!0}],["#project-end-date",{dateFormat:"Y-m-d",allowInput:!0}]],r=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,allowInput:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,allowInput:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...s,...r].forEach(([a,l])=>{const c=document.querySelector(a);c&&e(c,l)});const n=a=>{if(a==null)return"";const l=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"],c=["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"],d=["0","1","2","3","4","5","6","7","8","9"];return String(a).split("").map(f=>{const j=l.indexOf(f);if(j>-1)return d[j];const m=c.indexOf(f);return m>-1?d[m]:f}).join("")},o=a=>{if(!a||a.dataset.normalizedDigits==="true")return;const l=()=>{const c=a.value||"",d=n(c);if(d!==c){const f=a.selectionStart,j=a.selectionEnd;a.value=d;try{if(typeof f=="number"&&typeof j=="number"){const m=d.length-c.length;a.setSelectionRange(Math.max(0,f+m),Math.max(0,j+m))}}catch{}}};a.addEventListener("input",l),a.addEventListener("blur",l);try{a.setAttribute("inputmode","numeric")}catch{}a.dataset.normalizedDigits="true"};o(t.startDate),o(t.endDate),o(t.startTime),o(t.endTime),t.startTime&&t.startTime._flatpickr?.altInput&&o(t.startTime._flatpickr.altInput),t.endTime&&t.endTime._flatpickr?.altInput&&o(t.endTime._flatpickr.altInput)}function ot(){["startDate","startTime","endDate","endTime"].forEach(e=>{const s=t[e];s&&(s._flatpickr?s._flatpickr.clear():s.value="")})}function Rs(){const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Lt()),e.dataset.listenerAttached="true")}function z(e){if(!e?.start)return Number.NaN;const s=new Date(e.start).getTime();return Number.isFinite(s)?s:Number.NaN}function Te(e){if(e?.createdAt){const r=new Date(e.createdAt).getTime();if(Number.isFinite(r))return r}const s=z(e);return Number.isFinite(s)?s:Number.NEGATIVE_INFINITY}function Bs(e,s){if(!e)return"";const r=s&&/\d{1,2}:\d{2}/.test(s)?s:"00:00",[n="00",o="00"]=r.split(":"),a=n.padStart(2,"0"),l=o.padStart(2,"0");return`${e}T${a}:${l}`}function it(e,s){const r=String(e||"");return r.length<=s?r:`${r.slice(0,Math.max(0,s-1))}…`}function Fs(e){if(!e||typeof e!="string")return{date:"",time:""};let s=e.trim();if(!s)return{date:"",time:""};if(s.includes(" ")&&(s=s.replace(" ","T")),!s.includes("T"))return{date:s,time:""};const[r,n=""]=s.split("T");return{date:r,time:n}}function we(e){if(!e)return p("projects.form.types.unknown","نوع غير محدد");const s={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return p(s,e)}function oe(){if(!t.projectsTableBody)return;const e=i.filters.search,s=i.projects.filter(n=>{if(!e)return!0;const o=i.customers.find(l=>String(l.id)===String(n.clientId));return y([n.title,n.description,o?.customerName,n.clientCompany,we(n.type),n.id,n.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(e)});if(!s.length){const n=i.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",o=i.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",a=u(p(n,o));t.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${a}</td></tr>`,ze(0),i.visibleProjects=[],We([]);return}const r=[...s].sort((n,o)=>{const a=Te(n),l=Te(o);if(Number.isFinite(a)&&Number.isFinite(l)&&a!==l)return l-a;const c=z(n),d=z(o);return Number.isFinite(c)&&Number.isFinite(d)?d-c:0});i.visibleProjects=r,ze(r.length),t.projectsTableBody.innerHTML=r.map(n=>ss(n)).join(""),We(r),Ae()}function ss(e){const s=i.customers.find(E=>String(E.id)===String(e.clientId)),r=s?.customerName||p("projects.fallback.unknownClient","عميل غير معروف"),n=(e.clientCompany||s?.companyName||"").trim(),o=e.technicians?.length||0,a=(e.equipment||[]).reduce((E,A)=>E+(A.qty||0),0),{expensesTotal:l,totalWithTax:c}=Ce(e),f=Ve(e.id).length,m=p("projects.table.reservationsCount","{count} حجوزات").replace("{count}",y(String(f))),h=f?`<span class="badge rounded-pill project-reservations-chip">${u(m)}</span>`:"",S=`<span class="badge project-type-badge">${u(we(e.type))}</span>`,b=e.projectCode||`PRJ-${y(String(e.id))}`,P=`<span class="project-code-badge">#${u(b)}</span>`,_=Ze()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${e.id}">${u(p("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${e.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${u(e.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${P}
            ${S}
          </div>
        </div>
        ${h}
      </td>
      <td>
        ${n?`<div class="d-flex flex-column"><span>${u(r)}</span><small class="text-muted">${u(n)}</small></div>`:u(r)}
      </td>
      <td>${rs(e.start,e.end)}</td>
      <td>${y(String(o))}</td>
      <td>${y(String(a))}</td>
      <td>${D(c)}</td>
      <td>${D(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${e.id}">${u(p("actions.view","عرض"))}</button>
        ${_}
      </td>
    </tr>
  `}function rs(e,s){if(!e)return"—";const r=W(e),n=s?W(s):"",o=d=>{const f=String(d).split(" ").filter(Boolean),j=f.shift()||"",m=f.join(" ");return{date:j,time:m}},a=o(r),l=n?o(n):{date:"",time:""};if(l.date&&a.date===l.date){const d=a.time&&l.time?`من ${a.time} إلى ${l.time}`:"";return`
      <div class="date-range">
        <div class="date-line">${a.date}</div>
        ${d?`<div class="time-line">${d}</div>`:""}
      </div>
    `}const c=a.time&&l.time?`من ${a.time} إلى ${l.time}`:"";return`
    <div class="date-range">
      <div class="date-line">${a.date}</div>
      ${l.date?`<div class="date-line">${l.date}</div>`:""}
      ${c?`<div class="time-line">${c}</div>`:""}
    </div>
  `}function ns(e,s){if(!e)return{dateHtml:"—",timeText:""};const r=W(e),n=s?W(s):"",o=f=>{const j=String(f).split(" ").filter(Boolean),m=j.shift()||"",h=j.join(" ");return{date:m,time:h}},a=o(r),l=n?o(n):{date:"",time:""};let c="",d="";return l.date&&a.date===l.date?(c=`<div class="date-range"><div class="date-line">${a.date}</div></div>`,d=`من ${a.time||"—:—"} إلى ${l.time||"—:—"}`):(c=`<div class="date-range"><div class="date-line">${a.date}</div>`+(l.date?`<div class="date-line">${l.date}</div>`:"")+"</div>",d=`من ${a.time||"—:—"} إلى ${l.time||"—:—"}`),{dateHtml:c,timeText:d}}function We(e){if(!t.timeline)return;const r=(Array.isArray(e)?e:i.visibleProjects.length?i.visibleProjects:i.projects).map(m=>{if(!m?.start)return null;const h=new Date(m.start);if(Number.isNaN(h.getTime()))return null;let g=m.end?new Date(m.end):new Date(h);return Number.isNaN(g.getTime())&&(g=new Date(h)),g<=h&&(g=new Date(h.getTime()+xe)),{project:m,startDate:h,endDate:g}}).filter(Boolean).sort((m,h)=>m.startDate-h.startDate);if(!r.length){const m=u(p("projects.timeline.empty",t.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));t.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${m}</div>`;return}const n=r[0].startDate.getTime(),o=Math.max(...r.map(m=>m.endDate.getTime()));let a=o-n;a<=0&&(a=xe);const l=as(r),c=p("projects.timeline.range","{start} → {end}"),d=p("projects.timeline.conflict","Scheduling conflict"),f=r.map(m=>{const{project:h,startDate:g,endDate:S}=m,b=S.getTime()-g.getTime();let P=(g.getTime()-n)/a*100;P=Math.max(0,Math.min(P,100));let w=b/a*100;w=Math.max(w,2.5),P+w>100&&(w=Math.max(1.5,100-P));const E=`project-timeline__item--${ct(h)}`,A=l.has(h.id),q=(h.title||"").trim()||p("projects.fallback.untitled","Untitled project"),L=it(q,26),U=i.customers.find(ee=>String(ee.id)===String(h.clientId)),R=U?.customerName||p("projects.fallback.unknownClient","Unknown client"),k=(h.clientCompany||U?.companyName||"").trim(),O=we(h.type),I=W(g.toISOString()),X=W(S.toISOString()),le=c.replace("{start}",I).replace("{end}",X),B=k?`${R} (${k})`:R,H=`${q} • ${O} • ${B} | ${le}`,Z=A?`<span class="project-timeline__item-conflict" title="${u(d)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${E}${A?" project-timeline__item--conflict":""}" style="left:${P}%;width:${w}%;" title="${u(H)}">
          <span class="project-timeline__item-label">${u(L)}</span>
          ${Z}
        </div>
      `}).join(""),j=`
    <div class="project-timeline__scale">
      <span>${u(W(new Date(n).toISOString()))}</span>
      <span>${u(W(new Date(o).toISOString()))}</span>
    </div>
  `;t.timeline.innerHTML=`
    ${j}
    <div class="project-timeline__track">
      ${f}
    </div>
  `}function as(e){const s=new Set;for(let r=0;r<e.length;r+=1)for(let n=r+1;n<e.length;n+=1){const o=e[r],a=e[n];o.startDate<a.endDate&&a.startDate<o.endDate&&(s.add(o.project.id),s.add(a.project.id))}return s}function Ae(){if(!t.focusCards)return;const e=os();if(!e.length){const s=u(p("projects.focus.empty",t.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));t.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${s}</div></div>`;return}t.focusCards.innerHTML=e.join("")}function os(){if(!Array.isArray(i.projects)||!i.projects.length)return[];const e=i.projects.filter(Ke),s=i.projects.filter(a=>!Ke(a)&&cs(a)),r=[],n=new Set,o=(a,l)=>{!a||n.has(a.id)||r.length>=De||(n.add(a.id),r.push(is(a,l)))};if(e.sort((a,l)=>z(a)-z(l)).forEach(a=>o(a,"today")),s.sort((a,l)=>z(a)-z(l)).forEach(a=>o(a,"thisWeek")),r.length<De){const a=Date.now();[...i.projects].filter(c=>!n.has(c.id)).filter(c=>{const d=z(c);return Number.isFinite(d)&&d>=a}).sort((c,d)=>z(c)-z(d)).forEach(c=>o(c,"upcoming"))}return r.length<De&&[...i.projects].filter(l=>!n.has(l.id)).sort((l,c)=>Te(c)-Te(l)).forEach(l=>o(l,"recent")),r}function is(e,s){const r=i.customers.find(T=>String(T.id)===String(e.clientId)),n=r?.customerName||p("projects.fallback.unknownClient","عميل غير معروف");(e.clientCompany||r?.companyName||"").trim();const o=Array.isArray(e.technicians)?e.technicians.length:0,a=Ve(e.id),l=a.length;lt(e);const c=Number(e?.servicesClientPrice??0),{applyTax:d}=Ce(e),f=(e.description||"").trim(),j=f?it(f,110):p("projects.fallback.noDescription","لا يوجد وصف"),m=we(e.type),h=typeof e.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",g=["paid","partial"].includes(h)?h:"unpaid",S=p(`projects.paymentStatus.${g}`,g==="paid"?"Paid":g==="partial"?"Partially Paid":"Unpaid"),b=g==="paid"?"status-paid":g==="partial"?"status-partial":"status-unpaid",P=g==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",w=e.confirmed===!0||e.confirmed==="true",_=u(String(e.id)),E=e.projectCode||`PRJ-${y(String(e.id))}`,A=y(E),q={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},L={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},U=q[s]||q.recent;p(U,L[s]||L.recent);const R=ct(e),k=e?.cancelled===!0||e?.status==="cancelled"||e?.status==="canceled"?"cancelled":R;p(`projects.status.${k}`,Bt[k]||k);const I=(()=>{try{const T=e.start?new Date(e.start):null,v=e.end?new Date(e.end):T?new Date(T.getTime()+xe):null;return!T||!v||Number.isNaN(T.getTime())||Number.isNaN(v.getTime())?!1:i.projects.some(N=>{if(!N||String(N.id)===String(e.id))return!1;const M=N.start?new Date(N.start):null,V=N.end?new Date(N.end):M?new Date(M.getTime()+xe):null;if(!M||!V||Number.isNaN(M.getTime())||Number.isNaN(V.getTime()))return!1;const ne=Math.max(T.getTime(),M.getTime()),qe=Math.min(v.getTime(),V.getTime());return ne<qe})}catch{return!1}})()&&(k==="upcoming"||k==="ongoing")?"conflict":k,X=I==="upcoming"?"timeline-status-badge timeline-status-badge--upcoming":I==="ongoing"?"timeline-status-badge timeline-status-badge--ongoing":I==="completed"?"timeline-status-badge timeline-status-badge--completed":I==="cancelled"?"timeline-status-badge timeline-status-badge--cancelled":"timeline-status-badge timeline-status-badge--conflict",le=(e.title||"").trim()||p("projects.fallback.untitled","Untitled project"),B=I==="cancelled"?[]:[P];I==="cancelled"?B.push("project-focus-card--cancelled"):w&&B.push("project-focus-card--confirmed");const H=a.reduce((T,v)=>{const N=Array.isArray(v.items)?v.items:[],M=Array.isArray(v.crewAssignments)?v.crewAssignments:[],V=M.length?M:Array.isArray(v.technicians)?v.technicians:[],ne=Ot({items:N,technicianIds:Array.isArray(V)&&!V.length?V:[],crewAssignments:Array.isArray(V)&&V.length&&typeof V[0]=="object"?V:[],discount:v.discount??0,discountType:v.discountType||"percent",applyTax:!1,start:v.start,end:v.end,companySharePercent:null}),qe=He(v),_t=(v.items||[]).reduce(($t,qt)=>$t+(Number(qt?.qty)||1),0),It=(v.technicians||[]).length;return{netTotal:T.netTotal+qe,equipmentMoney:T.equipmentMoney+Number(ne.equipmentTotal||0),crewMoney:T.crewMoney+Number(ne.crewTotal||0),equipmentCount:T.equipmentCount+_t,crewCount:T.crewCount+It}},{netTotal:0,equipmentMoney:0,crewMoney:0,equipmentCount:0,crewCount:0}),Z=Number(H.netTotal.toFixed(2)),ee=H.equipmentCount,_e=H.crewCount||o,te=Number(c||0),se=Number((H.equipmentMoney+H.crewMoney+te).toFixed(2)),be=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let F=(e?.discountType==="amount"?"amount":"percent")==="amount"?be:se*(be/100);(!Number.isFinite(F)||F<0)&&(F=0),F>se&&(F=se);const de=Math.max(0,se-F),Ie=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",ue=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,C=Ie&&ue>0?ue:0,me=Number((de*(C/100)).toFixed(2)),J=d?Number(((de+me)*Me).toFixed(2)):0,re=Number((de+me+J).toFixed(2)),je=`<span class="project-code-badge project-focus-card__code">#${u(A)}</span>`,bt="",vt="",St=p(`projects.status.${I}`,I),xt=`<span class="${X}">${u(St)}</span>`,Tt=`<span class="reservation-chip ${b} project-focus-card__payment-chip">${u(S)}</span>`,$e=(T,v,N)=>{const M=String(N||""),ne=M.trim().startsWith("<");return`
      <div class="project-focus-card__row">
        <span class="project-focus-card__row-label">
          ${T?`<span class="project-focus-card__row-icon">${u(T)}</span>`:""}
          ${u(v)}
        </span>
        <span class="project-focus-card__row-value">${ne?M:u(M)}</span>
      </div>
    `},{dateHtml:Ct,timeText:Oe}=ns(e.start,e.end),Pt=[{icon:"👤",label:p("projects.details.client","العميل"),value:n},{icon:"🏷️",label:p("projects.details.type","نوع المشروع"),value:`<span class="project-type-chip project-type-chip--${e.type||"default"}">${u(m)}</span>`},{icon:"📅",label:p("projects.focus.summary.range","الفترة الزمنية"),value:Ct},Oe?{icon:"⏰",label:p("projects.focus.summary.time","الوقت"),value:Oe}:null].filter(Boolean).map(({icon:T,label:v,value:N})=>$e(T,v,N)).join(""),wt=C>0&&d?` ${p("projects.details.chips.vatOn","(شامل الضريبة)")}`:"",At=`${p("projects.details.summary.finalTotal","المجموع النهائي")}${wt}`,kt=[{icon:"💼",label:p("projectCards.stats.servicesClientPrice","الخدمات الإنتاجية"),value:D(c)},{icon:"💵",label:At,value:D(re)}].map(({icon:T,label:v,value:N})=>$e(T,v,N)).join(""),Et=[{icon:"🔗",label:p("projectCards.stats.reservationsShort","الحجوزات"),value:y(String(l))},{icon:"📦",label:p("projectCards.stats.equipmentCount","عدد المعدات"),value:y(String(ee))},{icon:"😎",label:p("projectCards.stats.crewCount","عدد الطاقم"),value:y(String(_e))},{icon:"💵",label:p("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:D(Z)}].map(({icon:T,label:v,value:N})=>$e(T,v,N)).join(""),Nt=I==="cancelled"?`<span class="reservation-chip status-cancelled project-focus-card__confirm-indicator">${u(p("projects.focus.cancelled","مشروع ملغي"))}</span>`:w?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${u(p("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${_}">${u(p("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`;return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${B.filter(Boolean).join(" ")}" data-project-id="${_}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${je}
          ${bt}
          ${vt}
          ${xt}
          ${Tt}
        </div>
        <h6 class="project-focus-card__title">${u(le)}</h6>
        <p class="project-focus-card__description">${u(j)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${u(p("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${Pt}
            </div>
          </div>
          <!-- Show reservations above the financial summary -->
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${u(p("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${Et}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${u(p("projects.focus.summary.payment","الملخص المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${kt}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${Nt}
        </div>
      </article>
    </div>
  `}function Ke(e){if(!e?.start)return!1;const s=new Date(e.start);if(Number.isNaN(s.getTime()))return!1;const r=new Date;return s.getFullYear()===r.getFullYear()&&s.getMonth()===r.getMonth()&&s.getDate()===r.getDate()}function cs(e){if(!e?.start)return!1;const s=new Date(e.start);if(Number.isNaN(s.getTime()))return!1;const r=new Date,n=new Date(r);n.setHours(0,0,0,0);const o=n.getDay(),a=o===0?6:o-1;n.setDate(n.getDate()-a);const l=new Date(n);return l.setDate(l.getDate()+7),s>=n&&s<l}function ct(e){const s=new Date,r=e.start?new Date(e.start):null,n=e.end?new Date(e.end):null;return r&&!Number.isNaN(r.getTime())&&r>s?"upcoming":n&&!Number.isNaN(n.getTime())&&n<s?"completed":"ongoing"}function lt(e){return typeof e.expensesTotal=="number"?e.expensesTotal:Array.isArray(e.expenses)?e.expenses.reduce((s,r)=>s+(Number(r.amount)||0),0):0}function Ce(e){const s=Number(e?.equipmentEstimate)||0,r=lt(e),n=s+r,o=e?.applyTax===!0||e?.applyTax==="true",a=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let c=(e?.discountType==="amount"?"amount":"percent")==="amount"?a:n*(a/100);(!Number.isFinite(c)||c<0)&&(c=0),c>n&&(c=n);const d=Math.max(0,n-c),f=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",j=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,m=f&&o&&j>0?j:0,h=m>0?Number((d*(m/100)).toFixed(2)):0,g=d+h;let S=o?g*Me:0;(!Number.isFinite(S)||S<0)&&(S=0),S=Number(S.toFixed(2));let b=o?Number(e?.totalWithTax):g;return o?(!Number.isFinite(b)||b<=0)&&(b=Number((g+S).toFixed(2))):b=g,{equipmentEstimate:s,expensesTotal:r,baseSubtotal:n,discountAmount:c,subtotalAfterDiscount:d,companyShareAmount:h,subtotal:g,applyTax:o,taxAmount:S,totalWithTax:b}}function ke(){const e=i.projects.length,s=i.projects.filter(o=>{const a=o.start?new Date(o.start):null;return!a||Number.isNaN(a.getTime())?!1:a>new Date}).length,r=i.projects.reduce((o,a)=>o+Ce(a).expensesTotal,0),n=i.projects.reduce((o,a)=>o+Ce(a).totalWithTax,0);t.projectsCount&&(t.projectsCount.textContent=y(String(e))),t.projectsUpcoming&&(t.projectsUpcoming.textContent=y(String(s))),t.projectsExpenses&&(t.projectsExpenses.textContent=D(r)),t.projectsBudget&&(t.projectsBudget.textContent=D(n))}function Ve(e){return e?i.reservations.filter(s=>{const r=s?.projectId??s?.project_id??null;return r!=null&&String(r)===String(e)}):[]}function He(e){if(!e)return 0;const s=Array.isArray(e.items)?e.items:[],r=e.discount??0,n=Number(y(String(r)))||0,o=e.discountType||"percent",a=Array.isArray(e.crewAssignments)?e.crewAssignments:[],l=a.length?a:Array.isArray(e.technicians)?e.technicians:[],c=Ut(s,n,o,!1,l,{start:e.start,end:e.end});if(Number.isFinite(c))return c;const d=Number(y(String(e.cost??0)));return Number.isFinite(d)?Math.round(d):0}function ls(e,s,r=null){if(!e)return"";const n=e.reservationId||e.id||`RES-${s+1}`,o=e.status||e.state||"pending",a=String(o).toLowerCase(),{effectiveConfirmed:l}=rt(e,r),c=l?"confirmed":a,d=p(`reservations.list.status.${c}`,c==="confirmed"?"✅ مؤكد":c==="pending"?"⏳ غير مؤكد":c),j={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[c]||"project-reservation-card__badge--info",m=typeof r?.paymentStatus=="string"?r.paymentStatus.toLowerCase():null,h=m&&["paid","partial","unpaid"].includes(m)?m:String(e.paidStatus||e.paymentStatus||(e.paid?"paid":"unpaid")).toLowerCase(),g=h==="paid"?"paid":h==="partial"?"partial":"unpaid",S=g==="paid"?p("reservations.list.payment.paid","💳 مدفوع"):g==="partial"?p("reservations.list.payment.partial","💳 مدفوع جزئياً"):p("reservations.list.payment.unpaid","💳 غير مدفوع"),b=g==="paid"?"project-reservation-card__badge--paid":g==="partial"?"project-reservation-card__badge--partial":"project-reservation-card__badge--unpaid",P=e.completed===!0||e.completed==="true",w=p("reservations.details.completed","مكتمل"),_=P?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${u(w)}</span>`:"",E=He(e),A=D(E),q=(e.items||[]).reduce((O,I)=>O+(Number(I?.qty)||1),0),L=(e.technicians||[]).length,U=p("projectCards.stats.crewCount","عدد الطاقم"),R=p("projectCards.stats.equipmentCount","عدد المعدات"),k=p("projectCards.stats.reservationTotal","إجمالي الحجز");return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${s}" data-reservation-index="${s}" data-project-id="${r?r.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${u(n)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${j}">${u(d)}</span>
          <span class="project-reservation-card__badge ${b}">${u(S)}</span>
          ${_}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__meta project-reservation-card__meta--vertical">
          <span>😎 ${u(U)}: ${y(String(L))}</span>
          <span>📦 ${u(R)}: ${y(String(q))}</span>
          <span>💵 ${u(k)}: ${u(A)}</span>
        </div>
      </div>
    </article>
  `}function Ms(e){const s=Ve(e.id).map(a=>{const l=a?.id??a?.reservationId??a?.reservation_code??a?.reservation_id,c=i.reservations.findIndex(d=>{const f=d?.id??d?.reservationId??d?.reservation_code??d?.reservation_id;return l!=null&&f!=null&&String(f)===String(l)});return{reservation:a,index:c}}).filter(({index:a})=>Number.isInteger(a)&&a>=0).sort((a,l)=>{const c=a.reservation.start?new Date(a.reservation.start).getTime():0;return(l.reservation.start?new Date(l.reservation.start).getTime():0)-c}),r=p("projects.details.reservations.title","الحجوزات المرتبطة"),n=p("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),o=s.length?`<div class="project-reservations-list">${s.map(({reservation:a,index:l})=>ls(a,l,e)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${u(n)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${u(r)}</h6>
      </div>
      ${o}
    </section>
  `}async function ps(e){if(i.projects.findIndex(o=>String(o.id)===String(e))===-1)return;let r=0;try{r=($()||[]).filter(a=>String(a.projectId)===String(e)).length}catch{}const n=r>0?p("projects.confirm.deleteCascade",`⚠️ سيتم حذف المشروع وجميع الحجوزات المرتبطة به (${r}). هل أنت متأكد؟`):p("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟");if(window.confirm(n))try{try{const a=($()||[]).filter(l=>String(l.projectId)===String(e));for(const l of a){const c=l.id??l.reservationId??l.reservation_code;if(c)try{await zt(c)}catch(d){console.warn("⚠️ failed to delete linked reservation",c,d)}}}catch{}await Ft(e),await tt(),await nt(),i.projects=Fe(),i.reservations=$(),oe(),ke(),Ae(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),x(p("projects.toast.deleted","🗑️ تم حذف المشروع والحجوزات المرتبطة به"))}catch(o){console.error("❌ [projects] removeProject failed",o);const a=st(o)?o.message:p("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");x(a,"error")}}async function Vs(e,{start:s=null,end:r=null}={}){if(!e)return!1;const o=$().filter(c=>String(c.projectId)===String(e));if(!o.length)return!1;let a=!1,l=0;for(const c of o){const d=c.id??c.reservationId;if(!d)continue;const f=String(c.status||"").toLowerCase();if(f==="completed"||f==="cancelled"||f==="canceled")continue;const j={};if(s&&(j.start_datetime=s),r&&(j.end_datetime=r),Object.keys(j).length!==0)try{await ge(d,j),a=!0,l+=1}catch(m){console.warn("[projects] failed to update linked reservation schedule",d,m)}}if(a){i.reservations=$();try{document.dispatchEvent(new CustomEvent("reservations:changed"))}catch{}try{const c=p("projects.toast.linkedReservationsScheduleUpdated","تم تحديث توقيت الحجوزات المرتبطة ({count})","Updated linked reservations timing ({count})").replace("{count}",String(l));x(c)}catch{}}return a}async function ds(e,s){if(!e)return!1;const n=$().filter(d=>String(d.projectId)===String(e));if(!n.length)return!1;const o=typeof s=="string"?s.toLowerCase():"unpaid",a=o==="paid",l=a?"paid":o==="partial"?"partial":"unpaid";let c=!1;for(const d of n){const f=d.id??d.reservationId;if(!f)continue;const j=d.paid===!0||d.paid==="paid",m=d.paidStatus||d.paymentStatus||(j?"paid":"unpaid");j===a&&m===l||(await ge(f,{paid_status:l,paid:a}),c=!0)}return c&&(i.reservations=$()),c}async function Hs(e){if(!e)return!1;const s=$(),r=i.projects.find(a=>String(a.id)===String(e))||(Q().projects||[]).find?.(a=>String(a.id)===String(e))||null,n=s.filter(a=>String(a.projectId)===String(e));if(!n.length)return!1;let o=!1;for(const a of n){const l=a.id??a.reservationId;if(!l)continue;const c=rt({...a,projectId:e},r);if(c.effectiveConfirmed)continue;const d=r?.status??c.projectStatus??"confirmed";await ge(l,{confirmed:!0,status:d}),o=!0}return o&&(i.reservations=$()),o}async function Je(e,s){if(!e)return!1;const r=await ds(e,s);return r&&document.dispatchEvent(new CustomEvent("reservations:changed")),r}async function Us(e){if(!e)return!1;const r=$().filter(o=>String(o.projectId)===String(e));if(!r.length)return!1;let n=!1;for(const o of r){const a=o.id??o.reservationId;if(a)try{await ge(a,{status:"cancelled",cancelled:!0}),n=!0}catch(l){console.warn("[projects] failed to cancel linked reservation",a,l)}}return n&&(i.reservations=$(),document.dispatchEvent(new CustomEvent("reservations:changed"))),n}let Le=!1;const Ee="projects:create:draft",us="projects.html#projects-section";let ve=!1,K=[];function pt(e){return e?e instanceof HTMLElement?e:typeof e=="string"?document.getElementById(e):null:null}function Os(e=t.companyShare){const s=pt(e);if(!s||s.checked!==!0)return null;const r=s.dataset.companyShare??s.value??Y,n=y(String(r).replace("%","").trim()),o=Number.parseFloat(n);return!Number.isFinite(o)||o<=0?Y:o}function Ye(e=t.companyShare,s=Y){const r=pt(e);if(!r)return;const n=r.dataset.companyShare??r.value??s,o=y(String(n).replace("%","").trim());let a=Number.parseFloat(o);(!Number.isFinite(a)||a<=0)&&(a=s),r.dataset.companyShare=String(a),r.checked=!0}function fe(e){const s=t.taxCheckbox,r=t.companyShare;if(!s||!r||ve)return;ve=!0;const n=()=>{x(p("projects.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"))};if(e==="share")if(r.checked){if(s.disabled){r.checked=!1,n(),ve=!1;return}s.checked||(s.checked=!0),Ye(r)}else s.checked&&!s.disabled&&(s.checked=!1);else e==="tax"&&(s.checked?Ye(r):r.checked&&(r.checked=!1));ve=!1}function ms({equipmentEstimate:e=0,expensesTotal:s=0,servicesClientPrice:r=0,discountValue:n=0,discountType:o="percent",applyTax:a=!1,companyShareEnabled:l=!1,companySharePercent:c=null}={}){const d=Number(e)+Number(r),f=Number.isFinite(Number(n))?Number(n):0;let j=0;o==="amount"?j=f:j=d*(f/100),(!Number.isFinite(j)||j<0)&&(j=0),j>d&&(j=d);const m=Math.max(0,d-j),h=l&&a&&Number.isFinite(Number(c))&&Number(c)>0?Number(c):0,g=h>0?Number((m*(h/100)).toFixed(2)):0,S=m+g;let b=a?S*Me:0;(!Number.isFinite(b)||b<0)&&(b=0),b=Number(b.toFixed(2));const P=Number((S+b).toFixed(2));return{baseSubtotal:d,discountAmount:j,subtotalAfterDiscount:m,companyShareAmount:g,taxableAmount:S,taxAmount:b,totalWithTax:P}}function zs(){t.form&&!t.form.dataset.listenerAttached&&(t.form.addEventListener("submit",xs),t.form.dataset.listenerAttached="true"),t.form&&!t.form.dataset.resetListenerAttached&&(t.form.addEventListener("reset",()=>{t.client&&(t.client.dataset.customerId=""),ye(),ot(),t.type&&(t.type.value=""),G(null),ht(),dt()}),t.form.dataset.resetListenerAttached="true"),js(),fs(),t.search&&!t.search.dataset.listenerAttached&&(t.search.addEventListener("input",()=>{i.filters.search=y(t.search.value||"").trim().toLowerCase(),oe()}),t.search.dataset.listenerAttached="true")}function dt(){Jt(),i.editingProjectId=null,t.form&&(delete t.form.dataset.editingId,t.form.dataset.mode="create"),ie(),t.expenseLabel&&(t.expenseLabel.value=""),t.expenseAmount&&(t.expenseAmount.value=""),i.servicesClientPriceTotal=0,t.servicesClientPrice&&(t.servicesClientPrice.value=""),t.taxCheckbox&&(t.taxCheckbox.checked=!1),t.discountType&&(t.discountType.value="percent"),t.discountValue&&(t.discountValue.value=""),t.companyShare&&(t.companyShare.checked=!1,t.companyShare.dataset.companyShare=String(Y)),t.paymentStatus&&(t.paymentStatus.value="unpaid"),t.paymentStatus?.dataset&&delete t.paymentStatus.dataset.userSelected,t.paymentProgressType&&(t.paymentProgressType.value="percent"),t.paymentProgressValue&&(t.paymentProgressValue.value=""),K=[],t.paymentHistory&&(t.paymentHistory.innerHTML=""),yt(),he(),fe("tax"),ce()}function Ws(){t.addTechnicianBtn&&t.addTechnicianBtn.dataset.listenerAttached!=="true"&&(t.addTechnicianBtn.addEventListener("click",ys),t.addTechnicianBtn.dataset.listenerAttached="true"),t.addEquipmentBtn&&t.addEquipmentBtn.dataset.listenerAttached!=="true"&&(t.addEquipmentBtn.addEventListener("click",hs),t.addEquipmentBtn.dataset.listenerAttached="true")}function Ks(){Re(t.technicianList,e=>{if(e.matches('[data-action="remove-technician"]')){const s=e.dataset.id;i.selectedTechnicians=i.selectedTechnicians.filter(r=>r!==s),ut()}}),Re(t.equipmentList,e=>{if(e.matches('[data-action="remove-equipment"]')){const s=e.dataset.id;i.selectedEquipment=i.selectedEquipment.filter(r=>r.barcode!==s),mt()}}),Re(t.expenseList,e=>{if(e.matches('[data-action="remove-expense"]')){const s=e.dataset.id;i.expenses=i.expenses.filter(r=>String(r.id)!==String(s)),jt(),ke(),gt(),ce()}})}function js(){t.discountValue&&t.discountValue.dataset.listenerAttached!=="true"&&(t.discountValue.addEventListener("input",e=>{const s=e.target;s instanceof HTMLInputElement&&(s.value=y(s.value||""))}),t.discountValue.dataset.listenerAttached="true"),t.companyShare&&t.companyShare.dataset.listenerAttached!=="true"&&(t.companyShare.addEventListener("change",()=>{fe("share")}),t.companyShare.dataset.listenerAttached="true"),t.taxCheckbox&&t.taxCheckbox.dataset.projectListenerAttached!=="true"&&(t.taxCheckbox.addEventListener("change",()=>{fe("tax")}),t.taxCheckbox.dataset.projectListenerAttached="true"),t.paymentStatus&&t.paymentStatus.dataset.billingListenerAttached!=="true"&&(t.paymentStatus.addEventListener("change",()=>{t.paymentStatus.dataset.userSelected="true"}),t.paymentStatus.dataset.billingListenerAttached="true"),t.paymentProgressValue&&t.paymentProgressValue.dataset.listenerAttached!=="true"&&(t.paymentProgressValue.addEventListener("input",e=>{const s=e.target;s instanceof HTMLInputElement&&(s.value=y(s.value||""))}),t.paymentProgressValue.dataset.listenerAttached="true"),t.servicesClientPrice&&t.servicesClientPrice.dataset.normalizeAttached!=="true"&&(t.servicesClientPrice.addEventListener("input",e=>{const s=e.target;if(!(s instanceof HTMLInputElement))return;const r=s.selectionStart,n=y(s.value||"");if(s.value=n,r!=null){const o=Math.min(n.length,r);s.setSelectionRange(o,o)}}),t.servicesClientPrice.dataset.normalizeAttached="true"),fe(t.companyShare?.checked?"share":"tax"),ce()}function Ge(){const e=t.paymentHistory;if(!e)return;const s=Array.isArray(K)?K:[];if(!s.length){e.innerHTML=`<div class="reservation-payment-history__empty">${u(p("reservations.paymentHistory.empty","لا توجد دفعات مسجلة"))}</div>`;return}const r=s.map((n,o)=>{const a=Number.isFinite(Number(n?.amount))&&Number(n.amount)>0?D(Number(n.amount)):"—",l=Number.isFinite(Number(n?.percentage))&&Number(n.percentage)>0?`${y(Number(n.percentage).toFixed(2))}%`:"—",c=n?.recordedAt?y(W(n.recordedAt)):"—",d=n?.type==="percent"?p("reservations.paymentHistory.type.percent","٪ دفعة نسبة"):p("reservations.paymentHistory.type.amount","💵 دفعة مالية");return`
      <tr>
        <td>${u(d)}</td>
        <td>${u(a)}</td>
        <td>${u(l)}</td>
        <td>${u(c)}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${o}" aria-label="${u(p("reservations.paymentHistory.actions.delete","حذف الدفعة"))}">🗑️</button>
        </td>
      </tr>`}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${u(p("reservations.paymentHistory.headers.method","نوع الدفعة"))}</th>
            <th>${u(p("reservations.paymentHistory.headers.amount","المبلغ"))}</th>
            <th>${u(p("reservations.paymentHistory.headers.percent","النسبة"))}</th>
            <th>${u(p("reservations.paymentHistory.headers.date","التاريخ"))}</th>
            <th>${u(p("reservations.paymentHistory.headers.note","ملاحظات"))}</th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>`}function fs(){t.paymentAddButton&&t.paymentAddButton.dataset.listenerAttached!=="true"&&(t.paymentAddButton.addEventListener("click",e=>{e.preventDefault();const s=t.paymentProgressType?.value==="amount"?"amount":"percent",r=y(t.paymentProgressValue?.value||"").replace("%","").trim(),n=Number.parseFloat(r);if(!Number.isFinite(n)||n<=0){x(p("projects.toast.paymentInvalid","⚠️ يرجى إدخال قيمة دفعة صحيحة"));return}K.push({type:s,value:n,recordedAt:new Date().toISOString()}),t.paymentProgressValue&&(t.paymentProgressValue.value=""),Ge()}),t.paymentAddButton.dataset.listenerAttached="true"),t.paymentHistory&&t.paymentHistory.dataset.listenerAttached!=="true"&&(t.paymentHistory.addEventListener("click",e=>{const s=e.target.closest('[data-action="remove-payment"]');if(!s)return;const r=Number.parseInt(s.dataset.index||"-1",10);!Number.isInteger(r)||r<0||(K.splice(r,1),Ge())}),t.paymentHistory.dataset.listenerAttached="true")}function Js(){t.addExpenseBtn&&t.addExpenseBtn.dataset.listenerAttached!=="true"&&(t.addExpenseBtn.addEventListener("click",gs),t.addExpenseBtn.dataset.listenerAttached="true"),t.expenseAmount&&t.expenseAmount.dataset.normalizeAttached!=="true"&&(t.expenseAmount.addEventListener("input",e=>{const s=e.target;if(!(s instanceof HTMLInputElement))return;const r=s.selectionStart,n=y(s.value||"");if(s.value=n,r!=null){const o=Math.min(n.length,r);s.setSelectionRange(o,o)}}),t.expenseAmount.dataset.normalizeAttached="true")}function Re(e,s){!e||e.dataset.listenerAttached==="true"||(e.addEventListener("click",r=>{const n=r.target;n instanceof HTMLElement&&s(n)}),e.dataset.listenerAttached="true")}function Ys({onViewDetails:e}){!t.projectsTableBody||t.projectsTableBody.dataset.listenerAttached==="true"||(t.projectsTableBody.addEventListener("click",s=>{const r=s.target;if(r instanceof HTMLElement){if(r.matches('[data-action="view-details"]')){const n=r.dataset.id;e?.(n);return}if(r.matches('[data-action="delete-project"]')){if(!Ze()){Rt();return}const n=r.dataset.id;ps(n)}}}),t.projectsTableBody.dataset.listenerAttached="true")}function Gs(){const{customers:e}=Q();i.customers=Array.isArray(e)?e:[],ie(),oe(),Ae()}function Qs(){const{technicians:e}=Q();i.technicians=Array.isArray(e)?e:[],ie(),oe(),Ae()}function Xs(e){const{reservations:s}=Q();i.reservations=Array.isArray(s)?s:[],oe();const r=t.detailsModalEl&&t.detailsModalEl.classList.contains("show"),n=t.detailsBody?.dataset.projectId;r&&n&&i.projects.find(a=>String(a.id)===String(n))&&e?.(n)}function ys(){const e=t.technicianSelect?.value;if(!e){x(p("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(i.selectedTechnicians.includes(e)){x(p("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}i.selectedTechnicians.push(e),ie(),x(p("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function hs(){const e=t.equipmentSelect?.value;if(!e){x(p("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const s=Math.max(1,parseInt(t.equipmentQty?.value||"1",10)||1),r=i.selectedEquipment.find(n=>n.barcode===e);r?r.qty+=s:i.selectedEquipment.push({barcode:e,qty:s}),ie(),x(p("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function gs(){const e=(t.expenseLabel?.value||"").trim(),s=y(t.expenseAmount?.value||"0"),r=Number(s),n=y(t.servicesClientPrice?.value||"0"),o=Number.parseFloat(n)||0,a=(t.expenseNote?.value||"").trim();if(!e){x(p("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(r)||r<0){x(p("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}i.expenses.push({id:Date.now(),label:e,amount:r,salePrice:o,note:a}),gt(),t.expenseLabel&&(t.expenseLabel.value=""),t.expenseAmount&&(t.expenseAmount.value=y(String(s))),t.servicesClientPrice&&(t.servicesClientPrice.value=""),t.expenseNote&&(t.expenseNote.value=""),ie(),ke(),ce()}function ie(){ut(),mt(),jt(),yt(),ce()}function ut(){t.technicianList&&ft(t.technicianList,i.selectedTechnicians,e=>{const r=i.technicians.find(n=>String(n.id)===String(e))?.name||p("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${u(r)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${u(String(e))}" aria-label="${u(p("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function mt(){t.equipmentList&&ft(t.equipmentList,i.selectedEquipment,e=>{const s=i.equipment.find(o=>String(o.barcode||"")===String(e.barcode)),r=s?.desc||s?.description||s?.name||p("projects.fallback.unknownEquipment","معدة"),n=y(String(e.qty||1));return`
      <span class="chip">
        ${u(r)} (x${n})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${u(String(e.barcode))}" aria-label="${u(p("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function jt(){if(!t.expenseList)return;const e=Array.isArray(i.expenses)?i.expenses:[];if(!e.length){const r=u(at(t.expenseList));t.expenseList.innerHTML=`
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle project-services-table">
          <thead class="table-light">
            <tr>
              <th>${u(p("projects.expenses.table.headers.service","الخدمة"))}</th>
              <th>${u(p("projects.expenses.table.headers.cost","التكلفة (SR)"))}</th>
              <th>${u(p("projects.expenses.table.headers.sale","سعر البيع (SR)"))}</th>
              <th>${u(p("projects.expenses.table.headers.note","ملاحظات"))}</th>
              <th>${u(p("projects.expenses.table.headers.actions","الإجراءات"))}</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="text-center text-muted">${r}</td></tr>
          </tbody>
        </table>
      </div>`;return}const s=e.map(r=>{const n=u(r.label||""),o=D(Number(r.amount)||0),a=D(Number(r.salePrice)||0),l=u(r.note||""),c=u(String(r.id)),d=u(p("actions.remove","إزالة"));return`
      <tr>
        <td>${n}</td>
        <td>${u(o)}</td>
        <td>${u(a)}</td>
        <td>${l||"—"}</td>
        <td>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${c}" aria-label="${d}">✖</button>
        </td>
      </tr>`}).join("");t.expenseList.innerHTML=`
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle project-services-table">
        <thead class="table-light">
            <tr>
              <th>${u(p("projects.expenses.table.headers.service","الخدمة"))}</th>
              <th>${u(p("projects.expenses.table.headers.cost","التكلفة (SR)"))}</th>
              <th>${u(p("projects.expenses.table.headers.sale","سعر البيع (SR)"))}</th>
              <th>${u(p("projects.expenses.table.headers.note","ملاحظات"))}</th>
              <th>${u(p("projects.expenses.table.headers.actions","الإجراءات"))}</th>
            </tr>
        </thead>
        <tbody>${s}</tbody>
      </table>
    </div>`}function ft(e,s,r){if(e){if(!s||s.length===0){const n=u(at(e));e.innerHTML=`<span class="text-muted">${n}</span>`;return}e.innerHTML=s.map(n=>r(n)).join("")}}function yt(){if(!t.submitBtn)return;const e=!!i.editingProjectId,s=e?"projects.form.buttons.update":"projects.form.buttons.save",r=e?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";t.submitBtn.textContent=p(s,r)}function bs(){return i.expenses.reduce((e,s)=>e+(Number(s.amount)||0),0)}function Qe(e){return y(String(e||"")).trim().toLowerCase()}function vs(){if(!Array.isArray(i.selectedEquipment)||i.selectedEquipment.length===0)return{items:[],missing:[]};const e=new Map((i.equipment||[]).map(n=>[Qe(n?.barcode),n])),s=[],r=[];return i.selectedEquipment.forEach(n=>{const o=Qe(n?.barcode);if(!o){s.push(n?.barcode||"");return}const a=e.get(o);if(!a||a.id==null){s.push(n?.barcode||o);return}const l=Number.parseInt(String(n?.qty??0),10);r.push({equipmentId:a.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:r,missing:s}}function Zs(e){return!e||!Array.isArray(e.equipment)?[]:e.equipment.map(s=>{const r=s?.equipmentId??s?.equipment_id??s?.id??null,n=Number.parseInt(String(s?.qty??s?.quantity??0),10);return r?{equipmentId:r,qty:Number.isInteger(n)&&n>0?n:1}:null}).filter(Boolean)}function Ss(){return i.selectedEquipment.reduce((e,s)=>{const r=i.equipment.find(o=>String(o.barcode||"")===String(s.barcode)),n=Number(r?.price||r?.daily_rate||r?.dailyRate||0);return e+n*(s.qty||1)},0)}async function xs(e){if(e.preventDefault(),Le)return;const s=t.title?.value.trim(),r=t.type?.value||"",n=t.client?.value?.trim()||"",o=t.client?.dataset?.customerId||"",a=t.startDate?.value?.trim()||"",l=t.startTime?.value?.trim()||"";if(!s||!r||!a){x(p("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const c=es(n,o);if(!c){x(p("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),t.client?.focus();return}const d=String(c.id);t.client&&(t.client.dataset.customerId=d,t.client.value=c.customerName||c.name||t.client.value),G(c);const f=t.endDate?.value?.trim()||"",j=t.endTime?.value?.trim()||"",m=Pe(a,l),h=f?Pe(f,j):"",g=new Date(m),S=h?new Date(h):null;if(S&&g>S){x(p("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}t.expenseAmount&&(t.expenseAmount.value=y(t.expenseAmount.value||""));const b=bs(),P=Ss(),w=y(t.servicesClientPrice?.value||"");let _=i.servicesClientPriceTotal||Number.parseFloat(w);(!Number.isFinite(_)||_<0)&&(_=0);const E=t.taxCheckbox?.checked===!0,A=t.discountType?.value==="amount"?"amount":"percent",q=y(t.discountValue?.value||"0");let L=Number.parseFloat(q);(!Number.isFinite(L)||L<0)&&(L=0);const U=t.companyShare,R=U?.checked===!0;let k=R?Number.parseFloat(y(String(U.dataset.companyShare??U.value??Y))):null;(!Number.isFinite(k)||k<=0)&&(k=R?Y:null);const O=ms({equipmentEstimate:P,expensesTotal:b,servicesClientPrice:_,discountValue:L,discountType:A,applyTax:E,companyShareEnabled:R,companySharePercent:k}),I=t.paymentProgressType?.value==="amount"?"amount":"percent",X=y(t.paymentProgressValue?.value||""),le=X?Number.parseFloat(X):null,B=Wt({totalAmount:O.totalWithTax,progressType:I,progressValue:le,history:Array.isArray(K)?[...K]:[]}),H=t.paymentStatus?.dataset?.userSelected==="true",Z=(t.paymentStatus?.value||"unpaid").toLowerCase(),ee=["paid","partial"].includes(Z)?Z:"unpaid",_e=Kt({manualStatus:H?ee:null,paidAmount:B.paidAmount,paidPercent:B.paidPercent,totalAmount:O.totalWithTax}),te=H?ee:_e;!H&&t.paymentStatus&&(t.paymentStatus.value=te),t.paymentStatus?.dataset&&delete t.paymentStatus.dataset.userSelected;const{items:se,missing:be}=vs();if(be.length){x(p("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const pe=!!i.editingProjectId,F=pe?i.projects.find(C=>String(C.id)===String(i.editingProjectId)):null;if(pe&&!F){x(p("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const de=c.companyName||c.company||"",Ie=t.description?.value.trim()||"",ue=Mt({projectCode:F?.projectCode||(pe?null:Xe()),title:s,type:r,clientId:d,clientCompany:de,description:Ie,start:m,end:h||null,applyTax:E,paymentStatus:te,equipmentEstimate:P,expenses:i.expenses.map(C=>({id:C.id,label:C.label,amount:C.amount,salePrice:C.salePrice,note:C.note||void 0})),servicesClientPrice:_,discount:L,discountType:A,companyShareEnabled:R&&E,companySharePercent:R&&E?k:null,companyShareAmount:O.companyShareAmount,taxAmount:O.taxAmount,totalWithTax:O.totalWithTax,confirmed:F?.confirmed??!1,technicians:i.selectedTechnicians,equipment:se,paidAmount:B.paidAmount,paidPercentage:B.paidPercent,paymentProgressType:B.paymentProgressType,paymentProgressValue:B.paymentProgressValue,payments:Array.isArray(K)?K:[]});Le=!0;try{let C=F?.projectId??F?.id??null;if(pe){const J=await Vt(C??i.editingProjectId,ue);C=J?.projectId??J?.id??C,await Je(C,te),x(p("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const J=await Ht(ue);C=J?.projectId??J?.id??null,await Je(C,te),x(p("projects.toast.saved","✅ تم حفظ المشروع بنجاح"));try{et({projectsTab:"projects-section",projectsSubTab:"projects-list-tab"}).catch(()=>{});const re=document.querySelector('.tab-button[data-tab-target="projects-section"]');re&&typeof re.click=="function"&&re.click();const je=document.querySelector('.sub-tab-button[data-project-subtab-target="projects-list-tab"]');je&&typeof je.click=="function"&&setTimeout(()=>je.click(),0)}catch{}}await ws(C)||ht(),i.editingProjectId=null,t.form.reset(),dt(),ot(),ye(),t.client&&(t.client.dataset.customerId=""),t.type&&(t.type.value="");try{await tt()}catch{}i.projects=Fe(),i.reservations=$(),oe(),ke(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(C){console.error("❌ [projects] handleSubmitProject failed",C);const me=st(C)?C.message:p("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");x(me,"error")}finally{Le=!1}}function Pe(e,s){if(!e)return"";const r=s&&/\d{1,2}:\d{2}/.test(s)?s:"00:00",[n="00",o="00"]=r.split(":"),a=n.padStart(2,"0"),l=o.padStart(2,"0");return`${e}T${a}:${l}`}function Ne(){if(typeof window>"u"||!window.sessionStorage)return null;const e=window.sessionStorage.getItem(Ee);if(!e)return null;try{const s=JSON.parse(e);return s&&typeof s=="object"?s:null}catch(s){return console.warn("⚠️ [projects] Failed to parse project form draft",s),null}}function Ue(e){if(!(typeof window>"u"||!window.sessionStorage))try{window.sessionStorage.setItem(Ee,JSON.stringify(e))}catch(s){console.warn("⚠️ [projects] Unable to persist project form draft",s)}}function ht(){typeof window>"u"||!window.sessionStorage||(window.sessionStorage.removeItem(Ee),he())}function Ts(){const e=Ne()||{};return{...e,type:t.type?.value||"",title:t.title?.value||"",client:t.client?.value||"",customerId:t.client?.dataset.customerId||"",clientCompany:t.clientCompany?.value||"",paymentStatus:t.paymentStatus?.value||"unpaid",taxChecked:t.taxCheckbox?.checked===!0,discountType:t.discountType?.value||"percent",discountValue:t.discountValue?.value||"",companyShareEnabled:t.companyShare?.checked===!0,companySharePercent:t.companyShare?.dataset.companyShare||t.companyShare?.value||String(Y),paymentProgressType:t.paymentProgressType?.value||"percent",paymentProgressValue:t.paymentProgressValue?.value||"",startDate:t.startDate?.value||"",startTime:t.startTime?.value||"",endDate:t.endDate?.value||"",endTime:t.endTime?.value||"",description:t.description?.value||"",expenses:Array.isArray(i.expenses)?i.expenses.map(s=>({...s})):[],servicesClientPriceTotal:Number.isFinite(Number(i.servicesClientPriceTotal))?i.servicesClientPriceTotal:0,technicians:Array.isArray(i.selectedTechnicians)?[...i.selectedTechnicians]:[],equipment:Array.isArray(i.selectedEquipment)?i.selectedEquipment.map(s=>({...s})):[],linkedReservationIds:Array.isArray(e.linkedReservationIds)?[...e.linkedReservationIds]:[],savedAt:Date.now()}}function er(){const e=Ne();return e?(t.type&&(t.type.value=e.type||""),t.title&&(t.title.value=e.title||""),t.client&&(t.client.value=e.client||"",t.client.dataset.customerId=e.customerId||""),t.clientCompany&&(t.clientCompany.value=e.clientCompany||""),t.paymentStatus&&e.paymentStatus&&(t.paymentStatus.value=e.paymentStatus),t.taxCheckbox&&(t.taxCheckbox.checked=e.taxChecked===!0),t.discountType&&e.discountType&&(t.discountType.value=e.discountType),t.discountValue&&(t.discountValue.value=e.discountValue||""),t.companyShare&&(e.companySharePercent?t.companyShare.dataset.companyShare=String(e.companySharePercent):t.companyShare.dataset.companyShare=String(Y),t.companyShare.checked=e.companyShareEnabled===!0),t.paymentProgressType&&e.paymentProgressType&&(t.paymentProgressType.value=e.paymentProgressType),t.paymentProgressValue&&(t.paymentProgressValue.value=e.paymentProgressValue||""),i.servicesClientPriceTotal=Number.isFinite(Number(e.servicesClientPriceTotal))?Number(e.servicesClientPriceTotal):0,t.startDate&&(t.startDate.value=e.startDate||""),t.startTime&&(t.startTime.value=e.startTime||""),t.endDate&&(t.endDate.value=e.endDate||""),t.endTime&&(t.endTime.value=e.endTime||""),t.description&&(t.description.value=e.description||""),i.expenses=Array.isArray(e.expenses)?e.expenses.map(s=>({...s})):[],i.selectedTechnicians=Array.isArray(e.technicians)?[...e.technicians]:[],i.selectedEquipment=Array.isArray(e.equipment)?e.equipment.map(s=>({...s})):[],fe("tax"),he(),ce(),!0):(he(),!1)}function tr(){!t.linkedReservationBtn||t.linkedReservationBtn.dataset.listenerAttached==="true"||(t.linkedReservationBtn.addEventListener("click",Cs),t.linkedReservationBtn.dataset.listenerAttached="true")}function Cs(e){e.preventDefault();const s=e.currentTarget;if(s?.classList?.contains("btn-disabled")||s?.getAttribute("aria-disabled")==="true"){x(p("projects.form.linkedReservation.buttonDisabledToast","⚠️ المشروع مربوط بحجز مسبقاً"));return}const n=Ts();if(!(n.customerId&&n.customerId!==""||n.client&&n.client.trim())){x(p("projects.form.linkedReservation.missingClient","⚠️ يرجى اختيار العميل قبل إنشاء الحجز"));return}const a=n.startDate&&n.startTime,l=n.endDate&&n.endTime;if(!a||!l){x(p("projects.form.linkedReservation.missingSchedule","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إنشاء الحجز"));return}Ue(n);const c=Ps(n);let d="";try{d=encodeURIComponent(JSON.stringify(c))}catch(j){console.warn("⚠️ [projects] Unable to encode reservation context",j)}et({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(j=>{console.warn("⚠️ [projects] Failed to persist dashboard preference before redirect",j)});const f=d?`?reservationProjectContext=${d}`:"";window.location.href=`dashboard.html${f}#reservations`}function Ps(e){const s=Pe(e.startDate,e.startTime)||null,r=Pe(e.endDate,e.endTime)||null;return{fromProjectForm:!0,draftStorageKey:Ee,returnUrl:us,start:s,end:r,customerId:e.customerId||null,customerName:e.client||"",clientCompany:e.clientCompany||"",projectTitle:e.title||"",projectType:e.type||"",description:e.description||""}}async function ws(e){if(!e)return;const s=Ne(),r=Array.isArray(s?.linkedReservationIds)?s.linkedReservationIds:[];if(!r.length)return;const n=[];let o=!1;for(const l of r){const c=l!=null?String(l):"";if(c)try{await ge(c,{project_id:e}),o=!0}catch(d){console.error("❌ [projects] Failed to link reservation to project",c,d),n.push(c)}}if(o)try{await nt(),i.reservations=$(),document.dispatchEvent(new CustomEvent("reservations:changed"))}catch(l){console.warn("⚠️ [projects] Failed to refresh reservations after linking",l)}const a={linkedReservationIds:n,savedAt:Date.now()};return Ue(a),n.length&&x(p("projects.toast.linkReservationFailed","⚠️ تعذر ربط بعض الحجوزات بالمشروع، يرجى التحقق يدويًا"),"error"),he(),n.length}function As(){const e=new Map,s=n=>{if(!n)return;[n.id,n.reservationId,n.reservation_id,n.reservation_code].map(a=>a!=null?String(a):"").filter(Boolean).forEach(a=>{e.has(a)||e.set(a,n)})};Array.isArray(i.reservations)&&i.reservations.forEach(s);const r=Q();return Array.isArray(r?.reservations)&&r.reservations.forEach(s),e}function ks(e){if(!e||typeof e!="object")return"";const s=[e.name,e.full_name,e.fullName,e.technician_name,e.technicianName,e.label,e.displayName];for(const r of s)if(typeof r=="string"&&r.trim())return r.trim();return""}function Es(e){if(!e)return[];const s=new Set;(Array.isArray(e.techniciansDetails)?e.techniciansDetails:[]).forEach(o=>{const a=ks(o);a&&s.add(a)});const n=Array.isArray(e.technicians)?e.technicians:[];if(n.length){const o=Array.isArray(i.technicians)?i.technicians:[];n.forEach(a=>{const l=o.find(d=>String(d?.id)===String(a)),c=l?.name||l?.full_name||"";c&&s.add(String(c).trim())})}return Array.from(s)}function he(){const e=document.getElementById("project-linked-reservation-summary");if(!e)return;const s=Ne(),r=t.linkedReservationBtn;let n=Array.isArray(s?.linkedReservationIds)?Array.from(new Set(s.linkedReservationIds.map(c=>String(c)).filter(Boolean))):[];const o=As(),a=n.filter(c=>o.has(c));if(a.length!==n.length){n=a;const c={...s||{},linkedReservationIds:n,savedAt:Date.now()};Ue(c)}if(!n.length){e.dataset.state="empty",e.innerHTML=`<p class="project-linked-reservation__summary-empty">${u(p("projects.form.linkedReservation.empty","لم يتم إنشاء حجوزات مرتبطة بعد."))}</p>`,r&&(r.disabled=!1,r.classList.remove("btn-disabled"),r.removeAttribute("aria-disabled"),r.title="");return}const l=n.map(c=>{const d=o.get(c);if(!d)return`
        <li class="project-linked-reservation__summary-item">
          <div class="project-linked-reservation__summary-item-title">#${u(y(c))}</div>
          <div class="project-linked-reservation__summary-item-meta">
            <span>${u(p("projects.form.linkedReservation.pendingItem","تم إنشاء حجز جديد وسيتم ربطه بعد حفظ المشروع."))}</span>
          </div>
        </li>`;const f=d.reservation_code||d.reservationId||d.id||c,j=`#${y(String(f))}`,m=Array.isArray(d.items)?d.items:[],h=m.reduce((A,q)=>A+(Number(q?.qty)||0),0)||m.length||0,g=Es(d),b=(Array.isArray(d.technicians)?d.technicians:[]).length||g.length||0,P=He(d),w=[],_=p("projects.form.linkedReservation.meta.equipment","عدد المعدات: {count}").replace("{count}",y(String(h)));w.push(_);const E=p("projects.form.linkedReservation.meta.crew","عدد الفريق: {count}").replace("{count}",y(String(b)));if(w.push(E),g.length){const A=typeof Se=="function"&&Se()==="en"?", ":"، ",q=p("projects.form.linkedReservation.meta.crewNames","أسماء الفريق: {names}").replace("{names}",g.join(A));w.push(q)}if(Number.isFinite(P)){const A=p("projects.form.linkedReservation.meta.total","إجمالي الحجز: {amount}").replace("{amount}",D(P));w.push(A)}return`
      <li class="project-linked-reservation__summary-item">
        <div class="project-linked-reservation__summary-item-title">${u(j)}</div>
        <div class="project-linked-reservation__summary-item-meta">
          ${w.map(A=>`<span>${u(A)}</span>`).join("")}
        </div>
      </li>`}).join("");e.dataset.state="has-linked",e.innerHTML=`<ul class="project-linked-reservation__summary-list">${l}</ul>`,r&&(r.disabled=!1,r.classList.add("btn-disabled"),r.setAttribute("aria-disabled","true"),r.setAttribute("data-allow-click","true"),r.title=p("projects.form.linkedReservation.buttonDisabled","⚠️ المشروع مربوط بحجز مسبقاً"))}function gt(){const e=Array.isArray(i.expenses)?i.expenses.reduce((s,r)=>s+(Number(r?.salePrice)||0),0):0;i.servicesClientPriceTotal=Math.round(e*100)/100}function ce(){t.servicesClientTotalIndicator||document.getElementById("project-services-client-total-indicator");const e=t.servicesClientTotalValue||document.getElementById("project-services-client-total-value");if(!e)return;const s=Number(i.servicesClientPriceTotal)||0;e.textContent=D(s)}export{Rs as A,zs as B,Ws as C,Ks as D,Js as E,tr as F,Ys as G,Qt as H,Xs as I,$s as J,qs as K,er as L,ie as M,Gs as N,Qs as O,Ae as a,Hs as b,ms as c,t as d,Ye as e,Ve as f,Os as g,Ce as h,ct as i,u as j,D as k,Ms as l,W as m,ps as n,Fs as o,Bs as p,Zs as q,oe as r,i as s,Vs as t,ke as u,Je as v,Us as w,Ds as x,yt as y,Ls as z};
