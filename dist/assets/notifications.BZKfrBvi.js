import{r as y,a as b,c as v,g as $,j as r,t as d,b as h}from"./auth.BO9j1-fU.js";import{i as T}from"./dashboardShell.DF2kUed9.js";y({ar:{notifications:{title:"إدارة التنبيهات",header:"🔔 إدارة التنبيهات",subtitle:"أرسل تنبيهات للفريق بخصوص الحجوزات/المشاريع، وحدد القنوات والمستلمين.",form:{entityType:"النوع",entity:{reservation:"حجز",project:"مشروع"},search:"بحث","search.placeholder":"ابحث بالكود أو العنوان"},table:{headers:{code:"الكود",title:"العنوان",when:"الوقت",customer:"العميل",actions:"الإجراءات"},loading:"⏳ اكتب للبحث…",select:"اختيار"},channels:{email:"إيميل",whatsapp:"واتساب"},compose:{title:"✉️ إنشاء رسالة",recipients:"المستلمون",toTechnicians:"الفنيون المعيّنون",toAdmins:"الإدمن",subject:"الموضوع",body:"نص الرسالة",templates:{reminder:"📌 تذكير",note:"📝 ملاحظة إدارية"},send:"🚀 إرسال",sentOk:"تم إرسال الرسالة بنجاح"}}}});b();T();const t={};let c=null,m=null;function a(e){return document.querySelector(e)}function x(){t.entityType=a("#notif-entity-type"),t.search=a("#notif-search"),t.resultsBody=a("#notif-results-body"),t.composeSection=a("#notif-compose-section"),t.selectedSummary=a("#notif-selected-summary"),t.chEmail=a("#notif-channel-email"),t.chWhatsapp=a("#notif-channel-whatsapp"),t.toTechs=a("#notif-to-techs"),t.toAdmins=a("#notif-to-admins"),t.extraEmails=a("#notif-extra-emails"),t.extraPhones=a("#notif-extra-phones"),t.subject=a("#notif-subject"),t.body=a("#notif-body"),t.sendBtn=a("#notif-send-btn"),t.tReminder=a("#notif-template-reminder"),t.tNote=a("#notif-template-note")}function p(e,n){const s=e.start_datetime||e.startDate||"",o=e.end_datetime||e.endDate||"";return s&&o&&s!==o?`${s} — ${o}`:s||o||""}function _(e,n){if(!Array.isArray(e)||e.length===0){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${d("notifications.table.loading","لا نتائج")}</td></tr>`;return}t.resultsBody.innerHTML=e.map(s=>{const o=n==="reservation"?s.reservation_code||"":s.project_code||"",i=s.title||"",l=p(s),u=n==="reservation"?s.customer_name||"":s.client_name||"";return`
      <tr>
        <td>${o||"—"}</td>
        <td>${i||"—"}</td>
        <td>${l||"—"}</td>
        <td>${u||"—"}</td>
        <td><button type="button" class="btn btn-sm btn-primary" data-select-id="${s.id}" data-select-type="${n}">${d("notifications.table.select","اختيار")}</button></td>
      </tr>
    `}).join("")}async function f(){const e=t.entityType.value,n=(t.search.value||"").trim();if(n===""){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${d("notifications.table.loading","اكتب للبحث…")}</td></tr>`;return}try{const o=await h(`${e==="reservation"?"/reservations/":"/projects/"}?search=${encodeURIComponent(n)}&limit=10`);_(o?.data??[],e)}catch(s){console.error(s),t.resultsBody.innerHTML='<tr><td colspan="5" class="text-center text-error">فشل البحث</td></tr>'}}function g(){m&&clearTimeout(m),m=setTimeout(f,350)}function j(e,n){const s=e==="reservation"?n.reservation_code||"":n.project_code||"",o=n.title||s||e,i=p(n),l=n.location||"",u=e==="reservation"?n.customer_name||"":n.client_name||"";return[s?`الكود: ${s}`:"",`العنوان: ${o}`,i?`الوقت: ${i}`:"",l?`الموقع: ${l}`:"",u?`العميل: ${u}`:""].filter(Boolean).join(" | ")}async function E(e,n){try{const i=(await h(`${n==="reservation"?"/reservations/":"/projects/"}?id=${encodeURIComponent(e)}`))?.data;if(!i)throw new Error("Not found");c={type:n,id:Number(i.id),summary:j(n,i)},t.selectedSummary.textContent=c.summary,t.composeSection.hidden=!1}catch(s){console.error(s),r("⚠️ تعذر تحميل العنصر المحدد")}}async function w(){if(!c){r("اختر عنصراً أولاً");return}const e={email:!!t.chEmail.checked,whatsapp:!!t.chWhatsapp.checked};if(!e.email&&!e.whatsapp){r("اختر قناة إرسال واحدة على الأقل");return}const n={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(o=>o.trim()).filter(Boolean),additional_phones:(t.extraPhones.value||"").split(",").map(o=>o.trim()).filter(Boolean)},s={subject:(t.subject.value||"تنبيه إداري").trim(),text:(t.body.value||"").trim()};if(!s.text){r("اكتب نص الرسالة");return}try{const o=await h("/notifications/send.php",{method:"POST",body:{entity_type:c.type,entity_id:c.id,channels:e,recipients:n,message:s}});r(d("notifications.compose.sentOk","تم إرسال الرسالة بنجاح"))}catch(o){console.error(o),r("فشل الإرسال")}}function B(){t.search.addEventListener("input",g),t.entityType.addEventListener("change",()=>{t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${d("notifications.table.loading","اكتب للبحث…")}</td></tr>`,t.search.value&&f()}),t.resultsBody.addEventListener("click",e=>{const n=e.target.closest("[data-select-id]");n&&E(n.getAttribute("data-select-id"),n.getAttribute("data-select-type"))}),t.tReminder.addEventListener("click",()=>{const e=`تذكير بالحجز/المشروع:
يرجى الاطلاع واتخاذ اللازم.`;t.body.value=e}),t.tNote.addEventListener("click",()=>{const e=`ملاحظة إدارية:
يرجى متابعة الإجراء المطلوب.`;t.body.value=e}),t.sendBtn.addEventListener("click",w)}(async function(){await v();const n=await $();if(!n||n.role!=="admin"){r("هذه الصفحة للمسؤولين فقط"),window.location.href="home.html";return}x(),B()})();
