import{t as c,r as L,f as nt,c as at,p as st,a as it,b as $,d as J,e as ct}from"./calculations.Cuzjzmo7.js";import{e as pt}from"./reports.gY22zGjU.js";import{s as lt,c as dt,d as mt,q as ut}from"./controller.CKj9uBP3.js";import{n as V}from"./auth.DEm-O4iH.js";import"./reservationsService.DHFcI6wO.js";import"./dashboard.ZP_2F2Yz.js";/* empty css              */import"./dashboardShell.BJ8UOETr.js";import"./customers.DDv-F3VN.js";import"./maintenanceService.-sdg2Aq9.js";const X=96,U=25.4,K=210,ft=297,N=Math.round(K/U*X),H=Math.round(ft/U*X),j=X/U,ht=/safari/i,gt=/(iphone|ipad|ipod)/i,bt=/(crios|fxios|edgios|opios)/i;function yt(){try{const o=navigator.userAgent||"";return gt.test(o)&&ht.test(o)&&!bt.test(o)}catch{return!1}}function xt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function wt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const r=document.createElement("style");r.textContent=String(ut).trim(),t.appendChild(r);const s=document.createElement("div");s.className="quote-preview-pages",s.setAttribute("data-quote-pages",""),t.appendChild(s);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function Q(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function Y({rightMm:o,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function vt(o){try{const t=Q(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const s="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${s}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(r,e);const d=()=>{const g=Number(r.querySelector("[data-rpt-right]").value),i=Number(r.querySelector("[data-rpt-top]").value),M=Number(r.querySelector("[data-rpt-scale]").value),b=Math.max(.9,Math.min(1,M/100));Y({rightMm:g,topMm:i,scale:b});const m=g*j,_=i*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${m}px, ${_}px) scale(${b})`})};r.querySelector("[data-rpt-apply]").addEventListener("click",d),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,Y({rightMm:0,topMm:0,scale:1});const g=o.querySelector("[data-quote-pages]");Object.assign(g.style,{transform:"none"})});const a=t.rightMm*j,n=t.topMm*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${a}px, ${n}px) scale(${t.scale})`})}catch{}}function B({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function Ct(o){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=c("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const s=document.createElement("p");s.className="rpt-subtitle",s.textContent=`${ct(new Date)} • ${c("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(s);const e=document.createElement("div");e.className="rpt-kpis";const d=(a,n)=>{const g=document.createElement("div");return g.className="rpt-kpi",g.innerHTML=`<div class="label">${a}</div><div class="value">${n}</div>`,g};return e.appendChild(d(c("reservations.reports.kpi.total.label","الحجوزات","Reservations"),J(o.total||0))),e.appendChild(d(c("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),$(o.revenue||0))),e.appendChild(d(c("reservations.reports.kpi.net.label","صافي الربح","Net profit"),$(o.netProfit||0))),e.appendChild(d(c("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),$(o.companyShareTotal||0))),e.appendChild(d(c("reservations.reports.kpi.tax.label","الضريبة","Tax"),$(o.taxTotal||0))),e.appendChild(d(c("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),$(o.maintenanceExpense||0))),t.appendChild(e),t}function Pt(){try{const o=L?.data||{},t=L?.lastSnapshot?.filtered||o.reservations||[],r=new Map((o.customers||[]).map(n=>[String(n.id),n])),s=[...t].sort((n,g)=>new Date(g?.start||0)-new Date(n?.start||0)),e={code:c("reservations.reports.results.headers.id","الحجز","Reservation"),customer:c("reservations.reports.results.headers.customer","العميل","Customer"),date:c("reservations.reports.results.headers.date","التاريخ","Date"),status:c("reservations.reports.results.headers.status","الحالة","Status"),payment:c("reservations.reports.results.headers.payment","الدفع","Payment"),total:c("reservations.reports.results.headers.total","الإجمالي","Total"),share:c("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:c("reservations.reports.results.headers.net","صافي الربح","Net profit")},d=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],a=s.map(n=>{const g=n?.reservationId||n?.id||"—",i=V(String(g)),b=r.get(String(n?.customerId))?.customerName||c("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),m=nt(n?.start),_=at(n),x=(()=>{switch(_.statusValue){case"completed":return String(c("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(c("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(c("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return V(String(_.statusValue||"—"))}})(),k=st(_.paidStatus),S=it(n),q=$(S.finalTotal),W=S.companySharePercent>0?`${J(S.companySharePercent)}% (${$(S.companyShareAmount)})`:c("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),u=$(S.netProfit);return{[e.code]:i,[e.customer]:b,[e.date]:m,[e.status]:x,[e.payment]:k,[e.total]:q,[e.share]:W,[e.net]:u}});return{headers:d,rows:a}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function G(o){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),s=document.createElement("tr");o.forEach(d=>{const a=document.createElement("th");a.textContent=d,s.appendChild(a)}),r.appendChild(s);const e=document.createElement("tbody");return t.appendChild(r),t.appendChild(e),{table:t,tbody:e}}function Mt(o,t,r,s){const e=o.querySelector("[data-quote-pages]"),d=B({primary:!0});e.appendChild(d);const a=Ct(s);d.appendChild(a);let{table:n,tbody:g}=G(r);d.appendChild(n);const i=18,M=28,b=[];for(let x=0;x<t.length;x+=M)b.push(t.slice(x,x+M));if(b.length){const x=b[0];if(x.length>i){const k=x.splice(i);b.length>1?b[1]=k.concat(b[1]):b.push(k)}}const m=(x,k)=>{const S=document.createElement("tr");r.forEach(q=>{const W=document.createElement("td");W.textContent=k[q]!=null?String(k[q]):"",S.appendChild(W)}),x.appendChild(S)};(b.shift()||t).forEach(x=>m(g,x)),b.forEach(x=>{const k=B({primary:!1});e.appendChild(k);const S=G(r);k.appendChild(S.table),x.forEach(q=>m(S.tbody,q))})}function St(o=[],{context:t="preview"}={}){const s=(L.lastSnapshot||{}).metrics||{};let e,d=o&&o.length?o:null;if(d)e=Object.keys(d[0]||{});else{const g=Pt();e=g.headers,d=g.rows}const a=wt(t),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${N}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(a);try{lt(a),dt(a),mt(a)}catch{}return Mt(a,d||[],e,s),a.parentElement?.removeChild(a),n.parentElement?.removeChild(n),t==="preview"&&vt(a),a}async function Wt(o=[],{action:t="save"}={}){const r=St(o,{context:"export"}),s=document.createElement("div");Object.assign(s.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),s.appendChild(r),document.body.appendChild(s);try{if(t==="print"&&localStorage.getItem("reportsPdf.nativePrint")==="on"){const i=window.open("","_blank");if(!i)throw new Error("Popup blocked");const M=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${c("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} /* ضمان إظهار كل صفحة كتلة مطبوعة */ .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{i.document.open(),i.document.write(M),i.document.close()}catch{}const b=r.cloneNode(!0);try{i.document.body.appendChild(b)}catch{}try{i.document?.fonts?.ready&&await i.document.fonts.ready}catch{}await new Promise(m=>setTimeout(m,60));try{i.focus(),i.print()}catch{}return}const a=yt()&&!xt()?window.open("","_blank"):null;if(a)try{a.document.open(),a.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${c("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),a.document.close()}catch{}await pt();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const n=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,g=window.html2canvas;if(typeof n=="function"&&typeof g=="function"){const i=Q(),M=new n({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),m={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},_=Array.from(r.querySelectorAll(".quote-page"));let x=0;const k=(u,p=250)=>{try{const f=u.getContext("2d"),{width:y,height:w}=u,l=new Uint8ClampedArray(y*4),v=h=>{const E=f.getImageData(0,h,y,1).data||l;let R=0;for(let P=0;P<y;P+=1){const T=P*4,I=E[T],D=E[T+1],A=E[T+2];if((I<p||D<p||A<p)&&(R+=1,R>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let C=0;for(let h=0;h<w;h+=2)if(!v(h)){C=h;break}return C}catch{return 0}},S=(u,p=245)=>{try{const f=u.getContext("2d"),{width:y,height:w}=u,l=Math.floor(y*.55),v=Math.max(10,y-l),C=Math.max(3,Math.ceil(v*.015));for(let h=0;h<w;h+=2){const E=f.getImageData(l,h,v,1).data;let R=0;for(let P=0;P<v;P+=1){const T=P*4,I=E[T],D=E[T+1],A=E[T+2];if((I<p||D<p||A<p)&&(R+=1,R>=C))return h}}return 0}catch{return 0}},q=(u,p=250)=>{try{const f=u.getContext("2d"),{width:y,height:w}=u,l=C=>{const h=f.getImageData(0,C,y,1).data;let E=0;for(let R=0;R<y;R+=1){const P=R*4,T=h[P],I=h[P+1],D=h[P+2];if((T<p||I<p||D<p)&&(E+=1,E>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let v=0;for(let C=w-1;C>=0;C-=2)if(!l(C)){v=w-1-C;break}return v}catch{return 0}},W=(u,p,f)=>{try{const{width:y,height:w}=u,l=Math.max(0,Math.min(w-1,Math.round(p))),v=Math.max(0,Math.min(w-l,Math.round(f))),C=Math.max(1,w-l-v);if(l===0&&v===0)return u;const h=document.createElement("canvas");return h.width=y,h.height=C,h.getContext("2d").drawImage(u,0,-l),h}catch{return u}};for(let u=0;u<_.length;u+=1){const p=_[u],f=p.ownerDocument||document,y=f.createElement("div");Object.assign(y.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const w=f.createElement("div");w.id="quotation-pdf-root",w.setAttribute("data-quote-render-context","export"),w.style.width=`${N}px`,w.style.maxWidth=`${N}px`,w.style.minWidth=`${N}px`,w.style.background="#ffffff";const l=p.cloneNode(!0);l.style.width=`${N}px`,l.style.maxWidth=`${N}px`,l.style.minWidth=`${N}px`,l.style.height=`${H}px`,l.style.maxHeight=`${H}px`,l.style.minHeight=`${H}px`,l.style.position="relative",l.style.background="#ffffff",l.style.overflow="hidden",w.appendChild(l),y.appendChild(w),f.body.appendChild(y);let v;try{v=await g(l,{...m,scrollX:0,scrollY:0,windowWidth:N,windowHeight:H})}finally{y.parentNode?.removeChild(y)}if(!v)continue;const C=k(v,246),h=S(v,244),E=Math.max(C,h),R=q(v,246),P=W(v,E,R),T=Math.max(.9,Math.min(1,i.scale||1)),I=K*T,D=P.height/P.width*I;let A=Number(i.rightMm)||0;const Z=p.classList.contains("quote-page--primary")?6:4;let O=0;try{const F=p.querySelector(".rpt-header")||p.firstElementChild;if(F){const ot=F.getBoundingClientRect(),rt=p.getBoundingClientRect();O=Math.max(0,ot.top-rt.top)}}catch{O=0}const tt=O/j;let z=(Number(i.topMm)||0)+Z-tt;z<-80&&(z=-80);const et=P.toDataURL("image/jpeg",.95);x>0&&M.addPage(),M.addImage(et,"JPEG",A,z,I,D,`page-${x+1}`,"FAST"),x+=1,await new Promise(F=>requestAnimationFrame(F))}if(x===0)throw new Error("PDF generation produced no pages");if(t==="print"){const u=M.output("bloburl");if(a)try{a.location.href=u}catch{}else await new Promise(p=>{const f=document.createElement("iframe");Object.assign(f.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),f.onload=()=>{try{f.contentWindow?.focus(),f.contentWindow?.print()}catch{}setTimeout(()=>{f.remove(),p()},700)},f.src=u,document.body.appendChild(f)})}else M.save("reservations-report.pdf")}else{const i=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const M=await i.get("pdf").then(b=>b.output("bloburl"));await new Promise(b=>{const m=document.createElement("iframe");Object.assign(m.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),m.onload=()=>{try{m.contentWindow?.focus(),m.contentWindow?.print()}catch{}setTimeout(()=>{m.remove(),b()},700)},m.src=M,document.body.appendChild(m)})}else await i.save("reservations-report.pdf")}}finally{s.remove()}}export{St as buildReportsPdfPages,Wt as exportReportsPdf};
