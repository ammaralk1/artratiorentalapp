import{d as ee,h as te,b as j,A as ne,t as oe,n as k}from"./auth.CnqFW8CW.js";const re=ee()||{};let d=(re.projects||[]).map(le),A=!1;function l(e){if(e==null||e==="")return 0;const o=k(String(e)).replace(/[^\d.+-]/g,""),t=Number.parseFloat(o);return Number.isFinite(t)?t:0}function pe(){return d}function P(e){d=Array.isArray(e)?e.map(z):[],te({projects:d});try{const o=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(o),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(o)}catch(o){console.warn("⚠️ [projectsService] Failed to dispatch projects:changed event",o)}return d}async function ie(e={}){const o=new URLSearchParams;Object.entries(e).forEach(([_,m])=>{m==null||m===""||o.set(_,String(m))});const t=o.toString(),r=(await j(`/projects/${t?`?${t}`:""}`))?.data;let i=[];Array.isArray(r)?i=r:r&&typeof r=="object"&&(Array.isArray(r.items)?i=r.items:Array.isArray(r.results)?i=r.results:Array.isArray(r.data)?i=r.data:Array.isArray(r.records)&&(i=r.records));const y=i.map($);return P(y),A=!0,d}async function de({force:e=!1,params:o=null}={}){if(!e&&A&&d.length>0)return d;try{return await ie(o||{})}catch(t){return console.error("❌ [projectsService] Failed to load projects from API",t),d}}async function me(e){const o=await j("/projects/",{method:"POST",body:e}),t=$(o?.data??{}),a=[...d,t];return P(a),A=!0,t}async function V(e,o){const t=await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:o}),a=$(t?.data??{}),r=d.map(i=>String(i.id)===String(e)?a:i);return P(r),A=!0,a}function ae(e="",o=""){const t=String(e||"").trim(),a=String(o||"").trim();if(!a)return t;const i=`${oe("projects.close.noteLabel","ملاحظة إغلاق")}: ${a}`;return t?`${t}
${i}`:i}function ce(e=""){const o=String(e||"");if(!o.trim())return"";const t=["ملاحظة إغلاق","Close note"];let a=-1;for(const i of t){const y=o.lastIndexOf(i);y>a&&(a=y)}return a===-1?o:o.slice(0,a).replace(/\n$/,"")}async function fe(e,o=""){const t=d.find(r=>String(r.id)===String(e)),a=ae(t?.description||"",o||"");return V(e,{status:"completed",confirmed:!0,description:a})}async function ye(e){const o=d.find(a=>String(a.id)===String(e)),t=ce(o?.description||"");return V(e,{status:"ongoing",confirmed:!0,description:t})}async function _e(e){await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const o=d.filter(t=>String(t.id)!==String(e));P(o),A=!0}function ge({projectCode:e,title:o,type:t,clientId:a,clientCompany:r,description:i,start:y,end:_,applyTax:m,paymentStatus:f,equipmentEstimate:g=0,expenses:h=[],servicesClientPrice:q=0,taxAmount:b=0,totalWithTax:n=0,discount:p=0,discountType:I="percent",companyShareEnabled:N=!1,companySharePercent:x=null,companyShareAmount:G=0,paidAmount:C=null,paidPercentage:E=null,paymentProgressType:v=null,paymentProgressValue:F=null,confirmed:J=!1,technicians:L=[],equipment:B=[],payments:O,paymentHistory:K}={}){const Q=Array.isArray(L)?L.map(c=>Number.parseInt(String(c),10)).filter(c=>Number.isInteger(c)&&c>0):[],X=Array.isArray(B)?B.map(c=>{const s=Number.parseInt(String(c.equipmentId??c.equipment_id??c.id??0),10),S=Number.parseInt(String(c.qty??c.quantity??0),10);return!Number.isInteger(s)||s<=0?null:{equipment_id:s,quantity:Number.isInteger(S)&&S>0?S:1}}).filter(Boolean):[],H=Array.isArray(h)?h.map(c=>{const s=l(c?.amount??c?.value??0),S=(c?.label??c?.name??"").trim();if(!S)return null;const w=l(c?.salePrice??c?.sale_price??0),R=(c?.note??c?.notes??"").toString().trim();return{label:S,amount:Math.round(s*100)/100,sale_price:Math.max(0,Math.round(w*100)/100),note:R||void 0,...R?{notes:R}:{}}}).filter(Boolean):[],Y=H.reduce((c,s)=>c+(s?.amount??0),0),u={title:o,type:t,client_id:a?Number.parseInt(String(a),10):null,client_company:r??null,description:i??null,start_datetime:y??null,end_datetime:_||null,apply_tax:!!m,payment_status:f??"unpaid",equipment_estimate:l(g),expenses_total:Math.round(Y*100)/100,services_client_price:Math.round(l(q)*100)/100,tax_amount:Math.round(l(b)*100)/100,total_with_tax:Math.round(l(n)*100)/100,confirmed:!!J,technicians:Q,equipment:X,expenses:H},Z=Math.max(0,Number.parseFloat(p)||0);u.discount=Z,u.discount_type=I==="amount"?"amount":"percent";const T=l(x),M=!!N&&Number.isFinite(T)&&T>0;u.company_share_enabled=M,u.company_share_percent=M?T:0,u.company_share_amount=M?Math.max(0,l(G)):0,C!=null&&C!==""&&(u.paid_amount=Math.max(0,l(C))),E!=null&&E!==""&&(u.paid_percentage=Math.max(0,l(E))),(v==="amount"||v==="percent")&&(u.payment_progress_type=v),F!=null&&F!==""&&(u.payment_progress_value=l(F)),e&&(u.project_code=String(e).trim());const U=O!==void 0?O:K;if(U!==void 0){const c=W(U)||[];u.payments=c.map(s=>({type:s.type,amount:s.amount!=null?s.amount:null,percentage:s.percentage!=null?s.percentage:null,value:s.value!=null?s.value:null,note:s.note??null,recorded_at:s.recordedAt??null}))}return u.end_datetime||delete u.end_datetime,u.client_company||(u.client_company=null),u}function $(e={}){return z(e)}function le(e={}){return z(e)}function z(e={}){const o=e.id??e.projectId??e.project_id??null,t=Array.isArray(e.technicians)?e.technicians:[],a=t.map(n=>{if(n==null)return null;if(typeof n=="object"){const p=n.id??n.technician_id??n.technicianId;return p!=null?String(p):null}return String(n)}).filter(Boolean),i=(Array.isArray(e.equipment)?e.equipment:[]).map(n=>{const p=n?.equipment_id??n?.equipmentId??n?.id??null,I=n?.quantity??n?.qty??0,N=n?.barcode??n?.code??"",x=n?.description??n?.name??"";return{equipmentId:p!=null?String(p):null,qty:Number.parseInt(String(I),10)||0,barcode:N,description:x}}),_=(Array.isArray(e.expenses)?e.expenses:[]).map((n,p)=>({id:n?.id??`expense-${o??"x"}-${p}`,label:n?.label??"",amount:l(n?.amount??0),salePrice:l(n?.sale_price??n?.salePrice??0),note:n?.note??n?.notes??""})),m=l(e.company_share_percent??e.companySharePercent??0),f=e.company_share_enabled??e.companyShareEnabled,g=f!=null?f===!0||f===1||String(f).toLowerCase()==="true":m>0,h=e.payment_history??e.paymentHistory??e.payments??null,q=W(h),b=(()=>{const n=e.cancelled??e.canceled??e.is_cancelled??e.isCanceled;if(n===!0||n==="true"||n===1||n==="1")return!0;if(typeof n=="string"){const p=n.toLowerCase();return p==="yes"||p==="cancelled"||p==="canceled"}return!1})();return{id:o!=null?String(o):"",projectId:o!=null?Number(o):null,status:(()=>{const n=String(e.status??e.project_status??"").toLowerCase();if(b||n==="cancelled"||n==="canceled"||n==="ملغي"||n==="ملغى")return"cancelled";if(n==="completed"||n==="مكتمل")return"completed";if(n==="ongoing"||n==="in_progress"||n==="قيد التنفيذ")return"ongoing";if(n==="upcoming"||n==="قادم")return"upcoming"})(),cancelled:b,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:l(e.equipment_estimate??e.equipmentEstimate??0),expensesTotal:l(e.expenses_total??e.expensesTotal??0),servicesClientPrice:l(e.services_client_price??e.servicesClientPrice??0),taxAmount:l(e.tax_amount??e.taxAmount??0),totalWithTax:l(e.total_with_tax??e.totalWithTax??0),discount:l(e.discount??e.discount_value??0),discountType:e.discount_type??e.discountType??"percent",companyShareEnabled:g,companySharePercent:g?m:0,companyShareAmount:l(e.company_share_amount??e.companyShareAmount??0),paidAmount:l(e.paid_amount??e.paidAmount??0),paidPercent:l(e.paid_percentage??e.paidPercent??0),paymentProgressType:e.payment_progress_type??e.paymentProgressType??null,paymentProgressValue:e.payment_progress_value??e.paymentProgressValue??null,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:t.map(n=>typeof n=="object"?n:{id:n}),equipment:i,expenses:_,paymentHistory:q}}function he(e){return e instanceof ne}function D(e){if(e==null||e==="")return null;const o=k(String(e)).replace(/[^\d.,-]/g,"").trim();if(!o)return null;let t=o;const a=t.includes(","),r=t.includes(".");a&&(t=r?t.replace(/,/g,""):t.replace(/,/g,"."));const i=Number.parseFloat(t);return Number.isFinite(i)?i:null}function se(e){if(!e||typeof e!="object")return null;const o=e.type??e.payment_type??e.paymentType??e.kind??null;let t=typeof o=="string"?o.trim().toLowerCase():null;t==="percentage"&&(t="percent");const a=D(e.value);let r=D(e.amount),i=D(e.percentage);if(t==="amount"&&r==null&&a!=null?r=a:t==="percent"&&i==null&&a!=null&&(i=a),!t)if(r!=null&&r>=0)t="amount";else if(i!=null&&i>=0)t="percent";else if(a!=null&&a>=0)t="amount",r=a;else return null;if(t==="amount"){if(r==null||!Number.isFinite(r)||r<0)return null;r=Math.round(r*100)/100}if(t==="percent"){if(i==null||!Number.isFinite(i)||i<0)return null;i=Math.min(100,Math.round(i*100)/100)}const y=e.note??e.memo??e.description??null,_=y!=null?String(y).trim():null,m=e.recordedAt??e.recorded_at??e.date??null;let f=null;if(m){const h=new Date(m);Number.isNaN(h.getTime())||(f=h.toISOString())}f||(f=new Date().toISOString());const g=t==="amount"?r:t==="percent"?i:a;return{type:t,amount:r??null,percentage:i??null,value:g!=null?Math.round(g*100)/100:null,note:_&&_.length?_.slice(0,500):null,recordedAt:f}}function W(e){if(e!==void 0)return e===null?[]:Array.isArray(e)?e.map(o=>se(o)).filter(Boolean):[]}export{ge as buildProjectPayload,fe as closeProjectApi,me as createProjectApi,_e as deleteProjectApi,de as ensureProjectsLoaded,pe as getProjectsState,he as isApiError,le as mapLegacyProject,$ as mapProjectFromApi,ie as refreshProjectsFromApi,ye as reopenProjectApi,P as setProjectsState,V as updateProjectApi};
