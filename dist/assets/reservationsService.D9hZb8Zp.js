import{t as P,p as pe,n as b,j as z,d as me,b as we,h as sn,A as cn}from"./auth.BLFzWQsL.js";import{r as vt,i as on,D as nt,s as rn,k as ln,P as un,u as De,E as qt,j as dn,O as it,G as ye,H as fe,b as _e,I as Ft,J as pn}from"./state.BK2rhNHf.js";const mn=()=>P("reservations.create.summary.currency","SR");let Ae=[],ne=[],le=[],ue=[],V="create",Et=()=>{},Lt=()=>{};const ze=new Map,Ye=450;function fn(e){const t=ze.get(e);return t!=null&&Date.now()-t<Ye}function gn(e){ze.set(e,Date.now()),setTimeout(()=>{const t=ze.get(e);t!=null&&Date.now()-t>=Ye&&ze.delete(e)},Ye+50)}function Fe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function he(e={}){return{...e,assignmentId:e.assignmentId||Fe()}}function Ve(e){if(!e)return null;const t=String(e),n=Ae.find(s=>String(s?.id)===t);if(n)return{...n};const{technicians:i=[]}=me();return i.find(s=>String(s?.id)===t)||null}function Pe(e={},t=pe()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function at(e={},t=pe()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function wt(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=ne.find(c=>String(c.id).trim().toLowerCase()===n);if(i)return i;const s=dn(e);return s||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function gt(e){const t=wt(e,e?.name??""),n=pe(),i=Pe(t,n)||t?.name||"",s=at(t,n);return Je({assignmentId:Fe(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:s,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Je(e={}){const t={assignmentId:e.assignmentId||Fe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=wt(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=pe(),s=Pe(n,i)||t.positionLabel,c=at(n,i);t.positionLabel=s||t.positionLabel||n?.name||"",t.positionLabelAlt=c||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=Ve(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function be(){ne=on()}function _n(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return he(Je(t));const n=Ve(t),i=n?{assignmentId:Fe(),positionLabel:n.role||P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:Fe(),positionLabel:P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return he(Je(i))}).filter(Boolean):[]}function ge(e="create"){return e==="edit"?ue.map(he):le.map(he)}function se(e="create",t=[]){try{be()}catch{}const n=_n(t);e==="edit"?(ue=n,Ie("edit-selected-technicians-list",ue,"edit"),Lt()):(le=n,Ie("selected-technicians-list",le,"create"),Et()),Ee()}function Ke(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),o=document.getElementById("edit-res-end")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=a?De(a,l):null,p=o?De(o,u):null;let y=null;const _=document.getElementById("edit-res-index")?.value;if(_!=null){const h=Number.parseInt(_,10);if(Number.isInteger(h)){const{reservations:k=[]}=me(),m=k?.[h];m&&(y=m.id??m.reservationId??null)}}return{start:d,end:p,ignoreReservationId:y}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",s=document.getElementById("res-end-time")?.value?.trim()||"00:00",c=t?De(t,i):null,r=n?De(n,s):null;return{start:c,end:r,ignoreReservationId:null}}function Ee(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=ge(V).length;if(t){const n=P("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",b(String(t)));e.textContent=n}else e.textContent=P("technicians.picker.selectionInfo","No crew selected yet")}function Me(e){const t=Number.isFinite(e)?e:0;return`${b(t.toFixed(2))} ${mn()}`}function yn(e){const t=ge(V),n=new Set(t.filter(l=>l.assignmentId!==e&&l.technicianId).map(l=>l.technicianId)),i=Ae.length?Ae:me().technicians||[],{start:s,end:c,ignoreReservationId:r}=Ke(V),a=!!(s&&c);return i.map(l=>{const u=String(l.id),d=n.has(u),p=a?nt(u,s,c,r):!1,y=b(l.name||l.full_name||l.fullName||l.email||u);return{id:u,label:y,disabled:d||p,conflict:p,taken:d}})}function ee(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=ge(V);if(!t.length){const n=P("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=P("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}be(),e.innerHTML=t.map((n,i)=>{const s=b(String(i+1)),c=Me(n.positionClientPrice||0),r=yn(n.assignmentId),a=P("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),o=n.technicianId!=null?String(n.technicianId):"",l=n.technicianName?b(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,d=P("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),p=P("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),y=r.map(A=>{const g=o===A.id,C=A.disabled&&!g?`${A.label} ${A.conflict?p:d}`:A.label;return`
        <option value="${A.label}"
                data-id="${A.id}"
                data-disabled="${A.disabled?"true":"false"}"
                data-conflict="${A.conflict?"true":"false"}"
                data-taken="${A.taken?"true":"false"}"
                label="${C}"></option>
      `}).join("");let _=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!_||String(_).trim()===""){const A=n.positionId?ne.find(N=>String(N.id)===String(n.positionId)):null,g=!A&&n.positionKey?ne.find(N=>String(N.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(A||g){const N=A||g;_=Pe(N,pe())||N?.name||""}}const h=n.positionLabelAlt?`<div class="text-muted small">${b(n.positionLabelAlt)}</div>`:"",k=P("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),m=P("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${s}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${b(_||P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${h}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${m}">${c}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${a}"
              value="${o?l:""}"
              aria-label="${P("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${y}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${k}">
            ${k}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{Tt(n.dataset.assignmentId,V)}),n.dataset.listenerAttached="true")}),hn(e)}function hn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,s=()=>{bn(n,i)};n.addEventListener("change",s),n.addEventListener("blur",s),n.dataset.listenerAttached="true"})}function bn(e,t){if(!t||fn(t))return;gn(t);const n=e.value?.trim()??"";if(!n){Be(t,"");return}const i=e.getAttribute("list"),s=i?document.getElementById(i):null,c=s?Array.from(s.options):[],r=b(n).toLowerCase(),a=c.find(l=>b(l.value).toLowerCase()===r);if(!a){z(P("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",Be(t,"");return}if(a.dataset.disabled==="true"){if(a.dataset.conflict==="true")try{const{start:l,end:u,ignoreReservationId:d}=Ke(V),p=a.dataset.id||"",y=l&&u&&p?qt(String(p),l,u,d):[],_=P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),h=y&&y.length?`: ${y.join("ØŒ ")}`:"";z(`${_}${h}`,"warning",6e3)}catch{z(P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else z(P("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const o=a.dataset.id;if(!o){z(P("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",Be(t,"");return}Be(t,o)}function je(){const e=document.getElementById("crew-position-list");if(!e)return;be();const t=document.getElementById("crew-position-search"),n=b(String(t?.value||"")).trim().toLowerCase(),s=ge(V).reduce((a,o)=>{const l=o?.positionId!=null?String(o.positionId):null;return l&&a.set(l,(a.get(l)||0)+1),a},new Map),c=ne.filter(a=>n?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(l=>b(String(l)).toLowerCase()).join(" ").includes(n):!0);if(!c.length){e.innerHTML=`<div class="text-muted">${P("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const r=pe();e.innerHTML=c.map(a=>{const o=Pe(a,r)||a.name||"",l=at(a,r),u=Me(a.clientPrice||0),d=Me(a.cost||0),p=l?`<span class="crew-position-card__subtitle">${b(l)}</span>`:"",y=P("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),_=P("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),h=P("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),k=s.get(String(a.id))||0,m=P("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",b(String(k)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${b(o)}">
        ${k>0?`<span class="crew-position-card__badge" aria-label="${m}">${b(String(k))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${b(o)}</h6>
            ${p}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${y}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${_}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${y}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${b(String(a.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${_}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${a.clientPrice==null?"":b(String(a.clientPrice))}" inputmode="decimal" placeholder="${b("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${a.id}">${P("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${a.id}">${P("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${a.id}">
            ${h}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${a.id}">
            ${P("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.stopPropagation(),Ue(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{a.dataset.editing!=="true"&&Ue(a.dataset.positionId)}),a.addEventListener("keydown",o=>{if(o.key==="Enter"||o.key===" "){if(o.preventDefault(),a.dataset.editing==="true")return;Ue(a.dataset.positionId)}}),a.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const l=a.closest(".crew-position-card");if(!l)return;const u=l.querySelector(".crew-position-card__metrics"),d=l.querySelector(".crew-position-card__footer"),p=l.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),p&&(p.hidden=!1),l.dataset.editing="true";const y=l.querySelector(".crew-position-edit-cost"),_=l.querySelector(".crew-position-edit-client"),h=k=>{k.addEventListener("input",m=>{const g=b(m.target.value).replace(/[^0-9.]/g,"");if(g!==m.target.value){const N=m.target.selectionEnd||g.length;m.target.value=g,m.target.setSelectionRange(N,N)}},{once:!0})};y&&h(y),_&&h(_)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation();const l=a.closest(".crew-position-card"),u=a.dataset.positionId;if(!(!l||!u))try{const d=l.querySelector(".crew-position-edit-cost"),p=l.querySelector(".crew-position-edit-client"),y=b(d?.value||"").trim(),_=b(p?.value||"").trim(),h=y===""?0:Number.parseFloat(y),k=_===""?null:Number.parseFloat(_);if(!Number.isFinite(h)||h<0){z(P("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(k!=null&&(!Number.isFinite(k)||k<0)){z(P("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),p?.focus();return}be();const m=ne.find(A=>String(A.id)===String(u));if(!m){z(P("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await un(u,{name:m.name,cost:Number(h.toFixed(2)),clientPrice:k==null?null:Number(k.toFixed(2)),labelAr:m.labelAr,labelEn:m.labelEn}),z(P("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),je(),ee()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const p=d?.message||P("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");z(p,"error")}}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const l=a.closest(".crew-position-card");if(!l)return;const u=l.querySelector(".crew-position-card__metrics"),d=l.querySelector(".crew-position-card__footer"),p=l.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),p&&(p.hidden=!0),delete l.dataset.editing}),a.dataset.listenerAttached="true")})}function Ue(e){be();const t=ne.find(s=>String(s.id)===String(e)),n=gt(t||{id:null,name:""}),i=ge(V);i.push(n),se(V,i),ee(),z(P("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Tt(e,t="create"){if(!e)return;const n=ge(t).filter(i=>i.assignmentId!==e);se(t,n),ee(),z(P("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function Be(e,t){if(!e)return;const n=ge(V),i=n.find(l=>l.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,se(V,n),ee(),z(P("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(n.find(l=>l.assignmentId!==e&&l.technicianId===t)){z(P("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),ee();return}const c=Ve(t),{start:r,end:a,ignoreReservationId:o}=Ke(V);if(r&&a&&nt(String(t),r,a,o)){try{const l=qt(String(t),r,a,o),u=P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=l&&l.length?`: ${l.join("ØŒ ")}`:"";z(`${u}${d}`,"warning",6e3)}catch{z(P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}ee();return}c?(i.technicianId=String(c.id),i.technicianName=c.name??null,i.technicianRole=c.role??null,i.technicianPhone=c.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),se(V,n),ee(),i.technicianName?z(P("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",b(i.technicianName)),"success"):z(P("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function _t(e="create"){V=e,ee(),Ee();let t=rn();if(!Array.isArray(t)||t.length===0)try{const i=await vt();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(Ae=t);try{await ln()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}be(),je(),ee(),Ee();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function Nn(){return ge(V).map(he)}function kn(){const e=Nn(),{start:t,end:n,ignoreReservationId:i}=Ke(V);if(t&&n){const c=e.filter(r=>r.technicianId&&nt(r.technicianId,t,n,i));if(c.length>0){const r=c.map(o=>o.technicianName||o.technicianId).join(P("reservations.list.crew.separator","ØŒ ")),a=P("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",r);c.forEach(o=>{o.technicianId=null,o.technicianName=null}),se(V,e),ee(),z(a),Ee();return}}se(V,e);const s=document.getElementById("selectTechniciansModal");s&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s)?.hide?.(),z(P("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function Ie(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${P("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}be(),i.innerHTML=t.map(s=>{let c=s.positionLabel??s.position_label??s.position_name??s.role??s.position??"";if(!c||String(c).trim()===""){const d=s.positionId?ne.find(y=>String(y.id)===String(s.positionId)):null,p=!d&&s.positionKey?ne.find(y=>String(y.name).toLowerCase()===String(s.positionKey).toLowerCase()):null;c=d?Pe(d,pe())||d?.name||"":p&&(Pe(p,pe())||p?.name)||""}const r=b(c||P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=s.technicianName?`${b(s.technicianName)}`:P("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let o=Number(s.positionClientPrice);if(!Number.isFinite(o)||o<=0){const d=[s.position_client_price,s.client_price,s.customer_price,s.daily_total,s.dailyTotal,s.total];for(const p of d){const y=Number(p);if(Number.isFinite(y)&&y>0){o=y;break}}}if((!Number.isFinite(o)||o<=0)&&(s.positionId||s.positionKey)){const d=s.positionId?ne.find(_=>String(_.id)===String(s.positionId)):null,p=!d&&s.positionKey?ne.find(_=>String(_.name).toLowerCase()===String(s.positionKey).toLowerCase()):null,y=d||p||null;y&&Number.isFinite(Number(y.clientPrice))&&(o=Number(y.clientPrice))}const l=Me(Number.isFinite(o)&&o>0?o:0),u=P("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${s.assignmentId}">
        <span class="technician-chip-name">${r}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${l}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${s.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(s=>{s.dataset.listenerAttached||(s.addEventListener("click",()=>{Tt(s.dataset.assignmentId,s.dataset.context)}),s.dataset.listenerAttached="true")})}}function An(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",r=>{const a=document.getElementById("res-customer")?.value?.trim(),o=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),p=!!(o&&l),y=!!(u&&d),_=!!a;if(!p||!y){r.preventDefault(),z(P("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!_){r.preventDefault(),z(P("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}_t("create")}),e.dataset.listenerAttached="true";const c=()=>{const r=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),o=document.getElementById("res-end")?.value?.trim(),l=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(r&&a&&o&&l&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(r=>document.getElementById(r)).filter(Boolean).forEach(r=>{["input","change"].forEach(a=>r.addEventListener(a,c))}),c()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>_t("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{je()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",kn),i.dataset.listenerAttached="true");const s=document.getElementById("selectTechniciansModal");s&&!s.dataset.listenerAttached&&window.bootstrap?.Modal&&(s.addEventListener("shown.bs.modal",async()=>{if(!Ae.length&&(!me().technicians||me().technicians.length===0))try{await vt()}catch(c){console.warn("[crew-picker] fetch on show failed",c)}je(),ee(),Ee()}),s.addEventListener("hidden.bs.modal",()=>{const c=document.getElementById("crew-position-search");c&&(c.value="")}),s.dataset.listenerAttached="true"),Ie("selected-technicians-list",le,"create"),Ie("edit-selected-technicians-list",ue,"edit")}function Pi({onDraftChange:e,onEditChange:t}={}){Et=typeof e=="function"?e:()=>{},Lt=typeof t=="function"?t:()=>{},An()}function Pn(){return le.map(he)}function In(){return ue.map(he)}function yt(){return le.map(e=>e.technicianId).filter(Boolean).map(String)}function ht(){return ue.map(e=>e.technicianId).filter(Boolean).map(String)}function Ii(e=[]){se("create",e)}function Ci(e=[]){se("edit",e)}function Si(){se("create",[])}function vi(){se("edit",[])}function bt(e=[]){return e.map(t=>{if(t.technicianId){const n=Ve(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function qi(e=[]){Array.isArray(e)&&e.length&&(Ae=e),le=bt(le),ue=bt(ue),Ie("selected-technicians-list",le,"create"),Ie("edit-selected-technicians-list",ue,"edit"),ee()}function Nt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function $t(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=b(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),s=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const c=t.includes(","),r=t.includes(".");if(c&&r){const o=t.lastIndexOf(","),l=t.lastIndexOf(".");o>l?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(c){const o=t.split(",");o.length===2&&o[1].length===3?t=o.join(""):t=t.replace(/,/g,".")}else if(r){const o=t.split(".");if(o.length===2){const[,l]=o;if(l.length===3){const u=o.join("");/^[0-9]+$/.test(u)&&(t=u)}}else o.length>2&&(t=Nt(t))}if(t=t.replace(/,/g,""),t=Nt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const a=Number.parseFloat(t);return Number.isFinite(a)?s?-a:a:Number.NaN}function $(e){return $t(e)}function x(e){const t=$t(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function qe(e){return b(String(e??"")).trim().toLowerCase()}function Rt(e=""){return b(String(e)).trim().toLowerCase()}const Cn=2;function Sn(e){const t=$(e);return Number.isFinite(t)?t.toFixed(Cn):"0.00"}function Ge(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(b(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return x(i)}return 1}function vn(e={}){const t=e?.desc||e?.description||e?.name||"",n=Rt(t),i=Sn(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function qn(e=[]){const t=new Map;return e.forEach((n,i)=>{const s=vn(n);if(!s)return;if(!t.has(s)){const r=n?.desc||n?.description||n?.name||"",a=Rt(r),o=At(n),l=Pt(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(s,{key:s,description:r,normalizedDescription:a,unitPrice:o,unitCost:l,image:u,items:[],itemIndices:[],barcodes:[]})}const c=t.get(s);c.items.push(n),c.itemIndices.push(i),n?.barcode&&c.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,s)=>i+Ge(s),0)})).map(n=>{const i=n.quantity||0,s=n.items.reduce((_,h)=>{const k=At(h),m=Ge(h);return _+k*m},0),c=x(s),r=$(n.unitPrice),a=Number.isFinite(r)?r:0,o=n.items.reduce((_,h)=>{const k=Pt(h),m=Ge(h);return _+k*m},0),l=x(o),u=$(n.unitCost),d=Number.isFinite(u)?u:0,p=i>0?x(c/i):x(a),y=i>0?x(l/i):x(d);return{...n,quantity:i,count:i,totalPrice:c,unitPrice:p,totalCost:l,unitCost:y}})}function kt(e={}){return(_e(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??qe(n?.barcode),qty:(()=>{const i=Number.parseFloat(b(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=$(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=$(n?.cost??n?.unit_cost??n?.unitCost??n?.rental_cost??n?.purchase_price);return Number.isFinite(i)?i:0})()}))}function Fn(e={},{packageQuantity:t=1}={}){const n=ye(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=n&&fe(n)||e,s=_e(i)||[],c=Number.isFinite(Number(t))&&Number(t)>0?Number(t):1;return s.map(r=>{const o=$(r?.price??r?.unit_price??r?.unitPrice),l=Number.isFinite(o)?x(o):0,u=$(r?.cost??r?.unit_cost??r?.unitCost??r?.rental_cost??r?.purchase_price),d=Number.isFinite(u)?x(u):0,p=1*c,y=x(l*p),_=x(d*p);return{equipmentId:r?.equipmentId??r?.equipment_id??null,barcode:r?.barcode??r?.normalizedBarcode??"",desc:r?.desc??r?.description??"",qtyPerPackage:1,packageQuantity:c,totalUnits:p,unitPrice:l,perDayTotal:y,unitCost:d,perDayCost:_}})}function En(e={},{packageQuantity:t=1,days:n=1}={}){const i=Fn(e,{packageQuantity:t}),s=x(i.reduce((o,l)=>o+(Number(l.perDayTotal)||0),0)),c=x(i.reduce((o,l)=>o+(Number(l.perDayCost)||0),0)),r=x(s*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1)),a=x(c*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1));return{lines:i,perDayTotal:s,total:r,perDayCostTotal:c,costTotal:a}}function Ln(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(b(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function wn(e={},t=[],n=null){try{const l=ye(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(l){const u=fe(l);if(u){const d=u.price??u.total_price??u.package_price,p=$(d);if(Number.isFinite(p)&&p>0)return x(p)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,s=$(i);if(Number.isFinite(s)&&s>0)return x(s);const c=e.total_price??e.totalPrice??e.total,r=$(c),a=Number.parseFloat(b(String(n)).replace(/[^0-9.]/g,"")),o=Number.isFinite(a)&&a>0?a:Ln(e);return Number.isFinite(r)&&r>0&&o>0?x(r/o):0}function Tn(e={}){const t=Array.isArray(e?.items)?e.items:[],n=qn(t),i=it(),s=new Set,c=new Map;i.forEach(g=>{const N=ye(g?.id??g?.packageId??g?.package_id??g?.code);N&&s.add(N);const C=b(String(g?.package_code??g?.code??"")).trim().toLowerCase();C&&c.set(C,N||C)});const r=(g,N=0)=>{const C=ye(g?.package_code??g?.packageId??g?.package_id??g?.code??g?.id??null),F=b(String(g?.package_code??g?.code??g?.barcode??"")).trim().toLowerCase();return C||(F&&c.has(F)?c.get(F):F||`pkg-${N}`)},a=new Map,o=new Map,l=(g,N=0,C="packages")=>{if(!g||typeof g!="object")return;const L=r(g,N)||`pkg-${N}`;if(!a.has(L)){a.set(L,{source:g,normalizedId:L,index:N,itemSource:C==="items"?g:null});return}const T=a.get(L);if(T.source||(T.source=g),C==="items"&&(T.itemSource=g,T.source&&typeof T.source=="object")){const I=Array.isArray(T.source.packageItems)&&T.source.packageItems.length>0,E=Array.isArray(g.packageItems)&&g.packageItems.length>0;!I&&E&&(T.source={...T.source,packageItems:g.packageItems}),!T.source.image&&g.image&&(T.source={...T.source,image:g.image})}},u=g=>{if(!g||typeof g!="object")return;const N=r(g);N&&(o.has(N)||o.set(N,g))};Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(u),Array.isArray(e?.packages)&&e.packages.forEach((g,N)=>{l(g,N,"packages"),u(g)}),t.forEach((g,N)=>{if(g&&typeof g=="object"&&(g.type==="package"||Array.isArray(g?.packageItems))){const C=r(g,N+a.size);l({...g,package_id:C,packageId:C,package_code:g.package_code??g.code},N+a.size,"items")}});const d=[],p=new Set,y=new Set;a.forEach(({source:g,itemSource:N=null,normalizedId:C},F)=>{const L=C?fe(C):null,T=g&&typeof g=="object"?g:{},I=L?{...L,...T}:T,E=N&&typeof N=="object"?N:null;let f=kt(I);(!Array.isArray(f)||f.length===0)&&E&&(f=kt(E)),f.forEach(q=>{const D=q?.normalizedBarcode??qe(q?.barcode);D&&p.add(D);const K=q?.equipmentId??q?.equipment_id??null;K!=null&&y.add(String(K))});let W=1,M=wn(I,f,W);const te=[E?.price,E?.unit_price,E?.unitPrice];for(const q of te){const D=$(q);if(Number.isFinite(D)&&D>0){M=x(D);break}}M=x(M);const Y=[I?.unit_cost,I?.unitCost,I?.cost,E?.unit_cost,E?.unitCost,E?.cost];let B=0;for(const q of Y){const D=$(q);if(Number.isFinite(D)&&D>=0){B=x(D);break}}if((!B||B===0)&&o.has(F)){const q=o.get(F),D=$(q?.unit_cost??q?.unitCost??q?.cost??q?.package_cost??q?.rental_cost??q?.purchase_price??q?.internal_cost??q?.equipment_cost??q?.item_cost);Number.isFinite(D)&&D>0&&(B=x(D))}const de=(()=>{const q=[I?.pricing_mode,I?.pricingMode,I?.pricing,E?.pricing_mode,E?.pricingMode,E?.pricing];for(const D of q){if(D==null)continue;const K=String(D).trim().toLowerCase();if(K==="daily"||K==="per_day"||K==="day")return"daily";if(K==="fixed"||K==="per_booking"||K==="booking")return"fixed"}return"daily"})(),R=[E?.total,E?.total_price,E?.totalPrice,I?.total,I?.total_price,I?.totalPrice];let v=NaN;for(const q of R){const D=$(q);if(Number.isFinite(D)&&D>=0){v=D;break}}Number.isFinite(v)||(v=M*W),v=x(v);const X=[I?.package_code,I?.code,I?.packageCode,I?.displayCode,I?.display_code,I?.barcode,E?.package_code,E?.code,E?.packageCode,E?.displayCode,E?.display_code,E?.barcode,C,F].find(q=>q==null?!1:String(q).trim().length>0),j=X!=null?b(String(X)).trim():"";if(j){const q=qe(j);q&&p.add(q)}const oe=f.map(q=>b(String(q?.barcode??q?.normalizedBarcode??""))).filter(Boolean),U=[I?.name,I?.package_name,I?.title,E?.name,E?.desc,E?.package_name,j,b(String(F))].find(q=>q!=null&&String(q).trim()!=="")||b(String(j||F)),J=f.find(q=>q?.image)?.image??I?.image??E?.image??null,ie=1;d.push({key:`package::${F}`,description:U,normalizedDescription:b(String(U)),unitPrice:M,unitCost:B,totalPrice:v,pricingMode:de,quantity:W,count:ie,image:J,barcodes:oe,barcode:j,package_code:j,packageDisplayCode:j,items:[{type:"package",packageItems:f,packageId:C,desc:U,price:M,cost:B,qty:ie,barcode:j}],type:"package",packageItems:f,packageId:C})});const _=new Set(Array.from(p).map(g=>qe(g)).filter(Boolean)),h=n.filter(g=>{if(g.items.some(L=>L?.type==="package")&&d.length>0)return!1;const C=(L={})=>[L.packageId,L.package_id,L.package_code,L.packageCode,L.bundleId,L.bundle_id].some(T=>T!=null&&T!=="");return!g.items.every(L=>{const T=$n(L),I=T!=null?String(T):null;if(I&&y.has(I))return!0;const E=L?.barcode?qe(L.barcode):null;return!!(E&&_.has(E)||C(L))})}),k=new Set,m=[];return d.forEach(g=>{const N=r({package_code:g?.package_code,packageId:g?.packageId,package_id:g?.packageId,code:g?.barcode,id:g?.packageId});!N||k.has(N)||(k.add(N),m.push(g))}),{groups:m.length?[...m,...h]:n,packageGroups:d,groupedItems:n,filteredGroupedItems:h,packagesMap:a}}function $n(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function At(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=$(n);if(Number.isFinite(i))return i}return 0}function Pt(e={}){const t=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const n of t){const i=$(n);if(Number.isFinite(i))return i}return 0}function Fi(e){const t=e?.status??e?.reservationStatus??null;if(t){const s=String(t).trim().toLowerCase();if(s==="completed"||s==="closed"||s==="Ù…ØºÙ„Ù‚"||s==="Ù…ÙƒØªÙ…Ù„"||s==="Ù…Ù†ØªÙ‡ÙŠ"||s==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const n=new Date(e.end);return Number.isNaN(n.getTime())?!1:n<new Date}function Rn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Ei(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,s=i!=null&&i!==""&&i!=="null",c=s?Rn(t?.status??t?.status_label??t?.statusLabel??""):null,r=s&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(c));return{reservationConfirmed:n,projectLinked:s,projectStatus:c,projectConfirmed:r,effectiveConfirmed:s?r:n}}const xt=10;function Dt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=$(n);if(Number.isFinite(i))return x(i)}return 0}function xn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=$(n);if(Number.isFinite(i))return x(i)}return Dt(e)}function Dn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=me();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,s)=>{const c=n.get(String(s));if(!c)return i;const r=Dt(c),a=xn(c);return{costPerDay:i.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const Bn=1440*60*1e3,ke=.01;function Ne(e){if(e==null||e==="")return null;const t=b(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function It(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let s=Number.isFinite(e)?e:0;if(s<t&&(s=t),s>n&&(s=n),i!=null){const c=10**i;s=Math.round(s*c)/c}return s}function Bt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function st({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:s=null,history:c=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,a=t==="amount"?"amount":t==="percent"?"percent":null;let o=Ne(i),l=Ne(s);const u=Ne(n);let d=0,p=0;Array.isArray(c)&&c.length&&c.forEach(m=>{if(!m)return;const A=m.type==="amount"||m.type==="percent"?m.type:null,g=Ne(m.value),N=Ne(m.amount),C=Ne(m.percentage);if(A==="amount"){const F=N??g;F!=null&&(d+=F,r>0&&(p+=F/r*100))}else if(A==="percent"){const F=C??g;F!=null&&(p+=F,r>0&&(d+=F/100*r))}else N!=null&&(d+=N,r>0&&(p+=N/r*100)),C!=null&&(p+=C,r>0&&(d+=C/100*r))}),a==="amount"&&u!=null?o=u:a==="percent"&&u!=null?l=u:a===null&&u!=null&&(l!=null?l=u:o=u),(o==null||o<=0)&&l!=null&&l>0&&r>0&&(o=r*(l/100)),(l==null||l<=0)&&o!=null&&o>0&&r>0&&(l=o/r*100);const y=o??0,_=l??0;o=y+d,l=_+p,o=It(o??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),l=It(l??0,{min:0,max:100,precision:2});let h=a;return h||(o>0&&r>0?h="amount":l>0&&(h="percent")),{paidAmount:o,paidPercent:l,paymentProgressType:h,paymentProgressValue:h==="amount"?o:h==="percent"?l:null}}function ct({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const s=Bt(e),c=Number.isFinite(Number(i))?Number(i):0,r=Number.isFinite(Number(t))?Number(t):0,a=Number.isFinite(Number(n))?Number(n):0;if(s==="paid")return"paid";const o=c>0&&r>=c-ke,l=a>=100-ke*100;if(o||l)return"paid";const u=r>ke||a>ke;return s==="partial"||u?"partial":"unpaid"}function zn(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const s=i.getTime()-n.getTime();if(s<=0)return 1;const c=s/Bn;return Math.max(1,Math.ceil(c))}function Ce({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:s="percent",applyTax:c=!1,start:r=null,end:a=null,companySharePercent:o=null,groupingSource:l=null}={}){const u=zn(r,a);let d=!1;try{if(typeof window<"u"&&window.location){const v=new URL(window.location.href),w=(v.searchParams.get("noDays")||v.searchParams.get("pricing")||"").toLowerCase();d=w==="1"||w==="true"||w==="fixed"||w==="nodays"}}catch{}const p=l&&typeof l=="object"?l:{items:Array.isArray(e)?e:[]},{groups:y}=Tn(p),_=v=>{if((v?.type||"").toLowerCase()==="package")return!0;const w=Array.isArray(v?.items)?v.items:[];if(!w.length)return!1;if(w.some(H=>H?.reservation_id!=null||H?.reservationId!=null))return!0;const j=w.every(H=>H?.unit_price!=null||H?.unitPrice!=null),oe=w.some(H=>H?.daily_rate!=null||H?.dailyRate!=null||H?.unit_rate!=null||H?.unitRate!=null||H?.price!=null);return!!(j&&!oe)};let h=0,k=0;(Array.isArray(y)?y:[]).forEach(v=>{const w=Number.isFinite(Number(v?.quantity))?Number(v.quantity):0,X=Number.isFinite(Number(v?.unitPrice))?Number(v.unitPrice):0,j=Number.isFinite(Number(v?.unitCost))?Number(v.unitCost):0,oe=String(v?.type||"").toLowerCase()==="package",H=_(v),U=d||H?1:u;if(oe){const J={package_code:v?.package_code||v?.packageDisplayCode||v?.barcode||v?.packageId||v?.key,packageItems:Array.isArray(v?.packageItems)?v.packageItems:void 0},ie=En(J,{packageQuantity:w,days:U}),q=Number.isFinite(Number(ie.total))?Number(ie.total):w*(Number.isFinite(X)?X:0)*U,D=(()=>{const K=Number(ie?.costTotal);if(Number.isFinite(K))return K;const xe=Number(ie?.perDayCostTotal);return Number.isFinite(xe)?xe*U:w*(Number.isFinite(j)?j:0)*U})();h+=q,k+=D}else h+=w*X*U,k+=w*j*U});const m=x(h),A=x(k),g=Array.isArray(n)?n:[],N=g.length?g.map(v=>v?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:C,totalPerDay:F}=g.length?g.reduce((v,w)=>{const X=$(w?.positionCost??w?.position_cost??w?.cost??w?.dailyWage??w?.daily_wage??0),j=$(w?.positionClientPrice??w?.position_client_price??w?.clientPrice??w?.dailyTotal??w?.daily_total??w?.total??0),oe=Number.isFinite(X)?X:0,H=Number.isFinite(j)?j:0;return{costPerDay:v.costPerDay+oe,totalPerDay:v.totalPerDay+H}},{costPerDay:0,totalPerDay:0}):Dn(N),L=x(F*u),T=x(C*u),I=x(m+L),E=Number(i)||0;let f=s==="amount"?E:I*(E/100);(!Number.isFinite(f)||f<0)&&(f=0),f>I&&(f=I);const W=Math.max(0,I-f),M=Number.isFinite(o)&&Number(o)>0?Number(o):0,te=M>0?Math.max(0,W*(M/100)):0,Y=W+te;let B=c?Y*.15:0;(!Number.isFinite(B)||B<0)&&(B=0),B=Number(B.toFixed(2));const ce=Y+B,de=Math.max(0,Number(ce.toFixed(2))),R=Math.max(0,Math.max(0,m+L-f)-T-A);return{rentalDays:u,equipmentTotal:m,equipmentCostTotal:A,crewTotal:L,crewCostTotal:T,discountAmount:f,subtotalAfterDiscount:W,taxableAmount:Y,taxAmount:B,finalTotal:de,companySharePercent:M,companyShareAmount:te,netProfit:R}}function Li(e=[],t=0,n="percent",i=!1,s=[],{start:c=null,end:r=null,companySharePercent:a=null}={}){const o=y=>y&&typeof y=="object"&&(y.positionId!==void 0||y.position_id!==void 0||y.positionLabel!==void 0||y.position_name!==void 0||y.positionClientPrice!==void 0),l=Array.isArray(s)&&s.some(o)?s:[],u=l.length?l.map(y=>y?.technicianId).filter(Boolean):Array.isArray(s)?s:[];return Ce({items:e,technicianIds:u,crewAssignments:l,discount:t,discountType:n,applyTax:i,start:c,end:r,companySharePercent:a??xt}).finalTotal}function zt({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:s,paymentStatus:c,paidAmount:r=0,paidPercent:a=0,companySharePercent:o=null,companyShareAmount:l=null,taxAmount:u=null,netProfit:d=null,totalKey:p="reservations.summary.total",equipmentTotal:y=null,crewTotal:_=null,equipmentCostTotal:h=null}){const k=P("reservations.create.summary.currency","SR"),m=b(String(e)),A=b(String(t)),g=b(String(n??1)),N=b(String(i)),C=Bt(c),F=C==="paid"?"Ù…Ø¯ÙÙˆØ¹":C==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",L=P(`reservations.create.paymentStatus.${C}`,F),T=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,I=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,E=T>ke||I>ke,f=P("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),W=b(T.toFixed(2)),M=b(I.toFixed(I%1?2:0)),te=P("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),Y=P("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),B=P("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),ce=P("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),de=P("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),R=P("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),v=P("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),w=P("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),j=P(p==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",P("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),oe=P("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),H=P("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),U=Number.isFinite(d)?Math.max(0,Number(d)):null,J=[{label:te,value:A},{label:Y,value:g},{label:B,value:N}],ie=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;ie!=null&&J.push({label:ce,value:`${b(ie.toFixed(2))} ${k}`});const q=Number.isFinite(Number(h))?Math.max(0,Number(h)):null;q!=null&&J.push({label:de,value:`${b(q.toFixed(2))} ${k}`});const D=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;if(D!=null&&J.push({label:R,value:`${b(D.toFixed(2))} ${k}`}),s){let re=P("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(re=`${b(Number(u).toFixed(2))} ${k}`),J.push({label:v,value:re})}const K=Number.isFinite(o)?Number(o):null;if(K!==null&&K>0){const re=Number.isFinite(l)?Number(l):e*(K/100),ve=b(String(K)),nn=b(Number.isFinite(re)?re.toFixed(2):"0"),an=`${ve}% (${nn} ${k})`;J.push({label:oe,value:an})}if(U!==null&&Math.abs(U-Number(e))>.009){const re=b(U.toFixed(2));J.push({label:H,value:`${re} ${k}`})}J.push({label:w,value:L}),E&&J.push({label:f,value:`${W} ${k} (${M}%)`});const xe=`${m} ${k}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${J.map(({label:re,value:ve})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${re}</span>
            ${ve?`<span class="reservation-summary-value">${ve}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${j}</span>
          <span class="reservation-summary-value">${xe}</span>
        </div>
      </div>
    </div>
  `}function Mn({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:s,paymentProgressType:c=null,paymentProgressValue:r=null,start:a,end:o,companySharePercent:l=null,paymentHistory:u=[]}){const d=Pn(),p=typeof yt=="function"?yt()??[]:[],y=Array.isArray(p)?p.map(String):[],_=d.length?d.map(F=>F?.technicianId).filter(Boolean).map(String):y,h=d.length||_.length,k=Number.isFinite(l)?Number(l):null,m=Ce({items:e,technicianIds:_,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:a,end:o,companySharePercent:k}),A=st({totalAmount:m.finalTotal,progressType:c,progressValue:r,history:u}),g=ct({manualStatus:s,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:m.finalTotal}),N=zt({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:h,applyTax:i,paymentStatus:g,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit,equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal,equipmentCostTotal:m.equipmentCostTotal}),C={paymentStatus:g,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:m.finalTotal};return Mn.lastResult=C,Hn(N),N}function jn({items:e,discount:t,discountType:n,applyTax:i,paidStatus:s,paymentProgressType:c=null,paymentProgressValue:r=null,start:a,end:o,companySharePercent:l=null,paymentHistory:u=[]}){const d=In(),p=typeof ht=="function"?ht()??[]:[],y=Array.isArray(p)?p.map(String):[],_=d.length?d.map(F=>F?.technicianId).filter(Boolean).map(String):y,h=d.length||_.length,k=Number.isFinite(l)?Number(l):null,m=Ce({items:e,technicianIds:_,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:a,end:o,companySharePercent:k}),A=st({totalAmount:m.finalTotal,progressType:c,progressValue:r,history:u}),g=ct({manualStatus:s,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:m.finalTotal}),N=zt({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:h,applyTax:i,paymentStatus:g,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal,equipmentCostTotal:m.equipmentCostTotal}),C={html:N,paymentStatus:g,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:m.finalTotal};return jn.lastResult=C,N}function Hn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Ct(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Ct(n,e))}function Ct(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Vn=me()||{};let Q=(Vn.reservations||[]).map(Yt);function Z(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const Mt="__reservation_packages_cache__",jt="__reservation_item_cost_cache__";function Ht(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Vt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Kt(){const e=Ht();if(!e)return{};try{const t=e.getItem(Mt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function St(e){const t=Ht();if(t)try{t.setItem(Mt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function ot(){const e=Vt();if(!e)return{};try{const t=e.getItem(jt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation item cost cache",t),{}}}function Xe(e){const t=Vt();if(t)try{t.setItem(jt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation item cost cache",n)}}function Kn(e,t=0){if(!e||typeof e!="object")return null;const n=e.equipment_id??e.equipmentId??e.id??null,i=b(String(e.barcode??e.code??"")).trim(),s=Z(S(e.cost??e.unit_cost)),c=Z(S(e.price??e.unit_price)),r=Number.isFinite(s),a=Number.isFinite(c);return!r&&!a?null:{key:n!=null?`id:${n}`:i?`bc:${i}`:`idx:${t}`,equipmentId:n,barcode:i,cost:r?s:null,price:a?c:null}}function On(e,t){if(!e)return;const n=Array.isArray(t)?t.map((c,r)=>Kn(c,r)).filter(Boolean):[],i=ot(),s=String(e);if(!n.length){i[s]&&(delete i[s],Xe(i));return}i[s]=n,Xe(i)}function Qn(e=[]){const t=ot(),n=new Set;e.forEach(s=>{const c=s?.id??s?.reservationId??s?.reservation_code??null;c&&n.add(String(c))});let i=!1;Object.keys(t).forEach(s=>{n.has(s)||(delete t[s],i=!0)}),i&&Xe(t)}function Un(e){if(!e)return[];const t=ot(),n=String(e),i=t[n];return Array.isArray(i)?i:[]}function Gn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=it();if(!Array.isArray(t)||t.length===0)return[];const n=new Map;e.forEach(s=>{if(!s||typeof s!="object")return;const c=s.equipmentId??s.equipment_id??s.id??null;if(c==null)return;const r=String(c),a=(()=>{const o=[s.qty,s.quantity,s.count,1];for(const l of o){const u=Number(l);if(Number.isFinite(u)&&u>0)return u}return 1})();n.set(r,(n.get(r)||0)+a)});const i=[];return t.forEach((s,c)=>{const r=_e(s)||[],a=new Map;let o=!0;if(r.forEach(_=>{const h=_?.equipmentId??_?.equipment_id??null,k=Number.isFinite(Number(_?.qty))&&Number(_.qty)>0?Number(_.qty):1;if(h==null){o=!1;return}const m=String(h);a.set(m,(a.get(m)||0)+k)}),!o||a.size===0)return;let l=1/0;for(const[_,h]of a.entries()){const k=n.get(_)||0,m=Math.floor(k/h);if(m<=0){l=0;break}m<l&&(l=m)}if(!Number.isFinite(l)||l<=0)return;for(const[_,h]of a.entries()){const k=n.get(_)||0;n.set(_,Math.max(0,k-l*h))}const u=ye(s?.id??s?.packageId??s?.package_id??s?.code),d=Array.from(a.entries()).map(([_,h])=>({equipment_id:/^\d+$/.test(_)?Number(_):_,quantity:h,unit_price:0})),p=(s?.package_code??s?.code??u)||`pkg-${c}`,y=pn(s)||u||`package-${c}`;i.push({package_code:p,name:y,quantity:l,unit_price:Ft(s)||0,items:d})}),i}function Wn(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,s=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",c=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,r=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return i||s||c||r})}function Yn(e){return[]}function Ot(e=[]){return Array.isArray(e)?e.map((t,n)=>tn(t,n)).filter(Boolean).map((t,n)=>{const i=ye(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),s=He(t,i).map(l=>{const u=O(l.qty??l.quantity??l.count??l.units??l.unit_qty??l.unitQty??l.unit_count??l.unitCount??l.package_quantity??l.packageQty??1),d=Z(S(l.price??l.unit_price??0));return{...l,qty:u,quantity:u,price:d,unit_price:d}}),c=O(t.quantity??t.qty??1);let r=Z(S(t.unit_price??t.unitPrice??t.price??0));if(!r||r<=0){const l=s.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);l>0&&c>0&&(r=Z(Number((l/c).toFixed(2))))}const a=S(t.total_price??t.totalPrice??t.total??r*c),o=a>0?Z(a):Z(Number((r*c).toFixed(2)));return{...t,packageId:i,package_id:i,qty:c,quantity:c,unit_price:r,unitPrice:r,price:r,total_price:o,total:o,packageItems:s}}):[]}function Te(e,t){if(!e)return;const n=Kt(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],St(n));return}n[i]=Ot(t),St(n)}function Jn(e){if(!e)return[];const t=Kt(),n=String(e),i=t[n];return Array.isArray(i)?Ot(i):[]}function rt(e,t=0){if(e==null)return null;if(typeof e!="object"){const g=e!=null?String(e):null;return{assignmentId:`crew-${t}-${g??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:g,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,s=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,c=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let r=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";r||(r=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,o=e.position_label_en??null,l=e.position_label_alt??o??a??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,p=Z($(u)),y=Z($(d)),_=e&&typeof e.technician=="object"?e.technician:null,h=e.technician_id??e.technicianId??e.id??_?.id??e.userId??e.user_id??null,k=e.technician_name??e.technicianName??e.name??_?.name??e.full_name??null,m=e.role??_?.role??e.specialization??null,A=e.technician_phone??_?.phone??e.phone??null;return{assignmentId:String(n),positionId:s!=null?String(s):null,positionKey:c!=null?String(c):null,positionLabel:r!=null?String(r):"",positionLabelAlt:l!=null?String(l):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:o!=null?String(o):null,positionCost:Number.isFinite(p)?p:0,positionClientPrice:Number.isFinite(y)?y:0,technicianId:h!=null?String(h):null,technicianName:k!=null?String(k):null,technicianRole:m!=null?String(m):null,technicianPhone:A!=null?String(A):null,notes:e.notes??null}}function Xn(){return Q}function Se(e){Q=Array.isArray(e)?e.map(Oe):[],Q.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Te(n,t.packages),On(n,t.items);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];Wn(i)}),Qn(Q),sn({reservations:Q});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return Q}async function Zn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,o])=>{o!=null&&o!==""&&t.set(a,String(o))});const n=t.toString(),s=(await we(`/reservations/${n?`?${n}`:""}`))?.data;let c=[];Array.isArray(s)?c=s:s&&typeof s=="object"&&(Array.isArray(s.items)?c=s.items:Array.isArray(s.results)?c=s.results:Array.isArray(s.data)?c=s.data:Array.isArray(s.records)&&(c=s.records));const r=c.map($e).map(Ut);return Se(r)}async function ei(e){try{Array.isArray(e?.packages)&&console.debug("[reservationsService] createReservationApi payload.packages",e.packages)}catch{}const n=(await we("/reservations/",{method:"POST",body:e}))?.data??{};(!Array.isArray(n.packages)||n.packages.length===0)&&Array.isArray(e?.packages)&&e.packages.length&&(n.packages=e.packages);const i=Wt($e(n),e?.packages),s=Array.isArray(e?.items)?e.items:null;if(s&&(Array.isArray(i.items)&&i.items.length?i.items=Qt(i.items,s):i.items=s.map(Qe)),!Number.isFinite(i.companySharePercent)&&e?.company_share_percent!=null&&(i.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const c=ut(e.payment_history);c.length&&(i.paymentHistory=c)}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const c=e.technicians.map((r,a)=>rt(r,a)).filter(Boolean);c.length&&(i.crewAssignments=c,i.techniciansDetails=c.map((r,a)=>{const o=e.technicians[a];return typeof o=="object"?{...o,...r}:r}))}if(Array.isArray(e?.packages)&&e.packages.length){const c=Re({packages:e.packages});i.packages=ae(i.packages,c)}{const c=pt(i.items||[],i.packages||[]);i.items=c.items,i.packages=ae(i.packages||[],c.packages)}if(Te(i.id??i.reservationId??i.reservation_code,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const c=Ce({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=c.companyShareAmount,i.cost=c.finalTotal,i.totalAmount=c.finalTotal}return i.companyShareEnabled=e?.company_share_enabled?!0:i.companySharePercent>0,Se([...Q,i]),i}async function lt(e,t){try{Array.isArray(t?.packages)&&console.debug("[reservationsService] updateReservationApi payload.packages",t.packages)}catch{}const i=await we(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t})??{},s=i&&typeof i=="object"&&i.data&&typeof i.data=="object"&&!Array.isArray(i.data)?i.data:i,c=Array.isArray(s.packages)&&s.packages.length>0,r=Array.isArray(t?.packages)&&t.packages.length?t.packages:null;!c&&r&&(s.packages=r);const a=Wt($e(s),c?null:r),o=Array.isArray(t?.items)?t.items:null;if(o&&(Array.isArray(a.items)&&a.items.length?a.items=Qt(a.items,o):a.items=o.map(Qe)),console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const u=ut(t.payment_history);u.length&&(a.paymentHistory=u,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if((!Array.isArray(a.crewAssignments)||a.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const u=t.technicians.map((d,p)=>rt(d,p)).filter(Boolean);u.length&&(a.crewAssignments=u,a.techniciansDetails=u.map((d,p)=>{const y=t.technicians[p];return typeof y=="object"?{...y,...d}:d}))}if(!c&&Array.isArray(t?.packages))if(t.packages.length){const u=Re({packages:t.packages});a.packages=ae(a.packages,u)}else a.packages=[];{const u=pt(a.items||[],a.packages||[]);a.items=u.items,a.packages=ae(a.packages||[],u.packages)}if(Te(a.id??a.reservationId??a.reservation_code??e,a.packages),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const u=Ce({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=u.companyShareAmount,a.cost=u.finalTotal,a.totalAmount=u.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const l=Q.map(u=>String(u.id)===String(e)?a:u);return Se(l),a}function Qt(e,t){if(!Array.isArray(e)||!Array.isArray(t))return e;const n=new Map;return t.forEach((i,s)=>{if(!i||typeof i!="object")return;const c=i.equipment_id??i.equipmentId??i.id??null,r=b(String(i.barcode??"")).trim(),a=c!=null?`id:${c}`:r?`bc:${r}`:`idx:${s}`,o=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,l=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;n.set(a,{cost:o,price:l})}),e.map((i,s)=>{const c=i.equipmentId??i.equipment_id??i.id??null,r=b(String(i.barcode??"")).trim(),a=[c!=null?`id:${c}`:null,r?`bc:${r}`:null,`idx:${s}`].filter(Boolean);let o=null;for(const u of a)if(n.has(u)){o=n.get(u);break}if(!o)return i;const l={...i};return Number.isFinite(o.cost)&&(l.cost=o.cost,l.unit_cost=o.cost),Number.isFinite(o.price)&&(l.price=o.price,l.unit_price=o.price),l})}function Ut(e){try{return ti(e)}catch(t){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",t),e}}function ti(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(r=>r!=null?String(r):"").filter(Boolean);if(!t.length)return e;const n=Q.find(r=>{if(!r)return!1;const a=r.id!=null?String(r.id):"",o=r.reservationId!=null?String(r.reservationId):"",l=r.reservation_code!=null?String(r.reservation_code):"";return a&&t.includes(a)||o&&t.includes(o)||l&&t.includes(l)});if(!n||!Array.isArray(n.items))return e;const i=new Map;n.items.forEach((r,a)=>{const o=r?.equipmentId??r?.equipment_id??r?.id??null,l=b(String(r?.barcode??"")).trim(),u=o!=null?`id:${o}`:l?`bc:${l}`:`idx:${a}`;i.set(u,r)});const s=e.items.map((r,a)=>{const o=r?.equipmentId??r?.equipment_id??r?.id??null,l=b(String(r?.barcode??"")).trim(),u=[o!=null?`id:${o}`:null,l?`bc:${l}`:null,`idx:${a}`].filter(Boolean);let d=null;for(const h of u)if(i.has(h)){d=i.get(h);break}if(!d)return r;const p={...r},y=Number(d.cost),_=Number(d.price);return Number.isFinite(y)&&y>0&&(p.cost=y,p.unit_cost=y),Number.isFinite(_)&&_>0&&(p.price=_,p.unit_price=_),p}),c={...e,items:s};return ni(c)}function ni(e){if(!e||typeof e!="object")return e;const t=Array.isArray(e.packages)&&e.packages.length,n=Array.isArray(e.packagesRaw)&&e.packagesRaw.length;if(!t&&!n)return e;const i=[e.id,e.reservationId,e.reservation_id,e.reservationCode,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!i.length)return e;const s=Q.find(o=>{if(!o)return!1;const l=o.id!=null?String(o.id):"",u=o.reservationId!=null?String(o.reservationId):"",d=o.reservation_code!=null?String(o.reservation_code):"";return l&&i.includes(l)||u&&i.includes(u)||d&&i.includes(d)});if(!s)return e;const c=[].concat(Array.isArray(s.packages)?s.packages:[]).concat(Array.isArray(s.packagesRaw)?s.packagesRaw:[]),r=new Map;if(c.forEach(o=>{if(!o||typeof o!="object")return;const l=Ze(o);if(!l)return;const u=$(o.unit_cost??o.unitCost??o.cost??o.package_cost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);!Number.isFinite(u)||u<=0||r.has(l)||r.set(l,u)}),!r.size)return e;const a=o=>{if(!o||typeof o!="object")return;const l=$(o.unit_cost??o.unitCost??o.cost??o.package_cost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);if(Number.isFinite(l)&&l>0)return;const u=Ze(o);if(!u||!r.has(u))return;const d=Z(r.get(u));if(o.unit_cost=d,o.unitCost=d,o.cost=d,typeof o.total_cost!="number"||!Number.isFinite(o.total_cost)||o.total_cost===0){const p=Number.isFinite(Number(o.quantity))?Number(o.quantity):1;o.total_cost=Number((d*p).toFixed(2))}Number.isFinite($(o.rental_cost))||(o.rental_cost=d),Number.isFinite($(o.purchase_price))||(o.purchase_price=d),Number.isFinite($(o.internal_cost))||(o.internal_cost=d),Number.isFinite($(o.equipment_cost))||(o.equipment_cost=d),Number.isFinite($(o.item_cost))||(o.item_cost=d)};return Array.isArray(e.packages)&&e.packages.forEach(a),Array.isArray(e.packagesRaw)&&e.packagesRaw.forEach(a),e}function Ze(e={}){const t=G(e?.packageId??e?.package_id??e?.id??e?.code??null);if(t)return t;const n=b(String(e?.package_code??e?.code??e?.barcode??"")).trim().toLowerCase();return n||null}function Gt(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=new Map;return e.forEach((n,i)=>{if(!n||typeof n!="object")return;const s=Ze(n)??`pkg-${i}`,c=t.get(s);if(!c){t.set(s,n);return}const r=$(c.unit_cost??c.unitCost??c.cost??c.package_cost??c.rental_cost??c.purchase_price??c.internal_cost??c.equipment_cost??c.item_cost),a=$(n.unit_cost??n.unitCost??n.cost??n.package_cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost);Number.isFinite(a)&&(!Number.isFinite(r)||a>=r)?t.set(s,{...c,...n,unit_cost:a}):t.set(s,{...n,...c})}),Array.from(t.values())}function ii(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(c=>c!=null?String(c):"").filter(Boolean);if(!t.length)return e;let n=[];for(const c of t)if(n=Un(c),n.length)break;if(!n.length)return e;const i=new Map;n.forEach((c,r)=>{if(!c||typeof c!="object")return;const a=c.equipmentId??c.equipment_id??null,o=b(String(c.barcode??"")).trim(),l=a!=null?`id:${a}`:o?`bc:${o}`:`idx:${r}`;i.set(l,c)});const s=e.items.map((c,r)=>{const a=c?.equipmentId??c?.equipment_id??c?.id??null,o=b(String(c?.barcode??"")).trim(),l=[a!=null?`id:${a}`:null,o?`bc:${o}`:null,`idx:${r}`].filter(Boolean);let u=null;for(const A of l)if(i.has(A)){u=i.get(A);break}if(!u)return c;const d={...c},p=Z(S(u.cost??u.unit_cost)),y=Z(S(u.price??u.unit_price)),_=Number.isFinite(p),h=Number.isFinite(y),k=Number(c.cost),m=Number(c.price);return _&&(!Number.isFinite(k)||k<=0)&&(d.cost=p,d.unit_cost=p),h&&(!Number.isFinite(m)||m<=0)&&(d.price=y,d.unit_price=y),d});return{...e,items:s}}async function ai(e){await we(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=Q.filter(n=>String(n.id)!==String(e));Se(t),Te(e,null)}async function si(e){return lt(e,{status:"confirmed",confirmed:!0})}async function ci(e,t=null){const n={status:"completed",confirmed:!0};return typeof t=="string"&&(n.notes=t),lt(e,n)}function $e(e={}){const t=Oe({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,packages:e.packages,reservation_packages:e.reservation_packages,reservationPackages:e.reservationPackages,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});if(Array.isArray(e.packages))try{t.packagesRaw=e.packages.map(i=>({...i}));const n=Re({packages:e.packages});n.length&&(t.packages=ae(n,t.packages||[]))}catch{t.packagesRaw=Array.isArray(t.packagesRaw)?t.packagesRaw:[]}else t.packagesRaw=Array.isArray(t.packagesRaw)?t.packagesRaw:[];return t.packages=Gt(t.packages),ft("mapReservationFromApi",t.packages),ii(Ut(t))}function Wt(e,t){if(!e||!Array.isArray(t)||t.length===0)return e;try{const n=Re({packages:t});n.length&&(e.packages=ae(n,e.packages||[]))}catch(n){console.warn("[reservationsService] Failed to normalize payload packages",n)}try{e.packagesRaw=t.map(n=>({...n}))}catch{e.packagesRaw=t}return e.packages=Gt(e.packages),ft("applyPayloadPackages",t),e}function Yt(e={}){return Oe(e)}function Oe(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(Qe):[];const s=Array.isArray(e.packagesRaw)?e.packagesRaw.map(R=>({...R})):Array.isArray(e.packages)?e.packages.map(R=>({...R})):[];let c=Re(e);const r=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let a=r.map((R,v)=>rt(R,v)).filter(Boolean),o=a.map((R,v)=>{const w=r?.[v];return{...w&&typeof w=="object"?{...w}:w!=null?{id:w}:{},...R}});const l=a.map(R=>R.technicianId).filter(R=>R!=null&&R!=="").map(R=>Number.isNaN(Number(R))?String(R):Number(R)),u=e.start??e.start_datetime??"",d=e.end??e.end_datetime??"";let p=S(e.total_amount??e.totalAmount??e.cost??0);const y=S(e.discount??0),_=e.discount_type??e.discountType??"percent",h=["percent","amount"].includes(_)?_:"percent",k=!!(e.apply_tax??e.applyTax??!1);let m=_i(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const A=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),g=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,N=g!=null?Number.parseFloat(b(String(g).replace("%","").trim())):NaN,C=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let F=C!=null?C===!0||C===1||C==="1"||String(C).toLowerCase()==="true":Number.isFinite(N)&&N>0,L=F&&Number.isFinite(N)?Number(N):0;const T=e.company_share_amount??e.companyShareAmount;let I=Number.isFinite(Number(T))?Number(T):NaN;k&&L<=0&&(L=xt,F=!0);const E=Ce({items:i,technicianIds:l,crewAssignments:a,discount:y,discountType:h,applyTax:k,start:u,end:d,companySharePercent:L>0?L:null});(!Number.isFinite(p)||p<=0||k)&&(p=E.finalTotal),(!Number.isFinite(I)||I<0)&&(I=E.companyShareAmount),I=Number.isFinite(I)?Number(I.toFixed(2)):0,!F&&L>0&&(F=!0);const f=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],W=ri(f),M=ut(W),te=t??n??e.reservation_code??e.reservationId??null;if(c.length)Te(te,c);else{const R=Jn(te);R.length&&(c=ae(c,R))}if(!c.length&&Array.isArray(i)&&i.length)try{const R=Gn(i);Array.isArray(R)&&R.length&&(c=ae(c,R))}catch(R){console.warn("[reservationsService] inference of packages from items failed",R)}const Y=pt(i,c);i=Y.items,c=ae(c,Y.packages);const B=st({totalAmount:p,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:M});m=ct({manualStatus:m,paidAmount:B.paidAmount,paidPercent:B.paidPercent,totalAmount:p});const ce=m==="paid",de=gi(e.status??(A?"confirmed":"pending"));return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:u,end:d,status:de,completed:de==="completed",confirmed:A,location:e.location??"",notes:e.notes??"",discount:y,discountType:h,applyTax:k,paid:ce,paidStatus:m,paidAmount:B.paidAmount,paidPercent:B.paidPercent,paymentProgressType:B.paymentProgressType,paymentProgressValue:B.paymentProgressValue,paymentHistory:M,payment_history:M,totalAmount:p,cost:p,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:a,techniciansDetails:o,startDatetime:u,endDatetime:d,customerPhone:e.customer_phone??e.customerPhone??null,packages:c,packagesRaw:s,companySharePercent:L,companyShareAmount:I,companyShareEnabled:F}}function Qe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=O(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=S(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),s=S(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),c=b(String(e.barcode??e.code??e.serial??"")),r=e.description??e.desc??e.name??e.title??"",a={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:c,desc:r,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,cost:s,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},o=Xt(e.type??e.item_type??e.kind??null),l=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=G(l),d=He(e,u);if(o==="package"||u||d.length){a.type="package";const p=u||(t!=null?String(t):a.id?G(a.id):"");p&&(a.packageId=p,a.package_id=p,a.package_code=e.package_code??e.packageCode??p),a.name=r||a.package_code||p||"",a.barcode=a.barcode||b(String(e.package_code??e.packageCode??"")),a.packageItems=d;const y=en({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(a.price)||a.price<=0||a.price>y*10)&&(a.price=y),a.qtyPerPackage=d.length?d[0]?.qtyPerPackage??a.qtyPerPackage:a.qtyPerPackage,a.totalQuantity=n}return a}function oi({reservationCode:e,customerId:t,start:n,end:i,status:s,title:c,location:r,notes:a,projectId:o,totalAmount:l,discount:u,discountType:d,applyTax:p,paidStatus:y,confirmed:_,items:h,packages:k,crewAssignments:m=[],technicians:A=m,companySharePercent:g,companyShareEnabled:N,paidAmount:C,paidPercentage:F,paymentProgressType:L,paymentProgressValue:T,paymentHistory:I}){const E=Array.isArray(m)?m:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:s??"pending",title:c??null,location:r??null,notes:a??null,project_id:o||null,total_amount:l??0,discount:u??0,discount_type:d??"percent",apply_tax:p?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(C)?S(C):0,paid_percentage:Number.isFinite(F)?Number(F.toFixed(2)):0,payment_progress_type:L??null,payment_progress_value:Number.isFinite(T)?Number(T.toFixed(2)):null,payment_history:Array.isArray(I)?I.map(f=>({type:et(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?S(f.value):null,amount:f?.amount!=null?S(f.amount):f?.payment_amount!=null?S(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],payments:Array.isArray(I)?I.map(f=>({type:et(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?S(f.value):null,amount:f?.amount!=null?S(f.amount):f?.payment_amount!=null?S(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],confirmed:_===void 0?null:!!_,items:li(h),packages:ui(h,k),company_share_percent:N&&Number.isFinite(g)?Number(g):null,company_share_enabled:N?1:0,technicians:E.length?E.map((f,W)=>{const M=f.technicianId??f.technician_id??f.id??null,te=f.positionId??f.position_id??f.position??f.position_code??null,Y=f.positionLabel??f.position_name??f.role??null,B=S(f.positionCost??f.position_cost??f.cost??f.daily_wage??f.dailyWage??0),ce=S(f.positionClientPrice??f.position_client_price??f.client_price??f.clientPrice??f.daily_total??f.dailyTotal??f.total??0);return{id:M,technician_id:M,role:Y??f.technicianRole??null,notes:f.notes??null,position_id:te,position_key:f.positionKey??f.position_key??null,position_name:Y,position_label_ar:f.positionLabelAr??f.position_label_ar??null,position_label_en:f.positionLabelEn??f.position_label_en??null,position_cost:B,position_client_price:ce,client_price:ce,cost:B,assignment_id:f.assignmentId??f.assignment_id??`crew-${W}`}}):Array.isArray(A)?A.map(f=>typeof f=="object"&&f!==null?{id:f.id??f.technician_id??f.technicianId??f.ID,role:f.role??null,notes:f.notes??null}:Number.isNaN(Number(f))?String(f):Number(f)):[]}}function ut(e){const t=dt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,s=et(i),c=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,r=c!=null?Number.parseFloat(b(String(c))):null,a=n.amount!=null?Number.parseFloat(b(String(n.amount))):n.payment_amount!=null?Number.parseFloat(b(String(n.payment_amount))):null,o=n.percentage!=null?Number.parseFloat(b(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(b(String(n.payment_percentage))):null,l=Number.isFinite(a)?a:s==="amount"&&Number.isFinite(r)?r:null,u=Number.isFinite(o)?o:s==="percent"&&Number.isFinite(r)?r:null,d=s??(l!=null?"amount":u!=null?"percent":null),p=d==="amount"?l:d==="percent"?u:Number.isFinite(r)?r:null,y=n.note??n.notes??n.comment??n.payment_note??null,_=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:p,amount:l,percentage:u,note:y,recordedAt:_}}).filter(n=>n&&n.type)}function et(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function dt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of t)if(Array.isArray(e[r]))return e[r];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(i))return i;const s=Object.values(e);if(s.length&&s.every(r=>r&&typeof r=="object")){const r=s.map(a=>a);if(r.every(a=>!Array.isArray(a)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return dt(t)}catch{return[]}return[]}function ri(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=dt(t);if(Array.isArray(n)&&n.length)return n}return[]}function li(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object"||n.type==="package")return;const i=Array.isArray(n.packageItems)?n.packageItems:[],s=n.equipmentId??n.equipment_id??n.id??null;if(s==null)return;const c=(()=>{const r=S(n.cost??n.unit_cost??n.rental_cost??n.internal_cost??n.purchase_price??n.equipment_cost??0);if(Number.isFinite(r)&&r>0)return r;if(i.length){const a=i.reduce((o,l)=>{const u=S(l.cost??l.unit_cost??l.unitCost??l.rental_cost??l.internal_cost??l.purchase_price??l.equipment_cost??l.item_cost??0),d=O(l.qty??l.quantity??l.qtyPerPackage??l.unit_qty??1);return o+u*d},0);if(a>0)return Number(a.toFixed(2))}return r})();t.push({equipment_id:Jt(s),quantity:O(n.qty??n.quantity??1),unit_price:S(n.price??n.unit_price??0),unit_cost:c,cost:c,total_cost:Number.isFinite(c)?Number((c*O(n.qty??n.quantity??1)).toFixed(2)):0,rental_cost:c,purchase_price:c,internal_cost:c,equipment_cost:c,item_cost:c,notes:n.notes??null})}),t}function Jt(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function ui(e,t){const n=Array.isArray(t)?t.map(s=>s&&typeof s=="object"?{...s}:s):[],i=new Map;return n.forEach((s,c)=>{if(!s||typeof s!="object")return;const r=Le(s);r&&i.set(r,c)}),Array.isArray(e)&&e.forEach(s=>{if(!s||typeof s!="object"||s.type!=="package")return;const c=G(s.packageId??s.package_id??s.package_code??s.packageCode??s.bundleId??s.bundle_id??s.id??null),r=c?fe(c):null,a=O(s.package_qty??s.packageQty??s.qty??s.quantity??r?.package_qty??1),o=_e(r||{})||[],l=Array.isArray(s.packageItems)&&s.packageItems.length?s.packageItems:o,u=Array.isArray(l)?l.map(m=>{const A=m?.equipmentId??m?.equipment_id??m?.id??null;if(A==null)return null;let g=S(m?.cost??m?.unit_cost??m?.unitCost??m?.rental_cost??m?.internal_cost??m?.purchase_price??m?.equipment_cost??m?.item_cost??0);if((!Number.isFinite(g)||g===0)&&A!=null){const N=fi(A);Number.isFinite(N)&&N>0&&(g=N)}return{equipment_id:Jt(A),quantity:O(m?.qty??m?.quantity??m?.count??m?.units??m?.unit_qty??m?.unitQty??m?.unit_count??m?.unitCount??m?.package_quantity??m?.packageQty??1),unit_price:S(m?.price??m?.unit_price??0),unit_cost:g,cost:g,rental_cost:g,purchase_price:g,internal_cost:g,equipment_cost:g,item_cost:g}}).filter(Boolean):[],d=[s.package_cost,s.packageCost,s.unit_cost,s.unitCost,s.cost,s.rental_cost,s.internal_cost,s.purchase_price,s.equipment_cost,s.item_cost];let p=0;for(const m of d){const A=S(m);if(Number.isFinite(A)&&A>=0){p=A;break}}const y=s.package_code??s.packageCode??s.barcode??s.code??s.packageId??s.package_id??null,_={packageId:c||null,package_id:c||null,package_code:y,name:s.desc??s.name??"",quantity:a,unit_price:S(s.price??s.unit_price??0),unit_cost:p,cost:p,total_cost:Number.isFinite(p)?Number((p*a).toFixed(2)):0,rental_cost:p,purchase_price:p,internal_cost:p,equipment_cost:p,item_cost:p,items:u},h=Le(_);if(h&&i.has(h)){const m=i.get(h),A=mt(n[m]&&typeof n[m]=="object"?n[m]:{},_);n[m]=A,i.set(h,m);return}const k=n.length;n.push(_),h&&i.set(h,k)}),n}function Xt(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function G(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return ye(t)}function Le(e,t=null){if(!e||typeof e!="object")return null;const n=[e.package_code,e.packageCode,e.code,e.barcode];for(const s of n){const c=G(s??"");if(c)return t&&t.has(c)&&t.get(c)||c}const i=[e.packageId,e.package_id,e.id];for(const s of i){const c=G(s??"");if(c)return c}return null}function tt(e){return e==null?"":b(String(e)).trim().toLowerCase()}function Zt(e={},t=1){if(!e||typeof e!="object"){const l=b(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:l,normalizedBarcode:tt(l),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=O(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=S(e.unit_price??e.unitPrice??e.price??0),c=S(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),r=b(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),a=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let o;if(a!=null)o=O(a,{fallback:1,max:99});else if(t>0){const l=i/t;Number.isFinite(l)&&l>0&&Number.isInteger(l)?o=O(l,{fallback:1,max:99}):o=Math.min(i,99)}else o=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:o,quantity:o,qtyPerPackage:o,totalQuantity:i,price:s,unit_price:s,cost:c,unit_cost:c,rental_cost:c,purchase_price:c,internal_cost:c,equipment_cost:c,item_cost:c,barcode:r,normalizedBarcode:tt(e.normalizedBarcode??r),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function di(e={},t={}){const n=G(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=O(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),s=S(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),c=[e.package_cost,e.packageCost,e.unit_cost,e.unitCost,e.cost,e.rental_cost,e.internal_cost,e.purchase_price,e.equipment_cost,e.item_cost,t.package_cost,t.packageCost,t.unit_cost,t.unitCost,t.cost,t.rental_cost,t.internal_cost,t.purchase_price,t.equipment_cost,t.item_cost];let r=0;for(const o of c){const l=S(o);if(Number.isFinite(l)&&l>=0){r=l;break}}const a=b(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:a,desc:t.desc??t.description??e.name??e.desc??e.title??a,qty:i,quantity:i,price:s,cost:r,unit_cost:r,rental_cost:r,purchase_price:r,internal_cost:r,equipment_cost:r,item_cost:r,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:a,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function pt(e=[],t=[]){const n=pi(e),i=Array.isArray(t)?ae(t,n.packages):n.packages,s=new Map;return i.forEach(c=>{const r=Le(c);r&&s.set(r,c)}),n.packages.forEach(c=>{const r=Le(c);if(!r)return;const a=s.get(r);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=c.packageItems),!a.name&&c.name&&(a.name=c.name),!a.image&&c.image&&(a.image=c.image))}),{items:n.items,packages:Array.from(s.values())}}function pi(e=[]){const t=new Map;if(e.forEach(c=>{const r=G(c.packageId??c.package_id??c.packageCode??c.package_code??c.bundleId??c.bundle_id??null);if(!r)return;const a=r;t.has(a)||t.set(a,{base:c,items:[]});const o=t.get(a);if(c.type==="package"){o.base=c;return}o.base||(o.base=c),o.items.push(c)}),!t.size)return{items:e,packages:[]};const n=[],i=[],s=new Set;return e.forEach(c=>{const r=G(c.packageId??c.package_id??c.packageCode??c.package_code??c.bundleId??c.bundle_id??null);if(r&&t.has(r)){if(s.has(r))return;const a=t.get(r),o=a.base||c,l=a.items.map(y=>Zt(y,1)),u=[o.package_cost,o.packageCost,o.unit_cost,o.unitCost,o.cost,o.rental_cost,o.internal_cost,o.purchase_price,o.equipment_cost,o.item_cost];let d=0;for(const y of u){const _=S(y);if(Number.isFinite(_)&&_>=0){d=_;break}}const p={packageId:r,package_id:r,package_code:o.package_code??o.packageCode??o.barcode??b(String(r)),name:o.package_name??o.packageName??o.desc??o.name??`Package ${r}`,quantity:O(o.package_quantity??o.packageQty??1,{fallback:1,max:9999}),unit_price:S(o.package_price??o.packagePrice??o.price??0),unit_cost:d,unitCost:d,cost:d,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,packageItems:l,image:o.image??null};i.push(p),n.push(di(p,o)),s.add(r);return}n.push(c)}),{items:n,packages:i}}function He(e={},t=""){if(!e||typeof e!="object")return[];const n=G(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let s=_e({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),c=[];if((!Array.isArray(s)||s.length===0)&&n){const l=fe(n);l&&(s=_e(l),c=Array.isArray(s)?s:[])}else if(n){const l=fe(n);l&&(c=_e(l)||[])}if(!Array.isArray(s)||s.length===0)return[];const r=O(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=s.map(l=>Zt(l,r));if(c.length){const l=new Map;c.forEach(u=>{if(!u)return;const d=tt(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&l.set(d,u)}),a.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!l.has(d))return;const p=l.get(d),y=O(p.quantity??p.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=y,u.qty=y,u.quantity=y;const _=S(p.unit_price??p.unitPrice??p.price??u.price);u.price=_,u.unit_price=_,!u.desc&&p.desc&&(u.desc=p.desc),!u.image&&p.image&&(u.image=p.image)})}const o=new Map;return a.forEach(l=>{const u=l.normalizedBarcode||(l.equipmentId?`id:${l.equipmentId}`:null);if(u){if(o.has(u)){const d=o.get(u);d.qty+=l.qty,d.quantity+=l.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=l.qtyPerPackage),(!d.price||d.price===0)&&l.price&&(d.price=l.price,d.unit_price=l.unit_price),!d.desc&&l.desc&&(d.desc=l.desc),!d.image&&l.image&&(d.image=l.image);return}o.set(u,{...l})}}),Array.from(o.values())}function en(e={},t=[],n=1){try{const c=G(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(c){const r=fe(c);if(r){const a=Ft(r);if(Number.isFinite(Number(a))&&Number(a)>0)return Number(a)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return S(i);const s=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(s))){const c=S(s);return n>0?Number((c/n).toFixed(2)):c}return 0}function mt(e,t){if(!e)return t;if(!t)return e;const n={...e},i=r=>{(n[r]===void 0||n[r]===null||n[r]==="")&&(n[r]=t[r])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price);const s=S(n.unit_cost??n.unitCost??n.cost??n.package_cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost),c=S(t.unit_cost??t.unitCost??t.cost??t.package_cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost);if((!Number.isFinite(s)||s===0)&&Number.isFinite(c)){const r=c;n.unit_cost=r,n.unitCost=r,n.cost=r,n.total_cost=Number.isFinite(t.total_cost)?t.total_cost:n.total_cost,Number.isFinite(n.rental_cost)||(n.rental_cost=r),Number.isFinite(n.purchase_price)||(n.purchase_price=r),Number.isFinite(n.internal_cost)||(n.internal_cost=r),Number.isFinite(n.equipment_cost)||(n.equipment_cost=r),Number.isFinite(n.item_cost)||(n.item_cost=r)}return(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=mi(n.packageItems,t.packageItems),n.items=n.packageItems),n}function mi(e=[],t=[]){const n=new Map,i=s=>{s.forEach(c=>{if(!c)return;const r=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(r){if(n.has(r)){const a=n.get(r);a.qty+=c.qty??0,a.quantity+=c.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(c.qtyPerPackage)&&(a.qtyPerPackage=c.qtyPerPackage),(!a.price||a.price===0)&&c.price&&(a.price=c.price,a.unit_price=c.unit_price);const o=S(a.cost??a.unit_cost??a.unitCost??a.rental_cost??a.purchase_price??a.internal_cost??a.equipment_cost??a.item_cost),l=S(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.purchase_price??c.internal_cost??c.equipment_cost??c.item_cost);if((!Number.isFinite(o)||o===0)&&Number.isFinite(l)){const u=l;a.cost=u,a.unit_cost=u,a.unitCost=u,Number.isFinite(a.rental_cost)||(a.rental_cost=u),Number.isFinite(a.purchase_price)||(a.purchase_price=u),Number.isFinite(a.internal_cost)||(a.internal_cost=u),Number.isFinite(a.equipment_cost)||(a.equipment_cost=u),Number.isFinite(a.item_cost)||(a.item_cost=u)}!a.desc&&c.desc&&(a.desc=c.desc),!a.image&&c.image&&(a.image=c.image);return}n.set(r,{...c})}})};return i(e),i(t),Array.from(n.values())}function ae(e=[],t=[]){const n=[],i=new Map,s=it(),c=new Map;s.forEach(o=>{const l=G(o?.id??o?.packageId??o?.package_id??o?.code??""),u=String(o?.package_code??o?.code??"").trim().toLowerCase();u&&c.set(u,l||u)});const r=o=>Le(o,c),a=o=>{Array.isArray(o)&&o.forEach(l=>{if(!l||typeof l!="object")return;const u=r(l);if(u)if(i.has(u)){const d=i.get(u);n[d]=mt(n[d],l)}else i.set(u,n.length),n.push({...l})})};return a(e),a(t),n}function fi(e){if(e==null)return 0;const t=me()||{},i=(Array.isArray(t.equipment)?t.equipment:[]).find(c=>[c.id,c.equipment_id,c.equipmentId,c.item_id,c.itemId].some(a=>String(a)===String(e)));if(!i)return 0;const s=S(i.cost??i.unit_cost??i.unitCost??i.rental_cost??i.purchase_price??i.internal_cost??i.equipment_cost??i.item_cost??0);return Number.isFinite(s)&&s>0?s:0}function tn(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const _=G(e),h=_?fe(_):null,k=h?He(h,_):[],m=h?S(h.price??h.unit_price??h.unitPrice??0):0,g=(()=>{const L=[h?.package_cost,h?.packageCost,h?.unit_cost,h?.unitCost,h?.cost,h?.rental_cost,h?.internal_cost,h?.purchase_price,h?.equipment_cost,h?.item_cost];for(const T of L){const I=S(T);if(Number.isFinite(I)&&I>=0)return I}return 0})(),N=1,C=Number((m*N).toFixed(2)),F=Number((g*N).toFixed(2));return{id:`package::${_||t}`,packageId:_||`pkg-${t}`,package_id:_||`pkg-${t}`,package_code:b(String(e))||_||`pkg-${t}`,name:h?.name??h?.package_name??h?.packageName??b(String(e))??"",desc:h?.name??b(String(e))??"",quantity:N,qty:N,unit_price:m,unitPrice:m,price:m,unit_cost:g,unitCost:g,cost:g,total_cost:F,rental_cost:g,purchase_price:g,internal_cost:g,equipment_cost:g,item_cost:g,total:C,total_price:C,barcode:b(String(e)),packageItems:k,items:k,type:"package",image:h?.image??null}}if(typeof e!="object")return null;const n=G(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=O(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=He(e,n),c=en(e,s,i),a=(()=>{const _=[e.package_cost,e.packageCost,e.unit_cost,e.unitCost,e.cost,e.rental_cost,e.internal_cost,e.purchase_price,e.equipment_cost,e.item_cost];for(const h of _){const k=S(h);if(Number.isFinite(k)&&k>=0)return k}return 0})(),o=e.total_price??e.totalPrice??e.total??c*i,l=Number.isFinite(Number(o))?S(o):Number((c*i).toFixed(2)),u=Number.isFinite(a)?Number((a*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??n,p=b(String(e.barcode??d??"")),y=e.image??e.cover??e.thumbnail??s.find(_=>_.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??n,quantity:i,qty:i,unit_price:c,unitPrice:c,price:c,unit_cost:a,unitCost:a,cost:a,total_cost:u,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,total:l,total_price:l,barcode:p,packageItems:s,items:s,type:"package",image:y}}function Re(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,s=(a,o=n.length)=>{const l=tn(a,o);if(!l)return;const u=l.packageId||l.package_code||l.id||`pkg-${o}`;if(i.has(u)){const d=i.get(u);n[d]=mt(n[d],l)}else i.set(u,n.length),n.push(l)};t.forEach(a=>{a.forEach((o,l)=>{s(o,l+n.length)})}),n.length===0&&e.package&&s(e.package,0);const c=Array.isArray(e.items)?e.items:[],r=(a={})=>!a||typeof a!="object"?!1:!!(Xt(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(l=>typeof l=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return c.forEach((a,o)=>{r(a)&&s(a,n.length+o)}),n}function S(e){const t=$(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function ft(e,t=[]){try{if(!t||typeof console>"u")return;console.groupCollapsed(`ğŸ“¦ [reservations] ${e}`),console.table((t||[]).map((n,i)=>({index:i,key:n?.package_code??n?.packageId??n?.id??n?.name??`pkg-${i}`,unitCost:n?.unit_cost??n?.unitCost??n?.cost??0,unitPrice:n?.unit_price??n?.unitPrice??n?.price??0}))),console.groupEnd()}catch{}}try{typeof window<"u"&&!window.__dumpReservationPackages&&(window.__dumpReservationPackages=e=>{const t=Q.find(n=>{const i=[n?.id,n?.reservationId,n?.reservation_id,n?.reservationCode,n?.reservation_code].map(c=>c!=null?String(c):null),s=e!=null?String(e):null;return s&&i.includes(s)});return t?(ft(`__dumpReservationPackages(${e})`,t.packages),t):(console.warn("[reservations] __dumpReservationPackages: reservation not found",e),null)})}catch{}function O(e,{fallback:t=1,max:n=1e6}={}){const i=$(e);if(!Number.isFinite(i))return t;const s=Math.round(i);return s<=0||s>n?t:s}function gi(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function _i(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function yi(e){return e instanceof cn}const hi=(e={})=>{const t=$(e.unit_cost??e.unitCost??e.cost??e.package_cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??e.item_cost);return Number.isFinite(t)&&t>0};function We(e={}){return e.id??e.reservationId??e.reservation_id??e.reservationCode??e.reservation_code??null}function bi(e={}){const t=e?.packages;return!Array.isArray(t)||t.length===0?!0:t.some(n=>!hi(n))}async function Ni(e){if(!e)return null;const n=(await we(`/reservations/?id=${encodeURIComponent(e)}`))?.data;if(!n||Array.isArray(n))return null;const i=$e(n),s=We(i),c=Q.some(r=>We(r)===s)?Q.map(r=>We(r)===s?i:r):[...Q,i];return Se(c),i}const wi=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:oi,closeReservationApi:ci,confirmReservationApi:si,createReservationApi:ei,deleteReservationApi:ai,fetchReservationWithDetails:Ni,getCachedReservationCrew:Yn,getReservationsState:Xn,isApiError:yi,mapLegacyReservation:Yt,mapReservationFromApi:$e,mapReservationItem:Qe,refreshReservationsFromApi:Zn,reservationPackagesNeedHydration:bi,setReservationsState:Se,toInternalReservation:Oe,updateReservationApi:lt},Symbol.toStringTag,{value:"Module"}));export{Oe as A,bi as B,Ni as C,xt as D,jn as E,Tn as F,$ as G,x as H,Yn as I,Ci as J,In as K,vi as L,Yt as M,En as N,si as O,ci as P,wi as Q,Ei as a,zn as b,st as c,Ce as d,ct as e,ai as f,Xn as g,Li as h,Pi as i,qi as j,Pn as k,Mn as l,$e as m,Rt as n,qn as o,$n as p,vn as q,Zn as r,Ii as s,oi as t,lt as u,ei as v,yi as w,Si as x,yt as y,Fi as z};
