import{t as l,r as A,f as Z,c as tt,p as et,a as ot,b as _,d as U,e as rt}from"./calculations.Cuzjzmo7.js";import{e as at}from"./reports.D5B8DrHP.js";import{s as nt,c as st,d as it,q as pt}from"./controller.CKj9uBP3.js";import{n as O}from"./auth.DEm-O4iH.js";import"./reservationsService.DHFcI6wO.js";import"./dashboard.CwXHs0Fv.js";/* empty css              */import"./dashboardShell.BJ8UOETr.js";import"./customers.DDv-F3VN.js";import"./maintenanceService.-sdg2Aq9.js";const j=96,H=25.4,Y=210,ct=297,$=Math.round(Y/H*j),D=Math.round(ct/H*j),F=j/H,lt=/safari/i,dt=/(iphone|ipad|ipod)/i,mt=/(crios|fxios|edgios|opios)/i;function ut(){try{const o=navigator.userAgent||"";return dt.test(o)&&lt.test(o)&&!mt.test(o)}catch{return!1}}function ft(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function ht(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const r=document.createElement("style");r.textContent=String(pt).trim(),t.appendChild(r);const i=document.createElement("div");i.className="quote-preview-pages",i.setAttribute("data-quote-pages",""),t.appendChild(i);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function G(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function L({rightMm:o,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function gt(o){try{const t=G(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const i="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${i}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${i}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${i}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(r,e);const n=()=>{const s=Number(r.querySelector("[data-rpt-right]").value),y=Number(r.querySelector("[data-rpt-top]").value),k=Number(r.querySelector("[data-rpt-scale]").value),p=Math.max(.9,Math.min(1,k/100));L({rightMm:s,topMm:y,scale:p});const q=s*F,S=y*F;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${q}px, ${S}px) scale(${p})`})};r.querySelector("[data-rpt-apply]").addEventListener("click",n),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,L({rightMm:0,topMm:0,scale:1});const s=o.querySelector("[data-quote-pages]");Object.assign(s.style,{transform:"none"})});const d=t.rightMm*F,a=t.topMm*F;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${d}px, ${a}px) scale(${t.scale})`})}catch{}}function z({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function bt(o){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=l("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const i=document.createElement("p");i.className="rpt-subtitle",i.textContent=`${rt(new Date)} • ${l("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(i);const e=document.createElement("div");e.className="rpt-kpis";const n=(d,a)=>{const s=document.createElement("div");return s.className="rpt-kpi",s.innerHTML=`<div class="label">${d}</div><div class="value">${a}</div>`,s};return e.appendChild(n(l("reservations.reports.kpi.total.label","الحجوزات","Reservations"),U(o.total||0))),e.appendChild(n(l("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),_(o.revenue||0))),e.appendChild(n(l("reservations.reports.kpi.net.label","صافي الربح","Net profit"),_(o.netProfit||0))),e.appendChild(n(l("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),_(o.companyShareTotal||0))),e.appendChild(n(l("reservations.reports.kpi.tax.label","الضريبة","Tax"),_(o.taxTotal||0))),e.appendChild(n(l("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),_(o.maintenanceExpense||0))),t.appendChild(e),t}function xt(){try{const o=A?.data||{},t=A?.lastSnapshot?.filtered||o.reservations||[],r=new Map((o.customers||[]).map(a=>[String(a.id),a])),i=[...t].sort((a,s)=>new Date(s?.start||0)-new Date(a?.start||0)),e={code:l("reservations.reports.results.headers.id","الحجز","Reservation"),customer:l("reservations.reports.results.headers.customer","العميل","Customer"),date:l("reservations.reports.results.headers.date","التاريخ","Date"),status:l("reservations.reports.results.headers.status","الحالة","Status"),payment:l("reservations.reports.results.headers.payment","الدفع","Payment"),total:l("reservations.reports.results.headers.total","الإجمالي","Total"),share:l("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:l("reservations.reports.results.headers.net","صافي الربح","Net profit")},n=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],d=i.map(a=>{const s=a?.reservationId||a?.id||"—",y=O(String(s)),p=r.get(String(a?.customerId))?.customerName||l("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),q=Z(a?.start),S=tt(a),f=(()=>{switch(S.statusValue){case"completed":return String(l("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(l("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(l("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return O(String(S.statusValue||"—"))}})(),M=et(S.paidStatus),w=ot(a),c=_(w.finalTotal),m=w.companySharePercent>0?`${U(w.companySharePercent)}% (${_(w.companyShareAmount)})`:l("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),u=_(w.netProfit);return{[e.code]:y,[e.customer]:p,[e.date]:q,[e.status]:f,[e.payment]:M,[e.total]:c,[e.share]:m,[e.net]:u}});return{headers:n,rows:d}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function X(o){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),i=document.createElement("tr");o.forEach(n=>{const d=document.createElement("th");d.textContent=n,i.appendChild(d)}),r.appendChild(i);const e=document.createElement("tbody");return t.appendChild(r),t.appendChild(e),{table:t,tbody:e}}function yt(o,t,r,i){const e=o.querySelector("[data-quote-pages]"),n=z({primary:!0});e.appendChild(n);const d=bt(i);n.appendChild(d);let{table:a,tbody:s}=X(r);n.appendChild(a);const y=18,k=28,p=[];for(let f=0;f<t.length;f+=k)p.push(t.slice(f,f+k));if(p.length){const f=p[0];if(f.length>y){const M=f.splice(y);p.length>1?p[1]=M.concat(p[1]):p.push(M)}}const q=(f,M)=>{const w=document.createElement("tr");r.forEach(c=>{const m=document.createElement("td");m.textContent=M[c]!=null?String(M[c]):"",w.appendChild(m)}),f.appendChild(w)};(p.shift()||t).forEach(f=>q(s,f)),p.forEach(f=>{const M=z({primary:!1});e.appendChild(M);const w=X(r);M.appendChild(w.table),f.forEach(c=>q(w.tbody,c))})}function wt(o=[],{context:t="preview"}={}){const i=(A.lastSnapshot||{}).metrics||{};let e,n=o&&o.length?o:null;if(n)e=Object.keys(n[0]||{});else{const s=xt();e=s.headers,n=s.rows}const d=ht(t),a=document.createElement("div");a.style.position="fixed",a.style.left="-10000px",a.style.top="0",a.style.width=`${$}px`,a.style.zIndex="-1",document.body.appendChild(a),a.appendChild(d);try{nt(d),st(d),it(d)}catch{}return yt(d,n||[],e,i),d.parentElement?.removeChild(d),a.parentElement?.removeChild(a),t==="preview"&&gt(d),d}async function _t(o=[],{action:t="save"}={}){const r=wt(o,{context:"export"}),i=document.createElement("div");Object.assign(i.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),i.appendChild(r),document.body.appendChild(i);try{const n=ut()&&!ft()?window.open("","_blank"):null;if(n)try{n.document.open(),n.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${l("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${l("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${l("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),n.document.close()}catch{}await at();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const d=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,a=window.html2canvas;if(typeof d=="function"&&typeof a=="function"){const s=G(),y=new d({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),p={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},q=Array.from(r.querySelectorAll(".quote-page"));let S=0;const f=(c,m=250)=>{try{const u=c.getContext("2d"),{width:h,height:g}=c,b=new Uint8ClampedArray(h*4),v=x=>{const P=u.getImageData(0,x,h,1).data||b;let R=0;for(let E=0;E<h;E+=1){const N=E*4,T=P[N],I=P[N+1],W=P[N+2];if((T<m||I<m||W<m)&&(R+=1,R>Math.max(2,Math.ceil(h*.003))))return!1}return!0};let C=0;for(let x=0;x<g;x+=2)if(!v(x)){C=x;break}return C}catch{return 0}},M=(c,m=250)=>{try{const u=c.getContext("2d"),{width:h,height:g}=c,b=C=>{const x=u.getImageData(0,C,h,1).data;let P=0;for(let R=0;R<h;R+=1){const E=R*4,N=x[E],T=x[E+1],I=x[E+2];if((N<m||T<m||I<m)&&(P+=1,P>Math.max(2,Math.ceil(h*.003))))return!1}return!0};let v=0;for(let C=g-1;C>=0;C-=2)if(!b(C)){v=g-1-C;break}return v}catch{return 0}},w=(c,m,u)=>{try{const{width:h,height:g}=c,b=Math.max(0,Math.min(g-1,Math.round(m))),v=Math.max(0,Math.min(g-b,Math.round(u))),C=Math.max(1,g-b-v);if(b===0&&v===0)return c;const x=document.createElement("canvas");return x.width=h,x.height=C,x.getContext("2d").drawImage(c,0,-b),x}catch{return c}};for(let c=0;c<q.length;c+=1){const m=q[c],u=m.ownerDocument||document,h=u.createElement("div");Object.assign(h.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const g=u.createElement("div");g.id="quotation-pdf-root",g.setAttribute("data-quote-render-context","export"),g.style.width=`${$}px`,g.style.maxWidth=`${$}px`,g.style.minWidth=`${$}px`,g.style.background="#ffffff";const b=m.cloneNode(!0);b.style.width=`${$}px`,b.style.maxWidth=`${$}px`,b.style.minWidth=`${$}px`,b.style.height=`${D}px`,b.style.maxHeight=`${D}px`,b.style.minHeight=`${D}px`,b.style.position="relative",b.style.background="#ffffff",g.appendChild(b),h.appendChild(g),u.body.appendChild(h);let v;try{v=await a(g,{...p,scrollX:0,scrollY:0,windowWidth:$,windowHeight:D})}finally{h.parentNode?.removeChild(h)}if(!v)continue;const C=f(v,246),x=M(v,246),P=w(v,C,x),R=Math.max(.9,Math.min(1,s.scale||1)),E=Y*R,N=P.height/P.width*E;let T=Number(s.rightMm)||0;const I=m.classList.contains("quote-page--primary")?6:4,W=f(P,246),V=E/P.width,B=W*V;let J=(Number(s.topMm)||0)+I-B;const K=P.toDataURL("image/jpeg",.95);S>0&&y.addPage(),y.addImage(K,"JPEG",T,J,E,N,`page-${S+1}`,"FAST"),S+=1,await new Promise(Q=>requestAnimationFrame(Q))}if(S===0)throw new Error("PDF generation produced no pages");if(t==="print"){const c=y.output("bloburl");if(n)try{n.location.href=c}catch{}else await new Promise(m=>{const u=document.createElement("iframe");Object.assign(u.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),u.onload=()=>{try{u.contentWindow?.focus(),u.contentWindow?.print()}catch{}setTimeout(()=>{u.remove(),m()},700)},u.src=c,document.body.appendChild(u)})}else y.save("reservations-report.pdf")}else{const s=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const y=await s.get("pdf").then(k=>k.output("bloburl"));await new Promise(k=>{const p=document.createElement("iframe");Object.assign(p.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),p.onload=()=>{try{p.contentWindow?.focus(),p.contentWindow?.print()}catch{}setTimeout(()=>{p.remove(),k()},700)},p.src=y,document.body.appendChild(p)})}else await s.save("reservations-report.pdf")}}finally{i.remove()}}export{wt as buildReportsPdfPages,_t as exportReportsPdf};
