import{e as H,t as f,n as D,f as R,d as S}from"./auth-CXJ9BVF7.js";/* empty css              *//* empty css                */import"./common-DiVDZi68.js";import"./projects-rKsBJ178.js";import"./projectsCommon-D3IFaSQr.js";import{e as z,v as j,D as F,z as G,B as K,C as Y,q as Z,g as J}from"./projectsService-CtD7Jyhk.js";const X="modulepreload",Q=function(t,n){return new URL(t,n).href},P={},tt=function(n,e,r){let c=Promise.resolve();if(e&&e.length>0){let o=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};const l=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),s=i?.nonce||i?.getAttribute("nonce");c=o(e.map(d=>{if(d=Q(d,r),d in P)return;P[d]=!0;const p=d.endsWith(".css"),v=p?'[rel="stylesheet"]':"";if(r)for(let C=l.length-1;C>=0;C--){const T=l[C];if(T.href===d&&(!p||T.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${v}`))return;const g=document.createElement("link");if(g.rel=p?"stylesheet":X,p||(g.as="script"),g.crossOrigin="",g.href=d,s&&g.setAttribute("nonce",s),document.head.appendChild(g),p)return new Promise((C,T)=>{g.addEventListener("load",C),g.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${d}`)))})}))}function m(l){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=l,window.dispatchEvent(i),!i.defaultPrevented)throw l}return c.then(l=>{for(const i of l||[])i.status==="rejected"&&m(i.reason);return n().catch(m)})},I=.15,E={},u={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},a={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null};let y=null;const O=["upcoming","ongoing","completed"];async function et(){try{await z({suppressError:!0}),await j({force:!0})}catch(t){console.error("❌ [projectsReports] Failed to load initial data",t),F(t)&&console.warn("Projects API error:",t.message)}}async function nt(){await at(),rt(),await et(),V(),U(),ut(),h(),document.addEventListener("language:changed",mt),document.addEventListener("projects:changed",()=>{A().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{A().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",pt)}document.addEventListener("DOMContentLoaded",nt);async function at(){if(y)return y;try{y=(await tt(()=>import("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"),[],import.meta.url)).default}catch(t){console.warn("Chart.js failed to load",t),y=null}return y}function rt(){a.search=document.getElementById("reports-search"),a.statusChips=document.getElementById("reports-status-chips"),a.payment=document.getElementById("reports-payment"),a.dateRange=document.getElementById("reports-date-range"),a.customRangeWrapper=document.getElementById("reports-custom-range"),a.startDate=document.getElementById("reports-start-date"),a.endDate=document.getElementById("reports-end-date"),a.refreshBtn=document.getElementById("reports-refresh"),a.kpiGrid=document.getElementById("reports-kpi-grid"),a.table=document.getElementById("reports-table"),a.tableBody=a.table?.querySelector("tbody"),a.tableMeta=document.getElementById("reports-table-meta"),a.tableEmpty=document.getElementById("reports-empty")}function V(){const{customers:t=[]}=H();u.customers=Array.isArray(t)?t:[],u.reservations=J();const n=new Map(u.customers.map(r=>[String(r.id),r])),e=G();u.projects=Array.isArray(e)?e.map(r=>st(r,n)):[],u.totalProjects=u.projects.length}function st(t,n){const e=t.paymentStatus==="paid"?"paid":"unpaid",r=n.get(String(t.clientId)),c=ot(t.id),m=c.reduce((q,W)=>q+it(W),0),l=lt(t),i=Number(t?.equipmentEstimate)||0,s=Number((i+l).toFixed(2)),o=t?.applyTax===!0||t?.applyTax==="true",d=o?Number((s*I).toFixed(2)):0,p=o?Number(((s+m)*I).toFixed(2)):0,v=Number((s+m+p).toFixed(2)),g=ct(t),C=t.start?new Date(t.start):null,T=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:r?.customerName||r?.name||"",clientCompany:t.clientCompany||r?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:e,confirmed:t.confirmed===!0||t.confirmed==="true",start:C,end:T,applyTax:o,status:g,reservationsTotal:Number(m.toFixed(2)),expensesTotal:l,subtotal:s,taxAmount:d,combinedTaxAmount:p,overallTotal:v,unpaidValue:e==="paid"?0:v,reservationsCount:c.length}}function ot(t){return Array.isArray(u.reservations)?u.reservations.filter(n=>String(n.projectId)===String(t)):[]}function it(t){if(!t)return 0;const n=Array.isArray(t.items)?t.items:[],e=t.discount??0,r=Number(D(String(e)))||0,c=t.discountType||"percent",m=Array.isArray(t.technicians)?t.technicians:[],l=Z(n,r,c,!1,m,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const i=Number(D(String(t.cost??0)));return Number.isFinite(i)?Math.round(i):0}function lt(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((n,e)=>n+(Number(e.amount)||0),0):0}function ct(t){const n=new Date,e=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return e&&!Number.isNaN(e.getTime())&&e>n?"upcoming":r&&!Number.isNaN(r.getTime())&&r<n?"completed":"ongoing"}function ut(){if(a.search){let t;a.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{u.filters.search=a.search.value.trim(),h()},180)})}a.payment&&(a.payment.value=u.filters.payment,a.payment.addEventListener("change",()=>{u.filters.payment=a.payment.value||"all",h()})),a.dateRange&&(a.dateRange.addEventListener("change",dt),a.dateRange.value=u.filters.range),a.startDate&&a.startDate.addEventListener("change",()=>{u.filters.startDate=a.startDate.value,u.filters.range==="custom"&&h()}),a.endDate&&a.endDate.addEventListener("change",()=>{u.filters.endDate=a.endDate.value,u.filters.range==="custom"&&h()}),a.refreshBtn&&a.refreshBtn.addEventListener("click",()=>{if(u.filters.range!=="custom"){h();return}u.filters.startDate=a.startDate?.value||"",u.filters.endDate=a.endDate?.value||"",h()})}function dt(t){const n=t.target.value;u.filters.range=n,n==="custom"?a.customRangeWrapper?.classList.add("active"):(a.customRangeWrapper?.classList.remove("active"),u.filters.startDate="",u.filters.endDate="",a.startDate&&(a.startDate.value=""),a.endDate&&(a.endDate.value=""),h())}async function A(){try{await Promise.all([K(),Y()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),F(t)&&console.warn("Projects API error:",t.message)}finally{V(),h()}}function mt(){U(),h()}function pt(t){t.key&&!["projects","reservations","customers"].includes(t.key)||A().catch(n=>{console.error("❌ [projectsReports] Storage sync failed",n)})}function h(){const t=ft();x(),ht(t),vt(t),Ct(t),Tt(t),Dt(t),Et(t)}function ft(){const{search:t,statuses:n,payment:e,range:r,startDate:c,endDate:m}=u.filters,l=_(t),i=new Date,s=Number(r);let o=null;if(r==="custom"){o=c?new Date(c):null;const d=m?new Date(m):null;return u.projects.filter(p=>!$(p,n)||!M(p,e)||!B(p,l)?!1:bt(p.start,o,d))}return r!=="all"&&Number.isFinite(s)&&(o=new Date,o.setDate(i.getDate()-s)),u.projects.filter(d=>!$(d,n)||!M(d,e)||!B(d,l)?!1:r==="all"?!0:gt(d.start,o,i))}function $(t,n){return n.includes(t.status)}function M(t,n){return n==="all"?!0:t.paymentStatus===n}function B(t,n){return n?_([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(n):!0}function gt(t,n,e){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:n?t>=n&&t<=e:!0}function bt(t,n,e){if(!n&&!e)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(n&&!Number.isNaN(n.getTime())&&r<n.getTime()||e&&!Number.isNaN(e.getTime())&&r>e.getTime())}function _(t){return t?D(String(t)).toLowerCase().trim():""}function ht(t){if(!a.kpiGrid)return;const n=t.length,e=t.reduce((l,i)=>l+i.overallTotal,0),r=t.reduce((l,i)=>l+i.unpaidValue,0),c=t.reduce((l,i)=>l+i.expensesTotal,0),m=[{icon:"📊",label:f("projects.reports.kpi.totalProjects","Total projects"),value:k(n),meta:f("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:"💰",label:f("projects.reports.kpi.totalValue","Total value"),value:N(e),meta:f("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:"🧾",label:f("projects.reports.kpi.unpaidValue","Outstanding value"),value:N(r),meta:f("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:"💸",label:f("projects.reports.kpi.expenses","Total expenses"),value:N(c),meta:f("projects.reports.kpi.expensesMeta","Expenses for included projects")}];a.kpiGrid.innerHTML=m.map(({icon:l,label:i,value:s,meta:o})=>`
    <div class="reports-kpi-card">
      <div class="reports-kpi-icon">${l}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${b(i)}</p>
        <p class="reports-kpi-value">${b(s)}</p>
        <span class="reports-kpi-meta">${b(o)}</span>
      </div>
    </div>
  `).join("")}function U(){if(!a.statusChips)return;const t=O.map(n=>{const e=f(`projects.status.${n}`,n);return`<button type="button" class="reports-status-chip" data-status="${n}">${b(e)}</button>`}).join("");a.statusChips.innerHTML=t,a.statusChips.dataset.listenerAttached||(a.statusChips.addEventListener("click",yt),a.statusChips.dataset.listenerAttached="true"),x()}function yt(t){const n=t.target.closest("[data-status]");if(!n)return;const e=n.dataset.status;if(!e)return;const r=new Set(u.filters.statuses);r.has(e)?r.delete(e):r.add(e),r.size===0&&O.forEach(c=>r.add(c)),u.filters.statuses=Array.from(r),x(),h()}function x(){if(!a.statusChips)return;const t=new Set(u.filters.statuses);a.statusChips.querySelectorAll("[data-status]").forEach(n=>{n.classList.toggle("is-active",t.has(n.dataset.status))})}function vt(t){if(!y)return;const n=document.getElementById("reports-status-chart");if(!n)return;const e=["upcoming","ongoing","completed"],r=e.map(i=>t.filter(s=>s.status===i).length),m={labels:e.map(i=>f(`projects.status.${i}`,i)),datasets:[{data:r,backgroundColor:["rgba(59, 130, 246, 0.85)","rgba(250, 204, 21, 0.85)","rgba(34, 197, 94, 0.85)"],borderColor:["rgba(37, 99, 235, 1)","rgba(217, 119, 6, 1)","rgba(22, 163, 74, 1)"],borderWidth:1}]};w("status",n,"doughnut",m,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function Ct(t){if(!y)return;const n=document.getElementById("reports-timeline-chart");if(!n)return;const e=new Map,r=new Intl.DateTimeFormat(St(),{month:"short",year:"numeric"});t.forEach(o=>{if(!o.start||Number.isNaN(o.start.getTime()))return;const d=`${o.start.getFullYear()}-${o.start.getMonth()+1}`,p=e.get(d)||{total:0,label:r.format(o.start)};p.total+=o.overallTotal,e.set(d,p)});const c=Array.from(e.keys()).sort((o,d)=>{const[p,v]=o.split("-").map(Number),[g,C]=d.split("-").map(Number);return p===g?v-C:p-g}),m=c.map(o=>e.get(o)?.label||o),l=c.map(o=>Math.round(e.get(o)?.total||0)),i={labels:m,datasets:[{label:f("projects.reports.charts.timeline","Revenue over time"),data:l,borderColor:"rgba(76, 110, 245, 0.95)",backgroundColor:"rgba(76, 110, 245, 0.25)",fill:!0,tension:.35,pointRadius:4}]};w("timeline",n,"line",i,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:o=>L(o)}}},plugins:{legend:{display:!1}}})}function Tt(t){if(!y)return;const n=document.getElementById("reports-expense-chart");if(!n)return;const e=[...t].sort((s,o)=>o.overallTotal-s.overallTotal).slice(0,6),r=e.map(s=>s.title||s.projectCode),c=e.map(s=>Math.round(s.overallTotal)),m=e.map(s=>Math.round(s.expensesTotal)),l={labels:r,datasets:[{label:f("projects.reports.datasets.value","Total value"),data:c,backgroundColor:"rgba(76, 110, 245, 0.65)"},{label:f("projects.reports.datasets.expenses","Expenses"),data:m,backgroundColor:"rgba(244, 114, 182, 0.55)"}]};w("expenses",n,"bar",l,{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0,ticks:{callback:s=>L(s)}}},plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function Dt(t){if(!y)return;const n=document.getElementById("reports-clients-chart");if(!n)return;const e=new Map;t.forEach(s=>{const o=s.clientName||s.clientCompany||f("projects.fallback.unknownClient","Unknown client"),d=e.get(o)||0;e.set(o,d+s.overallTotal)});const r=Array.from(e.entries()).sort((s,o)=>o[1]-s[1]).slice(0,6),c=r.map(([s])=>s),m=r.map(([,s])=>Math.round(s)),l={labels:c,datasets:[{label:f("projects.reports.charts.clients","Top clients"),data:m,backgroundColor:"rgba(59, 130, 246, 0.75)"}]};w("clients",n,"bar",l,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:s=>L(s)}}},plugins:{legend:{display:!1}}})}function w(t,n,e,r,c){if(!(!y||!n)){if(E[t]){E[t].data=r,E[t].options=c,E[t].update();return}E[t]=new y(n,{type:e,data:r,options:c})}}function Et(t){if(!a.table||!a.tableBody||!a.tableEmpty)return;if(!t.length){a.table.style.display="none",a.tableEmpty.classList.add("active"),a.tableMeta&&(a.tableMeta.textContent="");return}a.table.style.display="",a.tableEmpty.classList.remove("active");const n=t.map(e=>{const r=Nt(e.start,e.end),c=f(`projects.status.${e.status}`,e.status),m=f(`projects.paymentStatus.${e.paymentStatus}`,e.paymentStatus),l=e.clientCompany?`${b(e.clientName)} <small class="text-muted">${b(e.clientCompany)}</small>`:b(e.clientName||f("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${b(e.title||e.projectCode)}</span>
            <small class="text-muted">${b(`#${e.projectCode}`)}</small>
          </div>
        </td>
        <td>${l}</td>
        <td>${b(c)}</td>
        <td>${b(r)}</td>
        <td>${b(N(e.overallTotal))}</td>
        <td>${b(m)}</td>
      </tr>
    `}).join("");if(a.tableBody.innerHTML=n,a.tableMeta){const e=f("projects.reports.table.meta","Showing {count} of {total} projects");a.tableMeta.textContent=e.replace("{count}",k(t.length)).replace("{total}",k(u.totalProjects))}}function Nt(t,n){if(!t&&!n)return"—";const e=t?R(t.toISOString()):"—",r=n?R(n.toISOString()):"—";return n?`${e} → ${r}`:e}function N(t){const n=Number(t)||0,e=S(),r=e==="ar"?"ar-SA":"en-US",c=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(n)),m=e==="ar"?"ر.س":"SAR";return`${D(c)} ${m}`}function k(t){const e=S()==="ar"?"ar-SA":"en-US";return D(new Intl.NumberFormat(e).format(t))}function L(t){const e=S()==="ar"?"ar-SA":"en-US";return D(new Intl.NumberFormat(e,{notation:"compact",compactDisplay:"short"}).format(t))}function St(){return S()==="ar"?"ar-SA":"en-US"}function b(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
