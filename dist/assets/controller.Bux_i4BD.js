import{d as ie,n as E,t as u,j as v,b as Me,z as Ya,y as Xt,v as Xa,w as Za,u as es}from"./auth.BLFzWQsL.js";import{g as He,r as lt,f as pn,a as ts,b as Ze,i as Gn,c as ns}from"./details.BfZeEoH0.js";import{k as fn,l as Ln,n as ke,s as Cn,o as st,b as Zt,D as et,p as rt,q as Oe,h as Kn,c as qt,e as Nt,t as Wn,v as as,w as Jn,x as ss,y as rs,z as Qn,a as St,d as is,A as en,B as Yn,C as Xn,E as tn,F as zt,G as Ne,H as xe,g as Zn,I as os,J as cs,K as ds,u as ls,r as us,L as ms,j as ps}from"./reservationsService.-QaNbRas.js";import{o as gn,p as ea,q as fs,u as tt,v as kt,w as Ie,n as K,x as ta,y as yn,l as Te,z as Vt,A as xt,B as gs,C as na,D as aa,E as sa,s as It,F as ra,G as we,b as vn,H as ys,I as vs,J as hs,K as ia,L as bs,M as Is,k as oa,N as _n}from"./state.CVtBuisg.js";import{d as hn,E as ca,a as Es,c as Ss,e as ks,r as ws,s as As}from"./uiBridge.Dh5t9okA.js";import{g as Bs,a as Ps,b as Ls}from"./reservationPdf.Bl-3EzFe.js";import{o as Cs}from"./view.BO0K_zmi.js";import{c as da,r as la,d as _s,a as $s}from"./reservationsActions.Ca2bsA-k.js";import{ensureProjectsLoaded as qs}from"./projectsService.Do5PYtuQ.js";const Ns="__DEBUG_CREW__";function xs(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Ns);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function $n(e,n){if(xs())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const ua="projects:create:draft",ma="projects.html#projects-section";let nn=null,pa=[],an=new Map,sn=new Map,jt=new Map,Qt=!1,Lt=null,qn=!1,fa=[];const ze="reservations:create:draft";let ot=!1;function Ht(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function bn(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function js(){if(typeof document>"u"||!Ht())return null;try{const{input:n,hidden:t}=dt(),{input:a,hidden:r}=Re(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",c=document.getElementById("res-start-time")?.value||"",d=document.getElementById("res-end-time")?.value||"",o=document.getElementById("res-notes")?.value||"",l=document.getElementById("res-discount")?.value||"",p=document.getElementById("res-discount-type")?.value||"percent",g=!!document.getElementById("res-tax")?.checked,f=!!document.getElementById("res-company-share")?.checked,y=f?at("res-company-share"):null,b=document.getElementById("res-payment-status")?.value||"unpaid",B=document.getElementById("res-payment-progress-type")?.value||"percent",I=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:c,endTime:d,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:o,discount:String(l||""),discountType:p,taxEnabled:g,companyShareEnabled:f,companySharePercent:y,paymentStatus:b,paymentProgressType:B,paymentProgressValue:String(I||""),items:Ie()||[],technicianIds:rs()||[],crewAssignments:fn()||[]}}catch{return null}}function Ve(){if(ot)return;const e=Ht(),n=bn();if(!e&&!n)return;const t=js();if(t){try{const r=(()=>{const i=e?e.getItem(ze):null,c=!i&&n?n.getItem(ze):null,d=i||c;return d?JSON.parse(d):null})(),s=i=>{if(!i)return!1;const c=Array.isArray(i.items)&&i.items.length>0,d=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,o=!!(i.startDate||i.endDate||i.startTime||i.endTime),l=!!(i.customerId||i.customerLabel);return c||d||o||l};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(ze,a),n&&n!==e&&n.setItem(ze,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function ga(){const e=Ht(),n=bn();if(!(!e&&!n))try{e&&e.removeItem(ze),n&&n!==e&&n.removeItem(ze)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function Ts(){const e=Ht(),n=bn();if(!e&&!n)return;ot=!0;let t=null;try{const a=e?e.getItem(ze):null,r=!a&&n?n.getItem(ze):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),ot=!1;return}if(t)try{if(t.startDate||t.startTime){const i=tt(t.startDate||"",t.startTime||"");Ge("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=tt(t.endDate||"",t.endTime||"");Ge("res-end","res-end-time",i)}if(t.customerId){Ae({selectedValue:String(t.customerId)});const{input:i,hidden:c}=dt();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){Ae({selectedValue:"",resetInput:!0});const{input:i,hidden:c}=dt();i&&(i.value=t.customerLabel),c&&(c.value="");try{const d=Dt(t.customerLabel,{allowPartial:!0});d&&(c.value=String(d.id),i.value=d.label,i.dataset.selectedId=String(d.id))}catch{}}if(t.projectId)Ue({selectedValue:String(t.projectId)});else if(t.projectLabel){Ue({selectedValue:"",resetInput:!0});const{input:i,hidden:c}=Re();i&&(i.value=t.projectLabel),c&&(c.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",be(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(kt(t.items),ue()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{Cn(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{Cn(t.technicianIds)}catch{}je();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}J()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{ot=!1}}function Rs(e){if(!e)return null;let n=fa.find(a=>a.id===e)||null;if(n)return n;const t=ys(e);return t?(n={id:e,name:hs(t)||e,price:vs(t),items:vn(t),raw:t},n):null}function Tt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Rt(e){return E(String(e||"")).trim().toLowerCase()}function Ds(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=E(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function ya(e){const n=E(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function va(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function ha(e){if(!e)return null;const n=E(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function ba(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=E(String(n))}}function nt(e){switch(e){case"maintenance":return u("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return u("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return u("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return u("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function dt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function Re(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function Se(){const{input:e,hidden:n}=Re();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function Xe(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function Ia(e,n,{allowPartial:t=!1}={}){const a=ke(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,c)=>{c.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function Dt(e,n={}){return Ia(an,e,n)}function rn(e,n={}){return Ia(sn,e,n)}function be(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Ea(e){pa=Array.isArray(e)?[...e]:[]}function In(){return pa}function En(e){return e&&In().find(n=>String(n.id)===String(e))||null}function Nn(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||u("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function at(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??et,a=E(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:et}function Be(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??et,a=E(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=et),n.dataset.companyShare=String(r),n.checked=!0}function on(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Qt){J();return}Qt=!0;const a=()=>{Qt=!1,J()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(et)),n.disabled){t.checked=!1,v(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),Be()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Be():t.checked&&(t.checked=!1));a()}function Fs(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function xn(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function jn(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function Ae({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=dt();if(!t||!a||!r)return;const s=gn()||[],i=u("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),c=u("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const d=new Set;an=new Map;const o=s.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:jn(m)||c})).filter(m=>{if(!m.label)return!1;const f=ke(m.label);return!f||d.has(f)?!1:(d.add(f),an.set(f,m),!0)}).sort((m,f)=>m.label.localeCompare(f.label,void 0,{sensitivity:"base"}));r.innerHTML=o.map(m=>`<option value="${Tt(m.label)}"></option>`).join("");const l=n?"":t.value,p=e?String(e):a.value?String(a.value):"",g=p?s.find(m=>String(m.id)===p):null;if(g){const m=jn(g)||c;a.value=String(g.id),t.value=m,t.dataset.selectedId=String(g.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":l}function Ue({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=Re();if(!a||!r||!s)return;const i=Array.isArray(n)?n:In()||[],c=u("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",c);const d=[...i].filter(y=>y&&y.id!=null).sort((y,b)=>String(b.createdAt||b.start||"").localeCompare(String(y.createdAt||y.start||""))),o=t?"":a.value,l=u("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),p=new Set;sn=new Map;const g=d.map(y=>{const b=Nn(y)||l;return{id:String(y.id),label:b}}).filter(y=>{if(!y.label)return!1;const b=ke(y.label);return!b||p.has(b)?!1:(p.add(b),sn.set(b,y),!0)});s.innerHTML=g.map(y=>`<option value="${Tt(y.label)}"></option>`).join("");const m=e?String(e):r.value?String(r.value):"",f=m?d.find(y=>String(y.id)===m):null;if(f){const y=Nn(f)||l;r.value=String(f.id),a.value=y,a.dataset.selectedId=String(f.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":o}function Ge(e,n,t){const{date:a,time:r}=ra(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const c=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,c)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const c=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,c)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function Sa(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||Ue({selectedValue:a});const s=(gn()||[]).find(l=>String(l.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";Ae(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const c=xn(e,"start"),d=xn(e,"end");c&&Ge("res-start","res-start-time",c),d&&Ge("res-end","res-end-time",d);const o=document.getElementById("res-notes");o&&e.description&&(n||!o.value)&&(o.value=e.description),J(),je()}function ka({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:ie(),r=Array.isArray(a)?a:[];Ea(r);const s=n!=null?String(n):t.value?String(t.value):"";Ue({selectedValue:s,projectsList:r}),je(),J()}function je(){const{input:e,hidden:n}=Re(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),c=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),o=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),p=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(Xe(t,Se),a&&Xe(a,Se)),r&&Xe(r,Se),s&&Xe(s,Se),i&&Xe(i,Se),c&&Xe(c,Se),d&&Xe(d,Se),p)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=o),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=o),r&&(r.value="unpaid",be(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=o),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=o),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=o),c&&(c.value="0",c.disabled=!0,c.classList.add("reservation-input-disabled"),c.title=o),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=o);else{if(t){const g=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",g&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),c&&(c.disabled=!1,c.classList.remove("reservation-input-disabled"),c.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}on("tax"),J()}function Sn(){const{input:e,hidden:n}=Re();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?rn(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=En(s.id);i?Sa(i,{skipProjectSelectUpdate:!0}):(je(),J())}else n.value="",e.dataset.selectedId="",je(),J()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?rn(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Ve()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function kn(){const{input:e,hidden:n}=dt();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Dt(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),J()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Dt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Ve()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function Ms(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){vt({clearValue:!0});return}let t=null;try{const o=decodeURIComponent(n);t=JSON.parse(o)}catch(o){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",o)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),vt({clearValue:!1}),!t)return;t.fromProjectForm&&(Lt={draftStorageKey:t.draftStorageKey||ua,returnUrl:t.returnUrl||ma});const s=document.getElementById("res-project");if(t.projectId){s&&(Ue({selectedValue:String(t.projectId)}),je());const o=En(t.projectId);o?Sa(o,{forceNotes:!!t.forceNotes}):J(),vt()}else{s&&Ue({selectedValue:""});const o=t.projectTitle?t.projectTitle:u("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");ar(u("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),o)}t.start&&Ge("res-start","res-start-time",t.start),t.end&&Ge("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),c=document.getElementById("res-customer");if(t.customerId){const l=(gn()||[]).find(p=>String(p.id)===String(t.customerId));l?.id!=null&&(Ae({selectedValue:String(l.id)}),c&&(c.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else t.customerName&&i?(Ae({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",c&&(c.value="")):Ae({selectedValue:""});const d=document.getElementById("res-notes");d&&t.description&&!d.value&&(d.value=t.description),J()}function We(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:tt(e,t),end:tt(n,a)}}function wa(e){const n=Rt(e);if(n){const c=jt.get(n);if(c)return c}const{description:t,barcode:a}=ya(e);if(a){const c=pn(a);if(c)return c}const r=ke(t||e);if(!r)return null;let s=ta();if(!s?.length){const c=ie();s=Array.isArray(c?.equipment)?c.equipment:[],s.length&&ia(s)}const i=s.find(c=>ke(c?.desc||c?.description||"")===r);return i||s.find(c=>ke(c?.desc||c?.description||"").includes(r))||null}function Aa(e,n="equipment-description-options"){const t=Rt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(d=>Rt(d.value)===t)||jt.has(t))return!0;const{description:r}=ya(e);if(!r)return!1;const s=ke(r);return s?(ta()||[]).some(c=>ke(c?.desc||c?.description||"")===s):!1}const zs={available:0,reserved:1,maintenance:2,retired:3};function Vs(e){return zs[e]??5}function Tn(e){switch(e){case"available":return u("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return u("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return u("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return u("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return u("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Hs(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${Tn(t)}`;const a=u("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${Tn(t)})`}function Ke(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=hn(),a=ie(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];ia(s);const i=new Map;s.forEach(o=>{const l=Ds(o),p=Rt(l);if(!p||!l)return;const g=He(o),m=Vs(g),f=i.get(p);if(!f){i.set(p,{normalized:p,value:l,bestItem:o,bestStatus:g,bestPriority:m,statuses:new Set([g])});return}f.statuses.add(g),m<f.bestPriority&&(f.bestItem=o,f.bestStatus=g,f.bestPriority=m,f.value=l)}),jt=new Map;const d=Array.from(i.values()).sort((o,l)=>o.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(o=>{jt.set(o.normalized,o.bestItem);const l=Hs(o),p=Tt(o.value);if(l===o.value)return`<option value="${p}"></option>`;const g=Tt(l);return`<option value="${p}" label="${g}"></option>`}).join("");e&&(e.innerHTML=d),n&&(n.innerHTML=d)}function Ba(e,n,t={}){const{silent:a=!1}=t,r=K(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=We();if(!s||!i){const f=u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||v(f),{success:!1,message:f}}const c=Ie();if(wn(c).has(r)){const f=u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||v(f),{success:!1,message:f}}const o=yn(r,s,i);if(o.length){const f=o.map(b=>b.name).join(", "),y=u("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${f}`);return a||v(y),{success:!1,message:y}}if(Te(r,s,i)){const f=u("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const y=new URLSearchParams({type:"equipment",id:r,start:s,end:i});Me(`/reservations/availability.php?${y.toString()}`).then(b=>{const B=Array.isArray(b?.conflicts)?b.conflicts:[],I=Array.from(new Set(B.map(A=>A?.reservation_code||(A?.reservation_id!=null?`#${A.reservation_id}`:null)).filter(Boolean))),T=I.length?`${f}: ${I.join("ØŒ ")}`:f;v(T)}).catch(()=>v(f))}catch{v(f)}return{success:!1,message:f}}const l=pn(r);if(!l){const f=u("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||v(f),{success:!1,message:f}}const p=He(l);if(p==="maintenance"||p==="retired"){const f=nt(p);return a||v(f),{success:!1,message:f}}const g=rt(l);if(!g){const f=u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||v(f),{success:!1,message:f}}Vt({id:g,equipmentId:g,barcode:r,desc:l.desc,qty:1,price:l.price,cost:Ze(l),image:lt(l)}),n&&(n.value=""),ue(),J();const m=u("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||v(m),{success:!0,message:m,barcode:r}}function cn(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=wa(n);if(!t){v(u("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=ts(t.barcode),r=He(a||t);if(r==="maintenance"||r==="retired"){v(nt(r));return}const s=K(t.barcode);if(!s){v(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=rt(t);if(!i){v(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const c={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,cost:Ze(t),image:lt(t)},{start:d,end:o}=We();if(!d||!o){v(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const l=Ie();if(wn(l).has(s)){v(u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const g=yn(s,d,o);if(g.length){const m=g.map(f=>f.name).join(", ");v(u("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(Te(s,d,o)){const m=u("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const f=new URLSearchParams({type:"equipment",id:s,start:d,end:o});Me(`/reservations/availability.php?${f.toString()}`).then(y=>{const b=Array.isArray(y?.conflicts)?y.conflicts:[],B=Array.from(new Set(b.map(T=>T?.reservation_code||(T?.reservation_id!=null?`#${T.reservation_id}`:null)).filter(Boolean))),I=B.length?`${m}: ${B.join("ØŒ ")}`:m;v(I)}).catch(()=>v(m))}catch{v(m)}return}Vt(c),ue(),J(),v(u("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function Os(){Ke();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),cn(e))});const n=()=>{Aa(e.value,"equipment-description-options")&&cn(e)};e.addEventListener("focus",()=>{if(Ke(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function Rn(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function wn(e=Ie()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=K(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=K(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function Us(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=We();if(!n||!t){v(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}Es({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):v(u("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(ca.change,n=>{Rn(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),Rn(e,ks()))}function Gs(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,c=null;const d=[],o=new Set;s.forEach(p=>{const g=K(p);g&&!o.has(g)&&(o.add(g),d.push(g))});const l=Math.min(r,d.length);for(let p=0;p<l;p+=1){const g=d[p],m=Ba(g,null,{silent:!0});m.success&&(i+=1),m.message&&(c=m.message)}if(i>0){const g=u("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",E(String(i)));v(g)}else c&&v(c)}function Pa(){Us(),!(qn||typeof document>"u")&&(document.addEventListener(ca.requestAdd,Gs),qn=!0)}function wt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function dn(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=wt();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),c=n==="package";s&&(s.disabled=c),i&&(i.disabled=c),r&&(r.disabled=n!=="package"||r.options.length===0),bs(n),n==="package"&&Ot()}function Ot(){const{packageSelect:e,packageHint:n}=wt();if(!e)return;const t=ea();fa=t,fs(t.map(c=>c.raw??c));const a=u("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${u("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(c=>{const d=Number.isFinite(Number(c.price))?Number(c.price):0,o=E(d.toFixed(2)),l=`${c.name} â€” ${o} ${a}`;return`<option value="${c.id}">${l}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=u("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=u("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),_a()}function Ks(e,n){const t=e?.name||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=u("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const c=s?.desc||E(String(s?.barcode??s?.normalizedBarcode??""))||u("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const d=i.map(o=>o.name).join(", ");return`â€¢ ${c} (${u("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${d})`}return`â€¢ ${c} (${u("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function La(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=we(e);if(!s)return{success:!1,reason:"invalid",message:u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=Rs(s);if(!i)return{success:!1,reason:"not_found",message:u("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(m=>m?.type==="package"&&we(m.packageId)===s))return{success:!1,reason:"duplicate",message:u("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(na(s,t,a,r)){const m=i.name||s;return{success:!1,reason:"package_conflict",message:u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const c=Array.isArray(i.items)&&i.items.length?i.items:vn(i.raw??{}),d=wn(n),o=[],l=new Set;if(c.forEach(m=>{const f=K(m?.normalizedBarcode??m?.barcode);if(f){if(l.has(f)){o.push({item:m,type:"internal"});return}l.add(f),d.has(f)&&o.push({item:m,type:"external"})}}),o.length){const m=o.map(({item:y})=>y?.desc||y?.description||y?.name||y?.barcode||y?.normalizedBarcode||u("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(y=>E(String(y))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:o.some(y=>y.type==="external")?u("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):u("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:o}}const p=[];return c.forEach(m=>{const f=K(m?.normalizedBarcode??m?.barcode);if(f&&Te(f,t,a,r)){const y=yn(f,t,a,r);p.push({item:m,blockingPackages:y})}}),p.length?{success:!1,reason:"item_conflict",message:Ks(i,p),conflicts:p}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,cost:Number.isFinite(Number(i.cost))?Number(i.cost):0,barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:c.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:K(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0,cost:0})),image:c.find(m=>m?.image)?.image??null},packageInfo:i}}function Ca(e,{silent:n=!1}={}){const t=we(e);if(!t)return n||v(u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=We(),s=Ie(),i=La(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const d={invalid:u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:u("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:u("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");v(i.message||d)}return i}return Vt(i.package),ue(),J(),n||v(u("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function _a(){const{packageSelect:e}=wt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;Ca(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Ws(){const{packageAddButton:e,packageSelect:n}=wt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){v(u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Ca(t)}),e.dataset.listenerAttached="true")}function $a(){const{modeRadios:e}=wt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&dn(r.target.value)}),a.dataset.listenerAttached="true")}),Ws(),_a();const n=xt(),t=e.find(a=>a.value===n);t&&(t.checked=!0),dn(n)}function ue(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=Ie(),a=u("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=u("reservations.create.summary.currency","SR"),s=u("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=u("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),c=u("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),d=u("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;return}const o=st(t);n.innerHTML=o.map(l=>{const p=l.items[0]||{},g=lt(p)||l.image,m=g?`<img src="${g}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',f=E(String(l.count)),y=Number.isFinite(Number(l.unitPrice))?Number(l.unitPrice):0,b=(()=>{try{const{start:W,end:R}=We(),q=Zt(W,R);return Number.isFinite(q)&&q>0?q:1}catch{return 1}})(),B=E(String(b)),I=y*l.count*b,T=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${l.key}"
          min="0"
          step="0.01"
          value="${E(String(y))}"
          aria-label="${u("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,A=`${E(I.toFixed(2))} ${r}`,h=Number.isFinite(Number(l.unitCost))?Number(l.unitCost):0;`${E(h.toFixed(2))}${r}`;const w=l.items.some(W=>W?.type==="package"),P=l.barcodes.map(W=>E(String(W||""))).filter(Boolean),N=P.length?`<details class="reservation-item-barcodes">
            <summary>${u("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${P.map(W=>`<li>${W}</li>`).join("")}
            </ul>
          </details>`:"";let _="";if(w){const W=new Map;if(l.items.forEach(R=>{Array.isArray(R?.packageItems)&&R.packageItems.forEach(q=>{if(!q)return;const Z=K(q.barcode||q.desc||Math.random()),G=W.get(Z);if(G){G.qty+=Number.isFinite(Number(q.qty))?Number(q.qty):1;return}W.set(Z,{desc:q.desc||q.barcode||u("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(q.qty))?Number(q.qty):1,barcode:q.barcode??q.normalizedBarcode??""})})}),W.size){const R=Array.from(W.values()).map(q=>{const Z=E(String(q.qty)),G=q.desc||E(String(q.barcode||"")),z=q.barcode?` <span class="reservation-package-items__barcode">(${E(String(q.barcode))})</span>`:"";return`<li>${G}${z} Ã— ${Z}</li>`}).join("");_=`
            <details class="reservation-package-items">
              <summary>${u("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${R}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${w?`${_||""}${N||""}`:N}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${l.key}" aria-label="${c}" ${w?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${l.key}" aria-label="${i}" ${w?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${B}</span></td>
          <td>${T}</td>
          <td><input type="number" class="form-control form-control-sm reservation-unit-cost-input" data-group-key="${l.key}" min="0" step="0.01" value="${E(String(h))}" aria-label="${u("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"></td>
          <td>${A}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${l.key}" aria-label="${d}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Js(e){const n=Ie(),a=st(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(gs(r),ue(),J())}function Qs(e){const n=Ie(),t=n.filter(a=>Oe(a)!==e);t.length!==n.length&&(kt(t),ue(),J())}function Ys(e,n){const t=qa(n),a=Number.isFinite(t)&&t>=0?Na(t):0,r=Ie(),i=st(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const c=[...r];i.itemIndices.forEach(d=>{c[d]&&(c[d]={...c[d],price:a,unit_price:a})}),kt(c),ue(),J()}function Xs(e,n){const t=qa(n),a=Number.isFinite(t)&&t>=0?Na(t):0,r=Ie(),i=st(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const c=[...r];i.itemIndices.forEach(d=>{if(c[d]){const o={...c[d],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};c[d]=o}}),kt(c),ue(),J()}function qa(e){const n=E(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),t=Number.parseFloat(n);return Number.isFinite(t)?t:NaN}function Na(e){const n=Number(e);return!Number.isFinite(n)||n<0?0:Number(n.toFixed(2))}function Zs(e){const n=Ie(),a=st(n).find(p=>p.key===e);if(!a)return;const{start:r,end:s}=We();if(!r||!s){v(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(p=>K(p.barcode))),{equipment:c=[]}=ie(),d=(c||[]).find(p=>{const g=K(p?.barcode);return!g||i.has(g)||Oe({desc:p?.desc||p?.description||p?.name||"",price:Number(p?.price)||0})!==e||!Gn(p)?!1:!Te(g,r,s)});if(!d){v(u("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const o=K(d.barcode),l=rt(d);if(!l){v(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}Vt({id:l,equipmentId:l,barcode:o,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,cost:Number.isFinite(Number(d.cost))?Number(d.cost):Number.isFinite(Number(d.unit_cost))?Number(d.unit_cost):Number(a.unitCost)||0,image:lt(d)}),ue(),J()}function J(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(E(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,c=document.getElementById("res-payment-status"),d=c?.value||"unpaid",{start:o,end:l}=We();i&&Be();const p=at(),g=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),f=va(g),y=ha(m);fn(),Ln({selectedItems:Ie(),discount:t,discountType:r,applyTax:i,paidStatus:d,paymentProgressType:f,paymentProgressValue:y,start:o,end:l,companySharePercent:p,paymentHistory:[]});const b=Ln.lastResult;b?(ba(m,b.paymentProgressValue),c&&(c.value=b.paymentStatus,be(c,b.paymentStatus))):be(c,d);try{Ve()}catch{}}function er(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",c=>{c.target.value=E(c.target.value),J()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",J),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if(Se()){t.checked=!1,v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}on("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(Se()){a.checked=!1,v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}on("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(Se()){r.value="unpaid",be(r,"unpaid"),v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}be(r),J()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",c=>{if(Se()){s.value="percent",v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",J()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",c=>{if(Se()){i.value="",v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}c.target.value=E(c.target.value),J()}),i.dataset.listenerAttached="true"),J()}function tr(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const c=()=>{try{Ve()}catch{}},d=()=>{try{ue(),J()}catch{}};s.addEventListener("input",c),s.addEventListener("change",c),s.addEventListener("input",d),s.addEventListener("change",d),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const c=()=>{try{Ve()}catch{}},d=()=>{try{ue(),J()}catch{}};i.addEventListener("input",c),i.addEventListener("change",c),i.addEventListener("input",d),i.addEventListener("change",d),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){J();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),J();try{ue()}catch{}};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{Ve()}catch{}try{ue(),J()}catch{}}});const r=()=>{try{Ve()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Dn(){const{input:e,hidden:n}=dt(),{input:t,hidden:a}=Re(),{customers:r}=ie();let s=n?.value?String(n.value):"";if(!s&&e?.value){const L=Dt(e.value,{allowPartial:!0});L&&(s=String(L.id),n&&(n.value=s),e.value=L.label,e.dataset.selectedId=s)}const i=r.find(L=>String(L.id)===s);if(!i){v(u("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const c=i.id;let d=a?.value?String(a.value):"";if(!d&&t?.value){const L=rn(t.value,{allowPartial:!0});L&&(d=String(L.id),a&&(a.value=d),t.value=L.label,t.dataset.selectedId=d)}const o=document.getElementById("res-start").value,l=document.getElementById("res-end").value,p=document.getElementById("res-start-time")?.value||"00:00",g=document.getElementById("res-end-time")?.value||"00:00";if(!o||!l){v(u("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const m=`${o}T${p}`,f=`${l}T${g}`,y=new Date(m),b=new Date(f);if(Number.isNaN(y.getTime())||Number.isNaN(b.getTime())||y>=b){v(u("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const B=fn();B.map(L=>L.technicianId).filter(Boolean);const I=Ie();if(I.length===0&&B.length===0){v(u("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const T=document.getElementById("res-notes")?.value||"",A=parseFloat(E(document.getElementById("res-discount")?.value))||0,h=document.getElementById("res-discount-type")?.value||"percent",w=document.getElementById("res-payment-status"),P=w?.value||"unpaid",N=document.getElementById("res-payment-progress-type"),_=document.getElementById("res-payment-progress-value"),W=va(N),R=ha(_),q=d?En(d):null,Z=Fs(q);if(d&&!q){v(u("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const L of I){const O=He(L.barcode);if(O==="maintenance"||O==="retired"){v(nt(O));return}}const G=[];for(const L of I){const O=K(L.barcode);if(Te(O,m,f)){const ce=L?.desc||L?.name||L?.barcode||u("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");G.push({label:E(String(ce)),barcode:O})}}if(G.length){const L=u("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let O=null;try{const te=Array.from(new Set(G.map(se=>se.barcode).filter(Boolean))),ye=new Map;await Promise.all(te.map(async se=>{const le=new URLSearchParams({type:"equipment",id:se,start:m,end:f}),fe=await Me(`/reservations/availability.php?${le.toString()}`),qe=Array.isArray(fe?.conflicts)?fe.conflicts:[],Qe=Array.from(new Set(qe.map(Ye=>Ye?.reservation_code||(Ye?.reservation_id!=null?`#${Ye.reservation_id}`:null)).filter(Boolean)));ye.set(se,Qe)})),O=G.map(({label:se,barcode:le})=>{const fe=ye.get(le)||[];return fe.length?`${se} (${fe.join("ØŒ ")})`:se}).join("ØŒ ")}catch{}const ce=O||G.map(te=>te.label).filter(Boolean).map(String).join("ØŒ ");v(`${L}: ${ce}`,"warning",6e3);return}const z=[];for(const L of I){if(L?.type!=="package")continue;const O=L.packageId??L.package_id??null;if(O&&na(O,m,f)){const ce=L.desc||L.packageName||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let te=[];try{const ye=new URLSearchParams({type:"package",id:String(O),start:m,end:f}),se=await Me(`/reservations/availability.php?${ye.toString()}`),le=Array.isArray(se?.conflicts)?se.conflicts:[];te=Array.from(new Set(le.map(fe=>fe?.reservation_code||(fe?.reservation_id!=null?`#${fe.reservation_id}`:null)).filter(Boolean)))}catch{}z.push({label:E(String(ce)),codes:te})}}if(z.length){const L=z.map(({label:ce,codes:te})=>te&&te.length?`${ce} (${te.join("ØŒ ")})`:ce).join("ØŒ "),O=u("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");v(`${O}: ${L}`,"warning",6e3);return}const V=[];for(const L of B){if(!L?.technicianId||!aa(L.technicianId,m,f))continue;const O=L?.technicianName||L?.positionLabel||String(L.technicianId);let ce=[];try{ce=sa(L.technicianId,m,f,null)}catch{}V.push({label:E(String(O)),codes:ce})}if(V.length){const L=u("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),O=V.map(({label:ce,codes:te})=>te&&te.length?`${ce} (${te.join("ØŒ ")})`:ce).join("ØŒ ");v(`${L}: ${O}`);return}const oe=document.getElementById("res-tax"),Q=document.getElementById("res-company-share"),x=!!d;x?(oe&&(oe.checked=!1,oe.disabled=!0,oe.classList.add("disabled"),oe.title=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),Q&&(Q.checked=!1,Q.disabled=!0,Q.classList.add("disabled"),Q.title=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),w&&(w.value="unpaid",w.disabled=!0,be(w,"unpaid"),w.title=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),N&&(N.disabled=!0,N.classList.add("disabled")),_&&(_.value="",_.disabled=!0,_.classList.add("disabled"))):(oe&&(oe.disabled=!1,oe.classList.remove("disabled"),oe.title=""),Q&&(Q.disabled=!1,Q.classList.remove("disabled"),Q.title=""),w&&(w.disabled=!1,w.title=""),N&&(N.disabled=!1,N.classList.remove("disabled")),_&&(_.disabled=!1,_.classList.remove("disabled")));const D=x?!1:oe?.checked||!1,Y=!!Q?.checked;if(!x&&Y!==D){v(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let H=Y?at():null;Y&&(!Number.isFinite(H)||H<=0)&&(Be(),H=at());const C=Y&&D&&Number.isFinite(H)&&H>0;D&&Be();const ae=Kn(I,A,h,D,B,{start:m,end:f,companySharePercent:C?H:0}),me=Ya(),X=qt({totalAmount:ae,progressType:W,progressValue:R,history:[]});_&&ba(_,X.paymentProgressValue);const Je=[];X.paymentProgressValue!=null&&X.paymentProgressValue>0&&Je.push({type:X.paymentProgressType||W,value:X.paymentProgressValue,amount:X.paidAmount,percentage:X.paidPercent,recordedAt:new Date().toISOString()});const $e=Nt({manualStatus:P,paidAmount:X.paidAmount,paidPercent:X.paidPercent,totalAmount:ae});w&&(w.value=$e,be(w,$e));const ge=typeof q?.paymentStatus=="string"?q.paymentStatus.toLowerCase():null,ut=ge&&["paid","partial","unpaid"].includes(ge)?ge:"unpaid",pe=Wn({reservationCode:me,customerId:c,start:m,end:f,status:Z?"confirmed":"pending",title:null,location:null,notes:T,projectId:d||null,totalAmount:ae,discount:x?0:A,discountType:x?"percent":h,applyTax:D,paidStatus:x?ut:$e,confirmed:Z,items:I.map(L=>({...L,equipmentId:L.equipmentId??L.id})),crewAssignments:B,companySharePercent:x||!C?null:H,companyShareEnabled:x?!1:C,paidAmount:x?0:X.paidAmount,paidPercentage:x?0:X.paidPercent,paymentProgressType:x?null:X.paymentProgressType,paymentProgressValue:x?null:X.paymentProgressValue,paymentHistory:x?[]:Je});try{$n("about to submit",{crewAssignments:B,techniciansPayload:pe?.technicians,payload:pe});const L=await as(pe);$n("server response",{reservation:L?.id??L?.reservationId??L?.reservation_code,technicians:L?.technicians,crewAssignments:L?.crewAssignments,techniciansDetails:L?.techniciansDetails}),hn(),Ke(),It(),xa(),v(u("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const O=document.getElementById("sub-tab-trigger-my-reservations-tab");O&&typeof O.click=="function"&&setTimeout(()=>O.click(),0)}catch{}typeof nn=="function"&&nn({type:"created",reservation:L}),nr(L)}catch(L){console.error("âŒ [reservations/createForm] Failed to create reservation",L);const O=Jn(L)?L.message:u("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(O,"error"),x&&(v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),vt({clearValue:!1}))}}function nr(e){if(!Lt)return;const{draftStorageKey:n=ua,returnUrl:t=ma}=Lt,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],c=String(a);i.includes(c)||i.push(c),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}Lt=null,t&&(window.location.href=t)}function vt({clearValue:e=!1}={}){const{input:n,hidden:t}=Re();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,je())}function ar(e,n=""){const{input:t,hidden:a}=Re();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),je())}function xa(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),Ae({selectedValue:"",resetInput:!0});try{Ge("res-start","res-start-time","")}catch{}try{Ge("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),vt({clearValue:!1}),Ue({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",be(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const c=document.getElementById("res-payment-progress-value");c&&(c.value=""),ss(),kt([]),Ss("form-reset"),ue(),je(),J(),ga()}function sr(){const e=document.getElementById("reservation-items");if(!e||e.dataset.listenerAttached)return;e.addEventListener("click",t=>{const a=t.target.closest("button[data-action]");if(!a)return;const{action:r,groupKey:s}=a.dataset;if(r==="decrease-group"&&s){Js(s);return}if(r==="increase-group"&&s){Zs(s);return}if(r==="remove-group"&&s){Qs(s);return}});const n=t=>{const a=t.target.closest(".reservation-unit-price-input");if(a){const s=a.dataset.groupKey;s&&Ys(s,a.value);return}const r=t.target.closest(".reservation-unit-cost-input");if(r){const s=r.dataset.groupKey;s&&Xs(s,r.value)}};e.addEventListener("change",n),e.dataset.listenerAttached="true"}function rr(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(xt()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,Ba(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||xt()!=="single")return;const{start:s,end:i}=We();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function ir(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await Dn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await Dn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),xa();try{ga()}catch{}v(u("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function Zr({onAfterSubmit:e}={}){nn=typeof e=="function"?e:null,ot=!0;const{customers:n,projects:t}=ie();Is(n||[]),Ae(),kn(),Ea(t||[]),ka({projectsList:t}),Sn(),Ke(),Ot(),Os(),Pa(),$a(),tr(),er(),sr(),rr(),ir(),Ts(),Ms(),J(),ue();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Ve()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}ot=!1}function ja(){Ke(),Ot(),ka(),Ae(),kn(),Sn(),Pa(),$a(),ue(),J()}if(typeof document<"u"){const e=()=>{Ae(),Ue({projectsList:In()}),kn(),Sn(),J()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Ke()}),document.addEventListener("packages:changed",()=>{Ot(),xt()==="package"&&dn("package")})}typeof window<"u"&&(window.getCompanySharePercent=at);function Pt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function or(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function cr(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=or(t);if(a!==null)return a}return null}function Fn(e,n=0){const t=cr(e);if(t!=null)return t;const a=Pt(e.createdAt??e.created_at);if(a!=null)return a;const r=Pt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=Pt(e.start);if(s!=null)return s;const i=Pt(e.end);if(i!=null)return i;const c=Number(e.id??e.reservationId);return Number.isFinite(c)?c:Number.isFinite(n)?n:0}function dr({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((I,T)=>({reservation:I,index:T})),i=n.searchTerm||"",c=n.searchReservationId||"",d=n.searchCustomerName||"",o=n.searchProjectId||"",l=n.startDate||"",p=n.endDate||"",g=n.status||"",m=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,f=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,y=l?new Date(`${l}T00:00:00`):null,b=p?new Date(`${p}T23:59:59`):null,B=s.filter(({reservation:I})=>{const T=t.get(String(I.customerId)),A=r?.get?.(String(I.projectId)),h=I.start?new Date(I.start):null,w=Qn(I),{effectiveConfirmed:P}=St(I,A);if(m!=null&&String(I.customerId)!==String(m)||f!=null&&!(Array.isArray(I.technicians)?I.technicians.map(q=>String(q)):[]).includes(String(f))||g==="confirmed"&&!P||g==="pending"&&P||g==="completed"&&!w)return!1;if(g==="cancelled"){const R=String(I?.status||I?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(R))return!1}if(y&&h&&h<y||b&&h&&h>b)return!1;if(c){const R=[I.reservationId,I.id,I.reservation_id,I.reservationCode,I.reservation_code,I.code,I.reference,I.referenceNumber,I.reference_number],q=ke(R.filter(G=>G!=null&&G!=="").map(String).join(" ")).replace(/\s+/g,""),Z=c.replace(/\s+/g,"");if(!q.includes(Z))return!1}if(d&&!ke(T?.customerName||I.customerName||"").includes(d))return!1;if(o){const R=[I.projectId,I.project_id,I.projectID,A?.id,A?.projectCode,A?.project_code],q=ke(R.filter(G=>G!=null&&G!=="").map(String).join(" ")).replace(/\s+/g,""),Z=o.replace(/\s+/g,"");if(!q.includes(Z))return!1}if(!i)return!0;const N=I.items?.map?.(R=>`${R.barcode} ${R.desc}`).join(" ")||"",_=(I.technicians||[]).map(R=>a.get(String(R))?.name).filter(Boolean).join(" ");return ke([I.reservationId,T?.customerName||I.customerName,I.notes,N,_,A?.title].filter(Boolean).join(" ")).includes(i)});return B.sort((I,T)=>{const A=Fn(I.reservation,I.index),h=Fn(T.reservation,T.index);return A!==h?h-A:T.index-I.index}),B}function lr({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=u("reservations.create.summary.currency","SR"),s=u("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=u("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),c=u("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),d=u("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),o=u("reservations.list.crew.separator","ØŒ "),l=u("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),p=u("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),g=u("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),m=u("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),f=u("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),y=u("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),b=u("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),B=u("reservations.list.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),I=u("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),T=u("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),A={client:u("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:u("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:u("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:u("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:u("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:u("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:u("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:h,index:w})=>{const P=n.get(String(h.customerId)),N=h.projectId?a?.get?.(String(h.projectId)):null,_=Qn(h),W=h.items?.length||0,R=Array.isArray(h.crewAssignments)?h.crewAssignments:[],q=(h.technicians||[]).map(F=>t.get(String(F))).filter(Boolean),Z=R.length?R.map(F=>{const M=F.positionLabel??F.position_name??F.role??u("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),U=F.technicianName??t.get(String(F.technicianId??""))?.name??null;return U?`${E(M)} (${E(U)})`:E(M)}):q.map(F=>F.name),G=Z.length?Z.join(o):"â€”",z=E(String(h.reservationId??"")),V=h.start?E(Xt(h.start)):"-",oe=h.end?E(Xt(h.end)):"-",Q=h.discount??h.discountValue??h.discount_value??h.discountAmount??0,x=Number.parseFloat(E(String(Q))),D=Number.isFinite(x)?x:0,Y=h.discountType??h.discount_type??h.discountMode??"percent",H=String(Y).toLowerCase()==="amount"?"amount":"percent",C=!!(h.applyTax??h.apply_tax??h.taxApplied),ae=h.companySharePercent??h.company_share_percent??h.companyShare??h.company_share,me=h.companyShareEnabled??h.company_share_enabled??h.companyShareApplied,X=Number.parseFloat(E(String(ae))),$e=(me===!0||Number.isFinite(X)&&X>0)&&Number.isFinite(X)?X:0;let ge=0;try{const F=is({items:h.items||[],technicianIds:h.technicians||[],crewAssignments:Array.isArray(h.crewAssignments)?h.crewAssignments:[],discount:D,discountType:H,applyTax:C,start:h.start,end:h.end,companySharePercent:$e,groupingSource:h}),M=Number(F?.finalTotal||0);ge=Number.isFinite(M)?Number(M.toFixed(2)):0}catch{ge=0}const ut=Number.parseFloat(E(String(h.cost??0)))||0,pe=ge>0?ge:ut,L=h.paymentHistory||h.payment_history||[],O=qt({totalAmount:pe,paidAmount:L.length?0:h.paidAmount,paidPercent:L.length?0:h.paidPercent,history:L});let te=Nt({manualStatus:null,paidAmount:O.paidAmount,paidPercent:O.paidPercent,totalAmount:pe});if(N)try{const{totalWithTax:F}=Cs(N)||{totalWithTax:0},M=N.paymentHistory||N.payments||[],U=qt({totalAmount:F,paidAmount:M.length?0:N.paidAmount,paidPercent:M.length?0:N.paidPercent,history:M}),ne=Nt({manualStatus:null,paidAmount:U.paidAmount,paidPercent:U.paidPercent,totalAmount:F});ne&&(te=ne)}catch{}const ye=te==="paid",se=te==="partial",{effectiveConfirmed:le,projectLinked:fe}=St(h,N),qe=le?"status-confirmed":"status-pending",Qe=ye?"status-paid":se?"status-partial":"status-unpaid";let Ye=`<span class="reservation-chip status-chip ${qe}">${le?l:p}</span>`;const Bt=ye?m:se?y:f;let mt=`<span class="reservation-chip status-chip ${Qe}">${Bt}</span>`,Kt=ye?" tile-paid":se?" tile-partial":" tile-unpaid";_&&(Kt+=" tile-completed");let pt="";_&&(Ye=`<span class="reservation-chip status-chip status-completed">${g}</span>`,mt=`<span class="reservation-chip status-chip status-completed">${Bt}</span>`,pt=` data-completed-label="${u("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`);let De="";fe||(le?_||(De=`<button class="tile-confirm" data-reservation-index="${w}" data-action="close">${B}</button>`):De=`<button class="tile-confirm" data-reservation-index="${w}" data-action="confirm">${b}</button>`);const Fe=De?`<div class="tile-actions">${De}</div>`:"",Wt=E(pe.toFixed(2)),ft=E(String(W)),S=h.notes?E(h.notes):c,$=d.replace("{count}",ft),k=h.applyTax?`<small>${s}</small>`:"";let j=I;return h.projectId&&(j=N?.title?E(N.title):T),`
      <div class="${De?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${Kt}"${pt} data-reservation-index="${w}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${z}</div>
          <div class="tile-badges">
            ${Ye}
            ${mt}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${A.client}</span>
            <span class="tile-value">${P?.customerName||h.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.project}</span>
            <span class="tile-value">${j}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.start}</span>
            <span class="tile-value tile-inline">${V}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.end}</span>
            <span class="tile-value tile-inline">${oe}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.cost}</span>
            <span class="tile-value">${Wt} ${r} ${k}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.equipment}</span>
            <span class="tile-value">${$}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${A.crew}</span>
            <span class="tile-value">${Z.length?G:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${S}</span>
          </div>
        </div>
        ${Fe}
      </div>
    `}).join("")}function ur({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a,onCloseReservation:r,onReopenReservation:s}={}){const i=It(),{reservations:c=[],customers:d=[],technicians:o=[],projects:l=[]}=ie(),p=c.map(A=>{const h=en(A);return{...h,id:A.id??h.id,reservationId:A.reservationId??A.reservation_id??h.reservationId,reservationCode:A.reservationCode??A.reservation_code??h.reservationCode}}),g=p,m=Array.isArray(i)?i:o||[],f=new Map((l||[]).map(A=>[String(A.id),A])),y=document.getElementById(e);if(!y){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!g||g.length===0){y.innerHTML=`<p>${u("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const b=n||Bs(),B=new Map(d.map(A=>[String(A.id),A])),I=new Map(m.map(A=>[String(A.id),A])),T=dr({reservations:p,filters:b,customersMap:B,techniciansMap:I,projectsMap:f});if(T.length===0){y.innerHTML=`<p>${u("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}y.innerHTML=`<div class="reservations-grid">${lr({entries:T,customersMap:B,techniciansMap:I,projectsMap:f})}</div>`,y.querySelectorAll('[data-action="details"]').forEach(A=>{const h=Number(A.dataset.reservationIndex);Number.isNaN(h)||A.addEventListener("click",()=>{typeof t=="function"&&t(h)})}),y.querySelectorAll('button[data-action="confirm"]').forEach(A=>{const h=Number(A.dataset.reservationIndex);Number.isNaN(h)||A.addEventListener("click",w=>{w.stopPropagation(),typeof a=="function"&&a(h,w)})}),y.querySelectorAll('button[data-action="close"]').forEach(A=>{const h=Number(A.dataset.reservationIndex);Number.isNaN(h)||A.addEventListener("click",w=>{w.stopPropagation(),typeof r=="function"&&r(h,w)})})}function mr(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=ie(),c=r.map(b=>{const B=en(b);return{...B,id:b.id??B.id,reservationId:b.reservationId??b.reservation_id??B.reservationId,reservationCode:b.reservationCode??b.reservation_code??B.reservationCode}}),d=r[e];if(!d)return v(u("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;let o=c[e]??en(d);const l=s.find(b=>String(b.id)===String(d.customerId)),p=d.projectId?i.find(b=>String(b.id)===String(d.projectId)):null,g=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),f=(b,B=null)=>{if(g){const I=B??(It()||[]);g.innerHTML=ns(b,l,I,e,p)}},y=()=>{const b=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},B=document.getElementById("reservation-details-edit-btn");B&&(B.onclick=()=>{b(),typeof n=="function"&&n(e,{reservation:d,customer:l,getEditContext:a})});const I=document.getElementById("reservation-details-delete-btn");I&&(I.onclick=()=>{b(),typeof t=="function"&&t(e,{reservation:d,customer:l})});const T=g?.querySelector('[data-action="open-project"]');T&&p&&T.addEventListener("click",()=>{b();const w=p?.id!=null?String(p.id):"",P=w?`projects.html?project=${encodeURIComponent(w)}`:"projects.html";window.location.href=P});const A=document.getElementById("reservation-details-export-btn");A&&(A.onclick=async w=>{w?.preventDefault?.(),w?.stopPropagation?.(),A.blur();try{await Ps({reservation:d,customer:l,project:p})}catch(P){console.error("âŒ [reservations] export to PDF failed",P),v(u("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const h=document.getElementById("reservation-details-checklist-btn");h&&(h.onclick=async w=>{w?.preventDefault?.(),w?.stopPropagation?.(),h.blur();try{await Ls({reservation:d,customer:l,project:p})}catch(P){console.error("âŒ [reservations] export checklist PDF failed",P),v(u("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const w=g?.querySelector("[data-tech-slider]");if(w){const P=w.querySelector("[data-slider-track]"),N=w.querySelector("[data-slider-prev]"),_=w.querySelector("[data-slider-next]");if(P&&(N||_)){const W=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",R=()=>{const G=P.querySelector(".reservation-technician-card"),z=G&&G.getBoundingClientRect().width||220,V=12,oe=Math.max(1,Math.floor(P.clientWidth/(z+V)));return Math.max(z+V,Math.floor(oe*(z+V)*.9))},q=()=>{const G=Math.max(0,P.scrollWidth-P.clientWidth-2),z=P.scrollLeft<=1,V=P.scrollLeft>=G;N&&(N.disabled=z),_&&(_.disabled=V)},Z=G=>{const z=R()*G,V=W?-z:z;P.scrollBy({left:V,behavior:"smooth"})};N?.addEventListener("click",()=>Z(-1)),_?.addEventListener("click",()=>Z(1)),P.addEventListener("scroll",q,{passive:!0}),window.addEventListener("resize",q,{passive:!0}),setTimeout(q,0)}}}catch{}};if(g&&(f(o),y(),oa().then(()=>{const b=It()||[];f(o,b),y()}).catch(()=>{})),Yn(o)){const b=o.id||o.reservationId||o.reservation_code;Xn(b).then(B=>{B&&(o=B,f(o),y())}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function it(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";if(!e||!n)return{start:null,end:null};const r=`${e}T${t}`,s=`${n}T${a}`;return{start:tt(e,t)||r,end:tt(n,a)||s}}function Ft(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function An(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Ct(){const{container:e,select:n,hint:t,addButton:a}=An();if(!n)return;const r=n.value,s=ea(),i=u("reservations.create.summary.currency","SR"),c=`<option value="" disabled selected>${u("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,d=s.map(l=>{const p=Number.isFinite(Number(l.price))?Number(l.price):0,g=E(p.toFixed(2)),m=`${l.name} â€” ${g} ${i}`;return`<option value="${Ft(l.id)}">${Ft(m)}</option>`}).join("");n.innerHTML=`${c}${d}`;const o=s.length>0;n.disabled=!o,a&&(a.disabled=!o),e&&(e.hidden=!o,e.setAttribute("aria-hidden",o?"false":"true")),t&&(o?(t.textContent=u("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=u("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),o&&r&&s.some(l=>l.id===r)?n.value=r:n.selectedIndex=0}function pr(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||v(u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=ve(),{start:s,end:i}=it(),{reservations:c=[]}=ie(),d=a!=null&&c[a]||null,o=d?.id??d?.reservationId??null,l=La(t,{existingItems:r,start:s,end:i,ignoreReservationId:o});if(!l.success)return n||v(l.message||u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),l;const p=[...r,l.package];return _e(a,p),Ce(p),he(),n||v(u("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),l}function Mn(){const{select:e}=An();if(!e)return;const n=e.value||"";pr(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function fr(){const{addButton:e,select:n}=An();n&&!n.dataset.langRefreshAttached&&(document.addEventListener("language:changed",Ct),document.addEventListener("language:translationsReady",Ct),n.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Mn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Mn())}),n.dataset.listenerAttached="true"),Ct()}function Ce(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=u("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=u("reservations.create.summary.currency","SR"),r=u("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=u("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=u("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),c=u("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${t}</td></tr>`,Vn(n);return}const{groups:d}=zt({items:e});n.innerHTML=d.map(o=>{const l=o.items[0]||{},p=lt(l)||o.image,g=p?`<img src="${p}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',m=String(o?.type||"").toLowerCase()==="package"||o.items.some(x=>x?.type==="package"),f=E(String(o.count)),y=Ne(o.unitPrice),b=Number.isFinite(y)?xe(y):0,B=Ne(o.unitCost);let I=Number.isFinite(B)?xe(B):0;const T=(()=>{try{const{start:x,end:D}=it(),Y=typeof Zt=="function"?Zt(x,D):1;return Number.isFinite(Y)&&Y>0?Y:1}catch{return 1}})(),A=Ne(o.totalPrice),h=Number.isFinite(A)?A:b*(Number.isFinite(o.count)?o.count:1)*T,w=xe(h),P=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${o.key}"
          min="0"
          step="0.01"
          value="${E(String(b))}"
          aria-label="${u("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,N=`edit-unit-cost-${o.key}`,_=(()=>{for(let x=0;x<e.length;x+=1){const D=e[x];if(!(!D||String(D.type||"").toLowerCase()!=="package")&&Oe(D)===o.key)return x}return null})();if(_!=null&&Number.isInteger(_)&&e[_]){const x=e[_],D=Ne(x.unit_cost??x.cost??x.package_cost??x.packageCost);Number.isFinite(D)&&(I=xe(D))}const W=(()=>{if(!m)return null;const x=[o.packageId,o.package_id,o.packageCode,o.package_code,o.packageDisplayCode,o.barcode,o.key];for(const D of x){if(!D)continue;const Y=we(D);if(Y)return Y;const H=E(String(D)).trim().toLowerCase();if(H)return H}return null})(),R=W?`data-package-identity="${W}"`:"",q=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${N}"
          data-group-key="${o.key}"
          ${R}
          ${_!=null&&Number.isInteger(_)?`data-package-index="${_}"`:""}
          min="0"
          step="0.01"
          value="${E(String(I))}"
          aria-label="${u("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,Z=`${E(w.toFixed(2))} ${a}`,G=o.barcodes.map(x=>E(String(x||""))).filter(Boolean),z=G.length?`<details class="reservation-item-barcodes">
            <summary>${u("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${G.map(x=>`<li>${x}</li>`).join("")}
            </ul>
          </details>`:"";let V="";if(m){const x=new Map,D=H=>{const C=Number.parseFloat(E(String(H??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(C)||C<=0||C>99?1:Math.round(C)},Y=[];if(Array.isArray(o.packageItems)&&o.packageItems.length&&Y.push(...o.packageItems),o.items.forEach(H=>{Array.isArray(H?.packageItems)&&Y.push(...H.packageItems)}),Y.forEach(H=>{if(!H)return;const C=K(H.barcode||H.normalizedBarcode||H.desc||Math.random());if(!C)return;const ae=x.get(C),me=D(H.qtyPerPackage??H.perPackageQty??H.quantityPerPackage??H.qty??H.quantity??1),X=Math.max(1,Math.min(me,99));if(ae){ae.qty=X;return}x.set(C,{desc:H.desc||H.barcode||u("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:X,barcode:H.barcode??H.normalizedBarcode??""})}),x.size){const H=Array.from(x.values()).map(C=>{const ae=E(String(C.qty>0?Math.min(C.qty,99):1)),me=Ft(C.desc||""),X=C.barcode?` <span class="reservation-package-items__barcode">(${Ft(E(String(C.barcode)))})</span>`:"";return`<li>${me}${X} Ã— ${ae}</li>`}).join("");V=`
            <details class="reservation-package-items">
              <summary>${u("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${H}
              </ul>
            </details>
          `}}const oe=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",Q=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${o.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${g}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${o.description||"-"}</div>
                ${m?`${V||""}${z||""}`:z}
              </div>
            </div>
          </td>
          <td>
            <div class="${oe}" data-group-key="${o.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${o.key}" aria-label="${i}"${Q}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${o.key}" aria-label="${s}"${Q}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${E(String(T))}</span></td>
          <td>${P}</td>
          <td>${q}</td>
          <td>${Z}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${o.key}" aria-label="${c}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Vn(n)}function gr(e){switch(e){case"amount":return u("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return u("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return u("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Ut(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Gt();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(ie()?.projects||[]).find(d=>String(d.id)===String(t)),c=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(c)&&c.length&&(n=c)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${u("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,zn();return}const a=u("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const c=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${E(Number(s.amount).toFixed(2))} ${a}`:"â€”",d=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${E(Number(s.percentage).toFixed(2))}%`:"â€”",o=s?.recordedAt?E(Xt(s.recordedAt)):"â€”",l=gr(s?.type),p=s?.note?E(s.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${c}</td>
        <td>${d}</td>
        <td>${o}</td>
        <td>${p}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${u("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${u("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${u("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${u("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${u("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${u("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,zn()}function yr(){if(Et()){v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=Da(e);let a=Fa(n);if(!Number.isFinite(a)||a<=0){v(u("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=tn.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,c=Number(r?.paidAmount)||0,d=u("reservations.create.summary.currency","SR");let o=null,l=null;if(t==="percent"){const g=Math.max(0,100-i);if(g<=1e-4){v(u("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const f=E(m.toFixed(2));v(u("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",f)),a=m}l=Number(a.toFixed(2)),s>0&&(o=a/100*s)}else{const g=Math.max(0,s-c);if(g<=1e-4){v(u("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const f=`${E(m.toFixed(2))} ${d}`;v(u("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",f)),a=m}o=Number(a.toFixed(2)),s>0&&(l=o/s*100)}o!=null&&(o=Number(o.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const p={type:t,value:a,amount:o,percentage:l,recordedAt:new Date().toISOString()};$r(p),Bn(Gt()),Ut(),he(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),v(u("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function zn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(Et()){t.preventDefault(),v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}yr()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(Et()){t.preventDefault(),v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(qr(r),Bn(Gt()),Ut(),he(),v(u("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function vr(e){const{index:n,items:t}=ve(),{groups:a}=zt({items:t}),r=a.find(c=>c.key===e);if(!r||r.items.some(c=>c?.type==="package"))return;let s=-1;for(let c=t.length-1;c>=0;c-=1){const d=t[c];if(Oe(d)===e&&d?.type!=="package"){s=c;break}}if(s<0)return;const i=t.filter((c,d)=>d!==s);_e(n,i),Ce(i),he()}function hr(e){const{index:n,items:t}=ve(),{groups:a}=zt({items:t}),r=a.find(c=>c.key===e);if(!r)return;let s=t.filter(c=>Oe(c)!==e);if(r.items.some(c=>c&&c.type==="package")){const c=we(r.packageId??r.items.find(p=>p?.type==="package")?.packageId??""),d=K(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(p=>{if(!p||typeof p!="object"||p.type!=="package")return!0;const g=we(p.packageId??p.package_id??p.id??""),m=K(p.barcode??p.package_code??"");return!(c&&g===c||d&&m&&m===d)});const o=new Set,l=new Set;r.items.forEach(p=>{(Array.isArray(p?.packageItems)?p.packageItems:[]).forEach(m=>{const f=K(m?.barcode||m?.normalizedBarcode||"");f&&o.add(f);const y=m?.equipmentId??m?.equipment_id??null;y!=null&&l.add(String(y))})}),(o.size||l.size)&&(s=s.filter(p=>{const g=K(p?.barcode||""),m=p?.equipmentId??p?.id??null;return!(g&&o.has(g)||m!=null&&l.has(String(m)))}))}s.length!==t.length&&(_e(n,s),Ce(s),he())}function br(e){const{index:n,items:t}=ve(),{groups:a}=zt({items:t}),r=a.find(b=>b.key===e);if(!r||r.items.some(b=>b?.type==="package"))return;const{start:s,end:i}=it();if(!s||!i){v(u("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:c=[]}=ie(),d=n!=null&&c[n]||null,o=d?.id??d?.reservationId??null,l=new Set(t.map(b=>K(b.barcode))),{equipment:p=[]}=ie(),g=(p||[]).find(b=>{const B=K(b?.barcode);return!B||l.has(B)||Oe({desc:b?.desc||b?.description||b?.name||"",price:Number(b?.price)||0})!==e||!Gn(b)?!1:!Te(B,s,i,o)});if(!g){v(u("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=K(g.barcode),f=rt(g);if(!f){v(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=[...t,{id:f,equipmentId:f,barcode:m,desc:g.desc||g.description||g.name||r.description||"",qty:1,price:Number.isFinite(Number(g.price))?Number(g.price):r.unitPrice,cost:Ze(g),image:lt(g)}];_e(n,y),Ce(y),he()}function Ir(e,n,t=null){const a=Ne(n),r=Number.isFinite(a)&&a>=0?xe(a):0,{index:s,items:i}=ve();if(!Array.isArray(i))return;const d=st(i).find(p=>p.key===e);if(!d)return;const o=Number.isInteger(t)?[t]:Array.isArray(d.itemIndices)?d.itemIndices:[];if(!o.length)return;const l=[...i];o.forEach(p=>{if(l[p]){const g={...l[p],cost:r,unit_cost:r,rental_cost:r,purchase_price:r,internal_cost:r,equipment_cost:r};l[p]=g}}),_e(s,l),Ce(l),he()}function Er(e,n){const t=Ne(n),a=Number.isFinite(t)&&t>=0?xe(t):0,{index:r,items:s}=ve();if(!Array.isArray(s))return;const c=st(s).find(o=>o.key===e);if(!c||!Array.isArray(c.itemIndices))return;const d=[...s];c.itemIndices.forEach(o=>{d[o]&&(d[o]={...d[o],price:a,unit_price:a})}),_e(r,d),Ce(d),he()}function Vn(e){if(!e||e.dataset.groupListenerAttached)return;e.addEventListener("click",a=>{const r=a.target.closest("button[data-action]");if(!r)return;const{action:s,groupKey:i,itemIndex:c}=r.dataset;if(s==="decrease-edit-group"&&i){vr(i);return}if(s==="increase-edit-group"&&i){br(i);return}if(s==="remove-edit-group"&&i){hr(i);return}if(s==="remove-edit-item"){const d=Number(c);Number.isNaN(d)||wr(d)}});const n=a=>{const r=a.target.closest(".reservation-unit-cost-input");if(!r)return;const s=r.dataset.groupKey;if(!s)return;const i=r.dataset.packageIndex??"",c=i!==""?Number.parseInt(i,10):null;Ir(s,r.value,Number.isInteger(c)?c:null)},t=a=>{const r=a.target.closest(".reservation-unit-price-input");if(!r)return;const s=r.dataset.groupKey;s&&Er(s,r.value)};e.addEventListener("change",n),e.addEventListener("input",n),e.addEventListener("change",t),e.addEventListener("input",t),e.dataset.groupListenerAttached="true"}function Et(){return!!document.getElementById("edit-res-project")?.value}function Sr(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{Et()&&(v(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function kr(e){const n=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),c=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,c,d].forEach(Sr),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const o=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(o)try{const g=(ie()?.projects||[]).find(f=>String(f.id)===String(o)),m=typeof g?.paymentStatus=="string"?g.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(l=m)}catch{}r.value=l,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),c&&(c.disabled=!0,c.classList.add("reservation-input-disabled"),c.title=n),d&&(d.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),c&&(c.disabled=!1,c.classList.remove("reservation-input-disabled"),c.title=""),d&&(d.dataset.linkedDisabled="false")}function he(){const e=document.getElementById("edit-res-summary");if(!e)return;Ut();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),be(a),he()}),a.dataset.listenerAttached="true");const r=E(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",c=Et();kr(c);const d=document.getElementById("edit-res-tax"),o=c?!1:d?.checked||!1,l=!c&&a?.dataset?.userSelected==="true";let p="unpaid";if(c){const T=document.getElementById("edit-res-project")?.value||"";if(T)try{const h=(ie()?.projects||[]).find(P=>String(P.id)===String(T)),w=typeof h?.paymentStatus=="string"?h.paymentStatus.toLowerCase():null;w&&["paid","partial","unpaid"].includes(w)&&(p=w)}catch{}}else p=l&&a?.value||"unpaid";let g=null;!c&&o&&(Be("edit-res-company-share"),g=at("edit-res-company-share"),(!Number.isFinite(g)||g<=0)&&(Be("edit-res-company-share"),g=at("edit-res-company-share")));const{items:m=[],payments:f=[]}=ve(),{start:y,end:b}=it(),B=tn({items:m,discount:s,discountType:i,applyTax:o,paidStatus:p,start:y,end:b,companySharePercent:g,paymentHistory:f});e.innerHTML=B;const I=tn.lastResult;if(I&&a){const T=I.paymentStatus;l?be(a,a.value):(a.value!==T&&(a.value=T),a.dataset&&delete a.dataset.userSelected,be(a,T))}else a&&be(a,a.value)}function wr(e){if(e==null)return;const{index:n,items:t}=ve();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);_e(n,a),Ce(a),he()}async function Ar(e){const n=e?.value??"",t=K(n)||E(String(n)).trim().toLowerCase();if(!t)return;const a=pn(t);if(!a){v(u("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=He(a);if(r==="maintenance"||r==="retired"){v(nt(r));return}const s=K(t),{index:i,items:c=[]}=ve();if(c.findIndex(B=>K(B.barcode)===s)>-1){v(u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:o,end:l}=it();if(!o||!l){v(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:p=[]}=ie(),g=i!=null&&p[i]||null,m=g?.id??g?.reservationId??null;if(Te(s,o,l,m)){v(u("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const f=rt(a);if(!f){v(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=typeof Ze=="function"?Ze(a):Number.isFinite(Number(a?.cost))?Number(a.cost):0,b=[...c,{id:f,equipmentId:f,barcode:s,desc:a.desc,qty:1,price:a.price,cost:y,image:a.image||a.imageUrl||a.img||null}];_e(i,b),e&&(e.value=""),Ce(b),he()}async function Mt(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=wa(n),a=K(t?.barcode||n)||E(String(t?.barcode||n)).trim().toLowerCase();if(!t||!a){v(u("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=He(t);if(r==="maintenance"||r==="retired"){v(nt(r));return}const{start:s,end:i}=it();if(!s||!i){v(u("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:c,items:d=[]}=ve();if(d.some(b=>K(b.barcode)===a)){v(u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:l=[]}=ie(),p=c!=null&&l[c]||null,g=p?.id??p?.reservationId??null;if(Te(a,s,i,g)){v(u("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const m=rt(t);if(!m){v(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const f=typeof Ze=="function"?Ze(t):Number.isFinite(Number(t?.cost))?Number(t.cost):0,y=[...d,{id:m,equipmentId:m,barcode:a,desc:t.desc,qty:1,price:t.price,cost:f,image:t.image||t.imageUrl||t.img||null}];_e(c,y),Ce(y),he(),e.value=""}function Ta(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Mt(e))});const n=()=>{Aa(e.value,"edit-res-equipment-description-options")&&Mt(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{he()});const e=()=>{fr()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Ct()})}typeof window<"u"&&(window.getEditReservationDateRange=it,window.renderEditPaymentHistory=Ut);function Br(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){cn(e);return}Mt(e)}}function ei(){Ke(),Ta()}function Pr(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let ct=null,Ee=[],Le=[],ln=null,de={},Yt=!1,Hn=!1;function Lr(){if(!Hn)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{Va(de).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Hn=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Cr="__DEBUG_CREW__";function _r(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Cr);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function On(e,n){if(_r())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function ht(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=u("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),c=u("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=s?i:c,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function yt(){return document.getElementById("edit-res-confirmed")?.value==="true"}function ve(){return{index:ct,items:Ee,payments:Le}}function _e(e,n,t=Le){ct=typeof e=="number"?e:null,Ee=Array.isArray(n)?[...n]:[],Le=Array.isArray(t)?[...t]:[]}function Ra(){ct=null,Ee=[],ms(),Le=[]}function Gt(){return[...Le]}function Bn(e){Le=Array.isArray(e)?[...e]:[]}function $r(e){e&&(Le=[...Le,e])}function qr(e){!Number.isInteger(e)||e<0||(Le=Le.filter((n,t)=>t!==e))}function _t(e,n=1){const t=Number.parseFloat(E(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function bt(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(E(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function Nr(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?K(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:_t(e.qty??e.quantity??e.count??1),price:bt(e.price??e.unit_price??e.unitPrice??0),cost:bt(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.purchase_price??0),image:e.image??e.image_url??e.imageUrl??null}}function xr(e,n=0){if(!e||typeof e!="object")return null;const t=we(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:vn(e)).map(m=>Nr(m)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let c=bt(e.unit_price??e.unitPrice??e.price??null,0);if((!c||c===0)&&i!=null){const m=bt(i,0);m>0&&a>0&&(c=Number((m/a).toFixed(2)))}let d=bt(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??null,0);(!d||d===0)&&s.length&&(d=0);const o=e.package_code??e.packageCode??e.barcode??null,p=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,o,t].find(m=>m!=null&&String(m).trim()!=="")||`Package ${t}`,g=e.image??e.cover??e.thumbnail??s.find(m=>m?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:E(String(p)),name:E(String(p)),qty:a,price:c,cost:d,unit_cost:d,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,barcode:o,packageItems:s,image:g}}function jr(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function Tr(e={},n=[]){const t=Array.isArray(n)?n.map(o=>({...o})):[],a=new Map;Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(o=>{if(!o||typeof o!="object")return;const l=we(o.packageId??o.package_id??o.package_code??o.packageCode??o.code??o.id??"");l&&a.set(l,o)});const s=(Array.isArray(e?.packages)?e.packages:[]).map(o=>{const l=we(o.packageId??o.package_id??o.package_code??o.packageCode??o.code??o.id??"");if(!l||!a.has(l))return o;const p=Ne(o.unit_cost??o.unitCost??o.cost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);if(Number.isFinite(p)&&p>0)return o;const g=a.get(l),m=Ne(g.unit_cost??g.unitCost??g.cost??g.package_cost??g.rental_cost??g.purchase_price??g.internal_cost??g.equipment_cost??g.item_cost);if(!Number.isFinite(m)||m<=0)return o;const f=xe(m);return{...o,unit_cost:f,unitCost:f,cost:f,rental_cost:o.rental_cost??f,purchase_price:o.purchase_price??f,internal_cost:o.internal_cost??f,equipment_cost:o.equipment_cost??f,item_cost:o.item_cost??f}});if(!s.length)return t;const i=s.map((o,l)=>xr(o,l)).filter(Boolean);if(!i.length)return t;const c=new Map;i.forEach(o=>{const l=_t(o.qty??o.quantity??1);if(o.barcode){const p=K(o.barcode);if(p){const g=`package::${p}`;c.set(g,(c.get(g)??0)+l)}}(o.packageItems||[]).forEach(p=>{if(!p)return;const g=l*_t(p.qty??p.quantity??1),m=p.equipmentId??null,f=p.normalizedBarcode||(p.barcode?K(p.barcode):null);if(m!=null){const y=`equipment::${String(m)}`;c.set(y,(c.get(y)??0)+g)}if(f){const y=`barcode::${f}`;c.set(y,(c.get(y)??0)+g)}})});const d=[];return t.forEach(o=>{if(!o||typeof o!="object"){d.push(o);return}if(o.type==="package"){const I=we(o.packageId??o.package_id??o.id??"");i.some(A=>A.packageId===I)||d.push({...o});return}const l=_t(o.qty??o.quantity??1),p=rt(o),g=o.barcode?K(o.barcode):null,m=[];p!=null&&m.push(`equipment::${String(p)}`),g&&m.push(`barcode::${g}`);const f=m.map(I=>c.get(I)??0).filter(I=>I>0);if(!f.length){d.push({...o});return}const y=Math.min(...f);if(y<=0){d.push({...o});return}const b=Math.min(y,l);if(jr(c,m,b),b>=l)return;const B=l-b;d.push({...o,qty:B,quantity:B})}),[...d,...i.map(o=>({...o}))]}function Rr(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Da(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function Fa(e){if(!e)return null;const n=E(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function Dr(e,n){if(e){e.value="";return}}function gt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ma(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(E(String(e.value??""))),a=Number.parseFloat(E(String(e.amount??""))),r=Number.parseFloat(E(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,c=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),d=c==="amount"?s??null:c==="percent"?i??null:Number.isFinite(t)?t:null,o=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:c,value:d,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:o}}function Fr(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=u("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=u("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((d,o)=>String(o.createdAt||o.start||"").localeCompare(String(d.createdAt||d.start||""))):[],c=[`<option value="">${gt(a)}</option>`];i.forEach(d=>{c.push(`<option value="${gt(d.id)}">${gt(d.title||a)}</option>`)}),s&&!i.some(d=>String(d.id)===s)&&c.push(`<option value="${gt(s)}">${gt(r)}</option>`),t.innerHTML=c.join(""),s?t.value=s:t.value=""}function za(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const d=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",d&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}un("tax");const c=de?.updateEditReservationSummary;typeof c=="function"&&c()}function un(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=de?.updateEditReservationSummary;typeof s=="function"&&s()};if(Yt){a();return}Yt=!0;const r=()=>{Yt=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(et)),n.disabled){t.checked=!1,v(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),Be("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Be("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function Un(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:c,projects:d}=ie();let l=Zn()?.[e];if(!l){v(u("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}if(Yn(l))try{const C=await Xn(l.id||l.reservationId||l.reservation_code);C&&(l=C)}catch(C){console.warn("[reservationsEdit] Failed to hydrate reservation packages",C)}de={...de,reservation:l,projects:d||[]},n?.(),Fr(d||[],l);const p=l.projectId&&d?.find?.(C=>String(C.id)===String(l.projectId))||null,{effectiveConfirmed:g,projectLinked:m}=St(l,p),f=l.items?l.items.map(C=>({...C,equipmentId:C.equipmentId??C.equipment_id??C.id,barcode:K(C?.barcode)})):[],y=Tr(l,f),B=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map(C=>Ma(C)).filter(Boolean);_e(e,y,B);const I=u("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),T=c?.find?.(C=>String(C.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const A=document.getElementById("edit-res-id");A&&(A.value=l.reservationId||l.id);const h=document.getElementById("edit-res-customer");h&&(h.value=T?.customerName||I);const w=typeof a=="function"?a(l.start):{date:"",time:""},P=typeof a=="function"?a(l.end):{date:"",time:""};t?.("edit-res-start",w.date),t?.("edit-res-start-time",w.time),t?.("edit-res-end",P.date),t?.("edit-res-end-time",P.time);const N=document.getElementById("edit-res-notes");N&&(N.value=l.notes||"");const _=document.getElementById("edit-res-discount");if(_){const C=m?0:l.discount??0;_.value=E(C)}const W=document.getElementById("edit-res-discount-type");W&&(W.value=m?"percent":l.discountType||"percent");const R=l.projectId?!1:!!l.applyTax,q=document.getElementById("edit-res-tax");q&&(q.checked=R);const Z=document.getElementById("edit-res-company-share");if(Z){const C=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,ae=C!=null?Number.parseFloat(E(String(C).replace("%","").trim())):NaN,me=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,X=me!=null?me===!0||me===1||me==="1"||String(me).toLowerCase()==="true":Number.isFinite(ae)&&ae>0,Je=X&&Number.isFinite(ae)&&ae>0?ae:et,$e=R||X;Z.checked=$e,Z.dataset.companyShare=String(Je)}ht(g,{disable:m});const G=document.getElementById("edit-res-close-btn"),z=document.getElementById("edit-res-reopen-btn");G&&(G.disabled=!(g&&!m)||String(l.status||"").toLowerCase()==="completed"),z&&(z.disabled=String(l.status||"").toLowerCase()!=="completed");const V=document.getElementById("edit-res-paid"),oe=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");V&&(V.value=oe,V.dataset&&delete V.dataset.userSelected);const Q=document.getElementById("edit-res-payment-progress-type"),x=document.getElementById("edit-res-payment-progress-value");Q?.dataset?.userSelected&&delete Q.dataset.userSelected,Q&&(Q.value="percent"),Dr(x);const D=document.getElementById("edit-res-cancelled");if(D){const C=String(l?.status||l?.reservationStatus||"").toLowerCase();D.checked=["cancelled","canceled"].includes(C),D.checked&&ht(g,{disable:!0})}let Y=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map(C=>String(C));if(!Array.isArray(Y)||Y.length===0){const C=os(l.id??l.reservationId??l.reservation_code??null);Array.isArray(C)&&C.length&&(Y=C)}try{await oa()}catch(C){console.warn("[reservationsEdit] positions load failed (non-fatal)",C)}if(cs(Y),r?.(y),typeof window<"u"){const C=window?.renderEditPaymentHistory;typeof C=="function"&&C()}za(),s?.();const H=document.getElementById("editReservationModal");ln=Rr(H,i),ln?.show?.();try{Mr?.(de)}catch(C){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",C)}Lr()}async function Va({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:c}={}){if(ct===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),o=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",g=document.getElementById("edit-res-notes")?.value||"",m=E(document.getElementById("edit-res-discount")?.value||"0");let f=parseFloat(m)||0,y=document.getElementById("edit-res-discount-type")?.value||"percent";const b=yt(),B=document.getElementById("edit-res-paid"),I=B?.dataset?.userSelected==="true",T=I&&B?.value||"unpaid",A=document.getElementById("edit-res-payment-progress-type"),h=document.getElementById("edit-res-payment-progress-value"),w=Da(A),P=Fa(h),N=document.getElementById("edit-res-project")?.value||"",W=document.getElementById("edit-res-cancelled")?.checked===!0,R=ds();R.map(S=>S?.technicianId).filter(Boolean);const q=document.getElementById("edit-res-company-share"),Z=document.getElementById("edit-res-tax");if(!d||!l){v(u("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const G=typeof e=="function"?e:(S,$)=>`${S}T${$||"00:00"}`,z=G(d,o),V=G(l,p);if(z&&V&&new Date(z)>new Date(V)){v(u("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const Q=Zn()?.[ct];if(!Q){v(u("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(Ee)||Ee.length===0&&R.length===0){v(u("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const x=typeof n=="function"?n:()=>!1,D=Q.id??Q.reservationId;for(const S of Ee){if(S?.type==="package"&&Array.isArray(S.packageItems)){for(const k of S.packageItems){const j=k?.barcode??k?.normalizedBarcode??"";if(!j)continue;const ee=He(j);if(ee!=="reserved"&&ee!=="available"){v(nt(ee));return}}continue}const $=He(S.barcode);if($!=="reserved"&&$!=="available"){v(nt($));return}}{const S=typeof t=="function"?t:()=>!1;for(const $ of Ee){if($?.type!=="package")continue;const k=$.packageId??$.package_id??null,j=$.desc||$.packageName||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(k&&S(k,z,V,D)){const ee=Array.isArray($?.packageItems)?$.packageItems.map(U=>K(U?.barcode??U?.normalizedBarcode??"")).filter(Boolean):[];let F=_n(ee,z,V,D);if(!F.length)try{const U=new URLSearchParams;U.set("type","package"),U.set("id",String(k)),U.set("start",z),U.set("end",V),D!=null&&U.set("ignore",String(D));const ne=await Me(`/reservations/availability.php?${U.toString()}`),Pe=Array.isArray(ne?.conflicts)?ne.conflicts:[];F=Array.from(new Set(Pe.map(re=>re?.reservation_code||(re?.reservation_id!=null?`#${re.reservation_id}`:null)).filter(Boolean)))}catch{}const M=F.length?` (${F.join("ØŒ ")})`:"";v(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(j))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+M,"warning",-1);return}if(Array.isArray($?.packageItems)&&$.packageItems.length){const ee=($.packageItems||[]).map(U=>K(U?.barcode??U?.normalizedBarcode??"")).filter(Boolean),F=ee.length,M=ee.filter(U=>x(U,z,V,D)).length;if(F>0&&M>=F){const U=($.packageItems||[]).map(re=>K(re?.barcode??re?.normalizedBarcode??"")).filter(Boolean);let ne=_n(U,z,V,D);if(!ne.length)try{const re=new URLSearchParams;re.set("type","package"),k!=null&&re.set("id",String(k)),re.set("start",z),re.set("end",V),D!=null&&re.set("ignore",String(D));const Pn=await Me(`/reservations/availability.php?${re.toString()}`),Qa=Array.isArray(Pn?.conflicts)?Pn.conflicts:[];ne=Array.from(new Set(Qa.map(Jt=>Jt?.reservation_code||(Jt?.reservation_id!=null?`#${Jt.reservation_id}`:null)).filter(Boolean)))}catch{}const Pe=ne.length?` (${ne.join("ØŒ ")})`:"";v(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(j))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+Pe,"warning",6e3);return}}}}const Y=[];for(const S of Ee){if(S?.type==="package"&&Array.isArray(S.packageItems)){for(const k of S.packageItems){const j=K(k?.barcode??k?.normalizedBarcode??"");if(j&&x(j,z,V,D)){const ee=k?.desc||k?.barcode||u("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");Y.push({label:E(String(ee)),barcode:j})}}continue}const $=K(S.barcode);if(x($,z,V,D)){const k=S?.desc||S?.name||S?.barcode||u("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");Y.push({label:E(String(k)),barcode:$})}}if(Y.length){const S=u("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let $=null;try{const j=Array.from(new Set(Y.map(F=>F.barcode).filter(Boolean))),ee=new Map;await Promise.all(j.map(async F=>{const M=new URLSearchParams;M.set("type","equipment"),M.set("id",F),M.set("start",z),M.set("end",V),D!=null&&M.set("ignore",String(D));const U=await Me(`/reservations/availability.php?${M.toString()}`),ne=Array.isArray(U?.conflicts)?U.conflicts:[],Pe=Array.from(new Set(ne.map(re=>re?.reservation_code||(re?.reservation_id!=null?`#${re.reservation_id}`:null)).filter(Boolean)));ee.set(F,Pe)})),$=Y.map(({label:F,barcode:M})=>{const U=ee.get(M)||[];return U.length?`${F} (${U.join("ØŒ ")})`:F}).join("ØŒ ")}catch{}const k=$||Y.map(j=>j.label).filter(Boolean).map(String).join("ØŒ ");v(`${S}: ${k}`,"warning",6e3);return}const H=typeof t=="function"?t:()=>!1;for(const S of Ee){if(S?.type!=="package")continue;const $=S.packageId??S.package_id??null;if($&&H($,z,V,D)){const k=S.desc||S.packageName||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const j=new URLSearchParams;j.set("type","package"),j.set("id",String($)),j.set("start",z),j.set("end",V),D!=null&&j.set("ignore",String(D));const ee=await Me(`/reservations/availability.php?${j.toString()}`),F=Array.isArray(ee?.conflicts)?ee.conflicts:[],M=Array.from(new Set(F.map(ne=>ne?.reservation_code||(ne?.reservation_id!=null?`#${ne.reservation_id}`:null)).filter(Boolean))),U=M.length?` (${M.join("ØŒ ")})`:"";v(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(k))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+U,"warning",6e3)}catch{v(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(k))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const C=typeof a=="function"?a:()=>!1,ae=[];for(const S of R){if(!S?.technicianId||!C(S.technicianId,z,V,D))continue;const $=S?.technicianName||S?.positionLabel||String(S.technicianId);let k=[];try{k=sa(S.technicianId,z,V,D)}catch{}ae.push({label:E(String($)),codes:k})}if(ae.length){const S=u("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),$=ae.map(({label:k,codes:j})=>j&&j.length?`${k} (${j.join("ØŒ ")})`:k).join("ØŒ ");v(`${S}: ${$}`,"warning",6e3);return}const me=Array.isArray(de.projects)&&de.projects.length?de.projects:ie().projects||[],X=N&&me.find(S=>String(S.id)===String(N))||null,Je={...Q,projectId:N?String(N):null,confirmed:b},{effectiveConfirmed:$e,projectLinked:ge,projectStatus:ut}=St(Je,X);let pe=!!q?.checked,L=!!Z?.checked;if(ge&&(pe&&(q.checked=!1,pe=!1),L=!1),!ge&&pe!==L){v(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}L&&(Be("edit-res-company-share"),pe=!!q?.checked);let O=pe?getCompanySharePercent("edit-res-company-share"):null;pe&&(!Number.isFinite(O)||O<=0)&&(Be("edit-res-company-share"),O=getCompanySharePercent("edit-res-company-share"));const ce=pe&&L&&Number.isFinite(O)&&O>0,te=ge?!1:L;ge&&(f=0,y="percent");const ye=Kn(Ee,f,y,te,R,{start:z,end:V,companySharePercent:ce?O:0});let se=Gt();if(Number.isFinite(P)&&P>0){const S=ye;let $=null,k=null;w==="amount"?($=P,S>0&&(k=P/S*100)):(k=P,S>0&&($=P/100*S));const j=Ma({type:w,value:P,amount:$,percentage:k,recordedAt:new Date().toISOString()});j&&(se=[...se,j],Bn(se)),h&&(h.value="")}const le=qt({totalAmount:ye,history:se}),fe=new Map,qe=new Map,Qe=new Map,Bt=document.getElementById("editReservationModal")||document,mt=S=>{const $=we(S.packageId??S.package_id??S.package_code??S.packageCode??S.barcode??S.id??null);if($)return $;const k=S.package_code??S.packageCode??S.barcode??null;return k?E(String(k)).trim().toLowerCase():null};Bt.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(S=>{const $=Ne(S.value),k=Number.isFinite($)&&$>=0?xe($):null;if(k===null)return;const j=S.dataset.packageIndex;if(j!==void 0&&j!==""){const M=Number.parseInt(j,10);if(Number.isInteger(M)&&M>=0){qe.set(M,k);const U=Ee[M];if(U){const ne=mt(U);ne&&Qe.set(ne,k)}}}const ee=S.dataset.packageIdentity;if(ee){const M=we(ee)||E(String(ee)).trim().toLowerCase();M&&Qe.set(M,k)}const F=S.dataset.groupKey;F&&fe.set(F,k)});const pt=Ee.map((S,$)=>{let k=qe.has($)?qe.get($):void 0;if(k===void 0){const j=Oe(S);j&&(k=fe.get(j))}return k===void 0?S:{...S,cost:k,unit_cost:k,rental_cost:k,purchase_price:k,internal_cost:k,equipment_cost:k}}),De=Nt({manualStatus:T,paidAmount:le.paidAmount,paidPercent:le.paidPercent,totalAmount:ye});B&&!I&&(B.value=De,B.dataset&&delete B.dataset.userSelected);let Fe=Q.status??"pending";ge?Fe=X?.status??ut??Fe:W?Fe="cancelled":["completed","cancelled"].includes(String(Fe).toLowerCase())||(Fe=b?"confirmed":"pending");const Wt=(()=>{const S=[];pt.forEach((k,j)=>{if(String(k?.type||"").toLowerCase()!=="package")return;const ee=Number.isFinite(Number(k.qty??k.quantity))?Number(k.qty??k.quantity):1,F=Number.isFinite(Number(k.unit_price??k.price))?Number(k.unit_price??k.price):0;let M=Number.isFinite(Number(k.unit_cost??k.cost))?Number(k.unit_cost??k.cost):0;const U=Oe(k),ne=mt(k),Pe=(qe.has(j)?qe.get(j):void 0)??(ne?Qe.get(ne):void 0)??(U!==void 0?fe.get(U):void 0);Pe!==void 0&&Number.isFinite(Pe)&&(M=xe(Pe));const re=Pe!==void 0?2:Number.isFinite(M)&&M>0?1:0;S.push({__dedupeKey:ne??`pkg-${j}`,__priority:re,package_code:k.package_code??k.packageCode??k.barcode??k.code??null,name:k.name??k.desc??k.package_name??null,quantity:ee,unit_price:F,unit_cost:M,package_cost:M,packageCost:M,cost:M,items:Array.isArray(k.packageItems)?k.packageItems:[]})});const $=new Map;return S.forEach(k=>{const j=k.__dedupeKey;(!$.has(j)||(k.__priority??0)>=($.get(j).__priority??0))&&$.set(j,k)}),Array.from($.values()).map(k=>{const{__dedupeKey:j,__priority:ee,...F}=k;return F})})(),ft=Wn({reservationCode:Q.reservationCode??Q.reservationId??null,customerId:Q.customerId,start:z,end:V,status:Fe,title:Q.title??null,location:Q.location??null,notes:g,projectId:N?String(N):null,totalAmount:ye,discount:f,discountType:y,applyTax:te,paidStatus:De,confirmed:$e,items:pt.map(S=>({...S,equipmentId:S.equipmentId??S.id})),crewAssignments:R,companySharePercent:ce?O:null,companyShareEnabled:ce,paidAmount:le.paidAmount,paidPercentage:le.paidPercent,paymentProgressType:le.paymentProgressType,paymentProgressValue:le.paymentProgressValue,paymentHistory:se,packages:Wt});try{On("about to submit",{editingIndex:ct,crewAssignments:R,techniciansPayload:ft?.technicians,payload:ft});const S=await ls(Q.id||Q.reservationId,ft);On("server response",{reservation:S?.id??S?.reservationId??S?.reservation_code,technicians:S?.technicians,crewAssignments:S?.crewAssignments,techniciansDetails:S?.techniciansDetails}),await us(),hn(),It(),ws(),v(u("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),Ra(),c?.({type:"updated",reservation:S}),s?.(),i?.(),ln?.hide?.()}catch(S){console.error("âŒ [reservationsEdit] Failed to update reservation",S);const $=Jn(S)?S.message:u("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");v($,"error")}}function Mr(e={}){de={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=de,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=E(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const c=document.getElementById("edit-res-tax");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{un("tax")}),c.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{un("share")}),d.dataset.listenerAttached="true");const o=document.getElementById("edit-res-payment-progress-type");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{o.dataset.userSelected="true",n?.()}),o.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=E(l.value)}),l.dataset.listenerAttached="true");const p=["edit-res-start","edit-res-end"],g=["edit-res-start-time","edit-res-end-time"],m=w=>{const P=document.getElementById(w);if(!P||P.dataset.editDateListenerAttached==="true")return;const N=()=>{try{n?.()}catch{}try{const _=typeof ve=="function"?ve().items:[];r?.(_)}catch{}};P.addEventListener("input",N),P.addEventListener("change",N),P.dataset.editDateListenerAttached="true"};p.forEach(m),g.forEach(m),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const f=document.getElementById("edit-res-project");f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>{za();const w=Array.isArray(de.projects)&&de.projects.length?de.projects:ie().projects||[],P=f.value&&w.find(q=>String(q.id)===String(f.value))||null,_={...de?.reservation??{},projectId:f.value||null,confirmed:yt()},{effectiveConfirmed:W,projectLinked:R}=St(_,P);ht(W,{disable:R}),n?.()}),f.dataset.listenerAttached="true");const y=document.getElementById("edit-res-confirmed-btn");y&&!y.dataset.listenerAttached&&(y.addEventListener("click",()=>{if(y.disabled)return;const w=!yt();ht(w);const P=document.getElementById("edit-res-close-btn");P&&(P.disabled=!w),n?.()}),y.dataset.listenerAttached="true");const b=document.getElementById("edit-res-cancelled");b&&!b.dataset.listenerAttached&&(b.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&ht(yt(),{disable:b.checked});const P=document.getElementById("edit-res-close-btn");P&&(P.disabled=b.checked||!yt()),n?.()}),b.dataset.listenerAttached="true");const B=document.getElementById("save-reservation-changes");B&&!B.dataset.listenerAttached&&(B.addEventListener("click",()=>{Va(de).catch(w=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",w)})}),B.dataset.listenerAttached="true");const I=document.getElementById("edit-res-close-btn");I&&!I.dataset.listenerAttached&&(I.addEventListener("click",()=>{try{const{index:w}=ve(),P=document.getElementById("closeReservationModal"),N=document.getElementById("close-reservation-notes"),_=document.getElementById("close-reservation-submit"),W=document.getElementById("edit-res-notes")?.value||"";if(N&&(N.value=W),_&&_.__tmpCloseListener&&(_.removeEventListener("click",_.__tmpCloseListener),_.__tmpCloseListener=null),_){const R=async()=>{const q=N?.value||"";try{await da(w,q,{onAfterChange:de?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(P)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(P))?.hide?.()}catch{}}};_.__tmpCloseListener=R,_.addEventListener("click",R,{once:!0})}P&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(P).show()}catch(w){console.warn("[reservationsEdit] failed to open close modal",w)}}),I.dataset.listenerAttached="true");const T=document.getElementById("edit-res-reopen-btn");T&&!T.dataset.listenerAttached&&(T.addEventListener("click",async()=>{try{const{index:w}=ve();await la(w,{onAfterChange:de?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{T.disabled=!0}catch{}}catch(w){console.warn("[reservationsEdit] failed to reopen reservation",w)}}),T.dataset.listenerAttached="true");const A=document.getElementById("edit-res-equipment-barcode");if(A&&!A.dataset.listenerAttached){let w=null;const P=()=>{A.value?.trim()&&(clearTimeout(w),w=null,t?.(A))};A.addEventListener("keydown",_=>{_.key==="Enter"&&(_.preventDefault(),P())});const N=()=>{if(clearTimeout(w),!A.value?.trim())return;const{start:_,end:W}=getEditReservationDateRange();!_||!W||(w=setTimeout(()=>{P()},150))};A.addEventListener("input",N),A.addEventListener("change",P),A.dataset.listenerAttached="true"}Ta?.();const h=document.getElementById("editReservationModal");h&&!h.dataset.cleanupAttached&&(h.addEventListener("hidden.bs.modal",()=>{Ra(),n?.(),r?.([])}),h.dataset.cleanupAttached="true")}function ti(){return qs().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=ie()||{};ps(e||[]),ja()})}function At(e=null){ja(),Ha(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function zr(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function mn(){return{populateEquipmentDescriptionLists:Ke,setFlatpickrValue:Pr,splitDateTime:ra,renderEditItems:Ce,updateEditReservationSummary:he,addEquipmentByDescription:Br,addEquipmentToEditingReservation:Ar,addEquipmentToEditingByDescription:Mt,combineDateTime:tt,hasEquipmentConflict:Te,hasTechnicianConflict:aa,renderReservations:Ha,handleReservationsMutation:At,ensureModal:zr}}function Ha(e="reservations-list",n=null){ur({containerId:e,filters:n,onShowDetails:Oa,onConfirmReservation:Ga,onCloseReservation:Vr,onReopenReservation:Ka})}function Oa(e){return mr(e,{getEditContext:mn,onEdit:(n,{reservation:t})=>{Ja(n,t)},onDelete:Ua})}function Ua(e){return Xa()?window.confirm(u("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?_s(e,{onAfterChange:At}):!1:(Za(),!1)}function Ga(e){return $s(e,{onAfterChange:At})}function Ka(e){return la(e,{onAfterChange:At})}let $t=null;function Wa(){const e=document.getElementById("closeReservationModal"),n=document.getElementById("close-reservation-notes"),t=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:n,submit:t,cancel:a}}function Vr(e){$t=e;const{modal:n,note:t}=Wa();t&&(t.value=""),n&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(n).show()}function Hr(){const{modal:e,note:n,submit:t,cancel:a}=Wa();e&&(t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async()=>{const r=n?.value||"";try{await da($t,r,{onAfterChange:At})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}$t=null}}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{$t=null}),a.dataset.listenerAttached="true"))}function Ja(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}Un(e,mn());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}Un(e,mn());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}es({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function ni(){As({showReservationDetails:Oa,deleteReservation:Ua,confirmReservation:Ga,openReservationEditor:Ja,reopenReservation:Ka});try{Hr()}catch{}}export{ei as a,Ha as b,ja as c,J as d,Oa as e,Ua as f,mn as g,At as h,Zr as i,Ga as j,Pr as k,ti as l,Ja as o,ni as r,Mr as s,he as u};
