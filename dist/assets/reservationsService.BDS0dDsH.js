import{t as C,p as le,n as h,j as M,d as ue,b as ze,h as Zt,A as en}from"./auth.BLFzWQsL.js";import{r as kt,i as tn,D as et,s as nn,k as an,P as on,u as $e,E as It,j as sn,O as tt,G as fe,H as _e,b as Pe,I as St,J as cn}from"./state.DZCwr8Fl.js";const rn=()=>C("reservations.create.summary.currency","SR");let Ae=[],X=[],se=[],ce=[],V="create",vt=()=>{},qt=()=>{};const xe=new Map,Ge=450;function ln(e){const n=xe.get(e);return n!=null&&Date.now()-n<Ge}function un(e){xe.set(e,Date.now()),setTimeout(()=>{const n=xe.get(e);n!=null&&Date.now()-n>=Ge&&xe.delete(e)},Ge+50)}function qe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ge(e={}){return{...e,assignmentId:e.assignmentId||qe()}}function Me(e){if(!e)return null;const n=String(e),t=Ae.find(o=>String(o?.id)===n);if(t)return{...t};const{technicians:i=[]}=ue();return i.find(o=>String(o?.id)===n)||null}function Ce(e={},n=le()){return e?n==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function nt(e={},n=le()){return e?n==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function Ft(e,n=""){if(!e)return null;if(typeof e=="object")return e;const t=String(e).trim().toLowerCase();if(!t)return null;const i=X.find(s=>String(s.id).trim().toLowerCase()===t);if(i)return i;const o=sn(e);return o||{id:null,name:n||t,labelAr:n||t,labelEn:n||t,cost:0,clientPrice:0}}function pt(e){const n=Ft(e,e?.name??""),t=le(),i=Ce(n,t)||n?.name||"",o=nt(n,t);return We({assignmentId:qe(),positionId:n?.id??null,positionKey:n?.name??null,positionLabel:i,positionLabelAlt:o,positionCost:Number.isFinite(n?.cost)?Number(n.cost):0,positionClientPrice:Number.isFinite(n?.clientPrice)?Number(n.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function We(e={}){const n={assignmentId:e.assignmentId||qe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},t=Ft(n.positionId??n.positionKey??n.positionLabel,n.positionLabel);if(t){n.positionId=t.id??n.positionId;const i=le(),o=Ce(t,i)||n.positionLabel,s=nt(t,i);n.positionLabel=o||n.positionLabel||t?.name||"",n.positionLabelAlt=s||n.positionLabelAlt||"",(n.positionCost==null||!Number.isFinite(n.positionCost)||n.positionCost===0)&&(n.positionCost=Number.isFinite(t?.cost)?Number(t.cost):n.positionCost),(n.positionClientPrice==null||!Number.isFinite(n.positionClientPrice)||n.positionClientPrice===0)&&(n.positionClientPrice=Number.isFinite(t?.clientPrice)?Number(t.clientPrice):n.positionClientPrice)}if(n.technicianId!=null){const i=Me(n.technicianId);i?(n.technicianId=String(i.id),n.technicianName=i.name??n.technicianName??null,n.technicianRole=i.role??n.technicianRole??null,n.technicianPhone=i.phone??null):(n.technicianId=String(n.technicianId),n.technicianName=n.technicianName??null)}else n.technicianId=null,n.technicianName=null,n.technicianPhone=null;return n.positionCost=Number.isFinite(n.positionCost)?Number(n.positionCost):0,n.positionClientPrice=Number.isFinite(n.positionClientPrice)?Number(n.positionClientPrice):0,n}function ye(){X=tn()}function dn(e=[]){return Array.isArray(e)?e.map(n=>{if(n==null)return null;if(n&&typeof n=="object")return ge(We(n));const t=Me(n),i=t?{assignmentId:qe(),positionLabel:t.role||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(t.dailyWage)?Number(t.dailyWage):0,positionClientPrice:Number.isFinite(t.dailyTotal)?Number(t.dailyTotal):0,technicianId:t.id,technicianName:t.name,technicianRole:t.role}:{assignmentId:qe(),positionLabel:C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:n!=null?String(n):null,technicianName:null};return ge(We(i))}).filter(Boolean):[]}function de(e="create"){return e==="edit"?ce.map(ge):se.map(ge)}function ne(e="create",n=[]){try{ye()}catch{}const t=dn(n);e==="edit"?(ce=t,ke("edit-selected-technicians-list",ce,"edit"),qt()):(se=t,ke("selected-technicians-list",se,"create"),vt()),Fe()}function je(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),r=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=a?$e(a,c):null,m=r?$e(r,u):null;let y=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const _=Number.parseInt(g,10);if(Number.isInteger(_)){const{reservations:N=[]}=ue(),p=N?.[_];p&&(y=p.id??p.reservationId??null)}}return{start:d,end:m,ignoreReservationId:y}}const n=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",o=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=n?$e(n,i):null,l=t?$e(t,o):null;return{start:s,end:l,ignoreReservationId:null}}function Fe(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const n=de(V).length;if(n){const t=C("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",h(String(n)));e.textContent=t}else e.textContent=C("technicians.picker.selectionInfo","No crew selected yet")}function De(e){const n=Number.isFinite(e)?e:0;return`${h(n.toFixed(2))} ${rn()}`}function pn(e){const n=de(V),t=new Set(n.filter(c=>c.assignmentId!==e&&c.technicianId).map(c=>c.technicianId)),i=Ae.length?Ae:ue().technicians||[],{start:o,end:s,ignoreReservationId:l}=je(V),a=!!(o&&s);return i.map(c=>{const u=String(c.id),d=t.has(u),m=a?et(u,o,s,l):!1,y=h(c.name||c.full_name||c.fullName||c.email||u);return{id:u,label:y,disabled:d||m,conflict:m,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const n=de(V);if(!n.length){const t=C("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=C("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${t}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}ye(),e.innerHTML=n.map((t,i)=>{const o=h(String(i+1)),s=De(t.positionClientPrice||0),l=pn(t.assignmentId),a=C("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),r=t.technicianId!=null?String(t.technicianId):"",c=t.technicianName?h(t.technicianName):"",u=`crew-assignment-options-${t.assignmentId}`,d=C("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),m=C("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),y=l.map(b=>{const P=r===b.id,S=b.disabled&&!P?`${b.label} ${b.conflict?m:d}`:b.label;return`
        <option value="${b.label}"
                data-id="${b.id}"
                data-disabled="${b.disabled?"true":"false"}"
                data-conflict="${b.conflict?"true":"false"}"
                data-taken="${b.taken?"true":"false"}"
                label="${S}"></option>
      `}).join("");let g=t.positionLabel??t.position_label??t.position_name??t.role??t.position??"";if(!g||String(g).trim()===""){const b=t.positionId?X.find(I=>String(I.id)===String(t.positionId)):null,P=!b&&t.positionKey?X.find(I=>String(I.name).toLowerCase()===String(t.positionKey).toLowerCase()):null;if(b||P){const I=b||P;g=Ce(I,le())||I?.name||""}}const _=t.positionLabelAlt?`<div class="text-muted small">${h(t.positionLabelAlt)}</div>`:"",N=C("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),p=C("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${t.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${o}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${h(g||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${_}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${s}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${t.assignmentId}"
              placeholder="${a}"
              value="${r?c:""}"
              aria-label="${C("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${y}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${t.assignmentId}" aria-label="${N}">
            ${N}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Lt(t.dataset.assignmentId,V)}),t.dataset.listenerAttached="true")}),mn(e)}function mn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(t=>{if(t.dataset.listenerAttached)return;const i=t.dataset.assignmentId,o=()=>{fn(t,i)};t.addEventListener("change",o),t.addEventListener("blur",o),t.dataset.listenerAttached="true"})}function fn(e,n){if(!n||ln(n))return;un(n);const t=e.value?.trim()??"";if(!t){we(n,"");return}const i=e.getAttribute("list"),o=i?document.getElementById(i):null,s=o?Array.from(o.options):[],l=h(t).toLowerCase(),a=s.find(c=>h(c.value).toLowerCase()===l);if(!a){M(C("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}if(a.dataset.disabled==="true"){if(a.dataset.conflict==="true")try{const{start:c,end:u,ignoreReservationId:d}=je(V),m=a.dataset.id||"",y=c&&u&&m?It(String(m),c,u,d):[],g=C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),_=y&&y.length?`: ${y.join("ØŒ ")}`:"";M(`${g}${_}`,"warning",6e3)}catch{M(C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else M(C("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const r=a.dataset.id;if(!r){M(C("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}we(n,r)}function Re(){const e=document.getElementById("crew-position-list");if(!e)return;ye();const n=document.getElementById("crew-position-search"),t=h(String(n?.value||"")).trim().toLowerCase(),o=de(V).reduce((a,r)=>{const c=r?.positionId!=null?String(r.positionId):null;return c&&a.set(c,(a.get(c)||0)+1),a},new Map),s=X.filter(a=>t?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(c=>h(String(c)).toLowerCase()).join(" ").includes(t):!0);if(!s.length){e.innerHTML=`<div class="text-muted">${C("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const l=le();e.innerHTML=s.map(a=>{const r=Ce(a,l)||a.name||"",c=nt(a,l),u=De(a.clientPrice||0),d=De(a.cost||0),m=c?`<span class="crew-position-card__subtitle">${h(c)}</span>`:"",y=C("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=C("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),_=C("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),N=o.get(String(a.id))||0,p=C("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",h(String(N)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${h(r)}">
        ${N>0?`<span class="crew-position-card__badge" aria-label="${p}">${h(String(N))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${h(r)}</h6>
            ${m}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${y}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${y}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${h(String(a.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${a.clientPrice==null?"":h(String(a.clientPrice))}" inputmode="decimal" placeholder="${h("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${a.id}">${C("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${a.id}">${C("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${a.id}">
            ${_}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${a.id}">
            ${C("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",r=>{r.stopPropagation(),Ke(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{a.dataset.editing!=="true"&&Ke(a.dataset.positionId)}),a.addEventListener("keydown",r=>{if(r.key==="Enter"||r.key===" "){if(r.preventDefault(),a.dataset.editing==="true")return;Ke(a.dataset.positionId)}}),a.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const c=a.closest(".crew-position-card");if(!c)return;const u=c.querySelector(".crew-position-card__metrics"),d=c.querySelector(".crew-position-card__footer"),m=c.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),m&&(m.hidden=!1),c.dataset.editing="true";const y=c.querySelector(".crew-position-edit-cost"),g=c.querySelector(".crew-position-edit-client"),_=N=>{N.addEventListener("input",p=>{const P=h(p.target.value).replace(/[^0-9.]/g,"");if(P!==p.target.value){const I=p.target.selectionEnd||P.length;p.target.value=P,p.target.setSelectionRange(I,I)}},{once:!0})};y&&_(y),g&&_(g)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation();const c=a.closest(".crew-position-card"),u=a.dataset.positionId;if(!(!c||!u))try{const d=c.querySelector(".crew-position-edit-cost"),m=c.querySelector(".crew-position-edit-client"),y=h(d?.value||"").trim(),g=h(m?.value||"").trim(),_=y===""?0:Number.parseFloat(y),N=g===""?null:Number.parseFloat(g);if(!Number.isFinite(_)||_<0){M(C("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(N!=null&&(!Number.isFinite(N)||N<0)){M(C("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),m?.focus();return}ye();const p=X.find(b=>String(b.id)===String(u));if(!p){M(C("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await on(u,{name:p.name,cost:Number(_.toFixed(2)),clientPrice:N==null?null:Number(N.toFixed(2)),labelAr:p.labelAr,labelEn:p.labelEn}),M(C("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),Re(),Y()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const m=d?.message||C("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");M(m,"error")}}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const c=a.closest(".crew-position-card");if(!c)return;const u=c.querySelector(".crew-position-card__metrics"),d=c.querySelector(".crew-position-card__footer"),m=c.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),m&&(m.hidden=!0),delete c.dataset.editing}),a.dataset.listenerAttached="true")})}function Ke(e){ye();const n=X.find(o=>String(o.id)===String(e)),t=pt(n||{id:null,name:""}),i=de(V);i.push(t),ne(V,i),Y(),M(C("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Lt(e,n="create"){if(!e)return;const t=de(n).filter(i=>i.assignmentId!==e);ne(n,t),Y(),M(C("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function we(e,n){if(!e)return;const t=de(V),i=t.find(c=>c.assignmentId===e);if(!i)return;if(!n){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ne(V,t),Y(),M(C("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(t.find(c=>c.assignmentId!==e&&c.technicianId===n)){M(C("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),Y();return}const s=Me(n),{start:l,end:a,ignoreReservationId:r}=je(V);if(l&&a&&et(String(n),l,a,r)){try{const c=It(String(n),l,a,r),u=C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=c&&c.length?`: ${c.join("ØŒ ")}`:"";M(`${u}${d}`,"warning",6e3)}catch{M(C("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}Y();return}s?(i.technicianId=String(s.id),i.technicianName=s.name??null,i.technicianRole=s.role??null,i.technicianPhone=s.phone??null):(i.technicianId=String(n),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ne(V,t),Y(),i.technicianName?M(C("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",h(i.technicianName)),"success"):M(C("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function mt(e="create"){V=e,Y(),Fe();let n=nn();if(!Array.isArray(n)||n.length===0)try{const i=await kt();n=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(n)&&(Ae=n);try{await an()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}ye(),Re(),Y(),Fe();const t=document.getElementById("selectTechniciansModal");t&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(t).show()}function _n(){return de(V).map(ge)}function gn(){const e=_n(),{start:n,end:t,ignoreReservationId:i}=je(V);if(n&&t){const s=e.filter(l=>l.technicianId&&et(l.technicianId,n,t,i));if(s.length>0){const l=s.map(r=>r.technicianName||r.technicianId).join(C("reservations.list.crew.separator","ØŒ ")),a=C("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",l);s.forEach(r=>{r.technicianId=null,r.technicianName=null}),ne(V,e),Y(),M(a),Fe();return}}ne(V,e);const o=document.getElementById("selectTechniciansModal");o&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(o)?.hide?.(),M(C("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function ke(e,n=[],t="create"){const i=document.getElementById(e);if(i){if(!n.length){i.innerHTML=`<span class="text-muted">${C("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}ye(),i.innerHTML=n.map(o=>{let s=o.positionLabel??o.position_label??o.position_name??o.role??o.position??"";if(!s||String(s).trim()===""){const d=o.positionId?X.find(y=>String(y.id)===String(o.positionId)):null,m=!d&&o.positionKey?X.find(y=>String(y.name).toLowerCase()===String(o.positionKey).toLowerCase()):null;s=d?Ce(d,le())||d?.name||"":m&&(Ce(m,le())||m?.name)||""}const l=h(s||C("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=o.technicianName?`${h(o.technicianName)}`:C("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let r=Number(o.positionClientPrice);if(!Number.isFinite(r)||r<=0){const d=[o.position_client_price,o.client_price,o.customer_price,o.daily_total,o.dailyTotal,o.total];for(const m of d){const y=Number(m);if(Number.isFinite(y)&&y>0){r=y;break}}}if((!Number.isFinite(r)||r<=0)&&(o.positionId||o.positionKey)){const d=o.positionId?X.find(g=>String(g.id)===String(o.positionId)):null,m=!d&&o.positionKey?X.find(g=>String(g.name).toLowerCase()===String(o.positionKey).toLowerCase()):null,y=d||m||null;y&&Number.isFinite(Number(y.clientPrice))&&(r=Number(y.clientPrice))}const c=De(Number.isFinite(r)&&r>0?r:0),u=C("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${o.assignmentId}">
        <span class="technician-chip-name">${l}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${c}</small>
        <button type="button" class="technician-chip-remove" data-context="${t}" data-assignment-id="${o.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",()=>{Lt(o.dataset.assignmentId,o.dataset.context)}),o.dataset.listenerAttached="true")})}}function yn(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",l=>{const a=document.getElementById("res-customer")?.value?.trim(),r=document.getElementById("res-start")?.value?.trim(),c=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),m=!!(r&&c),y=!!(u&&d),g=!!a;if(!m||!y){l.preventDefault(),M(C("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){l.preventDefault(),M(C("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}mt("create")}),e.dataset.listenerAttached="true";const s=()=>{const l=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),r=document.getElementById("res-end")?.value?.trim(),c=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(l&&a&&r&&c&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(l=>document.getElementById(l)).filter(Boolean).forEach(l=>{["input","change"].forEach(a=>l.addEventListener(a,s))}),s()}const n=document.getElementById("open-edit-technician-picker");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>mt("edit")),n.dataset.listenerAttached="true");const t=document.getElementById("crew-position-search");t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{Re()}),t.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",gn),i.dataset.listenerAttached="true");const o=document.getElementById("selectTechniciansModal");o&&!o.dataset.listenerAttached&&window.bootstrap?.Modal&&(o.addEventListener("shown.bs.modal",async()=>{if(!Ae.length&&(!ue().technicians||ue().technicians.length===0))try{await kt()}catch(s){console.warn("[crew-picker] fetch on show failed",s)}Re(),Y(),Fe()}),o.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("crew-position-search");s&&(s.value="")}),o.dataset.listenerAttached="true"),ke("selected-technicians-list",se,"create"),ke("edit-selected-technicians-list",ce,"edit")}function mi({onDraftChange:e,onEditChange:n}={}){vt=typeof e=="function"?e:()=>{},qt=typeof n=="function"?n:()=>{},yn()}function bn(){return se.map(ge)}function hn(){return ce.map(ge)}function ft(){return se.map(e=>e.technicianId).filter(Boolean).map(String)}function _t(){return ce.map(e=>e.technicianId).filter(Boolean).map(String)}function fi(e=[]){ne("create",e)}function _i(e=[]){ne("edit",e)}function gi(){ne("create",[])}function yi(){ne("edit",[])}function gt(e=[]){return e.map(n=>{if(n.technicianId){const t=Me(n.technicianId);if(t)return n.technicianId=String(t.id),n.technicianName=t.name??n.technicianName??null,n.technicianRole=t.role??n.technicianRole??null,n.technicianPhone=t.phone??null,n;n.technicianId=null,n.technicianName=null,n.technicianRole=null,n.technicianPhone=null}return n})}function bi(e=[]){Array.isArray(e)&&e.length&&(Ae=e),se=gt(se),ce=gt(ce),ke("selected-technicians-list",se,"create"),ke("edit-selected-technicians-list",ce,"edit"),Y()}function yt(e){const n=e.split(".");if(n.length<=2)return e;const t=n.pop(),i=n.join("");return t?`${i}.${t}`:i}function Et(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let n=h(String(e)).trim();if(!n)return Number.NaN;const t=n.search(/[0-9]/),i=n.indexOf("-"),o=i!==-1&&(t===-1||i<t);if(n=n.replace(/[-+]/g,""),n=n.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),n=n.replace(/[^0-9.,]/g,""),!n)return Number.NaN;const s=n.includes(","),l=n.includes(".");if(s&&l){const r=n.lastIndexOf(","),c=n.lastIndexOf(".");r>c?(n=n.replace(/\./g,""),n=n.replace(/,/g,".")):n=n.replace(/,/g,"")}else if(s){const r=n.split(",");r.length===2&&r[1].length===3?n=r.join(""):n=n.replace(/,/g,".")}else if(l){const r=n.split(".");if(r.length===2){const[,c]=r;if(c.length===3){const u=r.join("");/^[0-9]+$/.test(u)&&(n=u)}}else r.length>2&&(n=yt(n))}if(n=n.replace(/,/g,""),n=yt(n),!/^[0-9]*\.?[0-9]*$/.test(n)||!n||n===".")return Number.NaN;const a=Number.parseFloat(n);return Number.isFinite(a)?o?-a:a:Number.NaN}function D(e){return Et(e)}function $(e){const n=Et(e);if(!Number.isFinite(n))return 0;let t=n,i=0;for(;Math.abs(t)>1e5&&i<8;)t/=10,i+=1;return Number(t.toFixed(2))}function ve(e){return h(String(e??"")).trim().toLowerCase()}function Tt(e=""){return h(String(e)).trim().toLowerCase()}const Nn=2;function Pn(e){const n=D(e);return Number.isFinite(n)?n.toFixed(Nn):"0.00"}function Qe(e={}){const n=[e?.qty,e?.quantity,e?.count,e?.units];for(const t of n){const i=Number.parseFloat(h(String(t??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return $(i)}return 1}function An(e={}){const n=e?.desc||e?.description||e?.name||"",t=Tt(n),i=Pn(e?.price??e?.unitPrice??e?.unit_price??0);return`${t}::${i}`}function Cn(e=[]){const n=new Map;return e.forEach((t,i)=>{const o=An(t);if(!o)return;if(!n.has(o)){const l=t?.desc||t?.description||t?.name||"",a=Tt(l),r=ht(t),c=Nt(t),u=t?.image||t?.imageUrl||t?.img||"";n.set(o,{key:o,description:l,normalizedDescription:a,unitPrice:r,unitCost:c,image:u,items:[],itemIndices:[],barcodes:[]})}const s=n.get(o);s.items.push(t),s.itemIndices.push(i),t?.barcode&&s.barcodes.push(String(t.barcode))}),Array.from(n.values()).map(t=>({...t,quantity:t.items.reduce((i,o)=>i+Qe(o),0)})).map(t=>{const i=t.quantity||0,o=t.items.reduce((g,_)=>{const N=ht(_),p=Qe(_);return g+N*p},0),s=$(o),l=D(t.unitPrice),a=Number.isFinite(l)?l:0,r=t.items.reduce((g,_)=>{const N=Nt(_),p=Qe(_);return g+N*p},0),c=$(r),u=D(t.unitCost),d=Number.isFinite(u)?u:0,m=i>0?$(s/i):$(a),y=i>0?$(c/i):$(d);return{...t,quantity:i,count:i,totalPrice:s,unitPrice:m,totalCost:c,unitCost:y}})}function bt(e={}){return(Pe(e)||[]).map(t=>({...t,normalizedBarcode:t?.normalizedBarcode??ve(t?.barcode),qty:(()=>{const i=Number.parseFloat(h(String(t?.qty??t?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=D(t?.price??t?.unit_price??t?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=D(t?.cost??t?.unit_cost??t?.unitCost??t?.rental_cost??t?.purchase_price);return Number.isFinite(i)?i:0})()}))}function kn(e={},{packageQuantity:n=1}={}){const t=fe(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=t&&_e(t)||e,o=Pe(i)||[],s=Number.isFinite(Number(n))&&Number(n)>0?Number(n):1;return o.map(l=>{const r=D(l?.price??l?.unit_price??l?.unitPrice),c=Number.isFinite(r)?$(r):0,u=D(l?.cost??l?.unit_cost??l?.unitCost??l?.rental_cost??l?.purchase_price),d=Number.isFinite(u)?$(u):0,m=1*s,y=$(c*m),g=$(d*m);return{equipmentId:l?.equipmentId??l?.equipment_id??null,barcode:l?.barcode??l?.normalizedBarcode??"",desc:l?.desc??l?.description??"",qtyPerPackage:1,packageQuantity:s,totalUnits:m,unitPrice:c,perDayTotal:y,unitCost:d,perDayCost:g}})}function In(e={},{packageQuantity:n=1,days:t=1}={}){const i=kn(e,{packageQuantity:n}),o=$(i.reduce((r,c)=>r+(Number(c.perDayTotal)||0),0)),s=$(i.reduce((r,c)=>r+(Number(c.perDayCost)||0),0)),l=$(o*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1)),a=$(s*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1));return{lines:i,perDayTotal:o,total:l,perDayCostTotal:s,costTotal:a}}function Sn(e={}){const n=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,t=Number.parseFloat(h(String(n)).replace(/[^0-9.]/g,""));return Number.isFinite(t)&&t>0?t:1}function vn(e={},n=[],t=null){try{const c=fe(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(c){const u=_e(c);if(u){const d=u.price??u.total_price??u.package_price,m=D(d);if(Number.isFinite(m)&&m>0)return $(m)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,o=D(i);if(Number.isFinite(o)&&o>0)return $(o);const s=e.total_price??e.totalPrice??e.total,l=D(s),a=Number.parseFloat(h(String(t)).replace(/[^0-9.]/g,"")),r=Number.isFinite(a)&&a>0?a:Sn(e);return Number.isFinite(l)&&l>0&&r>0?$(l/r):0}function qn(e={}){const n=Array.isArray(e?.items)?e.items:[],t=Cn(n),i=tt(),o=new Set,s=new Map;i.forEach(p=>{const b=fe(p?.id??p?.packageId??p?.package_id??p?.code);b&&o.add(b);const P=h(String(p?.package_code??p?.code??"")).trim().toLowerCase();P&&s.set(P,b||P)});const l=(p,b=0)=>{const P=fe(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),I=h(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return P||(I&&s.has(I)?s.get(I):I||`pkg-${b}`)},a=new Map,r=(p,b=0,P="packages")=>{if(!p||typeof p!="object")return;const S=l(p,b)||`pkg-${b}`;if(!a.has(S)){a.set(S,{source:p,normalizedId:S,index:b,itemSource:P==="items"?p:null});return}const A=a.get(S);if(A.source||(A.source=p),P==="items"&&(A.itemSource=p,A.source&&typeof A.source=="object")){const q=Array.isArray(A.source.packageItems)&&A.source.packageItems.length>0,L=Array.isArray(p.packageItems)&&p.packageItems.length>0;!q&&L&&(A.source={...A.source,packageItems:p.packageItems}),!A.source.image&&p.image&&(A.source={...A.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,b)=>r(p,b,"packages")),n.forEach((p,b)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const P=l(p,b+a.size);r({...p,package_id:P,packageId:P,package_code:p.package_code??p.code},b+a.size,"items")}});const c=[],u=new Set,d=new Set;a.forEach(({source:p,itemSource:b=null,normalizedId:P},I)=>{const A=(P?_e(P):null)||p||{},q=b&&typeof b=="object"?b:null;let L=bt(A);(!Array.isArray(L)||L.length===0)&&q&&(L=bt(q)),L.forEach(F=>{const T=F?.normalizedBarcode??ve(F?.barcode);T&&u.add(T);const z=F?.equipmentId??F?.equipment_id??null;z!=null&&d.add(String(z))});let B=1,w=vn(A,L,B);const f=[q?.price,q?.unit_price,q?.unitPrice];for(const F of f){const T=D(F);if(Number.isFinite(T)&&T>0){w=$(T);break}}w=$(w);const U=[A?.unit_cost,A?.unitCost,A?.cost,q?.unit_cost,q?.unitCost,q?.cost];let H=0;for(const F of U){const T=D(F);if(Number.isFinite(T)&&T>=0){H=$(T);break}}if(!H&&Array.isArray(L)&&L.length){const F=L.reduce((T,z)=>{const pe=D(z?.cost),be=Number.isFinite(Number(z?.qtyPerPackage))&&Number(z.qtyPerPackage)>0?Number(z.qtyPerPackage):1;return T+(Number.isFinite(pe)?pe:0)*be},0);H=$(F)}const O=(()=>{const F=[A?.pricing_mode,A?.pricingMode,A?.pricing,q?.pricing_mode,q?.pricingMode,q?.pricing];for(const T of F){if(T==null)continue;const z=String(T).trim().toLowerCase();if(z==="daily"||z==="per_day"||z==="day")return"daily";if(z==="fixed"||z==="per_booking"||z==="booking")return"fixed"}return"daily"})(),K=[q?.total,q?.total_price,q?.totalPrice,A?.total,A?.total_price,A?.totalPrice];let Q=NaN;for(const F of K){const T=D(F);if(Number.isFinite(T)&&T>=0){Q=T;break}}Number.isFinite(Q)||(Q=w*B),Q=$(Q);const ee=[A?.package_code,A?.code,A?.packageCode,A?.displayCode,A?.display_code,A?.barcode,q?.package_code,q?.code,q?.packageCode,q?.displayCode,q?.display_code,q?.barcode,P,I].find(F=>F==null?!1:String(F).trim().length>0),v=ee!=null?h(String(ee)).trim():"";if(v){const F=ve(v);F&&u.add(F)}const E=L.map(F=>h(String(F?.barcode??F?.normalizedBarcode??""))).filter(Boolean),G=[A?.name,A?.package_name,A?.title,q?.name,q?.desc,q?.package_name,v,h(String(I))].find(F=>F!=null&&String(F).trim()!=="")||h(String(v||I)),ae=L.find(F=>F?.image)?.image??A?.image??q?.image??null,j=1;c.push({key:`package::${I}`,description:G,normalizedDescription:h(String(G)),unitPrice:w,unitCost:H,totalPrice:Q,pricingMode:O,quantity:B,count:j,image:ae,barcodes:E,barcode:v,package_code:v,packageDisplayCode:v,items:[{type:"package",packageItems:L,packageId:P,desc:G,price:w,cost:H,qty:j,barcode:v}],type:"package",packageItems:L,packageId:P})});const m=new Set(Array.from(u).map(p=>ve(p)).filter(Boolean)),y=t.filter(p=>{if(p.items.some(S=>S?.type==="package")&&c.length>0)return!1;const P=(S={})=>[S.packageId,S.package_id,S.package_code,S.packageCode,S.bundleId,S.bundle_id].some(A=>A!=null&&A!=="");return!p.items.every(S=>{const A=Fn(S),q=A!=null?String(A):null;if(q&&d.has(q))return!0;const L=S?.barcode?ve(S.barcode):null;return!!(L&&m.has(L)||P(S))})}),g=new Set,_=[];return c.forEach(p=>{const b=l({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!b||g.has(b)||(g.add(b),_.push(p))}),{groups:_.length?[..._,...y]:t,packageGroups:c,groupedItems:t,filteredGroupedItems:y,packagesMap:a}}function Fn(e={}){const n=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const t of n)if(!(t==null||t===""))return String(t);return null}function ht(e={}){const n=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function Nt(e={}){const n=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function hi(e){const n=e?.status??e?.reservationStatus??null;if(n){const o=String(n).trim().toLowerCase();if(o==="completed"||o==="closed"||o==="Ù…ØºÙ„Ù‚"||o==="Ù…ÙƒØªÙ…Ù„"||o==="Ù…Ù†ØªÙ‡ÙŠ"||o==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Ln(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Ni(e={},n=null){const t=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,o=i!=null&&i!==""&&i!=="null",s=o?Ln(n?.status??n?.status_label??n?.statusLabel??""):null,l=o&&(n?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:t,projectLinked:o,projectStatus:s,projectConfirmed:l,effectiveConfirmed:o?l:t}}const $t=10;function wt(e={}){const n=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const t of n){const i=D(t);if(Number.isFinite(i))return $(i)}return 0}function En(e={}){const n=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const t of n){if(t==null||t==="")continue;const i=D(t);if(Number.isFinite(i))return $(i)}return wt(e)}function Tn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:n=[]}=ue();if(!Array.isArray(n)||n.length===0)return{costPerDay:0,totalPerDay:0};const t=new Map(n.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,o)=>{const s=t.get(String(o));if(!s)return i;const l=wt(s),a=En(s);return{costPerDay:i.costPerDay+(Number.isFinite(l)?l:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const $n=1440*60*1e3,Ne=.01;function he(e){if(e==null||e==="")return null;const n=h(String(e)).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return Number.isFinite(t)?t:null}function Pt(e,{min:n=0,max:t=Number.POSITIVE_INFINITY,precision:i=2}={}){let o=Number.isFinite(e)?e:0;if(o<n&&(o=n),o>t&&(o=t),i!=null){const s=10**i;o=Math.round(o*s)/s}return o}function xt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function it({totalAmount:e=0,progressType:n=null,progressValue:t=null,paidAmount:i=null,paidPercent:o=null,history:s=[]}={}){const l=Number.isFinite(Number(e))?Number(e):0,a=n==="amount"?"amount":n==="percent"?"percent":null;let r=he(i),c=he(o);const u=he(t);let d=0,m=0;Array.isArray(s)&&s.length&&s.forEach(p=>{if(!p)return;const b=p.type==="amount"||p.type==="percent"?p.type:null,P=he(p.value),I=he(p.amount),S=he(p.percentage);if(b==="amount"){const A=I??P;A!=null&&(d+=A,l>0&&(m+=A/l*100))}else if(b==="percent"){const A=S??P;A!=null&&(m+=A,l>0&&(d+=A/100*l))}else I!=null&&(d+=I,l>0&&(m+=I/l*100)),S!=null&&(m+=S,l>0&&(d+=S/100*l))}),a==="amount"&&u!=null?r=u:a==="percent"&&u!=null?c=u:a===null&&u!=null&&(c!=null?c=u:r=u),(r==null||r<=0)&&c!=null&&c>0&&l>0&&(r=l*(c/100)),(c==null||c<=0)&&r!=null&&r>0&&l>0&&(c=r/l*100);const y=r??0,g=c??0;r=y+d,c=g+m,r=Pt(r??0,{min:0,max:l>0?l:Number.POSITIVE_INFINITY,precision:2}),c=Pt(c??0,{min:0,max:100,precision:2});let _=a;return _||(r>0&&l>0?_="amount":c>0&&(_="percent")),{paidAmount:r,paidPercent:c,paymentProgressType:_,paymentProgressValue:_==="amount"?r:_==="percent"?c:null}}function at({manualStatus:e="unpaid",paidAmount:n=0,paidPercent:t=0,totalAmount:i=0}={}){const o=xt(e),s=Number.isFinite(Number(i))?Number(i):0,l=Number.isFinite(Number(n))?Number(n):0,a=Number.isFinite(Number(t))?Number(t):0;if(o==="paid")return"paid";const r=s>0&&l>=s-Ne,c=a>=100-Ne*100;if(r||c)return"paid";const u=l>Ne||a>Ne;return o==="partial"||u?"partial":"unpaid"}function wn(e,n){if(!e||!n)return 1;const t=new Date(e),i=new Date(n);if(Number.isNaN(t.getTime())||Number.isNaN(i.getTime()))return 1;const o=i.getTime()-t.getTime();if(o<=0)return 1;const s=o/$n;return Math.max(1,Math.ceil(s))}function Ie({items:e=[],technicianIds:n=[],crewAssignments:t=[],discount:i=0,discountType:o="percent",applyTax:s=!1,start:l=null,end:a=null,companySharePercent:r=null,groupingSource:c=null}={}){const u=wn(l,a);let d=!1;try{if(typeof window<"u"&&window.location){const v=new URL(window.location.href),E=(v.searchParams.get("noDays")||v.searchParams.get("pricing")||"").toLowerCase();d=E==="1"||E==="true"||E==="fixed"||E==="nodays"}}catch{}const m=c&&typeof c=="object"?c:{items:Array.isArray(e)?e:[]},{groups:y}=qn(m),g=v=>{if((v?.type||"").toLowerCase()==="package")return!0;const E=Array.isArray(v?.items)?v.items:[];if(!E.length)return!1;if(E.some(j=>j?.reservation_id!=null||j?.reservationId!=null))return!0;const G=E.every(j=>j?.unit_price!=null||j?.unitPrice!=null),ae=E.some(j=>j?.daily_rate!=null||j?.dailyRate!=null||j?.unit_rate!=null||j?.unitRate!=null||j?.price!=null);return!!(G&&!ae)};let _=0,N=0;(Array.isArray(y)?y:[]).forEach(v=>{const E=Number.isFinite(Number(v?.quantity))?Number(v.quantity):0,ie=Number.isFinite(Number(v?.unitPrice))?Number(v.unitPrice):0,G=Number.isFinite(Number(v?.unitCost))?Number(v.unitCost):0,ae=String(v?.type||"").toLowerCase()==="package",j=g(v),F=d||j?1:u;if(ae){const T={package_code:v?.package_code||v?.packageDisplayCode||v?.barcode||v?.packageId||v?.key,packageItems:Array.isArray(v?.packageItems)?v.packageItems:void 0},z=In(T,{packageQuantity:E,days:F}),pe=Number.isFinite(Number(z.total))?Number(z.total):E*(Number.isFinite(ie)?ie:0)*F,be=(()=>{const me=Number(z?.costTotal);if(Number.isFinite(me))return me;const Te=Number(z?.perDayCostTotal);return Number.isFinite(Te)?Te*F:E*(Number.isFinite(G)?G:0)*F})();_+=pe,N+=be}else _+=E*ie*F,N+=E*G*F});const p=$(_),b=$(N),P=Array.isArray(t)?t:[],I=P.length?P.map(v=>v?.technicianId).filter(Boolean):Array.isArray(n)?n:[],{costPerDay:S,totalPerDay:A}=P.length?P.reduce((v,E)=>{const ie=D(E?.positionCost??E?.position_cost??E?.cost??E?.dailyWage??E?.daily_wage??0),G=D(E?.positionClientPrice??E?.position_client_price??E?.clientPrice??E?.dailyTotal??E?.daily_total??E?.total??0),ae=Number.isFinite(ie)?ie:0,j=Number.isFinite(G)?G:0;return{costPerDay:v.costPerDay+ae,totalPerDay:v.totalPerDay+j}},{costPerDay:0,totalPerDay:0}):Tn(I),q=$(A*u),L=$(S*u),B=$(p+q),w=Number(i)||0;let f=o==="amount"?w:B*(w/100);(!Number.isFinite(f)||f<0)&&(f=0),f>B&&(f=B);const U=Math.max(0,B-f),H=Number.isFinite(r)&&Number(r)>0?Number(r):0,Z=H>0?Math.max(0,U*(H/100)):0,O=U+Z;let K=s?O*.15:0;(!Number.isFinite(K)||K<0)&&(K=0),K=Number(K.toFixed(2));const Q=O+K,x=Math.max(0,Number(Q.toFixed(2))),ee=Math.max(0,Math.max(0,p+q-f)-L-b);return{rentalDays:u,equipmentTotal:p,equipmentCostTotal:b,crewTotal:q,crewCostTotal:L,discountAmount:f,subtotalAfterDiscount:U,taxableAmount:O,taxAmount:K,finalTotal:x,companySharePercent:H,companyShareAmount:Z,netProfit:ee}}function Pi(e=[],n=0,t="percent",i=!1,o=[],{start:s=null,end:l=null,companySharePercent:a=null}={}){const r=y=>y&&typeof y=="object"&&(y.positionId!==void 0||y.position_id!==void 0||y.positionLabel!==void 0||y.position_name!==void 0||y.positionClientPrice!==void 0),c=Array.isArray(o)&&o.some(r)?o:[],u=c.length?c.map(y=>y?.technicianId).filter(Boolean):Array.isArray(o)?o:[];return Ie({items:e,technicianIds:u,crewAssignments:c,discount:n,discountType:t,applyTax:i,start:s,end:l,companySharePercent:a??$t}).finalTotal}function Dt({total:e,itemsCount:n,rentalDays:t,techniciansCount:i,applyTax:o,paymentStatus:s,paidAmount:l=0,paidPercent:a=0,companySharePercent:r=null,companyShareAmount:c=null,taxAmount:u=null,netProfit:d=null,totalKey:m="reservations.summary.total",equipmentTotal:y=null,crewTotal:g=null,equipmentCostTotal:_=null}){const N=C("reservations.create.summary.currency","SR"),p=h(String(e)),b=h(String(n)),P=h(String(t??1)),I=h(String(i)),S=xt(s),A=S==="paid"?"Ù…Ø¯ÙÙˆØ¹":S==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",q=C(`reservations.create.paymentStatus.${S}`,A),L=Number.isFinite(Number(l))?Math.max(0,Number(l)):0,B=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,w=L>Ne||B>Ne,f=C("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),U=h(L.toFixed(2)),H=h(B.toFixed(B%1?2:0)),Z=C("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),O=C("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),K=C("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),Q=C("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),x=C("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ee=C("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),v=C("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),E=C("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),G=C(m==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",C("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),ae=C("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),j=C("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),F=Number.isFinite(d)?Math.max(0,Number(d)):null,T=[{label:Z,value:b},{label:O,value:P},{label:K,value:I}],z=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;z!=null&&T.push({label:Q,value:`${h(z.toFixed(2))} ${N}`});const pe=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;pe!=null&&T.push({label:x,value:`${h(pe.toFixed(2))} ${N}`});const be=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(be!=null&&T.push({label:ee,value:`${h(be.toFixed(2))} ${N}`}),o){let oe=C("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(oe=`${h(Number(u).toFixed(2))} ${N}`),T.push({label:v,value:oe})}const me=Number.isFinite(r)?Number(r):null;if(me!==null&&me>0){const oe=Number.isFinite(c)?Number(c):e*(me/100),Se=h(String(me)),Jt=h(Number.isFinite(oe)?oe.toFixed(2):"0"),Xt=`${Se}% (${Jt} ${N})`;T.push({label:ae,value:Xt})}if(F!==null&&Math.abs(F-Number(e))>.009){const oe=h(F.toFixed(2));T.push({label:j,value:`${oe} ${N}`})}T.push({label:E,value:q}),w&&T.push({label:f,value:`${U} ${N} (${H}%)`});const Te=`${p} ${N}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${T.map(({label:oe,value:Se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${oe}</span>
            ${Se?`<span class="reservation-summary-value">${Se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${G}</span>
          <span class="reservation-summary-value">${Te}</span>
        </div>
      </div>
    </div>
  `}function xn({selectedItems:e,discount:n,discountType:t,applyTax:i,paidStatus:o,paymentProgressType:s=null,paymentProgressValue:l=null,start:a,end:r,companySharePercent:c=null,paymentHistory:u=[]}){const d=bn(),m=typeof ft=="function"?ft()??[]:[],y=Array.isArray(m)?m.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):y,_=d.length||g.length,N=Number.isFinite(c)?Number(c):null,p=Ie({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:a,end:r,companySharePercent:N}),b=it({totalAmount:p.finalTotal,progressType:s,progressValue:l,history:u}),P=at({manualStatus:o,paidAmount:b.paidAmount,paidPercent:b.paidPercent,totalAmount:p.finalTotal}),I=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,paymentProgressType:b.paymentProgressType,paymentProgressValue:b.paymentProgressValue,total:p.finalTotal};return xn.lastResult=S,Rn(I),I}function Dn({items:e,discount:n,discountType:t,applyTax:i,paidStatus:o,paymentProgressType:s=null,paymentProgressValue:l=null,start:a,end:r,companySharePercent:c=null,paymentHistory:u=[]}){const d=hn(),m=typeof _t=="function"?_t()??[]:[],y=Array.isArray(m)?m.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):y,_=d.length||g.length,N=Number.isFinite(c)?Number(c):null,p=Ie({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:a,end:r,companySharePercent:N}),b=it({totalAmount:p.finalTotal,progressType:s,progressValue:l,history:u}),P=at({manualStatus:o,paidAmount:b.paidAmount,paidPercent:b.paidPercent,totalAmount:p.finalTotal}),I=Dt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={html:I,paymentStatus:P,paidAmount:b.paidAmount,paidPercent:b.paidPercent,paymentProgressType:b.paymentProgressType,paymentProgressValue:b.paymentProgressValue,total:p.finalTotal};return Dn.lastResult=S,I}function Rn(e){const n=document.getElementById("reservation-preview");n&&(n.innerHTML=e,At(n,e));const t=document.getElementById("reservation-preview-bottom");t&&(t.innerHTML=e,At(t,e))}function At(e,n){const t=typeof n=="string"&&n.trim().length>0;e.classList.toggle("reservation-summary-host",t)}const Bn=ue()||{};let te=(Bn.reservations||[]).map(Kt);function J(e){let n=Number(e);if(!Number.isFinite(n))return 0;let t=0;for(;Math.abs(n)>1e5&&t<8;)n/=10,t+=1;return Number(n.toFixed(2))}const Rt="__reservation_packages_cache__",Bt="__reservation_item_cost_cache__";function zt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Mt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function jt(){const e=zt();if(!e)return{};try{const n=e.getItem(Rt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation packages cache",n),{}}}function Ct(e){const n=zt();if(n)try{n.setItem(Rt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation packages cache",t)}}function ot(){const e=Mt();if(!e)return{};try{const n=e.getItem(Bt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation item cost cache",n),{}}}function Ye(e){const n=Mt();if(n)try{n.setItem(Bt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation item cost cache",t)}}function zn(e,n=0){if(!e||typeof e!="object")return null;const t=e.equipment_id??e.equipmentId??e.id??null,i=h(String(e.barcode??e.code??"")).trim(),o=J(k(e.cost??e.unit_cost)),s=J(k(e.price??e.unit_price)),l=Number.isFinite(o),a=Number.isFinite(s);return!l&&!a?null:{key:t!=null?`id:${t}`:i?`bc:${i}`:`idx:${n}`,equipmentId:t,barcode:i,cost:l?o:null,price:a?s:null}}function Mn(e,n){if(!e)return;const t=Array.isArray(n)?n.map((s,l)=>zn(s,l)).filter(Boolean):[],i=ot(),o=String(e);if(!t.length){i[o]&&(delete i[o],Ye(i));return}i[o]=t,Ye(i)}function jn(e=[]){const n=ot(),t=new Set;e.forEach(o=>{const s=o?.id??o?.reservationId??o?.reservation_code??null;s&&t.add(String(s))});let i=!1;Object.keys(n).forEach(o=>{t.has(o)||(delete n[o],i=!0)}),i&&Ye(n)}function Vn(e){if(!e)return[];const n=ot(),t=String(e),i=n[t];return Array.isArray(i)?i:[]}function Hn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const n=tt();if(!Array.isArray(n)||n.length===0)return[];const t=new Map;e.forEach(o=>{if(!o||typeof o!="object")return;const s=o.equipmentId??o.equipment_id??o.id??null;if(s==null)return;const l=String(s),a=(()=>{const r=[o.qty,o.quantity,o.count,1];for(const c of r){const u=Number(c);if(Number.isFinite(u)&&u>0)return u}return 1})();t.set(l,(t.get(l)||0)+a)});const i=[];return n.forEach((o,s)=>{const l=Pe(o)||[],a=new Map;let r=!0;if(l.forEach(g=>{const _=g?.equipmentId??g?.equipment_id??null,N=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(_==null){r=!1;return}const p=String(_);a.set(p,(a.get(p)||0)+N)}),!r||a.size===0)return;let c=1/0;for(const[g,_]of a.entries()){const N=t.get(g)||0,p=Math.floor(N/_);if(p<=0){c=0;break}p<c&&(c=p)}if(!Number.isFinite(c)||c<=0)return;for(const[g,_]of a.entries()){const N=t.get(g)||0;t.set(g,Math.max(0,N-c*_))}const u=fe(o?.id??o?.packageId??o?.package_id??o?.code),d=Array.from(a.entries()).map(([g,_])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:_,unit_price:0})),m=(o?.package_code??o?.code??u)||`pkg-${s}`,y=cn(o)||u||`package-${s}`;i.push({package_code:m,name:y,quantity:c,unit_price:St(o)||0,items:d})}),i}function On(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(n=>{const i=(n.positionLabel??"").trim().length>0,o=n.positionId!=null||n.positionKey!=null&&String(n.positionKey).trim()!=="",s=Number.isFinite(Number(n.positionClientPrice))&&Number(n.positionClientPrice)>0,l=Number.isFinite(Number(n.positionCost))&&Number(n.positionCost)>0;return i||o||s||l})}function Kn(e){return[]}function Vt(e=[]){return Array.isArray(e)?e.map((n,t)=>Yt(n,t)).filter(Boolean).map((n,t)=>{const i=fe(n.packageId??n.package_id??n.package_code??n.code??n.id??`pkg-${t}`),o=Be(n,i).map(c=>{const u=R(c.qty??c.quantity??c.count??c.units??c.unit_qty??c.unitQty??c.unit_count??c.unitCount??c.package_quantity??c.packageQty??1),d=J(k(c.price??c.unit_price??0));return{...c,qty:u,quantity:u,price:d,unit_price:d}}),s=R(n.quantity??n.qty??1);let l=J(k(n.unit_price??n.unitPrice??n.price??0));if(!l||l<=0){const c=o.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);c>0&&s>0&&(l=J(Number((c/s).toFixed(2))))}const a=k(n.total_price??n.totalPrice??n.total??l*s),r=a>0?J(a):J(Number((l*s).toFixed(2)));return{...n,packageId:i,package_id:i,qty:s,quantity:s,unit_price:l,unitPrice:l,price:l,total_price:r,total:r,packageItems:o}}):[]}function Le(e,n){if(!e)return;const t=jt(),i=String(e);if(!Array.isArray(n)||n.length===0){t[i]&&(delete t[i],Ct(t));return}t[i]=Vt(n),Ct(t)}function Qn(e){if(!e)return[];const n=jt(),t=String(e),i=n[t];return Array.isArray(i)?Vt(i):[]}function st(e,n=0){if(e==null)return null;if(typeof e!="object"){const P=e!=null?String(e):null;return{assignmentId:`crew-${n}-${P??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:P,technicianName:null,technicianRole:null,notes:null}}const t=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${n}`,i=e&&typeof e.position=="object"?e.position:null,o=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,s=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let l=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";l||(l=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,r=e.position_label_en??null,c=e.position_label_alt??r??a??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,m=J(D(u)),y=J(D(d)),g=e&&typeof e.technician=="object"?e.technician:null,_=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,N=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,p=e.role??g?.role??e.specialization??null,b=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(t),positionId:o!=null?String(o):null,positionKey:s!=null?String(s):null,positionLabel:l!=null?String(l):"",positionLabelAlt:c!=null?String(c):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:r!=null?String(r):null,positionCost:Number.isFinite(m)?m:0,positionClientPrice:Number.isFinite(y)?y:0,technicianId:_!=null?String(_):null,technicianName:N!=null?String(N):null,technicianRole:p!=null?String(p):null,technicianPhone:b!=null?String(b):null,notes:e.notes??null}}function Un(){return te}function Ee(e){te=Array.isArray(e)?e.map(He):[],te.forEach(n=>{if(!n)return;const t=n.id??n.reservationId??n.reservationCode;Le(t,n.packages),Mn(t,n.items);const i=n.crewAssignments&&n.crewAssignments.length?n.crewAssignments:n.techniciansDetails||[];On(i)}),jn(te),Zt({reservations:te});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return te}async function Gn(e={}){const n=new URLSearchParams;Object.entries(e).forEach(([a,r])=>{r!=null&&r!==""&&n.set(a,String(r))});const t=n.toString(),o=(await ze(`/reservations/${t?`?${t}`:""}`))?.data;let s=[];Array.isArray(o)?s=o:o&&typeof o=="object"&&(Array.isArray(o.items)?s=o.items:Array.isArray(o.results)?s=o.results:Array.isArray(o.data)?s=o.data:Array.isArray(o.records)&&(s=o.records));const l=s.map(Ve).map(Ot);return Ee(l)}async function Wn(e){const n=await ze("/reservations/",{method:"POST",body:e}),t=Ve(n?.data??{}),i=Array.isArray(e?.items)?e.items:null;if(i&&(Array.isArray(t.items)&&t.items.length?t.items=Ht(t.items,i):t.items=i.map(Oe)),!Number.isFinite(t.companySharePercent)&&e?.company_share_percent!=null&&(t.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(t.paymentHistory)||t.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const o=rt(e.payment_history);o.length&&(t.paymentHistory=o)}if((!Array.isArray(t.crewAssignments)||t.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const o=e.technicians.map((s,l)=>st(s,l)).filter(Boolean);o.length&&(t.crewAssignments=o,t.techniciansDetails=o.map((s,l)=>{const a=e.technicians[l];return typeof a=="object"?{...a,...s}:s}))}if(Array.isArray(e?.packages)&&e.packages.length){const o=dt({packages:e.packages});t.packages=re(t.packages,o)}{const o=ut(t.items||[],t.packages||[]);t.items=o.items,t.packages=re(t.packages||[],o.packages)}if(Le(t.id??t.reservationId??t.reservation_code,t.packages),t.companySharePercent>0&&(!Number.isFinite(t.companyShareAmount)||t.companyShareAmount<=0)){const o=Ie({items:t.items||[],technicianIds:t.technicians||[],discount:t.discount,discountType:t.discountType,applyTax:t.applyTax,start:t.start,end:t.end,companySharePercent:t.companySharePercent});t.companyShareAmount=o.companyShareAmount,t.cost=o.finalTotal,t.totalAmount=o.finalTotal}return t.companyShareEnabled=e?.company_share_enabled?!0:t.companySharePercent>0,Ee([...te,t]),t}async function ct(e,n){const t=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:n}),i=Ve(t?.data??{}),o=Array.isArray(n?.items)?n.items:null;if(o&&(Array.isArray(i.items)&&i.items.length?i.items=Ht(i.items,o):i.items=o.map(Oe)),console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&n?.company_share_percent!=null&&(i.companySharePercent=Number(n.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(n?.payment_history)){const l=rt(n.payment_history);l.length&&(i.paymentHistory=l,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(n?.technicians)&&n.technicians.length){const l=n.technicians.map((a,r)=>st(a,r)).filter(Boolean);l.length&&(i.crewAssignments=l,i.techniciansDetails=l.map((a,r)=>{const c=n.technicians[r];return typeof c=="object"?{...c,...a}:a}))}if(Array.isArray(n?.packages))if(n.packages.length){const l=dt({packages:n.packages});i.packages=re(i.packages,l)}else i.packages=[];{const l=ut(i.items||[],i.packages||[]);i.items=l.items,i.packages=re(i.packages||[],l.packages)}if(Le(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const l=Ie({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=l.companyShareAmount,i.cost=l.finalTotal,i.totalAmount=l.finalTotal}i.companyShareEnabled=n?.company_share_enabled?!0:i.companySharePercent>0;const s=te.map(l=>String(l.id)===String(e)?i:l);return Ee(s),i}function Ht(e,n){if(!Array.isArray(e)||!Array.isArray(n))return e;const t=new Map;return n.forEach((i,o)=>{if(!i||typeof i!="object")return;const s=i.equipment_id??i.equipmentId??i.id??null,l=h(String(i.barcode??"")).trim(),a=s!=null?`id:${s}`:l?`bc:${l}`:`idx:${o}`,r=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,c=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;t.set(a,{cost:r,price:c})}),e.map((i,o)=>{const s=i.equipmentId??i.equipment_id??i.id??null,l=h(String(i.barcode??"")).trim(),a=[s!=null?`id:${s}`:null,l?`bc:${l}`:null,`idx:${o}`].filter(Boolean);let r=null;for(const u of a)if(t.has(u)){r=t.get(u);break}if(!r)return i;const c={...i};return Number.isFinite(r.cost)&&(c.cost=r.cost,c.unit_cost=r.cost),Number.isFinite(r.price)&&(c.price=r.price,c.unit_price=r.price),c})}function Ot(e){try{return Yn(e)}catch(n){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",n),e}}function Yn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(s=>s!=null?String(s):"").filter(Boolean);if(!n.length)return e;const t=te.find(s=>{if(!s)return!1;const l=s.id!=null?String(s.id):"",a=s.reservationId!=null?String(s.reservationId):"",r=s.reservation_code!=null?String(s.reservation_code):"";return l&&n.includes(l)||a&&n.includes(a)||r&&n.includes(r)});if(!t||!Array.isArray(t.items))return e;const i=new Map;t.items.forEach((s,l)=>{const a=s?.equipmentId??s?.equipment_id??s?.id??null,r=h(String(s?.barcode??"")).trim(),c=a!=null?`id:${a}`:r?`bc:${r}`:`idx:${l}`;i.set(c,s)});const o=e.items.map((s,l)=>{const a=s?.equipmentId??s?.equipment_id??s?.id??null,r=h(String(s?.barcode??"")).trim(),c=[a!=null?`id:${a}`:null,r?`bc:${r}`:null,`idx:${l}`].filter(Boolean);let u=null;for(const g of c)if(i.has(g)){u=i.get(g);break}if(!u)return s;const d={...s},m=Number(u.cost),y=Number(u.price);return Number.isFinite(m)&&m>0&&(d.cost=m,d.unit_cost=m),Number.isFinite(y)&&y>0&&(d.price=y,d.unit_price=y),d});return{...e,items:o}}function Jn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(s=>s!=null?String(s):"").filter(Boolean);if(!n.length)return e;let t=[];for(const s of n)if(t=Vn(s),t.length)break;if(!t.length)return e;const i=new Map;t.forEach((s,l)=>{if(!s||typeof s!="object")return;const a=s.equipmentId??s.equipment_id??null,r=h(String(s.barcode??"")).trim(),c=a!=null?`id:${a}`:r?`bc:${r}`:`idx:${l}`;i.set(c,s)});const o=e.items.map((s,l)=>{const a=s?.equipmentId??s?.equipment_id??s?.id??null,r=h(String(s?.barcode??"")).trim(),c=[a!=null?`id:${a}`:null,r?`bc:${r}`:null,`idx:${l}`].filter(Boolean);let u=null;for(const b of c)if(i.has(b)){u=i.get(b);break}if(!u)return s;const d={...s},m=J(k(u.cost??u.unit_cost)),y=J(k(u.price??u.unit_price)),g=Number.isFinite(m),_=Number.isFinite(y),N=Number(s.cost),p=Number(s.price);return g&&(!Number.isFinite(N)||N<=0)&&(d.cost=m,d.unit_cost=m),_&&(!Number.isFinite(p)||p<=0)&&(d.price=y,d.unit_price=y),d});return{...e,items:o}}async function Xn(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const n=te.filter(t=>String(t.id)!==String(e));Ee(n),Le(e,null)}async function Zn(e){return ct(e,{status:"confirmed",confirmed:!0})}async function ei(e,n=null){const t={status:"completed",confirmed:!0};return typeof n=="string"&&(t.notes=n),ct(e,t)}function Ve(e={}){const n=He({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});return Jn(Ot(n))}function Kt(e={}){return He(e)}function He(e={}){const n=e.id??e.reservation_id??e.reservationId??null,t=e.reservation_code??e.reservationCode??e.reservationId??(n!=null?`RSV-${n}`:null);let i=Array.isArray(e.items)?e.items.map(Oe):[],o=dt(e);const s=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let l=s.map((x,ee)=>st(x,ee)).filter(Boolean),a=l.map((x,ee)=>{const v=s?.[ee];return{...v&&typeof v=="object"?{...v}:v!=null?{id:v}:{},...x}});const r=l.map(x=>x.technicianId).filter(x=>x!=null&&x!=="").map(x=>Number.isNaN(Number(x))?String(x):Number(x)),c=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=k(e.total_amount??e.totalAmount??e.cost??0);const m=k(e.discount??0),y=e.discount_type??e.discountType??"percent",g=["percent","amount"].includes(y)?y:"percent",_=!!(e.apply_tax??e.applyTax??!1);let N=li(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),b=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,P=b!=null?Number.parseFloat(h(String(b).replace("%","").trim())):NaN,I=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let S=I!=null?I===!0||I===1||I==="1"||String(I).toLowerCase()==="true":Number.isFinite(P)&&P>0,A=S&&Number.isFinite(P)?Number(P):0;const q=e.company_share_amount??e.companyShareAmount;let L=Number.isFinite(Number(q))?Number(q):NaN;_&&A<=0&&(A=$t,S=!0);const B=Ie({items:i,technicianIds:r,crewAssignments:l,discount:m,discountType:g,applyTax:_,start:c,end:u,companySharePercent:A>0?A:null});(!Number.isFinite(d)||d<=0||_)&&(d=B.finalTotal),(!Number.isFinite(L)||L<0)&&(L=B.companyShareAmount),L=Number.isFinite(L)?Number(L.toFixed(2)):0,!S&&A>0&&(S=!0);const w=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],f=ni(w),U=rt(f),H=n??t??e.reservation_code??e.reservationId??null;if(o.length)Le(H,o);else{const x=Qn(H);x.length&&(o=re(o,x))}if(!o.length&&Array.isArray(i)&&i.length)try{const x=Hn(i);Array.isArray(x)&&x.length&&(o=re(o,x))}catch(x){console.warn("[reservationsService] inference of packages from items failed",x)}const Z=ut(i,o);i=Z.items,o=re(o,Z.packages);const O=it({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:U});N=at({manualStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,totalAmount:d});const K=N==="paid",Q=ri(e.status??(p?"confirmed":"pending"));return{id:n!=null?String(n):"",reservationId:t??(n!=null?String(n):""),reservationCode:t??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:c,end:u,status:Q,completed:Q==="completed",confirmed:p,location:e.location??"",notes:e.notes??"",discount:m,discountType:g,applyTax:_,paid:K,paidStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,paymentProgressType:O.paymentProgressType,paymentProgressValue:O.paymentProgressValue,paymentHistory:U,payment_history:U,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:r,crewAssignments:l,techniciansDetails:a,startDatetime:c,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:o,companySharePercent:A,companyShareAmount:L,companyShareEnabled:S}}function Oe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const n=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,t=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=k(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),o=k(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),s=h(String(e.barcode??e.code??e.serial??"")),l=e.description??e.desc??e.name??e.title??"",a={id:e.id!=null?String(e.id):n!=null?String(n):"",equipmentId:n,barcode:s,desc:l,qty:t,quantity:t,qtyPerPackage:null,totalQuantity:t,price:i,cost:o,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},r=Qt(e.type??e.item_type??e.kind??null),c=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=W(c),d=Be(e,u);if(r==="package"||u||d.length){a.type="package";const m=u||(n!=null?String(n):a.id?W(a.id):"");m&&(a.packageId=m,a.package_id=m,a.package_code=e.package_code??e.packageCode??m),a.name=l||a.package_code||m||"",a.barcode=a.barcode||h(String(e.package_code??e.packageCode??"")),a.packageItems=d;const y=Gt({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,t);(!Number.isFinite(a.price)||a.price<=0||a.price>y*10)&&(a.price=y),a.qtyPerPackage=d.length?d[0]?.qtyPerPackage??a.qtyPerPackage:a.qtyPerPackage,a.totalQuantity=t}return a}function ti({reservationCode:e,customerId:n,start:t,end:i,status:o,title:s,location:l,notes:a,projectId:r,totalAmount:c,discount:u,discountType:d,applyTax:m,paidStatus:y,confirmed:g,items:_,packages:N,crewAssignments:p=[],technicians:b=p,companySharePercent:P,companyShareEnabled:I,paidAmount:S,paidPercentage:A,paymentProgressType:q,paymentProgressValue:L,paymentHistory:B}){const w=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:n,start_datetime:t,end_datetime:i,status:o??"pending",title:s??null,location:l??null,notes:a??null,project_id:r||null,total_amount:c??0,discount:u??0,discount_type:d??"percent",apply_tax:m?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(S)?k(S):0,paid_percentage:Number.isFinite(A)?Number(A.toFixed(2)):0,payment_progress_type:q??null,payment_progress_value:Number.isFinite(L)?Number(L.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(f=>({type:Je(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?k(f.value):null,amount:f?.amount!=null?k(f.amount):f?.payment_amount!=null?k(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(f=>({type:Je(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?k(f.value):null,amount:f?.amount!=null?k(f.amount):f?.payment_amount!=null?k(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:ii(_),packages:ai(_,N),company_share_percent:I&&Number.isFinite(P)?Number(P):null,company_share_enabled:I?1:0,technicians:w.length?w.map((f,U)=>{const H=f.technicianId??f.technician_id??f.id??null,Z=f.positionId??f.position_id??f.position??f.position_code??null,O=f.positionLabel??f.position_name??f.role??null,K=k(f.positionCost??f.position_cost??f.cost??f.daily_wage??f.dailyWage??0),Q=k(f.positionClientPrice??f.position_client_price??f.client_price??f.clientPrice??f.daily_total??f.dailyTotal??f.total??0);return{id:H,technician_id:H,role:O??f.technicianRole??null,notes:f.notes??null,position_id:Z,position_key:f.positionKey??f.position_key??null,position_name:O,position_label_ar:f.positionLabelAr??f.position_label_ar??null,position_label_en:f.positionLabelEn??f.position_label_en??null,position_cost:K,position_client_price:Q,client_price:Q,cost:K,assignment_id:f.assignmentId??f.assignment_id??`crew-${U}`}}):Array.isArray(b)?b.map(f=>typeof f=="object"&&f!==null?{id:f.id??f.technician_id??f.technicianId??f.ID,role:f.role??null,notes:f.notes??null}:Number.isNaN(Number(f))?String(f):Number(f)):[]}}function rt(e){const n=lt(e);return!Array.isArray(n)||n.length===0?[]:n.map(t=>{if(!t||typeof t!="object")return null;const i=t.type??t.payment_type??t.paymentType??t.method??t.paymentMethod??t.kind??null,o=Je(i),s=t.value??t.payment_value??t.paymentValue??t.amount??t.payment_amount??t.percentage??t.payment_percentage??null,l=s!=null?Number.parseFloat(h(String(s))):null,a=t.amount!=null?Number.parseFloat(h(String(t.amount))):t.payment_amount!=null?Number.parseFloat(h(String(t.payment_amount))):null,r=t.percentage!=null?Number.parseFloat(h(String(t.percentage))):t.payment_percentage!=null?Number.parseFloat(h(String(t.payment_percentage))):null,c=Number.isFinite(a)?a:o==="amount"&&Number.isFinite(l)?l:null,u=Number.isFinite(r)?r:o==="percent"&&Number.isFinite(l)?l:null,d=o??(c!=null?"amount":u!=null?"percent":null),m=d==="amount"?c:d==="percent"?u:Number.isFinite(l)?l:null,y=t.note??t.notes??t.comment??t.payment_note??null,g=t.recordedAt??t.recorded_at??t.payment_date??t.date??t.createdAt??t.created_at??null;return{type:d,value:m,amount:c,percentage:u,note:y,recordedAt:g}}).filter(t=>t&&t.type)}function Je(e){if(!e)return null;const n=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(n)?"amount":["percent","percentage","ratio"].includes(n)?"percent":null}function lt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const n=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const l of n)if(Array.isArray(e[l]))return e[l];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(l=>Array.isArray(l));if(Array.isArray(i))return i;const o=Object.values(e);if(o.length&&o.every(l=>l&&typeof l=="object")){const l=o.map(a=>a);if(l.every(a=>!Array.isArray(a)))return l}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(l=>l in e))return[e]}if(typeof e=="string")try{const n=JSON.parse(e);return lt(n)}catch{return[]}return[]}function ni(e=[]){if(!Array.isArray(e))return[];for(const n of e){const t=lt(n);if(Array.isArray(t)&&t.length)return t}return[]}function ii(e){if(!Array.isArray(e)||e.length===0)return[];const n=[];return e.forEach(t=>{if(!t||typeof t!="object")return;if(t.type==="package"&&Array.isArray(t.packageItems)&&t.packageItems.length){const l=R(t.qty??t.quantity??1);t.packageItems.forEach(a=>{const r=a?.equipmentId??a?.equipment_id??a?.id??null;if(r==null)return;const c=R(a?.qty??a?.quantity??1),u=l*c,d=k(a?.cost??a?.unit_cost??a?.rental_cost??a?.internal_cost??a?.purchase_price??a?.equipment_cost??a?.item_cost??a?.price??0);n.push({equipment_id:Xe(r),quantity:u,unit_price:k(a?.price??a?.unit_price??0),unit_cost:d,cost:d,total_cost:Number.isFinite(d)?Number((d*u).toFixed(2)):0,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,notes:a?.notes??null})});return}const i=Array.isArray(t.packageItems)?t.packageItems:[],o=t.equipmentId??t.equipment_id??t.id??null;if(o==null)return;const s=(()=>{const l=k(t.cost??t.unit_cost??t.rental_cost??t.internal_cost??t.purchase_price??t.equipment_cost??0);if(Number.isFinite(l)&&l>0)return l;if(i.length){const a=i.reduce((r,c)=>{const u=k(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.internal_cost??c.purchase_price??c.equipment_cost??c.item_cost??c.price??0),d=R(c.qty??c.quantity??c.qtyPerPackage??c.unit_qty??1);return r+u*d},0);if(a>0)return Number(a.toFixed(2))}return l})();n.push({equipment_id:Xe(o),quantity:R(t.qty??t.quantity??1),unit_price:k(t.price??t.unit_price??0),unit_cost:s,cost:s,total_cost:Number.isFinite(s)?Number((s*R(t.qty??t.quantity??1)).toFixed(2)):0,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,notes:t.notes??null})}),n}function Xe(e){const n=Number(e);return Number.isFinite(n)&&n>=0?n:String(e)}function ai(e,n){const t=Array.isArray(n)?n.slice():[],i=new Map;return Array.isArray(e)&&e.forEach(o=>{const s=o?.equipmentId??o?.equipment_id??o?.id??null;if(s==null)return;let l=k(o?.unit_cost??o?.cost??o?.rental_cost??o?.purchase_price);if(!Number.isFinite(l)||l<=0){const a=Ue(s);Number.isFinite(a)&&a>0&&(l=a)}Number.isFinite(l)&&l>0&&i.set(String(s),l)}),Array.isArray(e)&&e.forEach(o=>{if(!o||typeof o!="object"||o.type!=="package")return;const s=R(o.qty??o.quantity??1),l=Array.isArray(o.packageItems)?o.packageItems.map(r=>{const c=r?.equipmentId??r?.equipment_id??r?.id??null;if(c==null)return null;let u=k(r?.cost??r?.unit_cost??r?.rental_cost??r?.internal_cost??r?.purchase_price??r?.equipment_cost??0);if((!Number.isFinite(u)||u===0)&&c!=null){const d=Ue(c);if(Number.isFinite(d)&&d>0)u=d;else if(i.has(String(c)))u=i.get(String(c));else{const m=k(r?.price??r?.unit_price??0);(!Number.isFinite(u)||u===0)&&Number.isFinite(m)&&m>0&&(u=m)}}return{equipment_id:Xe(c),quantity:R(r?.qty??r?.quantity??r?.count??r?.units??r?.unit_qty??r?.unitQty??r?.unit_count??r?.unitCount??r?.package_quantity??r?.packageQty??1),unit_price:k(r?.price??r?.unit_price??0),unit_cost:u,cost:u,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u}}).filter(Boolean):[];let a=k(o.cost??o.unit_cost??o.rental_cost??o.internal_cost??o.purchase_price??o.equipment_cost??0);if((!Number.isFinite(a)||a===0)&&o.equipmentId!=null){const r=Ue(o.equipmentId);if(Number.isFinite(r)&&r>0)a=r;else if(i.has(String(o.equipmentId)))a=i.get(String(o.equipmentId));else{const c=k(o?.price??o?.unit_price??0);(!Number.isFinite(a)||a===0)&&Number.isFinite(c)&&c>0&&(a=c)}}if((!Number.isFinite(a)||a===0)&&l.length){const r=l.reduce((c,u)=>{const d=k(u.cost??u.unit_cost??u.unitCost??u.rental_cost??u.internal_cost??u.purchase_price??u.equipment_cost??u.item_cost??u.price??0),m=R(u.qty??u.quantity??u.qtyPerPackage??1);return c+d*m},0);r>0&&(a=Number(r.toFixed(2)))}t.push({package_code:o.packageId??o.package_id??o.barcode??null,name:o.desc??o.name??"",quantity:s,unit_price:k(o.price??o.unit_price??0),unit_cost:a,cost:a,total_cost:Number.isFinite(a)?Number((a*s).toFixed(2)):0,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,items:l})}),t}function Qt(e){if(e==null)return"";const n=String(e).trim().toLowerCase();return n==="package"||n==="bundle"||n==="pack"?"package":n}function W(e){if(e==null)return"";const n=String(e).replace(/^package::/i,"");return fe(n)}function Ze(e){return e==null?"":h(String(e)).trim().toLowerCase()}function Ut(e={},n=1){if(!e||typeof e!="object"){const c=h(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:c,normalizedBarcode:Ze(c),desc:"",image:null}}const t=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),o=k(e.unit_price??e.unitPrice??e.price??0),s=k(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),l=h(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),a=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let r;if(a!=null)r=R(a,{fallback:1,max:99});else if(n>0){const c=i/n;Number.isFinite(c)&&c>0&&Number.isInteger(c)?r=R(c,{fallback:1,max:99}):r=Math.min(i,99)}else r=Math.min(i,99);return{equipmentId:t!=null?String(t):null,equipment_id:t,qty:r,quantity:r,qtyPerPackage:r,totalQuantity:i,price:o,unit_price:o,cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,barcode:l,normalizedBarcode:Ze(e.normalizedBarcode??l),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function oi(e={},n={}){const t=W(e.packageId??e.package_id??e.id??n.packageId??n.package_id??n.id??""),i=R(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),o=k(e.unit_price??e.unitPrice??e.price??n.price??n.unit_price??n.unitPrice??0);let s=k(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??n.unit_cost??n.unitCost??n.cost??0);if((!Number.isFinite(s)||s===0)&&Array.isArray(e.packageItems)&&e.packageItems.length){const a=e.packageItems.reduce((r,c)=>{const u=k(c.cost??c.unit_cost??c.unitCost??c.rental_cost??c.purchase_price??c.internal_cost??c.equipment_cost??c.item_cost??0),d=R(c.qty??c.quantity??c.qtyPerPackage??1);return r+u*d},0);a>0&&(s=Number(a.toFixed(2)))}const l=h(String(e.package_code??e.packageCode??e.barcode??n.package_code??n.packageCode??n.barcode??""));return{id:n.id??(e.id!=null?String(e.id):t?`package::${t}`:""),equipmentId:null,barcode:l,desc:n.desc??n.description??e.name??e.desc??e.title??l,qty:i,quantity:i,price:o,cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,notes:n.notes??null,image:e.image??n.image??null,type:"package",packageId:t,package_id:t,package_code:l,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(n.packageItems)?n.packageItems:[]}}function ut(e=[],n=[]){const t=si(e),i=Array.isArray(n)?re(n,t.packages):t.packages,o=new Map;return i.forEach(s=>{const l=W(s.packageId??s.package_id??s.id);l&&o.set(l,s)}),t.packages.forEach(s=>{const l=W(s.packageId??s.package_id??s.id);if(!l)return;const a=o.get(l);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=s.packageItems),!a.name&&s.name&&(a.name=s.name),!a.image&&s.image&&(a.image=s.image))}),{items:t.items,packages:Array.from(o.values())}}function si(e=[]){const n=new Map;if(e.forEach(s=>{const l=W(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(!l)return;const a=l;n.has(a)||n.set(a,{base:s,items:[]}),n.get(a).items.push(s)}),!n.size)return{items:e,packages:[]};const t=[],i=[],o=new Set;return e.forEach(s=>{const l=W(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(l&&n.has(l)){if(o.has(l))return;const a=n.get(l),r=a.base||s,c=a.items.map(m=>Ut(m,1)),u=(()=>{const m=k(r.unit_cost??r.unitCost??r.cost??r.rental_cost??r.internal_cost??r.purchase_price??r.equipment_cost??r.item_cost??0);if(Number.isFinite(m)&&m>0)return m;if(c.length){const y=c.reduce((g,_)=>{const N=k(_.cost??_.unit_cost??_.unitCost??_.rental_cost??_.internal_cost??_.purchase_price??_.equipment_cost??_.item_cost??0),p=R(_.qty??_.quantity??_.qtyPerPackage??1);return g+N*p},0);if(y>0)return Number(y.toFixed(2))}return m})(),d={packageId:l,package_id:l,package_code:r.package_code??r.packageCode??r.barcode??h(String(l)),name:r.package_name??r.packageName??r.desc??r.name??`Package ${l}`,quantity:R(r.package_quantity??r.packageQty??1,{fallback:1,max:9999}),unit_price:k(r.package_price??r.packagePrice??r.price??0),unit_cost:u,unitCost:u,cost:u,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u,packageItems:c,image:r.image??null};i.push(d),t.push(oi(d,r)),o.add(l);return}t.push(s)}),{items:t,packages:i}}function Be(e={},n=""){if(!e||typeof e!="object")return[];const t=W(n||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let o=Pe({...e,id:e.id??t??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??t,items:i,packageItems:i}),s=[];if((!Array.isArray(o)||o.length===0)&&t){const c=_e(t);c&&(o=Pe(c),s=Array.isArray(o)?o:[])}else if(t){const c=_e(t);c&&(s=Pe(c)||[])}if(!Array.isArray(o)||o.length===0)return[];const l=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=o.map(c=>Ut(c,l));if(s.length){const c=new Map;s.forEach(u=>{if(!u)return;const d=Ze(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&c.set(d,u)}),a.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!c.has(d))return;const m=c.get(d),y=R(m.quantity??m.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=y,u.qty=y,u.quantity=y;const g=k(m.unit_price??m.unitPrice??m.price??u.price);u.price=g,u.unit_price=g,!u.desc&&m.desc&&(u.desc=m.desc),!u.image&&m.image&&(u.image=m.image)})}const r=new Map;return a.forEach(c=>{const u=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(u){if(r.has(u)){const d=r.get(u);d.qty+=c.qty,d.quantity+=c.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=c.qtyPerPackage),(!d.price||d.price===0)&&c.price&&(d.price=c.price,d.unit_price=c.unit_price),!d.desc&&c.desc&&(d.desc=c.desc),!d.image&&c.image&&(d.image=c.image);return}r.set(u,{...c})}}),Array.from(r.values())}function Gt(e={},n=[],t=1){try{const s=W(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(s){const l=_e(s);if(l){const a=St(l);if(Number.isFinite(Number(a))&&Number(a)>0)return Number(a)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return k(i);const o=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(o))){const s=k(o);return t>0?Number((s/t).toFixed(2)):s}return 0}function Wt(e,n){if(!e)return n;if(!n)return e;const t={...e},i=l=>{(t[l]===void 0||t[l]===null||t[l]==="")&&(t[l]=n[l])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(t.unit_price))||t.unit_price===0)&&Number.isFinite(Number(n.unit_price))&&(t.unit_price=n.unit_price,t.unitPrice=n.unitPrice,t.price=n.price);const o=k(t.unit_cost??t.unitCost??t.cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost),s=k(n.unit_cost??n.unitCost??n.cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost);if((!Number.isFinite(o)||o===0)&&Number.isFinite(s)){const l=s;t.unit_cost=l,t.unitCost=l,t.cost=l,t.total_cost=Number.isFinite(n.total_cost)?n.total_cost:t.total_cost,Number.isFinite(t.rental_cost)||(t.rental_cost=l),Number.isFinite(t.purchase_price)||(t.purchase_price=l),Number.isFinite(t.internal_cost)||(t.internal_cost=l),Number.isFinite(t.equipment_cost)||(t.equipment_cost=l),Number.isFinite(t.item_cost)||(t.item_cost=l)}return(!Number.isFinite(Number(t.total_price))||t.total_price===0)&&Number.isFinite(Number(n.total_price))&&(t.total_price=n.total_price,t.total=n.total),!Array.isArray(t.packageItems)||t.packageItems.length===0?(t.packageItems=Array.isArray(n.packageItems)?n.packageItems:[],t.items=t.packageItems):Array.isArray(n.packageItems)&&n.packageItems.length&&(t.packageItems=ci(t.packageItems,n.packageItems),t.items=t.packageItems),t}function ci(e=[],n=[]){const t=new Map,i=o=>{o.forEach(s=>{if(!s)return;const l=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(l){if(t.has(l)){const a=t.get(l);a.qty+=s.qty??0,a.quantity+=s.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(s.qtyPerPackage)&&(a.qtyPerPackage=s.qtyPerPackage),(!a.price||a.price===0)&&s.price&&(a.price=s.price,a.unit_price=s.unit_price);const r=k(a.cost??a.unit_cost??a.unitCost??a.rental_cost??a.purchase_price??a.internal_cost??a.equipment_cost??a.item_cost),c=k(s.cost??s.unit_cost??s.unitCost??s.rental_cost??s.purchase_price??s.internal_cost??s.equipment_cost??s.item_cost);if((!Number.isFinite(r)||r===0)&&Number.isFinite(c)){const u=c;a.cost=u,a.unit_cost=u,a.unitCost=u,Number.isFinite(a.rental_cost)||(a.rental_cost=u),Number.isFinite(a.purchase_price)||(a.purchase_price=u),Number.isFinite(a.internal_cost)||(a.internal_cost=u),Number.isFinite(a.equipment_cost)||(a.equipment_cost=u),Number.isFinite(a.item_cost)||(a.item_cost=u)}!a.desc&&s.desc&&(a.desc=s.desc),!a.image&&s.image&&(a.image=s.image);return}t.set(l,{...s})}})};return i(e),i(n),Array.from(t.values())}function re(e=[],n=[]){const t=[],i=new Map,o=tt(),s=new Map;o.forEach(r=>{const c=W(r?.id??r?.packageId??r?.package_id??r?.code??""),u=String(r?.package_code??r?.code??"").trim().toLowerCase();u&&s.set(u,c||u)});const l=r=>{const c=W(r?.packageId??r?.package_id??r?.id??null),u=String(r?.package_code??r?.code??r?.barcode??"").trim().toLowerCase(),d=u?h(u):"";return c||(d&&s.has(d)?s.get(d):d||null)},a=r=>{Array.isArray(r)&&r.forEach(c=>{if(!c||typeof c!="object")return;const u=l(c);if(u)if(i.has(u)){const d=i.get(u);t[d]=Wt(t[d],c)}else i.set(u,t.length),t.push({...c})})};return a(e),a(n),t}function Ue(e){if(e==null)return 0;const n=ue()||{},i=(Array.isArray(n.equipment)?n.equipment:[]).find(s=>[s.id,s.equipment_id,s.equipmentId,s.item_id,s.itemId].some(a=>String(a)===String(e)));if(!i)return 0;const o=k(i.cost??i.unit_cost??i.unitCost??i.rental_cost??i.purchase_price??i.internal_cost??i.equipment_cost??i.item_cost??0);return Number.isFinite(o)&&o>0?o:0}function Yt(e,n=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const g=W(e),_=g?_e(g):null,N=_?Be(_,g):[],p=_?k(_.price??_.unit_price??_.unitPrice??0):0,P=(()=>{const q=_?.unit_cost??_?.unitCost??_?.cost??_?.rental_cost??_?.internal_cost??_?.purchase_price??_?.equipment_cost??_?.item_cost;if(Number.isFinite(Number(q)))return k(q);if(Array.isArray(N)&&N.length){const L=N.reduce((B,w)=>{const f=k(w.cost??w.unit_cost??w.unitCost??w.rental_cost??w.internal_cost??w.purchase_price??w.equipment_cost??w.item_cost??0),U=R(w.qty??w.quantity??w.qtyPerPackage??1);return B+f*U},0);if(L>0)return Number(L.toFixed(2))}return 0})(),I=1,S=Number((p*I).toFixed(2)),A=Number((P*I).toFixed(2));return{id:`package::${g||n}`,packageId:g||`pkg-${n}`,package_id:g||`pkg-${n}`,package_code:h(String(e))||g||`pkg-${n}`,name:_?.name??_?.package_name??_?.packageName??h(String(e))??"",desc:_?.name??h(String(e))??"",quantity:I,qty:I,unit_price:p,unitPrice:p,price:p,unit_cost:P,unitCost:P,cost:P,total_cost:A,rental_cost:P,purchase_price:P,internal_cost:P,equipment_cost:P,item_cost:P,total:S,total_price:S,barcode:h(String(e)),packageItems:N,items:N,type:"package",image:_?.image??null}}if(typeof e!="object")return null;const t=W(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${n}`,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),o=Be(e,t),s=Gt(e,o,i),a=(()=>{const g=e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost;if(Number.isFinite(Number(g)))return k(g);if(Array.isArray(o)&&o.length){const _=o.reduce((N,p)=>{const b=k(p.cost??p.unit_cost??p.unitCost??p.rental_cost??p.internal_cost??p.purchase_price??p.equipment_cost??p.item_cost??0),P=R(p.qtyPerPackage??p.qty??p.quantity??p.count??1);return N+b*P},0);if(_>0)return Number(_.toFixed(2))}return 0})(),r=e.total_price??e.totalPrice??e.total??s*i,c=Number.isFinite(Number(r))?k(r):Number((s*i).toFixed(2)),u=Number.isFinite(a)?Number((a*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??t,m=h(String(e.barcode??d??"")),y=e.image??e.cover??e.thumbnail??o.find(g=>g.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,packageId:t,package_id:t,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??t,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??t,quantity:i,qty:i,unit_price:s,unitPrice:s,price:s,unit_cost:a,unitCost:a,cost:a,total_cost:u,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,total:c,total_price:c,barcode:m,packageItems:o,items:o,type:"package",image:y}}function dt(e={}){const n=[];Array.isArray(e.packages)&&n.push(e.packages),Array.isArray(e.reservation_packages)&&n.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&n.push(e.reservationPackages),Array.isArray(e.package_details)&&n.push(e.package_details),Array.isArray(e.packageDetails)&&n.push(e.packageDetails),Array.isArray(e.package_list)&&n.push(e.package_list),Array.isArray(e.packageList)&&n.push(e.packageList);const t=[],i=new Map,o=(a,r=t.length)=>{const c=Yt(a,r);if(!c)return;const u=c.packageId||c.package_code||c.id||`pkg-${r}`;if(i.has(u)){const d=i.get(u);t[d]=Wt(t[d],c)}else i.set(u,t.length),t.push(c)};n.forEach(a=>{a.forEach((r,c)=>{o(r,c+t.length)})}),t.length===0&&e.package&&o(e.package,0);const s=Array.isArray(e.items)?e.items:[],l=(a={})=>!a||typeof a!="object"?!1:!!(Qt(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(c=>typeof c=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return s.forEach((a,r)=>{l(a)&&o(a,t.length+r)}),t}function k(e){const n=D(e);return Number.isFinite(n)?Number(n.toFixed(2)):0}function R(e,{fallback:n=1,max:t=1e6}={}){const i=D(e);if(!Number.isFinite(i))return n;const o=Math.round(i);return o<=0||o>t?n:o}function ri(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function li(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function ui(e){return e instanceof en}const Ai=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:ti,closeReservationApi:ei,confirmReservationApi:Zn,createReservationApi:Wn,deleteReservationApi:Xn,getCachedReservationCrew:Kn,getReservationsState:Un,isApiError:ui,mapLegacyReservation:Kt,mapReservationFromApi:Ve,mapReservationItem:Oe,refreshReservationsFromApi:Gn,setReservationsState:Ee,toInternalReservation:He,updateReservationApi:ct},Symbol.toStringTag,{value:"Module"}));export{He as A,Dn as B,qn as C,$t as D,D as E,$ as F,Kn as G,_i as H,hn as I,yi as J,Kt as K,In as L,Zn as M,ei as N,Ai as O,Ni as a,wn as b,it as c,Ie as d,at as e,Xn as f,Un as g,Pi as h,mi as i,bi as j,bn as k,xn as l,Ve as m,Tt as n,Cn as o,Fn as p,An as q,Gn as r,fi as s,ti as t,ct as u,Wn as v,ui as w,gi as x,ft as y,hi as z};
