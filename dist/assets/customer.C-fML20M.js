const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.CKp_Y2ri.js","./controller.vamJz6T5.js","./auth.TVJ8X2CT.js","./auth.BbS386zB.css","./details.BFR8N4JX.js","./state.BcSvKqfh.js","./reservationsService.DbQdg0Yk.js","./equipment.s3mi8kik.js","./reservationPdf.X4OS_gEL.js","./view.BH-BD-0N.js","./quotePdf.BXe1f9wz.js","./canvasColorUtils.CviLtv6S.js","./reservationsActions.DhRL-rkR.js","./projectsService.C-t3q7Yb.js","./uiBridge.BLZZT8b9.js"])))=>i.map(i=>d[i]);
import{r as le,n as k,d as H,t as d,a as de,c as ue,i as me,m as pe,l as fe,b as yt,A as ye,j as ft,h as tt}from"./auth.TVJ8X2CT.js";import"./dashboard.Dlrcx1MH.js";import{o as ge}from"./projectDetails.CcScnQKQ.js";import{_ as te,s as he}from"./uiBridge.BLZZT8b9.js";import{r as Nt}from"./reservationPdf.X4OS_gEL.js";import{d as ve,f as vt,m as De}from"./state.BcSvKqfh.js";import{g as Ee,b as be,r as Ae,a as Rt,P as Ie}from"./projectFocusTemplates.BAaXWOoJ.js";import{getProjectsState as xe,mapProjectFromApi as ke}from"./projectsService.C-t3q7Yb.js";import{g as Se,c as Ft,m as je}from"./reservationsService.DbQdg0Yk.js";import{d as Mt,s as Dt}from"./view.BH-BD-0N.js";import{i as Ne}from"./dashboardShell.DF2kUed9.js";import"./quotePdf.BXe1f9wz.js";import"./canvasColorUtils.CviLtv6S.js";le({ar:{"customerDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.title":"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.hero.subtitle":"ğŸ‘‹ Ù‡Ø°Ù‡ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.fields.taxId":"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:","customerDetails.fields.document":"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.reservations":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.stats.upcoming":"Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.projects":"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerDetails.stats.projectsEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.stats.lastActivity":"Ø¢Ø®Ø± Ù†Ø´Ø§Ø·","customerDetails.stats.lastActivityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.reservationsDesc":"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ","customerDetails.stats.upcomingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.nextReservation":"Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}","customerDetails.stats.projectsDesc":"Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.payment":"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentBreakdown":"Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentPaid":"Ø§Ù„Ù…Ø¯ÙÙˆØ¹","customerDetails.stats.paymentOutstandingLabel":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.totalValue":"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: {amount}","customerDetails.stats.totalValueEmpty":"Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ù…Ø¨Ø§Ù„Øº Ø¨Ø¹Ø¯.","customerDetails.stats.paymentOutstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}","customerDetails.stats.paymentAllSet":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.paymentOutstandingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.activityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.activityOn":"Ø¨ØªØ§Ø±ÙŠØ® {date}","customerDetails.stats.activityType.reservation":"Ø­Ø¬Ø²","customerDetails.stats.activityType.project":"Ù…Ø´Ø±ÙˆØ¹","customerDetails.stats.activityType.customer":"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.complianceEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©","customerDetails.stats.complianceProjects":"Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}","customerDetails.stats.complianceLabel.excellent":"Ø§Ù„ØªØ²Ø§Ù… Ù…Ù…ØªØ§Ø²","customerDetails.stats.complianceLabel.good":"Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯","customerDetails.stats.complianceLabel.average":"ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©","customerDetails.stats.complianceLabel.poor":"ØªØ£Ø®ÙŠØ± Ù…ØªÙƒØ±Ø±","customerDetails.document.open":"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯","customerDetails.document.defaultName":"Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·","customerDetails.primaryNav.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.primaryNav.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerTabs.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.customerReservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerTabs.customerProjects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","customerDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²...","customerDetails.fields.name":"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:","customerDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","customerDetails.fields.company":"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:","customerDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","customerDetails.fields.address":"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:","customerDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","customerDetails.toast.missingRequired":"âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†","customerDetails.toast.notFound":"âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","customerDetails.toast.updateSuccess":"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...","customerDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.loadFailed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","customerDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"ğŸ‘¤ Client Profile","customerDetails.hero.subtitle":"ğŸ‘‹ Here is a quick look at this client","customerDetails.fields.taxId":"ğŸ§¾ Tax Number:","customerDetails.fields.document":"ğŸ“ Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"ğŸ“… Booking Management","customerDetails.primaryNav.projects":"ğŸ“ Project Management","customerTabs.reservations":"ğŸ“… Booking Management","customerTabs.projects":"ğŸ“ Project Management","customerTabs.customerReservations":"ğŸ“… Client Reservations","customerTabs.customerProjects":"ğŸ“ Client Projects","customerDetails.actions.back":"â¬…ï¸ Back","customerDetails.actions.edit":"âœï¸ Edit Client","customerDetails.filters.search":"ğŸ” Search by client or reservation ID...","customerDetails.fields.name":"ğŸ‘¤ Name:","customerDetails.fields.phone":"ğŸ“ Phone:","customerDetails.fields.company":"ğŸ¢ Company:","customerDetails.fields.email":"ğŸ“§ Email:","customerDetails.fields.address":"ğŸ“ Address:","customerDetails.fields.notes":"ğŸ“ Notes:","customerDetails.toast.missingRequired":"âš ï¸ Name and phone are required","customerDetails.toast.notFound":"âš ï¸ Client not found","customerDetails.toast.updateSuccess":"âœ… Client information updated","customerDetails.status.loading":"â³ Loading client information...","customerDetails.errors.notFound":"âš ï¸ This client could not be found.","customerDetails.errors.loadFailed":"âš ï¸ Failed to load client information.","customerDetails.errors.missingId":"âš ï¸ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"âœï¸ Edit Client","customerProjects.title":"ğŸ“ Client Projects","customerProjects.empty":"No projects are linked to this client."}});let Et={},j={initialized:!1,currentId:null,modal:{el:null,body:null}};function It(t=""){return k(String(t)).trim().toLowerCase()}function ee(t,a,e){if(!a||!e)return;const{startDate:s,endDate:o}=Nt(t);a._flatpickr?s?a._flatpickr.setDate(s,!1,"Y-m-d"):a._flatpickr.clear():a.value=s||"",e._flatpickr?o?e._flatpickr.setDate(o,!1,"Y-m-d"):e._flatpickr.clear():e.value=o||""}function $t(t,{endOfDay:a=!1}={}){if(!t)return null;const e=String(t).trim();if(!e)return null;const s=e.includes("T")?e:`${e}T00:00:00`,o=new Date(s);return Number.isNaN(o.getTime())?null:(a?o.setHours(23,59,59,999):o.setHours(0,0,0,0),o)}function bt(t){const a=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const e of a){if(!e)continue;const s=new Date(e);if(!Number.isNaN(s.getTime()))return s.setHours(0,0,0,0),s}return null}function gt(t){if(!document.getElementById("customer-reservations"))return;const e=document.getElementById("customer-search-reservation"),s=document.getElementById("customer-filter-start-date"),o=document.getElementById("customer-filter-end-date"),i=document.getElementById("customer-reservation-date-range"),c=document.getElementById("customer-reservation-status-filter"),f=document.getElementById("customer-clear-filters");window.flatpickr&&(s&&window.flatpickr(s,{dateFormat:"Y-m-d"}),o&&window.flatpickr(o,{dateFormat:"Y-m-d"}));const u=()=>{let g=k(s?.value||"").trim(),D=k(o?.value||"").trim(),h=i?.value||"";if(new Set(["","today","week","month"]).has(h)||(h="",i&&(i.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),o&&(o._flatpickr&&o._flatpickr.clear(),o.value=""),g="",D=""),!g&&!D&&h){const{startDate:E,endDate:N}=Nt(h);g=E,D=N}return{searchTerm:It(e?.value||""),startDate:g,endDate:D,status:c?.value||"",quickRange:h,customerId:t}},m=()=>{Et=u(),wt("customer-reservations",Et)};e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=k(e.value),m()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{i&&(i.value=""),m()}),s.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{i&&(i.value=""),m()}),o.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ee(i.value,s,o),m()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",m),c.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{e&&(e.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),o&&(o._flatpickr&&o._flatpickr.clear(),o.value=""),i&&(i.value=""),c&&(c.value=""),m()}),f.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{wt("customer-reservations",Et)},m()}function et(t){j.currentId=t;const{container:a}=X();a&&(j.initialized||(Te(),_e(),Pe(),document.addEventListener("projects:changed",()=>{j.currentId&&C()}),document.addEventListener("language:changed",()=>{j.currentId&&C()}),document.addEventListener("technicians:updated",()=>{j.currentId&&C()}),j.initialized=!0),C())}function X(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Te(){const{searchInput:t,statusSelect:a,clearBtn:e,startInput:s,endInput:o,rangeSelect:i}=X();window.flatpickr&&(s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true"),o&&!o.dataset.datepickerAttached&&(window.flatpickr(o,{dateFormat:"Y-m-d"}),o.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=k(t.value),C()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{C()}),a.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=k(s.value),i&&(i.value=""),C()}),s.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{o.value=k(o.value),i&&(i.value=""),C()}),o.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ee(i.value,s,o),C()}),i.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{const{searchInput:c,statusSelect:f,startInput:u,endInput:m,rangeSelect:g}=X();c&&(c.value=""),f&&(f.value=""),g&&(g.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),m&&(m._flatpickr&&m._flatpickr.clear(),m.value=""),C()}),e.dataset.listenerAttached="true")}function _e(){const{container:t}=X();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Be),t.dataset.projectModalListenerAttached="true")}function Be(t){const a=t.target.closest(".project-focus-card");if(!a)return;const e=a.dataset.projectId?String(a.dataset.projectId):"";e&&se(e)}function Pe(){ae()}function ae(){if(j.modal?.el&&j.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");if(!t||!a){const o=document.createElement("div");o.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${d("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(o.firstElementChild)}const e=document.getElementById("projectDetailsModal"),s=document.getElementById("project-details-body");return!e||!s?!1:(j.modal={el:e,body:s},!0)}function C(){const{container:t,searchInput:a,statusSelect:e,startInput:s,endInput:o,rangeSelect:i}=X();if(!t||!j.currentId)return;const c=It(a?.value||""),f=e?.value||"";let u=k(s?.value||"").trim(),m=k(o?.value||"").trim(),g=i?.value||"";if(new Set(["","today","week","month"]).has(g)||(g="",i&&(i.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),o&&(o._flatpickr&&o._flatpickr.clear(),o.value=""),u="",m=""),!u&&!m&&g){const{startDate:p,endDate:I}=Nt(g);u=p,m=I}const h=$t(u),v=$t(m,{endOfDay:!0}),{projects:E=[],technicians:N=[],reservations:P=[],customers:b=[]}=H(),_=new Map(N.map(p=>[String(p.id),p])),S=Le(P),A=b.find(p=>String(p.id)===String(j.currentId))||null,at=E.filter(p=>String(p.clientId)===String(j.currentId)).filter(p=>{if(c){const I=[p.id,p.projectId,p.project_id,p.projectCode,p.project_code].map(n=>n==null?"":k(String(n)));if(!It([p.title,p.description,p.notes,...I].filter(Boolean).join(" ")).includes(c))return!1}if(f&&ve(p)!==f)return!1;if(h||v){const I=bt(p);if(!I||h&&I<h||v&&I>v)return!1}return!0}).sort((p,I)=>{const B=bt(p)?.getTime()||0;return(bt(I)?.getTime()||0)-B});if(!at.length){const p=d("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${p}</div></div>`;return}t.innerHTML=at.map(p=>{const I=Ee(p),B=I?S.get(I)||[]:[];return be(p,{customer:A,techniciansMap:_,reservations:B})}).join(""),t.querySelectorAll(".project-focus-card").forEach(p=>{p.dataset.customerModalListenerAttached!=="true"&&(p.addEventListener("click",I=>{const B=p.dataset.projectId?String(p.dataset.projectId):"";if(B){try{console.debug("[customer] project card click",B)}catch{}se(B)}}),p.dataset.customerModalListenerAttached="true")})}function Le(t=[]){const a=new Map;return t.forEach(e=>{const s=e?.projectId??e?.project_id??e?.projectID;if(s==null)return;const o=String(s);a.has(o)||a.set(o,[]),a.get(o).push(e)}),a}function se(t){const a=String(t||"").trim();if(!a||!ae())return;const{projects:e=[],reservations:s=[],customers:o=[]}=H(),i=j.modal;Mt.detailsModalEl=i.el,Mt.detailsBody=i.body;const c=xe(),f=Se(),u=Array.isArray(c)?c.some(m=>String(m?.id)===a):!1;Dt.projects=Array.isArray(c)&&c.length&&u?c:e||[],Dt.reservations=Array.isArray(f)&&f.length?f:s||[],Dt.customers=o||[],ge(a);try{if(!(window.bootstrap&&window.bootstrap.Modal)&&j.modal?.el){const m=j.modal.el;m.classList.add("show"),m.style.display="block",m.removeAttribute("aria-hidden")}}catch{}}async function wt(t,a){try{const e=await te(()=>import("./reservationsUI.CKp_Y2ri.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url);try{e.renderReservations?.(t,a)}catch(s){console.error("âŒ [customer-details] renderReservations failed",s)}}catch(e){console.error("âŒ [customer-details] Failed to load reservations UI module",e)}}de();ue();me();Ne();pe();const st=document.getElementById("logout-btn");st&&!st.dataset.listenerAttached&&(st.addEventListener("click",()=>fe()),st.dataset.listenerAttached="true");he({showReservationDetails(t){te(()=>import("./reservationsUI.CKp_Y2ri.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url).then(a=>{try{a.showReservationDetails?.(t)}catch(e){console.error("âŒ showReservationDetails failed",e)}}).catch(a=>console.error("âŒ Failed to load reservations UI module",a))}});const Ce=new URLSearchParams(window.location.search),x=Ce.get("id"),z=document.getElementById("customer-details"),Ot=document.getElementById("customer-hero-name"),Re=document.getElementById("customer-hero-phone"),Fe=document.getElementById("customer-hero-company"),Me=document.getElementById("customer-hero-email"),$e=document.getElementById("customer-hero-tax"),Ut=document.getElementById("customer-hero-summary"),zt=document.getElementById("dashboard-greeting-customer-name"),Ht=document.getElementById("dashboard-greeting-customer-company"),nt=document.getElementById("customer-stat-projects"),ot=document.getElementById("customer-stat-projects-desc"),it=document.getElementById("customer-stat-payment"),rt=document.getElementById("customer-stat-payment-desc"),ct=document.getElementById("customer-stat-upcoming"),lt=document.getElementById("customer-stat-upcoming-desc"),K=document.getElementById("customer-stat-activity"),dt=document.getElementById("customer-stat-activity-desc"),ut=document.getElementById("customer-stat-compliance"),Q=document.getElementById("customer-stat-compliance-desc"),Vt=document.getElementById("sidebar-stat-projects"),qt=document.getElementById("sidebar-stat-reservations"),Yt=document.getElementById("sidebar-stat-equipment"),Wt=document.getElementById("sidebar-stat-technicians"),Tt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),xt=Array.from(document.querySelectorAll("[data-customer-tab]")),we=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),O=document.getElementById("edit-document-file"),q=document.getElementById("edit-document-preview"),Kt=document.getElementById("edit-document-file-name"),G=document.getElementById("edit-document-url"),Z=document.getElementById("edit-document-name");let T=null,R="idle",M=null;Tt.forEach(t=>{t.disabled=!0});let l=null,J=!1,$="",_t="reservations";function L(t=""){const a=document.createElement("div");return a.textContent=t==null?"":String(t),a.innerHTML}function Oe(t=""){const a=L(t).replace(/\r/g,""),e=`
`;return a.includes(e)?a.split(e).join("<br>"):a}function Ue(t=null){M=t&&typeof t=="object"?{...t}:null,T=null,R="idle",O&&(O.value=""),V()}function V(){if(!Kt||!q)return;const t=R==="uploading",a=!!T?.dataUrl;let e=d("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?e=d("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):R==="error"?e=d("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):a?e=T?.fileName||d("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):M&&(M.fileName||M.url)&&(e=M.fileName||M.url),Kt.textContent=e;const s=a||!!M?.url;q.disabled=t||!s}function ze(){if(!O)return;const[t]=O.files||[];if(!t){R="idle",T=null,V();return}R="uploading",V();const a=new FileReader;a.onload=()=>{if(typeof a.result!="string"){R="error",T=null,V();return}T={dataUrl:a.result,fileName:t.name,mimeType:t.type,size:t.size},G&&(G.value=a.result),Z&&(Z.value=t.name),R="success",V()},a.onerror=()=>{R="error",T=null,V()},a.readAsDataURL(t)}O&&!O.dataset.listenerAttached&&(O.addEventListener("change",ze),O.dataset.listenerAttached="true");q&&!q.dataset.listenerAttached&&(q.addEventListener("click",()=>{if(R==="uploading")return;const t=T?.dataUrl||M?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),q.dataset.listenerAttached="true");function mt(t,a,e,{hideWhenEmpty:s=!1}={}){if(!t)return;const o=e==null?"":String(e).trim(),i=o.length>0,c=i?o:"â€”";t.textContent=`${a} ${c}`,s?t.classList.toggle("hidden",!i):t.classList.remove("hidden")}function kt(t){const a=d("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),e=t?.customerName||"â€”",s=t?.phone?k(t.phone):"",o=t?.companyName||"",i=t?.email||"",c=t?.tax_id??t?.taxId??"";if(Ot&&(Ot.textContent=e),Ut&&(Ut.textContent=e!=="â€”"?e:a),mt(Re,"ğŸ“",s,{hideWhenEmpty:!1}),mt(Fe,"ğŸ¢",o,{hideWhenEmpty:!0}),mt(Me,"ğŸ“§",i,{hideWhenEmpty:!0}),mt($e,"ğŸ§¾",c,{hideWhenEmpty:!0}),zt&&(zt.textContent=e),Ht){const f=[];o&&f.push(o),s&&f.push(`ğŸ“ ${s}`);const u=typeof c=="string"?c.trim():String(c||"").trim();u&&f.push(`ğŸ§¾ ${u}`),Ht.textContent=f.length?f.join(" â€¢ "):"â€”"}}function He(t){if(t?.preventDefault?.(),!l)return;aa();const a=document.getElementById("editCustomerModal"),e=typeof bootstrap<"u"?bootstrap.Modal:null;if(!a||!e)return;(e.getInstance(a)||new e(a)).show()}function Ve(){Tt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",He),t.dataset.listenerAttached="true")})}function St(t){Tt.forEach(a=>{a&&(a.disabled=!!t)})}Ve();function jt(t){t&&(_t=t,xt.forEach(a=>{const e=a?.getAttribute("data-customer-tab")===t;a&&(a.classList.toggle("tab-active",e),a.classList.toggle("active",e),a.setAttribute("aria-selected",String(e)))}),we.forEach((a,e)=>{a&&a.classList.toggle("hidden",e!==t)}),t==="projects"&&x&&l&&et(x))}function qe(){xt.length&&(xt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const a=t.getAttribute("data-customer-tab");a&&jt(a)}),t.dataset.listenerAttached="true")}),jt(_t))}qe();function ne(t={}){if(!t||typeof t!="object")return null;const a=[t.document,t.attachment,t.file].find(S=>S&&typeof S=="object"),e=S=>{for(const A of S)if(typeof A=="string"&&A.trim()!=="")return A.trim();return""},s=S=>{for(const A of S){if(typeof A=="number"&&Number.isFinite(A))return Math.max(0,Math.trunc(A));if(typeof A=="string"&&A.trim()!==""&&/^\d+$/.test(A.trim()))return Math.max(0,parseInt(A.trim(),10))}return null},o=[t.document_url,t.documentUrl,t.url,t.href,t.link,a?.url,a?.href,a?.link],i=[t.document_path,t.documentPath,t.path,a?.path,a?.documentPath],c=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,a?.fileName,a?.filename,a?.name],f=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,a?.mimeType,a?.contentType,a?.type],u=[t.document_size,t.documentSize,t.size,a?.size,a?.length],m=[a?.data,a?.base64,a?.content,t.data,t.base64,t.content,t.document_data],g=e(o),D=e(c),h=e(f)||"application/octet-stream",v=e(i),E=e(m),N=s(u);if(!g&&!E)return null;let P=g,b=E;if(!P&&b&&b.startsWith("data:")){const S=b.indexOf(",");S!==-1&&(P=b,b=b.slice(S+1))}!P&&b&&(P=`${b.startsWith("data:")?"":`data:${h};base64,`}${b}`);const _={url:P,fileName:D,mimeType:h,path:v,data:b||null,size:N};return _.url&&/sirv\.com/i.test(_.url)&&(_.source="sirv"),_}function Ye(){return document.documentElement.getAttribute("lang")||"ar"}function F(t){const a=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(a)}catch{return String(a)}}function Qt(t){if(!t)return"â€”";const a=t instanceof Date?t:new Date(t);if(Number.isNaN(a.getTime()))return"â€”";const s=Ye()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(s,{dateStyle:"medium"}).format(a)}catch{const i=String(a.getMonth()+1).padStart(2,"0"),c=String(a.getDate()).padStart(2,"0"),f=a.getFullYear();return`${i}/${c}/${f}`}}function Jt(t){if(!t)return"";const a=t.trim().split(/\s+/),e=a.pop()||"";return`<span class="currency-amount">${a.join(" ")}</span> <span class="currency-unit currency-unit--sm">${e}</span>`}function Xt(t,a){const e=d("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),s=d("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${e}</span>
      ${Jt(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${s}</span>
      ${Jt(a)}
    </div>
  `}const Gt={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},We={reservation:"Reservation",project:"Project",customer:"Client record"};function At(t=[]){let a=null;return t.forEach(e=>{if(!e)return;const s=e instanceof Date?e:new Date(e);Number.isNaN(s.getTime())||(!a||s>a)&&(a=s)}),a}function Ke(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function Zt({projects:t=0,reservations:a=0,equipment:e=0,technicians:s=0}={}){Vt&&(Vt.textContent=F(t)),qt&&(qt.textContent=F(a)),Yt&&(Yt.textContent=F(e)),Wt&&(Wt.textContent=F(s))}function U(){if(!l||!x){const n=vt(0);if(nt&&(nt.textContent="0"),ot&&(ot.textContent=d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),it&&(it.innerHTML=Xt(n,n)),rt){const r=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),y=d("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");rt.textContent=`${r} â€¢ ${y}`}ct&&(ct.textContent="0"),lt&&(lt.textContent=d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),K&&(K.textContent="â€”"),dt&&(dt.textContent=d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),ut&&(ut.textContent="0%"),Q&&(Q.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),Zt({projects:0,reservations:0,equipment:0,technicians:0});return}const t=H(),e=(Array.isArray(t.reservations)?t.reservations:[]).filter(n=>n?[n.customerId,n.customer_id,n.customer?.id].some(y=>y!=null&&String(y)===String(x)):!1),s=e.length,o=Date.now(),i=e.filter(n=>{const r=n?.start??n?.startDatetime??n?.start_datetime??n?.start_date;if(!r)return!1;const y=new Date(r);return Number.isNaN(y.getTime())?!1:y.getTime()>=o}),c=i.map(n=>n?.start??n?.startDatetime??n?.start_datetime).map(n=>new Date(n)).filter(n=>!Number.isNaN(n.getTime())).sort((n,r)=>n-r)[0]||null,u=(Array.isArray(t.projects)?t.projects:[]).filter(n=>n?[n.clientId,n.client_id,n.customer_id].some(y=>y!=null&&String(y)===String(x)):!1),m=u.length,g=e.filter(n=>{const r=String(n?.status||n?.reservationStatus||"").toLowerCase();return!(r==="cancelled"||r==="canceled"||r==="Ù…Ù„ØºÙŠ"||r==="Ù…Ù„ØºÙ‰"||r==="Ù…Ù„ØºÙŠØ©")}),D=new Map;g.forEach(n=>{const r=n?.projectId??n?.project_id??null;if(r==null)return;const y=String(r);D.has(y)||D.set(y,[]),D.get(y).push(n)});let h=0,v=0,E=0,N=0;u.forEach(n=>{const r=Ae(n)||{},y=n?.id??n?.projectId??n?.project_id??null,W=(y!=null?D.get(String(y))||[]:[]).reduce((ce,Ct)=>ce+(Number(Ct?.totalAmount)||Rt(Ct)||0),0),ie=r.applyTax?Number(((Number(r.subtotal||0)+W)*Ie).toFixed(2)):0,Bt=Number((Number(r.subtotal||0)+W+ie).toFixed(2)),re=Ft({totalAmount:Bt,paidAmount:Number(n?.paidAmount)||null,paidPercent:Number(n?.paidPercent)||null}),Pt=Math.max(0,Number(re.paidAmount||0)),Lt=Math.max(0,Number((Bt-Pt).toFixed(2)));h+=Pt,v+=Lt,N+=1,Lt<=.5&&(E+=1)}),g.filter(n=>n?.projectId==null&&n?.project_id==null).forEach(n=>{const r=Number(n?.totalAmount)||Rt(n)||0,y=Ft({totalAmount:r,paidAmount:Number(n?.paidAmount)||null,paidPercent:Number(n?.paidPercent)||null,progressType:n?.paymentProgressType??null,progressValue:n?.paymentProgressValue??null,history:Array.isArray(n?.paymentHistory)?n.paymentHistory:[]}),ht=Math.max(0,Number(y.paidAmount||0)),W=Math.max(0,Number((r-ht).toFixed(2)));h+=ht,v+=W,N+=1,W<=.5&&(E+=1)});const b=N>0?Math.round(E/N*100):0,_=[];if(e.forEach(n=>{const r=At([n?.updatedAt,n?.updated_at,n?.end,n?.endDatetime,n?.end_datetime,n?.start,n?.startDatetime,n?.start_datetime,n?.createdAt,n?.created_at]);r&&_.push({date:r,type:"reservation"})}),u.forEach(n=>{const r=At([n?.updatedAt,n?.updated_at,n?.end,n?.end_datetime,n?.start,n?.start_datetime,n?.createdAt,n?.created_at]);r&&_.push({date:r,type:"project"})}),!_.length){const n=At([l?.updated_at,l?.updatedAt,l?.created_at,l?.createdAt]);n&&_.push({date:n,type:"customer"})}const S=_.reduce((n,r)=>n?r.date>n.date?r:n:r,null),A=S?.date??null,Y=S?.type??null,at=e.reduce((n,r)=>Array.isArray(r?.items)?n+r.items.length:n,0),p=new Set;e.forEach(n=>{Array.isArray(n?.technicians)&&n.technicians.forEach(r=>{const y=r!=null?String(r):"";y&&p.add(y)}),Array.isArray(n?.techniciansDetails)&&n.techniciansDetails.forEach(r=>{const y=r?.id??r?.technician_id??r?.technicianId;y!=null&&p.add(String(y))})}),nt&&(nt.textContent=F(m)),ot&&(ot.textContent=m>0?d("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const I=vt(h),B=vt(v);if(it&&(it.innerHTML=Xt(I,B)),rt){const n=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),r=v>0?d("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",B):d("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");rt.textContent=`${n} â€¢ ${r}`}if(ct&&(ct.textContent=F(i.length)),lt&&(lt.textContent=i.length>0&&c?d("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",Qt(c)):d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),K)if(Y){const n=d(`customerDetails.stats.activityType.${Y}`,We[Y]||Y);K.textContent=n}else K.textContent="â€”";if(dt&&(dt.textContent=A?d("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",Qt(A)):d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),ut&&(ut.textContent=`${F(b)}%`),Q)if(N>0){const n=b>=90?"excellent":b>=70?"good":b>=40?"average":"poor",r=n?d(`customerDetails.stats.complianceLabel.${n}`,Gt[n]||Gt.poor):"",y=d("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",F(E)).replace("{total}",F(N));Q.textContent=r?`${r} â€¢ ${y}`:y}else Q.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");Zt({projects:m,reservations:s,equipment:at,technicians:p.size})}function Qe(t){const{customers:a}=H();if(!Array.isArray(a))return null;const e=a.find(c=>String(c.id)===String(t));if(!e)return null;const s=e.tax_id??e.taxId??"",o=typeof s=="string"?s.trim():String(s||"").trim(),i=e.document??ne(e);return{...e,tax_id:o,taxId:o,document:i}}function Je(t={}){if(!t||typeof t!="object")return null;const a=t.id??t.customerId??t.customer_id??null,e=t.full_name??t.customerName??t.name??"",s=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",o=typeof s=="string"?s.trim():String(s||"").trim(),i=ne(t);return a==null?null:{id:String(a),customerName:e,full_name:e,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:o,taxId:o,document:i,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Xe(t){if(!t)return;const a=H(),e=Array.isArray(a.customers)?[...a.customers]:[],s=e.findIndex(o=>String(o.id)===String(t.id));s>=0?e[s]={...e[s],...t}:e.push(t),tt({customers:e})}async function Ge(){const{technicians:t}=H();if(!(Array.isArray(t)&&t.length>0))try{const a=await yt("/technicians/"),e=Array.isArray(a?.data)?a.data.map(De):[];e.length>0&&tt({technicians:e})}catch(a){console.warn("âš ï¸ Failed to load technicians list",a)}}async function Ze(t){if(t)try{const a=new URLSearchParams({customer_id:String(t),limit:"200"}),e=await yt(`/reservations/?${a.toString()}`),s=Array.isArray(e?.data)?e.data.map(je):[];tt({reservations:s})}catch(a){console.warn("âš ï¸ Failed to load customer reservations",a)}}async function ta(t){if(t)try{const a=new URLSearchParams({client_id:String(t),limit:"200"}),e=await yt(`/projects/?${a.toString()}`),s=Array.isArray(e?.data)?e.data.map(ke):[];tt({projects:s})}catch(a){console.warn("âš ï¸ Failed to load customer projects",a)}}async function ea(t,{showSpinner:a=!1}={}){if(t){a?(J=!0,$="",w()):(J=!0,$="");try{const e=await yt(`/customers/?id=${encodeURIComponent(t)}`),s=e?.data??e,o=Je(s);if(!o)throw new Error("Invalid customer payload received from server");l=o,Xe(o),J=!1,$="",w(),await Ge(),await Promise.all([Ze(o.id),ta(o.id)]),gt(o.id),et(o.id),U()}catch(e){if(J=!1,e instanceof ye&&e.status===404){l=null,$="",w();return}console.error("âš ï¸ Failed to load customer details",e);const s=d("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");l?($="",ft(s),w()):($=`${s}${e?.message?` (${e.message})`:""}`,w())}}}function w(){if(!z)return;if(jt(_t),!l){if(kt(null),St(!0),U(),J){z.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if($){z.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${L($)}</div>
        </div>
      `;return}const e=d("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");z.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${L(e)}</div>
      </div>
    `;return}kt(l),St(!1);const a=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:l.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:l.phone?k(l.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:l.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:l.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:l.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:l.tax_id??l.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:l.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:l.document??null,type:"document"}].map(e=>{const s=d(e.key,e.fallback);if(e.type==="document"){const u=e.value;let m='<span class="text-base-content/50">â€”</span>';if(u&&typeof u=="object"){const g=u.fileName?.trim()||u.path?.trim()||u.url||"";if(u.url){const D=L(g||d("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),h=Ke(u.url),v=L(d("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));m=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${D}</span><a class="btn btn-outline btn-sm" href="${h}" target="_blank" rel="noopener noreferrer">${v}</a></div>`}else g&&(m=`<span class="text-base-content break-all">${L(g)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${L(s)}</span>
          <div class="mt-2">${m}</div>
        </article>
      `}const i=(e.value==null?"":String(e.value)).trim(),c=i.length>0?i:"â€”",f=e.multiline?Oe(c):L(c);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${L(s)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${f}</p>
      </article>
    `}).join("");z.innerHTML=a,U()}function aa(){document.getElementById("edit-id").value=l?.id||"",document.getElementById("edit-name").value=l?.customerName||"",document.getElementById("edit-phone").value=k(l?.phone||""),document.getElementById("edit-company").value=l?.companyName||"",document.getElementById("edit-email").value=l?.email||"",document.getElementById("edit-address").value=l?.address||"",document.getElementById("edit-tax-id").value=k(l?.tax_id??l?.taxId??"");const t=l?.document??null;G&&(G.value=t?.url||""),Z&&(Z.value=t?.fileName||""),Ue(t),document.getElementById("edit-notes").value=l?.notes||""}const pt=document.getElementById("save-edit-btn");pt&&!pt.dataset.listenerAttached&&(pt.addEventListener("click",()=>{if(!l)return;const t=document.getElementById("edit-id").value,a=document.getElementById("edit-name").value.trim(),e=k(document.getElementById("edit-phone").value.trim()),s=document.getElementById("edit-company").value.trim(),o=document.getElementById("edit-email").value.trim(),i=document.getElementById("edit-address").value.trim(),c=k(document.getElementById("edit-tax-id").value.trim()),f=(G?.value||"").trim(),u=(Z?.value||"").trim(),m=document.getElementById("edit-notes").value.trim();if(!a||!e){ft(d("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const g=H(),D=Array.isArray(g.customers)?g.customers:[],h=D.findIndex(P=>String(P.id)===String(t));if(h===-1){ft(d("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const v=D[h]?.document??null;let E=v;T?.dataUrl?E={...v||{},url:T.dataUrl,fileName:u||T.fileName||v?.fileName||"",mimeType:T.mimeType||v?.mimeType,size:T.size??v?.size}:f?E={...v||{},url:f,fileName:u||v?.fileName||""}:u&&v?E={...v,fileName:u}:!f&&!u&&(E=v),D[h]={...D[h],customerName:a,phone:e,companyName:s,email:o,address:i,notes:m,tax_id:c,taxId:c,document:E},tt({customers:D}),l=D[h],w(),gt(x),et(x),U(),document.dispatchEvent(new CustomEvent("customers:changed")),ft(d("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),pt.dataset.listenerAttached="true");async function sa(){if(z){if(!x){kt(null),St(!0),U(),z.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${d("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}l=Qe(x),l&&(w(),gt(x),et(x),U()),await ea(x,{showSpinner:!l})}}sa();const oe=()=>{!x||!l||U()};document.addEventListener("reservations:changed",oe);document.addEventListener("projects:changed",oe);document.addEventListener("language:changed",()=>{w(),x&&l&&(gt(x),et(x),U())});
