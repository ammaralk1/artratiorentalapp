import{r as C,t as i,f as _,c as M,p as q,a as z,b as h,d as P,e as A}from"./calculations.Bqm4O-PR.js";import{e as H}from"./reports.Da0HHdd6.js";import{s as I,c as D,d as L,q as W}from"./controller.CwK47G-r.js";import{n as w}from"./auth.BcQOd76e.js";import"./reservationsService.BtJ4Aekt.js";import"./dashboard.CZHBm4M1.js";/* empty css              */import"./dashboardShell.deT9qe6E.js";import"./customers.Bfn9j-AP.js";import"./maintenanceService.Cf3sMnbW.js";const k=96,N=25.4,F=210,$=297,R=Math.round(F/N*k),j=Math.round($/N*k);function O(n="preview"){const r=document.createElement("div");r.id="quotation-pdf-root",r.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),r.setAttribute("data-quote-render-context",n);const p=document.createElement("style");p.textContent=String(W).trim(),r.appendChild(p);const a=document.createElement("div");a.className="quote-preview-pages",a.setAttribute("data-quote-pages",""),r.appendChild(a);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; }
    .rpt-table th { background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
  `,r.appendChild(e),r}function E({primary:n=!1}={}){const r=document.createElement("div");return r.className="quote-page",n&&r.classList.add("quote-page--primary"),r}function U(n){const r=document.createElement("div");r.className="rpt-header";const p=document.createElement("h1");p.textContent=i("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const a=document.createElement("p");a.className="rpt-subtitle",a.textContent=`${A(new Date)} • ${i("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,r.appendChild(p),r.appendChild(a);const e=document.createElement("div");e.className="rpt-kpis";const o=(s,t)=>{const l=document.createElement("div");return l.className="rpt-kpi",l.innerHTML=`<div class="label">${s}</div><div class="value">${t}</div>`,l};return e.appendChild(o(i("reservations.reports.kpi.total.label","الحجوزات","Reservations"),P(n.total||0))),e.appendChild(o(i("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),h(n.revenue||0))),e.appendChild(o(i("reservations.reports.kpi.net.label","صافي الربح","Net profit"),h(n.netProfit||0))),e.appendChild(o(i("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),h(n.companyShareTotal||0))),e.appendChild(o(i("reservations.reports.kpi.tax.label","الضريبة","Tax"),h(n.taxTotal||0))),e.appendChild(o(i("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),h(n.maintenanceExpense||0))),r.appendChild(e),r}function X(){try{const n=C?.data||{},r=C?.lastSnapshot?.filtered||n.reservations||[],p=new Map((n.customers||[]).map(t=>[String(t.id),t])),a=[...r].sort((t,l)=>new Date(l?.start||0)-new Date(t?.start||0)),e={code:i("reservations.reports.results.headers.id","الحجز","Reservation"),customer:i("reservations.reports.results.headers.customer","العميل","Customer"),date:i("reservations.reports.results.headers.date","التاريخ","Date"),status:i("reservations.reports.results.headers.status","الحالة","Status"),payment:i("reservations.reports.results.headers.payment","الدفع","Payment"),total:i("reservations.reports.results.headers.total","الإجمالي","Total"),share:i("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:i("reservations.reports.results.headers.net","صافي الربح","Net profit")},o=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],s=a.map(t=>{const l=t?.reservationId||t?.id||"—",g=w(String(l)),c=p.get(String(t?.customerId))?.customerName||i("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),b=_(t?.start),x=M(t),d=(()=>{switch(x.statusValue){case"completed":return String(i("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(i("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(i("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return w(String(x.statusValue||"—"))}})(),u=q(x.paidStatus),m=z(t),f=h(m.finalTotal),v=m.companySharePercent>0?`${P(m.companySharePercent)}% (${h(m.companyShareAmount)})`:i("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),T=h(m.netProfit);return{[e.code]:g,[e.customer]:c,[e.date]:b,[e.status]:d,[e.payment]:u,[e.total]:f,[e.share]:v,[e.net]:T}});return{headers:o,rows:s}}catch(n){return console.warn("[reports/pdf] failed to build export rows from state",n),{headers:[],rows:[]}}}function S(n){const r=document.createElement("table");r.className="rpt-table";const p=document.createElement("thead"),a=document.createElement("tr");n.forEach(o=>{const s=document.createElement("th");s.textContent=o,a.appendChild(s)}),p.appendChild(a);const e=document.createElement("tbody");return r.appendChild(p),r.appendChild(e),{table:r,tbody:e}}function V(n,r,p,a){const e=n.querySelector("[data-quote-pages]"),o=E({primary:!0});e.appendChild(o);const s=U(a);o.appendChild(s);let{table:t,tbody:l}=S(p);o.appendChild(t);const g=18,y=28,c=[];for(let d=0;d<r.length;d+=y)c.push(r.slice(d,d+y));if(c.length){const d=c[0];if(d.length>g){const u=d.splice(g);c.length>1?c[1]=u.concat(c[1]):c.push(u)}}const b=(d,u)=>{const m=document.createElement("tr");p.forEach(f=>{const v=document.createElement("td");v.textContent=u[f]!=null?String(u[f]):"",m.appendChild(v)}),d.appendChild(m)};(c.shift()||r).forEach(d=>b(l,d)),c.forEach(d=>{const u=E({primary:!1});e.appendChild(u);const m=S(p);u.appendChild(m.table),d.forEach(f=>b(m.tbody,f))})}function G(n=[],{context:r="preview"}={}){const a=(C.lastSnapshot||{}).metrics||{};let e,o=n&&n.length?n:null;if(o)e=Object.keys(o[0]||{});else{const l=X();e=l.headers,o=l.rows}const s=O(r),t=document.createElement("div");t.style.position="fixed",t.style.left="-10000px",t.style.top="0",t.style.width=`${R}px`,t.style.zIndex="-1",document.body.appendChild(t),t.appendChild(s);try{I(s),D(s),L(s)}catch{}return V(s,o||[],e,a),s.parentElement?.removeChild(s),t.parentElement?.removeChild(t),s}async function ae(n=[],{action:r="save"}={}){const p=G(n,{context:"export"}),a=document.createElement("div");Object.assign(a.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),a.appendChild(p),document.body.appendChild(a);try{await H();const e=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",scrollX:0,scrollY:0,windowWidth:R,windowHeight:j},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(p).toPdf();if(r==="print"){const o=await e.get("pdf").then(s=>s.output("bloburl"));await new Promise(s=>{const t=document.createElement("iframe");Object.assign(t.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),t.onload=()=>{try{t.contentWindow?.focus(),t.contentWindow?.print()}catch{}setTimeout(()=>{t.remove(),s()},1e3)},t.src=o,document.body.appendChild(t)})}else await e.save("reservations-report.pdf")}finally{a.remove()}}export{G as buildReportsPdfPages,ae as exportReportsPdf};
