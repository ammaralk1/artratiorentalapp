import{t as f,e as Y,n as k,k as P,d as x}from"./auth.js";/* empty css     *//* empty css       */import"./projects2.js";import"./projectsCommon.js";import{e as Z,x as J,F as z,C as X,E as Q,g as tt,A as et,v as at}from"./projectsService.js";const nt="modulepreload",rt=function(t,e){return new URL(t,e).href},I={},st=function(e,a,r){let c=Promise.resolve();if(a&&a.length>0){let p=function(o){return Promise.all(o.map(m=>Promise.resolve(m).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};const i=document.getElementsByTagName("link"),l=document.querySelector("meta[property=csp-nonce]"),s=l?.nonce||l?.getAttribute("nonce");c=p(a.map(o=>{if(o=rt(o,r),o in I)return;I[o]=!0;const m=o.endsWith(".css"),h=m?'[rel="stylesheet"]':"";if(r)for(let w=i.length-1;w>=0;w--){const C=i[w];if(C.href===o&&(!m||C.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${o}"]${h}`))return;const b=document.createElement("link");if(b.rel=m?"stylesheet":nt,m||(b.as="script"),b.crossOrigin="",b.href=o,s&&b.setAttribute("nonce",s),document.head.appendChild(b),m)return new Promise((w,C)=>{b.addEventListener("load",w),b.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${o}`)))})}))}function d(i){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=i,window.dispatchEvent(l),!l.defaultPrevented)throw i}return c.then(i=>{for(const l of i||[])l.status==="rejected"&&d(l.reason);return e().catch(d)})},B=.15,E={};let T=0;const u={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},n={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},S=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let v=null;const O=["upcoming","ongoing","completed"];async function ot({forceProjects:t=!1}={}){try{await Z({suppressError:!0}),await J({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),z(e)&&console.warn("Projects API error:",e.message)}V()}async function lt(){ct(),q(),await it();try{await ot({forceProjects:!0}),W(),ht(),y()}finally{H()}document.addEventListener("language:changed",bt),document.addEventListener("projects:changed",()=>{A().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{A().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",yt)}document.addEventListener("DOMContentLoaded",lt);async function it(){if(v)return v;try{v=(await st(()=>import("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"),[],import.meta.url)).default}catch(t){console.warn("Chart.js failed to load",t),v=null}return v}function ct(){n.search=document.getElementById("reports-search"),n.statusChips=document.getElementById("reports-status-chips"),n.payment=document.getElementById("reports-payment"),n.dateRange=document.getElementById("reports-date-range"),n.customRangeWrapper=document.getElementById("reports-custom-range"),n.startDate=document.getElementById("reports-start-date"),n.endDate=document.getElementById("reports-end-date"),n.refreshBtn=document.getElementById("reports-refresh"),n.kpiGrid=document.getElementById("reports-kpi-grid"),n.table=document.getElementById("reports-table"),n.tableBody=n.table?.querySelector("tbody"),n.tableMeta=document.getElementById("reports-table-meta"),n.tableEmpty=document.getElementById("reports-empty"),n.chartCards={},n.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;n.chartCards[e]=t;const a=t.querySelector("[data-chart-loading]");a&&(n.chartLoaders[e]=a)})}function _(t){const e=!!t;Object.entries(n.chartCards||{}).forEach(([a,r])=>{if(!r)return;r.classList.toggle("is-loading",e),r.setAttribute("aria-busy",e?"true":"false");const c=n.chartLoaders?.[a];c&&(c.hidden=!e)})}function q(){T+=1,T===1&&_(!0)}function H(){T=Math.max(0,T-1),T===0&&_(!1)}function V(){const{customers:t=[]}=Y();u.customers=Array.isArray(t)?t:[],u.reservations=tt();const e=new Map(u.customers.map(r=>[String(r.id),r])),a=et();u.projects=Array.isArray(a)?a.map(r=>ut(r,e)):[],u.totalProjects=u.projects.length}function ut(t,e){const a=t.paymentStatus==="paid"?"paid":"unpaid",r=e.get(String(t.clientId)),c=dt(t.id),d=c.reduce((K,G)=>K+pt(G),0),i=mt(t),l=Number(t?.equipmentEstimate)||0,s=Number((l+i).toFixed(2)),p=t?.applyTax===!0||t?.applyTax==="true",o=p?Number((s*B).toFixed(2)):0,m=p?Number(((s+d)*B).toFixed(2)):0,h=Number((s+d+m).toFixed(2)),b=ft(t),w=t.start?new Date(t.start):null,C=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:r?.customerName||r?.name||"",clientCompany:t.clientCompany||r?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:a,confirmed:t.confirmed===!0||t.confirmed==="true",start:w,end:C,applyTax:p,status:b,reservationsTotal:Number(d.toFixed(2)),expensesTotal:i,subtotal:s,taxAmount:o,combinedTaxAmount:m,overallTotal:h,unpaidValue:a==="paid"?0:h,reservationsCount:c.length}}function dt(t){return Array.isArray(u.reservations)?u.reservations.filter(e=>String(e.projectId)===String(t)):[]}function pt(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],a=t.discount??0,r=Number(k(String(a)))||0,c=t.discountType||"percent",d=Array.isArray(t.technicians)?t.technicians:[],i=at(e,r,c,!1,d,{start:t.start,end:t.end});if(Number.isFinite(i))return i;const l=Number(k(String(t.cost??0)));return Number.isFinite(l)?Math.round(l):0}function mt(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,a)=>e+(Number(a.amount)||0),0):0}function ft(t){const e=new Date,a=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return a&&!Number.isNaN(a.getTime())&&a>e?"upcoming":r&&!Number.isNaN(r.getTime())&&r<e?"completed":"ongoing"}function ht(){if(n.search){let t;n.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{u.filters.search=n.search.value.trim(),y()},180)})}n.payment&&(n.payment.value=u.filters.payment,n.payment.addEventListener("change",()=>{u.filters.payment=n.payment.value||"all",y()})),n.dateRange&&(n.dateRange.addEventListener("change",gt),n.dateRange.value=u.filters.range),n.startDate&&n.startDate.addEventListener("change",()=>{u.filters.startDate=n.startDate.value,u.filters.range==="custom"&&y()}),n.endDate&&n.endDate.addEventListener("change",()=>{u.filters.endDate=n.endDate.value,u.filters.range==="custom"&&y()}),n.refreshBtn&&n.refreshBtn.addEventListener("click",()=>{if(u.filters.range!=="custom"){y();return}u.filters.startDate=n.startDate?.value||"",u.filters.endDate=n.endDate?.value||"",y()})}function gt(t){const e=t.target.value;u.filters.range=e,e==="custom"?n.customRangeWrapper?.classList.add("active"):(n.customRangeWrapper?.classList.remove("active"),u.filters.startDate="",u.filters.endDate="",n.startDate&&(n.startDate.value=""),n.endDate&&(n.endDate.value=""),y())}async function A(){q();try{await Promise.all([X(),Q()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),z(t)&&console.warn("Projects API error:",t.message)}finally{V(),y(),H()}}function bt(){W(),y()}function yt(t){t.key&&!["projects","reservations","customers"].includes(t.key)||A().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function y(){const t=vt();M(),kt(t),Et(t),St(t),Nt(t),xt(t),Dt(t)}function vt(){const{search:t,statuses:e,payment:a,range:r,startDate:c,endDate:d}=u.filters,i=U(t),l=new Date,s=Number(r);let p=null;if(r==="custom"){p=c?new Date(c):null;const o=d?new Date(d):null;return u.projects.filter(m=>!$(m,e)||!F(m,a)||!j(m,i)?!1:Ct(m.start,p,o))}return r!=="all"&&Number.isFinite(s)&&(p=new Date,p.setDate(l.getDate()-s)),u.projects.filter(o=>!$(o,e)||!F(o,a)||!j(o,i)?!1:r==="all"?!0:wt(o.start,p,l))}function $(t,e){return e.includes(t.status)}function F(t,e){return e==="all"?!0:t.paymentStatus===e}function j(t,e){return e?U([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function wt(t,e,a){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=a:!0}function Ct(t,e,a){if(!e&&!a)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&r<e.getTime()||a&&!Number.isNaN(a.getTime())&&r>a.getTime())}function U(t){return t?k(String(t)).toLowerCase().trim():""}function kt(t){if(!n.kpiGrid)return;const e=t.length,a=t.reduce((i,l)=>i+l.overallTotal,0),r=t.reduce((i,l)=>i+l.unpaidValue,0),c=t.reduce((i,l)=>i+l.expensesTotal,0),d=[{icon:S.projects,label:f("projects.reports.kpi.totalProjects","Total projects"),value:L(e),meta:f("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:S.value,label:f("projects.reports.kpi.totalValue","Total value"),value:N(a),meta:f("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:S.outstanding,label:f("projects.reports.kpi.unpaidValue","Outstanding value"),value:N(r),meta:f("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:S.expenses,label:f("projects.reports.kpi.expenses","Total expenses"),value:N(c),meta:f("projects.reports.kpi.expensesMeta","Expenses for included projects")}];n.kpiGrid.innerHTML=d.map(({icon:i,label:l,value:s,meta:p})=>`
    <div class="reports-kpi-card">
      <div class="reports-kpi-icon">${i}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${g(l)}</p>
        <p class="reports-kpi-value">${g(s)}</p>
        <span class="reports-kpi-meta">${g(p)}</span>
      </div>
    </div>
  `).join("")}function W(){if(!n.statusChips)return;const t=O.map(e=>{const a=f(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${g(a)}</button>`}).join("");n.statusChips.innerHTML=t,n.statusChips.dataset.listenerAttached||(n.statusChips.addEventListener("click",Tt),n.statusChips.dataset.listenerAttached="true"),M()}function Tt(t){const e=t.target.closest("[data-status]");if(!e)return;const a=e.dataset.status;if(!a)return;const r=new Set(u.filters.statuses);r.has(a)?r.delete(a):r.add(a),r.size===0&&O.forEach(c=>r.add(c)),u.filters.statuses=Array.from(r),M(),y()}function M(){if(!n.statusChips)return;const t=new Set(u.filters.statuses);n.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Et(t){if(!v)return;const e=document.getElementById("reports-status-chart");if(!e)return;const a=["upcoming","ongoing","completed"],r=a.map(l=>t.filter(s=>s.status===l).length),d={labels:a.map(l=>f(`projects.status.${l}`,l)),datasets:[{data:r,backgroundColor:["rgba(59, 130, 246, 0.85)","rgba(250, 204, 21, 0.85)","rgba(34, 197, 94, 0.85)"],borderColor:["rgba(37, 99, 235, 1)","rgba(217, 119, 6, 1)","rgba(22, 163, 74, 1)"],borderWidth:1}]};D("status",e,"doughnut",d,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function St(t){if(!v)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const a=new Map,r=new Intl.DateTimeFormat(Lt(),{month:"short",year:"numeric"});t.forEach(o=>{if(!o.start||Number.isNaN(o.start.getTime()))return;const m=`${o.start.getFullYear()}-${o.start.getMonth()+1}`,h=a.get(m)||{total:0,label:r.format(o.start)};h.total+=o.overallTotal,a.set(m,h)});const d=Array.from(a.keys()).sort((o,m)=>{const[h,b]=o.split("-").map(Number),[w,C]=m.split("-").map(Number);return h===w?b-C:h-w}).slice(-12),i=d.map(o=>a.get(o)?.label||o),l=d.map(o=>Math.round(a.get(o)?.total||0)),s={labels:i,datasets:[{label:f("projects.reports.charts.timeline","Revenue over time"),data:l,borderColor:"rgba(76, 110, 245, 0.95)",backgroundColor:"rgba(76, 110, 245, 0.25)",fill:!0,tension:.35,pointRadius:4}]};D("timeline",e,"line",s,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:o=>R(o)}}},plugins:{legend:{display:!1}}})}function Nt(t){if(!v)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const a=[...t].sort((s,p)=>p.overallTotal-s.overallTotal).slice(0,6),r=a.map(s=>s.title||s.projectCode),c=a.map(s=>Math.round(s.overallTotal)),d=a.map(s=>Math.round(s.expensesTotal)),i={labels:r,datasets:[{label:f("projects.reports.datasets.value","Total value"),data:c,backgroundColor:"rgba(76, 110, 245, 0.65)"},{label:f("projects.reports.datasets.expenses","Expenses"),data:d,backgroundColor:"rgba(244, 114, 182, 0.55)"}]};D("expenses",e,"bar",i,{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0,ticks:{callback:s=>R(s)}}},plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function xt(t){if(!v)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const a=new Map;t.forEach(s=>{const p=s.clientName||s.clientCompany||f("projects.fallback.unknownClient","Unknown client"),o=a.get(p)||0;a.set(p,o+s.overallTotal)});const r=Array.from(a.entries()).sort((s,p)=>p[1]-s[1]).slice(0,6),c=r.map(([s])=>s),d=r.map(([,s])=>Math.round(s)),i={labels:c,datasets:[{label:f("projects.reports.charts.clients","Top clients"),data:d,backgroundColor:"rgba(59, 130, 246, 0.75)"}]};D("clients",e,"bar",i,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:s=>R(s)}}},plugins:{legend:{display:!1}}})}function D(t,e,a,r,c){!v||!e||(E[t]&&(E[t].destroy(),delete E[t]),E[t]=new v(e,{type:a,data:r,options:c}))}function Dt(t){if(!n.table||!n.tableBody||!n.tableEmpty)return;if(!t.length){n.table.style.display="none",n.tableEmpty.classList.add("active"),n.tableMeta&&(n.tableMeta.textContent="");return}n.table.style.display="",n.tableEmpty.classList.remove("active");const e=t.map(a=>{const r=At(a.start,a.end),c=f(`projects.status.${a.status}`,a.status),d=f(`projects.paymentStatus.${a.paymentStatus}`,a.paymentStatus),i=a.clientCompany?`${g(a.clientName)} <small class="text-muted">${g(a.clientCompany)}</small>`:g(a.clientName||f("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${g(a.title||a.projectCode)}</span>
            <small class="text-muted">${g(`#${a.projectCode}`)}</small>
          </div>
        </td>
        <td>${i}</td>
        <td>${g(c)}</td>
        <td>${g(r)}</td>
        <td>${g(N(a.overallTotal))}</td>
        <td>${g(d)}</td>
      </tr>
    `}).join("");if(n.tableBody.innerHTML=e,n.tableMeta){const a=f("projects.reports.table.meta","Showing {count} of {total} projects");n.tableMeta.textContent=a.replace("{count}",L(t.length)).replace("{total}",L(u.totalProjects))}}function At(t,e){if(!t&&!e)return"—";const a=t?P(t.toISOString()):"—",r=e?P(e.toISOString()):"—";return e?`${a} → ${r}`:a}function N(t){const e=Number(t)||0,r=x()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",c=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${k(c)} SR`}function L(t){const a=x()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return k(new Intl.NumberFormat(a).format(t))}function R(t){const a=x()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return k(new Intl.NumberFormat(a,{notation:"compact",compactDisplay:"short"}).format(t))}function Lt(){return x()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function g(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
