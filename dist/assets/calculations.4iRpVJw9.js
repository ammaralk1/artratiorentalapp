import{n as J,t as q,v as E,a as at,B as ot,d as rt}from"./reservationsService.C-KNU2p4.js";import{t as Y,n as A,p as V}from"./auth.BLFzWQsL.js";const g={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,lastFetchSignature:null,lastFetchAt:0,pendingFetchSignature:null,pendingFetchForce:!1,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function ft(t){g.callbacks.onRender=typeof t=="function"?t:null}function ht(t){g.callbacks.onBeforeRender=typeof t=="function"?t:null}function gt(t){g.callbacks.onAfterRender=typeof t=="function"?t:null}function yt(t){g.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function wt(t){g.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function bt(t){g.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function L(t){if(g.loadedScripts.has(t))return g.loadedScripts.get(t);const e=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,r=new Promise((o,c)=>{const n=()=>{e&&(e.dataset.loaded="true"),o()},a=u=>c(u);if(e){if(e.dataset.loaded==="true"){o();return}e.addEventListener("load",n,{once:!0}),e.addEventListener("error",a,{once:!0});return}const i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>{i.dataset.loaded="true",o()},i.onerror=u=>c(u),document.head.appendChild(i)});return g.loadedScripts.set(t,r),r}function St(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(g.apexChartsReady||(g.apexChartsReady=L("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),g.apexChartsReady)}function K(t,e=1500){return new Promise((r,o)=>{const c=setTimeout(()=>r(null),Math.max(200,e));t.then(n=>{clearTimeout(c),r(n)},n=>{clearTimeout(c),r(null)})})}async function st(){try{const t=await fetch("/vendor/html2pdf.bundle.min.js",{method:"GET",cache:"no-cache"});if(!t.ok)return!1;const e=(t.headers.get("content-type")||"").toLowerCase();if(!(e.includes("javascript")||e.includes("ecmascript")))return!1;const r=await t.text();if(!r||/<\s*!doctype\s+html/i.test(r))return!1;const o=new Blob([r],{type:"text/javascript"}),c=URL.createObjectURL(o);await L(c);try{URL.revokeObjectURL(c)}catch{}return typeof window.html2pdf<"u"}catch{return!1}}function Dt(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(g.html2PdfReady||(g.html2PdfReady=(async()=>await K(st(),1200)&&window.html2pdf?window.html2pdf:(await K(L("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"),2e3),window.html2pdf||null))()),g.html2PdfReady)}function Nt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(g.xlsxReady||(g.xlsxReady=L("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),g.xlsxReady)}function Mt(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(g.jsZipReady||(g.jsZipReady=L("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),g.jsZipReady)}function D(t,e,r=e){const c=V()==="en"?r??e:e;return Y(t,c)}function Tt(){g.formatters.cachedLocale=null,g.formatters.numberFormatter=null}function z(){return(V()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function G(){const t=V();if(t!==g.formatters.cachedLocale||!g.formatters.numberFormatter||!g.formatters.currencyFormatter){g.formatters.cachedLocale=t;const e=z();g.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),g.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:g.formatters.numberFormatter,currencyFormatter:g.formatters.currencyFormatter}}function Ct(t){const{numberFormatter:e}=G(),r=e.format(Math.round(t||0));return A(r)}function Ft(t){const{currencyFormatter:e}=G(),r=Number.isFinite(Number(t))?Number(t):0,o=e.format(r);return`${A(o)} SR`}function I(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const r=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0");return`${r}-${o}-${c}`}function At(t){if(!t)return Y("common.placeholder.empty","—");const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return Y("common.placeholder.empty","—");const r=new Intl.DateTimeFormat(z(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return A(r.format(e))}function Q(t){return new Intl.DateTimeFormat(z(),{month:"short"}).format(t)}const ct=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["مغلق","completed"],["مغلقة","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),v=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),$=1440*60*1e3,N={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map,equipmentCost:new Map};function x(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const r=t[0]||{},o=t[e-1]||{},c=`${r.id??r.reservationId??""}-${r.start??""}`,n=`${o.id??o.reservationId??""}-${o.start??""}`,a=g.formatters?.cachedLocale||"ar";return`${e}|${c}|${n}|${a}`}function P(t,e){return t.get(e)}function k(t,e,r){if(t.set(e,r),t.size>64){const o=t.keys().next().value;t.delete(o)}return r}function tt(t){return A(String(t||"")).toLowerCase().trim()}function _(t){return(t||"").toString().trim()}function H(t,e){if(!t||!e)return 1;const r=new Date(t),o=new Date(e);if(Number.isNaN(r.getTime())||Number.isNaN(o.getTime()))return 1;const c=o.getTime()-r.getTime();return c<=0?1:Math.max(1,Math.ceil(c/$))}function O(t){return t?(g.techniciansIndex||(g.techniciansIndex=new Map((g.data.technicians||[]).map(e=>[String(e.id),e]))),g.techniciansIndex.get(String(t))||null):null}function B(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const r of e){if(r==null)continue;const o=Number.parseFloat(A(String(r)));if(Number.isFinite(o))return o}return 0}function X(t={}){const e=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const r of e){if(r==null)continue;const o=Number.parseFloat(A(String(r)));if(Number.isFinite(o))return o}return B(t)}function R(t){if(!t)return{rentalDays:1,equipmentTotal:0,equipmentCostTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;H(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,r=t.discountType||t.discount_type||"percent",o=String(r).toLowerCase()==="amount"?"amount":"percent",c=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",n=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,a=n!=null?q(n):Number.NaN,u=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(a)&&a>0?a:null,m=Array.isArray(t.crewAssignments)?t.crewAssignments:[],d=m.length?m.map(y=>y?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],s=rt({items:Array.isArray(t.items)?t.items:[],technicianIds:d,crewAssignments:m,discount:e,discountType:o,applyTax:c,start:t.start,end:t.end,companySharePercent:u}),l=Number(t.cost);let p=s.finalTotal,h=s.taxAmount;if(Number.isFinite(l)&&l>0&&(p=E(l),c)){const y=p-s.taxableAmount;Number.isFinite(y)&&y>=0&&(h=E(y))}const f={rentalDays:s.rentalDays,equipmentTotal:s.equipmentTotal,equipmentCostTotal:s.equipmentCostTotal,crewTotal:s.crewTotal,crewCostTotal:s.crewCostTotal,discountAmount:s.discountAmount,subtotalAfterDiscount:s.subtotalAfterDiscount,taxableAmount:s.taxableAmount,taxAmount:h,finalTotal:p,companySharePercent:s.companySharePercent,companyShareAmount:s.companyShareAmount,netProfit:s.netProfit,companyShareEnabled:s.companySharePercent>0};return t.__financials=f,f}function et(t){return t?.projectId&&g.data.projectsMap.get(String(t.projectId))||null}function Z(t=""){const e=String(t).toLowerCase().trim();return e?ct.get(e)||e:""}function lt(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const r of e){const o=String(r||"").toLowerCase().trim();if(o&&v.has(o))return v.get(o)}return t?.paid===!0||t?.paid==="true"}function M(t){const e=et(t),r=at(t,e),o=r.projectStatus||"",c=Z(o),n=Z(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");let a=n;r.projectLinked&&c&&a!=="cancelled"&&(a=c),a||(a=r.effectiveConfirmed?"confirmed":"pending"),a!=="cancelled"&&(ot(t)||c==="completed")&&(a="completed");const i=o==="confirmed"||o==="in_progress",u=e?.confirmed===!0||e?.confirmed==="true",m=r.reservationConfirmed||n==="confirmed";let d=m;r.projectLinked&&(d=u||i||m),a==="cancelled"&&(d=!1),d&&a!=="completed"&&a!=="cancelled"&&(a="confirmed");const s=lt(t),l=t?.paidStatus??t?.paid_status??(s?"paid":"unpaid");return{statusValue:a,confirmed:d,paid:s,paidStatus:l}}function Rt(t){let e=0,r=0,o=0,c=0,n=0,a=0,i=0,u=0,m=0,d=0,s=0,l=0,p=0,h=0,f=0;t.forEach(b=>{const{statusValue:w,confirmed:S,paid:C,paidStatus:T}=M(b);if(S&&(e+=1,w==="completed"&&(o+=1),w==="cancelled"&&(c+=1),r+=1,C&&w!=="cancelled"&&(n+=1),w!=="cancelled"&&T!=="paid"&&(a+=1),w!=="cancelled")){const F=R(b);i+=F.finalTotal,u+=F.companyShareAmount,m+=F.taxAmount,d+=F.crewTotal,s+=F.crewCostTotal??0,l+=F.equipmentTotal??0,p+=F.equipmentCostTotal??0,h+=F.netProfit;const j=U(b);Number.isFinite(j)&&j>0&&(f+=j)}});const y=e?i/e:0;return{total:e,confirmed:r,completed:o,cancelled:c,activeTotal:Math.max(0,e-c),paidCount:n,unpaidCount:a,outstandingTotal:f,revenue:i,average:y,companyShareTotal:u,taxTotal:m,crewTotal:d,crewCostTotal:s,equipmentTotal:l,equipmentCostTotal:p,netProfit:h}}function nt({range:t,start:e,end:r}){const o=new Date;if(o.setHours(23,59,59,999),t==="custom"||e||r){const a=e?new Date(`${e}T00:00:00`):null,i=r?new Date(`${r}T23:59:59`):null;return{startDate:W(a)?a:null,endDate:W(i)?i:null}}let c=new Date(o),n=null;switch(t){case"thisWeek":{const a=new Date(o),u=(a.getDay()-6+7)%7;a.setDate(a.getDate()-u),a.setHours(0,0,0,0);const m=new Date(a);m.setDate(a.getDate()+6),m.setHours(23,59,59,999),n=a,c=m;break}case"thisMonth":{n=new Date(o.getFullYear(),o.getMonth(),1),c=new Date(o.getFullYear(),o.getMonth()+1,0),c.setHours(23,59,59,999);break}case"thisQuarter":{const a=Math.floor(o.getMonth()/3);n=new Date(o.getFullYear(),a*3,1),c=new Date(o.getFullYear(),(a+1)*3,0),c.setHours(23,59,59,999);break}case"thisYear":{n=new Date(o.getFullYear(),0,1),c=new Date(o.getFullYear(),12,0),c.setHours(23,59,59,999);break}case"all":default:n=null,c=null;break}return n&&n.setHours(0,0,0,0),{startDate:n,endDate:c}}function W(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function xt(t,e){const{startDate:r,endDate:o}=nt(e);let c=0;const n=[];return(t||[]).forEach(a=>{if(!a)return;const i=typeof a.repairCost=="number"?a.repairCost:Number.parseFloat(A(String(a.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const u=String(a.statusRaw??a.status??"").toLowerCase();if(!(u==="closed"||u==="completed"||u==="cancelled"))return;const d=a.resolvedAt??a.resolved_at??null,s=a.reportedAt??a.reported_at??null,l=a.createdAt??a.created_at??null,p=d?new Date(d):null,h=s?new Date(s):l?new Date(l):null,f=p&&!Number.isNaN(p.getTime())?p:h&&!Number.isNaN(h.getTime())?h:null;if(f&&(r&&f<r||o&&f>o))return;const y=Math.round(i*100)/100;c+=y,n.push({id:a.id,cost:y,date:f})}),{total:c,items:n}}function Pt(t,e){const r=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:r,netProfit:(t.netProfit||0)-r}}function kt(t){const e=`trend:${x(t)}`,r=P(N.trend,e);if(r)return r;const o=new Date,c=[],n=(t||[]).map(u=>u?.start?new Date(u.start):null).filter(u=>u&&!Number.isNaN(u.getTime()));let a=6,i=new Date(o.getFullYear(),o.getMonth(),1);if(n.length){const u=new Date(Math.min(...n.map(h=>h.getTime()))),m=new Date(Math.max(...n.map(h=>h.getTime()))),d=new Date(u.getFullYear(),u.getMonth(),1);i=new Date(m.getFullYear(),m.getMonth(),1);const s=i.getFullYear()-d.getFullYear(),l=i.getMonth()-d.getMonth(),p=s*12+l;a=Math.min(12,Math.max(6,p+1))}for(let u=a-1;u>=0;u-=1){const m=new Date(i.getFullYear(),i.getMonth()-u,1),d=m.getFullYear(),s=m.getMonth(),l=t.filter(C=>{const T=C?.start?new Date(C.start):null;return T&&T.getFullYear()===d&&T.getMonth()===s}).filter(C=>M(C).statusValue!=="cancelled"),p=l.length;let h=0,f=0,y=0;l.forEach(C=>{const T=R(C);h+=T.finalTotal,f+=T.netProfit,y+=T.companyShareAmount});const b=Q(m),w=new Date(m.getFullYear(),m.getMonth(),1),S=new Date(m.getFullYear(),m.getMonth()+1,0);c.push({label:b,count:p,revenue:h,netProfit:f,companyShare:y,periodStart:w,periodEnd:S,startInput:I(w),endInput:I(S)})}try{const u=new Map;(t||[]).forEach(s=>{if(M(s).statusValue==="cancelled")return;const l=s?.start?new Date(s.start):null;if(!l||Number.isNaN(l.getTime()))return;const p=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`,h=R(s),f=u.get(p)||0;u.set(p,f+(Number(h.finalTotal)||0))});const m=c.map(s=>Number(s.revenue||0)),d=c.map((s,l)=>l<2?null:(m[l]+m[l-1]+m[l-2])/3);c.forEach((s,l)=>{const p=l>0?Number(c[l-1]?.revenue||0):null;let h=null;p!=null&&Number.isFinite(p)&&p>0&&(h=(Number(s.revenue||0)-p)/p*100);const f=s.periodStart instanceof Date?s.periodStart:null;let y=null;if(f&&!Number.isNaN(f.getTime())){const b=`${f.getFullYear()-1}-${String(f.getMonth()+1).padStart(2,"0")}`,w=u.get(b);Number.isFinite(w)&&w>0&&(y=(Number(s.revenue||0)-w)/w*100)}s.momChange=h,s.yoyChange=y,s.movingAvgRevenue=d[l]})}catch{}return k(N.trend,e,c)}function Et(t){const e=new Date,r=(t||[]).map(a=>a?.start?new Date(a.start):null).filter(a=>a&&!Number.isNaN(a.getTime()));let o=6,c=new Date(e.getFullYear(),e.getMonth(),1);if(r.length){const a=new Date(Math.min(...r.map(l=>l.getTime()))),i=new Date(Math.max(...r.map(l=>l.getTime()))),u=new Date(a.getFullYear(),a.getMonth(),1);c=new Date(i.getFullYear(),i.getMonth(),1);const m=c.getFullYear()-u.getFullYear(),d=c.getMonth()-u.getMonth(),s=m*12+d;o=Math.min(12,Math.max(6,s+1))}const n=[];for(let a=o-1;a>=0;a-=1){const i=new Date(c.getFullYear(),c.getMonth()-a,1),u=i.getFullYear(),m=i.getMonth();let d=0,s=0;(t||[]).forEach(l=>{const p=l?.start?new Date(l.start):null;if(!p||p.getFullYear()!==u||p.getMonth()!==m)return;const{statusValue:h,confirmed:f}=M(l);h==="cancelled"?s+=1:(f||h==="confirmed"||h==="completed")&&(d+=1)}),n.push({label:Q(i),confirmed:d,cancelled:s})}return n}function Lt(t){const e=`status:${x(t)}`,r=P(N.status,e);if(r)return r;const o={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(d=>{const{statusValue:s,confirmed:l}=M(d);s==="completed"?o.completed+=1:s==="cancelled"?o.cancelled+=1:s==="confirmed"||l?o.confirmed+=1:o.pending+=1});const c=Math.max(1,(t||[]).length),n=o.confirmed,a=o.pending,i=o.completed,u=o.cancelled,m=[{label:D("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:n,percent:Math.round(n/c*100)||0,rawCount:n,className:"status-confirmed",filterKey:"confirmed"},{label:D("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:a,percent:Math.round(a/c*100)||0,rawCount:a,className:"status-pending",filterKey:"pending"},{label:D("reservations.reports.status.completedLabel","مغلقة","Closed"),value:i,percent:Math.round(i/c*100)||0,rawCount:i,className:"status-completed",filterKey:"completed"},{label:D("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:u,percent:Math.round(u/c*100)||0,rawCount:u,className:"status-cancelled",filterKey:"cancelled"}];return k(N.status,e,m)}function _t(t){const e=`payment:${x(t)}`,r=P(N.payment,e);if(r)return r;const o=t.length||1;let c=0,n=0,a=0;(t||[]).forEach(u=>{const{paidStatus:m}=M(u);m==="paid"?c+=1:m==="partial"?n+=1:a+=1});const i=[{label:D("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:c,percent:Math.round(c/o*100)||0,rawCount:c,className:"status-paid",filterKey:"paid"},{label:D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:n,percent:Math.round(n/o*100)||0,rawCount:n,className:"status-partial",filterKey:"partial"},{label:D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/o*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}];return k(N.payment,e,i)}function jt(t,e){const r=`topCustomers:${x(t)}`,o=P(N.topCustomers,r);if(o)return o;const c=new Map,n=new Map((e||[]).map(i=>[String(i.id),i]));t.forEach(i=>{const{statusValue:u}=M(i);if(u==="cancelled")return;const m=String(i?.customerId??"unknown"),d=c.get(m)||{count:0,revenue:0},s=R(i);d.count+=1,d.revenue+=s.finalTotal,c.set(m,d)});const a=Array.from(c.entries()).map(([i,u])=>({name:n.get(i)?.customerName||D("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:u.count,revenue:u.revenue})).sort((i,u)=>u.revenue-i.revenue).slice(0,5);return k(N.topCustomers,r,a)}function qt(t,e){const r=`topEquipment:${x(t)}`,o=P(N.topEquipment,r);if(o)return o;const c=new Map,n=new Map((e||[]).map(u=>[_(u?.barcode),u])),a=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(u=>{(u?.items||[]).forEach(m=>{const d=_(m?.barcode),s=d?n.get(d):null,l=m?.desc||m?.description||m?.name||s?.desc||s?.description||s?.name||"",p=l&&l.trim()?l:a,h=J(p)||"unknown",f=Number(m?.qty)||1,y=Number(m?.price)||0,b=f*y,w=c.get(h)||{name:p,count:0,revenue:0};w.name=p,w.count+=f,w.revenue+=b,c.set(h,w)})});const i=Array.from(c.values()).sort((u,m)=>m.count!==u.count?m.count-u.count:m.revenue-u.revenue).slice(0,5);return k(N.topEquipment,r,i)}function Yt(t){const e=`equipmentCost:${x(t)}`,r=P(N.equipmentCost,e);if(r)return r;const o=new Map,c=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");(t||[]).forEach(a=>{const{statusValue:i}=M(a);if(i==="cancelled")return;const u=Math.max(1,H(a?.start,a?.end));(Array.isArray(a?.items)?a.items:[]).forEach(d=>{const s=d?.desc||d?.description||d?.name||"",l=s&&s.trim()?s:c,p=J(l)||l,h=Number(d?.qty??d?.quantity??1)||1,f=q(d?.price??d?.unit_price??d?.unitPrice??0),y=q(d?.unitCost??d?.unit_cost??d?.cost??0),b=E(h*f*u),w=E(h*y*u),S=o.get(p)||{name:l,quantity:0,billable:0,cost:0};S.name=l,S.quantity+=h,S.billable+=b,S.cost+=w,o.set(p,S)})});const n=Array.from(o.values()).map(a=>({...a,net:E(a.billable-a.cost)})).sort((a,i)=>i.cost!==a.cost?i.cost-a.cost:i.billable!==a.billable?i.billable-a.billable:(i.quantity||0)-(a.quantity||0)).slice(0,10);return k(N.equipmentCost,e,n)}function It(){Object.values(N).forEach(t=>t.clear())}function it(t,e,r,o,c){const n=[],a=t?.reservationId||t?.id;a&&n.push(a),t?.notes&&n.push(t.notes);const{statusValue:i,paid:u,paidStatus:m}=M(t);i&&n.push(i);const d=t?.paymentStatus||t?.payment_status;d&&n.push(d),t?.paid!=null&&n.push(t.paid?"paid":"unpaid"),m&&n.push(m);const s=r.get(String(t?.customerId));s&&n.push(s.customerName,s.company_name||s.companyName,s.contact_person||"");const l=et(t);return l&&n.push(l.title,l.code,l.status),n.push(ut(m)),(t?.items||[]).forEach(h=>{h?.desc&&n.push(h.desc),h?.barcode&&n.push(h.barcode);const f=o.get(_(h?.barcode));f&&n.push(f.desc,f.description,f.name)}),(t?.technicians||[]).forEach(h=>{const f=c.get(String(h));f&&n.push(f.name,f.role,f.department)}),tt(n.filter(Boolean).join(" ")).includes(e)}function $t(t,e,r,o,c){const{startDate:n,endDate:a}=nt(e),i=tt(e.search),u=!!i,m=new Map((r||[]).map(l=>[String(l.id),l])),d=new Map((o||[]).map(l=>[_(l?.barcode),l])),s=new Map((c||[]).map(l=>[String(l.id),l]));return(t||[]).filter(l=>{if(l&&l.projectId!=null&&String(l.projectId).trim()!=="")return!1;const p=l?.start?new Date(l.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let h=l?.end?new Date(l.end):p;if(Number.isNaN(h.getTime())&&(h=p),n&&h<n||a&&p>a)return!1;const{statusValue:f,confirmed:y,paid:b,paidStatus:w}=M(l);if(!(f==="confirmed"||f==="completed")||e.status==="confirmed"&&!(f==="confirmed"||f==="completed"||y)||e.status==="pending"&&f!=="pending"||e.status==="completed"&&f!=="completed"||e.status==="cancelled"&&f!=="cancelled"||e.payment==="paid"&&!b||e.payment==="unpaid"&&b||e.payment==="partial"&&w!=="partial")return!1;if(e.share&&e.share!=="all"){const T=R(l).companySharePercent>0;if(e.share==="with"&&!T||e.share==="without"&&T)return!1}return!(u&&!it(l,i,m,d,s))})}function ut(t){const e=String(t??"").toLowerCase();return e==="paid"?D("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Bt(t,e){const r=new Map((e||[]).map(n=>[String(n.id),n])),o=new Map;return(t||[]).forEach(n=>{const{statusValue:a}=M(n);if(a==="cancelled")return;const i=H(n.start,n.end),u=Array.isArray(n.crewAssignments)?n.crewAssignments:[];if(u.length){u.forEach(d=>{const s=d?.technicianId!=null?String(d.technicianId):null;if(!s)return;const l=r.get(s)||O(s)||{},p=Number(d?.positionClientPrice),h=Number.isFinite(p)?p:X(l),f=Number(d?.positionCost),y=Number.isFinite(f)?f:B(l),b=h*i,w=y*i,S=o.get(s)||{id:s,name:l?.name||String(s),days:0,billable:0,cost:0};S.days+=i,S.billable+=b,S.cost+=w,o.set(s,S)});return}(Array.isArray(n.technicians)?n.technicians.map(d=>String(d)):[]).forEach(d=>{const s=r.get(d)||O(d)||{},l=X(s),p=B(s),h=l*i,f=p*i,y=o.get(d)||{id:d,name:s?.name||String(d),days:0,billable:0,cost:0};y.days+=i,y.billable+=h,y.cost+=f,o.set(d,y)})}),Array.from(o.values()).map(n=>({...n,net:n.billable-n.cost})).sort((n,a)=>a.net-n.net)}function dt(t=[]){if(!Array.isArray(t)||!t.length)return 0;let e=0;return t.forEach(r=>{const o=Number(r?.amount);Number.isFinite(o)&&o>0&&(e+=o)}),e}function U(t){const e=R(t),r=Number(e.finalTotal||0);let o=Number(t?.paidAmount);if(!Number.isFinite(o)||o<=0){const n=dt(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(n)&&n>0&&(o=n)}if((!Number.isFinite(o)||o<=0)&&Number.isFinite(Number(t?.paidPercent))){const n=Number(t.paidPercent);n>0&&n<=100&&(o=n/100*r)}return Number.isFinite(o)||(o=0),Math.max(0,Math.round((r-o)*100)/100)}function Vt(t,e,r=5){const o=new Map((e||[]).map(n=>[String(n.id),n])),c=[];return(t||[]).forEach(n=>{const{paidStatus:a,statusValue:i}=M(n);if(i==="cancelled"||a!=="unpaid"&&a!=="partial")return;const u=U(n);if(!Number.isFinite(u)||u<=0)return;const m=o.get(String(n.customerId));c.push({id:n.id||n.reservationId||"",code:n.reservationCode||n.reservationId||n.id||"",customer:m?.customerName||n.customerName||"",outstanding:u,paidStatus:a})}),c.sort((n,a)=>a.outstanding-n.outstanding).slice(0,r)}function zt(t,{horizonDays:e=90}={}){const r=new Date,o=new Date(r.getTime()+e*$),c=new Map;return(t||[]).forEach(n=>{const{statusValue:a,paidStatus:i}=M(n);if(a==="cancelled"||i==="paid")return;const u=U(n);if(!Number.isFinite(u)||u<=0)return;const m=n?.start?new Date(n.start):null,d=n?.end?new Date(n.end):m;let s=d&&!Number.isNaN(d.getTime())?d:m;if((!s||Number.isNaN(s.getTime()))&&(s=new Date(r.getTime()+7*$)),s<r||s>o)return;const l=I(new Date(s.getFullYear(),s.getMonth(),s.getDate())),p=c.get(l)||{date:l,amount:0,count:0};p.amount+=u,p.count+=1,c.set(l,p)}),Array.from(c.values()).sort((n,a)=>n.date<a.date?-1:1)}export{Yt as A,zt as B,Vt as C,ft as D,ht as E,gt as F,yt as G,wt as H,bt as I,Tt as J,Mt as K,Nt as a,It as b,R as c,nt as d,Dt as e,St as f,Ct as g,Ft as h,M as i,At as j,I as k,L as l,$t as m,Rt as n,xt as o,ut as p,Pt as q,g as r,kt as s,D as t,Lt as u,Et as v,_t as w,jt as x,qt as y,Bt as z};
