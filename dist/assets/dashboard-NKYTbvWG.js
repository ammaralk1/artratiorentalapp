import{t as c,d as j,e as _,n as b,f as ie,b as D,A as qt,s as bn,h as hn,j as h,k as Ke,o as It,u as Ee,p as yn,q as vn,r as ct,a as En,c as Tn,i as Sn,l as An}from"./auth-1jMV0rNp.js";import"./common-C0-_Kxfj.js";import{r as $t,l as Ln}from"./controller-Dvdl897X.js";/* empty css            */import{r as wn}from"./customers-DWoCeRHL.js";import{e as Cn,i as qn,g as He,s as In,c as $n,r as kt,m as kn,a as Mt,b as Mn,d as Bn,f as Dn,h as Qe,j as xn,u as Rn}from"./projectsService-DkH_AiSE.js";import{s as Bt}from"./events-9Kn_bx7j.js";const Fn={limit:200};let E=null,lt=!1,dt=!1,ut=!1,mt=!1,xe=null,Re=null,Fe=!1,P="";function Dt(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Nn(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function G({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:s}=Dt();if(!a||!s)return;const r=typeof t=="string"?t.trim().length>0:!!t,o=!e&&!r&&!!n,i=e||r||o;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",o),!i){s.textContent="";return}let l="";e?l=c("calendar.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª..."):r?l=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹."):o&&(l=c("calendar.status.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.")),s.textContent=l}function Ne(){E&&(E.destroy(),E=null)}function jn(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const s=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:s==="paid",{effectiveConfirmed:o}=kt(e,t),i=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let d=!!e.completed;if(!d&&a){const m=new Date(a);Number.isNaN(m.getTime())||(d=m<new Date)}return{id:e.id??i??n,start:n,end:a||n,paid:r,confirmed:o,completed:d,reservationId:i??"",customerName:l,raw:e}}function xt(e=[]){const{projects:t=[]}=_(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&s!==""&&n.get(String(s))||null,o=jn(a,r);if(!o)return null;const i=Un({...a,paid:o.paid,confirmed:o.confirmed,completed:o.completed});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:i.background,borderColor:i.border,textColor:i.text,display:"auto",extendedProps:{...a,paid:o.paid,confirmed:o.confirmed,completed:o.completed,reservationId:o.reservationId,customerName:o.customerName}}}).filter(Boolean)}function pt(){return{today:c("calendar.buttons.today","Ø§Ù„ÙŠÙˆÙ…"),month:c("calendar.buttons.month","Ø´Ù‡Ø±"),week:c("calendar.buttons.week","Ø£Ø³Ø¨ÙˆØ¹"),day:c("calendar.buttons.day","ÙŠÙˆÙ…")}}async function _n(){if(Fe)return He();Fe=!0,P="";try{await Cn({suppressError:!1,params:Fn})}catch(e){console.error("âŒ [calendar] Failed to load reservations for calendar view",e),P=qn(e)?e.message:e instanceof Error&&e.message||""}finally{Fe=!1}return He()}function Rt(e){E&&E.batchRendering(()=>{E.removeAllEvents(),E.addEventSource(e)})}function Ft(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Nt(){const e=He(),t=xt(e);if(!E){$e();return}E.setOption("locale",j()),Rt(t),se(),G({loading:!1,error:"",empty:t.length===0}),Ft(t)}function Pn(){lt||(document.addEventListener("language:changed",()=>{E&&E.setOption("locale",j()),$e()}),lt=!0),dt||(document.addEventListener("reservations:changed",()=>{Nt()}),dt=!0)}function jt(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function se(){if(!E)return;const e=jt();E.view?.type!==e&&E.changeView(e),E.updateSize()}function Hn(){ut||typeof window>"u"||(window.addEventListener("resize",()=>{se()}),ut=!0)}function On(){if(mt||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{Re&&clearTimeout(Re),Re=setTimeout(()=>{E&&Nt()},80)};xe=new MutationObserver(e),xe.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&xe.observe(document.body,{attributes:!0,attributeFilter:["class"]}),mt=!0}function Vn(){return typeof document>"u"?!1:document.documentElement?.classList.contains("dark-mode")||document.body?.classList.contains("dark-mode")}function Un(){return Vn()?{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(30, 58, 138, 0.7))",border:"rgba(59, 130, 246, 0.5)",text:"#e2e8f0"}:{background:"linear-gradient(135deg, #4361ee, #3a0ca3)",border:"#240c62",text:"#ffffff"}}function zn(e){const{reservationId:t,customerName:n,paid:a,confirmed:s,completed:r}=e.event.extendedProps,o=a===!0||a==="paid",i=s===!0||s==="true",l=document.createElement("div");l.className="fc-reservation-event";const d=i?c("calendar.badges.confirmed","Ù…Ø¤ÙƒØ¯"):c("calendar.badges.pending","ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),m=o?c("calendar.badges.paid","Ù…Ø¯ÙÙˆØ¹"):c("calendar.badges.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),p=c("calendar.badges.completed","Ù…Ù†ØªÙ‡ÙŠ"),u=c("calendar.labels.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");return l.innerHTML=`
    <div class="fc-reservation-id">${t}</div>
    <div class="fc-reservation-customer">${n||u}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${i?"bg-success":"bg-warning text-dark"}">${d}</span>
      <span class="badge ${o?"bg-primary":"bg-danger"}">${m}</span>
      ${r?`<span class="badge bg-secondary">${p}</span>`:""}
    </div>
  `,{domNodes:[l]}}function Yn(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"));return}const n=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",s=!!e.completed,r=n?c("calendar.badges.confirmed","Ù…Ø¤ÙƒØ¯"):c("calendar.badges.pending","ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),o=a?c("calendar.badges.paid","Ù…Ø¯ÙÙˆØ¹"):c("calendar.badges.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),i=c("calendar.badges.completed","Ù…Ù†ØªÙ‡ÙŠ"),l=j(),d=e.items||[],m=In()||[],p=new Map(m.map(f=>[String(f.id),f])),u=(e.technicians||[]).map(f=>p.get(String(f))).filter(Boolean),g=$n(e.start,e.end),F=d.reduce((f,C)=>f+(C.qty||1)*(C.price||0),0)*g,A=(f={})=>{const C=[f.dailyWage,f.daily_rate,f.dailyRate,f.wage,f.rate];for(const ne of C){if(ne==null)continue;const ge=parseFloat(b(String(ne)));if(Number.isFinite(ge))return ge}return 0},me=u.reduce((f,C)=>f+A(C),0)*g,pe=F+me,te=(()=>{const f=parseFloat(e.discount)||0;return f?e.discountType==="amount"?f:pe*(f/100):0})(),ot=Math.max(0,pe-te),De=e.applyTax?ot*.15:0,sn=e.cost??Math.round(ot+De),rt=c("calendar.labels.currencySuffix","Ø±ÙŠØ§Ù„"),on=d.length?d.map((f,C)=>{const ne=f.image||f.imageUrl||f.img||"",ge=b(String(f.barcode||"-")),pn=b(String(f.qty||1)),fn=b(String(f.price||0)),gn=ne?`<img src="${ne}" alt="${f.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${b(String(C+1))}</td>
            <td>${ge}</td>
            <td>${f.desc||"-"}</td>
            <td>${pn}</td>
            <td>${fn} ${rt}</td>
            <td>${gn}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${c("calendar.labels.noEquipment","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª")}</td></tr>`,fe=[`<div>${c("calendar.summary.baseCost","ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª: <strong>{value} Ø±ÙŠØ§Ù„</strong>").replace("{value}",F.toFixed(2))}</div>`,`<div>${c("calendar.summary.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚: <strong>{value} Ø±ÙŠØ§Ù„</strong>").replace("{value}",me.toFixed(2))}</div>`,`<div>${c("calendar.summary.duration","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: <strong>{value}</strong>").replace("{value}",b(String(g)))}</div>`];if(te>0){const f=l==="en"?"%":"Ùª",C=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${f}`:`${te.toFixed(2)} ${rt}`;fe.push(`<div>${c("calendar.summary.discount","ğŸ’¸ Ø§Ù„Ø®ØµÙ…: <strong>{value}</strong>").replace("{value}",C)}</div>`)}e.applyTax&&De>0&&fe.push(`<div>${c("calendar.summary.tax","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%): <strong>{value} Ø±ÙŠØ§Ù„</strong>").replace("{value}",De.toFixed(2))}</div>`),fe.push(`<div>${c("calendar.summary.total","ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <strong>{value} Ø±ÙŠØ§Ù„</strong>").replace("{value}",sn.toFixed(2))}</div>`);const rn=b(String(e.reservationId??e.id??"")),cn=e.start?b(ie(e.start)):"-",ln=e.end?b(ie(e.end)):"-",dn=e.notes?b(e.notes):c("calendar.labels.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),un=e.customerName||c("calendar.labels.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),mn=[{icon:"ğŸ†”",label:c("calendar.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"),value:rn},{icon:"ğŸ‘¤",label:c("calendar.labels.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:un},{icon:"ğŸ—“ï¸",label:c("calendar.labels.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),value:cn},{icon:"ğŸ—“ï¸",label:c("calendar.labels.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),value:ln},{icon:"ğŸ“",label:c("calendar.labels.notes","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),value:dn}];t.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${r}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${o}</span>
      ${s?`<span class="badge bg-secondary">${i}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${mn.map(f=>`
        <div class="calendar-info-row">
          <span class="label">${f.icon} ${f.label}</span>
          <span class="value">${f.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${c("calendar.sections.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ")}</h6>
    ${u.length?`<ul class="list-unstyled calendar-reservation-technicians">${u.map(f=>{const C=f.role?` â€” ${f.role}`:"";return`<li><strong>${f.name}</strong>${C}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${c("calendar.emptyStates.noCrew","ğŸ˜ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø².")}</p>`}
    <h6 class="calendar-section-title">${c("calendar.sections.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${c("calendar.table.headers.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯")}</th>
            <th>${c("calendar.table.headers.description","Ø§Ù„ÙˆØµÙ")}</th>
            <th>${c("calendar.table.headers.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©")}</th>
            <th>${c("calendar.table.headers.price","Ø§Ù„Ø³Ø¹Ø±")}</th>
            <th>${c("calendar.table.headers.image","Ø§Ù„ØµÙˆØ±Ø©")}</th>
          </tr>
        </thead>
        <tbody>${on}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${fe.join("")}
    </div>
  `;const it=document.getElementById("calendarReservationModal");it&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(it).show():alert(c("calendar.alerts.cannotOpenModal","Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„"))}function $e(){Pn(),Hn(),On();const{calendarEl:e}=Dt();if(!e)return;const t=Nn();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");G({error:n}),Ne();return}(async()=>{G({loading:!0});const n=await _n();if(P){const s=c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");G({loading:!1,error:P||s}),Ne();return}const a=xt(n);E?(E.setOption("locale",j()),E.setOption("buttonText",pt()),Rt(a)):(E=new t.Calendar(e,{initialView:jt(),locale:j(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:pt(),events:a,eventContent:zn,eventClick(s){Yn(s.event.extendedProps)},windowResize:se}),E.render()),se(),Ft(a),G({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{se()},120)})().catch(n=>{console.error("âŒ [calendar] renderCalendar failed",n),P=n instanceof Error&&n.message||P||"";const a=c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");G({loading:!1,error:P||a}),Ne()})}let Oe=null,Te=null,Se=null;const T={range:"all",status:"all",payment:"all",search:"",start:null,end:null};let ft=!1,gt=!1,je=null;const v={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let Ae=!1,Le="";const q={icon:null,title:null,subtitle:null};let bt=!1;function y(e,t,n=t){const a=j()==="en"?n??t:t;return c(e,a)}function ht(){_e(),L(),setTimeout(()=>{_e(),L()},0),setTimeout(()=>{_e(),L()},60)}function Q(){T.range==="custom"&&L()}function _e(){Oe=null,Te=null,Se=null}function Ze(){return(j()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function _t(){const e=j();if(e!==Oe||!Te||!Se){Oe=e;const t=Ze();Te=new Intl.NumberFormat(t,{maximumFractionDigits:0}),Se=new Intl.NumberFormat(t,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Te,currencyFormatter:Se}}function Wn(e){const t=Ze();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function Pt(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Ht(e={}){const t=b(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function Ot(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",s=e?.confirmed===!0||we(a)==="confirmed"||we(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:s}}function Gn(){if(typeof _!="function")return!1;let e;try{e=_()}catch(i){return console.warn("âš ï¸ [reports] Failed to access cached data",i),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:s=[],projects:r=[]}=e;return t.length||n.length||a.length||s.length||r.length?(v.reservations=Array.isArray(t)?t.map(kn):[],v.customers=Array.isArray(n)?n.map(Pt):[],v.equipment=Array.isArray(a)?a.map(Ht):[],v.technicians=Array.isArray(s)?s.map(Mt):[],v.projects=Array.isArray(r)?r.map(Ot):[],v.projectsMap=new Map(v.projects.map(i=>[i.id,i])),!0):!1}function Vt(e){return e?.projectId&&v.projectsMap.get(String(e.projectId))||null}function W(e){const t=Vt(e),n=kt(e,t),a=we(n.projectStatus);let s=we(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(s=a),(!s||s==="cancelled")&&(s=n.effectiveConfirmed?"confirmed":"pending"),(Bn(e)||a==="completed")&&(s="completed");const r=n.effectiveConfirmed||s==="confirmed"||s==="completed";r&&s!=="completed"&&(s="confirmed");const o=ta(e);return{statusValue:s,confirmed:r,paid:o}}async function Ut({silent:e=!1}={}){if(!Ae){Ae=!0,Le="",e||L();try{const[t,n,a,s,r]=await Promise.all([D("/reservations/?limit=500"),D("/customers/?limit=500"),D("/equipment/?limit=500"),D("/technicians/?limit=500"),D("/projects/?limit=500")]);v.reservations=Array.isArray(t?.data)?t.data.map(o=>Mn(o)):[],v.customers=Array.isArray(n?.data)?n.data.map(Pt):[],v.equipment=Array.isArray(a?.data)?a.data.map(Ht):[],v.technicians=Array.isArray(s?.data)?s.data.map(Mt):[],v.projects=Array.isArray(r?.data)?r.data.map(Ot):[],v.projectsMap=new Map(v.projects.map(o=>[o.id,o]))}catch(t){console.error("âŒ [reports] Failed to load reports data",t),Le=t instanceof qt?t.message:c("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),v.reservations=[],v.customers=[],v.equipment=[],v.technicians=[],v.projects=[],v.projectsMap=new Map}finally{Ae=!1,L()}}}function be(){Ut({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function Ve({active:e,icon:t,title:n,subtitle:a}){const s=document.getElementById("reports-empty-state");if(!s)return;const r=s.querySelector(".reports-empty-icon"),o=s.querySelector("h4"),i=s.querySelector("p");q.icon===null&&r&&(q.icon=r.textContent),q.title===null&&o&&(q.title=o.textContent),q.subtitle===null&&i&&(q.subtitle=i.textContent),s.classList.toggle("active",!!e),!(!r||!o||!i)&&(e?(r.textContent=t!==void 0?t:q.icon??r.textContent,o.textContent=n!==void 0?n:q.title??o.textContent,i.textContent=a!==void 0?a:q.subtitle??i.textContent):(r.textContent=q.icon??r.textContent,o.textContent=q.title??o.textContent,i.textContent=q.subtitle??i.textContent))}function Kn(){if(ft)return;ft=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-start"),s=document.getElementById("reports-end"),r=document.getElementById("reports-refresh"),o=document.getElementById("reports-custom-range"),i=document.getElementById("reports-search");if(!e)return;e.value=T.range,Gn()&&L(),e.addEventListener("change",()=>{T.range=e.value,yt(o,T.range==="custom"),T.range!=="custom"&&(T.start=null,T.end=null),L()}),t?.addEventListener("change",()=>{T.status=t.value,L()}),n?.addEventListener("change",()=>{T.payment=n.value,L()}),i?.addEventListener("input",()=>{const d=i.value||"";je&&clearTimeout(je),je=setTimeout(()=>{T.search=d,L()},220)}),a?.addEventListener("change",()=>{T.start=a.value||null,Q()}),s?.addEventListener("change",()=>{T.end=s.value||null,Q()}),r?.addEventListener("click",()=>{T.range==="custom"&&(T.start=a?.value||null,T.end=s?.value||null),L()}),Qn(a,s),yt(o,!1),gt||(document.addEventListener("language:changed",ht),document.addEventListener("language:translationsReady",ht),gt=!0),bt||(document.addEventListener("reservations:changed",be),document.addEventListener("customers:changed",be),document.addEventListener("equipment:changed",be),document.addEventListener("technicians:updated",be),bt=!0),Ut()}function L(){if(Ae){Ve({active:!0,icon:"â³",title:c("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:c("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(Le){Ve({active:!0,icon:"âš ï¸",title:Le,subtitle:c("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=v,s=Zn(e,T,t,n,a),r=na(s),o=aa(s),i=sa(s),l=oa(s),d=ra(s,t),m=ia(s,n);ga(r),la(o),Tt("reports-status-breakdown",i),Tt("reports-payment-breakdown",l),da(d),ua(m),ca(s,t,a),ba(s.length===0)}function Qn(e,t){if(!window.flatpickr)return;const n=window.flatpickr?.l10ns?.ar?window.flatpickr.l10ns.ar:null,a=o=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...o};return n&&(i.locale=n),i};let s=null,r=null;e&&(s=window.flatpickr(e,a({onChange(o,i){T.start=i||null,r&&(o?.length?r.set("minDate",o[0]):r.set("minDate",null),Q())},onValueUpdate(o,i){T.start=i||null,Q()}}))),t&&(r=window.flatpickr(t,a({onChange(o,i){T.end=i||null,s&&(o?.length?s.set("maxDate",o[0]):s.set("maxDate",null),Q())},onValueUpdate(o,i){T.end=i||null,Q()}}))),s&&t?.value&&(s.setDate(e.value,!1),s.set("maxDate",r?.selectedDates?.[0]||t.value)),r&&e?.value&&(r.setDate(t.value,!1),r.set("minDate",s?.selectedDates?.[0]||e.value))}function yt(e,t){e&&e.classList.toggle("active",!!t)}function zt(e){return b(String(e||"")).toLowerCase().trim()}function Zn(e,t,n,a,s){const{startDate:r,endDate:o}=Xn(t),i=zt(t.search),l=!!i,d=new Map((n||[]).map(u=>[String(u.id),u])),m=new Map((a||[]).map(u=>[Ce(u?.barcode),u])),p=new Map((s||[]).map(u=>[String(u.id),u]));return(e||[]).filter(u=>{const g=u?.start?new Date(u.start):null;if(!g||Number.isNaN(g.getTime())||r&&g<r||o&&g>o)return!1;const{statusValue:S,confirmed:F,paid:A}=W(u);return!(t.status==="confirmed"&&!(S==="confirmed"||S==="completed"||F)||t.status==="pending"&&S!=="pending"||t.status==="completed"&&S!=="completed"||t.payment==="paid"&&!A||t.payment==="unpaid"&&A||l&&!Jn(u,i,d,m,p))})}function Jn(e,t,n,a,s){const r=[],o=e?.reservationId||e?.id;o&&r.push(o),e?.notes&&r.push(e.notes);const{statusValue:i}=W(e);i&&r.push(i);const l=e?.paymentStatus||e?.payment_status;l&&r.push(l),e?.paid!=null&&r.push(e.paid?"paid":"unpaid");const d=n.get(String(e?.customerId));d&&r.push(d.customerName,d.company_name||d.companyName,d.contact_person||"");const m=Vt(e);return m&&r.push(m.title,m.code,m.status),r.push(Yt(e)),(e?.items||[]).forEach(u=>{u?.desc&&r.push(u.desc),u?.barcode&&r.push(u.barcode);const g=a.get(Ce(u?.barcode));g&&r.push(g.desc,g.description,g.name)}),(e?.technicians||[]).forEach(u=>{const g=s.get(String(u));g&&r.push(g.name,g.role,g.department)}),zt(r.filter(Boolean).join(" ")).includes(t)}function Xn({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const o=t?new Date(`${t}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:vt(o)?o:null,endDate:vt(i)?i:null}}let s=new Date(a),r=null;switch(e){case"last30":{r=new Date(a),r.setDate(r.getDate()-29);break}case"thisWeek":{const o=new Date(a),l=(o.getDay()-6+7)%7;o.setDate(o.getDate()-l),o.setHours(0,0,0,0);const d=new Date(o);d.setDate(o.getDate()+6),d.setHours(23,59,59,999),r=o,s.setTime(d.getTime());break}case"thisMonth":{r=new Date(a.getFullYear(),a.getMonth(),1);const o=new Date(a.getFullYear(),a.getMonth()+1,0);s.setTime(o.setHours(23,59,59,999));break}case"thisQuarter":{const o=Math.floor(a.getMonth()/3);r=new Date(a.getFullYear(),o*3,1);const i=new Date(a.getFullYear(),(o+1)*3,0);s.setTime(i.setHours(23,59,59,999));break}case"thisYear":{r=new Date(a.getFullYear(),0,1);const o=new Date(a.getFullYear(),12,0);s.setTime(o.setHours(23,59,59,999));break}case"all":default:r=null,s=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:s}}function vt(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const ea=new Map([["confirmed","confirmed"],["Ù…Ø¤ÙƒØ¯","confirmed"],["Ù…Ø¤ÙƒØ¯Ø©","confirmed"],["approved","confirmed"],["pending","pending"],["Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","pending"],["ØºÙŠØ± Ù…Ø¤ÙƒØ¯","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["Ù…Ù†ØªÙ‡ÙŠ","completed"],["Ù…Ù†ØªÙ‡ÙŠØ©","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["Ù…Ù„ØºÙŠ","cancelled"]]),Et=new Map([["paid",!0],["Ù…Ø¯ÙÙˆØ¹",!0],["Ù…Ø¯ÙÙˆØ¹Ø©",!0],["ØªÙ… Ø§Ù„Ø¯ÙØ¹",!0],["completed",!0],["unpaid",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",!1],["pending",!1],["Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",!1]]);function we(e=""){const t=String(e).toLowerCase().trim();return t?ea.get(t)||t:""}function ta(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&Et.has(a))return Et.get(a)}return e?.paid===!0||e?.paid==="true"}function na(e){const t=e.length;let n=0,a=0,s=0,r=0;e.forEach(i=>{const{statusValue:l,confirmed:d,paid:m}=W(i);l==="completed"&&(a+=1),d&&(n+=1),m&&(s+=1),r+=Number(i?.cost)||0});const o=t?r/t:0;return{total:t,confirmed:n,completed:a,paidCount:s,revenue:r,average:o}}function aa(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const s=new Date(t.getFullYear(),t.getMonth()-a,1),r=s.getFullYear(),o=s.getMonth(),i=e.filter(p=>{const u=p?.start?new Date(p.start):null;return u&&u.getFullYear()===r&&u.getMonth()===o}),l=i.length,d=i.reduce((p,u)=>p+(Number(u?.cost)||0),0),m=Wn(s);n.push({label:m,count:l,revenue:d})}return n}function sa(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(o=>{const{statusValue:i,confirmed:l}=W(o);i==="completed"?t.completed+=1:i==="confirmed"||l?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,s=t.pending,r=t.completed;return[{label:y("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed"},{label:y("reservations.reports.status.pendingLabel","Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","Pending confirmation"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-pending"},{label:y("reservations.reports.status.completedLabel","Ù…Ù†ØªÙ‡ÙŠØ©","Completed"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-completed"}]}function oa(e){const t=e.length||1,n=e.filter(s=>W(s).paid).length,a=e.length-n;return[{label:y("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid"},{label:y("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid"}]}function ra(e,t){const n=new Map,a=new Map((t||[]).map(s=>[String(s.id),s]));return e.forEach(s=>{const r=String(s?.customerId??"unknown"),o=n.get(r)||{count:0,revenue:0};o.count+=1,o.revenue+=Number(s?.cost)||0,n.set(r,o)}),Array.from(n.entries()).map(([s,r])=>({name:a.get(s)?.customerName||y("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),count:r.count,revenue:r.revenue})).sort((s,r)=>r.revenue-s.revenue).slice(0,5)}function ia(e,t){const n=new Map,a=new Map((t||[]).map(s=>[Ce(s?.barcode),s]));return e.forEach(s=>{(s?.items||[]).forEach(r=>{const o=Ce(r?.barcode),i=o||(r?.desc??"unknown"),l=r?.desc||a.get(o)?.desc||a.get(o)?.description||y("reservations.reports.topEquipment.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…","Unnamed equipment"),d=Number(r?.qty)||1,m=d*(Number(r?.price)||0),p=n.get(i)||{name:l,count:0,revenue:0};p.name=l,p.count+=d,p.revenue+=m,n.set(i,p)})}),Array.from(n.values()).sort((s,r)=>r.count-s.count).slice(0,5)}function ca(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return;if(!e||e.length===0){a.innerHTML=`<tr><td colspan="6" class="text-muted">${y("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}const s=new Map((t||[]).map(i=>[String(i.id),i])),r=new Map((n||[]).map(i=>[String(i.id),i])),o=[...e].sort((i,l)=>new Date(l.start||0)-new Date(i.start||0)).slice(0,20).map(i=>ma(i,s,r));a.innerHTML=o.map(i=>`
      <tr>
        <td>${i.code}</td>
        <td>${i.customer}</td>
        <td>${i.date}</td>
        <td>${i.status}</td>
        <td>${i.payment}</td>
        <td>${i.total}</td>
      </tr>
    `).join("")}function la(e){const t=document.getElementById("reports-volume-chart");if(!t)return;if(!e||e.length===0){t.innerHTML=`<p class="text-muted">${y("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const n=Math.max(1,...e.map(a=>a.count));t.innerHTML=e.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/n*100))}%"></div>
          <span class="value">${x(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function Tt(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<p class="text-muted">${y("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}n.innerHTML=t.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${x(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${y("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",x(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function da(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-muted">${y("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${x(n.count)}</td>
        <td>${ce(n.revenue)}</td>
      </tr>
    `).join("")}}function ua(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-muted">${y("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${x(n.count)}</td>
        <td>${ce(n.revenue)}</td>
      </tr>
    `).join("")}}function ma(e,t,n){const a=e?.reservationId||e?.id||"â€”",r=t.get(String(e?.customerId))?.customerName||y("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),o=fa(e?.start),i=pa(e),l=Yt(e),d=ce(e?.cost||0),m=(e?.technicians||[]).map(S=>n.get(String(S))?.name).filter(Boolean),p=y("reservations.list.crew.separator","ØŒ ",", "),u=m.map(S=>k(S)).join(k(p)),g=m.length?`${k(r)}<br><small class="text-muted">${u}</small>`:k(r);return{code:k(a),customer:g,date:k(o),status:k(i),payment:k(l),total:k(d)}}function Yt(e){const{paid:t}=W(e);return t?y("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"):y("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid")}function pa(e){const{statusValue:t}=W(e);return t==="completed"?y("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"):t==="confirmed"?y("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"):t==="pending"?y("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"):k(t)}function fa(e){if(!e)return"â€”";const t=new Date(e);if(Number.isNaN(t.getTime()))return"â€”";const n=Ze(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return b(a.format(t))}function ga(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-kpi-confirmed"),o=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),l=document.getElementById("reports-kpi-paid-meta"),d=e.total||0,m=e.revenue||0,p=e.confirmed||0,u=e.paidCount||0,g=e.average||0,S=d?Math.round(p/d*100):0,F=d?Math.round(u/d*100):0;if(t&&(t.textContent=x(d)),n){const A=y("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",x(e.completed||0));n.textContent=A}if(a&&(a.textContent=ce(m)),s){const A=y("reservations.reports.kpi.revenue.average","Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø² {value}","Average reservation value {value}").replace("{value}",ce(g));s.textContent=A}if(r&&(r.textContent=`${S}%`),o){const A=y("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",x(p));o.textContent=A}if(i&&(i.textContent=`${F}%`),l){const A=y("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",x(u));l.textContent=A}}function ba(e){Ve({active:!!e})}function k(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function x(e){const{numberFormatter:t}=_t(),n=t.format(Math.round(e||0));return b(n)}function ce(e){const{currencyFormatter:t}=_t(),n=t.format(Math.max(0,Math.round(e||0)));return b(n)}function Ce(e){return(e||"").toString().trim()}const ha=_()||{};let U=(ha.maintenance||[]).map(Wt);function ke(){return U}function Me(e){return U=Array.isArray(e)?e.map(Wt):[],bn({maintenance:U}),qa(),U}async function ya(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,o])=>{o!=null&&o!==""&&t.set(r,String(o))});const n=t.toString(),a=await D(`/maintenance/${n?`?${n}`:""}`),s=Array.isArray(a?.data)?a.data.map(Je):[];return Me(s)}async function va(e){const t=await D("/maintenance/",{method:"POST",body:e}),n=Je(t?.data??{});return Me([n,...U.filter(a=>a.id!==n.id)]),n}async function Ea(e,t){const n=await D(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Je(n?.data??{});return Me(U.map(s=>String(s.id)===String(e)?a:s)),a}async function Ta(e){await D(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Me(U.filter(t=>String(t.id)!==String(e)))}function Sa({equipmentId:e,technicianId:t,issue:n,priority:a,status:s,scheduledAt:r,resolutionReport:o}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:s,notes:n??"",resolution_report:null}}function Je(e={}){return Gt({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function Wt(e={}){return Gt(e)}function Gt(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Aa(e.status_raw??e.status??"open"),s=La(a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:wa(e.priority??"medium"),status:s,statusRaw:a,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Aa(e){const t=String(e??"").trim().toLowerCase();return Ca(t)}function La(e){return["completed","cancelled"].includes(e)?"closed":"open"}function wa(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Ca(e){switch(e){case"open":case"Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"open";case"in_progress":case"in-progress":case"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":case"ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­":case"closed":case"Ù…ØºÙ„Ù‚":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return"open"}}function qa(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function le(e){return e instanceof qt}let Y=ke(),z=[],oe=null,Z=!1,re="",X=Y.length>0,O={id:null,equipmentDesc:"",equipmentBarcode:""},Xe=null,w=null,B=null,ee=null;async function de({showToastOnError:e=!0}={}){if(!Z){Z=!0,re="",M();try{await ya(),X=!0}catch(t){X=Y.length>0,console.error("âŒ [maintenance] Failed to load maintenance tickets",t),re=le(t)?t.message:c("maintenance.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."),e&&h(re,"error")}finally{Z=!1,Y=ke(),M()}}}function Ue(){return c("maintenance.form.selectedInfo","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø¯Ø© Ø¨Ø¹Ø¯.")}function N(e){return b(String(e||"")).trim().toLowerCase()}function St(e=""){return b(String(e)).trim().toLowerCase()}function Ia(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function R(){return Y=ke(),Y}function Kt(e){return R().find(n=>Number(n.id)===Number(e))||null}function et(){const{equipment:e=[]}=_(),t=c("maintenance.table.noName","Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return z=(e||[]).map(n=>({barcode:N(n?.barcode),desc:n?.desc||n?.description||n?.name||t,status:n?.status||"Ù…ØªØ§Ø­",price:Number(n?.price)||0,category:n?.category||""})),z.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),z}function Qt(){return new Set(R().filter(e=>e.status==="open").map(e=>N(e.equipmentBarcode)))}function Be(e){const t=N(e);return t&&(z.length?z:et()).find(a=>a.barcode===t)||null}function $a(e){const t=St(e);return t&&(z.length?z:et()).find(a=>St(a.desc).includes(t))||null}function ze(e){if(!e)return!0;const t=Qt();return e.status==="ØµÙŠØ§Ù†Ø©"||t.has(e.barcode)}function H({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),s&&(s.value="")),r&&(r.textContent=Ue()),oe=null}function Zt(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","Ø¨Ø§Ø±ÙƒÙˆØ¯"),a=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±");t.innerHTML=`
    <strong>${e.desc}</strong><br>
    <span class="text-muted">${n}: ${e.barcode||a}</span>
  `}function tt(e,{silent:t=!1}={}){if(!e)return!1;if(ze(e))return t||h(c("maintenance.toast.equipmentBlocked","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.barcode),s&&(s.value=e.desc),Zt(e),oe=e,!0}function Jt(e,{showFeedback:t=!0}={}){const n=Be(e);return n?tt(n,{silent:!t}):(t&&h(c("maintenance.toast.equipmentNotFoundBarcode","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯")),!1)}function Xt(e,{showFeedback:t=!0}={}){const n=$a(e);return n?tt(n,{silent:!t}):(t&&h(c("maintenance.toast.equipmentNotFoundName","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„")),!1)}function nt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=et(),s=Qt();if(e){const o=c("maintenance.form.blockedSuffix","(ØµÙŠØ§Ù†Ø©)");e.innerHTML=a.map(i=>{const d=i.status==="ØµÙŠØ§Ù†Ø©"||s.has(i.barcode)?`${i.desc} ${o}`:i.desc,m=i.desc.replace(/"/g,"&quot;"),p=d.replace(/"/g,"&quot;");return`<option value="${m}" label="${p}"></option>`}).join("")}const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const o=Be(r.value);!o||ze(o)?(H({keepInputs:!0,silent:!0}),o&&ze(o)&&h(c("maintenance.toast.equipmentBecameBlocked","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø£ØµØ¨Ø­Øª Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§"))):tt(o,{silent:!0})}else H({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),Jt(t.value)||H({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const o=()=>{if(!n.value){H({keepInputs:!0,silent:!0});return}Xt(n.value)||H({keepInputs:!0,silent:!0})};n.addEventListener("change",o),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),o())}),n.dataset.listenerAttached="true"}}async function qe(){try{await Dn({showToastOnError:!1})}catch(e){console.error("âŒ [maintenance] refreshEquipmentData failed",e)}finally{Qe(),nt()}}function en(){const e=document.getElementById("closeMaintenanceModal");if(!e||typeof bootstrap>"u"||!bootstrap?.Modal)return!1;Xe=bootstrap.Modal.getOrCreateInstance(e),w||(w=e.querySelector("#maintenance-close-report")),B||(B=e.querySelector("#maintenance-close-submit")),ee||(ee=e.querySelector("#maintenance-close-modal-details"));const t=e.querySelector("#maintenance-close-form");return t&&!t.dataset.listenerAttached&&(t.addEventListener("submit",Ma),t.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",tn),e.dataset.listenerAttached="true"),!0}function tn(){O={id:null,equipmentDesc:"",equipmentBarcode:""},w&&(w.value=""),ee&&(ee.innerHTML=""),ue(!1)}function ue(e){if(!B)return;const t=c("maintenance.closeModal.saving","â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚..."),n=c("maintenance.closeModal.confirm","âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©");e?(B.disabled=!0,B.dataset.loading="true",B.textContent=t):(B.disabled=!1,B.removeAttribute("data-loading"),B.textContent=n)}function ka(e){const t=Kt(e);if(!t){h(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(!en()){const n=prompt(c("maintenance.prompt.closeReport","Ø£Ø¯Ø®Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©:"));if(n===null)return;const a=n.trim();if(!a){h(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error");return}nn(e,a);return}if(O={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},w&&(w.value=t.resolutionReport||""),ee){c("maintenance.report.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø©");const n=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),a=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),s=O.equipmentDesc||a,r=O.equipmentBarcode?b(O.equipmentBarcode):a;ee.innerHTML=`
      <div class="fw-semibold">${s}</div>
      <div class="text-muted small">${n}: ${r}</div>
    `}ue(!1),Xe?.show(),setTimeout(()=>{w?.focus(),w?.setSelectionRange(w.value.length,w.value.length)},150)}async function Ma(e){if(e?.preventDefault(),!O.id){h(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(!w)return;const t=w.value.trim();if(!t){h(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error"),w.focus();return}ue(!0),(await nn(O.id,t)).success?Xe?.hide():ue(!1)}function Ba(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(d=>d.status==="open").length,s=n-a,r=d=>b(String(d)),o=c("maintenance.stats.open","{count} Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©").replace("{count}",`<strong>${r(a)}</strong>`),i=c("maintenance.stats.closed","{count} Ù…ØºÙ„Ù‚Ø©").replace("{count}",`<strong>${r(s)}</strong>`),l=c("maintenance.stats.total","{count} Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±").replace("{count}",`<strong>${r(n)}</strong>`);t.innerHTML=`
    <span class="maintenance-stat">${o}</span>
    <span class="maintenance-stat">${i}</span>
    <span class="maintenance-stat">${l}</span>
  `}function Da(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.table.emptyFiltered","Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.");t.innerHTML=`<tr><td colspan="6" class="text-muted text-center">${a}</td></tr>`,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const s=c("maintenance.status.open","Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),r=c("maintenance.status.closed","Ù…ØºÙ„Ù‚Ø©"),o=a.status==="open"?`<span class="badge bg-warning text-dark">${s}</span>`:`<span class="badge bg-success">${r}</span>`,i=(()=>{const me=c("maintenance.priority.high","Ù…Ø±ØªÙØ¹Ø©"),pe=c("maintenance.priority.medium","Ù…ØªÙˆØ³Ø·Ø©"),te=c("maintenance.priority.low","Ù…Ù†Ø®ÙØ¶Ø©");switch(a.priority){case"high":return`<span class="badge bg-danger">${me}</span>`;case"low":return`<span class="badge bg-secondary">${te}</span>`;default:return`<span class="badge bg-info text-dark">${pe}</span>`}})(),l=[],d=c("maintenance.actions.close","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),m=c("maintenance.actions.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),p=c("maintenance.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒØ±Ø©");a.status==="open"?l.push(`<button class="btn btn-sm btn-success" data-action="close" data-id="${a.id}">${d}</button>`):l.push(`<button class="btn btn-sm btn-warning" data-action="view" data-id="${a.id}">${m}</button>`),Ke()&&l.push(`<button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}">${p}</button>`);const u=l.join(""),g=c("maintenance.table.noBarcode","Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯"),S=c("maintenance.report.none","â€”"),F=a.equipmentBarcode?b(a.equipmentBarcode):g,A=a.issue?b(a.issue):S,st=a.createdAt?b(ie(a.createdAt)):"â€”";return`
        <tr>
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${F}</small>
          </td>
          <td class="maintenance-issue-text">${A}</td>
          <td>${i}</td>
          <td>${st}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${u}
            </div>
          </td>
        </tr>
      `}).join("")}}function xa(e){if(!X||Z){h(c("maintenance.toast.loading","â³ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø©..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")ka(a);else if(n==="view")Ra(a);else if(n==="delete"){if(!Ke()){It();return}Fa(a).catch(s=>{console.error("âŒ [maintenance] deleteTicket failed",s)})}}}async function nn(e,t){const n=Kt(e);if(!n)return h(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),{success:!1};const a=(t??"").trim();if(!a)return h(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error"),{success:!1};const s=Ia(new Date)||new Date().toISOString();try{await Ea(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:s}),await de({showToastOnError:!1});const r=document.getElementById("maintenance-status-filter");return r&&r.value==="open"&&(r.value="all"),await qe(),M(),h(c("maintenance.toast.ticketClosed","âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©")),{success:!0}}catch(r){if(console.error("âŒ [maintenance] closeTicket failed",r),le(r)&&r.status===404)return await de({showToastOnError:!1}),await qe(),M(),h(c("maintenance.toast.ticketAlreadyClosed","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ°Ø§ÙƒØ±ØŒ ÙˆÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹"),"info"),{success:!0};const o=le(r)?r.message:c("maintenance.toast.updateError","âš ï¸ ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return h(o,"error"),{success:!1,error:r}}}function Ra(e){const n=R().find(u=>Number(u.id)===Number(e));if(!n)return;const a=c("maintenance.report.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø©"),s=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),r=c("maintenance.report.issue","Ø§Ù„ÙˆØµÙ"),o=c("maintenance.report.createdAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"),i=c("maintenance.report.closedAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),l=c("maintenance.report.summary","Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),d=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),m=c("maintenance.report.none","â€”"),p=[`${a}: ${n.equipmentDesc}`,`${s}: ${n.equipmentBarcode?b(n.equipmentBarcode):d}`,`${r}: ${n.issue?b(n.issue):m}`,`${o}: ${n.createdAt?b(ie(n.createdAt)):m}`,`${i}: ${n.resolvedAt?b(ie(n.resolvedAt)):m}`,`${l}: ${n.resolutionReport?b(n.resolutionReport):m}`].join(`
`);alert(p)}async function Fa(e){if(!Ke()){It();return}if(!R().find(a=>Number(a.id)===Number(e))){h(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©ØŸ")))try{await Ta(e),await de({showToastOnError:!1}),await qe(),h(c("maintenance.toast.ticketDeleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"))}catch(a){console.error("âŒ [maintenance] deleteTicket failed",a);const s=le(a)?a.message:c("maintenance.toast.deleteError","âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");h(s,"error")}}async function Na(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let o=oe,i=N(a?.value);if(!o&&i&&(o=Be(i)),!o&&t?.value&&Jt(t.value,{showFeedback:!0})&&(o=oe,i=N(o?.barcode)),!o&&n?.value&&Xt(n.value,{showFeedback:!0})&&(o=oe,i=N(o?.barcode)),!o||!i){h(c("maintenance.toast.selectEquipment","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø©"));return}const{equipment:l=[]}=_();let d=(l||[]).find(S=>N(S?.barcode)===i);if(!d&&o&&(d={id:o.id,barcode:o.barcode,desc:o.desc,name:o.desc,status:o.status||"Ù…ØªØ§Ø­"}),!d||d.id==null){h(c("maintenance.toast.selectedNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")),H();return}if(d.status==="ØµÙŠØ§Ù†Ø©"){h(c("maintenance.toast.equipmentAlreadyMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø­Ø§Ù„Ø© ØµÙŠØ§Ù†Ø©"));return}if(R().filter(S=>S.status==="open").some(S=>N(S.equipmentBarcode)===i)){h(c("maintenance.toast.ticketExists","âš ï¸ ØªÙˆØ¬Ø¯ ØªØ°ÙƒØ±Ø© ØµÙŠØ§Ù†Ø© Ù…ÙØªÙˆØ­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø©"));return}const u=Sa({equipmentId:d.id,technicianId:null,issue:s?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await va(u),await de({showToastOnError:!1}),await qe(),h(c("maintenance.toast.ticketCreated","ğŸ› ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø¯Ø©")),H(),s&&(s.value=""),r&&(r.value="medium");const g=document.getElementById("maintenance-status-filter");g&&(g.value="all")}catch(t){console.error("âŒ [maintenance] Failed to create ticket",t);const n=le(t)?t.message:c("maintenance.toast.submitError","âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");h(n,"error")}}function ja(e){const t=R();return e==="all"?t:t.filter(n=>n.status===e)}function M(){const e=R();nt(),Ba(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),s=document.getElementById("maintenance-empty-state");if(!a)return;if(Z&&!X){const o=c("maintenance.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${o}</td></tr>`,s&&s.classList.remove("active");return}if(re&&!X){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${re}</td></tr>`,s&&s.classList.remove("active");return}const r=ja(n);Da(r)}function _a(){R(),nt(),X=Y.length>0,Z=!1,M(),de({showToastOnError:!1}),en()&&tn();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Na(a).catch(s=>{console.error("âŒ [maintenance] submit handler failed",s)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{M()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",xa),n.dataset.listenerAttached="true")}R();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=Be(e.value);n?Zt(n):t&&(t.textContent=Ue())}else t&&(t.textContent=Ue());M(),ue(!1)});document.addEventListener(hn.USER_UPDATED,()=>{M()});window.addEventListener("maintenance:updated",()=>{Y=ke(),M()});let ae=null,J=null,Ie=!1,$=null,At=null,Ye=null,Pe=null;function Pa(){console.log("ğŸš€ [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab");console.log("ğŸ“Œ tabButtons:",e),console.log("ğŸ“Œ tabContents:",t);const n=(s,{skipStore:r=!1}={})=>{if(!s)return;const o=e.filter(l=>l?.getAttribute("data-tab")===s),i=document.getElementById(s);!o.length||!i||(e.forEach(l=>{const d=l?.getAttribute("data-tab")===s;l.classList.toggle("active",d),d?(l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0")):(l.setAttribute("aria-selected","false"),l.setAttribute("tabindex","-1"))}),t.forEach(l=>{const d=l.id===s;l.style.display=d?"block":"none",l.classList.toggle("active",d)}),ae=s,r||Ee({dashboardTab:s}).catch(l=>{console.warn("âš ï¸ [tabs.js] Failed to store dashboard tab preference",l)}),s!=="reservations-tab"&&(J=null,$=null,r||Ee({dashboardSubTab:null}).catch(l=>{console.warn("âš ï¸ [tabs.js] Failed to clear sub-tab preference",l)})),s==="customers-tab"&&(console.log("ğŸ‘¤ Rendering customers"),wn()),s==="equipment-tab"&&(console.log("ğŸ“¦ Rendering equipment"),Qe()),s==="maintenance-tab"&&(console.log("ğŸ› ï¸ Rendering maintenance"),M()),s==="technicians-tab"&&(console.log("ğŸ› ï¸ Rendering technicians"),xn()),s==="reservations-tab"&&(console.log("ğŸ“… Rendering reservations"),$t(),Ha(),$&&(he($),$=null)))};e.forEach(s=>{s&&(s.getAttribute("type")||s.setAttribute("type","button"),s.setAttribute("role","tab"),s.hasAttribute("tabindex")||s.setAttribute("tabindex",s.classList.contains("active")?"0":"-1"),s.addEventListener("click",()=>{const r=s.getAttribute("data-tab");console.log("ğŸ–±ï¸ Tab clicked:",r),n(r),r!=="reservations-tab"&&Ee({dashboardSubTab:null}).catch(o=>{console.warn("âš ï¸ [tabs.js] Failed to clear sub-tab preference",o)})}))});const a=s=>{const r=document.querySelector("[data-tab].active"),o=s?.dashboardTab,i=o&&document.getElementById(o)?o:r?.getAttribute("data-tab")||e[0]?.getAttribute("data-tab");i&&(console.log("â­ Initial tab:",i),n(i,{skipStore:!0}));const l=s?.dashboardSubTab;l&&($=l,ae==="reservations-tab"&&(he(l),$=null)),document.body?.classList.remove("tabs-loading"),Ie=!0};yn().then(s=>a(s)).catch(s=>{console.warn("âš ï¸ [tabs.js] Failed to load tab preferences",s),a(null)}),At||(At=vn(s=>{!Ie||!s||(s.dashboardTab&&s.dashboardTab!==ae&&n(s.dashboardTab,{skipStore:!0}),ae==="reservations-tab"?s.dashboardSubTab&&s.dashboardSubTab!==J?he(s.dashboardSubTab):!s.dashboardSubTab&&J&&he(null):s.dashboardSubTab&&($=s.dashboardSubTab))}))}function Ha(){console.log("ğŸš€ [tabs.js] setupSubTabs()");const e=document.querySelectorAll(".sub-tab-button"),t=document.querySelectorAll(".sub-tab");console.log("ğŸ“Œ subTabButtons:",e),console.log("ğŸ“Œ subTabContents:",t);const n=(a,{skipStore:s=!1}={})=>{if(!a)return;const r=document.querySelector(`.sub-tab-button[data-sub-tab="${a}"]`),o=document.getElementById(a);!r||!o||(e.forEach(i=>i.classList.remove("active")),r.classList.add("active"),t.forEach(i=>{i.classList.remove("active")}),o.classList.add("active"),J=a,s||Ee({dashboardSubTab:a}).catch(i=>{console.warn("âš ï¸ [tabs.js] Failed to store sub-tab preference",i)}),a==="my-reservations-tab"?(console.log("ğŸ“‹ Rendering reservations list"),setTimeout(()=>{$t()},50)):a==="calendar-tab"?(console.log("ğŸ“… Rendering calendar view"),setTimeout(()=>{$e()},100)):a==="reports-tab"&&(console.log("ğŸ“Š Rendering reports view"),setTimeout(()=>{L()},50)))};if(Ye=(a,s={})=>{a?n(a,s):(e.forEach(r=>r.classList.remove("active")),t.forEach(r=>r.classList.remove("active")),J=null)},e.forEach(a=>{a.addEventListener("click",()=>{const s=a.getAttribute("data-sub-tab");console.log("ğŸ–±ï¸ Sub-tab clicked:",s),n(s)})}),$)n($,{skipStore:!0}),$=null;else{const s=document.querySelector(".sub-tab-button.active")?.getAttribute("data-sub-tab");s&&(console.log("â­ Initial sub-tab:",s),n(s,{skipStore:!0}))}Bt()}function he(e){typeof Ye=="function"?Ye(e,{skipStore:!0}):e&&($=e)}function Oa(){try{if(typeof ct=="function")return ct()||{}}catch(e){console.warn("âš ï¸ [tabs.js] Failed to read cached preferences",e)}return{}}function Va(){if(!Ie)return;const e=Oa(),t=Array.from(document.querySelectorAll("[data-tab]")),n=Array.from(document.querySelectorAll(".tab"));if(!t.length||!n.length)return;const a=n.find(o=>o.classList.contains("active")),s=t.find(o=>o.classList.contains("active"));let r=a?.id??s?.dataset.tab??(e.dashboardTab&&document.getElementById(e.dashboardTab)?e.dashboardTab:null)??t[0]?.dataset.tab;if(r&&(t.forEach(o=>{const i=o.dataset.tab===r;o.classList.toggle("active",i)}),n.forEach(o=>{const i=o.id===r;o.style.display=i?"block":"none",o.classList.toggle("active",i)}),ae=r,r==="reservations-tab")){const o=Array.from(document.querySelectorAll(".sub-tab-button")),i=Array.from(document.querySelectorAll(".sub-tab"));if(o.length&&i.length){const l=i.find(p=>p.classList.contains("active")),d=o.find(p=>p.classList.contains("active"));let m=l?.id??d?.dataset.subTab??(e.dashboardSubTab&&document.getElementById(e.dashboardSubTab)?e.dashboardSubTab:null)??o[0]?.dataset.subTab;m&&(o.forEach(p=>{p.classList.toggle("active",p.dataset.subTab===m)}),i.forEach(p=>{p.classList.toggle("active",p.id===m)}),J=m)}}}function at(){Ie&&(Pe&&clearTimeout(Pe),Pe=setTimeout(()=>{Va()},0))}document.addEventListener("language:translationsReady",at);document.addEventListener("language:changed",at);document.addEventListener("theme:changed",at);const ye={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let We=!1;function Ua(e){try{const n=(document.documentElement?.lang||"ar")==="ar"?"ar-SA":"en-US";return new Intl.NumberFormat(n,{maximumFractionDigits:0}).format(e??0)}catch{return String(e??0)}}function ve(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=Ua(t))}function Lt(){We=!1;const e=_(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,s=Array.isArray(e.technicians)?e.technicians.length:0;ye.projects.forEach(r=>ve(r,t)),ye.reservations.forEach(r=>ve(r,n)),ye.equipment.forEach(r=>ve(r,a)),ye.technicians.forEach(r=>ve(r,s))}function wt(){We||(We=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(Lt):setTimeout(Lt,16))}function za(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,wt,{passive:!0})}),wt()}const Ya=1024;function V(){return typeof window>"u"?!1:window.innerWidth>=Ya}function Wa(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function Ge({sidebar:e,backdrop:t}){e?.classList.add("open"),V()?t?.classList.remove("open"):t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function K({sidebar:e,backdrop:t}){e?.classList.remove("open"),V()?e?.setAttribute("aria-hidden","false"):(t?.classList.remove("open"),e?.setAttribute("aria-hidden","true"))}function Ga(e){V()?Ge(e):K(e)}function Ka(){const e=Wa(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:s}=e;if(!t)return;(()=>{V()?Ge(e):K(e)})(),a?.addEventListener("click",o=>{o.preventDefault(),!V()&&Ge(e)}),s?.addEventListener("click",o=>{o.preventDefault(),!V()&&K(e)}),n?.addEventListener("click",()=>{V()||K(e)}),t.addEventListener("click",o=>{const i=o.target;if(i instanceof HTMLElement){if(i.hasAttribute("data-close-sidebar")||i.closest("[data-close-sidebar]")){K(e);return}i.closest("[data-tab]")&&K(e)}}),typeof window<"u"&&window.addEventListener("resize",()=>{Ga(e)},{passive:!0})}En();let I=null;async function Ct(){if(!await Tn())return;Ka(),Pa(),za(),Sn(),Qe(),$e(),_a(),Kn(),Ln(),Bt();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await Rn(s),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",An),Qa(),Za()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Ct().catch(e=>{console.error("âŒ Failed to initialise app",e)})},{once:!0}):Ct().catch(e=>{console.error("âŒ Failed to initialise app",e)});function Qa(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[s]=a.split(":"),r=`${s.padStart(2,"0")}:00`,o=`${n}T${r}`;e.value!==o&&(e.value=o,setTimeout(()=>e.blur(),150))})})}function Za(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;I={reservationId:t,reservationIndex:n!=null?Number(n):null},an(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,s)}function an(){if(!I)return;const t=_().reservations||[];let n=null;if(I.reservationId){const a=t.findIndex(s=>String(s?.id)===I.reservationId||String(s?.reservationId)===I.reservationId);a!==-1&&(n=a)}n===null&&typeof I.reservationIndex=="number"&&!Number.isNaN(I.reservationIndex)&&I.reservationIndex>=0&&I.reservationIndex<t.length&&(n=I.reservationIndex),n!==null&&(I=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const s=window.editReservation;typeof s=="function"&&s(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{I&&an()});
