const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./print.CEJjwyZq.js","./calculations.BXg0KJpW.js","./reservationsService.-J4Tjyma.js","./auth.BoxVGC4W.js","./auth.BTf3u5Rf.css","./state.C85Yubyz.js","./dashboard.CoTRZ2S_.js","./projectDetails.B-ASgvbQ.js","./projectsService.BHDXIHEo.js","./uiBridge.BLZZT8b9.js","./reservationPdf.ByrdZHJD.js","./view.DSLkXJTZ.js","./quotePdf.kDBbUcue.js","./canvasColorUtils.CviLtv6S.js","./customers.BJGBlZqL.js","./controller.CnRIIzLB.js","./details.hdvbM_lL.js","./equipment.D7pobbRe.js","./reservationsActions.B27FSFMQ.js","./dashboardShell.DF2kUed9.js"])))=>i.map(i=>d[i]);
import{s as Ea,f as Ca,e as _r,u as Tr,j as It,t as U,p as yt,b as _t,q as Sa,a as Aa,m as _a,c as Ta,i as La,d as Pa,n as Qt}from"./auth.BoxVGC4W.js";import"./dashboard.CoTRZ2S_.js";import{o as Be,s as Ia,c as Na,r as Lr,i as Ba,b as Ma,a as Ra,d as ka,e as Da,f as qa,g as ja,h as Fa,j as $a,k as Oa,l as Ha,m as Pr,n as vn,p as za,q as ze,t as Ua,u as Wa,v as Va}from"./projectDetails.B-ASgvbQ.js";import"./customers.BJGBlZqL.js";import{h as we,i as $n,j as On,k as Xa,r as Ya}from"./state.C85Yubyz.js";import{r as Ga}from"./controller.CnRIIzLB.js";import{i as Ka}from"./dashboardShell.DF2kUed9.js";import{e as Ir}from"./reservationsActions.B27FSFMQ.js";import{refreshProjectsFromApi as Ae,getProjectsState as ie,ensureProjectsLoaded as Za,isApiError as Nr}from"./projectsService.BHDXIHEo.js";import{d as Z,s as lt,r as de,a as ue,u as _e,P as xn,b as En,c as Hn,e as sn,g as cn,h as zn}from"./view.DSLkXJTZ.js";import{_ as Un}from"./uiBridge.BLZZT8b9.js";import{g as Cn,r as Br,d as ve}from"./reservationsService.-J4Tjyma.js";import{l as Mr,e as Ja,a as Qa,c as to}from"./calculations.BXg0KJpW.js";import"./canvasColorUtils.CviLtv6S.js";import"./reservationPdf.ByrdZHJD.js";import"./quotePdf.kDBbUcue.js";import"./details.hdvbM_lL.js";import"./equipment.D7pobbRe.js";let Wn=null;function eo(t){t&&Rr()!==t&&Tr({[xn]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function Rr(){return _r()?.[xn]||""}function Sn(t){t&&qe()!==t&&Tr({[En]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function qe(){return _r()?.[En]||""}function no(t){if(!t)return"";const e=t.trim();return e?Object.values(Hn).includes(e)?e:Hn[e]||"":""}function kr(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=no(e);if(n)return n}}catch{}return""}function Dr(t,e){!t||!Z.tabPanes||!Z.tabButtons||(Z.tabButtons.forEach(n=>{const r=n===e;n.classList.toggle("active",r),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",r)}),Z.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&eo(t))}function ro(){if(!Z.tabButtons||!Z.tabButtons.length)return;Z.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",r=>{r.preventDefault();const o=n.dataset.tabTarget;o&&(Dr(o,n),o==="projects-section"&&(lt.filters.search="",Z.search&&(Z.search.value=""),de(),ue(),_e()))}),n.dataset.tabListenerAttached="true")});const t=Rr(),e=t&&Z.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}async function Ue(t,e){if(!(!t||!Z.projectSubTabButtons||!Z.projectSubTabPanes)&&(Z.projectSubTabButtons.forEach(n=>{const r=n===e;n.classList.toggle("active",r),n.classList.contains("tab")&&n.classList.toggle("tab-active",r)}),Z.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}),t==="projects-list-tab"))try{(!Array.isArray(lt.projects)||lt.projects.length===0)&&await Ae(),de(),ue(),_e()}catch(n){console.warn("[projects] Failed to render list after sub-tab switch",n)}}function ao(){!Z.projectSubTabButtons||!Z.projectSubTabButtons.length||(Z.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",async e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(await Ue(n,t),Sn(n))}),t.dataset.tabListenerAttached="true")}),oo())}function oo(){const e=kr()||qe();if(!e)return;const n=Z.projectSubTabButtons?.[0],r=Z.projectSubTabButtons?.find(s=>s.dataset.projectSubtabTarget===e)||n,o=r?.dataset.projectSubtabTarget;o&&(e!==qe()&&Sn(o),Ue(o,r))}function so(){return Z.tabButtons?Z.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Vn(t={}){if(t){if(Z.tabButtons&&Z.tabButtons.length){const n=Z.tabButtons.find(o=>o.classList.contains("active"))?.dataset.tabTarget||"",r=t[xn];if(r&&r!==n){const o=Z.tabButtons.find(s=>s.dataset.tabTarget===r);o&&Dr(r,o)}}if(Z.projectSubTabButtons&&Z.projectSubTabButtons.length&&so()){const n=Z.projectSubTabButtons.find(o=>o.classList.contains("active"))?.dataset.projectSubtabTarget||"",r=t[En];if(r&&r!==n){const o=Z.projectSubTabButtons.find(s=>s.dataset.projectSubtabTarget===r);o&&Ue(r,o)}}}}function co(){Wn||(Wn=Ea(t=>{Vn(t)})),Ca().then(t=>{Vn(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function An(t){if(typeof window>"u")return null;try{const r=new URLSearchParams(window.location.search||"").get(t);if(r)return r}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const r=new URLSearchParams(e).get(t);if(r)return r}catch{}return null}function lo(){return An(sn)}function io(){return An(cn)}function uo(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[sn,cn,"linked"].forEach(a=>{t.has(a)&&(t.delete(a),n=!0)});let r=e,o=!1;if(e)try{const a=new URLSearchParams(e);let u=!1;[sn,cn,"linked"].forEach(d=>{a.has(d)&&(a.delete(d),u=!0)}),u&&(r=a.toString(),o=!0)}catch{}if(!n&&!o)return;const s=window.location.pathname,c=t.toString(),i=`${s}${c?`?${c}`:""}${r?`#${r}`:""}`;window.history.replaceState({},"",i)}catch{}}function po(){const t=lo(),e=io(),n=An("linked");t&&(lt.pendingProjectDetailId=t),e&&(lt.pendingProjectEditId=e,lt.pendingProjectDetailId||(lt.pendingProjectDetailId=e)),n!=null&&String(n)!==""&&String(n)!=="0"&&String(n).toLowerCase()!=="false"&&(lt.pendingLinkedToast=!0),(t||e)&&uo()}function mo(){if(!lt.pendingProjectDetailId)return;const t=lt.pendingProjectDetailId,e=String(t),n=lt.projects.find(o=>[o?.id,o?.projectId,o?.project_id].some(c=>c!=null&&String(c)===e));if(!n)return;lt.pendingProjectDetailId=null;const r=n?.id??n?.projectId??n?.project_id??e;if(Be(r),lt.pendingLinkedToast){lt.pendingLinkedToast=!1;try{It(U("projects.toast.linkedReservationCreated","✅ تم ربط الحجز بالمشروع"))}catch{}}if(lt.pendingProjectEditId!=null){const o=String(lt.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(c=>c!=null&&String(c)===o)&&(lt.pendingProjectEditId=null,setTimeout(()=>Ia(n),0))}}let Ke=null;function _n(){return typeof window<"u"&&window.XLSX&&window.XLSX.utils?Promise.resolve(window.XLSX):(Ke||(Ke=Mr("https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js").then(()=>window.XLSX)),Ke)}function ae(t){const e=String(t||"").replace("#","");return e.length===3?e.split("").map(n=>n+n).join("").toUpperCase():e.slice(0,6).toUpperCase()}function je(t="#9CA3AF"){const e={rgb:ae(t)};return{top:{style:"thin",color:e},right:{style:"thin",color:e},bottom:{style:"thin",color:e},left:{style:"thin",color:e}}}function Xn(t){const e=Array.from(t.querySelectorAll("tr")),n=[];return e.forEach((r,o)=>{const s=Array.from(r.children),c=[];s.forEach(i=>{const a=(i.tagName||"").toLowerCase(),u=(i.textContent||"").replace(/\u00A0/g," ").trim(),l=a==="th"||i.classList.contains("cs-crew-title")||i.classList.contains("cs-cast-title")?{font:{bold:!0,color:{rgb:ae("#FFFFFF")}},fill:{patternType:"solid",fgColor:{rgb:ae("#2563EB")}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:je("#9CA3AF")}:{alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:je("#CBD5E1")};c.push({v:u,s:l})}),n.push(c)}),n}function Tn(t){t["!merges"]||(t["!merges"]=[]),t["!cols"]||(t["!cols"]=[])}function qr(t,e,n){const r=window.XLSX,o=t["!ref"];if(!o){t["!ref"]=r.utils.encode_range({s:{r:e,c:n},e:{r:e,c:n}});return}const s=r.utils.decode_range(o);e>s.e.r&&(s.e.r=e),n>s.e.c&&(s.e.c=n),e<s.s.r&&(s.s.r=e),n<s.s.c&&(s.s.c=n),t["!ref"]=r.utils.encode_range(s)}function kt(t,e,n,r,o){const c=window.XLSX.utils.encode_cell({r:e,c:n}),i=typeof r=="number"?"n":"s";t[c]={v:r??"",t:i,s:o||{}},qr(t,e,n)}function Ot(t,e,n,r,o){Tn(t),t["!merges"].push({s:{r:e,c:n},e:{r,c:o}})}function Ie(t,e,n,r,o){let s=0,c=0;for(let i=0;i<e.length;i+=1){const a=e[i]||[];c=Math.max(c,a.length);for(let u=0;u<a.length;u+=1){const d=a[u],l=d&&typeof d=="object"&&"v"in d?d.v:d,p=d&&typeof d=="object"&&d.s?d.s:o||{};kt(t,n+i,r+u,l,p)}}return s=e.length,{rows:s,cols:c}}function ho(t,e=[]){Tn(t),t["!cols"]=e.map(n=>({wch:n}))}async function fo(t){const e=await _n(),n=e.utils.book_new(),r={};Tn(r);const o=[5,5,25,6,5,5,6,4,4,10,8,17],s=o.reduce((_,M)=>_+M,0),c=120,i=o.map(_=>Math.max(5,Math.round(_/s*c)));ho(r,i);const a={alignment:{horizontal:"center",vertical:"center",wrapText:!0}},u={alignment:{horizontal:"left",vertical:"top",wrapText:!0}},d=je("#CBD5E1"),l=je("#9CA3AF"),p={...a,border:d},m={...u,border:d},h={font:{bold:!0,color:{rgb:ae("#FFFFFF")},sz:12},fill:{patternType:"solid",fgColor:{rgb:ae("#2563EB")}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:l},f=_=>t&&t.querySelector(_);let y=0;const E=(f(".callsheet-v1 .cs-brand")?.textContent||"").trim(),P=(f(".callsheet-v1 .cs-date")?.textContent||"").trim(),g=(f(".callsheet-v1 .cs-title")?.textContent||"CALL SHEET").trim();kt(r,y,0,E||""),Ot(r,y,0,y,11),r[e.utils.encode_cell({r:y,c:0})].s={font:{bold:!0,sz:20},...a},y+=1,kt(r,y,0,P||""),Ot(r,y,0,y,11),r[e.utils.encode_cell({r:y,c:0})].s={font:{bold:!0,sz:12},...a},y+=1,kt(r,y,0,g),Ot(r,y,0,y,11),r[e.utils.encode_cell({r:y,c:0})].s={font:{bold:!0,sz:14},...a},y+=2,r["!rows"]=r["!rows"]||[],r["!rows"][0]={hpt:26},r["!rows"][1]={hpt:18},r["!rows"][2]={hpt:20};const C=[];try{Array.from(f(".callsheet-v1 .cs-roles tbody")?.querySelectorAll("tr")||[]).forEach(_=>{const M=Array.from(_.children),O=(M[0]?.textContent||"").trim(),$=(M[1]?.textContent||"").trim();C.push([{v:O,s:{...p,font:{bold:!0}}},{v:$,s:p}])})}catch{}const x=[];try{Array.from(f(".callsheet-v1 .cs-times tbody")?.querySelectorAll("tr")||[]).forEach(_=>{const M=Array.from(_.children);x.push([{v:(M[0]?.textContent||"").trim(),s:{...p,font:{bold:!0}}},{v:(M[1]?.textContent||"").trim(),s:p}])})}catch{}const w=[];try{const _=(f(".callsheet-v1 .cs-notes-h")?.textContent||"Important Notes").trim(),M=(f(".callsheet-v1 .cs-notes")?.textContent||"").replace(/\n+/g,`
`).trim(),O=(f(".callsheet-v1 .cs-section")?.textContent||"Locations").trim(),$=(f(".callsheet-v1 .cs-locations")?.textContent||"").trim();w.push([{v:_,s:h}]),w.push([{v:M,s:m}]),w.push([{v:O,s:h}]),w.push([{v:$,s:m}])}catch{}const T=y,I=Ie(r,C,T,0,p).rows,L=Ie(r,x,T,8,p).rows;for(let _=0;_<w.length;_+=1){const M=T+_,O=w[_][0];kt(r,M,4,O.v,O.s),Ot(r,M,4,M,7)}const A=Math.max(I,w.length,L),k=(_,M,O,$)=>{const G="medium";for(let F=_;F<=O;F+=1)for(let H=M;H<=$;H+=1){const at=e.utils.encode_cell({r:F,c:H}),rt=r[at]||{v:"",t:"s",s:{}},Q=rt.s.border||{},gt={rgb:ae("#9CA3AF")};F===_&&(Q.top={style:G,color:gt}),F===O&&(Q.bottom={style:G,color:gt}),H===M&&(Q.left={style:G,color:gt}),H===$&&(Q.right={style:G,color:gt}),rt.s.border={...rt.s.border,...Q},r[at]=rt,qr(r,F,H)}};I>0&&k(T,0,T+I-1,3),w.length>0&&k(T,4,T+w.length-1,7),L>0&&k(T,8,T+L-1,11),y=T+A+2;const q=f(".callsheet-v1 .cs-cast");if(q){const _=y;kt(r,y,0,"Cast Calls",h),Ot(r,y,0,y,11),y+=1;const M=Xn(q).slice(1),O=Ie(r,M,y,2,p);k(_,2,y+O.rows-1,9),r["!rows"][_]={hpt:22},y+=O.rows+2}const B=f(".callsheet-v1 .cs-crew");if(B){const _=y;kt(r,y,0,"Crew Call",h),Ot(r,y,0,y,11),r["!rows"][y]={hpt:22},y+=1;const M=[[0,2],[3,7],[8,10],[11,11]];["Position","Name","Phone","Time"].forEach(($,G)=>{const[F,H]=M[G];kt(r,y,F,$,h),H>F&&Ot(r,y,F,y,H)}),r["!rows"][y]={hpt:18},y+=1,Array.from(B.querySelectorAll("tbody tr")).forEach($=>{const G=Array.from($.children);[0,1,2,3].map(H=>(G[H]?.textContent||"").trim()).forEach((H,at)=>{const[rt,Q]=M[at];kt(r,y,rt,H,at===1?m:p),Q>rt&&Ot(r,y,rt,y,Q)}),y+=1}),k(_,0,y-1,11),y+=2}const b=f(".callsheet-v1 .cs-schedule");if(b){const _=Xn(b),M=Ie(r,_,y,0,p);k(y,0,y+M.rows-1,11),r["!rows"][y]={hpt:18},y+=M.rows+1}e.utils.book_append_sheet(n,r,"Call Sheet");let R="CallSheet.xlsx";try{const _=(document.querySelector("#templates-save-title")?.value||"").trim();_&&(R=`${_}-CallSheet.xlsx`)}catch{}const D=e.write(n,{bookType:"xlsx",type:"array"}),N=new Blob([D],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),j=URL.createObjectURL(N),X=document.createElement("a");X.href=j,X.download=R,document.body.appendChild(X),X.click(),X.remove(),URL.revokeObjectURL(j)}function yo(t,e){try{if(!t)return;const n=(localStorage.getItem("templates.debugOverlay")||"")==="1";let r=document.getElementById("tpl-debug-overlay");if(!n){r&&r.remove();return}r||(r=document.createElement("div"),r.id="tpl-debug-overlay",Object.assign(r.style,{position:"absolute",top:"8px",left:"8px",background:"rgba(17,24,39,0.85)",color:"#fff",padding:"8px 10px",font:"12px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto",borderRadius:"8px",zIndex:"9999",maxWidth:"36vw",direction:"ltr",textAlign:"left"}),t.appendChild(r));const o=[],s=Array.isArray(e?.crewAssignments)?e.crewAssignments:[],c=Array.isArray(e?.techniciansDetails)?e.techniciansDetails:[],i=Array.isArray(e?.technicians)?e.technicians:[];o.push(`crewAssignments: ${s.length}`),o.push(`techniciansDetails: ${c.length}`),o.push(`technicians: ${i.length}`);const a=m=>m&&m.length?m[0]:null,u=m=>m&&typeof m=="object"?Object.keys(m):[],d=a(s);d&&o.push(`CA keys: ${u(d).join(", ")}`);const l=a(c);l&&o.push(`TD keys: ${u(l).join(", ")}`);const p=a(i);p&&typeof p!="string"&&o.push(`T keys: ${u(p).join(", ")}`),r.innerHTML=o.map(m=>`<div>${go(m)}</div>`).join("")}catch{}}function go(t){try{return String(t).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}catch{return String(t)}}function v(t,e={},n=[]){const r=document.createElement(t);return Object.entries(e||{}).forEach(([o,s])=>{o==="class"?r.className=s:o==="text"?r.textContent=s:o==="html"?r.innerHTML=s:r.setAttribute(o,s)}),(Array.isArray(n)?n:[n]).filter(Boolean).forEach(o=>r.appendChild(o)),r}function jr({landscape:t=!1,headerFooter:e=!1,logoUrl:n=""}={}){const o=typeof localStorage<"u"&&localStorage.getItem("templates.lang")==="ar"?"rtl":"ltr",s=v("div",{id:"templates-a4-root","data-render-context":"preview",dir:o}),c=v("div",{"data-a4-pages":""}),i=v("section",{class:`a4-page${t?" a4-page--landscape":""}${e?" a4-page--with-hf":""}`}),a=v("div",{class:"a4-inner"});if(e){const u=v("div",{class:"tpl-print-header"},[v("div",{class:"brand"},[v("img",{src:n,alt:"Logo",referrerpolicy:"no-referrer"}),v("div",{class:"brand-text",text:"Art Ratio"})]),v("div",{class:"meta"},[v("div",{text:new Date().toLocaleDateString()})])]),d=v("div",{class:"tpl-print-footer"},[v("div",{class:"footer-left",text:"art-ratio.com"}),v("div",{class:"page-num",html:"<span data-page-num>1</span> / <span data-page-count>1</span>"})]);i.appendChild(u),i.appendChild(d)}return i.appendChild(a),c.appendChild(i),s.appendChild(c),{root:s,inner:a}}function J(t,e){try{return(typeof localStorage<"u"&&localStorage.getItem("templates.lang")==="ar"?"ar":"en")==="ar"&&e||t}catch{return t}}function ee(t,e="",n=!0){const r=v("div",{class:"cell"});r.appendChild(v("span",{class:"label",text:t}));const o=v("div",{"data-editable":n?"true":"false",contenteditable:n?"true":"false"});try{o.setAttribute("dir","auto")}catch{}return o.textContent=e||"",r.appendChild(o),r}function Fr(){try{return{url:localStorage.getItem("templates.callsheet.logo2.url")||"",s:Number(localStorage.getItem("templates.callsheet.logo2.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo2.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo2.y")||"0")||0}}catch{return{url:"",s:1,x:0,y:0}}}function bo(t={}){try{typeof t.url=="string"&&localStorage.setItem("templates.callsheet.logo2.url",t.url),Number.isFinite(t.s)&&localStorage.setItem("templates.callsheet.logo2.s",String(t.s)),Number.isFinite(t.x)&&localStorage.setItem("templates.callsheet.logo2.x",String(t.x)),Number.isFinite(t.y)&&localStorage.setItem("templates.callsheet.logo2.y",String(t.y))}catch{}}function wo(t,e){try{if(!t||!e)return;let n=!1,r=0,o=0,s=0,c=0;const i=()=>{try{const l=e.style.transform||"",p=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(l),m=/scale\(([-\d.]+)\)/.exec(l);return{x:Number(p?.[1]||0)||0,y:Number(p?.[2]||0)||0,s:Number(m?.[1]||1)||1}}catch{return{x:0,y:0,s:1}}},a=l=>{n=!0;const p=i();s=p.x,c=p.y,r=l.clientX,o=l.clientY;try{l.preventDefault()}catch{}},u=l=>{if(!n)return;const p=l.clientX-r,m=l.clientY-o,h=Math.round(s+p),f=Math.round(c+m),y=Math.max(.3,Math.min(3,Number(Fr().s||1)));e.style.transform=`scale(${y}) translate(${h}px, ${f}px)`},d=()=>{if(!n)return;n=!1;const l=i();bo({x:l.x,y:l.y})};e.addEventListener("pointerdown",a),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",d,{passive:!0})}catch{}}function $r(){try{return{s:Number(localStorage.getItem("templates.callsheet.logo1.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo1.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo1.y")||"0")||0,h:localStorage.getItem("templates.callsheet.logo1.h")==="1"}}catch{return{s:1,x:0,y:0,h:!1}}}function Yn(t={}){try{Number.isFinite(t.s)&&localStorage.setItem("templates.callsheet.logo1.s",String(t.s)),Number.isFinite(t.x)&&localStorage.setItem("templates.callsheet.logo1.x",String(t.x)),Number.isFinite(t.y)&&localStorage.setItem("templates.callsheet.logo1.y",String(t.y)),typeof t.h=="boolean"&&localStorage.setItem("templates.callsheet.logo1.h",t.h?"1":"0")}catch{}}function vo(t,e){try{if(!t||!e)return;let n=!1,r=0,o=0,s=0,c=0;const i=()=>{try{const p=e.style.transform||"",m=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(p),h=/scale\(([-\d.]+)\)/.exec(p);return{x:Number(m?.[1]||0)||0,y:Number(m?.[2]||0)||0,s:Number(h?.[1]||1)||1}}catch{return{x:0,y:0,s:1}}},a=p=>{n=!0;const m=i();s=m.x,c=m.y,r=p.clientX,o=p.clientY;try{p.preventDefault()}catch{}},u=p=>{if(!n)return;const m=p.clientX-r,h=p.clientY-o,f=Math.round(s+m),y=Math.round(c+h),E=Math.max(.3,Math.min(3,Number($r().s||1)));e.style.transform=`scale(${E}) translate(${f}px, ${y}px)`},d=()=>{if(!n)return;n=!1;const p=i();Yn({x:p.x,y:p.y})};e.addEventListener("pointerdown",a),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",d,{passive:!0});const l=document.getElementById("tpl-logo1-size");if(l){const p=m=>{const h=Math.max(.3,Math.min(3,Number(m||1))),f=i();try{e.style.transform=`scale(${h}) translate(${f.x}px, ${f.y}px)`}catch{}Yn({s:h})};l.addEventListener("input",m=>{p(m?.target?.value)})}}catch{}}function Or(t,e){if(!t||!e)return;const n=(()=>{if(Array.isArray(e.crewAssignments)&&e.crewAssignments.length)return e.crewAssignments;if(Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length)return e.techniciansDetails;const s=Array.isArray(e.technicians)?e.technicians:[];if(s.length){const c=we()||[],i=new Map(c.map(u=>[String(u.id),u])),a=new Map(c.map(u=>[String((u.name||u.full_name||"").trim().toLowerCase()),u]));return s.map(u=>{if(u&&typeof u=="object"){const p=u.id??u.technicianId,m=u.name??u.full_name??u.technician_name,h=p!=null&&i.get(String(p))||(m?a.get(String(m).trim().toLowerCase()):null);return h?{technicianId:h.id,technicianName:h.name||h.full_name,technicianPhone:h.phone,technicianRole:h.role||h.specialization}:{technicianName:m||"",technicianId:p??null}}const d=String(u||"").trim(),l=i.get(d)||a.get(d.toLowerCase());return l?{technicianId:l.id,technicianName:l.name||l.full_name,technicianPhone:l.phone,technicianRole:l.role||l.specialization}:/^\d+$/.test(d)?{technicianId:d}:{technicianName:d}})}return[]})();try{if(n.length){n.forEach(a=>{try{a&&typeof a.technician=="object"&&(a.technicianId=a.technicianId??a.technician?.id??a.technician_id,a.technicianName=a.technicianName??a.technician?.name??a.technician?.full_name??a.name,a.technicianPhone=a.technicianPhone??a.technician?.phone??a.phone,a.technicianRole=a.technicianRole??a.technician?.role??a.specialization??a.role),a&&typeof a.position=="object"&&(a.positionLabel=a.positionLabel??a.position?.labelAr??a.position?.labelEn??a.position?.name??a.position_name),a.positionLabel=a.positionLabel??a.position_name??a.positionName??a.position,a.technicianPhone=a.technicianPhone??a.phone_number??a.phoneNumber??a.mobile??a.whatsapp,a.technicianName=a.technicianName??a.full_name??a.technician_name,!a.technicianName&&a.name&&(a.technicianName=a.name)}catch{}});const s=we()||[],c=new Map(s.map(a=>[String(a.id),a])),i=new Map(s.map(a=>[String((a.name||a.full_name||"").trim().toLowerCase()),a]));n.forEach(a=>{const u=a.technicianId??a.technician_id??a.id,d=a.technicianName??a.name,l=u!=null&&c.get(String(u))||(d?i.get(String(d).trim().toLowerCase()):null);l&&(!a.technicianName&&(l.name||l.full_name)&&(a.technicianName=l.name||l.full_name),!a.technicianPhone&&l.phone&&(a.technicianPhone=l.phone),!a.technicianRole&&(l.role||l.specialization)&&(a.technicianRole=l.role||l.specialization))})}}catch{}if(!n.length)return;const r=Array.from(t.querySelectorAll("tbody tr"));(s=>{const c=Math.max(0,s-r.length);for(let i=0;i<c;i+=1){const a=document.createElement("tr");for(let u=0;u<4;u+=1){const d=document.createElement("td");if(d.setAttribute("data-editable","true"),d.setAttribute("contenteditable","true"),u===2){try{d.removeAttribute("dir")}catch{}d.classList.add("dir-ltr")}a.appendChild(d)}t.tBodies[0].appendChild(a),r.push(a)}})(n.length),n.forEach((s,c)=>{const i=r[c];if(!i)return;const a=Array.from(i.children),u=Fe(s),d=s.technicianName||s.name||s.full_name||s.technician_name||"",l=s.technicianPhone||s.phone||s.phoneNumber||s.phone_number||s.mobile||s.whatsapp||"";if(a[0]&&(a[0].textContent=u||""),a[1]&&(a[1].textContent=d||""),a[2]){try{a[2].removeAttribute("dir")}catch{}a[2].classList.add("dir-ltr"),a[2].textContent=l||""}})}function ln(t){try{const e=document.querySelector("#templates-a4-root .callsheet-v1 table.cs-crew");if(!e||!t)return;const n=Array.from(e.querySelectorAll("tbody tr")),r=n.slice(0,Math.min(n.length,6));let o=0,s=0;if(r.forEach(i=>{Array.from(i.children).slice(0,3).forEach(u=>{s+=1,(u.textContent||"").trim()&&(o+=1)})}),(s>0?o/s:0)<=.15){Or(e,t);return}try{const i=(()=>{if(Array.isArray(t.crewAssignments)&&t.crewAssignments.length)return t.crewAssignments;if(Array.isArray(t.techniciansDetails)&&t.techniciansDetails.length)return t.techniciansDetails;const u=Array.isArray(t.technicians)?t.technicians:[];if(u.length){const d=new Map((we()||[]).map(l=>[String(l.id),l]));return u.map(l=>{const p=d.get(String(l));return p?{technicianId:p.id,technicianName:p.name||p.full_name,technicianPhone:p.phone,technicianRole:p.role||p.specialization}:{technicianId:l}})}return[]})(),a=new Map(i.map(u=>[String(u.technicianName||u.name||u.full_name||"").trim().toLowerCase(),u]));n.forEach(u=>{const d=Array.from(u.children);if(!(d[1]&&(d[1].textContent||"").trim()))return;const p=String(d[1].textContent||"").trim().toLowerCase(),m=a.get(p);if(!m)return;const h=Fe(m),f=m.technicianPhone||m.phone||m.phoneNumber||m.phone_number||m.mobile||m.whatsapp||"";if(d[0]&&!(d[0].textContent||"").trim()&&(d[0].textContent=h||""),d[2]&&!(d[2].textContent||"").trim()){try{d[2].removeAttribute("dir")}catch{}d[2].classList.add("dir-ltr"),d[2].textContent=f||""}})}catch{}}catch{}}function xo(t,e,n={}){const{headerFooter:r=!1,logoUrl:o=""}=n||{},{root:s,inner:c}=jr({landscape:!0,headerFooter:r,logoUrl:o});try{s.setAttribute("dir","ltr")}catch{}const i=s.querySelector("[data-a4-pages]"),a=e?.[0]||null,u=()=>{const z=v("section",{class:"a4-page a4-page--landscape"}),K=v("div",{class:"a4-inner"}),st=v("div",{class:"callsheet-v1"});return z.appendChild(K),K.appendChild(st),i.appendChild(z),{page:z,innerPage:K,wrapPage:st}},d=v("div",{class:"callsheet-v1"}),l=v("div",{class:"cs-header"}),p=v("div",{class:"cs-logo cs-logo--left"}),m=v("img",{src:o||"",alt:"Art Ratio Logo",draggable:"false",referrerpolicy:"no-referrer",crossorigin:"anonymous"});try{m.style.removeProperty("width")}catch{}try{const z=$r(),K=Number(z.x||0)||0,st=Number(z.y||0)||0,V=Math.max(.3,Math.min(3,Number(z.s||1)));if(m.style.transform=`scale(${V}) translate(${K}px, ${st}px)`,z.h)try{p.setAttribute("data-hidden","1"),p.style.visibility="hidden"}catch{}}catch{}p.appendChild(m),l.appendChild(p);const h=v("div",{class:"cs-titlebox"},[v("div",{class:"cs-brand","data-editable":"true",contenteditable:"true",text:t?.title||"WKK."}),v("div",{class:"cs-date","data-editable":"true",contenteditable:"true",text:new Date().toLocaleDateString("en-GB")}),v("div",{class:"cs-title",text:"CALL SHEET"})]);l.appendChild(h);const f=Fr(),y=v("div",{class:"cs-logo cs-logo--right","data-empty":f.url?"0":"1"}),E=v("img",{alt:"Client Logo",draggable:"false",referrerpolicy:"no-referrer",crossorigin:"anonymous"});try{E.style.removeProperty("width")}catch{}f.url&&E.setAttribute("src",f.url);try{const z=Number(f.x||0)||0,K=Number(f.y||0)||0,st=Math.max(.3,Math.min(3,Number(f.s||1)));E.style.transform=`scale(${st}) translate(${z}px, ${K}px)`}catch{}y.appendChild(E),y.appendChild(v("div",{class:"cs-logo__resize",title:"resize"})),l.appendChild(y),d.appendChild(l);const P=v("table",{class:"cs-info"}),g=v("tbody"),C=(...z)=>{const K=v("tr");return z.forEach(st=>K.appendChild(st)),K},x=z=>v("td",{class:"cs-label",text:z}),w=(z="")=>v("td",{"data-editable":"true",contenteditable:"true",text:z}),T=v("table",{class:"cs-roles"}),I=v("tbody");["Producer","Director","DOP","Production Manager","Assistant Director"].forEach(z=>{const K=v("tr");K.appendChild(x(`${z}:`)),K.appendChild(w("")),I.appendChild(K)}),T.appendChild(I);try{a&&Co(T,a)}catch{}const L=v("table",{class:"cs-center"}),A=v("tbody");A.appendChild(C(v("td",{class:"cs-notes-h",text:"Important Notes"}))),A.appendChild(C(v("td",{class:"cs-notes","data-editable":"true",contenteditable:"true",html:"Please be on Time<br>Have Fun and make Art<br>If you need any help please contact the AD or Production manager"}))),A.appendChild(C(v("td",{class:"cs-section",text:"Locations"}))),A.appendChild(C(v("td",{class:"cs-locations","data-editable":"true",contenteditable:"true",text:""}))),L.appendChild(A);const k=v("table",{class:"cs-times"}),q=v("tbody");[["Call Time",""],["Client",t?.clientCompany||t?.clientName||t?.client||""],["Ready to shoot",""],["Lunch",""],["Est. Wrap",""]].forEach(([z,K])=>{const st=v("tr");st.appendChild(x(`${z}:`)),st.appendChild(w(K)),q.appendChild(st)});const B=v("tr");B.appendChild(x(""));const b=v("td"),R=v("div",{class:"cs-weather"},[v("div",{class:"cs-city","data-editable":"true",contenteditable:"true",text:"jeddah"}),v("div",{class:"cs-temp","data-editable":"true",contenteditable:"true",text:"38°C - 25°C"}),v("div",{class:"cs-wind","data-editable":"true",contenteditable:"true",text:"Wind: 16 km/h"}),v("div",{class:"cs-rain","data-editable":"true",contenteditable:"true",text:"Chance of rain : 0%"})]);b.appendChild(R),B.appendChild(b),q.appendChild(B),k.appendChild(q),g.appendChild(C(v("td",{},[T]),v("td",{},[L]),v("td",{},[k]))),P.appendChild(g),d.appendChild(P);const D=v("table",{class:"cs-cast"}),N=v("tbody"),j=v("colgroup");for(let z=0;z<8;z+=1)j.appendChild(v("col",{style:"width:12.5%"}));D.appendChild(j),N.appendChild(C(v("td",{class:"cs-cast-title",text:"Cast Calls",colspan:"8",style:"background:#2563EB !important;color:#ffffff !important;"})));const X=v("tr"),_=v("tr");for(let z=0;z<8;z+=1)X.appendChild(v("td",{"data-editable":"true",contenteditable:"true"})),_.appendChild(v("td",{"data-editable":"true",contenteditable:"true"}));N.appendChild(X),N.appendChild(_),D.appendChild(N),d.appendChild(D),c.appendChild(d);const{innerPage:M,wrapPage:O}=u(),$=v("table",{class:"tpl-table cs-crew","data-editable-table":"crew",style:"width:90% !important; margin-left:auto !important; margin-right:auto !important;"}),G=[30,34,20,16],F=v("colgroup");G.forEach(z=>F.appendChild(v("col",{style:`width:${z}%`}))),$.appendChild(F);const H=v("thead"),at=v("tr");at.appendChild(v("th",{colspan:String(G.length),class:"cs-crew-title",text:"Crew Call"})),H.appendChild(at);const rt=v("tr");["Position","Name","Phone","Time"].forEach(z=>rt.appendChild(v("th",{text:z,class:"cs-crew-head"}))),H.appendChild(rt),$.appendChild(H);const Q=v("tbody");for(let z=0;z<18;z+=1){const K=v("tr");K.appendChild(v("td",{"data-editable":"true",contenteditable:"true"})),K.appendChild(v("td",{"data-editable":"true",contenteditable:"true"})),K.appendChild(v("td",{"data-editable":"true",contenteditable:"true",class:"dir-ltr"})),K.appendChild(v("td",{"data-editable":"true",contenteditable:"true"})),Q.appendChild(K)}$.appendChild(Q),O.appendChild($),M.appendChild(O);const{innerPage:gt,wrapPage:Tt}=u();try{gt.style.paddingLeft="0mm",gt.style.paddingRight="0mm"}catch{}const Et=v("table",{class:"tpl-table cs-schedule","data-editable-table":"callsheet",style:"width:calc(100% + 16mm) !important; margin-left:-8mm !important; margin-right:-8mm !important;"}),jt=[5,5,21,6,7,5,8,4,4,10,8,17],Xt=v("colgroup");jt.forEach(z=>Xt.appendChild(v("col",{style:`width:${z}%`}))),Et.appendChild(Xt);const te=["Shot #","Time (Duration)","Description","Movement","Rig","Lens","Location","I/E","D/N","Sound","Cast","Notes / Props"],Ft=v("thead"),Te=v("tr");Te.appendChild(v("th",{colspan:String(jt.length),class:"cs-schedule-title",text:"Shot List"})),Ft.appendChild(Te);const Rt=v("tr");te.forEach((z,K)=>Rt.appendChild(v("th",{text:z,class:"cs-schedule-head",style:`width:${jt[K]}%`}))),Ft.appendChild(Rt),Et.appendChild(Ft);const $t=v("tbody"),Le=v("tr",{class:"cs-row-note"});Le.appendChild(v("td",{colspan:"12","data-editable":"true",contenteditable:"true",text:"breakfast(30m)"})),$t.appendChild(Le);const Pe=v("tr",{class:"cs-row-strong"});Pe.appendChild(v("td",{colspan:"12","data-editable":"true",contenteditable:"true",text:"light, camera and art Prep (1H)"})),$t.appendChild(Pe);for(let z=0;z<4;z+=1){const K=v("tr");for(let st=0;st<12;st+=1)K.appendChild(v("td",{"data-editable":"true",contenteditable:"true"}));$t.appendChild(K)}Et.appendChild($t),Tt.appendChild(Et),gt.appendChild(Tt);try{vo(p,m)}catch{}try{wo(y,E)}catch{}return s}function Fe(t={}){try{const n=typeof yt=="function"?yt():"ar",r=i=>n==="ar"?i.labelAr||i.labelEn||i.name||"":i.labelEn||i.labelAr||i.name||"",o=typeof $n=="function"?$n()||[]:[],s=t.positionLabel||t.positionLabelAr||t.positionLabelEn||t.position_name||t.position_label||"";if(s&&!/^position[-_]/i.test(String(s)))return String(s);if(t.positionId!=null&&o.length){const i=o.find(a=>String(a.id)===String(t.positionId));if(i)return r(i)}const c=[t.positionKey,t.position_key,t.positionName,t.position_name,t.position,t.assignedPosition,t.assigned_position,t.reservationPosition,t.reservation_position,t.crewPosition,t.crew_position,t.roleInReservation,t.role_in_reservation,t.technicianRole,t.role,t.specialization].map(i=>i!=null?String(i).trim():"").filter(Boolean);for(const i of c){let a=null;if(typeof On=="function"&&(a=On(i)),!a&&o.length){const u=i.toLowerCase();a=o.find(d=>[d.name,d.labelAr,d.labelEn].filter(Boolean).map(l=>String(l).toLowerCase()).includes(u))||null}if(a)return r(a);if(!/^position[-_]/i.test(i))return i}}catch{}const e=t.positionLabel||t.positionLabelAr||t.positionLabelEn||t.position_name||t.position_label||t.technicianRole||t.role||t.specialization||"";return/^position[-_]/i.test(String(e))?"":String(e)}function Eo(t){const e=we()||[],n=new Map(e.map(c=>[String(c.id),c])),r=new Map(e.map(c=>[String((c.name||c.full_name||"").trim().toLowerCase()),c])),s=(()=>{if(Array.isArray(t?.crewAssignments)&&t.crewAssignments.length)return t.crewAssignments;if(Array.isArray(t?.techniciansDetails)&&t.techniciansDetails.length)return t.techniciansDetails;const c=Array.isArray(t?.technicians)?t.technicians:[];return c.length?c.map(i=>({technicianId:i})):[]})().map(c=>({...c}));return s.forEach(c=>{try{c&&typeof c.technician=="object"&&(c.technicianId=c.technicianId??c.technician?.id??c.technician_id,c.technicianName=c.technicianName??c.technician?.name??c.technician?.full_name??c.name,c.technicianPhone=c.technicianPhone??c.technician?.phone??c.phone,c.technicianRole=c.technicianRole??c.technician?.role??c.specialization??c.role),c&&typeof c.position=="object"&&(c.positionLabel=c.positionLabel??c.position?.labelAr??c.position?.labelEn??c.position?.name??c.position_name),c.positionLabel=c.positionLabel??c.position_name??c.positionName??c.position,c.technicianPhone=c.technicianPhone??c.phone_number??c.phoneNumber??c.mobile??c.whatsapp,c.technicianName=c.technicianName??c.full_name??c.technician_name,!c.technicianName&&c.name&&(c.technicianName=c.name)}catch{}}),s.forEach(c=>{const i=c.technicianId??c.technician_id??c.id,a=c.technicianName??c.name,u=i!=null&&n.get(String(i))||(a?r.get(String(a).trim().toLowerCase()):null);u&&(!c.technicianName&&(u.name||u.full_name)&&(c.technicianName=u.name||u.full_name),!c.technicianPhone&&u.phone&&(c.technicianPhone=u.phone),!c.technicianRole&&(u.role||u.specialization)&&(c.technicianRole=u.role||u.specialization))}),s}function Co(t,e){if(!t||!e)return;const n=Array.from(t.querySelectorAll("tbody tr")),r=d=>String(d||"").toLowerCase().replace(/[\u064B-\u0652]/g,"").replace(/[\.\-_/]+/g," ").replace(/\s+/g," ").trim(),o=d=>{const l=r(d);if(!l)return!1;const p=l.replace(/\s+/g,"");return!!(["assistant director","first assistant director","second assistant director","1st ad","1 ad","first ad","2nd ad","second ad","asst dir","dir asst","assistant dir","dir assistant","ad","مساعد مخرج","مساعد المخرج","مساعد اخراج","مساعد إخراج","مساعد مخرج اول","مساعد مخرج أول","مساعد مخرج ثاني"].map(r).includes(l)||l.includes("assistant director")||l.includes("dir asst")||l.includes("asst dir")||l.includes("assistant dir")||l.includes("dir assistant")||l.includes("مساعد مخرج")||l.includes("مساعد اخراج")||l.includes("مساعد إخراج")||/^ad$/.test(l)||/^(1st\s*ad|first\s*ad|ad\s*1)$/i.test(l)||/^(2nd\s*ad|second\s*ad|ad\s*2)$/i.test(l)||/^ad$/.test(p))},s=d=>{const l=String(d||"").toLowerCase();return o(l)?"ad1":/\bproducer\b/.test(l)||/منتج/.test(l)?"producer":/\bdop\b/.test(l)||/director of photography/i.test(l)||/cinematograph/.test(l)||/مدير تصوير/.test(l)?"dop":/production manager/i.test(l)||/مدير انتاج/.test(l)||/مدير إنتاج/.test(l)?"pm":/\bdirector\b/.test(l)&&!/assistant/.test(l)||/مخرج/.test(l)&&!/مساعد/.test(l)?"director":""},c=d=>n.find(l=>s(l?.children?.[0]?.textContent)===d)||null,i={producer:c("producer")?.children?.[1]||null,director:c("director")?.children?.[1]||null,dop:c("dop")?.children?.[1]||null,pm:c("pm")?.children?.[1]||null,ad1:c("ad1")?.children?.[1]||null},a=new Set,u=Eo(e);if(u.forEach(d=>{const l=d.technicianName||d.name||d.full_name||d.technician_name||"";if(!l)return;const p=Fe(d),m=String(p||"").trim().toLowerCase();if(m){if(!a.has("ad1")&&i.ad1&&o(m)){i.ad1.textContent=l,a.add("ad1");return}if(!a.has("pm")&&i.pm&&(/production manager/i.test(m)||/مدير انتاج/.test(m)||/مدير إنتاج/.test(m))){i.pm.textContent=l,a.add("pm");return}if(!a.has("dop")&&i.dop&&(/\bdop\b/.test(m)||/director of photography/i.test(m)||/cinematograph/.test(m)||/مدير تصوير/.test(m))){i.dop.textContent=l,a.add("dop");return}if(!a.has("director")&&i.director&&(/\bdirector\b/.test(m)&&!/assistant/.test(m)||/مخرج/.test(m)&&!/مساعد/.test(m))){i.director.textContent=l,a.add("director");return}if(!a.has("producer")&&i.producer&&(/\bproducer\b/.test(m)||/منتج/.test(m))){i.producer.textContent=l,a.add("producer");return}}}),i.ad1&&!a.has("ad1")&&(!i.ad1.textContent||!i.ad1.textContent.trim())){const d=u.find(l=>{const p=Fe(l)||"";return o(p)});if(d){const l=d.technicianName||d.name||d.full_name||d.technician_name||"";l&&(i.ad1.textContent=l,a.add("ad1"))}}}function So(t,e,n={}){const{headerFooter:r=!1,logoUrl:o=""}=n||{},{root:s,inner:c}=jr({landscape:!1,headerFooter:r,logoUrl:o});try{s.setAttribute("data-exp-mode","multipage")}catch{}const i=v("div",{class:"exp-masthead"},[v("div",{class:"brand-logo"},[v("img",{src:o,alt:"Logo",referrerpolicy:"no-referrer"})]),v("div",{class:"brand-info"},[v("div",{class:"text",text:n.companyName||t?.clientCompany||t?.title||"Company"}),v("div",{class:"meta"},[v("span",{class:"line",text:`${J("CR","السجل التجاري")}: ${n.companyCR||""}`}),v("span",{class:"line",text:`${J("Media License","ترخيص إعلامي")}: ${n.companyLicense||""}`})])]),(()=>{const E=document.createElement("div");return E.className="title-wrap",E.appendChild(v("div",{class:"title",text:J("Expenses Sheet","ورقة المصاريف")})),E.appendChild(v("div",{class:"date",text:`Date: ${new Date().toISOString().slice(0,10)}`})),E})()]);c.appendChild(i);const a=v("div",{class:"tpl-meta"});a.appendChild(ee(J("Client","العميل"),t?.clientCompany||"")),a.appendChild(ee(J("Project Title","اسم المشروع"),t?.title||"")),a.appendChild(ee(J("Budget Date","تاريخ الميزانية"),new Date().toISOString().slice(0,10))),a.appendChild(ee(J("Prepared by","إعداد"),""));const u=Array.from(new Set((e||[]).map(E=>(E?.location||"").trim()).filter(Boolean))).join(", ");a.appendChild(ee(J("Locations","المواقع"),u)),a.appendChild(ee(J("Shoot Days","أيام التصوير"),"")),c.appendChild(a);const d=v("div",{id:"expenses-top-sheet"}),l=(E,P)=>v("tr",{"data-top-row":E},[v("td",{class:"code",text:E}),v("td",{class:"exp-top-label",text:P}),v("td",{"data-top-count":E,text:""}),v("td",{"data-top-total":E,text:""})]),p=(E,P,g)=>{const C=v("table",{class:"exp-table exp-top-table dir-ltr"}),x=v("caption",{class:"exp-group-cap"},[v("div",{class:"exp-group-bar",text:E})]);C.appendChild(x);const w=v("thead"),T=v("tr");["CODE","DESCRIPTION","COUNT","TOTAL"].forEach((L,A)=>T.appendChild(v("th",{class:["exp-top-col-code","exp-top-col-label","exp-top-col-count","exp-top-col-total"][A],text:J(L,A===1?"الوصف":A===2?"العدد":"الإجمالي")}))),w.appendChild(T),C.appendChild(w);const I=v("tbody");if(P.forEach(([L,A])=>I.appendChild(l(L,A))),g){const L=g==="atl"?J("Total Above the Line","مجموع فوق الخط"):g==="prod"?J("Total Production","مجموع الإنتاج"):J("Total Post Production","مجموع ما بعد الإنتاج"),A=v("tr",{"data-top-group-total-row":g},[v("td",{colspan:"3",class:"exp-top-total-label",text:L}),v("td",{"data-top-total-group":g,text:"0"})]);I.appendChild(A)}return C.appendChild(I),C};d.appendChild(p(J("ABOVE THE LINE","فوق الخط"),[["01-00","PRODUCERS UNIT"],["02-00","DIRECTOR & STAFF"],["03-00","CAST"]],"atl")),d.appendChild(p(J("PRODUCTION EXPENSES","مصاريف الإنتاج"),[["04-00","PRODUCTION STAFF"],["05-00","SET DESIGN"],["06-00","SET CONSTRUCTION"]],"prod")),d.appendChild(p(J("POST-PRODUCTION EXPENSES","مصاريف ما بعد الإنتاج"),[["13-00","FILM EDITING"],["14-00","VOICE OVER"]],"post"));const m=v("table",{class:"exp-table exp-top-table dir-ltr"}),h=document.createElement("colgroup");["16%","54%","10%","20%"].forEach(E=>h.appendChild(v("col",{style:`width:${E}`}))),m.appendChild(h);const f=document.createElement("tbody");f.appendChild(v("tr",{class:"exp-grand-total-row"},[v("td",{colspan:"3",class:"exp-grand-total-label",text:J("GRAND TOTAL","الإجمالي الكلي")}),v("td",{"data-top-grand":"1",class:"exp-grand-total-value",text:"0"})])),m.appendChild(f),d.appendChild(m),c.appendChild(d);const y=(E,P,g=[])=>{const C=v("table",{class:"exp-table exp-details dir-ltr","data-editable-table":"expenses","data-group":E}),x=v("colgroup");["12%","38%","12%","10%","10%","8%","10%"].forEach(L=>x.appendChild(v("col",{style:`width:${L}`}))),C.appendChild(x);const w=v("thead"),T=v("tr");[{text:J("CODE","الكود")},{text:J("DESCRIPTION","الوصف")},{text:J("RATE","السعر")},{text:J("QTY","الكمية")},{text:J("DAYS","الأيام")},{text:J("PAID","المدفوع")},{text:J("TOTAL","الإجمالي")}].forEach(L=>T.appendChild(v("th",{text:L.text}))),w.appendChild(T),C.appendChild(w);const I=v("tbody");I.appendChild(v("tr",{"data-group-bar":"true","data-group-title":"true"},[v("th",{colspan:"7"},[v("div",{class:`exp-group-bar exp-group-bar--${E}`,text:P})])])),g.forEach((L,A)=>{I.appendChild(v("tr",{"data-subgroup-header":"true","data-subgroup":L.code},[v("td",{class:"code",text:L.code}),v("td",{class:"label",text:L.label}),v("td",{class:"exp-subheader-fill",colspan:"5",text:""})])),I.appendChild(v("tr",{"data-subgroup-marker":L.code,"data-parent-group":E,style:"display:none;"},[v("td",{colspan:"7",text:""})]));for(let k=0;k<(L.rows||2);k+=1){const q=v("tr",{"data-row":"item"}),B={"data-editable":"true",contenteditable:"true",autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false"},b={...B,"data-num":"1",inputmode:"decimal"};q.appendChild(v("td",B)),q.appendChild(v("td",B)),q.appendChild(v("td",b)),q.appendChild(v("td",b)),q.appendChild(v("td",b)),q.appendChild(v("td",b)),q.appendChild(v("td",{"data-num":"1"})),I.appendChild(q)}I.appendChild(v("tr",{"data-subgroup-subtotal":"true"},[v("td",{colspan:"6",text:J("SUBTOTAL","المجموع الفرعي")}),v("td",{"data-subtotal":L.code,"data-num":"1",text:"0"})]))}),C.appendChild(I),c.appendChild(C)};return y("atl",J("ABOVE THE LINE","فوق الخط"),[{code:"01-00",label:"PRODUCERS UNIT",rows:2},{code:"02-00",label:"DIRECTOR & STAFF",rows:2},{code:"03-00",label:"CAST",rows:6}]),y("prod",J("PRODUCTION EXPENSES","مصاريف الإنتاج"),[{code:"04-00",label:"PRODUCTION STAFF",rows:3},{code:"05-00",label:"SET DESIGN",rows:3},{code:"06-00",label:"SET CONSTRUCTION",rows:2}]),y("post",J("POST-PRODUCTION EXPENSES","مصاريف ما بعد الإنتاج"),[{code:"13-00",label:"FILM EDITING",rows:2},{code:"14-00",label:"VOICE OVER",rows:2}]),s}function dn(t){try{if(!t)return!1;const e=!!t.querySelector("#expenses-top-sheet"),n=!!t.querySelector('table.exp-details tbody tr[data-row="item"]'),r=!!Array.from(t.querySelectorAll("table.tpl-table tbody tr")).find(i=>{try{return i.classList?.contains("cs-row-note")||i.classList?.contains("cs-row-strong")?!0:Array.from(i.querySelectorAll("td")).some(u=>(u.textContent||"").trim().length>0)}catch{return!1}}),s=!!t.querySelector(".callsheet-v1 table.cs-crew")||!!Array.from(t.querySelectorAll(".callsheet-v1 table.cs-crew tbody tr")).find(i=>{try{return Array.from(i.querySelectorAll("td")).some(a=>(a.textContent||"").trim().length>0)}catch{return!1}}),c=!!t.querySelector(".callsheet-v1 .cs-header, .callsheet-v1 .cs-info td, .callsheet-v1 .cs-cast td");return e||n||r||s||c}catch{return!0}}const Ze=new Map;function Ao(t){if(!t)return Promise.resolve(null);const e=String(t);if(Ze.has(e))return Ze.get(e);const n=new Promise(r=>{try{const o=new Image;o.crossOrigin="anonymous",o.referrerPolicy="no-referrer",o.onload=()=>r(o),o.onerror=()=>r(null),o.src=e}catch{r(null)}});return Ze.set(e,n),n}function pc(t=[]){return Promise.all((t||[]).map(e=>Ao(e)))}async function _o(){try{document.fonts&&document.fonts.ready&&await document.fonts.ready}catch{}}function To(t=document){try{const e=t||document,n=Array.from(e.querySelectorAll?e.querySelectorAll("img"):[]);return n.length?Promise.all(n.map(r=>new Promise(o=>{try{if(r.complete&&r.naturalWidth>0)return o();const s=()=>{try{r.removeEventListener("load",s),r.removeEventListener("error",s)}catch{}o()};r.addEventListener("load",s,{once:!0}),r.addEventListener("error",s,{once:!0})}catch{o()}}))):Promise.resolve()}catch{return Promise.resolve()}}async function Lo(t=document){await _o(),await To(t)}let Ut=[],Ln=[],Gn=!1,Kn=null,Hr=()=>null,Pn=()=>{},zr=()=>{},Ur=()=>{};function Po({getSnapshot:t,applySnapshot:e,onAutosaveDebounced:n,onMarkEditing:r}={}){typeof t=="function"&&(Hr=t),typeof e=="function"&&(Pn=e),typeof n=="function"&&(zr=n),typeof r=="function"&&(Ur=r)}function Wr(){try{const t=Hr();if(!t)return;Ut.push(t),Ut.length>50&&Ut.shift(),Ln=[]}catch{}}function Mt(){try{clearTimeout(Kn)}catch{}Kn=setTimeout(Wr,250)}function Io(){if(Ut.length<2)return;const t=Ut.pop(),e=Ut[Ut.length-1];t&&Ln.push(t),e&&Pn(e)}function No(){const t=Ln.pop();t&&(Ut.push(t),Pn(t))}function Bo(t,e){try{if(e!=="callsheet"||(Wr(),Gn))return;const n=document.getElementById("templates-preview-host");if(!n)return;n.addEventListener("input",r=>{const o=r.target;if(o&&o.getAttribute&&o.getAttribute("data-editable")==="true"){try{Mt()}catch{}try{zr()}catch{}try{Ur()}catch{}}},!0),Gn=!0}catch{}}function Mo(t){return!t||!t.parentElement?-1:Array.from(t.parentElement.children).indexOf(t)}function Vt(t){return t?.matches("[data-section-bar]")||t?.classList.contains("tpl-subtotal-row")}function Vr(t,e=0){if(!t)return;const n=Array.from(t.children),r=n[e];if(r&&r.hasAttribute("contenteditable")){r.focus();return}n.find(s=>s.hasAttribute("contenteditable"))?.focus()}function Xr(t){if(!t)return null;const e=t.parentElement,n=t.cloneNode(!0);return n.querySelectorAll("[contenteditable]")?.forEach(r=>{r.textContent=""}),e.insertBefore(n,t.nextElementSibling),n}function Yr(t,e=-1){if(!t)return;const n=t.parentElement;if(e<0){const r=t.previousElementSibling;r&&!Vt(r)&&n.insertBefore(t,r)}else{const r=t.nextElementSibling;if(r){const o=r.nextElementSibling;Vt(r)?o&&!Vt(o)&&n.insertBefore(t,o.nextElementSibling):n.insertBefore(r,t)}}}function Gr(t){if(!t||Vt(t))return;const e=t.parentElement;try{e.removeChild(t)}catch{}}function oe({landscape:t=!1,headerFooter:e=!1,logoUrl:n=""}={}){const r=document.createElement("section");r.className=`a4-page ${t?"a4-landscape":""}`.trim();const o=document.createElement("div");if(o.className="a4-inner",e){const s=v("div",{class:"tpl-print-header"},[v("div",{class:"logo-left"},[v("img",{src:n||"",alt:""})]),v("div",{class:"meta"},[v("div",{text:new Date().toLocaleDateString()})])]),c=v("div",{class:"tpl-print-footer"},[v("div",{class:"footer-left",text:"art-ratio.com"}),v("div",{class:"page-num",html:"<span data-page-num>1</span> / <span data-page-count>1</span>"})]);r.appendChild(s),r.appendChild(c)}return r.appendChild(o),{page:r,inner:o}}function un({headerFooter:t=!1,logoUrl:e=""}={}){const n=document.querySelector("#templates-preview-host #templates-a4-root");if(!n)return;const r=n.querySelector("[data-a4-pages]"),s=r?.querySelector(".a4-page")?.querySelector(".a4-inner");if(!s)return;const c=s.querySelector(".exp-masthead"),i=s.querySelector(".tpl-meta"),a=s.querySelector("#expenses-top-sheet"),u=s.querySelector("#expenses-table"),d=s.querySelector("#expenses-summary");if(!u)return;for(;r.firstChild;)r.removeChild(r.firstChild);let{page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1});r.appendChild(l),c&&p.appendChild(c),i&&p.appendChild(i),a&&p.appendChild(a);const m=u.querySelector("thead"),h=()=>{const b=document.createElement("table");b.className=u.className,b.id="expenses-table",b.setAttribute("data-editable-table","expenses");const R=m?m.cloneNode(!0):document.createElement("thead");return b.appendChild(R),b.appendChild(document.createElement("tbody")),b};let f=h();p.appendChild(f);const y=Array.from(u.querySelectorAll("tbody > tr")),E=b=>b?.hasAttribute("data-subgroup-header"),P=b=>b?.hasAttribute("data-subgroup-subtotal"),g=b=>b?.hasAttribute("data-group-total"),C=b=>b?.hasAttribute("data-subgroup-marker"),x=b=>b?.getAttribute("data-row")==="item",w=b=>b?.hasAttribute("data-group-bar"),T=()=>p.scrollHeight<=p.clientHeight+.5;let I=null,L=null,A=null;const k=(b=null)=>{({page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(l),f=h(),p.appendChild(f);const R=f.tBodies[0];if(I&&!(b&&w(b))&&R.appendChild(I.cloneNode(!0)),L&&!(b&&E(b))){const D=b,N=!!(D&&(D.getAttribute&&D.getAttribute("data-subgroup-subtotal")===A||D.getAttribute&&D.getAttribute("data-row")==="item"||D.hasAttribute&&D.hasAttribute("data-subgroup-marker")));(!b||N)&&R.appendChild(L.cloneNode(!0))}},q=b=>{const R=f.tBodies[0];R.appendChild(b),T()||(R.removeChild(b),k(b),f.tBodies[0].appendChild(b))};let B=0;for(;B<y.length;){const b=y[B];if(w(b)&&(I=b.cloneNode(!0)),E(b)&&(L=b.cloneNode(!0),A=b.getAttribute("data-subgroup")),E(b)){const R=[b],D=b.getAttribute("data-subgroup");let N=B+1,j=0;for(;N<y.length&&j<2;)if(x(y[N]))R.push(y[N]),j+=1,N+=1;else if(C(y[N]))R.push(y[N]),N+=1;else{if(P(y[N]))break;break}N<y.length&&P(y[N])&&y[N].getAttribute("data-subgroup-subtotal")===D&&(R.push(y[N]),N+=1);const X=f.tBodies[0];if(R.forEach(_=>X.appendChild(_)),!T()){R.forEach(M=>{M.parentElement===X&&X.removeChild(M)}),k(R[0]);const _=f.tBodies[0];R.forEach(M=>_.appendChild(M))}B=N;continue}if(g(b)){const R=f.tBodies[0];if(R.appendChild(b),!T()){R.removeChild(b);const D=R.lastElementChild;let N=null;D&&(x(D)||P(D))&&(N=D,R.removeChild(D)),k(b);const j=f.tBodies[0];N&&j.appendChild(N),j.appendChild(b),T()||(j.removeChild(b),k(b),f.tBodies[0].appendChild(b))}L=null,A=null,I=null,B+=1;continue}q(b),B+=1}if(d&&(p.appendChild(d),T()||(p.removeChild(d),{page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1}),r.appendChild(l),f=h(),p.appendChild(f),p.appendChild(d))),t){const b=r.querySelectorAll(".a4-page").length;Array.from(r.querySelectorAll(".a4-page")).forEach((R,D)=>{const N=R.querySelector("[data-page-num]"),j=R.querySelector("[data-page-count]");N&&(N.textContent=String(D+1)),j&&(j.textContent=String(b))})}try{ko()}catch{}try{Do()}catch{}try{Nn()}catch{}try{window.__pdfTunerRefreshPages&&window.__pdfTunerRefreshPages()}catch{}try{window.__pdfTunerLoadValues&&window.__pdfTunerLoadValues()}catch{}}function In({headerFooter:t=!1,logoUrl:e=""}={}){const n=document.querySelector("#templates-preview-host #templates-a4-root");if(!n)return;const r=n.querySelector("[data-a4-pages]");if(!r)return;Array.from(r.querySelectorAll(".a4-page")).forEach(s=>{const c=s.querySelector(".a4-inner");if(!c)return;Array.from(c.querySelectorAll("table.exp-details")).filter(a=>a.getAttribute("data-split-done")!=="1").forEach(a=>{const u=a.querySelector("thead"),d=a.querySelector("colgroup"),l=a.getAttribute("data-group")||"",p=Array.from(a.querySelectorAll("tbody > tr"));if(!p.length){a.setAttribute("data-split-done","1");return}const m=()=>{const b=document.createElement("table");b.className=a.className,b.setAttribute("data-editable-table","expenses"),l&&b.setAttribute("data-group",l),d&&b.appendChild(d.cloneNode(!0));const R=u?u.cloneNode(!0):document.createElement("thead");return b.appendChild(R),b.appendChild(document.createElement("tbody")),b};let h=s,f=c;const y=m();try{c.removeChild(a)}catch{}f.appendChild(y);try{const b=!!f.querySelector("#expenses-top-sheet"),R=!!Array.from(f.querySelectorAll("table.exp-details")).find(D=>D!==y);if(b||R){try{f.removeChild(y)}catch{}({page:h,inner:f}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(h),f.appendChild(y)}}catch{}let E=y;const P=b=>b?.hasAttribute("data-subgroup-header"),g=b=>b?.hasAttribute("data-subgroup-subtotal"),C=b=>b?.hasAttribute("data-group-total"),x=b=>b?.hasAttribute("data-subgroup-marker"),w=b=>b?.getAttribute("data-row")==="item",T=b=>b?.hasAttribute("data-group-bar"),I=()=>f.scrollHeight<=f.clientHeight+.5;let L=null,A=null,k=null;const q=(b=null)=>{({page:h,inner:f}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(h),E=m(),f.appendChild(E);const R=E.tBodies[0];if(L&&!(b&&T(b))&&R.appendChild(L.cloneNode(!0)),A&&!(b&&P(b))){const D=b,N=!!(D&&(D.getAttribute&&D.getAttribute("data-subgroup-subtotal")===k||D.getAttribute&&D.getAttribute("data-row")==="item"||D.hasAttribute&&D.hasAttribute("data-subgroup-marker")));(!b||N)&&R.appendChild(A.cloneNode(!0))}};let B=0;for(;B<p.length;){const b=p[B],R=E.tBodies[0],D=N=>{if(R.appendChild(N),!I()){try{R.removeChild(N)}catch{}let j=!1;try{j=!(R.children&&R.children.length)}catch{}const X=E;if(q(N),j)try{X.parentElement?.removeChild(X)}catch{}E.tBodies[0].appendChild(N)}};if(T(b)){L=b.cloneNode(!0);const N=E.tBodies[0];N&&N.children&&N.children.length>0&&q(b),D(b),B+=1;continue}if(P(b)){A=b.cloneNode(!0),k=b.getAttribute("data-subgroup");const N=[b];let j=B+1,X=0;for(;j<p.length&&X<2;)if(w(p[j]))N.push(p[j]),X+=1,j+=1;else if(x(p[j]))N.push(p[j]),j+=1;else{if(g(p[j]))break;break}if(j<p.length&&g(p[j])&&p[j].getAttribute("data-subgroup-subtotal")===k&&(N.push(p[j]),j+=1),N.forEach(_=>R.appendChild(_)),!I()){N.forEach(M=>{try{R.removeChild(M)}catch{}}),q(N[0]);const _=E.tBodies[0];N.forEach(M=>_.appendChild(M))}B=j;continue}if(C(b)){if(D(b),!I()){const N=R.lastElementChild;let j=null;if(N&&(w(N)||g(N))){try{R.removeChild(N)}catch{}j=N}try{R.removeChild(b)}catch{}q(b);const X=E.tBodies[0];if(j&&X.appendChild(j),X.appendChild(b),!I()){try{X.removeChild(b)}catch{}q(b),E.tBodies[0].appendChild(b)}}A=null,k=null,L=null,B+=1;continue}D(b),B+=1}try{a.setAttribute("data-split-done","1")}catch{}try{Array.from(r.querySelectorAll("table.exp-details")).forEach(b=>{try{b.setAttribute("data-split-done","1")}catch{}})}catch{}})});try{const s=Array.from(r.querySelectorAll(".a4-page"));if(s.length>1){const c=s[0],i=s.slice(1),a={atl:[],prod:[],post:[],other:[]};i.forEach(d=>{const l=d.querySelector("table.exp-details"),p=l&&l.getAttribute("data-group")||"other";p in a?a[p].push(d):a.other.push(d)}),[c,...a.atl,...a.prod,...a.post,...a.other].forEach(d=>{try{r.appendChild(d)}catch{}})}}catch{}try{Array.from(r.querySelectorAll("table.exp-details")).forEach(c=>{const i=Array.from(c.querySelectorAll("thead"));i.length>1&&i.slice(1).forEach(d=>{try{d.parentElement?.removeChild(d)}catch{}});const a=c.tBodies&&c.tBodies[0];if(!!!(a&&a.children&&a.children.length))try{c.parentElement?.removeChild(c)}catch{}})}catch{}try{n.querySelector('table.exp-details:not([data-split-done="1"])')&&requestAnimationFrame(()=>{try{In({headerFooter:t,logoUrl:e})}catch{}})}catch{}}function pe({headerFooter:t=!1,logoUrl:e="",isLandscape:n=!0}={}){const r=document.querySelector("#templates-preview-host #templates-a4-root");if(!r||(document.getElementById("templates-type")?.value||"expenses")==="expenses")return;const s=r.querySelector("[data-a4-pages]");if(!s)return;Array.from(s.querySelectorAll(".a4-page")).forEach(i=>{const a=i.querySelector(".a4-inner");if(!a)return;Array.from(a.querySelectorAll("table.tpl-table")).forEach(d=>{if(!d||d.getAttribute("data-split-done")==="1")return;const l=d.querySelector("thead"),p=d.querySelector("colgroup"),m=Array.from(d.querySelectorAll("tbody > tr"));if(!m.length){d.setAttribute("data-split-done","1");return}const h=()=>{const C=document.createElement("table");C.className=d.className,p&&C.appendChild(p.cloneNode(!0));const x=l?l.cloneNode(!0):document.createElement("thead");return C.appendChild(x),C.appendChild(document.createElement("tbody")),C},f=()=>a.scrollHeight<=a.clientHeight+.5;let y=i,E=a;try{a.removeChild(d)}catch{}let P=h();E.appendChild(P);let g=0;for(;g<m.length;){const C=P.tBodies[0];if(C.appendChild(m[g]),!f()){C.removeChild(m[g]);try{if(!(C.children&&C.children.length)){const w=P;try{E.removeChild(w)}catch{}}}catch{}({page:y,inner:E}=oe({headerFooter:t,logoUrl:e,landscape:n})),s.appendChild(y),P=h(),E.appendChild(P),P.tBodies[0].appendChild(m[g])}g+=1}try{Array.from(s.querySelectorAll("table.tpl-table")).forEach(x=>{const w=x.tBodies&&x.tBodies[0];if(!!!(w&&w.children&&w.children.length))try{x.parentElement?.removeChild(x)}catch{}})}catch{}d.setAttribute("data-split-done","1")})})}function Zt(){try{const t=document.getElementById("templates-a4-root");if(!t)return;Array.from(t.querySelectorAll(".a4-page")).forEach(n=>{dn(n)||t.querySelectorAll(".a4-page").length>1&&n.parentElement?.removeChild(n)});try{Ro()}catch{}}catch{}}function Ro(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll("table.cs-crew"));if(e.length<=1)return;let n=e.find(r=>(r.tBodies?.[0]?.children?.length||0)>0)||e[0];e.forEach(r=>{if(r!==n)try{r.parentElement?.removeChild(r)}catch{}})}function ko(){Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.exp-table")).forEach(e=>{const n=e.tBodies?.[0];if(!n)return;let r=!1;Array.from(n.children).forEach(o=>{o.getAttribute("data-row")==="item"&&(o.classList.toggle("exp-row-alt",r),r=!r)})})}function Do(){Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.exp-table tr.exp-subheader th")).forEach(e=>{e.style.fontSize="",e.style.whiteSpace="nowrap",e.style.overflow="hidden",e.style.textOverflow="ellipsis";const n=12,r=9;let o=n;const s=()=>e.scrollWidth<=e.clientWidth;for(;o>r&&!s();)o-=.5,e.style.fontSize=o+"px"})}function Nn(t){const e=document.querySelector("#templates-preview-host #templates-a4-root");if(!e)return;const n=t&&t instanceof HTMLElement?t:e,r=Array.from(n.querySelectorAll("table.exp-table td")),o=s=>s&&!/\s/.test(s);r.forEach(s=>{const c=(s.textContent||"").trim();if(!c||!o(c))return;s.style.fontSize="";const i=Number.parseFloat(getComputedStyle(s).fontSize||"11");let a=Number.isFinite(i)?i:11;const u=7,d=()=>s.scrollWidth<=s.clientWidth&&s.scrollHeight<=s.clientHeight;let l=0;for(;!d()&&a>u&&l<40;)a-=.5,s.style.fontSize=a+"px",l+=1})}function Kr(){try{Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.cs-schedule thead th")).forEach(e=>{e.style.fontSize="";const n=Number.parseFloat(getComputedStyle(e).fontSize||"10");let r=Number.isFinite(n)?n:10;const o=8,s=()=>e.scrollWidth<=e.clientWidth+.5&&e.scrollHeight<=e.clientHeight+.5;let c=0;for(;!s()&&r>o&&c<30;)r-=.5,e.style.fontSize=r+"px",c+=1})}catch{}}function Zr({onAfterChange:t}={}){const e=document.getElementById("templates-preview-host");if(!e)return;const n=document.getElementById("templates-type")?.value||"expenses";let r=document.getElementById("tpl-cell-toolbar");if(!(n==="callsheet"||n==="expenses")){r&&(r.style.display="none");return}r||(r=document.createElement("div"),r.id="tpl-cell-toolbar",Object.assign(r.style,{position:"fixed",display:"none",zIndex:9999}),r.innerHTML=`
      <div style="display:inline-flex;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:4px;box-shadow:0 2px 8px rgba(15,23,42,0.12);">
        <button type="button" data-act="row-add" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف</button>
        <button type="button" data-act="row-full" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف كامل</button>
        <button type="button" data-act="row-full-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف كامل</button>
        <button type="button" data-act="row-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف</button>
        <button type="button" data-act="row-up" class="btn btn-outline" style="height:28px;padding:0 8px">↑</button>
        <button type="button" data-act="row-down" class="btn btn-outline" style="height:28px;padding:0 8px">↓</button>
        <span data-sep style="width:1px;background:#e5e7eb;margin:0 4px"></span>
        <button type="button" data-act="cast-add" class="btn btn-outline" style="height:28px;padding:0 8px">+ خانة</button>
        <button type="button" data-act="cast-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× خانة</button>
        <button type="button" data-act="cast-add-row" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف اسم/وقت</button>
        <button type="button" data-act="cast-del-row" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف اسم/وقت</button>
      </div>`,e.appendChild(r),r.__lock=!1,r.__switchTimer=null,r.__freezeUntil=0,r.addEventListener("pointerenter",()=>{r.__lock=!0}),r.addEventListener("pointerleave",()=>{r.__lock=!1}),r.addEventListener("click",c=>{const i=c.target.closest("[data-act]");if(!i)return;const a=i.getAttribute("data-act"),u=r.__targetCell||null;if(!u)return;const d=u.closest("table.cs-schedule")||u.closest("table.cs-crew")||u.closest("table.exp-details"),l=u.closest("table.cs-cast"),p=()=>{const x=u.closest("tr");if(!x)return;const w=Xr(x);w&&Vr(w,0)},m=()=>{const x=u.closest("tr");x&&(x.classList.contains("cs-row-note")||x.classList.contains("cs-row-strong")||x.hasAttribute("data-group-bar")||x.hasAttribute("data-subgroup-header")||x.hasAttribute("data-subgroup-subtotal")||x.hasAttribute("data-group-total")||x.hasAttribute("data-subgroup-marker")||Gr(x))},h=x=>{const w=u.closest("tr");w&&Yr(w,x)},f=()=>{try{typeof t=="function"&&t()}catch{}try{setTimeout(()=>{pe(),Zt()},30)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}try{document.dispatchEvent(new CustomEvent("templates:afterRowChange"))}catch{}},y=()=>{const x=d||u.closest("table");if(!x)return;const w=u.closest("tr"),T=w?.parentElement;if(!w||!T)return;const I=(()=>{try{const k=x.querySelectorAll("thead tr"),q=k&&k.length?k[k.length-1]:null;if(q&&q.children&&q.children.length)return q.children.length;const B=x.querySelectorAll("colgroup col");return B&&B.length?B.length:12}catch{return 12}})(),L=document.createElement("tr"),A=document.createElement("td");A.setAttribute("colspan",String(I)),A.setAttribute("data-editable","true"),A.setAttribute("contenteditable","true"),L.appendChild(A),T.insertBefore(L,w.nextElementSibling)},E=()=>{const x=l;if(!x)return;const w=x.tBodies&&x.tBodies[0];if(!w)return;const T=w.children&&w.children[1],I=w.children&&w.children[2];if(!T||!I)return;const L=document.createElement("td");L.setAttribute("data-editable","true"),L.setAttribute("contenteditable","true"),T.appendChild(L);const A=document.createElement("td");A.setAttribute("data-editable","true"),A.setAttribute("contenteditable","true"),I.appendChild(A)},P=()=>{const x=l;if(!x)return;const w=x.tBodies&&x.tBodies[0];if(!w)return;const T=w.children&&w.children[1],I=w.children&&w.children[2];!T||!I||T.children.length<=2||I.children.length<=2||(T.removeChild(T.lastElementChild),I.removeChild(I.lastElementChild))},g=()=>{const x=l;if(!x)return;const w=x.tBodies&&x.tBodies[0];if(!w)return;const T=w.children&&w.children[1],I=w.children&&w.children[2];if(!T||!I)return;const L=T.querySelector(".cs-weather"),A=T.children.length-(L?1:0),k=document.createElement("tr"),q=document.createElement("tr");for(let B=0;B<A;B+=1){const b=document.createElement("td");b.setAttribute("data-editable","true"),b.setAttribute("contenteditable","true"),k.appendChild(b)}for(let B=0;B<A;B+=1){const b=document.createElement("td");b.setAttribute("data-editable","true"),b.setAttribute("contenteditable","true"),q.appendChild(b)}if(w.appendChild(k),w.appendChild(q),L){const B=w.querySelectorAll("tr").length-1;L.setAttribute("rowspan",String(B))}},C=()=>{const x=l;if(!x)return;const w=x.tBodies&&x.tBodies[0];if(!w||w.children.length<=3)return;const T=w.lastElementChild,I=T?.previousElementSibling;I&&T&&I.tagName==="TR"&&(w.removeChild(T),w.removeChild(I));const A=w.children[1]?.querySelector(".cs-weather");if(A){const k=w.querySelectorAll("tr").length-1;A.setAttribute("rowspan",String(k))}};if(a==="row-add"&&d)p(),f();else if(a==="row-full"&&d)y(),f();else if(a==="row-full-del"&&d){const x=u.closest("tr"),w=(()=>{try{const I=d.querySelectorAll("thead tr"),L=I&&I.length?I[I.length-1]:null;if(L&&L.children&&L.children.length)return L.children.length;const A=d.querySelectorAll("colgroup col");return A&&A.length?A.length:12}catch{return 12}})();x&&x.children&&x.children.length===1&&Number(x.children[0]?.getAttribute("colspan")||"1")>=w&&(x.parentElement?.removeChild(x),f())}else a==="row-del"&&d?(m(),f()):a==="row-up"&&d?(h(-1),f()):a==="row-down"&&d?(h(1),f()):a==="cast-add"&&l?(E(),f()):a==="cast-del"&&l?(P(),f()):a==="cast-add-row"&&l?(g(),f()):a==="cast-del-row"&&l&&(C(),f())}));const o=c=>{if(!c){r.style.display="none",r.__targetCell=null;return}const i=c.closest("table.cs-schedule")||c.closest("table.cs-crew")||c.closest("table.exp-details"),a=c.closest("table.cs-cast");if(!i&&!a){r.style.display="none",r.__targetCell=null;return}let u=!!i;const d=!!a;try{if(u&&i&&i.matches("table.exp-details")){const f=c.closest("tr");u=!!(f&&f.getAttribute("data-row")==="item")}}catch{}Array.from(r.querySelectorAll('[data-act^="row-"]')).forEach(f=>f.style.display=u?"inline-flex":"none"),Array.from(r.querySelectorAll('[data-act^="cast-"]')).forEach(f=>f.style.display=d?"inline-flex":"none"),r.querySelector("[data-sep]")?.setAttribute("style",`width:1px;background:#e5e7eb;margin:0 4px;display:${u&&d?"inline-block":"none"}`);try{const f=r.querySelector('[data-act="row-full"]'),y=r.querySelector('[data-act="row-full-del"]');if(i&&i.matches("table.exp-details"))f&&(f.style.display="none"),y&&(y.style.display="none");else if(y&&i){const E=c.closest("tr"),P=i.querySelector("thead tr"),g=P&&P.children&&P.children.length?P.children.length:12,C=E&&E.children&&E.children.length===1&&Number(E.children[0]?.getAttribute("colspan")||"1")>=g;y.style.display=C?"inline-flex":"none",f&&(f.style.display="inline-flex")}}catch{}const l=c.getBoundingClientRect(),p=6,m=Math.round(l.left+Math.min(l.width-28,12)),h=Math.round(l.top-(r.offsetHeight||32)-p);r.style.transform="none",r.style.left=`${m}px`,r.style.top=`${Math.max(0,h)}px`,r.style.display="block",r.__targetCell=c},s=()=>{const c=document.getElementById("templates-a4-root");if(!c)return;const i=()=>{if(r.__lock)return;const u=window.getSelection();if(!u||u.rangeCount===0){r.__lock||(r.style.display="none");return}let d=u.anchorNode;d&&d.nodeType===3&&(d=d.parentElement);const l=d instanceof Element?d.closest("td,th"):null;if(!l){r.__lock||(r.style.display="none");return}o(l)};document.addEventListener("selectionchange",i);const a=u=>{const d=u.target;if(d instanceof Element&&(d.getAttribute("contenteditable")==="true"||d.closest('[contenteditable="true"]'))){const l=d.closest("td,th");l&&o(l)}};c.addEventListener("focusin",a,!0),r.__detach=()=>{try{document.removeEventListener("selectionchange",i),c.removeEventListener("focusin",a,!0)}catch{}}};r.__attachedOnce||(s(),r.__attachedOnce=!0)}function qo(t,{onAfterChange:e,onTotalsChange:n,onRenumber:r}={}){if(!t)return()=>{};const o=s=>{const c=s.target.closest("[data-action]");if(!c)return;const i=c.getAttribute("data-action"),a=c.closest("tr"),u=a?.parentElement;if(!(!a||!u)){if(i==="row-up"&&a.previousElementSibling&&!a.previousElementSibling.matches("[data-section-bar]"))u.insertBefore(a,a.previousElementSibling);else if(i==="row-down"&&a.nextElementSibling)u.insertBefore(a.nextElementSibling,a);else if(i==="row-add"){const d=a.cloneNode(!0);d.querySelectorAll("[contenteditable]")?.forEach(l=>{l.textContent=""}),u.insertBefore(d,a.nextElementSibling)}else i==="row-delete"&&u.removeChild(a);try{typeof r=="function"&&r()}catch{}try{typeof n=="function"&&n()}catch{}try{Nn(u)}catch{}try{typeof e=="function"&&e()}catch{}}};return t.addEventListener("click",o),()=>{try{t.removeEventListener("click",o)}catch{}}}function Zn(t){let e=t?.nextElementSibling;for(;e&&Vt(e);)e=e.nextElementSibling;return e}function jo(t,e,n){if(!(!t||!e||n<=0))for(let r=0;r<n;r+=1){const o=e.cloneNode(!0);o.querySelectorAll("[contenteditable]")?.forEach(s=>{s.textContent=""}),t.appendChild(o)}}function Fo(t){return t?t.split(/\r?\n/).map(n=>n.replace(/\r$/,"")).filter(n=>n.trim().length>0).map(n=>n.split(/\t|,|;/).map(r=>r.trim())):[]}function $o(t,e,n){if(!t||!n||!n.length)return;const r=Array.from(t.children);let o=Math.max(0,e);for(let s=0;s<n.length&&o<r.length;s+=1){for(;o<r.length&&!r[o].hasAttribute("contenteditable");)o+=1;if(o>=r.length)break;const c=r[o],i=n[s]??"";c.textContent=String(i),o+=1}}function Oo(t,{onAfterChange:e,onTotalsChange:n}={}){if(!t)return()=>{};const r=s=>{const c=s.target,i=c&&c.closest("[contenteditable]"),a=c&&c.closest("table.tpl-table");if(!i||!a)return;const u=s.clipboardData?.getData("text/plain")??"";if(!u||!u.includes("	")&&!u.includes(`
`))return;s.preventDefault();const d=Fo(u);if(!d.length)return;const l=c.closest("td"),p=Mo(l),m=a.tBodies?.[0]||a.querySelector("tbody");if(!m)return;let h=Array.from(m.children).find(C=>C&&!Vt(C)),f=l.parentElement,y=0,E=f;for(;E;)Vt(E)||(y+=1),E=E.nextElementSibling;const P=d.length-y;P>0&&h&&jo(m,h,P);let g=f;d.forEach((C,x)=>{for(;g&&Vt(g);)g=Zn(g);if(!g)return;const w=x===0?p:0,T=C.map(I=>{const L=String(I||""),A={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"},k={"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"۷","۸":"8","۹":"9"};return L.replace(/[\u0660-\u0669]/g,q=>A[q]).replace(/[\u06F0-\u06F9]/g,q=>k[q])});$o(g,w,T),g=Zn(g)||g?.nextElementSibling}),typeof n=="function"&&n();try{Nn(a)}catch{}},o=s=>{const c=s.target;if(!c||!c.closest("table.tpl-table"))return;const i=c.closest("table.tpl-table"),a=c.closest("tr");if(a){if(s.key==="Enter"&&!s.shiftKey){s.preventDefault();const u=Xr(a);u&&(Vr(u),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n());try{typeof e=="function"&&e()}catch{}return}if(s.altKey&&(s.key==="ArrowUp"||s.key==="ArrowDown")){s.preventDefault(),Yr(a,s.key==="ArrowDown"?1:-1),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n();try{typeof e=="function"&&e()}catch{}return}if((s.key==="Delete"||s.key==="Backspace")&&s.ctrlKey){s.preventDefault(),Gr(a),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n();try{typeof e=="function"&&e()}catch{}}}};return t.addEventListener("paste",r),t.addEventListener("keydown",o,!0),()=>{try{t.removeEventListener("paste",r)}catch{}try{t.removeEventListener("keydown",o,!0)}catch{}}}function Ho(t){try{const e=t.querySelector(".callsheet-v1");if(!e)return[];const n=Array.from(e.querySelectorAll("table")),r=[];return n.forEach((o,s)=>{const c=o.classList.contains("cs-schedule")?"schedule":o.classList.contains("cs-cast")?"cast":o.classList.contains("cs-info")?"info":"";Array.from(o.querySelectorAll("tr")).forEach((a,u)=>{Array.from(a.children).forEach((l,p)=>{if(l.getAttribute&&l.getAttribute("data-shaded")==="1"){const m=l.style.getPropertyValue("--shade")||l.style.backgroundColor||"";r.push({ti:s,ri:u,ci:p,shade:m,tp:c})}})})}),r}catch{return[]}}function Jr(t){if(!t)return[];const e=Cn();return Array.isArray(e)?e.filter(n=>String(n?.projectId??n?.project_id??"")===String(t)):[]}let Gt=1,xe=null,St="manual",Jn=!1,pn=!1,Y={hostInput:null,hostMouseDown:null,hostFocusIn:null,hostFocusOut:null,hostCompStart:null,hostCompEnd:null,projChanged:null,resChanged:null,resUpdated:null,tabClick:null},Pt=null,zt=null,se=null,Me=null,Je=null,Re=null,Qe=!1,Qn=null,tr=null;function re(t){try{const e=t||document.querySelector("#templates-preview-host #templates-a4-root");if(!e)return;try{Qr(e)}catch{}Array.from(e.querySelectorAll("table.cs-crew")).forEach(o=>{try{o.style.setProperty("width","90%","important"),o.style.setProperty("margin-left","auto","important"),o.style.setProperty("margin-right","auto","important")}catch{}});const r=Array.from(e.querySelectorAll("table.cs-schedule"));r.forEach(o=>{try{o.style.setProperty("width","calc(82% + 120px)","important"),o.style.setProperty("margin-left","11mm","important"),o.style.setProperty("margin-right","-16mm","important");const s=o.closest(".a4-inner");s&&(s.style.setProperty("padding-left","0mm","important"),s.style.setProperty("padding-right","0mm","important"))}catch{}});try{const o=r[0];if(o){const s=o.tBodies&&o.tBodies[0];if(s){const c=Array.from(s.children),i=d=>d.classList?.contains("cs-row-note")||d.classList?.contains("cs-row-strong");let a=c.filter(d=>!i(d));const u=(()=>{const d=o.querySelector("thead tr");return d&&d.children&&d.children.length?d.children.length:12})();for(;a.length<4;){const d=document.createElement("tr");for(let l=0;l<u;l+=1){const p=document.createElement("td");p.setAttribute("data-editable","true"),p.setAttribute("contenteditable","true"),d.appendChild(p)}s.appendChild(d),a.push(d)}}}}catch{}}catch{}}try{window.__enforceCallsheetSizing=re}catch{}function Qr(t){const e=t||document.getElementById("templates-a4-root");if(!e)return;Array.from(e.querySelectorAll("table.cs-crew, table.cs-schedule")).forEach(r=>{const o=r.closest(".a4-inner");if(!o||r.closest(".callsheet-v1"))return;let c=o.querySelector(":scope > .callsheet-v1");c||(c=document.createElement("div"),c.className="callsheet-v1",o.insertBefore(c,r));try{c.appendChild(r)}catch{}})}function er(){try{const t=document.getElementById("templates-preview-host");if(t){try{Y.hostInput&&t.removeEventListener("input",Y.hostInput)}catch{}try{Me&&(Me(),Me=null)}catch{}try{Y.hostMouseDown&&t.removeEventListener("mousedown",Y.hostMouseDown,!0)}catch{}try{Y.hostFocusIn&&t.removeEventListener("focusin",Y.hostFocusIn,!0)}catch{}try{Y.hostFocusOut&&t.removeEventListener("focusout",Y.hostFocusOut,!0)}catch{}try{Y.hostCompStart&&t.removeEventListener("compositionstart",Y.hostCompStart,!0)}catch{}try{Y.hostCompEnd&&t.removeEventListener("compositionend",Y.hostCompEnd,!0)}catch{}try{Re&&(Re(),Re=null)}catch{}try{const e=document.getElementById("tpl-cell-toolbar");e&&typeof e.__detach=="function"&&e.__detach()}catch{}}if(Y.projChanged&&document.removeEventListener("projects:changed",Y.projChanged),Y.resChanged&&document.removeEventListener("reservations:changed",Y.resChanged),Y.resUpdated&&document.removeEventListener("reservations:updated",Y.resUpdated),Y.tabClick){const e=document.querySelector('[data-project-subtab-target="projects-templates-tab"]');e&&e.removeEventListener("click",Y.tabClick)}if(zt&&(clearTimeout(zt),zt=null),se){try{se.disconnect()}catch{}se=null}}finally{pn=!1,Pt=null,Y={hostInput:null,hostMouseDown:null,hostFocusIn:null,hostFocusOut:null,projChanged:null,resChanged:null,resUpdated:null,tabClick:null}}}function Kt(t,e="تعذر الاتصال بالخادم"){try{let n=t&&t.message?String(t.message):e;try{const r=t&&t.payload&&t.payload.raw?String(t.payload.raw):"",o=`${n}
${r}`;/Missing configuration file/i.test(o)&&(n="الخادم غير مُعد: يرجى نسخ backend/config.example.php إلى backend/config.php وتعبئة بيانات الاتصال (Database + allowed_origins) ثم إعادة المحاولة.")}catch{}typeof It=="function"?It(n,"error",7e3):alert(n)}catch{}}function ta(){try{return Math.max(.3,Math.min(2.5,Number(localStorage.getItem("templates.preview.zoom")||"1")))}catch{return 1}}function zo(t){try{localStorage.setItem("templates.preview.zoom",String(t))}catch{}}function ea(){try{return(localStorage.getItem("templates.preview.zoomMode")||"manual")==="fit"?"fit":"manual"}catch{return"manual"}}function mn(t){try{localStorage.setItem("templates.preview.zoomMode",t==="fit"?"fit":"manual")}catch{}}function Ee(t,{silent:e=!1,markManual:n=!1}={}){Gt=Math.min(Math.max(t,.25),2.5),Uo(Gt),zo(Gt),!e&&xe&&(xe.textContent=`${Math.round(Gt*100)}%`)}function nr(t){St="manual",mn(St),Ee(Gt+t,{markManual:!0})}function Uo(t){const e=document.querySelector("#templates-preview-host > #templates-a4-root")||document.querySelector("#templates-preview-host #templates-a4-root");if(e){try{e.style.transformOrigin="top center"}catch{}try{e.style.transform=`scale(${t})`}catch{}}}function Wo(){try{const e=document.querySelector("#templates-preview-host #templates-a4-root .a4-page");if(e)return e.getBoundingClientRect().width||e.offsetWidth||794}catch{}return(document.getElementById("templates-type")?.value||"expenses")!=="expenses"?1123:794}function Vo(){const t=document.getElementById("templates-preview-host");if(!t)return null;try{const e=window.getComputedStyle(t),n=parseFloat(e.paddingLeft||"0")||0,r=parseFloat(e.paddingRight||"0")||0;return Math.max(0,t.clientWidth-n-r)}catch{return t.clientWidth||null}}function Xo(){const t=Wo(),e=Vo();return!t||!e?1:Math.max(.25,Math.min(2.5,e/t))}function Ce(){const t=Xo();Ee(t,{silent:!1})}function rr(){Jn||(window.addEventListener("resize",()=>{St==="fit"&&Ce()},{passive:!0}),Jn=!0)}function ar(){try{if(se)return;const t=document.getElementById("templates-preview-host");if(!t||typeof ResizeObserver>"u")return;se=new ResizeObserver(()=>{St==="fit"&&Ce()}),se.observe(t)}catch{}}function tn(t=180){try{Je&&clearTimeout(Je)}catch{}Je=setTimeout(()=>{try{jn()}catch{}},Math.max(0,t))}const na="projects.templates.type";function Yo(){try{const t=String(localStorage.getItem(na)||"").trim();return t&&(t==="expenses"||t==="callsheet")?t:""}catch{return""}}function Go(t){try{t&&localStorage.setItem(na,String(t))}catch{}}function Ko(t){if(!t)return;let e="";try{const s=new URLSearchParams(window.location.search||"");e=s.get("tplType")||s.get("templatesType")||""}catch{}const n=Yo(),r=e&&(e==="expenses"||e==="callsheet")?e:n;if(!r)return;Array.from(t.options).some(s=>s.value===r)&&(t.value=r)}function Zo(){const t=document.getElementById("templates-actions");if(!t||document.getElementById("tpl-zoom-controls"))return;const e=document.createElement("div");e.id="tpl-zoom-controls",e.className="tpl-zoom-controls",e.innerHTML=`
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-out title="تصغير">−</button>
    <span class="tpl-zoom-value" data-tpl-zoom-value>100%</span>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-in title="تكبير">+</button>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-fit title="ملء العرض">↔︎</button>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-reset title="1:1">1:1</button>
  `,t.appendChild(e);const n=e.querySelector("[data-tpl-zoom-out]"),r=e.querySelector("[data-tpl-zoom-in]"),o=e.querySelector("[data-tpl-zoom-reset]"),s=e.querySelector("[data-tpl-zoom-fit]");xe=e.querySelector("[data-tpl-zoom-value]"),n?.addEventListener("click",()=>nr(-.1)),r?.addEventListener("click",()=>nr(.1)),o?.addEventListener("click",()=>{St="manual",mn(St),Ee(1,{markManual:!0})}),s?.addEventListener("click",()=>{St="fit",mn(St),Ce(),rr(),ar()}),St=ea(),St==="fit"?(Ce(),rr(),ar()):Ee(ta(),{silent:!1})}function Jo(t="expenses"){if(!document.getElementById("templates-actions"))return;const n=document.getElementById("templates-controls"),r=document.getElementById("tpl-logo-controls"),o=document.getElementById("tpl-controls-row2")||(()=>{const l=document.createElement("div");return l.id="tpl-controls-row2",Object.assign(l.style,{display:"flex",flexWrap:"wrap",gap:"8px",width:"100%",alignItems:"center",marginTop:"6px"}),n?.appendChild(l),l})();if(t!=="callsheet"){r&&r.remove();return}if(r)return;const s=document.createElement("div");s.id="tpl-logo-controls",Object.assign(s.style,{display:"inline-flex",gap:"6px",alignItems:"center",flexWrap:"wrap"}),s.innerHTML=`
    <div class="input-group" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">لوغو ارت ريشيو</label>
      <input type="range" id="tpl-logo1-size" min="0.3" max="3" step="0.01" title="حجم لوغو ارت ريشيو">
      <button type="button" class="btn btn-outline" id="tpl-logo1-reset" title="إعادة تموضع لوغو ارت ريشيو">↺</button>
      <label class="form-check-label" style="display:inline-flex;align-items:center;gap:6px;margin:0 0 0 8px;">
        <input type="checkbox" id="tpl-logo1-hide" class="form-check-input">
        <span>إخفاء اللوغو</span>
      </label>
    </div>
    <div class="input-group" style="display:inline-flex;gap:6px;align-items:center;">
      <input type="url" id="tpl-logo2-url" class="form-control" placeholder="🔗 رابط لوغو إضافي" style="min-width:220px;max-width:320px;">
      <input type="range" id="tpl-logo2-size" min="0.3" max="3" step="0.01" title="حجم لوغو العميل">
      <button type="button" class="btn btn-outline" id="tpl-logo2-apply">تطبيق</button>
      <button type="button" class="btn btn-outline" id="tpl-logo2-reset">إعادة تموضع</button>
      <button type="button" class="btn btn-outline btn-danger" id="tpl-logo2-clear">حذف</button>
    </div>
    <div class="input-group" id="tpl-font-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">حجم الخط</label>
      <button type="button" class="btn btn-outline" id="tpl-font-down" title="تصغير الخط">A−</button>
      <button type="button" class="btn btn-outline" id="tpl-font-up" title="تكبير الخط">A+</button>
      <button type="button" class="btn btn-outline" id="tpl-font-bold" title="تسميك الخط (Bold)"><strong>B</strong></button>
    </div>
    <div class="input-group" id="tpl-shade-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">تظليل</label>
      <input type="color" id="tpl-shade-color" value="#fff59d" title="لون التظليل">
      <input type="range" id="tpl-shade-opacity" min="0" max="100" step="1" value="40" title="الشفافية %">
      <select id="tpl-shade-target" class="form-select" style="height:32px;">
        <option value="cell">خلية</option>
        <option value="row">صف</option>
      </select>
      <button type="button" class="btn btn-outline" id="tpl-shade-apply">تطبيق</button>
      <button type="button" class="btn btn-outline btn-danger" id="tpl-shade-clear">إزالة</button>
    </div>
    <div class="input-group" id="tpl-history-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <button type="button" class="btn btn-outline" id="tpl-undo" title="تراجع">↶</button>
      <button type="button" class="btn btn-outline" id="tpl-redo" title="تقديم">↷</button>
    </div>
  `,o.appendChild(s);try{const l=Bn(),p=document.getElementById("tpl-logo2-url"),m=document.getElementById("tpl-logo2-size");p&&l.url&&(p.value=l.url),m&&(m.value=String(l.s||1));const h=Mn(),f=document.getElementById("tpl-logo1-size");f&&(f.value=String(h.s||1));const y=document.getElementById("tpl-logo1-hide");y&&(y.checked=!!h.h)}catch(l){Kt(l,"تعذر حفظ القالب")}document.getElementById("tpl-logo2-apply")?.addEventListener("click",()=>{const l=document.getElementById("tpl-logo2-url")?.value?.trim()||"";ke({url:l});try{ft()}catch{}}),document.getElementById("tpl-logo2-clear")?.addEventListener("click",()=>{ke({url:"",w:0,x:0,y:0});try{const l=me(),p=localStorage.getItem(l);if(p){const m=JSON.parse(p);if(m){if(m.snap&&m.snap.r&&(m.snap.r.url=""),m.html&&typeof m.html=="string")try{const h=document.createElement("div");h.innerHTML=m.html;const f=h.firstElementChild,y=f&&f.querySelector(".cs-logo--right img");if(y){y.removeAttribute("src");const E=y.closest(".cs-logo--right");E&&E.setAttribute("data-empty","1")}m.html=f?f.outerHTML:m.html}catch{}localStorage.setItem(l,JSON.stringify(m))}}}catch{}try{Mt(),Bt()}catch{}try{ft()}catch{}}),document.getElementById("tpl-logo2-reset")?.addEventListener("click",()=>{ke({x:0,y:0});try{ft()}catch{}}),document.getElementById("tpl-logo1-hide")?.addEventListener("change",l=>{const p=!!l?.target?.checked;try{ra({h:p})}catch{}try{ft()}catch{}}),document.getElementById("tpl-undo")?.addEventListener("click",()=>Io()),document.getElementById("tpl-redo")?.addEventListener("click",()=>No());const c=document.getElementById("tpl-font-down"),i=document.getElementById("tpl-font-up");c?.addEventListener("click",l=>{try{ir(l&&l.shiftKey?-2:-1)}catch{}}),i?.addEventListener("click",l=>{try{ir(l&&l.shiftKey?2:1)}catch{}}),document.getElementById("tpl-font-bold")?.addEventListener("click",()=>{try{ts()}catch{}});const u=document.getElementById("tpl-shade-apply"),d=document.getElementById("tpl-shade-clear");u?.addEventListener("click",()=>{try{ns()}catch{}}),d?.addEventListener("click",()=>{try{rs()}catch{}})}function qt(){const e=document.getElementById("templates-project")?.value||"";return ie().find(n=>String(n.id)===String(e))||null}function ge(t){const e=document.getElementById("templates-reservation");if(!e)return[];const n=e.value||"",r=Jr(t);if(!n)return r;const o=r.find(s=>String(s.id||s.reservationId)===String(n));return o?[o]:[]}const xt={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",companyCR:"4030485240",companyLicense:"159460"};let Dt=typeof localStorage<"u"&&localStorage.getItem("templates.lang")||"en";function or(t){Dt=t==="ar"?"ar":"en";try{localStorage.setItem("templates.lang",Dt)}catch{}}function ht(t){try{const e=Math.round(Number(t)||0),n=Dt==="ar"?"ar-SA":"en-US";return e.toLocaleString(n,{maximumFractionDigits:0,minimumFractionDigits:0,useGrouping:!0})}catch{const n=Math.round(Number(t)||0);return String(n)}}function Qo(){return{headerFooter:!1,logoUrl:xt.logoUrl,companyName:xt.companyName,companyCR:xt.companyCR,companyLicense:xt.companyLicense}}function Bn(){try{return{url:localStorage.getItem("templates.callsheet.logo2.url")||"",s:Number(localStorage.getItem("templates.callsheet.logo2.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo2.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo2.y")||"0")||0}}catch{return{url:"",w:0,x:0,y:0}}}function ke(t={}){try{const n={...Bn(),...t};typeof n.url=="string"&&localStorage.setItem("templates.callsheet.logo2.url",n.url),Number.isFinite(n.s)&&localStorage.setItem("templates.callsheet.logo2.s",String(n.s)),Number.isFinite(n.x)&&localStorage.setItem("templates.callsheet.logo2.x",String(n.x)),Number.isFinite(n.y)&&localStorage.setItem("templates.callsheet.logo2.y",String(n.y))}catch{}}function Mn(){try{return{s:Number(localStorage.getItem("templates.callsheet.logo1.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo1.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo1.y")||"0")||0,h:localStorage.getItem("templates.callsheet.logo1.h")==="1"}}catch{return{s:1,x:0,y:0,h:!1}}}function ra(t={}){try{const n={...Mn(),...t};Number.isFinite(n.s)&&localStorage.setItem("templates.callsheet.logo1.s",String(n.s)),Number.isFinite(n.x)&&localStorage.setItem("templates.callsheet.logo1.x",String(n.x)),Number.isFinite(n.y)&&localStorage.setItem("templates.callsheet.logo1.y",String(n.y)),typeof n.h=="boolean"&&localStorage.setItem("templates.callsheet.logo1.h",n.h?"1":"0")}catch{}}let $e=!1,sr=null,cr=null,lr=null;function Nt(){$e=!0,clearTimeout(sr),sr=setTimeout(()=>{$e=!1;try{ls()}catch{}},1200)}function ir(t=0){try{if(!document.getElementById("templates-a4-root")||!Number.isFinite(t)||t===0)return;const n=window.getSelection(),o=(()=>{let u=n&&n.anchorNode||document.activeElement;if(!u)return null;u.nodeType===3&&(u=u.parentElement);let d=u instanceof Element?u:null;for(;d&&d!==document.body;){if(d.hasAttribute&&d.hasAttribute("contenteditable"))return d;d=d.parentElement}return null})();if(!o)return;const s=Number.parseFloat(getComputedStyle(o).fontSize||"11")||11,i=(u=>Math.max(7,Math.min(20,u)))(s+t),a=u=>{try{u.style.fontSize=i+"px"}catch{}};if(n&&n.rangeCount>0&&!n.isCollapsed){const u=n.getRangeAt(0);if(o.contains(u.commonAncestorContainer))try{const d=document.createElement("span");d.style.fontSize=i+"px";const l=u.extractContents();d.appendChild(l),u.insertNode(d),n.removeAllRanges();const p=document.createRange();p.setStartAfter(d),p.setEndAfter(d),n.addRange(p)}catch{a(o)}else a(o)}else a(o);try{Mt(),Bt()}catch{}Nt()}catch{}}function ts(){try{if(!document.getElementById("templates-a4-root"))return;const e=window.getSelection(),r=(()=>{let i=e&&e.anchorNode||document.activeElement;if(!i)return null;i.nodeType===3&&(i=i.parentElement);let a=i instanceof Element?i:null;for(;a&&a!==document.body;){if(a.hasAttribute&&a.hasAttribute("contenteditable"))return a;a=a.parentElement}return null})();if(!r)return;const s=!(Number.parseInt(getComputedStyle(r).fontWeight||"400",10)>=600),c=i=>{try{i.style.fontWeight=s?"700":"400"}catch{}};if(e&&e.rangeCount>0&&!e.isCollapsed){const i=e.getRangeAt(0);if(r.contains(i.commonAncestorContainer))try{const a=document.createElement("span");a.style.fontWeight=s?"700":"400";const u=i.extractContents();a.appendChild(u),i.insertNode(a),e.removeAllRanges();const d=document.createRange();d.setStartAfter(a),d.setEndAfter(a),e.addRange(d)}catch{c(r)}else c(r)}else c(r);try{Mt(),Bt()}catch{}Nt()}catch{}}function es(t){try{let e=(t||"").trim();e.startsWith("#")&&(e=e.slice(1)),e.length===3&&(e=e.split("").map(c=>c+c).join(""));const n=parseInt(e,16),r=n>>16&255,o=n>>8&255,s=n&255;return{r,g:o,b:s}}catch{return{r:255,g:255,b:0}}}function aa(){try{const t=document.getElementById("templates-a4-root");if(!t)return null;const e=window.getSelection();let n=e&&e.anchorNode||document.activeElement;if(!n)return null;n.nodeType===3&&(n=n.parentElement);let r=n instanceof Element?n:null;for(;r&&r!==document.body;){if((r.tagName==="TD"||r.tagName==="TH")&&t.contains(r))return r;r=r.parentElement}return null}catch{return null}}function en(t,e){if(t)try{t.setAttribute("data-shaded","1"),t.style.setProperty("--shade",e),t.style.setProperty("background","var(--shade)","important"),t.style.setProperty("background-color","var(--shade)","important")}catch{}}function nn(t){if(t)try{t.removeAttribute("data-shaded"),t.style.removeProperty("--shade"),t.style.removeProperty("background"),t.style.removeProperty("background-color")}catch{}}function ns(){const t=document.getElementById("tpl-shade-color"),e=document.getElementById("tpl-shade-opacity"),n=document.getElementById("tpl-shade-target"),{r,g:o,b:s}=es(t?.value||"#fff59d"),c=Math.max(0,Math.min(100,Number(e?.value||40)))/100,i=`rgba(${r}, ${o}, ${s}, ${c})`,a=aa();if(!a)return;if((n?.value||"cell")==="row"){const d=a.closest("tr");d?Array.from(d.children).forEach(l=>en(l,i)):en(a,i)}else en(a,i);try{Mt(),Bt(),Nt()}catch{}}function rs(){const t=aa();if(!t)return;if((document.getElementById("tpl-shade-target")?.value||"cell")==="row"){const r=t.closest("tr");r?Array.from(r.children).forEach(o=>nn(o)):nn(t)}else nn(t);try{Mt(),Bt(),Nt()}catch{}}function me(){try{const t=qt(),e=document.getElementById("templates-type"),n=e?e.value:"expenses",r=document.getElementById("templates-reservation"),o=r&&r.value?String(r.value):"all";return`templates.callsheet.autosave.${t?.id!=null?String(t.id):"no-project"}.${n}.${o}`}catch{return"templates.callsheet.autosave"}}function as(){try{const t=oa();if(!t)return;let e="";try{const r=document.getElementById("templates-a4-root");r&&(e=r.outerHTML)}catch{}const n={v:1,ts:Date.now(),snap:t,html:e};localStorage.setItem(me(),JSON.stringify(n))}catch{}}function Bt(){clearTimeout(cr),cr=setTimeout(as,250)}function oa(){const t=document.getElementById("templates-a4-root");if(!t)return null;const e=Array.from(t.querySelectorAll('[data-editable="true"]')).map(r=>r.innerHTML),n=Ho(t);return{edits:e,l:Mn(),r:Bn(),sh:n}}function os(t){if(!(!t||!document.getElementById("templates-preview-host")))try{ra(t.l||{}),ke(t.r||{});const n=document.getElementById("templates-a4-root");n&&Array.isArray(t.edits)&&Array.from(n.querySelectorAll('[data-editable="true"]')).forEach((o,s)=>{s<t.edits.length&&(o.innerHTML=t.edits[s])})}finally{try{ft()}catch{}}}function sa(){try{const t=`remoteAutosaveId:${me()}`,e=localStorage.getItem(t);return e?Number(e):null}catch{return null}}function dr(t){try{const e=`remoteAutosaveId:${me()}`;t&&localStorage.setItem(e,String(t))}catch{}}function Rn(t){try{const e=document.createElement("div");return e.innerHTML=String(t||""),e.querySelectorAll("script").forEach(n=>n.parentElement?.removeChild(n)),Array.from(e.querySelectorAll("*")).forEach(n=>{try{Array.from(n.attributes||[]).forEach(o=>{/^on/i.test(o.name)&&n.removeAttribute(o.name)})}catch{}}),e.innerHTML}catch{return t}}async function ss(){let t=sa();if(t)return t;const n=(await Oe()||[]).find(d=>{const l=String(d?.title||"").toLowerCase();return l.includes("autosave")||l.includes("draft")||l.includes("مسودة")});if(n&&n.id)return dr(n.id),n.id;const r=qt();if(!r)return null;const o=document.getElementById("templates-type"),s=o?o.value:"expenses",c=document.getElementById("templates-reservation"),i=c&&c.value?Number(c.value):null,a=document.querySelector("#templates-preview-host #templates-a4-root");if(!a)return null;const u={html:Rn(a.outerHTML)};try{await _t("/project-templates/",{method:"POST",body:{project_id:Number(r.id),reservation_id:i,type:s,title:`Autosave - ${s}`,data:u}});const l=(await Oe()||[]).find(p=>String(p?.title||"").toLowerCase().includes("autosave"));if(l&&l.id)return dr(l.id),l.id}catch{}return null}async function cs(){const t=document.querySelector("#templates-preview-host #templates-a4-root");if(!t)return;const e=await ss();if(!e)return;const n={html:Rn(t.outerHTML)};try{await _t(`/project-templates/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:{data:n}})}catch(r){Kt(r,"تعذر الحفظ التلقائي")}}function ls(){clearTimeout(lr),lr=setTimeout(()=>{cs()},800)}function ft(){const t=document.getElementById("templates-preview-host");if(!t)return;try{t.style.visibility="hidden"}catch{}const e=qt(),n=t.querySelector("#templates-a4-root");if(!e){t.innerHTML="";const a=v("div",{class:"text-muted",text:U("projects.templates.empty","اختر مشروعاً لبدء إنشاء القوالب.")});t.appendChild(a);try{t.style.visibility=""}catch{}return}const r=ge(e.id),o=document.getElementById("templates-type")?.value||"expenses",s=Qo();Jo(o);let c=null;c||(o==="callsheet"?c=xo(e,r,s):c=So(e,r,s));const i=c;if(n&&i&&n.tagName===i.tagName){const a=n.querySelector("[data-a4-pages]"),u=i.querySelector("[data-a4-pages]");if(a&&u)try{a.replaceWith(u)}catch{n.innerHTML=i.innerHTML}else n.innerHTML=i.innerHTML;c=n}else t.innerHTML="",t.appendChild(i),c=i;try{re(c)}catch{}try{Bo(c,o)}catch{}try{Zr({onAfterChange:()=>{try{Mt(),Bt(),Nt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:xt.logoUrl,isLandscape:!0}),Zt()},30)}catch{}}})}catch{}try{Kr()}catch{}try{o==="callsheet"&&(yr(),fr(),De(),fn(),yn())}catch{}try{ur()}catch{}try{ur()}catch{}try{if(o==="callsheet"){const a=ge(e.id)?.[0]||null,u=()=>ln(a);Promise.resolve(Xa()).catch(()=>{}).finally(()=>{we()?.length?u():Ya().then(u).catch(()=>u())})}}catch{}try{o==="callsheet"&&ln(ge(e.id)?.[0]||null)}catch{}try{Array.from(c.querySelectorAll(".a4-page")).forEach(a=>{dn(a)||a.parentElement?.removeChild(a)})}catch{}try{hn()}catch{}jn();try{un({headerFooter:!1,logoUrl:xt.logoUrl})}catch{}try{In({headerFooter:!1,logoUrl:xt.logoUrl})}catch{}try{Array.from(c.querySelectorAll(".a4-page")).forEach(a=>{dn(a)||a.parentElement?.removeChild(a)})}catch{}try{o==="callsheet"&&De()}catch{}try{o==="callsheet"&&(yr(),fr(),De(),fn(),yn(),re(c),Zt())}catch{}try{hn()}catch{}try{pe({headerFooter:!1,logoUrl:xt.logoUrl,isLandscape:!0})}catch{}try{o==="callsheet"&&re(c)}catch{}try{ia()}catch{}try{o==="callsheet"&&localStorage.getItem("templates.debugOverlay")==="1"&&yo(c,ge(e.id)?.[0]||null)}catch{}try{o==="callsheet"&&re(c)}catch{}try{t.style.visibility=""}catch{}try{if(St=ea(),St==="fit")Ce();else{const a=ta();Gt=a,Ee(a,{silent:!0})}xe&&(xe.textContent=`${Math.round(Gt*100)}%`)}catch{}}function ur(){const t=document.getElementById("templates-a4-root");if(!t)return;Array.from(t.querySelectorAll("table.exp-details td")).forEach(n=>{try{if(n===n.parentElement?.lastElementChild){n.removeAttribute("contenteditable"),n.removeAttribute("data-editable");return}if(!(n.getAttribute("data-editable")==="true"||n.getAttribute("contenteditable")==="true"||!!n.querySelector('[contenteditable="true"]')))return;const s=n.querySelector('[contenteditable="true"]');if(s){const c=s.innerHTML;n.innerHTML=c}n.setAttribute("data-editable","true"),n.setAttribute("contenteditable","true"),n.setAttribute("autocapitalize","off"),n.setAttribute("autocorrect","off"),n.setAttribute("autocomplete","off"),n.setAttribute("spellcheck","false")}catch{}})}async function kn(){const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t){alert("لا يوجد محتوى للطباعة");return}const e=document.getElementById("templates-type")?.value||"expenses",r=(o=>{try{const c=`templatesPdf.orientation.${o}`,i=mt(c,"");if(i==="portrait"||i==="landscape")return i}catch{}return{expenses:"portrait",callsheet:"landscape"}[o]||"landscape"})(e);if(e==="callsheet"){try{await(await Un(async()=>{const{printCallsheetFromHost:o}=await import("./print.CEJjwyZq.js");return{printCallsheetFromHost:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]),import.meta.url)).printCallsheetFromHost(t)}catch{alert("تعذر إنشاء PDF")}return}else{try{const{printGenericTemplate:o}=await Un(async()=>{const{printGenericTemplate:s}=await import("./print.CEJjwyZq.js");return{printGenericTemplate:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]),import.meta.url);await o(t,{orientation:r,filename:`template-${e}.pdf`})}catch{alert("تعذر إنشاء PDF")}return}}function is(){try{const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t){alert("لا يوجد محتوى للمعاينة");return}const e=document.createElement("div");Object.assign(e.style,{position:"fixed",inset:"0",background:"rgba(15,23,42,0.6)",zIndex:"9998",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"});const n=document.createElement("div");Object.assign(n.style,{background:"#fff",borderRadius:"12px",maxWidth:"92vw",maxHeight:"88vh",width:"min(1200px,92vw)",padding:"12px",boxShadow:"0 12px 30px rgba(0,0,0,0.25)",display:"flex",flexDirection:"column",gap:"12px"});const r=document.createElement("div");r.textContent="معاينة الطباعة",r.style.cssText="font-weight:800;font-size:16px";const o=document.createElement("div");Object.assign(o.style,{overflow:"auto",flex:"1 1 auto",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"10px",background:"#f8fafc"});const s=document.createElement("div");Object.assign(s.style,{display:"flex",gap:"8px",justifyContent:"flex-start"});const c=document.createElement("button");c.className="btn btn-outline",c.textContent="إغلاق",c.onclick=()=>e.remove();const i=document.createElement("button");i.className="btn btn-primary",i.textContent="طباعة الآن",i.onclick=async()=>{e.remove();try{await kn()}catch{}},s.appendChild(i),s.appendChild(c);const a=t.cloneNode(!0),u=a.querySelector("[data-a4-pages]")||a,d=Array.from(u.querySelectorAll(".a4-page")),l=f=>{try{const y=!!f.querySelector("#expenses-top-sheet"),E=!!f.querySelector('table.exp-details tbody tr[data-row="item"]'),P=!!Array.from(f.querySelectorAll("table.tpl-table tbody tr")).find(x=>Array.from(x.querySelectorAll("td")).some(w=>(w.textContent||"").trim().length>0)),g=!!Array.from(f.querySelectorAll(".callsheet-v1 table.cs-crew tbody tr")).find(x=>Array.from(x.querySelectorAll("td")).some(w=>(w.textContent||"").trim().length>0)),C=!!f.querySelector(".callsheet-v1 .cs-header, .callsheet-v1 .cs-info td, .callsheet-v1 .cs-cast td");return y||E||P||g||C}catch{return!0}};d.forEach(f=>{l(f)||f.parentElement?.removeChild(f)});const p=Array.from(u.querySelectorAll(".a4-page")),m=document.createElement("div");m.textContent=`عدد الصفحات: ${p.length}`,m.style.cssText="font-size:12px;color:#475569";const h=document.createElement("div");Object.assign(h.style,{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(360px, 1fr))",gap:"14px"}),p.forEach(f=>{const y=document.createElement("div");Object.assign(y.style,{background:"#fff",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"6px",display:"flex",justifyContent:"center",alignItems:"center"});const E=f.cloneNode(!0);Object.assign(E.style,{transform:"scale(0.45)",transformOrigin:"top left",width:f.clientWidth+"px",height:f.clientHeight+"px"}),y.appendChild(E),h.appendChild(y)}),o.appendChild(m),o.appendChild(h),n.appendChild(r),n.appendChild(o),n.appendChild(s),e.appendChild(n),document.body.appendChild(e)}catch{alert("تعذر إنشاء المعاينة")}}async function pr(t=!1){try{const e=document.getElementById("templates-a4-root");if(!e){alert("لا يوجد محتوى");return}const n=e.querySelector(".callsheet-v1 table.cs-crew");if(!n){alert("لا يوجد جدول Crew في القالب الحالي");return}const r=qt(),o=r&&ge(r.id)?.[0]||null;if(!o){alert("اختر حجزاً مرتبطاً أولاً");return}t?Or(n,o):ln(o);try{It("تم جلب بيانات الطاقم","success",2500)}catch{}}catch{alert("تعذر جلب بيانات الطاقم")}}function ca(){try{return`templatesPdf.${document.getElementById("templates-type")?.value||"expenses"}`}catch{return"templatesPdf.expenses"}}function la(t){const e=String(t||"").replace(/^templatesPdf[.:]/,"");return{ns:`${ca()}.${e}`,legacy:`templatesPdf.${e}`}}function mt(t,e){try{const{ns:n,legacy:r}=la(t);let o=localStorage.getItem(n);if(o==null&&(o=localStorage.getItem(r)),o==null)return e;const s=Number(o);return Number.isFinite(s)?s:e}catch{return e}}function mr(t,e){try{const{ns:n}=la(t);localStorage.setItem(n,String(e))}catch{}}function Dn(){return`${ca()}.pageOverrides`}function qn(){try{const t=localStorage.getItem(Dn());return t?JSON.parse(t):{}}catch{return{}}}function Lt(t,e,n){try{const r=qn(),o=String(t);r[o]=r[o]||{},r[o][e]=Number(n),localStorage.setItem(Dn(),JSON.stringify(r))}catch{}}function Wt(t,e,n){try{const o=qn()[String(e)];return o&&o[t]!=null&&Number.isFinite(Number(o[t]))?Number(o[t]):mt(t,n)}catch{return mt(t,n)}}function ds(){try{localStorage.removeItem(Dn())}catch{}}async function us(){const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t)return;const n=(document.getElementById("templates-type")?.value||"expenses")!=="expenses";try{const V=document.getElementById("templates-pdf-live-slot");V&&(V.innerHTML='<div style="padding:8px;color:#64748b">… جار إنشاء المعاينة</div>')}catch{}let r;try{r=await Ja()}catch{r=null}let o=window.html2canvas;if(typeof o!="function"){try{await Mr("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js")}catch{}o=window.html2canvas}if(typeof o!="function"){const V=document.getElementById("templates-pdf-live-slot");V&&(V.innerHTML='<div style="padding:8px;color:#ef4444">تعذر تحميل html2canvas لمعاينة PDF. تأكد من اتصال الشبكة ثم أعد المحاولة.</div>');return}const s=n?1123:794,c=n?794:1123,i=n?297:210,u=96/25.4,d=document.getElementById("pdftun-page")?.value,l=Math.max(0,Number(d??0)||0),p=Array.from(t.querySelectorAll(".a4-page")),m=p[l]||p[0];if(!m)return;const h=document.createElement("div");Object.assign(h.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const f=document.createElement("div");f.id="templates-a4-root",f.setAttribute("data-render-context","export"),f.setAttribute("dir",t.getAttribute("dir")||document.documentElement.getAttribute("dir")||"rtl");const y=document.createElement("div");y.setAttribute("data-a4-pages","");const E=m.cloneNode(!0);E.style.width=`${s}px`,E.style.height=`${c}px`,E.style.background="#ffffff",E.style.overflow="hidden";try{((tt,dt)=>{const et=tt.querySelector("table.exp-details");if(!et)return;const ut=et.tBodies&&et.tBodies[0];if(!ut||!!!ut.querySelector('tr[data-row="item"]'))return;const nt=ut.firstElementChild;if(nt&&nt.hasAttribute&&nt.hasAttribute("data-group-bar"))return;let vt=tt.querySelector("tbody > tr[data-group-bar]");!vt&&dt&&(vt=dt.querySelector("tbody > tr[data-group-bar]")),vt&&ut.insertBefore(vt.cloneNode(!0),ut.firstElementChild)})(E,m)}catch{}y.appendChild(E),f.appendChild(y),h.appendChild(f),document.body.appendChild(h);const P=Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),g={scale:P,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},C=(V,tt=246)=>{try{const dt=V.getContext("2d"),{width:et,height:ut}=V;for(let ot=0;ot<ut;ot+=2){const nt=dt.getImageData(0,ot,et,1).data;let vt=0;for(let ct=0;ct<et;ct+=1){const pt=ct*4;if((nt[pt]<tt||nt[pt+1]<tt||nt[pt+2]<tt)&&++vt>Math.max(2,Math.ceil(et*.003)))return ot}}return 0}catch{return 0}},x=(V,tt=244)=>{try{const dt=V.getContext("2d"),{width:et,height:ut}=V,ot=Math.floor(et*.55),nt=Math.max(10,et-ot),vt=Math.max(3,Math.ceil(nt*.015));for(let ct=0;ct<ut;ct+=2){const pt=dt.getImageData(ot,ct,nt,1).data;let he=0;for(let fe=0;fe<nt;fe+=1){const Yt=fe*4,ye=pt[Yt],Ye=pt[Yt+1],Ge=pt[Yt+2];if((ye<tt||Ye<tt||Ge<tt)&&++he>=vt)return ct}}return 0}catch{return 0}},w=(V,tt=244)=>{try{const dt=V.getContext("2d"),{width:et,height:ut}=V,ot=Math.floor(et*.2),nt=Math.max(10,Math.floor(et*.6)),vt=Math.max(12,Math.ceil(nt*.08)),ct=4;for(let pt=ct;pt<ut;pt+=2){const he=dt.getImageData(ot,pt,nt,1).data;let fe=0;for(let Yt=0;Yt<nt;Yt+=1){const ye=Yt*4,Ye=he[ye],Ge=he[ye+1],xa=he[ye+2];if((Ye<tt||Ge<tt||xa<tt)&&++fe>=vt)return pt}}return 0}catch{return 0}},T=(V,tt=246)=>{try{const dt=V.getContext("2d"),{width:et,height:ut}=V;for(let ot=ut-1;ot>=0;ot-=2){const nt=dt.getImageData(0,ot,et,1).data;let vt=0;for(let ct=0;ct<et;ct+=1){const pt=ct*4;if((nt[pt]<tt||nt[pt+1]<tt||nt[pt+2]<tt)&&++vt>Math.max(2,Math.ceil(et*.003)))return ut-1-ot}}return 0}catch{return 0}},I=(V,tt,dt)=>{try{const{width:et,height:ut}=V,ot=Math.max(0,Math.min(ut-1,Math.round(tt))),nt=Math.max(0,Math.min(ut-ot,Math.round(dt))),vt=Math.max(1,ut-ot-nt);if(ot===0&&nt===0)return V;const ct=document.createElement("canvas");return ct.width=et,ct.height=vt,ct.getContext("2d").drawImage(V,0,-ot),ct}catch{return V}};let L=0;try{const V=E.querySelector(".a4-inner")||E,tt=V.querySelector(".exp-masthead")||V.firstElementChild;if(tt){const dt=E.getBoundingClientRect(),et=tt.getBoundingClientRect();L=Math.max(0,et.top-dt.top)}}catch{L=0}let A;try{await Lo(f),A=await o(E,{...g,scrollX:0,scrollY:0,windowWidth:s,windowHeight:c})}finally{try{h.parentNode?.removeChild(h)}catch{}}if(!A)return;const k=C(A,246),q=x(A,244),B=w(A,244),b=document.getElementById("pdftun-page")?.value||"all",R=b==="all"?0:Math.max(0,Number(b)||0),D=Wt("templatesPdf.extraTrimMm",R,mt("templatesPdf.extraTrimMm",14)),N=Wt("templatesPdf.safeMarginMm",R,mt("templatesPdf.safeMarginMm",.5)),j=Math.max(B,L*P),X=D*u*P,_=N*u*P,M=Math.max(k,q,B),O=Math.min(Math.max(0,M+X),Math.max(0,j-_)),$=T(A,246),G=I(A,O,$),F=mt("templatesPdf.scalePct",100)/100,H=Math.max(.98,Math.min(1,F||1)),at=i*H,rt=G.height/G.width*at,Q=Wt("templatesPdf.shiftRightMm",l,mt("templatesPdf.shiftRightMm",40)),gt=mt("templatesPdf.globalAllRightMm",0),Tt=l===0?mt("templatesPdf.tightFudgeMm",-144.5):0,Et=Wt("templatesPdf.tightFudgeMm",l,Tt),jt=mt("templatesPdf.globalYmm",0),Xt=mt("templatesPdf.globalAllYmm",-1),te=Q+gt;let Te=-(Math.max(0,L*P-O)*(at/G.width))+Et+jt+Xt;const Rt=document.createElement("canvas");Rt.width=s,Rt.height=c;const $t=Rt.getContext("2d");$t.fillStyle="#ffffff",$t.fillRect(0,0,Rt.width,Rt.height);const Le=Math.round(te*u),Pe=Math.round(Te*u),z=Math.round(at*u),K=Math.round(rt*u);try{$t.drawImage(G,Le,Pe,z,K)}catch{}const st=document.getElementById("templates-pdf-live-slot");if(st){st.innerHTML="";const V=document.createElement("img");V.src=Rt.toDataURL("image/png"),V.style.maxWidth="100%",V.style.height="auto",V.style.border="1px solid #e5e7eb",st.appendChild(V)}}function ia(){const t=document.getElementById("templates-controls");if(!t||document.getElementById("templates-pdf-tuner-toggle"))return;const e=t.querySelector(".ms-auto")||t,n=document.createElement("button");n.type="button",n.id="templates-pdf-tuner-toggle",n.className="btn btn-outline",n.textContent="🛠️ ضبط PDF",e.appendChild(n);const r=document.createElement("div");r.id="templates-pdf-tuner",r.style.display="none",r.style.marginTop="10px",r.style.border="1px solid #e5e7eb",r.style.borderRadius="10px",r.style.padding="10px",r.innerHTML=`
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>الصفحة</span>
        <select id="pdftun-page" style="width:110px;"></select>
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Offset (All)</span>
        <input id="pdftun-globalY" type="number" step="0.5" min="-1000" max="1000" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Right Shift (All)</span>
        <input id="pdftun-globalX" type="number" step="0.5" min="-1000" max="1000" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Trim (mm)</span>
        <input id="pdftun-extraTrim" type="number" step="0.5" min="0" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Safe Margin (mm)</span>
        <input id="pdftun-safeMargin" type="number" step="0.1" min="0" max="10" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Offset (mm)</span>
        <input id="pdftun-tightFudge" type="number" step="0.5" min="-40" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Right Shift (mm)</span>
        <input id="pdftun-right" type="number" step="0.5" min="-40" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Scale (%)</span>
        <input id="pdftun-scale" type="number" step="1" min="90" max="110" style="width:90px;" />
      </label>
      <span style="flex:1 1 auto"></span>
      <button type="button" class="btn btn-outline" id="pdftun-preset">تطبيق القيم</button>
      <button type="button" class="btn btn-outline" id="pdftun-reset">الافتراضيات</button>
      <button type="button" class="btn btn-primary" id="pdftun-print">🖨️ طباعة</button>
    </div>
  `,t.parentElement?.appendChild(r);const o=()=>{const u=r.querySelector("#pdftun-page"),d=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page")),l=u.value||"0",p=[];d.forEach((m,h)=>{p.push(`<option value="${h}">الصفحة ${h+1}</option>`)}),p.length?u.innerHTML=p.join(""):(u.innerHTML='<option value="0">الصفحة 1</option>',setTimeout(()=>{try{o()}catch{}},120)),Array.from(u.options).some(m=>m.value===l)?u.value=l:u.value="0"},s=()=>{const u=r.querySelector("#pdftun-page"),d=Math.max(0,Number(u.value||"0")),l=Wt("templatesPdf.extraTrimMm",d,mt("templatesPdf.extraTrimMm",14)),p=Wt("templatesPdf.safeMarginMm",d,mt("templatesPdf.safeMarginMm",.5));document.getElementById("pdftun-extraTrim").value=String(l),document.getElementById("pdftun-safeMargin").value=String(p);const h=Wt("templatesPdf.tightFudgeMm",d,d===0?-144.5:0),f=Wt("templatesPdf.shiftRightMm",d,mt("templatesPdf.shiftRightMm",40));document.getElementById("pdftun-tightFudge").value=String(h),document.getElementById("pdftun-right").value=String(f),document.getElementById("pdftun-scale").value=String(mt("templatesPdf.scalePct",100));try{document.getElementById("pdftun-globalY").value=String(mt("templatesPdf.globalAllYmm",-1))}catch{}try{document.getElementById("pdftun-globalX").value=String(mt("templatesPdf.globalAllRightMm",0))}catch{}},c=()=>{o(),s()};c(),n.addEventListener("click",()=>{if(r.style.display=r.style.display==="none"?"block":"none",r.style.display==="block"){try{o(),s()}catch{}try{const u=qn();if(u&&Object.keys(u).length===0&&!localStorage.getItem("templatesPdf.presetSeeded.v4")){const d=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page"));if(d.length){const m=[-145,-290,-435,-580,-725],h=[14,14,14,14,14],f=-145;d.forEach((y,E)=>{const P=E<m.length?m[E]:m[m.length-1]+f*(E-(m.length-1)),g=E<h.length?h[E]:h[h.length-1];Lt(E,"templatesPdf.shiftRightMm",61),Lt(E,"templatesPdf.tightFudgeMm",P),Lt(E,"templatesPdf.extraTrimMm",g),Lt(E,"templatesPdf.safeMarginMm",.5)}),localStorage.setItem("templatesPdf.presetSeeded.v4","1");try{localStorage.setItem("templatesPdf.globalAllYmm","-1")}catch{}s()}}}catch{}try{if(window.__pdfTunerMO)try{window.__pdfTunerMO.disconnect()}catch{}const u=document.querySelector("#templates-preview-host #templates-a4-root [data-a4-pages]")||document.querySelector("#templates-preview-host #templates-a4-root");if(u){const d=new MutationObserver(()=>{try{o()}catch{}});d.observe(u,{childList:!0,subtree:!0}),window.__pdfTunerMO=d}}catch{}us()}else try{window.__pdfTunerMO&&(window.__pdfTunerMO.disconnect(),window.__pdfTunerMO=null)}catch{}}),r.querySelector("#pdftun-page").addEventListener("change",()=>{s()});const i=(u,d,l=!0)=>{const p=document.getElementById(u);p.addEventListener("input",()=>{const m=p.value;if(l){const h=r.querySelector("#pdftun-page").value||"0";Lt(Number(h),d,m)}else mr(d,m)}),p.addEventListener("change",()=>{const m=p.value;if(l){const h=r.querySelector("#pdftun-page").value||"0";Lt(Number(h),d,m)}else mr(d,m)})};i("pdftun-extraTrim","templatesPdf.extraTrimMm",!0),i("pdftun-safeMargin","templatesPdf.safeMarginMm",!0),i("pdftun-tightFudge","templatesPdf.tightFudgeMm",!0),i("pdftun-right","templatesPdf.shiftRightMm",!0),i("pdftun-scale","templatesPdf.scalePct",!1),i("pdftun-globalY","templatesPdf.globalAllYmm",!1),i("pdftun-globalX","templatesPdf.globalAllRightMm",!1);const a=()=>{const u=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page")),d=61,l=.5,p=[-145,-290,-435,-580,-725],m=[14,14,14,14,14],h=-145;u.forEach((f,y)=>{const E=y<p.length?p[y]:p[p.length-1]+h*(y-(p.length-1)),P=y<m.length?m[y]:m[m.length-1];Lt(y,"templatesPdf.shiftRightMm",d),Lt(y,"templatesPdf.tightFudgeMm",E),Lt(y,"templatesPdf.extraTrimMm",P),Lt(y,"templatesPdf.safeMarginMm",l)});try{localStorage.setItem("templatesPdf.globalAllYmm","-1")}catch{}s()};document.getElementById("pdftun-preset").addEventListener("click",a),document.getElementById("pdftun-reset").addEventListener("click",()=>{try{["templatesPdf.extraTrimMm","templatesPdf.safeMarginMm","templatesPdf.tightFudgeMm","templatesPdf.shiftRightMm","templatesPdf.scalePct","templatesPdf.globalYmm","templatesPdf.globalAllYmm","templatesPdf.globalAllRightMm"].forEach(u=>localStorage.removeItem(u)),ds()}catch{}c()}),document.getElementById("pdftun-print").addEventListener("click",kn);try{window.__pdfTunerRefreshPages=o,window.__pdfTunerLoadValues=s}catch{}}function hr(){const t=document.getElementById("templates-project");if(!t)return;const e=ie().map(n=>({id:n.id,title:n.title||`#${n.id}`}));t.innerHTML='<option value="">— اختر —</option>'+e.map(n=>`<option value="${String(n.id)}">${n.title}</option>`).join("")}function rn(t){const e=document.getElementById("templates-reservation");if(!e)return;const n=t?Jr(t):[],r=['<option value="" selected>— بدون ربط —</option>'];n.forEach(o=>{const s=o.id??o.reservationId,c=(o.title||"").trim()||`#${s}`;r.push(`<option value="${String(s)}">${c}</option>`)}),e.innerHTML=r.join("")}function jn(){const t=Array.from(document.querySelectorAll("#templates-preview-host table.exp-details")),e=document.querySelector("#templates-preview-host #expenses-table"),n=t.length?t:e?[e]:[];if(!n.length)return;if(n[0].classList.contains("exp-table")){const h=(B,b=0)=>{const D=String(B||"").replace(/[\u0660-\u0669]/g,j=>"0123456789"[j.charCodeAt(0)-1632]).replace(/[\u06F0-\u06F9]/g,j=>"0123456789"[j.charCodeAt(0)-1776]).replace(/[\u066B]/g,".").replace(/[\u066C]/g,"").replace(/[\u200f\u200e]/g,"").replace(/[^\d.\-]/g,""),N=Number(D);return Number.isFinite(N)?N:b},f={atl:0,prod:0,post:0};let y=0;const E={},P={};n.flatMap(B=>Array.from(B.querySelectorAll("tbody tr[data-subgroup-header]"))).forEach(B=>{const b=B.getAttribute("data-subgroup");let R=0,D=0,N=B.nextElementSibling;for(;N&&!N.hasAttribute("data-subgroup-header")&&!N.hasAttribute("data-subgroup-subtotal");){if(N.getAttribute("data-row")==="item"){const M=N.children,O=h(M[2]?.textContent,0),$=h(M[3]?.textContent,1),G=h(M[4]?.textContent,1),F=$*G*O;if(M[6]){M[6].textContent=ht(F);try{M[6].setAttribute("data-num","1")}catch{}}R+=F,(String(M[1]?.textContent||"").trim().length||h(M[2]?.textContent,0)||h(M[3]?.textContent,0))&&(D+=1)}N=N.nextElementSibling}const j=document.querySelector(`#templates-preview-host [data-subtotal="${CSS.escape(b)}"]`);j&&(j.textContent=ht(R)),E[b]=R,P[b]=D,y+=R;const _=document.querySelector(`#templates-preview-host tr[data-subgroup-marker="${CSS.escape(b)}"]`)?.getAttribute("data-parent-group")||null;_&&f[_]!=null&&(f[_]+=R)}),Object.entries(f).forEach(([B,b])=>{const R=document.querySelector(`#templates-preview-host [data-total-group="${CSS.escape(B)}"]`);R&&(R.textContent=ht(b))});const C=document.querySelector("#templates-preview-host [data-grand-total]");C&&(C.textContent=ht(y));try{Object.entries(E).forEach(([b,R])=>{const D=P[b]||0,N=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-count="${CSS.escape(b)}"]`),j=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-total="${CSS.escape(b)}"]`);N&&(N.textContent=ht(D)),j&&(j.textContent=ht(R))}),Object.entries(f).forEach(([b,R])=>{const D=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-total-group="${CSS.escape(b)}"]`);D&&(D.textContent=ht(R))});const B=document.querySelector("#templates-preview-host #expenses-top-sheet [data-top-grand]");B&&(B.textContent=ht(y))}catch{}const x=qt(),w=U("reservations.create.summary.currency","SR"),T=!!x?.applyTax,I=T?Math.round(y*zn):0,L=Math.round(y+I),A=document.querySelector("#expenses-summary [data-summary-subtotal]"),k=document.querySelector("#expenses-summary [data-summary-tax]"),q=document.querySelector("#expenses-summary [data-summary-total]");A&&(A.textContent=`${ht(y)} ${w}`),k&&(k.textContent=T?`${ht(I)} ${w}`:`0 ${w}`),q&&(q.textContent=`${ht(L)} ${w}`);try{const B=document.activeElement;!!(B&&(B.getAttribute("contenteditable")==="true"||B.closest('[contenteditable="true"]'))&&B.closest("#templates-a4-root table.exp-details"))||requestAnimationFrame(()=>{try{un({headerFooter:!1,logoUrl:xt.logoUrl})}catch{}})}catch{}return}let r=0,o=0;Array.from(e.querySelectorAll("tbody tr")).forEach(h=>{if(h.matches("[data-section-bar]")){r=0;return}if(h.classList.contains("tpl-subtotal-row")){const P=h.querySelector("[data-subtotal]")||h.children[5];P&&(P.textContent=ht(r||0));return}const f=Number(String(h.children[3]?.textContent||"1").replace(/[^\d.\-]/g,""))||1,y=Number(String(h.children[4]?.textContent||"0").replace(/[^\d.\-]/g,""))||0,E=f*y;h.children[5]&&(h.children[5].textContent=ht(E)),r+=E,o+=E});const c=qt(),i=U("reservations.create.summary.currency","SR"),a=!!c?.applyTax,u=a?Math.round(o*zn):0,d=Math.round(o+u),l=document.querySelector("#expenses-summary [data-summary-subtotal]"),p=document.querySelector("#expenses-summary [data-summary-tax]"),m=document.querySelector("#expenses-summary [data-summary-total]");l&&(l.textContent=`${ht(o)} ${i}`),p&&(p.textContent=a?`${ht(u)} ${i}`:`0 ${i}`),m&&(m.textContent=`${ht(d)} ${i}`);try{const h=document.activeElement;!!(h&&(h.getAttribute("contenteditable")==="true"||h.closest('[contenteditable="true"]'))&&h.closest("#templates-a4-root table.exp-details"))||(requestAnimationFrame(()=>{try{un({headerFooter:!1,logoUrl:xt.logoUrl})}catch{}}),requestAnimationFrame(()=>{try{In({headerFooter:!1,logoUrl:xt.logoUrl})}catch{}}))}catch{}}function hn(){const t=document.querySelector("#templates-preview-host #templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll("table.exp-details"));if(!e.length)return;const n=new Map,r=i=>i?.hasAttribute("data-subgroup-header"),o=i=>i?.hasAttribute("data-subgroup-subtotal"),s=i=>i?.getAttribute("data-row")==="item",c=i=>String(i||"").split("-")[0]||"";e.forEach(i=>{const a=Array.from(i.querySelectorAll("tbody > tr"));let u=null,d="",l=0;a.forEach(p=>{if(r(p)){u=p.getAttribute("data-subgroup"),d=c(u),l=n.get(u)||0;return}if(o(p)){n.set(u,l),u=null,d="";return}if(s(p)&&d){l+=1;const m=p.children[0];if(m&&m.hasAttribute("contenteditable")){const h=String(l).padStart(2,"0");m.textContent=`${d}-${h}`}}}),u&&n.set(u,l)})}function fr(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]");if(!e||t.querySelector("table.cs-crew"))return;const r=document.createElement("section");r.className="a4-page a4-page--landscape";const o=document.createElement("div");o.className="a4-inner";const s=document.createElement("div");s.className="callsheet-v1",r.appendChild(o),o.appendChild(s);const c=document.createElement("table");c.className="tpl-table cs-crew",c.setAttribute("data-editable-table","crew");const i=[30,34,20,16],a=document.createElement("colgroup");i.forEach(h=>{const f=document.createElement("col");f.setAttribute("style",`width:${h}%`),a.appendChild(f)}),c.appendChild(a);const u=document.createElement("thead"),d=document.createElement("tr"),l=document.createElement("th");l.setAttribute("colspan",String(i.length)),l.className="cs-crew-title",l.textContent="Crew Call",d.appendChild(l),u.appendChild(d);const p=document.createElement("tr");["Position","Name","Phone","Time"].forEach((h,f)=>{const y=document.createElement("th");y.textContent=h,y.setAttribute("style",`width:${i[f]}%`),p.appendChild(y)}),u.appendChild(p),c.appendChild(u);const m=document.createElement("tbody");for(let h=0;h<18;h+=1){const f=document.createElement("tr");for(let y=0;y<4;y+=1){const E=document.createElement("td");E.setAttribute("data-editable","true"),E.setAttribute("contenteditable","true"),y===2&&(E.setAttribute("dir","ltr"),E.style.direction="ltr"),f.appendChild(E)}m.appendChild(f)}c.appendChild(m),s.appendChild(c),e.insertBefore(r,e.children[1]||null);try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:xt.logoUrl,isLandscape:!0}),Zt()},20)}catch{}}function yr(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll(".callsheet-v1"));if(e.length)try{const n=[];e.forEach(a=>{n.push(...Array.from(a.getElementsByTagName("table")))});const r=a=>!!(a.classList&&a.classList.contains("cs-crew")),o=a=>{try{return r(a)?!0:((a.querySelector("thead")?.textContent||a.textContent||"")+"").toLowerCase().includes("crew call")}catch{return!1}},s=n.filter(o);if(!s.length)return;let c=null;const i=s.filter(r);i.length?c=i[i.length-1]:c=s[0],s.forEach(a=>{if(a!==c)try{a.parentElement?.removeChild(a)}catch{}})}catch{}}function De(){try{const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]");if(!e)return;const n=t.querySelector("table.cs-crew");if(!n)return;const r=n.closest(".a4-page"),o=Array.from(e.querySelectorAll(".a4-page"));r&&o.indexOf(r)!==1&&e.insertBefore(r,e.children[1]||null);const s=r?r.querySelector("table.cs-schedule"):null;if(s){const c=document.createElement("section");c.className="a4-page a4-page--landscape";const i=document.createElement("div");i.className="a4-inner";const a=document.createElement("div");a.className="callsheet-v1",c.appendChild(i),i.appendChild(a),a.appendChild(s),e.insertBefore(c,e.children[2]||null)}}catch{}}function fn(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll(".callsheet-v1 table.cs-crew"));if(e.length<=1)return;const n=l=>{try{return!!l.querySelector("thead .cs-crew-title")}catch{return!1}},r=l=>{try{return Array.from(l.querySelectorAll("tbody td")).reduce((m,h)=>m+((h.textContent||"").trim().length>0?1:0),0)}catch{return 0}};let o=null;const s=e.filter(n);if(s.length)o=s[s.length-1];else{o=e[0];let l=r(o);e.slice(1).forEach(p=>{const m=r(p);m>l&&(o=p,l=m)})}const c=o.tBodies&&o.tBodies[0];if(!c)return;const i=l=>{for(let p=0;p<l;p+=1){const m=document.createElement("tr");for(let h=0;h<4;h+=1){const f=document.createElement("td");f.setAttribute("data-editable","true"),f.setAttribute("contenteditable","true"),m.appendChild(f)}c.appendChild(m)}},a=[];e.forEach(l=>{if(l===o||!n(l))return;const p=l.tBodies&&l.tBodies[0];p&&Array.from(p.children).forEach(m=>{const h=Array.from(m.children);h.some(y=>(y.textContent||"").trim().length>0)&&a.push(h.map(y=>y.textContent||""))})}),a.length&&i(Math.max(0,a.length-(c.children?.length||0)));const u=l=>Array.from(l.children).every(p=>!(p.textContent||"").trim().length);let d=0;Array.from(c.children).forEach(l=>{if(d>=a.length||!u(l))return;const p=a[d++],m=Array.from(l.children);for(let h=0;h<Math.min(m.length,p.length);h+=1)m[h].textContent=p[h]||""}),e.forEach(l=>{if(l!==o)try{l.parentElement?.removeChild(l)}catch{}})}function yn(){try{const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]"),n=e?Array.from(e.querySelectorAll(".a4-page")):[],r=m=>{const h=m?.closest?.(".a4-page");return h?n.indexOf(h):-1},o=Array.from(t.getElementsByTagName("table")),s=m=>!!(m.classList&&m.classList.contains("cs-crew")),c=["crew call","crewcall","crew","طاقم","طاقم العمل","كرو","كرو كول"],i=m=>{try{if(s(m))return!0;const h=((m.querySelector("thead")?.textContent||m.textContent||"")+"").toLowerCase();return c.some(f=>h.includes(f))}catch{return!1}},a=o.filter(i);if(a.length<=1)return;let u=null;const d=a.filter(s);u=d.find(m=>r(m)===1)||d[d.length-1]||a[0];const l=u.tBodies&&u.tBodies[0],p=m=>{for(let h=0;h<m;h+=1){const f=document.createElement("tr");for(let y=0;y<4;y+=1){const E=document.createElement("td");E.setAttribute("data-editable","true"),E.setAttribute("contenteditable","true"),f.appendChild(E)}l.appendChild(f)}};a.forEach(m=>{if(m!==u){if(s(m)){const h=m.tBodies&&m.tBodies[0];if(!h){try{m.remove()}catch{}return}const y=Array.from(h.children).map(P=>Array.from(P.children).map(g=>g.textContent||"")).filter(P=>P.some(g=>(g||"").trim().length>0));y.length&&p(Math.max(0,y.length-(l?.children?.length||0)));let E=0;Array.from(l.children).forEach(P=>{if(E>=y.length)return;const g=Array.from(P.children);if(!g.every(w=>!(w.textContent||"").trim().length))return;const x=y[E++];for(let w=0;w<Math.min(g.length,x.length);w+=1)g[w].textContent=x[w]||""})}try{m.parentElement?.removeChild(m)}catch{}}});try{const m=u.closest(".a4-page");m&&e&&Array.from(e.children).indexOf(m)!==1&&e.insertBefore(m,e.children[1]||null)}catch{}}catch{}}async function gr({copy:t=!1}={}){const e=qt();if(!e)throw alert("اختر مشروعاً أولاً"),new Error("No project selected");const n=document.getElementById("templates-type"),r=n?n.value:"expenses",o=document.getElementById("templates-reservation"),s=o&&o.value?Number(o.value):null,c=document.querySelector("#templates-preview-host #templates-a4-root");if(!c)throw alert("لا يوجد محتوى للحفظ"),new Error("No template root to save");const i={html:Rn(c.outerHTML)},a=document.getElementById("templates-save-title"),u=a&&a.value?String(a.value).trim():"";await _t("/project-templates/",{method:"POST",body:{project_id:Number(e.id),reservation_id:s,type:r,title:u||`${e.title||"Template"} - ${r}`,data:i}}),alert("تم حفظ القالب");try{localStorage.removeItem(me())}catch{}}async function Oe(){const t=qt();if(!t)return[];const e=document.getElementById("templates-type");let n=e?e.value:"expenses";const r=n==="callsheet"?["callsheet","call-sheet","callsheet_v1","callsheetv1","callsheet-v1"]:[n],o=new Set,s=[],c=i=>Array.isArray(i?.data)?i.data:Array.isArray(i)?i:Array.isArray(i?.items)?i.items:[];for(const i of r)try{const a=await _t(`/project-templates/?project_id=${encodeURIComponent(t.id)}&type=${encodeURIComponent(i)}`);c(a).forEach(u=>{const d=String(u?.id??"");!d||o.has(d)||(o.add(d),s.push(u))})}catch{}if(!s.length)try{const i=await _t(`/project-templates/?project_id=${encodeURIComponent(t.id)}`);c(i).forEach(a=>{const u=String(a?.id??"");!u||o.has(u)||(o.add(u),s.push(a))})}catch{}return s}async function Ht(){const t=document.getElementById("templates-saved");if(!t)return;const e=t.value||"",n=Array.from(t.options).slice(1).map(s=>({id:s.value,title:s.textContent})),r=await Oe(),o=Array.isArray(r)&&r.length?r:n;t.innerHTML='<option value="">— محفوظات —</option>'+(o||[]).map(s=>`<option value="${String(s.id)}">${s.title||`#${s.id}`}</option>`).join(""),e&&Array.from(t.options).some(s=>s.value===String(e))&&(t.value=String(e))}async function an(t){if(!t)return;const e=document.getElementById("templates-preview-host");if(!e)return;try{e.style.visibility="hidden"}catch{}let n=null;try{n=await _t(`/project-templates/?id=${encodeURIComponent(t)}`)}catch(s){Kt(s,"تعذر تحميل القالب");return}const r=n&&typeof n=="object"&&"data"in n?n.data:n,o=Array.isArray(r)?r[0]:r;if(!o){try{e.style.visibility=""}catch{}return}e.innerHTML="";try{const s=typeof o.data=="string"?JSON.parse(o.data):o.data;if(s?.html){const c=document.createElement("div");c.innerHTML=s.html;const i=c.firstElementChild;i&&e.appendChild(i);try{Qr(i)}catch{}try{fn(),yn(),De()}catch{}try{re(i)}catch{}try{Kr()}catch{}try{Zt()}catch{}try{Zr({onAfterChange:()=>{try{Mt(),Bt(),Nt()}catch{}}})}catch{}}}catch{}try{e.style.visibility=""}catch{}}function ps(){const t=document.getElementById("templates-project"),e=document.getElementById("templates-reservation"),n=document.getElementById("templates-type"),r=document.getElementById("templates-refresh"),o=document.getElementById("templates-print"),s=document.getElementById("templates-save"),c=document.getElementById("templates-save-copy"),i=document.getElementById("templates-saved"),a=document.getElementById("templates-from-res"),u=document.getElementById("templates-rename"),d=document.getElementById("templates-delete"),l=document.getElementById("templates-export"),p=document.getElementById("templates-export-excel"),m=document.getElementById("templates-import"),h=document.getElementById("templates-import-file");try{console.debug("[templatesTab] init start")}catch{}if(!t)return;try{Po({getSnapshot:oa,applySnapshot:os,onAutosaveDebounced:Bt,onMarkEditing:Nt})}catch{}Ko(n),hr(),rn(t.value||""),ft(),(async()=>{try{await Ht()}catch{}})(),t.addEventListener("change",()=>{rn(t.value||""),ft(),(async()=>{try{await Ht()}catch{}})()}),e?.addEventListener("change",ft),n?.addEventListener("change",()=>{try{Go(n.value)}catch{}ft();try{window.__pdfTunerLoadValues&&window.__pdfTunerLoadValues()}catch{}}),r?.addEventListener("click",ft),o&&o.addEventListener("click",async g=>{try{g.preventDefault(),g.stopPropagation()}catch{}try{try{const x=document.getElementById("templates-actions-menu");x&&(x.style.display="none")}catch{}const C=o.textContent;o.disabled=!0,o.textContent="… جاري الطباعة",await kn();try{It("تم إنشاء ملف PDF","success",3500)}catch{}o.textContent=C,o.disabled=!1}catch(C){console.error("❌ [templatesTab] print failed",C);try{It("تعذر إنشاء PDF، حاول مجددًا","error",6e3)}catch{alert("تعذر إنشاء PDF، حاول مجددًا")}try{o.disabled=!1}catch{}}});const f=document.getElementById("templates-actions-toggle"),y=document.getElementById("templates-actions-menu"),E=document.getElementById("templates-actions-dd");if(f&&y){try{if(!document.getElementById("templates-print-preview")){const C=document.createElement("button");C.type="button",C.className="btn btn-outline",C.id="templates-print-preview",C.textContent="👁️ معاينة الطباعة",C.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",C.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation();try{is()}catch{}}),y.insertBefore(C,y.firstChild)}}catch{}try{if(!document.getElementById("templates-new")){const C=document.createElement("button");C.type="button",C.className="btn btn-outline",C.id="templates-new",C.textContent="🆕 قالب جديد (فارغ)",C.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",C.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation();try{const w=me();localStorage.removeItem(w);const T=`remoteAutosaveId:${w}`;localStorage.removeItem(T)}catch{}try{It("تم إنشاء قالب فارغ","success",2e3)}catch{}try{ft()}catch{}}),y.insertBefore(C,y.firstChild)}}catch{}try{if(!document.getElementById("templates-load-last")){const C=document.createElement("button");C.type="button",C.className="btn btn-outline",C.id="templates-load-last",C.textContent="📥 تحميل آخر مسودة",C.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",C.addEventListener("click",async x=>{x.preventDefault(),x.stopPropagation();try{const w=sa();if(w)await an(w);else{const T=await Oe(),I=(T||[]).find(L=>{const A=String(L?.title||"").toLowerCase();return A.includes("autosave")||A.includes("draft")||A.includes("مسودة")})||(T||[])[0];I&&I.id&&await an(I.id)}try{It("تم تحميل المسودة","success",2e3)}catch{}}catch{try{It("تعذر تحميل المسودة","error",2500)}catch{}}}),y.insertBefore(C,y.firstChild)}}catch{}try{if(!document.getElementById("templates-fetch-crew")){const C=document.createElement("div");C.style.cssText="height:1px;background:#e5e7eb;margin:6px 0",y.appendChild(C);const x=document.createElement("button");x.type="button",x.className="btn btn-outline",x.id="templates-fetch-crew",x.textContent="👥 جلب الطاقم (إكمال الفراغات)",x.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;";const w=document.createElement("button");w.type="button",w.className="btn btn-outline",w.id="templates-fetch-crew-force",w.textContent="👥 جلب الطاقم (إعادة تعبئة)",w.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",x.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();try{pr(!1)}catch{}}),w.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();try{pr(!0)}catch{}}),y.appendChild(x),y.appendChild(w)}}catch{}const g=C=>{if(!E?.contains(C.target)){y.style.display="none";try{E.classList.remove("dropdown-open");const x=E.closest(".reports-surface-card");x&&x.classList.remove("--raise-on-top"),x&&(x.style.zIndex="")}catch{}document.removeEventListener("click",g,!0)}};f.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation();const x=y.style.display==="block";if(y.style.display=x?"none":"block",x)try{E.classList.remove("dropdown-open");const w=E.closest(".reports-surface-card");w&&w.classList.remove("--raise-on-top"),w&&(w.style.zIndex="")}catch{}else{try{E.classList.add("dropdown-open");const w=E.closest(".reports-surface-card");w&&(w.classList.add("--raise-on-top"),w.style.zIndex="12")}catch{}document.addEventListener("click",g,!0)}})}const P=document.getElementById("templates-lang-toggle");if(P){const g=()=>{P.textContent=Dt==="ar"?"🌐 AR":"🌐 EN",P.title=`Language: ${Dt.toUpperCase()}`};g(),P.addEventListener("click",()=>{or(Dt==="ar"?"en":"ar"),g(),ft()})}if(document.addEventListener("keydown",g=>{g.altKey&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&(g.code==="KeyL"||g.key.toLowerCase()==="l")&&(g.preventDefault(),or(Dt==="ar"?"en":"ar"),P&&(P.textContent=Dt==="ar"?"🌐 AR":"🌐 EN",P.title=`Language: ${Dt.toUpperCase()}`),ft())},!0),s?.addEventListener("click",()=>{gr({copy:!1}).then(Ht).catch(g=>{const C=g&&(g.message||g?.payload?.error||g?.payload?.details)||"تعذر الحفظ";alert(C);try{console.error("[templates/save] error",g)}catch{}})}),c?.addEventListener("click",()=>{gr({copy:!0}).then(Ht).catch(g=>{const C=g&&(g.message||g?.payload?.error||g?.payload?.details)||"تعذر الحفظ";alert(C);try{console.error("[templates/saveCopy] error",g)}catch{}})}),i?.addEventListener("change",()=>{i.value&&an(i.value).catch(()=>{})}),a?.addEventListener("click",()=>{n&&(n.value="callsheet"),e&&e.options.length>1&&(e.selectedIndex=1),ft()}),u?.addEventListener("click",async()=>{const g=i?.value||"";if(!g){alert("اختر محفوظاً أولاً");return}const C=i.options[i.selectedIndex]?.textContent||"",x=prompt("اسم جديد للمحفوظ:",C);if(!(!x||x.trim()===C))try{try{await _t(`/project-templates/?id=${encodeURIComponent(g)}`,{method:"PATCH",body:{title:String(x).trim()}})}catch(T){Kt(T,"تعذر إعادة التسمية");return}await Ht(),Array.from(i.options).find(T=>T.value===String(g))&&(i.value=String(g))}catch{alert("تعذر إعادة التسمية")}}),d?.addEventListener("click",async()=>{const g=i?.value||"";if(!g){alert("اختر محفوظاً أولاً");return}if(confirm("هل تريد حذف هذا المحفوظ نهائياً؟"))try{try{await _t(`/project-templates/?id=${encodeURIComponent(g)}`,{method:"DELETE"})}catch(x){Kt(x,"تعذر حذف القالب");return}await Ht(),ft()}catch{alert("تعذر الحذف")}}),l?.addEventListener("click",async()=>{const g=i?.value||"";if(!g){alert("اختر محفوظاً أولاً");return}try{let C=null;try{C=await _t(`/project-templates/?id=${encodeURIComponent(g)}`)}catch(q){Kt(q,"تعذر تحميل القالب");return}const x=C&&typeof C=="object"&&"data"in C?C.data:C,w=Array.isArray(x)?x[0]:x;if(!w){alert("تعذر جلب المحفوظ");return}const T=typeof w.data=="string"?JSON.parse(w.data):w.data,I=new Blob([JSON.stringify({meta:{id:w.id,title:w.title,type:w.type,project_id:w.project_id},data:T},null,2)],{type:"application/json"}),L=URL.createObjectURL(I),A=document.createElement("a");A.href=L;const k=(w.title||`template-${g}`).replace(/[^\w\-\s]/g,"").trim()||`template-${g}`;A.download=`${k}.json`,document.body.appendChild(A),A.click(),A.remove(),URL.revokeObjectURL(L)}catch{alert("تعذر التصدير")}}),p?.addEventListener("click",async g=>{g?.preventDefault?.(),g?.stopPropagation?.();try{if((document.getElementById("templates-type")?.value||"expenses")!=="callsheet"){alert("التصدير إلى Excel متاح في الكول شيت فقط");return}const x=document.querySelector("#templates-preview-host #templates-a4-root");if(!x){alert("لا توجد معاينة للكول شيت");return}await _n(),await fo(x)}catch(C){console.error("[templates/export-excel] failed",C),alert("تعذر التصدير إلى Excel")}}),m?.addEventListener("click",()=>{h?.click()}),h?.addEventListener("change",async g=>{const C=g.target?.files?.[0];if(C)try{const x=await C.text(),w=JSON.parse(x),T=qt();if(!T){alert("اختر مشروعاً أولاً");return}const I=document.getElementById("templates-type"),L=I?I.value:w?.meta?.type||"expenses",A=document.getElementById("templates-reservation"),k=A?.value?Number(A.value):null,q=w?.data?.html?w.data:{html:document.querySelector("#templates-preview-host")?.innerHTML||""};try{await _t("/project-templates/",{method:"POST",body:{project_id:Number(T.id),reservation_id:k,type:L,title:w?.meta?.title||`Imported - ${L}`,data:q}})}catch(B){Kt(B,"تعذر الاستيراد");return}await Ht(),alert("تم الاستيراد بنجاح")}catch{alert("تعذر الاستيراد، تأكد من صحة ملف JSON")}finally{g.target.value=""}}),!pn){let b=function(_=k){if(L||$e){A=!0;return}zt&&(clearTimeout(zt),zt=null),zt=setTimeout(()=>{zt=null,B()},Math.max(0,_))};pn=!0,Pt=document.getElementById("templates-preview-host");try{Re=qo(Pt,{onRenumber:()=>{try{hn()}catch{}},onTotalsChange:()=>{try{jn()}catch{}},onAfterChange:()=>{try{Mt(),Bt(),Nt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:xt.logoUrl,isLandscape:!0}),Zt()},30)}catch{}}})}catch{}const g=_=>{const M=_&&_.target;if(M instanceof HTMLElement&&M.isContentEditable&&!Qe){try{Nt()}catch{}try{const O=M.closest("td"),$=O&&O.closest("tr"),G=$&&$.closest("table.exp-details");if($&&G&&$.getAttribute("data-row")==="item"){const F=Array.from($.children),H=(Et,jt=0)=>{try{const Xt=String(Et||"").replace(/[\u0660-\u0669]/g,Ft=>"0123456789"[Ft.charCodeAt(0)-1632]).replace(/[\u06F0-\u06F9]/g,Ft=>"0123456789"[Ft.charCodeAt(0)-1776]).replace(/[\u066B]/g,".").replace(/[\u066C]/g,"").replace(/[^\d.\-]/g,""),te=Number(Xt);return Number.isFinite(te)?te:jt}catch{return jt}},at=H(F[2]?.textContent,0),rt=H(F[3]?.textContent,1),Q=H(F[4]?.textContent,1),gt=Math.round(at*rt*Q),Tt=F[6];if(Tt){Tt.textContent=String(gt);try{Tt.setAttribute("data-num","1")}catch{}}}}catch{}try{clearTimeout(Qn)}catch{}Qn=setTimeout(()=>{tn(420)},180);try{clearTimeout(tr)}catch{}tr=setTimeout(()=>{try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}},80)}};Y.hostInput=g,Pt?.addEventListener("input",g);const C=_=>{Qe=!0},x=_=>{Qe=!1;try{g(_)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}};Y.hostCompStart=C,Y.hostCompEnd=x,Pt?.addEventListener("compositionstart",C,!0),Pt?.addEventListener("compositionend",x,!0);const w=_=>{const M=_.target;if(!(M instanceof HTMLElement))return;const O=M.closest&&M.closest("td");if(O)try{O.classList.add("editing")}catch{}},T=_=>{const M=_.target;if(!(M instanceof HTMLElement))return;const O=M.closest&&M.closest("td");if(O)try{O.classList.remove("editing")}catch{}try{O&&O.closest&&O.closest("table.exp-details")&&tn(120)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}};Pt?.addEventListener("focusin",w,!0),Pt?.addEventListener("focusout",T,!0),Y.hostFocusIn=w,Y.hostFocusOut=T;try{Me=Oo(Pt,{onAfterChange:()=>{try{Mt(),Bt(),Nt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:xt.logoUrl,isLandscape:!0}),Zt()},30)}catch{}},onTotalsChange:()=>tn()})}catch{}const I=_=>{const M=_.target&&_.target.closest&&_.target.closest('[contenteditable="true"]');if(M){try{setTimeout(()=>{M&&M.focus&&M.focus()},0)}catch{}return}const O=_.target&&_.target.closest&&_.target.closest("td");if(O){const $=O.querySelector('[contenteditable="true"]');if($)try{setTimeout(()=>{$&&$.focus&&$.focus()},0)}catch{}}};Pt?.addEventListener("mousedown",I,!0),Y.hostMouseDown=I;try{ia()}catch{}let L=!1,A=!1;const k=420;let q="";const B=async()=>{if(L||$e){A=!0;return}L=!0;try{isTemplatesDebugEnabled()&&console.debug("[templatesTab] repopulate start")}catch{}const _=t?.value||"";try{ie()?.length||await Ae(),Cn()?.length||await Br()}catch(G){try{isTemplatesDebugEnabled()&&console.warn("[templatesTab] fetch fallback failed",G)}catch{}}hr(),!t.value&&t.options.length>1?t.selectedIndex=1:_&&(t.value=_),rn(t.value||"");const M=document.getElementById("templates-type"),O=M?M.value:"expenses",$=`${t.value||""}|${document.getElementById("templates-reservation")?.value||""}|${O}`;$!==q&&(q=$,ft());try{await Ht()}catch{}try{isTemplatesDebugEnabled()&&console.debug("[templatesTab] repopulate done")}catch{}L=!1,A&&(A=!1,b())},R=()=>b(),D=()=>b(),N=()=>b();Y.projChanged=R,Y.resChanged=D,Y.resUpdated=N,document.addEventListener("projects:changed",R),document.addEventListener("reservations:changed",D),document.addEventListener("reservations:updated",N);const j=document.querySelector('[data-project-subtab-target="projects-templates-tab"]'),X=()=>b(0);Y.tabClick=X,j?.addEventListener("click",X),b(0)}try{Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")).forEach(g=>{(g.getAttribute("data-project-subtab-target")||"")!=="projects-templates-tab"&&g.dataset.tplDestroyBound!=="1"&&(g.addEventListener("click",()=>{try{er()}catch{}}),g.dataset.tplDestroyBound="1")}),Array.from(document.querySelectorAll(".tab-button[data-tab-target]")).forEach(g=>{(g.getAttribute("data-tab-target")||"")!=="projects-section"&&g.dataset.tplDestroyMainBound!=="1"&&(g.addEventListener("click",()=>{try{er()}catch{}}),g.dataset.tplDestroyMainBound="1")})}catch{}try{Zo()}catch{}}function ms(){document.addEventListener("DOMContentLoaded",()=>{co(),po(),Na(),Lr(),Ba(),ro(),ao(),ps(),Ma(),Ra(),ka(),Da(),qa(),ja(),Fa({onViewDetails:Be}),$a({onOpenProject:Be}),Oa(),hs()}),document.addEventListener("language:changed",br),document.addEventListener("language:translationsReady",br),document.addEventListener("customers:changed",fs),document.addEventListener("technicians:updated",ys),document.addEventListener("reservations:changed",()=>Ha(Be)),document.addEventListener(Sa.USER_UPDATED,()=>{de(),ue()});try{document.addEventListener("projects:changed",()=>{Pr(),vn(),de(),_e(),ue()},{passive:!0})}catch{}}async function hs(){try{await Ir({suppressError:!0}),await Ae();try{await za()}catch{}}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||U("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");It(e,"error")}finally{Pr(),ze(),Ua(),vn(),de(),_e(),ue(),mo();try{const t=!!qe(),e=!!kr(),n=document.querySelector('.sub-tab-button[data-project-subtab-target="projects-list-tab"]');!t&&!e&&Array.isArray(lt.projects)&&lt.projects.length>0&&n&&(await Ue("projects-list-tab",n),Sn("projects-list-tab"))}catch{}}}function br(){ze(),vn(),de(),_e(),ue(),Lr()}function fs(){Wa(),ze()}function ys(){Va(),ze()}Aa();_a();Ta();Ga();ms();document.addEventListener("DOMContentLoaded",()=>{Ka(),La()});let ce=.15;const Ne={},gs="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let be=0;const W={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",confirmed:"all",range:"all",startDate:"",endDate:""}},S={search:null,payment:null,confirmed:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,exportExcelBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableHead:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},ne=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `,margin:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3a9 9 0 1 0 9 9"></path>
      <path d="M12 7v5l3 3"></path>
      <path d="M16 3l5 5"></path>
    </svg>
  `});let Ct=null;const da=["upcoming","ongoing","completed"],At={key:"value",dir:"desc"};let on=!1,wr=0;const bs=1500;async function ws({forceProjects:t=!1}={}){try{await Ir({suppressError:!0}),await Za({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),Nr(e)&&console.warn("Projects API error:",e.message)}He()}async function vs(){Cs(),pa(),Ss();try{le()}catch{}try{const t=document?.documentElement?.getAttribute("dir")||"rtl",e=document.querySelector(".reports-wrapper--projects");e&&e.setAttribute("dir",t)}catch{}await xs();try{const t=new URLSearchParams(window.location.search||"");W.__debug=t.get("reportsDebug")==="1"||t.get("debugReports")==="1"}catch{W.__debug=!1}try{if(await ws({forceProjects:!0}),!Array.isArray(ie())||ie().length===0){try{await Ae()}catch{}He()}S.search&&(S.search.value=""),W.filters.search="",ba(),Ts(),Us(),$s(),it()}finally{ma()}document.addEventListener("language:changed",Ps,{passive:!0}),document.addEventListener("projects:changed",()=>{bn().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})},{passive:!0}),document.addEventListener("reservations:changed",()=>{bn().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})},{passive:!0}),window.addEventListener("storage",Is)}document.addEventListener("DOMContentLoaded",vs);async function xs(){if(Ct)return Ct;if(typeof window>"u")return null;if(window.ApexCharts)return Ct=window.ApexCharts,Ct;try{await Es(gs),Ct=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),Ct=null}return Ct}function Es(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const r=document.querySelector(`script[src="${t}"]`);if(r){if(r.dataset.loaded==="true"){e();return}r.addEventListener("load",e,{once:!0}),r.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const o=document.createElement("script");o.src=t,o.async=!0,o.dataset.loaded="false",o.onload=()=>{o.dataset.loaded="true",e()},o.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(o)})}function Cs(){S.search=document.getElementById("reports-search"),S.statusChips=document.getElementById("reports-status-chips"),S.payment=document.getElementById("reports-payment"),S.confirmed=document.getElementById("reports-confirmed"),S.dateRange=document.getElementById("reports-date-range"),S.customRangeWrapper=document.getElementById("reports-custom-range"),S.startDate=document.getElementById("reports-start-date"),S.endDate=document.getElementById("reports-end-date"),S.refreshBtn=document.getElementById("reports-refresh"),S.exportExcelBtn=document.getElementById("projects-export-excel"),S.kpiGrid=document.getElementById("reports-kpi-grid"),S.table=document.getElementById("reports-table"),S.tableBody=S.table?.querySelector("tbody"),S.tableHead=S.table?.querySelector("thead"),S.tableMeta=document.getElementById("reports-table-meta"),S.tableEmpty=document.getElementById("reports-empty"),S.chartCards={},S.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;S.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(S.chartLoaders[e]=n)})}function ua(t){const e=!!t;Object.entries(S.chartCards||{}).forEach(([n,r])=>{if(!r)return;r.classList.toggle("is-loading",e),r.setAttribute("aria-busy",e?"true":"false");const o=S.chartLoaders?.[n];o&&(o.hidden=!e)})}function pa(){be+=1,be===1&&ua(!0)}function ma(){be=Math.max(0,be-1),be===0&&ua(!1)}function He(){const{customers:t=[]}=Pa();W.customers=Array.isArray(t)?t:[],W.reservations=Cn();const e=new Map(W.customers.map(r=>[String(r.id),r])),n=ie();W.projects=Array.isArray(n)?n.map(r=>As(r,e)):[],W.totalProjects=W.projects.length}function gn(t){const e=We(t.id);let n=0,r=0,o=0;e.forEach(l=>{const p=to(l),m=Number(p.finalTotal||0),h=Number(p.taxAmount||0);n+=m,r+=h,o+=m-h});const s=Number(t?.raw?.equipmentEstimate??t?.equipmentEstimate??0)||0,c=Number(t?.raw?.servicesClientPrice??t?.servicesClientPrice??0)||0,i=Number(t?.expensesTotal??0)||0,a=o+s+c,u=o+(c-i),d=a>0?u/a*100:0;return{resFinal:n,resTax:r,resNetRevenue:o,equipmentEstimate:s,servicesRevenue:c,projectExpenses:i,netProfit:u,marginPercent:d}}function Ss(){try{const t=typeof window<"u"?window:globalThis,e=[t.APP_VAT_RATE,t.APP_TAX_RATE,t.__APP_SETTINGS__?.vatRate];for(const n of e){const r=Number(n);if(Number.isFinite(r)&&r>0&&r<=1){ce=r;return}if(Number.isFinite(r)&&r>1&&r<=100){ce=r/100;return}}}catch{}try{_t("/preferences/").then(t=>{const e=t?.data??t??{},n=e.vatRate??e.taxRate??null,r=Number(n);Number.isFinite(r)&&r>0&&(ce=r>1?r/100:r,it())}).catch(()=>{})}catch{}}function As(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",r=e.get(String(t.clientId)),o=We(t.id),s=o.reduce((L,A)=>{const k=Array.isArray(A.items)?A.items:[],q=Array.isArray(A.crewAssignments)?A.crewAssignments:[],B=q.length?q:Array.isArray(A.technicians)?A.technicians:[],b=Array.isArray(B)&&B.length&&typeof B[0]=="object",R=Array.isArray(B)&&B.length&&typeof B[0]!="object",D=ve({items:k,technicianIds:R?B:[],crewAssignments:b?B:[],discount:A.discount??0,discountType:A.discountType||"percent",applyTax:!1,start:A.start,end:A.end});return L.equipment+=Number(D.equipmentTotal||0),L.crew+=Number(D.crewTotal||0),L.crewCost+=Number(D.crewCostTotal||0),L},{equipment:0,crew:0,crewCost:0}),c=Ve(t),i=Number(t?.discount??0)||0,a=t?.discountType==="amount"?"amount":"percent",u=t?.applyTax===!0||t?.applyTax==="true",d=s.equipment+s.crew+c;let l=a==="amount"?i:d*(i/100);(!Number.isFinite(l)||l<0)&&(l=0),l>d&&(l=d);const p=Math.max(0,d-l),m=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true",h=Number(t?.companySharePercent)||0,f=u||m&&h>0,y=m&&f?h:0,E=y>0?Number((p*(y/100)).toFixed(2)):0,P=f?Number(((p+E)*ce).toFixed(2)):0,g=Number((p+E+P).toFixed(2)),C=_s(t),x=(()=>{try{if(t?.cancelled===!0)return!0;const L=String(t?.status||t?.raw?.status||"").toLowerCase();return L==="cancelled"||L==="canceled"||L==="ملغي"||L==="ملغى"}catch{return!1}})(),w=x?"cancelled":C,T=t.start?new Date(t.start):null,I=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:r?.customerName||r?.name||"",clientCompany:t.clientCompany||r?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:T,end:I,applyTax:f,companyShareEnabled:m,companySharePercent:y,status:w,cancelled:x,reservationsTotal:Number((s.equipment+s.crew).toFixed(2)),expensesTotal:Se(t),servicesClientPrice:c,taxAmount:P,combinedTaxAmount:P,overallTotal:g,unpaidValue:n==="paid"?0:g,reservationsCount:o.length}}function We(t){return Array.isArray(W.reservations)?W.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Se(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function Ve(t){const e=Number(t?.servicesClientPrice??t?.services_client_price??t?.raw?.servicesClientPrice??t?.raw?.services_client_price??0)||0;if(e>0)return e;const n=Array.isArray(t?.expenses)?t.expenses:Array.isArray(t?.raw?.expenses)?t.raw.expenses:[];if(!n.length)return 0;const r=o=>{if(typeof o=="number")return Number.isFinite(o)?o:0;if(o==null||o==="")return 0;const s=Qt(String(o)).replace(/[^\d.+-]/g,""),c=Number.parseFloat(s);return Number.isFinite(c)?c:0};return n.reduce((o,s)=>o+r(s?.salePrice??s?.sale_price??0),0)}function _s(t){const e=new Date,n=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":r&&!Number.isNaN(r.getTime())&&r<e?"completed":"ongoing"}function Ts(){if(S.search){let t;S.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{W.filters.search=S.search.value.trim(),it()},180)})}S.payment&&(S.payment.value=W.filters.payment,S.payment.addEventListener("change",()=>{W.filters.payment=S.payment.value||"all",it()})),S.confirmed&&(S.confirmed.value=W.filters.confirmed||"all",S.confirmed.addEventListener("change",()=>{W.filters.confirmed=S.confirmed.value||"all",it()})),S.dateRange&&(S.dateRange.addEventListener("change",Ls),S.dateRange.value=W.filters.range,S.dateRange.value==="custom"&&le()),S.startDate&&S.startDate.addEventListener("change",()=>{W.filters.startDate=S.startDate.value,W.filters.range==="custom"&&it()}),S.endDate&&S.endDate.addEventListener("change",()=>{W.filters.endDate=S.endDate.value,W.filters.range==="custom"&&it()}),S.refreshBtn&&S.refreshBtn.addEventListener("click",()=>{if(W.filters.range!=="custom"){it();return}W.filters.startDate=S.startDate?.value||"",W.filters.endDate=S.endDate?.value||"",it()})}function Ls(t){const e=t.target.value;W.filters.range=e,e==="custom"?(S.customRangeWrapper?.classList.add("active"),le()):(S.customRangeWrapper?.classList.remove("active"),W.filters.startDate="",W.filters.endDate="",S.startDate&&(S.startDate.value=""),S.endDate&&(S.endDate.value=""),it())}function le(){try{if(!window.flatpickr){try{const r=document.querySelector('script[data-flatpickr-loader="true"]')||document.querySelector('script[src*="flatpickr"]');if(r)r.dataset.boundRetry||(r.addEventListener("load",()=>{try{le()}catch{}},{once:!0}),r.dataset.boundRetry="true");else{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/flatpickr",o.async=!0,o.dataset.flatpickrLoader="true",o.onload=()=>{try{le()}catch{}},document.head.appendChild(o)}}catch{}setTimeout(()=>{try{le()}catch{}},150);return}const t=(()=>{try{if((yt()||"ar").toLowerCase().startsWith("ar")&&window.flatpickr?.l10ns?.ar)return"ar"}catch{}return window.flatpickr?.l10ns?.default,void 0})(),e=r=>({dateFormat:"Y-m-d",allowInput:!0,clickOpens:!0,disableMobile:!0,appendTo:document.body,...t?{locale:t}:{},...r});if(S.startDate&&!S.startDate._flatpickr){try{S.startDate.removeAttribute("readonly"),S.startDate.setAttribute("tabindex","0"),S.startDate.style.cursor="pointer",S.startDate.setAttribute("aria-haspopup","dialog")}catch{}window.flatpickr(S.startDate,e({onChange:(r,o)=>{W.filters.startDate=o||"",S.endDate?._flatpickr&&r?.length&&S.endDate._flatpickr.set("minDate",r[0]),W.filters.range==="custom"&&it()},onValueUpdate:(r,o)=>{W.filters.startDate=o||"",W.filters.range==="custom"&&it()}})),S.startDate.addEventListener("click",()=>S.startDate?._flatpickr?.open()),S.startDate.addEventListener("focus",()=>S.startDate?._flatpickr?.open())}if(S.endDate&&!S.endDate._flatpickr){try{S.endDate.removeAttribute("readonly"),S.endDate.setAttribute("tabindex","0"),S.endDate.style.cursor="pointer",S.endDate.setAttribute("aria-haspopup","dialog")}catch{}window.flatpickr(S.endDate,e({onChange:(r,o)=>{W.filters.endDate=o||"",S.startDate?._flatpickr&&r?.length&&S.startDate._flatpickr.set("maxDate",r[0]),W.filters.range==="custom"&&it()},onValueUpdate:(r,o)=>{W.filters.endDate=o||"",W.filters.range==="custom"&&it()}})),S.endDate.addEventListener("click",()=>S.endDate?._flatpickr?.open()),S.endDate.addEventListener("focus",()=>S.endDate?._flatpickr?.open())}const n=S.customRangeWrapper;n&&!n.dataset.openBound&&(n.addEventListener("click",r=>{const o=r.target;if(o===S.startDate){S.startDate?._flatpickr?.open();return}if(o===S.endDate){S.endDate?._flatpickr?.open();return}S.startDate?._flatpickr?.open()}),n.dataset.openBound="true")}catch{}}async function bn(){const t=Date.now();if(!on){if(t-wr<bs){He(),it();return}on=!0,pa();try{await Promise.all([Ae(),Br()])}catch(e){console.error("❌ [projectsReports] Data mutation refresh failed",e),Nr(e)&&console.warn("Projects API error:",e.message)}finally{wr=Date.now(),on=!1,He(),it(),ma()}}}function Ps(){try{const t=document?.documentElement?.getAttribute("dir")||"rtl",e=document.querySelector(".reports-wrapper--projects");e&&e.setAttribute("dir",t)}catch{}ba(),it()}function Is(t){t.key&&!["projects","reservations","customers"].includes(t.key)||bn().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function it(){const t=ha();Fn(),Ms(t),Ds(t),qs(t),js(t),Fs(t),zs(t),Vs()}function ha(){const{search:t,statuses:e,payment:n,range:r,startDate:o,endDate:s,confirmed:c}=W.filters,i=ya(t),a=new Date,u=Number(r);let d=null;if(r==="custom"){d=o?new Date(o):null;const l=s?new Date(s):null;return W.projects.filter(p=>p?.cancelled===!0||String(p?.status).toLowerCase()==="cancelled"||String(p?.status).toLowerCase()==="canceled"||!vr(p,e)||!xr(p,n)||!Cr(p,i)||!Er(p,c)?!1:Bs(p.start,d,l))}return r!=="all"&&Number.isFinite(u)&&(d=new Date,d.setDate(a.getDate()-u)),W.projects.filter(l=>l?.cancelled===!0||String(l?.status).toLowerCase()==="cancelled"||String(l?.status).toLowerCase()==="canceled"||!vr(l,e)||!xr(l,n)||!Cr(l,i)||!Er(l,c)?!1:r==="all"?!0:Ns(l.start,d,a))}function vr(t,e){return e.includes(t.status)}function xr(t,e){return e==="all"?!0:fa(t)===e}function Er(t,e){if(!e||e==="all")return!0;const n=t?.confirmed===!0;return e==="yes"?n:e==="no"?!n:!0}function Cr(t,e){return e?ya([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function fa(t){try{const e=t?.raw||t||{},n=Number(t?.overallTotal||0)||0;let r=0;const o=a=>{const u=Number(a);Number.isFinite(u)&&u>0&&(r+=u)},s=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payments)?e.payments:[];if(Array.isArray(s)&&s.length)s.forEach(a=>{const u=(a?.type||"").toString().toLowerCase(),d=Number(a?.value??a?.amount??a?.percentage??0)||0;o(u==="percent"||u==="percentage"?d/100*n:d)});else{o(e?.paidAmount??e?.paid_amount);const a=Number(e?.paidPercent??e?.paid_percentage);a>0&&o(a/100*n)}const c=.01;return n<=0?r>0?"partial":"unpaid":Math.max(0,n-r)<=c?"paid":r>0?"partial":"unpaid"}catch{return"unpaid"}}function Ns(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function Bs(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&r<e.getTime()||n&&!Number.isNaN(n.getTime())&&r>n.getTime())}function ya(t){return t?Qt(String(t)).toLowerCase().trim():""}function Ms(t){if(!S.kpiGrid)return;const e=t.length,n=ga(t),r=n.grossRevenue,o=n.outstandingTotal||0,s=n.projectExpensesTotal||0,c=n.netProfit||0,i=[{key:"projects",icon:ne.projects,label:U("projects.reports.kpi.totalProjects",yt()==="ar"?"إجمالي المشاريع":"Total projects"),value:wn(e),meta:U("projects.reports.kpi.totalProjectsMeta",yt()==="ar"?"بعد تطبيق الفلاتر الحالية":"After applying the current filters")},{key:"totalValue",icon:ne.value,label:U("projects.reports.kpi.totalValue",yt()==="ar"?"الإيراد الكلي":"Total value"),value:bt(r),meta:U("projects.reports.kpi.totalValueMeta",yt()==="ar"?"يشمل المشاريع والحجوزات والضريبة":"Includes projects, linked reservations, and VAT")},{key:"outstanding",icon:ne.outstanding,label:U("projects.reports.kpi.unpaidValue",yt()==="ar"?"قيمة غير مدفوعة":"Outstanding value"),value:bt(o),meta:U("projects.reports.kpi.unpaidValueMeta",yt()==="ar"?"مشاريع لم تُسدّد بالكامل":"Projects not fully paid yet")},{key:"expenses",icon:ne.expenses,label:U("projects.reports.kpi.expenses","تكلفة الخدمات الإنتاجية"),value:bt(s),meta:U("projects.reports.kpi.expensesMeta","تكلفة الخدمات الإنتاجية للمشاريع المحددة")},{key:"margin",icon:ne.margin,label:U("projects.reports.kpi.margin","هامش الربح"),value:va(n.profitMarginPercent),meta:U("projects.reports.kpi.marginMeta","صافي الربح ÷ الإيراد بدون الضريبة")},{key:"netProfit",icon:ne.value,label:U("reservations.reports.kpi.revenue.details.net","صافي الربح"),value:bt(c),meta:U("projects.reports.kpi.netProfitMeta","مجموع صافي الربح للمشاريع المحددة")}];S.kpiGrid.innerHTML=i.map(({key:a,icon:u,label:d,value:l,meta:p})=>`
    <div class="reports-kpi-card glass-card" data-kpi="${a}">
      <div class="reports-kpi-icon">${u}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${wt(d)}</p>
        <p class="reports-kpi-value">${wt(l)}</p>
        <span class="reports-kpi-meta">${wt(p)}</span>
      </div>
    </div>
  `).join(""),Rs(t)}function Rs(t){try{const e=ga(t),n="projects-revenue-breakdown";let r=document.getElementById(n);const o=(e.servicesRevenueTotal||0)-(e.projectExpensesTotal||0),s=[{key:"gross",label:U("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:bt(e.grossRevenue)},{key:"discount",label:U("projects.details.summary.discount","الخصم","Discount"),value:`−${bt(e.discountTotal||0)}`},{key:"share",label:U("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:bt(e.companyShareTotal)},{key:"tax",label:U("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:bt(e.taxTotal)},{key:"crewGross",label:U("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:bt(e.crewTotal)},{key:"crew",label:U("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:`−${bt(e.crewCostTotal)}`},{key:"equipment",label:U("reservations.reports.kpi.revenue.details.equipment","إجمالي المعدات","Equipment total"),value:bt(e.equipmentTotalCombined)},{key:"projectExpenses",label:U("projects.reports.kpi.revenue.details.projectExpenses","تكلفة الخدمات الإنتاجية","Project expenses"),value:`−${bt(e.projectExpensesTotal)}`},{key:"servicesProfit",label:U("projects.reports.kpi.revenue.details.servicesProfit",yt()==="ar"?"ربح الخدمات الإنتاجية":"Services profit"),value:`${bt(o)}`},{key:"net",label:U("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:bt(e.netProfit)}],c=`
      <div id="${n}" class="reports-kpi-details glass-card" style="margin-top: 12px;">
        ${s.map(({key:i,label:a,value:u})=>`
          <div class="reports-kpi-detail-row d-flex justify-content-between" data-row="${i}">
            <span class="reports-kpi-detail-label">${wt(a)}</span>
            <span class="reports-kpi-detail-value">${wt(u)}</span>
          </div>
        `).join("")}
      </div>
    `;r?r.outerHTML=c:S.kpiGrid.insertAdjacentHTML("afterend",c)}catch(e){console.warn("[projectsReports] Failed to render revenue breakdown",e)}}function ga(t){const e=new Set(t.map(g=>String(g.id))),n=W.reservations.filter(g=>g.projectId!=null&&e.has(String(g.projectId))),r=new Map;let o=0,s=0,c=0;n.forEach(g=>{const C=Array.isArray(g.items)?g.items:[],x=Array.isArray(g.crewAssignments)?g.crewAssignments:[],w=x.length?x:Array.isArray(g.technicians)?g.technicians:[],T=Array.isArray(w)&&w.length&&typeof w[0]=="object",I=Array.isArray(w)&&w.length&&typeof w[0]!="object",L=ve({items:C,technicianIds:I?w:[],crewAssignments:T?w:[],discount:g.discount??0,discountType:g.discountType||"percent",applyTax:!1,start:g.start,end:g.end});o+=Number(L.equipmentTotal||0),s+=Number(L.crewTotal||0),c+=Number(L.crewCostTotal||0);const A=r.get(String(g.projectId))||[];A.push(g),r.set(String(g.projectId),A)});let i=0,a=0,u=0,d=0,l=0,p=0,m=0,h=0;t.forEach(g=>{const x=(r.get(String(g.id))||[]).reduce((F,H)=>{const at=Array.isArray(H.items)?H.items:[],rt=Array.isArray(H.crewAssignments)?H.crewAssignments:[],Q=rt.length?rt:Array.isArray(H.technicians)?H.technicians:[],gt=Array.isArray(Q)&&Q.length&&typeof Q[0]=="object",Tt=Array.isArray(Q)&&Q.length&&typeof Q[0]!="object",Et=ve({items:at,technicianIds:Tt?Q:[],crewAssignments:gt?Q:[],discount:H.discount??0,discountType:H.discountType||"percent",applyTax:!1,start:H.start,end:H.end});return F.equipment+=Number(Et.equipmentTotal||0),F.crew+=Number(Et.crewTotal||0),F.crewCost+=Number(Et.crewCostTotal||0),F},{equipment:0,crew:0,crewCost:0}),w=Ve(g);l+=w,d+=Number(Se(g)||0);const T=x.equipment+x.crew+w,I=Number(g?.raw?.discount??g?.discount??0)||0;let A=((g?.raw?.discount_type??g?.discountType)==="amount"?"amount":"percent")==="amount"?I:T*(I/100);(!Number.isFinite(A)||A<0)&&(A=0),A>T&&(A=T);const k=Math.max(0,T-A);h+=Number(A||0);let q=(()=>{const F=g?.applyTax!==void 0?g.applyTax:g?.apply_tax??g?.raw?.apply_tax??g?.raw?.applyTax;return F===!0||F===1||F==="1"||typeof F=="string"&&F.toLowerCase()==="true"})();const B=(()=>{const F=g?.companyShareEnabled!==void 0?g.companyShareEnabled:g?.raw?.company_share_enabled??g?.raw?.companyShareEnabled;return F===!0||F===1||F==="1"||typeof F=="string"&&F.toLowerCase()==="true"})(),b=(()=>{const F=g?.raw?.company_share_percent??g?.raw?.companySharePercent??g?.companySharePercent??g?.company_share_percent??0,H=Number(F);return Number.isFinite(H)?H:0})();B&&b>0&&(q=!0);const R=B&&q?b:0,D=R>0?Number((k*(R/100)).toFixed(2)):0;u+=D;const N=q?Number(((k+D)*ce).toFixed(2)):0;a+=N;const j=k+D+N;i+=j;const X=Number(Se(g)||0),_=Number((k-X-(x.crewCost||0)).toFixed(2));m+=_;const M=g.raw||g;let O=0;const $=F=>{const H=Number(F);Number.isFinite(H)&&H>0&&(O+=H)};let G=!1;try{const F=Array.isArray(M.paymentHistory)?M.paymentHistory:Array.isArray(M.payments)?M.payments:[];Array.isArray(F)&&F.length&&(G=!0,F.forEach(H=>{const at=(H?.type||"").toString().toLowerCase(),rt=Number(H?.value??H?.amount??H?.percentage??0)||0;$(at==="percent"||at==="percentage"?rt/100*j:rt)}))}catch{}if(!G){$(M?.paidAmount??M?.paid_amount);const F=Number(M?.paidPercent??M?.paid_percentage);F>0&&$(F/100*j)}O>j&&(O=j),p+=Math.max(0,j-O)});const f=o,y=Math.max(0,i-a),E=m,P=y>0?E/y*100:0;return{grossRevenue:i,companyShareTotal:u,taxTotal:a,crewTotal:s,crewCostTotal:c,equipmentTotalCombined:f,projectExpensesTotal:d,servicesRevenueTotal:l,outstandingTotal:p,netProfit:E,revenueExTax:y,profitMarginPercent:P,discountTotal:h}}function ba(){if(!S.statusChips)return;const t=da.map(e=>{const n=U(`projects.status.${e}`,e);return`<span class="reports-status-chip timeline-status-badge timeline-status-badge--${e}" data-status="${e}">${wt(n)}</span>`}).join("");S.statusChips.innerHTML=t,S.statusChips.dataset.listenerAttached||(S.statusChips.addEventListener("click",ks),S.statusChips.dataset.listenerAttached="true"),Fn()}function ks(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const r=new Set(W.filters.statuses);r.has(n)?r.delete(n):r.add(n),r.size===0&&da.forEach(o=>r.add(o)),W.filters.statuses=Array.from(r),Fn(),it()}function Fn(){if(!S.statusChips)return;const t=new Set(W.filters.statuses);S.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Ds(t){if(!Ct)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],r=n.map(a=>t.filter(u=>u.status===a).length),o=n.map(a=>U(`projects.status.${a}`,a)),c=r.reduce((a,u)=>a+u,0)>0?r:[],i={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:o,series:c,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:a=>Number.isFinite(a)?`${Math.round(a)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:a=>Jt(a)}},noData:{text:U("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};Xe("status",e,i)}function qs(t){if(!Ct)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,r=new Intl.DateTimeFormat(Xs(),{month:"short",year:"numeric"});t.forEach(d=>{if(!d.start||Number.isNaN(d.start.getTime()))return;const l=`${d.start.getFullYear()}-${d.start.getMonth()+1}`,p=n.get(l)||{total:0,label:r.format(d.start)};p.total+=d.overallTotal,n.set(l,p)});const s=Array.from(n.keys()).sort((d,l)=>{const[p,m]=d.split("-").map(Number),[h,f]=l.split("-").map(Number);return p===h?m-f:p-h}).slice(-12),c=s.map(d=>n.get(d)?.label||d),i=s.map(d=>Math.round(n.get(d)?.total||0)),a=i.length?[{name:U("projects.reports.datasets.value","Total value"),data:i}]:[],u={chart:{type:"area",height:320,toolbar:{show:!1}},series:a,xaxis:{categories:c,labels:{rotate:-35}},yaxis:{labels:{formatter:d=>Jt(d)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:d=>Jt(d)}},noData:{text:U("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("timeline",e,u)}function js(t){if(!Ct)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((u,d)=>d.overallTotal-u.overallTotal).slice(0,6),r=n.map(u=>u.title||u.projectCode),o=n.map(u=>Math.round(u.overallTotal)),s=n.map(u=>Math.round(u.expensesTotal)),c=r.length?[{name:U("projects.reports.datasets.value","Total value"),data:o},{name:U("projects.reports.datasets.expenses","تكلفة الخدمات الإنتاجية"),data:s}]:[],a={chart:{type:"bar",height:Math.max(320,r.length*60||0),toolbar:{show:!1}},series:c,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:r,labels:{formatter:u=>Jt(u)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:u=>Jt(u)}},noData:{text:U("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("expenses",e,a)}function Fs(t){if(!Ct)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(a=>{const u=a.clientName||a.clientCompany||U("projects.fallback.unknownClient","Unknown client"),d=n.get(u)||0;n.set(u,d+a.overallTotal)});const r=Array.from(n.entries()).sort((a,u)=>u[1]-a[1]).slice(0,6),o=r.map(([a])=>a),s=r.map(([,a])=>Math.round(a)),c=s.length?[{name:U("projects.reports.datasets.value","Total value"),data:s}]:[],i={chart:{type:"bar",height:320,toolbar:{show:!1}},series:c,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:o,labels:{rotate:-35}},yaxis:{labels:{formatter:a=>Jt(a)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:a=>Jt(a)}},legend:{show:!1},noData:{text:U("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("clients",e,i)}function Xe(t,e,n={}){if(!Ct||!e)return;if(Ne[t]){try{Ne[t].destroy()}catch(o){console.warn(`⚠️ [projectsReports] Failed to destroy ${t} chart`,o)}delete Ne[t]}e.innerHTML="";const r={...n};Array.isArray(r.series)||(r.series=[]);try{const o=new Ct(e,r);Ne[t]=o,o.render().catch(s=>{console.error(`❌ [projectsReports] Failed to render ${t} chart`,s)})}catch(o){console.error(`❌ [projectsReports] Failed to render ${t} chart`,o)}}function $s(){!S.exportExcelBtn||S.exportExcelBtn.dataset.bound==="true"||(S.exportExcelBtn.addEventListener("click",async()=>{try{const t=ha();await Os(t)}catch(t){console.error("❌ [projectsReports] Failed to export Excel",t);try{alert("تعذر تصدير البيانات.")}catch{}}}),S.exportExcelBtn.dataset.bound="true")}async function Os(t){if(!Array.isArray(t)||t.length===0){try{alert("لا توجد بيانات لتصديرها.")}catch{}return}let e=null;try{e=await _n()}catch{e=null}if(e||(e=await Qa()),!e){try{alert("مكتبة Excel غير متوفرة.")}catch{}return}const n=["كود المشروع","المشروع","العميل","الحالة","الفترة","القيمة (مع الضريبة)","تقدير المعدات","إيرادات الخدمات","تكلفة الخدمات","صافي الحجوزات (بدون ضريبة)","صافي الربح","هامش الربح %","حالة الدفع","المبالغ المدفوعة","نسبة الدفع %","عدد الدفعات"],r=t.map(h=>{const f=We(h.id),y=(Array.isArray(f)?f:[]).reduce((X,_)=>{const M=Array.isArray(_.items)?_.items:[],O=Array.isArray(_.crewAssignments)?_.crewAssignments:[],$=O.length?O:Array.isArray(_.technicians)?_.technicians:[],G=Array.isArray($)&&$.length&&typeof $[0]=="object",F=Array.isArray($)&&$.length&&typeof $[0]!="object",H=ve({items:M,technicianIds:F?$:[],crewAssignments:G?$:[],discount:_.discount??0,discountType:_.discountType||"percent",applyTax:!1,start:_.start,end:_.end});return X.equipment+=Number(H.equipmentTotal||0),X.crew+=Number(H.crewTotal||0),X.crewCost+=Number(H.crewCostTotal||0),X},{equipment:0,crew:0,crewCost:0}),E=Ve(h),P=Number(Se(h)||0),g=y.equipment+y.crew+E,C=Number(h?.raw?.discount??h?.discount??0)||0;let w=((h?.raw?.discount_type??h?.discountType)==="amount"?"amount":"percent")==="amount"?C:g*(C/100);(!Number.isFinite(w)||w<0)&&(w=0),w>g&&(w=g);const T=Math.max(0,g-w),I=T,L=Math.max(0,y.equipment+y.crew-w),A=Number((T-P-(y.crewCost||0)).toFixed(2)),k=I>0?A/I*100:0,q=wa(h.start,h.end),B=U(`projects.status.${h.status}`,h.status),b=U(`projects.paymentStatus.${h.paymentStatus}`,h.paymentStatus),R=h.clientCompany?`${h.clientName} (${h.clientCompany})`:h.clientName||"",D=Number(h.raw?.paidAmount??h.paidAmount??0)||0,N=Number(h.raw?.paidPercent??h.paidPercent??0)||0,j=Array.isArray(h.raw?.paymentHistory)?h.raw.paymentHistory.length:0;return[String(h.projectCode||h.id||""),String(h.title||h.projectCode||""),String(R),B,q,Math.round(h.overallTotal||0),Math.round(Number(h?.raw?.equipmentEstimate??h?.equipmentEstimate??0)||0),Math.round(E||0),Math.round(P||0),Math.round(L||0),Math.round(A||0),Number(k.toFixed(1)),b,Math.round(D||0),Number((N||0).toFixed(1)),j]}),o={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{patternType:"solid",fgColor:{rgb:"2563EB"}},alignment:{horizontal:"center",vertical:"center"}},s={z:"#,##0",alignment:{horizontal:"right"}},c={z:"#,##0.0",alignment:{horizontal:"right"}},i=[n.map(h=>({v:h,t:"s",s:o}))];r.forEach(h=>{const f=[];f.push({v:h[0]}),f.push({v:h[1]}),f.push({v:h[2]}),f.push({v:h[3]}),f.push({v:h[4]}),f.push({v:h[5],t:"n",s}),f.push({v:h[6],t:"n",s}),f.push({v:h[7],t:"n",s}),f.push({v:h[8],t:"n",s}),f.push({v:h[9],t:"n",s}),f.push({v:h[10],t:"n",s}),f.push({v:h[11],t:"n",s:c}),f.push({v:h[12]}),f.push({v:h[13],t:"n",s}),f.push({v:h[14],t:"n",s:c}),f.push({v:h[15],t:"n",s}),i.push(f)});const a=e.utils.aoa_to_sheet(i);a["!cols"]=[8,24,18,12,16,16,14,14,14,18,14,12,12,14,12,10].map(h=>({wch:h}));const u=String.fromCharCode(65+n.length-1);a["!autofilter"]={ref:`A1:${u}${i.length}`};const d=e.utils.book_new();e.utils.book_append_sheet(d,a,"Summary");const l=Hs(e,t);e.utils.book_append_sheet(d,l,"Breakdown");const m=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");e.writeFile(d,`projects-report-${m}.xlsx`)}function Hs(t,e){const n={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{patternType:"solid",fgColor:{rgb:"1F2937"}},alignment:{horizontal:"center",vertical:"center"}},r={font:{bold:!0,sz:13},alignment:{horizontal:"left",vertical:"center"}},o={z:"#,##0",alignment:{horizontal:"right"}},s={z:"#,##0.0",alignment:{horizontal:"right"}},c={};let i=0;const a=(l,p,m)=>{const h=t.utils.encode_cell({r:i,c:l}),f=typeof p=="number"?"n":"s";c[h]={v:p,t:f,s:m||{}},u()},u=()=>{const l=c["!ref"],p=t.utils.encode_cell({r:i,c:5});c["!ref"]=l?l.replace(/:[A-Z]+\d+$/,`:${p}`):`A1:${p}`},d=(l=1)=>{i+=l};return c["!cols"]=[22,36,16,16,16,16].map(l=>({wch:l})),e.forEach((l,p)=>{a(0,`${l.title||l.projectCode||""} — #${l.projectCode||l.id||""}`,r),d(),["البند","القيمة","البند","القيمة","البند","القيمة"].forEach((A,k)=>a(k,A,n)),d();const h=We(l.id),f=(Array.isArray(h)?h:[]).reduce((A,k)=>{const q=Array.isArray(k.items)?k.items:[],B=Array.isArray(k.crewAssignments)?k.crewAssignments:[],b=B.length?B:Array.isArray(k.technicians)?k.technicians:[],R=Array.isArray(b)&&b.length&&typeof b[0]=="object",D=Array.isArray(b)&&b.length&&typeof b[0]!="object",N=ve({items:q,technicianIds:D?b:[],crewAssignments:R?b:[],discount:k.discount??0,discountType:k.discountType||"percent",applyTax:!1,start:k.start,end:k.end});return A.equipment+=Number(N.equipmentTotal||0),A.crew+=Number(N.crewTotal||0),A.crewCost+=Number(N.crewCostTotal||0),A},{equipment:0,crew:0,crewCost:0}),y=Ve(l),E=Number(Se(l)||0),P=f.equipment+f.crew+y,g=Number(l?.raw?.discount??l?.discount??0)||0;let x=((l?.raw?.discount_type??l?.discountType)==="amount"?"amount":"percent")==="amount"?g:P*(g/100);(!Number.isFinite(x)||x<0)&&(x=0),x>P&&(x=P);const w=Math.max(0,P-x),T=Number((w-E-(f.crewCost||0)).toFixed(2)),I=w>0?T/w*100:0;[["إيراد المعدات (حجوزات)",f.equipment,"إيراد الطاقم (حجوزات)",f.crew,"إيرادات الخدمات",y],["الخصم",x,"بعد الخصم",w,"تكلفة الطاقم",f.crewCost],["تكلفة الخدمات الإنتاجية",E,"صافي الربح",T,"هامش الربح %",Number(I.toFixed(1))]].forEach(A=>{A.forEach((k,q)=>{const B=q%2===1;a(q,k,B?typeof k=="number"&&(q===5?s:o):{})}),d()}),d()}),c}function zs(t){if(!S.table||!S.tableBody||!S.tableEmpty)return;if(!t.length){S.table.style.display="none",S.tableEmpty.classList.add("active"),S.tableMeta&&(S.tableMeta.textContent="");return}S.table.style.display="",S.tableEmpty.classList.remove("active");const e=Ws([...t||[]]).map(n=>{const r=gn(n),o=wa(n.start,n.end),s=U(`projects.status.${n.status}`,n.status),c=`<span class="timeline-status-badge timeline-status-badge--${n.status}">${wt(s)}</span>`,i=fa(n),a=i==="paid"?"status-paid":i==="partial"?"status-partial":"status-unpaid",u=i==="paid"?U("reservations.list.payment.paid","💳 مدفوع"):i==="partial"?U("reservations.list.payment.partial","💳 مدفوع جزئياً"):U("reservations.list.payment.unpaid","💳 غير مدفوع"),d=`<span class="reservation-chip ${a}">${wt(u)}</span>`,l=wt(n.clientName||U("projects.fallback.unknownClient","Unknown client")),p=`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${wt(n.title||n.projectCode)}</span>
            <small class="text-muted">${wt(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${l}</td>
        <td>${c}</td>
        <td>${wt(o)}</td>
        <td>${wt(bt(n.overallTotal))}</td>
        <td>${wt(va(r.marginPercent))}</td>
        <td>${d}</td>
      </tr>
    `;if(!W.__debug)return p;const m=[];m.push(`resFinal=${Math.round(r.resFinal)}`),m.push(`resTax=${Math.round(r.resTax)}`),m.push(`resNet=${Math.round(r.resNetRevenue)}`),m.push(`equipEst=${Math.round(r.equipmentEstimate)}`),m.push(`services=${Math.round(r.servicesRevenue)}`),m.push(`expenses=${Math.round(r.projectExpenses)}`),m.push(`netProfit=${Math.round(r.netProfit)}`),m.push(`margin=${Number((r.marginPercent||0).toFixed(1))}%`);const f=(n?.raw?.companyShareEnabled===!0||String(n?.raw?.companyShareEnabled).toLowerCase()==="true")&&Number(n?.raw?.companySharePercent)||0,y=Number(n?.raw?.discount??0)||0,E=n?.raw?.discountType==="amount"?"amount":"percent";m.push(`share%=${f}`),m.push(`disc=${y}${E==="amount"?"":"%"}`),m.push(`applyTax=${n.applyTax?"Y":"N"} taxRate=${Number((ce*100).toFixed(2))}%`);const P=`
      <tr class="reports-debug-row">
        <td colspan="7">
          <code class="reports-debug-code">${wt(m.join("  |  "))}</code>
        </td>
      </tr>
    `;return`${p}${P}`}).join("");if(S.tableBody.innerHTML=e,S.tableMeta){const n=U("projects.reports.table.meta","Showing {count} of {total} projects");S.tableMeta.textContent=n.replace("{count}",wn(t.length)).replace("{total}",wn(W.totalProjects))}}function Us(){!S.tableHead||S.tableHead.dataset.sortAttached==="true"||(S.tableHead.addEventListener("click",t=>{const e=t.target.closest("[data-sort-key]");if(!e)return;const n=e.getAttribute("data-sort-key");n&&(At.key===n?At.dir=At.dir==="asc"?"desc":"asc":(At.key=n,At.dir=n==="project"||n==="client"||n==="status"?"asc":"desc"),it())}),S.tableHead.dataset.sortAttached="true")}function Ws(t){const e=At.dir==="asc"?1:-1,n=At.key,r=(o,s)=>{switch(n){case"project":{const c=String(o.title||o.projectCode||"").toLowerCase(),i=String(s.title||s.projectCode||"").toLowerCase();return c.localeCompare(i,"ar")}case"client":{const c=String(o.clientName||"").toLowerCase(),i=String(s.clientName||"").toLowerCase();return c.localeCompare(i,"ar")}case"status":{const c=String(o.status||""),i=String(s.status||"");return c.localeCompare(i,"ar")}case"period":{const c=o.start?new Date(o.start).getTime():0,i=s.start?new Date(s.start).getTime():0;return c-i}case"value":return(o.overallTotal||0)-(s.overallTotal||0);case"margin":{const c=gn(o).marginPercent||0,i=gn(s).marginPercent||0;return c-i}case"payment":{const c=i=>i==="paid"?2:i==="partial"?1:0;return c(o.paymentStatus)-c(s.paymentStatus)}default:return(o.overallTotal||0)-(s.overallTotal||0)}};return t.sort((o,s)=>e*r(o,s))}function Vs(){if(!S.tableHead)return;S.tableHead.querySelectorAll("th.sortable").forEach(e=>{e.classList.remove("is-sorted"),e.removeAttribute("data-dir");const n=e.getAttribute("data-sort-key");n&&e.setAttribute("title",Sr(n,null))});const t=S.tableHead.querySelector(`th.sortable[data-sort-key="${At.key}"]`);t&&(t.classList.add("is-sorted"),t.setAttribute("data-dir",At.dir),t.setAttribute("title",Sr(At.key,At.dir)))}function Sr(t,e){const r=U({project:"projects.reports.table.columns.project",client:"projects.reports.table.columns.client",status:"projects.reports.table.columns.status",period:"projects.reports.table.columns.period",value:"projects.reports.table.columns.value",margin:"projects.reports.table.columns.margin",payment:"projects.reports.table.columns.payment"}[t]||"",t);if(!e)return`${r} — ${U("projects.reports.table.sortable","قابل للفرز")}`;const o=e==="asc"?U("projects.reports.table.sort.asc","ترتيب تصاعدي"):U("projects.reports.table.sort.desc","ترتيب تنازلي");return`${r} — ${o}`}function Ar(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const r=yt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.DateTimeFormat(r,{day:"2-digit",month:"2-digit",year:"numeric"});return Qt(o.format(e))}function wa(t,e){if(!t&&!e)return"—";const n=t?Ar(t):"—",r=e?Ar(e):"—";return e?`${n} → ${r}`:n}function bt(t){const e=Number(t)||0,r=yt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${Qt(o)} SR`}function wn(t){const n=yt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return Qt(new Intl.NumberFormat(n).format(t))}function va(t){const n=yt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=Number.isFinite(t)?t:0,o=new Intl.NumberFormat(n,{minimumFractionDigits:1,maximumFractionDigits:1}).format(r);return`${Qt(o)}%`}function Jt(t){const n=yt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return Qt(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function Xs(){return yt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function wt(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}export{dn as a,_o as e,pc as p};
