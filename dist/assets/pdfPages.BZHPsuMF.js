import{t as a,r as F,f as X,c as U,p as G,a as V,b as w,d as N,e as Y}from"./calculations.Bqm4O-PR.js";import{e as J}from"./reports.ClKPyKTP.js";import{s as B,c as K,d as Q,q as Z}from"./controller.CwK47G-r.js";import{n as M}from"./auth.BcQOd76e.js";import"./reservationsService.BtJ4Aekt.js";import"./dashboard.jS050jX9.js";/* empty css              */import"./dashboardShell.deT9qe6E.js";import"./customers.Bfn9j-AP.js";import"./maintenanceService.Cf3sMnbW.js";const $=96,j=25.4,k=210,_=297,R=Math.round(k/j*$),D=Math.round(_/j*$),tt=/safari/i,et=/(iphone|ipad|ipod)/i,ot=/(crios|fxios|edgios|opios)/i;function nt(){try{const o=navigator.userAgent||"";return et.test(o)&&tt.test(o)&&!ot.test(o)}catch{return!1}}function rt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function at(o="preview"){const e=document.createElement("div");e.id="quotation-pdf-root",e.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),e.setAttribute("data-quote-render-context",o);const c=document.createElement("style");c.textContent=String(Z).trim(),e.appendChild(c);const p=document.createElement("div");p.className="quote-preview-pages",p.setAttribute("data-quote-pages",""),e.appendChild(p);const t=document.createElement("style");return t.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تقليل الحافة العلوية قليلاً في حالة التصدير فقط لمطابقة المعاينة */
    #quotation-pdf-root[data-quote-render-context="export"] .quote-page { padding: 4mm 12mm 10mm; }
  `,e.appendChild(t),e}function A({primary:o=!1}={}){const e=document.createElement("div");return e.className="quote-page",o&&e.classList.add("quote-page--primary"),e}function st(o){const e=document.createElement("div");e.className="rpt-header";const c=document.createElement("h1");c.textContent=a("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const p=document.createElement("p");p.className="rpt-subtitle",p.textContent=`${Y(new Date)} • ${a("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,e.appendChild(c),e.appendChild(p);const t=document.createElement("div");t.className="rpt-kpis";const r=(d,n)=>{const s=document.createElement("div");return s.className="rpt-kpi",s.innerHTML=`<div class="label">${d}</div><div class="value">${n}</div>`,s};return t.appendChild(r(a("reservations.reports.kpi.total.label","الحجوزات","Reservations"),N(o.total||0))),t.appendChild(r(a("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),w(o.revenue||0))),t.appendChild(r(a("reservations.reports.kpi.net.label","صافي الربح","Net profit"),w(o.netProfit||0))),t.appendChild(r(a("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),w(o.companyShareTotal||0))),t.appendChild(r(a("reservations.reports.kpi.tax.label","الضريبة","Tax"),w(o.taxTotal||0))),t.appendChild(r(a("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),w(o.maintenanceExpense||0))),e.appendChild(t),e}function it(){try{const o=F?.data||{},e=F?.lastSnapshot?.filtered||o.reservations||[],c=new Map((o.customers||[]).map(n=>[String(n.id),n])),p=[...e].sort((n,s)=>new Date(s?.start||0)-new Date(n?.start||0)),t={code:a("reservations.reports.results.headers.id","الحجز","Reservation"),customer:a("reservations.reports.results.headers.customer","العميل","Customer"),date:a("reservations.reports.results.headers.date","التاريخ","Date"),status:a("reservations.reports.results.headers.status","الحالة","Status"),payment:a("reservations.reports.results.headers.payment","الدفع","Payment"),total:a("reservations.reports.results.headers.total","الإجمالي","Total"),share:a("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:a("reservations.reports.results.headers.net","صافي الربح","Net profit")},r=[t.code,t.customer,t.date,t.status,t.payment,t.total,t.share,t.net],d=p.map(n=>{const s=n?.reservationId||n?.id||"—",v=M(String(s)),i=c.get(String(n?.customerId))?.customerName||a("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),g=X(n?.start),E=U(n),m=(()=>{switch(E.statusValue){case"completed":return String(a("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(a("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(a("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return M(String(E.statusValue||"—"))}})(),f=G(E.paidStatus),l=V(n),h=w(l.finalTotal),u=l.companySharePercent>0?`${N(l.companySharePercent)}% (${w(l.companyShareAmount)})`:a("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),y=w(l.netProfit);return{[t.code]:v,[t.customer]:i,[t.date]:g,[t.status]:m,[t.payment]:f,[t.total]:h,[t.share]:u,[t.net]:y}});return{headers:r,rows:d}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function I(o){const e=document.createElement("table");e.className="rpt-table";const c=document.createElement("thead"),p=document.createElement("tr");o.forEach(r=>{const d=document.createElement("th");d.textContent=r,p.appendChild(d)}),c.appendChild(p);const t=document.createElement("tbody");return e.appendChild(c),e.appendChild(t),{table:e,tbody:t}}function pt(o,e,c,p){const t=o.querySelector("[data-quote-pages]"),r=A({primary:!0});t.appendChild(r);const d=st(p);r.appendChild(d);let{table:n,tbody:s}=I(c);r.appendChild(n);const v=18,x=28,i=[];for(let m=0;m<e.length;m+=x)i.push(e.slice(m,m+x));if(i.length){const m=i[0];if(m.length>v){const f=m.splice(v);i.length>1?i[1]=f.concat(i[1]):i.push(f)}}const g=(m,f)=>{const l=document.createElement("tr");c.forEach(h=>{const u=document.createElement("td");u.textContent=f[h]!=null?String(f[h]):"",l.appendChild(u)}),m.appendChild(l)};(i.shift()||e).forEach(m=>g(s,m)),i.forEach(m=>{const f=A({primary:!1});t.appendChild(f);const l=I(c);f.appendChild(l.table),m.forEach(h=>g(l.tbody,h))})}function dt(o=[],{context:e="preview"}={}){const p=(F.lastSnapshot||{}).metrics||{};let t,r=o&&o.length?o:null;if(r)t=Object.keys(r[0]||{});else{const s=it();t=s.headers,r=s.rows}const d=at(e),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${R}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(d);try{B(d),K(d),Q(d)}catch{}return pt(d,r||[],t,p),d.parentElement?.removeChild(d),n.parentElement?.removeChild(n),d}async function vt(o=[],{action:e="save"}={}){const c=dt(o,{context:"export"}),p=document.createElement("div");Object.assign(p.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),p.appendChild(c),document.body.appendChild(p);try{const r=nt()&&!rt()?window.open("","_blank"):null;if(r)try{r.document.open(),r.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${a("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${a("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${a("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),r.document.close()}catch{}await J();const d=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,n=window.html2canvas;if(typeof d=="function"&&typeof n=="function"){const s=new d({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),x={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},i=Array.from(c.querySelectorAll(".quote-page"));let g=0;const E=6,m=-10,f=.985;for(let l=0;l<i.length;l+=1){const h=i[l],u=h.ownerDocument||document,y=u.createElement("div");Object.assign(y.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const b=h.cloneNode(!0);b.style.width=`${R}px`,b.style.maxWidth=`${R}px`,b.style.minWidth=`${R}px`,b.style.height=`${D}px`,b.style.maxHeight=`${D}px`,b.style.minHeight=`${D}px`,b.style.position="relative",b.style.background="#ffffff",y.appendChild(b),u.body.appendChild(y);let P;try{P=await n(b,{...x,scrollX:0,scrollY:0})}finally{y.parentNode?.removeChild(y)}if(!P)continue;const H=P.width||1,W=(P.height||1)/H;let C=k,S=C*W,q=0;if(S>_){const T=_/S;S=_,C=C*T,q=Math.max(0,(k-C)/2)}C*=f,S*=f,q=Math.max(0,(k-C)/2);const z=P.toDataURL("image/jpeg",.95);g>0&&s.addPage();const L=Math.max(0,q+E),O=m;s.addImage(z,"JPEG",L,O,C,S,`page-${g+1}`,"FAST"),g+=1,await new Promise(T=>requestAnimationFrame(T))}if(g===0)throw new Error("PDF generation produced no pages");if(e==="print"){const l=s.output("bloburl");if(r)try{r.location.href=l}catch{}else await new Promise(h=>{const u=document.createElement("iframe");Object.assign(u.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),u.onload=()=>{try{u.contentWindow?.focus(),u.contentWindow?.print()}catch{}setTimeout(()=>{u.remove(),h()},700)},u.src=l,document.body.appendChild(u)})}else s.save("reservations-report.pdf")}else{const s=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(c).toPdf();if(e==="print"){const v=await s.get("pdf").then(x=>x.output("bloburl"));await new Promise(x=>{const i=document.createElement("iframe");Object.assign(i.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),i.onload=()=>{try{i.contentWindow?.focus(),i.contentWindow?.print()}catch{}setTimeout(()=>{i.remove(),x()},700)},i.src=v,document.body.appendChild(i)})}else await s.save("reservations-report.pdf")}}finally{p.remove()}}export{dt as buildReportsPdfPages,vt as exportReportsPdf};
