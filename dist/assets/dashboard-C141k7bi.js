import{t as c,d as O,e as H,n as g,f as W,b as R,A as Dt,s as In,h as _n,j as h,k as ot,o as xt,u as fe,p as xe,q as qn,r as Bn,a as Cn,c as Mn,i as Dn,l as xn}from"./auth-CXJ9BVF7.js";import"./common-DiVDZi68.js";import{r as Rt,l as Rn}from"./controller-D3HYq-zB.js";/* empty css            */import{r as Fn}from"./customers-DO2XvEk7.js";import{e as Nn,i as jn,g as Qe,s as Pn,c as On,r as Ft,m as Hn,a as Nt,b as Un,d as Vn,f as zn,h as it,j as Yn,k as Gn,u as Wn}from"./projectsService-BIwVNY6h.js";import{s as jt}from"./events-DDD7O3MK.js";const Kn={limit:200};let S=null,gt=!1,ht=!1,yt=!1,vt=!1,ze=null,Ye=null,Ge=!1,V="";function Pt(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Zn(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function re({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:r}=Pt();if(!a||!r)return;const s=typeof t=="string"?t.trim().length>0:!!t,o=!e&&!s&&!!n,i=e||s||o;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",s),a.classList.toggle("is-empty",o),!i){r.textContent="";return}let l="";e?l=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):s?l=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):o&&(l=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة.")),r.textContent=l}function We(){S&&(S.destroy(),S=null)}function Qn(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const r=e.paidStatus??e.paid_status??null,s=e.paid!=null?e.paid:r==="paid",{effectiveConfirmed:o}=Ft(e,t),i=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let u=!!e.completed;if(!u&&a){const d=new Date(a);Number.isNaN(d.getTime())||(u=d<new Date)}return{id:e.id??i??n,start:n,end:a||n,paid:s,confirmed:o,completed:u,reservationId:i??"",customerName:l,raw:e}}function Ot(e=[]){const{projects:t=[]}=H(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const r=a?.projectId??a?.project_id??null,s=r!=null&&r!==""&&n.get(String(r))||null,o=Qn(a,s);if(!o)return null;const i=aa({...a,paid:o.paid,confirmed:o.confirmed,completed:o.completed});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:i.background,borderColor:i.border,textColor:i.text,display:"auto",extendedProps:{...a,paid:o.paid,confirmed:o.confirmed,completed:o.completed,reservationId:o.reservationId,customerName:o.customerName}}}).filter(Boolean)}function Et(){return{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")}}async function Jn(){if(Ge)return Qe();Ge=!0,V="";try{await Nn({suppressError:!1,params:Kn})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),V=jn(e)?e.message:e instanceof Error&&e.message||""}finally{Ge=!1}return Qe()}function Ht(e){S&&S.batchRendering(()=>{S.removeAllEvents(),S.addEventSource(e)})}function Ut(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Vt(){const e=Qe(),t=Ot(e);if(!S){Oe();return}S.setOption("locale",O()),Ht(t),be(),re({loading:!1,error:"",empty:t.length===0}),Ut(t)}function Xn(){gt||(document.addEventListener("language:changed",()=>{S&&S.setOption("locale",O()),Oe()}),gt=!0),ht||(document.addEventListener("reservations:changed",()=>{Vt()}),ht=!0)}function zt(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function be(){if(!S)return;const e=zt();S.view?.type!==e&&S.changeView(e),S.updateSize()}function ea(){yt||typeof window>"u"||(window.addEventListener("resize",()=>{be()}),yt=!0)}function ta(){if(vt||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{Ye&&clearTimeout(Ye),Ye=setTimeout(()=>{S&&Vt()},80)};ze=new MutationObserver(e),ze.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&ze.observe(document.body,{attributes:!0,attributeFilter:["class"]}),vt=!0}function na(){return typeof document>"u"?!1:document.documentElement?.classList.contains("dark-mode")||document.body?.classList.contains("dark-mode")}function aa(){return na()?{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(30, 58, 138, 0.7))",border:"rgba(59, 130, 246, 0.5)",text:"#e2e8f0"}:{background:"linear-gradient(135deg, #4361ee, #3a0ca3)",border:"#240c62",text:"#ffffff"}}function sa(e){const{reservationId:t,customerName:n,paid:a,confirmed:r,completed:s}=e.event.extendedProps,o=a===!0||a==="paid",i=r===!0||r==="true",l=document.createElement("div");l.className="fc-reservation-event";const u=i?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),d=o?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),p=c("calendar.badges.completed","منتهي"),m=c("calendar.labels.unknownCustomer","غير معروف");return l.innerHTML=`
    <div class="fc-reservation-id">${t}</div>
    <div class="fc-reservation-customer">${n||m}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${i?"bg-success":"bg-warning text-dark"}">${u}</span>
      <span class="badge ${o?"bg-primary":"bg-danger"}">${d}</span>
      ${s?`<span class="badge bg-secondary">${p}</span>`:""}
    </div>
  `,{domNodes:[l]}}function ra(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",r=!!e.completed,s=n?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),o=a?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),i=c("calendar.badges.completed","منتهي"),l=O(),u=e.items||[],d=Pn()||[],p=new Map(d.map(b=>[String(b.id),b])),m=(e.technicians||[]).map(b=>p.get(String(b))).filter(Boolean),f=On(e.start,e.end),C=u.reduce((b,I)=>b+(I.qty||1)*(I.price||0),0)*f,T=(b={})=>{const I=[b.dailyWage,b.daily_rate,b.dailyRate,b.wage,b.rate];for(const pe of I){if(pe==null)continue;const ke=parseFloat(g(String(pe)));if(Number.isFinite(ke))return ke}return 0},te=m.reduce((b,I)=>b+T(I),0)*f,ne=C+te,ue=(()=>{const b=parseFloat(e.discount)||0;return b?e.discountType==="amount"?b:ne*(b/100):0})(),Ae=Math.max(0,ne-ue),me=e.applyTax?Ae*.15:0,ae=e.cost??Math.round(Ae+me),we=c("calendar.labels.currencySuffix","ريال"),yn=u.length?u.map((b,I)=>{const pe=b.image||b.imageUrl||b.img||"",ke=g(String(b.barcode||"-")),Ln=g(String(b.qty||1)),kn=g(String(b.price||0)),$n=pe?`<img src="${pe}" alt="${b.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${g(String(I+1))}</td>
            <td>${ke}</td>
            <td>${b.desc||"-"}</td>
            <td>${Ln}</td>
            <td>${kn} ${we}</td>
            <td>${$n}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${c("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,Le=[`<div>${c("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",C.toFixed(2))}</div>`,`<div>${c("calendar.summary.crewTotal","😎 إجمالي الفريق: <strong>{value} ريال</strong>").replace("{value}",te.toFixed(2))}</div>`,`<div>${c("calendar.summary.duration","⏱️ عدد الأيام: <strong>{value}</strong>").replace("{value}",g(String(f)))}</div>`];if(ue>0){const b=l==="en"?"%":"٪",I=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${b}`:`${ue.toFixed(2)} ${we}`;Le.push(`<div>${c("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",I)}</div>`)}e.applyTax&&me>0&&Le.push(`<div>${c("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",me.toFixed(2))}</div>`),Le.push(`<div>${c("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",ae.toFixed(2))}</div>`);const vn=g(String(e.reservationId??e.id??"")),En=e.start?g(W(e.start)):"-",Tn=e.end?g(W(e.end)):"-",Sn=e.notes?g(e.notes):c("calendar.labels.noNotes","لا توجد ملاحظات"),An=e.customerName||c("calendar.labels.unknownCustomer","غير معروف"),wn=[{icon:"🆔",label:c("calendar.labels.reservationId","رقم الحجز"),value:vn},{icon:"👤",label:c("calendar.labels.customer","العميل"),value:An},{icon:"🗓️",label:c("calendar.labels.start","بداية الحجز"),value:En},{icon:"🗓️",label:c("calendar.labels.end","نهاية الحجز"),value:Tn},{icon:"📝",label:c("calendar.labels.notes","الملاحظات"),value:Sn}];t.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${s}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${o}</span>
      ${r?`<span class="badge bg-secondary">${i}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${wn.map(b=>`
        <div class="calendar-info-row">
          <span class="label">${b.icon} ${b.label}</span>
          <span class="value">${b.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${c("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${m.length?`<ul class="list-unstyled calendar-reservation-technicians">${m.map(b=>{const I=b.role?` — ${b.role}`:"";return`<li><strong>${b.name}</strong>${I}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${c("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${c("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${c("calendar.table.headers.barcode","الباركود")}</th>
            <th>${c("calendar.table.headers.description","الوصف")}</th>
            <th>${c("calendar.table.headers.quantity","الكمية")}</th>
            <th>${c("calendar.table.headers.price","السعر")}</th>
            <th>${c("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${yn}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${Le.join("")}
    </div>
  `;const bt=document.getElementById("calendarReservationModal");bt&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(bt).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function Oe(){Xn(),ea(),ta();const{calendarEl:e}=Pt();if(!e)return;const t=Zn();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");re({error:n}),We();return}(async()=>{re({loading:!0});const n=await Jn();if(V){const r=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");re({loading:!1,error:V||r}),We();return}const a=Ot(n);S?(S.setOption("locale",O()),S.setOption("buttonText",Et()),Ht(a)):(S=new t.Calendar(e,{initialView:zt(),locale:O(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:Et(),events:a,eventContent:sa,eventClick(r){ra(r.event.extendedProps)},windowResize:be}),S.render()),be(),Ut(a),re({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{be()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),V=n instanceof Error&&n.message||V||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");re({loading:!1,error:V||a}),We()})}let Je=null,Ce=null,Me=null;const A={range:"all",status:"all",payment:"all",search:"",start:null,end:null};let Tt=!1,St=!1,Ke=null;const E={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let De=!1,Re="";const _={icon:null,title:null,subtitle:null};let At=!1;function y(e,t,n=t){const a=O()==="en"?n??t:t;return c(e,a)}function wt(){Ze(),k(),setTimeout(()=>{Ze(),k()},0),setTimeout(()=>{Ze(),k()},60)}function oe(){A.range==="custom"&&k()}function Ze(){Je=null,Ce=null,Me=null}function ct(){return(O()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function Yt(){const e=O();if(e!==Je||!Ce||!Me){Je=e;const t=ct();Ce=new Intl.NumberFormat(t,{maximumFractionDigits:0}),Me=new Intl.NumberFormat(t,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Ce,currencyFormatter:Me}}function oa(e){const t=ct();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function Gt(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Wt(e={}){const t=g(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function Kt(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",r=e?.confirmed===!0||Fe(a)==="confirmed"||Fe(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:r}}function ia(){if(typeof H!="function")return!1;let e;try{e=H()}catch(i){return console.warn("⚠️ [reports] Failed to access cached data",i),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:r=[],projects:s=[]}=e;return t.length||n.length||a.length||r.length||s.length?(E.reservations=Array.isArray(t)?t.map(Hn):[],E.customers=Array.isArray(n)?n.map(Gt):[],E.equipment=Array.isArray(a)?a.map(Wt):[],E.technicians=Array.isArray(r)?r.map(Nt):[],E.projects=Array.isArray(s)?s.map(Kt):[],E.projectsMap=new Map(E.projects.map(i=>[i.id,i])),!0):!1}function Zt(e){return e?.projectId&&E.projectsMap.get(String(e.projectId))||null}function ee(e){const t=Zt(e),n=Ft(e,t),a=Fe(n.projectStatus);let r=Fe(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(r=a),(!r||r==="cancelled")&&(r=n.effectiveConfirmed?"confirmed":"pending"),(Vn(e)||a==="completed")&&(r="completed");const s=n.effectiveConfirmed||r==="confirmed"||r==="completed";s&&r!=="completed"&&(r="confirmed");const o=fa(e);return{statusValue:r,confirmed:s,paid:o}}async function Qt({silent:e=!1}={}){if(!De){De=!0,Re="",e||k();try{const[t,n,a,r,s]=await Promise.all([R("/reservations/?limit=500"),R("/customers/?limit=500"),R("/equipment/?limit=500"),R("/technicians/?limit=500"),R("/projects/?limit=500")]);E.reservations=Array.isArray(t?.data)?t.data.map(o=>Un(o)):[],E.customers=Array.isArray(n?.data)?n.data.map(Gt):[],E.equipment=Array.isArray(a?.data)?a.data.map(Wt):[],E.technicians=Array.isArray(r?.data)?r.data.map(Nt):[],E.projects=Array.isArray(s?.data)?s.data.map(Kt):[],E.projectsMap=new Map(E.projects.map(o=>[o.id,o]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),Re=t instanceof Dt?t.message:c("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),E.reservations=[],E.customers=[],E.equipment=[],E.technicians=[],E.projects=[],E.projectsMap=new Map}finally{De=!1,k()}}}function $e(){Qt({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function Xe({active:e,icon:t,title:n,subtitle:a}){const r=document.getElementById("reports-empty-state");if(!r)return;const s=r.querySelector(".reports-empty-icon"),o=r.querySelector("h4"),i=r.querySelector("p");_.icon===null&&s&&(_.icon=s.textContent),_.title===null&&o&&(_.title=o.textContent),_.subtitle===null&&i&&(_.subtitle=i.textContent),r.classList.toggle("active",!!e),!(!s||!o||!i)&&(e?(s.textContent=t!==void 0?t:_.icon??s.textContent,o.textContent=n!==void 0?n:_.title??o.textContent,i.textContent=a!==void 0?a:_.subtitle??i.textContent):(s.textContent=_.icon??s.textContent,o.textContent=_.title??o.textContent,i.textContent=_.subtitle??i.textContent))}function ca(){if(Tt)return;Tt=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-start"),r=document.getElementById("reports-end"),s=document.getElementById("reports-refresh"),o=document.getElementById("reports-custom-range"),i=document.getElementById("reports-search");if(!e)return;e.value=A.range,ia()&&k(),e.addEventListener("change",()=>{A.range=e.value,Lt(o,A.range==="custom"),A.range!=="custom"&&(A.start=null,A.end=null),k()}),t?.addEventListener("change",()=>{A.status=t.value,k()}),n?.addEventListener("change",()=>{A.payment=n.value,k()}),i?.addEventListener("input",()=>{const u=i.value||"";Ke&&clearTimeout(Ke),Ke=setTimeout(()=>{A.search=u,k()},220)}),a?.addEventListener("change",()=>{A.start=a.value||null,oe()}),r?.addEventListener("change",()=>{A.end=r.value||null,oe()}),s?.addEventListener("click",()=>{A.range==="custom"&&(A.start=a?.value||null,A.end=r?.value||null),k()}),la(a,r),Lt(o,!1),St||(document.addEventListener("language:changed",wt),document.addEventListener("language:translationsReady",wt),St=!0),At||(document.addEventListener("reservations:changed",$e),document.addEventListener("customers:changed",$e),document.addEventListener("equipment:changed",$e),document.addEventListener("technicians:updated",$e),At=!0),Qt()}function k(){if(De){Xe({active:!0,icon:"⏳",title:c("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:c("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(Re){Xe({active:!0,icon:"⚠️",title:Re,subtitle:c("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=E,r=da(e,A,t,n,a),s=ba(r),o=ga(r),i=ha(r),l=ya(r),u=va(r,t),d=Ea(r,n);Ia(s),Sa(o),It("reports-status-breakdown",i),It("reports-payment-breakdown",l),Aa(u),wa(d),Ta(r,t,a),_a(r.length===0)}function la(e,t){if(!window.flatpickr)return;const n=window.flatpickr?.l10ns?.ar?window.flatpickr.l10ns.ar:null,a=o=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...o};return n&&(i.locale=n),i};let r=null,s=null;e&&(r=window.flatpickr(e,a({onChange(o,i){A.start=i||null,s&&(o?.length?s.set("minDate",o[0]):s.set("minDate",null),oe())},onValueUpdate(o,i){A.start=i||null,oe()}}))),t&&(s=window.flatpickr(t,a({onChange(o,i){A.end=i||null,r&&(o?.length?r.set("maxDate",o[0]):r.set("maxDate",null),oe())},onValueUpdate(o,i){A.end=i||null,oe()}}))),r&&t?.value&&(r.setDate(e.value,!1),r.set("maxDate",s?.selectedDates?.[0]||t.value)),s&&e?.value&&(s.setDate(t.value,!1),s.set("minDate",r?.selectedDates?.[0]||e.value))}function Lt(e,t){e&&e.classList.toggle("active",!!t)}function Jt(e){return g(String(e||"")).toLowerCase().trim()}function da(e,t,n,a,r){const{startDate:s,endDate:o}=ma(t),i=Jt(t.search),l=!!i,u=new Map((n||[]).map(m=>[String(m.id),m])),d=new Map((a||[]).map(m=>[Ne(m?.barcode),m])),p=new Map((r||[]).map(m=>[String(m.id),m]));return(e||[]).filter(m=>{const f=m?.start?new Date(m.start):null;if(!f||Number.isNaN(f.getTime())||s&&f<s||o&&f>o)return!1;const{statusValue:v,confirmed:C,paid:T}=ee(m);return!(t.status==="confirmed"&&!(v==="confirmed"||v==="completed"||C)||t.status==="pending"&&v!=="pending"||t.status==="completed"&&v!=="completed"||t.payment==="paid"&&!T||t.payment==="unpaid"&&T||l&&!ua(m,i,u,d,p))})}function ua(e,t,n,a,r){const s=[],o=e?.reservationId||e?.id;o&&s.push(o),e?.notes&&s.push(e.notes);const{statusValue:i}=ee(e);i&&s.push(i);const l=e?.paymentStatus||e?.payment_status;l&&s.push(l),e?.paid!=null&&s.push(e.paid?"paid":"unpaid");const u=n.get(String(e?.customerId));u&&s.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const d=Zt(e);return d&&s.push(d.title,d.code,d.status),s.push(Xt(e)),(e?.items||[]).forEach(m=>{m?.desc&&s.push(m.desc),m?.barcode&&s.push(m.barcode);const f=a.get(Ne(m?.barcode));f&&s.push(f.desc,f.description,f.name)}),(e?.technicians||[]).forEach(m=>{const f=r.get(String(m));f&&s.push(f.name,f.role,f.department)}),Jt(s.filter(Boolean).join(" ")).includes(t)}function ma({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const o=t?new Date(`${t}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:kt(o)?o:null,endDate:kt(i)?i:null}}let r=new Date(a),s=null;switch(e){case"last30":{s=new Date(a),s.setDate(s.getDate()-29);break}case"thisWeek":{const o=new Date(a),l=(o.getDay()-6+7)%7;o.setDate(o.getDate()-l),o.setHours(0,0,0,0);const u=new Date(o);u.setDate(o.getDate()+6),u.setHours(23,59,59,999),s=o,r.setTime(u.getTime());break}case"thisMonth":{s=new Date(a.getFullYear(),a.getMonth(),1);const o=new Date(a.getFullYear(),a.getMonth()+1,0);r.setTime(o.setHours(23,59,59,999));break}case"thisQuarter":{const o=Math.floor(a.getMonth()/3);s=new Date(a.getFullYear(),o*3,1);const i=new Date(a.getFullYear(),(o+1)*3,0);r.setTime(i.setHours(23,59,59,999));break}case"thisYear":{s=new Date(a.getFullYear(),0,1);const o=new Date(a.getFullYear(),12,0);r.setTime(o.setHours(23,59,59,999));break}case"all":default:s=null,r=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:r}}function kt(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const pa=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),$t=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function Fe(e=""){const t=String(e).toLowerCase().trim();return t?pa.get(t)||t:""}function fa(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&$t.has(a))return $t.get(a)}return e?.paid===!0||e?.paid==="true"}function ba(e){const t=e.length;let n=0,a=0,r=0,s=0;e.forEach(i=>{const{statusValue:l,confirmed:u,paid:d}=ee(i);l==="completed"&&(a+=1),u&&(n+=1),d&&(r+=1),s+=Number(i?.cost)||0});const o=t?s/t:0;return{total:t,confirmed:n,completed:a,paidCount:r,revenue:s,average:o}}function ga(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const r=new Date(t.getFullYear(),t.getMonth()-a,1),s=r.getFullYear(),o=r.getMonth(),i=e.filter(p=>{const m=p?.start?new Date(p.start):null;return m&&m.getFullYear()===s&&m.getMonth()===o}),l=i.length,u=i.reduce((p,m)=>p+(Number(m?.cost)||0),0),d=oa(r);n.push({label:d,count:l,revenue:u})}return n}function ha(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(o=>{const{statusValue:i,confirmed:l}=ee(o);i==="completed"?t.completed+=1:i==="confirmed"||l?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,r=t.pending,s=t.completed;return[{label:y("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed"},{label:y("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-pending"},{label:y("reservations.reports.status.completedLabel","منتهية","Completed"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-completed"}]}function ya(e){const t=e.length||1,n=e.filter(r=>ee(r).paid).length,a=e.length-n;return[{label:y("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid"},{label:y("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid"}]}function va(e,t){const n=new Map,a=new Map((t||[]).map(r=>[String(r.id),r]));return e.forEach(r=>{const s=String(r?.customerId??"unknown"),o=n.get(s)||{count:0,revenue:0};o.count+=1,o.revenue+=Number(r?.cost)||0,n.set(s,o)}),Array.from(n.entries()).map(([r,s])=>({name:a.get(r)?.customerName||y("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:s.count,revenue:s.revenue})).sort((r,s)=>s.revenue-r.revenue).slice(0,5)}function Ea(e,t){const n=new Map,a=new Map((t||[]).map(r=>[Ne(r?.barcode),r]));return e.forEach(r=>{(r?.items||[]).forEach(s=>{const o=Ne(s?.barcode),i=o||(s?.desc??"unknown"),l=s?.desc||a.get(o)?.desc||a.get(o)?.description||y("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),u=Number(s?.qty)||1,d=u*(Number(s?.price)||0),p=n.get(i)||{name:l,count:0,revenue:0};p.name=l,p.count+=u,p.revenue+=d,n.set(i,p)})}),Array.from(n.values()).sort((r,s)=>s.count-r.count).slice(0,5)}function Ta(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return;if(!e||e.length===0){a.innerHTML=`<tr><td colspan="6" class="text-muted">${y("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}const r=new Map((t||[]).map(i=>[String(i.id),i])),s=new Map((n||[]).map(i=>[String(i.id),i])),o=[...e].sort((i,l)=>new Date(l.start||0)-new Date(i.start||0)).slice(0,20).map(i=>La(i,r,s));a.innerHTML=o.map(i=>`
      <tr>
        <td>${i.code}</td>
        <td>${i.customer}</td>
        <td>${i.date}</td>
        <td>${i.status}</td>
        <td>${i.payment}</td>
        <td>${i.total}</td>
      </tr>
    `).join("")}function Sa(e){const t=document.getElementById("reports-volume-chart");if(!t)return;if(!e||e.length===0){t.innerHTML=`<p class="text-muted">${y("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const n=Math.max(1,...e.map(a=>a.count));t.innerHTML=e.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/n*100))}%"></div>
          <span class="value">${N(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function It(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<p class="text-muted">${y("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}n.innerHTML=t.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${N(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${y("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",N(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function Aa(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-muted">${y("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${N(n.count)}</td>
        <td>${ye(n.revenue)}</td>
      </tr>
    `).join("")}}function wa(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-muted">${y("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${N(n.count)}</td>
        <td>${ye(n.revenue)}</td>
      </tr>
    `).join("")}}function La(e,t,n){const a=e?.reservationId||e?.id||"—",s=t.get(String(e?.customerId))?.customerName||y("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),o=$a(e?.start),i=ka(e),l=Xt(e),u=ye(e?.cost||0),d=(e?.technicians||[]).map(v=>n.get(String(v))?.name).filter(Boolean),p=y("reservations.list.crew.separator","، ",", "),m=d.map(v=>M(v)).join(M(p)),f=d.length?`${M(s)}<br><small class="text-muted">${m}</small>`:M(s);return{code:M(a),customer:f,date:M(o),status:M(i),payment:M(l),total:M(u)}}function Xt(e){const{paid:t}=ee(e);return t?y("reservations.reports.payment.paidLabel","مدفوعة","Paid"):y("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function ka(e){const{statusValue:t}=ee(e);return t==="completed"?y("reservations.list.status.completed","📁 منتهي","Completed"):t==="confirmed"?y("reservations.list.status.confirmed","✅ مؤكد","Confirmed"):t==="pending"?y("reservations.list.status.pending","⏳ غير مؤكد","Pending"):M(t)}function $a(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=ct(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return g(a.format(t))}function Ia(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),r=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-kpi-confirmed"),o=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),l=document.getElementById("reports-kpi-paid-meta"),u=e.total||0,d=e.revenue||0,p=e.confirmed||0,m=e.paidCount||0,f=e.average||0,v=u?Math.round(p/u*100):0,C=u?Math.round(m/u*100):0;if(t&&(t.textContent=N(u)),n){const T=y("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",N(e.completed||0));n.textContent=T}if(a&&(a.textContent=ye(d)),r){const T=y("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",ye(f));r.textContent=T}if(s&&(s.textContent=`${v}%`),o){const T=y("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",N(p));o.textContent=T}if(i&&(i.textContent=`${C}%`),l){const T=y("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",N(m));l.textContent=T}}function _a(e){Xe({active:!!e})}function M(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function N(e){const{numberFormatter:t}=Yt(),n=t.format(Math.round(e||0));return g(n)}function ye(e){const{currencyFormatter:t}=Yt(),n=t.format(Math.max(0,Math.round(e||0)));return g(n)}function Ne(e){return(e||"").toString().trim()}const qa=H()||{};let Q=(qa.maintenance||[]).map(en);function He(){return Q}function Ue(e){return Q=Array.isArray(e)?e.map(en):[],In({maintenance:Q}),Pa(),Q}async function Ba(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,o])=>{o!=null&&o!==""&&t.set(s,String(o))});const n=t.toString(),a=await R(`/maintenance/${n?`?${n}`:""}`),r=Array.isArray(a?.data)?a.data.map(lt):[];return Ue(r)}async function Ca(e){const t=await R("/maintenance/",{method:"POST",body:e}),n=lt(t?.data??{});return Ue([n,...Q.filter(a=>a.id!==n.id)]),n}async function Ma(e,t){const n=await R(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=lt(n?.data??{});return Ue(Q.map(r=>String(r.id)===String(e)?a:r)),a}async function Da(e){await R(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Ue(Q.filter(t=>String(t.id)!==String(e)))}function xa({equipmentId:e,technicianId:t,issue:n,priority:a,status:r,scheduledAt:s,resolutionReport:o}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:r,notes:n??"",resolution_report:null}}function lt(e={}){return tn({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function en(e={}){return tn(e)}function tn(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Ra(e.status_raw??e.status??"open"),r=Fa(a),s=ja(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:Na(e.priority??"medium"),status:r,statusRaw:a,statusLabel:s,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Ra(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Fa(e){const t=nn(e);return["completed","cancelled"].includes(t)?"closed":"open"}function Na(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function ja(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,r=>r.toUpperCase())}function nn(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function Pa(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function ve(e){return e instanceof Dt}let X=He(),J=[],ge=null,ie=!1,he="",ce=X.length>0,K={id:null,equipmentDesc:"",equipmentBarcode:""},dt=null,$=null,x=null,le=null,an=null,de=null;async function Ee({showToastOnError:e=!0}={}){if(!ie){ie=!0,he="",D();try{await Ba(),ce=!0}catch(t){ce=X.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),he=ve(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&h(he,"error")}finally{ie=!1,X=He(),D()}}}function et(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function P(e){return g(String(e||"")).trim().toLowerCase()}function _t(e=""){return g(String(e)).trim().toLowerCase()}function L(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Oa(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function j(){return X=He(),X}function sn(e){return j().find(n=>Number(n.id)===Number(e))||null}function ut(){const{equipment:e=[]}=H(),t=c("maintenance.table.noName","بدون اسم");return J=(e||[]).map(n=>({barcode:P(n?.barcode),desc:n?.desc||n?.description||n?.name||t,status:n?.status||"متاح",price:Number(n?.price)||0,category:n?.category||""})),J.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),J}function rn(){return new Set(j().filter(e=>e.status==="open").map(e=>P(e.equipmentBarcode)))}function Ve(e){const t=P(e);return t&&(J.length?J:ut()).find(a=>a.barcode===t)||null}function Ha(e){const t=_t(e);return t&&(J.length?J:ut()).find(a=>_t(a.desc).includes(t))||null}function tt(e){if(!e)return!0;const t=rn();return e.status==="صيانة"||t.has(e.barcode)}function z({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search"),s=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),r&&(r.value="")),s&&(s.textContent=et()),ge=null}function on(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر");t.innerHTML=`
    <strong>${e.desc}</strong><br>
    <span class="text-muted">${n}: ${e.barcode||a}</span>
  `}function mt(e,{silent:t=!1}={}){if(!e)return!1;if(tt(e))return t||h(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.barcode),r&&(r.value=e.desc),on(e),ge=e,!0}function cn(e,{showFeedback:t=!0}={}){const n=Ve(e);return n?mt(n,{silent:!t}):(t&&h(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function ln(e,{showFeedback:t=!0}={}){const n=Ha(e);return n?mt(n,{silent:!t}):(t&&h(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function pt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=ut(),r=rn();if(e){const o=c("maintenance.form.blockedSuffix","(صيانة)");e.innerHTML=a.map(i=>{const u=i.status==="صيانة"||r.has(i.barcode)?`${i.desc} ${o}`:i.desc,d=i.desc.replace(/"/g,"&quot;"),p=u.replace(/"/g,"&quot;");return`<option value="${d}" label="${p}"></option>`}).join("")}const s=document.getElementById("maintenance-selected-barcode");if(s&&s.value){const o=Ve(s.value);!o||tt(o)?(z({keepInputs:!0,silent:!0}),o&&tt(o)&&h(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):mt(o,{silent:!0})}else z({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),cn(t.value)||z({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const o=()=>{if(!n.value){z({keepInputs:!0,silent:!0});return}ln(n.value)||z({keepInputs:!0,silent:!0})};n.addEventListener("change",o),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),o())}),n.dataset.listenerAttached="true"}}async function je(){try{await zn({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{it(),pt()}}function dn(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;dt=t.Modal.getOrCreateInstance(e),$||($=e.querySelector("#maintenance-close-report")),x||(x=e.querySelector("#maintenance-close-submit")),le||(le=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",Va),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",un),e.dataset.listenerAttached="true"),!0}function un(){K={id:null,equipmentDesc:"",equipmentBarcode:""},$&&($.value=""),le&&(le.innerHTML=""),Te(!1)}function mn(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(an=t.Modal.getOrCreateInstance(e),de||(de=e.querySelector("#maintenance-report-modal-content")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",pn),e.dataset.listenerAttached="true"),!0):!1}function pn(){de&&(de.innerHTML="")}function Te(e){if(!x)return;const t=c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),n=c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(x.disabled=!0,x.dataset.loading="true",x.textContent=t):(x.disabled=!1,x.removeAttribute("data-loading"),x.textContent=n)}function Ua(e){const t=sn(e);if(!t){h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!dn()){const n=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(n===null)return;const a=n.trim();if(!a){h(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}fn(e,a);return}if(K={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},$&&($.value=t.resolutionReport||""),le){const n=c("maintenance.report.barcode","الباركود"),a=c("maintenance.report.notAvailable","غير متوفر"),r=K.equipmentDesc||a,s=K.equipmentBarcode?g(K.equipmentBarcode):a;le.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${r}</div>
          <div class="maintenance-close-modal__ticket-meta">${n}: <span>${s}</span></div>
        </div>
      </div>
    `}Te(!1),dt?.show(),setTimeout(()=>{$?.focus(),$?.setSelectionRange($.value.length,$.value.length)},150)}async function Va(e){if(e?.preventDefault(),!K.id){h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!$)return;const t=$.value.trim();if(!t){h(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),$.focus();return}Te(!0),(await fn(K.id,t)).success?dt?.hide():Te(!1)}function za(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(p=>p.status==="open").length,r=n-a,s=p=>g(String(p)),o=c("maintenance.stats.summaryTitle","ملخص الصيانة"),i=c("maintenance.filters.status.open","قيد الصيانة"),l=c("maintenance.filters.status.closed","مغلقة"),u=c("maintenance.stats.totalLabel","إجمالي التذاكر"),d=(p,m,f)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${f}">
      <span class="maintenance-summary__value">${s(p)}</span>
      <span class="maintenance-summary__label">${m}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${o}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${d(a,i,"open")}
        ${d(r,l,"closed")}
        ${d(n,u,"total")}
      </div>
    </section>
  `}function Ya(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=nn(n)||"open",r={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},s=r[a]??r.open,o=s?c(s.key,s.fallback):c("maintenance.status.open","قيد الصيانة"),i=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():o,l=["maintenance-status-badge","maintenance-status-tag"];return s?.className&&l.push(s.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${i}</span>`}function Ga(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),r=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${r}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const r=Ya(a),s=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",o=(()=>{const Se=c("maintenance.priority.high","مرتفعة"),te=c("maintenance.priority.medium","متوسطة"),ne=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${Se}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${ne}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${te}</span>`}})(),i=[],l=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),u=c("maintenance.actions.view","👁️ عرض التقرير"),d=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?i.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):i.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${u}</button>`),ot()&&i.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${d}</button>`);const p=i.join(""),m=c("maintenance.table.noBarcode","بدون باركود"),f=c("maintenance.report.none","—"),v=a.equipmentBarcode?g(a.equipmentBarcode):m,C=a.issue?g(a.issue):f,T=a.createdAt?g(W(a.createdAt)):"—";return`
        <tr class="${s}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${v}</small>
          </td>
          <td class="maintenance-issue-text">${C}</td>
          <td>${o}</td>
          <td>${T}</td>
          <td>${r}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${p}
            </div>
          </td>
        </tr>
      `}).join("")}}function Wa(e){if(!ce||ie){h(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Ua(a);else if(n==="view")Ka(a);else if(n==="delete"){if(!ot()){xt();return}Za(a).catch(r=>{console.error("❌ [maintenance] deleteTicket failed",r)})}}}async function fn(e,t){const n=sn(e);if(!n)return h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const a=(t??"").trim();if(!a)return h(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const r=Oa(new Date)||new Date().toISOString();try{await Ma(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:r}),await Ee({showToastOnError:!1});const s=document.getElementById("maintenance-status-filter");return s&&s.value==="open"&&(s.value="all"),await je(),D(),h(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(s){if(console.error("❌ [maintenance] closeTicket failed",s),ve(s)&&s.status===404)return await Ee({showToastOnError:!1}),await je(),D(),h(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const o=ve(s)?s.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return h(o,"error"),{success:!1,error:s}}}function Ka(e){const n=j().find(T=>Number(T.id)===Number(e));if(!n)return;if(!mn()){const T=c("maintenance.report.equipment","المعدة"),Se=c("maintenance.report.barcode","الباركود"),te=c("maintenance.report.issue","الوصف"),ne=c("maintenance.report.createdAt","تاريخ الإنشاء"),ue=c("maintenance.report.closedAt","تاريخ الإغلاق"),Ae=c("maintenance.report.summary","التقرير"),me=c("maintenance.report.notAvailable","غير متوفر"),ae=c("maintenance.report.none","—"),we=[`${T}: ${n.equipmentDesc}`,`${Se}: ${n.equipmentBarcode?g(n.equipmentBarcode):me}`,`${te}: ${n.issue?g(n.issue):ae}`,`${ne}: ${n.createdAt?g(W(n.createdAt)):ae}`,`${ue}: ${n.resolvedAt?g(W(n.resolvedAt)):ae}`,`${Ae}: ${n.resolutionReport?g(n.resolutionReport):ae}`].join(`
`);alert(we);return}const a=c("maintenance.report.equipment","المعدة"),r=c("maintenance.report.barcode","الباركود"),s=c("maintenance.report.issue","الوصف"),o=c("maintenance.report.createdAt","تاريخ الإنشاء"),i=c("maintenance.report.closedAt","تاريخ الإغلاق"),l=c("maintenance.report.summary","التقرير"),u=c("maintenance.report.notAvailable","غير متوفر"),d=c("maintenance.report.none","—"),p=[{label:a,value:`<span class="maintenance-report-modal__value">${L(n.equipmentDesc||d)}</span>`},{label:r,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${L(g(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${L(u)}</span>`},{label:s,value:n.issue?`<span class="maintenance-report-modal__value">${L(g(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${L(d)}</span>`},{label:o,value:n.createdAt?`<span class="maintenance-report-modal__value">${L(g(W(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${L(d)}</span>`},{label:i,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${L(g(W(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${L(d)}</span>`}],m=n.resolutionReport?g(n.resolutionReport):"",f=m?`<p>${L(m).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${L(d)}</p>`,v=p.map(T=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${L(T.label)}</span>
        ${T.value}
      </div>
    `).join(""),C=`
    <div class="maintenance-report-modal__summary">
      <h6>${L(l)}</h6>
      ${f}
    </div>
  `;de&&(de.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${v}
        </div>
        ${C}
      </div>
    `),an?.show()}async function Za(e){if(!ot()){xt();return}if(!j().find(a=>Number(a.id)===Number(e))){h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Da(e),await Ee({showToastOnError:!1}),await je(),h(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const r=ve(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");h(r,"error")}}async function Qa(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),r=document.getElementById("maintenance-issue"),s=document.getElementById("maintenance-priority");let o=ge,i=P(a?.value);if(!o&&i&&(o=Ve(i)),!o&&t?.value&&cn(t.value,{showFeedback:!0})&&(o=ge,i=P(o?.barcode)),!o&&n?.value&&ln(n.value,{showFeedback:!0})&&(o=ge,i=P(o?.barcode)),!o||!i){h(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=H();let u=(l||[]).find(v=>P(v?.barcode)===i);if(!u&&o&&(u={id:o.id,barcode:o.barcode,desc:o.desc,name:o.desc,status:o.status||"متاح"}),!u||u.id==null){h(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),z();return}if(u.status==="صيانة"){h(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(j().filter(v=>v.status==="open").some(v=>P(v.equipmentBarcode)===i)){h(c("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const m=xa({equipmentId:u.id,technicianId:null,issue:r?.value.trim()||"",priority:s?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Ca(m),await Ee({showToastOnError:!1}),await je(),h(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),z(),r&&(r.value=""),s&&(s.value="medium");const f=document.getElementById("maintenance-status-filter");f&&(f.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=ve(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");h(n,"error")}}function Ja(e){const t=j();return e==="all"?t:t.filter(n=>n.status===e)}function D(){const e=j();pt(),za(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),r=document.getElementById("maintenance-empty-state");if(!a)return;if(ie&&!ce){const o=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${o}</td></tr>`,r&&r.classList.remove("active");return}if(he&&!ce){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${he}</td></tr>`,r&&r.classList.remove("active");return}const s=Ja(n);Ga(s)}function Xa(){j(),pt(),ce=X.length>0,ie=!1,D(),Ee({showToastOnError:!1}),dn()&&un(),mn()&&pn();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Qa(a).catch(r=>{console.error("❌ [maintenance] submit handler failed",r)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{D()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Wa),n.dataset.listenerAttached="true")}j();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=Ve(e.value);n?on(n):t&&(t.textContent=et())}else t&&(t.textContent=et());D(),Te(!1)});document.addEventListener(_n.USER_UPDATED,()=>{D()});window.addEventListener("maintenance:updated",()=>{X=He(),D()});const nt="__ART_RATIO_LAST_DASHBOARD_TAB__",F="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Pe="create-tab",bn=/^[a-z0-9\-]+$/i;function Y(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!bn.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function at(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!bn.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function gn(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let U=null,B=null,G=!1,w=null,qt=null,Z=null,st=null,se=null;function es(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(s,{skipStore:o=!1,skipRender:i=!1}={})=>{if(!s)return;const l=e.filter(d=>d?.getAttribute("data-tab")===s),u=document.getElementById(s);if(!(!l.length||!u)&&(e.forEach(d=>{const p=d?.getAttribute("data-tab")===s;d.classList.toggle("active",p),p?(d.setAttribute("aria-selected","true"),d.setAttribute("tabindex","0")):(d.setAttribute("aria-selected","false"),d.setAttribute("tabindex","-1"))}),t.forEach(d=>{const p=d.id===s;d.style.display=p?"block":"none",d.classList.toggle("active",p)}),U=s,at(nt,s),o||fe({dashboardTab:s}).catch(d=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",d)}),s!=="reservations-tab"&&(B=null,w=null,gn(F),o||fe({dashboardSubTab:null}).catch(d=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",d)})),!i&&s==="customers-tab"&&(console.log("👤 Rendering customers"),Fn()),!i&&s==="equipment-tab"&&(console.log("📦 Rendering equipment"),it()),!i&&s==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),D()),!i&&s==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Yn()),s==="reservations-tab")){if(console.log("📅 Rendering reservations"),i||Rt(),!w){const d=Y(F);w=B||d||Pe}ts(),w&&(Ie(w),w=null)}};st=n,e.forEach(s=>{s&&(s.getAttribute("type")||s.setAttribute("type","button"),s.setAttribute("role","tab"),s.hasAttribute("tabindex")||s.setAttribute("tabindex",s.classList.contains("active")?"0":"-1"),s.addEventListener("click",()=>{const o=s.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",o),n(o),o==="reservations-tab"){const i=B||Y(F)||Pe;typeof Z=="function"?Z(i):w=i}else fe({dashboardSubTab:null}).catch(i=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",i)})}))});const a=s=>{const o=document.querySelector("[data-tab].active"),i=Y(nt),l=e[0]?.getAttribute("data-tab")||null,d=[s?.dashboardTab,i,U,o?.getAttribute("data-tab"),l].filter(Boolean).find(f=>document.getElementById(f))||l;d&&(!G||d!==U)&&(console.log("⭐ Initial tab:",d),n(d,{skipStore:!0}));const m=[s?.dashboardSubTab,Y(F)].filter(Boolean).find(f=>document.getElementById(f));m&&(U==="reservations-tab"&&typeof Z=="function"?(!G||m!==B)&&Z(m,{skipStore:!0}):w=m),G||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),G=!0)},r=typeof xe=="function"?xe():null;a(r||null),qn().then(s=>a(s||null)).catch(s=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",s),a(null)}),qt||(qt=Bn(s=>{if(!(!G||!s))if(s.dashboardTab&&s.dashboardTab!==U&&n(s.dashboardTab,{skipStore:!0}),U==="reservations-tab"){if(s.dashboardSubTab&&s.dashboardSubTab!==B)Ie(s.dashboardSubTab);else if(!s.dashboardSubTab&&B){const o=Y(F);o?o!==B&&Ie(o):Ie(null)}}else s.dashboardSubTab&&(w=s.dashboardSubTab)}))}function ts(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(s=>s?.getAttribute("data-sub-tab")).filter(s=>typeof s=="string"&&s.trim().length>0),a=()=>n.length?n.includes(Pe)?Pe:n[0]:null,r=(s,{skipStore:o=!1}={})=>{if(!n.length)return;let i=s;(!i||!n.includes(i))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:i,available:n}),i=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${i}"]`),u=document.getElementById(i);if(!l||!u){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:i});return}if(B===i&&l.classList.contains("active")&&u.classList.contains("active")&&u.getAttribute("aria-hidden")==="false"){u.removeAttribute("hidden"),u.style.display="block",u.setAttribute("aria-hidden","false"),B=i,o||(at(F,i),fe({dashboardSubTab:i}).catch(p=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",p)}));return}e.forEach(p=>{p.classList.remove("active"),p.classList.contains("tab")&&p.classList.remove("tab-active"),p.setAttribute("aria-selected","false"),p.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),t.forEach(p=>{const m=p.id===i;p.classList.toggle("active",m),p.setAttribute("aria-hidden",m?"false":"true"),m?(p.removeAttribute("hidden"),p.style.display="block"):(p.setAttribute("hidden",""),p.style.display="none")}),B=i,at(F,i),o||fe({dashboardSubTab:i}).catch(p=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",p)}),i==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{Rt()},50)):i==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{Oe()},100)):i==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{k()},50))};if(Z=(s,o={})=>{s?r(s,o):(e.forEach(i=>{i.classList.remove("active"),i.classList.contains("tab")&&i.classList.remove("tab-active"),i.setAttribute("aria-selected","false"),i.setAttribute("tabindex","-1")}),t.forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden",""),i.style.display="none"}),B=null,gn(F))},e.forEach(s=>{s.dataset.subTabListenerAttached||(s.addEventListener("click",()=>{const o=s.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",o),r(o)}),s.dataset.subTabListenerAttached="true")}),w)r(w,{skipStore:!0}),w=null;else{const s=document.querySelector("#reservations-tab .sub-tab-button.active"),o=a(),i=s?.getAttribute("data-sub-tab")||o;i&&(console.log("⭐ Initial sub-tab:",i),r(i,{skipStore:!0}))}jt()}function Ie(e){typeof Z=="function"?Z(e,{skipStore:!0}):e&&(w=e)}function ns(){try{if(typeof xe=="function")return xe()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function as({attemptsLeft:e=0}={}){if(!G||typeof st!="function")return!1;const t=ns(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,s=[U,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,Y(nt),a].filter(Boolean).find(i=>document.getElementById(i));if(!s)return!1;const o=()=>{const i=document.querySelector(`[data-tab].active[data-tab="${s}"]`),l=document.getElementById(s);return!!(i&&l?.classList.contains("active")&&l?.style.display!=="none")};if(s==="reservations-tab"){const i=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!i.length)return!1;const l=i[0]?.getAttribute("data-sub-tab")||null,d=[B,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,Y(F),l].filter(Boolean).find(v=>document.getElementById(v)),p=document.querySelector("#reservations-tab .sub-tab-button.active"),m=document.querySelector("#reservations-tab .sub-tab.active"),f=m?.id||p?.getAttribute("data-sub-tab")||null;if(d&&f===d&&o())return m&&(m.removeAttribute("hidden"),m.style.display="block",m.setAttribute("aria-hidden","false")),!0;if(d)w=d;else if(e>0)return!1}else if(o())return!0;return st(s,{skipStore:!0,skipRender:!0}),!0}function ft(){if(!G)return;let e=0;const t=5;se&&(clearTimeout(se),se=null);const n=()=>{if(as({attemptsLeft:t-e})){se=null;return}if(e>=t){se=null;return}e+=1,se=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",ft);document.addEventListener("language:changed",ft);document.addEventListener("theme:changed",ft);const _e={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let rt=!1;const ss=1632,rs=1776;function os(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-ss)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-rs)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function is(e){try{const t=os(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function qe(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=is(t))}function Bt(){rt=!1;const e=H(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,r=Array.isArray(e.technicians)?e.technicians.length:0;_e.projects.forEach(s=>qe(s,t)),_e.reservations.forEach(s=>qe(s,n)),_e.equipment.forEach(s=>qe(s,a)),_e.technicians.forEach(s=>qe(s,r))}function Ct(){rt||(rt=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(Bt):setTimeout(Bt,16))}function cs(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,Ct,{passive:!0})}),Ct()}function ls(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function ds({sidebar:e,backdrop:t}){e?.classList.add("open"),t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function Be({sidebar:e,backdrop:t}){e?.classList.remove("open"),t?.classList.remove("open"),e?.setAttribute("aria-hidden","true")}function us(){const e=document.querySelector("[data-dashboard-greeting]");if(!e)return;const t=e.querySelector("[data-greeting-toggle]"),n=e.querySelector("[data-greeting-panel]");if(!t||!n)return;const a=i=>{i.target instanceof Node&&(e.contains(i.target)||o(!1))},r=()=>{window.requestAnimationFrame(()=>{document.addEventListener("click",a,{capture:!0})})},s=()=>{document.removeEventListener("click",a,{capture:!0})},o=i=>{n.hidden=!i,t.setAttribute("aria-expanded",String(i)),e.dataset.state=i?"open":"closed",i?r():s()};o(!1),t.addEventListener("click",()=>{const l=!(t.getAttribute("aria-expanded")==="true");o(l),l&&!window.matchMedia("(min-width: 768px)").matches&&n.scrollIntoView({behavior:"smooth",block:"start"})})}function ms(){const e=ls(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:r}=e;t&&(t.setAttribute("aria-hidden","true"),a?.addEventListener("click",s=>{s.preventDefault(),ds(e)}),r?.addEventListener("click",s=>{s.preventDefault(),Be(e)}),n?.addEventListener("click",()=>{Be(e)}),t.addEventListener("click",s=>{const o=s.target;if(o instanceof HTMLElement){if(o.hasAttribute("data-close-sidebar")||o.closest("[data-close-sidebar]")){Be(e);return}o.closest("[data-tab]")&&Be(e)}}),us())}Cn();let q=null;async function Mt(){if(!await Mn())return;ms(),es(),cs(),Dn(),it(),Gn(),Oe(),Xa(),ca(),Rn(),jt();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const r=a.target.files&&a.target.files[0];r&&(await Wn(r),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",xn),ps(),fs()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Mt().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):Mt().catch(e=>{console.error("❌ Failed to initialise app",e)});function ps(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[r]=a.split(":"),s=`${r.padStart(2,"0")}:00`,o=`${n}T${s}`;e.value!==o&&(e.value=o,setTimeout(()=>e.blur(),150))})})}function fs(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;q={reservationId:t,reservationIndex:n!=null?Number(n):null},hn(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,r)}function hn(){if(!q)return;const t=H().reservations||[];let n=null;if(q.reservationId){const a=t.findIndex(r=>String(r?.id)===q.reservationId||String(r?.reservationId)===q.reservationId);a!==-1&&(n=a)}n===null&&typeof q.reservationIndex=="number"&&!Number.isNaN(q.reservationIndex)&&q.reservationIndex>=0&&q.reservationIndex<t.length&&(n=q.reservationIndex),n!==null&&(q=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const r=window.editReservation;typeof r=="function"&&r(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{q&&hn()});
