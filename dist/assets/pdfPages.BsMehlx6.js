import{t as d,r as O,f as it,c as ct,p as pt,a as lt,b as D,d as V,e as dt}from"./calculations.Cuzjzmo7.js";import{e as mt}from"./reports.B8mIFZMK.js";import{s as ut,c as ft,d as ht,q as gt}from"./controller.CKj9uBP3.js";import{n as U}from"./auth.DEm-O4iH.js";import"./reservationsService.DHFcI6wO.js";import"./dashboard.TVUGWSOZ.js";/* empty css              */import"./dashboardShell.BJ8UOETr.js";import"./customers.DDv-F3VN.js";import"./maintenanceService.-sdg2Aq9.js";const L=96,z=25.4,J=210,xt=297,N=Math.round(J/z*L),j=Math.round(xt/z*L),A=L/z,bt=/safari/i,yt=/(iphone|ipad|ipod)/i,wt=/(crios|fxios|edgios|opios)/i;function vt(){try{const o=navigator.userAgent||"";return yt.test(o)&&bt.test(o)&&!wt.test(o)}catch{return!1}}function Ct(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function Pt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const r=document.createElement("style");r.textContent=String(gt).trim(),t.appendChild(r);const c=document.createElement("div");c.className="quote-preview-pages",c.setAttribute("data-quote-pages",""),t.appendChild(c);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function K(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function Y({rightMm:o,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function Mt(o){try{const t=K(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const c="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${c}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${c}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${c}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(r,e);const n=()=>{const i=Number(r.querySelector("[data-rpt-right]").value),C=Number(r.querySelector("[data-rpt-top]").value),R=Number(r.querySelector("[data-rpt-scale]").value),l=Math.max(.9,Math.min(1,R/100));Y({rightMm:i,topMm:C,scale:l});const T=i*A,E=C*A;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${T}px, ${E}px) scale(${l})`})};r.querySelector("[data-rpt-apply]").addEventListener("click",n),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,Y({rightMm:0,topMm:0,scale:1});const i=o.querySelector("[data-quote-pages]");Object.assign(i.style,{transform:"none"})});const m=t.rightMm*A,a=t.topMm*A;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${m}px, ${a}px) scale(${t.scale})`})}catch{}}function B({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function St(o){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=d("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const c=document.createElement("p");c.className="rpt-subtitle",c.textContent=`${dt(new Date)} • ${d("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(c);const e=document.createElement("div");e.className="rpt-kpis";const n=(m,a)=>{const i=document.createElement("div");return i.className="rpt-kpi",i.innerHTML=`<div class="label">${m}</div><div class="value">${a}</div>`,i};return e.appendChild(n(d("reservations.reports.kpi.total.label","الحجوزات","Reservations"),V(o.total||0))),e.appendChild(n(d("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),D(o.revenue||0))),e.appendChild(n(d("reservations.reports.kpi.net.label","صافي الربح","Net profit"),D(o.netProfit||0))),e.appendChild(n(d("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),D(o.companyShareTotal||0))),e.appendChild(n(d("reservations.reports.kpi.tax.label","الضريبة","Tax"),D(o.taxTotal||0))),e.appendChild(n(d("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),D(o.maintenanceExpense||0))),t.appendChild(e),t}function Et(){try{const o=O?.data||{},t=O?.lastSnapshot?.filtered||o.reservations||[],r=new Map((o.customers||[]).map(a=>[String(a.id),a])),c=[...t].sort((a,i)=>new Date(i?.start||0)-new Date(a?.start||0)),e={code:d("reservations.reports.results.headers.id","الحجز","Reservation"),customer:d("reservations.reports.results.headers.customer","العميل","Customer"),date:d("reservations.reports.results.headers.date","التاريخ","Date"),status:d("reservations.reports.results.headers.status","الحالة","Status"),payment:d("reservations.reports.results.headers.payment","الدفع","Payment"),total:d("reservations.reports.results.headers.total","الإجمالي","Total"),share:d("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:d("reservations.reports.results.headers.net","صافي الربح","Net profit")},n=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],m=c.map(a=>{const i=a?.reservationId||a?.id||"—",C=U(String(i)),l=r.get(String(a?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),T=it(a?.start),E=ct(a),y=(()=>{switch(E.statusValue){case"completed":return String(d("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(d("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(d("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return U(String(E.statusValue||"—"))}})(),P=pt(E.paidStatus),M=lt(a),$=D(M.finalTotal),p=M.companySharePercent>0?`${V(M.companySharePercent)}% (${D(M.companyShareAmount)})`:d("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),u=D(M.netProfit);return{[e.code]:C,[e.customer]:l,[e.date]:T,[e.status]:y,[e.payment]:P,[e.total]:$,[e.share]:p,[e.net]:u}});return{headers:n,rows:m}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function G(o){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),c=document.createElement("tr");o.forEach(n=>{const m=document.createElement("th");m.textContent=n,c.appendChild(m)}),r.appendChild(c);const e=document.createElement("tbody");return t.appendChild(r),t.appendChild(e),{table:t,tbody:e}}function kt(o,t,r,c){const e=o.querySelector("[data-quote-pages]"),n=B({primary:!0});e.appendChild(n);const m=St(c);n.appendChild(m);let{table:a,tbody:i}=G(r);n.appendChild(a);const C=18,R=28,l=[];for(let y=0;y<t.length;y+=R)l.push(t.slice(y,y+R));if(l.length){const y=l[0];if(y.length>C){const P=y.splice(C);l.length>1?l[1]=P.concat(l[1]):l.push(P)}}const T=(y,P)=>{const M=document.createElement("tr");r.forEach($=>{const p=document.createElement("td");p.textContent=P[$]!=null?String(P[$]):"",M.appendChild(p)}),y.appendChild(M)};(l.shift()||t).forEach(y=>T(i,y)),l.forEach(y=>{const P=B({primary:!1});e.appendChild(P);const M=G(r);P.appendChild(M.table),y.forEach($=>T(M.tbody,$))})}function qt(o=[],{context:t="preview"}={}){const c=(O.lastSnapshot||{}).metrics||{};let e,n=o&&o.length?o:null;if(n)e=Object.keys(n[0]||{});else{const i=Et();e=i.headers,n=i.rows}const m=Pt(t),a=document.createElement("div");a.style.position="fixed",a.style.left="-10000px",a.style.top="0",a.style.width=`${N}px`,a.style.zIndex="-1",document.body.appendChild(a),a.appendChild(m);try{ut(m),ft(m),ht(m)}catch{}return kt(m,n||[],e,c),m.parentElement?.removeChild(m),a.parentElement?.removeChild(a),t==="preview"&&Mt(m),m}async function jt(o=[],{action:t="save"}={}){const r=qt(o,{context:"export"}),c=document.createElement("div");Object.assign(c.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),c.appendChild(r),document.body.appendChild(c);try{const n=vt()&&!Ct()?window.open("","_blank"):null;if(n)try{n.document.open(),n.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${d("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${d("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${d("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),n.document.close()}catch{}await mt();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const m=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,a=window.html2canvas;if(typeof m=="function"&&typeof a=="function"){const i=K(),C=new m({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),l={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},T=Array.from(r.querySelectorAll(".quote-page"));let E=0;const y=(p,u=250)=>{try{const f=p.getContext("2d"),{width:g,height:x}=p,s=new Uint8ClampedArray(g*4),b=h=>{const S=f.getImageData(0,h,g,1).data||s;let k=0;for(let w=0;w<g;w+=1){const q=w*4,_=S[q],I=S[q+1],F=S[q+2];if((_<u||I<u||F<u)&&(k+=1,k>Math.max(2,Math.ceil(g*.003))))return!1}return!0};let v=0;for(let h=0;h<x;h+=2)if(!b(h)){v=h;break}return v}catch{return 0}},P=(p,u=245)=>{try{const f=p.getContext("2d"),{width:g,height:x}=p,s=Math.floor(g*.55),b=Math.max(10,g-s),v=Math.max(3,Math.ceil(b*.015));for(let h=0;h<x;h+=2){const S=f.getImageData(s,h,b,1).data;let k=0;for(let w=0;w<b;w+=1){const q=w*4,_=S[q],I=S[q+1],F=S[q+2];if((_<u||I<u||F<u)&&(k+=1,k>=v))return h}}return 0}catch{return 0}},M=(p,u=250)=>{try{const f=p.getContext("2d"),{width:g,height:x}=p,s=v=>{const h=f.getImageData(0,v,g,1).data;let S=0;for(let k=0;k<g;k+=1){const w=k*4,q=h[w],_=h[w+1],I=h[w+2];if((q<u||_<u||I<u)&&(S+=1,S>Math.max(2,Math.ceil(g*.003))))return!1}return!0};let b=0;for(let v=x-1;v>=0;v-=2)if(!s(v)){b=x-1-v;break}return b}catch{return 0}},$=(p,u,f)=>{try{const{width:g,height:x}=p,s=Math.max(0,Math.min(x-1,Math.round(u))),b=Math.max(0,Math.min(x-s,Math.round(f))),v=Math.max(1,x-s-b);if(s===0&&b===0)return p;const h=document.createElement("canvas");return h.width=g,h.height=v,h.getContext("2d").drawImage(p,0,-s),h}catch{return p}};for(let p=0;p<T.length;p+=1){const u=T[p],f=u.ownerDocument||document,g=f.createElement("div");Object.assign(g.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const x=f.createElement("div");x.id="quotation-pdf-root",x.setAttribute("data-quote-render-context","export"),x.style.width=`${N}px`,x.style.maxWidth=`${N}px`,x.style.minWidth=`${N}px`,x.style.background="#ffffff";const s=u.cloneNode(!0);s.style.width=`${N}px`,s.style.maxWidth=`${N}px`,s.style.minWidth=`${N}px`,s.style.height=`${j}px`,s.style.maxHeight=`${j}px`,s.style.minHeight=`${j}px`,s.style.position="relative",s.style.background="#ffffff",s.style.overflow="hidden";try{const W=s.querySelector(".rpt-header")||s.firstElementChild;if(W){const rt=W.getBoundingClientRect(),at=s.getBoundingClientRect(),nt=Math.max(0,rt.top-at.top),st=(s.classList.contains("quote-page--primary")?6:4)*A,X=nt-st;X>0&&(s.style.transform=`translateY(${-X}px)`)}}catch{}x.appendChild(s),g.appendChild(x),f.body.appendChild(g);let b;try{b=await a(s,{...l,scrollX:0,scrollY:0,windowWidth:N,windowHeight:j})}finally{g.parentNode?.removeChild(g)}if(!b)continue;const v=y(b,246),h=P(b,244),S=Math.max(v,h),k=M(b,246),w=$(b,S,k),q=Math.max(.9,Math.min(1,i.scale||1)),_=J*q,I=w.height/w.width*_;let F=Number(i.rightMm)||0;const Q=u.classList.contains("quote-page--primary")?6:4,Z=P(w,244),tt=_/w.width,et=Z*tt;let H=(Number(i.topMm)||0)+Q-et;H<-60&&(H=-60);const ot=w.toDataURL("image/jpeg",.95);E>0&&C.addPage(),C.addImage(ot,"JPEG",F,H,_,I,`page-${E+1}`,"FAST"),E+=1,await new Promise(W=>requestAnimationFrame(W))}if(E===0)throw new Error("PDF generation produced no pages");if(t==="print"){const p=C.output("bloburl");if(n)try{n.location.href=p}catch{}else await new Promise(u=>{const f=document.createElement("iframe");Object.assign(f.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),f.onload=()=>{try{f.contentWindow?.focus(),f.contentWindow?.print()}catch{}setTimeout(()=>{f.remove(),u()},700)},f.src=p,document.body.appendChild(f)})}else C.save("reservations-report.pdf")}else{const i=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const C=await i.get("pdf").then(R=>R.output("bloburl"));await new Promise(R=>{const l=document.createElement("iframe");Object.assign(l.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),l.onload=()=>{try{l.contentWindow?.focus(),l.contentWindow?.print()}catch{}setTimeout(()=>{l.remove(),R()},700)},l.src=C,document.body.appendChild(l)})}else await i.save("reservations-report.pdf")}}finally{c.remove()}}export{qt as buildReportsPdfPages,jt as exportReportsPdf};
