const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./print.DhOIqY7E.js","./calculations.D49aCgrQ.js","./reservationsService.DNivvkEg.js","./auth.BAlKESmj.js","./auth.DVkqRmLm.css","./state.DTH-ciAY.js","./dashboard.BfwBmcFP.js","./modals.CYAagKC6.js","./projectsService.C6TBOvj1.js","./uiBridge.Di_bWTlt.js","./controller.BWuNcDzb.js","./reservationsActions.DopTzUPD.js","./quotePdf.WC1ebubv.js","./canvasColorUtils.CviLtv6S.js","./customers.DdP3kelG.js","./dashboardShell.DF2kUed9.js"])))=>i.map(i=>d[i]);
import{s as _a,f as Ta,e as Pr,u as Ir,j as Bt,t as O,p as wt,b as Lt,q as La,a as Pa,m as Ia,c as Na,i as Ba,d as Ma,n as Qt}from"./auth.BAlKESmj.js";import"./dashboard.BfwBmcFP.js";import{o as Be,s as Ra,c as ka,r as Nr,i as Da,b as qa,a as ja,d as Fa,e as $a,f as Oa,g as Ha,h as za,j as Ua,k as Wa,l as Va,n as Br,p as xn,q as Xa,t as ze,u as Ya,v as Ga,w as Ka,m as Za}from"./modals.CYAagKC6.js";import"./customers.DdP3kelG.js";import{h as we,i as On,j as Hn,k as Ja,r as Qa}from"./state.DTH-ciAY.js";import{a as to,s as eo,g as no}from"./controller.BWuNcDzb.js";import{i as ro}from"./dashboardShell.DF2kUed9.js";import{d as Q,s as it,r as ie,a as de,u as Ae,P as En,b as Cn,c as zn,g as sn,h as cn,i as Un,e as Mr}from"./reservationsActions.DopTzUPD.js";import{refreshProjectsFromApi as _e,getProjectsState as ue,ensureProjectsLoaded as ao,isApiError as Rr}from"./projectsService.C6TBOvj1.js";import{_ as Wn}from"./uiBridge.Di_bWTlt.js";import{g as Sn,r as kr,d as ve}from"./reservationsService.DNivvkEg.js";import{l as Dr,e as oo,a as so,c as co}from"./calculations.D49aCgrQ.js";import"./canvasColorUtils.CviLtv6S.js";import"./quotePdf.WC1ebubv.js";let Vn=null;function lo(t){t&&qr()!==t&&Ir({[En]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function qr(){return Pr()?.[En]||""}function An(t){t&&qe()!==t&&Ir({[Cn]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function qe(){return Pr()?.[Cn]||""}function io(t){if(!t)return"";const e=t.trim();return e?Object.values(zn).includes(e)?e:zn[e]||"":""}function jr(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=io(e);if(n)return n}}catch{}return""}function Fr(t,e){!t||!Q.tabPanes||!Q.tabButtons||(Q.tabButtons.forEach(n=>{const r=n===e;n.classList.toggle("active",r),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",r)}),Q.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&lo(t))}function uo(){if(!Q.tabButtons||!Q.tabButtons.length)return;Q.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",r=>{r.preventDefault();const a=n.dataset.tabTarget;a&&(Fr(a,n),a==="projects-section"&&(it.filters.search="",Q.search&&(Q.search.value=""),ie(),de(),Ae()))}),n.dataset.tabListenerAttached="true")});const t=qr(),e=t&&Q.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}async function Ue(t,e){if(!(!t||!Q.projectSubTabButtons||!Q.projectSubTabPanes)&&(Q.projectSubTabButtons.forEach(n=>{const r=n===e;n.classList.toggle("active",r),n.classList.contains("tab")&&n.classList.toggle("tab-active",r)}),Q.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}),t==="projects-list-tab"))try{(!Array.isArray(it.projects)||it.projects.length===0)&&await _e(),ie(),de(),Ae()}catch(n){console.warn("[projects] Failed to render list after sub-tab switch",n)}}function po(){!Q.projectSubTabButtons||!Q.projectSubTabButtons.length||(Q.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",async e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(await Ue(n,t),An(n))}),t.dataset.tabListenerAttached="true")}),mo())}function mo(){const e=jr()||qe();if(!e)return;const n=Q.projectSubTabButtons?.[0],r=Q.projectSubTabButtons?.find(s=>s.dataset.projectSubtabTarget===e)||n,a=r?.dataset.projectSubtabTarget;a&&(e!==qe()&&An(a),Ue(a,r))}function ho(){return Q.tabButtons?Q.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Xn(t={}){if(t){if(Q.tabButtons&&Q.tabButtons.length){const n=Q.tabButtons.find(a=>a.classList.contains("active"))?.dataset.tabTarget||"",r=t[En];if(r&&r!==n){const a=Q.tabButtons.find(s=>s.dataset.tabTarget===r);a&&Fr(r,a)}}if(Q.projectSubTabButtons&&Q.projectSubTabButtons.length&&ho()){const n=Q.projectSubTabButtons.find(a=>a.classList.contains("active"))?.dataset.projectSubtabTarget||"",r=t[Cn];if(r&&r!==n){const a=Q.projectSubTabButtons.find(s=>s.dataset.projectSubtabTarget===r);a&&Ue(r,a)}}}}function fo(){Vn||(Vn=_a(t=>{Xn(t)})),Ta().then(t=>{Xn(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function _n(t){if(typeof window>"u")return null;try{const r=new URLSearchParams(window.location.search||"").get(t);if(r)return r}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const r=new URLSearchParams(e).get(t);if(r)return r}catch{}return null}function yo(){return _n(sn)}function go(){return _n(cn)}function bo(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[sn,cn,"linked"].forEach(o=>{t.has(o)&&(t.delete(o),n=!0)});let r=e,a=!1;if(e)try{const o=new URLSearchParams(e);let u=!1;[sn,cn,"linked"].forEach(d=>{o.has(d)&&(o.delete(d),u=!0)}),u&&(r=o.toString(),a=!0)}catch{}if(!n&&!a)return;const s=window.location.pathname,c=t.toString(),i=`${s}${c?`?${c}`:""}${r?`#${r}`:""}`;window.history.replaceState({},"",i)}catch{}}function wo(){const t=yo(),e=go(),n=_n("linked");t&&(it.pendingProjectDetailId=t),e&&(it.pendingProjectEditId=e,it.pendingProjectDetailId||(it.pendingProjectDetailId=e)),n!=null&&String(n)!==""&&String(n)!=="0"&&String(n).toLowerCase()!=="false"&&(it.pendingLinkedToast=!0),(t||e)&&bo()}function vo(){if(!it.pendingProjectDetailId)return;const t=it.pendingProjectDetailId,e=String(t),n=it.projects.find(a=>[a?.id,a?.projectId,a?.project_id].some(c=>c!=null&&String(c)===e));if(!n)return;it.pendingProjectDetailId=null;const r=n?.id??n?.projectId??n?.project_id??e;if(Be(r),it.pendingLinkedToast){it.pendingLinkedToast=!1;try{Bt(O("projects.toast.linkedReservationCreated","✅ تم ربط الحجز بالمشروع"))}catch{}}if(it.pendingProjectEditId!=null){const a=String(it.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(c=>c!=null&&String(c)===a)&&(it.pendingProjectEditId=null,setTimeout(()=>Ra(n),0))}}let Ke=null;function Tn(){return typeof window<"u"&&window.XLSX&&window.XLSX.utils?Promise.resolve(window.XLSX):(Ke||(Ke=Dr("https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js").then(()=>window.XLSX)),Ke)}function ae(t){const e=String(t||"").replace("#","");return e.length===3?e.split("").map(n=>n+n).join("").toUpperCase():e.slice(0,6).toUpperCase()}function je(t="#9CA3AF"){const e={rgb:ae(t)};return{top:{style:"thin",color:e},right:{style:"thin",color:e},bottom:{style:"thin",color:e},left:{style:"thin",color:e}}}function Yn(t){const e=Array.from(t.querySelectorAll("tr")),n=[];return e.forEach((r,a)=>{const s=Array.from(r.children),c=[];s.forEach(i=>{const o=(i.tagName||"").toLowerCase(),u=(i.textContent||"").replace(/\u00A0/g," ").trim(),l=o==="th"||i.classList.contains("cs-crew-title")||i.classList.contains("cs-cast-title")?{font:{bold:!0,color:{rgb:ae("#FFFFFF")}},fill:{patternType:"solid",fgColor:{rgb:ae("#2563EB")}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:je("#9CA3AF")}:{alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:je("#CBD5E1")};c.push({v:u,s:l})}),n.push(c)}),n}function Ln(t){t["!merges"]||(t["!merges"]=[]),t["!cols"]||(t["!cols"]=[])}function $r(t,e,n){const r=window.XLSX,a=t["!ref"];if(!a){t["!ref"]=r.utils.encode_range({s:{r:e,c:n},e:{r:e,c:n}});return}const s=r.utils.decode_range(a);e>s.e.r&&(s.e.r=e),n>s.e.c&&(s.e.c=n),e<s.s.r&&(s.s.r=e),n<s.s.c&&(s.s.c=n),t["!ref"]=r.utils.encode_range(s)}function qt(t,e,n,r,a){const c=window.XLSX.utils.encode_cell({r:e,c:n}),i=typeof r=="number"?"n":"s";t[c]={v:r??"",t:i,s:a||{}},$r(t,e,n)}function Ht(t,e,n,r,a){Ln(t),t["!merges"].push({s:{r:e,c:n},e:{r,c:a}})}function Ie(t,e,n,r,a){let s=0,c=0;for(let i=0;i<e.length;i+=1){const o=e[i]||[];c=Math.max(c,o.length);for(let u=0;u<o.length;u+=1){const d=o[u],l=d&&typeof d=="object"&&"v"in d?d.v:d,p=d&&typeof d=="object"&&d.s?d.s:a||{};qt(t,n+i,r+u,l,p)}}return s=e.length,{rows:s,cols:c}}function xo(t,e=[]){Ln(t),t["!cols"]=e.map(n=>({wch:n}))}async function Eo(t){const e=await Tn(),n=e.utils.book_new(),r={};Ln(r);const a=[5,5,25,6,5,5,6,4,4,10,8,17],s=a.reduce((_,D)=>_+D,0),c=120,i=a.map(_=>Math.max(5,Math.round(_/s*c)));xo(r,i);const o={alignment:{horizontal:"center",vertical:"center",wrapText:!0}},u={alignment:{horizontal:"left",vertical:"top",wrapText:!0}},d=je("#CBD5E1"),l=je("#9CA3AF"),p={...o,border:d},m={...u,border:d},h={font:{bold:!0,color:{rgb:ae("#FFFFFF")},sz:12},fill:{patternType:"solid",fgColor:{rgb:ae("#2563EB")}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:l},f=_=>t&&t.querySelector(_);let y=0;const x=(f(".callsheet-v1 .cs-brand")?.textContent||"").trim(),I=(f(".callsheet-v1 .cs-date")?.textContent||"").trim(),E=(f(".callsheet-v1 .cs-title")?.textContent||"CALL SHEET").trim();qt(r,y,0,x||""),Ht(r,y,0,y,11),r[e.utils.encode_cell({r:y,c:0})].s={font:{bold:!0,sz:20},...o},y+=1,qt(r,y,0,I||""),Ht(r,y,0,y,11),r[e.utils.encode_cell({r:y,c:0})].s={font:{bold:!0,sz:12},...o},y+=1,qt(r,y,0,E),Ht(r,y,0,y,11),r[e.utils.encode_cell({r:y,c:0})].s={font:{bold:!0,sz:14},...o},y+=2,r["!rows"]=r["!rows"]||[],r["!rows"][0]={hpt:26},r["!rows"][1]={hpt:18},r["!rows"][2]={hpt:20};const A=[];try{Array.from(f(".callsheet-v1 .cs-roles tbody")?.querySelectorAll("tr")||[]).forEach(_=>{const D=Array.from(_.children),H=(D[0]?.textContent||"").trim(),F=(D[1]?.textContent||"").trim();A.push([{v:H,s:{...p,font:{bold:!0}}},{v:F,s:p}])})}catch{}const g=[];try{Array.from(f(".callsheet-v1 .cs-times tbody")?.querySelectorAll("tr")||[]).forEach(_=>{const D=Array.from(_.children);g.push([{v:(D[0]?.textContent||"").trim(),s:{...p,font:{bold:!0}}},{v:(D[1]?.textContent||"").trim(),s:p}])})}catch{}const v=[];try{const _=(f(".callsheet-v1 .cs-notes-h")?.textContent||"Important Notes").trim(),D=(f(".callsheet-v1 .cs-notes")?.textContent||"").replace(/\n+/g,`
`).trim(),H=(f(".callsheet-v1 .cs-section")?.textContent||"Locations").trim(),F=(f(".callsheet-v1 .cs-locations")?.textContent||"").trim();v.push([{v:_,s:h}]),v.push([{v:D,s:m}]),v.push([{v:H,s:h}]),v.push([{v:F,s:m}])}catch{}const T=y,P=Ie(r,A,T,0,p).rows,L=Ie(r,g,T,8,p).rows;for(let _=0;_<v.length;_+=1){const D=T+_,H=v[_][0];qt(r,D,4,H.v,H.s),Ht(r,D,4,D,7)}const C=Math.max(P,v.length,L),B=(_,D,H,F)=>{const Y="medium";for(let G=_;G<=H;G+=1)for(let K=D;K<=F;K+=1){const z=e.utils.encode_cell({r:G,c:K}),V=r[z]||{v:"",t:"s",s:{}},at=V.s.border||{},st={rgb:ae("#9CA3AF")};G===_&&(at.top={style:Y,color:st}),G===H&&(at.bottom={style:Y,color:st}),K===D&&(at.left={style:Y,color:st}),K===F&&(at.right={style:Y,color:st}),V.s.border={...V.s.border,...at},r[z]=V,$r(r,G,K)}};P>0&&B(T,0,T+P-1,3),v.length>0&&B(T,4,T+v.length-1,7),L>0&&B(T,8,T+L-1,11),y=T+C+2;const R=f(".callsheet-v1 .cs-cast");if(R){const _=y;qt(r,y,0,"Cast Calls",h),Ht(r,y,0,y,11),y+=1;const D=Yn(R).slice(1),H=Ie(r,D,y,2,p);B(_,2,y+H.rows-1,9),r["!rows"][_]={hpt:22},y+=H.rows+2}const N=f(".callsheet-v1 .cs-crew");if(N){const _=y;qt(r,y,0,"Crew Call",h),Ht(r,y,0,y,11),r["!rows"][y]={hpt:22},y+=1;const D=[[0,2],[3,7],[8,10],[11,11]];["Position","Name","Phone","Time"].forEach((F,Y)=>{const[G,K]=D[Y];qt(r,y,G,F,h),K>G&&Ht(r,y,G,y,K)}),r["!rows"][y]={hpt:18},y+=1,Array.from(N.querySelectorAll("tbody tr")).forEach(F=>{const Y=Array.from(F.children);[0,1,2,3].map(K=>(Y[K]?.textContent||"").trim()).forEach((K,z)=>{const[V,at]=D[z];qt(r,y,V,K,z===1?m:p),at>V&&Ht(r,y,V,y,at)}),y+=1}),B(_,0,y-1,11),y+=2}const b=f(".callsheet-v1 .cs-schedule");if(b){const _=Yn(b),D=Ie(r,_,y,0,p);B(y,0,y+D.rows-1,11),r["!rows"][y]={hpt:18},y+=D.rows+1}e.utils.book_append_sheet(n,r,"Call Sheet");let k="CallSheet.xlsx";try{const _=(document.querySelector("#templates-save-title")?.value||"").trim();_&&(k=`${_}-CallSheet.xlsx`)}catch{}const q=e.write(n,{bookType:"xlsx",type:"array"}),M=new Blob([q],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),j=URL.createObjectURL(M),X=document.createElement("a");X.href=j,X.download=k,document.body.appendChild(X),X.click(),X.remove(),URL.revokeObjectURL(j)}function Co(t,e){try{if(!t)return;const n=(localStorage.getItem("templates.debugOverlay")||"")==="1";let r=document.getElementById("tpl-debug-overlay");if(!n){r&&r.remove();return}r||(r=document.createElement("div"),r.id="tpl-debug-overlay",Object.assign(r.style,{position:"absolute",top:"8px",left:"8px",background:"rgba(17,24,39,0.85)",color:"#fff",padding:"8px 10px",font:"12px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto",borderRadius:"8px",zIndex:"9999",maxWidth:"36vw",direction:"ltr",textAlign:"left"}),t.appendChild(r));const a=[],s=Array.isArray(e?.crewAssignments)?e.crewAssignments:[],c=Array.isArray(e?.techniciansDetails)?e.techniciansDetails:[],i=Array.isArray(e?.technicians)?e.technicians:[];a.push(`crewAssignments: ${s.length}`),a.push(`techniciansDetails: ${c.length}`),a.push(`technicians: ${i.length}`);const o=m=>m&&m.length?m[0]:null,u=m=>m&&typeof m=="object"?Object.keys(m):[],d=o(s);d&&a.push(`CA keys: ${u(d).join(", ")}`);const l=o(c);l&&a.push(`TD keys: ${u(l).join(", ")}`);const p=o(i);p&&typeof p!="string"&&a.push(`T keys: ${u(p).join(", ")}`),r.innerHTML=a.map(m=>`<div>${So(m)}</div>`).join("")}catch{}}function So(t){try{return String(t).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}catch{return String(t)}}function w(t,e={},n=[]){const r=document.createElement(t);return Object.entries(e||{}).forEach(([a,s])=>{a==="class"?r.className=s:a==="text"?r.textContent=s:a==="html"?r.innerHTML=s:r.setAttribute(a,s)}),(Array.isArray(n)?n:[n]).filter(Boolean).forEach(a=>r.appendChild(a)),r}function Or({landscape:t=!1,headerFooter:e=!1,logoUrl:n=""}={}){const a=typeof localStorage<"u"&&localStorage.getItem("templates.lang")==="ar"?"rtl":"ltr",s=w("div",{id:"templates-a4-root","data-render-context":"preview",dir:a}),c=w("div",{"data-a4-pages":""}),i=w("section",{class:`a4-page${t?" a4-page--landscape":""}${e?" a4-page--with-hf":""}`}),o=w("div",{class:"a4-inner"});if(e){const u=w("div",{class:"tpl-print-header"},[w("div",{class:"brand"},[w("img",{src:n,alt:"Logo",referrerpolicy:"no-referrer"}),w("div",{class:"brand-text",text:"Art Ratio"})]),w("div",{class:"meta"},[w("div",{text:new Date().toLocaleDateString()})])]),d=w("div",{class:"tpl-print-footer"},[w("div",{class:"footer-left",text:"art-ratio.com"}),w("div",{class:"page-num",html:"<span data-page-num>1</span> / <span data-page-count>1</span>"})]);i.appendChild(u),i.appendChild(d)}return i.appendChild(o),c.appendChild(i),s.appendChild(c),{root:s,inner:o}}function tt(t,e){try{return(typeof localStorage<"u"&&localStorage.getItem("templates.lang")==="ar"?"ar":"en")==="ar"&&e||t}catch{return t}}function ee(t,e="",n=!0){const r=w("div",{class:"cell"});r.appendChild(w("span",{class:"label",text:t}));const a=w("div",{"data-editable":n?"true":"false",contenteditable:n?"true":"false"});try{a.setAttribute("dir","auto")}catch{}return a.textContent=e||"",r.appendChild(a),r}function Hr(){try{return{url:localStorage.getItem("templates.callsheet.logo2.url")||"",s:Number(localStorage.getItem("templates.callsheet.logo2.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo2.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo2.y")||"0")||0}}catch{return{url:"",s:1,x:0,y:0}}}function Ao(t={}){try{typeof t.url=="string"&&localStorage.setItem("templates.callsheet.logo2.url",t.url),Number.isFinite(t.s)&&localStorage.setItem("templates.callsheet.logo2.s",String(t.s)),Number.isFinite(t.x)&&localStorage.setItem("templates.callsheet.logo2.x",String(t.x)),Number.isFinite(t.y)&&localStorage.setItem("templates.callsheet.logo2.y",String(t.y))}catch{}}function _o(t,e){try{if(!t||!e)return;let n=!1,r=0,a=0,s=0,c=0;const i=()=>{try{const l=e.style.transform||"",p=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(l),m=/scale\(([-\d.]+)\)/.exec(l);return{x:Number(p?.[1]||0)||0,y:Number(p?.[2]||0)||0,s:Number(m?.[1]||1)||1}}catch{return{x:0,y:0,s:1}}},o=l=>{n=!0;const p=i();s=p.x,c=p.y,r=l.clientX,a=l.clientY;try{l.preventDefault()}catch{}},u=l=>{if(!n)return;const p=l.clientX-r,m=l.clientY-a,h=Math.round(s+p),f=Math.round(c+m),y=Math.max(.3,Math.min(3,Number(Hr().s||1)));e.style.transform=`scale(${y}) translate(${h}px, ${f}px)`},d=()=>{if(!n)return;n=!1;const l=i();Ao({x:l.x,y:l.y})};e.addEventListener("pointerdown",o),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",d,{passive:!0})}catch{}}function zr(){try{return{s:Number(localStorage.getItem("templates.callsheet.logo1.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo1.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo1.y")||"0")||0,h:localStorage.getItem("templates.callsheet.logo1.h")==="1"}}catch{return{s:1,x:0,y:0,h:!1}}}function Gn(t={}){try{Number.isFinite(t.s)&&localStorage.setItem("templates.callsheet.logo1.s",String(t.s)),Number.isFinite(t.x)&&localStorage.setItem("templates.callsheet.logo1.x",String(t.x)),Number.isFinite(t.y)&&localStorage.setItem("templates.callsheet.logo1.y",String(t.y)),typeof t.h=="boolean"&&localStorage.setItem("templates.callsheet.logo1.h",t.h?"1":"0")}catch{}}function To(t,e){try{if(!t||!e)return;let n=!1,r=0,a=0,s=0,c=0;const i=()=>{try{const p=e.style.transform||"",m=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(p),h=/scale\(([-\d.]+)\)/.exec(p);return{x:Number(m?.[1]||0)||0,y:Number(m?.[2]||0)||0,s:Number(h?.[1]||1)||1}}catch{return{x:0,y:0,s:1}}},o=p=>{n=!0;const m=i();s=m.x,c=m.y,r=p.clientX,a=p.clientY;try{p.preventDefault()}catch{}},u=p=>{if(!n)return;const m=p.clientX-r,h=p.clientY-a,f=Math.round(s+m),y=Math.round(c+h),x=Math.max(.3,Math.min(3,Number(zr().s||1)));e.style.transform=`scale(${x}) translate(${f}px, ${y}px)`},d=()=>{if(!n)return;n=!1;const p=i();Gn({x:p.x,y:p.y})};e.addEventListener("pointerdown",o),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",d,{passive:!0});const l=document.getElementById("tpl-logo1-size");if(l){const p=m=>{const h=Math.max(.3,Math.min(3,Number(m||1))),f=i();try{e.style.transform=`scale(${h}) translate(${f.x}px, ${f.y}px)`}catch{}Gn({s:h})};l.addEventListener("input",m=>{p(m?.target?.value)})}}catch{}}function Ur(t,e){if(!t||!e)return;const n=(()=>{if(Array.isArray(e.crewAssignments)&&e.crewAssignments.length)return e.crewAssignments;if(Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length)return e.techniciansDetails;const s=Array.isArray(e.technicians)?e.technicians:[];if(s.length){const c=we()||[],i=new Map(c.map(u=>[String(u.id),u])),o=new Map(c.map(u=>[String((u.name||u.full_name||"").trim().toLowerCase()),u]));return s.map(u=>{if(u&&typeof u=="object"){const p=u.id??u.technicianId,m=u.name??u.full_name??u.technician_name,h=p!=null&&i.get(String(p))||(m?o.get(String(m).trim().toLowerCase()):null);return h?{technicianId:h.id,technicianName:h.name||h.full_name,technicianPhone:h.phone,technicianRole:h.role||h.specialization}:{technicianName:m||"",technicianId:p??null}}const d=String(u||"").trim(),l=i.get(d)||o.get(d.toLowerCase());return l?{technicianId:l.id,technicianName:l.name||l.full_name,technicianPhone:l.phone,technicianRole:l.role||l.specialization}:/^\d+$/.test(d)?{technicianId:d}:{technicianName:d}})}return[]})();try{if(n.length){n.forEach(o=>{try{o&&typeof o.technician=="object"&&(o.technicianId=o.technicianId??o.technician?.id??o.technician_id,o.technicianName=o.technicianName??o.technician?.name??o.technician?.full_name??o.name,o.technicianPhone=o.technicianPhone??o.technician?.phone??o.phone,o.technicianRole=o.technicianRole??o.technician?.role??o.specialization??o.role),o&&typeof o.position=="object"&&(o.positionLabel=o.positionLabel??o.position?.labelAr??o.position?.labelEn??o.position?.name??o.position_name),o.positionLabel=o.positionLabel??o.position_name??o.positionName??o.position,o.technicianPhone=o.technicianPhone??o.phone_number??o.phoneNumber??o.mobile??o.whatsapp,o.technicianName=o.technicianName??o.full_name??o.technician_name,!o.technicianName&&o.name&&(o.technicianName=o.name)}catch{}});const s=we()||[],c=new Map(s.map(o=>[String(o.id),o])),i=new Map(s.map(o=>[String((o.name||o.full_name||"").trim().toLowerCase()),o]));n.forEach(o=>{const u=o.technicianId??o.technician_id??o.id,d=o.technicianName??o.name,l=u!=null&&c.get(String(u))||(d?i.get(String(d).trim().toLowerCase()):null);l&&(!o.technicianName&&(l.name||l.full_name)&&(o.technicianName=l.name||l.full_name),!o.technicianPhone&&l.phone&&(o.technicianPhone=l.phone),!o.technicianRole&&(l.role||l.specialization)&&(o.technicianRole=l.role||l.specialization))})}}catch{}if(!n.length)return;const r=Array.from(t.querySelectorAll("tbody tr"));(s=>{const c=Math.max(0,s-r.length);for(let i=0;i<c;i+=1){const o=document.createElement("tr");for(let u=0;u<4;u+=1){const d=document.createElement("td");if(d.setAttribute("data-editable","true"),d.setAttribute("contenteditable","true"),u===2){try{d.removeAttribute("dir")}catch{}d.classList.add("dir-ltr")}o.appendChild(d)}t.tBodies[0].appendChild(o),r.push(o)}})(n.length),n.forEach((s,c)=>{const i=r[c];if(!i)return;const o=Array.from(i.children),u=Fe(s),d=s.technicianName||s.name||s.full_name||s.technician_name||"",l=s.technicianPhone||s.phone||s.phoneNumber||s.phone_number||s.mobile||s.whatsapp||"";if(o[0]&&(o[0].textContent=u||""),o[1]&&(o[1].textContent=d||""),o[2]){try{o[2].removeAttribute("dir")}catch{}o[2].classList.add("dir-ltr"),o[2].textContent=l||""}})}function ln(t){try{const e=document.querySelector("#templates-a4-root .callsheet-v1 table.cs-crew");if(!e||!t)return;const n=Array.from(e.querySelectorAll("tbody tr")),r=n.slice(0,Math.min(n.length,6));let a=0,s=0;if(r.forEach(i=>{Array.from(i.children).slice(0,3).forEach(u=>{s+=1,(u.textContent||"").trim()&&(a+=1)})}),(s>0?a/s:0)<=.15){Ur(e,t);return}try{const i=(()=>{if(Array.isArray(t.crewAssignments)&&t.crewAssignments.length)return t.crewAssignments;if(Array.isArray(t.techniciansDetails)&&t.techniciansDetails.length)return t.techniciansDetails;const u=Array.isArray(t.technicians)?t.technicians:[];if(u.length){const d=new Map((we()||[]).map(l=>[String(l.id),l]));return u.map(l=>{const p=d.get(String(l));return p?{technicianId:p.id,technicianName:p.name||p.full_name,technicianPhone:p.phone,technicianRole:p.role||p.specialization}:{technicianId:l}})}return[]})(),o=new Map(i.map(u=>[String(u.technicianName||u.name||u.full_name||"").trim().toLowerCase(),u]));n.forEach(u=>{const d=Array.from(u.children);if(!(d[1]&&(d[1].textContent||"").trim()))return;const p=String(d[1].textContent||"").trim().toLowerCase(),m=o.get(p);if(!m)return;const h=Fe(m),f=m.technicianPhone||m.phone||m.phoneNumber||m.phone_number||m.mobile||m.whatsapp||"";if(d[0]&&!(d[0].textContent||"").trim()&&(d[0].textContent=h||""),d[2]&&!(d[2].textContent||"").trim()){try{d[2].removeAttribute("dir")}catch{}d[2].classList.add("dir-ltr"),d[2].textContent=f||""}})}catch{}}catch{}}function Lo(t,e,n={}){const{headerFooter:r=!1,logoUrl:a=""}=n||{},{root:s,inner:c}=Or({landscape:!0,headerFooter:r,logoUrl:a});try{s.setAttribute("dir","ltr")}catch{}const i=s.querySelector("[data-a4-pages]"),o=e?.[0]||null,u=()=>{const $=w("section",{class:"a4-page a4-page--landscape"}),J=w("div",{class:"a4-inner"}),ct=w("div",{class:"callsheet-v1"});return $.appendChild(J),J.appendChild(ct),i.appendChild($),{page:$,innerPage:J,wrapPage:ct}},d=w("div",{class:"callsheet-v1"}),l=w("div",{class:"cs-header"}),p=w("div",{class:"cs-logo cs-logo--left"}),m=w("img",{src:a||"",alt:"Art Ratio Logo",draggable:"false",referrerpolicy:"no-referrer",crossorigin:"anonymous"});try{m.style.removeProperty("width")}catch{}try{const $=zr(),J=Number($.x||0)||0,ct=Number($.y||0)||0,W=Math.max(.3,Math.min(3,Number($.s||1)));if(m.style.transform=`scale(${W}) translate(${J}px, ${ct}px)`,$.h)try{p.setAttribute("data-hidden","1"),p.style.visibility="hidden"}catch{}}catch{}p.appendChild(m),l.appendChild(p);const h=w("div",{class:"cs-titlebox"},[w("div",{class:"cs-brand","data-editable":"true",contenteditable:"true",text:t?.title||"WKK."}),w("div",{class:"cs-date","data-editable":"true",contenteditable:"true",text:new Date().toLocaleDateString("en-GB")}),w("div",{class:"cs-title",text:"CALL SHEET"})]);l.appendChild(h);const f=Hr(),y=w("div",{class:"cs-logo cs-logo--right","data-empty":f.url?"0":"1"}),x=w("img",{alt:"Client Logo",draggable:"false",referrerpolicy:"no-referrer",crossorigin:"anonymous"});try{x.style.removeProperty("width")}catch{}f.url&&x.setAttribute("src",f.url);try{const $=Number(f.x||0)||0,J=Number(f.y||0)||0,ct=Math.max(.3,Math.min(3,Number(f.s||1)));x.style.transform=`scale(${ct}) translate(${$}px, ${J}px)`}catch{}y.appendChild(x),y.appendChild(w("div",{class:"cs-logo__resize",title:"resize"})),l.appendChild(y),d.appendChild(l);const I=w("table",{class:"cs-info"}),E=w("tbody"),A=(...$)=>{const J=w("tr");return $.forEach(ct=>J.appendChild(ct)),J},g=$=>w("td",{class:"cs-label",text:$}),v=($="")=>w("td",{"data-editable":"true",contenteditable:"true",text:$}),T=w("table",{class:"cs-roles"}),P=w("tbody");["Producer","Director","DOP","Production Manager","Assistant Director"].forEach($=>{const J=w("tr");J.appendChild(g(`${$}:`)),J.appendChild(v("")),P.appendChild(J)}),T.appendChild(P);try{o&&Io(T,o)}catch{}const L=w("table",{class:"cs-center"}),C=w("tbody");C.appendChild(A(w("td",{class:"cs-notes-h",text:"Important Notes"}))),C.appendChild(A(w("td",{class:"cs-notes","data-editable":"true",contenteditable:"true",html:"Please be on Time<br>Have Fun and make Art<br>If you need any help please contact the AD or Production manager"}))),C.appendChild(A(w("td",{class:"cs-section",text:"Locations"}))),C.appendChild(A(w("td",{class:"cs-locations","data-editable":"true",contenteditable:"true",text:""}))),L.appendChild(C);const B=w("table",{class:"cs-times"}),R=w("tbody");[["Call Time",""],["Client",t?.clientCompany||t?.clientName||t?.client||""],["Ready to shoot",""],["Lunch",""],["Est. Wrap",""]].forEach(([$,J])=>{const ct=w("tr");ct.appendChild(g(`${$}:`)),ct.appendChild(v(J)),R.appendChild(ct)});const N=w("tr");N.appendChild(g(""));const b=w("td"),k=w("div",{class:"cs-weather"},[w("div",{class:"cs-city","data-editable":"true",contenteditable:"true",text:"jeddah"}),w("div",{class:"cs-temp","data-editable":"true",contenteditable:"true",text:"38°C - 25°C"}),w("div",{class:"cs-wind","data-editable":"true",contenteditable:"true",text:"Wind: 16 km/h"}),w("div",{class:"cs-rain","data-editable":"true",contenteditable:"true",text:"Chance of rain : 0%"})]);b.appendChild(k),N.appendChild(b),R.appendChild(N),B.appendChild(R),E.appendChild(A(w("td",{},[T]),w("td",{},[L]),w("td",{},[B]))),I.appendChild(E),d.appendChild(I);const q=w("table",{class:"cs-cast"}),M=w("tbody"),j=w("colgroup");for(let $=0;$<8;$+=1)j.appendChild(w("col",{style:"width:12.5%"}));q.appendChild(j),M.appendChild(A(w("td",{class:"cs-cast-title",text:"Cast Calls",colspan:"8",style:"background:#2563EB !important;color:#ffffff !important;"})));const X=w("tr"),_=w("tr");for(let $=0;$<8;$+=1)X.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),_.appendChild(w("td",{"data-editable":"true",contenteditable:"true"}));M.appendChild(X),M.appendChild(_),q.appendChild(M),d.appendChild(q),c.appendChild(d);const{innerPage:D,wrapPage:H}=u(),F=w("table",{class:"tpl-table cs-crew","data-editable-table":"crew",style:"width:90% !important; margin-left:auto !important; margin-right:auto !important;"}),Y=[30,34,20,16],G=w("colgroup");Y.forEach($=>G.appendChild(w("col",{style:`width:${$}%`}))),F.appendChild(G);const K=w("thead"),z=w("tr");z.appendChild(w("th",{colspan:String(Y.length),class:"cs-crew-title",text:"Crew Call"})),K.appendChild(z);const V=w("tr");["Position","Name","Phone","Time"].forEach($=>V.appendChild(w("th",{text:$,class:"cs-crew-head"}))),K.appendChild(V),F.appendChild(K);const at=w("tbody");for(let $=0;$<18;$+=1){const J=w("tr");J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),J.appendChild(w("td",{"data-editable":"true",contenteditable:"true",class:"dir-ltr"})),J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),at.appendChild(J)}F.appendChild(at),H.appendChild(F),D.appendChild(H);const{innerPage:st,wrapPage:mt}=u();try{st.style.paddingLeft="0mm",st.style.paddingRight="0mm"}catch{}const _t=w("table",{class:"tpl-table cs-schedule","data-editable-table":"callsheet",style:"width:calc(100% + 16mm) !important; margin-left:-8mm !important; margin-right:-8mm !important;"}),Pt=[5,5,21,6,7,5,8,4,4,10,8,17],St=w("colgroup");Pt.forEach($=>St.appendChild(w("col",{style:`width:${$}%`}))),_t.appendChild(St);const te=["Shot #","Time (Duration)","Description","Movement","Rig","Lens","Location","I/E","D/N","Sound","Cast","Notes / Props"],$t=w("thead"),Te=w("tr");Te.appendChild(w("th",{colspan:String(Pt.length),class:"cs-schedule-title",text:"Shot List"})),$t.appendChild(Te);const Dt=w("tr");te.forEach(($,J)=>Dt.appendChild(w("th",{text:$,class:"cs-schedule-head",style:`width:${Pt[J]}%`}))),$t.appendChild(Dt),_t.appendChild($t);const Ot=w("tbody"),Le=w("tr",{class:"cs-row-note"});Le.appendChild(w("td",{colspan:"12","data-editable":"true",contenteditable:"true",text:"breakfast(30m)"})),Ot.appendChild(Le);const Pe=w("tr",{class:"cs-row-strong"});Pe.appendChild(w("td",{colspan:"12","data-editable":"true",contenteditable:"true",text:"light, camera and art Prep (1H)"})),Ot.appendChild(Pe);for(let $=0;$<4;$+=1){const J=w("tr");for(let ct=0;ct<12;ct+=1)J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"}));Ot.appendChild(J)}_t.appendChild(Ot),mt.appendChild(_t),st.appendChild(mt);try{To(p,m)}catch{}try{_o(y,x)}catch{}return s}function Fe(t={}){try{const n=typeof wt=="function"?wt():"ar",r=i=>n==="ar"?i.labelAr||i.labelEn||i.name||"":i.labelEn||i.labelAr||i.name||"",a=typeof On=="function"?On()||[]:[],s=t.positionLabel||t.positionLabelAr||t.positionLabelEn||t.position_name||t.position_label||"";if(s&&!/^position[-_]/i.test(String(s)))return String(s);if(t.positionId!=null&&a.length){const i=a.find(o=>String(o.id)===String(t.positionId));if(i)return r(i)}const c=[t.positionKey,t.position_key,t.positionName,t.position_name,t.position,t.assignedPosition,t.assigned_position,t.reservationPosition,t.reservation_position,t.crewPosition,t.crew_position,t.roleInReservation,t.role_in_reservation,t.technicianRole,t.role,t.specialization].map(i=>i!=null?String(i).trim():"").filter(Boolean);for(const i of c){let o=null;if(typeof Hn=="function"&&(o=Hn(i)),!o&&a.length){const u=i.toLowerCase();o=a.find(d=>[d.name,d.labelAr,d.labelEn].filter(Boolean).map(l=>String(l).toLowerCase()).includes(u))||null}if(o)return r(o);if(!/^position[-_]/i.test(i))return i}}catch{}const e=t.positionLabel||t.positionLabelAr||t.positionLabelEn||t.position_name||t.position_label||t.technicianRole||t.role||t.specialization||"";return/^position[-_]/i.test(String(e))?"":String(e)}function Po(t){const e=we()||[],n=new Map(e.map(c=>[String(c.id),c])),r=new Map(e.map(c=>[String((c.name||c.full_name||"").trim().toLowerCase()),c])),s=(()=>{if(Array.isArray(t?.crewAssignments)&&t.crewAssignments.length)return t.crewAssignments;if(Array.isArray(t?.techniciansDetails)&&t.techniciansDetails.length)return t.techniciansDetails;const c=Array.isArray(t?.technicians)?t.technicians:[];return c.length?c.map(i=>({technicianId:i})):[]})().map(c=>({...c}));return s.forEach(c=>{try{c&&typeof c.technician=="object"&&(c.technicianId=c.technicianId??c.technician?.id??c.technician_id,c.technicianName=c.technicianName??c.technician?.name??c.technician?.full_name??c.name,c.technicianPhone=c.technicianPhone??c.technician?.phone??c.phone,c.technicianRole=c.technicianRole??c.technician?.role??c.specialization??c.role),c&&typeof c.position=="object"&&(c.positionLabel=c.positionLabel??c.position?.labelAr??c.position?.labelEn??c.position?.name??c.position_name),c.positionLabel=c.positionLabel??c.position_name??c.positionName??c.position,c.technicianPhone=c.technicianPhone??c.phone_number??c.phoneNumber??c.mobile??c.whatsapp,c.technicianName=c.technicianName??c.full_name??c.technician_name,!c.technicianName&&c.name&&(c.technicianName=c.name)}catch{}}),s.forEach(c=>{const i=c.technicianId??c.technician_id??c.id,o=c.technicianName??c.name,u=i!=null&&n.get(String(i))||(o?r.get(String(o).trim().toLowerCase()):null);u&&(!c.technicianName&&(u.name||u.full_name)&&(c.technicianName=u.name||u.full_name),!c.technicianPhone&&u.phone&&(c.technicianPhone=u.phone),!c.technicianRole&&(u.role||u.specialization)&&(c.technicianRole=u.role||u.specialization))}),s}function Io(t,e){if(!t||!e)return;const n=Array.from(t.querySelectorAll("tbody tr")),r=d=>String(d||"").toLowerCase().replace(/[\u064B-\u0652]/g,"").replace(/[\.\-_/]+/g," ").replace(/\s+/g," ").trim(),a=d=>{const l=r(d);if(!l)return!1;const p=l.replace(/\s+/g,"");return!!(["assistant director","first assistant director","second assistant director","1st ad","1 ad","first ad","2nd ad","second ad","asst dir","dir asst","assistant dir","dir assistant","ad","مساعد مخرج","مساعد المخرج","مساعد اخراج","مساعد إخراج","مساعد مخرج اول","مساعد مخرج أول","مساعد مخرج ثاني"].map(r).includes(l)||l.includes("assistant director")||l.includes("dir asst")||l.includes("asst dir")||l.includes("assistant dir")||l.includes("dir assistant")||l.includes("مساعد مخرج")||l.includes("مساعد اخراج")||l.includes("مساعد إخراج")||/^ad$/.test(l)||/^(1st\s*ad|first\s*ad|ad\s*1)$/i.test(l)||/^(2nd\s*ad|second\s*ad|ad\s*2)$/i.test(l)||/^ad$/.test(p))},s=d=>{const l=String(d||"").toLowerCase();return a(l)?"ad1":/\bproducer\b/.test(l)||/منتج/.test(l)?"producer":/\bdop\b/.test(l)||/director of photography/i.test(l)||/cinematograph/.test(l)||/مدير تصوير/.test(l)?"dop":/production manager/i.test(l)||/مدير انتاج/.test(l)||/مدير إنتاج/.test(l)?"pm":/\bdirector\b/.test(l)&&!/assistant/.test(l)||/مخرج/.test(l)&&!/مساعد/.test(l)?"director":""},c=d=>n.find(l=>s(l?.children?.[0]?.textContent)===d)||null,i={producer:c("producer")?.children?.[1]||null,director:c("director")?.children?.[1]||null,dop:c("dop")?.children?.[1]||null,pm:c("pm")?.children?.[1]||null,ad1:c("ad1")?.children?.[1]||null},o=new Set,u=Po(e);if(u.forEach(d=>{const l=d.technicianName||d.name||d.full_name||d.technician_name||"";if(!l)return;const p=Fe(d),m=String(p||"").trim().toLowerCase();if(m){if(!o.has("ad1")&&i.ad1&&a(m)){i.ad1.textContent=l,o.add("ad1");return}if(!o.has("pm")&&i.pm&&(/production manager/i.test(m)||/مدير انتاج/.test(m)||/مدير إنتاج/.test(m))){i.pm.textContent=l,o.add("pm");return}if(!o.has("dop")&&i.dop&&(/\bdop\b/.test(m)||/director of photography/i.test(m)||/cinematograph/.test(m)||/مدير تصوير/.test(m))){i.dop.textContent=l,o.add("dop");return}if(!o.has("director")&&i.director&&(/\bdirector\b/.test(m)&&!/assistant/.test(m)||/مخرج/.test(m)&&!/مساعد/.test(m))){i.director.textContent=l,o.add("director");return}if(!o.has("producer")&&i.producer&&(/\bproducer\b/.test(m)||/منتج/.test(m))){i.producer.textContent=l,o.add("producer");return}}}),i.ad1&&!o.has("ad1")&&(!i.ad1.textContent||!i.ad1.textContent.trim())){const d=u.find(l=>{const p=Fe(l)||"";return a(p)});if(d){const l=d.technicianName||d.name||d.full_name||d.technician_name||"";l&&(i.ad1.textContent=l,o.add("ad1"))}}}function No(t,e,n={}){const{headerFooter:r=!1,logoUrl:a=""}=n||{},{root:s,inner:c}=Or({landscape:!1,headerFooter:r,logoUrl:a});try{s.setAttribute("data-exp-mode","multipage")}catch{}const i=w("div",{class:"exp-masthead"},[w("div",{class:"brand-logo"},[w("img",{src:a,alt:"Logo",referrerpolicy:"no-referrer"})]),w("div",{class:"brand-info"},[w("div",{class:"text",text:n.companyName||t?.clientCompany||t?.title||"Company"}),w("div",{class:"meta"},[w("span",{class:"line",text:`${tt("CR","السجل التجاري")}: ${n.companyCR||""}`}),w("span",{class:"line",text:`${tt("Media License","ترخيص إعلامي")}: ${n.companyLicense||""}`})])]),(()=>{const x=document.createElement("div");return x.className="title-wrap",x.appendChild(w("div",{class:"title",text:tt("Expenses Sheet","ورقة المصاريف")})),x.appendChild(w("div",{class:"date",text:`Date: ${new Date().toISOString().slice(0,10)}`})),x})()]);c.appendChild(i);const o=w("div",{class:"tpl-meta"});o.appendChild(ee(tt("Client","العميل"),t?.clientCompany||"")),o.appendChild(ee(tt("Project Title","اسم المشروع"),t?.title||"")),o.appendChild(ee(tt("Budget Date","تاريخ الميزانية"),new Date().toISOString().slice(0,10))),o.appendChild(ee(tt("Prepared by","إعداد"),""));const u=Array.from(new Set((e||[]).map(x=>(x?.location||"").trim()).filter(Boolean))).join(", ");o.appendChild(ee(tt("Locations","المواقع"),u)),o.appendChild(ee(tt("Shoot Days","أيام التصوير"),"")),c.appendChild(o);const d=w("div",{id:"expenses-top-sheet"}),l=(x,I)=>w("tr",{"data-top-row":x},[w("td",{class:"code",text:x}),w("td",{class:"exp-top-label",text:I}),w("td",{"data-top-count":x,text:""}),w("td",{"data-top-total":x,text:""})]),p=(x,I,E)=>{const A=w("table",{class:"exp-table exp-top-table dir-ltr"}),g=w("caption",{class:"exp-group-cap"},[w("div",{class:"exp-group-bar",text:x})]);A.appendChild(g);const v=w("thead"),T=w("tr");["CODE","DESCRIPTION","COUNT","TOTAL"].forEach((L,C)=>T.appendChild(w("th",{class:["exp-top-col-code","exp-top-col-label","exp-top-col-count","exp-top-col-total"][C],text:tt(L,C===1?"الوصف":C===2?"العدد":"الإجمالي")}))),v.appendChild(T),A.appendChild(v);const P=w("tbody");if(I.forEach(([L,C])=>P.appendChild(l(L,C))),E){const L=E==="atl"?tt("Total Above the Line","مجموع فوق الخط"):E==="prod"?tt("Total Production","مجموع الإنتاج"):tt("Total Post Production","مجموع ما بعد الإنتاج"),C=w("tr",{"data-top-group-total-row":E},[w("td",{colspan:"3",class:"exp-top-total-label",text:L}),w("td",{"data-top-total-group":E,text:"0"})]);P.appendChild(C)}return A.appendChild(P),A};d.appendChild(p(tt("ABOVE THE LINE","فوق الخط"),[["01-00","PRODUCERS UNIT"],["02-00","DIRECTOR & STAFF"],["03-00","CAST"]],"atl")),d.appendChild(p(tt("PRODUCTION EXPENSES","مصاريف الإنتاج"),[["04-00","PRODUCTION STAFF"],["05-00","SET DESIGN"],["06-00","SET CONSTRUCTION"]],"prod")),d.appendChild(p(tt("POST-PRODUCTION EXPENSES","مصاريف ما بعد الإنتاج"),[["13-00","FILM EDITING"],["14-00","VOICE OVER"]],"post"));const m=w("table",{class:"exp-table exp-top-table dir-ltr"}),h=document.createElement("colgroup");["16%","54%","10%","20%"].forEach(x=>h.appendChild(w("col",{style:`width:${x}`}))),m.appendChild(h);const f=document.createElement("tbody");f.appendChild(w("tr",{class:"exp-grand-total-row"},[w("td",{colspan:"3",class:"exp-grand-total-label",text:tt("GRAND TOTAL","الإجمالي الكلي")}),w("td",{"data-top-grand":"1",class:"exp-grand-total-value",text:"0"})])),m.appendChild(f),d.appendChild(m),c.appendChild(d);const y=(x,I,E=[])=>{const A=w("table",{class:"exp-table exp-details dir-ltr","data-editable-table":"expenses","data-group":x}),g=w("colgroup");["12%","38%","12%","10%","10%","8%","10%"].forEach(L=>g.appendChild(w("col",{style:`width:${L}`}))),A.appendChild(g);const v=w("thead"),T=w("tr");[{text:tt("CODE","الكود")},{text:tt("DESCRIPTION","الوصف")},{text:tt("RATE","السعر")},{text:tt("QTY","الكمية")},{text:tt("DAYS","الأيام")},{text:tt("PAID","المدفوع")},{text:tt("TOTAL","الإجمالي")}].forEach(L=>T.appendChild(w("th",{text:L.text}))),v.appendChild(T),A.appendChild(v);const P=w("tbody");P.appendChild(w("tr",{"data-group-bar":"true","data-group-title":"true"},[w("th",{colspan:"7"},[w("div",{class:`exp-group-bar exp-group-bar--${x}`,text:I})])])),E.forEach((L,C)=>{P.appendChild(w("tr",{"data-subgroup-header":"true","data-subgroup":L.code},[w("td",{class:"code",text:L.code}),w("td",{class:"label",text:L.label}),w("td",{class:"exp-subheader-fill",colspan:"5",text:""})])),P.appendChild(w("tr",{"data-subgroup-marker":L.code,"data-parent-group":x,style:"display:none;"},[w("td",{colspan:"7",text:""})]));for(let B=0;B<(L.rows||2);B+=1){const R=w("tr",{"data-row":"item"}),N={"data-editable":"true",contenteditable:"true",autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false"},b={...N,"data-num":"1",inputmode:"decimal"};R.appendChild(w("td",N)),R.appendChild(w("td",N)),R.appendChild(w("td",b)),R.appendChild(w("td",b)),R.appendChild(w("td",b)),R.appendChild(w("td",b)),R.appendChild(w("td",{"data-num":"1"})),P.appendChild(R)}P.appendChild(w("tr",{"data-subgroup-subtotal":"true"},[w("td",{colspan:"6",text:tt("SUBTOTAL","المجموع الفرعي")}),w("td",{"data-subtotal":L.code,"data-num":"1",text:"0"})]))}),A.appendChild(P),c.appendChild(A)};return y("atl",tt("ABOVE THE LINE","فوق الخط"),[{code:"01-00",label:"PRODUCERS UNIT",rows:2},{code:"02-00",label:"DIRECTOR & STAFF",rows:2},{code:"03-00",label:"CAST",rows:6}]),y("prod",tt("PRODUCTION EXPENSES","مصاريف الإنتاج"),[{code:"04-00",label:"PRODUCTION STAFF",rows:3},{code:"05-00",label:"SET DESIGN",rows:3},{code:"06-00",label:"SET CONSTRUCTION",rows:2}]),y("post",tt("POST-PRODUCTION EXPENSES","مصاريف ما بعد الإنتاج"),[{code:"13-00",label:"FILM EDITING",rows:2},{code:"14-00",label:"VOICE OVER",rows:2}]),s}function dn(t){try{if(!t)return!1;const e=!!t.querySelector("#expenses-top-sheet"),n=!!t.querySelector('table.exp-details tbody tr[data-row="item"]'),r=!!Array.from(t.querySelectorAll("table.tpl-table tbody tr")).find(i=>{try{return i.classList?.contains("cs-row-note")||i.classList?.contains("cs-row-strong")?!0:Array.from(i.querySelectorAll("td")).some(u=>(u.textContent||"").trim().length>0)}catch{return!1}}),s=!!t.querySelector(".callsheet-v1 table.cs-crew")||!!Array.from(t.querySelectorAll(".callsheet-v1 table.cs-crew tbody tr")).find(i=>{try{return Array.from(i.querySelectorAll("td")).some(o=>(o.textContent||"").trim().length>0)}catch{return!1}}),c=!!t.querySelector(".callsheet-v1 .cs-header, .callsheet-v1 .cs-info td, .callsheet-v1 .cs-cast td");return e||n||r||s||c}catch{return!0}}const Ze=new Map;function Bo(t){if(!t)return Promise.resolve(null);const e=String(t);if(Ze.has(e))return Ze.get(e);const n=new Promise(r=>{try{const a=new Image;a.crossOrigin="anonymous",a.referrerPolicy="no-referrer",a.onload=()=>r(a),a.onerror=()=>r(null),a.src=e}catch{r(null)}});return Ze.set(e,n),n}function yc(t=[]){return Promise.all((t||[]).map(e=>Bo(e)))}async function Mo(){try{document.fonts&&document.fonts.ready&&await document.fonts.ready}catch{}}function Ro(t=document){try{const e=t||document,n=Array.from(e.querySelectorAll?e.querySelectorAll("img"):[]);return n.length?Promise.all(n.map(r=>new Promise(a=>{try{if(r.complete&&r.naturalWidth>0)return a();const s=()=>{try{r.removeEventListener("load",s),r.removeEventListener("error",s)}catch{}a()};r.addEventListener("load",s,{once:!0}),r.addEventListener("error",s,{once:!0})}catch{a()}}))):Promise.resolve()}catch{return Promise.resolve()}}async function ko(t=document){await Mo(),await Ro(t)}let Wt=[],Pn=[],Kn=!1,Zn=null,Wr=()=>null,In=()=>{},Vr=()=>{},Xr=()=>{};function Do({getSnapshot:t,applySnapshot:e,onAutosaveDebounced:n,onMarkEditing:r}={}){typeof t=="function"&&(Wr=t),typeof e=="function"&&(In=e),typeof n=="function"&&(Vr=n),typeof r=="function"&&(Xr=r)}function Yr(){try{const t=Wr();if(!t)return;Wt.push(t),Wt.length>50&&Wt.shift(),Pn=[]}catch{}}function kt(){try{clearTimeout(Zn)}catch{}Zn=setTimeout(Yr,250)}function qo(){if(Wt.length<2)return;const t=Wt.pop(),e=Wt[Wt.length-1];t&&Pn.push(t),e&&In(e)}function jo(){const t=Pn.pop();t&&(Wt.push(t),In(t))}function Fo(t,e){try{if(e!=="callsheet"||(Yr(),Kn))return;const n=document.getElementById("templates-preview-host");if(!n)return;n.addEventListener("input",r=>{const a=r.target;if(a&&a.getAttribute&&a.getAttribute("data-editable")==="true"){try{kt()}catch{}try{Vr()}catch{}try{Xr()}catch{}}},!0),Kn=!0}catch{}}function $o(t){return!t||!t.parentElement?-1:Array.from(t.parentElement.children).indexOf(t)}function Xt(t){return t?.matches("[data-section-bar]")||t?.classList.contains("tpl-subtotal-row")}function Gr(t,e=0){if(!t)return;const n=Array.from(t.children),r=n[e];if(r&&r.hasAttribute("contenteditable")){r.focus();return}n.find(s=>s.hasAttribute("contenteditable"))?.focus()}function Kr(t){if(!t)return null;const e=t.parentElement,n=t.cloneNode(!0);return n.querySelectorAll("[contenteditable]")?.forEach(r=>{r.textContent=""}),e.insertBefore(n,t.nextElementSibling),n}function Zr(t,e=-1){if(!t)return;const n=t.parentElement;if(e<0){const r=t.previousElementSibling;r&&!Xt(r)&&n.insertBefore(t,r)}else{const r=t.nextElementSibling;if(r){const a=r.nextElementSibling;Xt(r)?a&&!Xt(a)&&n.insertBefore(t,a.nextElementSibling):n.insertBefore(r,t)}}}function Jr(t){if(!t||Xt(t))return;const e=t.parentElement;try{e.removeChild(t)}catch{}}function oe({landscape:t=!1,headerFooter:e=!1,logoUrl:n=""}={}){const r=document.createElement("section");r.className=`a4-page ${t?"a4-landscape":""}`.trim();const a=document.createElement("div");if(a.className="a4-inner",e){const s=w("div",{class:"tpl-print-header"},[w("div",{class:"logo-left"},[w("img",{src:n||"",alt:""})]),w("div",{class:"meta"},[w("div",{text:new Date().toLocaleDateString()})])]),c=w("div",{class:"tpl-print-footer"},[w("div",{class:"footer-left",text:"art-ratio.com"}),w("div",{class:"page-num",html:"<span data-page-num>1</span> / <span data-page-count>1</span>"})]);r.appendChild(s),r.appendChild(c)}return r.appendChild(a),{page:r,inner:a}}function un({headerFooter:t=!1,logoUrl:e=""}={}){const n=document.querySelector("#templates-preview-host #templates-a4-root");if(!n)return;const r=n.querySelector("[data-a4-pages]"),s=r?.querySelector(".a4-page")?.querySelector(".a4-inner");if(!s)return;const c=s.querySelector(".exp-masthead"),i=s.querySelector(".tpl-meta"),o=s.querySelector("#expenses-top-sheet"),u=s.querySelector("#expenses-table"),d=s.querySelector("#expenses-summary");if(!u)return;for(;r.firstChild;)r.removeChild(r.firstChild);let{page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1});r.appendChild(l),c&&p.appendChild(c),i&&p.appendChild(i),o&&p.appendChild(o);const m=u.querySelector("thead"),h=()=>{const b=document.createElement("table");b.className=u.className,b.id="expenses-table",b.setAttribute("data-editable-table","expenses");const k=m?m.cloneNode(!0):document.createElement("thead");return b.appendChild(k),b.appendChild(document.createElement("tbody")),b};let f=h();p.appendChild(f);const y=Array.from(u.querySelectorAll("tbody > tr")),x=b=>b?.hasAttribute("data-subgroup-header"),I=b=>b?.hasAttribute("data-subgroup-subtotal"),E=b=>b?.hasAttribute("data-group-total"),A=b=>b?.hasAttribute("data-subgroup-marker"),g=b=>b?.getAttribute("data-row")==="item",v=b=>b?.hasAttribute("data-group-bar"),T=()=>p.scrollHeight<=p.clientHeight+.5;let P=null,L=null,C=null;const B=(b=null)=>{({page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(l),f=h(),p.appendChild(f);const k=f.tBodies[0];if(P&&!(b&&v(b))&&k.appendChild(P.cloneNode(!0)),L&&!(b&&x(b))){const q=b,M=!!(q&&(q.getAttribute&&q.getAttribute("data-subgroup-subtotal")===C||q.getAttribute&&q.getAttribute("data-row")==="item"||q.hasAttribute&&q.hasAttribute("data-subgroup-marker")));(!b||M)&&k.appendChild(L.cloneNode(!0))}},R=b=>{const k=f.tBodies[0];k.appendChild(b),T()||(k.removeChild(b),B(b),f.tBodies[0].appendChild(b))};let N=0;for(;N<y.length;){const b=y[N];if(v(b)&&(P=b.cloneNode(!0)),x(b)&&(L=b.cloneNode(!0),C=b.getAttribute("data-subgroup")),x(b)){const k=[b],q=b.getAttribute("data-subgroup");let M=N+1,j=0;for(;M<y.length&&j<2;)if(g(y[M]))k.push(y[M]),j+=1,M+=1;else if(A(y[M]))k.push(y[M]),M+=1;else{if(I(y[M]))break;break}M<y.length&&I(y[M])&&y[M].getAttribute("data-subgroup-subtotal")===q&&(k.push(y[M]),M+=1);const X=f.tBodies[0];if(k.forEach(_=>X.appendChild(_)),!T()){k.forEach(D=>{D.parentElement===X&&X.removeChild(D)}),B(k[0]);const _=f.tBodies[0];k.forEach(D=>_.appendChild(D))}N=M;continue}if(E(b)){const k=f.tBodies[0];if(k.appendChild(b),!T()){k.removeChild(b);const q=k.lastElementChild;let M=null;q&&(g(q)||I(q))&&(M=q,k.removeChild(q)),B(b);const j=f.tBodies[0];M&&j.appendChild(M),j.appendChild(b),T()||(j.removeChild(b),B(b),f.tBodies[0].appendChild(b))}L=null,C=null,P=null,N+=1;continue}R(b),N+=1}if(d&&(p.appendChild(d),T()||(p.removeChild(d),{page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1}),r.appendChild(l),f=h(),p.appendChild(f),p.appendChild(d))),t){const b=r.querySelectorAll(".a4-page").length;Array.from(r.querySelectorAll(".a4-page")).forEach((k,q)=>{const M=k.querySelector("[data-page-num]"),j=k.querySelector("[data-page-count]");M&&(M.textContent=String(q+1)),j&&(j.textContent=String(b))})}try{Ho()}catch{}try{zo()}catch{}try{Bn()}catch{}try{window.__pdfTunerRefreshPages&&window.__pdfTunerRefreshPages()}catch{}try{window.__pdfTunerLoadValues&&window.__pdfTunerLoadValues()}catch{}}function Nn({headerFooter:t=!1,logoUrl:e=""}={}){const n=document.querySelector("#templates-preview-host #templates-a4-root");if(!n)return;const r=n.querySelector("[data-a4-pages]");if(!r)return;Array.from(r.querySelectorAll(".a4-page")).forEach(s=>{const c=s.querySelector(".a4-inner");if(!c)return;Array.from(c.querySelectorAll("table.exp-details")).filter(o=>o.getAttribute("data-split-done")!=="1").forEach(o=>{const u=o.querySelector("thead"),d=o.querySelector("colgroup"),l=o.getAttribute("data-group")||"",p=Array.from(o.querySelectorAll("tbody > tr"));if(!p.length){o.setAttribute("data-split-done","1");return}const m=()=>{const b=document.createElement("table");b.className=o.className,b.setAttribute("data-editable-table","expenses"),l&&b.setAttribute("data-group",l),d&&b.appendChild(d.cloneNode(!0));const k=u?u.cloneNode(!0):document.createElement("thead");return b.appendChild(k),b.appendChild(document.createElement("tbody")),b};let h=s,f=c;const y=m();try{c.removeChild(o)}catch{}f.appendChild(y);try{const b=!!f.querySelector("#expenses-top-sheet"),k=!!Array.from(f.querySelectorAll("table.exp-details")).find(q=>q!==y);if(b||k){try{f.removeChild(y)}catch{}({page:h,inner:f}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(h),f.appendChild(y)}}catch{}let x=y;const I=b=>b?.hasAttribute("data-subgroup-header"),E=b=>b?.hasAttribute("data-subgroup-subtotal"),A=b=>b?.hasAttribute("data-group-total"),g=b=>b?.hasAttribute("data-subgroup-marker"),v=b=>b?.getAttribute("data-row")==="item",T=b=>b?.hasAttribute("data-group-bar"),P=()=>f.scrollHeight<=f.clientHeight+.5;let L=null,C=null,B=null;const R=(b=null)=>{({page:h,inner:f}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(h),x=m(),f.appendChild(x);const k=x.tBodies[0];if(L&&!(b&&T(b))&&k.appendChild(L.cloneNode(!0)),C&&!(b&&I(b))){const q=b,M=!!(q&&(q.getAttribute&&q.getAttribute("data-subgroup-subtotal")===B||q.getAttribute&&q.getAttribute("data-row")==="item"||q.hasAttribute&&q.hasAttribute("data-subgroup-marker")));(!b||M)&&k.appendChild(C.cloneNode(!0))}};let N=0;for(;N<p.length;){const b=p[N],k=x.tBodies[0],q=M=>{if(k.appendChild(M),!P()){try{k.removeChild(M)}catch{}let j=!1;try{j=!(k.children&&k.children.length)}catch{}const X=x;if(R(M),j)try{X.parentElement?.removeChild(X)}catch{}x.tBodies[0].appendChild(M)}};if(T(b)){L=b.cloneNode(!0);const M=x.tBodies[0];M&&M.children&&M.children.length>0&&R(b),q(b),N+=1;continue}if(I(b)){C=b.cloneNode(!0),B=b.getAttribute("data-subgroup");const M=[b];let j=N+1,X=0;for(;j<p.length&&X<2;)if(v(p[j]))M.push(p[j]),X+=1,j+=1;else if(g(p[j]))M.push(p[j]),j+=1;else{if(E(p[j]))break;break}if(j<p.length&&E(p[j])&&p[j].getAttribute("data-subgroup-subtotal")===B&&(M.push(p[j]),j+=1),M.forEach(_=>k.appendChild(_)),!P()){M.forEach(D=>{try{k.removeChild(D)}catch{}}),R(M[0]);const _=x.tBodies[0];M.forEach(D=>_.appendChild(D))}N=j;continue}if(A(b)){if(q(b),!P()){const M=k.lastElementChild;let j=null;if(M&&(v(M)||E(M))){try{k.removeChild(M)}catch{}j=M}try{k.removeChild(b)}catch{}R(b);const X=x.tBodies[0];if(j&&X.appendChild(j),X.appendChild(b),!P()){try{X.removeChild(b)}catch{}R(b),x.tBodies[0].appendChild(b)}}C=null,B=null,L=null,N+=1;continue}q(b),N+=1}try{o.setAttribute("data-split-done","1")}catch{}try{Array.from(r.querySelectorAll("table.exp-details")).forEach(b=>{try{b.setAttribute("data-split-done","1")}catch{}})}catch{}})});try{const s=Array.from(r.querySelectorAll(".a4-page"));if(s.length>1){const c=s[0],i=s.slice(1),o={atl:[],prod:[],post:[],other:[]};i.forEach(d=>{const l=d.querySelector("table.exp-details"),p=l&&l.getAttribute("data-group")||"other";p in o?o[p].push(d):o.other.push(d)}),[c,...o.atl,...o.prod,...o.post,...o.other].forEach(d=>{try{r.appendChild(d)}catch{}})}}catch{}try{Array.from(r.querySelectorAll("table.exp-details")).forEach(c=>{const i=Array.from(c.querySelectorAll("thead"));i.length>1&&i.slice(1).forEach(d=>{try{d.parentElement?.removeChild(d)}catch{}});const o=c.tBodies&&c.tBodies[0];if(!!!(o&&o.children&&o.children.length))try{c.parentElement?.removeChild(c)}catch{}})}catch{}try{n.querySelector('table.exp-details:not([data-split-done="1"])')&&requestAnimationFrame(()=>{try{Nn({headerFooter:t,logoUrl:e})}catch{}})}catch{}}function pe({headerFooter:t=!1,logoUrl:e="",isLandscape:n=!0}={}){const r=document.querySelector("#templates-preview-host #templates-a4-root");if(!r||(document.getElementById("templates-type")?.value||"expenses")==="expenses")return;const s=r.querySelector("[data-a4-pages]");if(!s)return;Array.from(s.querySelectorAll(".a4-page")).forEach(i=>{const o=i.querySelector(".a4-inner");if(!o)return;Array.from(o.querySelectorAll("table.tpl-table")).forEach(d=>{if(!d||d.getAttribute("data-split-done")==="1")return;const l=d.querySelector("thead"),p=d.querySelector("colgroup"),m=Array.from(d.querySelectorAll("tbody > tr"));if(!m.length){d.setAttribute("data-split-done","1");return}const h=d.closest(".callsheet-v1"),f=h?h.cloneNode(!1):null,y=d.getAttribute("data-editable-table")||"",x=()=>{const C=document.createElement("table");C.className=d.className,y&&C.setAttribute("data-editable-table",y),p&&C.appendChild(p.cloneNode(!0));const B=l?l.cloneNode(!0):document.createElement("thead");return C.appendChild(B),C.appendChild(document.createElement("tbody")),C},I=(C,B=!1)=>{if(!f)return C;if(B&&h&&h.parentElement===C)return h;const R=f.cloneNode(!1);return C.appendChild(R),R},E=()=>o.scrollHeight<=o.clientHeight+.5;let A=i,g=o;const v=h||d.parentElement||o;try{v.removeChild(d)}catch{}let T=x(),P=I(g,!0);P.appendChild(T);let L=0;for(;L<m.length;){const C=T.tBodies[0];if(C.appendChild(m[L]),!E()){C.removeChild(m[L]);try{if(!(C.children&&C.children.length)){const R=T;try{g.removeChild(R)}catch{}}}catch{}({page:A,inner:g}=oe({headerFooter:t,logoUrl:e,landscape:n})),s.appendChild(A),T=x(),P=I(g,!1),P.appendChild(T),T.tBodies[0].appendChild(m[L])}L+=1}try{Array.from(s.querySelectorAll("table.tpl-table")).forEach(B=>{const R=B.tBodies&&B.tBodies[0];if(!!!(R&&R.children&&R.children.length))try{B.parentElement?.removeChild(B)}catch{}})}catch{}d.setAttribute("data-split-done","1");try{f&&typeof window<"u"&&typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}})})}function Zt(){try{const t=document.getElementById("templates-a4-root");if(!t)return;Array.from(t.querySelectorAll(".a4-page")).forEach(n=>{dn(n)||t.querySelectorAll(".a4-page").length>1&&n.parentElement?.removeChild(n)});try{Oo()}catch{}}catch{}}function Oo(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll("table.cs-crew"));if(e.length<=1)return;let n=e.find(r=>(r.tBodies?.[0]?.children?.length||0)>0)||e[0];e.forEach(r=>{if(r!==n)try{r.parentElement?.removeChild(r)}catch{}})}function Ho(){Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.exp-table")).forEach(e=>{const n=e.tBodies?.[0];if(!n)return;let r=!1;Array.from(n.children).forEach(a=>{a.getAttribute("data-row")==="item"&&(a.classList.toggle("exp-row-alt",r),r=!r)})})}function zo(){Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.exp-table tr.exp-subheader th")).forEach(e=>{e.style.fontSize="",e.style.whiteSpace="nowrap",e.style.overflow="hidden",e.style.textOverflow="ellipsis";const n=12,r=9;let a=n;const s=()=>e.scrollWidth<=e.clientWidth;for(;a>r&&!s();)a-=.5,e.style.fontSize=a+"px"})}function Bn(t){const e=document.querySelector("#templates-preview-host #templates-a4-root");if(!e)return;const n=t&&t instanceof HTMLElement?t:e,r=Array.from(n.querySelectorAll("table.exp-table td")),a=s=>s&&!/\s/.test(s);r.forEach(s=>{const c=(s.textContent||"").trim();if(!c||!a(c))return;s.style.fontSize="";const i=Number.parseFloat(getComputedStyle(s).fontSize||"11");let o=Number.isFinite(i)?i:11;const u=7,d=()=>s.scrollWidth<=s.clientWidth&&s.scrollHeight<=s.clientHeight;let l=0;for(;!d()&&o>u&&l<40;)o-=.5,s.style.fontSize=o+"px",l+=1})}function Qr(){try{Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.cs-schedule thead th")).forEach(e=>{e.style.fontSize="";const n=Number.parseFloat(getComputedStyle(e).fontSize||"10");let r=Number.isFinite(n)?n:10;const a=8,s=()=>e.scrollWidth<=e.clientWidth+.5&&e.scrollHeight<=e.clientHeight+.5;let c=0;for(;!s()&&r>a&&c<30;)r-=.5,e.style.fontSize=r+"px",c+=1})}catch{}}function ta({onAfterChange:t}={}){if(!document.getElementById("templates-preview-host")){const c=document.getElementById("tpl-cell-toolbar");c&&(c.style.display="none");return}const n=document.getElementById("templates-type")?.value||"expenses";let r=document.getElementById("tpl-cell-toolbar");if(!(n==="callsheet"||n==="expenses")){r&&(r.style.display="none");return}if(!r)r=document.createElement("div"),r.id="tpl-cell-toolbar",Object.assign(r.style,{position:"fixed",display:"none",zIndex:2147483e3}),r.innerHTML=`
      <div style="display:inline-flex;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:4px;box-shadow:0 2px 8px rgba(15,23,42,0.12);">
        <button type="button" data-act="row-add" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف</button>
        <button type="button" data-act="row-full" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف كامل</button>
        <button type="button" data-act="row-full-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف كامل</button>
        <button type="button" data-act="row-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف</button>
        <button type="button" data-act="row-up" class="btn btn-outline" style="height:28px;padding:0 8px">↑</button>
        <button type="button" data-act="row-down" class="btn btn-outline" style="height:28px;padding:0 8px">↓</button>
        <span data-sep style="width:1px;background:#e5e7eb;margin:0 4px"></span>
        <button type="button" data-act="cast-add" class="btn btn-outline" style="height:28px;padding:0 8px">+ خانة</button>
        <button type="button" data-act="cast-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× خانة</button>
        <button type="button" data-act="cast-add-row" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف اسم/وقت</button>
        <button type="button" data-act="cast-del-row" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف اسم/وقت</button>
      </div>`,document.body.appendChild(r),r.__lock=!1,r.__switchTimer=null,r.__freezeUntil=0,r.addEventListener("pointerenter",()=>{r.__lock=!0}),r.addEventListener("pointerleave",()=>{r.__lock=!1}),r.addEventListener("click",c=>{const i=c.target.closest("[data-act]");if(!i)return;const o=i.getAttribute("data-act"),u=r.__targetCell||null;if(!u)return;const d=u.closest("table.cs-schedule")||u.closest("table.cs-crew")||u.closest("table.exp-details"),l=u.closest("table.cs-cast"),p=()=>{const g=u.closest("tr");if(!g)return;const v=Kr(g);v&&Gr(v,0)},m=()=>{const g=u.closest("tr");g&&(g.classList.contains("cs-row-note")||g.classList.contains("cs-row-strong")||g.hasAttribute("data-group-bar")||g.hasAttribute("data-subgroup-header")||g.hasAttribute("data-subgroup-subtotal")||g.hasAttribute("data-group-total")||g.hasAttribute("data-subgroup-marker")||Jr(g))},h=g=>{const v=u.closest("tr");v&&Zr(v,g)},f=()=>{try{typeof t=="function"&&t()}catch{}try{setTimeout(()=>{pe(),Zt()},30)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}try{document.dispatchEvent(new CustomEvent("templates:afterRowChange"))}catch{}},y=()=>{const g=d||u.closest("table");if(!g)return;const v=u.closest("tr"),T=v?.parentElement;if(!v||!T)return;const P=(()=>{try{const B=g.querySelectorAll("thead tr"),R=B&&B.length?B[B.length-1]:null;if(R&&R.children&&R.children.length)return R.children.length;const N=g.querySelectorAll("colgroup col");return N&&N.length?N.length:12}catch{return 12}})(),L=document.createElement("tr"),C=document.createElement("td");C.setAttribute("colspan",String(P)),C.setAttribute("data-editable","true"),C.setAttribute("contenteditable","true"),L.appendChild(C),T.insertBefore(L,v.nextElementSibling)},x=()=>{const g=l;if(!g)return;const v=g.tBodies&&g.tBodies[0];if(!v)return;const T=v.children&&v.children[1],P=v.children&&v.children[2];if(!T||!P)return;const L=document.createElement("td");L.setAttribute("data-editable","true"),L.setAttribute("contenteditable","true"),T.appendChild(L);const C=document.createElement("td");C.setAttribute("data-editable","true"),C.setAttribute("contenteditable","true"),P.appendChild(C)},I=()=>{const g=l;if(!g)return;const v=g.tBodies&&g.tBodies[0];if(!v)return;const T=v.children&&v.children[1],P=v.children&&v.children[2];!T||!P||T.children.length<=2||P.children.length<=2||(T.removeChild(T.lastElementChild),P.removeChild(P.lastElementChild))},E=()=>{const g=l;if(!g)return;const v=g.tBodies&&g.tBodies[0];if(!v)return;const T=v.children&&v.children[1],P=v.children&&v.children[2];if(!T||!P)return;const L=T.querySelector(".cs-weather"),C=T.children.length-(L?1:0),B=document.createElement("tr"),R=document.createElement("tr");for(let N=0;N<C;N+=1){const b=document.createElement("td");b.setAttribute("data-editable","true"),b.setAttribute("contenteditable","true"),B.appendChild(b)}for(let N=0;N<C;N+=1){const b=document.createElement("td");b.setAttribute("data-editable","true"),b.setAttribute("contenteditable","true"),R.appendChild(b)}if(v.appendChild(B),v.appendChild(R),L){const N=v.querySelectorAll("tr").length-1;L.setAttribute("rowspan",String(N))}},A=()=>{const g=l;if(!g)return;const v=g.tBodies&&g.tBodies[0];if(!v||v.children.length<=3)return;const T=v.lastElementChild,P=T?.previousElementSibling;P&&T&&P.tagName==="TR"&&(v.removeChild(T),v.removeChild(P));const C=v.children[1]?.querySelector(".cs-weather");if(C){const B=v.querySelectorAll("tr").length-1;C.setAttribute("rowspan",String(B))}};if(o==="row-add"&&d)p(),f();else if(o==="row-full"&&d)y(),f();else if(o==="row-full-del"&&d){const g=u.closest("tr"),v=(()=>{try{const P=d.querySelectorAll("thead tr"),L=P&&P.length?P[P.length-1]:null;if(L&&L.children&&L.children.length)return L.children.length;const C=d.querySelectorAll("colgroup col");return C&&C.length?C.length:12}catch{return 12}})();g&&g.children&&g.children.length===1&&Number(g.children[0]?.getAttribute("colspan")||"1")>=v&&(g.parentElement?.removeChild(g),f())}else o==="row-del"&&d?(m(),f()):o==="row-up"&&d?(h(-1),f()):o==="row-down"&&d?(h(1),f()):o==="cast-add"&&l?(x(),f()):o==="cast-del"&&l?(I(),f()):o==="cast-add-row"&&l?(E(),f()):o==="cast-del-row"&&l&&(A(),f())});else if(r.parentElement!==document.body){try{r.parentElement.removeChild(r)}catch{}document.body.appendChild(r)}const a=c=>{if(!c){r.style.display="none",r.__targetCell=null;return}const i=c.closest("table.cs-schedule")||c.closest("table.cs-crew")||c.closest("table.exp-details"),o=c.closest("table.cs-cast");if(!i&&!o){r.style.display="none",r.__targetCell=null;return}let u=!!i;const d=!!o;try{if(u&&i&&i.matches("table.exp-details")){const f=c.closest("tr");u=!!(f&&f.getAttribute("data-row")==="item")}}catch{}Array.from(r.querySelectorAll('[data-act^="row-"]')).forEach(f=>f.style.display=u?"inline-flex":"none"),Array.from(r.querySelectorAll('[data-act^="cast-"]')).forEach(f=>f.style.display=d?"inline-flex":"none"),r.querySelector("[data-sep]")?.setAttribute("style",`width:1px;background:#e5e7eb;margin:0 4px;display:${u&&d?"inline-block":"none"}`);try{const f=r.querySelector('[data-act="row-full"]'),y=r.querySelector('[data-act="row-full-del"]');if(i&&i.matches("table.exp-details"))f&&(f.style.display="none"),y&&(y.style.display="none");else if(y&&i){const x=c.closest("tr"),I=i.querySelector("thead tr"),E=I&&I.children&&I.children.length?I.children.length:12,A=x&&x.children&&x.children.length===1&&Number(x.children[0]?.getAttribute("colspan")||"1")>=E;y.style.display=A?"inline-flex":"none",f&&(f.style.display="inline-flex")}}catch{}const l=c.getBoundingClientRect(),p=6,m=Math.round(l.left+Math.min(l.width-28,12)),h=Math.round(l.top-(r.offsetHeight||32)-p);r.style.transform="none",r.style.left=`${m}px`,r.style.top=`${Math.max(0,h)}px`,r.style.display="block",r.__targetCell=c},s=()=>{const c=document.getElementById("templates-a4-root");if(!c)return;const i=()=>{if(r.__lock)return;const u=window.getSelection();if(!u||u.rangeCount===0){r.__lock||(r.style.display="none");return}let d=u.anchorNode;d&&d.nodeType===3&&(d=d.parentElement);const l=d instanceof Element?d.closest("td,th"):null;if(!l){r.__lock||(r.style.display="none");return}a(l)};document.addEventListener("selectionchange",i);const o=u=>{const d=u.target;if(d instanceof Element&&(d.getAttribute("contenteditable")==="true"||d.closest('[contenteditable="true"]'))){const l=d.closest("td,th");l&&a(l)}};c.addEventListener("focusin",o,!0),r.__detach=()=>{try{document.removeEventListener("selectionchange",i),c.removeEventListener("focusin",o,!0)}catch{}}};r.__attachedOnce||(s(),r.__attachedOnce=!0)}function Uo(t,{onAfterChange:e,onTotalsChange:n,onRenumber:r}={}){if(!t)return()=>{};const a=s=>{const c=s.target.closest("[data-action]");if(!c)return;const i=c.getAttribute("data-action"),o=c.closest("tr"),u=o?.parentElement;if(!(!o||!u)){if(i==="row-up"&&o.previousElementSibling&&!o.previousElementSibling.matches("[data-section-bar]"))u.insertBefore(o,o.previousElementSibling);else if(i==="row-down"&&o.nextElementSibling)u.insertBefore(o.nextElementSibling,o);else if(i==="row-add"){const d=o.cloneNode(!0);d.querySelectorAll("[contenteditable]")?.forEach(l=>{l.textContent=""}),u.insertBefore(d,o.nextElementSibling)}else i==="row-delete"&&u.removeChild(o);try{typeof r=="function"&&r()}catch{}try{typeof n=="function"&&n()}catch{}try{Bn(u)}catch{}try{typeof e=="function"&&e()}catch{}}};return t.addEventListener("click",a),()=>{try{t.removeEventListener("click",a)}catch{}}}function Jn(t){let e=t?.nextElementSibling;for(;e&&Xt(e);)e=e.nextElementSibling;return e}function Wo(t,e,n){if(!(!t||!e||n<=0))for(let r=0;r<n;r+=1){const a=e.cloneNode(!0);a.querySelectorAll("[contenteditable]")?.forEach(s=>{s.textContent=""}),t.appendChild(a)}}function Vo(t){return t?t.split(/\r?\n/).map(n=>n.replace(/\r$/,"")).filter(n=>n.trim().length>0).map(n=>n.split(/\t|,|;/).map(r=>r.trim())):[]}function Xo(t,e,n){if(!t||!n||!n.length)return;const r=Array.from(t.children);let a=Math.max(0,e);for(let s=0;s<n.length&&a<r.length;s+=1){for(;a<r.length&&!r[a].hasAttribute("contenteditable");)a+=1;if(a>=r.length)break;const c=r[a],i=n[s]??"";c.textContent=String(i),a+=1}}function Yo(t,{onAfterChange:e,onTotalsChange:n}={}){if(!t)return()=>{};const r=s=>{const c=s.target,i=c&&c.closest("[contenteditable]"),o=c&&c.closest("table.tpl-table");if(!i||!o)return;const u=s.clipboardData?.getData("text/plain")??"";if(!u||!u.includes("	")&&!u.includes(`
`))return;s.preventDefault();const d=Vo(u);if(!d.length)return;const l=c.closest("td"),p=$o(l),m=o.tBodies?.[0]||o.querySelector("tbody");if(!m)return;let h=Array.from(m.children).find(A=>A&&!Xt(A)),f=l.parentElement,y=0,x=f;for(;x;)Xt(x)||(y+=1),x=x.nextElementSibling;const I=d.length-y;I>0&&h&&Wo(m,h,I);let E=f;d.forEach((A,g)=>{for(;E&&Xt(E);)E=Jn(E);if(!E)return;const v=g===0?p:0,T=A.map(P=>{const L=String(P||""),C={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"},B={"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"۷","۸":"8","۹":"9"};return L.replace(/[\u0660-\u0669]/g,R=>C[R]).replace(/[\u06F0-\u06F9]/g,R=>B[R])});Xo(E,v,T),E=Jn(E)||E?.nextElementSibling}),typeof n=="function"&&n();try{Bn(o)}catch{}},a=s=>{const c=s.target;if(!c||!c.closest("table.tpl-table"))return;const i=c.closest("table.tpl-table"),o=c.closest("tr");if(o){if(s.key==="Enter"&&!s.shiftKey){s.preventDefault();const u=Kr(o);u&&(Gr(u),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n());try{typeof e=="function"&&e()}catch{}return}if(s.altKey&&(s.key==="ArrowUp"||s.key==="ArrowDown")){s.preventDefault(),Zr(o,s.key==="ArrowDown"?1:-1),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n();try{typeof e=="function"&&e()}catch{}return}if((s.key==="Delete"||s.key==="Backspace")&&s.ctrlKey){s.preventDefault(),Jr(o),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n();try{typeof e=="function"&&e()}catch{}}}};return t.addEventListener("paste",r),t.addEventListener("keydown",a,!0),()=>{try{t.removeEventListener("paste",r)}catch{}try{t.removeEventListener("keydown",a,!0)}catch{}}}function Go(t){try{const e=t.querySelector(".callsheet-v1");if(!e)return[];const n=Array.from(e.querySelectorAll("table")),r=[];return n.forEach((a,s)=>{const c=a.classList.contains("cs-schedule")?"schedule":a.classList.contains("cs-cast")?"cast":a.classList.contains("cs-info")?"info":"";Array.from(a.querySelectorAll("tr")).forEach((o,u)=>{Array.from(o.children).forEach((l,p)=>{if(l.getAttribute&&l.getAttribute("data-shaded")==="1"){const m=l.style.getPropertyValue("--shade")||l.style.backgroundColor||"";r.push({ti:s,ri:u,ci:p,shade:m,tp:c})}})})}),r}catch{return[]}}function ea(t){if(!t)return[];const e=Sn();return Array.isArray(e)?e.filter(n=>String(n?.projectId??n?.project_id??"")===String(t)):[]}let Gt=1,xe=null,At="manual",Qn=!1,pn=!1,Z={hostInput:null,hostMouseDown:null,hostFocusIn:null,hostFocusOut:null,hostCompStart:null,hostCompEnd:null,projChanged:null,resChanged:null,resUpdated:null,tabClick:null},Nt=null,Ut=null,se=null,Me=null,Je=null,Re=null,Qe=!1,tr=null,er=null;function re(t){try{const e=t||document.querySelector("#templates-preview-host #templates-a4-root");if(!e)return;try{na(e)}catch{}Array.from(e.querySelectorAll("table.cs-crew")).forEach(a=>{try{a.style.setProperty("width","90%","important"),a.style.setProperty("margin-left","auto","important"),a.style.setProperty("margin-right","auto","important")}catch{}});const r=Array.from(e.querySelectorAll("table.cs-schedule"));r.forEach(a=>{try{a.style.setProperty("width","calc(82% + 120px)","important"),a.style.setProperty("margin-left","11mm","important"),a.style.setProperty("margin-right","-16mm","important");const s=a.closest(".a4-inner");s&&(s.style.setProperty("padding-left","0mm","important"),s.style.setProperty("padding-right","0mm","important"))}catch{}});try{const a=r[0];if(a){const s=a.tBodies&&a.tBodies[0];if(s){const c=Array.from(s.children),i=d=>d.classList?.contains("cs-row-note")||d.classList?.contains("cs-row-strong");let o=c.filter(d=>!i(d));const u=(()=>{const d=a.querySelector("thead tr");return d&&d.children&&d.children.length?d.children.length:12})();for(;o.length<4;){const d=document.createElement("tr");for(let l=0;l<u;l+=1){const p=document.createElement("td");p.setAttribute("data-editable","true"),p.setAttribute("contenteditable","true"),d.appendChild(p)}s.appendChild(d),o.push(d)}}}}catch{}}catch{}}try{window.__enforceCallsheetSizing=re}catch{}function na(t){const e=t||document.getElementById("templates-a4-root");if(!e)return;Array.from(e.querySelectorAll("table.cs-crew, table.cs-schedule")).forEach(r=>{const a=r.closest(".a4-inner");if(!a||r.closest(".callsheet-v1"))return;let c=a.querySelector(":scope > .callsheet-v1");c||(c=document.createElement("div"),c.className="callsheet-v1",a.insertBefore(c,r));try{c.appendChild(r)}catch{}})}function nr(){try{const t=document.getElementById("templates-preview-host");if(t){try{Z.hostInput&&t.removeEventListener("input",Z.hostInput)}catch{}try{Me&&(Me(),Me=null)}catch{}try{Z.hostMouseDown&&t.removeEventListener("mousedown",Z.hostMouseDown,!0)}catch{}try{Z.hostFocusIn&&t.removeEventListener("focusin",Z.hostFocusIn,!0)}catch{}try{Z.hostFocusOut&&t.removeEventListener("focusout",Z.hostFocusOut,!0)}catch{}try{Z.hostCompStart&&t.removeEventListener("compositionstart",Z.hostCompStart,!0)}catch{}try{Z.hostCompEnd&&t.removeEventListener("compositionend",Z.hostCompEnd,!0)}catch{}try{Re&&(Re(),Re=null)}catch{}try{const e=document.getElementById("tpl-cell-toolbar");e&&typeof e.__detach=="function"&&e.__detach()}catch{}}if(Z.projChanged&&document.removeEventListener("projects:changed",Z.projChanged),Z.resChanged&&document.removeEventListener("reservations:changed",Z.resChanged),Z.resUpdated&&document.removeEventListener("reservations:updated",Z.resUpdated),Z.tabClick){const e=document.querySelector('[data-project-subtab-target="projects-templates-tab"]');e&&e.removeEventListener("click",Z.tabClick)}if(Ut&&(clearTimeout(Ut),Ut=null),se){try{se.disconnect()}catch{}se=null}}finally{pn=!1,Nt=null,Z={hostInput:null,hostMouseDown:null,hostFocusIn:null,hostFocusOut:null,projChanged:null,resChanged:null,resUpdated:null,tabClick:null}}}function Kt(t,e="تعذر الاتصال بالخادم"){try{let n=t&&t.message?String(t.message):e;try{const r=t&&t.payload&&t.payload.raw?String(t.payload.raw):"",a=`${n}
${r}`;/Missing configuration file/i.test(a)&&(n="الخادم غير مُعد: يرجى نسخ backend/config.example.php إلى backend/config.php وتعبئة بيانات الاتصال (Database + allowed_origins) ثم إعادة المحاولة.")}catch{}typeof Bt=="function"?Bt(n,"error",7e3):alert(n)}catch{}}function ra(){try{return Math.max(.3,Math.min(2.5,Number(localStorage.getItem("templates.preview.zoom")||"1")))}catch{return 1}}function Ko(t){try{localStorage.setItem("templates.preview.zoom",String(t))}catch{}}function aa(){try{return(localStorage.getItem("templates.preview.zoomMode")||"manual")==="fit"?"fit":"manual"}catch{return"manual"}}function mn(t){try{localStorage.setItem("templates.preview.zoomMode",t==="fit"?"fit":"manual")}catch{}}function Ee(t,{silent:e=!1,markManual:n=!1}={}){Gt=Math.min(Math.max(t,.25),2.5),Zo(Gt),Ko(Gt),!e&&xe&&(xe.textContent=`${Math.round(Gt*100)}%`)}function rr(t){At="manual",mn(At),Ee(Gt+t,{markManual:!0})}function Zo(t){const e=document.querySelector("#templates-preview-host > #templates-a4-root")||document.querySelector("#templates-preview-host #templates-a4-root");if(e){try{e.style.transformOrigin="top center"}catch{}try{e.style.transform=`scale(${t})`}catch{}}}function Jo(){try{const e=document.querySelector("#templates-preview-host #templates-a4-root .a4-page");if(e)return e.getBoundingClientRect().width||e.offsetWidth||794}catch{}return(document.getElementById("templates-type")?.value||"expenses")!=="expenses"?1123:794}function Qo(){const t=document.getElementById("templates-preview-host");if(!t)return null;try{const e=window.getComputedStyle(t),n=parseFloat(e.paddingLeft||"0")||0,r=parseFloat(e.paddingRight||"0")||0;return Math.max(0,t.clientWidth-n-r)}catch{return t.clientWidth||null}}function ts(){const t=Jo(),e=Qo();return!t||!e?1:Math.max(.25,Math.min(2.5,e/t))}function Ce(){const t=ts();Ee(t,{silent:!1})}function ar(){Qn||(window.addEventListener("resize",()=>{At==="fit"&&Ce()},{passive:!0}),Qn=!0)}function or(){try{if(se)return;const t=document.getElementById("templates-preview-host");if(!t||typeof ResizeObserver>"u")return;se=new ResizeObserver(()=>{At==="fit"&&Ce()}),se.observe(t)}catch{}}function tn(t=180){try{Je&&clearTimeout(Je)}catch{}Je=setTimeout(()=>{try{Fn()}catch{}},Math.max(0,t))}const oa="projects.templates.type";function es(){try{const t=String(localStorage.getItem(oa)||"").trim();return t&&(t==="expenses"||t==="callsheet")?t:""}catch{return""}}function ns(t){try{t&&localStorage.setItem(oa,String(t))}catch{}}function rs(t){if(!t)return;let e="";try{const s=new URLSearchParams(window.location.search||"");e=s.get("tplType")||s.get("templatesType")||""}catch{}const n=es(),r=e&&(e==="expenses"||e==="callsheet")?e:n;if(!r)return;Array.from(t.options).some(s=>s.value===r)&&(t.value=r)}function as(){const t=document.getElementById("templates-actions");if(!t||document.getElementById("tpl-zoom-controls"))return;const e=document.createElement("div");e.id="tpl-zoom-controls",e.className="tpl-zoom-controls",e.innerHTML=`
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-out title="تصغير">−</button>
    <span class="tpl-zoom-value" data-tpl-zoom-value>100%</span>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-in title="تكبير">+</button>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-fit title="ملء العرض">↔︎</button>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-reset title="1:1">1:1</button>
  `,t.appendChild(e);const n=e.querySelector("[data-tpl-zoom-out]"),r=e.querySelector("[data-tpl-zoom-in]"),a=e.querySelector("[data-tpl-zoom-reset]"),s=e.querySelector("[data-tpl-zoom-fit]");xe=e.querySelector("[data-tpl-zoom-value]"),n?.addEventListener("click",()=>rr(-.1)),r?.addEventListener("click",()=>rr(.1)),a?.addEventListener("click",()=>{At="manual",mn(At),Ee(1,{markManual:!0})}),s?.addEventListener("click",()=>{At="fit",mn(At),Ce(),ar(),or()}),At=aa(),At==="fit"?(Ce(),ar(),or()):Ee(ra(),{silent:!1})}function os(t="expenses"){if(!document.getElementById("templates-actions"))return;const n=document.getElementById("templates-controls"),r=document.getElementById("tpl-logo-controls"),a=document.getElementById("tpl-controls-row2")||(()=>{const l=document.createElement("div");return l.id="tpl-controls-row2",Object.assign(l.style,{display:"flex",flexWrap:"wrap",gap:"8px",width:"100%",alignItems:"center",marginTop:"6px"}),n?.appendChild(l),l})();if(t!=="callsheet"){r&&r.remove();return}if(r)return;const s=document.createElement("div");s.id="tpl-logo-controls",Object.assign(s.style,{display:"inline-flex",gap:"6px",alignItems:"center",flexWrap:"wrap"}),s.innerHTML=`
    <div class="input-group" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">لوغو ارت ريشيو</label>
      <input type="range" id="tpl-logo1-size" min="0.3" max="3" step="0.01" title="حجم لوغو ارت ريشيو">
      <button type="button" class="btn btn-outline" id="tpl-logo1-reset" title="إعادة تموضع لوغو ارت ريشيو">↺</button>
      <label class="form-check-label" style="display:inline-flex;align-items:center;gap:6px;margin:0 0 0 8px;">
        <input type="checkbox" id="tpl-logo1-hide" class="form-check-input">
        <span>إخفاء اللوغو</span>
      </label>
    </div>
    <div class="input-group" style="display:inline-flex;gap:6px;align-items:center;">
      <input type="url" id="tpl-logo2-url" class="form-control" placeholder="🔗 رابط لوغو إضافي" style="min-width:220px;max-width:320px;">
      <input type="range" id="tpl-logo2-size" min="0.3" max="3" step="0.01" title="حجم لوغو العميل">
      <button type="button" class="btn btn-outline" id="tpl-logo2-apply">تطبيق</button>
      <button type="button" class="btn btn-outline" id="tpl-logo2-reset">إعادة تموضع</button>
      <button type="button" class="btn btn-outline btn-danger" id="tpl-logo2-clear">حذف</button>
    </div>
    <div class="input-group" id="tpl-font-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">حجم الخط</label>
      <button type="button" class="btn btn-outline" id="tpl-font-down" title="تصغير الخط">A−</button>
      <button type="button" class="btn btn-outline" id="tpl-font-up" title="تكبير الخط">A+</button>
      <button type="button" class="btn btn-outline" id="tpl-font-bold" title="تسميك الخط (Bold)"><strong>B</strong></button>
    </div>
    <div class="input-group" id="tpl-shade-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">تظليل</label>
      <input type="color" id="tpl-shade-color" value="#fff59d" title="لون التظليل">
      <input type="range" id="tpl-shade-opacity" min="0" max="100" step="1" value="40" title="الشفافية %">
      <select id="tpl-shade-target" class="form-select" style="height:32px;">
        <option value="cell">خلية</option>
        <option value="row">صف</option>
      </select>
      <button type="button" class="btn btn-outline" id="tpl-shade-apply">تطبيق</button>
      <button type="button" class="btn btn-outline btn-danger" id="tpl-shade-clear">إزالة</button>
    </div>
    <div class="input-group" id="tpl-history-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <button type="button" class="btn btn-outline" id="tpl-undo" title="تراجع">↶</button>
      <button type="button" class="btn btn-outline" id="tpl-redo" title="تقديم">↷</button>
    </div>
  `,a.appendChild(s);try{const l=Mn(),p=document.getElementById("tpl-logo2-url"),m=document.getElementById("tpl-logo2-size");p&&l.url&&(p.value=l.url),m&&(m.value=String(l.s||1));const h=Rn(),f=document.getElementById("tpl-logo1-size");f&&(f.value=String(h.s||1));const y=document.getElementById("tpl-logo1-hide");y&&(y.checked=!!h.h)}catch(l){Kt(l,"تعذر حفظ القالب")}document.getElementById("tpl-logo2-apply")?.addEventListener("click",()=>{const l=document.getElementById("tpl-logo2-url")?.value?.trim()||"";ke({url:l});try{gt()}catch{}}),document.getElementById("tpl-logo2-clear")?.addEventListener("click",()=>{ke({url:"",w:0,x:0,y:0});try{const l=me(),p=localStorage.getItem(l);if(p){const m=JSON.parse(p);if(m){if(m.snap&&m.snap.r&&(m.snap.r.url=""),m.html&&typeof m.html=="string")try{const h=document.createElement("div");h.innerHTML=m.html;const f=h.firstElementChild,y=f&&f.querySelector(".cs-logo--right img");if(y){y.removeAttribute("src");const x=y.closest(".cs-logo--right");x&&x.setAttribute("data-empty","1")}m.html=f?f.outerHTML:m.html}catch{}localStorage.setItem(l,JSON.stringify(m))}}}catch{}try{kt(),Rt()}catch{}try{gt()}catch{}}),document.getElementById("tpl-logo2-reset")?.addEventListener("click",()=>{ke({x:0,y:0});try{gt()}catch{}}),document.getElementById("tpl-logo1-hide")?.addEventListener("change",l=>{const p=!!l?.target?.checked;try{sa({h:p})}catch{}try{gt()}catch{}}),document.getElementById("tpl-undo")?.addEventListener("click",()=>qo()),document.getElementById("tpl-redo")?.addEventListener("click",()=>jo());const c=document.getElementById("tpl-font-down"),i=document.getElementById("tpl-font-up");c?.addEventListener("click",l=>{try{dr(-1,{times:l&&l.shiftKey?2:1})}catch{}}),i?.addEventListener("click",l=>{try{dr(1,{times:l&&l.shiftKey?2:1})}catch{}}),document.getElementById("tpl-font-bold")?.addEventListener("click",()=>{try{cs()}catch{}});const u=document.getElementById("tpl-shade-apply"),d=document.getElementById("tpl-shade-clear");u?.addEventListener("click",()=>{try{is()}catch{}}),d?.addEventListener("click",()=>{try{ds()}catch{}})}function Ft(){const e=document.getElementById("templates-project")?.value||"";return ue().find(n=>String(n.id)===String(e))||null}function ge(t){const e=document.getElementById("templates-reservation");if(!e)return[];const n=e.value||"",r=ea(t);if(!n)return r;const a=r.find(s=>String(s.id||s.reservationId)===String(n));return a?[a]:[]}const Et={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",companyCR:"4030485240",companyLicense:"159460"};let jt=typeof localStorage<"u"&&localStorage.getItem("templates.lang")||"en";function sr(t){jt=t==="ar"?"ar":"en";try{localStorage.setItem("templates.lang",jt)}catch{}}function yt(t){try{const e=Math.round(Number(t)||0),n=jt==="ar"?"ar-SA":"en-US";return e.toLocaleString(n,{maximumFractionDigits:0,minimumFractionDigits:0,useGrouping:!0})}catch{const n=Math.round(Number(t)||0);return String(n)}}function ss(){return{headerFooter:!1,logoUrl:Et.logoUrl,companyName:Et.companyName,companyCR:Et.companyCR,companyLicense:Et.companyLicense}}function Mn(){try{return{url:localStorage.getItem("templates.callsheet.logo2.url")||"",s:Number(localStorage.getItem("templates.callsheet.logo2.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo2.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo2.y")||"0")||0}}catch{return{url:"",w:0,x:0,y:0}}}function ke(t={}){try{const n={...Mn(),...t};typeof n.url=="string"&&localStorage.setItem("templates.callsheet.logo2.url",n.url),Number.isFinite(n.s)&&localStorage.setItem("templates.callsheet.logo2.s",String(n.s)),Number.isFinite(n.x)&&localStorage.setItem("templates.callsheet.logo2.x",String(n.x)),Number.isFinite(n.y)&&localStorage.setItem("templates.callsheet.logo2.y",String(n.y))}catch{}}function Rn(){try{return{s:Number(localStorage.getItem("templates.callsheet.logo1.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo1.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo1.y")||"0")||0,h:localStorage.getItem("templates.callsheet.logo1.h")==="1"}}catch{return{s:1,x:0,y:0,h:!1}}}function sa(t={}){try{const n={...Rn(),...t};Number.isFinite(n.s)&&localStorage.setItem("templates.callsheet.logo1.s",String(n.s)),Number.isFinite(n.x)&&localStorage.setItem("templates.callsheet.logo1.x",String(n.x)),Number.isFinite(n.y)&&localStorage.setItem("templates.callsheet.logo1.y",String(n.y)),typeof n.h=="boolean"&&localStorage.setItem("templates.callsheet.logo1.h",n.h?"1":"0")}catch{}}let $e=!1,cr=null,lr=null,ir=null;function Mt(){$e=!0,clearTimeout(cr),cr=setTimeout(()=>{$e=!1;try{fs()}catch{}},1200)}function dr(t=0,{times:e=1}={}){try{const n=document.getElementById("templates-a4-root"),r=t>0?1:t<0?-1:0;if(e=Math.max(1,Math.min(5,Number(e)||1)),!n||r===0)return;const a=window.getSelection(),c=(()=>{let p=a&&a.anchorNode||document.activeElement;if(!p)return null;p.nodeType===3&&(p=p.parentElement);let m=p instanceof Element?p:null;for(;m&&m!==document.body;){if(m.hasAttribute&&m.hasAttribute("contenteditable"))return m;m=m.parentElement}return null})();if(!c)return;const i=Number.parseFloat(getComputedStyle(c).fontSize||"11")||11,o=(()=>{const p=Number.parseFloat(c.dataset.fontBase||"0");return Number.isFinite(p)&&p>0?p:i})();try{c.dataset.fontBase=String(o)}catch{}const u=o*5,d=o/5,l=()=>{const p=a&&a.rangeCount&&a.getRangeAt(0)?a.getRangeAt(0).commonAncestorContainer:c,m=p instanceof Element?p:p?.parentElement||c,h=Number.parseFloat(getComputedStyle(m).fontSize||String(o))||o,f=r>0?Math.min(u,h*2):Math.max(d,h*.5),y=x=>{try{x.style.fontSize=f+"px"}catch{}};if(a&&a.rangeCount>0&&!a.isCollapsed){const x=a.getRangeAt(0);if(c.contains(x.commonAncestorContainer))try{const I=document.createElement("span");I.style.fontSize=f+"px",I.appendChild(x.extractContents()),x.insertNode(I),a.removeAllRanges();const E=document.createRange();E.selectNodeContents(I),a.addRange(E)}catch{y(c)}else y(c)}else y(c)};for(let p=0;p<e;p+=1)l();try{kt(),Rt()}catch{}Mt()}catch{}}function cs(){try{if(!document.getElementById("templates-a4-root"))return;const e=window.getSelection(),r=(()=>{let i=e&&e.anchorNode||document.activeElement;if(!i)return null;i.nodeType===3&&(i=i.parentElement);let o=i instanceof Element?i:null;for(;o&&o!==document.body;){if(o.hasAttribute&&o.hasAttribute("contenteditable"))return o;o=o.parentElement}return null})();if(!r)return;const s=!(Number.parseInt(getComputedStyle(r).fontWeight||"400",10)>=600),c=i=>{try{i.style.fontWeight=s?"700":"400"}catch{}};if(e&&e.rangeCount>0&&!e.isCollapsed){const i=e.getRangeAt(0);if(r.contains(i.commonAncestorContainer))try{const o=document.createElement("span");o.style.fontWeight=s?"700":"400";const u=i.extractContents();o.appendChild(u),i.insertNode(o),e.removeAllRanges();const d=document.createRange();d.setStartAfter(o),d.setEndAfter(o),e.addRange(d)}catch{c(r)}else c(r)}else c(r);try{kt(),Rt()}catch{}Mt()}catch{}}function ls(t){try{let e=(t||"").trim();e.startsWith("#")&&(e=e.slice(1)),e.length===3&&(e=e.split("").map(c=>c+c).join(""));const n=parseInt(e,16),r=n>>16&255,a=n>>8&255,s=n&255;return{r,g:a,b:s}}catch{return{r:255,g:255,b:0}}}function ca(){try{const t=document.getElementById("templates-a4-root");if(!t)return null;const e=window.getSelection();let n=e&&e.anchorNode||document.activeElement;if(!n)return null;n.nodeType===3&&(n=n.parentElement);let r=n instanceof Element?n:null;for(;r&&r!==document.body;){if((r.tagName==="TD"||r.tagName==="TH")&&t.contains(r))return r;r=r.parentElement}return null}catch{return null}}function en(t,e){if(t)try{t.setAttribute("data-shaded","1"),t.style.setProperty("--shade",e),t.style.setProperty("background","var(--shade)","important"),t.style.setProperty("background-color","var(--shade)","important")}catch{}}function nn(t){if(t)try{t.removeAttribute("data-shaded"),t.style.removeProperty("--shade"),t.style.removeProperty("background"),t.style.removeProperty("background-color")}catch{}}function is(){const t=document.getElementById("tpl-shade-color"),e=document.getElementById("tpl-shade-opacity"),n=document.getElementById("tpl-shade-target"),{r,g:a,b:s}=ls(t?.value||"#fff59d"),c=Math.max(0,Math.min(100,Number(e?.value||40)))/100,i=`rgba(${r}, ${a}, ${s}, ${c})`,o=ca();if(!o)return;if((n?.value||"cell")==="row"){const d=o.closest("tr");d?Array.from(d.children).forEach(l=>en(l,i)):en(o,i)}else en(o,i);try{kt(),Rt(),Mt()}catch{}}function ds(){const t=ca();if(!t)return;if((document.getElementById("tpl-shade-target")?.value||"cell")==="row"){const r=t.closest("tr");r?Array.from(r.children).forEach(a=>nn(a)):nn(t)}else nn(t);try{kt(),Rt(),Mt()}catch{}}function me(){try{const t=Ft(),e=document.getElementById("templates-type"),n=e?e.value:"expenses",r=document.getElementById("templates-reservation"),a=r&&r.value?String(r.value):"all";return`templates.callsheet.autosave.${t?.id!=null?String(t.id):"no-project"}.${n}.${a}`}catch{return"templates.callsheet.autosave"}}function us(){try{const t=la();if(!t)return;let e="";try{const r=document.getElementById("templates-a4-root");r&&(e=r.outerHTML)}catch{}const n={v:1,ts:Date.now(),snap:t,html:e};localStorage.setItem(me(),JSON.stringify(n))}catch{}}function Rt(){clearTimeout(lr),lr=setTimeout(us,250)}function la(){const t=document.getElementById("templates-a4-root");if(!t)return null;const e=Array.from(t.querySelectorAll('[data-editable="true"]')).map(r=>r.innerHTML),n=Go(t);return{edits:e,l:Rn(),r:Mn(),sh:n}}function ps(t){if(!(!t||!document.getElementById("templates-preview-host")))try{sa(t.l||{}),ke(t.r||{});const n=document.getElementById("templates-a4-root");n&&Array.isArray(t.edits)&&Array.from(n.querySelectorAll('[data-editable="true"]')).forEach((a,s)=>{s<t.edits.length&&(a.innerHTML=t.edits[s])})}finally{try{gt()}catch{}}}function ia(){try{const t=`remoteAutosaveId:${me()}`,e=localStorage.getItem(t);return e?Number(e):null}catch{return null}}function ur(t){try{const e=`remoteAutosaveId:${me()}`;t&&localStorage.setItem(e,String(t))}catch{}}function kn(t){try{const e=document.createElement("div");return e.innerHTML=String(t||""),e.querySelectorAll("script").forEach(n=>n.parentElement?.removeChild(n)),Array.from(e.querySelectorAll("*")).forEach(n=>{try{Array.from(n.attributes||[]).forEach(a=>{/^on/i.test(a.name)&&n.removeAttribute(a.name)})}catch{}}),e.innerHTML}catch{return t}}async function ms(){let t=ia();if(t)return t;const n=(await Oe()||[]).find(d=>{const l=String(d?.title||"").toLowerCase();return l.includes("autosave")||l.includes("draft")||l.includes("مسودة")});if(n&&n.id)return ur(n.id),n.id;const r=Ft();if(!r)return null;const a=document.getElementById("templates-type"),s=a?a.value:"expenses",c=document.getElementById("templates-reservation"),i=c&&c.value?Number(c.value):null,o=document.querySelector("#templates-preview-host #templates-a4-root");if(!o)return null;const u={html:kn(o.outerHTML)};try{await Lt("/project-templates/",{method:"POST",body:{project_id:Number(r.id),reservation_id:i,type:s,title:`Autosave - ${s}`,data:u}});const l=(await Oe()||[]).find(p=>String(p?.title||"").toLowerCase().includes("autosave"));if(l&&l.id)return ur(l.id),l.id}catch{}return null}async function hs(){const t=document.querySelector("#templates-preview-host #templates-a4-root");if(!t)return;const e=await ms();if(!e)return;const n={html:kn(t.outerHTML)};try{await Lt(`/project-templates/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:{data:n}})}catch(r){Kt(r,"تعذر الحفظ التلقائي")}}function fs(){clearTimeout(ir),ir=setTimeout(()=>{hs()},800)}function gt(){const t=document.getElementById("templates-preview-host");if(!t)return;try{t.style.visibility="hidden"}catch{}const e=Ft(),n=t.querySelector("#templates-a4-root");if(!e){t.innerHTML="";const o=w("div",{class:"text-muted",text:O("projects.templates.empty","اختر مشروعاً لبدء إنشاء القوالب.")});t.appendChild(o);try{t.style.visibility=""}catch{}return}const r=ge(e.id),a=document.getElementById("templates-type")?.value||"expenses",s=ss();os(a);let c=null;c||(a==="callsheet"?c=Lo(e,r,s):c=No(e,r,s));const i=c;if(n&&i&&n.tagName===i.tagName){const o=n.querySelector("[data-a4-pages]"),u=i.querySelector("[data-a4-pages]");if(o&&u)try{o.replaceWith(u)}catch{n.innerHTML=i.innerHTML}else n.innerHTML=i.innerHTML;c=n}else t.innerHTML="",t.appendChild(i),c=i;try{re(c)}catch{}try{Fo(c,a)}catch{}try{ta({onAfterChange:()=>{try{kt(),Rt(),Mt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},30)}catch{}}})}catch{}try{Qr()}catch{}try{a==="callsheet"&&(gr(),yr(),De(),fn(),yn())}catch{}try{pr()}catch{}try{pr()}catch{}try{if(a==="callsheet"){const o=ge(e.id)?.[0]||null,u=()=>ln(o);Promise.resolve(Ja()).catch(()=>{}).finally(()=>{we()?.length?u():Qa().then(u).catch(()=>u())})}}catch{}try{a==="callsheet"&&ln(ge(e.id)?.[0]||null)}catch{}try{Array.from(c.querySelectorAll(".a4-page")).forEach(o=>{dn(o)||o.parentElement?.removeChild(o)})}catch{}try{hn()}catch{}Fn();try{un({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}try{Nn({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}try{Array.from(c.querySelectorAll(".a4-page")).forEach(o=>{dn(o)||o.parentElement?.removeChild(o)})}catch{}try{a==="callsheet"&&De()}catch{}try{a==="callsheet"&&(gr(),yr(),De(),fn(),yn(),re(c),Zt())}catch{}try{hn()}catch{}try{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0})}catch{}try{a==="callsheet"&&re(c)}catch{}try{pa()}catch{}try{a==="callsheet"&&localStorage.getItem("templates.debugOverlay")==="1"&&Co(c,ge(e.id)?.[0]||null)}catch{}try{a==="callsheet"&&re(c)}catch{}try{t.style.visibility=""}catch{}try{if(At=aa(),At==="fit")Ce();else{const o=ra();Gt=o,Ee(o,{silent:!0})}xe&&(xe.textContent=`${Math.round(Gt*100)}%`)}catch{}}function pr(){const t=document.getElementById("templates-a4-root");if(!t)return;Array.from(t.querySelectorAll("table.exp-details td")).forEach(n=>{try{if(n===n.parentElement?.lastElementChild){n.removeAttribute("contenteditable"),n.removeAttribute("data-editable");return}if(!(n.getAttribute("data-editable")==="true"||n.getAttribute("contenteditable")==="true"||!!n.querySelector('[contenteditable="true"]')))return;const s=n.querySelector('[contenteditable="true"]');if(s){const c=s.innerHTML;n.innerHTML=c}n.setAttribute("data-editable","true"),n.setAttribute("contenteditable","true"),n.setAttribute("autocapitalize","off"),n.setAttribute("autocorrect","off"),n.setAttribute("autocomplete","off"),n.setAttribute("spellcheck","false")}catch{}})}async function Dn(){const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t){alert("لا يوجد محتوى للطباعة");return}const e=document.getElementById("templates-type")?.value||"expenses",r=(a=>{try{const c=`templatesPdf.orientation.${a}`,i=ft(c,"");if(i==="portrait"||i==="landscape")return i}catch{}return{expenses:"portrait",callsheet:"landscape"}[a]||"landscape"})(e);if(e==="callsheet"){try{await(await Wn(async()=>{const{printCallsheetFromHost:a}=await import("./print.DhOIqY7E.js");return{printCallsheetFromHost:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),import.meta.url)).printCallsheetFromHost(t)}catch{alert("تعذر إنشاء PDF")}return}else{try{const{printGenericTemplate:a}=await Wn(async()=>{const{printGenericTemplate:s}=await import("./print.DhOIqY7E.js");return{printGenericTemplate:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),import.meta.url);await a(t,{orientation:r,filename:`template-${e}.pdf`})}catch{alert("تعذر إنشاء PDF")}return}}function ys(){try{const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t){alert("لا يوجد محتوى للمعاينة");return}const e=document.createElement("div");Object.assign(e.style,{position:"fixed",inset:"0",background:"rgba(15,23,42,0.6)",zIndex:"9998",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"});const n=document.createElement("div");Object.assign(n.style,{background:"#fff",borderRadius:"12px",maxWidth:"92vw",maxHeight:"88vh",width:"min(1200px,92vw)",padding:"12px",boxShadow:"0 12px 30px rgba(0,0,0,0.25)",display:"flex",flexDirection:"column",gap:"12px"});const r=document.createElement("div");r.textContent="معاينة الطباعة",r.style.cssText="font-weight:800;font-size:16px";const a=document.createElement("div");Object.assign(a.style,{overflow:"auto",flex:"1 1 auto",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"10px",background:"#f8fafc"});const s=document.createElement("div");Object.assign(s.style,{display:"flex",gap:"8px",justifyContent:"flex-start"});const c=document.createElement("button");c.className="btn btn-outline",c.textContent="إغلاق",c.onclick=()=>e.remove();const i=document.createElement("button");i.className="btn btn-primary",i.textContent="طباعة الآن",i.onclick=async()=>{e.remove();try{await Dn()}catch{}},s.appendChild(i),s.appendChild(c);const o=t.cloneNode(!0),u=o.querySelector("[data-a4-pages]")||o,d=Array.from(u.querySelectorAll(".a4-page")),l=f=>{try{const y=!!f.querySelector("#expenses-top-sheet"),x=!!f.querySelector('table.exp-details tbody tr[data-row="item"]'),I=!!Array.from(f.querySelectorAll("table.tpl-table tbody tr")).find(g=>Array.from(g.querySelectorAll("td")).some(v=>(v.textContent||"").trim().length>0)),E=!!Array.from(f.querySelectorAll(".callsheet-v1 table.cs-crew tbody tr")).find(g=>Array.from(g.querySelectorAll("td")).some(v=>(v.textContent||"").trim().length>0)),A=!!f.querySelector(".callsheet-v1 .cs-header, .callsheet-v1 .cs-info td, .callsheet-v1 .cs-cast td");return y||x||I||E||A}catch{return!0}};d.forEach(f=>{l(f)||f.parentElement?.removeChild(f)});const p=Array.from(u.querySelectorAll(".a4-page")),m=document.createElement("div");m.textContent=`عدد الصفحات: ${p.length}`,m.style.cssText="font-size:12px;color:#475569";const h=document.createElement("div");Object.assign(h.style,{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(360px, 1fr))",gap:"14px"}),p.forEach(f=>{const y=document.createElement("div");Object.assign(y.style,{background:"#fff",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"6px",display:"flex",justifyContent:"center",alignItems:"center"});const x=f.cloneNode(!0);Object.assign(x.style,{transform:"scale(0.45)",transformOrigin:"top left",width:f.clientWidth+"px",height:f.clientHeight+"px"}),y.appendChild(x),h.appendChild(y)}),a.appendChild(m),a.appendChild(h),n.appendChild(r),n.appendChild(a),n.appendChild(s),e.appendChild(n),document.body.appendChild(e)}catch{alert("تعذر إنشاء المعاينة")}}async function mr(t=!1){try{const e=document.getElementById("templates-a4-root");if(!e){alert("لا يوجد محتوى");return}const n=e.querySelector(".callsheet-v1 table.cs-crew");if(!n){alert("لا يوجد جدول Crew في القالب الحالي");return}const r=Ft(),a=r&&ge(r.id)?.[0]||null;if(!a){alert("اختر حجزاً مرتبطاً أولاً");return}t?Ur(n,a):ln(a);try{Bt("تم جلب بيانات الطاقم","success",2500)}catch{}}catch{alert("تعذر جلب بيانات الطاقم")}}function da(){try{return`templatesPdf.${document.getElementById("templates-type")?.value||"expenses"}`}catch{return"templatesPdf.expenses"}}function ua(t){const e=String(t||"").replace(/^templatesPdf[.:]/,"");return{ns:`${da()}.${e}`,legacy:`templatesPdf.${e}`}}function ft(t,e){try{const{ns:n,legacy:r}=ua(t);let a=localStorage.getItem(n);if(a==null&&(a=localStorage.getItem(r)),a==null)return e;const s=Number(a);return Number.isFinite(s)?s:e}catch{return e}}function hr(t,e){try{const{ns:n}=ua(t);localStorage.setItem(n,String(e))}catch{}}function qn(){return`${da()}.pageOverrides`}function jn(){try{const t=localStorage.getItem(qn());return t?JSON.parse(t):{}}catch{return{}}}function It(t,e,n){try{const r=jn(),a=String(t);r[a]=r[a]||{},r[a][e]=Number(n),localStorage.setItem(qn(),JSON.stringify(r))}catch{}}function Vt(t,e,n){try{const a=jn()[String(e)];return a&&a[t]!=null&&Number.isFinite(Number(a[t]))?Number(a[t]):ft(t,n)}catch{return ft(t,n)}}function gs(){try{localStorage.removeItem(qn())}catch{}}async function bs(){const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t)return;const n=(document.getElementById("templates-type")?.value||"expenses")!=="expenses";try{const W=document.getElementById("templates-pdf-live-slot");W&&(W.innerHTML='<div style="padding:8px;color:#64748b">… جار إنشاء المعاينة</div>')}catch{}let r;try{r=await oo()}catch{r=null}let a=window.html2canvas;if(typeof a!="function"){try{await Dr("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js")}catch{}a=window.html2canvas}if(typeof a!="function"){const W=document.getElementById("templates-pdf-live-slot");W&&(W.innerHTML='<div style="padding:8px;color:#ef4444">تعذر تحميل html2canvas لمعاينة PDF. تأكد من اتصال الشبكة ثم أعد المحاولة.</div>');return}const s=n?1123:794,c=n?794:1123,i=n?297:210,u=96/25.4,d=document.getElementById("pdftun-page")?.value,l=Math.max(0,Number(d??0)||0),p=Array.from(t.querySelectorAll(".a4-page")),m=p[l]||p[0];if(!m)return;const h=document.createElement("div");Object.assign(h.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const f=document.createElement("div");f.id="templates-a4-root",f.setAttribute("data-render-context","export"),f.setAttribute("dir",t.getAttribute("dir")||document.documentElement.getAttribute("dir")||"rtl");const y=document.createElement("div");y.setAttribute("data-a4-pages","");const x=m.cloneNode(!0);x.style.width=`${s}px`,x.style.height=`${c}px`,x.style.background="#ffffff",x.style.overflow="hidden";try{((et,ut)=>{const nt=et.querySelector("table.exp-details");if(!nt)return;const pt=nt.tBodies&&nt.tBodies[0];if(!pt||!!!pt.querySelector('tr[data-row="item"]'))return;const rt=pt.firstElementChild;if(rt&&rt.hasAttribute&&rt.hasAttribute("data-group-bar"))return;let xt=et.querySelector("tbody > tr[data-group-bar]");!xt&&ut&&(xt=ut.querySelector("tbody > tr[data-group-bar]")),xt&&pt.insertBefore(xt.cloneNode(!0),pt.firstElementChild)})(x,m)}catch{}y.appendChild(x),f.appendChild(y),h.appendChild(f),document.body.appendChild(h);const I=Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),E={scale:I,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},A=(W,et=246)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W;for(let ot=0;ot<pt;ot+=2){const rt=ut.getImageData(0,ot,nt,1).data;let xt=0;for(let lt=0;lt<nt;lt+=1){const ht=lt*4;if((rt[ht]<et||rt[ht+1]<et||rt[ht+2]<et)&&++xt>Math.max(2,Math.ceil(nt*.003)))return ot}}return 0}catch{return 0}},g=(W,et=244)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W,ot=Math.floor(nt*.55),rt=Math.max(10,nt-ot),xt=Math.max(3,Math.ceil(rt*.015));for(let lt=0;lt<pt;lt+=2){const ht=ut.getImageData(ot,lt,rt,1).data;let he=0;for(let fe=0;fe<rt;fe+=1){const Yt=fe*4,ye=ht[Yt],Ye=ht[Yt+1],Ge=ht[Yt+2];if((ye<et||Ye<et||Ge<et)&&++he>=xt)return lt}}return 0}catch{return 0}},v=(W,et=244)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W,ot=Math.floor(nt*.2),rt=Math.max(10,Math.floor(nt*.6)),xt=Math.max(12,Math.ceil(rt*.08)),lt=4;for(let ht=lt;ht<pt;ht+=2){const he=ut.getImageData(ot,ht,rt,1).data;let fe=0;for(let Yt=0;Yt<rt;Yt+=1){const ye=Yt*4,Ye=he[ye],Ge=he[ye+1],Aa=he[ye+2];if((Ye<et||Ge<et||Aa<et)&&++fe>=xt)return ht}}return 0}catch{return 0}},T=(W,et=246)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W;for(let ot=pt-1;ot>=0;ot-=2){const rt=ut.getImageData(0,ot,nt,1).data;let xt=0;for(let lt=0;lt<nt;lt+=1){const ht=lt*4;if((rt[ht]<et||rt[ht+1]<et||rt[ht+2]<et)&&++xt>Math.max(2,Math.ceil(nt*.003)))return pt-1-ot}}return 0}catch{return 0}},P=(W,et,ut)=>{try{const{width:nt,height:pt}=W,ot=Math.max(0,Math.min(pt-1,Math.round(et))),rt=Math.max(0,Math.min(pt-ot,Math.round(ut))),xt=Math.max(1,pt-ot-rt);if(ot===0&&rt===0)return W;const lt=document.createElement("canvas");return lt.width=nt,lt.height=xt,lt.getContext("2d").drawImage(W,0,-ot),lt}catch{return W}};let L=0;try{const W=x.querySelector(".a4-inner")||x,et=W.querySelector(".exp-masthead")||W.firstElementChild;if(et){const ut=x.getBoundingClientRect(),nt=et.getBoundingClientRect();L=Math.max(0,nt.top-ut.top)}}catch{L=0}let C;try{await ko(f),C=await a(x,{...E,scrollX:0,scrollY:0,windowWidth:s,windowHeight:c})}finally{try{h.parentNode?.removeChild(h)}catch{}}if(!C)return;const B=A(C,246),R=g(C,244),N=v(C,244),b=document.getElementById("pdftun-page")?.value||"all",k=b==="all"?0:Math.max(0,Number(b)||0),q=Vt("templatesPdf.extraTrimMm",k,ft("templatesPdf.extraTrimMm",14)),M=Vt("templatesPdf.safeMarginMm",k,ft("templatesPdf.safeMarginMm",.5)),j=Math.max(N,L*I),X=q*u*I,_=M*u*I,D=Math.max(B,R,N),H=Math.min(Math.max(0,D+X),Math.max(0,j-_)),F=T(C,246),Y=P(C,H,F),G=ft("templatesPdf.scalePct",100)/100,K=Math.max(.98,Math.min(1,G||1)),z=i*K,V=Y.height/Y.width*z,at=Vt("templatesPdf.shiftRightMm",l,ft("templatesPdf.shiftRightMm",40)),st=ft("templatesPdf.globalAllRightMm",0),mt=l===0?ft("templatesPdf.tightFudgeMm",-144.5):0,_t=Vt("templatesPdf.tightFudgeMm",l,mt),Pt=ft("templatesPdf.globalYmm",0),St=ft("templatesPdf.globalAllYmm",-1),te=at+st;let Te=-(Math.max(0,L*I-H)*(z/Y.width))+_t+Pt+St;const Dt=document.createElement("canvas");Dt.width=s,Dt.height=c;const Ot=Dt.getContext("2d");Ot.fillStyle="#ffffff",Ot.fillRect(0,0,Dt.width,Dt.height);const Le=Math.round(te*u),Pe=Math.round(Te*u),$=Math.round(z*u),J=Math.round(V*u);try{Ot.drawImage(Y,Le,Pe,$,J)}catch{}const ct=document.getElementById("templates-pdf-live-slot");if(ct){ct.innerHTML="";const W=document.createElement("img");W.src=Dt.toDataURL("image/png"),W.style.maxWidth="100%",W.style.height="auto",W.style.border="1px solid #e5e7eb",ct.appendChild(W)}}function pa(){const t=document.getElementById("templates-controls");if(!t||document.getElementById("templates-pdf-tuner-toggle"))return;const e=t.querySelector(".ms-auto")||t,n=document.createElement("button");n.type="button",n.id="templates-pdf-tuner-toggle",n.className="btn btn-outline",n.textContent="🛠️ ضبط PDF",e.appendChild(n);const r=document.createElement("div");r.id="templates-pdf-tuner",r.style.display="none",r.style.marginTop="10px",r.style.border="1px solid #e5e7eb",r.style.borderRadius="10px",r.style.padding="10px",r.innerHTML=`
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>الصفحة</span>
        <select id="pdftun-page" style="width:110px;"></select>
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Offset (All)</span>
        <input id="pdftun-globalY" type="number" step="0.5" min="-1000" max="1000" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Right Shift (All)</span>
        <input id="pdftun-globalX" type="number" step="0.5" min="-1000" max="1000" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Trim (mm)</span>
        <input id="pdftun-extraTrim" type="number" step="0.5" min="0" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Safe Margin (mm)</span>
        <input id="pdftun-safeMargin" type="number" step="0.1" min="0" max="10" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Offset (mm)</span>
        <input id="pdftun-tightFudge" type="number" step="0.5" min="-40" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Right Shift (mm)</span>
        <input id="pdftun-right" type="number" step="0.5" min="-40" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Scale (%)</span>
        <input id="pdftun-scale" type="number" step="1" min="90" max="110" style="width:90px;" />
      </label>
      <span style="flex:1 1 auto"></span>
      <button type="button" class="btn btn-outline" id="pdftun-preset">تطبيق القيم</button>
      <button type="button" class="btn btn-outline" id="pdftun-reset">الافتراضيات</button>
      <button type="button" class="btn btn-primary" id="pdftun-print">🖨️ طباعة</button>
    </div>
  `,t.parentElement?.appendChild(r);const a=()=>{const u=r.querySelector("#pdftun-page"),d=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page")),l=u.value||"0",p=[];d.forEach((m,h)=>{p.push(`<option value="${h}">الصفحة ${h+1}</option>`)}),p.length?u.innerHTML=p.join(""):(u.innerHTML='<option value="0">الصفحة 1</option>',setTimeout(()=>{try{a()}catch{}},120)),Array.from(u.options).some(m=>m.value===l)?u.value=l:u.value="0"},s=()=>{const u=r.querySelector("#pdftun-page"),d=Math.max(0,Number(u.value||"0")),l=Vt("templatesPdf.extraTrimMm",d,ft("templatesPdf.extraTrimMm",14)),p=Vt("templatesPdf.safeMarginMm",d,ft("templatesPdf.safeMarginMm",.5));document.getElementById("pdftun-extraTrim").value=String(l),document.getElementById("pdftun-safeMargin").value=String(p);const h=Vt("templatesPdf.tightFudgeMm",d,d===0?-144.5:0),f=Vt("templatesPdf.shiftRightMm",d,ft("templatesPdf.shiftRightMm",40));document.getElementById("pdftun-tightFudge").value=String(h),document.getElementById("pdftun-right").value=String(f),document.getElementById("pdftun-scale").value=String(ft("templatesPdf.scalePct",100));try{document.getElementById("pdftun-globalY").value=String(ft("templatesPdf.globalAllYmm",-1))}catch{}try{document.getElementById("pdftun-globalX").value=String(ft("templatesPdf.globalAllRightMm",0))}catch{}},c=()=>{a(),s()};c(),n.addEventListener("click",()=>{if(r.style.display=r.style.display==="none"?"block":"none",r.style.display==="block"){try{a(),s()}catch{}try{const u=jn();if(u&&Object.keys(u).length===0&&!localStorage.getItem("templatesPdf.presetSeeded.v4")){const d=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page"));if(d.length){const m=[-145,-290,-435,-580,-725],h=[14,14,14,14,14],f=-145;d.forEach((y,x)=>{const I=x<m.length?m[x]:m[m.length-1]+f*(x-(m.length-1)),E=x<h.length?h[x]:h[h.length-1];It(x,"templatesPdf.shiftRightMm",61),It(x,"templatesPdf.tightFudgeMm",I),It(x,"templatesPdf.extraTrimMm",E),It(x,"templatesPdf.safeMarginMm",.5)}),localStorage.setItem("templatesPdf.presetSeeded.v4","1");try{localStorage.setItem("templatesPdf.globalAllYmm","-1")}catch{}s()}}}catch{}try{if(window.__pdfTunerMO)try{window.__pdfTunerMO.disconnect()}catch{}const u=document.querySelector("#templates-preview-host #templates-a4-root [data-a4-pages]")||document.querySelector("#templates-preview-host #templates-a4-root");if(u){const d=new MutationObserver(()=>{try{a()}catch{}});d.observe(u,{childList:!0,subtree:!0}),window.__pdfTunerMO=d}}catch{}bs()}else try{window.__pdfTunerMO&&(window.__pdfTunerMO.disconnect(),window.__pdfTunerMO=null)}catch{}}),r.querySelector("#pdftun-page").addEventListener("change",()=>{s()});const i=(u,d,l=!0)=>{const p=document.getElementById(u);p.addEventListener("input",()=>{const m=p.value;if(l){const h=r.querySelector("#pdftun-page").value||"0";It(Number(h),d,m)}else hr(d,m)}),p.addEventListener("change",()=>{const m=p.value;if(l){const h=r.querySelector("#pdftun-page").value||"0";It(Number(h),d,m)}else hr(d,m)})};i("pdftun-extraTrim","templatesPdf.extraTrimMm",!0),i("pdftun-safeMargin","templatesPdf.safeMarginMm",!0),i("pdftun-tightFudge","templatesPdf.tightFudgeMm",!0),i("pdftun-right","templatesPdf.shiftRightMm",!0),i("pdftun-scale","templatesPdf.scalePct",!1),i("pdftun-globalY","templatesPdf.globalAllYmm",!1),i("pdftun-globalX","templatesPdf.globalAllRightMm",!1);const o=()=>{const u=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page")),d=61,l=.5,p=[-145,-290,-435,-580,-725],m=[14,14,14,14,14],h=-145;u.forEach((f,y)=>{const x=y<p.length?p[y]:p[p.length-1]+h*(y-(p.length-1)),I=y<m.length?m[y]:m[m.length-1];It(y,"templatesPdf.shiftRightMm",d),It(y,"templatesPdf.tightFudgeMm",x),It(y,"templatesPdf.extraTrimMm",I),It(y,"templatesPdf.safeMarginMm",l)});try{localStorage.setItem("templatesPdf.globalAllYmm","-1")}catch{}s()};document.getElementById("pdftun-preset").addEventListener("click",o),document.getElementById("pdftun-reset").addEventListener("click",()=>{try{["templatesPdf.extraTrimMm","templatesPdf.safeMarginMm","templatesPdf.tightFudgeMm","templatesPdf.shiftRightMm","templatesPdf.scalePct","templatesPdf.globalYmm","templatesPdf.globalAllYmm","templatesPdf.globalAllRightMm"].forEach(u=>localStorage.removeItem(u)),gs()}catch{}c()}),document.getElementById("pdftun-print").addEventListener("click",Dn);try{window.__pdfTunerRefreshPages=a,window.__pdfTunerLoadValues=s}catch{}}function fr(){const t=document.getElementById("templates-project");if(!t)return;const e=ue().map(n=>({id:n.id,title:n.title||`#${n.id}`}));t.innerHTML='<option value="">— اختر —</option>'+e.map(n=>`<option value="${String(n.id)}">${n.title}</option>`).join("")}function rn(t){const e=document.getElementById("templates-reservation");if(!e)return;const n=t?ea(t):[],r=['<option value="" selected>— بدون ربط —</option>'];n.forEach(a=>{const s=a.id??a.reservationId,c=(a.title||"").trim()||`#${s}`;r.push(`<option value="${String(s)}">${c}</option>`)}),e.innerHTML=r.join("")}function Fn(){const t=Array.from(document.querySelectorAll("#templates-preview-host table.exp-details")),e=document.querySelector("#templates-preview-host #expenses-table"),n=t.length?t:e?[e]:[];if(!n.length)return;if(n[0].classList.contains("exp-table")){const h=(N,b=0)=>{const q=String(N||"").replace(/[\u0660-\u0669]/g,j=>"0123456789"[j.charCodeAt(0)-1632]).replace(/[\u06F0-\u06F9]/g,j=>"0123456789"[j.charCodeAt(0)-1776]).replace(/[\u066B]/g,".").replace(/[\u066C]/g,"").replace(/[\u200f\u200e]/g,"").replace(/[^\d.\-]/g,""),M=Number(q);return Number.isFinite(M)?M:b},f={atl:0,prod:0,post:0};let y=0;const x={},I={};n.flatMap(N=>Array.from(N.querySelectorAll("tbody tr[data-subgroup-header]"))).forEach(N=>{const b=N.getAttribute("data-subgroup");let k=0,q=0,M=N.nextElementSibling;for(;M&&!M.hasAttribute("data-subgroup-header")&&!M.hasAttribute("data-subgroup-subtotal");){if(M.getAttribute("data-row")==="item"){const D=M.children,H=h(D[2]?.textContent,0),F=h(D[3]?.textContent,1),Y=h(D[4]?.textContent,1),G=F*Y*H;if(D[6]){D[6].textContent=yt(G);try{D[6].setAttribute("data-num","1")}catch{}}k+=G,(String(D[1]?.textContent||"").trim().length||h(D[2]?.textContent,0)||h(D[3]?.textContent,0))&&(q+=1)}M=M.nextElementSibling}const j=document.querySelector(`#templates-preview-host [data-subtotal="${CSS.escape(b)}"]`);j&&(j.textContent=yt(k)),x[b]=k,I[b]=q,y+=k;const _=document.querySelector(`#templates-preview-host tr[data-subgroup-marker="${CSS.escape(b)}"]`)?.getAttribute("data-parent-group")||null;_&&f[_]!=null&&(f[_]+=k)}),Object.entries(f).forEach(([N,b])=>{const k=document.querySelector(`#templates-preview-host [data-total-group="${CSS.escape(N)}"]`);k&&(k.textContent=yt(b))});const A=document.querySelector("#templates-preview-host [data-grand-total]");A&&(A.textContent=yt(y));try{Object.entries(x).forEach(([b,k])=>{const q=I[b]||0,M=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-count="${CSS.escape(b)}"]`),j=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-total="${CSS.escape(b)}"]`);M&&(M.textContent=yt(q)),j&&(j.textContent=yt(k))}),Object.entries(f).forEach(([b,k])=>{const q=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-total-group="${CSS.escape(b)}"]`);q&&(q.textContent=yt(k))});const N=document.querySelector("#templates-preview-host #expenses-top-sheet [data-top-grand]");N&&(N.textContent=yt(y))}catch{}const g=Ft(),v=O("reservations.create.summary.currency","SR"),T=!!g?.applyTax,P=T?Math.round(y*Un):0,L=Math.round(y+P),C=document.querySelector("#expenses-summary [data-summary-subtotal]"),B=document.querySelector("#expenses-summary [data-summary-tax]"),R=document.querySelector("#expenses-summary [data-summary-total]");C&&(C.textContent=`${yt(y)} ${v}`),B&&(B.textContent=T?`${yt(P)} ${v}`:`0 ${v}`),R&&(R.textContent=`${yt(L)} ${v}`);try{const N=document.activeElement;!!(N&&(N.getAttribute("contenteditable")==="true"||N.closest('[contenteditable="true"]'))&&N.closest("#templates-a4-root table.exp-details"))||requestAnimationFrame(()=>{try{un({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}})}catch{}return}let r=0,a=0;Array.from(e.querySelectorAll("tbody tr")).forEach(h=>{if(h.matches("[data-section-bar]")){r=0;return}if(h.classList.contains("tpl-subtotal-row")){const I=h.querySelector("[data-subtotal]")||h.children[5];I&&(I.textContent=yt(r||0));return}const f=Number(String(h.children[3]?.textContent||"1").replace(/[^\d.\-]/g,""))||1,y=Number(String(h.children[4]?.textContent||"0").replace(/[^\d.\-]/g,""))||0,x=f*y;h.children[5]&&(h.children[5].textContent=yt(x)),r+=x,a+=x});const c=Ft(),i=O("reservations.create.summary.currency","SR"),o=!!c?.applyTax,u=o?Math.round(a*Un):0,d=Math.round(a+u),l=document.querySelector("#expenses-summary [data-summary-subtotal]"),p=document.querySelector("#expenses-summary [data-summary-tax]"),m=document.querySelector("#expenses-summary [data-summary-total]");l&&(l.textContent=`${yt(a)} ${i}`),p&&(p.textContent=o?`${yt(u)} ${i}`:`0 ${i}`),m&&(m.textContent=`${yt(d)} ${i}`);try{const h=document.activeElement;!!(h&&(h.getAttribute("contenteditable")==="true"||h.closest('[contenteditable="true"]'))&&h.closest("#templates-a4-root table.exp-details"))||(requestAnimationFrame(()=>{try{un({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}}),requestAnimationFrame(()=>{try{Nn({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}}))}catch{}}function hn(){const t=document.querySelector("#templates-preview-host #templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll("table.exp-details"));if(!e.length)return;const n=new Map,r=i=>i?.hasAttribute("data-subgroup-header"),a=i=>i?.hasAttribute("data-subgroup-subtotal"),s=i=>i?.getAttribute("data-row")==="item",c=i=>String(i||"").split("-")[0]||"";e.forEach(i=>{const o=Array.from(i.querySelectorAll("tbody > tr"));let u=null,d="",l=0;o.forEach(p=>{if(r(p)){u=p.getAttribute("data-subgroup"),d=c(u),l=n.get(u)||0;return}if(a(p)){n.set(u,l),u=null,d="";return}if(s(p)&&d){l+=1;const m=p.children[0];if(m&&m.hasAttribute("contenteditable")){const h=String(l).padStart(2,"0");m.textContent=`${d}-${h}`}}}),u&&n.set(u,l)})}function yr(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]");if(!e||t.querySelector("table.cs-crew"))return;const r=document.createElement("section");r.className="a4-page a4-page--landscape";const a=document.createElement("div");a.className="a4-inner";const s=document.createElement("div");s.className="callsheet-v1",r.appendChild(a),a.appendChild(s);const c=document.createElement("table");c.className="tpl-table cs-crew",c.setAttribute("data-editable-table","crew");const i=[30,34,20,16],o=document.createElement("colgroup");i.forEach(h=>{const f=document.createElement("col");f.setAttribute("style",`width:${h}%`),o.appendChild(f)}),c.appendChild(o);const u=document.createElement("thead"),d=document.createElement("tr"),l=document.createElement("th");l.setAttribute("colspan",String(i.length)),l.className="cs-crew-title",l.textContent="Crew Call",d.appendChild(l),u.appendChild(d);const p=document.createElement("tr");["Position","Name","Phone","Time"].forEach((h,f)=>{const y=document.createElement("th");y.textContent=h,y.setAttribute("style",`width:${i[f]}%`),p.appendChild(y)}),u.appendChild(p),c.appendChild(u);const m=document.createElement("tbody");for(let h=0;h<18;h+=1){const f=document.createElement("tr");for(let y=0;y<4;y+=1){const x=document.createElement("td");x.setAttribute("data-editable","true"),x.setAttribute("contenteditable","true"),y===2&&(x.setAttribute("dir","ltr"),x.style.direction="ltr"),f.appendChild(x)}m.appendChild(f)}c.appendChild(m),s.appendChild(c),e.insertBefore(r,e.children[1]||null);try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},20)}catch{}}function gr(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll(".callsheet-v1"));if(e.length)try{const n=[];e.forEach(o=>{n.push(...Array.from(o.getElementsByTagName("table")))});const r=o=>!!(o.classList&&o.classList.contains("cs-crew")),a=o=>{try{return r(o)?!0:((o.querySelector("thead")?.textContent||o.textContent||"")+"").toLowerCase().includes("crew call")}catch{return!1}},s=n.filter(a);if(!s.length)return;let c=null;const i=s.filter(r);i.length?c=i[i.length-1]:c=s[0],s.forEach(o=>{if(o!==c)try{o.parentElement?.removeChild(o)}catch{}})}catch{}}function De(){try{const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]");if(!e)return;const n=t.querySelector("table.cs-crew");if(!n)return;const r=n.closest(".a4-page"),a=Array.from(e.querySelectorAll(".a4-page"));r&&a.indexOf(r)!==1&&e.insertBefore(r,e.children[1]||null);const s=r?r.querySelector("table.cs-schedule"):null;if(s){const c=document.createElement("section");c.className="a4-page a4-page--landscape";const i=document.createElement("div");i.className="a4-inner";const o=document.createElement("div");o.className="callsheet-v1",c.appendChild(i),i.appendChild(o),o.appendChild(s),e.insertBefore(c,e.children[2]||null)}}catch{}}function fn(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll(".callsheet-v1 table.cs-crew"));if(e.length<=1)return;const n=l=>{try{return!!l.querySelector("thead .cs-crew-title")}catch{return!1}},r=l=>{try{return Array.from(l.querySelectorAll("tbody td")).reduce((m,h)=>m+((h.textContent||"").trim().length>0?1:0),0)}catch{return 0}};let a=null;const s=e.filter(n);if(s.length)a=s[s.length-1];else{a=e[0];let l=r(a);e.slice(1).forEach(p=>{const m=r(p);m>l&&(a=p,l=m)})}const c=a.tBodies&&a.tBodies[0];if(!c)return;const i=l=>{for(let p=0;p<l;p+=1){const m=document.createElement("tr");for(let h=0;h<4;h+=1){const f=document.createElement("td");f.setAttribute("data-editable","true"),f.setAttribute("contenteditable","true"),m.appendChild(f)}c.appendChild(m)}},o=[];e.forEach(l=>{if(l===a||!n(l))return;const p=l.tBodies&&l.tBodies[0];p&&Array.from(p.children).forEach(m=>{const h=Array.from(m.children);h.some(y=>(y.textContent||"").trim().length>0)&&o.push(h.map(y=>y.textContent||""))})}),o.length&&i(Math.max(0,o.length-(c.children?.length||0)));const u=l=>Array.from(l.children).every(p=>!(p.textContent||"").trim().length);let d=0;Array.from(c.children).forEach(l=>{if(d>=o.length||!u(l))return;const p=o[d++],m=Array.from(l.children);for(let h=0;h<Math.min(m.length,p.length);h+=1)m[h].textContent=p[h]||""}),e.forEach(l=>{if(l!==a)try{l.parentElement?.removeChild(l)}catch{}})}function yn(){try{const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]"),n=e?Array.from(e.querySelectorAll(".a4-page")):[],r=m=>{const h=m?.closest?.(".a4-page");return h?n.indexOf(h):-1},a=Array.from(t.getElementsByTagName("table")),s=m=>!!(m.classList&&m.classList.contains("cs-crew")),c=["crew call","crewcall","crew","طاقم","طاقم العمل","كرو","كرو كول"],i=m=>{try{if(s(m))return!0;const h=((m.querySelector("thead")?.textContent||m.textContent||"")+"").toLowerCase();return c.some(f=>h.includes(f))}catch{return!1}},o=a.filter(i);if(o.length<=1)return;let u=null;const d=o.filter(s);u=d.find(m=>r(m)===1)||d[d.length-1]||o[0];const l=u.tBodies&&u.tBodies[0],p=m=>{for(let h=0;h<m;h+=1){const f=document.createElement("tr");for(let y=0;y<4;y+=1){const x=document.createElement("td");x.setAttribute("data-editable","true"),x.setAttribute("contenteditable","true"),f.appendChild(x)}l.appendChild(f)}};o.forEach(m=>{if(m!==u){if(s(m)){const h=m.tBodies&&m.tBodies[0];if(!h){try{m.remove()}catch{}return}const y=Array.from(h.children).map(I=>Array.from(I.children).map(E=>E.textContent||"")).filter(I=>I.some(E=>(E||"").trim().length>0));y.length&&p(Math.max(0,y.length-(l?.children?.length||0)));let x=0;Array.from(l.children).forEach(I=>{if(x>=y.length)return;const E=Array.from(I.children);if(!E.every(v=>!(v.textContent||"").trim().length))return;const g=y[x++];for(let v=0;v<Math.min(E.length,g.length);v+=1)E[v].textContent=g[v]||""})}try{m.parentElement?.removeChild(m)}catch{}}});try{const m=u.closest(".a4-page");m&&e&&Array.from(e.children).indexOf(m)!==1&&e.insertBefore(m,e.children[1]||null)}catch{}}catch{}}async function br({copy:t=!1}={}){const e=Ft();if(!e)throw alert("اختر مشروعاً أولاً"),new Error("No project selected");const n=document.getElementById("templates-type"),r=n?n.value:"expenses",a=document.getElementById("templates-reservation"),s=a&&a.value?Number(a.value):null,c=document.querySelector("#templates-preview-host #templates-a4-root");if(!c)throw alert("لا يوجد محتوى للحفظ"),new Error("No template root to save");const i={html:kn(c.outerHTML)},o=document.getElementById("templates-save-title"),u=o&&o.value?String(o.value).trim():"";await Lt("/project-templates/",{method:"POST",body:{project_id:Number(e.id),reservation_id:s,type:r,title:u||`${e.title||"Template"} - ${r}`,data:i}}),alert("تم حفظ القالب");try{localStorage.removeItem(me())}catch{}}async function Oe(){const t=Ft();if(!t)return[];const e=document.getElementById("templates-type");let n=e?e.value:"expenses";const r=n==="callsheet"?["callsheet","call-sheet","callsheet_v1","callsheetv1","callsheet-v1"]:[n],a=new Set,s=[],c=i=>Array.isArray(i?.data)?i.data:Array.isArray(i)?i:Array.isArray(i?.items)?i.items:[];for(const i of r)try{const o=await Lt(`/project-templates/?project_id=${encodeURIComponent(t.id)}&type=${encodeURIComponent(i)}`);c(o).forEach(u=>{const d=String(u?.id??"");!d||a.has(d)||(a.add(d),s.push(u))})}catch{}if(!s.length)try{const i=await Lt(`/project-templates/?project_id=${encodeURIComponent(t.id)}`);c(i).forEach(o=>{const u=String(o?.id??"");!u||a.has(u)||(a.add(u),s.push(o))})}catch{}return s}async function zt(){const t=document.getElementById("templates-saved");if(!t)return;const e=t.value||"",n=Array.from(t.options).slice(1).map(s=>({id:s.value,title:s.textContent})),r=await Oe(),a=Array.isArray(r)&&r.length?r:n;t.innerHTML='<option value="">— محفوظات —</option>'+(a||[]).map(s=>`<option value="${String(s.id)}">${s.title||`#${s.id}`}</option>`).join(""),e&&Array.from(t.options).some(s=>s.value===String(e))&&(t.value=String(e))}async function an(t){if(!t)return;const e=document.getElementById("templates-preview-host");if(!e)return;try{e.style.visibility="hidden"}catch{}let n=null;try{n=await Lt(`/project-templates/?id=${encodeURIComponent(t)}`)}catch(s){Kt(s,"تعذر تحميل القالب");return}const r=n&&typeof n=="object"&&"data"in n?n.data:n,a=Array.isArray(r)?r[0]:r;if(!a){try{e.style.visibility=""}catch{}return}e.innerHTML="";try{const s=typeof a.data=="string"?JSON.parse(a.data):a.data;if(s?.html){const c=document.createElement("div");c.innerHTML=s.html;const i=c.firstElementChild;i&&e.appendChild(i);try{na(i)}catch{}try{fn(),yn(),De()}catch{}try{re(i)}catch{}try{Qr()}catch{}try{Zt()}catch{}try{ta({onAfterChange:()=>{try{kt(),Rt(),Mt()}catch{}}})}catch{}}}catch{}try{e.style.visibility=""}catch{}}function ws(){const t=document.getElementById("templates-project"),e=document.getElementById("templates-reservation"),n=document.getElementById("templates-type"),r=document.getElementById("templates-refresh"),a=document.getElementById("templates-print"),s=document.getElementById("templates-save"),c=document.getElementById("templates-save-copy"),i=document.getElementById("templates-saved"),o=document.getElementById("templates-from-res"),u=document.getElementById("templates-rename"),d=document.getElementById("templates-delete"),l=document.getElementById("templates-export"),p=document.getElementById("templates-export-excel"),m=document.getElementById("templates-import"),h=document.getElementById("templates-import-file");try{console.debug("[templatesTab] init start")}catch{}if(!t)return;try{Do({getSnapshot:la,applySnapshot:ps,onAutosaveDebounced:Rt,onMarkEditing:Mt})}catch{}rs(n),fr(),rn(t.value||""),gt(),(async()=>{try{await zt()}catch{}})(),t.addEventListener("change",()=>{rn(t.value||""),gt(),(async()=>{try{await zt()}catch{}})()}),e?.addEventListener("change",gt),n?.addEventListener("change",()=>{try{ns(n.value)}catch{}gt();try{window.__pdfTunerLoadValues&&window.__pdfTunerLoadValues()}catch{}}),r?.addEventListener("click",gt),a&&a.addEventListener("click",async E=>{try{E.preventDefault(),E.stopPropagation()}catch{}try{try{const g=document.getElementById("templates-actions-menu");g&&(g.style.display="none")}catch{}const A=a.textContent;a.disabled=!0,a.textContent="… جاري الطباعة",await Dn();try{Bt("تم إنشاء ملف PDF","success",3500)}catch{}a.textContent=A,a.disabled=!1}catch(A){console.error("❌ [templatesTab] print failed",A);try{Bt("تعذر إنشاء PDF، حاول مجددًا","error",6e3)}catch{alert("تعذر إنشاء PDF، حاول مجددًا")}try{a.disabled=!1}catch{}}});const f=document.getElementById("templates-actions-toggle"),y=document.getElementById("templates-actions-menu"),x=document.getElementById("templates-actions-dd");if(f&&y){try{if(!document.getElementById("templates-print-preview")){const A=document.createElement("button");A.type="button",A.className="btn btn-outline",A.id="templates-print-preview",A.textContent="👁️ معاينة الطباعة",A.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",A.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation();try{ys()}catch{}}),y.insertBefore(A,y.firstChild)}}catch{}try{if(!document.getElementById("templates-new")){const A=document.createElement("button");A.type="button",A.className="btn btn-outline",A.id="templates-new",A.textContent="🆕 قالب جديد (فارغ)",A.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",A.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation();try{const v=me();localStorage.removeItem(v);const T=`remoteAutosaveId:${v}`;localStorage.removeItem(T)}catch{}try{Bt("تم إنشاء قالب فارغ","success",2e3)}catch{}try{gt()}catch{}}),y.insertBefore(A,y.firstChild)}}catch{}try{if(!document.getElementById("templates-load-last")){const A=document.createElement("button");A.type="button",A.className="btn btn-outline",A.id="templates-load-last",A.textContent="📥 تحميل آخر مسودة",A.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",A.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation();try{const v=ia();if(v)await an(v);else{const T=await Oe(),P=(T||[]).find(L=>{const C=String(L?.title||"").toLowerCase();return C.includes("autosave")||C.includes("draft")||C.includes("مسودة")})||(T||[])[0];P&&P.id&&await an(P.id)}try{Bt("تم تحميل المسودة","success",2e3)}catch{}}catch{try{Bt("تعذر تحميل المسودة","error",2500)}catch{}}}),y.insertBefore(A,y.firstChild)}}catch{}try{if(!document.getElementById("templates-fetch-crew")){const A=document.createElement("div");A.style.cssText="height:1px;background:#e5e7eb;margin:6px 0",y.appendChild(A);const g=document.createElement("button");g.type="button",g.className="btn btn-outline",g.id="templates-fetch-crew",g.textContent="👥 جلب الطاقم (إكمال الفراغات)",g.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;";const v=document.createElement("button");v.type="button",v.className="btn btn-outline",v.id="templates-fetch-crew-force",v.textContent="👥 جلب الطاقم (إعادة تعبئة)",v.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",g.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();try{mr(!1)}catch{}}),v.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();try{mr(!0)}catch{}}),y.appendChild(g),y.appendChild(v)}}catch{}const E=A=>{if(!x?.contains(A.target)){y.style.display="none";try{x.classList.remove("dropdown-open");const g=x.closest(".reports-surface-card");g&&g.classList.remove("--raise-on-top"),g&&(g.style.zIndex="")}catch{}document.removeEventListener("click",E,!0)}};f.addEventListener("click",A=>{A.preventDefault(),A.stopPropagation();const g=y.style.display==="block";if(y.style.display=g?"none":"block",g)try{x.classList.remove("dropdown-open");const v=x.closest(".reports-surface-card");v&&v.classList.remove("--raise-on-top"),v&&(v.style.zIndex="")}catch{}else{try{x.classList.add("dropdown-open");const v=x.closest(".reports-surface-card");v&&(v.classList.add("--raise-on-top"),v.style.zIndex="12")}catch{}document.addEventListener("click",E,!0)}})}const I=document.getElementById("templates-lang-toggle");if(I){const E=()=>{I.textContent=jt==="ar"?"🌐 AR":"🌐 EN",I.title=`Language: ${jt.toUpperCase()}`};E(),I.addEventListener("click",()=>{sr(jt==="ar"?"en":"ar"),E(),gt()})}if(document.addEventListener("keydown",E=>{E.altKey&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&(E.code==="KeyL"||E.key.toLowerCase()==="l")&&(E.preventDefault(),sr(jt==="ar"?"en":"ar"),I&&(I.textContent=jt==="ar"?"🌐 AR":"🌐 EN",I.title=`Language: ${jt.toUpperCase()}`),gt())},!0),s?.addEventListener("click",()=>{br({copy:!1}).then(zt).catch(E=>{const A=E&&(E.message||E?.payload?.error||E?.payload?.details)||"تعذر الحفظ";alert(A);try{console.error("[templates/save] error",E)}catch{}})}),c?.addEventListener("click",()=>{br({copy:!0}).then(zt).catch(E=>{const A=E&&(E.message||E?.payload?.error||E?.payload?.details)||"تعذر الحفظ";alert(A);try{console.error("[templates/saveCopy] error",E)}catch{}})}),i?.addEventListener("change",()=>{i.value&&an(i.value).catch(()=>{})}),o?.addEventListener("click",()=>{n&&(n.value="callsheet"),e&&e.options.length>1&&(e.selectedIndex=1),gt()}),u?.addEventListener("click",async()=>{const E=i?.value||"";if(!E){alert("اختر محفوظاً أولاً");return}const A=i.options[i.selectedIndex]?.textContent||"",g=prompt("اسم جديد للمحفوظ:",A);if(!(!g||g.trim()===A))try{try{await Lt(`/project-templates/?id=${encodeURIComponent(E)}`,{method:"PATCH",body:{title:String(g).trim()}})}catch(T){Kt(T,"تعذر إعادة التسمية");return}await zt(),Array.from(i.options).find(T=>T.value===String(E))&&(i.value=String(E))}catch{alert("تعذر إعادة التسمية")}}),d?.addEventListener("click",async()=>{const E=i?.value||"";if(!E){alert("اختر محفوظاً أولاً");return}if(confirm("هل تريد حذف هذا المحفوظ نهائياً؟"))try{try{await Lt(`/project-templates/?id=${encodeURIComponent(E)}`,{method:"DELETE"})}catch(g){Kt(g,"تعذر حذف القالب");return}await zt(),gt()}catch{alert("تعذر الحذف")}}),l?.addEventListener("click",async()=>{const E=i?.value||"";if(!E){alert("اختر محفوظاً أولاً");return}try{let A=null;try{A=await Lt(`/project-templates/?id=${encodeURIComponent(E)}`)}catch(R){Kt(R,"تعذر تحميل القالب");return}const g=A&&typeof A=="object"&&"data"in A?A.data:A,v=Array.isArray(g)?g[0]:g;if(!v){alert("تعذر جلب المحفوظ");return}const T=typeof v.data=="string"?JSON.parse(v.data):v.data,P=new Blob([JSON.stringify({meta:{id:v.id,title:v.title,type:v.type,project_id:v.project_id},data:T},null,2)],{type:"application/json"}),L=URL.createObjectURL(P),C=document.createElement("a");C.href=L;const B=(v.title||`template-${E}`).replace(/[^\w\-\s]/g,"").trim()||`template-${E}`;C.download=`${B}.json`,document.body.appendChild(C),C.click(),C.remove(),URL.revokeObjectURL(L)}catch{alert("تعذر التصدير")}}),p?.addEventListener("click",async E=>{E?.preventDefault?.(),E?.stopPropagation?.();try{if((document.getElementById("templates-type")?.value||"expenses")!=="callsheet"){alert("التصدير إلى Excel متاح في الكول شيت فقط");return}const g=document.querySelector("#templates-preview-host #templates-a4-root");if(!g){alert("لا توجد معاينة للكول شيت");return}await Tn(),await Eo(g)}catch(A){console.error("[templates/export-excel] failed",A),alert("تعذر التصدير إلى Excel")}}),m?.addEventListener("click",()=>{h?.click()}),h?.addEventListener("change",async E=>{const A=E.target?.files?.[0];if(A)try{const g=await A.text(),v=JSON.parse(g),T=Ft();if(!T){alert("اختر مشروعاً أولاً");return}const P=document.getElementById("templates-type"),L=P?P.value:v?.meta?.type||"expenses",C=document.getElementById("templates-reservation"),B=C?.value?Number(C.value):null,R=v?.data?.html?v.data:{html:document.querySelector("#templates-preview-host")?.innerHTML||""};try{await Lt("/project-templates/",{method:"POST",body:{project_id:Number(T.id),reservation_id:B,type:L,title:v?.meta?.title||`Imported - ${L}`,data:R}})}catch(N){Kt(N,"تعذر الاستيراد");return}await zt(),alert("تم الاستيراد بنجاح")}catch{alert("تعذر الاستيراد، تأكد من صحة ملف JSON")}finally{E.target.value=""}}),!pn){let b=function(_=B){if(L||$e){C=!0;return}Ut&&(clearTimeout(Ut),Ut=null),Ut=setTimeout(()=>{Ut=null,N()},Math.max(0,_))};pn=!0,Nt=document.getElementById("templates-preview-host");try{Re=Uo(Nt,{onRenumber:()=>{try{hn()}catch{}},onTotalsChange:()=>{try{Fn()}catch{}},onAfterChange:()=>{try{kt(),Rt(),Mt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},30)}catch{}}})}catch{}const E=_=>{const D=_&&_.target;if(D instanceof HTMLElement&&D.isContentEditable&&!Qe){try{Mt()}catch{}try{const H=D.closest("td"),F=H&&H.closest("tr"),Y=F&&F.closest("table.exp-details");if(F&&Y&&F.getAttribute("data-row")==="item"){const G=Array.from(F.children),K=(_t,Pt=0)=>{try{const St=String(_t||"").replace(/[\u0660-\u0669]/g,$t=>"0123456789"[$t.charCodeAt(0)-1632]).replace(/[\u06F0-\u06F9]/g,$t=>"0123456789"[$t.charCodeAt(0)-1776]).replace(/[\u066B]/g,".").replace(/[\u066C]/g,"").replace(/[^\d.\-]/g,""),te=Number(St);return Number.isFinite(te)?te:Pt}catch{return Pt}},z=K(G[2]?.textContent,0),V=K(G[3]?.textContent,1),at=K(G[4]?.textContent,1),st=Math.round(z*V*at),mt=G[6];if(mt){mt.textContent=String(st);try{mt.setAttribute("data-num","1")}catch{}}}}catch{}try{clearTimeout(tr)}catch{}tr=setTimeout(()=>{tn(420)},180);try{clearTimeout(er)}catch{}er=setTimeout(()=>{try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}},80)}};Z.hostInput=E,Nt?.addEventListener("input",E);const A=_=>{Qe=!0},g=_=>{Qe=!1;try{E(_)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}};Z.hostCompStart=A,Z.hostCompEnd=g,Nt?.addEventListener("compositionstart",A,!0),Nt?.addEventListener("compositionend",g,!0);const v=_=>{const D=_.target;if(!(D instanceof HTMLElement))return;const H=D.closest&&D.closest("td");if(H)try{H.classList.add("editing")}catch{}},T=_=>{const D=_.target;if(!(D instanceof HTMLElement))return;const H=D.closest&&D.closest("td");if(H)try{H.classList.remove("editing")}catch{}try{H&&H.closest&&H.closest("table.exp-details")&&tn(120)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}};Nt?.addEventListener("focusin",v,!0),Nt?.addEventListener("focusout",T,!0),Z.hostFocusIn=v,Z.hostFocusOut=T;try{Me=Yo(Nt,{onAfterChange:()=>{try{kt(),Rt(),Mt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},30)}catch{}},onTotalsChange:()=>tn()})}catch{}const P=_=>{const D=_.target&&_.target.closest&&_.target.closest('[contenteditable="true"]');if(D){try{setTimeout(()=>{D&&D.focus&&D.focus()},0)}catch{}return}const H=_.target&&_.target.closest&&_.target.closest("td");if(H){const F=H.querySelector('[contenteditable="true"]');if(F)try{setTimeout(()=>{F&&F.focus&&F.focus()},0)}catch{}}};Nt?.addEventListener("mousedown",P,!0),Z.hostMouseDown=P;try{pa()}catch{}let L=!1,C=!1;const B=420;let R="";const N=async()=>{if(L||$e){C=!0;return}L=!0;try{isTemplatesDebugEnabled()&&console.debug("[templatesTab] repopulate start")}catch{}const _=t?.value||"";try{ue()?.length||await _e(),Sn()?.length||await kr()}catch(Y){try{isTemplatesDebugEnabled()&&console.warn("[templatesTab] fetch fallback failed",Y)}catch{}}fr(),!t.value&&t.options.length>1?t.selectedIndex=1:_&&(t.value=_),rn(t.value||"");const D=document.getElementById("templates-type"),H=D?D.value:"expenses",F=`${t.value||""}|${document.getElementById("templates-reservation")?.value||""}|${H}`;F!==R&&(R=F,gt());try{await zt()}catch{}try{isTemplatesDebugEnabled()&&console.debug("[templatesTab] repopulate done")}catch{}L=!1,C&&(C=!1,b())},k=()=>b(),q=()=>b(),M=()=>b();Z.projChanged=k,Z.resChanged=q,Z.resUpdated=M,document.addEventListener("projects:changed",k),document.addEventListener("reservations:changed",q),document.addEventListener("reservations:updated",M);const j=document.querySelector('[data-project-subtab-target="projects-templates-tab"]'),X=()=>b(0);Z.tabClick=X,j?.addEventListener("click",X),b(0)}try{Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")).forEach(E=>{(E.getAttribute("data-project-subtab-target")||"")!=="projects-templates-tab"&&E.dataset.tplDestroyBound!=="1"&&(E.addEventListener("click",()=>{try{nr()}catch{}}),E.dataset.tplDestroyBound="1")}),Array.from(document.querySelectorAll(".tab-button[data-tab-target]")).forEach(E=>{(E.getAttribute("data-tab-target")||"")!=="projects-section"&&E.dataset.tplDestroyMainBound!=="1"&&(E.addEventListener("click",()=>{try{nr()}catch{}}),E.dataset.tplDestroyMainBound="1")})}catch{}try{as()}catch{}}function vs(){document.addEventListener("DOMContentLoaded",()=>{fo(),wo(),ka(),Nr(),Da(),uo(),po(),ws(),qa(),ja(),Fa(),$a(),Oa(),Ha(),za({onViewDetails:Be}),Ua({onOpenProject:Be}),Wa(),xs()}),document.addEventListener("language:changed",wr),document.addEventListener("language:translationsReady",wr),document.addEventListener("customers:changed",Es),document.addEventListener("technicians:updated",Cs),document.addEventListener("reservations:changed",()=>Va(Be)),document.addEventListener(La.USER_UPDATED,()=>{ie(),de()});try{document.addEventListener("projects:changed",()=>{Br(),xn(),ie(),Ae(),de()},{passive:!0})}catch{}}async function xs(){try{await Mr({suppressError:!0}),await _e();try{await Xa()}catch{}}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||O("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");Bt(e,"error")}finally{Br(),ze(),Ya(),xn(),ie(),Ae(),de(),vo();try{const t=!!qe(),e=!!jr(),n=document.querySelector('.sub-tab-button[data-project-subtab-target="projects-list-tab"]');!t&&!e&&Array.isArray(it.projects)&&it.projects.length>0&&n&&(await Ue("projects-list-tab",n),An("projects-list-tab"))}catch{}}}function wr(){ze(),xn(),ie(),Ae(),de(),Nr()}function Es(){Ga(),ze()}function Cs(){Ka(),ze()}Za();Pa();Ia();Na();to();const vr=()=>{try{eo(no())}catch(t){console.warn("⚠️ [projects] Failed to initialize reservation edit modal",t)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",vr,{once:!0}):vr();vs();document.addEventListener("DOMContentLoaded",()=>{ro(),Ba()});let ce=.15;const Ne={},Ss="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let be=0;const U={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",confirmed:"all",range:"all",startDate:"",endDate:""}},S={search:null,payment:null,confirmed:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,exportExcelBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableHead:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},ne=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `,margin:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3a9 9 0 1 0 9 9"></path>
      <path d="M12 7v5l3 3"></path>
      <path d="M16 3l5 5"></path>
    </svg>
  `});let Ct=null;const ma=["upcoming","ongoing","completed"],As=new Set(["completed","closed","done","finished","resolved","مغلق","مكتمل","منتهي","منتهية"]),Tt={key:"value",dir:"desc"};let on=!1,xr=0;const _s=1500;function Er(t){return t==null?"":String(t).trim().toLowerCase()}function ha(t){if(!t)return!1;const e=t.raw||t,n=[e?.status,e?.project_status,e?.projectStatus,e?.state,e?.project_state,e?.projectState,e?.status_label,e?.statusLabel];for(const a of n){const s=Er(a);if(s&&(As.has(s)||s.includes("closed")))return!0}return!![e?.closed,e?.isClosed,e?.is_closed,e?.closed_at,e?.closedAt].some(a=>{if(a==null)return!1;if(a===!0)return!0;if(typeof a=="number")return a===1;const s=Er(a);return s==="true"||s==="yes"})}function gn(t){return!t||t.cancelled?!1:t.confirmed===!0?!0:ha(t)}async function Ts({forceProjects:t=!1}={}){try{await Mr({suppressError:!0}),await ao({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),Rr(e)&&console.warn("Projects API error:",e.message)}He()}async function Ls(){Ns(),ya(),Bs();try{le()}catch{}try{const t=document?.documentElement?.getAttribute("dir")||"rtl",e=document.querySelector(".reports-wrapper--projects");e&&e.setAttribute("dir",t)}catch{}await Ps();try{const t=new URLSearchParams(window.location.search||"");U.__debug=t.get("reportsDebug")==="1"||t.get("debugReports")==="1"}catch{U.__debug=!1}try{if(await Ts({forceProjects:!0}),!Array.isArray(ue())||ue().length===0){try{await _e()}catch{}He()}S.search&&(S.search.value=""),U.filters.search="",Ea(),ks(),Js(),Ys(),dt()}finally{ga()}document.addEventListener("language:changed",qs,{passive:!0}),document.addEventListener("projects:changed",()=>{wn().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})},{passive:!0}),document.addEventListener("reservations:changed",()=>{wn().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})},{passive:!0}),window.addEventListener("storage",js)}document.addEventListener("DOMContentLoaded",Ls);async function Ps(){if(Ct)return Ct;if(typeof window>"u")return null;if(window.ApexCharts)return Ct=window.ApexCharts,Ct;try{await Is(Ss),Ct=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),Ct=null}return Ct}function Is(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const r=document.querySelector(`script[src="${t}"]`);if(r){if(r.dataset.loaded==="true"){e();return}r.addEventListener("load",e,{once:!0}),r.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const a=document.createElement("script");a.src=t,a.async=!0,a.dataset.loaded="false",a.onload=()=>{a.dataset.loaded="true",e()},a.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(a)})}function Ns(){S.search=document.getElementById("reports-search"),S.statusChips=document.getElementById("reports-status-chips"),S.payment=document.getElementById("reports-payment"),S.confirmed=document.getElementById("reports-confirmed"),S.dateRange=document.getElementById("reports-date-range"),S.customRangeWrapper=document.getElementById("reports-custom-range"),S.startDate=document.getElementById("reports-start-date"),S.endDate=document.getElementById("reports-end-date"),S.refreshBtn=document.getElementById("reports-refresh"),S.exportExcelBtn=document.getElementById("projects-export-excel"),S.kpiGrid=document.getElementById("reports-kpi-grid"),S.table=document.getElementById("reports-table"),S.tableBody=S.table?.querySelector("tbody"),S.tableHead=S.table?.querySelector("thead"),S.tableMeta=document.getElementById("reports-table-meta"),S.tableEmpty=document.getElementById("reports-empty"),S.chartCards={},S.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;S.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(S.chartLoaders[e]=n)})}function fa(t){const e=!!t;Object.entries(S.chartCards||{}).forEach(([n,r])=>{if(!r)return;r.classList.toggle("is-loading",e),r.setAttribute("aria-busy",e?"true":"false");const a=S.chartLoaders?.[n];a&&(a.hidden=!e)})}function ya(){be+=1,be===1&&fa(!0)}function ga(){be=Math.max(0,be-1),be===0&&fa(!1)}function He(){const{customers:t=[]}=Ma();U.customers=Array.isArray(t)?t:[],U.reservations=Sn();const e=new Map(U.customers.map(a=>[String(a.id),a])),n=ue(),r=Array.isArray(n)?n.map(a=>Ms(a,e)):[];U.projects=r.filter(a=>gn(a)),U.totalProjects=U.projects.length}function bn(t){const e=We(t.id);let n=0,r=0,a=0;e.forEach(l=>{const p=co(l),m=Number(p.finalTotal||0),h=Number(p.taxAmount||0);n+=m,r+=h,a+=m-h});const s=Number(t?.raw?.equipmentEstimate??t?.equipmentEstimate??0)||0,c=Number(t?.raw?.servicesClientPrice??t?.servicesClientPrice??0)||0,i=Number(t?.expensesTotal??0)||0,o=a+s+c,u=a+(c-i),d=o>0?u/o*100:0;return{resFinal:n,resTax:r,resNetRevenue:a,equipmentEstimate:s,servicesRevenue:c,projectExpenses:i,netProfit:u,marginPercent:d}}function Bs(){try{const t=typeof window<"u"?window:globalThis,e=[t.APP_VAT_RATE,t.APP_TAX_RATE,t.__APP_SETTINGS__?.vatRate];for(const n of e){const r=Number(n);if(Number.isFinite(r)&&r>0&&r<=1){ce=r;return}if(Number.isFinite(r)&&r>1&&r<=100){ce=r/100;return}}}catch{}try{Lt("/preferences/").then(t=>{const e=t?.data??t??{},n=e.vatRate??e.taxRate??null,r=Number(n);Number.isFinite(r)&&r>0&&(ce=r>1?r/100:r,dt())}).catch(()=>{})}catch{}}function Ms(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",r=e.get(String(t.clientId)),a=We(t.id),s=a.reduce((L,C)=>{const B=Array.isArray(C.items)?C.items:[],R=Array.isArray(C.crewAssignments)?C.crewAssignments:[],N=R.length?R:Array.isArray(C.technicians)?C.technicians:[],b=Array.isArray(N)&&N.length&&typeof N[0]=="object",k=Array.isArray(N)&&N.length&&typeof N[0]!="object",q=ve({items:B,technicianIds:k?N:[],crewAssignments:b?N:[],discount:C.discount??0,discountType:C.discountType||"percent",applyTax:!1,start:C.start,end:C.end});return L.equipment+=Number(q.equipmentTotal||0),L.crew+=Number(q.crewTotal||0),L.crewCost+=Number(q.crewCostTotal||0),L},{equipment:0,crew:0,crewCost:0}),c=Ve(t),i=Number(t?.discount??0)||0,o=t?.discountType==="amount"?"amount":"percent",u=t?.applyTax===!0||t?.applyTax==="true",d=s.equipment+s.crew+c;let l=o==="amount"?i:d*(i/100);(!Number.isFinite(l)||l<0)&&(l=0),l>d&&(l=d);const p=Math.max(0,d-l),m=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true",h=Number(t?.companySharePercent)||0,f=u||m&&h>0,y=m&&f?h:0,x=y>0?Number((p*(y/100)).toFixed(2)):0,I=f?Number(((p+x)*ce).toFixed(2)):0,E=Number((p+x+I).toFixed(2)),A=Rs(t),g=(()=>{try{if(t?.cancelled===!0)return!0;const L=String(t?.status||t?.raw?.status||"").toLowerCase();return L==="cancelled"||L==="canceled"||L==="ملغي"||L==="ملغى"}catch{return!1}})(),v=g?"cancelled":A,T=t.start?new Date(t.start):null,P=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:r?.customerName||r?.name||"",clientCompany:t.clientCompany||r?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:T,end:P,applyTax:f,companyShareEnabled:m,companySharePercent:y,status:v,cancelled:g,reservationsTotal:Number((s.equipment+s.crew).toFixed(2)),expensesTotal:Se(t),servicesClientPrice:c,taxAmount:I,combinedTaxAmount:I,overallTotal:E,unpaidValue:n==="paid"?0:E,reservationsCount:a.length}}function We(t){return Array.isArray(U.reservations)?U.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Se(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function Ve(t){const e=Number(t?.servicesClientPrice??t?.services_client_price??t?.raw?.servicesClientPrice??t?.raw?.services_client_price??0)||0;if(e>0)return e;const n=Array.isArray(t?.expenses)?t.expenses:Array.isArray(t?.raw?.expenses)?t.raw.expenses:[];if(!n.length)return 0;const r=a=>{if(typeof a=="number")return Number.isFinite(a)?a:0;if(a==null||a==="")return 0;const s=Qt(String(a)).replace(/[^\d.+-]/g,""),c=Number.parseFloat(s);return Number.isFinite(c)?c:0};return n.reduce((a,s)=>a+r(s?.salePrice??s?.sale_price??0),0)}function Rs(t){const e=new Date,n=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":r&&!Number.isNaN(r.getTime())&&r<e?"completed":"ongoing"}function ks(){if(S.search){let t;S.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{U.filters.search=S.search.value.trim(),dt()},180)})}S.payment&&(S.payment.value=U.filters.payment,S.payment.addEventListener("change",()=>{U.filters.payment=S.payment.value||"all",dt()})),S.confirmed&&(S.confirmed.value=U.filters.confirmed||"all",S.confirmed.addEventListener("change",()=>{U.filters.confirmed=S.confirmed.value||"all",dt()})),S.dateRange&&(S.dateRange.addEventListener("change",Ds),S.dateRange.value=U.filters.range,S.dateRange.value==="custom"&&le()),S.startDate&&S.startDate.addEventListener("change",()=>{U.filters.startDate=S.startDate.value,U.filters.range==="custom"&&dt()}),S.endDate&&S.endDate.addEventListener("change",()=>{U.filters.endDate=S.endDate.value,U.filters.range==="custom"&&dt()}),S.refreshBtn&&S.refreshBtn.addEventListener("click",()=>{if(U.filters.range!=="custom"){dt();return}U.filters.startDate=S.startDate?.value||"",U.filters.endDate=S.endDate?.value||"",dt()})}function Ds(t){const e=t.target.value;U.filters.range=e,e==="custom"?(S.customRangeWrapper?.classList.add("active"),le()):(S.customRangeWrapper?.classList.remove("active"),U.filters.startDate="",U.filters.endDate="",S.startDate&&(S.startDate.value=""),S.endDate&&(S.endDate.value=""),dt())}function le(){try{if(!window.flatpickr){try{const r=document.querySelector('script[data-flatpickr-loader="true"]')||document.querySelector('script[src*="flatpickr"]');if(r)r.dataset.boundRetry||(r.addEventListener("load",()=>{try{le()}catch{}},{once:!0}),r.dataset.boundRetry="true");else{const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/flatpickr",a.async=!0,a.dataset.flatpickrLoader="true",a.onload=()=>{try{le()}catch{}},document.head.appendChild(a)}}catch{}setTimeout(()=>{try{le()}catch{}},150);return}const t=(()=>{try{if((wt()||"ar").toLowerCase().startsWith("ar")&&window.flatpickr?.l10ns?.ar)return"ar"}catch{}return window.flatpickr?.l10ns?.default,void 0})(),e=r=>({dateFormat:"Y-m-d",allowInput:!0,clickOpens:!0,disableMobile:!0,appendTo:document.body,...t?{locale:t}:{},...r});if(S.startDate&&!S.startDate._flatpickr){try{S.startDate.removeAttribute("readonly"),S.startDate.setAttribute("tabindex","0"),S.startDate.style.cursor="pointer",S.startDate.setAttribute("aria-haspopup","dialog")}catch{}window.flatpickr(S.startDate,e({onChange:(r,a)=>{U.filters.startDate=a||"",S.endDate?._flatpickr&&r?.length&&S.endDate._flatpickr.set("minDate",r[0]),U.filters.range==="custom"&&dt()},onValueUpdate:(r,a)=>{U.filters.startDate=a||"",U.filters.range==="custom"&&dt()}})),S.startDate.addEventListener("click",()=>S.startDate?._flatpickr?.open()),S.startDate.addEventListener("focus",()=>S.startDate?._flatpickr?.open())}if(S.endDate&&!S.endDate._flatpickr){try{S.endDate.removeAttribute("readonly"),S.endDate.setAttribute("tabindex","0"),S.endDate.style.cursor="pointer",S.endDate.setAttribute("aria-haspopup","dialog")}catch{}window.flatpickr(S.endDate,e({onChange:(r,a)=>{U.filters.endDate=a||"",S.startDate?._flatpickr&&r?.length&&S.startDate._flatpickr.set("maxDate",r[0]),U.filters.range==="custom"&&dt()},onValueUpdate:(r,a)=>{U.filters.endDate=a||"",U.filters.range==="custom"&&dt()}})),S.endDate.addEventListener("click",()=>S.endDate?._flatpickr?.open()),S.endDate.addEventListener("focus",()=>S.endDate?._flatpickr?.open())}const n=S.customRangeWrapper;n&&!n.dataset.openBound&&(n.addEventListener("click",r=>{const a=r.target;if(a===S.startDate){S.startDate?._flatpickr?.open();return}if(a===S.endDate){S.endDate?._flatpickr?.open();return}S.startDate?._flatpickr?.open()}),n.dataset.openBound="true")}catch{}}async function wn(){const t=Date.now();if(!on){if(t-xr<_s){He(),dt();return}on=!0,ya();try{await Promise.all([_e(),kr()])}catch(e){console.error("❌ [projectsReports] Data mutation refresh failed",e),Rr(e)&&console.warn("Projects API error:",e.message)}finally{xr=Date.now(),on=!1,He(),dt(),ga()}}}function qs(){try{const t=document?.documentElement?.getAttribute("dir")||"rtl",e=document.querySelector(".reports-wrapper--projects");e&&e.setAttribute("dir",t)}catch{}Ea(),dt()}function js(t){t.key&&!["projects","reservations","customers"].includes(t.key)||wn().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function dt(){const t=ba();$n(),Os(t),Us(t),Ws(t),Vs(t),Xs(t),Zs(t),tc()}function ba(){const{search:t,statuses:e,payment:n,range:r,startDate:a,endDate:s,confirmed:c}=U.filters,i=va(t),o=new Date,u=Number(r);let d=null;if(r==="custom"){d=a?new Date(a):null;const l=s?new Date(s):null;return U.projects.filter(p=>p?.cancelled===!0||String(p?.status).toLowerCase()==="cancelled"||String(p?.status).toLowerCase()==="canceled"||!gn(p)||!Cr(p,e)||!Sr(p,n)||!_r(p,i)||!Ar(p,c)?!1:$s(p.start,d,l))}return r!=="all"&&Number.isFinite(u)&&(d=new Date,d.setDate(o.getDate()-u)),U.projects.filter(l=>l?.cancelled===!0||String(l?.status).toLowerCase()==="cancelled"||String(l?.status).toLowerCase()==="canceled"||!gn(l)||!Cr(l,e)||!Sr(l,n)||!_r(l,i)||!Ar(l,c)?!1:r==="all"?!0:Fs(l.start,d,o))}function Cr(t,e){return e.includes(t.status)}function Sr(t,e){return e==="all"?!0:wa(t)===e}function Ar(t,e){if(!e||e==="all"||e==="no")return!0;const n=t?.confirmed===!0;return e==="yes"?n:e==="closed"?ha(t):!0}function _r(t,e){return e?va([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function wa(t){try{const e=t?.raw||t||{},n=Number(t?.overallTotal||0)||0;let r=0;const a=o=>{const u=Number(o);Number.isFinite(u)&&u>0&&(r+=u)},s=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payments)?e.payments:[];if(Array.isArray(s)&&s.length)s.forEach(o=>{const u=(o?.type||"").toString().toLowerCase(),d=Number(o?.value??o?.amount??o?.percentage??0)||0;a(u==="percent"||u==="percentage"?d/100*n:d)});else{a(e?.paidAmount??e?.paid_amount);const o=Number(e?.paidPercent??e?.paid_percentage);o>0&&a(o/100*n)}const c=.01;return n<=0?r>0?"partial":"unpaid":Math.max(0,n-r)<=c?"paid":r>0?"partial":"unpaid"}catch{return"unpaid"}}function Fs(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function $s(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&r<e.getTime()||n&&!Number.isNaN(n.getTime())&&r>n.getTime())}function va(t){return t?Qt(String(t)).toLowerCase().trim():""}function Os(t){if(!S.kpiGrid)return;const e=t.length,n=xa(t),r=n.grossRevenue,a=n.outstandingTotal||0,s=n.projectExpensesTotal||0,c=n.netProfit||0,i=[{key:"projects",icon:ne.projects,label:O("projects.reports.kpi.totalProjects",wt()==="ar"?"إجمالي المشاريع":"Total projects"),value:vn(e),meta:O("projects.reports.kpi.totalProjectsMeta",wt()==="ar"?"بعد تطبيق الفلاتر الحالية":"After applying the current filters")},{key:"totalValue",icon:ne.value,label:O("projects.reports.kpi.totalValue",wt()==="ar"?"الإيراد الكلي":"Total value"),value:bt(r),meta:O("projects.reports.kpi.totalValueMeta",wt()==="ar"?"يشمل المشاريع والحجوزات والضريبة":"Includes projects, linked reservations, and VAT")},{key:"outstanding",icon:ne.outstanding,label:O("projects.reports.kpi.unpaidValue",wt()==="ar"?"قيمة غير مدفوعة":"Outstanding value"),value:bt(a),meta:O("projects.reports.kpi.unpaidValueMeta",wt()==="ar"?"مشاريع لم تُسدّد بالكامل":"Projects not fully paid yet")},{key:"expenses",icon:ne.expenses,label:O("projects.reports.kpi.expenses","تكلفة الخدمات الإنتاجية"),value:bt(s),meta:O("projects.reports.kpi.expensesMeta","تكلفة الخدمات الإنتاجية للمشاريع المحددة")},{key:"margin",icon:ne.margin,label:O("projects.reports.kpi.margin","هامش الربح"),value:Sa(n.profitMarginPercent),meta:O("projects.reports.kpi.marginMeta","صافي الربح ÷ الإيراد بدون الضريبة")},{key:"netProfit",icon:ne.value,label:O("reservations.reports.kpi.revenue.details.net","صافي الربح"),value:bt(c),meta:O("projects.reports.kpi.netProfitMeta","مجموع صافي الربح للمشاريع المحددة")}];S.kpiGrid.innerHTML=i.map(({key:o,icon:u,label:d,value:l,meta:p})=>`
    <div class="reports-kpi-card glass-card" data-kpi="${o}">
      <div class="reports-kpi-icon">${u}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${vt(d)}</p>
        <p class="reports-kpi-value">${vt(l)}</p>
        <span class="reports-kpi-meta">${vt(p)}</span>
      </div>
    </div>
  `).join(""),Hs(t)}function Hs(t){try{const e=xa(t),n="projects-revenue-breakdown";let r=document.getElementById(n);const a=(e.servicesRevenueTotal||0)-(e.projectExpensesTotal||0),s=[{key:"gross",label:O("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:bt(e.grossRevenue)},{key:"discount",label:O("projects.details.summary.discount","الخصم","Discount"),value:`−${bt(e.discountTotal||0)}`},{key:"share",label:O("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:bt(e.companyShareTotal)},{key:"tax",label:O("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:bt(e.taxTotal)},{key:"crewGross",label:O("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:bt(e.crewTotal)},{key:"crew",label:O("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:`−${bt(e.crewCostTotal)}`},{key:"equipment",label:O("reservations.reports.kpi.revenue.details.equipmentGross","إجمالي المعدات","Equipment total"),value:bt(e.equipmentTotalCombined)},{key:"equipmentCost",label:O("reservations.reports.kpi.revenue.details.equipment","تكلفة المعدات","Equipment cost"),value:`−${bt(e.equipmentCostTotalCombined||0)}`},{key:"projectExpenses",label:O("projects.reports.kpi.revenue.details.projectExpenses","تكلفة الخدمات الإنتاجية","Project expenses"),value:`−${bt(e.projectExpensesTotal)}`},{key:"servicesProfit",label:O("projects.reports.kpi.revenue.details.servicesProfit",wt()==="ar"?"ربح الخدمات الإنتاجية":"Services profit"),value:`${bt(a)}`},{key:"net",label:O("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:bt(e.netProfit)}],c=`
      <div id="${n}" class="reports-kpi-details glass-card" style="margin-top: 12px;">
        ${s.map(({key:i,label:o,value:u})=>`
          <div class="reports-kpi-detail-row d-flex justify-content-between" data-row="${i}">
            <span class="reports-kpi-detail-label">${vt(o)}</span>
            <span class="reports-kpi-detail-value">${vt(u)}</span>
          </div>
        `).join("")}
      </div>
    `;r?r.outerHTML=c:S.kpiGrid.insertAdjacentHTML("afterend",c)}catch(e){console.warn("[projectsReports] Failed to render revenue breakdown",e)}}function xa(t){const e=new Set(t.map(g=>String(g.id))),n=U.reservations.filter(g=>g.projectId!=null&&e.has(String(g.projectId))),r=new Map;let a=0,s=0,c=0,i=0;n.forEach(g=>{const v=Array.isArray(g.items)?g.items:[],T=Array.isArray(g.crewAssignments)?g.crewAssignments:[],P=T.length?T:Array.isArray(g.technicians)?g.technicians:[],L=Array.isArray(P)&&P.length&&typeof P[0]=="object",C=Array.isArray(P)&&P.length&&typeof P[0]!="object",B=ve({items:v,technicianIds:C?P:[],crewAssignments:L?P:[],discount:g.discount??0,discountType:g.discountType||"percent",applyTax:!1,start:g.start,end:g.end});a+=Number(B.equipmentTotal||0),s+=Number(B.equipmentCostTotal||0),c+=Number(B.crewTotal||0),i+=Number(B.crewCostTotal||0);const R=r.get(String(g.projectId))||[];R.push(g),r.set(String(g.projectId),R)});let o=0,u=0,d=0,l=0,p=0,m=0,h=0,f=0;t.forEach(g=>{const T=(r.get(String(g.id))||[]).reduce((z,V)=>{const at=Array.isArray(V.items)?V.items:[],st=Array.isArray(V.crewAssignments)?V.crewAssignments:[],mt=st.length?st:Array.isArray(V.technicians)?V.technicians:[],_t=Array.isArray(mt)&&mt.length&&typeof mt[0]=="object",Pt=Array.isArray(mt)&&mt.length&&typeof mt[0]!="object",St=ve({items:at,technicianIds:Pt?mt:[],crewAssignments:_t?mt:[],discount:V.discount??0,discountType:V.discountType||"percent",applyTax:!1,start:V.start,end:V.end});return z.equipment+=Number(St.equipmentTotal||0),z.equipmentCost+=Number(St.equipmentCostTotal||0),z.crew+=Number(St.crewTotal||0),z.crewCost+=Number(St.crewCostTotal||0),z},{equipment:0,equipmentCost:0,crew:0,crewCost:0}),P=Ve(g);p+=P,l+=Number(Se(g)||0);const L=T.equipment+T.crew+P,C=Number(g?.raw?.discount??g?.discount??0)||0;let R=((g?.raw?.discount_type??g?.discountType)==="amount"?"amount":"percent")==="amount"?C:L*(C/100);(!Number.isFinite(R)||R<0)&&(R=0),R>L&&(R=L);const N=Math.max(0,L-R);f+=Number(R||0);let b=(()=>{const z=g?.applyTax!==void 0?g.applyTax:g?.apply_tax??g?.raw?.apply_tax??g?.raw?.applyTax;return z===!0||z===1||z==="1"||typeof z=="string"&&z.toLowerCase()==="true"})();const k=(()=>{const z=g?.companyShareEnabled!==void 0?g.companyShareEnabled:g?.raw?.company_share_enabled??g?.raw?.companyShareEnabled;return z===!0||z===1||z==="1"||typeof z=="string"&&z.toLowerCase()==="true"})(),q=(()=>{const z=g?.raw?.company_share_percent??g?.raw?.companySharePercent??g?.companySharePercent??g?.company_share_percent??0,V=Number(z);return Number.isFinite(V)?V:0})();k&&q>0&&(b=!0);const M=k&&b?q:0,j=M>0?Number((N*(M/100)).toFixed(2)):0;d+=j;const X=b?Number(((N+j)*ce).toFixed(2)):0;u+=X;const _=N+j+X;o+=_;const D=Number(Se(g)||0),H=Number((N-D-(T.crewCost||0)-(T.equipmentCost||0)).toFixed(2));h+=H;const F=g.raw||g;let Y=0;const G=z=>{const V=Number(z);Number.isFinite(V)&&V>0&&(Y+=V)};let K=!1;try{const z=Array.isArray(F.paymentHistory)?F.paymentHistory:Array.isArray(F.payments)?F.payments:[];Array.isArray(z)&&z.length&&(K=!0,z.forEach(V=>{const at=(V?.type||"").toString().toLowerCase(),st=Number(V?.value??V?.amount??V?.percentage??0)||0;G(at==="percent"||at==="percentage"?st/100*_:st)}))}catch{}if(!K){G(F?.paidAmount??F?.paid_amount);const z=Number(F?.paidPercent??F?.paid_percentage);z>0&&G(z/100*_)}Y>_&&(Y=_),m+=Math.max(0,_-Y)});const y=a,x=s,I=Math.max(0,o-u),E=h,A=I>0?E/I*100:0;return{grossRevenue:o,companyShareTotal:d,taxTotal:u,crewTotal:c,crewCostTotal:i,equipmentTotalCombined:y,equipmentCostTotalCombined:x,projectExpensesTotal:l,servicesRevenueTotal:p,outstandingTotal:m,netProfit:E,revenueExTax:I,profitMarginPercent:A,discountTotal:f}}function Ea(){if(!S.statusChips)return;const t=ma.map(e=>{const n=O(`projects.status.${e}`,e);return`<span class="reports-status-chip timeline-status-badge timeline-status-badge--${e}" data-status="${e}">${vt(n)}</span>`}).join("");S.statusChips.innerHTML=t,S.statusChips.dataset.listenerAttached||(S.statusChips.addEventListener("click",zs),S.statusChips.dataset.listenerAttached="true"),$n()}function zs(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const r=new Set(U.filters.statuses);r.has(n)?r.delete(n):r.add(n),r.size===0&&ma.forEach(a=>r.add(a)),U.filters.statuses=Array.from(r),$n(),dt()}function $n(){if(!S.statusChips)return;const t=new Set(U.filters.statuses);S.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Us(t){if(!Ct)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],r=n.map(o=>t.filter(u=>u.status===o).length),a=n.map(o=>O(`projects.status.${o}`,o)),c=r.reduce((o,u)=>o+u,0)>0?r:[],i={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:a,series:c,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:o=>Number.isFinite(o)?`${Math.round(o)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:o=>Jt(o)}},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};Xe("status",e,i)}function Ws(t){if(!Ct)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,r=new Intl.DateTimeFormat(ec(),{month:"short",year:"numeric"});t.forEach(d=>{if(!d.start||Number.isNaN(d.start.getTime()))return;const l=`${d.start.getFullYear()}-${d.start.getMonth()+1}`,p=n.get(l)||{total:0,label:r.format(d.start)};p.total+=d.overallTotal,n.set(l,p)});const s=Array.from(n.keys()).sort((d,l)=>{const[p,m]=d.split("-").map(Number),[h,f]=l.split("-").map(Number);return p===h?m-f:p-h}).slice(-12),c=s.map(d=>n.get(d)?.label||d),i=s.map(d=>Math.round(n.get(d)?.total||0)),o=i.length?[{name:O("projects.reports.datasets.value","Total value"),data:i}]:[],u={chart:{type:"area",height:320,toolbar:{show:!1}},series:o,xaxis:{categories:c,labels:{rotate:-35}},yaxis:{labels:{formatter:d=>Jt(d)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:d=>Jt(d)}},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("timeline",e,u)}function Vs(t){if(!Ct)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((u,d)=>d.overallTotal-u.overallTotal).slice(0,6),r=n.map(u=>u.title||u.projectCode),a=n.map(u=>Math.round(u.overallTotal)),s=n.map(u=>Math.round(u.expensesTotal)),c=r.length?[{name:O("projects.reports.datasets.value","Total value"),data:a},{name:O("projects.reports.datasets.expenses","تكلفة الخدمات الإنتاجية"),data:s}]:[],o={chart:{type:"bar",height:Math.max(320,r.length*60||0),toolbar:{show:!1}},series:c,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:r,labels:{formatter:u=>Jt(u)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:u=>Jt(u)}},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("expenses",e,o)}function Xs(t){if(!Ct)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(o=>{const u=o.clientName||o.clientCompany||O("projects.fallback.unknownClient","Unknown client"),d=n.get(u)||0;n.set(u,d+o.overallTotal)});const r=Array.from(n.entries()).sort((o,u)=>u[1]-o[1]).slice(0,6),a=r.map(([o])=>o),s=r.map(([,o])=>Math.round(o)),c=s.length?[{name:O("projects.reports.datasets.value","Total value"),data:s}]:[],i={chart:{type:"bar",height:320,toolbar:{show:!1}},series:c,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:a,labels:{rotate:-35}},yaxis:{labels:{formatter:o=>Jt(o)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:o=>Jt(o)}},legend:{show:!1},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("clients",e,i)}function Xe(t,e,n={}){if(!Ct||!e)return;if(Ne[t]){try{Ne[t].destroy()}catch(a){console.warn(`⚠️ [projectsReports] Failed to destroy ${t} chart`,a)}delete Ne[t]}e.innerHTML="";const r={...n};Array.isArray(r.series)||(r.series=[]);try{const a=new Ct(e,r);Ne[t]=a,a.render().catch(s=>{console.error(`❌ [projectsReports] Failed to render ${t} chart`,s)})}catch(a){console.error(`❌ [projectsReports] Failed to render ${t} chart`,a)}}function Ys(){!S.exportExcelBtn||S.exportExcelBtn.dataset.bound==="true"||(S.exportExcelBtn.addEventListener("click",async()=>{try{const t=ba();await Gs(t)}catch(t){console.error("❌ [projectsReports] Failed to export Excel",t);try{alert("تعذر تصدير البيانات.")}catch{}}}),S.exportExcelBtn.dataset.bound="true")}async function Gs(t){if(!Array.isArray(t)||t.length===0){try{alert("لا توجد بيانات لتصديرها.")}catch{}return}let e=null;try{e=await Tn()}catch{e=null}if(e||(e=await so()),!e){try{alert("مكتبة Excel غير متوفرة.")}catch{}return}const n=["كود المشروع","المشروع","العميل","الحالة","الفترة","القيمة (مع الضريبة)","تقدير المعدات","إيرادات الخدمات","تكلفة الخدمات","صافي الحجوزات (بدون ضريبة)","صافي الربح","هامش الربح %","حالة الدفع","المبالغ المدفوعة","نسبة الدفع %","عدد الدفعات"],r=t.map(h=>{const f=We(h.id),y=(Array.isArray(f)?f:[]).reduce((X,_)=>{const D=Array.isArray(_.items)?_.items:[],H=Array.isArray(_.crewAssignments)?_.crewAssignments:[],F=H.length?H:Array.isArray(_.technicians)?_.technicians:[],Y=Array.isArray(F)&&F.length&&typeof F[0]=="object",G=Array.isArray(F)&&F.length&&typeof F[0]!="object",K=ve({items:D,technicianIds:G?F:[],crewAssignments:Y?F:[],discount:_.discount??0,discountType:_.discountType||"percent",applyTax:!1,start:_.start,end:_.end});return X.equipment+=Number(K.equipmentTotal||0),X.crew+=Number(K.crewTotal||0),X.crewCost+=Number(K.crewCostTotal||0),X},{equipment:0,crew:0,crewCost:0}),x=Ve(h),I=Number(Se(h)||0),E=y.equipment+y.crew+x,A=Number(h?.raw?.discount??h?.discount??0)||0;let v=((h?.raw?.discount_type??h?.discountType)==="amount"?"amount":"percent")==="amount"?A:E*(A/100);(!Number.isFinite(v)||v<0)&&(v=0),v>E&&(v=E);const T=Math.max(0,E-v),P=T,L=Math.max(0,y.equipment+y.crew-v),C=Number((T-I-(y.crewCost||0)).toFixed(2)),B=P>0?C/P*100:0,R=Ca(h.start,h.end),N=O(`projects.status.${h.status}`,h.status),b=O(`projects.paymentStatus.${h.paymentStatus}`,h.paymentStatus),k=h.clientCompany?`${h.clientName} (${h.clientCompany})`:h.clientName||"",q=Number(h.raw?.paidAmount??h.paidAmount??0)||0,M=Number(h.raw?.paidPercent??h.paidPercent??0)||0,j=Array.isArray(h.raw?.paymentHistory)?h.raw.paymentHistory.length:0;return[String(h.projectCode||h.id||""),String(h.title||h.projectCode||""),String(k),N,R,Math.round(h.overallTotal||0),Math.round(Number(h?.raw?.equipmentEstimate??h?.equipmentEstimate??0)||0),Math.round(x||0),Math.round(I||0),Math.round(L||0),Math.round(C||0),Number(B.toFixed(1)),b,Math.round(q||0),Number((M||0).toFixed(1)),j]}),a={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{patternType:"solid",fgColor:{rgb:"2563EB"}},alignment:{horizontal:"center",vertical:"center"}},s={z:"#,##0",alignment:{horizontal:"right"}},c={z:"#,##0.0",alignment:{horizontal:"right"}},i=[n.map(h=>({v:h,t:"s",s:a}))];r.forEach(h=>{const f=[];f.push({v:h[0]}),f.push({v:h[1]}),f.push({v:h[2]}),f.push({v:h[3]}),f.push({v:h[4]}),f.push({v:h[5],t:"n",s}),f.push({v:h[6],t:"n",s}),f.push({v:h[7],t:"n",s}),f.push({v:h[8],t:"n",s}),f.push({v:h[9],t:"n",s}),f.push({v:h[10],t:"n",s}),f.push({v:h[11],t:"n",s:c}),f.push({v:h[12]}),f.push({v:h[13],t:"n",s}),f.push({v:h[14],t:"n",s:c}),f.push({v:h[15],t:"n",s}),i.push(f)});const o=e.utils.aoa_to_sheet(i);o["!cols"]=[8,24,18,12,16,16,14,14,14,18,14,12,12,14,12,10].map(h=>({wch:h}));const u=String.fromCharCode(65+n.length-1);o["!autofilter"]={ref:`A1:${u}${i.length}`};const d=e.utils.book_new();e.utils.book_append_sheet(d,o,"Summary");const l=Ks(e,t);e.utils.book_append_sheet(d,l,"Breakdown");const m=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");e.writeFile(d,`projects-report-${m}.xlsx`)}function Ks(t,e){const n={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{patternType:"solid",fgColor:{rgb:"1F2937"}},alignment:{horizontal:"center",vertical:"center"}},r={font:{bold:!0,sz:13},alignment:{horizontal:"left",vertical:"center"}},a={z:"#,##0",alignment:{horizontal:"right"}},s={z:"#,##0.0",alignment:{horizontal:"right"}},c={};let i=0;const o=(l,p,m)=>{const h=t.utils.encode_cell({r:i,c:l}),f=typeof p=="number"?"n":"s";c[h]={v:p,t:f,s:m||{}},u()},u=()=>{const l=c["!ref"],p=t.utils.encode_cell({r:i,c:5});c["!ref"]=l?l.replace(/:[A-Z]+\d+$/,`:${p}`):`A1:${p}`},d=(l=1)=>{i+=l};return c["!cols"]=[22,36,16,16,16,16].map(l=>({wch:l})),e.forEach((l,p)=>{o(0,`${l.title||l.projectCode||""} — #${l.projectCode||l.id||""}`,r),d(),["البند","القيمة","البند","القيمة","البند","القيمة"].forEach((C,B)=>o(B,C,n)),d();const h=We(l.id),f=(Array.isArray(h)?h:[]).reduce((C,B)=>{const R=Array.isArray(B.items)?B.items:[],N=Array.isArray(B.crewAssignments)?B.crewAssignments:[],b=N.length?N:Array.isArray(B.technicians)?B.technicians:[],k=Array.isArray(b)&&b.length&&typeof b[0]=="object",q=Array.isArray(b)&&b.length&&typeof b[0]!="object",M=ve({items:R,technicianIds:q?b:[],crewAssignments:k?b:[],discount:B.discount??0,discountType:B.discountType||"percent",applyTax:!1,start:B.start,end:B.end});return C.equipment+=Number(M.equipmentTotal||0),C.crew+=Number(M.crewTotal||0),C.crewCost+=Number(M.crewCostTotal||0),C},{equipment:0,crew:0,crewCost:0}),y=Ve(l),x=Number(Se(l)||0),I=f.equipment+f.crew+y,E=Number(l?.raw?.discount??l?.discount??0)||0;let g=((l?.raw?.discount_type??l?.discountType)==="amount"?"amount":"percent")==="amount"?E:I*(E/100);(!Number.isFinite(g)||g<0)&&(g=0),g>I&&(g=I);const v=Math.max(0,I-g),T=Number((v-x-(f.crewCost||0)).toFixed(2)),P=v>0?T/v*100:0;[["إيراد المعدات (حجوزات)",f.equipment,"إيراد الطاقم (حجوزات)",f.crew,"إيرادات الخدمات",y],["الخصم",g,"بعد الخصم",v,"تكلفة الطاقم",f.crewCost],["تكلفة الخدمات الإنتاجية",x,"صافي الربح",T,"هامش الربح %",Number(P.toFixed(1))]].forEach(C=>{C.forEach((B,R)=>{const N=R%2===1;o(R,B,N?typeof B=="number"&&(R===5?s:a):{})}),d()}),d()}),c}function Zs(t){if(!S.table||!S.tableBody||!S.tableEmpty)return;if(!t.length){S.table.style.display="none",S.tableEmpty.classList.add("active"),S.tableMeta&&(S.tableMeta.textContent="");return}S.table.style.display="",S.tableEmpty.classList.remove("active");const e=Qs([...t||[]]).map(n=>{const r=bn(n),a=Ca(n.start,n.end),s=O(`projects.status.${n.status}`,n.status),c=`<span class="timeline-status-badge timeline-status-badge--${n.status}">${vt(s)}</span>`,i=wa(n),o=i==="paid"?"status-paid":i==="partial"?"status-partial":"status-unpaid",u=i==="paid"?O("reservations.list.payment.paid","💳 مدفوع"):i==="partial"?O("reservations.list.payment.partial","💳 مدفوع جزئياً"):O("reservations.list.payment.unpaid","💳 غير مدفوع"),d=`<span class="reservation-chip ${o}">${vt(u)}</span>`,l=vt(n.clientName||O("projects.fallback.unknownClient","Unknown client")),p=`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${vt(n.title||n.projectCode)}</span>
            <small class="text-muted">${vt(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${l}</td>
        <td>${c}</td>
        <td>${vt(a)}</td>
        <td>${vt(bt(n.overallTotal))}</td>
        <td>${vt(Sa(r.marginPercent))}</td>
        <td>${d}</td>
      </tr>
    `;if(!U.__debug)return p;const m=[];m.push(`resFinal=${Math.round(r.resFinal)}`),m.push(`resTax=${Math.round(r.resTax)}`),m.push(`resNet=${Math.round(r.resNetRevenue)}`),m.push(`equipEst=${Math.round(r.equipmentEstimate)}`),m.push(`services=${Math.round(r.servicesRevenue)}`),m.push(`expenses=${Math.round(r.projectExpenses)}`),m.push(`netProfit=${Math.round(r.netProfit)}`),m.push(`margin=${Number((r.marginPercent||0).toFixed(1))}%`);const f=(n?.raw?.companyShareEnabled===!0||String(n?.raw?.companyShareEnabled).toLowerCase()==="true")&&Number(n?.raw?.companySharePercent)||0,y=Number(n?.raw?.discount??0)||0,x=n?.raw?.discountType==="amount"?"amount":"percent";m.push(`share%=${f}`),m.push(`disc=${y}${x==="amount"?"":"%"}`),m.push(`applyTax=${n.applyTax?"Y":"N"} taxRate=${Number((ce*100).toFixed(2))}%`);const I=`
      <tr class="reports-debug-row">
        <td colspan="7">
          <code class="reports-debug-code">${vt(m.join("  |  "))}</code>
        </td>
      </tr>
    `;return`${p}${I}`}).join("");if(S.tableBody.innerHTML=e,S.tableMeta){const n=O("projects.reports.table.meta","Showing {count} of {total} projects");S.tableMeta.textContent=n.replace("{count}",vn(t.length)).replace("{total}",vn(U.totalProjects))}}function Js(){!S.tableHead||S.tableHead.dataset.sortAttached==="true"||(S.tableHead.addEventListener("click",t=>{const e=t.target.closest("[data-sort-key]");if(!e)return;const n=e.getAttribute("data-sort-key");n&&(Tt.key===n?Tt.dir=Tt.dir==="asc"?"desc":"asc":(Tt.key=n,Tt.dir=n==="project"||n==="client"||n==="status"?"asc":"desc"),dt())}),S.tableHead.dataset.sortAttached="true")}function Qs(t){const e=Tt.dir==="asc"?1:-1,n=Tt.key,r=(a,s)=>{switch(n){case"project":{const c=String(a.title||a.projectCode||"").toLowerCase(),i=String(s.title||s.projectCode||"").toLowerCase();return c.localeCompare(i,"ar")}case"client":{const c=String(a.clientName||"").toLowerCase(),i=String(s.clientName||"").toLowerCase();return c.localeCompare(i,"ar")}case"status":{const c=String(a.status||""),i=String(s.status||"");return c.localeCompare(i,"ar")}case"period":{const c=a.start?new Date(a.start).getTime():0,i=s.start?new Date(s.start).getTime():0;return c-i}case"value":return(a.overallTotal||0)-(s.overallTotal||0);case"margin":{const c=bn(a).marginPercent||0,i=bn(s).marginPercent||0;return c-i}case"payment":{const c=i=>i==="paid"?2:i==="partial"?1:0;return c(a.paymentStatus)-c(s.paymentStatus)}default:return(a.overallTotal||0)-(s.overallTotal||0)}};return t.sort((a,s)=>e*r(a,s))}function tc(){if(!S.tableHead)return;S.tableHead.querySelectorAll("th.sortable").forEach(e=>{e.classList.remove("is-sorted"),e.removeAttribute("data-dir");const n=e.getAttribute("data-sort-key");n&&e.setAttribute("title",Tr(n,null))});const t=S.tableHead.querySelector(`th.sortable[data-sort-key="${Tt.key}"]`);t&&(t.classList.add("is-sorted"),t.setAttribute("data-dir",Tt.dir),t.setAttribute("title",Tr(Tt.key,Tt.dir)))}function Tr(t,e){const r=O({project:"projects.reports.table.columns.project",client:"projects.reports.table.columns.client",status:"projects.reports.table.columns.status",period:"projects.reports.table.columns.period",value:"projects.reports.table.columns.value",margin:"projects.reports.table.columns.margin",payment:"projects.reports.table.columns.payment"}[t]||"",t);if(!e)return`${r} — ${O("projects.reports.table.sortable","قابل للفرز")}`;const a=e==="asc"?O("projects.reports.table.sort.asc","ترتيب تصاعدي"):O("projects.reports.table.sort.desc","ترتيب تنازلي");return`${r} — ${a}`}function Lr(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const r=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",a=new Intl.DateTimeFormat(r,{day:"2-digit",month:"2-digit",year:"numeric"});return Qt(a.format(e))}function Ca(t,e){if(!t&&!e)return"—";const n=t?Lr(t):"—",r=e?Lr(e):"—";return e?`${n} → ${r}`:n}function bt(t){const e=Number(t)||0,r=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",a=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${Qt(a)} SR`}function vn(t){const n=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return Qt(new Intl.NumberFormat(n).format(t))}function Sa(t){const n=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=Number.isFinite(t)?t:0,a=new Intl.NumberFormat(n,{minimumFractionDigits:1,maximumFractionDigits:1}).format(r);return`${Qt(a)}%`}function Jt(t){const n=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return Qt(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function ec(){return wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function vt(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}export{dn as a,Mo as e,yc as p};
