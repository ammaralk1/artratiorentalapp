import{t as a,r as T,f as L,c as X,p as U,a as G,b as y,d as A,e as V}from"./calculations.Bqm4O-PR.js";import{e as Y}from"./reports.D4BrwVTJ.js";import{s as J,c as B,d as K,q as Q}from"./controller.CwK47G-r.js";import{n as F}from"./auth.BcQOd76e.js";import"./reservationsService.BtJ4Aekt.js";import"./dashboard.DfLXSGVN.js";/* empty css              */import"./dashboardShell.deT9qe6E.js";import"./customers.Bfn9j-AP.js";import"./maintenanceService.Cf3sMnbW.js";const N=96,$=25.4,D=210,S=297,k=Math.round(D/$*N),_=Math.round(S/$*N),Z=/safari/i,tt=/(iphone|ipad|ipod)/i,et=/(crios|fxios|edgios|opios)/i;function ot(){try{const o=navigator.userAgent||"";return tt.test(o)&&Z.test(o)&&!et.test(o)}catch{return!1}}function nt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function rt(o="preview"){const e=document.createElement("div");e.id="quotation-pdf-root",e.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),e.setAttribute("data-quote-render-context",o);const c=document.createElement("style");c.textContent=String(Q).trim(),e.appendChild(c);const p=document.createElement("div");p.className="quote-preview-pages",p.setAttribute("data-quote-pages",""),e.appendChild(p);const t=document.createElement("style");return t.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
  `,e.appendChild(t),e}function M({primary:o=!1}={}){const e=document.createElement("div");return e.className="quote-page",o&&e.classList.add("quote-page--primary"),e}function at(o){const e=document.createElement("div");e.className="rpt-header";const c=document.createElement("h1");c.textContent=a("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const p=document.createElement("p");p.className="rpt-subtitle",p.textContent=`${V(new Date)} • ${a("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,e.appendChild(c),e.appendChild(p);const t=document.createElement("div");t.className="rpt-kpis";const r=(d,n)=>{const s=document.createElement("div");return s.className="rpt-kpi",s.innerHTML=`<div class="label">${d}</div><div class="value">${n}</div>`,s};return t.appendChild(r(a("reservations.reports.kpi.total.label","الحجوزات","Reservations"),A(o.total||0))),t.appendChild(r(a("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),y(o.revenue||0))),t.appendChild(r(a("reservations.reports.kpi.net.label","صافي الربح","Net profit"),y(o.netProfit||0))),t.appendChild(r(a("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),y(o.companyShareTotal||0))),t.appendChild(r(a("reservations.reports.kpi.tax.label","الضريبة","Tax"),y(o.taxTotal||0))),t.appendChild(r(a("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),y(o.maintenanceExpense||0))),e.appendChild(t),e}function st(){try{const o=T?.data||{},e=T?.lastSnapshot?.filtered||o.reservations||[],c=new Map((o.customers||[]).map(n=>[String(n.id),n])),p=[...e].sort((n,s)=>new Date(s?.start||0)-new Date(n?.start||0)),t={code:a("reservations.reports.results.headers.id","الحجز","Reservation"),customer:a("reservations.reports.results.headers.customer","العميل","Customer"),date:a("reservations.reports.results.headers.date","التاريخ","Date"),status:a("reservations.reports.results.headers.status","الحالة","Status"),payment:a("reservations.reports.results.headers.payment","الدفع","Payment"),total:a("reservations.reports.results.headers.total","الإجمالي","Total"),share:a("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:a("reservations.reports.results.headers.net","صافي الربح","Net profit")},r=[t.code,t.customer,t.date,t.status,t.payment,t.total,t.share,t.net],d=p.map(n=>{const s=n?.reservationId||n?.id||"—",w=F(String(s)),i=c.get(String(n?.customerId))?.customerName||a("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),b=L(n?.start),v=X(n),l=(()=>{switch(v.statusValue){case"completed":return String(a("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(a("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(a("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return F(String(v.statusValue||"—"))}})(),m=U(v.paidStatus),u=G(n),f=y(u.finalTotal),g=u.companySharePercent>0?`${A(u.companySharePercent)}% (${y(u.companyShareAmount)})`:a("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),h=y(u.netProfit);return{[t.code]:w,[t.customer]:i,[t.date]:b,[t.status]:l,[t.payment]:m,[t.total]:f,[t.share]:g,[t.net]:h}});return{headers:r,rows:d}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function I(o){const e=document.createElement("table");e.className="rpt-table";const c=document.createElement("thead"),p=document.createElement("tr");o.forEach(r=>{const d=document.createElement("th");d.textContent=r,p.appendChild(d)}),c.appendChild(p);const t=document.createElement("tbody");return e.appendChild(c),e.appendChild(t),{table:e,tbody:t}}function it(o,e,c,p){const t=o.querySelector("[data-quote-pages]"),r=M({primary:!0});t.appendChild(r);const d=at(p);r.appendChild(d);let{table:n,tbody:s}=I(c);r.appendChild(n);const w=18,x=28,i=[];for(let l=0;l<e.length;l+=x)i.push(e.slice(l,l+x));if(i.length){const l=i[0];if(l.length>w){const m=l.splice(w);i.length>1?i[1]=m.concat(i[1]):i.push(m)}}const b=(l,m)=>{const u=document.createElement("tr");c.forEach(f=>{const g=document.createElement("td");g.textContent=m[f]!=null?String(m[f]):"",u.appendChild(g)}),l.appendChild(u)};(i.shift()||e).forEach(l=>b(s,l)),i.forEach(l=>{const m=M({primary:!1});t.appendChild(m);const u=I(c);m.appendChild(u.table),l.forEach(f=>b(u.tbody,f))})}function pt(o=[],{context:e="preview"}={}){const p=(T.lastSnapshot||{}).metrics||{};let t,r=o&&o.length?o:null;if(r)t=Object.keys(r[0]||{});else{const s=st();t=s.headers,r=s.rows}const d=rt(e),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${k}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(d);try{J(d),B(d),K(d)}catch{}return it(d,r||[],t,p),d.parentElement?.removeChild(d),n.parentElement?.removeChild(n),d}async function wt(o=[],{action:e="save"}={}){const c=pt(o,{context:"export"}),p=document.createElement("div");Object.assign(p.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),p.appendChild(c),document.body.appendChild(p);try{const r=ot()&&!nt()?window.open("","_blank"):null;if(r)try{r.document.open(),r.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${a("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${a("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${a("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),r.document.close()}catch{}await Y();const d=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,n=window.html2canvas;if(typeof d=="function"&&typeof n=="function"){const s=new d({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),x={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},i=Array.from(c.querySelectorAll(".quote-page"));let b=0;const v=2,l=-2;for(let m=0;m<i.length;m+=1){const u=i[m],f=u.ownerDocument||document,g=f.createElement("div");Object.assign(g.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const h=u.cloneNode(!0);h.style.width=`${k}px`,h.style.maxWidth=`${k}px`,h.style.minWidth=`${k}px`,h.style.height=`${_}px`,h.style.maxHeight=`${_}px`,h.style.minHeight=`${_}px`,h.style.position="relative",h.style.background="#ffffff",g.appendChild(h),f.body.appendChild(g);let C;try{C=await n(h,{...x,scrollX:0,scrollY:0})}finally{g.parentNode?.removeChild(g)}if(!C)continue;const j=C.width||1,H=(C.height||1)/j;let P=D,E=P*H,q=0;if(E>S){const R=S/E;E=S,P=P*R,q=Math.max(0,(D-P)/2)}const W=C.toDataURL("image/jpeg",.95);b>0&&s.addPage();const z=Math.max(0,q+v),O=l;s.addImage(W,"JPEG",z,O,P,E,`page-${b+1}`,"FAST"),b+=1,await new Promise(R=>requestAnimationFrame(R))}if(b===0)throw new Error("PDF generation produced no pages");if(e==="print"){const m=s.output("bloburl");if(r)try{r.location.href=m}catch{}else await new Promise(u=>{const f=document.createElement("iframe");Object.assign(f.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),f.onload=()=>{try{f.contentWindow?.focus(),f.contentWindow?.print()}catch{}setTimeout(()=>{f.remove(),u()},700)},f.src=m,document.body.appendChild(f)})}else s.save("reservations-report.pdf")}else{const s=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(c).toPdf();if(e==="print"){const w=await s.get("pdf").then(x=>x.output("bloburl"));await new Promise(x=>{const i=document.createElement("iframe");Object.assign(i.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),i.onload=()=>{try{i.contentWindow?.focus(),i.contentWindow?.print()}catch{}setTimeout(()=>{i.remove(),x()},700)},i.src=w,document.body.appendChild(i)})}else await s.save("reservations-report.pdf")}}finally{p.remove()}}export{pt as buildReportsPdfPages,wt as exportReportsPdf};
