import{n as Y,r as z,i as V,p as H,l as K,m as _}from"./reservationsService.BLsfbDMx.js";import{t as U,n as T,g as R}from"./auth.iwMzhNuX.js";const y={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function et(t){y.callbacks.onRender=typeof t=="function"?t:null}function nt(t){y.callbacks.onBeforeRender=typeof t=="function"?t:null}function at(t){y.callbacks.onAfterRender=typeof t=="function"?t:null}function ot(t){y.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function rt(t){y.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function st(t){y.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function D(t,e,s=e){const o=R()==="en"?s??e:e;return U(t,o)}function ct(){y.formatters.cachedLocale=null,y.formatters.numberFormatter=null}function x(){return(R()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function j(){const t=R();if(t!==y.formatters.cachedLocale||!y.formatters.numberFormatter||!y.formatters.currencyFormatter){y.formatters.cachedLocale=t;const e=x();y.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),y.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:y.formatters.numberFormatter,currencyFormatter:y.formatters.currencyFormatter}}function ut(t){const{numberFormatter:e}=j(),s=e.format(Math.round(t||0));return T(s)}function lt(t){const{currencyFormatter:e}=j(),s=Number.isFinite(Number(t))?Number(t):0,n=e.format(s);return`${T(n)} SR`}function k(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${o}`}function it(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const s=new Intl.DateTimeFormat(x(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return T(s.format(e))}function O(t){return new Intl.DateTimeFormat(x(),{month:"short"}).format(t)}const W=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),L=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),G=1440*60*1e3,b={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function M(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const s=t[0]||{},n=t[e-1]||{},o=`${s.id??s.reservationId??""}-${s.start??""}`,r=`${n.id??n.reservationId??""}-${n.start??""}`,a=y.formatters?.cachedLocale||"ar";return`${e}|${o}|${r}|${a}`}function N(t,e){return t.get(e)}function A(t,e,s){if(t.set(e,s),t.size>64){const n=t.keys().next().value;t.delete(n)}return s}function q(t){return T(String(t||"")).toLowerCase().trim()}function F(t){return(t||"").toString().trim()}function Q(t,e){if(!t||!e)return 1;const s=new Date(t),n=new Date(e);if(Number.isNaN(s.getTime())||Number.isNaN(n.getTime()))return 1;const o=n.getTime()-s.getTime();return o<=0?1:Math.max(1,Math.ceil(o/G))}function P(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;Q(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,s=t.discountType||t.discount_type||"percent",n=String(s).toLowerCase()==="amount"?"amount":"percent",o=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",r=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,a=r!=null?H(r):Number.NaN,u=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(a)&&a>0?a:null,l=Array.isArray(t.crewAssignments)?t.crewAssignments:[],f=l.length?l.map(h=>h?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],i=K({items:Array.isArray(t.items)?t.items:[],technicianIds:f,crewAssignments:l,discount:e,discountType:n,applyTax:o,start:t.start,end:t.end,companySharePercent:u}),m=Number(t.cost);let p=i.finalTotal,d=i.taxAmount;if(Number.isFinite(m)&&m>0&&(p=_(m),o)){const h=p-i.taxableAmount;Number.isFinite(h)&&h>=0&&(d=_(h))}const g={rentalDays:i.rentalDays,equipmentTotal:i.equipmentTotal,crewTotal:i.crewTotal,crewCostTotal:i.crewCostTotal,discountAmount:i.discountAmount,subtotalAfterDiscount:i.subtotalAfterDiscount,taxableAmount:i.taxableAmount,taxAmount:d,finalTotal:p,companySharePercent:i.companySharePercent,companyShareAmount:i.companyShareAmount,netProfit:i.netProfit,companyShareEnabled:i.companySharePercent>0};return t.__financials=g,g}function $(t){return t?.projectId&&y.data.projectsMap.get(String(t.projectId))||null}function E(t=""){const e=String(t).toLowerCase().trim();return e?W.get(e)||e:""}function J(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const s of e){const n=String(s||"").toLowerCase().trim();if(n&&L.has(n))return L.get(n)}return t?.paid===!0||t?.paid==="true"}function C(t){const e=$(t),s=z(t,e),n=E(s.projectStatus);let o=E(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");s.projectLinked&&n&&(o=n),(!o||o==="cancelled")&&(o=s.effectiveConfirmed?"confirmed":"pending"),(V(t)||n==="completed")&&(o="completed");const r=s.effectiveConfirmed||o==="confirmed"||o==="completed";r&&o!=="completed"&&(o="confirmed");const a=J(t),c=t?.paidStatus??t?.paid_status??(a?"paid":"unpaid");return{statusValue:o,confirmed:r,paid:a,paidStatus:c}}function mt(t){const e=t.length;let s=0,n=0,o=0,r=0,a=0,c=0,u=0,l=0,f=0;t.forEach(m=>{const{statusValue:p,confirmed:d,paid:g}=C(m);p==="completed"&&(n+=1),d&&(s+=1),g&&(o+=1);const h=P(m);r+=h.finalTotal,a+=h.companyShareAmount,c+=h.taxAmount,u+=h.crewTotal,l+=h.crewCostTotal??0,f+=h.netProfit});const i=e?r/e:0;return{total:e,confirmed:s,completed:n,paidCount:o,revenue:r,average:i,companyShareTotal:a,taxTotal:c,crewTotal:u,crewCostTotal:l,netProfit:f}}function B({range:t,start:e,end:s}){const n=new Date;if(n.setHours(23,59,59,999),t==="custom"){const a=e?new Date(`${e}T00:00:00`):null,c=s?new Date(`${s}T23:59:59`):null;return{startDate:I(a)?a:null,endDate:I(c)?c:null}}let o=new Date(n),r=null;switch(t){case"last30":{r=new Date(n),r.setDate(r.getDate()-29);break}case"thisWeek":{const a=new Date(n),u=(a.getDay()-6+7)%7;a.setDate(a.getDate()-u),a.setHours(0,0,0,0);const l=new Date(a);l.setDate(a.getDate()+6),l.setHours(23,59,59,999),r=a,o=l;break}case"thisMonth":{r=new Date(n.getFullYear(),n.getMonth(),1),o=new Date(n.getFullYear(),n.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const a=Math.floor(n.getMonth()/3);r=new Date(n.getFullYear(),a*3,1),o=new Date(n.getFullYear(),(a+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{r=new Date(n.getFullYear(),0,1),o=new Date(n.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:r=null,o=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:o}}function I(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function pt(t,e){const{startDate:s,endDate:n}=B(e);let o=0;const r=[];return(t||[]).forEach(a=>{if(!a)return;const c=typeof a.repairCost=="number"?a.repairCost:Number.parseFloat(T(String(a.repairCost??"")));if(!Number.isFinite(c)||c<=0)return;const u=String(a.statusRaw??a.status??"").toLowerCase();if(!(u==="closed"||u==="completed"||u==="cancelled"))return;const f=a.resolvedAt??a.resolved_at??null,i=a.reportedAt??a.reported_at??null,m=a.createdAt??a.created_at??null,p=f?new Date(f):null,d=i?new Date(i):m?new Date(m):null,g=p&&!Number.isNaN(p.getTime())?p:d&&!Number.isNaN(d.getTime())?d:null;if(g&&(s&&g<s||n&&g>n))return;const h=Math.round(c*100)/100;o+=h,r.push({id:a.id,cost:h,date:g})}),{total:o,items:r}}function dt(t,e){const s=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:s,netProfit:(t.netProfit||0)-s}}function ft(t){const e=`trend:${M(t)}`,s=N(b.trend,e);if(s)return s;const n=new Date,o=[];for(let r=5;r>=0;r-=1){const a=new Date(n.getFullYear(),n.getMonth()-r,1),c=a.getFullYear(),u=a.getMonth(),l=t.filter(S=>{const w=S?.start?new Date(S.start):null;return w&&w.getFullYear()===c&&w.getMonth()===u}),f=l.length;let i=0,m=0,p=0;l.forEach(S=>{const w=P(S);i+=w.finalTotal,m+=w.netProfit,p+=w.companyShareAmount});const d=O(a),g=new Date(a.getFullYear(),a.getMonth(),1),h=new Date(a.getFullYear(),a.getMonth()+1,0);o.push({label:d,count:f,revenue:i,netProfit:m,companyShare:p,periodStart:g,periodEnd:h,startInput:k(g),endInput:k(h)})}return A(b.trend,e,o)}function ht(t){const e=`status:${M(t)}`,s=N(b.status,e);if(s)return s;const n={confirmed:0,pending:0,completed:0};(t||[]).forEach(l=>{const{statusValue:f,confirmed:i}=C(l);f==="completed"?n.completed+=1:f==="confirmed"||i?n.confirmed+=1:n.pending+=1});const o=Math.max(1,(t||[]).length),r=n.confirmed,a=n.pending,c=n.completed,u=[{label:D("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:r,percent:Math.round(r/o*100)||0,rawCount:r,className:"status-confirmed",filterKey:"confirmed"},{label:D("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:a,percent:Math.round(a/o*100)||0,rawCount:a,className:"status-pending",filterKey:"pending"},{label:D("reservations.reports.status.completedLabel","منتهية","Completed"),value:c,percent:Math.round(c/o*100)||0,rawCount:c,className:"status-completed",filterKey:"completed"}];return A(b.status,e,u)}function yt(t){const e=`payment:${M(t)}`,s=N(b.payment,e);if(s)return s;const n=t.length||1,o=t.filter(c=>C(c).paid).length,r=t.length-o,a=[{label:D("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-paid",filterKey:"paid"},{label:D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}];return A(b.payment,e,a)}function gt(t,e){const s=`topCustomers:${M(t)}`,n=N(b.topCustomers,s);if(n)return n;const o=new Map,r=new Map((e||[]).map(c=>[String(c.id),c]));t.forEach(c=>{const u=String(c?.customerId??"unknown"),l=o.get(u)||{count:0,revenue:0},f=P(c);l.count+=1,l.revenue+=f.finalTotal,o.set(u,l)});const a=Array.from(o.entries()).map(([c,u])=>({name:r.get(c)?.customerName||D("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:u.count,revenue:u.revenue})).sort((c,u)=>u.revenue-c.revenue).slice(0,5);return A(b.topCustomers,s,a)}function wt(t,e){const s=`topEquipment:${M(t)}`,n=N(b.topEquipment,s);if(n)return n;const o=new Map,r=new Map((e||[]).map(u=>[F(u?.barcode),u])),a=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(u=>{(u?.items||[]).forEach(l=>{const f=F(l?.barcode),i=f?r.get(f):null,m=l?.desc||l?.description||l?.name||i?.desc||i?.description||i?.name||"",p=m&&m.trim()?m:a,d=Y(p)||"unknown",g=Number(l?.qty)||1,h=Number(l?.price)||0,S=g*h,w=o.get(d)||{name:p,count:0,revenue:0};w.name=p,w.count+=g,w.revenue+=S,o.set(d,w)})});const c=Array.from(o.values()).sort((u,l)=>l.count!==u.count?l.count-u.count:l.revenue-u.revenue).slice(0,5);return A(b.topEquipment,s,c)}function bt(){Object.values(b).forEach(t=>t.clear())}function X(t,e,s,n,o){const r=[],a=t?.reservationId||t?.id;a&&r.push(a),t?.notes&&r.push(t.notes);const{statusValue:c,paidStatus:u}=C(t);c&&r.push(c);const l=t?.paymentStatus||t?.payment_status;l&&r.push(l),t?.paid!=null&&r.push(t.paid?"paid":"unpaid"),u&&r.push(u);const f=s.get(String(t?.customerId));f&&r.push(f.customerName,f.company_name||f.companyName,f.contact_person||"");const i=$(t);return i&&r.push(i.title,i.code,i.status),r.push(Z(u)),(t?.items||[]).forEach(p=>{p?.desc&&r.push(p.desc),p?.barcode&&r.push(p.barcode);const d=n.get(F(p?.barcode));d&&r.push(d.desc,d.description,d.name)}),(t?.technicians||[]).forEach(p=>{const d=o.get(String(p));d&&r.push(d.name,d.role,d.department)}),q(r.filter(Boolean).join(" ")).includes(e)}function Dt(t,e,s,n,o){const{startDate:r,endDate:a}=B(e),c=q(e.search),u=!!c,l=new Map((s||[]).map(m=>[String(m.id),m])),f=new Map((n||[]).map(m=>[F(m?.barcode),m])),i=new Map((o||[]).map(m=>[String(m.id),m]));return(t||[]).filter(m=>{if(m&&m.projectId!=null&&String(m.projectId).trim()!=="")return!1;const p=m?.start?new Date(m.start):null;if(!p||Number.isNaN(p.getTime())||r&&p<r||a&&p>a)return!1;const{statusValue:d,confirmed:g,paid:h}=C(m);if(e.status==="confirmed"&&!(d==="confirmed"||d==="completed"||g)||e.status==="pending"&&d!=="pending"||e.status==="completed"&&d!=="completed"||e.payment==="paid"&&!h||e.payment==="unpaid"&&h)return!1;if(e.share&&e.share!=="all"){const w=P(m).companySharePercent>0;if(e.share==="with"&&!w||e.share==="without"&&w)return!1}return!(u&&!X(m,c,l,f,i))})}function Z(t){const e=String(t??"").toLowerCase();return e==="paid"?D("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}export{bt as a,lt as b,P as c,C as d,it as e,ut as f,k as g,Dt as h,mt as i,pt as j,dt as k,ft as l,ht as m,yt as n,gt as o,Z as p,wt as q,y as r,et as s,D as t,nt as u,at as v,ot as w,rt as x,st as y,ct as z};
