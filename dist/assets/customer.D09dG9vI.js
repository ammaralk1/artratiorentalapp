import{r as Ae,n as I,l as O,t as m,s as C,e as ke,h as je,i as Te,m as Pe,j as Ne,a as xt,b as Ce,d as ct}from"./auth.DeRd8Lwk.js";import{i as Le}from"./dashboardShell.GGxhX8QT.js";import{e as Pt,g as Be,c as _e}from"./form.BjojDpxM.js";import{c as Jt,d as qt,g as Re,w as we,f as Fe,u as Me,s as $e,h as qe,m as He}from"./controller.DxuTUCXb.js";import{d as Ue,g as Ve,o as ze,q as Oe,D as ut,f as Nt,v as We,w as Ye}from"./reservationsService.uHRkBvfi.js";import{g as It,b as Ke,a as Qe,c as Ge,d as Xt,s as Je,e as Xe,r as Ze}from"./projectFocusTemplates.DuRNYSo5.js";Ae({ar:{"customerDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.title":"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.hero.subtitle":"ğŸ‘‹ Ù‡Ø°Ù‡ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.fields.taxId":"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:","customerDetails.fields.document":"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.reservations":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.stats.upcoming":"Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.projects":"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerDetails.stats.projectsEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.stats.lastActivity":"Ø¢Ø®Ø± Ù†Ø´Ø§Ø·","customerDetails.stats.lastActivityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.reservationsDesc":"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ","customerDetails.stats.upcomingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.nextReservation":"Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}","customerDetails.stats.projectsDesc":"Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.payment":"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentBreakdown":"Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentPaid":"Ø§Ù„Ù…Ø¯ÙÙˆØ¹","customerDetails.stats.paymentOutstandingLabel":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.totalValue":"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: {amount}","customerDetails.stats.totalValueEmpty":"Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ù…Ø¨Ø§Ù„Øº Ø¨Ø¹Ø¯.","customerDetails.stats.paymentOutstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}","customerDetails.stats.paymentAllSet":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.paymentOutstandingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.activityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.activityOn":"Ø¨ØªØ§Ø±ÙŠØ® {date}","customerDetails.stats.activityType.reservation":"Ø­Ø¬Ø²","customerDetails.stats.activityType.project":"Ù…Ø´Ø±ÙˆØ¹","customerDetails.stats.activityType.customer":"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.complianceEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©","customerDetails.stats.complianceProjects":"Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}","customerDetails.stats.complianceLabel.excellent":"Ø§Ù„ØªØ²Ø§Ù… Ù…Ù…ØªØ§Ø²","customerDetails.stats.complianceLabel.good":"Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯","customerDetails.stats.complianceLabel.average":"ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©","customerDetails.stats.complianceLabel.poor":"ØªØ£Ø®ÙŠØ± Ù…ØªÙƒØ±Ø±","customerDetails.document.open":"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯","customerDetails.document.defaultName":"Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·","customerDetails.primaryNav.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.primaryNav.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerTabs.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.customerReservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerTabs.customerProjects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","customerDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²...","customerDetails.fields.name":"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:","customerDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","customerDetails.fields.company":"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:","customerDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","customerDetails.fields.address":"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:","customerDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","customerDetails.toast.missingRequired":"âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†","customerDetails.toast.notFound":"âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","customerDetails.toast.updateSuccess":"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...","customerDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.loadFailed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","customerDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"ğŸ‘¤ Client Profile","customerDetails.hero.subtitle":"ğŸ‘‹ Here is a quick look at this client","customerDetails.fields.taxId":"ğŸ§¾ Tax Number:","customerDetails.fields.document":"ğŸ“ Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"ğŸ“… Booking Management","customerDetails.primaryNav.projects":"ğŸ“ Project Management","customerTabs.reservations":"ğŸ“… Booking Management","customerTabs.projects":"ğŸ“ Project Management","customerTabs.customerReservations":"ğŸ“… Client Reservations","customerTabs.customerProjects":"ğŸ“ Client Projects","customerDetails.actions.back":"â¬…ï¸ Back","customerDetails.actions.edit":"âœï¸ Edit Client","customerDetails.filters.search":"ğŸ” Search by client or reservation ID...","customerDetails.fields.name":"ğŸ‘¤ Name:","customerDetails.fields.phone":"ğŸ“ Phone:","customerDetails.fields.company":"ğŸ¢ Company:","customerDetails.fields.email":"ğŸ“§ Email:","customerDetails.fields.address":"ğŸ“ Address:","customerDetails.fields.notes":"ğŸ“ Notes:","customerDetails.toast.missingRequired":"âš ï¸ Name and phone are required","customerDetails.toast.notFound":"âš ï¸ Client not found","customerDetails.toast.updateSuccess":"âœ… Client information updated","customerDetails.status.loading":"â³ Loading client information...","customerDetails.errors.notFound":"âš ï¸ This client could not be found.","customerDetails.errors.loadFailed":"âš ï¸ Failed to load client information.","customerDetails.errors.missingId":"âš ï¸ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"âœï¸ Edit Client","customerProjects.title":"ğŸ“ Client Projects","customerProjects.empty":"No projects are linked to this client."}});let Ct={},x={initialized:!1,currentId:null,modal:{el:null,body:null}};function _t(t=""){return I(String(t)).trim().toLowerCase()}function fe(t,e,a){if(!e||!a)return;const{startDate:n,endDate:s}=qt(t);e._flatpickr?n?e._flatpickr.setDate(n,!1,"Y-m-d"):e._flatpickr.clear():e.value=n||"",a._flatpickr?s?a._flatpickr.setDate(s,!1,"Y-m-d"):a._flatpickr.clear():a.value=s||""}function Zt(t,{endOfDay:e=!1}={}){if(!t)return null;const a=String(t).trim();if(!a)return null;const n=a.includes("T")?a:`${a}T00:00:00`,s=new Date(n);return Number.isNaN(s.getTime())?null:(e?s.setHours(23,59,59,999):s.setHours(0,0,0,0),s)}function Lt(t){const e=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const a of e){if(!a)continue;const n=new Date(a);if(!Number.isNaN(n.getTime()))return n.setHours(0,0,0,0),n}return null}function At(t){if(!document.getElementById("customer-reservations"))return;const a=document.getElementById("customer-search-reservation"),n=document.getElementById("customer-filter-start-date"),s=document.getElementById("customer-filter-end-date"),i=document.getElementById("customer-reservation-date-range"),c=document.getElementById("customer-reservation-status-filter"),v=document.getElementById("customer-clear-filters");window.flatpickr&&(n&&window.flatpickr(n,{dateFormat:"Y-m-d"}),s&&window.flatpickr(s,{dateFormat:"Y-m-d"}));const p=()=>{let d=I(n?.value||"").trim(),g=I(s?.value||"").trim(),u=i?.value||"";if(new Set(["","today","week","month"]).has(u)||(u="",i&&(i.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),d="",g=""),!d&&!g&&u){const{startDate:S,endDate:T}=qt(u);d=S,g=T}return{searchTerm:_t(a?.value||""),startDate:d,endDate:g,status:c?.value||"",quickRange:u,customerId:t}},f=()=>{Ct=p(),Jt("customer-reservations",Ct)};a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{a.value=I(a.value),f()}),a.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{i&&(i.value=""),f()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{i&&(i.value=""),f()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{fe(i.value,n,s),f()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",f),c.dataset.listenerAttached="true"),v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{a&&(a.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i.value=""),c&&(c.value=""),f()}),v.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{Jt("customer-reservations",Ct)},f()}function lt(t){x.currentId=t;const{container:e}=rt();e&&(x.initialized||(ta(),ea(),na(),document.addEventListener("projects:changed",()=>{x.currentId&&B()}),document.addEventListener("language:changed",()=>{x.currentId&&B()}),document.addEventListener("technicians:updated",()=>{x.currentId&&B()}),x.initialized=!0),B())}function rt(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function ta(){const{searchInput:t,statusSelect:e,clearBtn:a,startInput:n,endInput:s,rangeSelect:i}=rt();window.flatpickr&&(n&&!n.dataset.datepickerAttached&&(window.flatpickr(n,{dateFormat:"Y-m-d"}),n.dataset.datepickerAttached="true"),s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=I(t.value),B()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{B()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{n.value=I(n.value),i&&(i.value=""),B()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=I(s.value),i&&(i.value=""),B()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{fe(i.value,n,s),B()}),i.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{const{searchInput:c,statusSelect:v,startInput:p,endInput:f,rangeSelect:d}=rt();c&&(c.value=""),v&&(v.value=""),d&&(d.value=""),p&&(p._flatpickr&&p._flatpickr.clear(),p.value=""),f&&(f._flatpickr&&f._flatpickr.clear(),f.value=""),B()}),a.dataset.listenerAttached="true")}function ea(){const{container:t}=rt();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",aa),t.dataset.projectModalListenerAttached="true")}function aa(t){const e=t.target.closest(".project-focus-card");if(!e||t.target.closest("[data-ignore-project-modal]"))return;const n=e.dataset.projectId?String(e.dataset.projectId):"";n&&Rt(n)}function na(){Ht()}function Ht(){if(x.modal?.el&&x.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(x.modal={el:t,body:e},!0)}function B(){const{container:t,searchInput:e,statusSelect:a,startInput:n,endInput:s,rangeSelect:i}=rt();if(!t||!x.currentId)return;const c=_t(e?.value||""),v=a?.value||"";let p=I(n?.value||"").trim(),f=I(s?.value||"").trim(),d=i?.value||"";if(new Set(["","today","week","month"]).has(d)||(d="",i&&(i.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),p="",f=""),!p&&!f&&d){const{startDate:h,endDate:b}=qt(d);p=h,f=b}const u=Zt(p),D=Zt(f,{endOfDay:!0}),{projects:S=[],technicians:T=[],reservations:k=[],customers:E=[]}=O(),N=new Map(T.map(h=>[String(h.id),h])),A=sa(k),r=E.find(h=>String(h.id)===String(x.currentId))||null,l=S.filter(h=>String(h.clientId)===String(x.currentId)).filter(h=>{if(c){const b=[h.id,h.projectId,h.project_id,h.projectCode,h.project_code].map(G=>G==null?"":I(String(G)));if(!_t([h.title,h.description,h.notes,...b].filter(Boolean).join(" ")).includes(c))return!1}if(v&&Ue(h)!==v)return!1;if(u||D){const b=Lt(h);if(!b||u&&b<u||D&&b>D)return!1}return!0}).sort((h,b)=>{const $=Lt(h)?.getTime()||0;return(Lt(b)?.getTime()||0)-$});if(!l.length){const h=m("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${h}</div></div>`;return}t.innerHTML=l.map(h=>{const b=It(h),$=b?A.get(b)||[]:[];return Ke(h,{customer:r,techniciansMap:N,reservations:$})}).join("")}function sa(t=[]){const e=new Map;return t.forEach(a=>{const n=a?.projectId??a?.project_id??a?.projectID;if(n==null)return;const s=String(n);e.has(s)||e.set(s,[]),e.get(s).push(a)}),e}function Rt(t){const e=String(t||"").trim();if(!e||!Ht())return;const a=x.modal;if(!a?.body)return;a.body.dataset.mode="view";const{projects:n=[],reservations:s=[],customers:i=[]}=O(),c=la(n,e);if(!c||x.currentId&&c.clientId!=null&&String(c.clientId)!==String(x.currentId))return;const v=i.find(d=>String(d.id)===String(c.clientId))||null,p=s.filter(d=>{const g=da(d);return g&&g===e}),f=Qe(c,{customer:v,reservations:p});a.body.innerHTML=f,ra(c),ia(a.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(a.el).show():(a.el.classList.add("show"),a.el.style.display="block")}function ra(t){if(!t||!x.modal?.body)return;const e=x.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",a=>{a.preventDefault(),oa(t)})}function ia(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');if(!e.length)return;async function a(n){if(!Number.isInteger(n)||n<0)return!1;const s=Re("showReservationDetails");if(typeof s=="function")return s(n),!0;try{const i=await we("showReservationDetails");if(typeof i=="function")return i(n),!0}catch(i){console.warn("âš ï¸ [customerDetails] Unable to resolve reservation UI handler",i)}return!1}e.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();const i=Ve();let c=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(c)||c<0){const p=n.dataset.reservationId;p&&(c=i.findIndex(d=>[d?.id,d?.reservationId,d?.reservation_id].some(u=>u!=null&&String(u)===p)))}await a(c)||C(m("projects.details.reservations.viewUnavailable","ØªØ¹Ø°Ø± ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"))}),n.dataset.listenerAttached="true")})}function oa(t){if(!t||!Ht())return;const e=x.modal;if(!e?.body)return;const{customers:a=[]}=O(),n=a.find(c=>String(c.id)===String(t.clientId))||null,s=n?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||n?.companyName||n?.company||"";e.body.dataset.mode="edit",e.body.innerHTML=Ge(t,{clientName:s,clientCompany:i}),ca(t,{clientName:s,clientCompany:i})}function ca(t,{clientName:e="",clientCompany:a=""}={}){if(!t||!x.modal?.body)return;const n=x.modal.body,s=n.querySelector("#customer-project-edit-form")||n.querySelector("#project-details-edit-form");if(!s)return;const i=s.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",o=>{o.preventDefault();const l=It(t);l&&Rt(l)});const c=s.querySelector("#project-edit-expense-label"),v=s.querySelector("#project-edit-expense-amount"),p=s.querySelector('[data-action="add-expense"]'),f=s.querySelector("#project-edit-expense-list");s.querySelector('[name="project-start-date"]'),s.querySelector('[name="project-start-time"]'),s.querySelector('[name="project-end-date"]'),s.querySelector('[name="project-end-time"]');const d=s.querySelector("#project-edit-payment-status"),g=s.querySelector("#project-edit-tax"),u=s.querySelector("#project-edit-company-share"),D=s.querySelector("#project-edit-discount-type"),S=s.querySelector("#project-edit-discount"),T=s.querySelector("#project-edit-payment-progress-type"),k=s.querySelector("#project-edit-payment-progress-value"),E={expenses:Array.isArray(t?.expenses)?t.expenses.map(o=>({...o})):[]};let N=!1;const A=o=>{!g||!u||N||(N=!0,o==="share"?u.checked?(g.checked||(g.checked=!0),Pt(u,ut)):g.checked&&(g.checked=!1):o==="tax"&&(g.checked?Pt(u,ut):u.checked&&(u.checked=!1)),N=!1)},r=()=>{f&&(f.innerHTML=Xe(E.expenses))};r(),p&&!p.dataset.listenerAttached&&(p.addEventListener("click",o=>{o.preventDefault();const l=c?.value.trim()||"",h=I(v?.value||"0"),b=Number(h);if(!l){C(m("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),c?.focus();return}if(!Number.isFinite(b)||b<=0){C(m("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),v?.focus();return}E.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:l,amount:b}),c&&(c.value=""),v&&(v.value=""),r()}),p.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("click",o=>{const l=o.target.closest('[data-action="remove-expense"]');if(!l)return;const{id:h}=l.dataset;E.expenses=E.expenses.filter(b=>String(b.id)!==String(h)),r()}),f.dataset.listenerAttached="true"),S&&!S.dataset.listenerAttached&&(S.addEventListener("input",o=>{const l=o.target;l instanceof HTMLInputElement&&(l.value=I(l.value||""))}),S.dataset.listenerAttached="true"),k&&!k.dataset.listenerAttached&&(k.addEventListener("input",o=>{const l=o.target;l instanceof HTMLInputElement&&(l.value=I(l.value||""))}),k.dataset.listenerAttached="true"),d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{d.dataset.userSelected="true"}),d.dataset.listenerAttached="true"),u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>A("share")),u.dataset.listenerAttached="true"),g&&!g.dataset.listenerAttached&&(g.addEventListener("change",()=>A("tax")),g.dataset.listenerAttached="true"),u?.checked&&Pt(u,ut),A(u?.checked?"share":"tax"),s.addEventListener("submit",async o=>{if(o.preventDefault(),s.dataset.submitting==="true")return;const l=new FormData(s),h=(l.get("project-title")||"").toString().trim(),b=(l.get("project-type")||"").toString().trim(),$=(l.get("project-start-date")||"").toString().trim(),G=(l.get("project-start-time")||"").toString().trim(),zt=(l.get("project-end-date")||"").toString().trim(),he=(l.get("project-end-time")||"").toString().trim(),ve=(l.get("project-description")||"").toString().trim(),Ot=(l.get("project-payment-status")||"unpaid").toString().toLowerCase(),Wt=["paid","partial"].includes(Ot)?Ot:"unpaid",J=g?.checked===!0;if(!h||!b||!$){C(m("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"));return}const Yt=Xt($,G),kt=zt?Xt(zt,he):"";if(kt){const _=new Date(Yt),w=new Date(kt);if(!Number.isNaN(_.getTime())&&!Number.isNaN(w.getTime())&&_>w){C(m("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"));return}}const dt=It(t);if(!dt){C(m("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const Kt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,De=E.expenses.reduce((_,w)=>_+(Number(w.amount)||0),0),Qt=D?.value==="amount"?"amount":"percent",Ee=I(S?.value||"0");let X=Number.parseFloat(Ee);(!Number.isFinite(X)||X<0)&&(X=0);const Z=u?.checked===!0;let tt=Z?Be(u):null;(!Number.isFinite(tt)||tt<=0)&&(tt=Z&&J?ut:null);const et=_e({equipmentEstimate:Kt,expensesTotal:De,discountValue:X,discountType:Qt,applyTax:J,companyShareEnabled:Z,companySharePercent:tt}),be=T?.value==="amount"?"amount":"percent",Gt=I(k?.value||""),Se=Gt?Number.parseFloat(Gt):null,Y=ze({totalAmount:et.totalWithTax,progressType:be,progressValue:Se,history:[]}),jt=d?.dataset?.userSelected==="true",Ie=Oe({manualStatus:jt?Wt:null,paidAmount:Y.paidAmount,paidPercent:Y.paidPercent,totalAmount:et.totalWithTax}),Tt=jt?Wt:Ie;!jt&&d&&(d.value=Tt),d?.dataset&&delete d.dataset.userSelected;const xe=Fe({projectCode:t.projectCode,title:h,type:b,clientId:t.clientId,clientCompany:a,description:ve,start:Yt,end:kt||null,applyTax:J,paymentStatus:Tt,equipmentEstimate:Kt,expenses:E.expenses,discount:X,discountType:Qt,companyShareEnabled:Z&&J,companySharePercent:Z&&J?tt:null,companyShareAmount:et.companyShareAmount,taxAmount:et.taxAmount,totalWithTax:et.totalWithTax,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[],paidAmount:Y.paidAmount,paidPercentage:Y.paidPercent,paymentProgressType:Y.paymentProgressType,paymentProgressValue:Y.paymentProgressValue}),L=s.querySelector('button[type="submit"]');L&&(L.disabled=!0,L.dataset.originalText=L.textContent||"",L.textContent=m("projects.details.edit.saving","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...")),s.dataset.submitting="true";try{const _=await Me(dt,xe);await Je(dt,Tt),document.dispatchEvent(new CustomEvent("projects:changed")),C(m("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),B();const w=It(_)||dt;w&&Rt(w)}catch(_){console.error("âŒ [customerDetails] Failed to update project from customer modal",_);const w=typeof _?.message=="string"?_.message:m("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");C(w,"error")}finally{delete s.dataset.submitting,L&&(L.disabled=!1,L.dataset.originalText&&(L.textContent=L.dataset.originalText,delete L.dataset.originalText))}})}function la(t=[],e){const a=String(e);return t.find(n=>[n?.id,n?.projectId,n?.project_id].some(i=>i!=null&&String(i)===a))||null}function da(t){if(!t)return null;const e=t.projectId??t.project_id??t.projectID??null;return e!=null?String(e):null}ke();je();Te();Le();Pe();const mt=document.getElementById("logout-btn");mt&&!mt.dataset.listenerAttached&&(mt.addEventListener("click",()=>Ne()),mt.dataset.listenerAttached="true");$e({showReservationDetails:qe});const ua=new URLSearchParams(window.location.search),j=ua.get("id"),W=document.getElementById("customer-details"),te=document.getElementById("customer-hero-name"),ma=document.getElementById("customer-hero-phone"),pa=document.getElementById("customer-hero-company"),fa=document.getElementById("customer-hero-email"),ya=document.getElementById("customer-hero-tax"),ee=document.getElementById("customer-hero-summary"),ae=document.getElementById("dashboard-greeting-customer-name"),ne=document.getElementById("dashboard-greeting-customer-company"),pt=document.getElementById("customer-stat-projects"),ft=document.getElementById("customer-stat-projects-desc"),yt=document.getElementById("customer-stat-payment"),gt=document.getElementById("customer-stat-payment-desc"),ht=document.getElementById("customer-stat-upcoming"),vt=document.getElementById("customer-stat-upcoming-desc"),at=document.getElementById("customer-stat-activity"),Dt=document.getElementById("customer-stat-activity-desc"),Et=document.getElementById("customer-stat-compliance"),nt=document.getElementById("customer-stat-compliance-desc"),se=document.getElementById("sidebar-stat-projects"),re=document.getElementById("sidebar-stat-reservations"),ie=document.getElementById("sidebar-stat-equipment"),oe=document.getElementById("sidebar-stat-technicians"),Ut=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),wt=Array.from(document.querySelectorAll("[data-customer-tab]")),ga=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),V=document.getElementById("edit-document-file"),Q=document.getElementById("edit-document-preview"),ce=document.getElementById("edit-document-file-name"),it=document.getElementById("edit-document-url"),ot=document.getElementById("edit-document-name");let P=null,F="idle",q=null;Ut.forEach(t=>{t.disabled=!0});let y=null,st=!1,H="",Vt="reservations";function R(t=""){const e=document.createElement("div");return e.textContent=t==null?"":String(t),e.innerHTML}function ha(t=""){const e=R(t).replace(/\r/g,""),a=`
`;return e.includes(a)?e.split(a).join("<br>"):e}function va(t=null){q=t&&typeof t=="object"?{...t}:null,P=null,F="idle",V&&(V.value=""),K()}function K(){if(!ce||!Q)return;const t=F==="uploading",e=!!P?.dataUrl;let a=m("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?a=m("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):F==="error"?a=m("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):e?a=P?.fileName||m("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):q&&(q.fileName||q.url)&&(a=q.fileName||q.url),ce.textContent=a;const n=e||!!q?.url;Q.disabled=t||!n}function Da(){if(!V)return;const[t]=V.files||[];if(!t){F="idle",P=null,K();return}F="uploading",K();const e=new FileReader;e.onload=()=>{if(typeof e.result!="string"){F="error",P=null,K();return}P={dataUrl:e.result,fileName:t.name,mimeType:t.type,size:t.size},it&&(it.value=e.result),ot&&(ot.value=t.name),F="success",K()},e.onerror=()=>{F="error",P=null,K()},e.readAsDataURL(t)}V&&!V.dataset.listenerAttached&&(V.addEventListener("change",Da),V.dataset.listenerAttached="true");Q&&!Q.dataset.listenerAttached&&(Q.addEventListener("click",()=>{if(F==="uploading")return;const t=P?.dataUrl||q?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),Q.dataset.listenerAttached="true");function bt(t,e,a,{hideWhenEmpty:n=!1}={}){if(!t)return;const s=a==null?"":String(a).trim(),i=s.length>0,c=i?s:"â€”";t.textContent=`${e} ${c}`,n?t.classList.toggle("hidden",!i):t.classList.remove("hidden")}function Ft(t){const e=m("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),a=t?.customerName||"â€”",n=t?.phone?I(t.phone):"",s=t?.companyName||"",i=t?.email||"",c=t?.tax_id??t?.taxId??"";if(te&&(te.textContent=a),ee&&(ee.textContent=a!=="â€”"?a:e),bt(ma,"ğŸ“",n,{hideWhenEmpty:!1}),bt(pa,"ğŸ¢",s,{hideWhenEmpty:!0}),bt(fa,"ğŸ“§",i,{hideWhenEmpty:!0}),bt(ya,"ğŸ§¾",c,{hideWhenEmpty:!0}),ae&&(ae.textContent=a),ne){const v=[];s&&v.push(s),n&&v.push(`ğŸ“ ${n}`);const p=typeof c=="string"?c.trim():String(c||"").trim();p&&v.push(`ğŸ§¾ ${p}`),ne.textContent=v.length?v.join(" â€¢ "):"â€”"}}function Ea(t){if(t?.preventDefault?.(),!y)return;Ba();const e=document.getElementById("editCustomerModal"),a=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!a)return;(a.getInstance(e)||new a(e)).show()}function ba(){Ut.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Ea),t.dataset.listenerAttached="true")})}function Mt(t){Ut.forEach(e=>{e&&(e.disabled=!!t)})}ba();function $t(t){t&&(Vt=t,wt.forEach(e=>{const a=e?.getAttribute("data-customer-tab")===t;e&&(e.classList.toggle("tab-active",a),e.classList.toggle("active",a),e.setAttribute("aria-selected",String(a)))}),ga.forEach((e,a)=>{e&&e.classList.toggle("hidden",a!==t)}),t==="projects"&&j&&y&&lt(j))}function Sa(){wt.length&&(wt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-customer-tab");e&&$t(e)}),t.dataset.listenerAttached="true")}),$t(Vt))}Sa();function ye(t={}){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(A=>A&&typeof A=="object"),a=A=>{for(const r of A)if(typeof r=="string"&&r.trim()!=="")return r.trim();return""},n=A=>{for(const r of A){if(typeof r=="number"&&Number.isFinite(r))return Math.max(0,Math.trunc(r));if(typeof r=="string"&&r.trim()!==""&&/^\d+$/.test(r.trim()))return Math.max(0,parseInt(r.trim(),10))}return null},s=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],i=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],c=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],v=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],p=[t.document_size,t.documentSize,t.size,e?.size,e?.length],f=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],d=a(s),g=a(c),u=a(v)||"application/octet-stream",D=a(i),S=a(f),T=n(p);if(!d&&!S)return null;let k=d,E=S;if(!k&&E&&E.startsWith("data:")){const A=E.indexOf(",");A!==-1&&(k=E,E=E.slice(A+1))}!k&&E&&(k=`${E.startsWith("data:")?"":`data:${u};base64,`}${E}`);const N={url:k,fileName:g,mimeType:u,path:D,data:E||null,size:T};return N.url&&/sirv\.com/i.test(N.url)&&(N.source="sirv"),N}function Ia(){return document.documentElement.getAttribute("lang")||"ar"}function M(t){const e=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(e)}catch{return String(e)}}function le(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=Ia()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(n,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),v=e.getFullYear();return`${i}/${c}/${v}`}}function de(t){if(!t)return"";const e=t.trim().split(/\s+/),a=e.pop()||"";return`<span class="currency-amount">${e.join(" ")}</span> <span class="currency-unit currency-unit--sm">${a}</span>`}function ue(t,e){const a=m("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),n=m("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${a}</span>
      ${de(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${n}</span>
      ${de(e)}
    </div>
  `}const me={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},xa={reservation:"Reservation",project:"Project",customer:"Client record"};function Bt(t=[]){let e=null;return t.forEach(a=>{if(!a)return;const n=a instanceof Date?a:new Date(a);Number.isNaN(n.getTime())||(!e||n>e)&&(e=n)}),e}function Aa(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function pe({projects:t=0,reservations:e=0,equipment:a=0,technicians:n=0}={}){se&&(se.textContent=M(t)),re&&(re.textContent=M(e)),ie&&(ie.textContent=M(a)),oe&&(oe.textContent=M(n))}function z(){if(!y||!j){const r=Nt(0);if(pt&&(pt.textContent="0"),ft&&(ft.textContent=m("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),yt&&(yt.innerHTML=ue(r,r)),gt){const o=m("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),l=m("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");gt.textContent=`${o} â€¢ ${l}`}ht&&(ht.textContent="0"),vt&&(vt.textContent=m("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),at&&(at.textContent="â€”"),Dt&&(Dt.textContent=m("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Et&&(Et.textContent="0%"),nt&&(nt.textContent=m("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),pe({projects:0,reservations:0,equipment:0,technicians:0});return}const t=O(),a=(Array.isArray(t.reservations)?t.reservations:[]).filter(r=>r?[r.customerId,r.customer_id,r.customer?.id].some(l=>l!=null&&String(l)===String(j)):!1),n=a.length,s=Date.now(),i=a.filter(r=>{const o=r?.start??r?.startDatetime??r?.start_datetime??r?.start_date;if(!o)return!1;const l=new Date(o);return Number.isNaN(l.getTime())?!1:l.getTime()>=s}),c=i.map(r=>r?.start??r?.startDatetime??r?.start_datetime).map(r=>new Date(r)).filter(r=>!Number.isNaN(r.getTime())).sort((r,o)=>r-o)[0]||null,p=(Array.isArray(t.projects)?t.projects:[]).filter(r=>r?[r.clientId,r.client_id,r.customer_id].some(l=>l!=null&&String(l)===String(j)):!1),f=p.length,d=p.reduce((r,o)=>{if(!o)return r;const l=Ze(o)||{},h=Number(l.totalWithTax??l.subtotal??0)||0;return String(o?.paymentStatus??o?.status??"").toLowerCase()==="paid"?(r.paid+=h,r.paidCount+=1):r.outstanding+=h,r},{paid:0,outstanding:0,paidCount:0}),g=f>0?Math.round(d.paidCount/f*100):0,u=[];if(a.forEach(r=>{const o=Bt([r?.updatedAt,r?.updated_at,r?.end,r?.endDatetime,r?.end_datetime,r?.start,r?.startDatetime,r?.start_datetime,r?.createdAt,r?.created_at]);o&&u.push({date:o,type:"reservation"})}),p.forEach(r=>{const o=Bt([r?.updatedAt,r?.updated_at,r?.end,r?.end_datetime,r?.start,r?.start_datetime,r?.createdAt,r?.created_at]);o&&u.push({date:o,type:"project"})}),!u.length){const r=Bt([y?.updated_at,y?.updatedAt,y?.created_at,y?.createdAt]);r&&u.push({date:r,type:"customer"})}const D=u.reduce((r,o)=>r?o.date>r.date?o:r:o,null),S=D?.date??null,T=D?.type??null,k=a.reduce((r,o)=>Array.isArray(o?.items)?r+o.items.length:r,0),E=new Set;a.forEach(r=>{Array.isArray(r?.technicians)&&r.technicians.forEach(o=>{const l=o!=null?String(o):"";l&&E.add(l)}),Array.isArray(r?.techniciansDetails)&&r.techniciansDetails.forEach(o=>{const l=o?.id??o?.technician_id??o?.technicianId;l!=null&&E.add(String(l))})}),pt&&(pt.textContent=M(f)),ft&&(ft.textContent=f>0?m("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):m("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const N=Nt(d.paid),A=Nt(d.outstanding);if(yt&&(yt.innerHTML=ue(N,A)),gt){const r=m("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),o=d.outstanding>0?m("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",A):m("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");gt.textContent=`${r} â€¢ ${o}`}if(ht&&(ht.textContent=M(i.length)),vt&&(vt.textContent=i.length>0&&c?m("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",le(c)):m("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),at)if(T){const r=m(`customerDetails.stats.activityType.${T}`,xa[T]||T);at.textContent=r}else at.textContent="â€”";if(Dt&&(Dt.textContent=S?m("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",le(S)):m("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Et&&(Et.textContent=`${M(g)}%`),nt)if(f>0){const r=g>=90?"excellent":g>=70?"good":g>=40?"average":"poor",o=r?m(`customerDetails.stats.complianceLabel.${r}`,me[r]||me.poor):"",l=m("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",M(d.paidCount)).replace("{total}",M(f));nt.textContent=o?`${o} â€¢ ${l}`:l}else nt.textContent=m("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");pe({projects:f,reservations:n,equipment:k,technicians:E.size})}function ka(t){const{customers:e}=O();if(!Array.isArray(e))return null;const a=e.find(c=>String(c.id)===String(t));if(!a)return null;const n=a.tax_id??a.taxId??"",s=typeof n=="string"?n.trim():String(n||"").trim(),i=a.document??ye(a);return{...a,tax_id:s,taxId:s,document:i}}function ja(t={}){if(!t||typeof t!="object")return null;const e=t.id??t.customerId??t.customer_id??null,a=t.full_name??t.customerName??t.name??"",n=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",s=typeof n=="string"?n.trim():String(n||"").trim(),i=ye(t);return e==null?null:{id:String(e),customerName:a,full_name:a,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:s,taxId:s,document:i,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Ta(t){if(!t)return;const e=O(),a=Array.isArray(e.customers)?[...e.customers]:[],n=a.findIndex(s=>String(s.id)===String(t.id));n>=0?a[n]={...a[n],...t}:a.push(t),ct({customers:a})}async function Pa(){const{technicians:t}=O();if(!(Array.isArray(t)&&t.length>0))try{const e=await xt("/technicians/"),a=Array.isArray(e?.data)?e.data.map(We):[];a.length>0&&ct({technicians:a})}catch(e){console.warn("âš ï¸ Failed to load technicians list",e)}}async function Na(t){if(t)try{const e=new URLSearchParams({customer_id:String(t),limit:"200"}),a=await xt(`/reservations/?${e.toString()}`),n=Array.isArray(a?.data)?a.data.map(Ye):[];ct({reservations:n})}catch(e){console.warn("âš ï¸ Failed to load customer reservations",e)}}async function Ca(t){if(t)try{const e=new URLSearchParams({client_id:String(t),limit:"200"}),a=await xt(`/projects/?${e.toString()}`),n=Array.isArray(a?.data)?a.data.map(He):[];ct({projects:n})}catch(e){console.warn("âš ï¸ Failed to load customer projects",e)}}async function La(t,{showSpinner:e=!1}={}){if(t){e?(st=!0,H="",U()):(st=!0,H="");try{const a=await xt(`/customers/?id=${encodeURIComponent(t)}`),n=a?.data??a,s=ja(n);if(!s)throw new Error("Invalid customer payload received from server");y=s,Ta(s),st=!1,H="",U(),await Pa(),await Promise.all([Na(s.id),Ca(s.id)]),At(s.id),lt(s.id),z()}catch(a){if(st=!1,a instanceof Ce&&a.status===404){y=null,H="",U();return}console.error("âš ï¸ Failed to load customer details",a);const n=m("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");y?(H="",C(n),U()):(H=`${n}${a?.message?` (${a.message})`:""}`,U())}}}function U(){if(!W)return;if($t(Vt),!y){if(Ft(null),Mt(!0),z(),st){W.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(H){W.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${R(H)}</div>
        </div>
      `;return}const a=m("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");W.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${R(a)}</div>
      </div>
    `;return}Ft(y),Mt(!1);const e=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:y.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:y.phone?I(y.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:y.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:y.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:y.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:y.tax_id??y.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:y.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:y.document??null,type:"document"}].map(a=>{const n=m(a.key,a.fallback);if(a.type==="document"){const p=a.value;let f='<span class="text-base-content/50">â€”</span>';if(p&&typeof p=="object"){const d=p.fileName?.trim()||p.path?.trim()||p.url||"";if(p.url){const g=R(d||m("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),u=Aa(p.url),D=R(m("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));f=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${g}</span><a class="btn btn-outline btn-sm" href="${u}" target="_blank" rel="noopener noreferrer">${D}</a></div>`}else d&&(f=`<span class="text-base-content break-all">${R(d)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${R(n)}</span>
          <div class="mt-2">${f}</div>
        </article>
      `}const i=(a.value==null?"":String(a.value)).trim(),c=i.length>0?i:"â€”",v=a.multiline?ha(c):R(c);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${R(n)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${v}</p>
      </article>
    `}).join("");W.innerHTML=e,z()}function Ba(){document.getElementById("edit-id").value=y?.id||"",document.getElementById("edit-name").value=y?.customerName||"",document.getElementById("edit-phone").value=I(y?.phone||""),document.getElementById("edit-company").value=y?.companyName||"",document.getElementById("edit-email").value=y?.email||"",document.getElementById("edit-address").value=y?.address||"",document.getElementById("edit-tax-id").value=I(y?.tax_id??y?.taxId??"");const t=y?.document??null;it&&(it.value=t?.url||""),ot&&(ot.value=t?.fileName||""),va(t),document.getElementById("edit-notes").value=y?.notes||""}const St=document.getElementById("save-edit-btn");St&&!St.dataset.listenerAttached&&(St.addEventListener("click",()=>{if(!y)return;const t=document.getElementById("edit-id").value,e=document.getElementById("edit-name").value.trim(),a=I(document.getElementById("edit-phone").value.trim()),n=document.getElementById("edit-company").value.trim(),s=document.getElementById("edit-email").value.trim(),i=document.getElementById("edit-address").value.trim(),c=I(document.getElementById("edit-tax-id").value.trim()),v=(it?.value||"").trim(),p=(ot?.value||"").trim(),f=document.getElementById("edit-notes").value.trim();if(!e||!a){C(m("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const d=O(),g=Array.isArray(d.customers)?d.customers:[],u=g.findIndex(k=>String(k.id)===String(t));if(u===-1){C(m("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const D=g[u]?.document??null;let S=D;P?.dataUrl?S={...D||{},url:P.dataUrl,fileName:p||P.fileName||D?.fileName||"",mimeType:P.mimeType||D?.mimeType,size:P.size??D?.size}:v?S={...D||{},url:v,fileName:p||D?.fileName||""}:p&&D?S={...D,fileName:p}:!v&&!p&&(S=D),g[u]={...g[u],customerName:e,phone:a,companyName:n,email:s,address:i,notes:f,tax_id:c,taxId:c,document:S},ct({customers:g}),y=g[u],U(),At(j),lt(j),z(),document.dispatchEvent(new CustomEvent("customers:changed")),C(m("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),St.dataset.listenerAttached="true");async function _a(){if(W){if(!j){Ft(null),Mt(!0),z(),W.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${m("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}y=ka(j),y&&(U(),At(j),lt(j),z()),await La(j,{showSpinner:!y})}}_a();const ge=()=>{!j||!y||z()};document.addEventListener("reservations:changed",ge);document.addEventListener("projects:changed",ge);document.addEventListener("language:changed",()=>{U(),j&&y&&(At(j),lt(j),z())});
