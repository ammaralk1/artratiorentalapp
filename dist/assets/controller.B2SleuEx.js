import{d as te,n as S,t as c,j as h,b as Le,z as Ca,y as xt,v as ja,w as xa,u as Ta}from"./auth.DPPwhYNj.js";import{g as Ne,r as et,f as Kt,a as Na,i as xn,b as pn}from"./details.DixsuZMy.js";import{k as Tn,l as fn,n as ve,s as _a,o as Qt,D as Ue,p as Qe,q as dt,h as Nn,c as vt,e as ht,t as _n,v as Ra,w as Rn,x as Da,y as Fa,z as Dn,a as lt,d as Ma,A as Tt,B as Nt,C as Bt,E as gn,F as yn,g as Fn,G as Va,H as za,I as Ha,u as Ua,r as Oa,J as Ga,j as Wa}from"./reservationsService.DofAzaoX.js";import{l as Jt,o as Mn,p as Ka,q as Oe,u as Yt,v as ke,n as N,w as Vn,x as Xt,y as je,z as wt,A as bt,B as Qa,C as zn,D as Hn,E as Un,s as ot,F as On,G as Ge,b as Zt,H as Ja,I as Ya,J as Xa,K as Gn,L as Za,M as es,k as Wn,N as vn}from"./state.CdpE6Oc4.js";import{s as en,E as Kn,a as ts,c as ns,b as as,r as ss}from"./equipment.zTNo6P9R.js";import{g as rs,a as is}from"./reservationPdf.Cb15Lmam.js";import{o as os}from"./view.nMj7WoZi.js";import{d as cs,c as ds}from"./reservationsActions.DWCZd4m8.js";import{ensureProjectsLoaded as ls}from"./projectsService._9Q7aAR5.js";import{s as us}from"./uiBridge.BLZZT8b9.js";const ms="__DEBUG_CREW__";function ps(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(ms);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function hn(e,t){if(ps())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,t)}catch{}}const Qn="projects:create:draft",Jn="projects.html#projects-section";let _t=null,Yn=[],Rt=new Map,Dt=new Map,It=new Map,Ct=!1,ft=null,bn=!1,Xn=[];const tn="reservations:create:draft";function Pt(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}return null}function fs(){if(typeof document>"u"||!Pt())return null;try{const{input:t,hidden:n}=ut(),{input:a,hidden:r}=xe(),s=document.getElementById("res-start")?.value||"",o=document.getElementById("res-end")?.value||"",i=document.getElementById("res-start-time")?.value||"",m=document.getElementById("res-end-time")?.value||"",l=document.getElementById("res-notes")?.value||"",d=document.getElementById("res-discount")?.value||"",p=document.getElementById("res-discount-type")?.value||"percent",f=!!document.getElementById("res-tax")?.checked,g=!!document.getElementById("res-company-share")?.checked,y=g?Ke("res-company-share"):null,I=document.getElementById("res-payment-status")?.value||"unpaid",A=document.getElementById("res-payment-progress-type")?.value||"percent",b=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:o,startTime:i,endTime:m,customerId:n?.value||"",customerLabel:t?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:l,discount:String(d||""),discountType:p,taxEnabled:f,companyShareEnabled:g,companySharePercent:y,paymentStatus:I,paymentProgressType:A,paymentProgressValue:String(b||""),items:ke()||[],technicianIds:Fa()||[]}}catch{return null}}function gs(){const e=Pt();if(!e)return;const t=fs();if(t)try{e.setItem(tn,JSON.stringify(t))}catch(n){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",n)}}function Zn(){const e=Pt();if(e)try{e.removeItem(tn)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function ys(){const e=Pt();if(!e)return;let t=null;try{const n=e.getItem(tn);t=n?JSON.parse(n):null}catch(n){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",n);return}if(t)try{if(t.startDate||t.startTime){const s=Oe(t.startDate||"",t.startTime||"");Ze("res-start","res-start-time",s)}if(t.endDate||t.endTime){const s=Oe(t.endDate||"",t.endTime||"");Ze("res-end","res-end-time",s)}if(t.customerId)Se({selectedValue:String(t.customerId)});else if(t.customerLabel){Se({selectedValue:"",resetInput:!0});const{input:s,hidden:o}=ut();s&&(s.value=t.customerLabel),o&&(o.value="")}if(t.projectId)_e({selectedValue:String(t.projectId)});else if(t.projectLabel){_e({selectedValue:"",resetInput:!0});const{input:s,hidden:o}=xe();s&&(s.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const n=document.getElementById("res-tax");n&&(n.checked=!!t.taxEnabled);const a=document.getElementById("res-company-share");a&&(a.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(a.dataset.companyShare=String(t.companySharePercent)));const r=document.getElementById("res-payment-status");if(r&&(r.value=t.paymentStatus||r.value||"unpaid",fe(r,r.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(Yt(t.items),$e()),Array.isArray(t.technicianIds)&&t.technicianIds.length)try{_a(t.technicianIds)}catch{}Ce(),H()}catch(n){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",n)}}function vs(e){if(!e)return null;let t=Xn.find(a=>a.id===e)||null;if(t)return t;const n=Ja(e);return n?(t={id:e,name:Xa(n)||e,price:Ya(n),items:Zt(n),raw:n},t):null}function St(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Et(e){return S(String(e||"")).trim().toLowerCase()}function hs(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=S(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function ea(e){const t=S(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function ta(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function na(e){if(!e)return null;const t=S(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function aa(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=S(String(t))}}function We(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function ut(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function xe(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function ye(){const{input:e,hidden:t}=xe();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function He(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&n.add(s)}const r=s=>{t()&&h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};n.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(o=>{s.addEventListener(o,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function sa(e,t,{allowPartial:n=!1}={}){const a=ve(t);if(!a)return null;const r=e.get(a);if(r)return r;if(!n)return null;const s=[];return e.forEach((o,i)=>{i.includes(a)&&s.push(o)}),s.length===1?s[0]:null}function Ft(e,t={}){return sa(Rt,e,t)}function Mt(e,t={}){return sa(Dt,e,t)}function fe(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function ra(e){Yn=Array.isArray(e)?[...e]:[]}function nn(){return Yn}function an(e){return e&&nn().find(t=>String(t.id)===String(e))||null}function In(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function Ke(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??Ue,a=S(String(n).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:Ue}function Ee(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??Ue,a=S(String(n).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=Ue),t.dataset.companyShare=String(r),t.checked=!0}function Vt(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(Ct){H();return}Ct=!0;const a=()=>{Ct=!1,H()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(Ue)),t.disabled){n.checked=!1,h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}t.checked||(t.checked=!0),Ee()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Ee():n.checked&&(n.checked=!1));a()}function bs(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function Sn(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${r}`}return""}function En(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function Se({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:r}=ut();if(!n||!a||!r)return;const s=Jt()||[],o=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),i=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");n.setAttribute("placeholder",o);const m=new Set;Rt=new Map;const l=s.filter(u=>u&&u.id!=null).map(u=>({id:String(u.id),label:En(u)||i})).filter(u=>{if(!u.label)return!1;const g=ve(u.label);return!g||m.has(g)?!1:(m.add(g),Rt.set(g,u),!0)}).sort((u,g)=>u.label.localeCompare(g.label,void 0,{sensitivity:"base"}));r.innerHTML=l.map(u=>`<option value="${St(u.label)}"></option>`).join("");const d=t?"":n.value,p=e?String(e):a.value?String(a.value):"",f=p?s.find(u=>String(u.id)===p):null;if(f){const u=En(f)||i;a.value=String(f.id),n.value=u,n.dataset.selectedId=String(f.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":d}function _e({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:r,list:s}=xe();if(!a||!r||!s)return;const o=Array.isArray(t)?t:nn()||[],i=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",i);const m=[...o].filter(y=>y&&y.id!=null).sort((y,I)=>String(I.createdAt||I.start||"").localeCompare(String(y.createdAt||y.start||""))),l=n?"":a.value,d=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),p=new Set;Dt=new Map;const f=m.map(y=>{const I=In(y)||d;return{id:String(y.id),label:I}}).filter(y=>{if(!y.label)return!1;const I=ve(y.label);return!I||p.has(I)?!1:(p.add(I),Dt.set(I,y),!0)});s.innerHTML=f.map(y=>`<option value="${St(y.label)}"></option>`).join("");const u=e?String(e):r.value?String(r.value):"",g=u?m.find(y=>String(y.id)===u):null;if(g){const y=In(g)||d;r.value=String(g.id),a.value=y,a.dataset.selectedId=String(g.id)}else r.value="",a.dataset.selectedId="",a.value=n?"":l}function Ze(e,t,n){const{date:a,time:r}=On(n),s=document.getElementById(e),o=document.getElementById(t);if(s){if(a)if(s._flatpickr){const i=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,i)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(o){if(r)if(o._flatpickr){const i=o._flatpickr.config?.dateFormat||"H:i";o._flatpickr.setDate(r,!1,i)}else o.value=r;else o._flatpickr?o._flatpickr.clear():o.value="";o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}}function ia(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||_e({selectedValue:a});const s=(Jt()||[]).find(d=>String(d.id)===String(e.clientId)),o=s?.id!=null?String(s.id):"";Se(o?{selectedValue:o}:{selectedValue:"",resetInput:!0});const i=Sn(e,"start"),m=Sn(e,"end");i&&Ze("res-start","res-start-time",i),m&&Ze("res-end","res-end-time",m);const l=document.getElementById("res-notes");l&&e.description&&(t||!l.value)&&(l.value=e.description),H(),Ce()}function oa({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:te(),r=Array.isArray(a)?a:[];ra(r);const s=t!=null?String(t):n.value?String(n.value):"";_e({selectedValue:s,projectsList:r}),Ce(),H()}function Ce(){const{input:e,hidden:t}=xe(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),o=document.getElementById("res-payment-progress-value"),i=document.getElementById("res-discount"),m=document.getElementById("res-discount-type"),l=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),p=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(He(n,ye),a&&He(a,ye)),r&&He(r,ye),s&&He(s,ye),o&&He(o,ye),i&&He(i,ye),m&&He(m,ye),p)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=l),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=l),r&&(r.value="unpaid",fe(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=l),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=l),o&&(o.value="",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=l),i&&(i.value="0",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=l),m&&(m.value="percent",m.disabled=!0,m.classList.add("reservation-input-disabled"),m.title=l);else{if(n){const f=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",f&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),m&&(m.disabled=!1,m.classList.remove("reservation-input-disabled"),m.title="")}Vt("tax"),H()}function sn(){const{input:e,hidden:t}=xe();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const r=e.value.trim(),s=r?Mt(r,{allowPartial:a}):null;if(s){t.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const o=an(s.id);o?ia(o,{skipProjectSelectUpdate:!0}):(Ce(),H())}else t.value="",e.dataset.selectedId="",Ce(),H()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Mt(a):null;r?(t.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function rn(){const{input:e,hidden:t}=ut();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const r=e.value.trim(),s=r?Ft(r,{allowPartial:a}):null;s?(t.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(t.value="",e.dataset.selectedId=""),H()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Ft(a):null;r?(t.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Is(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){rt({clearValue:!0});return}let n=null;try{const l=decodeURIComponent(t);n=JSON.parse(l)}catch(l){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",l)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),rt({clearValue:!1}),!n)return;n.fromProjectForm&&(ft={draftStorageKey:n.draftStorageKey||Qn,returnUrl:n.returnUrl||Jn});const s=document.getElementById("res-project");if(n.projectId){s&&(_e({selectedValue:String(n.projectId)}),Ce());const l=an(n.projectId);l?ia(l,{forceNotes:!!n.forceNotes}):H(),rt()}else{s&&_e({selectedValue:""});const l=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");Ns(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),l)}n.start&&Ze("res-start","res-start-time",n.start),n.end&&Ze("res-end","res-end-time",n.end);const o=document.getElementById("res-customer-input"),i=document.getElementById("res-customer");if(n.customerId){const d=(Jt()||[]).find(p=>String(p.id)===String(n.customerId));d?.id!=null&&(Se({selectedValue:String(d.id)}),i&&(i.value=String(d.id)),o&&(o.value=d.customerName||d.name||o.value))}else n.customerName&&o?(Se({selectedValue:""}),o.value=n.customerName,o.dataset.selectedId="",i&&(i.value="")):Se({selectedValue:""});const m=document.getElementById("res-notes");m&&n.description&&!m.value&&(m.value=n.description),H()}function Je(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Oe(e,n),end:Oe(t,a)}}function ca(e){const t=Et(e);if(t){const i=It.get(t);if(i)return i}const{description:n,barcode:a}=ea(e);if(a){const i=Kt(a);if(i)return i}const r=ve(n||e);if(!r)return null;let s=Vn();if(!s?.length){const i=te();s=Array.isArray(i?.equipment)?i.equipment:[],s.length&&Gn(s)}const o=s.find(i=>ve(i?.desc||i?.description||"")===r);return o||s.find(i=>ve(i?.desc||i?.description||"").includes(r))||null}function da(e,t="equipment-description-options"){const n=Et(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(m=>Et(m.value)===n)||It.has(n))return!0;const{description:r}=ea(e);if(!r)return!1;const s=ve(r);return s?(Vn()||[]).some(i=>ve(i?.desc||i?.description||"")===s):!1}const Ss={available:0,reserved:1,maintenance:2,retired:3};function Es(e){return Ss[e]??5}function kn(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function ks(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(n==="available")return`${t} â€” ${kn(n)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${t} â€” ${a} (${kn(n)})`}function Re(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=en(),a=te(),r=Array.isArray(n)&&n.length?n:a?.equipment||[],s=Array.isArray(r)?r:[];Gn(s);const o=new Map;s.forEach(l=>{const d=hs(l),p=Et(d);if(!p||!d)return;const f=Ne(l),u=Es(f),g=o.get(p);if(!g){o.set(p,{normalized:p,value:d,bestItem:l,bestStatus:f,bestPriority:u,statuses:new Set([f])});return}g.statuses.add(f),u<g.bestPriority&&(g.bestItem=l,g.bestStatus=f,g.bestPriority=u,g.value=d)}),It=new Map;const m=Array.from(o.values()).sort((l,d)=>l.value.localeCompare(d.value,"ar",{sensitivity:"base"})).map(l=>{It.set(l.normalized,l.bestItem);const d=ks(l),p=St(l.value);if(d===l.value)return`<option value="${p}"></option>`;const f=St(d);return`<option value="${p}" label="${f}"></option>`}).join("");e&&(e.innerHTML=m),t&&(t.innerHTML=m)}function la(e,t,n={}){const{silent:a=!1}=n,r=N(e);if(!r)return{success:!1,message:null};const{start:s,end:o}=Je();if(!s||!o){const g=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||h(g),{success:!1,message:g}}const i=ke();if(on(i).has(r)){const g=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||h(g),{success:!1,message:g}}const l=Xt(r,s,o);if(l.length){const g=l.map(I=>I.name).join(", "),y=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${g}`);return a||h(y),{success:!1,message:y}}if(je(r,s,o)){const g=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const y=new URLSearchParams({type:"equipment",id:r,start:s,end:o});Le(`/reservations/availability.php?${y.toString()}`).then(I=>{const A=Array.isArray(I?.conflicts)?I.conflicts:[],b=Array.from(new Set(A.map(v=>v?.reservation_code||(v?.reservation_id!=null?`#${v.reservation_id}`:null)).filter(Boolean))),E=b.length?`${g}: ${b.join("ØŒ ")}`:g;h(E)}).catch(()=>h(g))}catch{h(g)}return{success:!1,message:g}}const d=Kt(r);if(!d){const g=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||h(g),{success:!1,message:g}}const p=Ne(d);if(p==="maintenance"||p==="retired"){const g=We(p);return a||h(g),{success:!1,message:g}}const f=Qe(d);if(!f){const g=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||h(g),{success:!1,message:g}}wt({id:f,equipmentId:f,barcode:r,desc:d.desc,qty:1,price:d.price,image:et(d)}),t&&(t.value=""),$e(),H();const u=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||h(u),{success:!0,message:u,barcode:r}}function zt(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=ca(t);if(!n){h(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Na(n.barcode),r=Ne(a||n);if(r==="maintenance"||r==="retired"){h(We(r));return}const s=N(n.barcode);if(!s){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o=Qe(n);if(!o){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i={id:o,equipmentId:o,barcode:s,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,image:et(n)},{start:m,end:l}=Je();if(!m||!l){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const d=ke();if(on(d).has(s)){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const f=Xt(s,m,l);if(f.length){const u=f.map(g=>g.name).join(", ");h(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${u}`));return}if(je(s,m,l)){const u=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const g=new URLSearchParams({type:"equipment",id:s,start:m,end:l});Le(`/reservations/availability.php?${g.toString()}`).then(y=>{const I=Array.isArray(y?.conflicts)?y.conflicts:[],A=Array.from(new Set(I.map(E=>E?.reservation_code||(E?.reservation_id!=null?`#${E.reservation_id}`:null)).filter(Boolean))),b=A.length?`${u}: ${A.join("ØŒ ")}`:u;h(b)}).catch(()=>h(u))}catch{h(u)}return}wt(i),$e(),H(),h(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function As(){Re();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),zt(e))});const t=()=>{da(e.value,"equipment-description-options")&&zt(e)};e.addEventListener("focus",()=>{if(Re(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function An(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function on(e=ke()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=N(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(r=>{const s=N(r?.normalizedBarcode??r?.barcode);s&&t.add(s)})}),t}function Bs(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=Je();if(!t||!n){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}ts({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):h(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(Kn.change,t=>{An(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),An(e,as()))}function ws(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],r=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,s=a.length?a:t.barcode?[t.barcode]:[];if(!s.length)return;let o=0,i=null;const m=[],l=new Set;s.forEach(p=>{const f=N(p);f&&!l.has(f)&&(l.add(f),m.push(f))});const d=Math.min(r,m.length);for(let p=0;p<d;p+=1){const f=m[p],u=la(f,null,{silent:!0});u.success&&(o+=1),u.message&&(i=u.message)}if(o>0){const f=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",S(String(o)));h(f)}else i&&h(i)}function ua(){Bs(),!(bn||typeof document>"u")&&(document.addEventListener(Kn.requestAdd,ws),bn=!0)}function mt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:r,packageAddButton:s}}function Ht(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:r}=mt();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),o=document.getElementById("equipment-description"),i=t==="package";s&&(s.disabled=i),o&&(o.disabled=i),r&&(r.disabled=t!=="package"||r.options.length===0),Za(t),t==="package"&&Lt()}function Lt(){const{packageSelect:e,packageHint:t}=mt();if(!e)return;const n=Mn();Xn=n,Ka(n.map(i=>i.raw??i));const a=c("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=n.map(i=>{const m=Number.isFinite(Number(i.price))?Number(i.price):0,l=S(m.toFixed(2)),d=`${i.name} â€” ${l} ${a}`;return`<option value="${i.id}">${d}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const o=n.length>0;e.disabled=!o,t&&(o?(t.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),fa()}function Ps(e,t){const n=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${n} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=t.map(({item:s,blockingPackages:o})=>{const i=s?.desc||S(String(s?.barcode??s?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(o)&&o.length){const m=o.map(l=>l.name).join(", ");return`â€¢ ${i} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${m})`}return`â€¢ ${i} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function ma(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:r=null}={}){const s=Ge(e);if(!s)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const o=vs(s);if(!o)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(t.some(u=>u?.type==="package"&&Ge(u.packageId)===s))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(zn(s,n,a,r)){const u=o.name||s;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${u} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const i=Array.isArray(o.items)&&o.items.length?o.items:Zt(o.raw??{}),m=on(t),l=[],d=new Set;if(i.forEach(u=>{const g=N(u?.normalizedBarcode??u?.barcode);if(g){if(d.has(g)){l.push({item:u,type:"internal"});return}d.add(g),m.has(g)&&l.push({item:u,type:"external"})}}),l.length){const u=l.map(({item:y})=>y?.desc||y?.description||y?.name||y?.barcode||y?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(y=>S(String(y))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:l.some(y=>y.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",u):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",u),duplicates:l}}const p=[];return i.forEach(u=>{const g=N(u?.normalizedBarcode??u?.barcode);if(g&&je(g,n,a,r)){const y=Xt(g,n,a,r);p.push({item:u,blockingPackages:y})}}),p.length?{success:!1,reason:"item_conflict",message:Ps(o,p),conflicts:p}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:o.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(o.price))?Number(o.price):0,barcode:o.code||o.raw?.package_code||`pkg-${s}`,packageItems:i.map(u=>({equipmentId:u?.equipmentId??null,barcode:u?.barcode??u?.normalizedBarcode??"",normalizedBarcode:N(u?.normalizedBarcode??u?.barcode),desc:u?.desc??"",qty:Number.isFinite(Number(u?.qty))?Number(u.qty):1,price:Number.isFinite(Number(u?.price))?Number(u.price):0})),image:i.find(u=>u?.image)?.image??null},packageInfo:o}}function pa(e,{silent:t=!1}={}){const n=Ge(e);if(!n)return t||h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=Je(),s=ke(),o=ma(n,{existingItems:s,start:a,end:r});if(!o.success){if(!t){const m={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[o.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");h(o.message||m)}return o}return wt(o.package),$e(),H(),t||h(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:o.package}}function fa(){const{packageSelect:e}=mt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;pa(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Ls(){const{packageAddButton:e,packageSelect:t}=mt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}pa(n)}),e.dataset.listenerAttached="true")}function ga(){const{modeRadios:e}=mt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&Ht(r.target.value)}),a.dataset.listenerAttached="true")}),Ls(),fa();const t=bt(),n=e.find(a=>a.value===t);n&&(n.checked=!0),Ht(t)}function $e(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=ke(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),o=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),m=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(n.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${a}</td></tr>`;return}const l=Qt(n);t.innerHTML=l.map(d=>{const p=d.items[0]||{},f=et(p)||d.image,u=f?`<img src="${f}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',g=S(String(d.count)),y=Number.isFinite(Number(d.unitPrice))?Number(d.unitPrice):0,I=Number.isFinite(Number(d.totalPrice))?Number(d.totalPrice):y*d.count,A=`${S(y.toFixed(2))} ${r}`,b=`${S(I.toFixed(2))} ${r}`,E=d.items.some(L=>L?.type==="package"),v=d.barcodes.map(L=>S(String(L||""))).filter(Boolean),P=v.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${v.map(L=>`<li>${L}</li>`).join("")}
            </ul>
          </details>`:"";let T="";if(E){const L=new Map;if(d.items.forEach(V=>{Array.isArray(V?.packageItems)&&V.packageItems.forEach(j=>{if(!j)return;const K=N(j.barcode||j.desc||Math.random()),q=L.get(K);if(q){q.qty+=Number.isFinite(Number(j.qty))?Number(j.qty):1;return}L.set(K,{desc:j.desc||j.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(j.qty))?Number(j.qty):1,barcode:j.barcode??j.normalizedBarcode??""})})}),L.size){const V=Array.from(L.values()).map(j=>{const K=S(String(j.qty)),q=j.desc||S(String(j.barcode||"")),z=j.barcode?` <span class="reservation-package-items__barcode">(${S(String(j.barcode))})</span>`:"";return`<li>${q}${z} Ã— ${K}</li>`}).join("");T=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${V}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${d.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${u}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${d.description||"-"}</div>
                ${E?`${T||""}${P||""}`:P}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${d.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${d.key}" aria-label="${i}" ${E?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${g}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${d.key}" aria-label="${o}" ${E?"disabled":""}>+</button>
            </div>
          </td>
          <td>${A}</td>
          <td>${b}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${d.key}" aria-label="${m}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function qs(e){const t=ke(),a=Qt(t).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(Qa(r),$e(),H())}function $s(e){const t=ke(),n=t.filter(a=>dt(a)!==e);n.length!==t.length&&(Yt(n),$e(),H())}function Cs(e){const t=ke(),a=Qt(t).find(p=>p.key===e);if(!a)return;const{start:r,end:s}=Je();if(!r||!s){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const o=new Set(t.map(p=>N(p.barcode))),{equipment:i=[]}=te(),m=(i||[]).find(p=>{const f=N(p?.barcode);return!f||o.has(f)||dt({desc:p?.desc||p?.description||p?.name||"",price:Number(p?.price)||0})!==e||!xn(p)?!1:!je(f,r,s)});if(!m){h(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const l=N(m.barcode),d=Qe(m);if(!d){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}wt({id:d,equipmentId:d,barcode:l,desc:m.desc||m.description||m.name||a.description||"",qty:1,price:Number.isFinite(Number(m.price))?Number(m.price):a.unitPrice,image:et(m)}),$e(),H()}function H(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(S(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),o=e?!1:s?.checked||!1,i=document.getElementById("res-payment-status"),m=i?.value||"unpaid",{start:l,end:d}=Je();o&&Ee();const p=Ke(),f=document.getElementById("res-payment-progress-type"),u=document.getElementById("res-payment-progress-value"),g=ta(f),y=na(u);Tn(),fn({selectedItems:ke(),discount:n,discountType:r,applyTax:o,paidStatus:m,paymentProgressType:g,paymentProgressValue:y,start:l,end:d,companySharePercent:p,paymentHistory:[]});const I=fn.lastResult;I?(aa(u,I.paymentProgressValue),i&&(i.value=I.paymentStatus,fe(i,I.paymentStatus))):fe(i,m);try{gs()}catch{}}function js(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",i=>{i.target.value=S(i.target.value),H()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",H),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(ye()){n.checked=!1,h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Vt("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(ye()){a.checked=!1,h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Vt("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(ye()){r.value="unpaid",fe(r,"unpaid"),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}fe(r),H()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",i=>{if(ye()){s.value="percent",h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",H()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const o=document.getElementById("res-payment-progress-value");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",i=>{if(ye()){o.value="",h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}i.target.value=S(i.target.value),H()}),o.dataset.listenerAttached="true"),H()}function xs(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;let n=!1;const a=()=>{const r=e.value?.trim();if(!r){H();return}const s=t.dataset.syncedWithStart;(!t.value?.trim()||s!=="false")&&(n=!0,t.value=r,t.dataset.syncedWithStart="true",t.dataset.syncedValue=r,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),H()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{n||(t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false")}),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Bn(){const{input:e,hidden:t}=ut(),{input:n,hidden:a}=xe(),{customers:r}=te();let s=t?.value?String(t.value):"";if(!s&&e?.value){const B=Ft(e.value,{allowPartial:!0});B&&(s=String(B.id),t&&(t.value=s),e.value=B.label,e.dataset.selectedId=s)}const o=r.find(B=>String(B.id)===s);if(!o){h(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const i=o.id;let m=a?.value?String(a.value):"";if(!m&&n?.value){const B=Mt(n.value,{allowPartial:!0});B&&(m=String(B.id),a&&(a.value=m),n.value=B.label,n.dataset.selectedId=m)}const l=document.getElementById("res-start").value,d=document.getElementById("res-end").value,p=document.getElementById("res-start-time")?.value||"00:00",f=document.getElementById("res-end-time")?.value||"00:00";if(!l||!d){h(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const u=`${l}T${p}`,g=`${d}T${f}`,y=new Date(u),I=new Date(g);if(Number.isNaN(y.getTime())||Number.isNaN(I.getTime())||y>=I){h(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const A=Tn();A.map(B=>B.technicianId).filter(Boolean);const b=ke();if(b.length===0&&A.length===0){h(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const E=document.getElementById("res-notes")?.value||"",v=parseFloat(S(document.getElementById("res-discount")?.value))||0,P=document.getElementById("res-discount-type")?.value||"percent",T=document.getElementById("res-payment-status"),L=T?.value||"unpaid",V=document.getElementById("res-payment-progress-type"),j=document.getElementById("res-payment-progress-value"),K=ta(V),q=na(j),z=m?an(m):null,U=bs(z);if(m&&!z){h(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const B of b){const R=Ne(B.barcode);if(R==="maintenance"||R==="retired"){h(We(R));return}}const w=[];for(const B of b){const R=N(B.barcode);if(je(R,u,g)){const J=B?.desc||B?.name||B?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");w.push({label:S(String(J)),barcode:R})}}if(w.length){const B=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let R=null;try{const Q=Array.from(new Set(w.map(X=>X.barcode).filter(Boolean))),le=new Map;await Promise.all(Q.map(async X=>{const ue=new URLSearchParams({type:"equipment",id:X,start:u,end:g}),me=await Le(`/reservations/availability.php?${ue.toString()}`),we=Array.isArray(me?.conflicts)?me.conflicts:[],Te=Array.from(new Set(we.map(k=>k?.reservation_code||(k?.reservation_id!=null?`#${k.reservation_id}`:null)).filter(Boolean)));le.set(X,Te)})),R=w.map(({label:X,barcode:ue})=>{const me=le.get(ue)||[];return me.length?`${X} (${me.join("ØŒ ")})`:X}).join("ØŒ ")}catch{}const J=R||w.map(Q=>Q.label).filter(Boolean).map(String).join("ØŒ ");h(`${B}: ${J}`,"warning",6e3);return}const C=[];for(const B of b){if(B?.type!=="package")continue;const R=B.packageId??B.package_id??null;if(R&&zn(R,u,g)){const J=B.desc||B.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let Q=[];try{const le=new URLSearchParams({type:"package",id:String(R),start:u,end:g}),X=await Le(`/reservations/availability.php?${le.toString()}`),ue=Array.isArray(X?.conflicts)?X.conflicts:[];Q=Array.from(new Set(ue.map(me=>me?.reservation_code||(me?.reservation_id!=null?`#${me.reservation_id}`:null)).filter(Boolean)))}catch{}C.push({label:S(String(J)),codes:Q})}}if(C.length){const B=C.map(({label:J,codes:Q})=>Q&&Q.length?`${J} (${Q.join("ØŒ ")})`:J).join("ØŒ "),R=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");h(`${R}: ${B}`,"warning",6e3);return}const D=[];for(const B of A){if(!B?.technicianId||!Hn(B.technicianId,u,g))continue;const R=B?.technicianName||B?.positionLabel||String(B.technicianId);let J=[];try{J=Un(B.technicianId,u,g,null)}catch{}D.push({label:S(String(R)),codes:J})}if(D.length){const B=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),R=D.map(({label:J,codes:Q})=>Q&&Q.length?`${J} (${Q.join("ØŒ ")})`:J).join("ØŒ ");h(`${B}: ${R}`);return}const ne=document.getElementById("res-tax"),_=document.getElementById("res-company-share"),W=!!m;W?(ne&&(ne.checked=!1,ne.disabled=!0,ne.classList.add("disabled"),ne.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),_&&(_.checked=!1,_.disabled=!0,_.classList.add("disabled"),_.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),T&&(T.value="unpaid",T.disabled=!0,fe(T,"unpaid"),T.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),V&&(V.disabled=!0,V.classList.add("disabled")),j&&(j.value="",j.disabled=!0,j.classList.add("disabled"))):(ne&&(ne.disabled=!1,ne.classList.remove("disabled"),ne.title=""),_&&(_.disabled=!1,_.classList.remove("disabled"),_.title=""),T&&(T.disabled=!1,T.title=""),V&&(V.disabled=!1,V.classList.remove("disabled")),j&&(j.disabled=!1,j.classList.remove("disabled")));const O=W?!1:ne?.checked||!1,$=!!_?.checked;if(!W&&$!==O){h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let re=$?Ke():null;$&&(!Number.isFinite(re)||re<=0)&&(Ee(),re=Ke());const pe=$&&O&&Number.isFinite(re)&&re>0;O&&Ee();const ge=Nn(b,v,P,O,A,{start:u,end:g,companySharePercent:pe?re:0}),Ae=Ca(),ae=vt({totalAmount:ge,progressType:K,progressValue:q,history:[]});j&&aa(j,ae.paymentProgressValue);const Ye=[];ae.paymentProgressValue!=null&&ae.paymentProgressValue>0&&Ye.push({type:ae.paymentProgressType||K,value:ae.paymentProgressValue,amount:ae.paidAmount,percentage:ae.paidPercent,recordedAt:new Date().toISOString()});const Be=ht({manualStatus:L,paidAmount:ae.paidAmount,paidPercent:ae.paidPercent,totalAmount:ge});T&&(T.value=Be,fe(T,Be));const be=typeof z?.paymentStatus=="string"?z.paymentStatus.toLowerCase():null,Ve=be&&["paid","partial","unpaid"].includes(be)?be:"unpaid",ce=_n({reservationCode:Ae,customerId:i,start:u,end:g,status:U?"confirmed":"pending",title:null,location:null,notes:E,projectId:m||null,totalAmount:ge,discount:W?0:v,discountType:W?"percent":P,applyTax:O,paidStatus:W?Ve:Be,confirmed:U,items:b.map(B=>({...B,equipmentId:B.equipmentId??B.id})),crewAssignments:A,companySharePercent:W||!pe?null:re,companyShareEnabled:W?!1:pe,paidAmount:W?0:ae.paidAmount,paidPercentage:W?0:ae.paidPercent,paymentProgressType:W?null:ae.paymentProgressType,paymentProgressValue:W?null:ae.paymentProgressValue,paymentHistory:W?[]:Ye});try{hn("about to submit",{crewAssignments:A,techniciansPayload:ce?.technicians,payload:ce});const B=await Ra(ce);hn("server response",{reservation:B?.id??B?.reservationId??B?.reservation_code,technicians:B?.technicians,crewAssignments:B?.crewAssignments,techniciansDetails:B?.techniciansDetails}),en(),Re(),ot(),ya(),h(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const R=document.getElementById("sub-tab-trigger-my-reservations-tab");R&&typeof R.click=="function"&&setTimeout(()=>R.click(),0)}catch{}typeof _t=="function"&&_t({type:"created",reservation:B}),Ts(B)}catch(B){console.error("âŒ [reservations/createForm] Failed to create reservation",B);const R=Rn(B)?B.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");h(R,"error"),W&&(h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),rt({clearValue:!1}))}}function Ts(e){if(!ft)return;const{draftStorageKey:t=Qn,returnUrl:n=Jn}=ft,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(t),s=r?JSON.parse(r)||{}:{},o=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],i=String(a);o.includes(i)||o.push(i),s.linkedReservationIds=o,window.sessionStorage.setItem(t,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}ft=null,n&&(window.location.href=n)}function rt({clearValue:e=!1}={}){const{input:t,hidden:n}=xe();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,Ce())}function Ns(e,t=""){const{input:n,hidden:a}=xe();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),Ce())}function ya(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),Se({selectedValue:"",resetInput:!0}),document.getElementById("res-start").value="",document.getElementById("res-start-time").value="",document.getElementById("res-end").value="",document.getElementById("res-end-time").value="",document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),rt({clearValue:!1}),_e({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",fe(s,"unpaid"));const o=document.getElementById("res-payment-progress-type");o&&(o.value="percent");const i=document.getElementById("res-payment-progress-value");i&&(i.value=""),Da(),Yt([]),ns("form-reset"),$e(),Ce(),H(),Zn()}function _s(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:r}=n.dataset;if(a==="decrease-group"&&r){qs(r);return}if(a==="increase-group"&&r){Cs(r);return}if(a==="remove-group"&&r){$s(r);return}}),e.dataset.listenerAttached="true")}function Rs(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(bt()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(t),t=null,la(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||bt()!=="single")return;const{start:s,end:o}=Je();!s||!o||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function Ds(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await Bn()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async a=>{a.preventDefault(),await Bn()}),t.dataset.listenerAttached="true");const n=document.getElementById("clear-reservation-form-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",a=>{a.preventDefault(),ya();try{Zn()}catch{}h(c("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),n.dataset.listenerAttached="true")}function Lr({onAfterSubmit:e}={}){_t=typeof e=="function"?e:null;const{customers:t,projects:n}=te();es(t||[]),Se(),rn(),ra(n||[]),oa({projectsList:n}),sn(),Re(),Lt(),As(),ua(),ga(),xs(),js(),_s(),Rs(),Ds(),ys(),Is(),H(),$e()}function va(){Re(),Lt(),oa(),Se(),rn(),sn(),ua(),ga(),$e(),H()}if(typeof document<"u"){const e=()=>{Se(),_e({projectsList:nn()}),rn(),sn(),H()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Re()}),document.addEventListener("packages:changed",()=>{Lt(),bt()==="package"&&Ht("package")})}typeof window<"u"&&(window.getCompanySharePercent=Ke);function pt(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function Fs(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function Ms(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=Fs(n);if(a!==null)return a}return null}function wn(e,t=0){const n=Ms(e);if(n!=null)return n;const a=pt(e.createdAt??e.created_at);if(a!=null)return a;const r=pt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=pt(e.start);if(s!=null)return s;const o=pt(e.end);if(o!=null)return o;const i=Number(e.id??e.reservationId);return Number.isFinite(i)?i:Number.isFinite(t)?t:0}function Vs({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:r}){const s=e.map((b,E)=>({reservation:b,index:E})),o=t.searchTerm||"",i=t.searchReservationId||"",m=t.searchCustomerName||"",l=t.searchProjectId||"",d=t.startDate||"",p=t.endDate||"",f=t.status||"",u=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,g=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,y=d?new Date(`${d}T00:00:00`):null,I=p?new Date(`${p}T23:59:59`):null,A=s.filter(({reservation:b})=>{const E=n.get(String(b.customerId)),v=r?.get?.(String(b.projectId)),P=b.start?new Date(b.start):null,T=Dn(b),{effectiveConfirmed:L}=lt(b,v);if(u!=null&&String(b.customerId)!==String(u)||g!=null&&!(Array.isArray(b.technicians)?b.technicians.map(z=>String(z)):[]).includes(String(g))||f==="confirmed"&&!L||f==="pending"&&L||f==="completed"&&!T)return!1;if(f==="cancelled"){const q=String(b?.status||b?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(q))return!1}if(y&&P&&P<y||I&&P&&P>I)return!1;if(i){const q=[b.reservationId,b.id,b.reservation_id,b.reservationCode,b.reservation_code,b.code,b.reference,b.referenceNumber,b.reference_number],z=ve(q.filter(w=>w!=null&&w!=="").map(String).join(" ")).replace(/\s+/g,""),U=i.replace(/\s+/g,"");if(!z.includes(U))return!1}if(m&&!ve(E?.customerName||b.customerName||"").includes(m))return!1;if(l){const q=[b.projectId,b.project_id,b.projectID,v?.id,v?.projectCode,v?.project_code],z=ve(q.filter(w=>w!=null&&w!=="").map(String).join(" ")).replace(/\s+/g,""),U=l.replace(/\s+/g,"");if(!z.includes(U))return!1}if(!o)return!0;const V=b.items?.map?.(q=>`${q.barcode} ${q.desc}`).join(" ")||"",j=(b.technicians||[]).map(q=>a.get(String(q))?.name).filter(Boolean).join(" ");return ve([b.reservationId,E?.customerName||b.customerName,b.notes,V,j,v?.title].filter(Boolean).join(" ")).includes(o)});return A.sort((b,E)=>{const v=wn(b.reservation,b.index),P=wn(E.reservation,E.index);return v!==P?P-v:E.index-b.index}),A}function zs({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const r=c("reservations.create.summary.currency","SR"),s=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),o=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),i=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),m=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),l=c("reservations.list.crew.separator","ØŒ "),d=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),p=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),f=c("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ"),u=c("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),g=c("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),y=c("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),I=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),A=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),b=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),E={client:c("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:v,index:P})=>{const T=t.get(String(v.customerId)),L=v.projectId?a?.get?.(String(v.projectId)):null,V=Dn(v),j=v.items?.length||0,K=Array.isArray(v.crewAssignments)?v.crewAssignments:[],q=(v.technicians||[]).map(Y=>n.get(String(Y))).filter(Boolean),z=K.length?K.map(Y=>{const Pe=Y.positionLabel??Y.position_name??Y.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),at=Y.technicianName??n.get(String(Y.technicianId??""))?.name??null;return at?`${S(Pe)} (${S(at)})`:S(Pe)}):q.map(Y=>Y.name),U=z.length?z.join(l):"â€”",w=S(String(v.reservationId??"")),C=v.start?S(xt(v.start)):"-",D=v.end?S(xt(v.end)):"-",ne=v.discount??v.discountValue??v.discount_value??v.discountAmount??0,_=Number.parseFloat(S(String(ne))),W=Number.isFinite(_)?_:0,O=v.discountType??v.discount_type??v.discountMode??"percent",$=String(O).toLowerCase()==="amount"?"amount":"percent",re=!!(v.applyTax??v.apply_tax??v.taxApplied),pe=v.companySharePercent??v.company_share_percent??v.companyShare??v.company_share,ge=v.companyShareEnabled??v.company_share_enabled??v.companyShareApplied,Ae=Number.parseFloat(S(String(pe))),Ye=(ge===!0||Number.isFinite(Ae)&&Ae>0)&&Number.isFinite(Ae)?Ae:0;let Be=0;try{const Y=Ma({items:v.items||[],technicianIds:v.technicians||[],crewAssignments:Array.isArray(v.crewAssignments)?v.crewAssignments:[],discount:W,discountType:$,applyTax:re,start:v.start,end:v.end,companySharePercent:Ye,groupingSource:v}),Pe=Number(Y?.finalTotal||0);Be=Number.isFinite(Pe)?Number(Pe.toFixed(2)):0}catch{Be=0}const be=Number.parseFloat(S(String(v.cost??0)))||0,Ve=Be>0?Be:be,ce=v.paymentHistory||v.payment_history||[],B=vt({totalAmount:Ve,paidAmount:ce.length?0:v.paidAmount,paidPercent:ce.length?0:v.paidPercent,history:ce});let J=ht({manualStatus:null,paidAmount:B.paidAmount,paidPercent:B.paidPercent,totalAmount:Ve});if(L)try{const{totalWithTax:Y}=os(L)||{totalWithTax:0},Pe=L.paymentHistory||L.payments||[],at=vt({totalAmount:Y,paidAmount:Pe.length?0:L.paidAmount,paidPercent:Pe.length?0:L.paidPercent,history:Pe}),mn=ht({manualStatus:null,paidAmount:at.paidAmount,paidPercent:at.paidPercent,totalAmount:Y});mn&&(J=mn)}catch{}const Q=J==="paid",le=J==="partial",{effectiveConfirmed:X,projectLinked:ue}=lt(v,L),me=X?"status-confirmed":"status-pending",we=Q?"status-paid":le?"status-partial":"status-unpaid";let Te=`<span class="reservation-chip status-chip ${me}">${X?d:p}</span>`;const k=Q?u:le?y:g;let x=`<span class="reservation-chip status-chip ${we}">${k}</span>`,F=Q?" tile-paid":le?" tile-partial":" tile-unpaid";V&&(F+=" tile-completed");let M="";V&&(Te=`<span class="reservation-chip status-chip status-completed">${f}</span>`,x=`<span class="reservation-chip status-chip status-completed">${k}</span>`,M=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…Ù†ØªÙ‡ÙŠ").replace(/\"/g,"&quot;")}"`);let Z=!ue&&!X?`<button class="tile-confirm" data-reservation-index="${P}" data-action="confirm">${I}</button>`:"";const se=Z?`<div class="tile-actions">${Z}</div>`:"",ie=S(Ve.toFixed(2)),G=S(String(j)),de=v.notes?S(v.notes):i,ze=m.replace("{count}",G),ee=v.applyTax?`<small>${s}</small>`:"";let nt=A;return v.projectId&&(nt=L?.title?S(L.title):b),`
      <div class="${Z?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${F}"${M} data-reservation-index="${P}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${w}</div>
          <div class="tile-badges">
            ${Te}
            ${x}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${E.client}</span>
            <span class="tile-value">${T?.customerName||v.customerName||o}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.project}</span>
            <span class="tile-value">${nt}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.start}</span>
            <span class="tile-value tile-inline">${C}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.end}</span>
            <span class="tile-value tile-inline">${D}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.cost}</span>
            <span class="tile-value">${ie} ${r} ${ee}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.equipment}</span>
            <span class="tile-value">${ze}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${E.crew}</span>
            <span class="tile-value">${z.length?U:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${de}</span>
          </div>
        </div>
        ${se}
      </div>
    `}).join("")}function Hs({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a}={}){const r=ot(),{reservations:s=[],customers:o=[],technicians:i=[],projects:m=[]}=te(),l=s.map(b=>{const E=Tt(b);return{...E,id:b.id??E.id,reservationId:b.reservationId??b.reservation_id??E.reservationId,reservationCode:b.reservationCode??b.reservation_code??E.reservationCode}}),d=l,p=Array.isArray(r)?r:i||[],f=new Map((m||[]).map(b=>[String(b.id),b])),u=document.getElementById(e);if(!u){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!d||d.length===0){u.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const g=t||rs(),y=new Map(o.map(b=>[String(b.id),b])),I=new Map(p.map(b=>[String(b.id),b])),A=Vs({reservations:l,filters:g,customersMap:y,techniciansMap:I,projectsMap:f});if(A.length===0){u.innerHTML=`<p>${c("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}u.innerHTML=`<div class="reservations-grid">${zs({entries:A,customersMap:y,techniciansMap:I,projectsMap:f})}</div>`,u.querySelectorAll('[data-action="details"]').forEach(b=>{const E=Number(b.dataset.reservationIndex);Number.isNaN(E)||b.addEventListener("click",()=>{typeof n=="function"&&n(E)})}),u.querySelectorAll('button[data-action="confirm"]').forEach(b=>{const E=Number(b.dataset.reservationIndex);Number.isNaN(E)||b.addEventListener("click",v=>{v.stopPropagation(),typeof a=="function"&&a(E,v)})})}function Us(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:o=[]}=te(),i=r.map(y=>{const I=Tt(y);return{...I,id:y.id??I.id,reservationId:y.reservationId??y.reservation_id??I.reservationId,reservationCode:y.reservationCode??y.reservation_code??I.reservationCode}}),m=r[e];if(!m)return h(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const l=i[e]??Tt(m),d=s.find(y=>String(y.id)===String(m.customerId)),p=m.projectId?o.find(y=>String(y.id)===String(m.projectId)):null,f=document.getElementById("reservation-details-body"),u=document.getElementById("reservationDetailsModal"),g=()=>{const y=()=>{u&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(u)?.hide()},I=document.getElementById("reservation-details-edit-btn");I&&(I.onclick=()=>{y(),typeof t=="function"&&t(e,{reservation:m,customer:d,getEditContext:a})});const A=document.getElementById("reservation-details-delete-btn");A&&(A.onclick=()=>{y(),typeof n=="function"&&n(e,{reservation:m,customer:d})});const b=f?.querySelector('[data-action="open-project"]');b&&p&&b.addEventListener("click",()=>{y();const v=p?.id!=null?String(p.id):"",P=v?`projects.html?project=${encodeURIComponent(v)}`:"projects.html";window.location.href=P});const E=document.getElementById("reservation-details-export-btn");E&&(E.onclick=async v=>{v?.preventDefault?.(),v?.stopPropagation?.(),E.blur();try{await is({reservation:m,customer:d,project:p})}catch(P){console.error("âŒ [reservations] export to PDF failed",P),h(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const v=f?.querySelector("[data-tech-slider]");if(v){const P=v.querySelector("[data-slider-track]"),T=v.querySelector("[data-slider-prev]"),L=v.querySelector("[data-slider-next]");if(P&&(T||L)){const V=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",j=()=>{const z=P.querySelector(".reservation-technician-card"),U=z&&z.getBoundingClientRect().width||220,w=12,C=Math.max(1,Math.floor(P.clientWidth/(U+w)));return Math.max(U+w,Math.floor(C*(U+w)*.9))},K=()=>{const z=Math.max(0,P.scrollWidth-P.clientWidth-2),U=P.scrollLeft<=1,w=P.scrollLeft>=z;T&&(T.disabled=U),L&&(L.disabled=w)},q=z=>{const U=j()*z,w=V?-U:U;P.scrollBy({left:w,behavior:"smooth"})};T?.addEventListener("click",()=>q(-1)),L?.addEventListener("click",()=>q(1)),P.addEventListener("scroll",K,{passive:!0}),window.addEventListener("resize",K,{passive:!0}),setTimeout(K,0)}}}catch{}};if(f){const y=ot()||[];f.innerHTML=pn(l,d,y,e,p),g(),Wn().then(()=>{const I=ot()||[];f.innerHTML=pn(l,d,I,e,p),g()}).catch(()=>{})}return u&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(u).show(),!0}function tt(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Oe(e,n),end:Oe(t,a)}}function kt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function cn(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function ha(){const{container:e,select:t,hint:n,addButton:a}=cn();if(!t)return;const r=t.value,s=Mn(),o=c("reservations.create.summary.currency","SR"),i=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,m=s.map(d=>{const p=Number.isFinite(Number(d.price))?Number(d.price):0,f=S(p.toFixed(2)),u=`${d.name} â€” ${f} ${o}`;return`<option value="${kt(d.id)}">${kt(u)}</option>`}).join("");t.innerHTML=`${i}${m}`;const l=s.length>0;t.disabled=!l,a&&(a.disabled=!l),e&&(e.hidden=!l,e.setAttribute("aria-hidden",l?"false":"true")),n&&(l?(n.textContent=c("reservations.create.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),l&&r&&s.some(d=>d.id===r)?t.value=r:t.selectedIndex=0}function Os(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=Fe(),{start:s,end:o}=tt(),{reservations:i=[]}=te(),m=a!=null&&i[a]||null,l=m?.id??m?.reservationId??null,d=ma(n,{existingItems:r,start:s,end:o,ignoreReservationId:l});if(!d.success)return t||h(d.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),d;const p=[...r,d.package];return Me(a,p),De(p),he(),t||h(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),d}function Pn(){const{select:e}=cn();if(!e)return;const t=e.value||"";Os(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function Gs(){const{addButton:e,select:t}=cn();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Pn()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Pn())}),t.dataset.listenerAttached="true"),ha()}function De(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${n}</td></tr>`,qn(t);return}const{groups:m}=Bt({items:e});t.innerHTML=m.map(l=>{const d=l.items[0]||{},p=et(d)||l.image,f=p?`<img src="${p}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',u=String(l?.type||"").toLowerCase()==="package"||l.items.some(q=>q?.type==="package"),g=S(String(l.count)),y=gn(l.unitPrice),I=Number.isFinite(y)?yn(y):0,A=gn(l.totalPrice),b=Number.isFinite(A)?A:I*(Number.isFinite(l.count)?l.count:1),E=yn(b),v=`${S(I.toFixed(2))} ${a}`,P=`${S(E.toFixed(2))} ${a}`,T=l.barcodes.map(q=>S(String(q||""))).filter(Boolean),L=T.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${T.map(q=>`<li>${q}</li>`).join("")}
            </ul>
          </details>`:"";let V="";if(u){const q=new Map,z=w=>{const C=Number.parseFloat(S(String(w??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(C)||C<=0||C>99?1:Math.round(C)},U=[];if(Array.isArray(l.packageItems)&&l.packageItems.length&&U.push(...l.packageItems),l.items.forEach(w=>{Array.isArray(w?.packageItems)&&U.push(...w.packageItems)}),U.forEach(w=>{if(!w)return;const C=N(w.barcode||w.normalizedBarcode||w.desc||Math.random());if(!C)return;const D=q.get(C),ne=z(w.qtyPerPackage??w.perPackageQty??w.quantityPerPackage??w.qty??w.quantity??1),_=Math.max(1,Math.min(ne,99));if(D){D.qty=_;return}q.set(C,{desc:w.desc||w.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:_,barcode:w.barcode??w.normalizedBarcode??""})}),q.size){const w=Array.from(q.values()).map(C=>{const D=S(String(C.qty>0?Math.min(C.qty,99):1)),ne=kt(C.desc||""),_=C.barcode?` <span class="reservation-package-items__barcode">(${kt(S(String(C.barcode)))})</span>`:"";return`<li>${ne}${_} Ã— ${D}</li>`}).join("");V=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${w}
              </ul>
            </details>
          `}}const j=u?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",K=u?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${f}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${u?`${V||""}${L||""}`:L}
              </div>
            </div>
          </td>
          <td>
            <div class="${j}" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${l.key}" aria-label="${o}"${K}>âˆ’</button>
              <span class="reservation-qty-value">${g}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${l.key}" aria-label="${s}"${K}>+</button>
            </div>
          </td>
          <td>${v}</td>
          <td>${P}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${l.key}" aria-label="${i}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),qn(t)}function Ws(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function qt(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let t=$t();const n=document.getElementById("edit-res-project")?.value||"";if(n)try{const o=(te()?.projects||[]).find(m=>String(m.id)===String(n)),i=Array.isArray(o?.paymentHistory)?o.paymentHistory:Array.isArray(o?.payment_history)?o.payment_history:Array.isArray(o?.payments)?o.payments:Array.isArray(o?.paymentLogs)?o.paymentLogs:[];Array.isArray(i)&&i.length&&(t=i)}catch{}if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Ln();return}const a=c("reservations.create.summary.currency","SR"),r=t.map((s,o)=>{const i=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${S(Number(s.amount).toFixed(2))} ${a}`:"â€”",m=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${S(Number(s.percentage).toFixed(2))}%`:"â€”",l=s?.recordedAt?S(xt(s.recordedAt)):"â€”",d=Ws(s?.type),p=s?.note?S(s.note):"";return`
      <tr>
        <td>${d}</td>
        <td>${i}</td>
        <td>${m}</td>
        <td>${l}</td>
        <td>${p}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${o}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Ln()}function Ks(){if(ct()){h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=Sa(e);let a=Ea(t);if(!Number.isFinite(a)||a<=0){h(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=Nt.lastResult,s=Number(r?.total)||0,o=Number(r?.paidPercent)||0,i=Number(r?.paidAmount)||0,m=c("reservations.create.summary.currency","SR");let l=null,d=null;if(n==="percent"){const f=Math.max(0,100-o);if(f<=1e-4){h(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const u=Math.min(a,f);if(u!==a){const g=S(u.toFixed(2));h(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",g)),a=u}d=Number(a.toFixed(2)),s>0&&(l=a/100*s)}else{const f=Math.max(0,s-i);if(f<=1e-4){h(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const u=Math.min(a,f);if(u!==a){const g=`${S(u.toFixed(2))} ${m}`;h(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",g)),a=u}l=Number(a.toFixed(2)),s>0&&(d=l/s*100)}l!=null&&(l=Number(l.toFixed(2))),d!=null&&(d=Number(d.toFixed(2)));const p={type:n,value:a,amount:l,percentage:d,recordedAt:new Date().toISOString()};or(p),dn($t()),qt(),he(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),h(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Ln(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(ct()){n.preventDefault(),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Ks()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(ct()){n.preventDefault(),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(cr(r),dn($t()),qt(),he(),h(c("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),t.dataset.listenerAttached="true")}function Qs(e){const{index:t,items:n}=Fe(),{groups:a}=Bt({items:n}),r=a.find(i=>i.key===e);if(!r||r.items.some(i=>i?.type==="package"))return;let s=-1;for(let i=n.length-1;i>=0;i-=1){const m=n[i];if(dt(m)===e&&m?.type!=="package"){s=i;break}}if(s<0)return;const o=n.filter((i,m)=>m!==s);Me(t,o),De(o),he()}function Js(e){const{index:t,items:n}=Fe(),{groups:a}=Bt({items:n}),r=a.find(i=>i.key===e);if(!r)return;let s=n.filter(i=>dt(i)!==e);if(r.items.some(i=>i&&i.type==="package")){const i=Ge(r.packageId??r.items.find(p=>p?.type==="package")?.packageId??""),m=N(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(p=>{if(!p||typeof p!="object"||p.type!=="package")return!0;const f=Ge(p.packageId??p.package_id??p.id??""),u=N(p.barcode??p.package_code??"");return!(i&&f===i||m&&u&&u===m)});const l=new Set,d=new Set;r.items.forEach(p=>{(Array.isArray(p?.packageItems)?p.packageItems:[]).forEach(u=>{const g=N(u?.barcode||u?.normalizedBarcode||"");g&&l.add(g);const y=u?.equipmentId??u?.equipment_id??null;y!=null&&d.add(String(y))})}),(l.size||d.size)&&(s=s.filter(p=>{const f=N(p?.barcode||""),u=p?.equipmentId??p?.id??null;return!(f&&l.has(f)||u!=null&&d.has(String(u)))}))}s.length!==n.length&&(Me(t,s),De(s),he())}function Ys(e){const{index:t,items:n}=Fe(),{groups:a}=Bt({items:n}),r=a.find(I=>I.key===e);if(!r||r.items.some(I=>I?.type==="package"))return;const{start:s,end:o}=tt();if(!s||!o){h(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:i=[]}=te(),m=t!=null&&i[t]||null,l=m?.id??m?.reservationId??null,d=new Set(n.map(I=>N(I.barcode))),{equipment:p=[]}=te(),f=(p||[]).find(I=>{const A=N(I?.barcode);return!A||d.has(A)||dt({desc:I?.desc||I?.description||I?.name||"",price:Number(I?.price)||0})!==e||!xn(I)?!1:!je(A,s,o,l)});if(!f){h(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=N(f.barcode),g=Qe(f);if(!g){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=[...n,{id:g,equipmentId:g,barcode:u,desc:f.desc||f.description||f.name||r.description||"",qty:1,price:Number.isFinite(Number(f.price))?Number(f.price):r.unitPrice,image:et(f)}];Me(t,y),De(y),he()}function qn(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:r,itemIndex:s}=n.dataset;if(a==="decrease-edit-group"&&r){Qs(r);return}if(a==="increase-edit-group"&&r){Ys(r);return}if(a==="remove-edit-group"&&r){Js(r);return}if(a==="remove-edit-item"){const o=Number(s);Number.isNaN(o)||er(o)}}),e.dataset.groupListenerAttached="true")}function ct(){return!!document.getElementById("edit-res-project")?.value}function Xs(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{ct()&&(h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function Zs(e){const t=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),o=document.getElementById("edit-res-payment-progress-value"),i=document.getElementById("edit-res-payment-add"),m=document.getElementById("edit-res-payment-history");if([n,a,r,s,o,i,m].forEach(Xs),e){if(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),r){const l=document.getElementById("edit-res-project")?.value||"";let d="unpaid";if(l)try{const f=(te()?.projects||[]).find(g=>String(g.id)===String(l)),u=typeof f?.paymentStatus=="string"?f.paymentStatus.toLowerCase():null;u&&["paid","partial","unpaid"].includes(u)&&(d=u)}catch{}r.value=d,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t),o&&(o.value="",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),i&&(i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),m&&(m.dataset.linkedDisabled="true")}else n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),m&&(m.dataset.linkedDisabled="false")}function he(){const e=document.getElementById("edit-res-summary");if(!e)return;qt();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),fe(a),he()}),a.dataset.listenerAttached="true");const r=S(t?.value||"0");t&&(t.value=r);const s=parseFloat(r)||0,o=n?.value||"percent",i=ct();Zs(i);const m=document.getElementById("edit-res-tax"),l=i?!1:m?.checked||!1,d=!i&&a?.dataset?.userSelected==="true";let p="unpaid";if(i){const E=document.getElementById("edit-res-project")?.value||"";if(E)try{const P=(te()?.projects||[]).find(L=>String(L.id)===String(E)),T=typeof P?.paymentStatus=="string"?P.paymentStatus.toLowerCase():null;T&&["paid","partial","unpaid"].includes(T)&&(p=T)}catch{}}else p=d&&a?.value||"unpaid";let f=null;!i&&l&&(Ee("edit-res-company-share"),f=Ke("edit-res-company-share"),(!Number.isFinite(f)||f<=0)&&(Ee("edit-res-company-share"),f=Ke("edit-res-company-share")));const{items:u=[],payments:g=[]}=Fe(),{start:y,end:I}=tt(),A=Nt({items:u,discount:s,discountType:o,applyTax:l,paidStatus:p,start:y,end:I,companySharePercent:f,paymentHistory:g});e.innerHTML=A;const b=Nt.lastResult;if(b&&a){const E=b.paymentStatus;d?fe(a,a.value):(a.value!==E&&(a.value=E),a.dataset&&delete a.dataset.userSelected,fe(a,E))}else a&&fe(a,a.value)}function er(e){if(e==null)return;const{index:t,items:n}=Fe();if(!Array.isArray(n))return;const a=n.filter((r,s)=>s!==e);Me(t,a),De(a),he()}async function tr(e){const t=e?.value??"",n=N(t);if(!n)return;const a=Kt(n);if(!a){h(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Ne(a);if(r==="maintenance"||r==="retired"){h(We(r));return}const s=N(n),{index:o,items:i=[]}=Fe();if(i.findIndex(I=>N(I.barcode)===s)>-1){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:l,end:d}=tt();if(!l||!d){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:p=[]}=te(),f=o!=null&&p[o]||null,u=f?.id??f?.reservationId??null;if(je(s,l,d,u)){try{const I=new URLSearchParams({type:"equipment",id:s,start:l,end:d});u!=null&&I.set("ignore",String(u));const A=await Le(`/reservations/availability.php?${I.toString()}`),b=Array.isArray(A?.conflicts)?A.conflicts:[],E=Array.from(new Set(b.map(P=>P?.reservation_code||(P?.reservation_id!=null?`#${P.reservation_id}`:null)).filter(Boolean))),v=E.length?`: ${E.join("ØŒ ")}`:"";h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+v,"warning",6e3)}catch{h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const g=Qe(a);if(!g){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=[...i,{id:g,equipmentId:g,barcode:s,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];Me(o,y),e&&(e.value=""),De(y),he()}async function At(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=ca(t),a=N(n?.barcode||t);if(!n||!a){h(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Ne(n);if(r==="maintenance"||r==="retired"){h(We(r));return}const{start:s,end:o}=tt();if(!s||!o){h(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:i,items:m=[]}=Fe();if(m.some(y=>N(y.barcode)===a)){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:d=[]}=te(),p=i!=null&&d[i]||null,f=p?.id??p?.reservationId??null;if(je(a,s,o,f)){try{const y=new URLSearchParams({type:"equipment",id:a,start:s,end:o});f!=null&&y.set("ignore",String(f));const I=await Le(`/reservations/availability.php?${y.toString()}`),A=Array.isArray(I?.conflicts)?I.conflicts:[],b=Array.from(new Set(A.map(v=>v?.reservation_code||(v?.reservation_id!=null?`#${v.reservation_id}`:null)).filter(Boolean))),E=b.length?`: ${b.join("ØŒ ")}`:"";h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+E,"warning",6e3)}catch{h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const u=Qe(n);if(!u){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=[...m,{id:u,equipmentId:u,barcode:a,desc:n.desc,qty:1,price:n.price,image:n.image||n.imageUrl||n.img||null}];Me(i,g),De(g),he(),e.value=""}function ba(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),At(e))});const t=()=>{da(e.value,"edit-res-equipment-description-options")&&At(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{he()});const e=()=>{Gs()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{ha()})}typeof window<"u"&&(window.getEditReservationDateRange=tt,window.renderEditPaymentHistory=qt);function nr(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){zt(e);return}At(e)}}function qr(){Re(),ba()}function ar(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let Xe=null,Ie=[],qe=[],Ut=null,oe={},jt=!1,$n=!1;function sr(){if(!$n)try{document.addEventListener("click",e=>{const t=e.target?.closest?.("#save-reservation-changes");if(t){try{if(t.dataset.listenerAttached==="true")return}catch{}try{t.dataset.saving||(t.dataset.saving="true",setTimeout(()=>{try{delete t.dataset.saving}catch{}},1200))}catch{}try{Ba(oe).catch(n=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",n)})}catch(n){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",n)}}},!0),$n=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const rr="__DEBUG_CREW__";function ir(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(rr);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function Cn(e,t){if(ir())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,t)}catch{}}function it(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(n&&(n.value=s?"true":"false"),a){const o=a.dataset.confirmLabel||"âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯",i=a.dataset.pendingLabel||"â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯";a.innerHTML=s?o:i,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!t),a.classList.toggle("btn-outline-secondary",!s||t),a.disabled=t,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",t)}function gt(){return document.getElementById("edit-res-confirmed")?.value==="true"}function Fe(){return{index:Xe,items:Ie,payments:qe}}function Me(e,t,n=qe){Xe=typeof e=="number"?e:null,Ie=Array.isArray(t)?[...t]:[],qe=Array.isArray(n)?[...n]:[]}function Ia(){Xe=null,Ie=[],Ga(),qe=[]}function $t(){return[...qe]}function dn(e){qe=Array.isArray(e)?[...e]:[]}function or(e){e&&(qe=[...qe,e])}function cr(e){!Number.isInteger(e)||e<0||(qe=qe.filter((t,n)=>n!==e))}function yt(e,t=1){const n=Number.parseFloat(S(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function Ot(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(S(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function dr(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?N(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:yt(e.qty??e.quantity??e.count??1),price:Ot(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function lr(e,t=0){if(!e||typeof e!="object")return null;const n=Ge(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:Zt(e)).map(f=>dr(f)).filter(Boolean),o=e.total_price??e.totalPrice??e.total??null;let i=Ot(e.unit_price??e.unitPrice??e.price??null,0);if((!i||i===0)&&o!=null){const f=Ot(o,0);f>0&&a>0&&(i=Number((f/a).toFixed(2)))}const m=e.package_code??e.packageCode??e.barcode??null,d=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,m,n].find(f=>f!=null&&String(f).trim()!=="")||`Package ${n}`,p=e.image??e.cover??e.thumbnail??s.find(f=>f?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:S(String(d)),name:S(String(d)),qty:a,price:i,barcode:m,packageItems:s,image:p}}function ur(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-n;e.set(a,s>0?s:0)})}function mr(e={},t=[]){const n=Array.isArray(t)?t.map(i=>({...i})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return n;const r=a.map((i,m)=>lr(i,m)).filter(Boolean);if(!r.length)return n;const s=new Map;r.forEach(i=>{const m=yt(i.qty??i.quantity??1);if(i.barcode){const l=N(i.barcode);if(l){const d=`package::${l}`;s.set(d,(s.get(d)??0)+m)}}(i.packageItems||[]).forEach(l=>{if(!l)return;const d=m*yt(l.qty??l.quantity??1),p=l.equipmentId??null,f=l.normalizedBarcode||(l.barcode?N(l.barcode):null);if(p!=null){const u=`equipment::${String(p)}`;s.set(u,(s.get(u)??0)+d)}if(f){const u=`barcode::${f}`;s.set(u,(s.get(u)??0)+d)}})});const o=[];return n.forEach(i=>{if(!i||typeof i!="object"){o.push(i);return}if(i.type==="package"){const I=Ge(i.packageId??i.package_id??i.id??"");r.some(b=>b.packageId===I)||o.push({...i});return}const m=yt(i.qty??i.quantity??1),l=Qe(i),d=i.barcode?N(i.barcode):null,p=[];l!=null&&p.push(`equipment::${String(l)}`),d&&p.push(`barcode::${d}`);const f=p.map(I=>s.get(I)??0).filter(I=>I>0);if(!f.length){o.push({...i});return}const u=Math.min(...f);if(u<=0){o.push({...i});return}const g=Math.min(u,m);if(ur(s,p,g),g>=m)return;const y=m-g;o.push({...i,qty:y,quantity:y})}),[...o,...r.map(i=>({...i}))]}function pr(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Sa(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Ea(e){if(!e)return null;const t=S(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function fr(e,t){if(e){e.value="";return}}function st(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ka(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(S(String(e.value??""))),a=Number.parseFloat(S(String(e.amount??""))),r=Number.parseFloat(S(String(e.percentage??""))),s=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,o=Number.isFinite(r)?r:t==="percent"&&Number.isFinite(n)?n:null,i=t??(Number.isFinite(s)?"amount":Number.isFinite(o)?"percent":null),m=i==="amount"?s??null:i==="percent"?o??null:Number.isFinite(n)?n:null,l=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:i,value:m,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(o)?o:null,note:e.note??null,recordedAt:l}}function gr(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=t?.projectId?String(t.projectId):"",o=Array.isArray(e)?[...e].sort((m,l)=>String(l.createdAt||l.start||"").localeCompare(String(m.createdAt||m.start||""))):[],i=[`<option value="">${st(a)}</option>`];o.forEach(m=>{i.push(`<option value="${st(m.id)}">${st(m.title||a)}</option>`)}),s&&!o.some(m=>String(m.id)===s)&&i.push(`<option value="${st(s)}">${st(r)}</option>`),n.innerHTML=i.join(""),s?n.value=s:n.value=""}function Aa(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=s),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(t){const m=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",m&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}Gt("tax");const i=oe?.updateEditReservationSummary;typeof i=="function"&&i()}function Gt(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const s=oe?.updateEditReservationSummary;typeof s=="function"&&s()};if(jt){a();return}jt=!0;const r=()=>{jt=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(Ue)),t.disabled){n.checked=!1,h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}t.checked||(t.checked=!0),Ee("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Ee("edit-res-company-share"):n.checked&&(n.checked=!1));r()}async function jn(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:o}={}){const{customers:i,projects:m}=te(),d=Fn()?.[e];if(!d){h(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}oe={...oe,reservation:d,projects:m||[]},t?.(),gr(m||[],d);const p=d.projectId&&m?.find?.($=>String($.id)===String(d.projectId))||null,{effectiveConfirmed:f,projectLinked:u}=lt(d,p),g=d.items?d.items.map($=>({...$,equipmentId:$.equipmentId??$.equipment_id??$.id,barcode:N($?.barcode)})):[],y=mr(d,g),A=(Array.isArray(d.paymentHistory)?d.paymentHistory:Array.isArray(d.payment_history)?d.payment_history:[]).map($=>ka($)).filter(Boolean);Me(e,y,A);const b=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),E=i?.find?.($=>String($.id)===String(d.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const v=document.getElementById("edit-res-id");v&&(v.value=d.reservationId||d.id);const P=document.getElementById("edit-res-customer");P&&(P.value=E?.customerName||b);const T=typeof a=="function"?a(d.start):{date:"",time:""},L=typeof a=="function"?a(d.end):{date:"",time:""};n?.("edit-res-start",T.date),n?.("edit-res-start-time",T.time),n?.("edit-res-end",L.date),n?.("edit-res-end-time",L.time);const V=document.getElementById("edit-res-notes");V&&(V.value=d.notes||"");const j=document.getElementById("edit-res-discount");if(j){const $=u?0:d.discount??0;j.value=S($)}const K=document.getElementById("edit-res-discount-type");K&&(K.value=u?"percent":d.discountType||"percent");const q=d.projectId?!1:!!d.applyTax,z=document.getElementById("edit-res-tax");z&&(z.checked=q);const U=document.getElementById("edit-res-company-share");if(U){const $=d.companySharePercent??d.company_share_percent??d.companyShare??d.company_share??null,re=$!=null?Number.parseFloat(S(String($).replace("%","").trim())):NaN,pe=d.companyShareEnabled??d.company_share_enabled??d.companyShareApplied??d.company_share_applied??null,ge=pe!=null?pe===!0||pe===1||pe==="1"||String(pe).toLowerCase()==="true":Number.isFinite(re)&&re>0,Ae=ge&&Number.isFinite(re)&&re>0?re:Ue,ae=q||ge;U.checked=ae,U.dataset.companyShare=String(Ae)}it(f,{disable:u});const w=document.getElementById("edit-res-paid"),C=d.paidStatus??(d.paid===!0||d.paid==="paid"?"paid":"unpaid");w&&(w.value=C,w.dataset&&delete w.dataset.userSelected);const D=document.getElementById("edit-res-payment-progress-type"),ne=document.getElementById("edit-res-payment-progress-value");D?.dataset?.userSelected&&delete D.dataset.userSelected,D&&(D.value="percent"),fr(ne);const _=document.getElementById("edit-res-cancelled");if(_){const $=String(d?.status||d?.reservationStatus||"").toLowerCase();_.checked=["cancelled","canceled"].includes($),_.checked&&it(f,{disable:!0})}let W=Array.isArray(d.crewAssignments)&&d.crewAssignments.length?d.crewAssignments:Array.isArray(d.techniciansDetails)&&d.techniciansDetails.length?d.techniciansDetails:(d.technicians||[]).map($=>String($));if(!Array.isArray(W)||W.length===0){const $=Va(d.id??d.reservationId??d.reservation_code??null);Array.isArray($)&&$.length&&(W=$)}try{await Wn()}catch($){console.warn("[reservationsEdit] positions load failed (non-fatal)",$)}if(za(W),r?.(y),typeof window<"u"){const $=window?.renderEditPaymentHistory;typeof $=="function"&&$()}Aa(),s?.();const O=document.getElementById("editReservationModal");Ut=pr(O,o),Ut?.show?.();try{yr?.(oe)}catch($){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",$)}sr()}async function Ba({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:o,handleReservationsMutation:i}={}){if(Xe===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const m=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end")?.value?.trim(),p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",f=document.getElementById("edit-res-notes")?.value||"",u=S(document.getElementById("edit-res-discount")?.value||"0");let g=parseFloat(u)||0,y=document.getElementById("edit-res-discount-type")?.value||"percent";const I=gt(),A=document.getElementById("edit-res-paid"),b=A?.dataset?.userSelected==="true",E=b&&A?.value||"unpaid",v=document.getElementById("edit-res-payment-progress-type"),P=document.getElementById("edit-res-payment-progress-value"),T=Sa(v),L=Ea(P),V=document.getElementById("edit-res-project")?.value||"",K=document.getElementById("edit-res-cancelled")?.checked===!0,q=Ha();q.map(k=>k?.technicianId).filter(Boolean);const z=document.getElementById("edit-res-company-share"),U=document.getElementById("edit-res-tax");if(!m||!d){h(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const w=typeof e=="function"?e:(k,x)=>`${k}T${x||"00:00"}`,C=w(m,l),D=w(d,p);if(C&&D&&new Date(C)>new Date(D)){h(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const _=Fn()?.[Xe];if(!_){h(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(Ie)||Ie.length===0&&q.length===0){h(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const W=typeof t=="function"?t:()=>!1,O=_.id??_.reservationId;for(const k of Ie){if(k?.type==="package"&&Array.isArray(k.packageItems)){for(const F of k.packageItems){const M=F?.barcode??F?.normalizedBarcode??"";if(!M)continue;const Z=Ne(M);if(Z!=="reserved"&&Z!=="available"){h(We(Z));return}}continue}const x=Ne(k.barcode);if(x!=="reserved"&&x!=="available"){h(We(x));return}}{const k=typeof n=="function"?n:()=>!1;for(const x of Ie){if(x?.type!=="package")continue;const F=x.packageId??x.package_id??null,M=x.desc||x.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(F&&k(F,C,D,O)){const Z=Array.isArray(x?.packageItems)?x.packageItems.map(G=>N(G?.barcode??G?.normalizedBarcode??"")).filter(Boolean):[];let se=vn(Z,C,D,O);if(!se.length)try{const G=new URLSearchParams;G.set("type","package"),G.set("id",String(F)),G.set("start",C),G.set("end",D),O!=null&&G.set("ignore",String(O));const de=await Le(`/reservations/availability.php?${G.toString()}`),ze=Array.isArray(de?.conflicts)?de.conflicts:[];se=Array.from(new Set(ze.map(ee=>ee?.reservation_code||(ee?.reservation_id!=null?`#${ee.reservation_id}`:null)).filter(Boolean)))}catch{}const ie=se.length?` (${se.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(M))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ie,"warning",-1);return}if(Array.isArray(x?.packageItems)&&x.packageItems.length){const Z=(x.packageItems||[]).map(G=>N(G?.barcode??G?.normalizedBarcode??"")).filter(Boolean),se=Z.length,ie=Z.filter(G=>W(G,C,D,O)).length;if(se>0&&ie>=se){const G=(x.packageItems||[]).map(ee=>N(ee?.barcode??ee?.normalizedBarcode??"")).filter(Boolean);let de=vn(G,C,D,O);if(!de.length)try{const ee=new URLSearchParams;ee.set("type","package"),F!=null&&ee.set("id",String(F)),ee.set("start",C),ee.set("end",D),O!=null&&ee.set("ignore",String(O));const nt=await Le(`/reservations/availability.php?${ee.toString()}`),un=Array.isArray(nt?.conflicts)?nt.conflicts:[];de=Array.from(new Set(un.map(Y=>Y?.reservation_code||(Y?.reservation_id!=null?`#${Y.reservation_id}`:null)).filter(Boolean)))}catch{}const ze=de.length?` (${de.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(M))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ze,"warning",6e3);return}}}}const $=[];for(const k of Ie){if(k?.type==="package"&&Array.isArray(k.packageItems)){for(const F of k.packageItems){const M=N(F?.barcode??F?.normalizedBarcode??"");if(M&&W(M,C,D,O)){const Z=F?.desc||F?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");$.push({label:S(String(Z)),barcode:M})}}continue}const x=N(k.barcode);if(W(x,C,D,O)){const F=k?.desc||k?.name||k?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");$.push({label:S(String(F)),barcode:x})}}if($.length){const k=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let x=null;try{const M=Array.from(new Set($.map(se=>se.barcode).filter(Boolean))),Z=new Map;await Promise.all(M.map(async se=>{const ie=new URLSearchParams;ie.set("type","equipment"),ie.set("id",se),ie.set("start",C),ie.set("end",D),O!=null&&ie.set("ignore",String(O));const G=await Le(`/reservations/availability.php?${ie.toString()}`),de=Array.isArray(G?.conflicts)?G.conflicts:[],ze=Array.from(new Set(de.map(ee=>ee?.reservation_code||(ee?.reservation_id!=null?`#${ee.reservation_id}`:null)).filter(Boolean)));Z.set(se,ze)})),x=$.map(({label:se,barcode:ie})=>{const G=Z.get(ie)||[];return G.length?`${se} (${G.join("ØŒ ")})`:se}).join("ØŒ ")}catch{}const F=x||$.map(M=>M.label).filter(Boolean).map(String).join("ØŒ ");h(`${k}: ${F}`,"warning",6e3);return}const re=typeof n=="function"?n:()=>!1;for(const k of Ie){if(k?.type!=="package")continue;const x=k.packageId??k.package_id??null;if(x&&re(x,C,D,O)){const F=k.desc||k.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const M=new URLSearchParams;M.set("type","package"),M.set("id",String(x)),M.set("start",C),M.set("end",D),O!=null&&M.set("ignore",String(O));const Z=await Le(`/reservations/availability.php?${M.toString()}`),se=Array.isArray(Z?.conflicts)?Z.conflicts:[],ie=Array.from(new Set(se.map(de=>de?.reservation_code||(de?.reservation_id!=null?`#${de.reservation_id}`:null)).filter(Boolean))),G=ie.length?` (${ie.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(F))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+G,"warning",6e3)}catch{h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(F))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const pe=typeof a=="function"?a:()=>!1,ge=[];for(const k of q){if(!k?.technicianId||!pe(k.technicianId,C,D,O))continue;const x=k?.technicianName||k?.positionLabel||String(k.technicianId);let F=[];try{F=Un(k.technicianId,C,D,O)}catch{}ge.push({label:S(String(x)),codes:F})}if(ge.length){const k=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),x=ge.map(({label:F,codes:M})=>M&&M.length?`${F} (${M.join("ØŒ ")})`:F).join("ØŒ ");h(`${k}: ${x}`,"warning",6e3);return}const Ae=Array.isArray(oe.projects)&&oe.projects.length?oe.projects:te().projects||[],ae=V&&Ae.find(k=>String(k.id)===String(V))||null,Ye={..._,projectId:V?String(V):null,confirmed:I},{effectiveConfirmed:Be,projectLinked:be,projectStatus:Ve}=lt(Ye,ae);let ce=!!z?.checked,B=!!U?.checked;if(be&&(ce&&(z.checked=!1,ce=!1),B=!1),!be&&ce!==B){h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}B&&(Ee("edit-res-company-share"),ce=!!z?.checked);let R=ce?getCompanySharePercent("edit-res-company-share"):null;ce&&(!Number.isFinite(R)||R<=0)&&(Ee("edit-res-company-share"),R=getCompanySharePercent("edit-res-company-share"));const J=ce&&B&&Number.isFinite(R)&&R>0,Q=be?!1:B;be&&(g=0,y="percent");const le=Nn(Ie,g,y,Q,q,{start:C,end:D,companySharePercent:J?R:0});let X=$t();if(Number.isFinite(L)&&L>0){const k=le;let x=null,F=null;T==="amount"?(x=L,k>0&&(F=L/k*100)):(F=L,k>0&&(x=L/100*k));const M=ka({type:T,value:L,amount:x,percentage:F,recordedAt:new Date().toISOString()});M&&(X=[...X,M],dn(X)),P&&(P.value="")}const ue=vt({totalAmount:le,history:X}),me=ht({manualStatus:E,paidAmount:ue.paidAmount,paidPercent:ue.paidPercent,totalAmount:le});A&&!b&&(A.value=me,A.dataset&&delete A.dataset.userSelected);let we=_.status??"pending";be?we=ae?.status??Ve??we:K?we="cancelled":["completed","cancelled"].includes(String(we).toLowerCase())||(we=I?"confirmed":"pending");const Te=_n({reservationCode:_.reservationCode??_.reservationId??null,customerId:_.customerId,start:C,end:D,status:we,title:_.title??null,location:_.location??null,notes:f,projectId:V?String(V):null,totalAmount:le,discount:g,discountType:y,applyTax:Q,paidStatus:me,confirmed:Be,items:Ie.map(k=>({...k,equipmentId:k.equipmentId??k.id})),crewAssignments:q,companySharePercent:J?R:null,companyShareEnabled:J,paidAmount:ue.paidAmount,paidPercentage:ue.paidPercent,paymentProgressType:ue.paymentProgressType,paymentProgressValue:ue.paymentProgressValue,paymentHistory:X});try{Cn("about to submit",{editingIndex:Xe,crewAssignments:q,techniciansPayload:Te?.technicians,payload:Te});const k=await Ua(_.id||_.reservationId,Te);Cn("server response",{reservation:k?.id??k?.reservationId??k?.reservation_code,technicians:k?.technicians,crewAssignments:k?.crewAssignments,techniciansDetails:k?.techniciansDetails}),await Oa(),en(),ot(),ss(),h(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),Ia(),i?.({type:"updated",reservation:k}),s?.(),o?.(),Ut?.hide?.()}catch(k){console.error("âŒ [reservationsEdit] Failed to update reservation",k);const x=Rn(k)?k.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");h(x,"error")}}function yr(e={}){oe={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:r}=oe,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=S(s.value),t?.()}),s.dataset.listenerAttached="true");const o=document.getElementById("edit-res-discount-type");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>t?.()),o.dataset.listenerAttached="true");const i=document.getElementById("edit-res-tax");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Gt("tax")}),i.dataset.listenerAttached="true");const m=document.getElementById("edit-res-company-share");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{Gt("share")}),m.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-type");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{l.dataset.userSelected="true",t?.()}),l.dataset.listenerAttached="true");const d=document.getElementById("edit-res-payment-progress-value");d&&!d.dataset.listenerAttached&&(d.addEventListener("input",()=>{d.value=S(d.value)}),d.dataset.listenerAttached="true"),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const p=document.getElementById("edit-res-project");p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>{Aa();const A=Array.isArray(oe.projects)&&oe.projects.length?oe.projects:te().projects||[],b=p.value&&A.find(L=>String(L.id)===String(p.value))||null,v={...oe?.reservation??{},projectId:p.value||null,confirmed:gt()},{effectiveConfirmed:P,projectLinked:T}=lt(v,b);it(P,{disable:T}),t?.()}),p.dataset.listenerAttached="true");const f=document.getElementById("edit-res-confirmed-btn");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{if(f.disabled)return;const A=!gt();it(A),t?.()}),f.dataset.listenerAttached="true");const u=document.getElementById("edit-res-cancelled");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&it(gt(),{disable:u.checked}),t?.()}),u.dataset.listenerAttached="true");const g=document.getElementById("save-reservation-changes");g&&!g.dataset.listenerAttached&&(g.addEventListener("click",()=>{Ba(oe).catch(A=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",A)})}),g.dataset.listenerAttached="true");const y=document.getElementById("edit-res-equipment-barcode");if(y&&!y.dataset.listenerAttached){let A=null;const b=()=>{y.value?.trim()&&(clearTimeout(A),A=null,n?.(y))};y.addEventListener("keydown",v=>{v.key==="Enter"&&(v.preventDefault(),b())});const E=()=>{if(clearTimeout(A),!y.value?.trim())return;const{start:v,end:P}=getEditReservationDateRange();!v||!P||(A=setTimeout(()=>{b()},150))};y.addEventListener("input",E),y.addEventListener("change",b),y.dataset.listenerAttached="true"}ba?.();const I=document.getElementById("editReservationModal");I&&!I.dataset.cleanupAttached&&(I.addEventListener("hidden.bs.modal",()=>{Ia(),t?.(),r?.([])}),I.dataset.cleanupAttached="true")}function $r(){return ls().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=te()||{};Wa(e||[]),va()})}function ln(e=null){va(),wa(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function vr(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Wt(){return{populateEquipmentDescriptionLists:Re,setFlatpickrValue:ar,splitDateTime:On,renderEditItems:De,updateEditReservationSummary:he,addEquipmentByDescription:nr,addEquipmentToEditingReservation:tr,addEquipmentToEditingByDescription:At,combineDateTime:Oe,hasEquipmentConflict:je,hasTechnicianConflict:Hn,renderReservations:wa,handleReservationsMutation:ln,ensureModal:vr}}function wa(e="reservations-list",t=null){Hs({containerId:e,filters:t,onShowDetails:Pa,onConfirmReservation:qa})}function Pa(e){return Us(e,{getEditContext:Wt,onEdit:(t,{reservation:n})=>{$a(t,n)},onDelete:La})}function La(e){return ja()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?cs(e,{onAfterChange:ln}):!1:(xa(),!1)}function qa(e){return ds(e,{onAfterChange:ln})}function $a(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}jn(e,Wt());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}jn(e,Wt());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const s=t.id??t.reservationId;n.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(o){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",o)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}Ta({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=n.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function Cr(){us({showReservationDetails:Pa,deleteReservation:La,confirmReservation:qa,openReservationEditor:$a})}export{qr as a,wa as b,va as c,H as d,Pa as e,La as f,Wt as g,ln as h,Lr as i,qa as j,ar as k,$r as l,$a as o,Cr as r,yr as s,he as u};
