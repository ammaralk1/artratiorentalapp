import{d as te,n as E,t as c,j as h,b as Le,z as Ma,y as Vt,v as Va,w as za,u as Ha}from"./auth.BqwfmscP.js";import{g as Ne,r as st,f as nn,a as Oa,i as Vn,b as In}from"./details.q0CukAHD.js";import{k as an,l as Sn,n as be,s as En,o as sn,b as zt,D as Ke,p as Ze,q as pt,h as zn,c as wt,e as kt,t as Hn,v as Ua,w as On,x as Ga,y as Wa,z as Un,a as ft,d as Ka,A as Ht,B as Ot,C as _t,E as wn,F as kn,g as Gn,G as Ja,H as Qa,I as Ya,u as Xa,r as Za,J as es,j as ts}from"./reservationsService.DC1_tqLc.js";import{l as rn,o as Wn,p as ns,q as Je,u as on,v as Ae,n as F,w as Kn,x as cn,y as Ce,z as xt,A as At,B as as,C as Jn,D as Qn,E as Yn,s as ut,F as Xn,G as Qe,b as dn,H as ss,I as rs,J as is,K as Zn,L as os,M as cs,k as ea,N as An}from"./state.BUFhj3Lf.js";import{s as ln,E as ta,a as ds,c as ls,b as us,r as ms}from"./equipment.rqy6sxA-.js";import{g as ps,a as fs,b as gs}from"./reservationPdf.CGvz1591.js";import{o as ys}from"./view.BuPP1Eg8.js";import{c as na,d as vs,a as hs}from"./reservationsActions.7jpxcZfI.js";import{ensureProjectsLoaded as bs}from"./projectsService.B0-iuJKq.js";import{s as Is}from"./uiBridge.BLZZT8b9.js";const Ss="__DEBUG_CREW__";function Es(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Ss);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Bn(e,n){if(Es())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const aa="projects:create:draft",sa="projects.html#projects-section";let Ut=null,ra=[],Gt=new Map,Wt=new Map,Bt=new Map,Ft=!1,It=null,Pn=!1,ia=[];const je="reservations:create:draft";let tt=!1;function jt(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function un(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function ws(){if(typeof document>"u"||!jt())return null;try{const{input:n,hidden:t}=at(),{input:a,hidden:r}=_e(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",o=document.getElementById("res-start-time")?.value||"",l=document.getElementById("res-end-time")?.value||"",u=document.getElementById("res-notes")?.value||"",d=document.getElementById("res-discount")?.value||"",f=document.getElementById("res-discount-type")?.value||"percent",g=!!document.getElementById("res-tax")?.checked,p=!!document.getElementById("res-company-share")?.checked,v=p?Xe("res-company-share"):null,b=document.getElementById("res-payment-status")?.value||"unpaid",q=document.getElementById("res-payment-progress-type")?.value||"percent",I=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:o,endTime:l,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:u,discount:String(d||""),discountType:f,taxEnabled:g,companyShareEnabled:p,companySharePercent:v,paymentStatus:b,paymentProgressType:q,paymentProgressValue:String(I||""),items:Ae()||[],technicianIds:Wa()||[],crewAssignments:an()||[]}}catch{return null}}function Te(){if(tt)return;const e=jt(),n=un();if(!e&&!n)return;const t=ws();if(t){try{const r=(()=>{const i=e?e.getItem(je):null,o=!i&&n?n.getItem(je):null,l=i||o;return l?JSON.parse(l):null})(),s=i=>{if(!i)return!1;const o=Array.isArray(i.items)&&i.items.length>0,l=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,u=!!(i.startDate||i.endDate||i.startTime||i.endTime),d=!!(i.customerId||i.customerLabel);return o||l||u||d};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(je,a),n&&n!==e&&n.setItem(je,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function oa(){const e=jt(),n=un();if(!(!e&&!n))try{e&&e.removeItem(je),n&&n!==e&&n.removeItem(je)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function ks(){const e=jt(),n=un();if(!e&&!n)return;tt=!0;let t=null;try{const a=e?e.getItem(je):null,r=!a&&n?n.getItem(je):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),tt=!1;return}if(t)try{if(t.startDate||t.startTime){const i=Je(t.startDate||"",t.startTime||"");Re("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=Je(t.endDate||"",t.endTime||"");Re("res-end","res-end-time",i)}if(t.customerId){Ee({selectedValue:String(t.customerId)});const{input:i,hidden:o}=at();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){Ee({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=at();i&&(i.value=t.customerLabel),o&&(o.value="");try{const l=$t(t.customerLabel,{allowPartial:!0});l&&(o.value=String(l.id),i.value=l.label,i.dataset.selectedId=String(l.id))}catch{}}if(t.projectId)De({selectedValue:String(t.projectId)});else if(t.projectLabel){De({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=_e();i&&(i.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",ve(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(on(t.items),ge()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{En(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{En(t.technicianIds)}catch{}qe();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}H()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{tt=!1}}function As(e){if(!e)return null;let n=ia.find(a=>a.id===e)||null;if(n)return n;const t=ss(e);return t?(n={id:e,name:is(t)||e,price:rs(t),items:dn(t),raw:t},n):null}function Pt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Lt(e){return E(String(e||"")).trim().toLowerCase()}function Bs(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=E(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function ca(e){const n=E(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function da(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function la(e){if(!e)return null;const n=E(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function ua(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=E(String(n))}}function Ye(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function at(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function _e(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function he(){const{input:e,hidden:n}=_e();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function We(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function ma(e,n,{allowPartial:t=!1}={}){const a=be(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,o)=>{o.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function $t(e,n={}){return ma(Gt,e,n)}function Kt(e,n={}){return ma(Wt,e,n)}function ve(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function pa(e){ra=Array.isArray(e)?[...e]:[]}function mn(){return ra}function pn(e){return e&&mn().find(n=>String(n.id)===String(e))||null}function Ln(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function Xe(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??Ke,a=E(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:Ke}function ke(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??Ke,a=E(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=Ke),n.dataset.companyShare=String(r),n.checked=!0}function Jt(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Ft){H();return}Ft=!0;const a=()=>{Ft=!1,H()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Ke)),n.disabled){t.checked=!1,h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),ke()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?ke():t.checked&&(t.checked=!1));a()}function Ps(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function $n(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function qn(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function Ee({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=at();if(!t||!a||!r)return;const s=rn()||[],i=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const l=new Set;Gt=new Map;const u=s.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:qn(m)||o})).filter(m=>{if(!m.label)return!1;const p=be(m.label);return!p||l.has(p)?!1:(l.add(p),Gt.set(p,m),!0)}).sort((m,p)=>m.label.localeCompare(p.label,void 0,{sensitivity:"base"}));r.innerHTML=u.map(m=>`<option value="${Pt(m.label)}"></option>`).join("");const d=n?"":t.value,f=e?String(e):a.value?String(a.value):"",g=f?s.find(m=>String(m.id)===f):null;if(g){const m=qn(g)||o;a.value=String(g.id),t.value=m,t.dataset.selectedId=String(g.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":d}function De({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=_e();if(!a||!r||!s)return;const i=Array.isArray(n)?n:mn()||[],o=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const l=[...i].filter(v=>v&&v.id!=null).sort((v,b)=>String(b.createdAt||b.start||"").localeCompare(String(v.createdAt||v.start||""))),u=t?"":a.value,d=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),f=new Set;Wt=new Map;const g=l.map(v=>{const b=Ln(v)||d;return{id:String(v.id),label:b}}).filter(v=>{if(!v.label)return!1;const b=be(v.label);return!b||f.has(b)?!1:(f.add(b),Wt.set(b,v),!0)});s.innerHTML=g.map(v=>`<option value="${Pt(v.label)}"></option>`).join("");const m=e?String(e):r.value?String(r.value):"",p=m?l.find(v=>String(v.id)===m):null;if(p){const v=Ln(p)||d;r.value=String(p.id),a.value=v,a.dataset.selectedId=String(p.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":u}function Re(e,n,t){const{date:a,time:r}=Xn(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const o=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,o)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,o)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function fa(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||De({selectedValue:a});const s=(rn()||[]).find(d=>String(d.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";Ee(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=$n(e,"start"),l=$n(e,"end");o&&Re("res-start","res-start-time",o),l&&Re("res-end","res-end-time",l);const u=document.getElementById("res-notes");u&&e.description&&(n||!u.value)&&(u.value=e.description),H(),qe()}function ga({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:te(),r=Array.isArray(a)?a:[];pa(r);const s=n!=null?String(n):t.value?String(t.value):"";De({selectedValue:s,projectsList:r}),qe(),H()}function qe(){const{input:e,hidden:n}=_e(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),l=document.getElementById("res-discount-type"),u=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),f=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(We(t,he),a&&We(a,he)),r&&We(r,he),s&&We(s,he),i&&We(i,he),o&&We(o,he),l&&We(l,he),f)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),r&&(r.value="unpaid",ve(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),l&&(l.value="percent",l.disabled=!0,l.classList.add("reservation-input-disabled"),l.title=u);else{if(t){const g=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",g&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),l&&(l.disabled=!1,l.classList.remove("reservation-input-disabled"),l.title="")}Jt("tax"),H()}function fn(){const{input:e,hidden:n}=_e();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Kt(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=pn(s.id);i?fa(i,{skipProjectSelectUpdate:!0}):(qe(),H())}else n.value="",e.dataset.selectedId="",qe(),H()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Kt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Te()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function gn(){const{input:e,hidden:n}=at();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?$t(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),H()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?$t(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Te()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function Ls(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){dt({clearValue:!0});return}let t=null;try{const u=decodeURIComponent(n);t=JSON.parse(u)}catch(u){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),dt({clearValue:!1}),!t)return;t.fromProjectForm&&(It={draftStorageKey:t.draftStorageKey||aa,returnUrl:t.returnUrl||sa});const s=document.getElementById("res-project");if(t.projectId){s&&(De({selectedValue:String(t.projectId)}),qe());const u=pn(t.projectId);u?fa(u,{forceNotes:!!t.forceNotes}):H(),dt()}else{s&&De({selectedValue:""});const u=t.projectTitle?t.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");Hs(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),u)}t.start&&Re("res-start","res-start-time",t.start),t.end&&Re("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(t.customerId){const d=(rn()||[]).find(f=>String(f.id)===String(t.customerId));d?.id!=null&&(Ee({selectedValue:String(d.id)}),o&&(o.value=String(d.id)),i&&(i.value=d.customerName||d.name||i.value))}else t.customerName&&i?(Ee({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",o&&(o.value="")):Ee({selectedValue:""});const l=document.getElementById("res-notes");l&&t.description&&!l.value&&(l.value=t.description),H()}function Me(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Je(e,t),end:Je(n,a)}}function ya(e){const n=Lt(e);if(n){const o=Bt.get(n);if(o)return o}const{description:t,barcode:a}=ca(e);if(a){const o=nn(a);if(o)return o}const r=be(t||e);if(!r)return null;let s=Kn();if(!s?.length){const o=te();s=Array.isArray(o?.equipment)?o.equipment:[],s.length&&Zn(s)}const i=s.find(o=>be(o?.desc||o?.description||"")===r);return i||s.find(o=>be(o?.desc||o?.description||"").includes(r))||null}function va(e,n="equipment-description-options"){const t=Lt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(l=>Lt(l.value)===t)||Bt.has(t))return!0;const{description:r}=ca(e);if(!r)return!1;const s=be(r);return s?(Kn()||[]).some(o=>be(o?.desc||o?.description||"")===s):!1}const $s={available:0,reserved:1,maintenance:2,retired:3};function qs(e){return $s[e]??5}function Cn(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Cs(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${Cn(t)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${Cn(t)})`}function Fe(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=ln(),a=te(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];Zn(s);const i=new Map;s.forEach(u=>{const d=Bs(u),f=Lt(d);if(!f||!d)return;const g=Ne(u),m=qs(g),p=i.get(f);if(!p){i.set(f,{normalized:f,value:d,bestItem:u,bestStatus:g,bestPriority:m,statuses:new Set([g])});return}p.statuses.add(g),m<p.bestPriority&&(p.bestItem=u,p.bestStatus=g,p.bestPriority=m,p.value=d)}),Bt=new Map;const l=Array.from(i.values()).sort((u,d)=>u.value.localeCompare(d.value,"ar",{sensitivity:"base"})).map(u=>{Bt.set(u.normalized,u.bestItem);const d=Cs(u),f=Pt(u.value);if(d===u.value)return`<option value="${f}"></option>`;const g=Pt(d);return`<option value="${f}" label="${g}"></option>`}).join("");e&&(e.innerHTML=l),n&&(n.innerHTML=l)}function ha(e,n,t={}){const{silent:a=!1}=t,r=F(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=Me();if(!s||!i){const p=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||h(p),{success:!1,message:p}}const o=Ae();if(yn(o).has(r)){const p=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||h(p),{success:!1,message:p}}const u=cn(r,s,i);if(u.length){const p=u.map(b=>b.name).join(", "),v=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${p}`);return a||h(v),{success:!1,message:v}}if(Ce(r,s,i)){const p=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const v=new URLSearchParams({type:"equipment",id:r,start:s,end:i});Le(`/reservations/availability.php?${v.toString()}`).then(b=>{const q=Array.isArray(b?.conflicts)?b.conflicts:[],I=Array.from(new Set(q.map(B=>B?.reservation_code||(B?.reservation_id!=null?`#${B.reservation_id}`:null)).filter(Boolean))),S=I.length?`${p}: ${I.join("ØŒ ")}`:p;h(S)}).catch(()=>h(p))}catch{h(p)}return{success:!1,message:p}}const d=nn(r);if(!d){const p=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||h(p),{success:!1,message:p}}const f=Ne(d);if(f==="maintenance"||f==="retired"){const p=Ye(f);return a||h(p),{success:!1,message:p}}const g=Ze(d);if(!g){const p=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||h(p),{success:!1,message:p}}xt({id:g,equipmentId:g,barcode:r,desc:d.desc,qty:1,price:d.price,image:st(d)}),n&&(n.value=""),ge(),H();const m=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||h(m),{success:!0,message:m,barcode:r}}function Qt(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=ya(n);if(!t){h(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Oa(t.barcode),r=Ne(a||t);if(r==="maintenance"||r==="retired"){h(Ye(r));return}const s=F(t.barcode);if(!s){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=Ze(t);if(!i){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,image:st(t)},{start:l,end:u}=Me();if(!l||!u){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const d=Ae();if(yn(d).has(s)){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const g=cn(s,l,u);if(g.length){const m=g.map(p=>p.name).join(", ");h(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(Ce(s,l,u)){const m=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const p=new URLSearchParams({type:"equipment",id:s,start:l,end:u});Le(`/reservations/availability.php?${p.toString()}`).then(v=>{const b=Array.isArray(v?.conflicts)?v.conflicts:[],q=Array.from(new Set(b.map(S=>S?.reservation_code||(S?.reservation_id!=null?`#${S.reservation_id}`:null)).filter(Boolean))),I=q.length?`${m}: ${q.join("ØŒ ")}`:m;h(I)}).catch(()=>h(m))}catch{h(m)}return}xt(o),ge(),H(),h(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function _s(){Fe();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Qt(e))});const n=()=>{va(e.value,"equipment-description-options")&&Qt(e)};e.addEventListener("focus",()=>{if(Fe(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function _n(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function yn(e=Ae()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=F(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=F(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function xs(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=Me();if(!n||!t){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}ds({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):h(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(ta.change,n=>{_n(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),_n(e,us()))}function js(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,o=null;const l=[],u=new Set;s.forEach(f=>{const g=F(f);g&&!u.has(g)&&(u.add(g),l.push(g))});const d=Math.min(r,l.length);for(let f=0;f<d;f+=1){const g=l[f],m=ha(g,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const g=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",E(String(i)));h(g)}else o&&h(o)}function ba(){xs(),!(Pn||typeof document>"u")&&(document.addEventListener(ta.requestAdd,js),Pn=!0)}function gt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function Yt(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=gt();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=n==="package";s&&(s.disabled=o),i&&(i.disabled=o),r&&(r.disabled=n!=="package"||r.options.length===0),os(n),n==="package"&&Tt()}function Tt(){const{packageSelect:e,packageHint:n}=gt();if(!e)return;const t=Wn();ia=t,ns(t.map(o=>o.raw??o));const a=c("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(o=>{const l=Number.isFinite(Number(o.price))?Number(o.price):0,u=E(l.toFixed(2)),d=`${o.name} â€” ${u} ${a}`;return`<option value="${o.id}">${d}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),Ea()}function Ts(e,n){const t=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const o=s?.desc||E(String(s?.barcode??s?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const l=i.map(u=>u.name).join(", ");return`â€¢ ${o} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${l})`}return`â€¢ ${o} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function Ia(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=Qe(e);if(!s)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=As(s);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(m=>m?.type==="package"&&Qe(m.packageId)===s))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(Jn(s,t,a,r)){const m=i.name||s;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:dn(i.raw??{}),l=yn(n),u=[],d=new Set;if(o.forEach(m=>{const p=F(m?.normalizedBarcode??m?.barcode);if(p){if(d.has(p)){u.push({item:m,type:"internal"});return}d.add(p),l.has(p)&&u.push({item:m,type:"external"})}}),u.length){const m=u.map(({item:v})=>v?.desc||v?.description||v?.name||v?.barcode||v?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(v=>E(String(v))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(v=>v.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:u}}const f=[];return o.forEach(m=>{const p=F(m?.normalizedBarcode??m?.barcode);if(p&&Ce(p,t,a,r)){const v=cn(p,t,a,r);f.push({item:m,blockingPackages:v})}}),f.length?{success:!1,reason:"item_conflict",message:Ts(i,f),conflicts:f}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:F(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function Sa(e,{silent:n=!1}={}){const t=Qe(e);if(!t)return n||h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=Me(),s=Ae(),i=Ia(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const l={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");h(i.message||l)}return i}return xt(i.package),ge(),H(),n||h(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function Ea(){const{packageSelect:e}=gt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;Sa(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Ns(){const{packageAddButton:e,packageSelect:n}=gt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Sa(t)}),e.dataset.listenerAttached="true")}function wa(){const{modeRadios:e}=gt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&Yt(r.target.value)}),a.dataset.listenerAttached="true")}),Ns(),Ea();const n=At(),t=e.find(a=>a.value===n);t&&(t.checked=!0),Yt(n)}function ge(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=Ae(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),l=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="6" class="text-center">${a}</td></tr>`;return}const u=sn(t);n.innerHTML=u.map(d=>{const f=d.items[0]||{},g=st(f)||d.image,m=g?`<img src="${g}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',p=E(String(d.count)),v=Number.isFinite(Number(d.unitPrice))?Number(d.unitPrice):0,b=(()=>{try{const{start:C,end:W}=Me(),L=zt(C,W);return Number.isFinite(L)&&L>0?L:1}catch{return 1}})(),q=E(String(b)),I=v*d.count*b,S=`${E(v.toFixed(2))} ${r}`,B=`${E(I.toFixed(2))} ${r}`,y=d.items.some(C=>C?.type==="package"),w=d.barcodes.map(C=>E(String(C||""))).filter(Boolean),T=w.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${w.map(C=>`<li>${C}</li>`).join("")}
            </ul>
          </details>`:"";let P="";if(y){const C=new Map;if(d.items.forEach(W=>{Array.isArray(W?.packageItems)&&W.packageItems.forEach(L=>{if(!L)return;const _=F(L.barcode||L.desc||Math.random()),z=C.get(_);if(z){z.qty+=Number.isFinite(Number(L.qty))?Number(L.qty):1;return}C.set(_,{desc:L.desc||L.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(L.qty))?Number(L.qty):1,barcode:L.barcode??L.normalizedBarcode??""})})}),C.size){const W=Array.from(C.values()).map(L=>{const _=E(String(L.qty)),z=L.desc||E(String(L.barcode||"")),N=L.barcode?` <span class="reservation-package-items__barcode">(${E(String(L.barcode))})</span>`:"";return`<li>${z}${N} Ã— ${_}</li>`}).join("");P=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${W}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${d.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${d.description||"-"}</div>
                ${y?`${P||""}${T||""}`:T}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${d.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${d.key}" aria-label="${o}" ${y?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${d.key}" aria-label="${i}" ${y?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${q}</span></td>
          <td>${S}</td>
          <td>${B}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${d.key}" aria-label="${l}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Ds(e){const n=Ae(),a=sn(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(as(r),ge(),H())}function Rs(e){const n=Ae(),t=n.filter(a=>pt(a)!==e);t.length!==n.length&&(on(t),ge(),H())}function Fs(e){const n=Ae(),a=sn(n).find(f=>f.key===e);if(!a)return;const{start:r,end:s}=Me();if(!r||!s){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(f=>F(f.barcode))),{equipment:o=[]}=te(),l=(o||[]).find(f=>{const g=F(f?.barcode);return!g||i.has(g)||pt({desc:f?.desc||f?.description||f?.name||"",price:Number(f?.price)||0})!==e||!Vn(f)?!1:!Ce(g,r,s)});if(!l){h(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=F(l.barcode),d=Ze(l);if(!d){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}xt({id:d,equipmentId:d,barcode:u,desc:l.desc||l.description||l.name||a.description||"",qty:1,price:Number.isFinite(Number(l.price))?Number(l.price):a.unitPrice,image:st(l)}),ge(),H()}function H(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(E(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,o=document.getElementById("res-payment-status"),l=o?.value||"unpaid",{start:u,end:d}=Me();i&&ke();const f=Xe(),g=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),p=da(g),v=la(m);an(),Sn({selectedItems:Ae(),discount:t,discountType:r,applyTax:i,paidStatus:l,paymentProgressType:p,paymentProgressValue:v,start:u,end:d,companySharePercent:f,paymentHistory:[]});const b=Sn.lastResult;b?(ua(m,b.paymentProgressValue),o&&(o.value=b.paymentStatus,ve(o,b.paymentStatus))):ve(o,l);try{Te()}catch{}}function Ms(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=E(o.target.value),H()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",H),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if(he()){t.checked=!1,h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Jt("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(he()){a.checked=!1,h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Jt("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(he()){r.value="unpaid",ve(r,"unpaid"),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ve(r),H()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",o=>{if(he()){s.value="percent",h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",H()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(he()){i.value="",h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=E(o.target.value),H()}),i.dataset.listenerAttached="true"),H()}function Vs(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const o=()=>{try{Te()}catch{}},l=()=>{try{ge(),H()}catch{}};s.addEventListener("input",o),s.addEventListener("change",o),s.addEventListener("input",l),s.addEventListener("change",l),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const o=()=>{try{Te()}catch{}},l=()=>{try{ge(),H()}catch{}};i.addEventListener("input",o),i.addEventListener("change",o),i.addEventListener("input",l),i.addEventListener("change",l),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){H();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),H();try{ge()}catch{}};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{Te()}catch{}try{ge(),H()}catch{}}});const r=()=>{try{Te()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function xn(){const{input:e,hidden:n}=at(),{input:t,hidden:a}=_e(),{customers:r}=te();let s=n?.value?String(n.value):"";if(!s&&e?.value){const A=$t(e.value,{allowPartial:!0});A&&(s=String(A.id),n&&(n.value=s),e.value=A.label,e.dataset.selectedId=s)}const i=r.find(A=>String(A.id)===s);if(!i){h(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let l=a?.value?String(a.value):"";if(!l&&t?.value){const A=Kt(t.value,{allowPartial:!0});A&&(l=String(A.id),a&&(a.value=l),t.value=A.label,t.dataset.selectedId=l)}const u=document.getElementById("res-start").value,d=document.getElementById("res-end").value,f=document.getElementById("res-start-time")?.value||"00:00",g=document.getElementById("res-end-time")?.value||"00:00";if(!u||!d){h(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const m=`${u}T${f}`,p=`${d}T${g}`,v=new Date(m),b=new Date(p);if(Number.isNaN(v.getTime())||Number.isNaN(b.getTime())||v>=b){h(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const q=an();q.map(A=>A.technicianId).filter(Boolean);const I=Ae();if(I.length===0&&q.length===0){h(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const S=document.getElementById("res-notes")?.value||"",B=parseFloat(E(document.getElementById("res-discount")?.value))||0,y=document.getElementById("res-discount-type")?.value||"percent",w=document.getElementById("res-payment-status"),T=w?.value||"unpaid",P=document.getElementById("res-payment-progress-type"),C=document.getElementById("res-payment-progress-value"),W=da(P),L=la(C),_=l?pn(l):null,z=Ps(_);if(l&&!_){h(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const A of I){const R=Ne(A.barcode);if(R==="maintenance"||R==="retired"){h(Ye(R));return}}const N=[];for(const A of I){const R=F(A.barcode);if(Ce(R,m,p)){const ne=A?.desc||A?.name||A?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");N.push({label:E(String(ne)),barcode:R})}}if(N.length){const A=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let R=null;try{const Y=Array.from(new Set(N.map(Z=>Z.barcode).filter(Boolean))),fe=new Map;await Promise.all(Y.map(async Z=>{const se=new URLSearchParams({type:"equipment",id:Z,start:m,end:p}),ue=await Le(`/reservations/availability.php?${se.toString()}`),Be=Array.isArray(ue?.conflicts)?ue.conflicts:[],Ue=Array.from(new Set(Be.map(k=>k?.reservation_code||(k?.reservation_id!=null?`#${k.reservation_id}`:null)).filter(Boolean)));fe.set(Z,Ue)})),R=N.map(({label:Z,barcode:se})=>{const ue=fe.get(se)||[];return ue.length?`${Z} (${ue.join("ØŒ ")})`:Z}).join("ØŒ ")}catch{}const ne=R||N.map(Y=>Y.label).filter(Boolean).map(String).join("ØŒ ");h(`${A}: ${ne}`,"warning",6e3);return}const $=[];for(const A of I){if(A?.type!=="package")continue;const R=A.packageId??A.package_id??null;if(R&&Jn(R,m,p)){const ne=A.desc||A.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let Y=[];try{const fe=new URLSearchParams({type:"package",id:String(R),start:m,end:p}),Z=await Le(`/reservations/availability.php?${fe.toString()}`),se=Array.isArray(Z?.conflicts)?Z.conflicts:[];Y=Array.from(new Set(se.map(ue=>ue?.reservation_code||(ue?.reservation_id!=null?`#${ue.reservation_id}`:null)).filter(Boolean)))}catch{}$.push({label:E(String(ne)),codes:Y})}}if($.length){const A=$.map(({label:ne,codes:Y})=>Y&&Y.length?`${ne} (${Y.join("ØŒ ")})`:ne).join("ØŒ "),R=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");h(`${R}: ${A}`,"warning",6e3);return}const j=[];for(const A of q){if(!A?.technicianId||!Qn(A.technicianId,m,p))continue;const R=A?.technicianName||A?.positionLabel||String(A.technicianId);let ne=[];try{ne=Yn(A.technicianId,m,p,null)}catch{}j.push({label:E(String(R)),codes:ne})}if(j.length){const A=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),R=j.map(({label:ne,codes:Y})=>Y&&Y.length?`${ne} (${Y.join("ØŒ ")})`:ne).join("ØŒ ");h(`${A}: ${R}`);return}const J=document.getElementById("res-tax"),O=document.getElementById("res-company-share"),U=!!l;U?(J&&(J.checked=!1,J.disabled=!0,J.classList.add("disabled"),J.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),O&&(O.checked=!1,O.disabled=!0,O.classList.add("disabled"),O.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),w&&(w.value="unpaid",w.disabled=!0,ve(w,"unpaid"),w.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),P&&(P.disabled=!0,P.classList.add("disabled")),C&&(C.value="",C.disabled=!0,C.classList.add("disabled"))):(J&&(J.disabled=!1,J.classList.remove("disabled"),J.title=""),O&&(O.disabled=!1,O.classList.remove("disabled"),O.title=""),w&&(w.disabled=!1,w.title=""),P&&(P.disabled=!1,P.classList.remove("disabled")),C&&(C.disabled=!1,C.classList.remove("disabled")));const G=U?!1:J?.checked||!1,ce=!!O?.checked;if(!U&&ce!==G){h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let x=ce?Xe():null;ce&&(!Number.isFinite(x)||x<=0)&&(ke(),x=Xe());const ye=ce&&G&&Number.isFinite(x)&&x>0;G&&ke();const de=zn(I,B,y,G,q,{start:m,end:p,companySharePercent:ye?x:0}),xe=Ma(),Q=wt({totalAmount:de,progressType:W,progressValue:L,history:[]});C&&ua(C,Q.paymentProgressValue);const He=[];Q.paymentProgressValue!=null&&Q.paymentProgressValue>0&&He.push({type:Q.paymentProgressType||W,value:Q.paymentProgressValue,amount:Q.paidAmount,percentage:Q.paidPercent,recordedAt:new Date().toISOString()});const Oe=kt({manualStatus:T,paidAmount:Q.paidAmount,paidPercent:Q.paidPercent,totalAmount:de});w&&(w.value=Oe,ve(w,Oe));const pe=typeof _?.paymentStatus=="string"?_.paymentStatus.toLowerCase():null,rt=pe&&["paid","partial","unpaid"].includes(pe)?pe:"unpaid",le=Hn({reservationCode:xe,customerId:o,start:m,end:p,status:z?"confirmed":"pending",title:null,location:null,notes:S,projectId:l||null,totalAmount:de,discount:U?0:B,discountType:U?"percent":y,applyTax:G,paidStatus:U?rt:Oe,confirmed:z,items:I.map(A=>({...A,equipmentId:A.equipmentId??A.id})),crewAssignments:q,companySharePercent:U||!ye?null:x,companyShareEnabled:U?!1:ye,paidAmount:U?0:Q.paidAmount,paidPercentage:U?0:Q.paidPercent,paymentProgressType:U?null:Q.paymentProgressType,paymentProgressValue:U?null:Q.paymentProgressValue,paymentHistory:U?[]:He});try{Bn("about to submit",{crewAssignments:q,techniciansPayload:le?.technicians,payload:le});const A=await Ua(le);Bn("server response",{reservation:A?.id??A?.reservationId??A?.reservation_code,technicians:A?.technicians,crewAssignments:A?.crewAssignments,techniciansDetails:A?.techniciansDetails}),ln(),Fe(),ut(),ka(),h(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const R=document.getElementById("sub-tab-trigger-my-reservations-tab");R&&typeof R.click=="function"&&setTimeout(()=>R.click(),0)}catch{}typeof Ut=="function"&&Ut({type:"created",reservation:A}),zs(A)}catch(A){console.error("âŒ [reservations/createForm] Failed to create reservation",A);const R=On(A)?A.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");h(R,"error"),U&&(h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),dt({clearValue:!1}))}}function zs(e){if(!It)return;const{draftStorageKey:n=aa,returnUrl:t=sa}=It,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}It=null,t&&(window.location.href=t)}function dt({clearValue:e=!1}={}){const{input:n,hidden:t}=_e();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,qe())}function Hs(e,n=""){const{input:t,hidden:a}=_e();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),qe())}function ka(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),Ee({selectedValue:"",resetInput:!0});try{Re("res-start","res-start-time","")}catch{}try{Re("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),dt({clearValue:!1}),De({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",ve(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),Ga(),on([]),ls("form-reset"),ge(),qe(),H(),oa()}function Os(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",n=>{const t=n.target.closest("button[data-action]");if(!t)return;const{action:a,groupKey:r}=t.dataset;if(a==="decrease-group"&&r){Ds(r);return}if(a==="increase-group"&&r){Fs(r);return}if(a==="remove-group"&&r){Rs(r);return}}),e.dataset.listenerAttached="true")}function Us(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(At()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,ha(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||At()!=="single")return;const{start:s,end:i}=Me();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function Gs(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await xn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await xn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),ka();try{oa()}catch{}h(c("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function Rr({onAfterSubmit:e}={}){Ut=typeof e=="function"?e:null,tt=!0;const{customers:n,projects:t}=te();cs(n||[]),Ee(),gn(),pa(t||[]),ga({projectsList:t}),fn(),Fe(),Tt(),_s(),ba(),wa(),Vs(),Ms(),Os(),Us(),Gs(),ks(),Ls(),H(),ge();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Te()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}tt=!1}function Aa(){Fe(),Tt(),ga(),Ee(),gn(),fn(),ba(),wa(),ge(),H()}if(typeof document<"u"){const e=()=>{Ee(),De({projectsList:mn()}),gn(),fn(),H()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Fe()}),document.addEventListener("packages:changed",()=>{Tt(),At()==="package"&&Yt("package")})}typeof window<"u"&&(window.getCompanySharePercent=Xe);function bt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function Ws(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function Ks(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=Ws(t);if(a!==null)return a}return null}function jn(e,n=0){const t=Ks(e);if(t!=null)return t;const a=bt(e.createdAt??e.created_at);if(a!=null)return a;const r=bt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=bt(e.start);if(s!=null)return s;const i=bt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(n)?n:0}function Js({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((I,S)=>({reservation:I,index:S})),i=n.searchTerm||"",o=n.searchReservationId||"",l=n.searchCustomerName||"",u=n.searchProjectId||"",d=n.startDate||"",f=n.endDate||"",g=n.status||"",m=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,p=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,v=d?new Date(`${d}T00:00:00`):null,b=f?new Date(`${f}T23:59:59`):null,q=s.filter(({reservation:I})=>{const S=t.get(String(I.customerId)),B=r?.get?.(String(I.projectId)),y=I.start?new Date(I.start):null,w=Un(I),{effectiveConfirmed:T}=ft(I,B);if(m!=null&&String(I.customerId)!==String(m)||p!=null&&!(Array.isArray(I.technicians)?I.technicians.map(_=>String(_)):[]).includes(String(p))||g==="confirmed"&&!T||g==="pending"&&T||g==="completed"&&!w)return!1;if(g==="cancelled"){const L=String(I?.status||I?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(L))return!1}if(v&&y&&y<v||b&&y&&y>b)return!1;if(o){const L=[I.reservationId,I.id,I.reservation_id,I.reservationCode,I.reservation_code,I.code,I.reference,I.referenceNumber,I.reference_number],_=be(L.filter(N=>N!=null&&N!=="").map(String).join(" ")).replace(/\s+/g,""),z=o.replace(/\s+/g,"");if(!_.includes(z))return!1}if(l&&!be(S?.customerName||I.customerName||"").includes(l))return!1;if(u){const L=[I.projectId,I.project_id,I.projectID,B?.id,B?.projectCode,B?.project_code],_=be(L.filter(N=>N!=null&&N!=="").map(String).join(" ")).replace(/\s+/g,""),z=u.replace(/\s+/g,"");if(!_.includes(z))return!1}if(!i)return!0;const P=I.items?.map?.(L=>`${L.barcode} ${L.desc}`).join(" ")||"",C=(I.technicians||[]).map(L=>a.get(String(L))?.name).filter(Boolean).join(" ");return be([I.reservationId,S?.customerName||I.customerName,I.notes,P,C,B?.title].filter(Boolean).join(" ")).includes(i)});return q.sort((I,S)=>{const B=jn(I.reservation,I.index),y=jn(S.reservation,S.index);return B!==y?y-B:S.index-I.index}),q}function Qs({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=c("reservations.create.summary.currency","SR"),s=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),l=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),u=c("reservations.list.crew.separator","ØŒ "),d=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),f=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),g=c("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),m=c("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),p=c("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),v=c("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),b=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),q=c("reservations.list.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),I=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),S=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),B={client:c("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:y,index:w})=>{const T=n.get(String(y.customerId)),P=y.projectId?a?.get?.(String(y.projectId)):null,C=Un(y),W=y.items?.length||0,L=Array.isArray(y.crewAssignments)?y.crewAssignments:[],_=(y.technicians||[]).map(ie=>t.get(String(ie))).filter(Boolean),z=L.length?L.map(ie=>{const Pe=ie.positionLabel??ie.position_name??ie.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),it=ie.technicianName??t.get(String(ie.technicianId??""))?.name??null;return it?`${E(Pe)} (${E(it)})`:E(Pe)}):_.map(ie=>ie.name),N=z.length?z.join(u):"â€”",$=E(String(y.reservationId??"")),j=y.start?E(Vt(y.start)):"-",J=y.end?E(Vt(y.end)):"-",O=y.discount??y.discountValue??y.discount_value??y.discountAmount??0,U=Number.parseFloat(E(String(O))),G=Number.isFinite(U)?U:0,ce=y.discountType??y.discount_type??y.discountMode??"percent",x=String(ce).toLowerCase()==="amount"?"amount":"percent",ye=!!(y.applyTax??y.apply_tax??y.taxApplied),de=y.companySharePercent??y.company_share_percent??y.companyShare??y.company_share,xe=y.companyShareEnabled??y.company_share_enabled??y.companyShareApplied,Q=Number.parseFloat(E(String(de))),Oe=(xe===!0||Number.isFinite(Q)&&Q>0)&&Number.isFinite(Q)?Q:0;let pe=0;try{const ie=Ka({items:y.items||[],technicianIds:y.technicians||[],crewAssignments:Array.isArray(y.crewAssignments)?y.crewAssignments:[],discount:G,discountType:x,applyTax:ye,start:y.start,end:y.end,companySharePercent:Oe,groupingSource:y}),Pe=Number(ie?.finalTotal||0);pe=Number.isFinite(Pe)?Number(Pe.toFixed(2)):0}catch{pe=0}const rt=Number.parseFloat(E(String(y.cost??0)))||0,le=pe>0?pe:rt,A=y.paymentHistory||y.payment_history||[],R=wt({totalAmount:le,paidAmount:A.length?0:y.paidAmount,paidPercent:A.length?0:y.paidPercent,history:A});let Y=kt({manualStatus:null,paidAmount:R.paidAmount,paidPercent:R.paidPercent,totalAmount:le});if(P)try{const{totalWithTax:ie}=ys(P)||{totalWithTax:0},Pe=P.paymentHistory||P.payments||[],it=wt({totalAmount:ie,paidAmount:Pe.length?0:P.paidAmount,paidPercent:Pe.length?0:P.paidPercent,history:Pe}),bn=kt({manualStatus:null,paidAmount:it.paidAmount,paidPercent:it.paidPercent,totalAmount:ie});bn&&(Y=bn)}catch{}const fe=Y==="paid",Z=Y==="partial",{effectiveConfirmed:se,projectLinked:ue}=ft(y,P),Be=se?"status-confirmed":"status-pending",Ue=fe?"status-paid":Z?"status-partial":"status-unpaid";let k=`<span class="reservation-chip status-chip ${Be}">${se?d:f}</span>`;const D=fe?m:Z?v:p;let M=`<span class="reservation-chip status-chip ${Ue}">${D}</span>`,V=fe?" tile-paid":Z?" tile-partial":" tile-unpaid";C&&(V+=" tile-completed");let ae="";C&&(k=`<span class="reservation-chip status-chip status-completed">${g}</span>`,M=`<span class="reservation-chip status-chip status-completed">${D}</span>`,ae=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`);let X="";!ue&&!se?X=`<button class="tile-confirm" data-reservation-index="${w}" data-action="confirm">${b}</button>`:!ue&&se&&!C&&(X=`<button class="tile-confirm" data-reservation-index="${w}" data-action="close">${q}</button>`);const re=X?`<div class="tile-actions">${X}</div>`:"",K=E(le.toFixed(2)),me=E(String(W)),Ge=y.notes?E(y.notes):o,ee=l.replace("{count}",me),yt=y.applyTax?`<small>${s}</small>`:"";let vt=I;return y.projectId&&(vt=P?.title?E(P.title):S),`
      <div class="${X?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${V}"${ae} data-reservation-index="${w}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${$}</div>
          <div class="tile-badges">
            ${k}
            ${M}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${B.client}</span>
            <span class="tile-value">${T?.customerName||y.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${B.project}</span>
            <span class="tile-value">${vt}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${B.start}</span>
            <span class="tile-value tile-inline">${j}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${B.end}</span>
            <span class="tile-value tile-inline">${J}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${B.cost}</span>
            <span class="tile-value">${K} ${r} ${yt}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${B.equipment}</span>
            <span class="tile-value">${ee}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${B.crew}</span>
            <span class="tile-value">${z.length?N:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${Ge}</span>
          </div>
        </div>
        ${re}
      </div>
    `}).join("")}function Ys({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a,onCloseReservation:r}={}){const s=ut(),{reservations:i=[],customers:o=[],technicians:l=[],projects:u=[]}=te(),d=i.map(S=>{const B=Ht(S);return{...B,id:S.id??B.id,reservationId:S.reservationId??S.reservation_id??B.reservationId,reservationCode:S.reservationCode??S.reservation_code??B.reservationCode}}),f=d,g=Array.isArray(s)?s:l||[],m=new Map((u||[]).map(S=>[String(S.id),S])),p=document.getElementById(e);if(!p){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!f||f.length===0){p.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const v=n||ps(),b=new Map(o.map(S=>[String(S.id),S])),q=new Map(g.map(S=>[String(S.id),S])),I=Js({reservations:d,filters:v,customersMap:b,techniciansMap:q,projectsMap:m});if(I.length===0){p.innerHTML=`<p>${c("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}p.innerHTML=`<div class="reservations-grid">${Qs({entries:I,customersMap:b,techniciansMap:q,projectsMap:m})}</div>`,p.querySelectorAll('[data-action="details"]').forEach(S=>{const B=Number(S.dataset.reservationIndex);Number.isNaN(B)||S.addEventListener("click",()=>{typeof t=="function"&&t(B)})}),p.querySelectorAll('button[data-action="confirm"]').forEach(S=>{const B=Number(S.dataset.reservationIndex);Number.isNaN(B)||S.addEventListener("click",y=>{y.stopPropagation(),typeof a=="function"&&a(B,y)})}),p.querySelectorAll('button[data-action="close"]').forEach(S=>{const B=Number(S.dataset.reservationIndex);Number.isNaN(B)||S.addEventListener("click",y=>{y.stopPropagation(),typeof r=="function"&&r(B,y)})})}function Xs(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=te(),o=r.map(v=>{const b=Ht(v);return{...b,id:v.id??b.id,reservationId:v.reservationId??v.reservation_id??b.reservationId,reservationCode:v.reservationCode??v.reservation_code??b.reservationCode}}),l=r[e];if(!l)return h(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const u=o[e]??Ht(l),d=s.find(v=>String(v.id)===String(l.customerId)),f=l.projectId?i.find(v=>String(v.id)===String(l.projectId)):null,g=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),p=()=>{const v=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},b=document.getElementById("reservation-details-edit-btn");b&&(b.onclick=()=>{v(),typeof n=="function"&&n(e,{reservation:l,customer:d,getEditContext:a})});const q=document.getElementById("reservation-details-delete-btn");q&&(q.onclick=()=>{v(),typeof t=="function"&&t(e,{reservation:l,customer:d})});const I=g?.querySelector('[data-action="open-project"]');I&&f&&I.addEventListener("click",()=>{v();const y=f?.id!=null?String(f.id):"",w=y?`projects.html?project=${encodeURIComponent(y)}`:"projects.html";window.location.href=w});const S=document.getElementById("reservation-details-export-btn");S&&(S.onclick=async y=>{y?.preventDefault?.(),y?.stopPropagation?.(),S.blur();try{await fs({reservation:l,customer:d,project:f})}catch(w){console.error("âŒ [reservations] export to PDF failed",w),h(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const B=document.getElementById("reservation-details-checklist-btn");B&&(B.onclick=async y=>{y?.preventDefault?.(),y?.stopPropagation?.(),B.blur();try{await gs({reservation:l,customer:d,project:f})}catch(w){console.error("âŒ [reservations] export checklist PDF failed",w),h(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const y=g?.querySelector("[data-tech-slider]");if(y){const w=y.querySelector("[data-slider-track]"),T=y.querySelector("[data-slider-prev]"),P=y.querySelector("[data-slider-next]");if(w&&(T||P)){const C=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",W=()=>{const z=w.querySelector(".reservation-technician-card"),N=z&&z.getBoundingClientRect().width||220,$=12,j=Math.max(1,Math.floor(w.clientWidth/(N+$)));return Math.max(N+$,Math.floor(j*(N+$)*.9))},L=()=>{const z=Math.max(0,w.scrollWidth-w.clientWidth-2),N=w.scrollLeft<=1,$=w.scrollLeft>=z;T&&(T.disabled=N),P&&(P.disabled=$)},_=z=>{const N=W()*z,$=C?-N:N;w.scrollBy({left:$,behavior:"smooth"})};T?.addEventListener("click",()=>_(-1)),P?.addEventListener("click",()=>_(1)),w.addEventListener("scroll",L,{passive:!0}),window.addEventListener("resize",L,{passive:!0}),setTimeout(L,0)}}}catch{}};if(g){const v=ut()||[];g.innerHTML=In(u,d,v,e,f),p(),ea().then(()=>{const b=ut()||[];g.innerHTML=In(u,d,b,e,f),p()}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function et(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Je(e,t),end:Je(n,a)}}function qt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function vn(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Ba(){const{container:e,select:n,hint:t,addButton:a}=vn();if(!n)return;const r=n.value,s=Wn(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,l=s.map(d=>{const f=Number.isFinite(Number(d.price))?Number(d.price):0,g=E(f.toFixed(2)),m=`${d.name} â€” ${g} ${i}`;return`<option value="${qt(d.id)}">${qt(m)}</option>`}).join("");n.innerHTML=`${o}${l}`;const u=s.length>0;n.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),t&&(u?(t.textContent=c("reservations.create.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),u&&r&&s.some(d=>d.id===r)?n.value=r:n.selectedIndex=0}function Zs(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=we(),{start:s,end:i}=et(),{reservations:o=[]}=te(),l=a!=null&&o[a]||null,u=l?.id??l?.reservationId??null,d=Ia(t,{existingItems:r,start:s,end:i,ignoreReservationId:u});if(!d.success)return n||h(d.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),d;const f=[...r,d.package];return ze(a,f),Ve(f),Ie(),n||h(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),d}function Tn(){const{select:e}=vn();if(!e)return;const n=e.value||"";Zs(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function er(){const{addButton:e,select:n}=vn();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Tn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Tn())}),n.dataset.listenerAttached="true"),Ba()}function Ve(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="6" class="text-center">${t}</td></tr>`,Dn(n);return}const{groups:l}=_t({items:e});n.innerHTML=l.map(u=>{const d=u.items[0]||{},f=st(d)||u.image,g=f?`<img src="${f}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',m=String(u?.type||"").toLowerCase()==="package"||u.items.some(_=>_?.type==="package"),p=E(String(u.count)),v=wn(u.unitPrice),b=Number.isFinite(v)?kn(v):0,q=(()=>{try{const{start:_,end:z}=et(),N=typeof zt=="function"?zt(_,z):1;return Number.isFinite(N)&&N>0?N:1}catch{return 1}})(),I=wn(u.totalPrice),S=Number.isFinite(I)?I:b*(Number.isFinite(u.count)?u.count:1)*q,B=kn(S),y=`${E(b.toFixed(2))} ${a}`,w=`${E(B.toFixed(2))} ${a}`,T=u.barcodes.map(_=>E(String(_||""))).filter(Boolean),P=T.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${T.map(_=>`<li>${_}</li>`).join("")}
            </ul>
          </details>`:"";let C="";if(m){const _=new Map,z=$=>{const j=Number.parseFloat(E(String($??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(j)||j<=0||j>99?1:Math.round(j)},N=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&N.push(...u.packageItems),u.items.forEach($=>{Array.isArray($?.packageItems)&&N.push(...$.packageItems)}),N.forEach($=>{if(!$)return;const j=F($.barcode||$.normalizedBarcode||$.desc||Math.random());if(!j)return;const J=_.get(j),O=z($.qtyPerPackage??$.perPackageQty??$.quantityPerPackage??$.qty??$.quantity??1),U=Math.max(1,Math.min(O,99));if(J){J.qty=U;return}_.set(j,{desc:$.desc||$.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:U,barcode:$.barcode??$.normalizedBarcode??""})}),_.size){const $=Array.from(_.values()).map(j=>{const J=E(String(j.qty>0?Math.min(j.qty,99):1)),O=qt(j.desc||""),U=j.barcode?` <span class="reservation-package-items__barcode">(${qt(E(String(j.barcode)))})</span>`:"";return`<li>${O}${U} Ã— ${J}</li>`}).join("");C=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${$}
              </ul>
            </details>
          `}}const W=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",L=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${g}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${m?`${C||""}${P||""}`:P}
              </div>
            </div>
          </td>
          <td>
            <div class="${W}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${i}"${L}>âˆ’</button>
              <span class="reservation-qty-value">${p}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${s}"${L}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${E(String(q))}</span></td>
          <td>${y}</td>
          <td>${w}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${o}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Dn(n)}function tr(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Nt(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Dt();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(te()?.projects||[]).find(l=>String(l.id)===String(t)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(n=o)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Nn();return}const a=c("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const o=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${E(Number(s.amount).toFixed(2))} ${a}`:"â€”",l=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${E(Number(s.percentage).toFixed(2))}%`:"â€”",u=s?.recordedAt?E(Vt(s.recordedAt)):"â€”",d=tr(s?.type),f=s?.note?E(s.note):"";return`
      <tr>
        <td>${d}</td>
        <td>${o}</td>
        <td>${l}</td>
        <td>${u}</td>
        <td>${f}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Nn()}function nr(){if(mt()){h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=$a(e);let a=qa(n);if(!Number.isFinite(a)||a<=0){h(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=Ot.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,o=Number(r?.paidAmount)||0,l=c("reservations.create.summary.currency","SR");let u=null,d=null;if(t==="percent"){const g=Math.max(0,100-i);if(g<=1e-4){h(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const p=E(m.toFixed(2));h(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",p)),a=m}d=Number(a.toFixed(2)),s>0&&(u=a/100*s)}else{const g=Math.max(0,s-o);if(g<=1e-4){h(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const p=`${E(m.toFixed(2))} ${l}`;h(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",p)),a=m}u=Number(a.toFixed(2)),s>0&&(d=u/s*100)}u!=null&&(u=Number(u.toFixed(2))),d!=null&&(d=Number(d.toFixed(2)));const f={type:t,value:a,amount:u,percentage:d,recordedAt:new Date().toISOString()};gr(f),hn(Dt()),Nt(),Ie(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),h(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Nn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(mt()){t.preventDefault(),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}nr()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(mt()){t.preventDefault(),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(yr(r),hn(Dt()),Nt(),Ie(),h(c("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function ar(e){const{index:n,items:t}=we(),{groups:a}=_t({items:t}),r=a.find(o=>o.key===e);if(!r||r.items.some(o=>o?.type==="package"))return;let s=-1;for(let o=t.length-1;o>=0;o-=1){const l=t[o];if(pt(l)===e&&l?.type!=="package"){s=o;break}}if(s<0)return;const i=t.filter((o,l)=>l!==s);ze(n,i),Ve(i),Ie()}function sr(e){const{index:n,items:t}=we(),{groups:a}=_t({items:t}),r=a.find(o=>o.key===e);if(!r)return;let s=t.filter(o=>pt(o)!==e);if(r.items.some(o=>o&&o.type==="package")){const o=Qe(r.packageId??r.items.find(f=>f?.type==="package")?.packageId??""),l=F(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(f=>{if(!f||typeof f!="object"||f.type!=="package")return!0;const g=Qe(f.packageId??f.package_id??f.id??""),m=F(f.barcode??f.package_code??"");return!(o&&g===o||l&&m&&m===l)});const u=new Set,d=new Set;r.items.forEach(f=>{(Array.isArray(f?.packageItems)?f.packageItems:[]).forEach(m=>{const p=F(m?.barcode||m?.normalizedBarcode||"");p&&u.add(p);const v=m?.equipmentId??m?.equipment_id??null;v!=null&&d.add(String(v))})}),(u.size||d.size)&&(s=s.filter(f=>{const g=F(f?.barcode||""),m=f?.equipmentId??f?.id??null;return!(g&&u.has(g)||m!=null&&d.has(String(m)))}))}s.length!==t.length&&(ze(n,s),Ve(s),Ie())}function rr(e){const{index:n,items:t}=we(),{groups:a}=_t({items:t}),r=a.find(b=>b.key===e);if(!r||r.items.some(b=>b?.type==="package"))return;const{start:s,end:i}=et();if(!s||!i){h(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=te(),l=n!=null&&o[n]||null,u=l?.id??l?.reservationId??null,d=new Set(t.map(b=>F(b.barcode))),{equipment:f=[]}=te(),g=(f||[]).find(b=>{const q=F(b?.barcode);return!q||d.has(q)||pt({desc:b?.desc||b?.description||b?.name||"",price:Number(b?.price)||0})!==e||!Vn(b)?!1:!Ce(q,s,i,u)});if(!g){h(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=F(g.barcode),p=Ze(g);if(!p){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const v=[...t,{id:p,equipmentId:p,barcode:m,desc:g.desc||g.description||g.name||r.description||"",qty:1,price:Number.isFinite(Number(g.price))?Number(g.price):r.unitPrice,image:st(g)}];ze(n,v),Ve(v),Ie()}function Dn(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",n=>{const t=n.target.closest("button[data-action]");if(!t)return;const{action:a,groupKey:r,itemIndex:s}=t.dataset;if(a==="decrease-edit-group"&&r){ar(r);return}if(a==="increase-edit-group"&&r){rr(r);return}if(a==="remove-edit-group"&&r){sr(r);return}if(a==="remove-edit-item"){const i=Number(s);Number.isNaN(i)||cr(i)}}),e.dataset.groupListenerAttached="true")}function mt(){return!!document.getElementById("edit-res-project")?.value}function ir(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{mt()&&(h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function or(e){const n=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),l=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,o,l].forEach(ir),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const u=document.getElementById("edit-res-project")?.value||"";let d="unpaid";if(u)try{const g=(te()?.projects||[]).find(p=>String(p.id)===String(u)),m=typeof g?.paymentStatus=="string"?g.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(d=m)}catch{}r.value=d,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=n),l&&(l.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),l&&(l.dataset.linkedDisabled="false")}function Ie(){const e=document.getElementById("edit-res-summary");if(!e)return;Nt();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),ve(a),Ie()}),a.dataset.listenerAttached="true");const r=E(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",o=mt();or(o);const l=document.getElementById("edit-res-tax"),u=o?!1:l?.checked||!1,d=!o&&a?.dataset?.userSelected==="true";let f="unpaid";if(o){const S=document.getElementById("edit-res-project")?.value||"";if(S)try{const y=(te()?.projects||[]).find(T=>String(T.id)===String(S)),w=typeof y?.paymentStatus=="string"?y.paymentStatus.toLowerCase():null;w&&["paid","partial","unpaid"].includes(w)&&(f=w)}catch{}}else f=d&&a?.value||"unpaid";let g=null;!o&&u&&(ke("edit-res-company-share"),g=Xe("edit-res-company-share"),(!Number.isFinite(g)||g<=0)&&(ke("edit-res-company-share"),g=Xe("edit-res-company-share")));const{items:m=[],payments:p=[]}=we(),{start:v,end:b}=et(),q=Ot({items:m,discount:s,discountType:i,applyTax:u,paidStatus:f,start:v,end:b,companySharePercent:g,paymentHistory:p});e.innerHTML=q;const I=Ot.lastResult;if(I&&a){const S=I.paymentStatus;d?ve(a,a.value):(a.value!==S&&(a.value=S),a.dataset&&delete a.dataset.userSelected,ve(a,S))}else a&&ve(a,a.value)}function cr(e){if(e==null)return;const{index:n,items:t}=we();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);ze(n,a),Ve(a),Ie()}async function dr(e){const n=e?.value??"",t=F(n);if(!t)return;const a=nn(t);if(!a){h(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Ne(a);if(r==="maintenance"||r==="retired"){h(Ye(r));return}const s=F(t),{index:i,items:o=[]}=we();if(o.findIndex(b=>F(b.barcode)===s)>-1){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:u,end:d}=et();if(!u||!d){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:f=[]}=te(),g=i!=null&&f[i]||null,m=g?.id??g?.reservationId??null;if(Ce(s,u,d,m)){try{const b=new URLSearchParams({type:"equipment",id:s,start:u,end:d});m!=null&&b.set("ignore",String(m));const q=await Le(`/reservations/availability.php?${b.toString()}`),I=Array.isArray(q?.conflicts)?q.conflicts:[],S=Array.from(new Set(I.map(y=>y?.reservation_code||(y?.reservation_id!=null?`#${y.reservation_id}`:null)).filter(Boolean))),B=S.length?`: ${S.join("ØŒ ")}`:"";h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+B,"warning",6e3)}catch{h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const p=Ze(a);if(!p){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const v=[...o,{id:p,equipmentId:p,barcode:s,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];ze(i,v),e&&(e.value=""),Ve(v),Ie()}async function Ct(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=ya(n),a=F(t?.barcode||n);if(!t||!a){h(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Ne(t);if(r==="maintenance"||r==="retired"){h(Ye(r));return}const{start:s,end:i}=et();if(!s||!i){h(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:l=[]}=we();if(l.some(v=>F(v.barcode)===a)){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:d=[]}=te(),f=o!=null&&d[o]||null,g=f?.id??f?.reservationId??null;if(Ce(a,s,i,g)){try{const v=new URLSearchParams({type:"equipment",id:a,start:s,end:i});g!=null&&v.set("ignore",String(g));const b=await Le(`/reservations/availability.php?${v.toString()}`),q=Array.isArray(b?.conflicts)?b.conflicts:[],I=Array.from(new Set(q.map(B=>B?.reservation_code||(B?.reservation_id!=null?`#${B.reservation_id}`:null)).filter(Boolean))),S=I.length?`: ${I.join("ØŒ ")}`:"";h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+S,"warning",6e3)}catch{h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const m=Ze(t);if(!m){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const p=[...l,{id:m,equipmentId:m,barcode:a,desc:t.desc,qty:1,price:t.price,image:t.image||t.imageUrl||t.img||null}];ze(o,p),Ve(p),Ie(),e.value=""}function Pa(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Ct(e))});const n=()=>{va(e.value,"edit-res-equipment-description-options")&&Ct(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{Ie()});const e=()=>{er()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Ba()})}typeof window<"u"&&(window.getEditReservationDateRange=et,window.renderEditPaymentHistory=Nt);function lr(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){Qt(e);return}Ct(e)}}function Fr(){Fe(),Pa()}function ur(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let nt=null,Se=[],$e=[],Xt=null,oe={},Mt=!1,Rn=!1;function mr(){if(!Rn)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{xa(oe).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Rn=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const pr="__DEBUG_CREW__";function fr(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(pr);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Fn(e,n){if(fr())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function lt(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=a.dataset.confirmLabel||"âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯",o=a.dataset.pendingLabel||"â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯";a.innerHTML=s?i:o,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function ct(){return document.getElementById("edit-res-confirmed")?.value==="true"}function we(){return{index:nt,items:Se,payments:$e}}function ze(e,n,t=$e){nt=typeof e=="number"?e:null,Se=Array.isArray(n)?[...n]:[],$e=Array.isArray(t)?[...t]:[]}function La(){nt=null,Se=[],es(),$e=[]}function Dt(){return[...$e]}function hn(e){$e=Array.isArray(e)?[...e]:[]}function gr(e){e&&($e=[...$e,e])}function yr(e){!Number.isInteger(e)||e<0||($e=$e.filter((n,t)=>t!==e))}function St(e,n=1){const t=Number.parseFloat(E(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function Zt(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(E(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function vr(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?F(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:St(e.qty??e.quantity??e.count??1),price:Zt(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function hr(e,n=0){if(!e||typeof e!="object")return null;const t=Qe(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:dn(e)).map(g=>vr(g)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=Zt(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const g=Zt(i,0);g>0&&a>0&&(o=Number((g/a).toFixed(2)))}const l=e.package_code??e.packageCode??e.barcode??null,d=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,l,t].find(g=>g!=null&&String(g).trim()!=="")||`Package ${t}`,f=e.image??e.cover??e.thumbnail??s.find(g=>g?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:E(String(d)),name:E(String(d)),qty:a,price:o,barcode:l,packageItems:s,image:f}}function br(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function Ir(e={},n=[]){const t=Array.isArray(n)?n.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return t;const r=a.map((o,l)=>hr(o,l)).filter(Boolean);if(!r.length)return t;const s=new Map;r.forEach(o=>{const l=St(o.qty??o.quantity??1);if(o.barcode){const u=F(o.barcode);if(u){const d=`package::${u}`;s.set(d,(s.get(d)??0)+l)}}(o.packageItems||[]).forEach(u=>{if(!u)return;const d=l*St(u.qty??u.quantity??1),f=u.equipmentId??null,g=u.normalizedBarcode||(u.barcode?F(u.barcode):null);if(f!=null){const m=`equipment::${String(f)}`;s.set(m,(s.get(m)??0)+d)}if(g){const m=`barcode::${g}`;s.set(m,(s.get(m)??0)+d)}})});const i=[];return t.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const b=Qe(o.packageId??o.package_id??o.id??"");r.some(I=>I.packageId===b)||i.push({...o});return}const l=St(o.qty??o.quantity??1),u=Ze(o),d=o.barcode?F(o.barcode):null,f=[];u!=null&&f.push(`equipment::${String(u)}`),d&&f.push(`barcode::${d}`);const g=f.map(b=>s.get(b)??0).filter(b=>b>0);if(!g.length){i.push({...o});return}const m=Math.min(...g);if(m<=0){i.push({...o});return}const p=Math.min(m,l);if(br(s,f,p),p>=l)return;const v=l-p;i.push({...o,qty:v,quantity:v})}),[...i,...r.map(o=>({...o}))]}function Sr(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function $a(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function qa(e){if(!e)return null;const n=E(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function Er(e,n){if(e){e.value="";return}}function ot(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ca(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(E(String(e.value??""))),a=Number.parseFloat(E(String(e.amount??""))),r=Number.parseFloat(E(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,o=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),l=o==="amount"?s??null:o==="percent"?i??null:Number.isFinite(t)?t:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:l,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:u}}function wr(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((l,u)=>String(u.createdAt||u.start||"").localeCompare(String(l.createdAt||l.start||""))):[],o=[`<option value="">${ot(a)}</option>`];i.forEach(l=>{o.push(`<option value="${ot(l.id)}">${ot(l.title||a)}</option>`)}),s&&!i.some(l=>String(l.id)===s)&&o.push(`<option value="${ot(s)}">${ot(r)}</option>`),t.innerHTML=o.join(""),s?t.value=s:t.value=""}function _a(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const l=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",l&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}en("tax");const o=oe?.updateEditReservationSummary;typeof o=="function"&&o()}function en(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=oe?.updateEditReservationSummary;typeof s=="function"&&s()};if(Mt){a();return}Mt=!0;const r=()=>{Mt=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Ke)),n.disabled){t.checked=!1,h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),ke("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?ke("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function Mn(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:o,projects:l}=te(),d=Gn()?.[e];if(!d){h(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}oe={...oe,reservation:d,projects:l||[]},n?.(),wr(l||[],d);const f=d.projectId&&l?.find?.(x=>String(x.id)===String(d.projectId))||null,{effectiveConfirmed:g,projectLinked:m}=ft(d,f),p=d.items?d.items.map(x=>({...x,equipmentId:x.equipmentId??x.equipment_id??x.id,barcode:F(x?.barcode)})):[],v=Ir(d,p),q=(Array.isArray(d.paymentHistory)?d.paymentHistory:Array.isArray(d.payment_history)?d.payment_history:[]).map(x=>Ca(x)).filter(Boolean);ze(e,v,q);const I=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),S=o?.find?.(x=>String(x.id)===String(d.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const B=document.getElementById("edit-res-id");B&&(B.value=d.reservationId||d.id);const y=document.getElementById("edit-res-customer");y&&(y.value=S?.customerName||I);const w=typeof a=="function"?a(d.start):{date:"",time:""},T=typeof a=="function"?a(d.end):{date:"",time:""};t?.("edit-res-start",w.date),t?.("edit-res-start-time",w.time),t?.("edit-res-end",T.date),t?.("edit-res-end-time",T.time);const P=document.getElementById("edit-res-notes");P&&(P.value=d.notes||"");const C=document.getElementById("edit-res-discount");if(C){const x=m?0:d.discount??0;C.value=E(x)}const W=document.getElementById("edit-res-discount-type");W&&(W.value=m?"percent":d.discountType||"percent");const L=d.projectId?!1:!!d.applyTax,_=document.getElementById("edit-res-tax");_&&(_.checked=L);const z=document.getElementById("edit-res-company-share");if(z){const x=d.companySharePercent??d.company_share_percent??d.companyShare??d.company_share??null,ye=x!=null?Number.parseFloat(E(String(x).replace("%","").trim())):NaN,de=d.companyShareEnabled??d.company_share_enabled??d.companyShareApplied??d.company_share_applied??null,xe=de!=null?de===!0||de===1||de==="1"||String(de).toLowerCase()==="true":Number.isFinite(ye)&&ye>0,Q=xe&&Number.isFinite(ye)&&ye>0?ye:Ke,He=L||xe;z.checked=He,z.dataset.companyShare=String(Q)}lt(g,{disable:m});const N=document.getElementById("edit-res-close-btn");N&&(N.disabled=!(g&&!m));const $=document.getElementById("edit-res-paid"),j=d.paidStatus??(d.paid===!0||d.paid==="paid"?"paid":"unpaid");$&&($.value=j,$.dataset&&delete $.dataset.userSelected);const J=document.getElementById("edit-res-payment-progress-type"),O=document.getElementById("edit-res-payment-progress-value");J?.dataset?.userSelected&&delete J.dataset.userSelected,J&&(J.value="percent"),Er(O);const U=document.getElementById("edit-res-cancelled");if(U){const x=String(d?.status||d?.reservationStatus||"").toLowerCase();U.checked=["cancelled","canceled"].includes(x),U.checked&&lt(g,{disable:!0})}let G=Array.isArray(d.crewAssignments)&&d.crewAssignments.length?d.crewAssignments:Array.isArray(d.techniciansDetails)&&d.techniciansDetails.length?d.techniciansDetails:(d.technicians||[]).map(x=>String(x));if(!Array.isArray(G)||G.length===0){const x=Ja(d.id??d.reservationId??d.reservation_code??null);Array.isArray(x)&&x.length&&(G=x)}try{await ea()}catch(x){console.warn("[reservationsEdit] positions load failed (non-fatal)",x)}if(Qa(G),r?.(v),typeof window<"u"){const x=window?.renderEditPaymentHistory;typeof x=="function"&&x()}_a(),s?.();const ce=document.getElementById("editReservationModal");Xt=Sr(ce,i),Xt?.show?.();try{kr?.(oe)}catch(x){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",x)}mr()}async function xa({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(nt===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const l=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end")?.value?.trim(),f=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",g=document.getElementById("edit-res-notes")?.value||"",m=E(document.getElementById("edit-res-discount")?.value||"0");let p=parseFloat(m)||0,v=document.getElementById("edit-res-discount-type")?.value||"percent";const b=ct(),q=document.getElementById("edit-res-paid"),I=q?.dataset?.userSelected==="true",S=I&&q?.value||"unpaid",B=document.getElementById("edit-res-payment-progress-type"),y=document.getElementById("edit-res-payment-progress-value"),w=$a(B),T=qa(y),P=document.getElementById("edit-res-project")?.value||"",W=document.getElementById("edit-res-cancelled")?.checked===!0,L=Ya();L.map(k=>k?.technicianId).filter(Boolean);const _=document.getElementById("edit-res-company-share"),z=document.getElementById("edit-res-tax");if(!l||!d){h(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const N=typeof e=="function"?e:(k,D)=>`${k}T${D||"00:00"}`,$=N(l,u),j=N(d,f);if($&&j&&new Date($)>new Date(j)){h(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const O=Gn()?.[nt];if(!O){h(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(Se)||Se.length===0&&L.length===0){h(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const U=typeof n=="function"?n:()=>!1,G=O.id??O.reservationId;for(const k of Se){if(k?.type==="package"&&Array.isArray(k.packageItems)){for(const M of k.packageItems){const V=M?.barcode??M?.normalizedBarcode??"";if(!V)continue;const ae=Ne(V);if(ae!=="reserved"&&ae!=="available"){h(Ye(ae));return}}continue}const D=Ne(k.barcode);if(D!=="reserved"&&D!=="available"){h(Ye(D));return}}{const k=typeof t=="function"?t:()=>!1;for(const D of Se){if(D?.type!=="package")continue;const M=D.packageId??D.package_id??null,V=D.desc||D.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(M&&k(M,$,j,G)){const ae=Array.isArray(D?.packageItems)?D.packageItems.map(K=>F(K?.barcode??K?.normalizedBarcode??"")).filter(Boolean):[];let X=An(ae,$,j,G);if(!X.length)try{const K=new URLSearchParams;K.set("type","package"),K.set("id",String(M)),K.set("start",$),K.set("end",j),G!=null&&K.set("ignore",String(G));const me=await Le(`/reservations/availability.php?${K.toString()}`),Ge=Array.isArray(me?.conflicts)?me.conflicts:[];X=Array.from(new Set(Ge.map(ee=>ee?.reservation_code||(ee?.reservation_id!=null?`#${ee.reservation_id}`:null)).filter(Boolean)))}catch{}const re=X.length?` (${X.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(V))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+re,"warning",-1);return}if(Array.isArray(D?.packageItems)&&D.packageItems.length){const ae=(D.packageItems||[]).map(K=>F(K?.barcode??K?.normalizedBarcode??"")).filter(Boolean),X=ae.length,re=ae.filter(K=>U(K,$,j,G)).length;if(X>0&&re>=X){const K=(D.packageItems||[]).map(ee=>F(ee?.barcode??ee?.normalizedBarcode??"")).filter(Boolean);let me=An(K,$,j,G);if(!me.length)try{const ee=new URLSearchParams;ee.set("type","package"),M!=null&&ee.set("id",String(M)),ee.set("start",$),ee.set("end",j),G!=null&&ee.set("ignore",String(G));const yt=await Le(`/reservations/availability.php?${ee.toString()}`),vt=Array.isArray(yt?.conflicts)?yt.conflicts:[];me=Array.from(new Set(vt.map(ht=>ht?.reservation_code||(ht?.reservation_id!=null?`#${ht.reservation_id}`:null)).filter(Boolean)))}catch{}const Ge=me.length?` (${me.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(V))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+Ge,"warning",6e3);return}}}}const ce=[];for(const k of Se){if(k?.type==="package"&&Array.isArray(k.packageItems)){for(const M of k.packageItems){const V=F(M?.barcode??M?.normalizedBarcode??"");if(V&&U(V,$,j,G)){const ae=M?.desc||M?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");ce.push({label:E(String(ae)),barcode:V})}}continue}const D=F(k.barcode);if(U(D,$,j,G)){const M=k?.desc||k?.name||k?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");ce.push({label:E(String(M)),barcode:D})}}if(ce.length){const k=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let D=null;try{const V=Array.from(new Set(ce.map(X=>X.barcode).filter(Boolean))),ae=new Map;await Promise.all(V.map(async X=>{const re=new URLSearchParams;re.set("type","equipment"),re.set("id",X),re.set("start",$),re.set("end",j),G!=null&&re.set("ignore",String(G));const K=await Le(`/reservations/availability.php?${re.toString()}`),me=Array.isArray(K?.conflicts)?K.conflicts:[],Ge=Array.from(new Set(me.map(ee=>ee?.reservation_code||(ee?.reservation_id!=null?`#${ee.reservation_id}`:null)).filter(Boolean)));ae.set(X,Ge)})),D=ce.map(({label:X,barcode:re})=>{const K=ae.get(re)||[];return K.length?`${X} (${K.join("ØŒ ")})`:X}).join("ØŒ ")}catch{}const M=D||ce.map(V=>V.label).filter(Boolean).map(String).join("ØŒ ");h(`${k}: ${M}`,"warning",6e3);return}const x=typeof t=="function"?t:()=>!1;for(const k of Se){if(k?.type!=="package")continue;const D=k.packageId??k.package_id??null;if(D&&x(D,$,j,G)){const M=k.desc||k.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const V=new URLSearchParams;V.set("type","package"),V.set("id",String(D)),V.set("start",$),V.set("end",j),G!=null&&V.set("ignore",String(G));const ae=await Le(`/reservations/availability.php?${V.toString()}`),X=Array.isArray(ae?.conflicts)?ae.conflicts:[],re=Array.from(new Set(X.map(me=>me?.reservation_code||(me?.reservation_id!=null?`#${me.reservation_id}`:null)).filter(Boolean))),K=re.length?` (${re.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(M))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+K,"warning",6e3)}catch{h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${E(String(M))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const ye=typeof a=="function"?a:()=>!1,de=[];for(const k of L){if(!k?.technicianId||!ye(k.technicianId,$,j,G))continue;const D=k?.technicianName||k?.positionLabel||String(k.technicianId);let M=[];try{M=Yn(k.technicianId,$,j,G)}catch{}de.push({label:E(String(D)),codes:M})}if(de.length){const k=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),D=de.map(({label:M,codes:V})=>V&&V.length?`${M} (${V.join("ØŒ ")})`:M).join("ØŒ ");h(`${k}: ${D}`,"warning",6e3);return}const xe=Array.isArray(oe.projects)&&oe.projects.length?oe.projects:te().projects||[],Q=P&&xe.find(k=>String(k.id)===String(P))||null,He={...O,projectId:P?String(P):null,confirmed:b},{effectiveConfirmed:Oe,projectLinked:pe,projectStatus:rt}=ft(He,Q);let le=!!_?.checked,A=!!z?.checked;if(pe&&(le&&(_.checked=!1,le=!1),A=!1),!pe&&le!==A){h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}A&&(ke("edit-res-company-share"),le=!!_?.checked);let R=le?getCompanySharePercent("edit-res-company-share"):null;le&&(!Number.isFinite(R)||R<=0)&&(ke("edit-res-company-share"),R=getCompanySharePercent("edit-res-company-share"));const ne=le&&A&&Number.isFinite(R)&&R>0,Y=pe?!1:A;pe&&(p=0,v="percent");const fe=zn(Se,p,v,Y,L,{start:$,end:j,companySharePercent:ne?R:0});let Z=Dt();if(Number.isFinite(T)&&T>0){const k=fe;let D=null,M=null;w==="amount"?(D=T,k>0&&(M=T/k*100)):(M=T,k>0&&(D=T/100*k));const V=Ca({type:w,value:T,amount:D,percentage:M,recordedAt:new Date().toISOString()});V&&(Z=[...Z,V],hn(Z)),y&&(y.value="")}const se=wt({totalAmount:fe,history:Z}),ue=kt({manualStatus:S,paidAmount:se.paidAmount,paidPercent:se.paidPercent,totalAmount:fe});q&&!I&&(q.value=ue,q.dataset&&delete q.dataset.userSelected);let Be=O.status??"pending";pe?Be=Q?.status??rt??Be:W?Be="cancelled":["completed","cancelled"].includes(String(Be).toLowerCase())||(Be=b?"confirmed":"pending");const Ue=Hn({reservationCode:O.reservationCode??O.reservationId??null,customerId:O.customerId,start:$,end:j,status:Be,title:O.title??null,location:O.location??null,notes:g,projectId:P?String(P):null,totalAmount:fe,discount:p,discountType:v,applyTax:Y,paidStatus:ue,confirmed:Oe,items:Se.map(k=>({...k,equipmentId:k.equipmentId??k.id})),crewAssignments:L,companySharePercent:ne?R:null,companyShareEnabled:ne,paidAmount:se.paidAmount,paidPercentage:se.paidPercent,paymentProgressType:se.paymentProgressType,paymentProgressValue:se.paymentProgressValue,paymentHistory:Z});try{Fn("about to submit",{editingIndex:nt,crewAssignments:L,techniciansPayload:Ue?.technicians,payload:Ue});const k=await Xa(O.id||O.reservationId,Ue);Fn("server response",{reservation:k?.id??k?.reservationId??k?.reservation_code,technicians:k?.technicians,crewAssignments:k?.crewAssignments,techniciansDetails:k?.techniciansDetails}),await Za(),ln(),ut(),ms(),h(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),La(),o?.({type:"updated",reservation:k}),s?.(),i?.(),Xt?.hide?.()}catch(k){console.error("âŒ [reservationsEdit] Failed to update reservation",k);const D=On(k)?k.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");h(D,"error")}}function kr(e={}){oe={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=oe,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=E(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{en("tax")}),o.dataset.listenerAttached="true");const l=document.getElementById("edit-res-company-share");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{en("share")}),l.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",n?.()}),u.dataset.listenerAttached="true");const d=document.getElementById("edit-res-payment-progress-value");d&&!d.dataset.listenerAttached&&(d.addEventListener("input",()=>{d.value=E(d.value)}),d.dataset.listenerAttached="true");const f=["edit-res-start","edit-res-end"],g=["edit-res-start-time","edit-res-end-time"],m=y=>{const w=document.getElementById(y);if(!w||w.dataset.editDateListenerAttached==="true")return;const T=()=>{try{n?.()}catch{}try{const P=typeof we=="function"?we().items:[];r?.(P)}catch{}};w.addEventListener("input",T),w.addEventListener("change",T),w.dataset.editDateListenerAttached="true"};f.forEach(m),g.forEach(m),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const p=document.getElementById("edit-res-project");p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>{_a();const y=Array.isArray(oe.projects)&&oe.projects.length?oe.projects:te().projects||[],w=p.value&&y.find(L=>String(L.id)===String(p.value))||null,P={...oe?.reservation??{},projectId:p.value||null,confirmed:ct()},{effectiveConfirmed:C,projectLinked:W}=ft(P,w);lt(C,{disable:W}),n?.()}),p.dataset.listenerAttached="true");const v=document.getElementById("edit-res-confirmed-btn");v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{if(v.disabled)return;const y=!ct();lt(y);const w=document.getElementById("edit-res-close-btn");w&&(w.disabled=!y),n?.()}),v.dataset.listenerAttached="true");const b=document.getElementById("edit-res-cancelled");b&&!b.dataset.listenerAttached&&(b.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&lt(ct(),{disable:b.checked});const w=document.getElementById("edit-res-close-btn");w&&(w.disabled=b.checked||!ct()),n?.()}),b.dataset.listenerAttached="true");const q=document.getElementById("save-reservation-changes");q&&!q.dataset.listenerAttached&&(q.addEventListener("click",()=>{xa(oe).catch(y=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",y)})}),q.dataset.listenerAttached="true");const I=document.getElementById("edit-res-close-btn");I&&!I.dataset.listenerAttached&&(I.addEventListener("click",()=>{try{const{index:y}=we(),w=document.getElementById("closeReservationModal"),T=document.getElementById("close-reservation-notes"),P=document.getElementById("close-reservation-submit"),C=document.getElementById("edit-res-notes")?.value||"";if(T&&(T.value=C),P&&P.__tmpCloseListener&&(P.removeEventListener("click",P.__tmpCloseListener),P.__tmpCloseListener=null),P){const W=async()=>{const L=T?.value||"";try{await na(y,L,{onAfterChange:oe?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(w)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(w))?.hide?.()}catch{}}};P.__tmpCloseListener=W,P.addEventListener("click",W,{once:!0})}w&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(w).show()}catch(y){console.warn("[reservationsEdit] failed to open close modal",y)}}),I.dataset.listenerAttached="true");const S=document.getElementById("edit-res-equipment-barcode");if(S&&!S.dataset.listenerAttached){let y=null;const w=()=>{S.value?.trim()&&(clearTimeout(y),y=null,t?.(S))};S.addEventListener("keydown",P=>{P.key==="Enter"&&(P.preventDefault(),w())});const T=()=>{if(clearTimeout(y),!S.value?.trim())return;const{start:P,end:C}=getEditReservationDateRange();!P||!C||(y=setTimeout(()=>{w()},150))};S.addEventListener("input",T),S.addEventListener("change",w),S.dataset.listenerAttached="true"}Pa?.();const B=document.getElementById("editReservationModal");B&&!B.dataset.cleanupAttached&&(B.addEventListener("hidden.bs.modal",()=>{La(),n?.(),r?.([])}),B.dataset.cleanupAttached="true")}function Mr(){return bs().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=te()||{};ts(e||[]),Aa()})}function Rt(e=null){Aa(),ja(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function Ar(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function tn(){return{populateEquipmentDescriptionLists:Fe,setFlatpickrValue:ur,splitDateTime:Xn,renderEditItems:Ve,updateEditReservationSummary:Ie,addEquipmentByDescription:lr,addEquipmentToEditingReservation:dr,addEquipmentToEditingByDescription:Ct,combineDateTime:Je,hasEquipmentConflict:Ce,hasTechnicianConflict:Qn,renderReservations:ja,handleReservationsMutation:Rt,ensureModal:Ar}}function ja(e="reservations-list",n=null){Ys({containerId:e,filters:n,onShowDetails:Ta,onConfirmReservation:Da,onCloseReservation:Br})}function Ta(e){return Xs(e,{getEditContext:tn,onEdit:(n,{reservation:t})=>{Fa(n,t)},onDelete:Na})}function Na(e){return Va()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?vs(e,{onAfterChange:Rt}):!1:(za(),!1)}function Da(e){return hs(e,{onAfterChange:Rt})}let Et=null;function Ra(){const e=document.getElementById("closeReservationModal"),n=document.getElementById("close-reservation-notes"),t=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:n,submit:t,cancel:a}}function Br(e){Et=e;const{modal:n,note:t}=Ra();t&&(t.value=""),n&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(n).show()}function Pr(){const{modal:e,note:n,submit:t,cancel:a}=Ra();e&&(t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async()=>{const r=n?.value||"";try{await na(Et,r,{onAfterChange:Rt})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}Et=null}}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{Et=null}),a.dataset.listenerAttached="true"))}function Fa(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}Mn(e,tn());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}Mn(e,tn());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}Ha({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function Vr(){Is({showReservationDetails:Ta,deleteReservation:Na,confirmReservation:Da,openReservationEditor:Fa});try{Pr()}catch{}}export{Fr as a,ja as b,Aa as c,H as d,Ta as e,Na as f,tn as g,Rt as h,Rr as i,Da as j,ur as k,Mr as l,Fa as o,Vr as r,kr as s,Ie as u};
