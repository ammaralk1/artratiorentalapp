import{a as V,c as K,i as H,m as G,t as d,l as W,g as J,b as Q,A as X,d as Y,n as Z,u as _}from"./auth.js";import{i as ee}from"./dashboardShell.js";/* empty css   */import{r as te,a as ae,s as ne}from"./reservationsService.js";import{d as se}from"./projectsCommon.js";V();K();ee();H();G();let E="",q="",g=null,L=!1,w="";function j(){const e=document.querySelectorAll("[data-home-greeting]");if(!e.length)return;const t=d("home.hero.title","مرحباً بك"),a=E?d("home.hero.greetingUser","مرحباً {name}").replace("{name}",E):t;e.forEach(s=>{s.textContent=a})}function $(){const e=q==="admin";document.querySelectorAll("[data-admin-card]").forEach(t=>{e?t.classList.remove("hidden"):t.classList.add("hidden")})}function re(e){if(!e||typeof e!="object")return null;const t=a=>{const s=Number.parseInt(String(a??"0"),10);return Number.isFinite(s)?s:0};return{customers:{total:t(e?.customers?.total)},reservations:{total:t(e?.reservations?.total),today:t(e?.reservations?.today),upcoming:t(e?.reservations?.upcoming)},equipment:{total:t(e?.equipment?.total),maintenance:t(e?.equipment?.maintenance)},technicians:{total:t(e?.technicians?.total),busy:t(e?.technicians?.busy)},projects:{total:t(e?.projects?.total),active:t(e?.projects?.active)},maintenance:{open:t(e?.maintenance?.open),highPriority:t(e?.maintenance?.highPriority)}}}function ie(){return{customers:{total:0},reservations:{total:0,today:0,upcoming:0},equipment:{total:0,maintenance:0},technicians:{total:0,busy:0},projects:{total:0,active:0},maintenance:{open:0,highPriority:0}}}function oe(e){if(e==null)return null;if(typeof e=="object"){const a=[e.id,e.technicianId,e.technician_id,e.technician?.id,e.value];for(const s of a)if(s!=null&&String(s).trim()!=="")return String(s).trim();return null}const t=String(e).trim();return t===""?null:t}function P(e){const t=Y(),a=e?{...e}:ie(),s=Array.isArray(t.customers)?t.customers:[],l=Array.isArray(t.reservations)?t.reservations:[],p=Array.isArray(t.equipment)?t.equipment:[],v=Array.isArray(t.maintenance)?t.maintenance:[],S=Array.isArray(t.projects)?t.projects:[];if(s.length&&(a.customers={...a.customers,total:s.length}),p.length){const u=p.filter(i=>{const c=String(i?.status||i?.state||"").toLowerCase();return c.includes("maintenance")||c.includes("repair")}).length;a.equipment={...a.equipment,total:p.length,maintenance:u}}if(S.length){const u=S.filter(i=>se(i)==="ongoing").length;a.projects={...a.projects,total:Math.max(a.projects?.total??0,S.length),active:Math.max(a.projects?.active??0,u)}}if(v.length){const u=v.filter(c=>{const m=String(c?.status||c?.state||"").toLowerCase();return!m||["open","pending","in-progress","progress","scheduled"].includes(m)}).length,i=v.filter(c=>{const m=String(c?.priority||c?.severity||"").toLowerCase();return["high","urgent","critical"].includes(m)}).length;a.maintenance={...a.maintenance,open:Math.max(a.maintenance?.open??0,u),highPriority:Math.max(a.maintenance?.highPriority??0,i)}}if(l.length){const u=new Date,i=new Date(u);i.setHours(0,0,0,0);const c=new Date(i);c.setDate(c.getDate()+1);const m=n=>{const r=String(n?.status||n?.reservationStatus||"").toLowerCase();return["cancelled","canceled"].includes(r)},y=(n,r)=>{const o=String(n||"").trim(),f=String(r||"").trim();return!o&&!f?null:o&&f?`${o}T${f}`:o?`${o}T00:00:00`:null},h=n=>{if(!n)return null;if(n instanceof Date)return Number.isNaN(n.getTime())?null:n;let r=String(n).trim();if(!r)return null;/^\d{4}-\d{2}-\d{2}$/.test(r)?r=`${r}T00:00:00`:r.includes(" ")&&(r=r.replace(" ","T"));const o=new Date(r);return Number.isNaN(o.getTime())?null:o},T=n=>{const r=[n?.start,n?.startDatetime,n?.start_datetime,n?.start_date,n?.startDate,y(n?.startDate,n?.startTime),y(n?.start_date,n?.start_time)];for(const o of r){const f=h(o);if(f)return f}return null},R=n=>{const r=[n?.end,n?.endDatetime,n?.end_datetime,n?.end_date,n?.endDate,y(n?.endDate,n?.endTime),y(n?.end_date,n?.end_time)];for(const o of r){const f=h(o);if(f)return f}return null},I=l.filter(n=>{if(m(n))return!1;const r=T(n);return r?r>=i&&r<c:!1}).length,B=l.filter(n=>{if(m(n))return!1;const r=T(n);return r?r>=u:!1}).length,C=new Set;l.forEach(n=>{if(m(n))return;const r=T(n);let o=R(n);if(!r||((!o||o<=r)&&(o=new Date(r.getTime()+14400*1e3)),!r||!o)||r>u||o<=u)return;(Array.isArray(n.technicians)?n.technicians:[]).forEach(U=>{const k=oe(U);k&&C.add(k)})}),a.reservations={...a.reservations,total:Math.max(a.reservations?.total??0,l.length),today:Math.max(a.reservations?.today??0,I),upcoming:Math.max(a.reservations?.upcoming??0,B)},a.technicians={...a.technicians,busy:Math.max(a.technicians?.busy??0,C.size)}}const D=ne(),O=Array.isArray(t.technicians)?t.technicians:[],M=Array.isArray(D)&&D.length>0?D:O;if(M.length){const u=M.filter(i=>{if(!i)return!1;if(i.isBusy===!0||i.busy===!0)return!0;const m=[i?.status,i?.baseStatus,i?.currentStatus,i?.availability,i?.state,i?.status_label,i?.statusLabel,i?.statusText,i?.status_text].map(h=>String(h??"").trim().toLowerCase()).filter(h=>h.length>0).map(h=>h.replace(/[\u2700-\u27bf\u1f300-\u1f64f\u1f680-\u1f6ff\u2600-\u26ff]/g,"").replace(/[^\p{L}\p{N}\s_-]+/gu," ").replace(/\s+/g," ").trim());if(!m.length)return!1;const y=["busy","مشغول","غير متاح","مشغولة","occupied","in use","in-use","working","assigned","قيد العمل","assigned crew"];return m.some(h=>y.some(T=>h.includes(T)))}).length;a.technicians={...a.technicians,total:Math.max(a.technicians?.total??0,M.length),busy:Math.max(a.technicians?.busy??0,u)}}return a}function ce(e){return[{key:"customers.total",label:d("home.summary.customers","إجمالي العملاء"),value:e.customers.total,icon:"👥",accent:"primary",href:"dashboard.html#customers-tab",dashboardTab:"customers-tab"},{key:"reservations.today",label:d("home.summary.reservationsToday","حجوزات اليوم"),value:e.reservations.today,icon:"🛎️",accent:"success",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"},{key:"reservations.upcoming",label:d("home.summary.reservationsUpcoming","حجوزات قادمة"),value:e.reservations.upcoming,icon:"🔔",accent:"info",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"calendar-tab"},{key:"projects.active",label:d("home.summary.projectsActive","مشاريع نشطة"),value:e.projects.active,icon:"🏗️",accent:"warning",href:"projects.html#projects-section",projectsTab:"projects-section",projectsSubTab:"projects-list-tab"},{key:"equipment.maintenance",label:d("home.summary.equipmentMaintenance","معدات قيد الصيانة"),value:e.equipment.maintenance,icon:"🛠️",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"maintenance.highPriority",label:d("home.summary.maintenanceHigh","بلاغات صيانة عاجلة"),value:e.maintenance.highPriority,icon:"⚡",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"technicians.busy",label:d("home.summary.techniciansBusy","أعضاء طاقم مشغولون"),value:e.technicians.busy,icon:"👷",accent:"secondary",href:"dashboard.html#technicians-tab",dashboardTab:"technicians-tab"}]}const F={primary:"bg-primary/10 text-primary",success:"bg-success/10 text-success",info:"bg-info/10 text-info",warning:"bg-warning/10 text-warning",error:"bg-error/10 text-error",secondary:"bg-secondary/10 text-secondary"};function ue(e){if(typeof _!="function")return;const t=["dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"],a={};if(t.forEach(s=>{Object.prototype.hasOwnProperty.call(e,s)&&(a[s]=e[s]??null)}),Object.keys(a).length!==0)try{const s=_(a);s&&typeof s.catch=="function"&&s.catch(l=>{console.warn("⚠️ [home] Failed to persist navigation preference",l)})}catch(s){console.warn("⚠️ [home] Failed to persist navigation preference",s)}}function de(e){e.querySelectorAll("[data-summary-card]").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{const a={};t.dataset.dashboardTab!==void 0&&(a.dashboardTab=t.dataset.dashboardTab||null),t.dataset.dashboardSubtab!==void 0&&(a.dashboardSubTab=t.dataset.dashboardSubtab||null),t.dataset.projectsTab!==void 0&&(a.projectsTab=t.dataset.projectsTab||null),t.dataset.projectsSubtab!==void 0&&(a.projectsSubTab=t.dataset.projectsSubtab||null),Object.keys(a).length>0&&ue(a)}),t.dataset.listenerAttached="true")})}function le(e){const t=["glass-card","summary-card","flex","flex-col","items-center","gap-2","p-5","text-center","transition","duration-200","hover:-translate-y-1","focus-visible:outline","focus-visible:outline-2","focus-visible:outline-offset-2","focus-visible:outline-primary"],a=["data-summary-card"],s=S=>String(S??"").replace(/"/g,"&quot;");e.href&&a.push(`href="${s(e.href)}"`),e.dashboardTab!==void 0&&a.push(`data-dashboard-tab="${s(e.dashboardTab??"")}"`),e.dashboardSubTab!==void 0&&a.push(`data-dashboard-subtab="${s(e.dashboardSubTab??"")}"`),e.projectsTab!==void 0&&a.push(`data-projects-tab="${s(e.projectsTab??"")}"`),e.projectsSubTab!==void 0&&a.push(`data-projects-subtab="${s(e.projectsSubTab??"")}"`);const l=Z(String(e.value??0)),p=s(e.label),v=F[e.accent]||F.primary;return`
    <a ${a.join(" ")} class="${t.join(" ")}" aria-label="${p}">
      <span class="summary-card__icon flex h-12 w-12 items-center justify-center rounded-2xl text-2xl ${v}">${e.icon}</span>
      <span class="summary-card__label text-sm font-medium text-base-content/70">${e.label}</span>
      <span class="summary-card__value text-3xl font-bold text-base-content">${l}</span>
    </a>
  `}function A(){const e=document.querySelector("[data-home-summary]");if(!e)return;if(L){e.innerHTML=`
      <div class="w-full text-center text-base-content/60" data-i18n data-i18n-key="home.summary.loading">
        ${d("home.summary.loading","⏳ جارٍ جلب بيانات النظام...")}
      </div>
    `;return}if(w){e.innerHTML=`
      <div class="alert alert-warning" role="alert">
        ${w}
      </div>
    `;return}if(!g){e.innerHTML=`
      <div class="w-full text-center text-base-content/60">
        ${d("home.summary.empty","لا تتوفر بيانات بعد. ابدأ بإضافة سجلات.")} 
      </div>
    `;return}const t=ce(g);e.innerHTML=t.map(le).join(""),de(e)}async function z({silent:e=!1}={}){if(!L){L=!0,e||A();try{const t=await Q("/summary/");g=re(t?.data??null),g=P(g),w=""}catch(t){console.error("❌ [home] Failed to load summary data",t),g=P(null),w=t instanceof X?t.message:d("home.summary.error","تعذر تحميل بيانات النظام، حاول لاحقاً")}finally{L=!1,A()}}}function b(){z({silent:!0}).catch(e=>{console.error("❌ [home] Summary refresh failed",e)})}const x=document.getElementById("home-refresh-summary");x&&!x.dataset.listenerAttached&&(x.addEventListener("click",()=>{b()}),x.dataset.listenerAttached="true");document.addEventListener("language:translationsReady",()=>{j(),A()});document.addEventListener("language:changed",()=>{j(),A()});function N(){H();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>W()),e.dataset.listenerAttached="true"),J({refresh:!0}).then(s=>{E=s?.username||"",q=(s?.role||"").toLowerCase(),j(),$()}).catch(()=>{E="",q="",j(),$()}),j(),$(),A(),z(),document.addEventListener("customers:changed",b,{passive:!0}),document.addEventListener("reservations:changed",b,{passive:!0}),document.addEventListener("equipment:changed",b,{passive:!0}),document.addEventListener("maintenance:updated",b,{passive:!0}),document.addEventListener("technicians:updated",b,{passive:!0}),document.addEventListener("projects:changed",b,{passive:!0}),typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("technicians:updated",b,{passive:!0});const t=()=>{b()},a=(s,l)=>{!s||typeof s.then!="function"||s.then(()=>{t()}).catch(p=>{console.warn(`⚠️ [home] Failed to prefetch ${l} for summary`,p)})};try{a(te(),"technicians")}catch(s){console.warn("⚠️ [home] Failed to kick off technicians prefetch",s)}try{a(ae(),"reservations")}catch(s){console.warn("⚠️ [home] Failed to kick off reservations prefetch",s)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{N()},{once:!0}):N();
