import{a as N,c as B,i as M,m as R,t as i,l as F,g as I,b as U,A as z,d as V,n as G,u as D}from"./auth.js";import{i as K}from"./dashboardShell.js";/* empty css   */import{s as W}from"./technicians.js";N();B();K();M();R();let j="",E="",h=null,S=!1,T="";function y(){const e=document.querySelectorAll("[data-home-greeting]");if(!e.length)return;const t=i("home.hero.title","Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ"),a=j?i("home.hero.greetingUser","Ù…Ø±Ø­Ø¨Ø§Ù‹ {name}").replace("{name}",j):t;e.forEach(n=>{n.textContent=a})}function L(){const e=E==="admin";document.querySelectorAll("[data-admin-card]").forEach(t=>{e?t.classList.remove("hidden"):t.classList.add("hidden")})}function J(e){if(!e||typeof e!="object")return null;const t=a=>{const n=Number.parseInt(String(a??"0"),10);return Number.isFinite(n)?n:0};return{customers:{total:t(e?.customers?.total)},reservations:{total:t(e?.reservations?.total),today:t(e?.reservations?.today),upcoming:t(e?.reservations?.upcoming)},equipment:{total:t(e?.equipment?.total),maintenance:t(e?.equipment?.maintenance)},technicians:{total:t(e?.technicians?.total),busy:t(e?.technicians?.busy)},projects:{total:t(e?.projects?.total),active:t(e?.projects?.active)},maintenance:{open:t(e?.maintenance?.open),highPriority:t(e?.maintenance?.highPriority)}}}function Q(){return{customers:{total:0},reservations:{total:0,today:0,upcoming:0},equipment:{total:0,maintenance:0},technicians:{total:0,busy:0},projects:{total:0,active:0},maintenance:{open:0,highPriority:0}}}function X(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);return Number.isNaN(t.getTime())?null:t}function $(e){const t=V(),a=e?{...e}:Q(),n=Array.isArray(t.customers)?t.customers:[],l=Array.isArray(t.reservations)?t.reservations:[],b=Array.isArray(t.equipment)?t.equipment:[],f=Array.isArray(t.maintenance)?t.maintenance:[],p=Array.isArray(t.projects)?t.projects:[];if(n.length&&(a.customers={...a.customers,total:n.length}),b.length){const c=b.filter(r=>{const o=String(r?.status||r?.state||"").toLowerCase();return o.includes("maintenance")||o.includes("repair")}).length;a.equipment={...a.equipment,total:b.length,maintenance:c}}if(p.length){const c=p.filter(r=>determineProjectStatus(r)==="ongoing").length;a.projects={...a.projects,total:p.length,active:c}}if(f.length){const c=f.filter(o=>{const d=String(o?.status||o?.state||"").toLowerCase();return!d||["open","pending","in-progress","progress","scheduled"].includes(d)}).length,r=f.filter(o=>{const d=String(o?.priority||o?.severity||"").toLowerCase();return["high","urgent","critical"].includes(d)}).length;a.maintenance={...a.maintenance,open:c,highPriority:r}}if(l.length){const c=new Date,r=new Date(c);r.setHours(0,0,0,0);const o=new Date(r);o.setDate(o.getDate()+1);const d=s=>{const u=String(s?.status||s?.reservationStatus||"").toLowerCase();return["cancelled","canceled"].includes(u)},q=s=>{const u=[s?.start,s?.startDatetime,s?.start_datetime,s?.start_date,s?.startDate];for(const _ of u){const C=X(_);if(C)return C}return null},H=l.filter(s=>{if(d(s))return!1;const u=q(s);return u?u>=r&&u<o:!1}).length,O=l.filter(s=>{if(d(s))return!1;const u=q(s);return u?u>=c:!1}).length;a.reservations={...a.reservations,total:l.length,today:H,upcoming:O}}const x=W()||t.technicians||[],A=Array.isArray(x)?x:[];if(A.length){const c=A.filter(r=>String(r?.status||r?.baseStatus||"").toLowerCase()==="busy").length;a.technicians={...a.technicians,total:A.length,busy:c}}return a}function Y(e){return[{key:"customers.total",label:i("home.summary.customers","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"),value:e.customers.total,icon:"ğŸ‘¥",accent:"primary",href:"dashboard.html#customers-tab",dashboardTab:"customers-tab"},{key:"reservations.today",label:i("home.summary.reservationsToday","Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…"),value:e.reservations.today,icon:"ğŸ›ï¸",accent:"success",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"},{key:"reservations.upcoming",label:i("home.summary.reservationsUpcoming","Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©"),value:e.reservations.upcoming,icon:"ğŸ””",accent:"info",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"calendar-tab"},{key:"projects.active",label:i("home.summary.projectsActive","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©"),value:e.projects.active,icon:"ğŸ—ï¸",accent:"warning",href:"projects.html#projects-section",projectsTab:"projects-section",projectsSubTab:"projects-list-tab"},{key:"equipment.maintenance",label:i("home.summary.equipmentMaintenance","Ù…Ø¹Ø¯Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),value:e.equipment.maintenance,icon:"ğŸ› ï¸",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"maintenance.highPriority",label:i("home.summary.maintenanceHigh","Ø¨Ù„Ø§ØºØ§Øª ØµÙŠØ§Ù†Ø© Ø¹Ø§Ø¬Ù„Ø©"),value:e.maintenance.highPriority,icon:"âš¡",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"technicians.busy",label:i("home.summary.techniciansBusy","Ø£Ø¹Ø¶Ø§Ø¡ Ø·Ø§Ù‚Ù… Ù…Ø´ØºÙˆÙ„ÙˆÙ†"),value:e.technicians.busy,icon:"ğŸ‘·",accent:"secondary",href:"dashboard.html#technicians-tab",dashboardTab:"technicians-tab"}]}const P={primary:"bg-primary/10 text-primary",success:"bg-success/10 text-success",info:"bg-info/10 text-info",warning:"bg-warning/10 text-warning",error:"bg-error/10 text-error",secondary:"bg-secondary/10 text-secondary"};function Z(e){if(typeof D!="function")return;const t=["dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"],a={};if(t.forEach(n=>{Object.prototype.hasOwnProperty.call(e,n)&&(a[n]=e[n]??null)}),Object.keys(a).length!==0)try{const n=D(a);n&&typeof n.catch=="function"&&n.catch(l=>{console.warn("âš ï¸ [home] Failed to persist navigation preference",l)})}catch(n){console.warn("âš ï¸ [home] Failed to persist navigation preference",n)}}function ee(e){e.querySelectorAll("[data-summary-card]").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{const a={};t.dataset.dashboardTab!==void 0&&(a.dashboardTab=t.dataset.dashboardTab||null),t.dataset.dashboardSubtab!==void 0&&(a.dashboardSubTab=t.dataset.dashboardSubtab||null),t.dataset.projectsTab!==void 0&&(a.projectsTab=t.dataset.projectsTab||null),t.dataset.projectsSubtab!==void 0&&(a.projectsSubTab=t.dataset.projectsSubtab||null),Object.keys(a).length>0&&Z(a)}),t.dataset.listenerAttached="true")})}function te(e){const t=["glass-card","summary-card","flex","flex-col","items-center","gap-2","p-5","text-center","transition","duration-200","hover:-translate-y-1","focus-visible:outline","focus-visible:outline-2","focus-visible:outline-offset-2","focus-visible:outline-primary"],a=["data-summary-card"],n=p=>String(p??"").replace(/"/g,"&quot;");e.href&&a.push(`href="${n(e.href)}"`),e.dashboardTab!==void 0&&a.push(`data-dashboard-tab="${n(e.dashboardTab??"")}"`),e.dashboardSubTab!==void 0&&a.push(`data-dashboard-subtab="${n(e.dashboardSubTab??"")}"`),e.projectsTab!==void 0&&a.push(`data-projects-tab="${n(e.projectsTab??"")}"`),e.projectsSubTab!==void 0&&a.push(`data-projects-subtab="${n(e.projectsSubTab??"")}"`);const l=G(String(e.value??0)),b=n(e.label),f=P[e.accent]||P.primary;return`
    <a ${a.join(" ")} class="${t.join(" ")}" aria-label="${b}">
      <span class="summary-card__icon flex h-12 w-12 items-center justify-center rounded-2xl text-2xl ${f}">${e.icon}</span>
      <span class="summary-card__label text-sm font-medium text-base-content/70">${e.label}</span>
      <span class="summary-card__value text-3xl font-bold text-base-content">${l}</span>
    </a>
  `}function g(){const e=document.querySelector("[data-home-summary]");if(!e)return;if(S){e.innerHTML=`
      <div class="w-full text-center text-base-content/60" data-i18n data-i18n-key="home.summary.loading">
        ${i("home.summary.loading","â³ Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…...")}
      </div>
    `;return}if(T){e.innerHTML=`
      <div class="alert alert-warning" role="alert">
        ${T}
      </div>
    `;return}if(!h){e.innerHTML=`
      <div class="w-full text-center text-base-content/60">
        ${i("home.summary.empty","Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª.")} 
      </div>
    `;return}const t=Y(h);e.innerHTML=t.map(te).join(""),ee(e)}async function w({silent:e=!1}={}){if(!S){S=!0,e||g();try{const t=await U("/summary/");h=J(t?.data??null),h=$(h),T=""}catch(t){console.error("âŒ [home] Failed to load summary data",t),h=$(null),T=t instanceof z?t.message:i("home.summary.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹")}finally{S=!1,g()}}}function m(){w({silent:!0}).catch(e=>{console.error("âŒ [home] Summary refresh failed",e)})}const v=document.getElementById("home-refresh-summary");v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{m()}),v.dataset.listenerAttached="true");document.addEventListener("language:translationsReady",()=>{y(),g()});document.addEventListener("language:changed",()=>{y(),g()});function k(){M();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>F()),e.dataset.listenerAttached="true"),I({refresh:!0}).then(t=>{j=t?.username||"",E=(t?.role||"").toLowerCase(),y(),L()}).catch(()=>{j="",E="",y(),L()}),y(),L(),g(),w(),document.addEventListener("customers:changed",m,{passive:!0}),document.addEventListener("reservations:changed",m,{passive:!0}),document.addEventListener("equipment:changed",m,{passive:!0}),document.addEventListener("maintenance:updated",m,{passive:!0}),document.addEventListener("technicians:updated",m,{passive:!0}),document.addEventListener("projects:changed",m,{passive:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{k()},{once:!0}):k();
