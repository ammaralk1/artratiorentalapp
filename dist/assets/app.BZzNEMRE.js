const SE={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_BASE_URL:"http://127.0.0.1:8000/api"},AE="/backend/api";class Ge extends Error{constructor(t,{status:n,payload:a}={}){super(t),this.name="ApiError",this.status=n??null,this.payload=a??null}}function EE(){const e=typeof import.meta<"u"&&SE&&"http://127.0.0.1:8000/api",t=typeof window<"u"?window.APP_API_BASE:null;return String(e||t||AE).replace(/\/$/,"")}async function pe(e,{method:t="GET",headers:n={},body:a,signal:s,credentials:r="include"}={}){let i=e;try{if(typeof URL<"u"&&e instanceof URL)i=e.href;else if(typeof Request<"u"&&e instanceof Request)i=e.url;else if(e&&typeof e=="object"){const g=e.path||e.url||e.endpoint||null;i=String(g||e)}}catch{}typeof i!="string"&&(i=String(i||""));const o=/^https?:\/\//i.test(i),l=o||i.charAt(0)==="/"?i:`/${i}`,d=o?l:`${EE()}${l}`,u={Accept:"application/json",...n},m={method:t,headers:u,signal:s,credentials:r};a!==void 0&&(a instanceof FormData?(delete u["Content-Type"],m.body=a):typeof a=="string"?(u["Content-Type"]=u["Content-Type"]||"application/json",m.body=a):(u["Content-Type"]=u["Content-Type"]||"application/json",m.body=JSON.stringify(a)));const p=await fetch(d,m),f=p.headers.get("content-type")||"";let h=null;if(f.includes("application/json"))try{h=await p.json()}catch{throw new Ge("Failed to parse server response as JSON",{status:p.status})}else{const g=await p.text();h=g?{raw:g}:null}if(!p.ok){const g=h?.error||`Request failed with status ${p.status}`;throw new Ge(g,{status:p.status,payload:h})}if(h&&typeof h=="object"&&h.ok===!1){const g=h.error||"API returned an error response";throw new Ge(g,{status:p.status,payload:h})}return h}const sa=Object.freeze({language:"ar",theme:"light",dashboardTab:null,dashboardSubTab:null,projectsTab:null,projectsSubTab:null});let zn=null,Ko=null;const Jd=new Set,sg="__ART_RATIO_SKIP_PREF_FETCH__",rg="__ART_RATIO_PREFERENCES__";function ig(){try{return typeof window>"u"?!1:!!window[sg]}catch{return!1}}function wE(){try{typeof window<"u"&&delete window[sg]}catch{}}function xr(e={}){const t=e.language==="en"?"en":"ar",n=e.theme==="dark"?"dark":"light",a=typeof e.dashboardTab=="string"?Wo(e.dashboardTab):null,s=typeof e.dashboardSubTab=="string"?Wo(e.dashboardSubTab):null,r=typeof e.projectsTab=="string"?Wo(e.projectsTab):null,i=typeof e.projectsSubTab=="string"?Wo(e.projectsSubTab):null;return{language:t,theme:n,dashboardTab:a,dashboardSubTab:s,projectsTab:r,projectsSubTab:i}}function Wo(e){const t=String(e||"").trim();return t&&/^[a-z0-9\-]+$/i.test(t)?t:null}function jE(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(rg);if(!e)return null;const t=JSON.parse(e);return xr(t)}catch(e){return console.warn("⚠️ [preferencesService] Failed to read cached preferences",e),null}}function IE(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.setItem(rg,JSON.stringify(e))}catch(t){console.warn("⚠️ [preferencesService] Failed to persist preferences",t)}}const Df=jE();Df&&(zn=Df);function xE(){const e=lt();Jd.forEach(t=>{try{t(e)}catch(n){console.error("⚠️ [preferencesService] listener failed",n)}})}function hs(e){const n={...zn?{...zn}:{...sa},...e};zn=xr(n),IE(zn),xE()}function lt(){return zn?{...zn}:null}function El(e){if(typeof e!="function")return()=>{};if(Jd.add(e),zn)try{e(lt())}catch(t){console.error("⚠️ [preferencesService] listener failed",t)}return()=>{Jd.delete(e)}}function wl({refresh:e=!1}={}){if(ig()){const t=lt()||{...sa};return Promise.resolve(t)}return!e&&zn?Promise.resolve(lt()):(Ko||(Ko=pe("/preferences/").then(t=>{const n=t?.data??sa;return hs(n),lt()}).catch(t=>t instanceof Ge&&t.status===401?(zn=null,sa):(console.warn("⚠️ [preferencesService] Failed to load preferences",t),hs(sa),sa)).finally(()=>{Ko=null})),Ko)}function qE(e=null){if(!e){const t=lt();return xr(t||sa)}return xr(e)}async function Ft(e={}){if(ig())return hs(e),lt()||{...sa};e.language!==void 0&&e.language,e.theme!==void 0&&e.theme,e.dashboardTab!==void 0&&e.dashboardTab,e.dashboardSubTab!==void 0&&e.dashboardSubTab,e.projectsTab!==void 0&&e.projectsTab,e.projectsSubTab!==void 0&&e.projectsSubTab;const t=qE(),n={...t,...e},a=xr(n),s={},r={};["language","theme","dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"].forEach(d=>{if(e[d]===void 0)return;const u=a[d],m=t[d];u!==m&&(s[d]=u,(d==="language"||d==="theme")&&(r[d]=u))});const o=Object.keys(s).length>0,l=Object.keys(r).length>0;if(!l&&!o)return lt();if(!l&&o)return hs(a),lt();try{const d=await pe("/preferences/",{method:"PATCH",body:r});return hs(d?.data??sa),o&&hs({...lt(),...s}),lt()}catch(d){if(d instanceof Ge&&d.status===422)return console.warn("⚠️ [preferencesService] Server rejected preference update (no changes)."),hs(a),lt();throw d}}const qs="ar",kE="ar",_E="language-loading",Bf="language-ready",og=["Placeholder","Title","AriaLabel","AriaDescription","Value"],Wi={ar:Object.create(null),en:Object.create(null)};let Fs=qs,Mc=!1,pd=null;function Qi(e){return e==="en"?"en":"ar"}function cg(){if(!pd){const e=lt();if(e?.language){const t=Qi(e.language);Ni(t,{persist:!1,dispatch:!1})}pd=wl().then(t=>{const n=Qi(t?.language??qs);return Ni(n,{persist:!1}),Mc=!0,n}).catch(t=>(console.warn("⚠️ تعذر تحميل تفضيل اللغة من الخادم",t),Ni(qs,{persist:!1}),Mc=!0,qs))}return pd}function TE(e){if(e.dataset.i18nCached==="true")return;e.dataset.i18nHtml==="true"?e.dataset.arHtml===void 0&&(e.dataset.arHtml=e.innerHTML):e.dataset.ar===void 0&&(e.dataset.ar=e.textContent),og.forEach(n=>{const a=n.charAt(0).toLowerCase()+n.slice(1),s=e.getAttribute(a);s!=null&&e.dataset[`ar${n}`]===void 0&&(e.dataset[`ar${n}`]=s)}),e.dataset.i18nCached="true"}function Ff(e,t){if(!t)return;const n=Wi[e]??(Wi[e]=Object.create(null));Object.entries(t).forEach(([a,s])=>{typeof a=="string"&&(n[a]=s)})}function Rf(e,t){if(!t)return;const n=Wi[e];return n?n[t]:void 0}function CE(e,t){TE(e);const n=e.dataset.i18nHtml==="true",a=e.dataset.i18nKey,s=Rf(t,a);s!==void 0?n?e.innerHTML=s:e.textContent=s:t==="en"?n?e.dataset.enHtml!==void 0&&(e.innerHTML=e.dataset.enHtml):e.dataset.en!==void 0&&(e.textContent=e.dataset.en):n?e.innerHTML=e.dataset.arHtml??e.innerHTML:e.textContent=e.dataset.ar??e.textContent,og.forEach(r=>{const i=r.charAt(0).toLowerCase()+r.slice(1),o=e.dataset[`i18n${r}Key`],l=Rf(t,o);if(l!==void 0){e.setAttribute(i,l);return}const d=t==="en"?`en${r}`:`ar${r}`,u=e.dataset[d];u!==void 0&&e.setAttribute(i,u)})}function lg(e){document.querySelectorAll("[data-i18n]").forEach(n=>CE(n,e))}function PE(e){const t=document.documentElement,n=document.body,a=e===kE?"rtl":"ltr";t.setAttribute("lang",e),t.setAttribute("dir",a),n&&(n.setAttribute("dir",a),n.dataset.lang=e)}function LE(){const e=document.documentElement;e&&(e.classList.contains(Bf)||(e.classList.remove(_E),e.classList.add(Bf)))}function dg(e){document.querySelectorAll(".language-toggle-btn").forEach(t=>{const n=t.dataset.labelAr||"🇸🇦 العربية",a=t.dataset.labelEn||"🇬🇧 English";t.textContent=e==="en"?n:a,t.setAttribute("aria-pressed",e==="en"?"true":"false")})}function Ni(e,{persist:t=!1,dispatch:n=!0}={}){const a=Qi(e);Fs===a&&Mc&&!t||(Fs=a,Mc=!0,PE(a),lg(a),dg(a),LE(),n&&document.dispatchEvent(new CustomEvent("language:changed",{detail:{language:a}})),t&&Ft({language:a}).catch(s=>{console.warn("⚠️ تعذر حفظ تفضيل اللغة في الخادم",s)}))}function NE(){$E(Fs==="ar"?"en":"ar")}function ug(){document.querySelectorAll(".language-toggle-btn").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{NE()}),t.dataset.listenerAttached="true")}),dg(Fs)}function Zr(e={}){Ff("ar",e.ar),Ff("en",e.en);const t=Le();lg(t),document.dispatchEvent(new CustomEvent("language:translationsReady",{detail:{language:t}}))}function c(e,t=""){if(!e)return t;const n=Fs||qs,a=Wi[n];if(a&&a[e]!==void 0)return a[e];const r=Wi[n==="en"?"ar":"en"];return r&&r[e]!==void 0?r[e]:t}function $E(e){const t=Qi(e);Ni(t,{persist:!0})}function DE(){cg().catch(()=>qs).finally(()=>{ug()})}function Le(){return Fs}function Mf(){cg().catch(()=>qs),ug()}El(e=>{e&&e.language&&Qi(e.language)!==Fs&&Ni(e.language,{persist:!1})});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Mf,{once:!0}):Mf();Zr({ar:{"actions.logout":"🚪 تسجيل الخروج","actions.toggleTheme":"🌙 الوضع الليلي","theme.toggle.toLight":"☀️ الوضع العادي","theme.toggle.toDark":"🌙 الوضع الليلي","theme.toggle.titleLight":"التبديل إلى الوضع العادي","theme.toggle.titleDark":"التبديل إلى الوضع الليلي","theme.toggle.ariaLight":"الوضع العادي مفعل","theme.toggle.ariaDark":"الوضع الليلي مفعل","common.boolean.yes":"نعم","common.boolean.no":"لا","language.toggle.labelAr":"🇸🇦 العربية","language.toggle.labelEn":"🇬🇧 English","login.pageTitle":"تسجيل الدخول","login.header.title":"🔐 تسجيل الدخول","login.header.subtitle":"أدخل بيانات الحساب للوصول إلى لوحة التحكم.","login.form.username":"اسم المستخدم","login.form.username.placeholder":"أدخل اسم المستخدم","login.form.password":"كلمة المرور","login.form.password.placeholder":"أدخل كلمة المرور","login.form.password.toggleShow":"إظهار كلمة المرور","login.form.password.toggleHide":"إخفاء كلمة المرور","login.form.submit":"دخول","login.errors.invalidCredentials":"❌ بيانات الدخول غير صحيحة","login.errors.network":"🌐 تعذر الاتصال بالخادم. حاول مرة أخرى.","login.errors.generic":"⚠️ حدث خطأ غير متوقع. حاول مرة أخرى.","login.footer.note":"محمي لأعضاء فريق Art Ratio. تواصل معنا إذا واجهت مشكلة في تسجيل الدخول.","actions.clearFilters":"🔄 إعادة التصفية","actions.view":"👁️ عرض","actions.delete":"🗑️ حذف","actions.remove":"إزالة","auth.permissions.denied":"⚠️ ليس لديك صلاحية لتنفيذ هذا الإجراء","home.nav.brand":"لوحة التحكم","home.hero.title":"مرحباً بك","home.hero.subtitle":"اختر المسار المناسب لإدارة أعمالك.","home.hero.greetingUser":"مرحباً {name}","home.bookings.title":"إدارة الحجوزات","home.bookings.description":"الوصول إلى لوحة التحكم الكاملة لإدارة الحجوزات، المعدات، الصيانة، والطاقم.","home.bookings.button":"انتقال إلى لوحة التحكم","home.projects.title":"إدارة المشاريع","home.projects.description":"إنشاء ومتابعة المشاريع، توزيع الطاقم والمعدات، وتتبع المصروفات المرتبطة بكل مشروع.","home.projects.button":"فتح لوحة المشاريع","home.users.title":"إدارة المستخدمين","home.users.description":"إنشاء المستخدمين، تعديل الصلاحيات، والاطلاع على سجلات الجلسات والنشاط.","home.users.button":"إدارة المستخدمين","actions.refresh":"🔄 تحديث البيانات","home.summary.title":"📊 ملخص سريع","home.summary.subtitle":"أرقام مختصرة تساعدك على اتخاذ القرار بسرعة.","home.summary.loading":"⏳ جارٍ جلب بيانات النظام...","home.summary.error":"تعذر تحميل بيانات النظام، حاول لاحقاً","home.summary.empty":"لا تتوفر بيانات بعد. ابدأ بإضافة سجلات.","home.summary.customers":"إجمالي العملاء","home.summary.reservationsToday":"حجوزات اليوم","home.summary.reservationsUpcoming":"حجوزات قادمة","home.summary.projectsActive":"مشاريع نشطة","home.summary.equipmentMaintenance":"معدات قيد الصيانة","home.summary.maintenanceHigh":"بلاغات صيانة عاجلة","home.summary.techniciansBusy":"أعضاء طاقم مشغولون"},en:{"actions.logout":"🚪 Log Out","actions.toggleTheme":"🌙 Dark Mode","theme.toggle.toLight":"☀️ Light Mode","theme.toggle.toDark":"🌙 Dark Mode","theme.toggle.titleLight":"Switch to Light Mode","theme.toggle.titleDark":"Switch to Dark Mode","theme.toggle.ariaLight":"Light mode enabled","theme.toggle.ariaDark":"Dark mode enabled","common.boolean.yes":"Yes","common.boolean.no":"No","language.toggle.labelAr":"🇸🇦 Arabic","language.toggle.labelEn":"🇬🇧 English","login.pageTitle":"Log In","login.header.title":"🔐 Log In","login.header.subtitle":"Enter your account credentials to access the dashboard.","login.form.username":"Username","login.form.username.placeholder":"Enter username","login.form.password":"Password","login.form.password.placeholder":"Enter password","login.form.password.toggleShow":"Show password","login.form.password.toggleHide":"Hide password","login.form.submit":"Sign In","login.errors.invalidCredentials":"❌ Incorrect username or password","login.errors.network":"🌐 Unable to reach the server. Please try again.","login.errors.generic":"⚠️ Something went wrong. Please try again.","login.footer.note":"Restricted to Art Ratio team members. Contact us if you run into any login issues.","actions.clearFilters":"🔄 Reset filters","actions.view":"👁️ View","actions.delete":"🗑️ Delete","actions.remove":"Remove","auth.permissions.denied":"⚠️ You do not have permission to perform this action","home.nav.brand":"Control Panel","home.hero.title":"Welcome","home.hero.subtitle":"Choose the best path to manage your operations.","home.hero.greetingUser":"Welcome {name}","home.bookings.title":"Bookings Management","home.bookings.description":"Access the full dashboard for bookings, equipment, maintenance, and crew.","home.bookings.button":"Open Dashboard","home.projects.title":"Projects Management","home.projects.description":"Create and follow up on projects, assign crew and equipment, and track expenses.","home.projects.button":"Open Projects Hub","home.users.title":"User Management","home.users.description":"Create accounts, adjust roles, and review session and activity logs.","home.users.button":"Manage Users","actions.refresh":"🔄 Refresh data","home.summary.title":"📊 Quick Snapshot","home.summary.subtitle":"Key metrics that keep you informed at a glance.","home.summary.loading":"⏳ Fetching system metrics...","home.summary.error":"Unable to load system metrics. Please try again later.","home.summary.empty":"No data yet. Start by adding your first records.","home.summary.customers":"Total Customers","home.summary.reservationsToday":"Reservations Today","home.summary.reservationsUpcoming":"Upcoming Reservations","home.summary.projectsActive":"Active Projects","home.summary.equipmentMaintenance":"Equipment in Maintenance","home.summary.maintenanceHigh":"Urgent Maintenance Tickets","home.summary.techniciansBusy":"Crew Members Busy"}});Zr({ar:{"dashboard.header.greeting":"👋 أهلاً بك في لوحة التحكم","dashboard.header.toggleLabel":"لوحة التحكم","dashboard.sidebar.title":"مركز التحكم","dashboard.sidebar.statsHeading":"ملخص اليوم","dashboard.sidebar.tabsHeading":"التبويبات","dashboard.sidebar.quickLinksHeading":"روابط سريعة","dashboard.hero.title":"مركز إدارة التأجير","dashboard.actions.addProject":"➕ إضافة مشروع","dashboard.metrics.projects.label":"المشاريع","dashboard.metrics.projects.caption":"مشاريع نشطة هذا الشهر","dashboard.metrics.reservations.label":"الحجوزات","dashboard.metrics.reservations.caption":"متابعة جدول الفعاليات","dashboard.metrics.equipment.label":"المعدات","dashboard.metrics.equipment.caption":"الأصول المتاحة حالياً","dashboard.metrics.technicians.label":"طاقم العمل","dashboard.metrics.technicians.caption":"أعضاء جاهزون للتكليف","dashboard.quickLinks.home":"الصفحة الرئيسية","dashboard.quickLinks.projects":"إدارة المشاريع","dashboard.quickLinks.reports":"تقارير المشاريع","dashboard.quickLinks.users":"إدارة المستخدمين","tabs.customers":"👤 العملاء","tabs.equipment":"🎥 المعدات","tabs.maintenance":"🛠️ الصيانة","tabs.technicians":"😎 طاقم العمل","tabs.reservations":"📅 الحجوزات","actions.close":"إغلاق","actions.cancel":"إلغاء","actions.goHome":"🏠 الرئيسية","customers.section.title":"📋 إدارة العملاء","customers.form.title":"إضافة / تعديل عميل","customers.form.hint":"حدّث بيانات العميل وسيتم مزامنتها مع الحجوزات والفواتير.","customers.form.labels.name":"👤 الاسم","customers.form.labels.phone":"📞 الجوال","customers.form.labels.email":"📧 البريد","customers.form.labels.address":"📍 العنوان","customers.form.labels.company":"🏢 الشركة","customers.form.labels.taxId":"🧾 الرقم الضريبي","customers.form.labels.document":"📎 مستند العميل","customers.form.labels.documentName":"📄 اسم الملف","customers.form.document.placeholder":"https://example.com/document.pdf","customers.form.document.helper":"يمكنك لصق رابط مباشر للمستند أو لملف مخزن.","customers.form.document.namePlaceholder":"invoice.pdf","customers.form.labels.notes":"📝 الملاحظات","customers.form.placeholders.name":"اسم العميل","customers.form.placeholders.phone":"05xxxxxxxx","customers.form.placeholders.email":"example@email.com","customers.form.placeholders.address":"عنوان العميل","customers.form.placeholders.company":"اسم الشركة","customers.form.placeholders.taxId":"1234567890","customers.form.placeholders.notes":"معلومات إضافية أو تذكيرات","customers.form.actions.cancel":"إلغاء التعديل","customers.form.actions.submit":"➕ إضافة عميل","customers.form.actions.update":"💾 حفظ التعديل","customers.form.actions.previewDocument":"عرض الملف","customers.form.document.empty":"لم يتم اختيار ملف بعد","customers.form.document.uploading":"📤 جارٍ رفع الملف...","customers.form.document.uploadFailed":"⚠️ فشل رفع الملف","customers.form.document.selected":"تم إرفاق ملف.","customers.form.document.uploadingWait":"⏳ يرجى الانتظار حتى يكتمل رفع الملف","customers.form.document.uploadSuccess":"✅ تم رفع الملف بنجاح","customers.search.placeholder":"🔍 ابحث عن عميل بالاسم أو الجوال أو الشركة...","customers.table.headers.name":"👤 الاسم","customers.table.headers.phone":"📞 الجوال","customers.table.headers.company":"🏢 الشركة","customers.table.headers.notes":"📝 ملاحظات","customers.table.headers.actions":"⚙️ الإجراءات","customers.table.loading":"جاري التحميل...","customers.table.empty":"لا يوجد عملاء","customers.table.noResults":"لا توجد نتائج مطابقة","customers.actions.edit":"✏️ تعديل","customers.actions.delete":"🗑️ حذف","customers.actions.viewDocument":"📎 عرض الملف","customers.documents.missing":"لا يوجد ملف لعرضه","customers.documents.unsupportedPreview":"لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل.","customers.toast.updateSuccess":"تم تحديث بيانات العميل بنجاح","customers.toast.createSuccess":"تمت إضافة العميل بنجاح","customers.toast.missingFields":"يرجى تعبئة الاسم ورقم الهاتف","customers.toast.deleteConfirm":"⚠️ هل أنت متأكد من حذف هذا العميل؟","customers.toast.deleteSuccess":"تم حذف العميل","customers.toast.fetchFailed":"تعذر تحميل قائمة العملاء","customers.toast.submitFailed":"حدث خطأ أثناء حفظ بيانات العميل","customers.toast.deleteFailed":"تعذر حذف العميل، يرجى المحاولة مجدداً","equipment.section.title":"🎥 إدارة المعدات","equipment.actions.clearAll":"🗑️ مسح الكل","equipment.actions.uploadExcel":"📤 رفع من Excel","equipment.form.title":"إضافة معدة","equipment.form.hint":"أدخل بيانات المعدة ليتم حفظها ضمن قائمة المعدات.","equipment.form.labels.description":"📝 الوصف","equipment.form.placeholders.description":"وصف المعدة","equipment.form.labels.barcode":"🏷️ الباركود","equipment.form.placeholders.barcode":"الباركود","equipment.form.labels.price":"💵 السعر","equipment.form.placeholders.price":"0","equipment.form.labels.quantity":"🔢 الكمية","equipment.form.placeholders.quantity":"1","equipment.form.labels.image":"🖼️ رابط الصورة","equipment.form.placeholders.image":"https://...","equipment.form.labels.category":"📂 القسم","equipment.form.placeholders.category":"القسم","equipment.form.labels.subcategory":"📑 القسم الثانوي","equipment.form.placeholders.subcategory":"القسم الثانوي","equipment.form.labels.status":"⚙️ الحالة","equipment.form.options.available":"✅ متاح","equipment.form.options.booked":"📌 محجوز","equipment.form.options.maintenance":"🛠️ صيانة","equipment.form.options.retired":"📦 خارج الخدمة","equipment.form.actions.submit":"➕ إضافة معدة","equipment.filters.search":"🔍 ابحث عن معدة...","equipment.filters.status.all":"⚙️ الحالات","equipment.filters.category.all":"📂 الأقسام","equipment.filters.subcategory.all":"📑 الأقسام الثانوية","equipment.list.title":"📋 كل المعدات","equipment.list.loading":"⏳ جاري تحميل المعدات...","equipment.list.empty":"لا توجد معدات مسجلة بعد.","equipment.card.labels.description":"الوصف","equipment.card.labels.status":"الحالة","equipment.card.labels.alias":"الاسم","equipment.card.labels.quantity":"الكمية","equipment.card.labels.price":"السعر","equipment.card.labels.category":"القسم","equipment.card.labels.subcategory":"القسم الثانوي","equipment.card.labels.barcode":"الباركود","equipment.card.labels.available":"المتاح","equipment.card.labels.availableOfTotal":"من أصل","equipment.card.availability.reservedSingle":"مؤجرة","equipment.card.availability.reserved":"مؤجرة بالكامل","equipment.card.availability.maintenance":"تحت الصيانة","equipment.card.availability.retired":"غير متاحة","equipment.card.availability.unavailable":"غير متاحة حالياً","equipment.modal.title":"✏️ تعديل بيانات المعدة","equipment.modal.title.details":"📇 تفاصيل بطاقة المعدة","equipment.modal.placeholders.image":"ضع رابط مباشر للصورة","equipment.modal.actions.cancel":"❌ إلغاء","equipment.modal.actions.close":"❌ إغلاق","equipment.modal.actions.edit":"✏️ تعديل","equipment.modal.actions.cancelEdit":"↩️ إلغاء التعديل","equipment.modal.actions.save":"💾 حفظ التعديلات","equipment.toast.xlsxMissing":"⚠️ مكتبة Excel (XLSX) غير محملة. تحقق من الروابط في dashboard.html","equipment.toast.uploadSuccess":"✅ تم رفع المعدات بنجاح","equipment.toast.uploadEmpty":"⚠️ الملف لا يحتوي على بيانات يمكن استيرادها","equipment.toast.uploadFailed":"❌ حدث خطأ أثناء قراءة ملف الإكسل","equipment.toast.clearConfirm":"⚠️ هل أنت متأكد من حذف كل المعدات؟","equipment.toast.clearSuccess":"🗑️ تم مسح جميع المعدات","equipment.toast.deleteConfirm":"❌ هل أنت متأكد من حذف هذه المعدة؟","equipment.toast.deleteSuccess":"🗑️ تم حذف المعدة","equipment.toast.editSuccess":"✏️ تم تعديل بيانات المعدة","equipment.toast.addSuccess":"✅ تم إضافة المعدة","equipment.toast.updateSuccess":"✅ تم تحديث بيانات المعدة بنجاح","equipment.toast.missingFields":"⚠️ يرجى إدخال الوصف والباركود","equipment.toast.duplicateBarcode":"⚠️ هذا الباركود مستخدم مسبقًا","equipment.list.emptyFiltered":"⚠️ لا توجد معدات مطابقة.","equipment.list.countSuffix":"عنصر","equipment.item.imageAlt":"صورة","equipment.item.currency":"SR","equipment.item.actions.edit":"✏️ تعديل","equipment.item.actions.delete":"🗑️ حذف","reservations.tabs.create":"➕ إنشاء حجز","reservations.tabs.mine":"📋 حجوزاتي","reservations.tabs.reports":"📊 تقارير","reservations.tabs.calendar":"📅 التقويم","reservations.create.title":"➕ إنشاء حجز جديد","reservations.create.labels.startDate":"📅 تاريخ البداية","reservations.create.labels.startTime":"⏰ وقت البداية","reservations.create.labels.endDate":"📅 تاريخ النهاية","reservations.create.labels.endTime":"⏰ وقت النهاية","reservations.create.labels.client":"👤 العميل","reservations.create.placeholders.client":"اكتب اسم العميل...","reservations.create.labels.project":"📁 المشروع المرتبط","reservations.create.placeholders.project":"اختر مشروعاً (اختياري)","reservations.create.project.pendingPlaceholder":"سيتم الربط بعد حفظ المشروع الحالي","reservations.create.project.pendingTooltip":"احفظ المشروع الحالي أولاً ليتم تفعيل اختيار المشروع المرتبط.","reservations.create.labels.notes":"📝 ملاحظات","reservations.create.placeholders.notes":"اكتب أي ملاحظات إضافية...","reservations.create.equipment.title":"🎥 أضف المعدات","reservations.create.equipment.placeholders.barcode":"🔍 امسح أو أدخل الباركود ثم اضغط Enter","reservations.create.equipment.placeholders.description":"🎥 اكتب اسم المعدة ثم اضغط Enter","reservations.equipment.table.item":"المعدة","reservations.equipment.table.quantity":"الكمية","reservations.equipment.table.unitPrice":"سعر الوحدة","reservations.equipment.table.total":"الإجمالي","reservations.equipment.table.actions":"الإجراءات","reservations.equipment.actions.increase":"زيادة الكمية","reservations.equipment.actions.decrease":"تقليل الكمية","reservations.equipment.actions.remove":"إزالة البند","reservations.equipment.barcodes.summary":"عرض الباركودات","equipment.modal.variants.title":"📦 القطع المرتبطة","equipment.modal.variants.barcode":"الباركود","equipment.modal.variants.status":"الحالة","equipment.modal.variants.quantity":"الكمية","equipment.modal.variants.actions":"الإجراءات","equipment.modal.variants.empty":"لا توجد قطع مرتبطة أخرى.","equipment.modal.variants.current":"الحالي","reservations.create.billing.title":"💵 الخصم والضريبة","reservations.create.billing.discount":"ادخل قيمة الخصم","reservations.create.billing.discountPercent":"٪ نسبة","reservations.create.billing.discountAmount":"💵 مبلغ","reservations.create.billing.companyShare":"🏦 نسبة الشركة","reservations.create.billing.companyShareToggle":"إضافة نسبة الشركة (10٪)","reservations.create.billing.taxLabel":"شامل الضريبة (15٪)","reservations.create.labels.paymentStatus":"💳 حالة الدفع","reservations.create.paymentStatus.paid":"مدفوع","reservations.create.paymentStatus.partial":"مدفوع جزئياً","reservations.create.paymentStatus.unpaid":"لم يتم الدفع","reservations.create.paymentProgress.label":"💰 الدفعة المستلمة","reservations.create.paymentProgress.amount":"💵 مبلغ","reservations.create.paymentProgress.percent":"٪ نسبة","reservations.create.paymentProgress.placeholder":"50","reservations.create.paymentProgress.hint":"اكتب النسبة أو المبلغ الذي تم استلامه من إجمالي الحجز","reservations.toast.linkedProjectDisabled":"لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع.","reservations.paymentHistory.title":"سجل الدفعات","reservations.paymentHistory.empty":"لا توجد دفعات مسجلة","reservations.paymentHistory.headers.method":"نوع الدفعة","reservations.paymentHistory.headers.amount":"المبلغ","reservations.paymentHistory.headers.percent":"النسبة","reservations.paymentHistory.headers.date":"التاريخ","reservations.paymentHistory.headers.note":"ملاحظات","reservations.paymentHistory.actions.add":"➕ إضافة دفعة","reservations.paymentHistory.actions.delete":"حذف الدفعة","reservations.paymentHistory.type.amount":"دفعة مالية","reservations.paymentHistory.type.percent":"دفعة نسبة","reservations.paymentHistory.type.unknown":"دفعة","reservations.paymentHistory.countLabel":"{count} دفعة","reservations.toast.paymentInvalid":"⚠️ يرجى إدخال قيمة دفعة صحيحة","reservations.toast.paymentAdded":"✅ تم تسجيل الدفعة","reservations.toast.paymentRemoved":"🗑️ تم حذف الدفعة","reservations.create.actions.submit":"💾 إنشاء الحجز","reservations.section.title":"📅 إدارة الحجوزات","reservations.crew.none":"لم يتم اختيار أي عضو من الطاقم.","reservations.crew.noneShort":"لم يتم اختيار أي عضو بعد","reservations.crew.selectedCount":"تم اختيار {count} عضو","reservations.crew.fallbackName":"عضو الطاقم {id}","reservations.crew.removeAria":"إزالة","reservations.crew.searchEmpty":"لا يوجد نتائج مطابقة.","reservations.create.equipment.noResults":"لا يوجد نتائج مطابقة.","reservations.create.equipment.noneAdded":"لا توجد معدات مضافة","reservations.create.equipment.none":"لا توجد معدات","reservations.create.summary.currency":"SR","reservations.create.equipment.imageAlt":"صورة","reservations.summary.total":"💰 التكلفة الإجمالية: <strong>{total} {currency}</strong>","reservations.summary.totalAfterEdit":"💰 التكلفة بعد التعديل: <strong>{total} {currency}</strong>","reservations.summary.itemsCount":"📦 عدد المعدات: {count}","reservations.summary.crewCount":"😎 عدد الفريق: {count}","reservations.summary.companyShareLabel":"🏦 نسبة الشركة","reservations.summary.taxIncluded":"شامل الضريبة 15%","reservations.summary.taxExcluded":"غير شامل الضريبة","reservations.summary.paymentLabel":"💳 حالة الدفع: {status}","reservations.summary.itemsLabel":"📦 عدد المعدات","reservations.summary.durationLabel":"⏱️ عدد الأيام","reservations.summary.crewLabel":"😎 عدد الفريق","reservations.summary.taxLabelShort":"🧾 الضريبة","reservations.summary.paymentLabelShort":"💳 حالة الدفع","reservations.summary.paymentProgressLabel":"💰 الدفعة المستلمة","reservations.summary.taxIncludedValue":"شامل 15%","reservations.summary.taxExcludedValue":"غير شامل","reservations.summary.totalLabel":"💰 التكلفة الإجمالية","reservations.toast.customerNotFound":"⚠️ لم يتم العثور على العميل بالاسم المدخل","reservations.toast.invalidDateOrder":"⚠️ تاريخ البداية لا يمكن أن يكون بعد تاريخ النهاية","reservations.toast.reservationMissing":"⚠️ تعذر العثور على الحجز المطلوب","reservations.list.title":"📋 حجوزاتي","reservations.list.search.placeholder":"🔍 ابحث باسم العميل أو الكود...","reservations.list.filters.start":"📅 من تاريخ","reservations.list.filters.end":"📅 إلى تاريخ","reservations.list.filters.range.all":"⏱️ كل التواريخ","reservations.list.filters.range.today":"📅 اليوم","reservations.list.filters.range.week":"📆 هذا الأسبوع","reservations.list.filters.range.month":"🗓️ هذا الشهر","reservations.list.filters.status.all":"⚙️ كل الحالات","reservations.list.filters.status.confirmed":"✅ مؤكدة","reservations.list.filters.status.pending":"⏳ غير مؤكدة","reservations.list.filters.status.completed":"📁 منتهية","reservations.list.empty":"⚠️ لا توجد حجوزات بعد.","reservations.list.noResults":"🔍 لا توجد حجوزات مطابقة للبحث.","reservations.list.taxIncludedShort":"(شامل الضريبة)","reservations.list.unknownCustomer":"غير معروف","reservations.list.noNotes":"لا توجد ملاحظات","reservations.list.project.unlinked":"غير مرتبط بمشروع","reservations.list.itemsCountShort":"{count} عنصر","reservations.list.crew.separator":"، ","reservations.list.status.confirmed":"✅ مؤكد","reservations.list.status.pending":"⏳ غير مؤكد","reservations.list.payment.paid":"💳 مدفوع","reservations.list.payment.partial":"💳 مدفوع جزئياً","reservations.list.payment.unpaid":"💳 غير مدفوع","reservations.list.status.completed":"📁 منتهي","reservations.list.ribbon.completed":"منتهي","reservations.list.actions.confirm":"✔️ تأكيد","reservations.list.labels.client":"👤 العميل","reservations.list.labels.project":"📁 المشروع","reservations.edit.modalTitle":"✏️ تعديل الحجز","reservations.edit.labels.id":"🆔 رقم الحجز","reservations.edit.labels.customer":"👤 العميل","reservations.edit.labels.project":"📁 المشروع المرتبط","reservations.edit.labels.startDate":"📅 تاريخ البداية","reservations.edit.labels.startTime":"⏰ وقت البداية","reservations.edit.labels.endDate":"📅 تاريخ النهاية","reservations.edit.labels.endTime":"⏰ وقت النهاية","reservations.edit.labels.discount":"💵 الخصم","reservations.edit.placeholders.discount":"ادخل قيمة الخصم","reservations.edit.discount.percent":"٪ نسبة","reservations.edit.discount.amount":"💵 مبلغ","reservations.edit.labels.tax":"شامل الضريبة (15%)","reservations.edit.labels.confirmed":"✅ تم التأكيد","reservations.edit.labels.paymentStatus":"💳 حالة الدفع","reservations.edit.payment.paid":"مدفوع","reservations.edit.payment.partial":"مدفوع جزئياً","reservations.edit.payment.unpaid":"لم يتم الدفع","reservations.edit.paymentProgress.label":"💰 الدفعات المستلمة","reservations.edit.paymentProgress.amount":"💵 مبلغ","reservations.edit.paymentProgress.percent":"٪ نسبة","reservations.edit.paymentProgress.placeholder":"50","reservations.edit.paymentProgress.hint":"حدّد مقدار الدفعة التي استلمتها من الحجز","reservations.edit.labels.notes":"📝 الملاحظات","reservations.edit.placeholders.notes":"اكتب أي ملاحظات...","reservations.edit.labels.addEquipment":"🎥 إضافة معدة","reservations.edit.project.missing":"⚠️ المشروع غير متوفر (تم حذفه)","reservations.edit.placeholders.barcode":"🔍 امسح أو أدخل الباركود ثم اضغط Enter","reservations.edit.placeholders.description":"🎥 اكتب اسم المعدة ثم اضغط Enter","reservations.edit.table.empty":"لا توجد معدات","reservations.edit.actions.save":"💾 حفظ التعديلات","reservations.edit.tech.headers.total":"التكلفة الإجمالية","reservations.list.labels.start":"🗓️ بداية الحجز","reservations.list.labels.end":"🗓️ نهاية الحجز","reservations.list.labels.cost":"💵 التكلفة","reservations.list.labels.equipment":"📦 المعدات","reservations.list.labels.crew":"😎 الفريق","reservations.details.labels.discount":"الخصم","reservations.details.labels.companyShare":"🏦 نسبة الشركة","reservations.details.labels.netProfit":"💵 صافي الربح","reservations.details.labels.subtotalAfterDiscount":"الإجمالي","reservations.details.labels.tax":"الضريبة (15%)","reservations.details.labels.crewTotal":"إجمالي الفريق","reservations.details.table.headers.code":"الكود","reservations.details.table.headers.description":"الوصف","reservations.details.table.headers.quantity":"الكمية","reservations.details.table.headers.price":"السعر","reservations.details.table.headers.image":"الصورة","reservations.details.noItems":"📦 لا توجد معدات ضمن هذا الحجز حالياً.","reservations.details.noCrew":"😎 لا يوجد فريق مرتبط بهذا الحجز.","reservations.details.project.unlinked":"غير مرتبط بأي مشروع.","reservations.details.technicians.roleUnknown":"غير محدد","reservations.details.technicians.phoneUnknown":"غير متوفر","reservations.details.technicians.wage":"{amount} {currency} / اليوم","reservations.details.labels.id":"🆔 رقم الحجز","reservations.details.section.bookingInfo":"بيانات الحجز","reservations.details.section.statusSummary":"ملخص الحالة","reservations.details.section.paymentSummary":"💳 ملخص الدفع","reservations.details.labels.finalTotal":"المجموع النهائي","reservations.details.section.crew":"😎 الفريق الفني","reservations.details.crew.count":"{count} عضو","reservations.details.section.items":"📦 المعدات المرتبطة","reservations.details.items.count":"{count} عنصر","reservations.details.actions.edit":"✏️ تعديل","reservations.details.actions.delete":"🗑️ حذف","reservations.details.actions.openProject":"📁 فتح المشروع","reservations.details.labels.customer":"العميل","reservations.details.labels.contact":"رقم التواصل","reservations.details.labels.project":"📁 المشروع المرتبط","reservations.details.labels.start":"بداية الحجز","reservations.details.labels.end":"نهاية الحجز","reservations.details.labels.notes":"ملاحظات","reservations.details.labels.itemsCount":"عدد المعدات","reservations.details.labels.itemsTotal":"إجمالي المعدات","reservations.details.labels.paymentStatus":"حالة الدفع","reservations.details.modalTitle":"📋 تفاصيل الحجز","reservations.calendar.title":"📅 التقويم","reservations.calendar.helper":"🎯 اختر أي حجز للاطلاع على التفاصيل.","calendar.legend.confirmed":"حجز مؤكد","calendar.legend.pending":"بانتظار التأكيد","calendar.legend.paid":"مدفوع بالكامل","calendar.legend.unpaid":"لم يتم الدفع","calendar.legend.completed":"منتهي","calendar.labels.allDay":"طوال اليوم","reservations.reports.title":"تقارير الأداء","reservations.reports.subtitle":"نظرة شاملة على الحجوزات والإيرادات ونسب الإشغال خلال الفترة المحددة.","reservations.reports.filters.rangeLabel":"الفترة","reservations.reports.filters.range.last30":"آخر 30 يوم","reservations.reports.filters.range.thisWeek":"هذا الأسبوع","reservations.reports.filters.range.thisMonth":"هذا الشهر","reservations.reports.filters.range.thisQuarter":"هذا الربع","reservations.reports.filters.range.thisYear":"هذا العام","reservations.reports.filters.range.all":"كل الوقت","reservations.reports.filters.range.custom":"مخصص","reservations.reports.filters.startLabel":"من","reservations.reports.filters.endLabel":"إلى","reservations.reports.filters.statusLabel":"الحالة","reservations.reports.filters.status.all":"كل الحالات","reservations.reports.filters.status.confirmed":"مؤكدة","reservations.reports.filters.status.pending":"قيد التأكيد","reservations.reports.filters.status.completed":"منتهية","reservations.reports.filters.paymentLabel":"الدفع","reservations.reports.filters.payment.all":"الكل","reservations.reports.filters.payment.paid":"مدفوعة","reservations.reports.filters.payment.unpaid":"غير مدفوعة","reservations.reports.filters.shareLabel":"نسبة الشركة","reservations.reports.filters.share.all":"الكل","reservations.reports.filters.share.with":"مع نسبة الشركة","reservations.reports.filters.share.without":"بدون نسبة الشركة","reservations.reports.filters.searchLabel":"البحث","reservations.reports.filters.searchPlaceholder":"ابحث باسم العميل، رقم الحجز، أو المعدة...","reservations.reports.actions.refresh":"تحديث","reservations.reports.actions.customizeColumns":"تخصيص الأعمدة","reservations.reports.actions.exportPdf":"تصدير PDF","reservations.reports.actions.exportExcel":"تصدير Excel","reservations.reports.actions.exportCsv":"تصدير CSV","reservations.reports.export.filePrefix":"تقرير-الحجوزات","reservations.reports.export.sheetName":"الحجوزات","reservations.reports.kpi.total.label":"إجمالي الحجوزات","reservations.reports.kpi.total.meta":"لم يتم تسجيل بيانات بعد","reservations.reports.kpi.revenue.label":"إجمالي الإيرادات","reservations.reports.kpi.revenue.meta":"صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","reservations.reports.kpi.revenue.details.title":"تفاصيل الإيرادات","reservations.reports.kpi.revenue.details.gross":"الإيراد الكلي","reservations.reports.kpi.revenue.details.share":"نسبة الشركة","reservations.reports.kpi.revenue.details.tax":"الضريبة","reservations.reports.kpi.revenue.details.crewGross":"إجمالي الطاقم","reservations.reports.kpi.revenue.details.crew":"تكلفة الطاقم","reservations.reports.kpi.revenue.details.maintenance":"مصاريف الصيانة","reservations.reports.kpi.revenue.details.net":"صافي الربح","reservations.reports.kpi.confirmation.label":"معدل التأكيد","reservations.reports.kpi.confirmation.meta":"الحجوزات المؤكدة —","reservations.reports.kpi.paid.label":"نسبة المدفوع","reservations.reports.kpi.paid.meta":"الحجوزات المدفوعة —","reservations.reports.kpi.total.dynamicMeta":"منها {count} منتهية","reservations.reports.kpi.revenue.average":"متوسط قيمة الحجز {value}","reservations.reports.kpi.confirmed.detail":"{count} حجوزات مؤكدة","reservations.reports.kpi.paid.detail":"{count} حجوزات مدفوعة","reservations.reports.status.loading":"جارٍ تحميل التقارير...","reservations.reports.status.loadingHint":"قد يستغرق هذا بضع ثوانٍ.","reservations.reports.status.retry":"جرّب إعادة المحاولة أو تحديث الصفحة.","reservations.reports.status.confirmedLabel":"مؤكدة","reservations.reports.status.pendingLabel":"قيد التأكيد","reservations.reports.status.completedLabel":"منتهية","reservations.reports.payment.paidLabel":"مدفوعة","reservations.reports.payment.partialLabel":"مدفوعة جزئياً","reservations.reports.payment.unpaidLabel":"غير مدفوعة","reservations.reports.progress.empty":"لا توجد بيانات لعرضها.","reservations.reports.progress.meta":"{count} حجز","reservations.reports.chart.volume.title":"حجم الحجوزات الشهري","reservations.reports.chart.volume.hint":"الحجوزات والإيرادات خلال الأشهر الماضية","reservations.reports.chart.volume.series.reservations":"عدد الحجوزات","reservations.reports.chart.volume.series.revenue":"الإيرادات (SR)","reservations.reports.chart.volume.series.net":"صافي الربح (SR)","reservations.reports.chart.status.title":"توزيع الحالات","reservations.reports.chart.status.hint":"نسبة الحجوزات المؤكدة، قيد التأكيد، والمنتهية","reservations.reports.chart.status.statusLabel":"الحالات","reservations.reports.chart.status.paymentLabel":"الدفع","reservations.reports.chart.payment.title":"حالة الدفع","reservations.reports.chart.payment.hint":"مقارنة الحجوزات المدفوعة وغير المدفوعة","reservations.reports.topCustomers.title":"أفضل العملاء","reservations.reports.topCustomers.hint":"حسب إجمالي الإيراد","reservations.reports.topCustomers.headers.customer":"العميل","reservations.reports.topCustomers.headers.count":"عدد الحجوزات","reservations.reports.topCustomers.headers.revenue":"الإيراد الكلي","reservations.reports.topCustomers.unknown":"عميل غير معروف","reservations.reports.table.empty":"لا توجد بيانات","reservations.reports.table.emptyPeriod":"لا توجد بيانات في هذه الفترة.","reservations.reports.results.title":"تفاصيل الحجوزات","reservations.reports.results.hint":"أحدث الحجوزات المطابقة لعوامل التصفية","reservations.reports.results.headers.id":"الحجز","reservations.reports.results.headers.customer":"العميل","reservations.reports.results.headers.date":"التاريخ","reservations.reports.results.headers.status":"الحالة","reservations.reports.results.headers.payment":"الدفع","reservations.reports.results.headers.total":"الإجمالي","reservations.reports.results.headers.share":"نسبة الشركة","reservations.reports.results.headers.net":"صافي الربح","reservations.reports.results.share.none":"بدون نسبة الشركة","reservations.reports.topEquipment.title":"المعدات الأكثر استخدامًا","reservations.reports.topEquipment.hint":"عدد مرات الحجز","reservations.reports.topEquipment.headers.item":"المعدة","reservations.reports.topEquipment.headers.usage":"عدد مرات الاستخدام","reservations.reports.topEquipment.headers.revenue":"الإيراد المرتبط","reservations.reports.topEquipment.unknown":"معدة بدون اسم","reservations.reports.empty.title":"لا توجد بيانات ضمن المعايير الحالية","reservations.reports.empty.subtitle":"جرّب تغيير الفترة الزمنية أو إزالة عوامل التصفية لعرض نتائج أخرى.","calendar.buttons.today":"اليوم","calendar.buttons.month":"شهر","calendar.buttons.week":"أسبوع","calendar.buttons.day":"يوم","calendar.badges.confirmed":"مؤكد","calendar.badges.pending":"غير مؤكد","calendar.badges.paid":"مدفوع","calendar.badges.unpaid":"غير مدفوع","calendar.badges.completed":"منتهي","calendar.labels.unknownCustomer":"غير معروف","calendar.labels.unknownEquipment":"معدة بدون اسم","calendar.labels.currencySuffix":"SR","calendar.labels.noEquipment":"لا توجد معدات","calendar.labels.noNotes":"لا توجد ملاحظات","calendar.labels.reservationId":"رقم الحجز","calendar.labels.customer":"العميل","calendar.labels.start":"بداية الحجز","calendar.labels.end":"نهاية الحجز","calendar.labels.notes":"الملاحظات","calendar.sections.crew":"😎 الفريق الفني","calendar.sections.equipment":"📦 المعدات","calendar.emptyStates.noCrew":"😎 لا يوجد فريق مرتبط بهذا الحجز.","calendar.table.headers.barcode":"الباركود","calendar.table.headers.description":"الوصف","calendar.table.headers.quantity":"الكمية","calendar.table.headers.price":"السعر","calendar.table.headers.image":"الصورة","calendar.summary.baseCost":"💵 إجمالي المعدات: <strong>{value} SR</strong>","calendar.summary.discount":"💸 الخصم: <strong>{value}</strong>","calendar.summary.tax":"🧾 الضريبة (15%): <strong>{value} SR</strong>","calendar.summary.total":"💰 المجموع النهائي: <strong>{value} SR</strong>","calendar.alerts.cannotShowDetails":"لا يمكن عرض تفاصيل الحجز","calendar.alerts.cannotOpenModal":"لا يمكن فتح نافذة التفاصيل","calendar.modal.title":"📅 تفاصيل الحجز","reservations.toast.equipmentNameNotFound":"❌ لم يتم العثور على معدة بالاسم المدخل","reservations.toast.equipmentMaintenance":"⚠️ هذه المعدة قيد الصيانة ولا يمكن إضافتها حالياً","reservations.toast.equipmentMissingBarcode":"⚠️ هذه المعدة لا تحتوي على باركود معرف","reservations.toast.requireDatesBeforeAdd":"⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات","reservations.toast.equipmentDuplicate":"⚠️ هذه المعدة موجودة بالفعل في الحجز","reservations.toast.equipmentTimeConflict":"⚠️ لا يمكن إضافة المعدة لأنها محجوزة أو في الصيانة خلال نفس الفترة الزمنية","reservations.toast.equipmentMaintenanceStrict":"⚠️ لا يمكن إضافة معدة قيد الصيانة إلى الحجز","reservations.toast.requireOverallDates":"⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات","reservations.toast.equipmentTimeConflictSimple":"⚠️ هذه المعدة محجوزة أو في الصيانة خلال نفس الفترة الزمنية","reservations.toast.barcodeNotFound":"❌ الباركود غير موجود","reservations.toast.equipmentAdded":"✅ تم إضافة المعدة بنجاح","reservations.toast.noAdditionalUnits":"⚠️ لا توجد وحدات إضافية متاحة حالياً","reservations.toast.barcodeNotInCatalog":"❌ الباركود غير موجود ضمن المعدات","reservations.toast.requireDates":"⚠️ يرجى تحديد تاريخ البداية والنهاية","reservations.toast.invalidDateRange":"⚠️ تأكد من أن تاريخ ووقت البداية يسبق تاريخ ووقت النهاية","reservations.toast.missingFields":"⚠️ تأكد من تعبئة جميع الحقول","reservations.toast.paymentNoRemainingBalance":"⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة","reservations.toast.paymentCappedPercent":"ℹ️ تم ضبط الدفعة إلى {value}% لاستكمال 100%","reservations.toast.paymentCappedAmount":"ℹ️ تم ضبط الدفعة إلى {amount} لاستكمال المبلغ المتبقي","reservations.toast.companyShareRequiresTax":"⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة","reservations.toast.noItems":"⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل","reservations.toast.cannotCreateEquipmentMaintenance":"⚠️ لا يمكن إتمام الحجز لأن إحدى المعدات قيد الصيانة","reservations.toast.cannotCreateEquipmentConflict":"⚠️ لا يمكن إتمام الحجز، إحدى المعدات محجوزة في نفس الفترة الزمنية","reservations.toast.cannotCreateCrewConflict":"⚠️ لا يمكن إتمام الحجز، أحد أعضاء الطاقم مرتبط بحجز آخر في نفس الفترة","reservations.toast.projectNotFound":"⚠️ لم يتم العثور على المشروع المحدد. يرجى تحديث الصفحة أو اختيار مشروع آخر.","reservations.toast.technicianSelectionConflict":"⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية","reservations.toast.created":"✅ تم إنشاء الحجز","reservations.toast.notFound":"⚠️ تعذر العثور على بيانات الحجز","reservations.toast.updateNoItems":"⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل للحجز","reservations.toast.updateEquipmentMaintenance":"⚠️ لا يمكن حفظ التعديلات لأن إحدى المعدات قيد الصيانة","reservations.toast.updateEquipmentConflict":"⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات","reservations.toast.updateCrewConflict":"⚠️ لا يمكن حفظ التعديلات بسبب تعارض في جدول أحد أعضاء الطاقم","reservations.toast.updated":"✅ تم حفظ التعديلات على الحجز","reservations.toast.confirmed":"✅ تم تأكيد الحجز","reservations.toast.confirmBlockedByProject":"⚠️ حالة هذا الحجز تتحكم بها حالة المشروع المرتبط ولا يمكن تأكيده من هنا","reservations.toast.deleteConfirm":"⚠️ هل أنت متأكد من حذف هذا الحجز؟","maintenance.section.title":"🛠️ إدارة الصيانة","maintenance.form.title":"➕ إنشاء تذكرة صيانة","maintenance.form.hint":"حدد المعدة المتضررة وسجّل المشكلة لإيقافها عن الاستخدام لحين الإصلاح.","maintenance.form.labels.barcode":"🏷️ الباركود","maintenance.form.placeholders.barcode":"🖨️ امسح أو أدخل الباركود ثم اضغط Enter","maintenance.form.labels.search":"🎥 إضافة معدة بالاسم","maintenance.form.placeholders.search":"اكتب اسم المعدة...","maintenance.form.labels.priority":"⚠️ الأولوية","maintenance.form.options.priority.high":"مرتفعة","maintenance.form.options.priority.medium":"متوسطة","maintenance.form.options.priority.low":"منخفضة","maintenance.form.selectedInfo":"لم يتم اختيار معدة بعد.","maintenance.form.labels.issue":"📝 وصف المشكلة","maintenance.form.placeholders.issue":"اشرح المشكلة أو الأعراض الظاهرة للمعدة","maintenance.form.actions.submit":"🛠️ إنشاء التذكرة","maintenance.form.blockedSuffix":"(صيانة)","maintenance.list.title":"📋 تذاكر الصيانة","maintenance.list.hint":"تابع حالة الأعطال وقم بإغلاق التذاكر بعد إتمام الإصلاح.","maintenance.filters.status.label":"الحالة","maintenance.filters.status.all":"كل الحالات","maintenance.filters.status.open":"قيد الصيانة","maintenance.filters.status.closed":"مغلقة","maintenance.filters.priority.label":"الأولوية","maintenance.filters.priority.all":"كل الأولويات","maintenance.filters.priority.high":"مرتفعة","maintenance.filters.priority.medium":"متوسطة","maintenance.filters.priority.low":"منخفضة","maintenance.filters.search.placeholder":"🔍 ابحث باسم المعدة أو الباركود...","maintenance.table.headers.equipment":"المعدة","maintenance.table.headers.issue":"وصف المشكلة","maintenance.table.headers.priority":"الأولوية","maintenance.table.headers.created":"تاريخ الإنشاء","maintenance.table.headers.status":"الحالة","maintenance.table.headers.actions":"الإجراءات","maintenance.table.empty":"لا توجد تذاكر بعد.","maintenance.table.emptyFiltered":"لا توجد تذاكر ضمن هذا الفلتر.","maintenance.table.noName":"بدون اسم","maintenance.empty.title":"لا توجد تذاكر صيانة","maintenance.empty.subtitle":"عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.","maintenance.table.noBarcode":"بدون باركود","maintenance.table.repairCost":"💰 تكلفة الإصلاح: {amount}","maintenance.stats.open":"{count} قيد الصيانة","maintenance.stats.closed":"{count} مغلقة","maintenance.stats.total":"{count} إجمالي التذاكر","maintenance.stats.summaryTitle":"ملخص الصيانة","maintenance.stats.totalLabel":"إجمالي التذاكر","maintenance.status.open":"قيد الصيانة","maintenance.status.closed":"مغلقة","maintenance.status.inProgress":"قيد التنفيذ","maintenance.status.completed":"مكتملة","maintenance.status.cancelled":"ملغاة","maintenance.priority.high":"مرتفعة","maintenance.priority.medium":"متوسطة","maintenance.priority.low":"منخفضة","maintenance.actions.close":"🔧 إغلاق بعد الإصلاح","maintenance.actions.view":"👁️ عرض التقرير","maintenance.actions.delete":"🗑️ حذف التذكرة","maintenance.actions.editClosed":"✏️ تعديل بيانات الإغلاق","maintenance.closeModal.title":"🔧 إغلاق تذكرة الصيانة","maintenance.closeModal.subtitle":"يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.","maintenance.closeModal.reportLabel":"📝 تقرير الإصلاح","maintenance.closeModal.reportPlaceholder":"اكتب تفاصيل الإصلاح والإجراءات المتخذة...","maintenance.closeModal.editTitle":"✏️ تعديل بيانات الإغلاق","maintenance.closeModal.editSubtitle":"يمكنك تحديث تقرير الإصلاح وتكلفته.","maintenance.closeModal.editConfirm":"حفظ التعديلات","maintenance.closeModal.editSaving":"⏳ جاري الحفظ...","maintenance.closeModal.costLabel":"💰 تكلفة الإصلاح (اختياري)","maintenance.closeModal.costPlaceholder":"أدخل تكلفة الإصلاح أو القطع إن وجدت","maintenance.closeModal.costHint":"يمكن ترك الحقل فارغاً إذا لم تكن هناك تكلفة.","maintenance.closeModal.confirm":"إغلاق التذكرة","maintenance.closeModal.cancel":"إلغاء","maintenance.closeModal.saving":"⏳ جاري الإغلاق...","maintenance.toast.equipmentBlocked":"⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً","maintenance.toast.equipmentNotFoundBarcode":"❌ لم يتم العثور على معدة بهذا الباركود","maintenance.toast.equipmentNotFoundName":"❌ لم يتم العثور على معدة بالاسم المدخل","maintenance.toast.equipmentBecameBlocked":"⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها","maintenance.toast.selectEquipment":"⚠️ يرجى اختيار المعدة","maintenance.toast.selectedNotFound":"❌ لم يتم العثور على المعدة المختارة","maintenance.toast.equipmentAlreadyMaintenance":"⚠️ هذه المعدة بالفعل في حالة صيانة","maintenance.toast.ticketExists":"⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة","maintenance.toast.ticketCreated":"🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة","maintenance.toast.storageError":"⚠️ تعذر حفظ بيانات الصيانة. يرجى المحاولة مجدداً.","maintenance.toast.submitError":"⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.","maintenance.toast.loading":"⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة...","maintenance.toast.ticketAlreadyClosed":"✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً","maintenance.toast.ticketClosed":"✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة","maintenance.toast.ticketDeleted":"🗑️ تم حذف تذكرة الصيانة","maintenance.toast.ticketDeleteConfirm":"⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟","maintenance.toast.reportRequired":"⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق","maintenance.toast.invalidRepairCost":"⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح","maintenance.prompt.closeReport":"أدخل تقرير الإصلاح / الإجراءات المتخذة:","maintenance.report.equipment":"المعدة","maintenance.report.barcode":"الباركود","maintenance.report.issue":"الوصف","maintenance.report.createdAt":"تاريخ الإنشاء","maintenance.report.closedAt":"تاريخ الإغلاق","maintenance.report.repairCost":"تكلفة الإصلاح","maintenance.report.currencyLabel":"ريال","maintenance.report.summary":"التقرير","maintenance.report.notAvailable":"غير متوفر","maintenance.report.modalTitle":"📝 تقرير الصيانة","maintenance.report.modalSubtitle":"تفاصيل التذكرة وتقرير الإصلاح.","maintenance.report.modalClose":"تم","maintenance.report.none":"—","maintenance.info.barcodeLabel":"باركود","technicians.section.title":"😎 إدارة طاقم العمل","technicians.subTabs.management":"⚙️ إدارة الطاقم","technicians.subTabs.positions":"🏷️ المناصب","technicians.form.title":"إضافة / تعديل عضو طاقم","technicians.form.hint":"أدخل بيانات عضو الطاقم ليتم حفظها وتحديثها في سجلات الحجز.","technicians.form.labels.name":"😎 اسم العضو","technicians.form.labels.phone":"📞 الجوال","technicians.form.labels.role":"👔 الوظيفة","technicians.form.labels.department":"🧩 القسم","technicians.form.labels.wage":"💰 الأجر اليومي","technicians.form.labels.total":"💼 التكلفة الإجمالية","technicians.form.labels.status":"⚙️ الحالة الأساسية","technicians.form.labels.notes":"📝 ملاحظات","technicians.form.placeholders.name":"اسم عضو الطاقم","technicians.form.placeholders.phone":"05xxxxxxxx","technicians.form.placeholders.role":"مثال: مصور","technicians.form.placeholders.department":"مثال: قسم الصوت","technicians.form.placeholders.wage":"0","technicians.form.placeholders.total":"0","technicians.form.placeholders.notes":"معلومات إضافية","technicians.form.actions.cancel":"إلغاء التعديل","technicians.form.actions.submit":"➕ إضافة عضو طاقم","technicians.form.actions.update":"💾 حفظ التعديل","technicians.positionSummary.title":"💵 تفاصيل التكلفة","technicians.positionSummary.match":"التكلفة: {cost} · سعر العميل: {price}","technicians.positionSummary.custom":"لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}","technicians.positionSummary.noClientPrice":"—","technicians.picker.selectedLabel":"😎 طاقم العمل المشارك","technicians.picker.openButton":"➕ اختيار الطاقم","technicians.picker.editButton":"🔁 تعديل الطاقم","technicians.picker.modalTitle":"😎 اختيار طاقم العمل","technicians.picker.actions.apply":"تم","technicians.picker.actions.cancel":"إلغاء","technicians.picker.selectionInfo":"لم يتم اختيار أي عضو بعد","technicians.picker.assignments.hint":"استخدم قائمة المناصب على اليسار لإضافة طاقم العمل.","technicians.picker.optionAssigned":"(مستخدم)","technicians.picker.selectedCount":"تم اختيار {count} عضو","technicians.form.options.available":"✅ متاح","technicians.form.options.busy":"⛔ مشغول","technicians.search.placeholder":"🔍 ابحث عن عضو الطاقم بالاسم أو الجوال أو الوظيفة...","technicians.search.filters.allRoles":"👔 كل الوظائف","technicians.table.empty":"لا يوجد أعضاء في الطاقم بعد.","technicians.table.loading":"جاري التحميل...","technicians.table.headers.name":"😎 اسم العضو","technicians.table.headers.phone":"📞 الجوال","technicians.table.headers.role":"👔 الوظيفة","technicians.table.headers.department":"🧩 القسم","technicians.table.headers.wage":"💰 الأجر اليومي","technicians.table.headers.total":"💼 التكلفة الإجمالية","technicians.table.headers.status":"⚙️ الحالة","technicians.table.headers.notes":"📝 ملاحظات","technicians.table.headers.actions":"⚙️ الإجراءات","technicians.status.available":"✅ متاح","technicians.status.busy":"⛔ مشغول","technicians.table.wageSuffix":"SR","technicians.badge.perDay":"/اليوم","technicians.actions.edit":"✏️ تعديل","technicians.actions.delete":"🗑️ حذف","technicians.toast.missingName":"⚠️ يرجى إدخال اسم عضو الطاقم","technicians.toast.missingPhone":"⚠️ يرجى إدخال رقم التواصل","technicians.toast.missingRole":"⚠️ يرجى إدخال الوظيفة","technicians.toast.invalidWage":"⚠️ أدخل قيمة صحيحة للأجر اليومي","technicians.toast.invalidTotal":"⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية","technicians.toast.addSuccess":"✅ تم إضافة عضو الطاقم","technicians.toast.updateSuccess":"💾 تم حفظ بيانات عضو الطاقم","technicians.toast.notFound":"⚠️ تعذر العثور على عضو الطاقم المطلوب","technicians.toast.unidentified":"⚠️ تعذر تحديد عضو الطاقم المطلوب","technicians.toast.dataNotFound":"⚠️ تعذر العثور على بيانات عضو الطاقم","technicians.toast.editReady":"✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل","technicians.toast.deleteConfirm":"⚠️ هل أنت متأكد من حذف هذا العضو؟","technicians.toast.deleteSuccess":"🗑️ تم حذف عضو الطاقم","positions.form.title":"إضافة / تعديل منصب","positions.form.hint":"عرّف المناصب القياسية مع التكلفة وسعر العميل لتسهيل تعبئة بيانات الطاقم.","positions.form.labels.nameAr":"🏷️ اسم المنصب (العربية)","positions.form.labels.nameEn":"🏷️ المنصب (English)","positions.form.labels.cost":"💵 التكلفة","positions.form.labels.clientPrice":"💼 السعر المقدم للعميل","positions.form.placeholders.nameAr":"مثال: مصور فوتوغرافي","positions.form.placeholders.nameEn":"e.g. Photographer","positions.form.placeholders.cost":"0","positions.form.placeholders.clientPrice":"0","positions.form.actions.cancel":"إلغاء","positions.form.actions.submit":"➕ إضافة منصب","positions.form.actions.update":"💾 حفظ المنصب","positions.list.title":"📋 المناصب الحالية","positions.table.headers.nameAr":"🏷️ المنصب (العربية)","positions.table.headers.nameEn":"🏷️ Position (English)","positions.table.headers.cost":"💵 التكلفة","positions.table.headers.clientPrice":"💼 سعر العميل","positions.table.headers.actions":"⚙️ الإجراءات","positions.table.actions.edit":"✏️ تعديل","positions.table.actions.delete":"🗑️ حذف","positions.table.empty":"لا توجد مناصب بعد.","positions.toast.invalidName":"⚠️ يرجى إدخال اسم المنصب","positions.toast.invalidCost":"⚠️ أدخل قيمة صحيحة للتكلفة","positions.toast.invalidClientPrice":"⚠️ أدخل قيمة صحيحة لسعر العميل","positions.toast.addSuccess":"✅ تم إضافة المنصب","positions.toast.updateSuccess":"💾 تم حفظ بيانات المنصب","positions.toast.saveFailed":"⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى","positions.toast.fetchFailed":"⚠️ تعذر تحميل المناصب، حاول مرة أخرى","positions.toast.notFound":"⚠️ تعذر العثور على بيانات المنصب","positions.toast.deleteConfirm":"⚠️ هل أنت متأكد من حذف هذا المنصب؟","positions.toast.deleteSuccess":"🗑️ تم حذف المنصب","positions.defaults.photographer":"مصور فوتوغرافي","positions.defaults.videographer":"مصور فيديو","positions.defaults.editor":"مونتير","positions.defaults.director":"مخرج","positions.defaults.dop":"مدير تصوير","positions.defaults.lightingAssistant":"مساعد إضاءة","positions.defaults.cameraAssistant":"مساعد كاميرا"},en:{"dashboard.header.greeting":"👋 Welcome to the Dashboard","dashboard.header.toggleLabel":"Dashboard","dashboard.sidebar.title":"Control Center","dashboard.sidebar.statsHeading":"Today at a Glance","dashboard.sidebar.tabsHeading":"Dashboard Tabs","dashboard.sidebar.quickLinksHeading":"Quick Links","dashboard.hero.title":"Art Ratio","dashboard.actions.addProject":"➕ Add Project","dashboard.metrics.projects.label":"Projects","dashboard.metrics.projects.caption":"Active projects this month","dashboard.metrics.reservations.label":"Reservations","dashboard.metrics.reservations.caption":"Keep track of upcoming events","dashboard.metrics.equipment.label":"Equipment","dashboard.metrics.equipment.caption":"Assets available right now","dashboard.metrics.technicians.label":"Crew Members","dashboard.metrics.technicians.caption":"Team ready for assignments","dashboard.quickLinks.home":"Home","dashboard.quickLinks.projects":"Projects workspace","dashboard.quickLinks.reports":"Project reports","dashboard.quickLinks.users":"User management","tabs.customers":"👤 Clients","tabs.equipment":"🎥 Equipment","tabs.maintenance":"🛠️ Maintenance","tabs.technicians":"😎 Crew","tabs.reservations":"📅 Reservations","actions.close":"Close","actions.cancel":"Cancel","actions.goHome":"🏠 Home","customers.section.title":"📋 Client Management","customers.form.title":"Add / Edit Client","customers.form.hint":"Update client details and they will sync with bookings and invoices.","customers.form.labels.name":"👤 Client","customers.form.labels.phone":"📞 Phone","customers.form.labels.email":"📧 Email","customers.form.labels.address":"📍 Address","customers.form.labels.company":"🏢 Company","customers.form.labels.taxId":"🧾 Tax Number","customers.form.labels.document":"📎 Client Document","customers.form.labels.documentName":"📄 File Name","customers.form.document.placeholder":"https://example.com/document.pdf","customers.form.document.helper":"Paste a direct link to the client document or uploaded file.","customers.form.document.namePlaceholder":"invoice.pdf","customers.form.labels.notes":"📝 Notes","customers.form.placeholders.name":"Client name","customers.form.placeholders.phone":"05xxxxxxxx","customers.form.placeholders.email":"name@email.com","customers.form.placeholders.address":"Client address","customers.form.placeholders.company":"Company name","customers.form.placeholders.taxId":"1234567890","customers.form.placeholders.notes":"Additional info or reminders","customers.form.actions.cancel":"Cancel edit","customers.form.actions.submit":"➕ Add Client","customers.form.actions.update":"💾 Update Client","customers.form.actions.previewDocument":"Preview document","customers.form.document.empty":"No file chosen yet","customers.form.document.uploading":"📤 Uploading file...","customers.form.document.uploadFailed":"⚠️ File upload failed","customers.form.document.selected":"A document is attached.","customers.form.document.uploadingWait":"⏳ Please wait for the upload to finish","customers.form.document.uploadSuccess":"✅ File uploaded successfully","customers.search.placeholder":"🔍 Search by name, phone, or company...","customers.table.headers.name":"👤 Client","customers.table.headers.phone":"📞 Phone","customers.table.headers.company":"🏢 Company","customers.table.headers.notes":"📝 Notes","customers.table.headers.actions":"⚙️ Actions","customers.table.loading":"Loading...","customers.table.empty":"No clients found","customers.table.noResults":"No matching results","customers.actions.edit":"✏️ Edit","customers.actions.delete":"🗑️ Delete","customers.actions.viewDocument":"📎 View Document","customers.documents.missing":"No document available","customers.documents.unsupportedPreview":"Preview not available for this file type. You can download it below.","customers.toast.updateSuccess":"Client updated successfully","customers.toast.createSuccess":"Client added successfully","customers.toast.missingFields":"Please fill in the name and phone number","customers.toast.deleteConfirm":"⚠️ Are you sure you want to delete this client?","customers.toast.deleteSuccess":"Client removed","customers.toast.fetchFailed":"Could not load clients list","customers.toast.submitFailed":"An error occurred while saving the client","customers.toast.deleteFailed":"Could not delete the client. Please try again","equipment.section.title":"🎥 Equipment Management","equipment.actions.clearAll":"🗑️ Clear All","equipment.actions.uploadExcel":"📤 Import from Excel","equipment.form.title":"Add Equipment","equipment.form.hint":"Enter equipment details to store them in the catalog.","equipment.form.labels.description":"📝 Description","equipment.form.placeholders.description":"Equipment description","equipment.form.labels.barcode":"🏷️ Barcode","equipment.form.placeholders.barcode":"Barcode","equipment.form.labels.price":"💵 Price","equipment.form.placeholders.price":"0","equipment.form.labels.quantity":"🔢 Quantity","equipment.form.placeholders.quantity":"1","equipment.form.labels.image":"🖼️ Image URL","equipment.form.placeholders.image":"https://...","equipment.form.labels.category":"📂 Category","equipment.form.placeholders.category":"Category","equipment.form.labels.subcategory":"📑 Subcategory","equipment.form.placeholders.subcategory":"Subcategory","equipment.form.labels.status":"⚙️ Status","equipment.form.options.available":"✅ Available","equipment.form.options.booked":"📌 Booked","equipment.form.options.maintenance":"🛠️ Maintenance","equipment.form.options.retired":"📦 Retired","equipment.form.actions.submit":"➕ Add Equipment","equipment.filters.search":"🔍 Search equipment...","equipment.filters.status.all":"⚙️ Statuses","equipment.filters.category.all":"📂 Categories","equipment.filters.subcategory.all":"📑 Subcategories","equipment.list.title":"📋 All Equipment","equipment.list.loading":"⏳ Loading equipment...","equipment.list.empty":"No equipment has been added yet.","equipment.card.labels.description":"Description","equipment.card.labels.status":"Status","equipment.card.labels.alias":"Name","equipment.card.labels.quantity":"Quantity","equipment.card.labels.price":"Price","equipment.card.labels.category":"Category","equipment.card.labels.subcategory":"Subcategory","equipment.card.labels.barcode":"Barcode","equipment.card.labels.available":"Available","equipment.card.labels.availableOfTotal":"of","equipment.card.availability.reservedSingle":"Rented","equipment.card.availability.reserved":"Fully Rented","equipment.card.availability.maintenance":"Under Maintenance","equipment.card.availability.retired":"Unavailable","equipment.card.availability.unavailable":"Currently Unavailable","equipment.modal.title":"✏️ Edit Equipment","equipment.modal.title.details":"📇 Equipment Card Details","equipment.modal.placeholders.image":"Paste a direct image link","equipment.modal.actions.cancel":"❌ Cancel","equipment.modal.actions.close":"❌ Close","equipment.modal.actions.edit":"✏️ Edit","equipment.modal.actions.cancelEdit":"↩️ Cancel Edit","equipment.modal.actions.save":"💾 Save Changes","equipment.toast.xlsxMissing":"⚠️ Excel library (XLSX) is not loaded. Check dashboard.html links","equipment.toast.uploadSuccess":"✅ Equipment imported successfully","equipment.toast.uploadEmpty":"⚠️ The file did not contain any rows to import","equipment.toast.uploadFailed":"❌ Something went wrong while reading the Excel file","equipment.toast.clearConfirm":"⚠️ Are you sure you want to delete all equipment?","equipment.toast.clearSuccess":"🗑️ All equipment cleared","equipment.toast.deleteConfirm":"❌ Are you sure you want to delete this equipment item?","equipment.toast.deleteSuccess":"🗑️ Equipment item deleted","equipment.toast.editSuccess":"✏️ Equipment updated","equipment.toast.addSuccess":"✅ Equipment added","equipment.toast.updateSuccess":"✅ Equipment updated successfully","equipment.toast.missingFields":"⚠️ Please enter the description and barcode","equipment.toast.duplicateBarcode":"⚠️ This barcode is already in use","equipment.list.emptyFiltered":"⚠️ No matching equipment.","equipment.list.countSuffix":"item(s)","equipment.item.imageAlt":"Image","equipment.item.currency":"SR","equipment.item.actions.edit":"✏️ Edit","equipment.item.actions.delete":"🗑️ Delete","reservations.tabs.create":"➕ Create Reservation","reservations.tabs.mine":"📋 My Reservations","reservations.tabs.reports":"📊 Reports","reservations.tabs.calendar":"📅 Calendar","reservations.create.title":"➕ Create New Reservation","reservations.create.labels.startDate":"📅 Start date","reservations.create.labels.startTime":"⏰ Start time","reservations.create.labels.endDate":"📅 End date","reservations.create.labels.endTime":"⏰ End time","reservations.create.labels.client":"👤 Client","reservations.create.placeholders.client":"Type client name...","reservations.create.labels.project":"📁 Linked project","reservations.create.placeholders.project":"Select a project (optional)","reservations.create.project.pendingPlaceholder":"Will link after saving this project","reservations.create.project.pendingTooltip":"Save the current project first to enable linked project selection.","reservations.create.labels.notes":"📝 Notes","reservations.create.placeholders.notes":"Add any additional notes...","reservations.create.equipment.title":"🎥 Add Equipment","reservations.create.equipment.placeholders.barcode":"🔍 Scan or enter a barcode then press Enter","reservations.create.equipment.placeholders.description":"🎥 Type the equipment name then press Enter","reservations.equipment.table.item":"Equipment","reservations.equipment.table.quantity":"Quantity","reservations.equipment.table.unitPrice":"Unit Price","reservations.equipment.table.total":"Total","reservations.equipment.table.actions":"Actions","reservations.equipment.actions.increase":"Increase quantity","reservations.equipment.actions.decrease":"Decrease quantity","reservations.equipment.actions.remove":"Remove item","reservations.equipment.barcodes.summary":"Show barcodes","equipment.modal.variants.title":"📦 Related Units","equipment.modal.variants.barcode":"Barcode","equipment.modal.variants.status":"Status","equipment.modal.variants.quantity":"Quantity","equipment.modal.variants.actions":"Actions","equipment.modal.variants.empty":"No related units found.","equipment.modal.variants.current":"Current","reservations.create.billing.title":"💵 Discount & Tax","reservations.create.billing.discount":"Enter discount value","reservations.create.billing.discountPercent":"% Percent","reservations.create.billing.discountAmount":"💵 Amount","reservations.create.billing.companyShare":"🏦 Company share","reservations.create.billing.companyShareToggle":"Include company share (10%)","reservations.create.billing.taxLabel":"Include VAT (15%)","reservations.create.labels.paymentStatus":"💳 Payment status","reservations.create.paymentStatus.paid":"Paid","reservations.create.paymentStatus.partial":"Partially paid","reservations.create.paymentStatus.unpaid":"Unpaid","reservations.create.paymentProgress.label":"💰 Received payment","reservations.create.paymentProgress.amount":"💵 Amount","reservations.create.paymentProgress.percent":"% Percentage","reservations.create.paymentProgress.placeholder":"50","reservations.create.paymentProgress.hint":"Enter the amount or percentage received towards this reservation","reservations.toast.linkedProjectDisabled":"This action is disabled for linked reservations. Please make these changes from the project screen.","reservations.paymentHistory.title":"Payment history","reservations.paymentHistory.empty":"No payments recorded","reservations.paymentHistory.headers.method":"Payment type","reservations.paymentHistory.headers.amount":"Amount","reservations.paymentHistory.headers.percent":"Percent","reservations.paymentHistory.headers.date":"Date","reservations.paymentHistory.headers.note":"Notes","reservations.paymentHistory.actions.add":"➕ Add payment","reservations.paymentHistory.actions.delete":"Delete payment","reservations.paymentHistory.type.amount":"Amount payment","reservations.paymentHistory.type.percent":"Percent payment","reservations.paymentHistory.type.unknown":"Payment","reservations.paymentHistory.countLabel":"{count} payments","reservations.toast.paymentInvalid":"⚠️ Please enter a valid payment value","reservations.toast.paymentAdded":"✅ Payment recorded","reservations.toast.paymentRemoved":"🗑️ Payment removed","reservations.create.actions.submit":"💾 Create reservation","reservations.section.title":"📅 Reservation Management","reservations.crew.none":"No crew members selected yet.","reservations.crew.noneShort":"No crew members selected","reservations.crew.selectedCount":"{count} crew member(s) selected","reservations.crew.fallbackName":"Crew member {id}","reservations.crew.removeAria":"Remove","reservations.crew.searchEmpty":"No matching results.","reservations.create.equipment.noResults":"No matching equipment.","reservations.create.equipment.noneAdded":"No equipment added","reservations.create.equipment.none":"No equipment","reservations.create.summary.currency":"SR","reservations.create.equipment.imageAlt":"Image","reservations.summary.total":"💰 Total cost: <strong>{total} {currency}</strong>","reservations.summary.totalAfterEdit":"💰 Updated total: <strong>{total} {currency}</strong>","reservations.summary.itemsCount":"📦 Items: {count}","reservations.summary.crewCount":"😎 Crew members: {count}","reservations.summary.companyShareLabel":"🏦 Company share","reservations.summary.taxIncluded":"Includes 15% VAT","reservations.summary.taxExcluded":"VAT not included","reservations.summary.paymentLabel":"💳 Payment status: {status}","reservations.summary.itemsLabel":"📦 Items","reservations.summary.durationLabel":"⏱️ Days","reservations.summary.crewLabel":"😎 Crew","reservations.summary.taxLabelShort":"🧾 VAT","reservations.summary.paymentLabelShort":"💳 Payment status","reservations.summary.paymentProgressLabel":"💰 Received payment","reservations.summary.taxIncludedValue":"Includes 15%","reservations.summary.taxExcludedValue":"Not included","reservations.summary.totalLabel":"💰 Total cost","reservations.toast.customerNotFound":"⚠️ Customer not found for the entered name","reservations.toast.invalidDateOrder":"⚠️ Start date cannot be after the end date","reservations.toast.reservationMissing":"⚠️ Unable to locate the selected reservation","reservations.list.title":"📋 My Reservations","reservations.list.search.placeholder":"🔍 Search by client name or code...","reservations.list.filters.start":"📅 From date","reservations.list.filters.end":"📅 To date","reservations.list.filters.range.all":"⏱️ All dates","reservations.list.filters.range.today":"📅 Today","reservations.list.filters.range.week":"📆 This week","reservations.list.filters.range.month":"🗓️ This month","reservations.list.filters.status.all":"⚙️ All statuses","reservations.list.filters.status.confirmed":"✅ Confirmed","reservations.list.filters.status.pending":"⏳ Pending","reservations.list.filters.status.completed":"📁 Completed","reservations.list.empty":"⚠️ No reservations yet.","reservations.list.noResults":"🔍 No reservations match the search.","reservations.list.taxIncludedShort":"(Tax included)","reservations.list.unknownCustomer":"Unknown","reservations.list.noNotes":"No notes","reservations.list.project.unlinked":"Not linked to a project","reservations.list.itemsCountShort":"{count} item(s)","reservations.list.crew.separator":", ","reservations.list.status.confirmed":"✅ Confirmed","reservations.list.status.pending":"⏳ Pending","reservations.list.payment.paid":"💳 Paid","reservations.list.payment.partial":"💳 Partially paid","reservations.list.payment.unpaid":"💳 Unpaid","reservations.list.status.completed":"📁 Completed","reservations.list.ribbon.completed":"Completed","reservations.list.actions.confirm":"✔️ Confirm","reservations.list.labels.client":"👤 Client","reservations.list.labels.project":"📁 Project","reservations.edit.modalTitle":"✏️ Edit Reservation","reservations.edit.labels.id":"🆔 Reservation ID","reservations.edit.labels.customer":"👤 Customer","reservations.edit.labels.project":"📁 Linked project","reservations.edit.labels.startDate":"📅 Start date","reservations.edit.labels.startTime":"⏰ Start time","reservations.edit.labels.endDate":"📅 End date","reservations.edit.labels.endTime":"⏰ End time","reservations.edit.labels.discount":"💵 Discount","reservations.edit.placeholders.discount":"Enter discount value","reservations.edit.discount.percent":"% Percent","reservations.edit.discount.amount":"💵 Amount","reservations.edit.labels.tax":"Include VAT (15%)","reservations.edit.labels.confirmed":"✅ Confirmed","reservations.edit.labels.paymentStatus":"💳 Payment status","reservations.edit.payment.paid":"Paid","reservations.edit.payment.partial":"Partially paid","reservations.edit.payment.unpaid":"Unpaid","reservations.edit.paymentProgress.label":"💰 Received payments","reservations.edit.paymentProgress.amount":"💵 Amount","reservations.edit.paymentProgress.percent":"% Percentage","reservations.edit.paymentProgress.placeholder":"50","reservations.edit.paymentProgress.hint":"Record how much of the reservation has been paid so far","reservations.edit.labels.notes":"📝 Notes","reservations.edit.placeholders.notes":"Add any notes...","reservations.edit.labels.addEquipment":"🎥 Add equipment","reservations.edit.project.missing":"⚠️ Project unavailable (deleted)","reservations.edit.placeholders.barcode":"🔍 Scan or enter a barcode then press Enter","reservations.edit.placeholders.description":"🎥 Type the equipment name then press Enter","reservations.edit.table.empty":"No equipment","reservations.edit.actions.save":"💾 Save changes","reservations.edit.tech.headers.total":"Total charge","reservations.list.labels.start":"🗓️ Start","reservations.list.labels.end":"🗓️ End","reservations.list.labels.cost":"💵 Cost","reservations.list.labels.equipment":"📦 Equipment","reservations.list.labels.crew":"😎 Crew","reservations.details.labels.discount":"Discount","reservations.details.labels.companyShare":"🏦 Company share","reservations.details.labels.netProfit":"💵 Net profit","reservations.details.labels.subtotalAfterDiscount":"Subtotal","reservations.details.labels.tax":"Tax (15%)","reservations.details.labels.crewTotal":"Crew total","reservations.details.table.headers.code":"Code","reservations.details.table.headers.description":"Description","reservations.details.table.headers.quantity":"Qty","reservations.details.table.headers.price":"Price","reservations.details.table.headers.image":"Image","reservations.details.noItems":"📦 No equipment is linked to this reservation yet.","reservations.details.noCrew":"😎 No crew assigned to this reservation.","reservations.details.project.unlinked":"Not linked to any project.","reservations.details.technicians.roleUnknown":"Not specified","reservations.details.technicians.phoneUnknown":"Not available","reservations.details.technicians.wage":"{amount} {currency} / day","reservations.details.labels.id":"🆔 Reservation ID","reservations.details.section.bookingInfo":"Booking details","reservations.details.section.statusSummary":"Status summary","reservations.details.section.paymentSummary":"💳 Payment summary","reservations.details.labels.finalTotal":"Final total","reservations.details.section.crew":"😎 Crew members","reservations.details.crew.count":"{count} member(s)","reservations.details.section.items":"📦 Linked equipment","reservations.details.items.count":"{count} item(s)","reservations.details.actions.edit":"✏️ Edit","reservations.details.actions.delete":"🗑️ Delete","reservations.details.actions.openProject":"📁 Open project","reservations.details.labels.customer":"Customer","reservations.details.labels.contact":"Contact","reservations.details.labels.start":"Start","reservations.details.labels.end":"End","reservations.details.labels.notes":"Notes","reservations.details.labels.itemsCount":"Equipment count","reservations.details.labels.itemsTotal":"Equipment total","reservations.details.labels.paymentStatus":"Payment status","reservations.details.modalTitle":"📋 Reservation Details","reservations.calendar.title":"📅 Calendar","reservations.calendar.helper":"🎯 Select any reservation to view its details.","calendar.legend.confirmed":"Confirmed reservation","calendar.legend.pending":"Awaiting confirmation","calendar.legend.paid":"Paid in full","calendar.legend.unpaid":"Payment pending","calendar.legend.completed":"Completed","calendar.labels.allDay":"All day","reservations.reports.title":"Performance reports","reservations.reports.subtitle":"A holistic view of reservations, revenue, and utilization for the selected period.","reservations.reports.filters.rangeLabel":"Period","reservations.reports.filters.range.last30":"Last 30 days","reservations.reports.filters.range.thisWeek":"This week","reservations.reports.filters.range.thisMonth":"This month","reservations.reports.filters.range.thisQuarter":"This quarter","reservations.reports.filters.range.thisYear":"This year","reservations.reports.filters.range.all":"All time","reservations.reports.filters.range.custom":"Custom","reservations.reports.filters.startLabel":"From","reservations.reports.filters.endLabel":"To","reservations.reports.filters.statusLabel":"Status","reservations.reports.filters.status.all":"All statuses","reservations.reports.filters.status.confirmed":"Confirmed","reservations.reports.filters.status.pending":"Pending confirmation","reservations.reports.filters.status.completed":"Completed","reservations.reports.filters.paymentLabel":"Payment","reservations.reports.filters.payment.all":"All","reservations.reports.filters.payment.paid":"Paid","reservations.reports.filters.payment.unpaid":"Unpaid","reservations.reports.filters.shareLabel":"Company share","reservations.reports.filters.share.all":"All","reservations.reports.filters.share.with":"With company share","reservations.reports.filters.share.without":"Without company share","reservations.reports.filters.searchLabel":"Search","reservations.reports.filters.searchPlaceholder":"Search by customer, reservation number, or equipment...","reservations.reports.actions.refresh":"Refresh","reservations.reports.actions.customizeColumns":"Customize columns","reservations.reports.actions.exportPdf":"Export PDF","reservations.reports.actions.exportExcel":"Export Excel","reservations.reports.actions.exportCsv":"Export CSV","reservations.reports.export.filePrefix":"reservations-report","reservations.reports.export.sheetName":"Reservations","reservations.reports.kpi.total.label":"Total reservations","reservations.reports.kpi.total.meta":"No data recorded yet","reservations.reports.kpi.revenue.label":"Total revenue","reservations.reports.kpi.revenue.meta":"Net profit {net} • Company share {share} • Average reservation {average}","reservations.reports.kpi.revenue.details.title":"Revenue details","reservations.reports.kpi.revenue.details.gross":"Gross revenue","reservations.reports.kpi.revenue.details.share":"Company share","reservations.reports.kpi.revenue.details.tax":"Tax","reservations.reports.kpi.revenue.details.crewGross":"Crew total","reservations.reports.kpi.revenue.details.crew":"Crew cost","reservations.reports.kpi.revenue.details.maintenance":"Maintenance expenses","reservations.reports.kpi.revenue.details.net":"Net profit","reservations.reports.kpi.confirmation.label":"Confirmation rate","reservations.reports.kpi.confirmation.meta":"Confirmed reservations —","reservations.reports.kpi.paid.label":"Paid ratio","reservations.reports.kpi.paid.meta":"Paid reservations —","reservations.reports.kpi.total.dynamicMeta":"Includes {count} completed","reservations.reports.kpi.revenue.average":"Average reservation value {value}","reservations.reports.kpi.confirmed.detail":"{count} confirmed reservations","reservations.reports.kpi.paid.detail":"{count} paid reservations","reservations.reports.status.loading":"Loading reports...","reservations.reports.status.loadingHint":"This may take a few seconds.","reservations.reports.status.retry":"Try refreshing or reloading the page.","reservations.reports.status.confirmedLabel":"Confirmed","reservations.reports.status.pendingLabel":"Pending confirmation","reservations.reports.status.completedLabel":"Completed","reservations.reports.payment.paidLabel":"Paid","reservations.reports.payment.partialLabel":"Partially paid","reservations.reports.payment.unpaidLabel":"Unpaid","reservations.reports.progress.empty":"No data to display.","reservations.reports.progress.meta":"{count} reservations","reservations.reports.chart.volume.title":"Monthly booking performance","reservations.reports.chart.volume.hint":"Bookings and revenue over the past months.","reservations.reports.chart.volume.series.reservations":"Reservations","reservations.reports.chart.volume.series.revenue":"Revenue (SR)","reservations.reports.chart.volume.series.net":"Net profit (SR)","reservations.reports.chart.status.title":"Status distribution","reservations.reports.chart.status.hint":"Share of confirmed, pending, and completed reservations.","reservations.reports.chart.status.statusLabel":"Status","reservations.reports.chart.status.paymentLabel":"Payment","reservations.reports.chart.payment.title":"Payment status","reservations.reports.chart.payment.hint":"Paid vs unpaid reservations at a glance.","reservations.reports.topCustomers.title":"Top customers","reservations.reports.topCustomers.hint":"By total revenue","reservations.reports.topCustomers.headers.customer":"Customer","reservations.reports.topCustomers.headers.count":"Reservations","reservations.reports.topCustomers.headers.revenue":"Total revenue","reservations.reports.topCustomers.unknown":"Unknown customer","reservations.reports.table.empty":"No data available","reservations.reports.table.emptyPeriod":"No data for this period.","reservations.reports.results.title":"Reservation details","reservations.reports.results.hint":"Latest reservations matching the current filters","reservations.reports.results.headers.id":"Reservation","reservations.reports.results.headers.customer":"Customer","reservations.reports.results.headers.date":"Date","reservations.reports.results.headers.status":"Status","reservations.reports.results.headers.payment":"Payment","reservations.reports.results.headers.total":"Total","reservations.reports.results.headers.share":"Company share","reservations.reports.results.headers.net":"Net profit","reservations.reports.results.share.none":"No company share","reservations.reports.topEquipment.title":"Most used equipment","reservations.reports.topEquipment.hint":"Total bookings","reservations.reports.topEquipment.headers.item":"Equipment","reservations.reports.topEquipment.headers.usage":"Usage count","reservations.reports.topEquipment.headers.revenue":"Linked revenue","reservations.reports.topEquipment.unknown":"Unnamed equipment","reservations.reports.empty.title":"No data matches the current filters","reservations.reports.empty.subtitle":"Try adjusting the date range or removing filters to see more results.","calendar.buttons.today":"Today","calendar.buttons.month":"Month","calendar.buttons.week":"Week","calendar.buttons.day":"Day","calendar.badges.confirmed":"Confirmed","calendar.badges.pending":"Pending","calendar.badges.paid":"Paid","calendar.badges.unpaid":"Unpaid","calendar.badges.completed":"Completed","calendar.labels.unknownCustomer":"Unknown","calendar.labels.unknownEquipment":"Unnamed equipment","calendar.labels.currencySuffix":"SR","calendar.labels.noEquipment":"No equipment","calendar.labels.noNotes":"No notes","calendar.labels.reservationId":"Reservation ID","calendar.labels.customer":"Customer","calendar.labels.start":"Start","calendar.labels.end":"End","calendar.labels.notes":"Notes","calendar.sections.crew":"😎 Crew members","calendar.sections.equipment":"📦 Equipment","calendar.emptyStates.noCrew":"😎 No crew assigned to this reservation.","calendar.table.headers.barcode":"Barcode","calendar.table.headers.description":"Description","calendar.table.headers.quantity":"Qty","calendar.table.headers.price":"Price","calendar.table.headers.image":"Image","calendar.summary.baseCost":"💵 Equipment subtotal: <strong>{value} SR</strong>","calendar.summary.discount":"💸 Discount: <strong>{value}</strong>","calendar.summary.tax":"🧾 Tax (15%): <strong>{value} SR</strong>","calendar.summary.total":"💰 Grand total: <strong>{value} SR</strong>","calendar.alerts.cannotShowDetails":"Unable to show reservation details","calendar.alerts.cannotOpenModal":"Unable to open details modal","calendar.modal.title":"📅 Reservation Details","reservations.toast.equipmentNameNotFound":"❌ No equipment found with that name","reservations.toast.equipmentMaintenance":"⚠️ This equipment is under maintenance and cannot be added","reservations.toast.equipmentMissingBarcode":"⚠️ This equipment has no barcode assigned","reservations.toast.requireDatesBeforeAdd":"⚠️ Set start and end date/time before adding equipment","reservations.toast.equipmentDuplicate":"⚠️ This equipment is already in the reservation","reservations.toast.equipmentTimeConflict":"⚠️ Cannot add equipment because it is booked or under maintenance in the same period","reservations.toast.equipmentMaintenanceStrict":"⚠️ Cannot add equipment while it is marked for maintenance","reservations.toast.requireOverallDates":"⚠️ Set the reservation dates before adding equipment","reservations.toast.equipmentTimeConflictSimple":"⚠️ This equipment is booked or under maintenance in the same period","reservations.toast.barcodeNotFound":"❌ Barcode not found","reservations.toast.equipmentAdded":"✅ Equipment added successfully","reservations.toast.noAdditionalUnits":"⚠️ No additional units available right now","reservations.toast.barcodeNotInCatalog":"❌ Barcode not found in catalog","reservations.toast.requireDates":"⚠️ Please set start and end date","reservations.toast.invalidDateRange":"⚠️ Make sure start time is before end time","reservations.toast.missingFields":"⚠️ Please fill in all required fields","reservations.toast.paymentNoRemainingBalance":"⚠️ This reservation is already fully paid; no additional payments can be added","reservations.toast.paymentCappedPercent":"ℹ️ Adjusted the payment to {value}% to complete 100%","reservations.toast.paymentCappedAmount":"ℹ️ Adjusted the payment to {amount} to finish the remaining balance","reservations.toast.companyShareRequiresTax":"⚠️ Enable VAT first before applying the company share","reservations.toast.noItems":"⚠️ Add at least one equipment item or crew member to the reservation","reservations.toast.cannotCreateEquipmentMaintenance":"⚠️ Cannot create reservation because an item is under maintenance","reservations.toast.cannotCreateEquipmentConflict":"⚠️ Cannot create reservation because an item is already booked","reservations.toast.cannotCreateCrewConflict":"⚠️ Cannot create reservation because a crew member has another booking in that period","reservations.toast.projectNotFound":"⚠️ Selected project was not found. Please refresh the page or choose another project.","reservations.toast.technicianSelectionConflict":"⚠️ Cannot select {names}; they are already booked for the selected time range","reservations.toast.created":"✅ Reservation created","reservations.toast.notFound":"⚠️ Unable to locate reservation data","reservations.toast.updateNoItems":"⚠️ Add at least one equipment item or crew member before saving","reservations.toast.updateEquipmentMaintenance":"⚠️ Cannot save changes because an item is under maintenance","reservations.toast.updateEquipmentConflict":"⚠️ Cannot save changes because an item conflicts with another booking","reservations.toast.updateCrewConflict":"⚠️ Cannot save changes because a crew member conflicts with another booking","reservations.toast.updated":"✅ Reservation updated","reservations.toast.confirmed":"✅ Reservation confirmed","reservations.toast.confirmBlockedByProject":"⚠️ This reservation is controlled by its linked project and cannot be confirmed here","reservations.toast.deleteConfirm":"⚠️ Are you sure you want to delete this reservation?","maintenance.section.title":"🛠️ Maintenance Management","maintenance.form.title":"➕ Create Maintenance Ticket","maintenance.form.hint":"Select the affected equipment and describe the issue to take it out of service.","maintenance.form.labels.barcode":"🏷️ Barcode","maintenance.form.placeholders.barcode":"🖨️ Scan or enter the barcode, then press Enter","maintenance.form.labels.search":"🎥 Add equipment by name","maintenance.form.placeholders.search":"Type the equipment name...","maintenance.form.labels.priority":"⚠️ Priority","maintenance.form.options.priority.high":"High","maintenance.form.options.priority.medium":"Medium","maintenance.form.options.priority.low":"Low","maintenance.form.selectedInfo":"No equipment selected yet.","maintenance.form.labels.issue":"📝 Issue description","maintenance.form.placeholders.issue":"Describe the issue or symptoms for the equipment","maintenance.form.actions.submit":"🛠️ Create Ticket","maintenance.form.blockedSuffix":"(In maintenance)","maintenance.list.title":"📋 Maintenance Tickets","maintenance.list.hint":"Track issues and close tickets once repairs are completed.","maintenance.filters.status.label":"Status","maintenance.filters.status.all":"All statuses","maintenance.filters.status.open":"In maintenance","maintenance.filters.status.closed":"Closed","maintenance.filters.priority.label":"Priority","maintenance.filters.priority.all":"All priorities","maintenance.filters.priority.high":"High","maintenance.filters.priority.medium":"Medium","maintenance.filters.priority.low":"Low","maintenance.filters.search.placeholder":"🔍 Search by equipment name or barcode...","maintenance.table.headers.equipment":"Equipment","maintenance.table.headers.issue":"Issue","maintenance.table.headers.priority":"Priority","maintenance.table.headers.created":"Created At","maintenance.table.headers.status":"Status","maintenance.table.headers.actions":"Actions","maintenance.table.empty":"No tickets yet.","maintenance.table.emptyFiltered":"No tickets match this filter.","maintenance.table.noName":"No name","maintenance.empty.title":"No maintenance tickets","maintenance.empty.subtitle":"Once you create a new ticket it will appear here.","maintenance.table.noBarcode":"No barcode","maintenance.table.repairCost":"💰 Repair cost: {amount}","maintenance.stats.open":"{count} in maintenance","maintenance.stats.closed":"{count} closed","maintenance.stats.total":"{count} total tickets","maintenance.stats.summaryTitle":"Maintenance Summary","maintenance.stats.totalLabel":"Total Tickets","maintenance.status.open":"In maintenance","maintenance.status.closed":"Closed","maintenance.status.inProgress":"In progress","maintenance.status.completed":"Completed","maintenance.status.cancelled":"Cancelled","maintenance.priority.high":"High","maintenance.priority.medium":"Medium","maintenance.priority.low":"Low","maintenance.actions.close":"🔧 Close after repair","maintenance.actions.view":"👁️ View report","maintenance.actions.delete":"🗑️ Delete ticket","maintenance.actions.editClosed":"✏️ Edit close details","maintenance.closeModal.title":"🔧 Close maintenance ticket","maintenance.closeModal.subtitle":"Please add a repair report before closing this ticket.","maintenance.closeModal.reportLabel":"📝 Repair report","maintenance.closeModal.reportPlaceholder":"Describe the repair work and actions taken...","maintenance.closeModal.editTitle":"✏️ Edit close details","maintenance.closeModal.editSubtitle":"Update the repair report and cost as needed.","maintenance.closeModal.editConfirm":"Save changes","maintenance.closeModal.editSaving":"⏳ Saving...","maintenance.closeModal.costLabel":"💰 Repair cost (optional)","maintenance.closeModal.costPlaceholder":"Enter repair cost if applicable","maintenance.closeModal.costHint":"Leave blank when there is no cost.","maintenance.closeModal.confirm":"Close ticket","maintenance.closeModal.cancel":"Cancel","maintenance.closeModal.saving":"⏳ Closing...","maintenance.toast.equipmentBlocked":"⚠️ This equipment is already under maintenance and can’t be selected","maintenance.toast.equipmentNotFoundBarcode":"❌ No equipment found with this barcode","maintenance.toast.equipmentNotFoundName":"❌ No equipment found with that name","maintenance.toast.equipmentBecameBlocked":"⚠️ This equipment is now under maintenance and can’t be selected","maintenance.toast.selectEquipment":"⚠️ Please select equipment","maintenance.toast.selectedNotFound":"❌ Selected equipment was not found","maintenance.toast.equipmentAlreadyMaintenance":"⚠️ This equipment is already marked as in maintenance","maintenance.toast.ticketExists":"⚠️ There is already an open maintenance ticket for this equipment","maintenance.toast.ticketCreated":"🛠️ Maintenance ticket created and equipment removed from service","maintenance.toast.storageError":"⚠️ Could not save maintenance data. Please try again.","maintenance.toast.submitError":"⚠️ Could not create the maintenance ticket. Please try again.","maintenance.toast.loading":"⏳ Maintenance data is refreshing, please wait a moment...","maintenance.toast.ticketAlreadyClosed":"✅ Tickets refreshed; this maintenance item appears to be already closed.","maintenance.toast.reportRequired":"⚠️ Please write the repair report before closing the ticket","maintenance.toast.invalidRepairCost":"⚠️ Please enter a valid numeric repair cost","maintenance.toast.ticketClosed":"✅ Maintenance ticket closed and equipment set to available","maintenance.toast.ticketDeleted":"🗑️ Maintenance ticket deleted","maintenance.toast.ticketDeleteConfirm":"⚠️ Are you sure you want to delete this maintenance ticket?","maintenance.prompt.closeReport":"Enter repair report / actions taken:","maintenance.report.equipment":"Equipment","maintenance.report.barcode":"Barcode","maintenance.report.issue":"Issue","maintenance.report.createdAt":"Created at","maintenance.report.closedAt":"Closed at","maintenance.report.repairCost":"Repair cost","maintenance.report.currencyLabel":"SR","maintenance.report.summary":"Report","maintenance.report.notAvailable":"Not available","maintenance.report.modalTitle":"📝 Maintenance Report","maintenance.report.modalSubtitle":"Ticket details and repair report.","maintenance.report.modalClose":"Done","maintenance.report.none":"—","maintenance.info.barcodeLabel":"Barcode","technicians.section.title":"😎 Crew Management","technicians.subTabs.management":"⚙️ Crew Members","technicians.subTabs.positions":"🏷️ Positions","technicians.form.title":"Add / Edit Crew Member","technicians.form.hint":"Enter crew member details to save and keep bookings updated.","technicians.form.labels.name":"😎 Crew Member","technicians.form.labels.phone":"📞 Phone","technicians.form.labels.role":"👔 Role","technicians.form.labels.department":"🧩 Department","technicians.form.labels.wage":"💰 Daily Rate","technicians.form.labels.total":"💼 Total Charge","technicians.form.labels.status":"⚙️ Base Status","technicians.form.labels.notes":"📝 Notes","technicians.form.placeholders.name":"Crew member name","technicians.form.placeholders.phone":"05xxxxxxxx","technicians.form.placeholders.role":"e.g. Camera operator","technicians.form.placeholders.department":"e.g. Audio team","technicians.form.placeholders.wage":"0","technicians.form.placeholders.total":"0","technicians.form.placeholders.notes":"Additional information","technicians.form.actions.cancel":"Cancel edit","technicians.form.actions.submit":"➕ Add Crew Member","technicians.form.actions.update":"💾 Update Crew Member","technicians.positionSummary.title":"💵 Cost details","technicians.positionSummary.match":"Cost: {cost} · Client price: {price}","technicians.positionSummary.custom":"No matching position found. Add it from the Positions tab. Current values will be saved: {cost} · Client price: {price}","technicians.positionSummary.noClientPrice":"—","technicians.picker.selectedLabel":"😎 Assigned crew","technicians.picker.openButton":"➕ Choose crew","technicians.picker.editButton":"🔁 Edit crew","technicians.picker.modalTitle":"😎 Select crew","technicians.picker.actions.apply":"Done","technicians.picker.actions.cancel":"Cancel","technicians.picker.selectionInfo":"No crew selected yet","technicians.picker.assignments.hint":"Use the positions list on the left to add crew roles.","technicians.picker.optionAssigned":"(Assigned)","technicians.picker.selectedCount":"Selected {count} member(s)","technicians.form.options.available":"✅ Available","technicians.form.options.busy":"⛔ Busy","technicians.search.placeholder":"🔍 Search crew member by name, phone, or role...","technicians.search.filters.allRoles":"👔 All roles","technicians.table.empty":"No crew members yet.","technicians.table.loading":"Loading...","technicians.table.headers.name":"😎 Crew Member","technicians.table.headers.phone":"📞 Phone","technicians.table.headers.role":"👔 Role","technicians.table.headers.department":"🧩 Department","technicians.table.headers.wage":"💰 Daily Rate","technicians.table.headers.total":"💼 Total charge","technicians.table.headers.status":"⚙️ Status","technicians.table.headers.notes":"📝 Notes","technicians.table.headers.actions":"⚙️ Actions","technicians.status.available":"✅ Available","technicians.status.busy":"⛔ Busy","technicians.table.wageSuffix":"SR","technicians.badge.perDay":"/day","technicians.actions.edit":"✏️ Edit","technicians.actions.delete":"🗑️ Delete","technicians.toast.missingName":"⚠️ Please enter the crew member name","technicians.toast.missingPhone":"⚠️ Please enter a contact number","technicians.toast.missingRole":"⚠️ Please enter the role","technicians.toast.invalidWage":"⚠️ Enter a valid daily wage","technicians.toast.invalidTotal":"⚠️ Enter a valid total charge","technicians.toast.addSuccess":"✅ Crew member added","technicians.toast.updateSuccess":"💾 Crew member updated","technicians.toast.notFound":"⚠️ Crew member not found","technicians.toast.unidentified":"⚠️ Unable to identify crew member","technicians.toast.dataNotFound":"⚠️ Crew member details not found","technicians.toast.editReady":"✏️ You can edit the crew member details now then press Save","technicians.toast.deleteConfirm":"⚠️ Are you sure you want to remove this crew member?","technicians.toast.deleteSuccess":"🗑️ Crew member removed","positions.form.title":"Add / Edit Position","positions.form.hint":"Define standard crew positions with cost and client price to speed up bookings.","positions.form.labels.nameAr":"🏷️ Position (Arabic)","positions.form.labels.nameEn":"🏷️ Position (English)","positions.form.labels.cost":"💵 Cost","positions.form.labels.clientPrice":"💼 Client price","positions.form.placeholders.nameAr":"مثال: مصور فوتوغرافي","positions.form.placeholders.nameEn":"e.g. Photographer","positions.form.placeholders.cost":"0","positions.form.placeholders.clientPrice":"0","positions.form.actions.cancel":"Cancel","positions.form.actions.submit":"➕ Add Position","positions.form.actions.update":"💾 Save position","positions.list.title":"📋 Current positions","positions.table.headers.nameAr":"🏷️ Position (Arabic)","positions.table.headers.nameEn":"🏷️ Position (English)","positions.table.headers.cost":"💵 Cost","positions.table.headers.clientPrice":"💼 Client price","positions.table.headers.actions":"⚙️ Actions","positions.table.actions.edit":"✏️ Edit","positions.table.actions.delete":"🗑️ Delete","positions.table.empty":"No positions yet.","positions.toast.invalidName":"⚠️ Enter a position name","positions.toast.invalidCost":"⚠️ Enter a valid cost","positions.toast.invalidClientPrice":"⚠️ Enter a valid client price","positions.toast.addSuccess":"✅ Position added","positions.toast.updateSuccess":"💾 Position saved","positions.toast.saveFailed":"⚠️ Could not save the position, please try again","positions.toast.fetchFailed":"⚠️ Could not load positions, please try again","positions.toast.notFound":"⚠️ Position not found","positions.toast.deleteConfirm":"⚠️ Are you sure you want to delete this position?","positions.toast.deleteSuccess":"🗑️ Position removed","positions.defaults.photographer":"Photographer","positions.defaults.videographer":"Videographer","positions.defaults.editor":"Editor","positions.defaults.director":"Director","positions.defaults.dop":"Director of Photography","positions.defaults.lightingAssistant":"Lighting assistant","positions.defaults.cameraAssistant":"Camera assistant"}});const gr="dark-mode",Qo=new WeakSet,Hf="theme-loading",mg="art-ratio:session-theme";let zf=!1;function pg(){return Array.from(document.querySelectorAll("[data-theme-toggle], .theme-toggle-btn"))}function fg(e){return e==="dark"?"dark":"light"}function BE(e){try{window.sessionStorage?.setItem(mg,fg(e))}catch{}}function FE(){try{const e=window.sessionStorage?.getItem(mg);return e==="dark"?"dark":e==="light"?"light":null}catch{return null}}function RE(){document.documentElement.classList.remove(Hf);const e=document.body;e&&e.classList.remove(Hf)}function jl(e,{persist:t=!0}={}){const n=fg(e),a=document.documentElement,s=document.body;n==="dark"?(a.classList.add(gr,"dark"),s&&s.classList.add(gr,"dark")):(a.classList.remove(gr,"dark"),s&&s.classList.remove(gr,"dark"));const r=n==="dark"?"dark":"light";a.setAttribute("data-theme",r),s&&s.setAttribute("data-theme",r),BE(n),wm(n);try{document.dispatchEvent(new CustomEvent("theme:changed",{detail:{theme:n}}))}catch(i){console.warn("⚠️ [theme.js] Failed to dispatch theme change event",i)}t&&Ft({theme:n}).catch(i=>{console.warn("⚠️ تعذر حفظ تفضيل السمة في الخادم",i)})}function bo(){const e=document.body;return e&&e.classList.contains(gr)||document.documentElement.classList.contains(gr)?"dark":"light"}function fd(){const e=bo()==="dark"?"light":"dark";jl(e,{persist:!0})}function ME(e,t){if(!e)return;const n=t==="dark",a=c("theme.toggle.toLight","☀️ الوضع العادي"),s=c("theme.toggle.toDark","🌙 الوضع الليلي"),r=c("theme.toggle.ariaLight","الوضع العادي مفعل"),i=c("theme.toggle.ariaDark","الوضع الليلي مفعل"),o=c("theme.toggle.titleLight","التبديل إلى الوضع العادي"),l=c("theme.toggle.titleDark","التبديل إلى الوضع الليلي");if(e.matches("[data-theme-toggle]")){const d=e.matches("input")?e:e.querySelector('input[type="checkbox"]'),u=n?a:s,m=n?r:i,p=n?o:l;d&&(d.checked=n,d.setAttribute("aria-label",u),d.setAttribute("aria-checked",String(n))),e.setAttribute("title",p),e.setAttribute("aria-label",m),e.setAttribute("data-theme-state",n?"dark":"light");const f=e.querySelector("[data-theme-label]");f&&(f.textContent=u)}else e.textContent=n?a:s,e.setAttribute("aria-pressed",String(n)),e.setAttribute("title",n?o:l),e.setAttribute("aria-label",n?r:i)}function wm(e){pg().forEach(t=>ME(t,e)),RE()}function Ia(){const e=pg();wm(bo()),e.forEach(t=>{if(!(!t||Qo.has(t))){if(t.matches("[data-theme-toggle]")){const n=t.matches("input")?t:t.querySelector('input[type="checkbox"]'),a=()=>{fd()};n&&!Qo.has(n)?(n.addEventListener("change",a),Qo.add(n)):n||t.addEventListener("click",s=>{s.preventDefault(),fd()})}else t.getAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",n=>{n.preventDefault(),fd()});Qo.add(t)}})}function Gs({skipRemote:e=!1}={}){const t=lt(),s=(t?.theme==="dark"?"dark":t?.theme==="light"?"light":null)||FE()||HE();jl(s,{persist:!1}),zE({skipRemote:e})}function HE(){try{if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return"dark"}catch{}return"light"}function zE({skipRemote:e=!1}={}){zf||(zf=!0,!e&&wl().then(t=>{const n=t?.theme==="dark"?"dark":t?.theme==="light"?"light":null;n&&jl(n,{persist:!1})}).catch(t=>{console.warn("⚠️ تعذر تحميل تفضيل السمة من الخادم",t)}))}document.addEventListener("language:changed",()=>{wm(bo()),Ia()});El(e=>{const t=e?.theme==="dark"?"dark":e?.theme==="light"?"light":null;t&&t!==bo()&&jl(t,{persist:!1})});function jm(){const e=typeof window<"u"?window:globalThis;return e.__APP_DATA_STORE__||(e.__APP_DATA_STORE__={customers:[],reservations:[],equipment:[],technicians:[],maintenance:[],projects:[],technicianPayouts:[],packages:[]}),e.__APP_DATA_STORE__}function Na(e,t,n){n!=null&&(e[t]=Array.isArray(n)?[...n]:n)}function ae(){const e=jm();return{customers:[...e.customers],reservations:[...e.reservations],equipment:[...e.equipment],technicians:[...e.technicians],maintenance:[...e.maintenance],projects:[...e.projects],technicianPayouts:[...e.technicianPayouts],packages:[...e.packages]}}function an(e={}){const t=jm();Na(t,"customers",e.customers),Na(t,"reservations",e.reservations),Na(t,"equipment",e.equipment),Na(t,"technicians",e.technicians),Na(t,"maintenance",e.maintenance),Na(t,"projects",e.projects),Na(t,"technicianPayouts",e.technicianPayouts),Na(t,"packages",e.packages)}let hd=!1;function Il(e=null){if(hd)return;const t=e||(typeof window<"u"?window.__LEGACY_DATA__:null);if(!t||typeof t!="object"){hd=!0;return}const n=jm();if(["customers","reservations","equipment","technicians","maintenance","projects","technicianPayouts","packages"].forEach(s=>{const r=t[s];Array.isArray(r)&&r.length>0&&(n[s]=[...r])}),hd=!0,!e&&typeof window<"u")try{delete window.__LEGACY_DATA__}catch{}}function hg(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="9999",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.width="min(92vw, 380px)",e.style.pointerEvents="none",document.body.appendChild(e)),e}function yg(e){e.style.background="#333",e.style.color="#fff",e.style.padding="10px 18px",e.style.marginTop="10px",e.style.borderRadius="10px",e.style.boxShadow="0 8px 24px rgba(15, 23, 42, 0.32)",e.style.opacity="0",e.style.transition="opacity 0.3s ease",e.style.fontSize="0.875rem",e.style.lineHeight="1.4",e.style.pointerEvents="auto",e.style.backdropFilter="blur(4px)"}function gg(e){requestAnimationFrame(()=>{e.style.opacity="1"})}function bg(e,t){let n;const a=()=>{n&&(clearTimeout(n),n=null),e.style.opacity="0",setTimeout(()=>e.remove(),320)};return n=setTimeout(a,t),{hide:a,timeoutId:n}}function I(e,t=3e3,n){const a=hg(),s=document.createElement("div");s.className="toast-message",s.textContent=e;const r=new Set(["success","error","info","warning"]);let i="info",o=3e3;typeof t=="number"&&Number.isFinite(t)?o=Math.max(0,t):typeof t=="string"&&r.has(t)&&(i=t),yg(s);const l={success:{bg:"#14532d",border:"rgba(34,197,94,0.35)",glow:"rgba(34,197,94,0.35)"},error:{bg:"#7f1d1d",border:"rgba(239,68,68,0.35)",glow:"rgba(239,68,68,0.35)"},info:{bg:"#1e3a8a",border:"rgba(59,130,246,0.35)",glow:"rgba(59,130,246,0.35)"},warning:{bg:"#7c2d12",border:"rgba(245,158,11,0.35)",glow:"rgba(245,158,11,0.35)"}},{bg:d,border:u,glow:m}=l[i]||l.info;s.style.background=d,s.style.border=`1px solid ${u}`,s.style.boxShadow=`0 8px 24px rgba(15, 23, 42, 0.32), 0 0 0 4px ${m}`,a.appendChild(s),gg(s);const{hide:p}=bg(s,o);s.addEventListener("click",p)}function vg({message:e,duration:t=6e3,actionLabel:n,onAction:a,linkLabel:s,linkHref:r}={}){const i=hg(),o=document.createElement("div");o.className="toast-message",yg(o);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="8px";const d=document.createElement("span");d.textContent=e,l.appendChild(d);const u=document.createElement("div");u.style.display="flex",u.style.flexWrap="wrap",u.style.gap="8px";let m=!1,p=()=>{};if(s&&r){const h=document.createElement("a");h.href=r,h.textContent=s,h.target="_blank",h.rel="noopener noreferrer",h.style.color="#bfdbfe",h.style.textDecoration="underline",h.style.fontWeight="500",h.style.pointerEvents="auto",u.appendChild(h),m=!0}if(n&&typeof a=="function"){const h=document.createElement("button");h.type="button",h.textContent=n,h.style.border="1px solid rgba(255,255,255,0.4)",h.style.background="rgba(15, 23, 42, 0.2)",h.style.color="#fff",h.style.borderRadius="999px",h.style.padding="6px 14px",h.style.fontSize="0.78rem",h.style.cursor="pointer",h.addEventListener("click",g=>{g.preventDefault();try{a()}catch(y){console.error("⚠️ [toast] action callback failed",y)}finally{p()}}),u.appendChild(h),m=!0}m&&l.appendChild(u),o.appendChild(l),i.appendChild(o),gg(o);const{hide:f}=bg(o,t);p=f,o.addEventListener("click",f)}const Of="RSV",Uf="PRJ",OE=4,$r=(()=>{try{const e=typeof globalThis<"u"?globalThis:window;return e.__APP_SEQUENCE_STATE__=e.__APP_SEQUENCE_STATE__||{reservation:0,project:0},e.__APP_SEQUENCE_STATE__}catch{return{reservation:0,project:0}}})();function UE(){return Number.isFinite($r.reservation)?$r.reservation:0}function VE(e){$r.reservation=Math.max(0,Number.parseInt(e,10)||0)}function KE(){return Number.isFinite($r.project)?$r.project:0}function WE(e){$r.project=Math.max(0,Number.parseInt(e,10)||0)}function Sg(){try{const e=ae();return{reservations:Array.isArray(e?.reservations)?e.reservations:[],projects:Array.isArray(e?.projects)?e.projects:[]}}catch(e){return console.warn("⚠️ [utils] Failed to load data snapshot for code generation",e),{reservations:[],projects:[]}}}function QE(e,t){if(e==null)return 0;if(typeof e=="number")return Number.isFinite(e)?Math.max(0,Math.trunc(e)):0;const n=String(e).trim();if(!n)return 0;const a=`${t.toUpperCase()}-`,s=n.toUpperCase();let r=n;s.startsWith(a)&&(r=n.slice(a.length));const i=r.match(/(\d+)$/);if(i){const l=Number.parseInt(i[1],10);return Number.isFinite(l)?Math.max(0,l):0}const o=Number.parseInt(n,10);return Number.isFinite(o)?Math.max(0,o):0}function GE(e){return Array.isArray(e)?e:[e]}function Ag(e,t,n){return!Array.isArray(e)||e.length===0?0:e.reduce((a,s)=>{const r=n(s),o=GE(r).reduce((l,d)=>{const u=QE(d,t);return u>l?u:l},0);return o>a?o:a},0)}function Eg(e,t){const n=Math.max(0,Number.parseInt(t,10)||0);return`${e}-${String(n).padStart(OE,"0")}`}function YE(){const{reservations:e}=Sg(),t=Ag(e,Of,a=>[a?.reservationCode,a?.reservation_code,a?.reservationId,a?.reservation_id,a?.id]),n=Math.max(t,UE())+1;return VE(n),Eg(Of,n)}function wg(){const{projects:e}=Sg(),t=Ag(e,Uf,a=>[a?.projectCode,a?.project_code,a?.code,a?.id]),n=Math.max(t,KE())+1;return WE(n),Eg(Uf,n)}function mt(e,t={}){if(!e)return"-";const n=new Date(e);if(Number.isNaN(n.getTime()))return"-";const a=document?.documentElement?.getAttribute("lang")||(typeof Le=="function"?Le():null)||"ar",r=String(a).toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.DateTimeFormat(r,{dateStyle:"short",timeStyle:"short",hour12:!0,calendar:"gregory",...t}).formatToParts(n),l=n.getHours()>=12?"PM":"AM",d=o.map(u=>u.type==="dayPeriod"?l:u.value).join("").replace(/\u200f/g,"");return b(d)}function b(e){if(e==null)return"";e=String(e);const t=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"],n=["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"],a=["0","1","2","3","4","5","6","7","8","9"];return Array.from(e).map(s=>{const r=t.indexOf(s);if(r>-1)return a[r];const i=n.indexOf(s);return i>-1?a[i]:s}).join("")}const Vf={INVALID:{key:"login.errors.invalidCredentials",fallback:"❌ بيانات الدخول غير صحيحة"},NETWORK:{key:"login.errors.network",fallback:"🌐 تعذر الاتصال بالخادم. حاول مرة أخرى."},GENERIC:{key:"login.errors.generic",fallback:"⚠️ حدث خطأ غير متوقع. حاول مرة أخرى."}};let Xt=null;const ei={USER_UPDATED:"auth:user-updated"};function XE(){try{const e=window?.location?.hostname||"";return e==="localhost"||e==="127.0.0.1"||e===""||e==="::1"}catch{return!1}}function jg(){try{if(!XE())return!1;const e=new URL(window.location.href),t=(e.searchParams.get("bypassAuth")||e.searchParams.get("dev")||e.searchParams.get("debug")||"").toLowerCase();return window.__BYPASS_AUTH__===!0||t==="1"||t==="true"}catch{return!1}}function JE(e){if(typeof document>"u")return;const t=document.documentElement;t&&(e?t.dataset.userRole=e:delete t.dataset.userRole)}function ZE(){typeof document>"u"||document.dispatchEvent(new CustomEvent(ei.USER_UPDATED,{detail:Xt?{...Xt}:null}))}function ks(e){if(e&&typeof e=="object"){const t=typeof e.role=="string"?e.role.trim().toLowerCase():null;Xt={id:Number.isFinite(e.id)?Number(e.id):null,username:String(e.username||""),loginAt:e.loginAt??null,role:t}}else Xt=null;JE(Xt?.role||""),ZE()}function e0(e="INVALID",t){if(t&&typeof t=="string")return t;const n=Vf[e]||Vf.INVALID;return c(n.key,n.fallback)}function t0(){const e=document.getElementById("login-error");e&&(e.textContent="",e.classList.add("hidden"))}function vi(e="INVALID",t){const n=e0(e,t);I(n);const a=document.getElementById("login-error");a&&(a.textContent=n,a.classList.remove("hidden"))}async function n0({username:e,password:t,form:n}){if(!(!e||!t))try{if(typeof window>"u"||typeof navigator>"u"||!window.isSecureContext||!navigator.credentials||typeof navigator.credentials.store!="function")return;const a=(()=>{try{const r=document.querySelector('link[rel~="icon"]');return r?r.href:void 0}catch{return}})();let s=null;if(n&&n instanceof HTMLFormElement&&typeof window.PasswordCredential<"u")try{s=new window.PasswordCredential(n)}catch(r){console.warn("⚠️ تعذر إنشاء بيانات الاعتماد من النموذج",r)}if(!s&&typeof window.PasswordCredential<"u")try{s=new window.PasswordCredential({id:e,name:e,password:t,iconURL:a})}catch(r){console.warn("⚠️ تعذر إنشاء PasswordCredential مباشر",r)}!s&&typeof navigator.credentials.create=="function"&&(s=await navigator.credentials.create({password:{id:e,name:e,password:t,iconURL:a}})),s&&await navigator.credentials.store(s)}catch(a){console.warn("⚠️ تعذر حفظ بيانات الاعتماد في المتصفح",a)}}async function a0(e,t,{form:n}={}){const a=(e||"").trim(),s=t||"";if(t0(),!a||!s)return vi("INVALID"),!1;try{const r=await pe("/auth/",{method:"POST",body:{username:a,password:s}});ks(r?.data??null);try{await Ft({theme:bo()})}catch(i){console.warn("⚠️ تعذر حفظ تفضيل السمة بعد تسجيل الدخول",i)}return wE(),await n0({username:a,password:s,form:n}),window.location.href="home.html",!0}catch(r){if(console.error("❌ فشل تسجيل الدخول",r),ks(null),r instanceof Ge)if(r.status===401||r.status===403)vi("INVALID");else if(r.status>=500)vi("GENERIC");else{const o=typeof r.message=="string"&&!/^request failed with status/i.test(r.message)?r.message:null;vi("GENERIC",o)}else vi("NETWORK");return!1}}async function ti(){try{await pe("/auth/",{method:"DELETE"})}catch(e){console.warn("⚠️ فشل تسجيل الخروج من الخادم",e)}finally{ks(null),I("🚪 تم تسجيل الخروج"),window.location.href="login.html"}}async function Im({refresh:e=!1}={}){if(jg())return Xt||ks({id:0,username:"dev-local",loginAt:new Date().toISOString(),role:"admin"}),Xt;if(!e&&Xt)return Xt;try{const t=await pe("/auth/");return ks(t?.data??null),Xt}catch(t){throw t instanceof Ge&&t.status===401&&ks(null),t}}function Rs({redirect:e=!0}={}){return jg()?(Xt||ks({id:0,username:"dev-local",loginAt:new Date().toISOString(),role:"admin"}),Promise.resolve(Xt)):Im({refresh:!0}).then(t=>(!t&&e&&(window.location.href="login.html"),t)).catch(t=>t instanceof Ge&&t.status===401?(e&&(window.location.href="login.html"),null):(console.error("❌ خطأ أثناء التحقق من الجلسة",t),e&&(window.location.href="login.html"),null))}function s0(){return Xt?.role||null}function St(){return s0()==="admin"}function Nn(){I(c("auth.permissions.denied","⚠️ ليس لديك صلاحية لتنفيذ هذا الإجراء"),"error")}function r0(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function i0({sidebar:e,backdrop:t}){e?.classList.add("open"),t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function Go({sidebar:e,backdrop:t}){e?.classList.remove("open"),t?.classList.remove("open"),e?.setAttribute("aria-hidden","true")}function o0(){const e=document.querySelector("[data-dashboard-greeting]");if(!e)return;const t=e.querySelector("[data-greeting-toggle]"),n=e.querySelector("[data-greeting-panel]");if(!t||!n)return;const a=o=>{o.target instanceof Node&&(e.contains(o.target)||i(!1))},s=()=>{window.requestAnimationFrame(()=>{document.addEventListener("click",a,{capture:!0})})},r=()=>{document.removeEventListener("click",a,{capture:!0})},i=o=>{n.hidden=!o,t.setAttribute("aria-expanded",String(o)),e.dataset.state=o?"open":"closed",o?s():r()};i(!1),t.addEventListener("click",()=>{const l=!(t.getAttribute("aria-expanded")==="true");i(l),l&&!window.matchMedia("(min-width: 768px)").matches&&n.scrollIntoView({behavior:"smooth",block:"start"})})}function vo(){const e=r0(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:s}=e;t&&(t.setAttribute("aria-hidden","true"),a?.addEventListener("click",r=>{r.preventDefault(),i0(e)}),s?.addEventListener("click",r=>{r.preventDefault(),Go(e)}),n?.addEventListener("click",()=>{Go(e)}),t.addEventListener("click",r=>{const i=r.target;if(i instanceof HTMLElement){if(i.hasAttribute("data-close-sidebar")||i.closest("[data-close-sidebar]")){Go(e);return}i.closest("[data-tab]")&&Go(e)}}),o0())}const c0=ae()||{};let _s=(c0.technicians||[]).map(_m);function xm(){return _s}function ni(e){return _s=Array.isArray(e)?e.map(_m):[],an({technicians:_s}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),_s}async function ai(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),a=await pe(`/technicians/${n?`?${n}`:""}`),s=a?.data??a;let r=[];Array.isArray(s)?r=s:s&&typeof s=="object"&&(Array.isArray(s.items)?r=s.items:Array.isArray(s.results)?r=s.results:Array.isArray(s.data)?r=s.data:Array.isArray(s.records)&&(r=s.records));const i=r.map(Ys);return ni(i)}async function Ig(e){const t=await pe("/technicians/",{method:"POST",body:e}),n=Ys(t?.data??{});return ni([..._s,n]),n}async function qm(e,t){const n=await pe(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Ys(n?.data??{}),s=_s.map(r=>String(r.id)===String(e)?a:r);return ni(s),a}async function xg(e){await pe(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ni(_s.filter(t=>String(t.id)!==String(e)))}function km({name:e,phone:t,email:n,role:a,department:s,dailyWage:r,dailyTotal:i,status:o,notes:l,active:d=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:s??null,daily_wage:r??0,daily_total:i??null,status:o??"available",notes:l??null,active:d?1:0}}function Ys(e={}){return qg({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function _m(e={}){return qg(e)}function qg(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",s=e.email??null,r=e.specialization??e.role??e.position??"",i=e.department??e.team??"",o=Kf(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=Kf(e.daily_total??e.dailyTotal??e.total??e.total_wage??o),d=Wf(e.baseStatus??e.status??"available"),u=Wf(e.status??e.baseStatus??"available"),m=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:s,role:r,department:i,dailyWage:o,dailyTotal:l,status:u,baseStatus:d,notes:m,active:p}}function Kf(e){const t=Number.parseFloat(b(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Wf(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function So(e){return e instanceof Ge}const wL=Object.freeze(Object.defineProperty({__proto__:null,buildTechnicianPayload:km,createTechnicianApi:Ig,deleteTechnicianApi:xg,getTechniciansState:xm,isApiError:So,mapLegacyTechnician:_m,mapTechnicianFromApi:Ys,refreshTechniciansFromApi:ai,setTechniciansState:ni,updateTechnicianApi:qm},Symbol.toStringTag,{value:"Module"}));Gs();Il();Rs();document.addEventListener("DOMContentLoaded",()=>{Ia();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ti()),e.dataset.listenerAttached="true")});function dt(e){const t=Number(e)||0,a=Le()==="ar"?"ar-SA-u-nu-latn":"en-US",s=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${b(s)} SR`}function l0(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function xl(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function d0(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}…`:""}function Q(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const u0="technicianPositions:updated";let xn=[],kg=!1,Si=null;function Tm(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function _g({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:s??null}}function m0(e){return xn=Array.isArray(e)?e.map(Tm).filter(t=>t.name!=="").sort((t,n)=>Dr(t).localeCompare(Dr(n),"ar",{sensitivity:"base"})):[],kg=!0,ql(),Et()}function ql(){try{const e={positions:Et()},t=new CustomEvent(u0,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function Dr(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function Et(){return xn.map(e=>({...e}))}function Br(e){const t=String(e??"").trim().toLowerCase();return t&&xn.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function p0({forceRefresh:e=!1}={}){return kg&&!e?Et():(Si&&!e||(Si=pe("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return m0(n)}).finally(()=>{Si=null})),Si)}async function es({forceRefresh:e=!1}={}){try{return await p0({forceRefresh:e})}catch(t){throw t instanceof Ge?t:new Ge(t?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"))}}async function f0({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}){const r=_g({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}),i=await pe("/technician-positions/",{method:"POST",body:r}),o=Tm(i?.data??{});return xn=[...xn,o],xn.sort((l,d)=>Dr(l).localeCompare(Dr(d),"ar",{sensitivity:"base"})),ql(),o}async function h0(e,{name:t,cost:n,clientPrice:a,labelAr:s,labelEn:r}){if(!e)throw new Error("Position id is required");const i=_g({name:t,cost:n,clientPrice:a,labelAr:s,labelEn:r}),o=await pe(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:i}),l=Tm(o?.data??{});return xn=xn.map(d=>d.id===l.id?l:d),xn.sort((d,u)=>Dr(d).localeCompare(Dr(u),"ar",{sensitivity:"base"})),ql(),l}async function y0(e){if(!e)throw new Error("Position id is required");return await pe(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),xn=xn.filter(t=>t.id!==Number(e)),ql(),Et()}const Zd="__ART_RATIO_TECH_SUB_TAB__",Tg=["technicians-management","technicians-positions"];let Ot=null,Qf=!1,qc=!1,$i="",eu=!1,Un=null,Ts="technicians-management";const Gf=g0();Gf&&(Ts=Gf);async function Cg({showToastOnError:e=!0}={}){if(!qc){qc=!0,$i="",nn();try{await ai(),eu=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),$i=So(t)?t.message:c("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&I($i,"error")}finally{qc=!1,nn()}}}function Pg(){return xm()}function Yo(e=""){return b(String(e)).trim().toLowerCase()}function Yf(e){return e==null?"":String(e)}function Fr(e=""){return b(String(e)).replace(/[^0-9+]/g,"")}function un(e=""){const t=b(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function qr(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function g0(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(Zd);return e&&Tg.includes(e)?e:null}catch(e){return console.warn("⚠️ [technicians] Failed to read stored sub-tab",e),null}}function b0(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Tg.includes(e)){window.localStorage.removeItem(Zd);return}window.localStorage.setItem(Zd,e)}catch(t){console.warn("⚠️ [technicians] Failed to store sub-tab",t)}}function Lg(e,t=0,n=null){const a=String(e??"").trim(),s=a?Br(a):null;return s?{matchedPosition:s,dailyWage:Number.isFinite(s.cost)?s.cost:0,dailyTotal:s.clientPrice==null?null:Number.isFinite(s.clientPrice)?s.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Ng(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function tu(e,t=Le()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function v0(e,t=Le()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function $g(){const{container:e,body:t}=Ng();!e||!t||(t.textContent="",e.hidden=!0)}function Cm(e,t={}){const{container:n,body:a}=Ng();if(!n||!a)return;const s=String(e??"").trim();if(!s){$g();return}const r=Lg(s,t?.dailyWage??0,t?.dailyTotal??null),i=dt(r.dailyWage||0),o=r.dailyTotal!=null?dt(r.dailyTotal):c("technicians.positionSummary.noClientPrice","—");r.matchedPosition?a.textContent=c("technicians.positionSummary.match","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",i).replace("{price}",o):a.textContent=c("technicians.positionSummary.custom","لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}").replace("{cost}",i).replace("{price}",o),n.hidden=!1}function Ao(){const e=document.getElementById("technician-position-options");if(!e)return;const t=Et(),n=Le(),a=new Set,s=[];t.forEach(r=>{const i=tu(r,n).trim();i&&!a.has(i.toLowerCase())&&(s.push(`<option value="${Q(i)}"></option>`),a.add(i.toLowerCase()));const o=v0(r,n).trim();o&&!a.has(o.toLowerCase())&&(s.push(`<option value="${Q(o)}"></option>`),a.add(o.toLowerCase()));const l=r.name?.trim();l&&!a.has(l.toLowerCase())&&(s.push(`<option value="${Q(l)}"></option>`),a.add(l.toLowerCase()))}),e.innerHTML=s.join("")}function Xf(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),s=t.map(o=>o?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(o=>{if(!o)return;const d=o.getAttribute("data-tech-tab")===s;o.classList.toggle("tab-active",d),o.classList.toggle("active",d),o.setAttribute("aria-selected",d?"true":"false"),o.setAttribute("tabindex",d?"0":"-1")}),n.forEach(o=>{if(!o)return;const d=o.getAttribute("data-tech-tab-panel")===s;o.hidden=!d,o.classList.toggle("active",d)}),Ts=s,b0(s);const i=t.find(o=>o?.getAttribute("data-tech-tab")===s)?.closest("[data-tab-scroll]");i&&i.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),s==="technicians-positions"&&(Aa(),es().then(()=>{Aa()}).catch(o=>{console.error("❌ [technicians] failed to load positions for tab switch",o),I(o?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}))}function Pm(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=c(n,a)}function Lm(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=c("technicians.form.actions.cancel","إلغاء التعديل"))}function Nm(){Pm(Ot?"update":"add"),Lm(!!Ot),nn()}function S0(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(r=>(r?.role||"").trim()).filter(Boolean))).sort((r,i)=>r.localeCompare(i,"ar",{sensitivity:"base"})),s=c("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${s}</option>`+a.map(r=>`<option value="${r}">${r}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function kl(){const e=document.getElementById("technician-form");e&&(e.reset(),Ot=null,Pm("add"),Lm(!1),$g())}function A0(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),s=document.getElementById("technician-department"),r=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=Fr(e.phone||""),a.value=e.role||"",s&&(s.value=e.department||""),r&&(r.value=e.notes||""),Ot=String(e.id),Pm("update"),Lm(!0),Cm(a.value,e))}function E0(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),s=document.getElementById("technician-notes");if(!e||!t||!n)return null;const r=e.value.trim(),i=Fr(t.value.trim());t.value=i;const o=n.value.trim(),l=a?.value.trim()||"",d="available",u=s?.value.trim()||"",m=Ot?Tl(Ot):null,{dailyWage:p,dailyTotal:f}=Lg(o,m?.dailyWage??0,m?.dailyTotal??null);return r?i?o?!Number.isFinite(p)||p<0?(I(c("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),null):f!=null&&(!Number.isFinite(f)||f<0)?(I(c("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),null):(Cm(o,{dailyWage:p,dailyTotal:f}),{name:r,phone:i,role:o,department:l,dailyWage:Number.isFinite(p)?p:0,dailyTotal:f==null?null:Number(f),status:d,baseStatus:d,notes:u}):(I(c("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(I(c("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(I(c("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function w0(e){e.preventDefault();try{await es()}catch(a){console.error("❌ [technicians] failed to load positions before submit",a);const s=a?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");I(s,"error");return}const t=E0();if(!t)return;const n=km({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{Ot?(await qm(Ot,n),I(c("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await Ig(n),I(c("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),kl(),nn()}catch(a){console.error("❌ [technicians] handleTechnicianSubmit failed",a);const s=So(a)?a.message:c("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");I(s,"error")}}function j0(){kl()}function I0(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=Fr(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=un(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const s=un(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==s&&(t.total.value=s);const r=e.baseStatus||e.status||"available";t.status.value!==r&&(t.status.value=r),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),qr(t.phone,Fr),qr(t.wage,un),qr(t.total,un)}function x0(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),s=document.getElementById("edit-technician-department"),r=document.getElementById("edit-technician-wage"),i=document.getElementById("edit-technician-total"),o=document.getElementById("edit-technician-status"),l=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!r||!i||!o)return null;const d=e.value.trim(),u=t.value.trim(),m=Fr(n.value.trim());n.value=m;const p=a.value.trim(),f=s?.value.trim()||"",h=un(r.value.trim());r.value=h;const g=h===""?0:parseFloat(h),y=un(i.value.trim());i.value=y;const E=y===""?null:parseFloat(y),S=o.value||"available",x=l?.value.trim()||"";return d?u?m?p?Number.isNaN(g)||g<0?(I(c("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),r.focus(),null):E!=null&&(Number.isNaN(E)||E<0)?(I(c("technicians.toast.invalidTotal","⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية")),i.focus(),null):{id:d,name:u,phone:m,role:p,department:f,dailyWage:Number.isFinite(g)?g:0,dailyTotal:E==null?null:Number(E),status:S,baseStatus:S,notes:x}:(I(c("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),a.focus(),null):(I(c("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(I(c("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(I(c("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function q0(){const e=x0();if(!e)return;const t=km({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await qm(e.id,t),I(c("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),nn()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const a=So(n)?n.message:c("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");I(a,"error")}}function nn(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Yo(t?.value||"");if(qc&&!eu){const d=c("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='6'>${d}</td></tr>`;return}if($i&&!eu){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${$i}</td></tr>`;return}const a=Ut(),{reservations:s=[]}=ae(),r=new Date;S0(a);const i=document.getElementById("technician-role-filter"),o=Yo(i?.value||""),l=a.filter(d=>o&&Yo(d.role||"")!==o?!1:n?Yo([d.name,d.phone,d.role,d.department,d.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const d=c("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='6'>${d}</td></tr>`;return}e.innerHTML=l.map(d=>{const u=Ot&&String(Ot)===String(d.id),f=(Bg(d.id,s,r)?"busy":d.status||d.baseStatus||"available")==="busy"?{label:c("technicians.status.busy","⛔ مشغول"),className:"technician-status-badge technician-status-badge--busy"}:{label:c("technicians.status.available","✅ متاح"),className:"technician-status-badge technician-status-badge--available"},h=c("technicians.actions.edit","✏️ تعديل"),g=c("technicians.actions.delete","🗑️ حذف"),y=St(),E=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${d.id}">${h}</button>`];return y&&E.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${d.id}">${g}</button>`),`
      <tr${u?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${d.id}" class="text-decoration-none">${d.name}</a></td>
        <td>${d.role||""}</td>
        <td>${d.department||"—"}</td>
        <td><span class="${f.className}"><span class="technician-status-badge__text">${f.label}</span></span></td>
        <td class="table-notes-cell">${d.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${E.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function _l(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function Dg(e="add"){const{submitBtn:t,cancelBtn:n}=_l(),a=e==="update";if(t){const s=a?"positions.form.actions.update":"positions.form.actions.submit",r=a?"💾 حفظ المنصب":"➕ إضافة منصب";t.textContent=c(s,r)}n&&(n.classList.toggle("d-none",!a),n.textContent=c("positions.form.actions.cancel","إلغاء"))}function $m(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:s,clientPriceInput:r}=_l();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),s&&(s.value=""),r&&(r.value=""),Un=null,Dg("add")}function k0(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:s,clientPriceInput:r}=_l();!e||!s||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),s.value=un(e.cost??0),r&&(r.value=e.clientPrice==null?"":un(e.clientPrice)),Un=e.id||null,Dg("update"))}function _0(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=_l();if(!n)return null;const s=e?.value.trim()||"",r=t?.value.trim()||"",i=r||s,o=Un?Et().find(p=>String(p.id)===String(Un)):null,l=un(n.value.trim());n.value=l;const d=l===""?0:parseFloat(l),u=a?un(a.value.trim()):"";a&&(a.value=u);const m=u===""?null:parseFloat(u);return i?!Number.isFinite(d)||d<0?(I(c("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),n.focus(),null):m!=null&&(!Number.isFinite(m)||m<0)?(I(c("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),a?.focus(),null):{id:Un,name:o?.name||i,cost:Number(d.toFixed(2)),clientPrice:m==null?null:Number(m.toFixed(2)),labelAr:s||null,labelEn:r||null}:(I(c("positions.toast.invalidName","⚠️ يرجى إدخال اسم المنصب")),e&&e.focus(),null)}function Rr(){const e=document.getElementById("technician-role");if(!e)return;const t=Ot?Tl(Ot):null;Cm(e.value,t||{})}function Aa(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=Et();if(t&&(t.textContent=b(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${c("positions.table.empty","لا توجد مناصب بعد.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const s=Un&&String(Un)===String(a.id),r=dt(a.cost||0),i=a.clientPrice==null?c("technicians.positionSummary.noClientPrice","—"):dt(a.clientPrice),o=tu(a,"ar")||"—",l=tu(a,"en")||"—",d=c("positions.table.actions.edit","✏️ تعديل"),u=c("positions.table.actions.delete","🗑️ حذف");return`
      <tr${s?' class="technician-table-row-editing"':""}>
        <td>${Q(o)}</td>
        <td>${Q(l)}</td>
        <td>${Q(r)}</td>
        <td>${Q(i)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${d}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${u}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function T0(e){e.preventDefault();const t=_0();if(t)try{const n=!!Un;n?await h0(t.id,t):await f0(t);const a=n?c("positions.toast.updateSuccess","💾 تم حفظ بيانات المنصب"):c("positions.toast.addSuccess","✅ تم إضافة المنصب");I(a),$m(),Aa(),Ao(),Rr()}catch(n){console.error("❌ [technicians] handlePositionSubmit failed",n);const a=n?.message||c("positions.toast.saveFailed","⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى");I(a,"error")}}function C0(){$m()}async function P0(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await es();const a=Et().find(s=>String(s.id)===String(n));if(!a){I(c("positions.toast.notFound","⚠️ تعذر العثور على بيانات المنصب"),"error");return}k0(a),Aa();return}if(t.classList.contains("position-delete-btn")){if(!confirm(c("positions.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا المنصب؟")))return;await y0(n),Un&&String(Un)===String(n)&&$m(),I(c("positions.toast.deleteSuccess","🗑️ تم حذف المنصب")),Aa(),Ao(),Rr()}}catch(t){console.error("❌ [technicians] handlePositionsTableClick failed",t);const n=t?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");I(n,"error")}}function L0(e){const t=Pg().find(n=>String(n.id)===String(e));if(!t){I(c("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}A0(t),I(c("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function N0(e){if(!St()){Nn();return}if(confirm(c("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await xg(e),I(c("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),Ot&&String(Ot)===String(e)&&kl(),nn()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=So(t)?t.message:c("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");I(n,"error")}}function $0(){Dm(),nn()}function Tl(e){return Pg().find(t=>String(t.id)===String(e))||null}function Bg(e,t=[],n){const a=Yf(e);return a?t.some(s=>{if(!s||!s.start||!s.end||!(Array.isArray(s.technicians)?s.technicians:[]).some(l=>Yf(l)===a))return!1;const i=new Date(s.start),o=new Date(s.end);return Number.isNaN(i.getTime())||Number.isNaN(o.getTime())?!1:i<=n&&n<o}):!1}function Ut(){const e=ae().reservations||[],t=xm();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const s=t.map(r=>{if(!r)return r;const i=r.baseStatus||r.status||"available";let o=i==="busy"?"busy":i;return Bg(r.id,e,n)&&(o="busy"),(o!==r.status||i!==r.baseStatus)&&(a=!0),{...r,baseStatus:i,status:o}});return a?(ni(s),s):t}function Dm(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{w0(p).catch(f=>{console.error("❌ [technicians] submit handler failed",f)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",j0),n.dataset.listenerAttached="true"),qr(document.getElementById("technician-phone"),Fr);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{Rr()}),a.dataset.listenerAttached="true");const s=document.getElementById("technicians-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",p=>{const f=p.target;if(f instanceof HTMLElement){if(f.classList.contains("technician-edit-btn")){const h=f.dataset.id;L0(h)}if(f.classList.contains("technician-delete-btn")){const h=f.dataset.id;N0(h).catch(g=>{console.error("❌ [technicians] delete handler failed",g)})}}}),s.dataset.listenerAttached="true");const r=document.getElementById("search-technician-input");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=b(r.value),nn()}),r.dataset.listenerAttached="true");const i=document.getElementById("technician-role-filter");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{nn()}),i.dataset.listenerAttached="true");const o=document.getElementById("save-technician-changes");o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{q0().catch(p=>{console.error("❌ [technicians] modal save failed",p)})}),o.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",p=>{T0(p).catch(f=>{console.error("❌ [technicians] position submit failed",f)})}),l.dataset.listenerAttached="true");const d=document.getElementById("position-cancel-btn");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",C0),d.dataset.listenerAttached="true");const u=document.getElementById("positions-table");u&&!u.dataset.listenerAttached&&(u.addEventListener("click",P0),u.dataset.listenerAttached="true"),qr(document.getElementById("position-cost"),un),qr(document.getElementById("position-client-price"),un);const m=document.querySelector("[data-tech-tabs]");m&&!m.dataset.listenerAttached&&(m.querySelectorAll("[data-tech-tab]").forEach(f=>{f&&f.addEventListener("click",()=>{const h=f.getAttribute("data-tech-tab");Xf(h)})}),m.dataset.listenerAttached="true"),Xf(Ts),es().then(()=>{Ao(),Ts==="technicians-positions"&&Aa(),Rr()}).catch(p=>{console.error("❌ [technicians] failed to load technician positions",p),I(p?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}),Qf||(document.addEventListener("technician:prefill",p=>{const f=p.detail;f&&I0(f)}),Qf=!0),t&&kl(),Ts==="technicians-positions"&&Aa()}window.addEventListener("DOMContentLoaded",()=>{Dm(),nn(),Nm(),Cg()});const Fg=()=>{nn()};window.addEventListener("technicians:updated",Fg);document.addEventListener("technicians:updated",Fg);document.addEventListener("technicians:refreshRequested",()=>{Dm(),nn(),Nm(),Cg({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Nm(),Ao(),Ts==="technicians-positions"&&Aa(),Rr()});document.addEventListener(ei.USER_UPDATED,()=>{nn()});const Rg=()=>{Ao(),Ts==="technicians-positions"&&Aa(),Rr()};window.addEventListener("technicianPositions:updated",Rg);document.addEventListener("technicianPositions:updated",Rg);function _i(e){return b(String(e||"")).trim().toLowerCase()}function kt(e){const t=String(e??"").trim().toLowerCase();return t||""}function Mg(){const{packages:e=[]}=ae();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function Gi(e){const t=kt(e);return t&&Mg().find(a=>kt(a?.id??a?.packageId??a?.package_id)===t)||null}function qn(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(o=>({barcode:o}))),n.forEach(o=>{if(!o)return;if(typeof o=="string"||typeof o=="number"){const p=_i(o);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof o!="object")return;const l=_i(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number),d=[o.equipmentId,o.equipment_id,o.itemId,o.item_id,o.id].find(p=>p!=null&&p!==""),u=[o.unit_price,o.unitPrice,o.price,o.daily_rate].find(p=>Number.isFinite(Number(p))),m=[o.quantity,o.qty,o.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:d!=null?String(d):null,barcode:o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??"",normalizedBarcode:l,qty:m!=null?Number(m):1,price:u!=null?Number(u):0,desc:o.description??o.desc??o.name??"",image:o.image??o.imageUrl??o.img??null})});const a=new Map,{equipment:s=[]}=ae()||{},r=new Map,i=new Map;return(Array.isArray(s)?s:[]).forEach(o=>{if(!o||typeof o!="object")return;[o.id,o.equipment_id,o.equipmentId,o.item_id,o.itemId].map(u=>u!=null?String(u):"").filter(Boolean).forEach(u=>{r.has(u)||r.set(u,o)});const d=_i(o.barcode);d&&!i.has(d)&&i.set(d,o)}),t.forEach(o=>{if(o.equipmentId&&r.has(o.equipmentId)){const l=r.get(o.equipmentId);if(l){if(o.desc||(o.desc=l.desc||l.description||l.name||""),o.barcode||(o.barcode=l.barcode||""),o.price==null||o.price===0){const d=l.price??l.unit_price,u=Number(d);Number.isFinite(u)&&u>=0&&u<1e6&&(o.price=u)}o.image||(o.image=l.image||l.imageUrl||l.img||null)}}else if(o.normalizedBarcode&&i.has(o.normalizedBarcode)){const l=i.get(o.normalizedBarcode);if(l){if(o.desc||(o.desc=l.desc||l.description||l.name||""),o.barcode||(o.barcode=l.barcode||""),o.price==null||o.price===0){const d=l.price??l.unit_price,u=Number(d);Number.isFinite(u)&&u>=0&&u<1e6&&(o.price=u)}o.image||(o.image=l.image||l.imageUrl||l.img||null)}}}),t.forEach(o=>{const l=o.normalizedBarcode||(o.barcode?_i(o.barcode):""),d=l||(o.equipmentId?`id:${o.equipmentId}`:null);if(!d)return;if(!a.has(d)){a.set(d,{...o,normalizedBarcode:l});return}const u=a.get(d);u.qty+=o.qty,!u.price&&o.price&&(u.price=o.price),!u.desc&&o.desc&&(u.desc=o.desc),!u.image&&o.image&&(u.image=o.image)}),Array.from(a.values())}function Hg(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const a of t){const s=Number(a);if(Number.isFinite(s))return s}return qn(e).reduce((a,s)=>a+(s.price||0)*(s.qty||1),0)}function zg(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Bm(){return Mg().map(t=>{const n=kt(t?.id??t?.packageId??t?.package_id??t?.code),a=zg(t)||n||"package",s=Hg(t);return{id:n,name:a,price:s,code:t?.package_code??t?.code??n,items:qn(t),raw:t}}).filter(t=>t.id)}function D0(e){const t=_i(e);return t?Bm().filter(n=>n.items.some(a=>a.normalizedBarcode===t)):[]}function B0(e){return qn(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let Mr=[],Og=[],Ug=[],Vg="single";function Yn(){return Mr}function Kg(e){Mr=Array.isArray(e)?e:[]}function Cl(e){Mr=[...Mr,e]}function F0(e){Number.isInteger(e)&&e>=0&&(Mr=Mr.filter((t,n)=>n!==e))}function Fm(){return Og}function R0(e){Og=Array.isArray(e)?e:[]}function Wg(){return Ug}function Qg(e){Ug=Array.isArray(e)?e:[]}function Hc(){return Vg==="package"?"package":"single"}function M0(e){Vg=e==="package"?"package":"single"}function Gg(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",s=""]=n.split("T"),r=a?a.slice(0,10):"",i=s.match(/(\d{1,2}:\d{2})/);let o="";if(i){const[l="00",d="00"]=i[0].split(":");o=`${l.padStart(2,"0")}:${d.padStart(2,"0")}`}return{date:r,time:o}}function ca(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function ve(e){return b(String(e||"")).trim().toLowerCase()}const H0=864e13;function la(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const s=new Date(a);if(!Number.isNaN(s.getTime()))return s}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function Xn(e,t,n,a=null){if(!e||!t||!n)return!1;const s=la(t),r=la(n);if(!s||!r||s>=r)return!1;const i=ve(e);if(!i)return!1;const o=ae()||{},l=Array.isArray(o.reservations)?o.reservations:[],d=Array.isArray(o.maintenance)?o.maintenance:[],u=Array.isArray(o.equipment)?o.equipment:[],m=Y0(u),p=Hm(a);return l.some(h=>{if(!h||zm(h,p)||!h.start||!h.end)return!1;const g=la(h.start),y=la(h.end);return!g||!y||!(g<r&&y>s)?!1:z0(h,i)})?!0:d.some(h=>{if(!V0(h)||!W0(h,m).has(i))return!1;const{start:y,end:E}=Q0(h);if(!y&&!E)return!0;const S=y??new Date(0),x=E??new Date(H0);return S<r&&x>s})}function Yg(e,t,n,a=null){const s=kt(e);if(!s||!t||!n)return!1;const r=la(t),i=la(n);if(!r||!i||r>=i)return!1;const o=ae()||{},l=Array.isArray(o.reservations)?o.reservations:[],d=Hm(a);return l.some(u=>{if(!u?.start||!u?.end||zm(u,d))return!1;const m=la(u.start),p=la(u.end);return!m||!p||!(m<i&&p>r)?!1:O0(u,s)})}function Rm(e,t,n,a=null){const s=ve(e);if(!s||!t||!n)return[];const r=D0(s);return r.length?r.filter(i=>Yg(i.id,t,n,a)):[]}function Xg(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(a=>{const s=e[a];Array.isArray(s)&&s.length&&t.push(s)}),t}function z0(e,t){if(!t||!e||typeof e!="object")return!1;const n=ve(e?.barcode);if(n&&n===t)return!0;const a=Xg(e);for(const s of a)for(const r of s)if(U0(r).has(t))return!0;return!1}function O0(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const r of n){if(!r&&r!==0)continue;const i=kt(r);if(i&&i===t)return!0}const a=e.packages;if(Array.isArray(a))for(const r of a){const i=kt(r);if(i&&i===t)return!0}const s=Xg(e);for(const r of s)for(const i of r)if(Mm(i).has(t))return!0;return!1}function U0(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const r=ve(e);return r&&t.add(r),t}if(typeof e!="object")return t;const n=ve(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(r=>{const i=e[r];Array.isArray(i)&&i.forEach(o=>{if(o!=null){if(typeof o=="string"||typeof o=="number"){const l=ve(o);l&&t.add(l);return}if(typeof o=="object"){const l=ve(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number);l&&t.add(l)}}})});const s=Mm(e);return s.size&&s.forEach(r=>{const i=Gi(r);if(!i)return;B0(i).forEach(l=>{const d=l.normalizedBarcode??ve(l.barcode);d&&t.add(d)})}),t}function Mm(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(a=>{const s=kt(a);s&&t.add(s)}),e.package&&typeof e.package=="object"&&Mm(e.package).forEach(s=>t.add(s)),Array.isArray(e.packages)&&e.packages.forEach(a=>{const s=kt(a);s&&t.add(s)}),t}function V0(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(G0(e))return!1;for(const n of t){const a=K0(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function K0(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="مكتمل"||t==="مغلق"?"completed":t==="cancelled"||t==="canceled"||t==="ملغي"?"cancelled":t==="in_progress"||t==="in-progress"||t==="قيد_التنفيذ"||t==="جاري_العمل"||t==="inprogress"?"in_progress":t==="open"||t==="قيد_الصيانة"||t==="قيد_الانتظار"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("تنفيذ")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function W0(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(i=>{const o=ve(i);o&&n.add(o)});const s=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(s){const i=ve(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);i&&n.add(i)}return[e?.equipmentId,e?.equipment_id,s?.id,s?.equipmentId,s?.equipment_id].map(i=>i!=null?String(i):"").filter(Boolean).forEach(i=>{const o=t.get(i);if(!o)return;const l=ve(o?.barcode??o?.equipmentBarcode??o?.code??o?.serial??o?.serialNumber??o?.serial_number);l&&n.add(l)}),n}function Q0(e){const t=nu([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=nu([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function G0(e){return!!nu([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function nu(e=[]){for(const t of e){const n=la(t);if(n)return n}return null}function Y0(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{t.has(s)||t.set(s,n)})}),t}function Eo(e,t,n,a=null){if(!e||!t||!n)return!1;const s=new Date(t),r=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(r.getTime()))return!1;const{reservations:i=[]}=ae(),o=String(e),l=Hm(a);return i.some(d=>{if(!d?.start||!d?.end||zm(d,l))return!1;const u=new Date(d.start),m=new Date(d.end);return Number.isNaN(u.getTime())||Number.isNaN(m.getTime())||!(u<r&&m>s)?!1:(Array.isArray(d.technicians)?d.technicians:[]).some(h=>String(h)===o)})}function Hm(e){return br(e,new Set)}function zm(e,t){if(!t||t.size===0)return!1;const n=br([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function br(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(r=>br(r,t)),t;if(Array.isArray(e))return e.forEach(r=>br(r,t)),t;if(typeof e=="object"){const r=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let i=!1;return r.forEach(o=>{Object.prototype.hasOwnProperty.call(e,o)&&(i=!0,br(e[o],t))}),i||Object.values(e).forEach(o=>br(o,t)),t}const n=b(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],s=n.replace(/\D+/g,"");if(s){a.push(s);const r=Number.parseInt(s,10);Number.isNaN(r)||a.push(String(r))}return a.forEach(r=>{r&&t.add(r)}),t}const X0=()=>c("reservations.create.summary.currency","SR");let Hr=[],On=[],fa=[],ha=[],wt="create",Jg=()=>{},Zg=()=>{};const kc=new Map,au=450;function J0(e){const t=kc.get(e);return t!=null&&Date.now()-t<au}function Z0(e){kc.set(e,Date.now()),setTimeout(()=>{const t=kc.get(e);t!=null&&Date.now()-t>=au&&kc.delete(e)},au+50)}function Yi(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ms(e={}){return{...e,assignmentId:e.assignmentId||Yi()}}function Pl(e){if(!e)return null;const t=String(e),n=Hr.find(s=>String(s?.id)===t);if(n)return{...n};const{technicians:a=[]}=ae();return a.find(s=>String(s?.id)===t)||null}function zr(e={},t=Le()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Om(e={},t=Le()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function eb(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const a=On.find(r=>String(r.id).trim().toLowerCase()===n);if(a)return a;const s=Br(e);return s||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function Jf(e){const t=eb(e,e?.name??""),n=Le(),a=zr(t,n)||t?.name||"",s=Om(t,n);return su({assignmentId:Yi(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:a,positionLabelAlt:s,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function su(e={}){const t={assignmentId:e.assignmentId||Yi(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=eb(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const a=Le(),s=zr(n,a)||t.positionLabel,r=Om(n,a);t.positionLabel=s||t.positionLabel||n?.name||"",t.positionLabelAlt=r||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const a=Pl(t.technicianId);a?(t.technicianId=String(a.id),t.technicianName=a.name??t.technicianName??null,t.technicianRole=a.role??t.technicianRole??null,t.technicianPhone=a.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function si(){On=Et()}function ew(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return Ms(su(t));const n=Pl(t),a=n?{assignmentId:Yi(),positionLabel:n.role||c("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:Yi(),positionLabel:c("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return Ms(su(a))}).filter(Boolean):[]}function ts(e="create"){return e==="edit"?ha.map(Ms):fa.map(Ms)}function Ea(e="create",t=[]){try{si()}catch{}const n=ew(t);e==="edit"?(ha=n,Or("edit-selected-technicians-list",ha,"edit"),Zg()):(fa=n,Or("selected-technicians-list",fa,"create"),Jg()),Xi()}function Um(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),d=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",m=o?ca(o,d):null,p=l?ca(l,u):null;let f=null;const h=document.getElementById("edit-res-index")?.value;if(h!=null){const g=Number.parseInt(h,10);if(Number.isInteger(g)){const{reservations:y=[]}=ae(),E=y?.[g];E&&(f=E.id??E.reservationId??null)}}return{start:m,end:p,ignoreReservationId:f}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",s=document.getElementById("res-end-time")?.value?.trim()||"00:00",r=t?ca(t,a):null,i=n?ca(n,s):null;return{start:r,end:i,ignoreReservationId:null}}function Xi(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=ts(wt).length;if(t){const n=c("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",b(String(t)));e.textContent=n}else e.textContent=c("technicians.picker.selectionInfo","No crew selected yet")}function zc(e){const t=Number.isFinite(e)?e:0;return`${b(t.toFixed(2))} ${X0()}`}function tw(e){const t=ts(wt),n=new Set(t.filter(d=>d.assignmentId!==e&&d.technicianId).map(d=>d.technicianId)),a=Hr.length?Hr:ae().technicians||[],{start:s,end:r,ignoreReservationId:i}=Um(wt),o=!!(s&&r);return a.map(d=>{const u=String(d.id),m=n.has(u),p=o?Eo(u,s,r,i):!1,f=b(d.name||d.full_name||d.fullName||d.email||u);return{id:u,label:f,disabled:m||p,conflict:p,taken:m}})}function In(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=ts(wt);if(!t.length){const n=c("technicians.picker.noAssignments","لم يتم إضافة أي مناصب بعد"),a=c("technicians.picker.assignments.hint","استخدم قائمة المناصب على اليسار لإضافة طاقم العمل.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">🧑‍🤝‍🧑</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${a}</p>
          </div>
        </td>
      </tr>
    `;return}si(),e.innerHTML=t.map((n,a)=>{const s=b(String(a+1)),r=zc(n.positionClientPrice||0),i=tw(n.assignmentId),o=c("technicians.picker.noTechnicianOption","— بدون تعيين —"),l=n.technicianId!=null?String(n.technicianId):"",d=n.technicianName?b(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,m=c("technicians.picker.optionAssigned","(مستخدم)"),p=c("technicians.picker.optionConflicting","(متعارض)"),f=i.map(S=>{const x=l===S.id,C=S.disabled&&!x?`${S.label} ${S.conflict?p:m}`:S.label;return`
        <option value="${S.label}"
                data-id="${S.id}"
                data-disabled="${S.disabled?"true":"false"}"
                data-conflict="${S.conflict?"true":"false"}"
                data-taken="${S.taken?"true":"false"}"
                label="${C}"></option>
      `}).join("");let h=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!h||String(h).trim()===""){const S=n.positionId?On.find(A=>String(A.id)===String(n.positionId)):null,x=!S&&n.positionKey?On.find(A=>String(A.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(S||x){const A=S||x;h=zr(A,Le())||A?.name||""}}const g=n.positionLabelAlt?`<div class="text-muted small">${b(n.positionLabelAlt)}</div>`:"",y=c("technicians.picker.actions.remove","إزالة"),E=c("technicians.picker.assignments.price","سعر العميل");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${s}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${b(h||c("reservations.crew.positionFallback","منصب بدون اسم"))}</div>
            ${g}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${E}">${r}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${o}"
              value="${l?d:""}"
              aria-label="${c("technicians.picker.assignments.member","عضو الطاقم")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${f}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${y}">
            ${y}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{tb(n.dataset.assignmentId,wt)}),n.dataset.listenerAttached="true")}),nw(e)}function nw(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const a=n.dataset.assignmentId,s=()=>{aw(n,a)};n.addEventListener("change",s),n.addEventListener("blur",s),n.dataset.listenerAttached="true"})}function aw(e,t){if(!t||J0(t))return;Z0(t);const n=e.value?.trim()??"";if(!n){Xo(t,"");return}const a=e.getAttribute("list"),s=a?document.getElementById(a):null,r=s?Array.from(s.options):[],i=b(n).toLowerCase(),o=r.find(d=>b(d.value).toLowerCase()===i);if(!o){I(c("technicians.picker.toast.autocompleteNoMatch","⚠️ لم يتم العثور على فني مطابق، الرجاء اختيار من القائمة")),e.value="",Xo(t,"");return}if(o.dataset.disabled==="true"){o.dataset.conflict==="true"?I(c("technicians.picker.optionConflict","⚠️ هذا العضو لديه تعارض في التاريخ/الوقت المحدد")):I(c("technicians.picker.optionTaken","⚠️ لا يمكن اختيار هذا العضو لأنه مرتبط بمنصب آخر")),e.value="";return}const l=o.dataset.id;if(!l){I(c("technicians.picker.toast.autocompleteNoMatch","⚠️ لم يتم العثور على فني مطابق، الرجاء اختيار من القائمة")),e.value="",Xo(t,"");return}Xo(t,l)}function ru(){const e=document.getElementById("crew-position-list");if(!e)return;si();const t=document.getElementById("crew-position-search"),n=b(String(t?.value||"")).trim().toLowerCase(),s=ts(wt).reduce((o,l)=>{const d=l?.positionId!=null?String(l.positionId):null;return d&&o.set(d,(o.get(d)||0)+1),o},new Map),r=On.filter(o=>n?[o.labelAr,o.labelEn,o.name].filter(Boolean).map(d=>b(String(d)).toLowerCase()).join(" ").includes(n):!0);if(!r.length){e.innerHTML=`<div class="text-muted">${c("technicians.picker.noPositions","لا توجد مناصب مطابقة.")}</div>`;return}const i=Le();e.innerHTML=r.map(o=>{const l=zr(o,i)||o.name||"",d=Om(o,i),u=zc(o.clientPrice||0),m=zc(o.cost||0),p=d?`<span class="crew-position-card__subtitle">${b(d)}</span>`:"",f=c("technicians.picker.positionCostLabel","التكلفة"),h=c("technicians.picker.positionClientPriceLabel","سعر العميل"),g=c("technicians.picker.actions.addPosition","إضافة المنصب"),y=s.get(String(o.id))||0,E=c("technicians.picker.positionCountBadge","مضاف ×{count}").replace("{count}",b(String(y)));return`
      <article class="crew-position-card" data-position-id="${o.id}" tabindex="0" role="button" aria-label="${b(l)}">
        ${y>0?`<span class="crew-position-card__badge" aria-label="${E}">${b(String(y))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">🎯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${b(l)}</h6>
            ${p}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${f}</span>
            <span class="crew-position-card__metric-value">${m}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${h}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary crew-position-add-btn" data-position-id="${o.id}">
            ${g}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",l=>{l.stopPropagation(),yd(o.dataset.positionId)}),o.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(o=>{o.dataset.cardListenerAttached||(o.addEventListener("click",()=>{yd(o.dataset.positionId)}),o.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),yd(o.dataset.positionId))}),o.dataset.cardListenerAttached="true")})}function yd(e){si();const t=On.find(s=>String(s.id)===String(e)),n=Jf(t||{id:null,name:""}),a=ts(wt);a.push(n),Ea(wt,a),In(),I(c("technicians.picker.toast.positionAdded","✅ تم إضافة المنصب إلى القائمة"),"success")}function tb(e,t="create"){if(!e)return;const n=ts(t).filter(a=>a.assignmentId!==e);Ea(t,n),In(),I(c("technicians.picker.toast.positionRemoved","🗑️ تم حذف المنصب من القائمة"))}function Xo(e,t){if(!e)return;const n=ts(wt),a=n.find(d=>d.assignmentId===e);if(!a)return;if(!t){a.technicianId=null,a.technicianName=null,a.technicianRole=null,Ea(wt,n),In(),I(c("technicians.picker.toast.assignmentCleared","ℹ️ تمت إزالة التعيين من هذا المنصب"));return}if(n.find(d=>d.assignmentId!==e&&d.technicianId===t)){I(c("technicians.picker.duplicateTechnician","⚠️ لا يمكن تعيين نفس الشخص لأكثر من منصب في نفس الحجز")),In();return}const r=Pl(t),{start:i,end:o,ignoreReservationId:l}=Um(wt);if(i&&o&&Eo(String(t),i,o,l)){I(c("technicians.picker.optionConflict","⚠️ هذا العضو لديه تعارض في التاريخ/الوقت المحدد")),In();return}r?(a.technicianId=String(r.id),a.technicianName=r.name??null,a.technicianRole=r.role??null,a.technicianPhone=r.phone??null):(a.technicianId=String(t),a.technicianName=null,a.technicianRole=null,a.technicianPhone=null),Ea(wt,n),In(),a.technicianName?I(c("technicians.picker.toast.assignmentApplied","✅ تم تعيين {name} على هذا المنصب").replace("{name}",b(a.technicianName)),"success"):I(c("technicians.picker.toast.assignmentIdApplied","✅ تم تعيين العضو المحدد على هذا المنصب"),"success")}async function Zf(e="create"){wt=e,In(),Xi();let t=Ut();if(!Array.isArray(t)||t.length===0)try{const a=await ai();t=Array.isArray(a)?a:[]}catch(a){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",a)}Array.isArray(t)&&(Hr=t);try{await es()}catch(a){console.warn("[reservations/crew] failed to load positions",a)}si(),ru(),In(),Xi();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function sw(){return ts(wt).map(Ms)}function rw(){const e=sw(),{start:t,end:n,ignoreReservationId:a}=Um(wt);if(t&&n){const r=e.filter(i=>i.technicianId&&Eo(i.technicianId,t,n,a));if(r.length>0){const i=r.map(l=>l.technicianName||l.technicianId).join(c("reservations.list.crew.separator","، ")),o=c("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",i);r.forEach(l=>{l.technicianId=null,l.technicianName=null}),Ea(wt,e),In(),I(o),Xi();return}}Ea(wt,e);const s=document.getElementById("selectTechniciansModal");s&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s)?.hide?.(),I(c("technicians.picker.toast.selectionApplied","✅ تم حفظ الطاقم بنجاح"),"success")}function Or(e,t=[],n="create"){const a=document.getElementById(e);if(a){if(!t.length){a.innerHTML=`<span class="text-muted">${c("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.")}</span>`;return}si(),a.innerHTML=t.map(s=>{let r=s.positionLabel??s.position_label??s.position_name??s.role??s.position??"";if(!r||String(r).trim()===""){const m=s.positionId?On.find(f=>String(f.id)===String(s.positionId)):null,p=!m&&s.positionKey?On.find(f=>String(f.name).toLowerCase()===String(s.positionKey).toLowerCase()):null;r=m?zr(m,Le())||m?.name||"":p&&(zr(p,Le())||p?.name)||""}const i=b(r||c("reservations.crew.positionFallback","منصب بدون اسم")),o=s.technicianName?`${b(s.technicianName)}`:c("technicians.picker.noTechnicianOption","— بدون تعيين —");let l=Number(s.positionClientPrice);if(!Number.isFinite(l)||l<=0){const m=[s.position_client_price,s.client_price,s.customer_price,s.daily_total,s.dailyTotal,s.total];for(const p of m){const f=Number(p);if(Number.isFinite(f)&&f>0){l=f;break}}}if((!Number.isFinite(l)||l<=0)&&(s.positionId||s.positionKey)){const m=s.positionId?On.find(h=>String(h.id)===String(s.positionId)):null,p=!m&&s.positionKey?On.find(h=>String(h.name).toLowerCase()===String(s.positionKey).toLowerCase()):null,f=m||p||null;f&&Number.isFinite(Number(f.clientPrice))&&(l=Number(f.clientPrice))}const d=zc(Number.isFinite(l)&&l>0?l:0),u=c("reservations.crew.removeAria","إزالة");return`
      <span class="technician-chip" data-assignment-id="${s.assignmentId}">
        <span class="technician-chip-name">${i}</span>
        <small class="technician-chip-role">${o}</small>
        <small class="technician-chip-wage">💼 ${d}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${s.assignmentId}" aria-label="${u}">✖</button>
      </span>
    `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(s=>{s.dataset.listenerAttached||(s.addEventListener("click",()=>{tb(s.dataset.assignmentId,s.dataset.context)}),s.dataset.listenerAttached="true")})}}function iw(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",i=>{const o=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),d=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),m=document.getElementById("res-end-time")?.value?.trim(),p=!!(l&&d),f=!!(u&&m),h=!!o;if(!p||!f){i.preventDefault(),I(c("technicians.picker.requireDates","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية أولاً"),"warning");return}if(!h){i.preventDefault(),I(c("technicians.picker.requireCustomer","⚠️ يرجى اختيار العميل أولاً"),"warning");return}Zf("create")}),e.dataset.listenerAttached="true";const r=()=>{const i=document.getElementById("res-customer")?.value?.trim(),o=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),d=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),m=!!(i&&o&&l&&d&&u);e.setAttribute("aria-disabled",String(!m)),e.dataset.ready=m?"true":"false",e.classList.toggle("is-disabled",!m)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{["input","change"].forEach(o=>i.addEventListener(o,r))}),r()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>Zf("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{ru()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",rw),a.dataset.listenerAttached="true");const s=document.getElementById("selectTechniciansModal");s&&!s.dataset.listenerAttached&&window.bootstrap?.Modal&&(s.addEventListener("shown.bs.modal",async()=>{if(!Hr.length&&(!ae().technicians||ae().technicians.length===0))try{await ai()}catch(r){console.warn("[crew-picker] fetch on show failed",r)}ru(),In(),Xi()}),s.addEventListener("hidden.bs.modal",()=>{const r=document.getElementById("crew-position-search");r&&(r.value="")}),s.dataset.listenerAttached="true"),Or("selected-technicians-list",fa,"create"),Or("edit-selected-technicians-list",ha,"edit")}function ow({onDraftChange:e,onEditChange:t}={}){Jg=typeof e=="function"?e:()=>{},Zg=typeof t=="function"?t:()=>{},iw()}function Vm(){return fa.map(Ms)}function nb(){return ha.map(Ms)}function eh(){return fa.map(e=>e.technicianId).filter(Boolean).map(String)}function th(){return ha.map(e=>e.technicianId).filter(Boolean).map(String)}function cw(e=[]){Ea("edit",e)}function lw(){Ea("create",[])}function dw(){Ea("edit",[])}function nh(e=[]){return e.map(t=>{if(t.technicianId){const n=Pl(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function ab(e=[]){Array.isArray(e)&&e.length&&(Hr=e),fa=nh(fa),ha=nh(ha),Or("selected-technicians-list",fa,"create"),Or("edit-selected-technicians-list",ha,"edit"),In()}function ah(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),a=t.join("");return n?`${a}.${n}`:a}function sb(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=b(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),a=t.indexOf("-"),s=a!==-1&&(n===-1||a<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const r=t.includes(","),i=t.includes(".");if(r&&i){const l=t.lastIndexOf(","),d=t.lastIndexOf(".");l>d?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(r){const l=t.split(",");l.length===2&&l[1].length===3?t=l.join(""):t=t.replace(/,/g,".")}else if(i){const l=t.split(".");if(l.length===2){const[,d]=l;if(d.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(t=u)}}else l.length>2&&(t=ah(t))}if(t=t.replace(/,/g,""),t=ah(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const o=Number.parseFloat(t);return Number.isFinite(o)?s?-o:o:Number.NaN}function xe(e){return sb(e)}function Ee(e){const t=sb(e);if(!Number.isFinite(t))return 0;let n=t,a=0;for(;Math.abs(n)>1e5&&a<8;)n/=10,a+=1;return Number(n.toFixed(2))}function Ti(e){return b(String(e??"")).trim().toLowerCase()}function et(e=""){return b(String(e)).trim().toLowerCase()}const uw=2;function mw(e){const t=xe(e);return Number.isFinite(t)?t.toFixed(uw):"0.00"}function sh(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const a=Number.parseFloat(b(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(a)&&a>0)return Ee(a)}return 1}function wo(e={}){const t=e?.desc||e?.description||e?.name||"",n=et(t),a=mw(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${a}`}function Xs(e=[]){const t=new Map;return e.forEach((n,a)=>{const s=wo(n);if(!s)return;if(!t.has(s)){const i=n?.desc||n?.description||n?.name||"",o=et(i),l=ih(n),d=n?.image||n?.imageUrl||n?.img||"";t.set(s,{key:s,description:i,normalizedDescription:o,unitPrice:l,image:d,items:[],itemIndices:[],barcodes:[]})}const r=t.get(s);r.items.push(n),r.itemIndices.push(a),n?.barcode&&r.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((a,s)=>a+sh(s),0)})).map(n=>{const a=n.quantity||0,s=n.items.reduce((d,u)=>{const m=ih(u),p=sh(u);return d+m*p},0),r=Ee(s),i=xe(n.unitPrice),o=Number.isFinite(i)?i:0,l=a>0?Ee(r/a):Ee(o);return{...n,quantity:a,count:a,totalPrice:r,unitPrice:l}})}function rh(e={}){return(qn(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??Ti(n?.barcode),qty:(()=>{const a=Number.parseFloat(b(String(n?.qty??n?.quantity??1)));return Number.isFinite(a)&&a>0?a:1})(),price:(()=>{const a=xe(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(a)?a:0})()}))}function iu(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(b(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function pw(e={},t=[],n=null){const a=e.unit_price??e.unitPrice??e.price,s=xe(a);if(Number.isFinite(s)&&s>0)return Ee(s);const r=e.total_price??e.totalPrice??e.total,i=xe(r),o=Number.parseFloat(b(String(n)).replace(/[^0-9.]/g,"")),l=Number.isFinite(o)&&o>0?o:iu(e);if(Number.isFinite(i)&&i>0&&l>0)return Ee(i/l);if(Array.isArray(t)&&t.length){const d=t.reduce((u,m)=>{const p=xe(m.price??m.unit_price??m.unitPrice),f=Number.parseFloat(b(String(m.qty??m.quantity??1)).replace(/[^0-9.]/g,"")),h=Number.isFinite(f)&&f>0?f:1;return u+p*h},0);if(d>0&&l>0)return Ee(d/l)}return 0}function rb(e={}){const t=Array.isArray(e?.items)?e.items:[],n=Xs(t),a=new Map,s=(m,p=0,f="packages")=>{if(!m||typeof m!="object")return;const g=kt(m?.package_code??m?.packageId??m?.package_id??m?.code??m?.id??m?.barcode??`pkg-${p}`)||`pkg-${p}`;if(!a.has(g)){a.set(g,{source:m,normalizedId:g,index:p,itemSource:f==="items"?m:null});return}const y=a.get(g);if(y.source||(y.source=m),f==="items"&&(y.itemSource=m,y.source&&typeof y.source=="object")){const E=Array.isArray(y.source.packageItems)&&y.source.packageItems.length>0,S=Array.isArray(m.packageItems)&&m.packageItems.length>0;!E&&S&&(y.source={...y.source,packageItems:m.packageItems}),!y.source.image&&m.image&&(y.source={...y.source,image:m.image})}};Array.isArray(e?.packages)&&e.packages.forEach((m,p)=>s(m,p,"packages")),t.forEach((m,p)=>{m&&typeof m=="object"&&(m.type==="package"||Array.isArray(m?.packageItems))&&s(m,p+a.size,"items")});const r=[],i=new Set,o=new Set;a.forEach(({source:m,itemSource:p=null,normalizedId:f},h)=>{const g=m||{},y=p&&typeof p=="object"?p:null;let E=rh(g);(!Array.isArray(E)||E.length===0)&&y&&(E=rh(y)),E.forEach(L=>{const B=L?.normalizedBarcode??Ti(L?.barcode);B&&i.add(B);const D=L?.equipmentId??L?.equipment_id??null;D!=null&&o.add(String(D))});let S=iu(g);if(y){const L=iu(y);Number.isFinite(L)&&L>0&&(S=L)}(!Number.isFinite(S)||S<=0)&&(S=1);let x=pw(g,E,S);const A=[y?.price,y?.unit_price,y?.unitPrice];for(const L of A){const B=xe(L);if(Number.isFinite(B)&&B>0){x=Ee(B);break}}x=Ee(x);const C=[y?.total,y?.total_price,y?.totalPrice,g?.total,g?.total_price,g?.totalPrice];let j=NaN;for(const L of C){const B=xe(L);if(Number.isFinite(B)&&B>=0){j=B;break}}Number.isFinite(j)||(j=x*S),j=Ee(j);const w=[g?.displayCode,g?.display_code,g?.package_code,g?.packageCode,g?.code,g?.barcode,g?.packageId,g?.package_id,y?.displayCode,y?.display_code,y?.package_code,y?.packageCode,y?.code,y?.barcode,y?.packageId,y?.package_id,f,h].find(L=>L==null?!1:String(L).trim().length>0),_=w!=null?b(String(w)).trim():"";if(_){const L=Ti(_);L&&i.add(L)}const $=E.map(L=>b(String(L?.barcode??L?.normalizedBarcode??""))).filter(Boolean),F=[g?.name,g?.package_name,g?.title,y?.name,y?.desc,y?.package_name,_,b(String(h))].find(L=>L!=null&&String(L).trim()!=="")||b(String(_||h)),U=E.find(L=>L?.image)?.image??g?.image??y?.image??null;r.push({key:`package::${h}`,description:F,normalizedDescription:b(String(F)),unitPrice:x,totalPrice:j,quantity:S,count:S,image:U,barcodes:$,barcode:_,package_code:_,packageDisplayCode:_,items:[{type:"package",packageItems:E,packageId:f,desc:F,price:x,qty:S,barcode:_}],type:"package",packageItems:E,packageId:f})});const l=new Set(Array.from(i).map(m=>Ti(m)).filter(Boolean)),d=n.filter(m=>!(m.items.some(h=>h?.type==="package")&&r.length>0||m.items.every(h=>{const g=ns(h),y=g!=null?String(g):null;if(y&&o.has(y))return!0;const E=h?.barcode?Ti(h.barcode):null;return!!(E&&l.has(E))})));return{groups:r.length?[...r,...d]:n,packageGroups:r,groupedItems:n,filteredGroupedItems:d,packagesMap:a}}function ns(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function ih(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const a=xe(n);if(Number.isFinite(a))return a}return 0}function jo(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function fw(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function Vt(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,s=a!=null&&a!==""&&a!=="null",r=s?fw(t?.status??t?.status_label??t?.statusLabel??""):null,i=s&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(r));return{reservationConfirmed:n,projectLinked:s,projectStatus:r,projectConfirmed:i,effectiveConfirmed:s?i:n}}const Fe=10;function ib(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=xe(n);if(Number.isFinite(a))return Ee(a)}return 0}function hw(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=xe(n);if(Number.isFinite(a))return Ee(a)}return ib(e)}function yw(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=ae();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,s)=>{const r=n.get(String(s));if(!r)return a;const i=ib(r),o=hw(r);return{costPerDay:a.costPerDay+(Number.isFinite(i)?i:0),totalPerDay:a.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const gw=1440*60*1e3,vr=.01;function mr(e){if(e==null||e==="")return null;const t=b(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function oh(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let s=Number.isFinite(e)?e:0;if(s<t&&(s=t),s>n&&(s=n),a!=null){const r=10**a;s=Math.round(s*r)/r}return s}function ob(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function en({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:s=null,history:r=[]}={}){const i=Number.isFinite(Number(e))?Number(e):0,o=t==="amount"?"amount":t==="percent"?"percent":null;let l=mr(a),d=mr(s);const u=mr(n);let m=0,p=0;Array.isArray(r)&&r.length&&r.forEach(S=>{if(!S)return;const x=S.type==="amount"||S.type==="percent"?S.type:null,A=mr(S.value),C=mr(S.amount),j=mr(S.percentage);if(x==="amount"){const k=C??A;k!=null&&(m+=k,i>0&&(p+=k/i*100))}else if(x==="percent"){const k=j??A;k!=null&&(p+=k,i>0&&(m+=k/100*i))}else C!=null&&(m+=C,i>0&&(p+=C/i*100)),j!=null&&(p+=j,i>0&&(m+=j/100*i))});function f(S=[]){return!Array.isArray(S)||S.length===0?{costPerDay:0,totalPerDay:0}:S.reduce((x,A)=>{const C=xe(A?.positionCost??A?.position_cost??A?.cost??A?.dailyWage??A?.daily_wage??0),j=xe(A?.positionClientPrice??A?.position_client_price??A?.clientPrice??A?.dailyTotal??A?.daily_total??A?.total??0),k=Number.isFinite(C)?C:0,w=Number.isFinite(j)?j:0;return{costPerDay:x.costPerDay+k,totalPerDay:x.totalPerDay+w}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=f),o==="amount"&&u!=null?l=u:o==="percent"&&u!=null?d=u:o===null&&u!=null&&(d!=null?d=u:l=u),(l==null||l<=0)&&d!=null&&d>0&&i>0&&(l=i*(d/100)),(d==null||d<=0)&&l!=null&&l>0&&i>0&&(d=l/i*100);const h=l??0,g=d??0;l=h+m,d=g+p,l=oh(l??0,{min:0,max:i>0?i:Number.POSITIVE_INFINITY,precision:2}),d=oh(d??0,{min:0,max:100,precision:2});let y=o;return y||(l>0&&i>0?y="amount":d>0&&(y="percent")),{paidAmount:l,paidPercent:d,paymentProgressType:y,paymentProgressValue:y==="amount"?l:y==="percent"?d:null}}function fn({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const s=ob(e),r=Number.isFinite(Number(a))?Number(a):0,i=Number.isFinite(Number(t))?Number(t):0,o=Number.isFinite(Number(n))?Number(n):0;if(s==="paid")return"paid";const l=r>0&&i>=r-vr,d=o>=100-vr*100;if(l||d)return"paid";const u=i>vr||o>vr;return s==="partial"||u?"partial":"unpaid"}function ri(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const s=a.getTime()-n.getTime();if(s<=0)return 1;const r=s/gw;return Math.max(1,Math.ceil(r))}function xa({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:a=0,discountType:s="percent",applyTax:r=!1,start:i=null,end:o=null,companySharePercent:l=null}={}){const d=ri(i,o),u=(e||[]).reduce((L,B)=>{const D=xe(B?.qty??B?.quantity??B?.count??1),K=Number.isFinite(D)&&D>0?D:1,Z=xe(B?.price??B?.unit_price??B?.unitPrice),R=Number.isFinite(Z)?Z:0;return L+K*R},0),m=Ee(u*d),p=Array.isArray(n)?n:[],f=p.length?p.map(L=>L?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:h,totalPerDay:g}=p.length?p.reduce((L,B)=>{const D=xe(B?.positionCost??B?.position_cost??B?.cost??B?.dailyWage??B?.daily_wage??0),K=xe(B?.positionClientPrice??B?.position_client_price??B?.clientPrice??B?.dailyTotal??B?.daily_total??B?.total??0),Z=Number.isFinite(D)?D:0,R=Number.isFinite(K)?K:0;return{costPerDay:L.costPerDay+Z,totalPerDay:L.totalPerDay+R}},{costPerDay:0,totalPerDay:0}):yw(f),y=Ee(g*d),E=Ee(h*d),S=Ee(m+y),x=Number(a)||0;let A=s==="amount"?x:S*(x/100);(!Number.isFinite(A)||A<0)&&(A=0),A>S&&(A=S);const C=Math.max(0,S-A);let j=Number.isFinite(l)?Number(l):null;r&&(!Number.isFinite(j)||j<=0)&&(j=Fe);const k=j&&j>0?j:0,w=k>0?Math.max(0,C*(k/100)):0,_=C+w;let $=r?_*.15:0;(!Number.isFinite($)||$<0)&&($=0),$=Number($.toFixed(2));const q=_+$,F=Math.max(0,Number(q.toFixed(2))),U=Math.max(0,Math.max(0,m+y-A)-E);return{rentalDays:d,equipmentTotal:m,crewTotal:y,crewCostTotal:E,discountAmount:A,subtotalAfterDiscount:C,taxableAmount:_,taxAmount:$,finalTotal:F,companySharePercent:k,companyShareAmount:w,netProfit:U}}function Js(e=[],t=0,n="percent",a=!1,s=[],{start:r=null,end:i=null,companySharePercent:o=null}={}){const l=p=>p&&typeof p=="object"&&(p.positionId!==void 0||p.position_id!==void 0||p.positionLabel!==void 0||p.position_name!==void 0||p.positionClientPrice!==void 0),d=Array.isArray(s)&&s.some(l)?s:[],u=d.length?d.map(p=>p?.technicianId).filter(Boolean):Array.isArray(s)?s:[];return xa({items:e,technicianIds:u,crewAssignments:d,discount:t,discountType:n,applyTax:a,start:r,end:i,companySharePercent:o}).finalTotal}function cb({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:s,paymentStatus:r,paidAmount:i=0,paidPercent:o=0,companySharePercent:l=null,companyShareAmount:d=null,taxAmount:u=null,netProfit:m=null,totalKey:p="reservations.summary.total",equipmentTotal:f=null,crewTotal:h=null}){const g=c("reservations.create.summary.currency","SR"),y=b(String(e)),E=b(String(t)),S=b(String(n??1)),x=b(String(a)),A=ob(r),C=A==="paid"?"مدفوع":A==="partial"?"مدفوع جزئياً":"غير مدفوع",j=c(`reservations.create.paymentStatus.${A}`,C),k=Number.isFinite(Number(i))?Math.max(0,Number(i)):0,w=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,_=k>vr||w>vr,$=c("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),q=b(k.toFixed(2)),F=b(w.toFixed(w%1?2:0)),U=c("reservations.summary.itemsLabel","📦 عدد المعدات"),L=c("reservations.summary.durationLabel","⏱️ عدد الأيام"),B=c("reservations.summary.crewLabel","😎 عدد الفريق"),D=c("reservations.details.labels.itemsTotal","💼 إجمالي المعدات"),K=c("reservations.details.labels.crewTotal","😎 إجمالي الفريق"),Z=c("reservations.summary.taxLabelShort","🧾 الضريبة"),R=c("reservations.summary.paymentLabelShort","💳 حالة الدفع"),M=c(p.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),H=c("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),V=c("reservations.details.labels.netProfit","💵 صافي الربح"),G=Number.isFinite(m)?Math.max(0,Number(m)):null,ie=[{label:U,value:E},{label:L,value:S},{label:B,value:x}],ee=Number.isFinite(Number(f))?Math.max(0,Number(f)):null;ee!=null&&ie.push({label:D,value:`${b(ee.toFixed(2))} ${g}`});const oe=Number.isFinite(Number(h))?Math.max(0,Number(h)):null;if(oe!=null&&ie.push({label:K,value:`${b(oe.toFixed(2))} ${g}`}),s){let he=c("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(u)&&u>0&&(he=`${b(Number(u).toFixed(2))} ${g}`),ie.push({label:Z,value:he})}const W=Number.isFinite(l)?Number(l):null;if(W!==null&&W>0){const he=Number.isFinite(d)?Number(d):e*(W/100),Se=b(String(W)),we=b(Number.isFinite(he)?he.toFixed(2):"0"),J=`${Se}% (${we} ${g})`;ie.push({label:H,value:J})}if(G!==null&&Math.abs(G-Number(e))>.009){const he=b(G.toFixed(2));ie.push({label:V,value:`${he} ${g}`})}ie.push({label:R,value:j}),_&&ie.push({label:$,value:`${q} ${g} (${F}%)`});const be=`${y} ${g}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${ie.map(({label:he,value:Se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${he}</span>
            ${Se?`<span class="reservation-summary-value">${Se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${M}</span>
          <span class="reservation-summary-value">${be}</span>
        </div>
      </div>
    </div>
  `}function ou({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:s,paymentProgressType:r=null,paymentProgressValue:i=null,start:o,end:l,companySharePercent:d=null,paymentHistory:u=[]}){const m=Vm(),p=typeof eh=="function"?eh()??[]:[],f=Array.isArray(p)?p.map(String):[],h=m.length?m.map(j=>j?.technicianId).filter(Boolean).map(String):f,g=m.length||h.length,y=Number.isFinite(d)?Number(d):null,E=xa({items:e,technicianIds:h,crewAssignments:m,discount:t,discountType:n,applyTax:a,start:o,end:l,companySharePercent:y}),S=en({totalAmount:E.finalTotal,progressType:r,progressValue:i,history:u}),x=fn({manualStatus:s,paidAmount:S.paidAmount,paidPercent:S.paidPercent,totalAmount:E.finalTotal}),A=cb({total:E.finalTotal,itemsCount:e.length,rentalDays:E.rentalDays,techniciansCount:g,applyTax:a,paymentStatus:x,paidAmount:S.paidAmount,paidPercent:S.paidPercent,companySharePercent:E.companySharePercent,companyShareAmount:E.companyShareAmount,taxAmount:E.taxAmount,netProfit:E.netProfit,equipmentTotal:E.equipmentTotal,crewTotal:E.crewTotal}),C={paymentStatus:x,paidAmount:S.paidAmount,paidPercent:S.paidPercent,paymentProgressType:S.paymentProgressType,paymentProgressValue:S.paymentProgressValue,total:E.finalTotal};return ou.lastResult=C,bw(A),A}function Oc({items:e,discount:t,discountType:n,applyTax:a,paidStatus:s,paymentProgressType:r=null,paymentProgressValue:i=null,start:o,end:l,companySharePercent:d=null,paymentHistory:u=[]}){const m=nb(),p=typeof th=="function"?th()??[]:[],f=Array.isArray(p)?p.map(String):[],h=m.length?m.map(j=>j?.technicianId).filter(Boolean).map(String):f,g=m.length||h.length,y=Number.isFinite(d)?Number(d):null,E=xa({items:e,technicianIds:h,crewAssignments:m,discount:t,discountType:n,applyTax:a,start:o,end:l,companySharePercent:y}),S=en({totalAmount:E.finalTotal,progressType:r,progressValue:i,history:u}),x=fn({manualStatus:s,paidAmount:S.paidAmount,paidPercent:S.paidPercent,totalAmount:E.finalTotal}),A=cb({total:E.finalTotal,itemsCount:e.length,rentalDays:E.rentalDays,techniciansCount:g,applyTax:a,paymentStatus:x,paidAmount:S.paidAmount,paidPercent:S.paidPercent,companySharePercent:E.companySharePercent,companyShareAmount:E.companyShareAmount,taxAmount:E.taxAmount,netProfit:E.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:E.equipmentTotal,crewTotal:E.crewTotal}),C={html:A,paymentStatus:x,paidAmount:S.paidAmount,paidPercent:S.paidPercent,paymentProgressType:S.paymentProgressType,paymentProgressValue:S.paymentProgressValue,total:E.finalTotal};return Oc.lastResult=C,A}function bw(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,ch(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,ch(n,e))}function ch(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const vw=ae()||{};let Mn=(vw.reservations||[]).map(Wm);function ys(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const lb="__reservation_packages_cache__";function db(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function ub(){const e=db();if(!e)return{};try{const t=e.getItem(lb);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function lh(e){const t=db();if(t)try{t.setItem(lb,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function Sw(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const a=(t.positionLabel??"").trim().length>0,s=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",r=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,i=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return a||s||r||i})}function mb(e){return[]}function pb(e=[]){return Array.isArray(e)?e.map((t,n)=>Eb(t,n)).filter(Boolean).map((t,n)=>{const a=kt(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),s=Uc(t,a).map(d=>{const u=qt(d.qty??d.quantity??d.count??d.units??d.unit_qty??d.unitQty??d.unit_count??d.unitCount??d.package_quantity??d.packageQty??1),m=ys(Ue(d.price??d.unit_price??0));return{...d,qty:u,quantity:u,price:m,unit_price:m}}),r=qt(t.quantity??t.qty??1);let i=ys(Ue(t.unit_price??t.unitPrice??t.price??0));if(!i||i<=0){const d=s.reduce((u,m)=>u+(m.price||0)*(m.qty||1),0);d>0&&r>0&&(i=ys(Number((d/r).toFixed(2))))}const o=Ue(t.total_price??t.totalPrice??t.total??i*r),l=o>0?ys(o):ys(Number((i*r).toFixed(2)));return{...t,packageId:a,package_id:a,qty:r,quantity:r,unit_price:i,unitPrice:i,price:i,total_price:l,total:l,packageItems:s}}):[]}function Io(e,t){if(!e)return;const n=ub(),a=String(e);if(!Array.isArray(t)||t.length===0){n[a]&&(delete n[a],lh(n));return}n[a]=pb(t),lh(n)}function Aw(e){if(!e)return[];const t=ub(),n=String(e),a=t[n];return Array.isArray(a)?pb(a):[]}function Km(e,t=0){if(e==null)return null;if(typeof e!="object"){const x=e!=null?String(e):null;return{assignmentId:`crew-${t}-${x??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:x,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,a=e&&typeof e.position=="object"?e.position:null,s=e.position_id??e.positionId??e.position??e.position_code??a?.id??a?.code??null,r=e.position_key??e.positionKey??e.position_code??e.positionId??a?.name??a?.key??null;let i=e.position_name??e.positionName??e.position_label??e.position_title??a?.label_ar??a?.label_en??a?.name??e.role??e.position??"";i||(i=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const o=e.position_label_ar??null,l=e.position_label_en??null,d=e.position_label_alt??l??o??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??a?.cost??a?.daily_wage??a?.dailyWage??e.internal_cost??null,m=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??a?.client_price??a?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,p=ys(xe(u)),f=ys(xe(m)),h=e&&typeof e.technician=="object"?e.technician:null,g=e.technician_id??e.technicianId??e.id??h?.id??e.userId??e.user_id??null,y=e.technician_name??e.technicianName??e.name??h?.name??e.full_name??null,E=e.role??h?.role??e.specialization??null,S=e.technician_phone??h?.phone??e.phone??null;return{assignmentId:String(n),positionId:s!=null?String(s):null,positionKey:r!=null?String(r):null,positionLabel:i!=null?String(i):"",positionLabelAlt:d!=null?String(d):"",positionLabelAr:o!=null?String(o):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(p)?p:0,positionClientPrice:Number.isFinite(f)?f:0,technicianId:g!=null?String(g):null,technicianName:y!=null?String(y):null,technicianRole:E!=null?String(E):null,technicianPhone:S!=null?String(S):null,notes:e.notes??null}}function We(){return Mn}function xo(e){Mn=Array.isArray(e)?e.map(Hs):[],Mn.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Io(n,t.packages);const a=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];Sw(a)}),Mn.length?console.debug("[reservationsService] setReservationsState first paymentHistory",Mn[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),an({reservations:Mn});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return Mn}async function Zs(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),s=(await pe(`/reservations/${n?`?${n}`:""}`))?.data;let r=[];Array.isArray(s)?r=s:s&&typeof s=="object"&&(Array.isArray(s.items)?r=s.items:Array.isArray(s.results)?r=s.results:Array.isArray(s.data)?r=s.data:Array.isArray(s.records)&&(r=s.records));const i=r.map(ii);return xo(i)}async function fb(e){const t=await pe("/reservations/",{method:"POST",body:e}),n=ii(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=Gm(e.payment_history);a.length&&(n.paymentHistory=a)}if((!Array.isArray(n.crewAssignments)||n.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const a=e.technicians.map((s,r)=>Km(s,r)).filter(Boolean);a.length&&(n.crewAssignments=a,n.techniciansDetails=a.map((s,r)=>{const i=e.technicians[r];return typeof i=="object"?{...i,...s}:s}))}if(Array.isArray(e?.packages)&&e.packages.length){const a=Jm({packages:e.packages});n.packages=zs(n.packages,a)}{const a=Xm(n.items||[],n.packages||[]);n.items=a.items,n.packages=zs(n.packages||[],a.packages)}if(Io(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=xa({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,xo([...Mn,n]),n}async function er(e,t){const n=await pe(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=ii(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const r=Gm(t.payment_history);r.length&&(a.paymentHistory=r,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if((!Array.isArray(a.crewAssignments)||a.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const r=t.technicians.map((i,o)=>Km(i,o)).filter(Boolean);r.length&&(a.crewAssignments=r,a.techniciansDetails=r.map((i,o)=>{const l=t.technicians[o];return typeof l=="object"?{...l,...i}:i}))}if(Array.isArray(t?.packages)&&t.packages.length){const r=Jm({packages:t.packages});a.packages=zs(a.packages,r)}{const r=Xm(a.items||[],a.packages||[]);a.items=r.items,a.packages=zs(a.packages||[],r.packages)}if(Io(a.id??a.reservationId??a.reservation_code??e,a.packages),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const r=xa({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=r.companyShareAmount,a.cost=r.finalTotal,a.totalAmount=r.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const s=Mn.map(r=>String(r.id)===String(e)?a:r);return xo(s),a}async function hb(e){await pe(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=Mn.filter(n=>String(n.id)!==String(e));xo(t),Io(e,null)}async function yb(e){return er(e,{status:"confirmed",confirmed:!0})}function ii(e={}){return Hs({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function Wm(e={}){return Hs(e)}function Hs(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let a=Array.isArray(e.items)?e.items.map(gb):[],s=Jm(e);const r=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let i=r.map((K,Z)=>Km(K,Z)).filter(Boolean),o=i.map((K,Z)=>{const R=r?.[Z];return{...R&&typeof R=="object"?{...R}:R!=null?{id:R}:{},...K}});const l=i.map(K=>K.technicianId).filter(K=>K!=null&&K!=="").map(K=>Number.isNaN(Number(K))?String(K):Number(K)),d=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let m=Ue(e.total_amount??e.totalAmount??e.cost??0);const p=Ue(e.discount??0),f=e.discount_type??e.discountType??"percent",h=["percent","amount"].includes(f)?f:"percent",g=!!(e.apply_tax??e.applyTax??!1);let y=_w(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const E=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),S=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,x=S!=null?Number.parseFloat(b(String(S).replace("%","").trim())):NaN,A=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let C=A!=null?A===!0||A===1||A==="1"||String(A).toLowerCase()==="true":Number.isFinite(x)&&x>0,j=C&&Number.isFinite(x)?Number(x):0;const k=e.company_share_amount??e.companyShareAmount;let w=Number.isFinite(Number(k))?Number(k):NaN;g&&j<=0&&(j=Fe,C=!0);const _=xa({items:a,technicianIds:l,crewAssignments:i,discount:p,discountType:h,applyTax:g,start:d,end:u,companySharePercent:j>0?j:null});(!Number.isFinite(m)||m<=0||g)&&(m=_.finalTotal),(!Number.isFinite(w)||w<0)&&(w=_.companyShareAmount),w=Number.isFinite(w)?Number(w.toFixed(2)):0,!C&&j>0&&(C=!0);const $=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],q=Ew($),F=Gm(q),U=t??n??e.reservation_code??e.reservationId??null;if(s.length)Io(U,s);else{const K=Aw(U);K.length&&(s=zs(s,K))}const L=Xm(a,s);a=L.items,s=zs(s,L.packages);const B=en({totalAmount:m,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:F});y=fn({manualStatus:y,paidAmount:B.paidAmount,paidPercent:B.paidPercent,totalAmount:m});const D=y==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:d,end:u,status:kw(e.status??(E?"confirmed":"pending")),confirmed:E,location:e.location??"",notes:e.notes??"",discount:p,discountType:h,applyTax:g,paid:D,paidStatus:y,paidAmount:B.paidAmount,paidPercent:B.paidPercent,paymentProgressType:B.paymentProgressType,paymentProgressValue:B.paymentProgressValue,paymentHistory:F,payment_history:F,totalAmount:m,cost:m,projectId:e.project_id??e.projectId??null,items:a,technicians:l,crewAssignments:i,techniciansDetails:o,startDatetime:d,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:s,companySharePercent:j,companyShareAmount:w,companyShareEnabled:C}}function gb(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=qt(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=Ue(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),s=b(String(e.barcode??e.code??e.serial??"")),r=e.description??e.desc??e.name??e.title??"",i={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:s,desc:r,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:a,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},o=bb(e.type??e.item_type??e.kind??null),l=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,d=Wn(l),u=Uc(e,d);if(o==="package"||d||u.length){i.type="package";const m=d||(t!=null?String(t):i.id?Wn(i.id):"");m&&(i.packageId=m,i.package_id=m,i.package_code=e.package_code??e.packageCode??m),i.name=r||i.package_code||m||"",i.barcode=i.barcode||b(String(e.package_code??e.packageCode??"")),i.packageItems=u;const p=Sb({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},u,n);(!Number.isFinite(i.price)||i.price<=0||i.price>p*10)&&(i.price=p),i.qtyPerPackage=u.length?u[0]?.qtyPerPackage??i.qtyPerPackage:i.qtyPerPackage,i.totalQuantity=n}return i}function Qm({reservationCode:e,customerId:t,start:n,end:a,status:s,title:r,location:i,notes:o,projectId:l,totalAmount:d,discount:u,discountType:m,applyTax:p,paidStatus:f,confirmed:h,items:g,packages:y,crewAssignments:E=[],technicians:S=E,companySharePercent:x,companyShareEnabled:A,paidAmount:C,paidPercentage:j,paymentProgressType:k,paymentProgressValue:w,paymentHistory:_}){const $=Array.isArray(E)?E:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:s??"pending",title:r??null,location:i??null,notes:o??null,project_id:l||null,total_amount:d??0,discount:u??0,discount_type:m??"percent",apply_tax:p?1:0,paid_status:f??"unpaid",paid_amount:Number.isFinite(C)?Ue(C):0,paid_percentage:Number.isFinite(j)?Number(j.toFixed(2)):0,payment_progress_type:k??null,payment_progress_value:Number.isFinite(w)?Number(w.toFixed(2)):null,payment_history:Array.isArray(_)?_.map(q=>({type:cu(q?.type??q?.payment_type??q?.method??q?.paymentMethod),value:q?.value!=null?Ue(q.value):null,amount:q?.amount!=null?Ue(q.amount):q?.payment_amount!=null?Ue(q.payment_amount):null,percentage:q?.percentage!=null?Number(q.percentage):q?.payment_percentage!=null?Number(q.payment_percentage):null,note:q?.note??q?.notes??q?.comment??q?.payment_note??null,recorded_at:q?.recordedAt??q?.recorded_at??q?.createdAt??q?.created_at??q?.payment_date??q?.date??new Date().toISOString()})):[],payments:Array.isArray(_)?_.map(q=>({type:cu(q?.type??q?.payment_type??q?.method??q?.paymentMethod),value:q?.value!=null?Ue(q.value):null,amount:q?.amount!=null?Ue(q.amount):q?.payment_amount!=null?Ue(q.payment_amount):null,percentage:q?.percentage!=null?Number(q.percentage):q?.payment_percentage!=null?Number(q.payment_percentage):null,note:q?.note??q?.notes??q?.comment??q?.payment_note??null,recorded_at:q?.recordedAt??q?.recorded_at??q?.createdAt??q?.created_at??q?.payment_date??q?.date??new Date().toISOString()})):[],confirmed:h===void 0?null:!!h,items:ww(g),packages:jw(g,y),company_share_percent:A&&Number.isFinite(x)?Number(x):null,company_share_enabled:A?1:0,technicians:$.length?$.map((q,F)=>{const U=q.technicianId??q.technician_id??q.id??null,L=q.positionId??q.position_id??q.position??q.position_code??null,B=q.positionLabel??q.position_name??q.role??null,D=Ue(q.positionCost??q.position_cost??q.cost??q.daily_wage??q.dailyWage??0),K=Ue(q.positionClientPrice??q.position_client_price??q.client_price??q.clientPrice??q.daily_total??q.dailyTotal??q.total??0);return{id:U,technician_id:U,role:B??q.technicianRole??null,notes:q.notes??null,position_id:L,position_key:q.positionKey??q.position_key??null,position_name:B,position_label_ar:q.positionLabelAr??q.position_label_ar??null,position_label_en:q.positionLabelEn??q.position_label_en??null,position_cost:D,position_client_price:K,client_price:K,cost:D,assignment_id:q.assignmentId??q.assignment_id??`crew-${F}`}}):Array.isArray(S)?S.map(q=>typeof q=="object"&&q!==null?{id:q.id??q.technician_id??q.technicianId??q.ID,role:q.role??null,notes:q.notes??null}:Number.isNaN(Number(q))?String(q):Number(q)):[]}}function Gm(e){const t=Ym(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const a=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,s=cu(a),r=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,i=r!=null?Number.parseFloat(b(String(r))):null,o=n.amount!=null?Number.parseFloat(b(String(n.amount))):n.payment_amount!=null?Number.parseFloat(b(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(b(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(b(String(n.payment_percentage))):null,d=Number.isFinite(o)?o:s==="amount"&&Number.isFinite(i)?i:null,u=Number.isFinite(l)?l:s==="percent"&&Number.isFinite(i)?i:null,m=s??(d!=null?"amount":u!=null?"percent":null),p=m==="amount"?d:m==="percent"?u:Number.isFinite(i)?i:null,f=n.note??n.notes??n.comment??n.payment_note??null,h=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:m,value:p,amount:d,percentage:u,note:f,recordedAt:h}}).filter(n=>n&&n.type)}function cu(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Ym(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const i of t)if(Array.isArray(e[i]))return e[i];const a=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(i=>Array.isArray(i));if(Array.isArray(a))return a;const s=Object.values(e);if(s.length&&s.every(i=>i&&typeof i=="object")){const i=s.map(o=>o);if(i.every(o=>!Array.isArray(o)))return i}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(i=>i in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Ym(t)}catch{return[]}return[]}function Ew(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Ym(t);if(Array.isArray(n)&&n.length)return n}return[]}function ww(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const s=qt(n.qty??n.quantity??1);n.packageItems.forEach(r=>{const i=r?.equipmentId??r?.equipment_id??r?.id??null;if(i==null)return;const o=qt(r?.qty??r?.quantity??1),l=s*o;t.push({equipment_id:lu(i),quantity:l,unit_price:Ue(r?.price??r?.unit_price??0),notes:r?.notes??null})});return}const a=n.equipmentId??n.equipment_id??n.id??null;a!=null&&t.push({equipment_id:lu(a),quantity:qt(n.qty??n.quantity??1),unit_price:Ue(n.price??n.unit_price??0),notes:n.notes??null})}),t}function lu(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function jw(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(a=>{if(!a||typeof a!="object"||a.type!=="package")return;const s=qt(a.qty??a.quantity??1),r=Array.isArray(a.packageItems)?a.packageItems.map(i=>{const o=i?.equipmentId??i?.equipment_id??i?.id??null;return o==null?null:{equipment_id:lu(o),quantity:qt(i?.qty??i?.quantity??i?.count??i?.units??i?.unit_qty??i?.unitQty??i?.unit_count??i?.unitCount??i?.package_quantity??i?.packageQty??1),unit_price:Ue(i?.price??i?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:a.packageId??a.package_id??a.barcode??null,name:a.desc??a.name??"",quantity:s,unit_price:Ue(a.price??a.unit_price??0),items:r})}),n}function bb(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function Wn(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return kt(t)}function du(e){return e==null?"":b(String(e)).trim().toLowerCase()}function vb(e={},t=1){if(!e||typeof e!="object"){const l=b(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:l,normalizedBarcode:du(l),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,a=qt(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=Ue(e.unit_price??e.unitPrice??e.price??0),r=b(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),i=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let o;if(i!=null)o=qt(i,{fallback:1,max:99});else if(t>0){const l=a/t;Number.isFinite(l)&&l>0&&Number.isInteger(l)?o=qt(l,{fallback:1,max:99}):o=Math.min(a,99)}else o=Math.min(a,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:o,quantity:o,qtyPerPackage:o,totalQuantity:a,price:s,unit_price:s,barcode:r,normalizedBarcode:du(e.normalizedBarcode??r),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function Iw(e={},t={}){const n=Wn(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),a=qt(e.quantity??e.qty??t.qty??t.quantity??1,{fallback:1,max:9999}),s=Ue(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),r=b(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:r,desc:t.desc??t.description??e.name??e.desc??e.title??r,qty:a,quantity:a,price:s,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:r,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function Xm(e=[],t=[]){const n=xw(e),a=Array.isArray(t)?zs(t,n.packages):n.packages,s=new Map;return a.forEach(r=>{const i=Wn(r.packageId??r.package_id??r.id);i&&s.set(i,r)}),n.packages.forEach(r=>{const i=Wn(r.packageId??r.package_id??r.id);if(!i)return;const o=s.get(i);o&&((!Array.isArray(o.packageItems)||o.packageItems.length===0)&&(o.packageItems=r.packageItems),!o.name&&r.name&&(o.name=r.name),!o.image&&r.image&&(o.image=r.image))}),{items:n.items,packages:Array.from(s.values())}}function xw(e=[]){const t=new Map;if(e.forEach(r=>{const i=Wn(r.packageId??r.package_id??r.packageCode??r.package_code??r.bundleId??r.bundle_id??null);if(!i)return;const o=i;t.has(o)||t.set(o,{base:r,items:[]}),t.get(o).items.push(r)}),!t.size)return{items:e,packages:[]};const n=[],a=[],s=new Set;return e.forEach(r=>{const i=Wn(r.packageId??r.package_id??r.packageCode??r.package_code??r.bundleId??r.bundle_id??null);if(i&&t.has(i)){if(s.has(i))return;const o=t.get(i),l=o.base||r,d=o.items.map(m=>vb(m,1)),u={packageId:i,package_id:i,package_code:l.package_code??l.packageCode??l.barcode??b(String(i)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${i}`,quantity:qt(l.package_quantity??l.packageQty??l.qty??1,{fallback:1,max:9999}),unit_price:Ue(l.package_price??l.packagePrice??l.price??0),packageItems:d,image:l.image??null};a.push(u),n.push(Iw(u,l)),s.add(i);return}n.push(r)}),{items:n,packages:a}}function Uc(e={},t=""){if(!e||typeof e!="object")return[];const n=Wn(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),a=[];Array.isArray(e.packageItems)&&a.push(...e.packageItems),Array.isArray(e.package_items)&&a.push(...e.package_items),Array.isArray(e.items)&&a.push(...e.items),Array.isArray(e.equipment)&&a.push(...e.equipment),Array.isArray(e.contents)&&a.push(...e.contents);let s=qn({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:a,packageItems:a}),r=[];if((!Array.isArray(s)||s.length===0)&&n){const d=Gi(n);d&&(s=qn(d),r=Array.isArray(s)?s:[])}else if(n){const d=Gi(n);d&&(r=qn(d)||[])}if(!Array.isArray(s)||s.length===0)return[];const i=qt(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),o=s.map(d=>vb(d,i));if(r.length){const d=new Map;r.forEach(u=>{if(!u)return;const m=du(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);m&&d.set(m,u)}),o.forEach(u=>{const m=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!m||!d.has(m))return;const p=d.get(m),f=qt(p.quantity??p.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=f,u.qty=f,u.quantity=f;const h=Ue(p.unit_price??p.unitPrice??p.price??u.price);u.price=h,u.unit_price=h,!u.desc&&p.desc&&(u.desc=p.desc),!u.image&&p.image&&(u.image=p.image)})}const l=new Map;return o.forEach(d=>{const u=d.normalizedBarcode||(d.equipmentId?`id:${d.equipmentId}`:null);if(u){if(l.has(u)){const m=l.get(u);m.qty+=d.qty,m.quantity+=d.quantity,(!Number.isFinite(m.qtyPerPackage)||m.qtyPerPackage<=0)&&(m.qtyPerPackage=d.qtyPerPackage),(!m.price||m.price===0)&&d.price&&(m.price=d.price,m.unit_price=d.unit_price),!m.desc&&d.desc&&(m.desc=d.desc),!m.image&&d.image&&(m.image=d.image);return}l.set(u,{...d})}}),Array.from(l.values())}function Sb(e={},t=[],n=1){if(Array.isArray(t)&&t.length){const s=t.reduce((r,i)=>{const o=Number.isFinite(Number(i.price))?Number(i.price):0,l=Number.isFinite(Number(i.qtyPerPackage))&&Number(i.qtyPerPackage)>0?Number(i.qtyPerPackage):Number.isFinite(Number(i.qty))&&Number(i.qty)>0?Number(i.qty):1;return r+o*l},0);if(s>0)return Number(s.toFixed(2))}const a=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(a))){const s=Ue(a);return n>0?Number((s/n).toFixed(2)):s}return Number.isFinite(Number(e.unit_price??e.unitPrice??e.price))?Ue(e.unit_price??e.unitPrice??e.price):0}function Ab(e,t){if(!e)return t;if(!t)return e;const n={...e},a=s=>{(n[s]===void 0||n[s]===null||n[s]==="")&&(n[s]=t[s])};return["name","desc","barcode","image"].forEach(a),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=qw(n.packageItems,t.packageItems),n.items=n.packageItems),n}function qw(e=[],t=[]){const n=new Map,a=s=>{s.forEach(r=>{if(!r)return;const i=r.normalizedBarcode||(r.equipmentId?`id:${r.equipmentId}`:null);if(i){if(n.has(i)){const o=n.get(i);o.qty+=r.qty??0,o.quantity+=r.quantity??0,(!Number.isFinite(o.qtyPerPackage)||o.qtyPerPackage<=0)&&Number.isFinite(r.qtyPerPackage)&&(o.qtyPerPackage=r.qtyPerPackage),(!o.price||o.price===0)&&r.price&&(o.price=r.price,o.unit_price=r.unit_price),!o.desc&&r.desc&&(o.desc=r.desc),!o.image&&r.image&&(o.image=r.image);return}n.set(i,{...r})}})};return a(e),a(t),Array.from(n.values())}function zs(e=[],t=[]){const n=[],a=new Map,s=r=>{Array.isArray(r)&&r.forEach(i=>{if(!i||typeof i!="object")return;const o=i.packageId||i.package_id||i.package_code||i.id;if(o)if(a.has(o)){const l=a.get(o);n[l]=Ab(n[l],i)}else a.set(o,n.length),n.push({...i})})};return s(e),s(t),n}function Eb(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const m=Wn(e),p=m?Gi(m):null,f=p?Uc(p,m):[],h=p?Ue(p.price??p.unit_price??p.unitPrice??0):0,g=1,y=Number((h*g).toFixed(2));return{id:`package::${m||t}`,packageId:m||`pkg-${t}`,package_id:m||`pkg-${t}`,package_code:b(String(e))||m||`pkg-${t}`,name:p?.name??p?.package_name??p?.packageName??b(String(e))??"",desc:p?.name??b(String(e))??"",quantity:g,qty:g,unit_price:h,unitPrice:h,price:h,total:y,total_price:y,barcode:b(String(e)),packageItems:f,items:f,type:"package",image:p?.image??null}}if(typeof e!="object")return null;const n=Wn(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,a=qt(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=Uc(e,n),r=Sb(e,s,a),i=e.total_price??e.totalPrice??e.total??r*a,o=Number.isFinite(Number(i))?Ue(i):Number((r*a).toFixed(2)),l=e.package_code??e.packageCode??e.code??n,d=b(String(e.barcode??l??"")),u=e.image??e.cover??e.thumbnail??s.find(m=>m.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:l,name:e.name??e.package_name??e.packageName??e.title??e.description??l??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??l??n,quantity:a,qty:a,unit_price:r,unitPrice:r,price:r,total:o,total_price:o,barcode:d,packageItems:s,items:s,type:"package",image:u}}function Jm(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],a=new Map,s=(o,l=n.length)=>{const d=Eb(o,l);if(!d)return;const u=d.packageId||d.package_code||d.id||`pkg-${l}`;if(a.has(u)){const m=a.get(u);n[m]=Ab(n[m],d)}else a.set(u,n.length),n.push(d)};t.forEach(o=>{o.forEach((l,d)=>{s(l,d+n.length)})}),n.length===0&&e.package&&s(e.package,0);const r=Array.isArray(e.items)?e.items:[],i=(o={})=>!o||typeof o!="object"?!1:!!(bb(o.type??o.item_type??o.kind??null)==="package"||o.packageItems&&Array.isArray(o.packageItems)&&o.packageItems.length||o.items&&Array.isArray(o.items)&&o.items.length&&o.items.every(d=>typeof d=="object")||o.packageId||o.package_id||o.package_code||o.packageCode||o.bundleId||o.bundle_id);return r.forEach((o,l)=>{i(o)&&s(o,n.length+l)}),n}function Ue(e){const t=xe(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function qt(e,{fallback:t=1,max:n=1e6}={}){const a=xe(e);if(!Number.isFinite(a))return t;const s=Math.round(a);return s<=0||s>n?t:s}function kw(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return"pending"}}function _w(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function oi(e){return e instanceof Ge}const jL=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:Qm,confirmReservationApi:yb,createReservationApi:fb,deleteReservationApi:hb,getCachedReservationCrew:mb,getReservationsState:We,isApiError:oi,mapLegacyReservation:Wm,mapReservationFromApi:ii,mapReservationItem:gb,refreshReservationsFromApi:Zs,setReservationsState:xo,toInternalReservation:Hs,updateReservationApi:er},Symbol.toStringTag,{value:"Module"}));Gs();Rs();vo();Ia();Il();let Vc="",uu="",Hn=null,_c=!1,Kc="";function Di(){const e=document.querySelectorAll("[data-home-greeting]");if(!e.length)return;const t=c("home.hero.title","مرحباً بك"),n=Vc?c("home.hero.greetingUser","مرحباً {name}").replace("{name}",Vc):t;e.forEach(a=>{a.textContent=n})}function gd(){const e=uu==="admin";document.querySelectorAll("[data-admin-card]").forEach(t=>{e?t.classList.remove("hidden"):t.classList.add("hidden")})}function Tw(e){if(!e||typeof e!="object")return null;const t=n=>{const a=Number.parseInt(String(n??"0"),10);return Number.isFinite(a)?a:0};return{customers:{total:t(e?.customers?.total)},reservations:{total:t(e?.reservations?.total),today:t(e?.reservations?.today),upcoming:t(e?.reservations?.upcoming)},equipment:{total:t(e?.equipment?.total),maintenance:t(e?.equipment?.maintenance)},technicians:{total:t(e?.technicians?.total),busy:t(e?.technicians?.busy)},projects:{total:t(e?.projects?.total),active:t(e?.projects?.active)},maintenance:{open:t(e?.maintenance?.open),highPriority:t(e?.maintenance?.highPriority)}}}function wb(){return{customers:{total:0},reservations:{total:0,today:0,upcoming:0},equipment:{total:0,maintenance:0},technicians:{total:0,busy:0},projects:{total:0,active:0},maintenance:{open:0,highPriority:0}}}function Cw(e){if(e==null)return null;if(typeof e=="object"){const n=[e.id,e.technicianId,e.technician_id,e.technician?.id,e.value];for(const a of n)if(a!=null&&String(a).trim()!=="")return String(a).trim();return null}const t=String(e).trim();return t===""?null:t}function dh(e){const t=ae(),n=e?{...e}:wb(),a=Array.isArray(t.customers)?t.customers:[],s=Array.isArray(t.reservations)?t.reservations:[],r=Array.isArray(t.equipment)?t.equipment:[],i=Array.isArray(t.maintenance)?t.maintenance:[],o=Array.isArray(t.projects)?t.projects:[];if(a.length&&(n.customers={...n.customers,total:a.length}),r.length){const m=r.filter(p=>{const f=String(p?.status||p?.state||"").toLowerCase();return f.includes("maintenance")||f.includes("repair")}).length;n.equipment={...n.equipment,total:r.length,maintenance:m}}if(o.length){const m=o.filter(p=>xl(p)==="ongoing").length;n.projects={...n.projects,total:Math.max(n.projects?.total??0,o.length),active:Math.max(n.projects?.active??0,m)}}if(i.length){const m=i.filter(f=>{const h=String(f?.status||f?.state||"").toLowerCase();return!h||["open","pending","in-progress","progress","scheduled"].includes(h)}).length,p=i.filter(f=>{const h=String(f?.priority||f?.severity||"").toLowerCase();return["high","urgent","critical"].includes(h)}).length;n.maintenance={...n.maintenance,open:Math.max(n.maintenance?.open??0,m),highPriority:Math.max(n.maintenance?.highPriority??0,p)}}if(s.length){const m=new Date,p=new Date(m);p.setHours(0,0,0,0);const f=new Date(p);f.setDate(f.getDate()+1);const h=j=>{const k=String(j?.status||j?.reservationStatus||"").toLowerCase();return["cancelled","canceled"].includes(k)},g=(j,k)=>{const w=String(j||"").trim(),_=String(k||"").trim();return!w&&!_?null:w&&_?`${w}T${_}`:w?`${w}T00:00:00`:null},y=j=>{if(!j)return null;if(j instanceof Date)return Number.isNaN(j.getTime())?null:j;let k=String(j).trim();if(!k)return null;/^\d{4}-\d{2}-\d{2}$/.test(k)?k=`${k}T00:00:00`:k.includes(" ")&&(k=k.replace(" ","T"));const w=new Date(k);return Number.isNaN(w.getTime())?null:w},E=j=>{const k=[j?.start,j?.startDatetime,j?.start_datetime,j?.start_date,j?.startDate,g(j?.startDate,j?.startTime),g(j?.start_date,j?.start_time)];for(const w of k){const _=y(w);if(_)return _}return null},S=j=>{const k=[j?.end,j?.endDatetime,j?.end_datetime,j?.end_date,j?.endDate,g(j?.endDate,j?.endTime),g(j?.end_date,j?.end_time)];for(const w of k){const _=y(w);if(_)return _}return null},x=s.filter(j=>{if(h(j))return!1;const k=E(j);return k?k>=p&&k<f:!1}).length,A=s.filter(j=>{if(h(j))return!1;const k=E(j);return k?k>=m:!1}).length,C=new Set;s.forEach(j=>{if(h(j))return;const k=E(j);let w=S(j);if(!k||((!w||w<=k)&&(w=new Date(k.getTime()+14400*1e3)),!k||!w)||k>m||w<=m)return;(Array.isArray(j.technicians)?j.technicians:[]).forEach($=>{const q=Cw($);q&&C.add(q)})}),n.reservations={...n.reservations,total:Math.max(n.reservations?.total??0,s.length),today:Math.max(n.reservations?.today??0,x),upcoming:Math.max(n.reservations?.upcoming??0,A)},n.technicians={...n.technicians,busy:Math.max(n.technicians?.busy??0,C.size)}}const l=Ut(),d=Array.isArray(t.technicians)?t.technicians:[],u=Array.isArray(l)&&l.length>0?l:d;if(u.length){const m=u.filter(p=>{if(!p)return!1;if(p.isBusy===!0||p.busy===!0)return!0;const h=[p?.status,p?.baseStatus,p?.currentStatus,p?.availability,p?.state,p?.status_label,p?.statusLabel,p?.statusText,p?.status_text].map(y=>String(y??"").trim().toLowerCase()).filter(y=>y.length>0).map(y=>y.replace(/[\u2700-\u27bf\u1f300-\u1f64f\u1f680-\u1f6ff\u2600-\u26ff]/g,"").replace(/[^\p{L}\p{N}\s_-]+/gu," ").replace(/\s+/g," ").trim());if(!h.length)return!1;const g=["busy","مشغول","غير متاح","مشغولة","occupied","in use","in-use","working","assigned","قيد العمل","assigned crew"];return h.some(y=>g.some(E=>y.includes(E)))}).length;n.technicians={...n.technicians,total:Math.max(n.technicians?.total??0,u.length),busy:Math.max(n.technicians?.busy??0,m)}}return n}function Pw(e){return[{key:"customers.total",label:c("home.summary.customers","إجمالي العملاء"),value:e.customers.total,icon:"👥",accent:"primary",href:"dashboard.html#customers-tab",dashboardTab:"customers-tab"},{key:"reservations.today",label:c("home.summary.reservationsToday","حجوزات اليوم"),value:e.reservations.today,icon:"🛎️",accent:"success",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"},{key:"reservations.upcoming",label:c("home.summary.reservationsUpcoming","حجوزات قادمة"),value:e.reservations.upcoming,icon:"🔔",accent:"info",href:"dashboard.html#reservations-tab",dashboardTab:"reservations-tab",dashboardSubTab:"calendar-tab"},{key:"projects.active",label:c("home.summary.projectsActive","مشاريع نشطة"),value:e.projects.active,icon:"🏗️",accent:"warning",href:"projects.html#projects-section",projectsTab:"projects-section",projectsSubTab:"projects-list-tab"},{key:"equipment.maintenance",label:c("home.summary.equipmentMaintenance","معدات قيد الصيانة"),value:e.equipment.maintenance,icon:"🛠️",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"maintenance.highPriority",label:c("home.summary.maintenanceHigh","بلاغات صيانة عاجلة"),value:e.maintenance.highPriority,icon:"⚡",accent:"error",href:"dashboard.html#maintenance-tab",dashboardTab:"maintenance-tab"},{key:"technicians.busy",label:c("home.summary.techniciansBusy","أعضاء طاقم مشغولون"),value:e.technicians.busy,icon:"👷",accent:"secondary",href:"dashboard.html#technicians-tab",dashboardTab:"technicians-tab"}]}const uh={primary:"bg-primary/10 text-primary",success:"bg-success/10 text-success",info:"bg-info/10 text-info",warning:"bg-warning/10 text-warning",error:"bg-error/10 text-error",secondary:"bg-secondary/10 text-secondary"},Lw={projects:["sidebar-stat-projects"],reservations:["sidebar-stat-reservations"],equipment:["sidebar-stat-equipment"],technicians:["sidebar-stat-technicians"]};function Jo(e){const t=e??wb(),n={projects:t?.projects?.total??0,reservations:t?.reservations?.total??0,equipment:t?.equipment?.total??0,technicians:t?.technicians?.total??0};Object.entries(n).forEach(([a,s])=>{const r=Lw[a];if(!Array.isArray(r))return;const i=b(String(s??0));r.forEach(o=>{if(!o)return;const l=document.getElementById(o);l&&(l.textContent=i)})})}function Nw(e){if(typeof Ft!="function")return;const t=["dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"],n={};if(t.forEach(a=>{Object.prototype.hasOwnProperty.call(e,a)&&(n[a]=e[a]??null)}),Object.keys(n).length!==0)try{const a=Ft(n);a&&typeof a.catch=="function"&&a.catch(s=>{console.warn("⚠️ [home] Failed to persist navigation preference",s)})}catch(a){console.warn("⚠️ [home] Failed to persist navigation preference",a)}}function $w(e){e.querySelectorAll("[data-summary-card]").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{const n={};t.dataset.dashboardTab!==void 0&&(n.dashboardTab=t.dataset.dashboardTab||null),t.dataset.dashboardSubtab!==void 0&&(n.dashboardSubTab=t.dataset.dashboardSubtab||null),t.dataset.projectsTab!==void 0&&(n.projectsTab=t.dataset.projectsTab||null),t.dataset.projectsSubtab!==void 0&&(n.projectsSubTab=t.dataset.projectsSubtab||null),Object.keys(n).length>0&&Nw(n)}),t.dataset.listenerAttached="true")})}function Dw(e){const t=["glass-card","summary-card","flex","flex-col","items-center","gap-2","p-5","text-center","transition","duration-200","hover:-translate-y-1","focus-visible:outline","focus-visible:outline-2","focus-visible:outline-offset-2","focus-visible:outline-primary"],n=["data-summary-card"],a=o=>String(o??"").replace(/"/g,"&quot;");e.href&&n.push(`href="${a(e.href)}"`),e.dashboardTab!==void 0&&n.push(`data-dashboard-tab="${a(e.dashboardTab??"")}"`),e.dashboardSubTab!==void 0&&n.push(`data-dashboard-subtab="${a(e.dashboardSubTab??"")}"`),e.projectsTab!==void 0&&n.push(`data-projects-tab="${a(e.projectsTab??"")}"`),e.projectsSubTab!==void 0&&n.push(`data-projects-subtab="${a(e.projectsSubTab??"")}"`);const s=b(String(e.value??0)),r=a(e.label),i=uh[e.accent]||uh.primary;return`
    <a ${n.join(" ")} class="${t.join(" ")}" aria-label="${r}">
      <span class="summary-card__icon flex h-12 w-12 items-center justify-center rounded-2xl text-2xl ${i}">${e.icon}</span>
      <span class="summary-card__label text-sm font-medium text-base-content/70">${e.label}</span>
      <span class="summary-card__value text-3xl font-bold text-base-content">${s}</span>
    </a>
  `}function Ji(){const e=document.querySelector("[data-home-summary]");if(!e)return;if(_c){e.innerHTML=`
      <div class="w-full text-center text-base-content/60" data-i18n data-i18n-key="home.summary.loading">
        ${c("home.summary.loading","⏳ جارٍ جلب بيانات النظام...")}
      </div>
    `,Jo(Hn);return}if(Kc){e.innerHTML=`
      <div class="alert alert-warning" role="alert">
        ${Kc}
      </div>
    `,Jo(Hn);return}if(!Hn){e.innerHTML=`
      <div class="w-full text-center text-base-content/60">
        ${c("home.summary.empty","لا تتوفر بيانات بعد. ابدأ بإضافة سجلات.")} 
      </div>
    `,Jo(Hn);return}const t=Pw(Hn);e.innerHTML=t.map(Dw).join(""),$w(e),Jo(Hn)}async function jb({silent:e=!1}={}){if(!_c){_c=!0,e||Ji();try{const t=await pe("/summary/");Hn=Tw(t?.data??null),Hn=dh(Hn),Kc=""}catch(t){console.error("❌ [home] Failed to load summary data",t),Hn=dh(null),Kc=t instanceof Ge?t.message:c("home.summary.error","تعذر تحميل بيانات النظام، حاول لاحقاً")}finally{_c=!1,Ji()}}}function ta(){jb({silent:!0}).catch(e=>{console.error("❌ [home] Summary refresh failed",e)})}const Zo=document.getElementById("home-refresh-summary");Zo&&!Zo.dataset.listenerAttached&&(Zo.addEventListener("click",()=>{ta()}),Zo.dataset.listenerAttached="true");document.addEventListener("language:translationsReady",()=>{Di(),Ji()});document.addEventListener("language:changed",()=>{Di(),Ji()});function mh(){Ia();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ti()),e.dataset.listenerAttached="true"),Promise.resolve(Im({refresh:!0})).then(a=>{Vc=a?.username||"",uu=(a?.role||"").toLowerCase(),Di(),gd()}).catch(()=>{Vc="",uu="",Di(),gd()}),Di(),gd(),Ji(),jb(),document.addEventListener("customers:changed",ta,{passive:!0}),document.addEventListener("reservations:changed",ta,{passive:!0}),document.addEventListener("equipment:changed",ta,{passive:!0}),document.addEventListener("maintenance:updated",ta,{passive:!0}),document.addEventListener("technicians:updated",ta,{passive:!0}),document.addEventListener("projects:changed",ta,{passive:!0}),typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("technicians:updated",ta,{passive:!0});const t=()=>{ta()},n=(a,s)=>{!a||typeof a.then!="function"||a.then(()=>{t()}).catch(r=>{console.warn(`⚠️ [home] Failed to prefetch ${s} for summary`,r)})};try{n(ai(),"technicians")}catch(a){console.warn("⚠️ [home] Failed to kick off technicians prefetch",a)}try{n(Zs(),"reservations")}catch(a){console.warn("⚠️ [home] Failed to kick off reservations prefetch",a)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{mh()},{once:!0}):mh();const Bw="modulepreload",Fw=function(e,t){return new URL(e,t).href},ph={},Ll=function(t,n,a){let s=Promise.resolve();if(n&&n.length>0){let d=function(u){return Promise.all(u.map(m=>Promise.resolve(m).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};const i=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),l=o?.nonce||o?.getAttribute("nonce");s=d(n.map(u=>{if(u=Fw(u,a),u in ph)return;ph[u]=!0;const m=u.endsWith(".css"),p=m?'[rel="stylesheet"]':"";if(a)for(let h=i.length-1;h>=0;h--){const g=i[h];if(g.href===u&&(!m||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${u}"]${p}`))return;const f=document.createElement("link");if(f.rel=m?"stylesheet":Bw,m||(f.as="script"),f.crossOrigin="",f.href=u,l&&f.setAttribute("nonce",l),document.head.appendChild(f),m)return new Promise((h,g)=>{f.addEventListener("load",h),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(i){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=i,window.dispatchEvent(o),!o.defaultPrevented)throw i}return s.then(i=>{for(const o of i||[])o.status==="rejected"&&r(o.reason);return t().catch(r)})};let Cn=null,mu=!1,Bi="";const Rw=ae()||{};let pu=(Rw.customers||[]).map(Zi),Vn=null,qo="idle",Nl=null;function fu(e){if(!e||typeof e!="object")return null;const t=[e.document,e.attachment,e.file].find(x=>x&&typeof x=="object"),n=[e.document_url,e.documentUrl,e.url,e.href,e.link,t?.url,t?.href,t?.link],a=[e.document_path,e.documentPath,e.path,t?.path,t?.documentPath],s=[e.document_file_name,e.documentFileName,e.document_name,e.fileName,e.filename,e.name,t?.fileName,t?.filename,t?.name],r=[e.document_mime_type,e.documentMimeType,e.document_type,e.mimeType,e.contentType,e.type,t?.mimeType,t?.contentType,t?.type],i=[e.document_size,e.documentSize,e.size,t?.size,t?.length],o=[t?.data,t?.base64,t?.content,e.data,e.base64,e.content,e.document_data],l=x=>{for(const A of x)if(typeof A=="string"&&A.trim()!=="")return A.trim();return""},d=x=>{for(const A of x){if(typeof A=="number"&&Number.isFinite(A))return Math.max(0,Math.trunc(A));if(typeof A=="string"&&A.trim()!==""&&/^\d+$/.test(A.trim()))return Math.max(0,parseInt(A.trim(),10))}return null},u=l(n),m=l(s),p=l(r)||"application/octet-stream",f=l(a),h=l(o),g=d(i);if(!u&&!h)return null;let y=u,E=h;if(!y&&E&&E.startsWith("data:")){const x=E.indexOf(",");x!==-1&&(y=E,E=E.slice(x+1))}!y&&E&&(y=`${E.startsWith("data:")?"":`data:${p};base64,`}${E}`);const S={url:y,fileName:m,mimeType:p,path:f,data:E||null,size:g};return S.url&&/sirv\.com/i.test(S.url)&&(S.source="sirv"),S}function Zm(){qo="idle",Nl=null}function bd(e,t){qo=e,Nl=t||null,Os()}function ep(){return qo==="uploading"}function ko(e){return!e||typeof e!="object"?!1:!!e.url||!!e.data}function Mw(e){if(!ko(e))return null;const t={},n=typeof e.url=="string"?e.url.trim():"",a=e.size;let s=n;return s||(s=rp(e)),s?(t.url=s,e.path&&(t.path=e.path),e.mimeType&&(t.mimeType=e.mimeType),e.fileName&&(t.fileName=e.fileName),typeof a=="number"&&Number.isFinite(a)?t.size=Math.max(0,Math.trunc(a)):typeof a=="string"&&a.trim()!==""&&/^\d+$/.test(a.trim())&&(t.size=Math.max(0,parseInt(a.trim(),10))),t):null}function Zi(e={}){if(!e||typeof e!="object")return{id:"",full_name:"",customerName:"",name:"",phone:"",email:"",address:"",company:"",notes:"",created_at:null,updated_at:null};const t=e.id??e.customerId??e.reservationId??e.customerID,n=e.full_name??e.customerName??e.name??"",a=typeof n=="string"?n.trim():String(n||"").trim(),s=e.tax_id??e.taxId??e.vat_number??e.vatNumber??e.taxNumber??"",r=fu(e);return{id:t!=null?String(t):"",full_name:a,customerName:a,name:a,phone:e.phone??e.phoneNumber??"",email:e.email??"",address:e.address??"",company:e.company??e.companyName??"",notes:e.notes??"",tax_id:typeof s=="string"?s.trim():String(s||"").trim(),taxId:typeof s=="string"?s.trim():String(s||"").trim(),document:r,created_at:e.created_at??null,updated_at:e.updated_at??null}}function Ib(){document.dispatchEvent(new CustomEvent("customers:changed"))}function Cs(){return pu}function Wc(e){pu=Array.isArray(e)?e.map(Zi):[],an({customers:pu})}function Qn(){return{form:document.getElementById("customer-form"),idInput:document.getElementById("customer-id"),nameInput:document.getElementById("customer-name"),phoneInput:document.getElementById("customer-phone"),emailInput:document.getElementById("customer-email"),addressInput:document.getElementById("customer-address"),companyInput:document.getElementById("customer-company"),notesInput:document.getElementById("customer-notes"),taxInput:document.getElementById("customer-tax-id"),documentInput:document.getElementById("customer-document"),documentNameLabel:document.getElementById("customer-document-name"),documentPreviewBtn:document.getElementById("customer-document-preview"),submitBtn:document.getElementById("submit-btn"),cancelBtn:document.getElementById("customer-cancel-btn")}}function Hw(){const{submitBtn:e}=Qn();e&&(e.disabled=ep())}function Os(){const{documentNameLabel:e,documentPreviewBtn:t}=Qn(),n=ep(),a=ko(Vn);if(t&&(t.disabled=!a||n),e){let r=c("customers.form.document.empty","لم يتم اختيار ملف بعد");n?r=c("customers.form.document.uploading","📤 جارٍ رفع الملف..."):qo==="error"?r=Nl||c("customers.form.document.uploadFailed","⚠️ فشل رفع الملف"):a&&(r=Vn?.fileName?.trim()||c("customers.form.document.selected","تم إرفاق ملف.")),e.textContent=r}Hw()}function tp(e="add"){const{submitBtn:t}=Qn();if(!t)return;const n=e==="update"?"customers.form.actions.update":"customers.form.actions.submit",a=e==="update"?"💾 حفظ التعديل":"➕ إضافة عميل";t.textContent=c(n,a)}function np(e){const{cancelBtn:t}=Qn();t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=c("customers.form.actions.cancel","إلغاء التعديل"))}function ap(){const e=!!Cn;tp(e?"update":"add"),np(e),Os()}function sp(){const{form:e,idInput:t,phoneInput:n}=Qn();e?.reset(),t&&(t.value=""),n&&(n.value=n.value.trim()),Vn=null,Zm(),Os(),Cn=null,tp("add"),np(!1)}function zw(e){const{idInput:t,nameInput:n,phoneInput:a,emailInput:s,addressInput:r,companyInput:i,notesInput:o,taxInput:l,documentInput:d}=Qn();!e||!n||!a||(t&&(t.value=e.id),n.value=e.full_name||"",a.value=b(e.phone||""),s&&(s.value=e.email||""),r&&(r.value=e.address||""),i&&(i.value=e.company||""),o&&(o.value=e.notes||""),l&&(l.value=e.tax_id||""),d&&(d.value=""),Vn=e.document?{...e.document}:null,Zm(),Os(),Cn=e.id,tp("update"),np(!0))}function Ow(){const{idInput:e,nameInput:t,phoneInput:n,emailInput:a,addressInput:s,companyInput:r,notesInput:i,taxInput:o}=Qn();if(!t||!n)return null;const l=t.value.trim(),d=b(n.value.trim());if(n.value=d,!l||!d)return I(c("customers.toast.missingFields","يرجى تعبئة الاسم ورقم الهاتف"),"error"),null;if(ep())return I(c("customers.form.document.uploadingWait","⏳ يرجى الانتظار حتى يكتمل رفع الملف"),"info"),null;if(qo==="error"){const f=Nl||c("customers.form.document.uploadFailed","⚠️ فشل رفع الملف، حاول مرة أخرى");return I(f,"error"),null}const u={full_name:l,phone:d,email:a?.value.trim()||"",address:s?.value.trim()||"",company:r?.value.trim()||"",notes:i?.value.trim()||""},m=o?.value.trim()||"";u.tax_id=m,u.taxId=m;const p=Mw(Vn);return p&&(u.document=p),{payload:u,id:e?.value||Cn||""}}async function Uw(e){const{documentInput:t}=Qn(),n=e.target?.files&&e.target.files[0];if(!n){Vn=null,Zm(),Os(),t&&(t.value="");return}bd("uploading");try{const a=new FormData;a.append("file",n),Cn&&a.append("customer_id",Cn);const r=(await pe("/uploads/sirv.php",{method:"POST",body:a}))?.data;if(!r||!r.url)throw new Error("Missing upload URL from server response");Vn={url:r.url,path:r.path||"",fileName:r.fileName||n.name,mimeType:r.mimeType||n.type||"application/octet-stream",size:typeof r.size=="number"?r.size:n.size,source:r.source||"sirv"},bd("success"),I(c("customers.form.document.uploadSuccess","✅ تم رفع الملف بنجاح"),"success")}catch(a){console.error("[customers] Failed to upload document to Sirv",a),Vn=null;const s=a instanceof Ge?a.message:c("customers.form.document.uploadFailed","⚠️ تعذر رفع الملف، حاول مرة أخرى");bd("error",s),I(s,"error")}finally{t&&(t.value=""),Os()}}function rp(e){if(!e||typeof e!="object")return"";const t=typeof e.url=="string"?e.url.trim():"";if(t)return t;const n=typeof e.data=="string"?e.data.trim():"";return n?`data:${e.mimeType||"application/octet-stream"};base64,${n}`:""}function Vw(){if(!ko(Vn)){I(c("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const e=rp(Vn);if(!e){I(c("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل."),"info");return}window.open(e,"_blank","noopener")}async function xb({showToastOnError:e=!0}={}){mu=!0,Bi="",wa();try{const t=await pe("/customers/"),n=Array.isArray(t?.data)?t.data.map(Zi):[];Wc(n)}catch(t){Bi=t instanceof Ge?t.message:c("customers.toast.fetchFailed","تعذر تحميل قائمة العملاء"),e&&I(Bi,"error")}finally{mu=!1,wa()}}async function Kw(e){e.preventDefault();const t=Ow();if(!t)return;const{payload:n}=t,a=!!Cn;try{if(a){const s=Cn,r=await pe(`/customers/?id=${encodeURIComponent(s)}`,{method:"PATCH",body:n}),i=Zi(r?.data),o=fu(n.document),l={...i,document:i.document??o,tax_id:i.tax_id??n.tax_id??"",taxId:i.taxId??n.taxId??""},d=Cs().map(u=>String(u.id)===String(s)?l:u);Wc(d),I(c("customers.toast.updateSuccess","تم تحديث بيانات العميل بنجاح"))}else{const s=await pe("/customers/",{method:"POST",body:n}),r=Zi(s?.data),i=fu(n.document),o={...r,document:r.document??i,tax_id:r.tax_id??n.tax_id??"",taxId:r.taxId??n.taxId??""},l=[...Cs(),o];Wc(l),I(c("customers.toast.createSuccess","تمت إضافة العميل بنجاح"))}wa(),sp(),Ib()}catch(s){const r=s instanceof Ge?s.message:c("customers.toast.submitFailed","حدث خطأ أثناء حفظ بيانات العميل");I(r,"error")}}async function Ww(e){const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.closest("button");if(n instanceof HTMLElement){if(n.classList.contains("customer-delete-btn")){if(!St()){Nn();return}const a=n.dataset.id;if(!confirm(c("customers.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العميل؟")))return;try{await pe(`/customers/?id=${encodeURIComponent(a)}`,{method:"DELETE"});const s=Cs().filter(r=>String(r.id)!==String(a));Wc(s),wa(),String(Cn)===String(a)&&sp(),I(c("customers.toast.deleteSuccess","تم حذف العميل")),Ib()}catch(s){const r=s instanceof Ge?s.message:c("customers.toast.deleteFailed","تعذر حذف العميل، يرجى المحاولة مجدداً");I(r,"error")}return}if(n.classList.contains("customer-view-file-btn")){const a=n.dataset.id,s=Cs().find(i=>String(i.id)===String(a));if(!ko(s?.document)){I(c("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const r=rp(s.document);if(!r){I(c("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل."),"info");return}window.open(r,"_blank","noopener");return}if(n.classList.contains("customer-edit-btn")){const a=n.dataset.id,s=Cs().find(r=>String(r.id)===String(a));if(!s)return;zw(s)}}}function Qw(e){const t=e.target.value.trim().toLowerCase(),a=Cs().filter(r=>{const i=r.full_name?.toLowerCase()||"",o=r.phone?.toLowerCase()||"",l=r.company?.toLowerCase()||"";return i.includes(t)||o.includes(t)||l.includes(t)}),s=t?c("customers.table.noResults","لا توجد نتائج مطابقة"):void 0;wa(a,{emptyMessage:s})}function Gw(){const{form:e,cancelBtn:t}=Qn();e&&e.addEventListener("submit",Kw);const{documentInput:n,documentPreviewBtn:a}=Qn();n&&!n.dataset.listenerAttached&&(n.addEventListener("change",Uw),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Vw),a.dataset.listenerAttached="true"),t&&t.addEventListener("click",()=>{sp()});const s=document.getElementById("customers-table");s&&s.addEventListener("click",Ww);const r=document.getElementById("search-customer-input");r&&r.addEventListener("input",Qw),Os()}document.addEventListener("DOMContentLoaded",()=>{Gw(),wa(),ap(),xb()});document.addEventListener("language:changed",()=>{ap(),wa()});document.addEventListener("customers:refreshRequested",()=>{xb({showToastOnError:!1}),ap()});document.addEventListener(ei.USER_UPDATED,()=>{wa()});function wa(e,t={}){const n=Array.isArray(e),a=n?e:Cs(),s=document.getElementById("customers-table");if(!s)return;if(s.innerHTML="",!n){if(mu){s.innerHTML=`<tr><td colspan='5'>${c("customers.table.loading","جاري التحميل...")}</td></tr>`;return}if(Bi){s.innerHTML=`<tr><td colspan='5' class='text-danger'>${Bi}</td></tr>`;return}}if(a.length===0){const d=t.emptyMessage||c("customers.table.empty","لا يوجد عملاء");s.innerHTML=`<tr><td colspan='5'>${d}</td></tr>`;return}const r=c("customers.actions.edit","✏️ تعديل"),i=c("customers.actions.delete","🗑️ حذف"),o=c("customers.actions.viewDocument","📎 عرض الملف"),l=St();a.forEach(d=>{const u=Cn&&String(Cn)===String(d.id),m=document.createElement("tr");u&&m.classList.add("customer-table-row-editing");const p=[`<button type="button" class="customer-action-btn customer-action-btn--edit customer-edit-btn" data-id="${d.id}">${r}</button>`];ko(d.document)&&p.push(`<button type="button" class="customer-action-btn customer-action-btn--file customer-view-file-btn" data-id="${d.id}">${o}</button>`),l&&p.push(`<button type="button" class="customer-action-btn customer-action-btn--delete customer-delete-btn" data-id="${d.id}">${i}</button>`),m.innerHTML=`
      <td><a href="customer.html?id=${d.id}" class="text-decoration-none">${d.full_name}</a></td>
      <td>${b(d.phone)}</td>
      <td>${d.company||""}</td>
      <td class="table-notes-cell">${d.notes||"—"}</td>
      <td class="table-actions-cell">
        <div class="table-action-buttons">
          ${p.join("")}
        </div>
      </td>
    `,s.appendChild(m)})}const vd="select.form-select:not([data-no-enhance]):not([multiple])",Jn=new WeakMap;let Sd=null,fh=!1,da=null;function IL(e=document){e&&(e.querySelectorAll(vd).forEach(t=>Cc(t)),!Sd&&e===document&&(Sd=new MutationObserver(t=>{for(const n of t)n.addedNodes?.forEach(a=>{a instanceof Element&&(a.matches?.(vd)&&Cc(a),a.querySelectorAll?.(vd).forEach(s=>Cc(s)))})}),Sd.observe(document.body,{childList:!0,subtree:!0})),fh||(fh=!0,document.addEventListener("pointerdown",Jw,{capture:!0})))}function Tc(e){if(!(e instanceof HTMLSelectElement))return;if(!e.dataset.enhancedSelect){Cc(e);return}const t=e.closest(".enhanced-select");t&&(ip(t),Qc(t),hu(t))}function Cc(e){if(!(e instanceof HTMLSelectElement))return;if(e.dataset.enhancedSelect){Tc(e);return}if(e.multiple||e.size>1)return;const t=document.createElement("div");t.className="enhanced-select";const n=e.parentNode;n&&n.insertBefore(t,e),t.appendChild(e),e.dataset.enhancedSelect="true",e.classList.add("enhanced-select__native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const a=document.createElement("button");a.type="button",a.className="enhanced-select__trigger",a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const s=document.createElement("ul");s.className="enhanced-select__menu",s.setAttribute("role","listbox"),s.setAttribute("tabindex","-1"),t.append(a,s);const r={select:e,trigger:a,menu:s,observer:null,refreshRaf:null};Jn.set(t,r),a.addEventListener("click",()=>Xw(t)),a.addEventListener("keydown",i=>Zw(i,t)),s.addEventListener("click",i=>tj(i,t)),s.addEventListener("keydown",i=>ej(i,t)),e.addEventListener("change",()=>{Qc(t),qb(t)}),r.observer=new MutationObserver(i=>{let o=!1,l=!1;for(const d of i)d.type==="attributes"&&d.attributeName==="disabled"&&(l=!0),d.type==="childList"&&(o=!0);l&&hu(t),o&&Yw(r,t)}),r.observer.observe(e,{attributes:!0,attributeFilter:["disabled"],childList:!0}),ip(t),Qc(t),hu(t)}function Yw(e,t){e&&(e.refreshRaf||(e.refreshRaf=requestAnimationFrame(()=>{e.refreshRaf=null,ip(t),Qc(t)})))}function ip(e){const t=Jn.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const s=Array.from(n.options||[]),r=document.createDocumentFragment();s.forEach(i=>{const o=document.createElement("li");o.className="enhanced-select__option",o.textContent=i.textContent??i.value??"",o.dataset.value=i.value??"",o.setAttribute("role","option"),o.setAttribute("tabindex","-1"),i.disabled&&(o.setAttribute("aria-disabled","true"),o.classList.add("is-disabled")),i.selected&&(o.setAttribute("aria-selected","true"),o.dataset.selected="true",o.setAttribute("tabindex","0")),r.appendChild(o)}),a.innerHTML="",a.appendChild(r),qb(e)}function Qc(e){const t=Jn.get(e);if(!t)return;const{select:n,trigger:a}=t;if(!n||!a)return;const s=n.selectedOptions?.[0]??n.options?.[n.selectedIndex],r=s?.textContent?.trim()||s?.value||"";a.textContent=r}function qb(e){const t=Jn.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const s=n.value;a.querySelectorAll(".enhanced-select__option").forEach(i=>{const o=i.dataset.value===s;i.toggleAttribute("aria-selected",o),i.dataset.selected=o?"true":"",i.setAttribute("tabindex",o?"0":"-1")})}function hu(e){const t=Jn.get(e);if(!t)return;const{select:n,trigger:a}=t,s=!!n?.disabled;e.classList.toggle("enhanced-select--disabled",s),a.disabled=s}function Xw(e){Jn.get(e)&&(e.getAttribute("data-open")==="true"?ci(e):kb(e))}function kb(e){const t=Jn.get(e);if(!t)return;da&&da!==e&&ci(da,{focusTrigger:!1}),e.setAttribute("data-open","true"),t.trigger.setAttribute("aria-expanded","true"),da=e;const n=t.menu.querySelector('.enhanced-select__option[aria-selected="true"]')??t.menu.querySelector(".enhanced-select__option:not([aria-disabled='true'])");n?n.focus():t.menu.focus()}function ci(e,{focusTrigger:t=!0}={}){const n=Jn.get(e);n&&(e.setAttribute("data-open","false"),n.trigger.setAttribute("aria-expanded","false"),t&&n.trigger.focus({preventScroll:!0}),da===e&&(da=null))}function Jw(e){if(!da)return;const t=e.target;t instanceof Node&&(da.contains(t)||ci(da,{focusTrigger:!1}))}function Zw(e,t){const n=e.key;n==="ArrowDown"||n==="ArrowUp"||n===" "||n==="Enter"?(e.preventDefault(),kb(t)):n==="Escape"&&ci(t)}function ej(e,t){const n=e.key,a=Jn.get(t);if(!a)return;const s=Array.from(a.menu.querySelectorAll(".enhanced-select__option:not([aria-disabled='true'])"));if(!s.length)return;const r=s.findIndex(i=>i===document.activeElement);if(n==="ArrowDown"||n==="ArrowUp"){e.preventDefault();const o=(r+(n==="ArrowDown"?1:-1)+s.length)%s.length;s[o].focus()}else if(n==="Home")e.preventDefault(),s[0].focus();else if(n==="End")e.preventDefault(),s[s.length-1].focus();else if(n==="Enter"||n===" "){e.preventDefault();const i=document.activeElement;i&&i.classList.contains("enhanced-select__option")&&_b(i,t)}else n==="Escape"&&(e.preventDefault(),ci(t))}function tj(e,t){const n=e.target?.closest?.(".enhanced-select__option");n&&_b(n,t)}function _b(e,t){const n=Jn.get(t);if(!n||e.getAttribute("aria-disabled")==="true")return;const{select:a}=n,s=e.dataset.value??"";a.value!==s&&(a.value=s,a.dispatchEvent(new Event("change",{bubbles:!0}))),ci(t)}const Ga=Object.freeze({change:"reservationEquipmentSelection:change",requestAdd:"reservationEquipmentSelection:requestAdd"});let ya=null;function op(e,t={}){typeof document>"u"||document.dispatchEvent(new CustomEvent(e,{detail:t}))}function Tb(e,t){if(typeof document>"u")return;const{body:n}=document;n&&(e?(n.classList.add("equipment-selection-active"),t&&(n.dataset.equipmentSelectionMode=t)):(n.classList.remove("equipment-selection-active"),n.dataset&&delete n.dataset.equipmentSelectionMode))}function nj(e={}){const t={...e};return t.barcode&&(t.barcode=b(String(t.barcode||"").trim())),t.start&&typeof t.start!="string"&&(t.start=String(t.start)),t.end&&typeof t.end!="string"&&(t.end=String(t.end)),t}function Cb(e={}){const t=nj({...e,activatedAt:Date.now()});return ya=t,Tb(!0,t.mode||"create"),op(Ga.change,{active:!0,selection:{...t}}),t}function eo(e="manual"){if(!ya)return;const t=ya;ya=null,Tb(!1),op(Ga.change,{active:!1,previous:t,reason:e})}function Pb(){return!!ya}function aj(){return ya?{...ya}:null}function sj(e){if(!ya)return!1;let t;if(typeof e=="string"||typeof e=="number"){const n=b(String(e??"").trim());if(!n)return!1;t={barcodes:[n],quantity:1}}else if(e&&typeof e=="object"){const{barcodes:n,barcode:a,quantity:s,groupKey:r,description:i}=e,o=Array.isArray(n)?n:[];a&&o.push(a);const l=o.map(u=>b(String(u??"").trim())).filter(u=>typeof u=="string"&&u.length>0);if(!l.length)return!1;const d=Number.isInteger(s)&&s>0?s:l.length;t={barcodes:l,quantity:Math.min(d,l.length)},r&&(t.groupKey=r),i&&(t.description=i)}else return!1;return op(Ga.requestAdd,{...t,selection:{...ya}}),!0}typeof document<"u"&&document.addEventListener("dashboard:tabChanged",e=>{const t=e?.detail?.tabId;!t||t==="equipment-tab"||eo("tab-changed")});const rj=new Map([["available","available"],["متاح","available"],["متوفر","available"],["جاهز","available"],["ready","available"],["reserved","reserved"],["محجوز","reserved"],["محجوزة","reserved"],["maintenance","maintenance"],["صيانة","maintenance"],["under_maintenance","maintenance"],["retired","retired"],["متوقف","retired"],["خارج الخدمة","retired"]]),ij=new Set(["maintenance","reserved","retired"]);function oj(e){const t=String(e??"").trim().toLowerCase();return t&&rj.get(t)||"available"}function cj(e){return e?typeof e=="object"?e:$l(e):null}function ja(e){const t=cj(e);return t?oj(t.status||t.state||t.statusLabel||t.status_label):"available"}function cp(e){return!ij.has(ja(e))}function tr(e={}){return e.image||e.imageUrl||e.img||""}function lj(e){if(!e)return null;const t=ve(e),{equipment:n=[]}=ae();return(n||[]).find(a=>ve(a?.barcode)===t)||null}function $l(e){const t=ve(e);if(!t)return null;const{equipment:n=[]}=ae();return(n||[]).find(a=>ve(a?.barcode)===t)||null}const dj=ae()||{};let Ma=(dj.equipment||[]).map(pj),yu=!1,Sr="",Es=null,Us=null,Vs=null,Dl=!1,hh=!1;function uj(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function mj(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function pj(e={}){return lp({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function Bl(e={}){return lp(e)}function lp(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",s=e.subcategory??e.sub??"",r=_o(e.quantity??e.qty??0),i=Fl(e.unit_price??e.price??0),o=b(String(e.barcode??"").trim()),l=zt(e.status??e.state??e.status_label??e.statusLabel??"available"),d=e.image_url??e.imageUrl??e.image??"",u=e.name??e.item_name??n;return{id:fj(t)?String(t):"",category:a,sub:s,desc:n,name:u,qty:r,price:i,barcode:o,status:l,image:d,imageUrl:d,created_at:e.created_at??null,updated_at:e.updated_at??null}}function fj(e){return e!=null&&e!==""}function _o(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function Fl(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function hj(e){!e||e.dataset.englishDigitsAttached||(e.addEventListener("input",()=>{const{selectionStart:t,selectionEnd:n,value:a}=e,s=b(a);if(s!==a&&(e.value=s,t!=null&&n!=null)){const r=s.length-a.length,i=t+r,o=n+r;e.setSelectionRange(i,o)}}),e.dataset.englishDigitsAttached="true")}function yh(e){if(!e)return"";const t=b(String(e.barcode??"")).trim();if(t)return t;if(Array.isArray(e.variants))for(const n of e.variants){const a=b(String(n?.barcode??"")).trim();if(a)return a}return""}function yj(e,t){const n=yh(e),a=yh(t);if(!n&&!a)return 0;if(!n)return 1;if(!a)return-1;const s=/^[0-9]+$/,r=s.test(n),i=s.test(a);if(r&&i){if(n.length!==a.length)return n.length-a.length;const d=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(d!==0)return d}else{if(r!==i)return r?-1:1;{const d=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(d!==0)return d}}const o=Gc(e?.desc||e?.description||e?.name||""),l=Gc(t?.desc||t?.description||t?.name||"");return o.localeCompare(l,"ar",{sensitivity:"base"})}function ht(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function zt(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":case"متوفر":return"available";case"reserved":case"محجوز":return"reserved";case"maintenance":case"صيانة":return"maintenance";case"retired":case"متوقف":case"خارج الخدمة":return"retired";default:return"available"}}function gj(e){return zt(e)}function gu(){if(!Pb())return null;const e=aj();return e?{...e}:null}function bj(e){const t=gu();if(!t)return{active:!1};const n=Array.isArray(e?.variants)&&e.variants.length?e.variants:[e],{start:a,end:s,ignoreReservationId:r=null}=t,i=t?.mode||t?.source||"",o=[],l=new Set;if(n.forEach(p=>{const f=ve(p?.barcode);!f||l.has(f)||(l.add(f),o.push({variant:p,barcode:f}))}),!o.length)return{active:!0,canSelect:!1,reason:c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف")};if(i==="package-manager"||i==="equipment-packages"){const p=Math.max(1,o.length||1);return{active:!0,canSelect:!0,barcode:o[0].barcode,availableBarcodes:o.map(({barcode:f})=>f),maxQuantity:p,reason:""}}const d=o.filter(({variant:p})=>cp(p));if(!a||!s)return{active:!0,canSelect:!1,barcode:d[0]?.barcode||o[0].barcode,reason:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"),availableBarcodes:[],maxQuantity:0};const u=d.filter(({barcode:p})=>!Xn(p,a,s,r));if(u.length)return{active:!0,canSelect:!0,barcode:u[0].barcode,availableBarcodes:u.map(({barcode:p})=>p),maxQuantity:u.length};let m=c("reservations.toast.equipmentUnavailable","⚠️ هذه المعدة غير متاحة حالياً");if(d.length>0)m=c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية");else{const p=new Set(o.map(({variant:f})=>zt(f?.status)));p.has("maintenance")?m=c("reservations.toast.equipmentMaintenance","⚠️ هذه المعدة قيد الصيانة ولا يمكن إضافتها حالياً"):p.has("reserved")?m=c("reservations.toast.equipmentReserved","⚠️ هذه المعدة محجوزة حالياً ولا يمكن إضافتها"):p.has("retired")&&(m=c("reservations.toast.equipmentRetired","⚠️ هذه المعدة خارج الخدمة حالياً"))}return{active:!0,canSelect:!1,barcode:d[0]?.barcode||o[0].barcode,reason:m,availableBarcodes:[],maxQuantity:0}}function vj(){const e=document.querySelector('[data-tab="reservations-tab"]');e&&(e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.querySelector("#sub-tab-trigger-create-tab")?.click(),document.getElementById("equipment-barcode")?.focus()},200)}))}function Lb(){if(typeof document>"u")return;const e=document.getElementById("equipment-selection-banner"),t=document.getElementById("equipment-selection-return"),n=document.getElementById("equipment-selection-banner-title"),a=document.getElementById("equipment-selection-banner-hint");if(!e)return;const s=gu();e.hidden=!s;const r=s?.mode||s?.source||"";s&&(r==="package-manager"||r==="equipment-packages")?(n&&(n.textContent=c("equipment.packages.selection.bannerTitle","📦 اختيار معدات للحزمة")),a&&(a.textContent=c("equipment.packages.selection.bannerHint","اختر المعدات المطلوبة من البطاقات أدناه ثم اضغط على زر إنهاء الاختيار لإضافتها إلى الحزمة.")),t&&(t.textContent=c("equipment.packages.selection.doneButton","✅ إنهاء اختيار الحزمة"))):(n&&(n.textContent=c("reservations.create.equipment.selector.bannerTitle","🔗 اختيار معدات لحجز جديد")),a&&(a.textContent=c("reservations.create.equipment.selector.bannerHint","ابحث في القائمة أدناه، ثم أضف المعدات المتاحة مباشرة إلى نموذج الحجز.")),t&&(t.textContent=c("reservations.create.equipment.selector.returnButton","⬅️ العودة إلى الحجز"))),s&&t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const o=gu(),l=o?.mode||o?.source||"";l==="package-manager"||l==="equipment-packages"?eo("package-finish-button"):(eo("return-button"),vj())}),t.dataset.listenerAttached="true")}function hn(){return Ma}function Ks(e){Ma=Array.isArray(e)?e.map(lp):[],an({equipment:Ma}),mj()}function Gc(e){return String(e??"").trim().toLowerCase()}function Ya(e){if(!e)return"";const t=e.desc||e.description||e.name||"";let n=Gc(t);return n||(n=Gc(e.category||"")),n||(n=b(String(e.barcode||"")).trim().toLowerCase()),n}function Rl(e){const t=Ya(e);return t?hn().filter(n=>Ya(n)===t):[]}function Ml(e){const t=document.getElementById("equipment-details-cover");if(!t)return;const n=Hl(e);if(n){const a=ht(e.desc||e.description||e.name||"");t.innerHTML=`<img src="${ht(n)}" alt="${a}">`,t.classList.add("has-image")}else t.innerHTML='<span class="equipment-details-header__placeholder" aria-hidden="true">📦</span>',t.classList.remove("has-image")}function dp(){return{category:document.getElementById("edit-equipment-category"),subcategory:document.getElementById("edit-equipment-subcategory"),description:document.getElementById("edit-equipment-description"),quantity:document.getElementById("edit-equipment-quantity"),price:document.getElementById("edit-equipment-price"),image:document.getElementById("edit-equipment-image"),barcode:document.getElementById("edit-equipment-barcode"),status:document.getElementById("edit-equipment-status")}}function Yc(){const e=dp();return{category:e.category?.value??"",subcategory:e.subcategory?.value??"",description:e.description?.value??"",quantity:e.quantity?.value??"",price:e.price?.value??"",image:e.image?.value??"",barcode:e.barcode?.value??"",status:e.status?.value??""}}function up(e={}){const t=dp();t.category&&(t.category.value=e.category??""),t.subcategory&&(t.subcategory.value=e.subcategory??""),t.description&&(t.description.value=e.description??""),t.quantity&&(t.quantity.value=e.quantity!=null?b(String(e.quantity)):""),t.price&&(t.price.value=e.price!=null?b(String(e.price)):""),t.image&&(t.image.value=e.image??""),t.barcode&&(t.barcode.value=e.barcode??""),t.status&&(t.status.value=e.status??"")}function Ur(e){Dl=e;const t=dp(),n=document.getElementById("equipment-edit-cancel"),a=document.getElementById("save-equipment-changes"),s=document.getElementById("edit-equipment-form");if(s&&s.classList.toggle("equipment-details-form--editing",e),[t.category,t.subcategory,t.description,t.quantity,t.price,t.image].forEach(i=>{i&&(e?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"))}),n&&(n.hidden=!e,n.disabled=!e),a){a.disabled=!1;const i=e?"equipment.modal.actions.save":"equipment.modal.actions.edit",o=e?"💾 حفظ التعديلات":"✏️ تعديل";a.textContent=c(i,o),a.dataset.mode=e?"save":"view"}if(e){const i=t.description||t.category||t.subcategory;i&&setTimeout(()=>{i.focus(),typeof i.select=="function"&&i.select()},0)}}async function Sj(e){if(!St()){Nn();return}if(!e)return;try{await Ej()}catch(n){console.error("❌ [equipment.js] Unable to load XLSX",n),alert(c("equipment.toast.xlsxMissing","⚠️ مكتبة Excel (XLSX) غير محملة."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),s=XLSX.read(a,{type:"array"}),r=s.Sheets[s.SheetNames[0]],i=XLSX.utils.sheet_to_json(r,{defval:""});if(!Array.isArray(i)||i.length===0){I(c("equipment.toast.uploadEmpty","⚠️ لم يتم العثور على بيانات في الملف"));return}const o=[];let l=0;if(i.forEach(d=>{const u=d.القسم??d.category??"",m=d["القسم الثانوي"]??d.subcategory??"",p=d.الوصف??d.description??d.name??"",f=d.الكمية??d.quantity??0,h=d.السعر??d.price??0,g=d.الباركود??d.barcode??"",y=d.الحالة??d.status??"متاح",E=d.الصورة??d.image_url??d.image??"",S=b(String(g||"")).trim();if(!p||!S){l+=1;return}o.push(mp({category:u,subcategory:m,description:p,quantity:f,unit_price:h,barcode:S,status:y,image_url:E}))}),!o.length){I(c("equipment.toast.uploadEmpty","⚠️ لم يتم العثور على بيانات في الملف"));return}try{const d=await pe("/equipment/?bulk=1",{method:"POST",body:o}),u=Array.isArray(d?.data)?d.data.map(Bl):[];if(u.length){const f=[...hn(),...u];Ks(f)}await di({showToastOnError:!1}),jt();const m=d?.meta?.count??u.length,p=[];m&&p.push(`${m} ✔️`),l&&p.push(`${l} ⚠️`),I(c("equipment.toast.uploadSuccess","✅ تم رفع المعدات بنجاح")+(p.length?` (${p.join(" / ")})`:""))}catch(d){const u=ui(d,"equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل");I(u,"error")}}catch(a){console.error("❌ [equipment.js] Failed to process Excel file",a),I(c("equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل"),"error")}},t.onerror=function(){console.error("❌ [equipment.js] FileReader error",t.error),I(c("equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل"),"error")},t.readAsArrayBuffer(e)}const Aj="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let Ai=null;function Ej(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):Ai||(Ai=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",s,{once:!0}),n.addEventListener("error",r,{once:!0});return}const a=document.createElement("script");a.src=Aj,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",s,{once:!0}),a.addEventListener("error",r,{once:!0}),document.head.appendChild(a);function s(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function r(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("⚠️ [equipment.js] ensureXLSXLoaded failed",e),Ai=null,e}),Ai)}function mp({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:s=0,barcode:r="",status:i="متاح",image_url:o=""}){const l=b(String(r||"")).trim(),d=gj(i);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:_o(a),unit_price:Fl(s),barcode:l,status:d,image_url:o?.trim()||null}}async function Nb(){if(!St()){Nn();return}if(confirm(c("equipment.toast.clearConfirm","⚠️ هل أنت متأكد من حذف كل المعدات؟")))try{const t=(await pe("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await di({showToastOnError:!1}),I(c("equipment.toast.clearSuccess","🗑️ تم مسح جميع المعدات")+(t?` (${t})`:""))}catch(e){const t=ui(e,"equipment.toast.clearFailed","⚠️ تعذر حذف بعض المعدات");I(t,"error")}}function Hl(e){return e.image||e.imageUrl||e.img||""}function wj(e){const t=zt(e),n={available:{label:c("equipment.form.options.available","✅ متاح"),className:"equipment-status-badge equipment-status-badge--available"},reserved:{label:c("equipment.form.options.booked","📌 محجوز"),className:"equipment-status-badge equipment-status-badge--reserved"},maintenance:{label:c("equipment.form.options.maintenance","🛠️ صيانة"),className:"equipment-status-badge equipment-status-badge--maintenance"},retired:{label:c("equipment.form.options.retired","📦 خارج الخدمة"),className:"equipment-status-badge equipment-status-badge--retired"}},{label:a,className:s}=n[t]||{label:e||"-",className:"equipment-status-badge equipment-status-badge--default"};return`<span class="${s}">${a}</span>`}function Xc(){const e=document.getElementById("equipment-variants-section"),t=document.getElementById("equipment-variants-table-body"),n=document.getElementById("equipment-variants-count");if(e&&(e.hidden=!0),t){const a=c("equipment.modal.variants.empty","لا توجد قطع مرتبطة أخرى.");t.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${ht(a)}</td></tr>`}n&&(n.textContent="0")}function $b(e){const t=document.getElementById("equipment-variants-section"),n=document.getElementById("equipment-variants-table-body"),a=document.getElementById("equipment-variants-count");if(!t||!n||!e)return;const r=Es?.groupKey||Ya(e);if(!r){Xc();return}const i=hn().filter(m=>Ya(m)===r).sort((m,p)=>{const f=String(m.barcode||"").trim(),h=String(p.barcode||"").trim();return!f&&!h?0:f?h?f.localeCompare(h,"ar",{numeric:!0,sensitivity:"base"}):-1:1});if(!i.length){Xc();return}t.hidden=!1,a&&(a.textContent=String(i.length));const o=c("equipment.modal.variants.current","الحالي"),l=c("equipment.form.labels.quantity","الكمية"),d=hn(),u=i.map(m=>{const p=m.id&&e.id?String(m.id)===String(e.id):String(m.barcode||"")===String(e.barcode||""),f=p?"equipment-variants-table__row--current":"",h=ht(String(m.barcode||"-")),g=p?`<span class="equipment-variants-current-badge">${ht(o)}</span>`:"",y=b(String(Number.isFinite(Number(m.qty))?Number(m.qty):0)),E=d.indexOf(m),S=ht(c("equipment.item.actions.delete","🗑️ حذف")),x=E>=0?`<div class="table-action-buttons equipment-variant-actions">
            <button type="button" class="btn btn-sm btn-error equipment-variant-action equipment-variant-action--danger" data-variant-action="delete" data-variant-index="${E}">${S}</button>
          </div>`:"";return`
        <tr class="${f}">
          <td>
            ${h}
            ${g}
          </td>
          <td>${wj(m.status)}</td>
          <td>
            <span class="equipment-variants-qty" title="${ht(l)}">${y}</span>
          </td>
          <td class="table-actions-cell">${x}</td>
        </tr>
      `}).join("");n.innerHTML=u}function jj({item:e,index:t}){const n=Hl(e),a=c("equipment.item.actions.delete","🗑️ حذف"),s=c("equipment.item.imageAlt","صورة"),r=c("equipment.item.currency","SR"),i=St(),o={description:c("equipment.card.labels.description","الوصف"),status:c("equipment.card.labels.status","الحالة"),alias:c("equipment.card.labels.alias","الاسم"),quantity:c("equipment.card.labels.quantity","الكمية"),price:c("equipment.card.labels.price","السعر"),category:c("equipment.card.labels.category","القسم"),subcategory:c("equipment.card.labels.subcategory","القسم الثانوي"),barcode:c("equipment.card.labels.barcode","الباركود"),available:c("equipment.card.labels.available","متاح")},l=Number.isFinite(Number(e.qty))?Number(e.qty):0,d=Number.isFinite(Number(e.price))?Number(e.price):0,u=l.toLocaleString("en-US"),m=d.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),p=Number.isFinite(Number(e.reservedQty))?Number(e.reservedQty):0,f=Number.isFinite(Number(e.maintenanceQty))?Number(e.maintenanceQty):0,h=Number.isFinite(Number(e.availableQty))?Number(e.availableQty):Math.max(l-p-f,0),g=h.toLocaleString("en-US"),y=c("equipment.card.labels.availableOfTotal","من أصل"),E=zt(e.status);let S=`${ht(o.available)}: ${ht(g)} ${ht(y)} ${ht(u)}`,x="available";if(h===0){const V={reserved:{text:l===1?c("equipment.card.availability.reservedSingle","مؤجرة"):c("equipment.card.availability.reserved","مؤجرة بالكامل"),modifier:"reserved"},maintenance:{text:c("equipment.card.availability.maintenance","تحت الصيانة"),modifier:"maintenance"},retired:{text:c("equipment.card.availability.retired","غير متاحة"),modifier:"retired"},default:{text:c("equipment.card.availability.unavailable","غير متاحة حالياً"),modifier:"unavailable"}},G=V[E]||V.default;S=ht(G.text),x=G.modifier}const A=`<span class="equipment-card__availability equipment-card__availability--${x}">${S}</span>`,C="",j=e.desc||e.name||"—",k=e.name&&e.name!==e.desc?e.name:"",_=`
    <div class="equipment-card__info-row equipment-card__info-row--center">
      ${[{label:o.quantity,value:u},{label:o.price,value:`${m} ${r}`}].map(({label:V,value:G})=>`
            <span class="equipment-card__info-item equipment-card__info-item--stacked">
              <span class="equipment-card__detail-label">${V}</span>
              <span class="equipment-card__detail-value">${G}</span>
            </span>
          `).join("")}
    </div>`,$=[e.category?{label:o.category,value:e.category}:null,e.sub?{label:o.subcategory,value:e.sub}:null].filter(Boolean),q=$.length?`<div class="equipment-card__categories">${$.map(({label:V,value:G})=>`
            <div class="equipment-card__category">
              <span class="equipment-card__detail-label">${V}</span>
              <span class="equipment-card__detail-value">${G}</span>
            </div>
          `).join("")}</div>`:"",F=k?`<div class="equipment-card__alias">
        <span class="equipment-card__detail-label">${o.alias}</span>
        <span class="equipment-card__detail-value">${k}</span>
      </div>`:"",L=`
    <div class="equipment-card__details">
      ${`
    <div class="equipment-card__description">
      <span class="equipment-card__label">${o.description}</span>
      <h3 class="equipment-card__title">${j}</h3>
    </div>
  `}
      ${_}
    </div>
  `,B=[],D=bj(e),K=D?.availableBarcodes?.length?D.availableBarcodes.join(","):D?.barcode?D.barcode:"";let Z="",R="";if(D.active){const V=`equipment-select-qty-${t}`,G=!!D.canSelect,ie=G?Math.max(1,Number(D.maxQuantity||D.availableBarcodes?.length||1)):1,ee=Math.max(1,Math.min(ie,99)),oe=[];for(let ue=1;ue<=ee;ue+=1){const Pe=b(String(ue));oe.push(`<option value="${ue}"${ue===1?" selected":""}>${Pe}</option>`)}const W=G?"":" disabled",be=c("reservations.create.equipment.selector.quantityLabel","الكمية"),he=G?`${c("reservations.create.equipment.selector.availableHint","الوحدات المتاحة")}: ${b(String(ie))}`:D.reason?D.reason:"";Z=`
      <div class="equipment-card__selection-controls">
        <label class="equipment-card__selection-label" for="${V}">${be}</label>
        <select class="equipment-card__quantity-select" id="${V}" data-equipment-select-quantity${W}>
          ${oe.join("")}
        </select>
        ${he?`<span class="equipment-card__selection-hint">${ht(he)}</span>`:""}
      </div>
    `;const Se=c("reservations.create.equipment.selector.addToReservation","➕ أضف إلى الحجز"),we=G?"":" disabled",J=D.reason?` title="${ht(D.reason)}"`:"",re=['data-equipment-action="select-reservation"',`data-selection-max="${G?ie:0}"`];K&&re.push(`data-selection-barcodes="${ht(K)}"`),e.groupKey&&re.push(`data-selection-group="${ht(String(e.groupKey))}"`),R=`
      <button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--select" ${re.join(" ")}${we}${J}>${Se}</button>
    `}i&&B.push(`<button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--delete" data-equipment-action="delete" data-equipment-index="${t}">${a}</button>`);const M=B.length?B.join(`
`):"",H=ht(j);return`
    <article
      class="equipment-card"
      data-equipment-index="${t}"
      ${e.groupKey?`data-equipment-group-key="${ht(String(e.groupKey))}"`:""}
      data-equipment-card="true"
      role="listitem"
      tabindex="0"
      aria-label="${H}"
    >
      <div class="equipment-card__header">
      <div class="equipment-card__status-block">
        ${C}
        ${A}
      </div>
        <div class="equipment-card__media-wrapper">
          <div class="equipment-card__media" aria-hidden="true">
            ${n?`<img src="${n}" alt="${s}" loading="lazy">`:'<div class="equipment-card__placeholder">📦</div>'}
          </div>
          ${L}
        </div>
      </div>
      <div class="equipment-card__body">
        ${q}
        ${F}
      </div>
      ${Z||R||M?`<div class="equipment-card__actions equipment-card__actions--center">
            ${Z}
            ${R}
            ${M}
          </div>`:""}
    </article>
  `}function Ij(e){const t=[...new Set(e.map(i=>i.category).filter(Boolean))],n=[...new Set(e.map(i=>i.sub).filter(Boolean))],a=document.getElementById("filter-category"),s=document.getElementById("filter-sub");if(a){const i=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=o,a.appendChild(l)}),t.includes(i)&&(a.value=i),Tc(a)}if(s){const i=s.value;for(;s.options.length>1;)s.remove(1);n.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=o,s.appendChild(l)}),n.includes(i)&&(s.value=i),Tc(s)}const r=document.getElementById("filter-status");r&&Tc(r)}function li(){const e=ae();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return Ma=t||[],Ma;const s=new Date;let r=!1;const i=new Set((a||[]).filter(l=>l?.status==="open").map(l=>b(String(l?.equipmentBarcode??"")).trim().toLowerCase())),o=t.map(l=>{if(!l)return l;const d=zt(l.status),u=b(String(l.barcode??"")).trim().toLowerCase(),m=u&&i.has(u);let p=m?"maintenance":"available";if(!m&&u)for(const f of n||[]){if(!xj(f,s))continue;if(f.items?.some(g=>b(String(g?.barcode??"")).trim().toLowerCase()===u)){p="reserved";break}}return p!==d?(r=!0,{...l,status:p}):{...l,status:p}});return r?Ks(o):(Ma=o,an({equipment:Ma})),Ma}function xj(e,t){if(!e?.start||!e?.end)return!1;const n=new Date(e.start),a=new Date(e.end);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?!1:n<=t&&t<a}function Ad(e,{tone:t="",icon:n="📦"}={}){const a=["equipment-empty-state"];return t&&a.push(`equipment-empty-state--${t}`),`
    <div class="${a.join(" ")}">
      <div class="equipment-empty-state__icon" aria-hidden="true">${n}</div>
      <p class="equipment-empty-state__text">${e}</p>
    </div>
  `}function jt(){const e=document.getElementById("equipment-list");if(!e)return;Lb();const t=li(),n=Array.isArray(t)?t:hn(),a=new Map;n.forEach(g=>{if(!g)return;const y=Ya(g);y&&(a.has(y)||a.set(y,[]),a.get(y).push(g))});const s=Array.from(a.values()).map(g=>{const y=g[0],E=g.reduce((k,w)=>k+(Number.isFinite(Number(w.qty))?Number(w.qty):0),0),S=["maintenance","reserved","available","retired"],x=g.map(k=>zt(k.status)).sort((k,w)=>S.indexOf(k)-S.indexOf(w))[0]||"available",A=g.reduce((k,w)=>{const _=_o(w?.qty??0)||0,$=zt(w?.status);return $==="reserved"?k.reserved+=_:$==="maintenance"&&(k.maintenance+=_),k},{reserved:0,maintenance:0}),C=Math.max(E-A.reserved-A.maintenance,0);return{item:{...y,qty:E,status:x,variants:g,groupKey:Ya(y),reservedQty:A.reserved,maintenanceQty:A.maintenance,availableQty:C},index:n.indexOf(y)}});s.sort((g,y)=>yj(g.item,y.item));const r=document.getElementById("search-equipment")?.value||"",i=b(r).toLowerCase().trim(),o=document.getElementById("filter-category")?.value||"",l=document.getElementById("filter-sub")?.value||"",d=document.getElementById("filter-status")?.value||"",u=d?zt(d):"";if(yu&&!n.length){e.innerHTML=Ad(c("equipment.list.loading","⏳ جاري تحميل المعدات..."),{icon:"⏳"});return}if(Sr&&!n.length){e.innerHTML=Ad(Sr,{tone:"error",icon:"⚠️"});return}const m=s.filter(({item:g})=>{const y=b(String(g.barcode??"")).toLowerCase().trim(),E=Array.isArray(g.variants)?g.variants.map(j=>b(String(j.barcode??"")).toLowerCase().trim()).filter(Boolean):[],S=!i||g.name&&g.name.toLowerCase().includes(i)||g.desc&&g.desc.toLowerCase().includes(i)||y&&y.includes(i)||E.some(j=>j.includes(i))||g.category&&g.category.toLowerCase().includes(i)||g.sub&&g.sub.toLowerCase().includes(i),x=!o||g.category===o,A=!l||g.sub===l,C=!u||zt(g.status)===u;return S&&x&&A&&C}),p=i?c("equipment.list.emptyFiltered","⚠️ لا توجد معدات مطابقة."):c("equipment.list.empty","لا توجد معدات مسجلة بعد."),f=m;e.innerHTML=f.length?f.map(jj).join(""):Ad(p);const h=document.getElementById("equipment-list-count");if(h){const g=c("equipment.list.countSuffix","عنصر"),y=b(String(f.length)),E=f.length?`${y} ${g}`:`0 ${g}`;h.textContent=E}Ij(n)}async function di({showToastOnError:e=!0}={}){yu=!0,Sr="",jt();try{const t=await pe("/equipment/?all=1"),n=t?.data??t;let a=[];Array.isArray(n)?a=n:n&&typeof n=="object"&&(Array.isArray(n.items)?a=n.items:Array.isArray(n.results)?a=n.results:Array.isArray(n.data)?a=n.data:Array.isArray(n.records)&&(a=n.records));const s=a.map(Bl);Ks(s)}catch(t){t&&typeof t=="object"&&Number(t.status)===401?Sr="":(Sr=ui(t,"equipment.toast.fetchFailed","تعذر تحميل قائمة المعدات"),e&&I(Sr,"error"))}finally{yu=!1,jt()}}function ui(e,t,n){if(e instanceof Ge){const a=e.payload?.errors;if(a&&typeof a=="object"){const s=Object.values(a)[0];if(Array.isArray(s))return s[0];if(typeof s=="string")return s}if(e.message)return e.message}return c(t,n)}async function qj(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",s=b(a).trim(),r=Fl(t.querySelector("#new-equipment-price")?.value||"0"),i=_o(t.querySelector("#new-equipment-qty")?.value||"1"),o=t.querySelector("#new-equipment-image")?.value?.trim()||"",l=t.querySelector("#new-equipment-category")?.value?.trim()||"",d=t.querySelector("#new-equipment-sub")?.value?.trim()||"",u=t.querySelector("#new-equipment-status")?.value||"متاح";if(!n||!s){I(c("equipment.toast.missingFields","⚠️ يرجى إدخال الوصف والباركود"));return}const m=mp({category:l,subcategory:d,description:n,quantity:i,unit_price:r,barcode:s,status:u,image_url:o});try{const p=await pe("/equipment/",{method:"POST",body:m}),f=Bl(p?.data),h=[...hn(),f];Ks(h),jt(),t.reset();const g=t.querySelector("#new-equipment-status");g&&(g.value="متاح"),I(c("equipment.toast.addSuccess","✅ تم إضافة المعدة"))}catch(p){const f=ui(p,"equipment.toast.addFailed","تعذر إضافة المعدة");I(f,"error")}}async function Db(e){if(!St()){Nn();return}const t=hn(),n=t[e];if(n&&confirm(c("equipment.toast.deleteConfirm","❌ هل أنت متأكد من حذف هذه المعدة؟")))try{n.id&&await pe(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),Ks(a),jt(),I(c("equipment.toast.deleteSuccess","🗑️ تم حذف المعدة"))}catch(a){const s=ui(a,"equipment.toast.deleteFailed","تعذر حذف المعدة، يرجى المحاولة مجدداً");I(s,"error")}}async function kj(e,t){const n=hn(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const r=[...n];r[e]={...r[e],...t},Ks(r),jt();return}const s=mp({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image});try{const r=await pe(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:s}),i=Bl(r?.data),o=[...n];o[e]=i,Ks(o),jt(),I(c("equipment.toast.updateSuccess","✅ تم تحديث بيانات المعدة بنجاح"))}catch(r){const i=ui(r,"equipment.toast.updateFailed","تعذر تحديث بيانات المعدة");throw I(i,"error"),r}}function ec(){jt()}function Bb(e){const n=hn()[e];if(!n)return;Us=e;const a=Rl(n),s=a[0]||n,r=a.reduce((l,d)=>l+(Number.isFinite(Number(d.qty))?Number(d.qty):0),0),i=["maintenance","reserved","available","retired"],o=a.map(l=>zt(l.status)).sort((l,d)=>i.indexOf(l)-i.indexOf(d))[0]||zt(s.status);document.getElementById("edit-equipment-index").value=e,up({category:s.category||"",subcategory:s.sub||"",description:s.desc||s.description||"",quantity:String(r||s.qty||0),price:s.price!=null?String(s.price):"0",image:Hl(s)||"",barcode:s.barcode||"",status:s.status||o}),Ur(!1),Vs=Yc(),Ml(s),$b(s),Es={groupKey:Ya(s),barcode:String(s.barcode||""),id:s.id||null},uj(document.getElementById("editEquipmentModal"))?.show()}function _j(e){const t=e.target.closest('[data-equipment-action="select-reservation"]');if(t){e.preventDefault(),e.stopPropagation();const s=t.closest('[data-equipment-card="true"]'),r=s?.querySelector("[data-equipment-select-quantity]");let i=Number.parseInt(r?.value||"1",10);(!Number.isFinite(i)||i<=0)&&(i=1);const o=Number.parseInt(t.dataset.selectionMax||"0",10);Number.isFinite(o)&&o>0&&i>o&&(i=o);const d=(t.dataset.selectionBarcodes||"").split(",").map(f=>f.trim()).filter(f=>f.length>0),u=s?.querySelector(".equipment-card__title")?.textContent?.trim()||"",m=s?.dataset.equipmentGroupKey||t.dataset.selectionGroup||"";sj({barcodes:d,quantity:i,groupKey:m,description:u})||I(c("reservations.create.equipment.selector.selectionInactive","⚠️ يرجى العودة إلى نموذج الحجز وتفعيل اختيار المعدات من جديد"));return}if(e.target.closest("[data-equipment-select-quantity]")||e.target.closest(".equipment-card__selection-controls"))return;const n=e.target.closest('[data-equipment-action="delete"]');if(n){e.preventDefault(),e.stopPropagation();const s=Number(n.dataset.equipmentIndex);Number.isNaN(s)||Db(s).catch(r=>{console.error("❌ [equipment.js] deleteEquipment",r)});return}const a=e.target.closest('[data-equipment-card="true"]');if(a){const s=Number(a.dataset.equipmentIndex);Number.isNaN(s)||Bb(s)}}function Tj(e){if(e.defaultPrevented||e.target.closest("[data-equipment-action]")||e.target.matches("[data-equipment-select-quantity]")||e.target.closest(".equipment-card__selection-controls"))return;const t=e.target.closest('[data-equipment-card="true"]');if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const n=Number(t.dataset.equipmentIndex);Number.isNaN(n)||Bb(n)}}function Cj(e){const t=e.target.closest('[data-variant-action="delete"]');if(t){const n=Number(t.dataset.variantIndex);Number.isNaN(n)||Db(n).catch(a=>{console.error("❌ [equipment.js] deleteEquipment",a)});return}}function Fb(){if(!Es||!document.getElementById("editEquipmentModal")?.classList.contains("show"))return;const n=hn(),a=Es.id?n.find(l=>String(l.id)===String(Es.id)):null,s=Es.groupKey,r=s?n.find(l=>Ya(l)===s):null,i=a||r;if(!i){Xc();return}const o=n.findIndex(l=>l===i);if(o>=0){const l=document.getElementById("edit-equipment-index");l&&(l.value=String(o)),Us=o}if($b(i),!Dl){const l=Rl(i),d=l[0]||i,u=l.reduce((f,h)=>f+(Number.isFinite(Number(h.qty))?Number(h.qty):0),0),m=["maintenance","reserved","available","retired"],p=l.map(f=>zt(f.status)).sort((f,h)=>m.indexOf(f)-m.indexOf(h))[0]||zt(d.status);up({category:d.category||"",subcategory:d.sub||"",description:d.desc||d.description||"",quantity:String(u||d.qty||0),price:d.price!=null?String(d.price):"0",image:Hl(d)||"",barcode:d.barcode||"",status:d.status||p}),Vs=Yc()}Ml(primary)}function Pj(){document.getElementById("search-equipment")?.addEventListener("input",ec),document.getElementById("filter-category")?.addEventListener("change",ec),document.getElementById("filter-sub")?.addEventListener("change",ec),document.getElementById("filter-status")?.addEventListener("change",ec),document.getElementById("add-equipment-form")?.addEventListener("submit",qj);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",a=>{a.preventDefault(),Nb().catch(s=>{console.error("❌ [equipment.js] clearEquipment",s)})}),e.dataset.listenerAttached="true");const t=document.getElementById("equipment-list");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",_j),t.addEventListener("keydown",Tj),t.dataset.listenerAttached="true");const n=document.getElementById("equipment-variants-table-body");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Cj),n.dataset.listenerAttached="true"),["edit-equipment-quantity","edit-equipment-price","edit-equipment-barcode"].forEach(a=>{const s=document.getElementById(a);hj(s)})}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{if(!Dl){Vs=Yc(),Ur(!0);return}const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){I(c("equipment.toast.updateFailed","تعذر تحديث بيانات المعدة"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:_o(document.getElementById("edit-equipment-quantity").value)||1,price:Fl(document.getElementById("edit-equipment-price").value)||0,barcode:b(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value};try{await kj(t,n),Vs=Yc(),Ur(!1),Fb()}catch(a){console.error("❌ [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{Pj(),jt(),di();const e=document.getElementById("equipment-edit-cancel");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{if(Vs&&up(Vs),Us!=null){const a=hn()[Us];if(a){const r=Rl(a)[0]||a;Ml(r)}}Ur(!1)}),e.dataset.listenerAttached="true");const t=document.getElementById("save-equipment-changes");t&&!t.dataset.listenerAttached&&(t.dataset.listenerAttached="true",t.dataset.mode||(t.dataset.mode="view"))});document.addEventListener("language:changed",()=>{if(jt(),Ur(Dl),Us!=null){const t=hn()[Us];if(t){const a=Rl(t)[0]||t;Ml(a)}}});document.addEventListener("equipment:refreshRequested",()=>{di({showToastOnError:!1})});document.addEventListener(ei.USER_UPDATED,()=>{jt()});document.addEventListener("equipment:changed",()=>{Fb()});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editEquipmentModal");e&&!e.dataset.variantsListenerAttached&&(e.addEventListener("hidden.bs.modal",()=>{Es=null,Xc(),Us=null,Vs=null,Ur(!1)}),e.dataset.variantsListenerAttached="true")});typeof document<"u"&&!hh&&(document.addEventListener(Ga.change,()=>{Lb(),jt()}),hh=!0);const xL=Object.freeze(Object.defineProperty({__proto__:null,clearEquipment:Nb,refreshEquipmentFromApi:di,renderEquipment:jt,syncEquipmentStatuses:li,uploadEquipmentFromExcel:Sj},Symbol.toStringTag,{value:"Module"})),Lj="__DEBUG_CREW__";function Nj(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Lj);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function gh(e,t){if(Nj())try{console.log(`🪵 [crew-debug:create] ${e}`,t)}catch{}}const Rb="projects:create:draft",Mb="projects.html#projects-section";let bu=null,Hb=[],vu=new Map,Su=new Map,Jc=new Map,Ed=!1,Pc=null,bh=!1,zb=[];function $j(e){if(!e)return null;let t=zb.find(a=>a.id===e)||null;if(t)return t;const n=Gi(e);return n?(t={id:e,name:zg(n)||e,price:Hg(n),items:qn(n),raw:n},t):null}function Zc(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function el(e){return b(String(e||"")).trim().toLowerCase()}function Dj(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=b(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function Ob(e){const t=b(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Ub(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Vb(e){if(!e)return null;const t=b(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Kb(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=b(String(t))}}function Ws(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","⚠️ هذه المعدة قيد الصيانة ولا يمكن إضافتها حالياً");case"reserved":return c("reservations.toast.equipmentReserved","⚠️ هذه المعدة محجوزة حالياً ولا يمكن إضافتها");case"retired":return c("reservations.toast.equipmentRetired","⚠️ هذه المعدة خارج الخدمة حالياً");default:return c("reservations.toast.equipmentUnavailable","⚠️ هذه المعدة غير متاحة حالياً")}}function pp(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function nr(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function on(){const{input:e,hidden:t}=nr();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function us(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const r=document.querySelector(`label[for="${e.id}"]`);r&&n.add(r)}const s=r=>{t()&&I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error")};n.forEach(r=>{!r||r.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{r.addEventListener(i,s,{capture:!0})}),r.dataset.linkedGuardAttached="true")})}function Wb(e,t,{allowPartial:n=!1}={}){const a=et(t);if(!a)return null;const s=e.get(a);if(s)return s;if(!n)return null;const r=[];return e.forEach((i,o)=>{o.includes(a)&&r.push(i)}),r.length===1?r[0]:null}function Au(e,t={}){return Wb(vu,e,t)}function Eu(e,t={}){return Wb(Su,e,t)}function mn(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Qb(e){Hb=Array.isArray(e)?[...e]:[]}function fp(){return Hb}function hp(e){return e&&fp().find(t=>String(t.id)===String(e))||null}function vh(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","مشروع بدون اسم")}function Vr(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??Fe,a=b(String(n).replace("%","").trim()),s=parseFloat(a);return Number.isFinite(s)?s:Fe}function Pn(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??Fe,a=b(String(n).replace("%","").trim()),s=parseFloat(a);(!Number.isFinite(s)||s<=0)&&(s=Fe),t.dataset.companyShare=String(s),t.checked=!0}function wu(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(Ed){He();return}Ed=!0;const a=()=>{Ed=!1,He()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(Fe)),t.disabled){n.checked=!1,I(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة")),a();return}t.checked||(t.checked=!0),Pn()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Pn():n.checked&&(n.checked=!1));a()}function Bj(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function Sh(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const s=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${s}`}return""}function Ah(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function ga({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:s}=pp();if(!n||!a||!s)return;const r=Fm()||[],i=c("reservations.create.placeholders.client","اختر عميلًا (اختياري)"),o=c("customers.fallback.unnamed","عميل بدون اسم");n.setAttribute("placeholder",i);const l=new Set;vu=new Map;const d=r.filter(f=>f&&f.id!=null).map(f=>({id:String(f.id),label:Ah(f)||o})).filter(f=>{if(!f.label)return!1;const h=et(f.label);return!h||l.has(h)?!1:(l.add(h),vu.set(h,f),!0)}).sort((f,h)=>f.label.localeCompare(h.label,void 0,{sensitivity:"base"}));s.innerHTML=d.map(f=>`<option value="${Zc(f.label)}"></option>`).join("");const u=t?"":n.value,m=e?String(e):a.value?String(a.value):"",p=m?r.find(f=>String(f.id)===m):null;if(p){const f=Ah(p)||o;a.value=String(p.id),n.value=f,n.dataset.selectedId=String(p.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":u}function Kr({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:s,list:r}=nr();if(!a||!s||!r)return;const i=Array.isArray(t)?t:fp()||[],o=c("reservations.create.placeholders.project","اختر مشروعاً (اختياري)");a.setAttribute("placeholder",o);const l=[...i].filter(g=>g&&g.id!=null).sort((g,y)=>String(y.createdAt||y.start||"").localeCompare(String(g.createdAt||g.start||""))),d=n?"":a.value,u=c("projects.fallback.untitled","مشروع بدون اسم"),m=new Set;Su=new Map;const p=l.map(g=>{const y=vh(g)||u;return{id:String(g.id),label:y}}).filter(g=>{if(!g.label)return!1;const y=et(g.label);return!y||m.has(y)?!1:(m.add(y),Su.set(y,g),!0)});r.innerHTML=p.map(g=>`<option value="${Zc(g.label)}"></option>`).join("");const f=e?String(e):s.value?String(s.value):"",h=f?l.find(g=>String(g.id)===f):null;if(h){const g=vh(h)||u;s.value=String(h.id),a.value=g,a.dataset.selectedId=String(h.id)}else s.value="",a.dataset.selectedId="",a.value=n?"":d}function tl(e,t,n){const{date:a,time:s}=Gg(n),r=document.getElementById(e),i=document.getElementById(t);if(r){if(a)if(r._flatpickr){const o=r._flatpickr.config?.dateFormat||"Y-m-d";r._flatpickr.setDate(a,!1,o)}else r.value=a;else r._flatpickr?r._flatpickr.clear():r.value="";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(s)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(s,!1,o)}else i.value=s;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function Gb(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||Kr({selectedValue:a});const r=(Fm()||[]).find(u=>String(u.id)===String(e.clientId)),i=r?.id!=null?String(r.id):"";ga(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=Sh(e,"start"),l=Sh(e,"end");o&&tl("res-start","res-start-time",o),l&&tl("res-end","res-end-time",l);const d=document.getElementById("res-notes");d&&e.description&&(t||!d.value)&&(d.value=e.description),He(),Xa()}function Yb({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:ae(),s=Array.isArray(a)?a:[];Qb(s);const r=t!=null?String(t):n.value?String(n.value):"";Kr({selectedValue:r,projectsList:s}),Xa(),He()}function Xa(){const{input:e,hidden:t}=nr(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),s=document.getElementById("res-payment-status"),r=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),l=document.getElementById("res-discount-type"),d=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),m=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(us(n,on),a&&us(a,on)),s&&us(s,on),r&&us(r,on),i&&us(i,on),o&&us(o,on),l&&us(l,on),m)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=d),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=d),s&&(s.value="unpaid",mn(s,"unpaid"),s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=d),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=d),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=d),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=d),l&&(l.value="percent",l.disabled=!0,l.classList.add("reservation-input-disabled"),l.title=d);else{if(n){const p=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",p&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),l&&(l.disabled=!1,l.classList.remove("reservation-input-disabled"),l.title="")}wu("tax"),He()}function yp(){const{input:e,hidden:t}=nr();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Eu(s,{allowPartial:a}):null;if(r){t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id);const i=hp(r.id);i?Gb(i,{skipProjectSelectUpdate:!0}):(Xa(),He())}else t.value="",e.dataset.selectedId="",Xa(),He()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Eu(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function gp(){const{input:e,hidden:t}=pp();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Au(s,{allowPartial:a}):null;r?(t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id)):(t.value="",e.dataset.selectedId=""),He()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Au(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Fj(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){Fi({clearValue:!0});return}let n=null;try{const d=decodeURIComponent(t);n=JSON.parse(d)}catch(d){console.warn("⚠️ [reservations/createForm] Failed to decode project context",d)}e.delete("reservationProjectContext");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,s),Fi({clearValue:!1}),!n)return;n.fromProjectForm&&(Pc={draftStorageKey:n.draftStorageKey||Rb,returnUrl:n.returnUrl||Mb});const r=document.getElementById("res-project");if(n.projectId){r&&(Kr({selectedValue:String(n.projectId)}),Xa());const d=hp(n.projectId);d?Gb(d,{forceNotes:!!n.forceNotes}):He(),Fi()}else{r&&Kr({selectedValue:""});const d=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","سيتم الربط بعد حفظ المشروع الحالي");Zj(c("reservations.create.project.pendingTooltip","سيتم تفعيل اختيار المشروع بعد حفظ المشروع الحالي"),d)}n.start&&tl("res-start","res-start-time",n.start),n.end&&tl("res-end","res-end-time",n.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(n.customerId){const u=(Fm()||[]).find(m=>String(m.id)===String(n.customerId));u?.id!=null&&(ga({selectedValue:String(u.id)}),o&&(o.value=String(u.id)),i&&(i.value=u.customerName||u.name||i.value))}else n.customerName&&i?(ga({selectedValue:""}),i.value=n.customerName,i.dataset.selectedId="",o&&(o.value="")):ga({selectedValue:""});const l=document.getElementById("res-notes");l&&n.description&&!l.value&&(l.value=n.description),He()}function ar(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:ca(e,n),end:ca(t,a)}}function Xb(e){const t=el(e);if(t){const o=Jc.get(t);if(o)return o}const{description:n,barcode:a}=Ob(e);if(a){const o=$l(a);if(o)return o}const s=et(n||e);if(!s)return null;let r=Wg();if(!r?.length){const o=ae();r=Array.isArray(o?.equipment)?o.equipment:[],r.length&&Qg(r)}const i=r.find(o=>et(o?.desc||o?.description||"")===s);return i||r.find(o=>et(o?.desc||o?.description||"").includes(s))||null}function Jb(e,t="equipment-description-options"){const n=el(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(l=>el(l.value)===n)||Jc.has(n))return!0;const{description:s}=Ob(e);if(!s)return!1;const r=et(s);return r?(Wg()||[]).some(o=>et(o?.desc||o?.description||"")===r):!1}const Rj={available:0,reserved:1,maintenance:2,retired:3};function Mj(e){return Rj[e]??5}function Eh(e){switch(e){case"available":return c("reservations.equipment.status.available","متاح");case"reserved":return c("reservations.equipment.status.reserved","محجوز");case"maintenance":return c("reservations.equipment.status.maintenance","صيانة");case"retired":return c("reservations.equipment.status.retired","خارج الخدمة");default:return c("reservations.equipment.status.unknown","الحالة غير معروفة")}}function Hj(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(s=>s!=="available")||e.bestStatus;if(n==="available")return`${t} — ${Eh(n)}`;const a=c("reservations.equipment.status.unavailable","غير متاح");return`${t} — ${a} (${Eh(n)})`}function Ja(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=li(),a=ae(),s=Array.isArray(n)&&n.length?n:a?.equipment||[],r=Array.isArray(s)?s:[];Qg(r);const i=new Map;r.forEach(d=>{const u=Dj(d),m=el(u);if(!m||!u)return;const p=ja(d),f=Mj(p),h=i.get(m);if(!h){i.set(m,{normalized:m,value:u,bestItem:d,bestStatus:p,bestPriority:f,statuses:new Set([p])});return}h.statuses.add(p),f<h.bestPriority&&(h.bestItem=d,h.bestStatus=p,h.bestPriority=f,h.value=u)}),Jc=new Map;const l=Array.from(i.values()).sort((d,u)=>d.value.localeCompare(u.value,"ar",{sensitivity:"base"})).map(d=>{Jc.set(d.normalized,d.bestItem);const u=Hj(d),m=Zc(d.value);if(u===d.value)return`<option value="${m}"></option>`;const p=Zc(u);return`<option value="${m}" label="${p}"></option>`}).join("");e&&(e.innerHTML=l),t&&(t.innerHTML=l)}function Zb(e,t,n={}){const{silent:a=!1}=n,s=ve(e);if(!s)return{success:!1,message:null};const{start:r,end:i}=ar();if(!r||!i){const h=c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات");return a||I(h),{success:!1,message:h}}const o=Yn();if(bp(o).has(s)){const h=c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز");return a||I(h),{success:!1,message:h}}const d=Rm(s,r,i);if(d.length){const h=d.map(y=>y.name).join(", "),g=c("reservations.toast.equipmentBlockedByPackage",`⚠️ لا يمكن إضافة هذه المعدة لأنها جزء من حزمة محجوزة: ${h}`);return a||I(g),{success:!1,message:g}}if(Xn(s,r,i)){const h=c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية");return a||I(h),{success:!1,message:h}}const u=$l(s);if(!u){const h=c("reservations.toast.barcodeNotFound","❌ الباركود غير موجود");return a||I(h),{success:!1,message:h}}const m=ja(u);if(m==="maintenance"||m==="retired"){const h=Ws(m);return a||I(h),{success:!1,message:h}}const p=ns(u);if(!p){const h=c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف");return a||I(h),{success:!1,message:h}}Cl({id:p,equipmentId:p,barcode:s,desc:u.desc,qty:1,price:u.price,image:tr(u)}),t&&(t.value=""),qa(),He();const f=c("reservations.toast.equipmentAdded","✅ تم إضافة المعدة بنجاح");return a||I(f),{success:!0,message:f,barcode:s}}function ju(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Xb(t);if(!n){I(c("reservations.toast.equipmentNameNotFound","❌ لم يتم العثور على معدة بالاسم المدخل"));return}const a=lj(n.barcode),s=ja(a||n);if(s==="maintenance"||s==="retired"){I(Ws(s));return}const r=ve(n.barcode);if(!r){I(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const i=ns(n);if(!i){I(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const o={id:i,equipmentId:i,barcode:r,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,image:tr(n)},{start:l,end:d}=ar();if(!l||!d){I(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const u=Yn();if(bp(u).has(r)){I(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const p=Rm(r,l,d);if(p.length){const f=p.map(h=>h.name).join(", ");I(c("reservations.toast.equipmentBlockedByPackage",`⚠️ لا يمكن إضافة هذه المعدة لأنها جزء من حزمة محجوزة: ${f}`));return}if(Xn(r,l,d)){I(c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية"));return}Cl(o),qa(),He(),I(c("reservations.toast.equipmentAdded","✅ تم إضافة المعدة بنجاح")),e.value=""}function zj(){Ja();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),ju(e))});const t=()=>{Jb(e.value,"equipment-description-options")&&ju(e)};e.addEventListener("focus",()=>{if(Ja(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function wh(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function bp(e=Yn()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=ve(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(s=>{const r=ve(s?.normalizedBarcode??s?.barcode);r&&t.add(r)})}),t}function Oj(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=ar();if(!t||!n){I(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}Cb({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):I(c("reservations.toast.equipmentTabUnavailable","⚠️ تعذر فتح تبويب المعدات حالياً"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(Ga.change,t=>{wh(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),wh(e,Pb()))}function Uj(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],s=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=a.length?a:t.barcode?[t.barcode]:[];if(!r.length)return;let i=0,o=null;const l=[],d=new Set;r.forEach(m=>{const p=ve(m);p&&!d.has(p)&&(d.add(p),l.push(p))});const u=Math.min(s,l.length);for(let m=0;m<u;m+=1){const p=l[m],f=Zb(p,null,{silent:!0});f.success&&(i+=1),f.message&&(o=f.message)}if(i>0){const p=c("reservations.toast.equipmentAddedBulk","✅ تم إضافة {count} معدة إلى الحجز").replace("{count}",b(String(i)));I(p)}else o&&I(o)}function ev(){Oj(),!(bh||typeof document>"u")&&(document.addEventListener(Ga.requestAdd,Uj),bh=!0)}function To(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),s=document.getElementById("reservation-package-hint"),r=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:s,packageAddButton:r}}function Iu(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:s}=To();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const r=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=t==="package";r&&(r.disabled=o),i&&(i.disabled=o),s&&(s.disabled=t!=="package"||s.options.length===0),M0(t),t==="package"&&zl()}function zl(){const{packageSelect:e,packageHint:t}=To();if(!e)return;const n=Bm();zb=n,n.map(o=>o.raw??o);const a=c("reservations.create.summary.currency","SR"),s=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","اختر الحزمة")}</option>`,r=n.map(o=>{const l=Number.isFinite(Number(o.price))?Number(o.price):0,d=b(l.toFixed(2)),u=`${o.name} — ${d} ${a}`;return`<option value="${o.id}">${u}</option>`}).join("");e.innerHTML=`${s}${r}`,e.selectedIndex=0;const i=n.length>0;e.disabled=!i,t&&(i?(t.textContent=c("reservations.create.packages.hint","سيتم إضافة الحزمة مباشرة بمجرد اختيارها."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","لا توجد حزم معرفة حالياً. يمكنك إضافتها لاحقاً من لوحة التحكم."),t.dataset.state="empty")),av()}function Vj(e,t){const n=e?.name||c("reservations.create.packages.genericName","الحزمة"),a=c("reservations.toast.packageItemsConflict",`⚠️ لا يمكن إضافة ${n} لأن العناصر التالية غير متاحة:`),s=t.map(({item:r,blockingPackages:i})=>{const o=r?.desc||b(String(r?.barcode??r?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","عنصر بدون اسم");if(Array.isArray(i)&&i.length){const l=i.map(d=>d.name).join(", ");return`• ${o} (${c("reservations.create.packages.blockedByPackage","محجوز ضمن الحزم")}: ${l})`}return`• ${o} (${c("reservations.create.packages.blockedDirect","محجوز في الفترة المختارة")})`});return[a,...s].join(`
`)}function tv(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:s=null}={}){const r=kt(e);if(!r)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")};const i=$j(r);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","⚠️ تعذر العثور على بيانات الحزمة المحددة")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات")};if(t.some(f=>f?.type==="package"&&kt(f.packageId)===r))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","⚠️ هذه الحزمة مضافة بالفعل إلى الحجز")};if(Yg(r,n,a,s)){const f=i.name||r;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`⚠️ الحزمة ${f} محجوزة بالفعل في الفترة المختارة`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:qn(i.raw??{}),l=bp(t),d=[],u=new Set;if(o.forEach(f=>{const h=ve(f?.normalizedBarcode??f?.barcode);if(h){if(u.has(h)){d.push({item:f,type:"internal"});return}u.add(h),l.has(h)&&d.push({item:f,type:"external"})}}),d.length){const f=d.map(({item:g})=>g?.desc||g?.description||g?.name||g?.barcode||g?.normalizedBarcode||c("equipment.packages.items.unknown","معدة بدون اسم")).map(g=>b(String(g))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:d.some(g=>g.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","⚠️ لا يمكن إضافة الحزمة لأن العناصر التالية موجودة مسبقاً في الحجز: {items}").replace("{items}",f):c("reservations.toast.packageDuplicateEquipmentInternal","⚠️ بيانات الحزمة تحتوي على عناصر مكررة: {items}").replace("{items}",f),duplicates:d}}const m=[];return o.forEach(f=>{const h=ve(f?.normalizedBarcode??f?.barcode);if(h&&Xn(h,n,a,s)){const g=Rm(h,n,a,s);m.push({item:f,blockingPackages:g})}}),m.length?{success:!1,reason:"item_conflict",message:Vj(i,m),conflicts:m}:{success:!0,package:{id:`package::${r}`,packageId:r,type:"package",desc:i.name||`Package ${r}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,barcode:i.code||i.raw?.package_code||`pkg-${r}`,packageItems:o.map(f=>({equipmentId:f?.equipmentId??null,barcode:f?.barcode??f?.normalizedBarcode??"",normalizedBarcode:ve(f?.normalizedBarcode??f?.barcode),desc:f?.desc??"",qty:Number.isFinite(Number(f?.qty))?Number(f.qty):1,price:Number.isFinite(Number(f?.price))?Number(f.price):0})),image:o.find(f=>f?.image)?.image??null},packageInfo:i}}function nv(e,{silent:t=!1}={}){const n=kt(e);if(!n)return t||I(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),{success:!1,reason:"invalid"};const{start:a,end:s}=ar(),r=Yn(),i=tv(n,{existingItems:r,start:a,end:s});if(!i.success){if(!t){const l={invalid:c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً"),not_found:c("reservations.toast.packageNotFound","⚠️ تعذر العثور على بيانات الحزمة المحددة"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"),duplicate:c("reservations.toast.packageDuplicate","⚠️ هذه الحزمة مضافة بالفعل إلى الحجز")}[i.reason]||c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً");I(i.message||l)}return i}return Cl(i.package),qa(),He(),t||I(c("reservations.toast.packageAdded","✅ تم إضافة الحزمة بنجاح")),{success:!0,package:i.package}}function av(){const{packageSelect:e}=To();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;nv(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Kj(){const{packageAddButton:e,packageSelect:t}=To();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){I(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً"));return}nv(n)}),e.dataset.listenerAttached="true")}function sv(){const{modeRadios:e}=To();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",s=>{s.target.checked&&Iu(s.target.value)}),a.dataset.listenerAttached="true")}),Kj(),av();const t=Hc(),n=e.find(a=>a.value===t);n&&(n.checked=!0),Iu(t)}function qa(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=Yn(),a=c("reservations.create.equipment.noneAdded","لا توجد معدات مضافة"),s=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","صورة"),i=c("reservations.equipment.actions.increase","زيادة الكمية"),o=c("reservations.equipment.actions.decrease","تقليل الكمية"),l=c("reservations.equipment.actions.remove","إزالة البند");if(n.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${a}</td></tr>`;return}const d=Xs(n);t.innerHTML=d.map(u=>{const m=u.items[0]||{},p=tr(m)||u.image,f=p?`<img src="${p}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',h=b(String(u.count)),g=Number.isFinite(Number(u.unitPrice))?Number(u.unitPrice):0,y=Number.isFinite(Number(u.totalPrice))?Number(u.totalPrice):g*u.count,E=`${b(g.toFixed(2))} ${s}`,S=`${b(y.toFixed(2))} ${s}`,x=u.items.some(k=>k?.type==="package"),A=u.barcodes.map(k=>b(String(k||""))).filter(Boolean),C=A.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
            <ul class="reservation-barcode-list">
              ${A.map(k=>`<li>${k}</li>`).join("")}
            </ul>
          </details>`:"";let j="";if(x){const k=new Map;if(u.items.forEach(w=>{Array.isArray(w?.packageItems)&&w.packageItems.forEach(_=>{if(!_)return;const $=ve(_.barcode||_.desc||Math.random()),q=k.get($);if(q){q.qty+=Number.isFinite(Number(_.qty))?Number(_.qty):1;return}k.set($,{desc:_.desc||_.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:Number.isFinite(Number(_.qty))?Number(_.qty):1,barcode:_.barcode??_.normalizedBarcode??""})})}),k.size){const w=Array.from(k.values()).map(_=>{const $=b(String(_.qty)),q=_.desc||b(String(_.barcode||"")),F=_.barcode?` <span class="reservation-package-items__barcode">(${b(String(_.barcode))})</span>`:"";return`<li>${q}${F} × ${$}</li>`}).join("");j=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
              <ul class="reservation-package-items__list">
                ${w}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${f}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${x?`${j||""}${C||""}`:C}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${u.key}" aria-label="${o}" ${x?"disabled":""}>−</button>
              <span class="reservation-qty-value">${h}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${u.key}" aria-label="${i}" ${x?"disabled":""}>+</button>
            </div>
          </td>
          <td>${E}</td>
          <td>${S}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${u.key}" aria-label="${l}">🗑️</button>
          </td>
        </tr>
      `}).join("")}function Wj(e){const t=Yn(),a=Xs(t).find(r=>r.key===e);if(!a)return;const s=a.itemIndices[a.itemIndices.length-1];s!=null&&(F0(s),qa(),He())}function Qj(e){const t=Yn(),n=t.filter(a=>wo(a)!==e);n.length!==t.length&&(Kg(n),qa(),He())}function Gj(e){const t=Yn(),a=Xs(t).find(m=>m.key===e);if(!a)return;const{start:s,end:r}=ar();if(!s||!r){I(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const i=new Set(t.map(m=>ve(m.barcode))),{equipment:o=[]}=ae(),l=(o||[]).find(m=>{const p=ve(m?.barcode);return!p||i.has(p)||wo({desc:m?.desc||m?.description||m?.name||"",price:Number(m?.price)||0})!==e||!cp(m)?!1:!Xn(p,s,r)});if(!l){I(c("reservations.toast.noAdditionalUnits","⚠️ لا توجد وحدات إضافية متاحة حالياً"));return}const d=ve(l.barcode),u=ns(l);if(!u){I(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}Cl({id:u,equipmentId:u,barcode:d,desc:l.desc||l.description||l.name||a.description||"",qty:1,price:Number.isFinite(Number(l.price))?Number(l.price):a.unitPrice,image:tr(l)}),qa(),He()}function He(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(b(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",s=e?"percent":a,r=document.getElementById("res-tax"),i=e?!1:r?.checked||!1,o=document.getElementById("res-payment-status"),l=o?.value||"unpaid",{start:d,end:u}=ar();i&&Pn();const m=Vr(),p=document.getElementById("res-payment-progress-type"),f=document.getElementById("res-payment-progress-value"),h=Ub(p),g=Vb(f);Vm(),ou({selectedItems:Yn(),discount:n,discountType:s,applyTax:i,paidStatus:l,paymentProgressType:h,paymentProgressValue:g,start:d,end:u,companySharePercent:m,paymentHistory:[]});const y=ou.lastResult;y?(Kb(f,y.paymentProgressValue),o&&(o.value=y.paymentStatus,mn(o,y.paymentStatus))):mn(o,l)}function Yj(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=b(o.target.value),He()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",He),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(on()){n.checked=!1,I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}wu("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(on()){a.checked=!1,I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}wu("share")}),a.dataset.listenerAttached="true");const s=document.getElementById("res-payment-status");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{if(on()){s.value="unpaid",mn(s,"unpaid"),I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}mn(s),He()}),s.dataset.listenerAttached="true");const r=document.getElementById("res-payment-progress-type");r&&!r.dataset.listenerAttached?(r.dataset.userSelected!=="true"&&(r.value="percent"),r.addEventListener("change",o=>{if(on()){r.value="percent",I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}r.dataset.userSelected="true",He()}),r.dataset.listenerAttached="true"):r&&r.dataset.userSelected!=="true"&&!r.value&&(r.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(on()){i.value="",I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}o.target.value=b(o.target.value),He()}),i.dataset.listenerAttached="true"),He()}function Xj(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;let n=!1;const a=()=>{const s=e.value?.trim();if(!s){He();return}const r=t.dataset.syncedWithStart;(!t.value?.trim()||r!=="false")&&(n=!0,t.value=s,t.dataset.syncedWithStart="true",t.dataset.syncedValue=s,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),He()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{n||(t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false")}),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function jh(){const{input:e,hidden:t}=pp(),{input:n,hidden:a}=nr(),{customers:s}=ae();let r=t?.value?String(t.value):"";if(!r&&e?.value){const W=Au(e.value,{allowPartial:!0});W&&(r=String(W.id),t&&(t.value=r),e.value=W.label,e.dataset.selectedId=r)}const i=s.find(W=>String(W.id)===r);if(!i){I(c("reservations.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل"));return}const o=i.id;let l=a?.value?String(a.value):"";if(!l&&n?.value){const W=Eu(n.value,{allowPartial:!0});W&&(l=String(W.id),a&&(a.value=l),n.value=W.label,n.dataset.selectedId=l)}const d=document.getElementById("res-start").value,u=document.getElementById("res-end").value,m=document.getElementById("res-start-time")?.value||"00:00",p=document.getElementById("res-end-time")?.value||"00:00";if(!d||!u){I(c("reservations.toast.requireDates","⚠️ يرجى تحديد تاريخ البداية والنهاية"));return}const f=`${d}T${m}`,h=`${u}T${p}`,g=new Date(f),y=new Date(h);if(Number.isNaN(g.getTime())||Number.isNaN(y.getTime())||g>=y){I(c("reservations.toast.invalidDateRange","⚠️ تأكد من أن تاريخ ووقت البداية يسبق تاريخ ووقت النهاية"));return}const E=Vm();E.map(W=>W.technicianId).filter(Boolean);const S=Yn();if(S.length===0&&E.length===0){I(c("reservations.toast.noItems","⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل"));return}const x=document.getElementById("res-notes")?.value||"",A=parseFloat(b(document.getElementById("res-discount")?.value))||0,C=document.getElementById("res-discount-type")?.value||"percent",j=document.getElementById("res-payment-status"),k=j?.value||"unpaid",w=document.getElementById("res-payment-progress-type"),_=document.getElementById("res-payment-progress-value"),$=Ub(w),q=Vb(_),F=l?hp(l):null,U=Bj(F);if(l&&!F){I(c("reservations.toast.projectNotFound","⚠️ لم يتم العثور على المشروع المحدد. حاول تحديث الصفحة."));return}for(const W of S){const be=ja(W.barcode);if(be==="maintenance"||be==="retired"){I(Ws(be));return}}for(const W of S){const be=ve(W.barcode);if(Xn(be,f,h)){I(c("reservations.toast.cannotCreateEquipmentConflict","⚠️ لا يمكن إتمام الحجز، إحدى المعدات محجوزة في نفس الفترة الزمنية"));return}}for(const W of E)if(W?.technicianId&&Eo(W.technicianId,f,h)){I(c("reservations.toast.cannotCreateCrewConflict","⚠️ لا يمكن إتمام الحجز، أحد أعضاء الطاقم مرتبط بحجز آخر في نفس الفترة"));return}const L=document.getElementById("res-tax"),B=document.getElementById("res-company-share"),D=!!l;D?(L&&(L.checked=!1,L.disabled=!0,L.classList.add("disabled"),L.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تعديل الضريبة من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),B&&(B.checked=!1,B.disabled=!0,B.classList.add("disabled"),B.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تعديل نسبة الشركة من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),j&&(j.value="unpaid",j.disabled=!0,mn(j,"unpaid"),j.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تغيير حالة الدفع من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),w&&(w.disabled=!0,w.classList.add("disabled")),_&&(_.value="",_.disabled=!0,_.classList.add("disabled"))):(L&&(L.disabled=!1,L.classList.remove("disabled"),L.title=""),B&&(B.disabled=!1,B.classList.remove("disabled"),B.title=""),j&&(j.disabled=!1,j.title=""),w&&(w.disabled=!1,w.classList.remove("disabled")),_&&(_.disabled=!1,_.classList.remove("disabled")));const K=D?!1:L?.checked||!1,Z=!!B?.checked;if(!D&&Z!==K){I(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"));return}let R=Z?Vr():null;Z&&(!Number.isFinite(R)||R<=0)&&(Pn(),R=Vr());const M=Z&&K&&Number.isFinite(R)&&R>0;K&&Pn();const H=Js(S,A,C,K,E,{start:f,end:h,companySharePercent:M?R:0}),V=YE(),G=en({totalAmount:H,progressType:$,progressValue:q,history:[]});_&&Kb(_,G.paymentProgressValue);const ie=[];G.paymentProgressValue!=null&&G.paymentProgressValue>0&&ie.push({type:G.paymentProgressType||$,value:G.paymentProgressValue,amount:G.paidAmount,percentage:G.paidPercent,recordedAt:new Date().toISOString()});const ee=fn({manualStatus:k,paidAmount:G.paidAmount,paidPercent:G.paidPercent,totalAmount:H});j&&(j.value=ee,mn(j,ee));const oe=Qm({reservationCode:V,customerId:o,start:f,end:h,status:U?"confirmed":"pending",title:null,location:null,notes:x,projectId:l||null,totalAmount:H,discount:D?0:A,discountType:D?"percent":C,applyTax:K,paidStatus:D?"unpaid":ee,confirmed:U,items:S.map(W=>({...W,equipmentId:W.equipmentId??W.id})),crewAssignments:E,companySharePercent:D||!M?null:R,companyShareEnabled:D?!1:M,paidAmount:D?0:G.paidAmount,paidPercentage:D?0:G.paidPercent,paymentProgressType:D?null:G.paymentProgressType,paymentProgressValue:D?null:G.paymentProgressValue,paymentHistory:D?[]:ie});try{gh("about to submit",{crewAssignments:E,techniciansPayload:oe?.technicians,payload:oe});const W=await fb(oe);gh("server response",{reservation:W?.id??W?.reservationId??W?.reservation_code,technicians:W?.technicians,crewAssignments:W?.crewAssignments,techniciansDetails:W?.techniciansDetails}),li(),Ja(),Ut(),eI(),I(c("reservations.toast.created","✅ تم إنشاء الحجز")),typeof bu=="function"&&bu({type:"created",reservation:W}),Jj(W)}catch(W){console.error("❌ [reservations/createForm] Failed to create reservation",W);const be=oi(W)?W.message:c("reservations.toast.createFailed","تعذر إنشاء الحجز، حاول مرة أخرى");I(be,"error"),D&&(I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ التعديلات من شاشة المشروع."),"error"),Fi({clearValue:!1}))}}function Jj(e){if(!Pc)return;const{draftStorageKey:t=Rb,returnUrl:n=Mb}=Pc,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const s=window.sessionStorage.getItem(t),r=s?JSON.parse(s)||{}:{},i=Array.isArray(r.linkedReservationIds)?r.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),r.linkedReservationIds=i,window.sessionStorage.setItem(t,JSON.stringify(r))}catch(s){console.warn("⚠️ [reservations] Unable to persist linked reservation draft state",s)}Pc=null,n&&(window.location.href=n)}function Fi({clearValue:e=!1}={}){const{input:t,hidden:n}=nr();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,Xa())}function Zj(e,t=""){const{input:n,hidden:a}=nr();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),Xa())}function eI(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),ga({selectedValue:"",resetInput:!0}),document.getElementById("res-start").value="",document.getElementById("res-start-time").value="",document.getElementById("res-end").value="",document.getElementById("res-end-time").value="",document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),Fi({clearValue:!1}),Kr({selectedValue:"",resetInput:!0});const s=document.getElementById("equipment-description");s&&(s.value="");const r=document.getElementById("res-payment-status");r&&(r.value="unpaid",mn(r,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),lw(),Kg([]),eo("form-reset"),qa(),Xa(),He()}function tI(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s}=n.dataset;if(a==="decrease-group"&&s){Wj(s);return}if(a==="increase-group"&&s){Gj(s);return}if(a==="remove-group"&&s){Qj(s);return}}),e.dataset.listenerAttached="true")}function nI(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(Hc()!=="single")return;const s=e.value;s?.trim()&&(clearTimeout(t),t=null,Zb(s,e))};e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||Hc()!=="single")return;const{start:r,end:i}=ar();!r||!i||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function aI(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async n=>{n.preventDefault(),await jh()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async n=>{n.preventDefault(),await jh()}),t.dataset.listenerAttached="true")}function rv({onAfterSubmit:e}={}){bu=typeof e=="function"?e:null;const{customers:t,projects:n}=ae();R0(t||[]),ga(),gp(),Qb(n||[]),Yb({projectsList:n}),yp(),Ja(),zl(),zj(),ev(),sv(),Xj(),Yj(),tI(),nI(),aI(),Fj(),He(),qa()}function vp(){Ja(),zl(),Yb(),ga(),gp(),yp(),ev(),sv(),qa(),He()}if(typeof document<"u"){const e=()=>{ga(),Kr({projectsList:fp()}),gp(),yp(),He()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Ja()}),document.addEventListener("packages:changed",()=>{zl(),Hc()==="package"&&Iu("package")})}typeof window<"u"&&(window.getCompanySharePercent=Vr);function sr(e){const t=new Date;if(t.setHours(0,0,0,0),e==="today")return{startDate:ms(t),endDate:ms(t)};if(e==="week"){const n=new Date(t),a=n.getDay(),s=a===0?6:a-1;n.setDate(n.getDate()-s);const r=new Date(n);return r.setDate(n.getDate()+6),{startDate:ms(n),endDate:ms(r)}}if(e==="month"){const n=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0);return{startDate:ms(n),endDate:ms(a)}}return e==="upcoming"?{startDate:ms(t),endDate:""}:{startDate:"",endDate:""}}function sI(){const e=document.getElementById("search-reservation"),t=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date"),a=document.getElementById("reservation-date-range"),s=document.getElementById("reservation-status-filter");let r=b(t?.value||"").trim(),i=b(n?.value||"").trim(),o=a?.value||"";if(new Set(["","today","week","month"]).has(o)||(o="",a&&(a.value=""),nl(t),nl(n),r="",i=""),!r&&!i&&o){const d=sr(o);r=d.startDate,i=d.endDate}return{searchTerm:et(e?.value||""),startDate:r,endDate:i,status:s?.value||"",quickRange:o}}function rI(e){const t=()=>{typeof e=="function"&&e()},n=document.getElementById("search-reservation");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=b(n.value),t()}),n.dataset.listenerAttached="true");const a=document.getElementById("filter-start-date");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{const l=document.getElementById("reservation-date-range");l&&(l.value=""),t()}),a.dataset.listenerAttached="true");const s=document.getElementById("filter-end-date");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{const l=document.getElementById("reservation-date-range");l&&(l.value=""),t()}),s.dataset.listenerAttached="true");const r=document.getElementById("reservation-date-range");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{iI(r.value),t()}),r.dataset.listenerAttached="true");const i=document.getElementById("reservation-status-filter");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",t),i.dataset.listenerAttached="true");const o=document.getElementById("clear-filters");o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{n&&(n.value=""),nl(a),nl(s),r&&(r.value=""),i&&(i.value=""),t()}),o.dataset.listenerAttached="true")}function iI(e){const t=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date");if(!t||!n)return;const{startDate:a,endDate:s}=sr(e);t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a,n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s}function ms(e){if(!e)return"";const t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().split("T")[0]}function nl(e){e&&(e._flatpickr&&e._flatpickr.clear(),e.value="")}function tc(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function oI(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],s=Number.parseInt(a,10);return Number.isFinite(s)?s:null}function cI(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=oI(n);if(a!==null)return a}return null}function Ih(e,t=0){const n=cI(e);if(n!=null)return n;const a=tc(e.createdAt??e.created_at);if(a!=null)return a;const s=tc(e.updatedAt??e.updated_at);if(s!=null)return s;const r=tc(e.start);if(r!=null)return r;const i=tc(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(t)?t:0}function lI({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:s}){const r=e.map((S,x)=>({reservation:S,index:x})),i=t.searchTerm||"",o=t.searchReservationId||"",l=t.searchCustomerName||"",d=t.searchProjectId||"",u=t.startDate||"",m=t.endDate||"",p=t.status||"",f=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,h=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,g=u?new Date(`${u}T00:00:00`):null,y=m?new Date(`${m}T23:59:59`):null,E=r.filter(({reservation:S})=>{const x=n.get(String(S.customerId)),A=s?.get?.(String(S.projectId)),C=S.start?new Date(S.start):null,j=jo(S),{effectiveConfirmed:k}=Vt(S,A);if(f!=null&&String(S.customerId)!==String(f)||h!=null&&!(Array.isArray(S.technicians)?S.technicians.map(F=>String(F)):[]).includes(String(h))||p==="confirmed"&&!k||p==="pending"&&k||p==="completed"&&!j||g&&C&&C<g||y&&C&&C>y)return!1;if(o){const q=[S.reservationId,S.id,S.reservation_id,S.reservationCode,S.reservation_code,S.code,S.reference,S.referenceNumber,S.reference_number],F=et(q.filter(L=>L!=null&&L!=="").map(String).join(" ")).replace(/\s+/g,""),U=o.replace(/\s+/g,"");if(!F.includes(U))return!1}if(l&&!et(x?.customerName||"").includes(l))return!1;if(d){const q=[S.projectId,S.project_id,S.projectID,A?.id,A?.projectCode,A?.project_code],F=et(q.filter(L=>L!=null&&L!=="").map(String).join(" ")).replace(/\s+/g,""),U=d.replace(/\s+/g,"");if(!F.includes(U))return!1}if(!i)return!0;const w=S.items?.map?.(q=>`${q.barcode} ${q.desc}`).join(" ")||"",_=(S.technicians||[]).map(q=>a.get(String(q))?.name).filter(Boolean).join(" ");return et([S.reservationId,x?.customerName,S.notes,w,_,A?.title].filter(Boolean).join(" ")).includes(i)});return E.sort((S,x)=>{const A=Ih(S.reservation,S.index),C=Ih(x.reservation,x.index);return A!==C?C-A:x.index-S.index}),E}function dI({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const s=c("reservations.create.summary.currency","SR"),r=c("reservations.list.taxIncludedShort","(شامل الضريبة)"),i=c("reservations.list.unknownCustomer","غير معروف"),o=c("reservations.list.noNotes","لا توجد ملاحظات"),l=c("reservations.list.itemsCountShort","{count} عنصر"),d=c("reservations.list.crew.separator","، "),u=c("reservations.list.status.confirmed","✅ مؤكد"),m=c("reservations.list.status.pending","⏳ غير مؤكد"),p=c("reservations.list.payment.paid","💳 مدفوع"),f=c("reservations.list.payment.unpaid","💳 غير مدفوع"),h=c("reservations.list.payment.partial","💳 مدفوع جزئياً"),g=c("reservations.list.actions.confirm","✔️ تأكيد"),y=c("reservations.list.project.unlinked","غير مرتبط بمشروع"),E=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),S={client:c("reservations.list.labels.client","👤 العميل"),project:c("reservations.list.labels.project","📁 المشروع"),start:c("reservations.list.labels.start","🗓️ بداية الحجز"),end:c("reservations.list.labels.end","🗓️ نهاية الحجز"),cost:c("reservations.list.labels.cost","💵 التكلفة"),equipment:c("reservations.list.labels.equipment","📦 المعدات"),crew:c("reservations.list.labels.crew","😎 الفريق")};return e.map(({reservation:x,index:A})=>{const C=t.get(String(x.customerId)),j=x.projectId?a?.get?.(String(x.projectId)):null,k=jo(x),w=x.paidStatus??x.paid_status??(x.paid===!0||x.paid==="paid"?"paid":"unpaid"),_=w==="paid",$=w==="partial",{effectiveConfirmed:q,projectLinked:F}=Vt(x,j),U=q?"status-confirmed":"status-pending",L=_?"status-paid":$?"status-partial":"status-unpaid";let B=`<span class="reservation-chip status-chip ${U}">${q?u:m}</span>`;const D=_?p:$?h:f;let K=`<span class="reservation-chip status-chip ${L}">${D}</span>`,Z=_?" tile-paid":$?" tile-partial":" tile-unpaid";k&&(Z+=" tile-completed");let R="";k&&(B=`<span class="reservation-chip status-chip status-completed">${u}</span>`,K=`<span class="reservation-chip status-chip status-completed">${D}</span>`,R=` data-completed-label="${c("reservations.list.ribbon.completed","منتهي").replace(/"/g,"&quot;")}"`);const M=!F&&!q?`<button class="tile-confirm" data-reservation-index="${A}" data-action="confirm">${g}</button>`:"",H=M?`<div class="tile-actions">${M}</div>`:"",V=x.items?.length||0,G=Array.isArray(x.crewAssignments)?x.crewAssignments:[],ie=(x.technicians||[]).map(ye=>n.get(String(ye))).filter(Boolean),ee=G.length?G.map(ye=>{const te=ye.positionLabel??ye.position_name??ye.role??c("reservations.crew.positionFallback","منصب بدون اسم"),Ce=ye.technicianName??n.get(String(ye.technicianId??""))?.name??null;return Ce?`${b(te)} (${b(Ce)})`:b(te)}):ie.map(ye=>ye.name),oe=ee.length?ee.join(d):"—",W=b(String(x.reservationId??"")),be=x.start?b(mt(x.start)):"-",he=x.end?b(mt(x.end)):"-",Se=b(String(x.cost??0)),we=b(String(V)),J=x.notes?b(x.notes):o,re=l.replace("{count}",we),ue=x.applyTax?`<small>${r}</small>`:"";let Pe=y;return x.projectId&&(Pe=j?.title?b(j.title):E),`
      <div class="${M?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${Z}"${R} data-reservation-index="${A}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${W}</div>
          <div class="tile-badges">
            ${B}
            ${K}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${S.client}</span>
            <span class="tile-value">${C?.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${S.project}</span>
            <span class="tile-value">${Pe}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${S.start}</span>
            <span class="tile-value tile-inline">${be}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${S.end}</span>
            <span class="tile-value tile-inline">${he}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${S.cost}</span>
            <span class="tile-value">${Se} ${s} ${ue}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${S.equipment}</span>
            <span class="tile-value">${re}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${S.crew}</span>
            <span class="tile-value">${ee.length?oe:"—"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">📝 ${J}</span>
          </div>
        </div>
        ${H}
      </div>
    `}).join("")}function Wt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function wd(e){if(e==null)return"";const t=String(e).trim();return t?b(t):""}function al(e,t,n=[],a,s=null){const{projectLinked:r,effectiveConfirmed:i}=Vt(e,s),o=e.paid===!0||e.paid==="paid",l=jo(e),d=e.items||[],{groups:u}=rb(e),{technicians:m=[]}=ae(),p=[].concat(Array.isArray(n)?n:[]).concat(Array.isArray(m)?m:[]),f=new Map;p.forEach(T=>{if(!T||T.id==null)return;const me=String(T.id),Re=f.get(me)||{};f.set(me,{...Re,...T})});const g=(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(T=>({technicianId:T}))).map((T,me)=>{const Re=T?.technicianId!=null?f.get(String(T.technicianId)):null;let Xe=T.positionLabel??T.position_name??T.position_label??T.role??T.position??"";(!Xe||Xe.trim()==="")&&(Xe=T.positionLabelAr??T.position_label_ar??T.positionLabelEn??T.position_label_en??T.position_name_ar??T.position_name_en??"");const st=T.positionLabelAlt??T.position_label_alt??T.positionLabelEn??T.position_label_en??T.positionLabelAr??T.position_label_ar??"";let It=Xe,Pt=st;if(!It||It.trim()==="")try{const Kt=Et?Et():[];let ke=null;if(T.positionId!=null&&(ke=Kt.find(rt=>String(rt.id)===String(T.positionId))||null),!ke){const rt=T.positionKey??T.position_key??T.positionName??T.position_name??T.position??"";if(rt&&(ke=typeof Br=="function"?Br(rt):null,!ke&&Kt.length)){const bn=String(rt).trim().toLowerCase();ke=Kt.find(vn=>[vn.name,vn.labelAr,vn.labelEn].filter(Boolean).map(La=>String(La).toLowerCase()).includes(bn))||null}}ke&&(It=ke.labelAr||ke.labelEn||ke.name||"",(!Pt||String(Pt).trim()==="")&&(ke.labelAr&&ke.labelEn?Pt=It===ke.labelAr?ke.labelEn:ke.labelAr:Pt=ke.labelAr||ke.labelEn||""))}catch{}const ft=Ee(xe(T.positionCost??T.position_cost??T.cost??T.daily_wage??T.dailyWage??Re?.dailyWage??Re?.wage??0)),dr=Ee(xe(T.positionClientPrice??T.position_client_price??T.client_price??T.clientPrice??T.daily_total??T.dailyTotal??T.total??Re?.dailyTotal??Re?.total??Re?.total_wage??0));return{assignmentId:T.assignmentId??T.assignment_id??`crew-${me}`,positionId:T.positionId??T.position_id??null,positionKey:T.positionKey??T.position_key??T.positionName??T.position_name??T.position??null,positionLabel:It,positionLabelAlt:Pt,positionLabelAr:T.positionLabelAr??T.position_label_ar??null,positionLabelEn:T.positionLabelEn??T.position_label_en??null,positionCost:ft,positionClientPrice:dr,technicianId:T.technicianId!=null?String(T.technicianId):Re?.id!=null?String(Re.id):null,technicianName:T.technicianName??T.technician_name??Re?.name??null,technicianRole:T.technicianRole??Re?.role??null,technicianPhone:T.technicianPhone??Re?.phone??null,notes:T.notes??null}}),y=St(),E=ri(e.start,e.end),S=e.discount??e.discountValue??e.discount_value??e.discountAmount??0,x=xe(S),A=Number.isFinite(x)?x:0,C=e.discountType??e.discount_type??e.discountMode??"percent",j=String(C).toLowerCase()==="amount"?"amount":"percent",k=r?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),w=xe(e.cost??e.total??e.finalTotal),_=Number.isFinite(w),$=_?Ee(w):0,q=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share,F=q!=null?xe(q):Number.NaN;let B=((e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied)===!0||Number.isFinite(F)&&F>0)&&Number.isFinite(F)?F:0;k&&B<=0&&(B=Fe);const D=xa({items:d,technicianIds:e.technicians||[],crewAssignments:g,discount:A,discountType:j,applyTax:k,start:e.start,end:e.end,companySharePercent:B}),K=Ee(D.equipmentTotal),Z=Ee(D.crewTotal);Ee(D.crewCostTotal);const R=Ee(D.discountAmount),M=Ee(D.subtotalAfterDiscount),H=Number.isFinite(D.companySharePercent)?D.companySharePercent:0;let V=Ee(D.companyShareAmount);V=H>0?Ee(Math.max(0,V)):0;const G=Ee(D.taxAmount),ie=Ee(D.finalTotal),ee=r?ie:_?$:ie,oe=Ee(D.netProfit),W=b(String(e.reservationId??e.id??"")),be=e.start?b(mt(e.start)):"-",he=e.end?b(mt(e.end)):"-",Se=b(String(g.length)),we=b(K.toFixed(2)),J=b(R.toFixed(2)),re=b(M.toFixed(2)),ue=b(G.toFixed(2)),Pe=b((Number.isFinite(ee)?ee:0).toFixed(2)),Te=b(String(E)),ye=c("reservations.create.summary.currency","SR"),te=c("reservations.details.labels.discount","الخصم"),Ce=c("reservations.details.labels.tax","الضريبة (15%)"),X=c("reservations.details.labels.crewTotal","إجمالي الفريق"),Ae=c("reservations.details.labels.subtotalAfterDiscount","الإجمالي"),Ne=c("reservations.details.labels.duration","عدد الأيام"),je=c("reservations.details.labels.companyShare","🏦 نسبة الشركة"),fe=c("reservations.details.labels.netProfit","💵 صافي الربح"),qe=c("reservations.create.equipment.imageAlt","صورة"),ze={item:c("reservations.equipment.table.item","المعدة"),quantity:c("reservations.equipment.table.quantity","الكمية"),unitPrice:c("reservations.equipment.table.unitPrice","سعر الوحدة"),total:c("reservations.equipment.table.total","الإجمالي"),actions:c("reservations.equipment.table.actions","الإجراءات")},Je=c("reservations.details.noItems","📦 لا توجد معدات ضمن هذا الحجز حالياً."),Ye=c("reservations.details.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.");c("reservations.details.technicians.roleUnknown","غير محدد");const _t=c("reservations.details.technicians.phoneUnknown","غير متوفر");c("reservations.details.technicians.wage","{amount} {currency} / اليوم");const Zn=c("reservations.list.status.confirmed","✅ مؤكد"),Ta=c("reservations.list.status.pending","⏳ غير مؤكد"),cs=c("reservations.list.payment.paid","💳 مدفوع"),ce=c("reservations.list.payment.unpaid","💳 غير مدفوع"),De=c("reservations.list.payment.partial","💳 مدفوع جزئياً"),At=c("reservations.list.status.completed","📁 منتهي"),Tt=c("reservations.details.labels.id","🆔 رقم الحجز"),Ca=c("reservations.details.section.bookingInfo","بيانات الحجز"),sn=c("reservations.details.section.paymentSummary","ملخص الدفع"),ls=c("reservations.details.labels.finalTotal","المجموع النهائي"),Uo=c("reservations.details.section.crew","😎 الفريق الفني"),ld=c("reservations.details.crew.count","{count} عضو"),cr=c("reservations.details.section.items","📦 المعدات المرتبطة"),lr=c("reservations.details.items.count","{count} عنصر"),$A=c("reservations.details.actions.edit","✏️ تعديل"),DA=c("reservations.details.actions.delete","🗑️ حذف"),BA=c("reservations.details.labels.customer","العميل"),FA=c("reservations.details.labels.contact","رقم التواصل"),RA=c("reservations.details.labels.project","📁 المشروع المرتبط");c("reservations.details.project.unlinked","غير مرتبط بأي مشروع.");const MA=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),HA=c("reservations.details.actions.openProject","📁 فتح المشروع"),zA=c("reservations.details.labels.start","بداية الحجز"),OA=c("reservations.details.labels.end","نهاية الحجز"),UA=c("reservations.details.labels.notes","ملاحظات"),VA=c("reservations.list.noNotes","لا توجد ملاحظات"),KA=c("reservations.details.labels.itemsCount","عدد المعدات"),WA=c("reservations.details.labels.itemsTotal","إجمالي المعدات"),QA=c("reservations.paymentHistory.title","سجل الدفعات"),GA=c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة"),YA=c("reservations.list.unknownCustomer","غير معروف"),dd=e.paidStatus??e.paid_status??(o?"paid":"unpaid"),Cf=dd==="partial",XA=dd==="paid"?cs:Cf?De:ce;function ud(T){if(T==null)return Number.NaN;if(typeof T=="number")return Number.isFinite(T)?T:Number.NaN;const me=String(T).replace(/[^0-9.+-]/g,""),Re=Number(me);return Number.isFinite(Re)?Re:Number.NaN}const Vo=(T={})=>{const me=String(T.type??T.kind??T.category??"").toLowerCase();return!!(["package","bundle","pack"].includes(me)||Array.isArray(T.packageItems)&&T.packageItems.length)},JA=(T={})=>[T.packageId,T.package_id,T.packageCode,T.package_code,T.bundleId,T.bundle_id].some(me=>me!=null&&me!==""),ZA=(T={})=>!T||typeof T!="object"?!1:!Vo(T)&&JA(T),Pf=(T={})=>{const me=Vo(T),Re=[{value:T.qty,key:"qty",limit:999},{value:T.quantity,key:"quantity",limit:999},{value:T.units,key:"units",limit:999},{value:T.count,key:"count",limit:50},{value:T.package_quantity,key:"package_quantity",limit:999},{value:T.packageQty,key:"packageQty",limit:999},{value:T.packageCount,key:"packageCount",limit:999}];let Xe=NaN;for(const st of Re){if(st.value==null||st.value==="")continue;const It=typeof st.value=="string"?st.value.trim():String(st.value??"");if(st.key==="count"&&It.length>6)continue;const Pt=ud(st.value);if(!Number.isFinite(Pt)||Pt<=0)continue;const ft=Math.round(Pt);if(!(ft>st.limit)){Xe=Math.max(1,ft);break}}return(!Number.isFinite(Xe)||Xe<=0)&&(Xe=1),me?Math.max(1,Math.min(99,Xe)):Math.max(1,Math.min(9999,Xe))};let Ct=(Array.isArray(d)?d:[]).reduce((T,me)=>!me||typeof me!="object"||ZA(me)?T:T+Pf(me),0);Ct<=0&&Array.isArray(u)&&u.length&&(Ct=u.reduce((T,me)=>{const Re=Pf({...me,type:me.type});return T+Re},0)),!Number.isFinite(Ct)||Ct<=0?Ct=Array.isArray(u)&&u.length?u.length:(Array.isArray(d)?d.length:0)||1:Ct>1e6&&(Ct=Math.min(Ct,Array.isArray(u)?u.length:Ct),(!Number.isFinite(Ct)||Ct<=0)&&(Ct=(Array.isArray(d)?d.length:0)||1)),Ct=Math.max(1,Math.round(Ct));const eE=b(String(Ct)),Lf=lr.replace("{count}",eE),tE=ld.replace("{count}",Se),nE=e.notes?b(e.notes):VA,aE=b(Z.toFixed(2)),sE=b(String(H)),rE=b(V.toFixed(2)),iE=`${sE}% (${rE} ${ye})`,oE=Number.isFinite(oe)?Math.max(0,oe):0,cE=b(oE.toFixed(2)),Pa=[{icon:"💼",label:WA,value:`${we} ${ye}`}];Pa.push({icon:"😎",label:X,value:`${aE} ${ye}`}),R>0&&Pa.push({icon:"💸",label:te,value:`${J} ${ye}`}),Pa.push({icon:"📊",label:Ae,value:`${re} ${ye}`}),k&&G>0&&Pa.push({icon:"🧾",label:Ce,value:`${ue} ${ye}`}),H>0&&Pa.push({icon:"🏦",label:je,value:iE}),Pa.push({icon:"💵",label:fe,value:`${cE} ${ye}`}),Pa.push({icon:"💰",label:ls,value:`${Pe} ${ye}`});const lE=Pa.map(({icon:T,label:me,value:Re})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${T} ${me}</span>
      <span class="summary-details-value">${Re}</span>
    </div>
  `).join("");console.debug("[reservations/details] payment history raw",e.paymentHistory,e.payment_history);let bi=[];Array.isArray(e.paymentHistory)?bi=e.paymentHistory:Array.isArray(e.payment_history)&&(bi=e.payment_history);const dE=Array.isArray(e.paymentLogs)?e.paymentLogs:[],Nf=Array.isArray(bi)&&bi.length>0?bi:dE,uE=Nf.length?`<ul class="reservation-payment-history-list">${Nf.map(T=>{const me=T?.type==="amount"?c("reservations.paymentHistory.type.amount","دفعة مالية"):T?.type==="percent"?c("reservations.paymentHistory.type.percent","دفعة نسبة"):c("reservations.paymentHistory.type.unknown","دفعة"),Re=Number.isFinite(Number(T?.amount))&&Number(T.amount)>0?`${b(Number(T.amount).toFixed(2))} ${ye}`:"—",Xe=Number.isFinite(Number(T?.percentage))&&Number(T.percentage)>0?`${b(Number(T.percentage).toFixed(2))}%`:"—",st=T?.recordedAt?b(mt(T.recordedAt)):"—",It=T?.note?`<div class="payment-history-note">${Wt(b(T.note))}</div>`:"";return`
          <li>
            <div class="payment-history-entry">
              <span class="payment-history-entry__type">${Wt(me)}</span>
              <span class="payment-history-entry__amount">${Re}</span>
              <span class="payment-history-entry__percent">${Xe}</span>
              <span class="payment-history-entry__date">${st}</span>
            </div>
            ${It}
          </li>
        `}).join("")}</ul>`:`<div class="reservation-payment-history-empty">${Wt(GA)}</div>`,$f=[{text:i?Zn:Ta,className:i?"status-confirmed":"status-pending"},{text:XA,className:dd==="paid"?"status-paid":Cf?"status-partial":"status-unpaid"}];l&&$f.push({text:At,className:"status-completed"});const mE=$f.map(({text:T,className:me})=>`<span class="status-chip ${me}">${T}</span>`).join(""),ds=(T,me,Re)=>`
    <div class="res-info-row">
      <span class="label">${T} ${me}</span>
      <span class="value">${Re}</span>
    </div>
  `;let md="";if(e.projectId){let T=Wt(MA);if(s){const me=s.title||c("projects.fallback.untitled","مشروع بدون اسم");T=`${Wt(me)} <button type="button" class="btn btn-sm btn-outline-primary" data-action="open-project" data-project-id="${s.id}">${Wt(HA)}</button>`}md=`
      <div class="res-info-row">
        <span class="label">📁 ${RA}</span>
        <span class="value">${T}</span>
      </div>
    `}const ea=[];ea.push(ds("👤",BA,t?.customerName||YA)),ea.push(ds("📞",FA,t?.phone||"—")),ea.push(ds("🗓️",zA,be)),ea.push(ds("🗓️",OA,he)),ea.push(ds("📦",KA,Lf)),ea.push(ds("⏱️",Ne,Te)),ea.push(ds("📝",UA,nE)),md&&ea.push(md);const pE=ea.join(""),fE=u.length?u.map(T=>{const me=T.items[0]||{},Re=tr(me)||T.image,Xe=Re?`<img src="${Re}" alt="${qe}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',st=[];Array.isArray(T.packageItems)&&T.packageItems.length&&st.push(...T.packageItems),T.items.forEach(Ve=>{Array.isArray(Ve?.packageItems)&&Ve.packageItems.length&&st.push(...Ve.packageItems)});const It=Vo(T)||T.items.some(Ve=>Vo(Ve))||st.length>0,Pt=(Ve,{fallback:Dn=1,max:Me=1e3}={})=>{const tt=ud(Ve);return Number.isFinite(tt)&&tt>0?Math.min(Me,tt):Dn};let ft;if(It){const Ve=Pt(me?.qty??me?.quantity??me?.count,{fallback:NaN,max:999});Number.isFinite(Ve)&&Ve>0?ft=Ve:ft=Pt(T.quantity??T.count??1,{fallback:1,max:999})}else ft=Pt(T.quantity??T.count??me?.qty??me?.quantity??me?.count??0,{fallback:1,max:9999});const dr=b(String(ft)),Kt=(Ve,{preferPositive:Dn=!1}={})=>{let Me=Number.NaN;for(const tt of Ve){const Bn=xe(tt);if(Number.isFinite(Bn)){if(Dn&&Bn>0)return Bn;Number.isFinite(Me)||(Me=Bn)}}return Me};let ke,rt;if(It){const Ve=[me?.price,me?.unit_price,me?.unitPrice,T.unitPrice];if(ke=Kt(Ve,{preferPositive:!0}),!Number.isFinite(ke)||ke<0){const Me=xe(T.totalPrice??me?.total??me?.total_price);Number.isFinite(Me)&&ft>0&&(ke=Me/ft)}Number.isFinite(ke)||(ke=0);const Dn=[me?.total,me?.total_price,T.totalPrice];if(rt=Kt(Dn),!Number.isFinite(rt))rt=ke*ft;else{const Me=ke*ft;Number.isFinite(Me)&&Me>0&&Math.abs(rt-Me)>Me*.25&&(rt=Me)}}else{const Ve=[me?.price,me?.unit_price,me?.unitPrice,T.unitPrice];if(ke=Kt(Ve,{preferPositive:!0}),!Number.isFinite(ke)||ke<0){const Dn=xe(T.totalPrice??me?.total??me?.total_price);Number.isFinite(Dn)&&ft>0&&(ke=Dn/ft)}Number.isFinite(ke)||(ke=0),rt=xe(T.totalPrice??me?.total??me?.total_price),Number.isFinite(rt)||(rt=ke*ft)}ke=Ee(ke),rt=Ee(rt);const bn=`${b(ke.toFixed(2))} ${ye}`,vn=`${b(rt.toFixed(2))} ${ye}`,La=T.barcodes.map(Ve=>b(String(Ve||""))).filter(Boolean),Sn=La.length?`<details class="reservation-item-barcodes">
              <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
              <ul class="reservation-barcode-list">
                ${La.map(Ve=>`<li>${Ve}</li>`).join("")}
              </ul>
            </details>`:"";let $n="";if(st.length){const Ve=new Map,Dn=Me=>{const tt=ud(Me?.qtyPerPackage??Me?.perPackageQty??Me?.quantityPerPackage);return Number.isFinite(tt)&&tt>0&&tt<=99?Math.round(tt):1};if(st.forEach(Me=>{if(!Me)return;const tt=ve(Me.barcode||Me.normalizedBarcode||Me.desc||Math.random());if(!tt)return;const Bn=Ve.get(tt),ur=Dn(Me);if(Bn){Bn.qty=ur,Bn.total=ur;return}Ve.set(tt,{desc:Me.desc||Me.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:Math.max(1,Math.min(ur,99)),total:Math.max(1,Math.min(ur,99)),barcode:Me.barcode??Me.normalizedBarcode??""})}),Ve.size){const Me=Array.from(Ve.values()).map(tt=>{const Bn=b(String(tt.qty>0?Math.min(tt.qty,99):1)),ur=Wt(tt.desc||""),vE=tt.barcode?` <span class="reservation-package-items__barcode">(${Wt(b(String(tt.barcode)))})</span>`:"";return`<li>${ur}${vE} × ${Bn}</li>`}).join("");$n=`
              <details class="reservation-package-items">
                <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
                <ul class="reservation-package-items__list">
                  ${Me}
                </ul>
              </details>
            `}}const bE=It?`${$n||""}${Sn||""}`:Sn;return`
          <tr>
            <td class="reservation-modal-items-table__cell reservation-modal-items-table__cell--item">
              <div class="reservation-item-info">
                <div class="reservation-item-thumb-wrapper">${Xe}</div>
                <div class="reservation-item-copy">
                  <div class="reservation-item-title">${Wt(me.desc||me.description||me.name||T.description||"-")}</div>
                  ${bE}
                </div>
              </div>
            </td>
            <td class="reservation-modal-items-table__cell" data-label="${Wt(ze.quantity)}">
              <div class="reservation-quantity-control reservation-quantity-control--static">
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">−</button>
                <span class="reservation-qty-value">${dr}</span>
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">+</button>
              </div>
            </td>
            <td class="reservation-modal-items-table__cell" data-label="${Wt(ze.unitPrice)}">${bn}</td>
            <td class="reservation-modal-items-table__cell" data-label="${Wt(ze.total)}">${vn}</td>
            <td class="reservation-modal-items-table__cell reservation-modal-items-table__cell--actions" data-label="${Wt(ze.actions)}">
              <button type="button" class="reservation-remove-button" disabled aria-disabled="true" tabindex="-1">🗑️</button>
            </td>
          </tr>
        `}).join(""):`<tr><td colspan="5" class="text-center">${Je}</td></tr>`,hE=`
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>${ze.item}</th>
            <th>${ze.quantity}</th>
            <th>${ze.unitPrice}</th>
            <th>${ze.total}</th>
            <th>${ze.actions}</th>
          </tr>
        </thead>
        <tbody>${fE}</tbody>
      </table>
    </div>
  `,yE=g.map((T,me)=>{const Re=b(String(me+1));let Xe=T.positionLabel??T.position_name??T.position_label??T.position_title??T.role??T.position??null;if((!Xe||Xe.trim()==="")&&(Xe=T.positionLabelAr??T.position_label_ar??T.position_title_ar??T.positionLabelEn??T.position_label_en??T.position_name_ar??T.position_title_en??T.position_name_en??null),!Xe||Xe.trim()==="")try{const bn=typeof Et=="function"?Et():[],vn=T.positionId?bn.find($n=>String($n.id)===String(T.positionId)):null,La=!vn&&T.positionKey?bn.find($n=>String($n.name).toLowerCase()===String(T.positionKey).toLowerCase()):null,Sn=vn||La||null;Sn&&(Xe=Sn.labelAr||Sn.labelEn||Sn.name||Xe)}catch{}const st=wd(Xe)||c("reservations.crew.positionFallback","منصب بدون اسم"),It=wd(T.positionLabelAlt??T.position_label_alt??T.positionLabelEn??T.position_label_en??T.positionLabelAr??T.position_label_ar??T.position_name_en??T.position_name_ar??""),Pt=wd(T.technicianName)||c("technicians.picker.noTechnicianOption","— بدون تعيين —"),ft=T.technicianPhone||_t,dr=Ee(xe(T.positionCost??T.position_cost??T.cost??T.daily_wage??T.dailyWage??T.internal_cost??0));let Kt=Ee(xe(T.positionClientPrice??T.position_client_price??T.client_price??T.customer_price??T.position_price??T.clientPrice??T.daily_total??T.dailyTotal??T.total??0));if(!Number.isFinite(Kt)||Kt<=0)try{const bn=Et?Et():[],vn=T.positionId?bn.find($n=>String($n.id)===String(T.positionId)):null,La=!vn&&T.positionKey?bn.find($n=>String($n.name).toLowerCase()===String(T.positionKey).toLowerCase()):null,Sn=vn||La||null;Sn&&Number.isFinite(Number(Sn.clientPrice))&&(Kt=Ee(Number(Sn.clientPrice)))}catch{}const ke=`${b(Kt.toFixed(2))} ${ye}`,rt=dr>0?`${b(dr.toFixed(2))} ${ye}`:null;return`
      <div class="reservation-technician-card">
        <div class="technician-card-head">
          <span class="technician-index">${Re}</span>
          <div class="d-flex flex-column">
            <span class="technician-name">${Pt}</span>
            <small class="text-muted">🏷️ ${st}${It?` — ${It}`:""}</small>
            <small class="text-muted">💼 ${ke}</small>
          </div>
        </div>
        <div class="technician-card-body">
          <div>📞 ${ft}</div>
          ${rt?`<div>💵 ${c("reservations.details.technicians.costLabel","التكلفة الداخلية")}: ${rt}</div>`:""}
        </div>
      </div>
    `}).join(""),gE=g.length?`<div class="reservation-technicians-grid">${yE}</div>`:`<ul class="reservation-modal-technicians"><li>${Ye}</li></ul>`;return`
    <div class="reservation-modal">
      <div class="reservation-modal-header">
        <div class="reservation-modal-id">
          <span>${Tt}</span>
          <strong>${W}</strong>
        </div>
        <div class="status-chips">
          ${mE}
        </div>
      </div>

      <div class="reservation-modal-grid">
        <div class="reservation-info-card">
          <h6>${Ca}</h6>
          ${pE}
        </div>
      </div>
      <div class="reservation-summary-card">
        <div class="summary-icon">💳</div>
        <div class="summary-body">
          <h6 class="summary-heading">${sn}</h6>
          <div class="summary-content">
            <div class="summary-details">
              ${lE}
            </div>
            <div class="reservation-payment-history-modal">
              <h6 class="history-heading">${QA}</h6>
              ${uE}
            </div>
          </div>
        </div>
      </div>

      <div class="reservation-technicians-section">
        <div class="section-title">
          <span>${Uo}</span>
          <span class="count">${tE}</span>
        </div>
        ${gE}
      </div>

      <div class="reservation-items-section">
        <div class="section-title">
          <span>${cr}</span>
          <span class="count">${Lf}</span>
        </div>
        ${hE}
      </div>

      <div class="reservation-modal-actions">
        <button type="button" class="modal-action-btn modal-action-btn--ghost" id="reservation-details-export-btn" data-index="${a}">
          ${c("reservations.details.actions.exportPdf","👁️ معاينة PDF")}
        </button>
        <button type="button" class="modal-action-btn modal-action-btn--primary" id="reservation-details-edit-btn" data-index="${a}">${$A}</button>
        ${y?`<button type="button" class="modal-action-btn modal-action-btn--danger" id="reservation-details-delete-btn" data-index="${a}">${DA}</button>`:""}
      </div>
    </div>
  `}const xu="project",qu="editProject",xh=3600*1e3,mi=.15,jd=6,Sp="projectsTab",Ap="projectsSubTab",qh={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},iv={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},uI={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"},mI=`@page {
  margin: 0;
  size: A4;
}

html,
body,
.page,
.quote-wrapper {
  margin: 0 !important;
  padding: 0 !important;
  box-sizing: border-box;
}

@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap');

#quotation-pdf-root {
  width: 210mm;
  min-width: 210mm;
  max-width: 210mm;
  min-height: 100%;
  box-sizing: border-box;
  font-family: 'Tajawal', 'Arial', 'Tahoma', sans-serif;
  color: #000000 !important;
  /* background: #ffffff !important; */
  direction: rtl;
  text-align: right;
  margin: 0 auto;
  padding: 0;
}

#quotation-pdf-root * {
  box-sizing: border-box;
  color: #000000 !important;
}

#quotation-pdf-root [style*="color"],
#quotation-pdf-root [class*="text"],
#quotation-pdf-root [class*="-text"],
#quotation-pdf-root [class*="text-"] {
  color: #000000 !important;
}

.quote-preview-pages {
  width: 210mm;
  max-width: 210mm;
  display: flex;
  flex-direction: column;
  gap: 18px;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  margin: 0;
}

#quotation-pdf-root[data-quote-render-context="export"] .quote-preview-pages {
  gap: 0 !important;
  row-gap: 0 !important;
  column-gap: 0 !important;
}

[data-quote-source] {
  display: none;
}

.quote-page {
  position: relative;
  width: 210mm;
  max-width: 210mm;
  min-width: 210mm;
  height: 297mm;
  min-height: 297mm;
  max-height: 297mm;
  margin: 0 auto;
  background: #ffffff;
  border-radius: 12px;
  padding: 4mm 14mm 12mm;
  display: flex;
  flex-direction: column;
  gap: 16px;
  box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
  page-break-after: auto;
  break-after: auto;
  page-break-before: auto;
  break-before: auto;
  page-break-inside: avoid;
  break-inside: avoid;
  align-items: stretch;
  justify-content: flex-start;
  overflow: hidden;
}

#quotation-pdf-root[data-quote-render-context="export"] .quote-page {
  box-shadow: none !important;
}

#quotation-pdf-root[data-quote-render-context="export"] .quote-page + .quote-page::before {
  display: none !important;
}

.quote-page:last-of-type {
  page-break-after: auto;
  break-after: auto;
}

.quote-page--primary {
  padding-top: 6mm;
}

.quote-page--continuation {
  padding-top: 12mm;
}

.quote-page + .quote-page::before {
  content: '';
  position: absolute;
  top: -18px;
  right: 16px;
  width: calc(100% - 32px);
  height: 1px;
  background: rgba(148, 163, 184, 0.5);
}

.quote-body {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  gap: 14px;
  align-items: stretch;
  justify-content: flex-start;
  width: 100%;
}

.quote-header {
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: flex-start;
  gap: 16px;
  width: 100%;
  margin: 0 auto 12px;
  padding: 0;
}

.quote-header__meta {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: flex-start;
  text-align: left;
  font-size: 0.72rem;
  color: #000000 !important;
  justify-self: start;
}

.quote-header__meta-item {
  display: flex;
  gap: 4px;
  align-items: baseline;
}

.quote-header__meta-item span {
  font-weight: 600;
  color: #000000 !important;
}

.quote-header__meta-item strong {
  font-size: 0.85rem;
  font-weight: 600;
  color: #000000 !important;
}

.quote-header__title {
  display: flex;
  flex-direction: column;
  gap: 6px;
  text-align: center;
  align-items: center;
  justify-self: center;
}

.quote-header__title h1 {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
}

.quote-company-name {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: #000000 !important;
}

.quote-company-cr {
  margin: 0;
  font-size: 13px;
  font-weight: 500;
  color: #000000 !important;
}

.quote-company-license {
  margin: 0;
  font-size: 13px;
  font-weight: 500;
  color: #000000 !important;
}

.quote-header__logo {
  justify-self: end;
  align-self: flex-start;
}

.quote-header__logo .quote-logo {
  width: 90px;
  height: 90px;
}

.quote-logo {
  display: block;
  object-fit: contain;
}

.quote-section h3 {
  margin-bottom: 10px;
  font-size: 16px;
  font-weight: 700;
  text-align: right;
  color: #000000 !important;
}

.quote-section__title {
  margin: 0 0 8px;
  font-size: 0.7rem;
  font-weight: 600;
  text-align: right;
  color: #000000 !important;
}

.quote-section--plain {
  padding-bottom: 4px;
  text-align: right;
}

.quote-section-row {
  display: flex;
  gap: 16px;
  justify-content: space-between;
  align-items: stretch;
}

.quote-section-row .quote-section {
  flex: 1 1 0;
  min-width: 0;
}

.quote-section-row--primary {
  display: flex;
  flex-direction: row-reverse;
  justify-content: space-between;
  gap: 18px;
  align-items: flex-start;
}

.quote-section--project,
.quote-section--customer {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
  flex: 1 1 0;
}

.quote-section--project {
  text-align: right;
  align-items: flex-end;
}

.quote-section--customer {
  text-align: left;
  align-items: flex-start;
}

.quote-section--project .quote-section__title {
  text-align: right;
  width: 50%;
}

.quote-section--customer .quote-section__title {
  width: 100%;
}

.quote-section--project .info-plain,
.quote-section--project .info-plain__item {
  text-align: right;
  justify-content: flex-end;
}

.quote-section--customer .info-plain,
.quote-section--customer .info-plain__item {
  text-align: left;
  align-items: flex-start;
  justify-content: flex-start;
}

.quote-section--reservation {
  text-align: left;
  margin-right: auto;
  margin-left: 0;
  max-width: fit-content;
}


.quote-section--financial {
  width: 100%;
  margin: 0;
}

#quotation-pdf-root[data-quote-render-context] .quote-section--financial {
  max-width: 60%;
  margin-left: auto;
  margin-right: auto;
}

@media (max-width: 900px) {
  #quotation-pdf-root[data-quote-render-context="preview"] .quote-section--financial {
    max-width: 100%;
  }
}


.quote-section,
.info-block,
.payment-block,
.totals-block,
.quote-notes,
.quote-approval-note,
.quote-footer,
.quote-placeholder {
  width: 100%;
  margin: 0;
  padding-top: 0;
  page-break-inside: avoid;
  break-inside: avoid;
}

.quote-section {
  margin-bottom: 12px;
}

.totals-block h3,
.payment-block h3 {
  margin: 0;
  text-align: center;
}

.quote-placeholder {
  padding: 18px 16px;
  border: 1px dashed rgba(148, 163, 184, 0.4);
  border-radius: 14px;
  font-size: 0.9rem;
  background: #ffffff;
  text-align: right;
}

.info-block,
.payment-block,
.totals-block {
  background: #ffffff;
  border: 1px solid rgba(148, 163, 184, 0.4);
  border-radius: 14px;
  padding: 12px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  text-align: left;
  direction: ltr;
}

.payment-block {
  align-items: stretch;
  text-align: right;
  direction: rtl;
  font-family: 'Tajawal', sans-serif;
  padding: 10px 12px;
  gap: 10px;
  width: 100%;
}

.payment-rows {
  display: flex;
  flex-direction: column;
  width: 100%;
  gap: 6px;
}

.payment-row {
  display: inline-flex;
  flex-direction: row;
  align-items: center;
  gap: 4px;
  direction: rtl;
  font-size: 0.68rem;
}

.payment-row__label {
  font-weight: 600;
  color: #000000 !important;
  text-align: right;
}

.payment-row__slash {
  font-weight: 600;
  color: #000000 !important;
}

.payment-row__value {
  font-weight: 700;
  color: #000000 !important;
  text-align: left;
  direction: ltr;
  white-space: nowrap;
}

.payment-block h3 {
  text-align: right;
  margin: 0;
}

.totals-block {
  font-size: 0.62rem;
  align-items: stretch;
  text-align: center;
  margin: 0 auto;
  direction: rtl;
  gap: 10px;
  font-family: 'Tajawal', sans-serif;
  padding: 12px 16px;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.totals-block h3 {
  font-size: 0.78rem;
  font-weight: 700;
  letter-spacing: 0;
  color: #000000 !important;
  margin-bottom: 4px;
  text-align: center;
  width: 100%;
}

.info-plain {
  display: flex;
  flex-direction: column;
  gap: 5px;
  align-items: flex-start;
  text-align: left;
  font-size: 0.68rem;
  color: #000000 !important;
}

.info-plain__item {
  display: flex;
  justify-content: flex-start;
  gap: 4px;
  align-items: baseline;
}

.info-plain__separator {
  color: #000000 !important;
  font-weight: 500;
}

.info-plain--right {
  align-items: flex-end;
  text-align: right;
}

.info-plain--right .info-plain__item {
  justify-content: flex-end;
}

.info-plain__label {
  font-weight: 600;
  color: #000000 !important;
}

.info-plain__value {
  font-weight: 600;
  font-size: 0.8rem;
  color: #000000 !important;
}

.info-plain--dense {
  gap: 4px;
  font-size: 0.7rem;
}

.info-plain--dense .info-plain__value {
  font-size: 0.76rem;
}

.info-plain__slash {
  color: #000000 !important;
  font-weight: 400;
}

.info-block h4,
.payment-block h4,
.totals-block h4 {
  margin: 0 0 6px;
  font-size: 14px;
  font-weight: 700;
  text-align: left;
}

.info-block__rows {
  display: flex;
  flex-direction: column;
  gap: 8px;
  text-align: right;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  background: #f8fafc;
  border: 1px solid rgba(148, 163, 184, 0.3);
  text-align: left;
}

.info-row span {
  font-weight: 600;
  font-size: 13px;
  color: #000000 !important;
}

.info-row strong {
  font-weight: 700;
  font-size: 13.5px;
  color: #000000 !important;
}

.info-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 10px;
  text-align: left;
  width: 100%;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  text-align: right;
}

.info-item span {
  font-weight: 600;
  font-size: 13px;
  color: #000000 !important;
}

.info-item strong {
  font-weight: 700;
  font-size: 13.5px;
  color: #000000 !important;
}

.totals-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 6px;
  width: 100%;
  justify-items: center;
}

.totals-inline {
  display: flex;
  flex-wrap: nowrap;
  width: 100%;
  justify-content: center;
  align-items: stretch;
  gap: 8px;
  overflow: hidden;
}

.totals-inline__item {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 3px;
  padding: 4px 10px;
  border-radius: 9px;
  background: #f8fafc;
  border: 1px solid rgba(148, 163, 184, 0.3);
  white-space: nowrap;
  font-size: 0.64rem;
  font-family: 'Tajawal', sans-serif;
  flex: 0 0 auto;
}

.totals-inline__label {
  font-weight: 600;
  color: #000000 !important;
}

.totals-inline__slash {
  font-weight: 600;
  color: #000000 !important;
}

.totals-inline__value {
  font-weight: 700;
  color: #000000 !important;
}

.totals-final {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  width: 100%;
  margin-top: 6px;
}

.totals-item--final {
  background: rgba(59, 91, 220, 0.12);
  border-color: rgba(59, 91, 220, 0.35);
  padding: 8px 16px;
  min-width: 200px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  border-radius: 12px;
}

.totals-item__label {
  font-weight: 600;
  color: #000000 !important;
  font-size: 0.7rem;
}

.totals-item__slash {
  font-weight: 600;
  color: #000000 !important;
  font-size: 0.7rem;
}

.totals-item__value {
  font-weight: 700;
  color: #000000 !important;
  font-size: 0.78rem;
}

.quote-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 12px;
  border: 1px solid rgba(148, 163, 184, 0.5);
  background-color: #ffffff !important;
  direction: rtl;
  text-align: center;
  page-break-inside: auto;
  word-break: break-word;
}

.quote-table thead,
.quote-table tbody,
.quote-table tr,
.quote-table th,
.quote-table td {
  background-color: #ffffff !important;
  color: #000000 !important;
  direction: rtl;
  text-align: center;
}

.quote-table th {
  padding: 9px 8px;
  font-weight: 700;
}

.quote-table th,
.quote-table td {
  border: 1px solid rgba(148, 163, 184, 0.5);
  text-align: center;
  padding: 9px 6px;
}

.quote-table tbody tr:last-child td {
  border-bottom: 1.5px solid rgba(148, 163, 184, 0.7);
}

.quote-section--table {
  display: block;
  clear: both;
  overflow: visible;
  break-inside: auto;
  page-break-inside: auto;
  page-break-after: auto;
  padding-top: 4mm;
}

.quote-section--table-fragment {
  padding-top: 4mm;
}

.quote-section--table-fragment--continued {
  padding-top: 2mm;
  margin-top: 6px;
}

.quote-section--table-fragment--continued h3 {
  margin-top: 0;
}

.quote-section--table-fragment--overflow {
  overflow: visible;
}

.quote-page .quote-section--table:first-of-type {
  padding-top: 0;
}
.quote-page .quote-section--table.quote-section--table-fragment--continued:first-of-type {
  padding-top: 2mm;
}

.quote-table {
  page-break-inside: auto;
  break-inside: auto;
  overflow: visible;
  margin-top: 2mm;
}

.quote-table thead {
  display: table-header-group;
}

.quote-table tbody {
  display: table-row-group;
}

.quote-table tr {
  page-break-inside: avoid;
  page-break-after: auto;
}

.quote-table td {
  padding: 9px 8px;
}

.quote-table .quote-item-code {
  display: inline-block;
  padding: 2px 4px;
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.08);
  margin-bottom: 2px;
}

.quote-table .quote-package-items {
  margin: 6px 0 0;
  padding-left: 16px;
  font-size: 12px;
  color: rgba(0, 0, 0, 0.75);
}

.quote-table .quote-package-items li {
  list-style: disc;
  margin-bottom: 2px;
}

.quote-table .quote-package-barcode {
  color: rgba(0, 0, 0, 0.6);
  font-size: 11px;
}

.quote-table .empty {
  padding: 14px;
  font-weight: 500;
  color: #000000 !important;
}

.quote-notes {
  background: #ffffff;
  border: 1px solid rgba(148, 163, 184, 0.38);
  border-radius: 12px;
  padding: 10px 12px;
  min-height: 0;
  font-family: 'Tajawal', 'Arial', 'Tahoma', sans-serif;
  font-size: 13px;
  line-height: 1.85;
  letter-spacing: normal;
  white-space: pre-wrap;
  word-break: normal;
  overflow-wrap: anywhere;
  line-break: normal;
  unicode-bidi: plaintext;
  font-feature-settings: 'liga' 1, 'rlig' 1;
  font-kerning: normal;
  text-align: right;
}

.quote-notes img[data-quote-note-image] {
  width: 100%;
  height: auto;
  display: block;
  border-radius: inherit;
}

.quote-approval-note {
  margin-top: 12px;
  font-size: 12px;
  background: rgba(234, 179, 8, 0.15);
  border-radius: 10px;
  padding: 10px 12px;
  border: 1px solid rgba(234, 179, 8, 0.3);
  text-align: right;
}

.quote-footer {
  margin-top: 20px;
  border-top: 1px solid rgba(148, 163, 184, 0.35);
  padding-top: 10px;
  text-align: right;
}

.quote-footer h4 {
  margin: 0 0 10px;
  font-size: 14px;
  font-weight: 700;
  text-align: right;
}

.quote-footer ul {
  margin: 0;
  font-size: 12px;
  line-height: 1.6;
  direction: rtl;
  text-align: right;
  padding-inline-start: 0;
  padding-inline-end: 18px;
}

@media print {
  #quotation-pdf-root {
    width: 210mm;
    min-width: 210mm;
    max-width: 210mm;
    min-height: auto;
    padding: 0;
    margin: 0 auto;
  }

  .quote-preview-pages {
    gap: 0;
  }

  .quote-page {
    box-shadow: none;
  }
}
`,pI=/color\([^)]*\)/gi,to=/(color\(|color-mix\(|oklab|oklch)/i,fI=["color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","outlineColor","fill","stroke"],hI=typeof document<"u"?document.createElement("canvas"):null,nc=hI?.getContext?.("2d")||null;function ov(e){return e.replace(/[A-Z]/g,t=>`-${t.toLowerCase()}`)}function ku(e,t="#000"){if(!nc||!e)return t;try{return nc.fillStyle="#000",nc.fillStyle=e,nc.fillStyle||t}catch{return t}}function cv(){const e=window.html2canvas;if(!e?.Color||e.Color.__artRatioPatched)return;const t=e.Color.fromString.bind(e.Color);e.Color.fromString=n=>{try{return t(n)}catch(a){if(typeof n=="string"&&to.test(n)){const s=ku(n)||"#000";try{return t(s)}catch{return t("#000")}}throw a}},e.Color.__artRatioPatched=!0}function kr(e,t,n){if(!e||!t?.style)return;const a=t.style.getPropertyValue(n),s=t.style.getPropertyPriority(n);e.push({element:t,prop:n,value:a,priority:s})}function yI(e=[]){if(!(!Array.isArray(e)||!e.length))for(let t=e.length-1;t>=0;t-=1){const{element:n,prop:a,value:s,priority:r}=e[t]||{};!n?.style||!a||(s&&s.length>0?n.style.setProperty(a,s,r||""):n.style.removeProperty(a))}}function Ep(e,t=window,n=[]){if(!e||!t||typeof t.getComputedStyle!="function")return;const a=e.querySelectorAll?.("*");a&&a.forEach(s=>{const r=t.getComputedStyle(s);if(!r)return;fI.forEach(o=>{const l=r[o];if(l&&to.test(l)){const d=ov(o);kr(n,s,d);const u=o==="backgroundColor"?"#ffffff":r.color||"#000000",m=ku(l,u);s.style.setProperty(d,m,"important")}});const i=r.backgroundImage;if(i&&to.test(i)){const o=ku(r.backgroundColor||"#ffffff","#ffffff");kr(n,s,"background-image"),kr(n,s,"background-color"),s.style.setProperty("background-image","none","important"),s.style.setProperty("background-color",o,"important")}})}function wp(e,t=window,n=[]){if(!e||!t||typeof t.getComputedStyle!="function")return;const a=e.querySelectorAll?.("*");a&&a.forEach(s=>{const r=t.getComputedStyle(s);if(!r)return;["color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor"].forEach(o=>{const l=r[o];if(l&&to.test(l)){const d=ov(o);kr(n,s,d);const u=o==="backgroundColor"?"#ffffff":"#000000";s.style.setProperty(d,u,"important")}});const i=r.backgroundImage;i&&to.test(i)&&(kr(n,s,"background-image"),kr(n,s,"background-color"),s.style.setProperty("background-image","none","important"),s.style.setProperty("background-color","#ffffff","important"))})}function lv(e){if(!e)return;const t=(n="")=>typeof n=="string"&&n.includes("color(")?n.replace(pI,"#000"):n;e.querySelectorAll?.("style")?.forEach?.(n=>{const a=n.textContent;typeof a=="string"&&a.includes("color(")&&(n.textContent=t(a))}),e.querySelectorAll?.("[style]")?.forEach?.(n=>{const a=n.getAttribute("style");typeof a=="string"&&a.includes("color(")&&n.setAttribute("style",t(a))})}const dv="reservations.quote.sequence",kh={reservation:"reservations.quote.togglePrefs.v1",project:"projects.quote.togglePrefs.v1"},uv="https://help.artratio.sa/guide/quote-preview",bt={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",commercialRegistry:"4030485240",beneficiaryName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",bankName:"مصرف الراجحي",accountNumber:"٣٥٨٠٠٠٠١٠٠٠٦٠٨٦٠٦٥٧٠٦",iban:"SA1680000358608016065706",approvalNote:"الموافقة على هذا العرض تعتبر موافقة على جميع الشروط والأحكام."},gI=["يوم العمل هو 12 ساعة، ويتم احتساب نصف يوم إضافي بعد 20 ساعة، ثم يوم كامل بعد ذلك.","يمنع استخدام المعدات في أنشطة غير قانونية.","يتحمل المستأجر مسؤولية أي تلف أو فقدان.","يجب إعادة المعدات في حالتها الأصلية.","يتم فرض رسوم على الإلغاء إذا لم يتم الإبلاغ قبل 24 ساعة."],tn=[...gI],bI=["يتم دفع 50% من قيمة المشروع عند الموافقة على عرض السعر، ويتم استكمال الـ 50% المتبقية قبل التسليم النهائي.","يحصل العميل على حقوق استخدام النسخة النهائية في أي مكان يراه مناسباً، بينما تحتفظ الشركة بالمواد الخام ولا تستخدمها إلا بعد موافقة العميل ما لم يُتفق على غير ذلك.","يتم الاتفاق على جدول زمني للتنفيذ، وأي تعديلات إضافية خارج النطاق المتفق عليه تخضع لرسوم إضافية.","العميل مسؤول عن توفير التصاريح اللازمة للتصوير في المواقع المحددة، وأي تأخير ناتج عن ذلك قد يؤثر على مواعيد التسليم.","تُحفَظ المواد النهائية للمشروع لمدة 12 شهراً في أرشيف الشركة، ويمكن للعميل طلب نسخ إضافية خلال تلك الفترة.","يتحمّل العميل مسؤولية توفير بيئة عمل آمنة للفريق الفني والمعدات في موقع التصوير، ويضمن اتخاذ كافة الاحتياطات اللازمة للحفاظ على سلامتهم."];function _u(e){return e?e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0):[...tn]}function vI(){const e=document.getElementById("reservation-terms");if(e&&e.value.trim().length>0){const a=_u(e.value);if(a.length)return a}const t=document.getElementById("edit-res-terms");if(t&&t.value.trim().length>0){const a=_u(t.value);if(a.length)return a}const n=tn.join(`
`);return e&&e.value.trim().length===0&&(e.value=n),t&&t.value.trim().length===0&&(t.value=n),[...tn]}const SI=[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"بيانات العميل",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"تفاصيل الحجز",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"بيانات المشروع",defaultSelected:!0},{id:"financialSummary",labelKey:"reservations.quote.sections.financial",fallback:"الملخص المالي",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"قائمة المعدات",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"طاقم العمل",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"ملاحظات الحجز",defaultSelected:!0}],mv=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>O(b(String(t+1)))},{id:"code",labelKey:"reservations.details.table.headers.code",fallback:"الكود",render:e=>O(e?.barcode||"-")},{id:"description",labelKey:"reservations.details.table.headers.description",fallback:"الوصف",render:e=>O(e?.desc||e?.description||"-")},{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:e=>O(b(String(e?.qty||1)))},{id:"price",labelKey:"reservations.details.table.headers.price",fallback:"السعر",render:e=>O(b(Number(e?.price||0).toFixed(2)))}],pv=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>O(b(String(t+1)))},{id:"position",labelKey:"reservations.details.crew.position",fallback:"المنصب",render:e=>O(b(e?.positionLabel??e?.position_name??e?.role??c("reservations.crew.positionFallback","منصب بدون اسم")))},{id:"price",labelKey:"reservations.details.crew.clientPrice",fallback:"سعر العميل",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return O(`${b(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}}],Tu={customerInfo:[{id:"customerName",labelKey:"reservations.details.labels.customer",fallback:"العميل"},{id:"customerCompany",labelKey:"reservations.details.labels.company",fallback:"الشركة"},{id:"customerPhone",labelKey:"reservations.details.labels.phone",fallback:"الهاتف"},{id:"customerEmail",labelKey:"reservations.details.labels.email",fallback:"البريد"}],reservationInfo:[{id:"reservationId",labelKey:"reservations.details.labels.reservationId",fallback:"رقم الحجز"},{id:"reservationStart",labelKey:"reservations.details.labels.start",fallback:"بداية الحجز"},{id:"reservationEnd",labelKey:"reservations.details.labels.end",fallback:"نهاية الحجز"},{id:"reservationDuration",labelKey:"reservations.details.labels.duration",fallback:"عدد الأيام"}],projectInfo:[{id:"projectTitle",labelKey:"reservations.details.labels.project",fallback:"المشروع"},{id:"projectCode",labelKey:"reservations.details.labels.code",fallback:"الرمز"}],financialSummary:[{id:"equipmentTotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"إجمالي المعدات"},{id:"crewTotal",labelKey:"reservations.details.labels.crewTotal",fallback:"إجمالي الفريق"},{id:"discountAmount",labelKey:"reservations.details.labels.discount",fallback:"الخصم"},{id:"taxAmount",labelKey:"reservations.details.labels.tax",fallback:"الضريبة"},{id:"finalTotal",labelKey:"reservations.details.labels.total",fallback:"الإجمالي النهائي"}],payment:[{id:"beneficiary",labelKey:"reservations.quote.labels.beneficiary",fallback:"اسم المستفيد"},{id:"bank",labelKey:"reservations.quote.labels.bank",fallback:"اسم البنك"},{id:"account",labelKey:"reservations.quote.labels.account",fallback:"رقم الحساب"},{id:"iban",labelKey:"reservations.quote.labels.iban",fallback:"رقم الآيبان"}],items:mv.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),crew:pv.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n}))},fv=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>O(b(String(t+1)))},{id:"name",labelKey:null,fallback:"الاسم",render:e=>O(e?.name||e?.full_name||e?.fullName||"-")},{id:"role",labelKey:null,fallback:"الدور",render:e=>O(e?.role||e?.title||c("reservations.details.technicians.roleUnknown","غير محدد"))},{id:"phone",labelKey:null,fallback:"الهاتف",render:e=>O(e?.phone||e?.mobile||c("reservations.details.technicians.phoneUnknown","غير متوفر"))}],hv=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>O(b(String(t+1)))},{id:"label",labelKey:null,fallback:"البند",render:e=>O(e?.label||"-")},{id:"amount",labelKey:null,fallback:"المبلغ",render:e=>O(e?.displayAmount||"—")},{id:"note",labelKey:null,fallback:"ملاحظات",render:e=>O(e?.note||"-")}],yv=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>O(b(String(t+1)))},{id:"description",labelKey:null,fallback:"الوصف",render:e=>O(e?.description||"-")},{id:"totalQuantity",labelKey:null,fallback:"إجمالي الكمية",render:e=>O(b(String(e?.totalQuantity||0)))},{id:"reservationsCount",labelKey:null,fallback:"عدد الحجوزات",render:e=>O(b(String(e?.reservationsCount||0)))},{id:"totalCost",labelKey:null,fallback:"التكلفة التقديرية",render:e=>O(e?.displayCost||"—")}],AI=[{id:"customerInfo",labelKey:"projects.quote.sections.customer",fallback:"بيانات العميل",defaultSelected:!0},{id:"projectInfo",labelKey:"projects.quote.sections.project",fallback:"بيانات المشروع",defaultSelected:!0},{id:"projectExpenses",labelKey:"projects.quote.sections.expenses",fallback:"متطلبات المشروع",defaultSelected:!0},{id:"projectCrew",labelKey:"projects.quote.sections.crew",fallback:"طاقم العمل",defaultSelected:!0},{id:"financialSummary",labelKey:"projects.quote.sections.financial",fallback:"الملخص المالي",defaultSelected:!0},{id:"projectEquipment",labelKey:"projects.quote.sections.equipment",fallback:"المعدات",defaultSelected:!0},{id:"projectNotes",labelKey:"projects.quote.sections.notes",fallback:"ملاحظات المشروع",defaultSelected:!0}],EI={customerInfo:Tu.customerInfo,projectInfo:[{id:"projectTitle",labelKey:"projects.details.overview.heading",fallback:"معلومات المشروع"},{id:"projectCode",labelKey:"projects.details.labels.code",fallback:"رقم المشروع"},{id:"projectType",labelKey:"projects.details.type",fallback:"نوع المشروع"},{id:"projectStart",labelKey:"projects.details.start",fallback:"بداية المشروع"},{id:"projectEnd",labelKey:"projects.details.end",fallback:"نهاية المشروع"},{id:"projectDuration",labelKey:"projects.details.duration",fallback:"مدة المشروع"},{id:"projectStatus",labelKey:"projects.details.status",fallback:"حالة المشروع"}],financialSummary:[{id:"projectSubtotal",labelKey:"projects.details.summary.projectSubtotal",fallback:"إجمالي المشروع"},{id:"expensesTotal",labelKey:"projects.details.expensesTotal",fallback:"إجمالي المصاريف"},{id:"reservationsTotal",labelKey:"projects.details.reservationsTotal",fallback:"إجمالي الحجوزات"},{id:"discountAmount",labelKey:"projects.details.summary.discount",fallback:"الخصم"},{id:"taxAmount",labelKey:"projects.details.summary.combinedTax",fallback:"الضريبة"},{id:"overallTotal",labelKey:"projects.details.summary.overallTotal",fallback:"الإجمالي الكلي"},{id:"paidAmount",labelKey:"projects.details.summary.paidAmount",fallback:"المدفوع"},{id:"remainingAmount",labelKey:"projects.details.summary.remainingAmount",fallback:"المتبقي للدفع"}],payment:Tu.payment,projectExpenses:hv.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),projectCrew:fv.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),projectEquipment:yv.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),projectNotes:[]},Id=new Map;function Ol(e="reservation"){if(Id.has(e))return Id.get(e);const t=e==="project"?AI:SI,n=e==="project"?EI:Tu,a=new Set(t.map(({id:i})=>i)),s=Object.fromEntries(Object.entries(n).map(([i,o=[]])=>[i,new Set(o.map(l=>l.id))])),r={sectionDefs:t,fieldDefs:n,sectionIdSet:a,fieldIdMap:s};return Id.set(e,r),r}function Ul(e="reservation"){return Ol(e).sectionDefs}function gv(e="reservation"){return Ol(e).fieldDefs}function bv(e="reservation"){return Ol(e).sectionIdSet}function vv(e="reservation"){return Ol(e).fieldIdMap}function Sv(e){switch(e){case"export":return c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...");case"render":default:return c("reservations.quote.status.rendering","جاري تحديث المعاينة...")}}const wI="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",jI="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",II="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",Av=mI.trim(),Ev=/^data:image\/svg\+xml/i,xI=/\.svg($|[?#])/i,Ci=512,Cu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/B8AAusB9YwpClgAAAAASUVORK5CYII=",wv=96,jv=25.4,Pu=210,Lc=297,Nc=Math.round(Pu/jv*wv),$c=Math.round(Lc/jv*wv),qI=2,Iv=/safari/i,kI=/(iphone|ipad|ipod)/i,_h=/(iphone|ipad|ipod)/i,_I=/(crios|fxios|edgios|opios)/i,sl="[reservations/pdf]";let ge=null,ne=null,Kn=1,Ei=null,wi=null,Ha=null,_r=null,Ri=!1;function Ps(e="render",{message:t,actionLabel:n,onAction:a,showSpinner:s=e!=="error"}={}){if(!ge?.statusIndicator||!ge?.statusText)return;ge.statusKind=e;const r=t||Sv(e);ge.statusText.textContent=r,ge.statusSpinner&&(ge.statusSpinner.hidden=!s),ge.statusAction&&(ge.statusAction.hidden=!0,ge.statusAction.onclick=null,n&&typeof a=="function"&&(ge.statusAction.textContent=n,ge.statusAction.hidden=!1,ge.statusAction.onclick=i=>{i.preventDefault(),a()})),ge.statusIndicator.hidden=!1,requestAnimationFrame(()=>{ge.statusIndicator.classList.add("is-visible")})}function Mi(e){!ge?.statusIndicator||!ge?.statusText||(ge.statusKind=null,ge.statusIndicator.classList.remove("is-visible"),setTimeout(()=>{ge?.statusIndicator&&(ge.statusIndicator.hidden=!0,ge.statusAction&&(ge.statusAction.hidden=!0,ge.statusAction.onclick=null),ge.statusSpinner&&(ge.statusSpinner.hidden=!1))},220))}function Lu(){return!!window?.bootstrap?.Modal}function TI(e){if(e&&!e.classList.contains("show")){e.classList.add("show"),e.style.display="block",e.removeAttribute("aria-hidden"),e.setAttribute("aria-modal","true"),e.getAttribute("role")||e.setAttribute("role","dialog"),document.body.classList.add("modal-open"),Ha||(Ha=document.createElement("div"),Ha.className="modal-backdrop fade show",Ha.dataset.quotePdfFallbackBackdrop="true",document.body.appendChild(Ha)),_r||(_r=t=>{t.key==="Escape"&&Nu(e)},document.addEventListener("keydown",_r));try{e.focus({preventScroll:!0})}catch{}}}function Nu(e){!e||!e.classList.contains("show")||(e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal"),document.body.classList.remove("modal-open"),Ha&&(Ha.remove(),Ha=null),_r&&(document.removeEventListener("keydown",_r),_r=null))}function CI(e){if(e){if(Lu()){window.bootstrap.Modal.getOrCreateInstance(e).show();return}TI(e)}}function PI(){if(Ri)return;Ri=!0;const e=c("reservations.quote.toast.viewGuide","📘 عرض دليل الحل السريع"),t=c("reservations.quote.toast.retry","إعادة المحاولة"),n=c("reservations.quote.toast.assetsFailed","⚠️ تعذر تحميل بعض الصور ضمن عرض السعر."),a=!!ge?.modal?.classList.contains("show"),s=()=>{ge?.modal?.classList.contains("show")&&(Ps("render"),Ri=!1,rr())};vg({message:n,duration:9e3,actionLabel:a?t:void 0,onAction:a?s:void 0,linkLabel:e,linkHref:uv}),a&&Ps("error",{message:n,actionLabel:t,onAction:s,showSpinner:!1})}function Vl(e="reservation"){const t={},n=gv(e);return Object.entries(n).forEach(([a,s=[]])=>{t[a]=new Set(s.filter(r=>r?.default!==!1).map(r=>r.id))}),t}function jp(e={}){const t={};return Object.entries(e).forEach(([n,a])=>{t[n]=new Set(Array.from(a||[]))}),t}function LI(e={},t){if(t)return e[t]||(e[t]=new Set),e[t]}function Ip(e={},t,n){const a=e?.[t];return a?a instanceof Set?a.has(n):Array.isArray(a)?a.includes(n):!!a?.[n]:!0}function xp(e="reservation"){return Object.fromEntries(Ul(e).map(({id:t})=>[t,!1]))}function qp(e,t){return e.sectionExpansions||(e.sectionExpansions=xp(e.context||"reservation")),t&&typeof e.sectionExpansions[t]!="boolean"&&(e.sectionExpansions[t]=!1),e.sectionExpansions}function NI(e,t){return qp(e,t)?.[t]!==!1}function kp(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches}function $I(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||navigator.platform||"";return kI.test(e)}function DI(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=Iv.test(e),n=e.includes("Chrome")||e.includes("CriOS")||e.includes("Chromium"),a=e.includes("Edg");return t&&!n&&!a}function xv(){return $I()&&DI()}function Kl(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=navigator.platform||"",n=Number.isFinite(navigator.maxTouchPoints)?navigator.maxTouchPoints:0,a=_h.test(e)||_h.test(t),s=/Macintosh/i.test(e)&&n>1;return Iv.test(e)&&!_I.test(e)&&(a||s)}function xd(e,...t){try{console.log(`${sl} ${e}`,...t)}catch{}}function ba(e,...t){try{console.warn(`${sl} ${e}`,...t)}catch{}}function BI(e,t,...n){try{t?console.error(`${sl} ${e}`,t,...n):console.error(`${sl} ${e}`,...n)}catch{}}function ot(e,{blockType:t="section",extraAttributes:n=""}={}){if(!e)return"";const a=n?` ${n.trim()}`:"";return e.replace(/^(<\w+)/,`$1 data-quote-block data-block-type="${t}"${a}`)}function FI(e,t="لا توجد بيانات للعرض."){const n=O(c(e,t));return ot(`<section class="quote-section quote-placeholder">${n}</section>`,{blockType:"placeholder"})}function rl(e,t){return Array.isArray(e)&&e.length?e:[FI(t)]}const RI=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;function qv(e=""){return RI.test(e)}function MI(){const e=window.CanvasRenderingContext2D?.prototype;if(!e||e.__artRatioDirectionPatched)return;const t=n=>{const a=e[n];typeof a=="function"&&(e[n]=function(r,...i){if(typeof r!="string"||!qv(r))return a.call(this,r,...i);let o,l=!1;try{"direction"in this&&(o=this.direction,o!=="rtl"&&(this.direction="rtl"),l=!0)}catch{}try{if(!l){const d=this.canvas;d&&d.style?.direction!=="rtl"&&(d.__artRatioOriginalDirection=d.style.direction,d.style.direction="rtl")}return a.call(this,r,...i)}finally{if(l&&o!==void 0&&o!=="rtl")try{this.direction=o}catch{}else if(!l){const d=this.canvas;d&&d.__artRatioOriginalDirection!==void 0&&(d.style.direction=d.__artRatioOriginalDirection,delete d.__artRatioOriginalDirection)}}})};t("fillText"),t("strokeText"),e.__artRatioDirectionPatched=!0}function Th(e,t=Ci){if(typeof e!="string"&&typeof e!="number")return t;const n=parseFloat(String(e).replace(/[^0-9.+-]/g,""));return Number.isFinite(n)&&n>0?n:t}function HI(e){if(!e)return{width:Ci,height:Ci};const t=e.getAttribute?.("width"),n=e.getAttribute?.("height");let a=t?Th(t,0):0,s=n?Th(n,0):0;if(a>0&&s>0)return{width:a,height:s};const r=e.getAttribute?.("viewBox");if(r){const i=r.trim().split(/[\s,]+/).map(o=>parseFloat(o||"0"));if(i.length>=4){const[,,o,l]=i;a=a||(Number.isFinite(o)&&o>0?o:0),s=s||(Number.isFinite(l)&&l>0?l:0)}}return{width:a||Ci,height:s||Ci}}function kv(e=""){return typeof e!="string"?!1:Ev.test(e)||xI.test(e)}function zI(e=""){const t=e.indexOf(",");if(t===-1)return"";const n=e.slice(0,t),a=e.slice(t+1);try{return/;base64/i.test(n)?typeof atob=="function"?atob(a):"":decodeURIComponent(a)}catch(s){return console.warn("[reservations/pdf] failed to decode SVG data URI",s),""}}function OI(e,{crossOrigin:t}={}){return new Promise((n,a)=>{const s=new Image;t&&(s.crossOrigin=t),s.onload=()=>n(s),s.onerror=r=>{const i=r?.message||`Unable to load image from ${e}`;a(new Error(i))},s.src=e})}async function _v(e,t={}){if(!e)return null;const n=document,a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a);try{const r=await OI(s),i=n.createElement("canvas"),o=Math.max(t.width||r.naturalWidth||r.width||0,1),l=Math.max(t.height||r.naturalHeight||r.height||o,1);i.width=o,i.height=l;const d=i.getContext("2d");return d.clearRect(0,0,o,l),d.drawImage(r,0,0,o,l),i.toDataURL("image/png")}catch(r){return console.warn("[reservations/pdf] failed to rasterize SVG content",r),null}finally{URL.revokeObjectURL(s)}}async function UI(e){if(!e)return null;if(Ev.test(e))return zI(e);try{const t=await fetch(e,{mode:"cors",credentials:"omit",cache:"default"});return t.ok?await t.text():(console.warn("[reservations/pdf] failed to fetch SVG image",e,t.status),null)}catch(t){return console.warn("[reservations/pdf] error fetching SVG image",e,t),null}}async function VI(e){if(!e)return!1;const t=e.getAttribute?.("src")||"";if(!kv(t))return!1;const n=await UI(t);if(!n)return e.dataset.svgRasterization="failed",e.setAttribute("src",Cu),!1;const a=await _v(n);return a?(e.dataset.svgOriginalSrc=t,e.setAttribute("src",a),e.setAttribute("data-rasterized","true"),!0):(e.dataset.svgRasterization="failed",e.setAttribute("src",Cu),!1)}async function KI(e){if(!e||e.tagName?.toLowerCase()!=="svg")return!1;const n=new XMLSerializer().serializeToString(e),a=HI(e),s=await _v(n,a),i=(e.ownerDocument||document).createElement("img");i.setAttribute("src",s||Cu),i.setAttribute("alt",e.getAttribute("aria-label")||e.getAttribute("title")||""),i.setAttribute("data-svg-replaced","true"),e.hasAttribute("class")&&i.setAttribute("class",e.getAttribute("class")),e.hasAttribute("style")&&i.setAttribute("style",e.getAttribute("style"));const o=e.getAttribute("width"),l=e.getAttribute("height");return o&&i.setAttribute("width",o),l&&i.setAttribute("height",l),e.parentNode?.replaceChild(i,e),!!s}async function Tv(e){if(!e)return;const t=Array.from(e.querySelectorAll?.("img")||[]),n=Array.from(e.querySelectorAll?.("svg")||[]),a=[];t.forEach(s=>{kv(s.getAttribute?.("src"))&&a.push(VI(s))}),n.forEach(s=>{a.push(KI(s))}),a.length&&await Promise.allSettled(a)}function WI(e,{pixelRatio:t=1}={}){if(!e)return null;const n=e.ownerDocument||document,s=(n.defaultView||window).getComputedStyle?.(e);if(!s)return null;const r=(R,M=0)=>{const H=parseFloat(R);return Number.isFinite(H)?H:M},i=r(s.paddingTop),o=r(s.paddingBottom),l=r(s.paddingRight),d=r(s.paddingLeft),u=r(s.borderRadius),m=r(s.fontSize,14),p=(()=>{const R=s.lineHeight;if(!R||R==="normal")return m*1.6;const M=r(R,m*1.6);return M>0?M:m*1.6})(),f=Math.max(e.clientWidth||0,e.scrollWidth||0,r(s.width,0));if(f<=0)return null;const h=Math.max(1,f-d-l),g=e.textContent||"",y=g.split(/\r?\n/),E=n.createElement("canvas"),S=E.getContext("2d");if(!S)return null;const x=s.fontStyle||"normal",A=s.fontVariant||"normal",C=s.fontWeight||"400",j=s.fontFamily||"sans-serif",k=s.fontStretch||"normal",w=R=>R.join(" "),_=[],$=R=>S.measureText(R).width;S.font=`${x} ${A} ${C} ${k} ${m}px ${j}`,y.forEach(R=>{const M=R.trim();if(M.length===0){_.push("");return}const H=M.split(/\s+/);let V=[];H.forEach((G,ie)=>{const ee=G.trim();if(!ee)return;const oe=w(V.concat(ee));if($(oe)<=h||V.length===0){V.push(ee);return}_.push(w(V)),V=[ee]}),V.length&&_.push(w(V))}),_.length||_.push("");const q=i+o+_.length*p,F=Math.ceil(Math.max(1,f)*t),U=Math.ceil(Math.max(1,q)*t);E.width=F,E.height=U,E.style.width=`${Math.max(1,f)}px`,E.style.height=`${Math.max(1,q)}px`,S.scale(t,t);const L=s.backgroundColor&&s.backgroundColor!=="rgba(0, 0, 0, 0)"?s.backgroundColor:"#ffffff";if(u>0){S.save(),S.beginPath();const R=Math.max(1,f),M=Math.max(1,q),H=Math.min(u,R/2,M/2);S.moveTo(H,0),S.lineTo(R-H,0),S.quadraticCurveTo(R,0,R,H),S.lineTo(R,M-H),S.quadraticCurveTo(R,M,R-H,M),S.lineTo(H,M),S.quadraticCurveTo(0,M,0,M-H),S.lineTo(0,H),S.quadraticCurveTo(0,0,H,0),S.closePath(),S.clip()}if(S.fillStyle=L,S.fillRect(0,0,Math.max(1,f),Math.max(1,q)),S.font=`${x} ${A} ${C} ${k} ${m}px ${j}`,S.fillStyle=s.color||"#000000",S.textBaseline="top",S.textAlign="right","direction"in S)try{S.direction="rtl"}catch{}const B=Math.max(0,f-l);let D=i;_.forEach(R=>{const M=R.length?R:" ";S.fillText(M,B,D,h),D+=p});const K=n.createElement("img");let Z;try{Z=E.toDataURL("image/png")}catch(R){return ba("note canvas toDataURL failed",R),null}return K.src=Z,K.alt=g,K.style.width=`${Math.max(1,f)}px`,K.style.height=`${Math.max(1,q)}px`,K.style.display="block",K.setAttribute("data-quote-note-image","true"),{image:K,canvas:E,totalHeight:q,width:f}}function QI(e,{pixelRatio:t=1}={}){if(!e||!Kl())return;Array.from(e.querySelectorAll?.(".quote-notes")||[]).forEach(a=>{if(!a||a.dataset.quoteNoteRasterized==="true"||!qv(a.textContent||""))return;let s;try{s=WI(a,{pixelRatio:t})}catch(r){ba("failed to rasterize note content",r),s=null}s&&(a.dataset.quoteNoteRasterized="true",a.innerHTML="",a.appendChild(s.image))})}function $u(e,t="export",{toastMessage:n,suppressToast:a=!1}={}){BI(`${t} failed`,e);const s=!!(e&&e.__artRatioPdfNotified);if(!a&&!s){const r=c("reservations.quote.errors.exportFailed","⚠️ تعذر إنشاء ملف PDF، يرجى المحاولة مرة أخرى."),i=n||r,o=c("reservations.quote.toast.viewGuide","📘 عرض دليل الحل السريع"),l=c("reservations.quote.toast.retry","إعادة المحاولة"),d=["exportQuoteAsPdf","renderQuotePreview","layoutQuoteDocument","pageCapture"].includes(t),u=()=>{t==="exportQuoteAsPdf"?(Ps("export"),Hv()):(Ps("render"),Ri=!1,rr())};if(vg({message:i,duration:9e3,actionLabel:d?l:void 0,onAction:d?u:void 0,linkLabel:o,linkHref:uv}),ge?.modal?.classList.contains("show")&&Ps("error",{message:i,actionLabel:d?l:void 0,onAction:d?u:void 0,showSpinner:!1}),e&&typeof e=="object")try{Object.defineProperty(e,"__artRatioPdfNotified",{value:!0,writable:!1,enumerable:!1,configurable:!0})}catch{}}}function Du({container:e,safariWindowRef:t,mobileWindowRef:n}={}){try{n&&!n.closed&&n.close()}catch(a){ba("failed to close mobile window",a)}try{t&&!t.closed&&t.close()}catch(a){ba("failed to close safari window",a)}e&&e.parentNode&&e.parentNode.removeChild(e)}function _p(e){return new Promise((t,n)=>{const a=document.querySelector(`script[src="${e}"]`);if(a){a.addEventListener("load",()=>t()),a.addEventListener("error",r=>n(r)),a.readyState==="complete"&&t();return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>t(),s.onerror=r=>n(r),document.head.appendChild(s)})}function Ch(){const e=[window.jspdf?.jsPDF,typeof window.jspdf=="function"?window.jspdf:null,window.jsPDF?.jsPDF,typeof window.jsPDF=="function"?window.jsPDF:null].filter(t=>typeof t=="function");return e.length?e[0]:null}function Ph(){return typeof window.html2canvas=="function"?window.html2canvas:null}async function GI(){const e=Ph();return e||(wi||(wi=_p(jI).catch(t=>{throw wi=null,t}).then(()=>{const t=Ph();if(!t)throw wi=null,new Error("تعذر تحميل مكتبة html2canvas المطلوبة.");return t})),wi)}async function YI(){const e=Ch();return e||(Ei||(Ei=_p(II).catch(t=>{throw Ei=null,t}).then(()=>{const t=Ch();if(!t)throw Ei=null,new Error("تعذر تحميل مكتبة jsPDF المطلوبة.");return t})),Ei)}async function XI(){if(window.html2pdf||await _p(wI),window.html2pdf&&!window.html2pdf.__artRatioConfigured){const e=window.html2pdf.defaultOptions||window.html2pdf.defaultOpt||{},t={...e.html2canvas||{}};t.useCORS=!0,t.allowTaint=!1,t.logging=!0;const n={unit:"mm",format:"a4",orientation:"portrait",compress:!0,...e.jsPDF||{}},a={image:{type:"jpeg",quality:.95,...e.image||{}},margin:e.margin??[0,0,0,0],filename:e.filename||"document.pdf",html2canvas:t,jsPDF:n};window.html2pdf.defaultOptions=a,window.html2pdf.defaultOpt=a,window.html2pdf.__artRatioConfigured=!0}cv(),MI()}function O(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function JI(e="reservation"){return e==="project"?"QP":"Q"}function ZI(e,t="reservation"){const n=Number(e),a=JI(t);return!Number.isFinite(n)||n<=0?`${a}-0001`:`${a}-${String(n).padStart(4,"0")}`}function ex(){const e=window.localStorage?.getItem?.(dv),t=parseInt(e??"",10);return Number.isFinite(t)&&t>0?t:0}function Cv(e="reservation"){const n=ex()+1;return{sequence:n,quoteNumber:ZI(n,e)}}function tx(e){try{const t=Number(e);if(!Number.isFinite(t)||t<=0)return;window.localStorage?.setItem?.(dv,String(t))}catch(t){console.warn("⚠️ [reservations/pdf] failed to persist quote sequence",t)}}function Pv(e="reservation"){return kh[e]||kh.reservation}function nx(e="reservation"){try{const t=Pv(e),n=window.localStorage?.getItem?.(t);if(!n)return null;const a=JSON.parse(n);return a&&typeof a=="object"?a:null}catch(t){return console.warn("⚠️ [reservations/pdf] failed to read toggle preferences",t),null}}function ax(e,t="reservation"){try{const n=Pv(t);if(!e){window.localStorage?.removeItem?.(n);return}window.localStorage?.setItem?.(n,JSON.stringify(e))}catch(n){console.warn("⚠️ [reservations/pdf] failed to persist toggle preferences",n)}}function sx(e){if(!e)return{ids:null,emptyExplicitly:!1};if(e instanceof Set)return{ids:Array.from(e),emptyExplicitly:e.size===0};if(Array.isArray(e))return{ids:e.slice(),emptyExplicitly:e.length===0};if(typeof e=="object"){const t=Object.entries(e).filter(([,n])=>!!n);return{ids:t.map(([n])=>n),emptyExplicitly:t.length===0}}return{ids:null,emptyExplicitly:!1}}function rx(e,t="reservation"){if(!e)return null;const n=bv(t),a=vv(t),s=Array.from(e.sections instanceof Set?e.sections:new Set(e.sections||[])).filter(o=>n.has(o)),r={},i=e.fields||{};return Object.entries(a).forEach(([o,l])=>{const d=i[o];if(d==null)return;const{ids:u,emptyExplicitly:m}=sx(d);if(!u&&!m)return;const p=Array.isArray(u)?u.filter(f=>l.has(f)):[];(p.length>0||m)&&(r[o]=p)}),{version:1,sections:s,fields:r}}function Lv(e){if(!e)return;const t=e.context||"reservation",n=rx(e,t);n&&ax(n,t)}function Nv(e){if(!e)return;const t=e.context||"reservation",n=nx(t);if(!n)return;const a=bv(t),s=Array.isArray(n.sections)?n.sections.filter(r=>a.has(r)):[];if(s.length&&(e.sections=new Set(s)),n.fields&&typeof n.fields=="object"){const r=jp(e.fields||Vl(t)),i=vv(t);Object.entries(n.fields).forEach(([o,l])=>{const d=i[o];if(!d)return;const u=Array.isArray(l)?l.filter(m=>d.has(m)):[];r[o]=new Set(u)}),e.fields=r}}function $v(e=new Date){try{return e.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return e.toISOString().slice(0,10)}}function ix(e){const t=Ut()||[],{technicians:n=[]}=ae(),a=[].concat(Array.isArray(t)?t:[]).concat(Array.isArray(n)?n:[]),s=new Map;return a.forEach(i=>{if(!i||i.id==null)return;const o=String(i.id),l=s.get(o)||{};s.set(o,{...l,...i})}),(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(i=>({technicianId:i}))).map((i,o)=>{const l=i?.technicianId!=null?s.get(String(i.technicianId)):null;let d=i.positionLabel??i.position_name??i.position_label??i.role??i.position??l?.role??c("reservations.crew.positionFallback","منصب بدون اسم");(!d||d.trim()==="")&&(d=i.positionLabelAr??i.position_label_ar??i.positionLabelEn??i.position_label_en??i.position_name_ar??i.position_name_en??l?.role??c("reservations.crew.positionFallback","منصب بدون اسم"));try{const p=typeof Et=="function"?Et()||[]:[];let f=null;if(i?.positionId!=null&&(f=p.find(h=>String(h?.id)===String(i.positionId))||null),!f){const h=i.positionKey??i.position_key??i.positionName??i.position_name??i.position??"";if(h&&(f=typeof Br=="function"&&Br(h)||null,!f&&p.length)){const g=String(h).trim().toLowerCase();f=p.find(y=>[y.name,y.labelAr,y.labelEn].filter(Boolean).map(E=>String(E).toLowerCase()).includes(g))||null}}if(f){const h=f.labelAr||f.labelEn||f.name||"";h&&h.trim()&&(d=h)}}catch{}const u=Ee(xe(i.positionCost??i.position_cost??i.cost??i.daily_wage??i.dailyWage??l?.dailyWage??l?.wage??0)),m=Ee(xe(i.positionClientPrice??i.position_client_price??i.client_price??i.clientPrice??i.daily_total??i.dailyTotal??i.total??l?.dailyTotal??l?.total??l?.total_wage??0));return{assignmentId:i.assignmentId??i.assignment_id??`crew-${o}`,positionId:i.positionId??i.position_id??null,positionLabel:d,positionLabelAlt:i.positionLabelAlt??i.position_label_alt??"",positionCost:u,positionClientPrice:m,technicianId:i.technicianId!=null?String(i.technicianId):l?.id!=null?String(l.id):null,technicianName:i.technicianName??i.technician_name??l?.name??null,technicianRole:i.technicianRole??l?.role??null}})}function ox(e,t,n){const{projectLinked:a}=Vt(e,n);ri(e.start,e.end);const s=e.discount??e.discountValue??0,r=Number(b(String(s)))||0,i=e.discountType??e.discount_type??"percent",o=String(i).toLowerCase()==="amount"?"amount":"percent",l=a?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),d=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,u=d!=null?xe(d):Number.NaN,p=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied)===!0&&Number.isFinite(u)&&u>0?u:null,f=Array.isArray(t)?t.map(A=>A?.technicianId).filter(Boolean):[],h=xa({items:Array.isArray(e.items)?e.items:[],technicianIds:f,crewAssignments:Array.isArray(t)?t:[],discount:r,discountType:o,applyTax:l,start:e.start,end:e.end,companySharePercent:p}),g=xe(e.cost??e.total??e.finalTotal),y=Number.isFinite(g),E=a?h.finalTotal:y?Ee(g):h.finalTotal,S={equipmentTotal:h.equipmentTotal,crewTotal:h.crewTotal,crewCostTotal:h.crewCostTotal,discountAmount:h.discountAmount,subtotalAfterDiscount:h.subtotalAfterDiscount,taxableAmount:h.taxableAmount,taxAmount:h.taxAmount,finalTotal:E,companySharePercent:h.companySharePercent,companyShareAmount:h.companyShareAmount,netProfit:h.netProfit},x={equipmentTotal:b(h.equipmentTotal.toFixed(2)),crewTotal:b(h.crewTotal.toFixed(2)),discountAmount:b(h.discountAmount.toFixed(2)),subtotalAfterDiscount:b(h.subtotalAfterDiscount.toFixed(2)),taxableAmount:b(h.taxableAmount.toFixed(2)),taxAmount:b(h.taxAmount.toFixed(2)),finalTotal:b(E.toFixed(2)),companySharePercent:b((Number.isFinite(h.companySharePercent)?h.companySharePercent:0).toFixed(2)),companyShareAmount:b(h.companyShareAmount.toFixed(2)),netProfit:b(h.netProfit.toFixed(2))};return{totals:S,totalsDisplay:x,rentalDays:h.rentalDays}}function Wr(e){if(e==null||e==="")return null;const t=Number.parseFloat(b(String(e)));return Number.isFinite(t)?t:null}function Dv(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function cx(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n!=="percent"&&(n="amount");const a=Wr(e.amount??(n==="amount"?e.value:null)),s=Wr(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,i=e.note??e.memo??null,o=Dv(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:i,recordedAt:o}}function lx(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(cx).filter(Boolean);if(n.length>0)return n;const a=Wr(e.paidPercent??e.paid_percent),s=Wr(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,i=Dv(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:i}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:i}]:[]}function dx(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function ux(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function mx(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function px(e){const t=Number(e?.equipmentEstimate)||0,n=mx(e),a=t+n,s=e?.applyTax===!0||e?.applyTax==="true",r=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let o=(e?.discountType==="amount"?"amount":"percent")==="amount"?r:a*(r/100);(!Number.isFinite(o)||o<0)&&(o=0),o>a&&(o=a);const l=Math.max(0,a-o),d=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",u=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,m=d&&s&&u>0?u:0,p=m>0?Number((l*(m/100)).toFixed(2)):0,f=l+p;let h=s?f*mi:0;(!Number.isFinite(h)||h<0)&&(h=0),h=Number(h.toFixed(2));let g=s?Number(e?.totalWithTax):f;return s?(!Number.isFinite(g)||g<=0)&&(g=Number((f+h).toFixed(2))):g=f,{equipmentEstimate:t,expensesTotal:n,baseSubtotal:a,discountAmount:o,subtotalAfterDiscount:l,companyShareAmount:p,subtotal:f,applyTax:s,taxAmount:h,totalWithTax:g}}function fx(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(b(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=Js(t,a,s,!1,i,{start:e.start,end:e.end});if(Number.isFinite(o))return o;const l=Number(b(String(e.cost??0)));return Number.isFinite(l)?Math.round(l):0}function hx(e,t){if(!e)return"—";const n=mt(e);return t?`${n} - ${mt(t)}`:n}function Be(e,t="SR",n=2){const a=Number(e)||0,s=Number.isInteger(n)?n:2;return`${b(a.toFixed(s))} ${t}`}function Lh(e,t=2){if(!Number.isFinite(Number(e)))return"0%";const n=Number.isInteger(t)?t:2;return`${b(Number(e).toFixed(n))}%`}function yx(e){if(!e?.start)return null;if(!e?.end)return 1;const t=ri(e.start,e.end);return Number.isFinite(t)?t:1}function gx(e){return Number.isFinite(e)?e<=1?"يوم واحد":`${b(String(Math.round(e)))} أيام`:"غير محدد"}function bx(e){const t=c("reservations.create.summary.currency","SR"),{customers:n=[],reservations:a=[],projects:s=[],technicians:r=[]}=ae(),i=e?.id!=null?s.find(X=>String(X.id)===String(e.id))||e:e||null,o={projectStatusLabel:c("projects.status.ongoing","قيد التنفيذ"),paymentStatusLabel:c("projects.paymentStatus.unpaid","غير مدفوع")};if(!i)return{project:null,customer:null,clientInfo:{name:"-",company:"-",phone:"-",email:"-"},projectInfo:{title:"-",code:"-",typeLabel:"-",startDisplay:"-",endDisplay:"-",durationLabel:"-",statusLabel:o.projectStatusLabel},expenses:[],equipment:[],reservations:[],totals:{equipmentEstimate:0,expensesTotal:0,baseSubtotal:0,discountAmount:0,subtotalAfterDiscount:0,companyShareAmount:0,subtotal:0,applyTax:!1,taxAmount:0,totalWithTax:0},totalsDisplay:{projectSubtotal:Be(0,t),expensesTotal:Be(0,t),reservationsTotal:Be(0,t),discountAmount:Be(0,t),taxAmount:Be(0,t),overallTotal:Be(0,t),paidAmount:Be(0,t),remainingAmount:Be(0,t)},projectTotals:{combinedTaxAmount:0,overallTotal:0,reservationsTotal:0,paidAmount:0,paidPercent:0,remainingAmount:0,paymentStatus:"unpaid"},paymentSummary:{status:"unpaid",statusLabel:o.paymentStatusLabel,paidAmount:0,paidPercent:0,remainingAmount:0,paidAmountDisplay:Be(0,t),remainingAmountDisplay:Be(0,t),paidPercentDisplay:Lh(0)},notes:"",currencyLabel:t,projectStatus:"ongoing",projectStatusLabel:o.projectStatusLabel,projectDurationDays:null,projectDurationLabel:"غير محدد",paymentHistory:[]};const l=i.clientId??i.customerId??i.client_id??i.customer_id??null,d=l!=null&&n.find(X=>String(X.id)===String(l))||null,u=d?.customerName??d?.name??i.clientName??i.customerName??c("projects.fallback.unknownClient","عميل غير معروف"),m=(i.clientCompany||d?.companyName||d?.company||"").trim(),p=d?.phone??d?.customerPhone??i.clientPhone??i.customerPhone??"",f=p?b(String(p).trim()):c("projects.details.client.noPhone","لا يوجد رقم متاح"),h=d?.email??i.clientEmail??i.customerEmail??"",g=h?String(h).trim():c("projects.details.client.noEmail","لا يوجد بريد متاح"),y=i.projectCode||`PRJ-${b(String(i.id??""))}`,E=b(String(y)),S=(i.title||"").trim()||c("projects.fallback.untitled","مشروع بدون عنوان"),x=dx(i.type),A=i.start?mt(i.start):"—",C=i.end?mt(i.end):"—",j=yx(i),k=j!=null?gx(j):"غير محدد",w=ux(i),_={upcoming:"قادم",ongoing:"قيد التنفيذ",completed:"مكتمل"},$=c(`projects.status.${w}`,_[w]||w),q=i.id!=null?String(i.id):null,F=q?a.filter(X=>String(X.projectId)===q):[],L=F.map(X=>{const Ae=X.reservationId||X.id||"",Ne=X.status||X.state||"pending",je=String(Ne).toLowerCase(),fe=c(`reservations.status.${je}`,je),qe=fx(X),ze=X.start?new Date(X.start).getTime():0;return{reservationId:b(String(Ae||"-")),status:je,statusLabel:fe,total:qe,totalLabel:Be(qe,t),dateRange:hx(X.start,X.end),startTimestamp:Number.isNaN(ze)?0:ze}}).sort((X,Ae)=>Ae.startTimestamp-X.startTimestamp).map(({startTimestamp:X,...Ae})=>Ae).reduce((X,Ae)=>X+(Number(Ae.total)||0),0),B=new Map;F.forEach(X=>{const Ae=Array.isArray(X.items)?X.items:[],Ne=ri(X.start,X.end),je=X.reservationId||X.id||"";Ae.forEach((fe,qe)=>{if(!fe)return;const ze=fe.barcode||fe.code||fe.id||fe.desc||fe.description||`item-${qe}`,Je=String(ze||`item-${qe}`),Ye=B.get(Je)||{description:fe.desc||fe.description||fe.name||fe.barcode||`#${b(String(qe+1))}`,totalQuantity:0,reservationsCount:0,reservationIds:new Set,totalCost:0},_t=Number(fe.qty)||1,Zn=Number(fe.price)||0;Ye.totalQuantity+=_t,Ye.reservationIds.add(String(je));const Ta=Zn*_t*Math.max(1,Ne);Number.isFinite(Ta)&&(Ye.totalCost+=Ta),B.set(Je,Ye)})});const D=Array.from(B.values()).map(X=>({description:X.description,totalQuantity:X.totalQuantity,reservationsCount:X.reservationIds.size,displayCost:Be(X.totalCost,t)})),K=new Map((r||[]).filter(Boolean).map(X=>[String(X.id),X])),Z=new Map,R=X=>{if(!X)return;let Ae=null;typeof X=="object"?Ae=X.id??X.technicianId??X.technician_id??X.userId??X.user_id??null:(typeof X=="string"||typeof X=="number")&&(Ae=X);const Ne=Ae!=null?String(Ae):null,je=Ne&&K.has(Ne)?K.get(Ne):typeof X=="object"?X:null,fe=je?.name||je?.full_name||je?.fullName||je?.displayName||(typeof X=="string"?X:null),qe=je?.role||je?.title||null,ze=je?.phone||je?.mobile||je?.contact||null;if(!fe&&!Ne)return;const Je=Ne||fe;Z.has(Je)||Z.set(Je,{id:Ne,name:fe||"-",role:qe||null,phone:ze||null})};Array.isArray(i?.technicians)&&i.technicians.forEach(X=>R(X)),F.forEach(X=>{(Array.isArray(X.crewAssignments)&&X.crewAssignments.length?X.crewAssignments:Array.isArray(X.technicians)?X.technicians.map(Ne=>({technicianId:Ne})):[]).forEach(Ne=>R(Ne))});const M=Array.from(Z.values()),H=Array.isArray(i.expenses)?i.expenses.map(X=>{const Ae=Number(X?.amount)||0;return{label:X?.label||X?.name||"-",amount:Ae,displayAmount:Be(Ae,t),note:X?.note||X?.description||""}}):[],V=px(i),G=V.applyTax?Number(((V.subtotal+L)*mi).toFixed(2)):0,ie=Number((V.subtotal+L+G).toFixed(2)),ee=lx(i),oe=Wr(i.paidAmount??i.paid_amount)||0,W=Wr(i.paidPercent??i.paid_percent)||0,be=en({totalAmount:ie,paidAmount:oe,paidPercent:W,history:ee}),he=typeof i.paymentStatus=="string"?i.paymentStatus.toLowerCase():"",Se=fn({manualStatus:he,paidAmount:be.paidAmount,paidPercent:be.paidPercent,totalAmount:ie}),we={paid:"مدفوع",partial:"مدفوع جزئياً",unpaid:"غير مدفوع"},J=c(`projects.paymentStatus.${Se}`,we[Se]||Se),re=Number(be.paidAmount||0),ue=Number(be.paidPercent||0),Pe=Math.max(0,Number((ie-re).toFixed(2))),Te={projectSubtotal:Be(V.subtotal,t),expensesTotal:Be(V.expensesTotal,t),reservationsTotal:Be(L,t),discountAmount:Be(V.discountAmount,t),taxAmount:Be(G,t),overallTotal:Be(ie,t),paidAmount:Be(re,t),remainingAmount:Be(Pe,t)},ye={status:Se,statusLabel:J,paidAmount:re,paidPercent:ue,remainingAmount:Pe,paidAmountDisplay:Be(re,t),remainingAmountDisplay:Be(Pe,t),paidPercentDisplay:Lh(ue)},te=(i.description||"").trim();return{project:i,customer:d,clientInfo:{name:u,company:m||"—",phone:f,email:g},projectInfo:{title:S,code:E,typeLabel:x,startDisplay:A,endDisplay:C,durationLabel:k,statusLabel:$},expenses:H,equipment:D,crew:M,totals:V,totalsDisplay:Te,projectTotals:{combinedTaxAmount:G,overallTotal:ie,reservationsTotal:L,paidAmount:re,paidPercent:ue,remainingAmount:Pe,paymentStatus:Se},paymentSummary:ye,notes:te,currencyLabel:t,projectStatus:w,projectStatusLabel:$,projectDurationDays:j,projectDurationLabel:k,paymentHistory:ee}}function vx({project:e,clientInfo:t={},projectInfo:n={},projectCrew:a=[],projectExpenses:s=[],projectEquipment:r=[],totalsDisplay:i={},projectTotals:o={},paymentSummary:l={},currencyLabel:d="SR",sections:u,fieldSelections:m={},quoteNumber:p,quoteDate:f,terms:h=tn}){const g=jp(m),y=(J,re)=>Ip(g,J,re),E=J=>u?.has?.(J),S=`<div class="quote-placeholder">${O(c("reservations.quote.placeholder.noFields","لم يتم اختيار أي معلومات للعرض في هذا القسم."))}</div>`,x=(J,re)=>`<div class="info-plain__item">
      <span class="info-plain__label">${O(J)}</span>
      <span class="info-plain__separator">:</span>
      <span class="info-plain__value">${O(re)}</span>
    </div>`,A=(J,re,{variant:ue="inline"}={})=>ue==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${O(J)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${O(re)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${O(J)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${O(re)}</span>
    </span>`,C=(J,re)=>`<div class="payment-row">
      <span class="payment-row__label">${O(J)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${O(re)}</span>
    </div>`,j=[];y("customerInfo","customerName")&&j.push(x(c("projects.details.client","العميل"),t.name||"-")),y("customerInfo","customerCompany")&&j.push(x(c("projects.details.company","شركة العميل"),t.company||"—")),y("customerInfo","customerPhone")&&j.push(x(c("projects.details.labels.clientPhone","رقم العميل"),t.phone||"-")),y("customerInfo","customerEmail")&&j.push(x(c("projects.details.labels.clientEmail","البريد الإلكتروني"),t.email||"-"));const k=E("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${O(c("projects.quote.sections.customer","بيانات العميل"))}</h3>
        ${j.length?`<div class="info-plain">${j.join("")}</div>`:S}
      </section>`:"",w=[];y("projectInfo","projectType")&&w.push(x(c("projects.details.type","نوع المشروع"),n.typeLabel||"-")),y("projectInfo","projectTitle")&&w.push(x(c("projects.details.projectTitle","اسم المشروع"),n.title||"-")),y("projectInfo","projectCode")&&w.push(x(c("projects.details.labels.code","رقم المشروع"),n.code||"-")),y("projectInfo","projectStart")&&w.push(x(c("projects.details.start","بداية المشروع"),n.startDisplay||"-")),y("projectInfo","projectEnd")&&w.push(x(c("projects.details.end","نهاية المشروع"),n.endDisplay||"-")),y("projectInfo","projectDuration")&&w.push(x(c("projects.details.duration","مدة المشروع"),n.durationLabel||"-")),y("projectInfo","projectStatus")&&w.push(x(c("projects.details.status","حالة المشروع"),n.statusLabel||"-"));const _=E("projectInfo")?`<section class="quote-section quote-section--plain quote-section--project">
        <h3 class="quote-section__title">${O(c("projects.quote.sections.project","بيانات المشروع"))}</h3>
        ${w.length?`<div class="info-plain">${w.join("")}</div>`:S}
      </section>`:"",$=fv.filter(J=>y("projectCrew",J.id)),q=E("projectCrew")?$.length?`<section class="quote-section quote-section--table">
            <h3>${O(c("projects.quote.sections.crew","طاقم العمل"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${$.map(J=>`<th>${O(J.labelKey?c(J.labelKey,J.fallback):J.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${a.length?a.map((J,re)=>`<tr>${$.map(ue=>`<td>${ue.render(J,re)}</td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max($.length,1)}" class="empty">${O(c("projects.details.crew.empty","لا يوجد طاقم فني مرتبط."))}</td></tr>`}
              </tbody>
            </table>
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${O(c("projects.quote.sections.crew","طاقم العمل"))}</h3>
            ${S}
          </section>`:"",F=[];y("financialSummary","projectSubtotal")&&F.push(A(c("projects.details.summary.projectSubtotal","إجمالي المشروع"),i.projectSubtotal||`${Be(0,d)}`)),y("financialSummary","expensesTotal")&&F.push(A(c("projects.details.expensesTotal","إجمالي متطلبات المشروع"),i.expensesTotal||Be(0,d))),y("financialSummary","reservationsTotal")&&F.push(A(c("projects.details.reservationsTotal","إجمالي الحجوزات"),i.reservationsTotal||Be(0,d))),y("financialSummary","discountAmount")&&F.push(A(c("reservations.details.labels.discount","الخصم"),i.discountAmount||Be(0,d))),y("financialSummary","taxAmount")&&F.push(A(c("projects.details.summary.combinedTax","إجمالي الضريبة"),i.taxAmount||Be(0,d)));const U=[];y("financialSummary","overallTotal")&&U.push(A(c("projects.details.summary.overallTotal","الإجمالي الكلي"),i.overallTotal||Be(0,d),{variant:"final"})),y("financialSummary","paidAmount")&&U.push(A(c("projects.details.summary.paidAmount","إجمالي المدفوع"),i.paidAmount||Be(0,d),{variant:"final"})),y("financialSummary","remainingAmount")&&U.push(A(c("projects.details.summary.remainingAmount","المتبقي للدفع"),i.remainingAmount||Be(0,d),{variant:"final"}));const L=E("financialSummary")?!F.length&&!U.length?`<section class="quote-section quote-section--financial">${S}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${O(c("projects.quote.sections.financial","الملخص المالي"))}</h3>
            ${F.length?`<div class="totals-inline">${F.join("")}</div>`:""}
            ${U.length?`<div class="totals-final">${U.join("")}</div>`:""}
          </div>
        </section>`:"",B=hv.filter(J=>y("projectExpenses",J.id)),D=E("projectExpenses")?B.length?`<section class="quote-section quote-section--table">
            <h3>${O(c("projects.quote.sections.expenses","متطلبات المشروع"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${B.map(J=>`<th>${O(J.labelKey?c(J.labelKey,J.fallback):J.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${s.length?s.map((J,re)=>`<tr>${B.map(ue=>`<td>${ue.render(J,re)}</td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(B.length,1)}" class="empty">${O(c("projects.details.expenses.empty","لا توجد متطلبات مسجلة."))}</td></tr>`}
              </tbody>
            </table>
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${O(c("projects.quote.sections.expenses","متطلبات المشروع"))}</h3>
            ${S}
          </section>`:"",K=yv.filter(J=>y("projectEquipment",J.id)),Z=E("projectEquipment")?K.length?`<section class="quote-section quote-section--table">
            <h3>${O(c("projects.quote.sections.equipment","المعدات"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${K.map(J=>`<th>${O(J.labelKey?c(J.labelKey,J.fallback):J.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${r.length?r.map((J,re)=>`<tr>${K.map(ue=>`<td>${ue.render(J,re)}</td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(K.length,1)}" class="empty">${O(c("projects.details.equipment.empty","لا توجد معدات مرتبطة حالياً."))}</td></tr>`}
              </tbody>
            </table>
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${O(c("projects.quote.sections.equipment","المعدات"))}</h3>
            ${S}
          </section>`:"",R=(e?.description||"").trim()||"",M=E("projectNotes")?`<section class="quote-section">
        <h3>${O(c("projects.quote.sections.notes","ملاحظات المشروع"))}</h3>
        <div class="quote-notes">${O(R||c("projects.fallback.noDescription","لا يوجد وصف للمشروع."))}</div>
      </section>`:"",H=[];y("payment","beneficiary")&&H.push(C(c("reservations.quote.labels.beneficiary","اسم المستفيد"),bt.beneficiaryName)),y("payment","bank")&&H.push(C(c("reservations.quote.labels.bank","اسم البنك"),bt.bankName)),y("payment","account")&&H.push(C(c("reservations.quote.labels.account","رقم الحساب"),b(bt.accountNumber))),y("payment","iban")&&H.push(C(c("reservations.quote.labels.iban","رقم الآيبان"),b(bt.iban)));const V=`<section class="quote-section">
      <div class="payment-block">
        <h3>${O(c("reservations.quote.sections.payment","بيانات الدفع"))}</h3>
        <div class="payment-rows">${H.length?H.join(""):S}</div>
      </div>
      <p class="quote-approval-note">${O(bt.approvalNote)}</p>
    </section>`,G=Array.isArray(h)&&h.length?h:tn,ie=`<footer class="quote-footer">
        <h4>${O(c("reservations.quote.labels.terms","الشروط العامة"))}</h4>
        <ul>${G.map(J=>`<li>${O(J)}</li>`).join("")}</ul>
      </footer>`,ee=[],oe=[];if(_&&oe.push({key:"project",html:_}),k&&oe.push({key:"customer",html:k}),oe.length>1){const J=oe.find(Pe=>Pe.key==="project"),re=oe.find(Pe=>Pe.key==="customer"),ue=[];J?.html&&ue.push(J.html),re?.html&&ue.push(re.html),ee.push(ot(`<div class="quote-section-row quote-section-row--primary">${ue.join("")}</div>`,{blockType:"group"}))}else oe.length===1&&ee.push(ot(oe[0].html));const W=[];q&&W.push(ot(q,{blockType:"table",extraAttributes:'data-table-id="project-crew"'})),D&&W.push(ot(D,{blockType:"table",extraAttributes:'data-table-id="project-expenses"'})),Z&&W.push(ot(Z,{blockType:"table",extraAttributes:'data-table-id="project-equipment"'}));const be=[];L&&be.push(ot(L,{blockType:"summary"})),M&&be.push(ot(M));const he=[ot(V,{blockType:"payment"}),ot(ie,{blockType:"footer"})],Se=[...rl(ee,"projects.quote.placeholder.primary"),...W,...rl(be,"projects.quote.placeholder.summary"),...he],we=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${O(bt.logoUrl)}" alt="${O(bt.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${O(c("projects.quote.title","عرض سعر"))}</h1>
        <p class="quote-company-name">${O(bt.companyName)}</p>
        <p class="quote-company-cr">${O(c("reservations.quote.labels.cr","السجل التجاري"))}: ${O(bt.commercialRegistry)}</p>
        <p class="quote-company-license">ترخيص إعلامي: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${O(c("reservations.details.labels.reservationId","رقم العرض"))}</span>
          <strong>${O(p)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${O(c("projects.quote.labels.date","التاريخ"))}</span>
          <strong>${O(f)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
      <style>${Av}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${we}
          ${Se.join("")}
        </div>
      </div>
    </div>
  `}function Bv(e){if(e?.context==="project")return vx(e);const{reservation:t,customer:n,project:a,crewAssignments:s,totals:r,totalsDisplay:i,rentalDays:o,currencyLabel:l,sections:d,fieldSelections:u={},quoteNumber:m,quoteDate:p,terms:f=tn}=e,h=b(String(t?.reservationId??t?.id??"")),g=t.start?b(mt(t.start)):"-",y=t.end?b(mt(t.end)):"-",E=n?.customerName||n?.full_name||n?.name||"-",S=n?.phone||"-",x=n?.email||"-",A=n?.company||n?.company_name||"-",C=b(S),j=a?.title||a?.name||c("reservations.details.project.none","غير مرتبط بمشروع"),k=a?.code||a?.projectCode||"",w=b(String(o)),_=t?.notes||"",$=Array.isArray(f)&&f.length?f:tn,q=jp(u),F=(ce,De)=>Ip(q,ce,De),U=ce=>d?.has?.(ce),L=`<div class="quote-placeholder">${O(c("reservations.quote.placeholder.noFields","لم يتم اختيار أي معلومات للعرض في هذا القسم."))}</div>`,B=(ce,De)=>`<div class="info-plain__item">${O(ce)} <span class="info-plain__slash">/</span> <strong class="info-plain__value">${O(De)}</strong></div>`,D=(ce,De,{variant:At="inline"}={})=>At==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${O(ce)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${O(De)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${O(ce)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${O(De)}</span>
    </span>`,K=(ce,De)=>`<div class="payment-row">
      <span class="payment-row__label">${O(ce)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${O(De)}</span>
    </div>`,Z=[];F("customerInfo","customerName")&&Z.push(B(c("reservations.details.labels.customer","العميل"),E)),F("customerInfo","customerCompany")&&Z.push(B(c("reservations.details.labels.company","الشركة"),A)),F("customerInfo","customerPhone")&&Z.push(B(c("reservations.details.labels.phone","الهاتف"),C)),F("customerInfo","customerEmail")&&Z.push(B(c("reservations.details.labels.email","البريد"),x));const R=U("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${O(c("reservations.quote.sections.customer","بيانات العميل"))}</h3>
        ${Z.length?`<div class="info-plain">${Z.join("")}</div>`:L}
      </section>`:"",M=[];F("reservationInfo","reservationId")&&M.push(B(c("reservations.details.labels.reservationId","رقم الحجز"),h||"-")),F("reservationInfo","reservationStart")&&M.push(B(c("reservations.details.labels.start","بداية الحجز"),g)),F("reservationInfo","reservationEnd")&&M.push(B(c("reservations.details.labels.end","نهاية الحجز"),y)),F("reservationInfo","reservationDuration")&&M.push(B(c("reservations.details.labels.duration","عدد الأيام"),w));const H=U("reservationInfo")?`<section class="quote-section quote-section--plain quote-section--reservation">
        <h3 class="quote-section__title">${O(c("reservations.quote.sections.reservation","تفاصيل الحجز"))}</h3>
        ${M.length?`<div class="info-plain">${M.join("")}</div>`:L}
      </section>`:"",V=[];F("projectInfo","projectTitle")&&V.push(B(c("reservations.details.labels.project","المشروع"),j)),F("projectInfo","projectCode")&&V.push(B(c("reservations.details.labels.code","الرمز"),k||"-"));const G=U("projectInfo")?`<section class="quote-section quote-section--plain">
        <h3 class="quote-section__title">${O(c("reservations.quote.sections.project","بيانات المشروع"))}</h3>
        ${V.length?`<div class="info-plain">${V.join("")}</div>`:L}
      </section>`:"",ie=[];F("financialSummary","equipmentTotal")&&ie.push(D(c("reservations.details.labels.equipmentTotal","إجمالي المعدات"),`${i.equipmentTotal} ${l}`)),F("financialSummary","crewTotal")&&ie.push(D(c("reservations.details.labels.crewTotal","إجمالي الفريق"),`${i.crewTotal} ${l}`)),F("financialSummary","discountAmount")&&ie.push(D(c("reservations.details.labels.discount","الخصم"),`${i.discountAmount} ${l}`)),F("financialSummary","taxAmount")&&ie.push(D(c("reservations.details.labels.tax","الضريبة"),`${i.taxAmount} ${l}`));const ee=F("financialSummary","finalTotal"),oe=[];ee&&oe.push(D(c("reservations.details.labels.total","الإجمالي النهائي"),`${i.finalTotal} ${l}`,{variant:"final"}));const W=oe.length?`<div class="totals-final">${oe.join("")}</div>`:"",be=U("financialSummary")?!ie.length&&!ee?`<section class="quote-section quote-section--financial">${L}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${O(c("reservations.details.labels.summary","الملخص المالي"))}</h3>
            ${ie.length?`<div class="totals-inline">${ie.join("")}</div>`:""}
            ${W}
          </div>
        </section>`:"",{groups:he}=rb(t),Se=he.map(ce=>{const De=Number(ce?.count??ce?.quantity??1)||1,At=Number(ce?.unitPrice);let Tt=Number.isFinite(At)?At:0;if(!Tt||Tt<=0){const lr=Number(ce?.totalPrice);Number.isFinite(lr)&&De>0&&(Tt=Number((lr/De).toFixed(2)))}Number.isFinite(Tt)||(Tt=0);const Ca=ce?.type==="package"||Array.isArray(ce?.items)&&ce.items.some(lr=>lr?.type==="package"),sn=Array.isArray(ce?.barcodes)&&ce.barcodes.length?ce.barcodes[0]:Array.isArray(ce?.items)&&ce.items.length?ce.items[0]?.barcode:null,ls=ce?.packageDisplayCode??ce?.package_code??ce?.packageCode??ce?.packageId??ce?.package_id??ce?.code??ce?.barcode??(Array.isArray(ce?.items)&&ce.items.length?ce.items[0]?.package_code??ce.items[0]?.packageCode??ce.items[0]?.packageId??ce.items[0]?.package_id??ce.items[0]?.code??ce.items[0]?.barcode:null),Uo=Ca?ls??sn??"":ce?.barcode??sn??"",ld=Uo!=null?String(Uo):"";let cr=Number.isFinite(Number(ce?.totalPrice))?Number(ce.totalPrice):Number((Tt*De).toFixed(2));return cr=Ee(cr),{...ce,isPackage:Ca,desc:ce?.description,barcode:ld,qty:De,price:cr,totalPrice:cr,unitPriceValue:Tt}}),we=mv.filter(ce=>F("items",ce.id)),J=we.length>0,re=J?we.map(ce=>`<th>${O(ce.labelKey?c(ce.labelKey,ce.fallback):ce.fallback)}</th>`).join(""):"",Pe=Se.length>0?Se.map((ce,De)=>`<tr>${we.map(At=>`<td>${At.render(ce,De)}</td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(we.length,1)}" class="empty">${O(c("reservations.details.noItems","📦 لا توجد معدات ضمن هذا الحجز حالياً."))}</td></tr>`,Te=U("items")?J?`<section class="quote-section quote-section--table">
            <h3>${O(c("reservations.details.items.title","المعدات"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${re}</tr>
              </thead>
              <tbody>${Pe}</tbody>
            </table>
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${O(c("reservations.details.items.title","المعدات"))}</h3>
            ${L}
          </section>`:"",ye=pv.filter(ce=>F("crew",ce.id)),te=ye.length>0,Ce=te?ye.map(ce=>`<th>${O(ce.labelKey?c(ce.labelKey,ce.fallback):ce.fallback)}</th>`).join(""):"",X=Array.isArray(s)?s:[],Ae=X.length?X.map((ce,De)=>`<tr>${ye.map(At=>`<td>${At.render(ce,De)}</td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(ye.length,1)}" class="empty">${O(c("reservations.details.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز."))}</td></tr>`,Ne=U("crew")?te?`<section class="quote-section quote-section--table">
            <h3>${O(c("reservations.details.technicians.title","طاقم العمل"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Ce}</tr>
              </thead>
              <tbody>${Ae}</tbody>
            </table>
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${O(c("reservations.details.technicians.title","طاقم العمل"))}</h3>
            ${L}
          </section>`:"",je=U("notes")?`<section class="quote-section">
        <h3>${O(c("reservations.details.labels.notes","ملاحظات الحجز"))}</h3>
        <div class="quote-notes">${O(_||c("reservations.quote.emptyNotes","لا توجد ملاحظات إضافية."))}</div>
      </section>`:"",fe=[];F("payment","beneficiary")&&fe.push(K(c("reservations.quote.labels.beneficiary","اسم المستفيد"),bt.beneficiaryName)),F("payment","bank")&&fe.push(K(c("reservations.quote.labels.bank","اسم البنك"),bt.bankName)),F("payment","account")&&fe.push(K(c("reservations.quote.labels.account","رقم الحساب"),b(bt.accountNumber))),F("payment","iban")&&fe.push(K(c("reservations.quote.labels.iban","رقم الآيبان"),b(bt.iban)));const qe=`<section class="quote-section">
      <div class="payment-block">
        <h3>${O(c("reservations.quote.sections.payment","بيانات الدفع"))}</h3>
        <div class="payment-rows">${fe.length?fe.join(""):L}</div>
      </div>
      <p class="quote-approval-note">${O(bt.approvalNote)}</p>
    </section>`,ze=`<footer class="quote-footer">
        <h4>${O(c("reservations.quote.labels.terms","الشروط العامة"))}</h4>
        <ul>${$.map(ce=>`<li>${O(ce)}</li>`).join("")}</ul>
      </footer>`,Je=[];R&&H?Je.push(ot(`<div class="quote-section-row">${R}${H}</div>`,{blockType:"group"})):(H&&Je.push(ot(H)),R&&Je.push(ot(R))),G&&Je.push(ot(G));const Ye=[];Te&&Ye.push(ot(Te,{blockType:"table",extraAttributes:'data-table-id="items"'})),Ne&&Ye.push(ot(Ne,{blockType:"table",extraAttributes:'data-table-id="crew"'}));const _t=[];be&&_t.push(ot(be,{blockType:"summary"})),je&&_t.push(ot(je));const Zn=[ot(qe,{blockType:"payment"}),ot(ze,{blockType:"footer"})],Ta=[...rl(Je,"reservations.quote.placeholder.page1"),...Ye,...rl(_t,"reservations.quote.placeholder.page2"),...Zn],cs=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${O(bt.logoUrl)}" alt="${O(bt.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${O(c("reservations.quote.title","عرض السعر"))}</h1>
        <p class="quote-company-name">${O(bt.companyName)}</p>
        <p class="quote-company-cr">${O(c("reservations.quote.labels.cr","السجل التجاري"))}: ${O(bt.commercialRegistry)}</p>
        <p class="quote-company-license">ترخيص إعلامي: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>رقم العرض</span>
          <strong>${O(m)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>التاريخ</span>
          <strong>${O(p)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
      <style>${Av}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${cs}
          ${Ta.join("")}
        </div>
      </div>
    </div>
  `}function Sx(e){return e?e.complete?e.naturalHeight===0?Promise.reject(new Error(`image failed to load: ${e.src||"unknown"}`)):Promise.resolve():new Promise((t,n)=>{const a=()=>{r(),t()},s=()=>{r(),n(new Error(`image failed to load: ${e.src||"unknown"}`))},r=()=>{e.removeEventListener("load",a),e.removeEventListener("error",s)};e.addEventListener("load",a,{once:!0}),e.addEventListener("error",s,{once:!0})}):Promise.resolve()}async function no(e){if(!e)return;const t=e.ownerDocument||document,n=t.defaultView||window,a=Array.from(e.querySelectorAll?.("img")||[]),s=t.fonts?.ready?t.fonts.ready:Promise.resolve(),r=a.map(o=>Sx(o)),i=[s,...r].map(o=>o.catch(l=>(ba("asset load failed",l),PI(),null)));await Promise.all(i),await new Promise(o=>n.requestAnimationFrame(()=>o()))}async function Fv(e,{context:t="preview"}={}){if(!e)return;const n=t==="preview",a=e.ownerDocument||document;e.setAttribute("data-quote-render-context",t);const s=e.querySelector("[data-quote-pages]"),r=e.querySelector("[data-quote-source]"),i=r?.querySelector("[data-quote-header-template]");if(!s||!r||!i)return;s.style.display="block",s.style.margin="0",s.style.padding="0",s.style.gap="0px",s.style.rowGap="0px",s.style.columnGap="0px",s.style.alignItems="stretch",s.style.justifyContent="flex-start",await Tv(r),await no(r),s.innerHTML="";const o=Array.from(r.querySelectorAll(":scope > [data-quote-block]"));let l=null,d=null;const u=j=>{j.style.margin="0 auto",j.style.breakInside="avoid",j.style.pageBreakInside="avoid",j.style.pageBreakAfter="auto",j.style.breakAfter="auto"},m=()=>{const j=a.createElement("div"),k=s.childElementCount===0;if(j.className="quote-page",j.dataset.pageIndex=String(s.childElementCount),k){j.classList.add("quote-page--primary");const _=i.cloneNode(!0);_.removeAttribute("data-quote-header-template"),j.appendChild(_)}else j.classList.add("quote-page--continuation");const w=a.createElement("main");w.className="quote-body",j.appendChild(w),s.appendChild(j),u(j),l=j,d=w},p=()=>{(!l||!d||!d.isConnected)&&m()},f=()=>{if(!l||!d||d.childElementCount>0)return;const j=l;l=null,d=null,j.parentNode&&j.parentNode.removeChild(j)},h=()=>{l=null,d=null},g=()=>l?l.scrollHeight-l.clientHeight>qI:!1,y=(j,{allowOverflow:k=!1}={})=>(p(),d.appendChild(j),g()&&!k?(d.removeChild(j),f(),!1):!0),E=j=>{const k=j.cloneNode(!0);k.removeAttribute?.("data-quote-block"),k.removeAttribute?.("data-block-type"),k.removeAttribute?.("data-table-id"),!y(k)&&(h(),!y(k)&&y(k,{allowOverflow:!0}))},S=j=>{const k=j.querySelector("table");if(!k){E(j);return}const w=j.querySelector("h3"),_=k.querySelector("thead"),$=Array.from(k.querySelectorAll("tbody tr"));if(!$.length){E(j);return}let q=null,F=0;const U=(B=!1)=>{const D=j.cloneNode(!1);D.removeAttribute("data-quote-block"),D.removeAttribute("data-block-type"),D.removeAttribute("data-table-id"),D.classList.add("quote-section--table-fragment"),B&&D.classList.add("quote-section--table-fragment--continued");const K=w?w.cloneNode(!0):null;K&&D.appendChild(K);const Z=k.cloneNode(!1);Z.classList.add("quote-table--fragment"),_&&Z.appendChild(_.cloneNode(!0));const R=a.createElement("tbody");return Z.appendChild(R),D.appendChild(Z),{section:D,body:R}},L=(B=!1)=>q||(q=U(B),y(q.section)||(h(),y(q.section)||y(q.section,{allowOverflow:!0})),q);$.forEach(B=>{L(F>0);const D=B.cloneNode(!0);if(q.body.appendChild(D),g()&&(q.body.removeChild(D),q.body.childElementCount||(d.removeChild(q.section),q=null,f()),h(),q=null,L(F>0),q.body.appendChild(D),g())){q.section.classList.add("quote-section--table-fragment--overflow"),F+=1;return}F+=1}),q=null};if(!o.length)return;o.forEach(j=>{j.getAttribute("data-block-type")==="table"?S(j):E(j)});const x=Array.from(s.children),A=[];if(x.forEach((j,k)=>{const w=j.querySelector(".quote-body");if(k!==0&&(!w||w.childElementCount===0)){j.remove();return}A.push(j)}),!n){const j=a.defaultView||window,k=Math.min(3,Math.max(1,j.devicePixelRatio||1)),w=Kl()?Math.min(2,k):k;A.forEach(_=>QI(_,{pixelRatio:w}))}A.forEach((j,k)=>{const w=k===0;j.style.pageBreakAfter="auto",j.style.breakAfter="auto",j.style.pageBreakBefore=w?"auto":"always",j.style.breakBefore=w?"auto":"page",n?j.style.boxShadow="":j.style.boxShadow="none"});const C=A[A.length-1]||null;l=C,d=C?.querySelector(".quote-body")||null,await no(s),n&&(s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="flex-start",s.style.rowGap="18px",s.style.columnGap="0px",s.style.gap="18px")}function Tp(e,t="#000000"){if(!e)return;e.querySelectorAll('[style*="color"], [class*="text"], h1, h2, h3, h4, h5, h6, p, span, th, td, li, strong, em, label, dt, dd, caption, div').forEach(a=>{a instanceof HTMLElement&&a.style.setProperty("color",t,"important")})}async function Ax(e,{filename:t,safariWindowRef:n=null,mobileWindowRef:a=null}){if(!e)return;const s=Array.from(e.querySelectorAll(".quote-page"));if(!s.length)throw new Error("لا توجد صفحات لتصديرها.");const[r,i]=await Promise.all([YI(),GI()]),o=e.ownerDocument||document,l=o?.defaultView?.getComputedStyle?.(e)?.direction,u=[e.getAttribute?.("dir"),e.style?.direction,l,o?.documentElement?.getAttribute?.("dir")].some(j=>typeof j=="string"&&j.toLowerCase().startsWith("rtl")),m=typeof window<"u"&&window.devicePixelRatio||1,p=kp(),f=xv(),h=Kl();let g;h?g=1.5:f?g=Math.min(1.7,Math.max(1.2,m*1.1)):p?g=Math.min(1.8,Math.max(1.25,m*1.2)):g=Math.min(2,Math.max(1.6,m*1.4));const y=h||f?.9:p?.92:.95,E=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),S={scale:g,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!u,removeContainer:!1,logging:!0};let x=0;const A=c("reservations.quote.errors.browserLimit","تعذر إتمام عملية التحويل بسبب قيود المتصفح، يرجى إعادة المحاولة أو تقليل حجم المحتوى.");try{for(let j=0;j<s.length;j+=1){const k=s[j];await Tv(k),await no(k);const w=k.ownerDocument||document,_=w.createElement("div");Object.assign(_.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const $=k.cloneNode(!0);$.style.width=`${Nc}px`,$.style.maxWidth=`${Nc}px`,$.style.minWidth=`${Nc}px`,$.style.height=`${$c}px`,$.style.maxHeight=`${$c}px`,$.style.minHeight=`${$c}px`,$.style.position="relative",$.style.background="#ffffff",Tp($),_.appendChild($),w.body.appendChild(_);let q;try{await no($),q=await i($,{...S,scale:g,backgroundColor:"#ffffff",scrollX:0,scrollY:0})}catch(R){throw $u(R,"pageCapture",{toastMessage:A}),R}finally{_.parentNode?.removeChild(_)}if(!q)continue;const F=q.width||1,L=(q.height||1)/F;let B=Pu,D=B*L,K=0;if(D>Lc){const R=Lc/D;D=Lc,B=B*R,K=Math.max(0,(Pu-B)/2)}const Z=q.toDataURL("image/jpeg",y);x>0&&E.addPage(),E.addImage(Z,"JPEG",K,0,B,D,`page-${x+1}`,"FAST"),x+=1,await new Promise(R=>window.requestAnimationFrame(R))}}catch(j){throw Du({safariWindowRef:n,mobileWindowRef:a}),j}if(x===0)throw Du({safariWindowRef:n,mobileWindowRef:a}),new Error("PDF generation produced no pages.");if(f||h){const j=E.output("blob");if(h){const k=URL.createObjectURL(j);Mi();try{window.location.assign(k)}catch(w){ba("mobile safari blob navigation failed",w)}finally{setTimeout(()=>URL.revokeObjectURL(k),6e4)}}else{const k=URL.createObjectURL(j),w=()=>f&&n&&!n.closed?n:a&&!a.closed?a:null,_=(q,F)=>{if(Mi(),!q){window.location.assign(F);return}try{q.location.replace(F),q.focus?.()}catch(U){ba("direct blob navigation failed",U);try{q.document.open(),q.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${O(c("reservations.quote.actions.export","تنزيل PDF"))}</title><style>html,body{margin:0;height:100%;background:#0f172a;color:#f8fafc;font-family:'Tajawal',sans-serif;} iframe{border:none;width:100%;height:100%;display:block;}</style></head><body><iframe src="${F}" title="PDF preview"></iframe></body></html>`),q.document.close()}catch(L){ba("iframe blob delivery failed",L),window.location.assign(F)}}},$=w();_($,k),setTimeout(()=>URL.revokeObjectURL(k),6e4)}}else{Mi();const j=E.output("bloburl"),k=document.createElement("a");k.href=j,k.download=t,k.rel="noopener",k.style.display="none",document.body.appendChild(k),k.click(),setTimeout(()=>{URL.revokeObjectURL(j),k.remove()},2e3)}}function rr(){if(!ne||!ge)return;const{previewFrame:e}=ge;if(!e)return;const t=ne.context||"reservation",n=Bv({context:t,reservation:ne.reservation,customer:ne.customer,project:ne.project,crewAssignments:ne.crewAssignments,totals:ne.totals,totalsDisplay:ne.totalsDisplay,rentalDays:ne.rentalDays,currencyLabel:ne.currencyLabel,sections:ne.sections,fieldSelections:ne.fields,quoteNumber:ne.quoteNumber,quoteDate:ne.quoteDateLabel,terms:ne.terms,projectCrew:ne.projectCrew,projectExpenses:ne.projectExpenses,projectEquipment:ne.projectEquipment,projectInfo:ne.projectInfo,clientInfo:ne.clientInfo,paymentSummary:ne.paymentSummary,projectTotals:ne.projectTotals});Ps("render"),e.srcdoc=`<!DOCTYPE html>${n}`,e.addEventListener("load",async()=>{try{const a=e.contentDocument,s=a?.defaultView||window,r=a?.documentElement||a;r&&(lv(r),Ep(r,s),wp(r,s));const i=a?.getElementById("quotation-pdf-root");try{i&&(await Fv(i,{context:"preview"}),Tp(i))}catch(f){console.error("[reservations/pdf] failed to layout preview document",f)}const o=Array.from(a?.querySelectorAll?.(".quote-page")||[]),l=a?.querySelector(".quote-preview-pages"),d=Nc;let u=18;if(l&&a?.defaultView){const f=a.defaultView.getComputedStyle(l),h=parseFloat(f.rowGap||f.gap||`${u}`);Number.isFinite(h)&&h>=0&&(u=h)}const m=$c,p=o.length?o.length*m+Math.max(0,(o.length-1)*u):m;if(e.dataset.baseWidth=String(d),e.dataset.baseHeight=String(p),e.style.width=`${d}px`,e.style.minWidth=`${d}px`,e.style.height=`${p}px`,e.style.minHeight=`${p}px`,ge?.previewFrameWrapper&&!ge?.userAdjustedZoom){const f=ge.previewFrameWrapper.clientWidth-24;f>0&&f<d?Kn=Math.max(f/d,.3):Kn=1}Mv(Kn)}finally{Mi()}},{once:!0})}function Ex(e){if(!ne)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(t.checked?ne.sections.add(n):ne.sections.delete(n),Lv(ne),Rv(),rr())}function wx(e){if(!ne)return;const t=e.currentTarget,n=t?.dataset?.sectionId,a=t?.dataset?.fieldId;if(!n||!a)return;const s=ne.context||"reservation",r=ne.fields||(ne.fields=Vl(s)),i=LI(r,n);t.checked?i.add(a):i.delete(a),Lv(ne),rr()}function jx(e){if(!ne)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(qp(ne,n),ne.sectionExpansions[n]=t.open)}function Rv(){if(!ge?.toggles||!ne)return;const{toggles:e}=ge,t=ne.fields||{},n=ne.context||"reservation";qp(ne);const a=Ul(n),s=gv(n),r=a.map(({id:i,labelKey:o,fallback:l})=>{const d=c(o,l),u=ne.sections.has(i),m=s[i]||[],p=NI(ne,i),f=m.length?`<div class="quote-toggle-sublist">
          ${m.map(h=>{const g=Ip(t,i,h.id),y=u?"":"disabled",E=h.labelKey?c(h.labelKey,h.fallback):h.fallback;return`
              <label class="quote-toggle quote-toggle--field">
                <input type="checkbox" data-field-toggle data-section-id="${i}" data-field-id="${h.id}" ${g?"checked":""} ${y}>
                <span>${O(E)}</span>
              </label>
            `}).join("")}
        </div>`:"";return`
      <details class="quote-toggle-group" data-section-group data-section-id="${i}" ${p?"open":""}>
        <summary class="quote-toggle-summary">
          <label class="quote-toggle quote-toggle--section">
            <input type="checkbox" data-section-toggle data-section-id="${i}" ${u?"checked":""}>
            <span>${O(d)}</span>
          </label>
          ${m.length?'<span class="quote-toggle-caret" aria-hidden="true"></span>':""}
        </summary>
        ${f}
      </details>
    `}).join("");e.innerHTML=r,e.querySelectorAll("input[data-section-toggle]").forEach(i=>{i.addEventListener("change",Ex)}),e.querySelectorAll("input[data-field-toggle]").forEach(i=>{i.addEventListener("change",wx)}),e.querySelectorAll("details[data-section-group]").forEach(i=>{i.addEventListener("toggle",jx)})}function Ix(){if(ge?.modal)return ge;const e=document.createElement("div");e.id="reservationQuoteModal",e.className="modal fade quote-preview-modal",e.tabIndex=-1,e.setAttribute("aria-labelledby","reservationQuoteModalLabel"),e.setAttribute("aria-hidden","true"),e.style.display="none",e.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationQuoteModalLabel">${O(c("reservations.quote.previewTitle","معاينة عرض السعر"))}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="quote-preview-layout">
            <aside class="quote-preview-sidebar">
              <h6>${O(c("reservations.quote.toggleHeading","حدد المعلومات المراد تصديرها"))}</h6>
              <div class="quote-toggle-list" data-quote-toggles></div>
              <div class="quote-meta-info" data-quote-meta></div>
              <div class="quote-terms-editor" data-quote-terms-editor>
                <label class="quote-terms-editor__label" for="quote-terms-input">${O(c("reservations.quote.termsEditor.title","الشروط العامة (قابلة للتعديل)"))}</label>
                <textarea id="quote-terms-input" class="quote-terms-editor__textarea" rows="6" data-quote-terms-input placeholder="${O(c("reservations.quote.termsEditor.placeholder","اكتب كل شرط في سطر مستقل"))}"></textarea>
                <button type="button" class="quote-terms-reset" data-quote-terms-reset>${O(c("reservations.quote.termsEditor.reset","استعادة الشروط الافتراضية"))}</button>
              </div>
            </aside>
            <section class="quote-preview-panel">
              <div class="quote-preview" data-quote-preview></div>
            </section>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">${O(c("reservations.quote.actions.close","إغلاق"))}</button>
          <button type="button" class="btn btn-primary" data-quote-download>
            ${O(c("reservations.quote.actions.export","📄 تنزيل PDF"))}
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector("[data-quote-toggles]"),n=e.querySelector("[data-quote-preview]"),a=e.querySelector("[data-quote-meta]"),s=e.querySelector("[data-quote-terms-input]"),r=e.querySelector("[data-quote-terms-reset]"),i=e.querySelector("[data-quote-download]"),o=e.querySelector(".modal-header"),l=o?.querySelector(".btn-close"),d=Array.from(e.querySelectorAll('[data-bs-dismiss="modal"]')),u=document.createElement("div");u.className="quote-preview-header-actions",o&&o.insertBefore(u,l||null);const m=document.createElement("iframe");m.className="quote-preview-frame",m.setAttribute("title",c("reservations.quote.previewTitle","معاينة عرض السعر")),m.setAttribute("loading","lazy"),m.setAttribute("frameborder","0");const p=document.createElement("div");p.className="quote-preview-zoom-controls",p.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-zoom-out title="${O(c("reservations.quote.zoom.out","تصغير"))}">−</button>
    <span class="quote-preview-zoom-value" data-zoom-value>100%</span>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-in title="${O(c("reservations.quote.zoom.in","تكبير"))}">+</button>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-reset title="${O(c("reservations.quote.zoom.reset","إعادة الضبط"))}">1:1</button>
  `;const f=document.createElement("div");f.className="quote-preview-frame-wrapper",f.appendChild(m),n.innerHTML="";const h=document.createElement("div");h.className="quote-preview-scroll",h.appendChild(f),n.appendChild(h);const g=document.createElement("div");g.className="quote-preview-status",g.setAttribute("role","status"),g.setAttribute("aria-live","polite"),g.hidden=!0,g.innerHTML=`
    <span class="quote-preview-spinner" data-quote-status-spinner aria-hidden="true"></span>
    <span data-quote-status-text>${O(Sv("render"))}</span>
    <button type="button" class="quote-preview-status-action" data-quote-status-action hidden></button>
  `,n.appendChild(g),u.appendChild(p),i?.addEventListener("click",async()=>{if(ne){i.disabled=!0;try{await Hv()}finally{i.disabled=!1}}});const y=()=>{Lu()||Nu(e)};d.forEach(A=>{A?.addEventListener("click",y)}),l&&!d.includes(l)&&l.addEventListener("click",y),e.addEventListener("click",A=>{Lu()||A.target===e&&Nu(e)}),ge={modal:e,toggles:t,preview:n,previewScroll:h,previewFrameWrapper:f,zoomControls:p,zoomValue:p.querySelector("[data-zoom-value]"),previewFrame:m,meta:a,downloadBtn:i,statusIndicator:g,statusText:g.querySelector("[data-quote-status-text]"),statusSpinner:g.querySelector("[data-quote-status-spinner]"),statusAction:g.querySelector("[data-quote-status-action]"),termsInput:s,termsReset:r,statusKind:null,userAdjustedZoom:!1};const E=p.querySelector("[data-zoom-out]"),S=p.querySelector("[data-zoom-in]"),x=p.querySelector("[data-zoom-reset]");return E?.addEventListener("click",()=>Nh(-.1)),S?.addEventListener("click",()=>Nh(.1)),x?.addEventListener("click",()=>il(1,{markManual:!0})),s&&s.addEventListener("input",qx),r&&r.addEventListener("click",kx),il(Kn),ge}function il(e,{silent:t=!1,markManual:n=!1}={}){Kn=Math.min(Math.max(e,.25),2.2),n&&ge&&(ge.userAdjustedZoom=!0),Mv(Kn),!t&&ge?.zoomValue&&(ge.zoomValue.textContent=`${Math.round(Kn*100)}%`)}function Nh(e){il(Kn+e,{markManual:!0})}function Mv(e){if(!ge?.previewFrame||!ge.previewFrameWrapper)return;const t=ge.previewFrame,n=ge.previewFrameWrapper,a=Number(t.dataset.baseWidth)||794,s=Number(t.dataset.baseHeight)||t.contentDocument?.body?.scrollHeight||1123;t.style.transform=`scale(${e})`,t.style.transformOrigin="top center",kp()?(n.style.width="100%",n.style.maxWidth="100%",n.style.minWidth="0"):(n.style.width=`${a}px`,n.style.maxWidth=`${a}px`,n.style.minWidth=`${a}px`),n.style.minHeight=`${s}px`,n.style.height=`${s}px`}function xx(){if(!ge?.meta||!ne)return;const{meta:e}=ge;e.innerHTML=`
    <div class="quote-meta-card">
      <div><span>${O(c("reservations.quote.labels.number","رقم عرض السعر"))}</span><strong>${O(ne.quoteNumber)}</strong></div>
      <div><span>${O(c("reservations.quote.labels.dateGregorian","التاريخ الميلادي"))}</span><strong>${O(ne.quoteDateLabel)}</strong></div>
    </div>
  `}function Cp(){if(!ge?.termsInput)return;const e=(ne?.terms&&ne.terms.length?ne.terms:tn).join(`
`);ge.termsInput.value!==e&&(ge.termsInput.value=e)}function qx(e){if(!ne)return;const t=_u(e?.target?.value??"");if(t.length){ne.terms=t;const n=document.getElementById("reservation-terms");n&&(n.value=e.target.value);const a=document.getElementById("edit-res-terms");a&&(a.value=e.target.value)}else{ne.terms=[...tn],Cp();const n=tn.join(`
`),a=document.getElementById("reservation-terms");a&&(a.value=n);const s=document.getElementById("edit-res-terms");s&&(s.value=n)}rr()}function kx(e){if(e?.preventDefault?.(),!ne)return;ne.terms=[...tn];const t=document.getElementById("reservation-terms");t&&(t.value=tn.join(`
`));const n=document.getElementById("edit-res-terms");n&&(n.value=tn.join(`
`)),Cp(),rr()}async function Hv(){if(!ne)return;Ps("export");const t=!kp()&&xv(),n=Kl(),a=null,s=!n&&t?window.open("","_blank"):null;(l=>{if(l)try{l.document.open(),l.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${O(c("reservations.quote.status.exporting","جاري تجهيز ملف PDF..."))}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${O(c("reservations.quote.status.exporting","جاري تجهيز ملف PDF..."))}</h1><p>${O(c("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار..."))}</p></div></body></html>`),l.document.close()}catch(d){ba("failed to prime download window",d)}})(s);let i=null;const o=c("reservations.quote.errors.browserLimit","تعذر إتمام عملية التحويل بسبب قيود المتصفح، يرجى إعادة المحاولة أو تقليل حجم المحتوى.");try{await XI(),xd("html2pdf ensured");const l=ne.context||"reservation",d=Bv({context:l,reservation:ne.reservation,customer:ne.customer,project:ne.project,crewAssignments:ne.crewAssignments,totals:ne.totals,totalsDisplay:ne.totalsDisplay,rentalDays:ne.rentalDays,currencyLabel:ne.currencyLabel,sections:ne.sections,fieldSelections:ne.fields,quoteNumber:ne.quoteNumber,quoteDate:ne.quoteDateLabel,terms:ne.terms,projectCrew:ne.projectCrew,projectExpenses:ne.projectExpenses,projectEquipment:ne.projectEquipment,projectInfo:ne.projectInfo,clientInfo:ne.clientInfo,paymentSummary:ne.paymentSummary,projectTotals:ne.projectTotals});i=document.createElement("div"),i.innerHTML=d,Object.assign(i.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(i),lv(i),Ep(i),wp(i),xd("export container prepared");const u=i.firstElementChild;if(u){u.setAttribute("dir","rtl"),u.style.direction="rtl",u.style.textAlign="right",u.setAttribute("data-theme","light"),u.classList.remove("dark","dark-mode"),u.style.margin="0",u.style.padding="0",u.style.width="210mm",u.style.maxWidth="210mm",u.style.marginLeft="auto",u.style.marginRight="auto",u.scrollTop=0,u.scrollLeft=0;try{await Fv(u,{context:"export"}),await no(u),Tp(u),xd("layout complete for export document")}catch(p){$u(p,"layoutQuoteDocument",{suppressToast:!0})}}const m=`quotation-${ne.quoteNumber}.pdf`;await Ax(u,{filename:m,safariWindowRef:s,mobileWindowRef:a}),ne.sequenceCommitted||(tx(ne.quoteSequence),ne.sequenceCommitted=!0)}catch(l){Du({container:i,safariWindowRef:s,mobileWindowRef:a}),i=null,$u(l,"exportQuoteAsPdf",{toastMessage:o})}finally{i&&i.parentNode&&i.parentNode.removeChild(i),Mi()}}function zv(){const e=Ix();e?.modal&&(Ri=!1,Kn=1,ge&&(ge.userAdjustedZoom=!1),il(Kn,{silent:!0}),Rv(),xx(),Cp(),rr(),CI(e.modal))}async function _x({reservation:e,customer:t,project:n}){if(!e){I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز"));return}const a=ix(e),{totalsDisplay:s,totals:r,rentalDays:i}=ox(e,a,n),o=c("reservations.create.summary.currency","SR"),{sequence:l,quoteNumber:d}=Cv("reservation"),u=new Date,m=vI();ne={context:"reservation",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:i,currencyLabel:o,projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(Ul("reservation").filter(p=>p.defaultSelected).map(p=>p.id)),sectionExpansions:xp("reservation"),fields:Vl("reservation"),terms:m,quoteSequence:l,quoteNumber:d,quoteDate:u,quoteDateLabel:$v(u),sequenceCommitted:!1},Nv(ne),zv()}async function Tx({project:e}){if(!e){I(c("projects.toast.notFound","⚠️ تعذر العثور على بيانات المشروع"));return}const t=bx(e),{project:n}=t;if(!n){I(c("projects.toast.notFound","⚠️ تعذر العثور على بيانات المشروع"));return}const{sequence:a,quoteNumber:s}=Cv("project"),r=new Date,i=[...bI];ne={context:"project",reservation:null,customer:t.customer,project:n,technicians:t.crew||[],clientInfo:t.clientInfo,projectInfo:t.projectInfo,projectCrew:t.crew,projectExpenses:t.expenses,projectEquipment:t.equipment,totals:t.totals,projectTotals:t.projectTotals,totalsDisplay:t.totalsDisplay,rentalDays:t.projectDurationDays,currencyLabel:t.currencyLabel,sections:new Set(Ul("project").filter(o=>o.defaultSelected).map(o=>o.id)),sectionExpansions:xp("project"),fields:Vl("project"),terms:i,quoteSequence:a,quoteNumber:s,quoteDate:r,quoteDateLabel:$v(r),sequenceCommitted:!1,paymentSummary:t.paymentSummary,projectNotes:t.notes,paymentHistory:t.paymentHistory},Nv(ne),zv()}function Cx({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a}={}){const s=Ut(),{reservations:r=[],customers:i=[],technicians:o=[],projects:l=[]}=ae(),d=r.map(S=>{const x=Hs(S);return{...x,id:S.id??x.id,reservationId:S.reservationId??S.reservation_id??x.reservationId,reservationCode:S.reservationCode??S.reservation_code??x.reservationCode}}),u=d,m=Array.isArray(s)?s:o||[],p=new Map((l||[]).map(S=>[String(S.id),S])),f=document.getElementById(e);if(!f){console.warn("⚠️ [reservations/renderers] container not found",e);return}if(!u||u.length===0){f.innerHTML=`<p>${c("reservations.list.empty","⚠️ لا توجد حجوزات بعد.")}</p>`;return}const h=t||sI(),g=new Map(i.map(S=>[String(S.id),S])),y=new Map(m.map(S=>[String(S.id),S])),E=lI({reservations:d,filters:h,customersMap:g,techniciansMap:y,projectsMap:p});if(E.length===0){f.innerHTML=`<p>${c("reservations.list.noResults","🔍 لا توجد حجوزات مطابقة للبحث.")}</p>`;return}f.innerHTML=`<div class="reservations-grid">${dI({entries:E,customersMap:g,techniciansMap:y,projectsMap:p})}</div>`,f.querySelectorAll('[data-action="details"]').forEach(S=>{const x=Number(S.dataset.reservationIndex);Number.isNaN(x)||S.addEventListener("click",()=>{typeof n=="function"&&n(x)})}),f.querySelectorAll('button[data-action="confirm"]').forEach(S=>{const x=Number(S.dataset.reservationIndex);Number.isNaN(x)||S.addEventListener("click",A=>{A.stopPropagation(),typeof a=="function"&&a(x,A)})})}function Px(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:s=[],customers:r=[],projects:i=[]}=ae(),o=s.map(g=>{const y=Hs(g);return{...y,id:g.id??y.id,reservationId:g.reservationId??g.reservation_id??y.reservationId,reservationCode:g.reservationCode??g.reservation_code??y.reservationCode}}),l=s[e];if(!l)return I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const d=o[e]??Hs(l),u=r.find(g=>String(g.id)===String(l.customerId)),m=l.projectId?i.find(g=>String(g.id)===String(l.projectId)):null,p=document.getElementById("reservation-details-body"),f=document.getElementById("reservationDetailsModal"),h=()=>{const g=()=>{f&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(f)?.hide()},y=document.getElementById("reservation-details-edit-btn");y&&(y.onclick=()=>{g(),typeof t=="function"&&t(e,{reservation:l,customer:u,getEditContext:a})});const E=document.getElementById("reservation-details-delete-btn");E&&(E.onclick=()=>{g(),typeof n=="function"&&n(e,{reservation:l,customer:u})});const S=p?.querySelector('[data-action="open-project"]');S&&m&&S.addEventListener("click",()=>{g();const A=m?.id!=null?String(m.id):"",C=A?`projects.html?project=${encodeURIComponent(A)}`:"projects.html";window.location.href=C});const x=document.getElementById("reservation-details-export-btn");x&&(x.onclick=async A=>{A?.preventDefault?.(),A?.stopPropagation?.(),x.blur();try{await _x({reservation:l,customer:u,project:m})}catch(C){console.error("❌ [reservations] export to PDF failed",C),I(c("reservations.details.actions.exportFailed","⚠️ تعذر تصدير الحجز إلى PDF"),"error")}})};if(p){const g=Ut()||[];p.innerHTML=al(d,u,g,e,m),h(),es().then(()=>{const y=Ut()||[];p.innerHTML=al(d,u,y,e,m),h()}).catch(()=>{})}return f&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(f).show(),!0}function Ov(){const e=()=>{li(),jt(),Ut()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(e,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(e);return}}e()}let $h=!1,Dh=null;function Lx(e){if(!e||typeof e!="object")return"";const t=Object.entries(e).filter(([n,a])=>a!=null).map(([n,a])=>[n,String(a)]);return t.length===0?"":JSON.stringify(t.sort(([n],[a])=>n.localeCompare(a)))}async function pi(e={}){const{suppressError:t=!0,params:n=null,force:a=!1}=e??{},s=Lx(n);if(!a&&$h&&We().length>0&&s===Dh)return We();try{const r=await Zs(n||{});return $h=!0,Dh=s,r}catch(r){if(console.error("❌ [reservationsActions] Failed to load reservations from API",r),!t)throw r;return We()}}async function Nx(e,{onAfterChange:t}={}){if(!St())return Nn(),!1;const a=We()[e];if(!a)return I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const s=a.id||a.reservationId;if(!s)return I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;try{return await hb(s),Ov(),t?.({type:"deleted",reservation:a}),I(c("reservations.toast.deleted","🗑️ تم حذف الحجز")),!0}catch(r){console.error("❌ [reservationsActions] deleteReservation failed",r);const i=oi(r)?r.message:c("reservations.toast.deleteFailed","تعذر حذف الحجز، حاول مرة أخرى");return I(i,"error"),!1}}async function $x(e,{onAfterChange:t}={}){const a=We()[e];if(!a)return I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const s=a.id||a.reservationId;if(!s)return I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const{projectLinked:r}=Vt(a);if(r)return I(c("reservations.toast.confirmBlockedByProject","⚠️ حالة هذا الحجز تتحكم بها حالة المشروع المرتبط ولا يمكن تأكيده من هنا"),"info"),!1;try{const i=await yb(s);return Ov(),t?.({type:"confirmed",reservation:i}),I(c("reservations.toast.confirmed","✅ تم تأكيد الحجز")),!0}catch(i){console.error("❌ [reservationsActions] confirmReservation failed",i);const o=oi(i)?i.message:c("reservations.toast.confirmFailed","تعذر تأكيد الحجز، حاول مرة أخرى");return I(o,"error"),!1}}function fi(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:ca(e,n),end:ca(t,a)}}function ol(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Pp(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Uv(){const{container:e,select:t,hint:n,addButton:a}=Pp();if(!t)return;const s=t.value,r=Bm(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","اختر الحزمة")}</option>`,l=r.map(u=>{const m=Number.isFinite(Number(u.price))?Number(u.price):0,p=b(m.toFixed(2)),f=`${u.name} — ${p} ${i}`;return`<option value="${ol(u.id)}">${ol(f)}</option>`}).join("");t.innerHTML=`${o}${l}`;const d=r.length>0;t.disabled=!d,a&&(a.disabled=!d),e&&(e.hidden=!d,e.setAttribute("aria-hidden",d?"false":"true")),n&&(d?(n.textContent=c("reservations.create.packages.hint","حدد الحزمة ثم اضغط على الزر لإضافتها للحجز."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","لا توجد حزم معرفة حالياً. يمكنك إضافتها لاحقاً من لوحة التحكم."),n.dataset.state="empty")),d&&s&&r.some(u=>u.id===s)?t.value=s:t.selectedIndex=0}function Dx(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||I(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),{success:!1,reason:"invalid"};const{index:a,items:s=[]}=ss(),{start:r,end:i}=fi(),{reservations:o=[]}=ae(),l=a!=null&&o[a]||null,d=l?.id??l?.reservationId??null,u=tv(n,{existingItems:s,start:r,end:i,ignoreReservationId:d});if(!u.success)return t||I(u.message||c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),u;const m=[...s,u.package];return rs(a,m),as(m),Rt(),t||I(c("reservations.toast.packageAdded","✅ تم إضافة الحزمة بنجاح")),u}function Bh(){const{select:e}=Pp();if(!e)return;const t=e.value||"";Dx(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function Bx(){const{addButton:e,select:t}=Pp();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Bh()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Bh())}),t.dataset.listenerAttached="true"),Uv()}function as(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","لا توجد معدات"),a=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","صورة"),r=c("reservations.equipment.actions.increase","زيادة الكمية"),i=c("reservations.equipment.actions.decrease","تقليل الكمية"),o=c("reservations.equipment.actions.remove","إزالة البند");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${n}</td></tr>`,Rh(t);return}const l=Xs(e);t.innerHTML=l.map(d=>{const u=d.items[0]||{},m=tr(u)||d.image,p=m?`<img src="${m}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',f=d.items.some(q=>q?.type==="package"),h=b(String(d.count)),g=xe(d.unitPrice),y=Number.isFinite(g)?Ee(g):0,E=xe(d.totalPrice),S=Number.isFinite(E)?E:y*(Number.isFinite(d.count)?d.count:1),x=Ee(S),A=`${b(y.toFixed(2))} ${a}`,C=`${b(x.toFixed(2))} ${a}`,j=d.barcodes.map(q=>b(String(q||""))).filter(Boolean),k=j.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
            <ul class="reservation-barcode-list">
              ${j.map(q=>`<li>${q}</li>`).join("")}
            </ul>
          </details>`:"";let w="";if(f){const q=new Map,F=L=>{const B=Number.parseFloat(b(String(L??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(B)||B<=0||B>99?1:Math.round(B)},U=[];if(Array.isArray(d.packageItems)&&d.packageItems.length&&U.push(...d.packageItems),d.items.forEach(L=>{Array.isArray(L?.packageItems)&&U.push(...L.packageItems)}),U.forEach(L=>{if(!L)return;const B=ve(L.barcode||L.normalizedBarcode||L.desc||Math.random());if(!B)return;const D=q.get(B),K=F(L.qtyPerPackage??L.perPackageQty??L.quantityPerPackage??L.qty??L.quantity??1),Z=Math.max(1,Math.min(K,99));if(D){D.qty=Z;return}q.set(B,{desc:L.desc||L.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:Z,barcode:L.barcode??L.normalizedBarcode??""})}),q.size){const L=Array.from(q.values()).map(B=>{const D=b(String(B.qty>0?Math.min(B.qty,99):1)),K=ol(B.desc||""),Z=B.barcode?` <span class="reservation-package-items__barcode">(${ol(b(String(B.barcode)))})</span>`:"";return`<li>${K}${Z} × ${D}</li>`}).join("");w=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
              <ul class="reservation-package-items__list">
                ${L}
              </ul>
            </details>
          `}}const _=f?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",$=f?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${d.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${p}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${d.description||"-"}</div>
                ${f?`${w||""}${k||""}`:k}
              </div>
            </div>
          </td>
          <td>
            <div class="${_}" data-group-key="${d.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${d.key}" aria-label="${i}"${$}>−</button>
              <span class="reservation-qty-value">${h}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${d.key}" aria-label="${r}"${$}>+</button>
            </div>
          </td>
          <td>${A}</td>
          <td>${C}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${d.key}" aria-label="${o}">🗑️</button>
          </td>
        </tr>
      `}).join(""),Rh(t)}function Fx(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","💵 دفعة مالية");case"percent":return c("reservations.paymentHistory.type.percent","٪ دفعة نسبة");default:return c("reservations.paymentHistory.type.unknown","دفعة")}}function Wl(){const e=document.getElementById("edit-res-payment-history");if(!e)return;const t=Ql();if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة لهذا الحجز")}</div>`,Fh();return}const n=c("reservations.create.summary.currency","SR"),a=t.map((s,r)=>{const i=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${b(Number(s.amount).toFixed(2))} ${n}`:"—",o=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${b(Number(s.percentage).toFixed(2))}%`:"—",l=s?.recordedAt?b(mt(s.recordedAt)):"—",d=Fx(s?.type),u=s?.note?b(s.note):"";return`
      <tr>
        <td>${d}</td>
        <td>${i}</td>
        <td>${o}</td>
        <td>${l}</td>
        <td>${u}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${r}" aria-label="${c("reservations.paymentHistory.actions.delete","حذف الدفعة")}">🗑️</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","نوع الدفعة")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","المبلغ")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","النسبة")}</th>
            <th>${c("reservations.paymentHistory.headers.date","التاريخ")}</th>
            <th>${c("reservations.paymentHistory.headers.note","ملاحظات")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${a}</tbody>
      </table>
    </div>
  `,Fh()}function Rx(){if(ao()){I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=Gv(e);let a=Yv(t);if(!Number.isFinite(a)||a<=0){I(c("reservations.toast.paymentInvalid","⚠️ يرجى إدخال قيمة دفعة صحيحة"));return}const s=Oc.lastResult,r=Number(s?.total)||0,i=Number(s?.paidPercent)||0,o=Number(s?.paidAmount)||0,l=c("reservations.create.summary.currency","SR");let d=null,u=null;if(n==="percent"){const p=Math.max(0,100-i);if(p<=1e-4){I(c("reservations.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة"));return}const f=Math.min(a,p);if(f!==a){const h=b(f.toFixed(2));I(c("reservations.toast.paymentCappedPercent","ℹ️ تم ضبط الدفعة إلى {value}% لاستكمال 100%").replace("{value}",h)),a=f}u=Number(a.toFixed(2)),r>0&&(d=a/100*r)}else{const p=Math.max(0,r-o);if(p<=1e-4){I(c("reservations.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة"));return}const f=Math.min(a,p);if(f!==a){const h=`${b(f.toFixed(2))} ${l}`;I(c("reservations.toast.paymentCappedAmount","ℹ️ تم ضبط الدفعة إلى {amount} لاستكمال المبلغ المتبقي").replace("{amount}",h)),a=f}d=Number(a.toFixed(2)),r>0&&(u=d/r*100)}d!=null&&(d=Number(d.toFixed(2))),u!=null&&(u=Number(u.toFixed(2)));const m={type:n,value:a,amount:d,percentage:u,recordedAt:new Date().toISOString()};Yx(m),Lp(Ql()),Wl(),Rt(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),I(c("reservations.toast.paymentAdded","✅ تم تسجيل الدفعة"))}function Fh(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(ao()){n.preventDefault(),I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}Rx()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(ao()){n.preventDefault(),I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}const s=Number(a.dataset.index);Number.isNaN(s)||(Xx(s),Lp(Ql()),Wl(),Rt(),I(c("reservations.toast.paymentRemoved","🗑️ تم حذف الدفعة")))}),t.dataset.listenerAttached="true")}function Mx(e){const{index:t,items:n}=ss(),s=Xs(n).find(o=>o.key===e);if(!s||s.items.some(o=>o?.type==="package"))return;const r=s.itemIndices[s.itemIndices.length-1];if(r==null)return;const i=n.filter((o,l)=>l!==r);rs(t,i),as(i),Rt()}function Hx(e){const{index:t,items:n}=ss(),a=n.filter(s=>wo(s)!==e);a.length!==n.length&&(rs(t,a),as(a),Rt())}function zx(e){const{index:t,items:n}=ss(),s=Xs(n).find(y=>y.key===e);if(!s||s.items.some(y=>y?.type==="package"))return;const{start:r,end:i}=fi();if(!r||!i){I(c("reservations.toast.requireOverallDates","⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات"));return}const{reservations:o=[]}=ae(),l=t!=null&&o[t]||null,d=l?.id??l?.reservationId??null,u=new Set(n.map(y=>ve(y.barcode))),{equipment:m=[]}=ae(),p=(m||[]).find(y=>{const E=ve(y?.barcode);return!E||u.has(E)||wo({desc:y?.desc||y?.description||y?.name||"",price:Number(y?.price)||0})!==e||!cp(y)?!1:!Xn(E,r,i,d)});if(!p){I(c("reservations.toast.noAdditionalUnits","⚠️ لا توجد وحدات إضافية متاحة حالياً"));return}const f=ve(p.barcode),h=ns(p);if(!h){I(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const g=[...n,{id:h,equipmentId:h,barcode:f,desc:p.desc||p.description||p.name||s.description||"",qty:1,price:Number.isFinite(Number(p.price))?Number(p.price):s.unitPrice,image:tr(p)}];rs(t,g),as(g),Rt()}function Rh(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s,itemIndex:r}=n.dataset;if(a==="decrease-edit-group"&&s){Mx(s);return}if(a==="increase-edit-group"&&s){zx(s);return}if(a==="remove-edit-group"&&s){Hx(s);return}if(a==="remove-edit-item"){const i=Number(r);Number.isNaN(i)||Vx(i)}}),e.dataset.groupListenerAttached="true")}function ao(){return!!document.getElementById("edit-res-project")?.value}function Ox(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{ao()&&(I(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(s=>a.addEventListener(s,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function Ux(e){const t=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),s=document.getElementById("edit-res-paid"),r=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),l=document.getElementById("edit-res-payment-history");[n,a,s,r,i,o,l].forEach(Ox),e?(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),s&&(s.value="unpaid",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t,s.dataset&&delete s.dataset.userSelected),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),l&&(l.dataset.linkedDisabled="true")):(n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),l&&(l.dataset.linkedDisabled="false"))}function Rt(){const e=document.getElementById("edit-res-summary");if(!e)return;Wl();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),mn(a),Rt()}),a.dataset.listenerAttached="true");const s=b(t?.value||"0");t&&(t.value=s);const r=parseFloat(s)||0,i=n?.value||"percent",o=ao();Ux(o);const l=document.getElementById("edit-res-tax"),d=o?!1:l?.checked||!1,u=!o&&a?.dataset?.userSelected==="true",m=o?"unpaid":u&&a?.value||"unpaid";let p=null;!o&&d&&(Pn("edit-res-company-share"),p=Vr("edit-res-company-share"),(!Number.isFinite(p)||p<=0)&&(Pn("edit-res-company-share"),p=Vr("edit-res-company-share")));const{items:f=[],payments:h=[]}=ss(),{start:g,end:y}=fi(),E=Oc({items:f,discount:r,discountType:i,applyTax:d,paidStatus:m,start:g,end:y,companySharePercent:p,paymentHistory:h});e.innerHTML=E;const S=Oc.lastResult;if(S&&a){const x=S.paymentStatus;u?mn(a,a.value):(a.value!==x&&(a.value=x),a.dataset&&delete a.dataset.userSelected,mn(a,x))}else a&&mn(a,a.value)}function Vx(e){if(e==null)return;const{index:t,items:n}=ss();if(!Array.isArray(n))return;const a=n.filter((s,r)=>r!==e);rs(t,a),as(a),Rt()}function Kx(e){const t=e?.value??"",n=ve(t);if(!n)return;const a=$l(n);if(!a){I(c("reservations.toast.barcodeNotInCatalog","❌ الباركود غير موجود ضمن المعدات"));return}const s=ja(a);if(s==="maintenance"||s==="retired"){I(Ws(s));return}const r=ve(n),{index:i,items:o=[]}=ss();if(o.findIndex(y=>ve(y.barcode)===r)>-1){I(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const{start:d,end:u}=fi();if(!d||!u){I(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const{reservations:m=[]}=ae(),p=i!=null&&m[i]||null,f=p?.id??p?.reservationId??null;if(Xn(r,d,u,f)){I(c("reservations.toast.equipmentTimeConflictSimple","⚠️ هذه المعدة محجوزة في نفس الفترة الزمنية"));return}const h=ns(a);if(!h){I(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const g=[...o,{id:h,equipmentId:h,barcode:r,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];rs(i,g),e&&(e.value=""),as(g),Rt()}function cl(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Xb(t),a=ve(n?.barcode||t);if(!n||!a){I(c("reservations.toast.equipmentNameNotFound","❌ لم يتم العثور على معدة بالاسم المدخل"));return}const s=ja(n);if(s==="maintenance"||s==="retired"){I(Ws(s));return}const{start:r,end:i}=fi();if(!r||!i){I(c("reservations.toast.requireOverallDates","⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات"));return}const{index:o,items:l=[]}=ss();if(l.some(g=>ve(g.barcode)===a)){I(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const{reservations:u=[]}=ae(),m=o!=null&&u[o]||null,p=m?.id??m?.reservationId??null;if(Xn(a,r,i,p)){I(c("reservations.toast.equipmentTimeConflictSimple","⚠️ هذه المعدة محجوزة في نفس الفترة الزمنية"));return}const f=ns(n);if(!f){I(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const h=[...l,{id:f,equipmentId:f,barcode:a,desc:n.desc,qty:1,price:n.price,image:n.image||n.imageUrl||n.img||null}];rs(o,h),as(h),Rt(),e.value=""}function Vv(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),cl(e))});const t=()=>{Jb(e.value,"edit-res-equipment-description-options")&&cl(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{Rt()});const e=()=>{Bx()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Uv()})}typeof window<"u"&&(window.getEditReservationDateRange=fi,window.renderEditPaymentHistory=Wl);function Wx(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){ju(e);return}cl(e)}}function Kv(){Ja(),Vv()}function Wv(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let Tr=null,Rn=[],Gn=[],Bu=null,Ht={},qd=!1;const Qx="__DEBUG_CREW__";function Gx(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Qx);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function Mh(e,t){if(Gx())try{console.log(`🪵 [crew-debug:edit] ${e}`,t)}catch{}}function Fu(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),s=document.getElementById("edit-res-confirmed-wrapper"),r=!!e;if(n&&(n.value=r?"true":"false"),a){const i=a.dataset.confirmLabel||"✅ تم التأكيد",o=a.dataset.pendingLabel||"⏳ بانتظار التأكيد";a.innerHTML=r?i:o,a.dataset.state=r?"confirmed":"pending",a.classList.toggle("btn-success",r&&!t),a.classList.toggle("btn-outline-secondary",!r||t),a.disabled=t,a.setAttribute("aria-pressed",r?"true":"false")}s&&s.classList.toggle("is-disabled",t)}function Ru(){return document.getElementById("edit-res-confirmed")?.value==="true"}function ss(){return{index:Tr,items:Rn,payments:Gn}}function rs(e,t,n=Gn){Tr=typeof e=="number"?e:null,Rn=Array.isArray(t)?[...t]:[],Gn=Array.isArray(n)?[...n]:[]}function Qv(){Tr=null,Rn=[],dw(),Gn=[]}function Ql(){return[...Gn]}function Lp(e){Gn=Array.isArray(e)?[...e]:[]}function Yx(e){e&&(Gn=[...Gn,e])}function Xx(e){!Number.isInteger(e)||e<0||(Gn=Gn.filter((t,n)=>n!==e))}function Hi(e,t=1){const n=Number.parseFloat(b(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function Mu(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(b(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function Jx(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?ve(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:Hi(e.qty??e.quantity??e.count??1),price:Mu(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function Zx(e,t=0){if(!e||typeof e!="object")return null;const n=kt(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=Hi(e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1),r=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:qn(e)).map(p=>Jx(p)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=Mu(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const p=Mu(i,0);p>0&&a>0&&(o=Number((p/a).toFixed(2)))}const l=e.package_code??e.packageCode??e.barcode??null,u=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,l,n].find(p=>p!=null&&String(p).trim()!=="")||`Package ${n}`,m=e.image??e.cover??e.thumbnail??r.find(p=>p?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:b(String(u)),name:b(String(u)),qty:a,price:o,barcode:l,packageItems:r,image:m}}function eq(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const s=e.get(a);if(s==null)return;const r=s-n;e.set(a,r>0?r:0)})}function tq(e={},t=[]){const n=Array.isArray(t)?t.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return n;const s=a.map((o,l)=>Zx(o,l)).filter(Boolean);if(!s.length)return n;const r=new Map;s.forEach(o=>{const l=Hi(o.qty??o.quantity??1);if(o.barcode){const d=ve(o.barcode);if(d){const u=`package::${d}`;r.set(u,(r.get(u)??0)+l)}}(o.packageItems||[]).forEach(d=>{if(!d)return;const u=l*Hi(d.qty??d.quantity??1),m=d.equipmentId??null,p=d.normalizedBarcode||(d.barcode?ve(d.barcode):null);if(m!=null){const f=`equipment::${String(m)}`;r.set(f,(r.get(f)??0)+u)}if(p){const f=`barcode::${p}`;r.set(f,(r.get(f)??0)+u)}})});const i=[];return n.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const y=kt(o.packageId??o.package_id??o.id??"");s.some(S=>S.packageId===y)||i.push({...o});return}const l=Hi(o.qty??o.quantity??1),d=ns(o),u=o.barcode?ve(o.barcode):null,m=[];d!=null&&m.push(`equipment::${String(d)}`),u&&m.push(`barcode::${u}`);const p=m.map(y=>r.get(y)??0).filter(y=>y>0);if(!p.length){i.push({...o});return}const f=Math.min(...p);if(f<=0){i.push({...o});return}const h=Math.min(f,l);if(eq(r,m,h),h>=l)return;const g=l-h;i.push({...o,qty:g,quantity:g})}),[...i,...s.map(o=>({...o}))]}function nq(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Gv(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Yv(e){if(!e)return null;const t=b(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function aq(e,t){if(e){e.value="";return}}function ji(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Xv(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(b(String(e.value??""))),a=Number.parseFloat(b(String(e.amount??""))),s=Number.parseFloat(b(String(e.percentage??""))),r=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,i=Number.isFinite(s)?s:t==="percent"&&Number.isFinite(n)?n:null,o=t??(Number.isFinite(r)?"amount":Number.isFinite(i)?"percent":null),l=o==="amount"?r??null:o==="percent"?i??null:Number.isFinite(n)?n:null,d=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:l,amount:Number.isFinite(r)?r:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:d}}function sq(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","اختر مشروعاً (اختياري)"),s=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),r=t?.projectId?String(t.projectId):"",i=Array.isArray(e)?[...e].sort((l,d)=>String(d.createdAt||d.start||"").localeCompare(String(l.createdAt||l.start||""))):[],o=[`<option value="">${ji(a)}</option>`];i.forEach(l=>{o.push(`<option value="${ji(l.id)}">${ji(l.title||a)}</option>`)}),r&&!i.some(l=>String(l.id)===r)&&o.push(`<option value="${ji(r)}">${ji(s)}</option>`),n.innerHTML=o.join(""),r?n.value=r:n.value=""}function Jv(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),s=document.getElementById("edit-res-discount-type"),r=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=r),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=r),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=r),s&&(s.value="percent",s.disabled=!0,s.classList.add("disabled","reservation-input-disabled"),s.title=r);else{if(t){const l=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",l&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("disabled","reservation-input-disabled"),s.title="")}Hu("tax");const o=Ht?.updateEditReservationSummary;typeof o=="function"&&o()}function Hu(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const r=Ht?.updateEditReservationSummary;typeof r=="function"&&r()};if(qd){a();return}qd=!0;const s=()=>{qd=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(Fe)),t.disabled){n.checked=!1,I(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة")),s();return}t.checked||(t.checked=!0),Pn("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Pn("edit-res-company-share"):n.checked&&(n.checked=!1));s()}async function Hh(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:s,updateEditReservationSummary:r,ensureModal:i}={}){const{customers:o,projects:l}=ae(),u=We()?.[e];if(!u){I(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز"));return}Ht={...Ht,reservation:u,projects:l||[]},t?.(),sq(l||[],u);const m=u.projectId&&l?.find?.(M=>String(M.id)===String(u.projectId))||null,{effectiveConfirmed:p,projectLinked:f}=Vt(u,m),h=u.items?u.items.map(M=>({...M,equipmentId:M.equipmentId??M.equipment_id??M.id,barcode:ve(M?.barcode)})):[],g=tq(u,h),E=(Array.isArray(u.paymentHistory)?u.paymentHistory:Array.isArray(u.payment_history)?u.payment_history:[]).map(M=>Xv(M)).filter(Boolean);rs(e,g,E);const S=c("reservations.list.unknownCustomer","غير معروف"),x=o?.find?.(M=>String(M.id)===String(u.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const A=document.getElementById("edit-res-id");A&&(A.value=u.reservationId||u.id);const C=document.getElementById("edit-res-customer");C&&(C.value=x?.customerName||S);const j=typeof a=="function"?a(u.start):{date:"",time:""},k=typeof a=="function"?a(u.end):{date:"",time:""};n?.("edit-res-start",j.date),n?.("edit-res-start-time",j.time),n?.("edit-res-end",k.date),n?.("edit-res-end-time",k.time);const w=document.getElementById("edit-res-notes");w&&(w.value=u.notes||"");const _=document.getElementById("edit-res-discount");if(_){const M=f?0:u.discount??0;_.value=b(M)}const $=document.getElementById("edit-res-discount-type");$&&($.value=f?"percent":u.discountType||"percent");const q=u.projectId?!1:!!u.applyTax,F=document.getElementById("edit-res-tax");F&&(F.checked=q);const U=document.getElementById("edit-res-company-share");if(U){const M=u.companySharePercent??u.company_share_percent??u.companyShare??u.company_share??null,H=M!=null?Number.parseFloat(b(String(M).replace("%","").trim())):NaN,V=u.companyShareEnabled??u.company_share_enabled??u.companyShareApplied??u.company_share_applied??null,G=V!=null?V===!0||V===1||V==="1"||String(V).toLowerCase()==="true":Number.isFinite(H)&&H>0,ie=G&&Number.isFinite(H)&&H>0?H:Fe,ee=q||G;U.checked=ee,U.dataset.companyShare=String(ie)}Fu(p,{disable:f});const L=document.getElementById("edit-res-paid"),B=u.paidStatus??(u.paid===!0||u.paid==="paid"?"paid":"unpaid");L&&(L.value=B,L.dataset&&delete L.dataset.userSelected);const D=document.getElementById("edit-res-payment-progress-type"),K=document.getElementById("edit-res-payment-progress-value");D?.dataset?.userSelected&&delete D.dataset.userSelected,D&&(D.value="percent"),aq(K);let Z=Array.isArray(u.crewAssignments)&&u.crewAssignments.length?u.crewAssignments:Array.isArray(u.techniciansDetails)&&u.techniciansDetails.length?u.techniciansDetails:(u.technicians||[]).map(M=>String(M));if(!Array.isArray(Z)||Z.length===0){const M=mb(u.id??u.reservationId??u.reservation_code??null);Array.isArray(M)&&M.length&&(Z=M)}try{await es()}catch(M){console.warn("[reservationsEdit] positions load failed (non-fatal)",M)}if(cw(Z),s?.(g),typeof window<"u"){const M=window?.renderEditPaymentHistory;typeof M=="function"&&M()}Jv(),r?.();const R=document.getElementById("editReservationModal");Bu=nq(R,i),Bu?.show?.()}async function rq({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:s,renderReservations:r,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(Tr===null){console.warn("⚠️ [reservationsEdit.js] No reservation selected for editing");return}const l=document.getElementById("edit-res-start")?.value?.trim(),d=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end")?.value?.trim(),m=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-notes")?.value||"",f=b(document.getElementById("edit-res-discount")?.value||"0");let h=parseFloat(f)||0,g=document.getElementById("edit-res-discount-type")?.value||"percent";const y=Ru(),E=document.getElementById("edit-res-paid"),S=E?.dataset?.userSelected==="true",x=S&&E?.value||"unpaid",A=document.getElementById("edit-res-payment-progress-type"),C=document.getElementById("edit-res-payment-progress-value"),j=Gv(A),k=Yv(C),w=document.getElementById("edit-res-project")?.value||"",_=nb();_.map(te=>te?.technicianId).filter(Boolean);const $=document.getElementById("edit-res-company-share"),q=document.getElementById("edit-res-tax");if(!l||!u){I(c("reservations.toast.requireDates","⚠️ يرجى تحديد تاريخ البداية والنهاية"));return}const F=typeof e=="function"?e:(te,Ce)=>`${te}T${Ce||"00:00"}`,U=F(l,d),L=F(u,m);if(U&&L&&new Date(U)>new Date(L)){I(c("reservations.toast.invalidDateOrder","⚠️ تاريخ البداية لا يمكن أن يكون بعد تاريخ النهاية"));return}const D=We()?.[Tr];if(!D){I(c("reservations.toast.reservationMissing","⚠️ تعذر العثور على الحجز المطلوب"));return}if(!Array.isArray(Rn)||Rn.length===0&&_.length===0){I(c("reservations.toast.updateNoItems","⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل للحجز"));return}const K=typeof t=="function"?t:()=>!1,Z=D.id??D.reservationId;for(const te of Rn){if(te?.type==="package"&&Array.isArray(te.packageItems)){for(const X of te.packageItems){const Ae=X?.barcode??X?.normalizedBarcode??"";if(!Ae)continue;const Ne=ja(Ae);if(Ne==="reserved"){const je=ve(Ae);if(!K(je,U,L,Z))continue}if(Ne!=="available"){I(Ws(Ne));return}}continue}const Ce=ja(te.barcode);if(Ce==="reserved"){const X=ve(te.barcode);if(!K(X,U,L,Z))continue}if(Ce!=="available"){I(Ws(Ce));return}}for(const te of Rn){if(te?.type==="package"&&Array.isArray(te.packageItems)){for(const X of te.packageItems){const Ae=ve(X?.barcode??X?.normalizedBarcode??"");if(Ae&&K(Ae,U,L,Z)){const Ne=X?.desc||X?.barcode||c("reservations.create.packages.unnamedItem","معدة بدون اسم"),je=`${c("reservations.toast.updateEquipmentConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات")} (${b(String(Ne))})`;I(je);return}}continue}const Ce=ve(te.barcode);if(K(Ce,U,L,Z)){I(c("reservations.toast.updateEquipmentConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات"));return}}const R=typeof n=="function"?n:()=>!1;for(const te of Rn){if(te?.type!=="package")continue;const Ce=te.packageId??te.package_id??null;if(Ce&&R(Ce,U,L,Z)){const X=te.desc||te.packageName||c("reservations.create.packages.genericName","الحزمة");I(c("reservations.toast.packageTimeConflict",`⚠️ الحزمة ${b(String(X))} محجوزة بالفعل في الفترة المختارة`));return}}const M=typeof a=="function"?a:()=>!1;for(const te of _)if(te?.technicianId&&M(te.technicianId,U,L,Z)){I(c("reservations.toast.updateCrewConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في جدول أحد أعضاء الطاقم"));return}const H=Array.isArray(Ht.projects)&&Ht.projects.length?Ht.projects:ae().projects||[],V=w&&H.find(te=>String(te.id)===String(w))||null,G={...D,projectId:w?String(w):null,confirmed:y},{effectiveConfirmed:ie,projectLinked:ee,projectStatus:oe}=Vt(G,V);let W=!!$?.checked,be=!!q?.checked;if(ee&&(W&&($.checked=!1,W=!1),be=!1),!ee&&W!==be){I(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"));return}be&&(Pn("edit-res-company-share"),W=!!$?.checked);let he=W?getCompanySharePercent("edit-res-company-share"):null;W&&(!Number.isFinite(he)||he<=0)&&(Pn("edit-res-company-share"),he=getCompanySharePercent("edit-res-company-share"));const Se=W&&be&&Number.isFinite(he)&&he>0,we=ee?!1:be;ee&&(h=0,g="percent");const J=Js(Rn,h,g,we,_,{start:U,end:L,companySharePercent:Se?he:0});let re=Ql();if(Number.isFinite(k)&&k>0){const te=J;let Ce=null,X=null;j==="amount"?(Ce=k,te>0&&(X=k/te*100)):(X=k,te>0&&(Ce=k/100*te));const Ae=Xv({type:j,value:k,amount:Ce,percentage:X,recordedAt:new Date().toISOString()});Ae&&(re=[...re,Ae],Lp(re)),C&&(C.value="")}const ue=en({totalAmount:J,history:re}),Pe=fn({manualStatus:x,paidAmount:ue.paidAmount,paidPercent:ue.paidPercent,totalAmount:J});E&&!S&&(E.value=Pe,E.dataset&&delete E.dataset.userSelected);let Te=D.status??"pending";ee?Te=V?.status??oe??Te:["completed","cancelled"].includes(String(Te).toLowerCase())||(Te=y?"confirmed":"pending");const ye=Qm({reservationCode:D.reservationCode??D.reservationId??null,customerId:D.customerId,start:U,end:L,status:Te,title:D.title??null,location:D.location??null,notes:p,projectId:w?String(w):null,totalAmount:J,discount:h,discountType:g,applyTax:we,paidStatus:Pe,confirmed:ie,items:Rn.map(te=>({...te,equipmentId:te.equipmentId??te.id})),crewAssignments:_,companySharePercent:Se?he:null,companyShareEnabled:Se,paidAmount:ue.paidAmount,paidPercentage:ue.paidPercent,paymentProgressType:ue.paymentProgressType,paymentProgressValue:ue.paymentProgressValue,paymentHistory:re});try{Mh("about to submit",{editingIndex:Tr,crewAssignments:_,techniciansPayload:ye?.technicians,payload:ye});const te=await er(D.id||D.reservationId,ye);Mh("server response",{reservation:te?.id??te?.reservationId??te?.reservation_code,technicians:te?.technicians,crewAssignments:te?.crewAssignments,techniciansDetails:te?.techniciansDetails}),await Zs(),li(),jt(),I(c("reservations.toast.updated","✅ تم حفظ التعديلات على الحجز")),s?.(),Qv(),o?.({type:"updated",reservation:te}),r?.(),i?.(),Bu?.hide?.()}catch(te){console.error("❌ [reservationsEdit] Failed to update reservation",te);const Ce=oi(te)?te.message:c("reservations.toast.updateFailed","تعذر تحديث بيانات الحجز");I(Ce,"error")}}function Zv(e={}){Ht={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:s}=Ht,r=document.getElementById("edit-res-discount");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=b(r.value),t?.()}),r.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>t?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{Hu("tax")}),o.dataset.listenerAttached="true");const l=document.getElementById("edit-res-company-share");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{Hu("share")}),l.dataset.listenerAttached="true");const d=document.getElementById("edit-res-payment-progress-type");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{d.dataset.userSelected="true",t?.()}),d.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-value");u&&!u.dataset.listenerAttached&&(u.addEventListener("input",()=>{u.value=b(u.value)}),u.dataset.listenerAttached="true"),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const m=document.getElementById("edit-res-project");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{Jv();const y=Array.isArray(Ht.projects)&&Ht.projects.length?Ht.projects:ae().projects||[],E=m.value&&y.find(j=>String(j.id)===String(m.value))||null,x={...Ht?.reservation??{},projectId:m.value||null,confirmed:Ru()},{effectiveConfirmed:A,projectLinked:C}=Vt(x,E);Fu(A,{disable:C}),t?.()}),m.dataset.listenerAttached="true");const p=document.getElementById("edit-res-confirmed-btn");p&&!p.dataset.listenerAttached&&(p.addEventListener("click",()=>{if(p.disabled)return;const y=!Ru();Fu(y),t?.()}),p.dataset.listenerAttached="true");const f=document.getElementById("save-reservation-changes");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{rq(Ht).catch(y=>{console.error("❌ [reservationsEdit] saveReservationChanges failed",y)})}),f.dataset.listenerAttached="true");const h=document.getElementById("edit-res-equipment-barcode");if(h&&!h.dataset.listenerAttached){let y=null;const E=()=>{h.value?.trim()&&(clearTimeout(y),y=null,n?.(h))};h.addEventListener("keydown",x=>{x.key==="Enter"&&(x.preventDefault(),E())});const S=()=>{if(clearTimeout(y),!h.value?.trim())return;const{start:x,end:A}=getEditReservationDateRange();!x||!A||(y=setTimeout(()=>{E()},150))};h.addEventListener("input",S),h.addEventListener("change",E),h.dataset.listenerAttached="true"}Vv?.();const g=document.getElementById("editReservationModal");g&&!g.dataset.cleanupAttached&&(g.addEventListener("hidden.bs.modal",()=>{Qv(),t?.(),s?.([])}),g.dataset.cleanupAttached="true")}const iq=ae()||{};let kn=(iq.projects||[]).map(nS),Co=!1;function ir(){return kn}function Po(e){kn=Array.isArray(e)?e.map(Np):[],an({projects:kn});try{const t=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(t),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(t)}catch(t){console.warn("⚠️ [projectsService] Failed to dispatch projects:changed event",t)}return kn}async function Lo(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l==null||l===""||t.set(o,String(l))});const n=t.toString(),s=(await pe(`/projects/${n?`?${n}`:""}`))?.data;let r=[];Array.isArray(s)?r=s:s&&typeof s=="object"&&(Array.isArray(s.items)?r=s.items:Array.isArray(s.results)?r=s.results:Array.isArray(s.data)?r=s.data:Array.isArray(s.records)&&(r=s.records));const i=r.map($o);return Po(i),Co=!0,kn}async function Gl({force:e=!1,params:t=null}={}){if(!e&&Co&&kn.length>0)return kn;try{return await Lo(t||{})}catch(n){return console.error("❌ [projectsService] Failed to load projects from API",n),kn}}async function eS(e){const t=await pe("/projects/",{method:"POST",body:e}),n=$o(t?.data??{}),a=[...kn,n];return Po(a),Co=!0,n}async function hi(e,t){const n=await pe(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=$o(n?.data??{}),s=kn.map(r=>String(r.id)===String(e)?a:r);return Po(s),Co=!0,a}async function tS(e){await pe(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=kn.filter(n=>String(n.id)!==String(e));Po(t),Co=!0}function No({projectCode:e,title:t,type:n,clientId:a,clientCompany:s,description:r,start:i,end:o,applyTax:l,paymentStatus:d,equipmentEstimate:u=0,expenses:m=[],taxAmount:p=0,totalWithTax:f=0,discount:h=0,discountType:g="percent",companyShareEnabled:y=!1,companySharePercent:E=null,companyShareAmount:S=0,paidAmount:x=null,paidPercentage:A=null,paymentProgressType:C=null,paymentProgressValue:j=null,confirmed:k=!1,technicians:w=[],equipment:_=[],payments:$,paymentHistory:q}={}){const F=Array.isArray(w)?w.map(H=>Number.parseInt(String(H),10)).filter(H=>Number.isInteger(H)&&H>0):[],U=Array.isArray(_)?_.map(H=>{const V=Number.parseInt(String(H.equipmentId??H.equipment_id??H.id??0),10),G=Number.parseInt(String(H.qty??H.quantity??0),10);return!Number.isInteger(V)||V<=0?null:{equipment_id:V,quantity:Number.isInteger(G)&&G>0?G:1}}).filter(Boolean):[],L=Array.isArray(m)?m.map(H=>{const V=Number.parseFloat(H?.amount??H?.value??0)||0,G=(H?.label??H?.name??"").trim();return G?{label:G,amount:Math.round(V*100)/100}:null}).filter(Boolean):[],B=L.reduce((H,V)=>H+(V?.amount??0),0),D={title:t,type:n,client_id:a?Number.parseInt(String(a),10):null,client_company:s??null,description:r??null,start_datetime:i??null,end_datetime:o||null,apply_tax:!!l,payment_status:d??"unpaid",equipment_estimate:Number.parseFloat(u)||0,expenses_total:Math.round(B*100)/100,tax_amount:Math.round((Number.parseFloat(p)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(f)||0)*100)/100,confirmed:!!k,technicians:F,equipment:U,expenses:L},K=Math.max(0,Number.parseFloat(h)||0);D.discount=K,D.discount_type=g==="amount"?"amount":"percent";const Z=Number.parseFloat(E),R=!!y&&Number.isFinite(Z)&&Z>0;D.company_share_enabled=R,D.company_share_percent=R?Z:0,D.company_share_amount=R?Math.max(0,Number.parseFloat(S)||0):0,Number.isFinite(Number(x))&&(D.paid_amount=Math.max(0,Number.parseFloat(x)||0)),Number.isFinite(Number(A))&&(D.paid_percentage=Math.max(0,Number.parseFloat(A)||0)),(C==="amount"||C==="percent")&&(D.payment_progress_type=C),j!=null&&j!==""&&(D.payment_progress_value=Number.parseFloat(j)||0),e&&(D.project_code=String(e).trim());const M=$!==void 0?$:q;if(M!==void 0){const H=aS(M)||[];D.payments=H.map(V=>({type:V.type,amount:V.amount!=null?V.amount:null,percentage:V.percentage!=null?V.percentage:null,value:V.value!=null?V.value:null,note:V.note??null,recorded_at:V.recordedAt??null}))}return D.end_datetime||delete D.end_datetime,D.client_company||(D.client_company=null),D}function $o(e={}){return Np(e)}function nS(e={}){return Np(e)}function Np(e={}){const t=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],a=n.map(f=>{if(f==null)return null;if(typeof f=="object"){const h=f.id??f.technician_id??f.technicianId;return h!=null?String(h):null}return String(f)}).filter(Boolean),r=(Array.isArray(e.equipment)?e.equipment:[]).map(f=>{const h=f?.equipment_id??f?.equipmentId??f?.id??null,g=f?.quantity??f?.qty??0,y=f?.barcode??f?.code??"",E=f?.description??f?.name??"";return{equipmentId:h!=null?String(h):null,qty:Number.parseInt(String(g),10)||0,barcode:y,description:E}}),o=(Array.isArray(e.expenses)?e.expenses:[]).map((f,h)=>({id:f?.id??`expense-${t??"x"}-${h}`,label:f?.label??"",amount:Number.parseFloat(f?.amount??0)||0})),l=Number.parseFloat(e.company_share_percent??e.companySharePercent??0)||0,d=e.company_share_enabled??e.companyShareEnabled,u=d!=null?d===!0||d===1||String(d).toLowerCase()==="true":l>0,m=e.payment_history??e.paymentHistory??e.payments??null,p=aS(m);return{id:t!=null?String(t):"",projectId:t!=null?Number(t):null,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,discount:Number.parseFloat(e.discount??e.discount_value??0)||0,discountType:e.discount_type??e.discountType??"percent",companyShareEnabled:u,companySharePercent:u?l:0,companyShareAmount:Number.parseFloat(e.company_share_amount??e.companyShareAmount??0)||0,paidAmount:Number.parseFloat(e.paid_amount??e.paidAmount??0)||0,paidPercent:Number.parseFloat(e.paid_percentage??e.paidPercent??0)||0,paymentProgressType:e.payment_progress_type??e.paymentProgressType??null,paymentProgressValue:e.payment_progress_value??e.paymentProgressValue??null,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:n.map(f=>typeof f=="object"?f:{id:f}),equipment:r,expenses:o,paymentHistory:p}}function or(e){return e instanceof Ge}function kd(e){if(e==null||e==="")return null;const t=b(String(e)).replace(/[^\d.,-]/g,"").trim();if(!t)return null;let n=t;const a=n.includes(","),s=n.includes(".");a&&(n=s?n.replace(/,/g,""):n.replace(/,/g,"."));const r=Number.parseFloat(n);return Number.isFinite(r)?r:null}function oq(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??e.kind??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n==="percentage"&&(n="percent");const a=kd(e.value);let s=kd(e.amount),r=kd(e.percentage);if(n==="amount"&&s==null&&a!=null?s=a:n==="percent"&&r==null&&a!=null&&(r=a),!n)if(s!=null&&s>=0)n="amount";else if(r!=null&&r>=0)n="percent";else if(a!=null&&a>=0)n="amount",s=a;else return null;if(n==="amount"){if(s==null||!Number.isFinite(s)||s<0)return null;s=Math.round(s*100)/100}if(n==="percent"){if(r==null||!Number.isFinite(r)||r<0)return null;r=Math.min(100,Math.round(r*100)/100)}const i=e.note??e.memo??e.description??null,o=i!=null?String(i).trim():null,l=e.recordedAt??e.recorded_at??e.date??null;let d=null;if(l){const m=new Date(l);Number.isNaN(m.getTime())||(d=m.toISOString())}d||(d=new Date().toISOString());const u=n==="amount"?s:n==="percent"?r:a;return{type:n,amount:s??null,percentage:r??null,value:u!=null?Math.round(u*100)/100:null,note:o&&o.length?o.slice(0,500):null,recordedAt:d}}function aS(e){if(e!==void 0)return e===null?[]:Array.isArray(e)?e.map(t=>oq(t)).filter(Boolean):[]}const qL=Object.freeze(Object.defineProperty({__proto__:null,buildProjectPayload:No,createProjectApi:eS,deleteProjectApi:tS,ensureProjectsLoaded:Gl,getProjectsState:ir,isApiError:or,mapLegacyProject:nS,mapProjectFromApi:$o,refreshProjectsFromApi:Lo,setProjectsState:Po,updateProjectApi:hi},Symbol.toStringTag,{value:"Module"})),ll="reservations-ui:ready",ws=typeof EventTarget<"u"?new EventTarget:null;let js={};function cq(e){return Object.freeze({...e})}function lq(){if(!ws)return;const e=js,t=typeof CustomEvent=="function"?new CustomEvent(ll,{detail:e}):{type:ll,detail:e};typeof ws.dispatchEvent=="function"&&ws.dispatchEvent(t)}function $p(e={}){if(!e||typeof e!="object")return js;const t={...js};return Object.entries(e).forEach(([n,a])=>{typeof a=="function"?t[n]=a:a===null&&delete t[n]}),js=cq(t),lq(),js}function Yl(e){if(e)return js?.[e]}function Dp(e){const t=Yl(e);return typeof t=="function"?Promise.resolve(t):new Promise(n=>{const a=s=>{const i=(s?.detail||js)?.[e];typeof i=="function"&&(ws&&ws.removeEventListener(ll,a),n(i))};ws&&ws.addEventListener(ll,a)})}function sS(){return Gl().catch(e=>{console.warn("⚠️ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=ae()||{};ab(e||[]),vp()})}function Do(e=null){vp(),Ln(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function dq(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function so(){return{populateEquipmentDescriptionLists:Ja,setFlatpickrValue:Wv,splitDateTime:Gg,renderEditItems:as,updateEditReservationSummary:Rt,addEquipmentByDescription:Wx,addEquipmentToEditingReservation:Kx,addEquipmentToEditingByDescription:cl,combineDateTime:ca,hasEquipmentConflict:Xn,hasTechnicianConflict:Eo,renderReservations:Ln,handleReservationsMutation:Do,ensureModal:dq}}function Ln(e="reservations-list",t=null){Cx({containerId:e,filters:t,onShowDetails:Bo,onConfirmReservation:Fp})}function Bo(e){return Px(e,{getEditContext:so,onEdit:(t,{reservation:n})=>{Rp(t,n)},onDelete:Bp})}function Bp(e){return St()?window.confirm(c("reservations.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا الحجز؟"))?Nx(e,{onAfterChange:Do}):!1:(Nn(),!1)}function Fp(e){return $x(e,{onAfterChange:Do})}function Rp(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("⚠️ [reservations/controller] Unable to clear pending edit id (inline form)",r)}Hh(e,so());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("⚠️ [reservations/controller] Unable to clear pending edit id (modal)",r)}Hh(e,so());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const r=t.id??t.reservationId;n.set("reservationEditId",String(r));try{localStorage.setItem("pendingReservationEditId",String(r)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("⚠️ [reservations/controller] Unable to persist pending edit id",i)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(r){console.warn("⚠️ [reservations/controller] Unable to persist pending edit index",r)}}Ft({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(r=>{console.warn("⚠️ [reservations/controller] Failed to persist tab preference",r)});const a=n.toString(),s=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=s}function Mp(){$p({showReservationDetails:Bo,deleteReservation:Bp,confirmReservation:Fp,openReservationEditor:Rp})}let zu=!1;function uq(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.setAttribute("step","300")})}function mq(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):(console.warn("⚠️ Flatpickr غير متاح - سيتم تخطي تهيئة عناصر التاريخ"),null)}function pq(){const e=mq(),t={dateFormat:"Y-m-d",altInput:!0,altFormat:"Y-m-d",allowInput:!0,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"},n=[["#res-start",{}],["#res-end",{}],["#filter-start-date",{}],["#filter-end-date",{}],["#edit-res-start",{}],["#edit-res-end",{}]],a={enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,disableMobile:!0,minuteIncrement:5,altInputClass:"flatpickr-alt-input form-control"},s=["#res-start-time","#res-end-time","#edit-res-start-time","#edit-res-end-time"];e&&(n.forEach(([i,o])=>{document.querySelector(i)&&e(i,{...t,...o})}),s.forEach(i=>{document.querySelector(i)&&e(i,{...a})}));const r=document.querySelector("#res-start-time");r&&r.dispatchEvent(new Event("change",{bubbles:!0}))}function Hp(){if(!zu){uq(),rI(()=>Ln()),Zv(so()),ow({onDraftChange:He,onEditChange:Rt}),sS(),Kv(),zu=!0;try{const e=()=>Ln();document.addEventListener("reservations:updated",e),window.addEventListener("reservations:updated",e)}catch{}}}function fq(){const e=document.body;e&&e.dataset.reservationsTechListener!=="true"&&(document.addEventListener("technicians:updated",()=>{const{technicians:t=[]}=ae();ab(t),vp(),Rt()}),e.dataset.reservationsTechListener="true")}async function hq(){await pi();try{await Gl({force:!0})}catch(e){console.warn("⚠️ [reservations/events] Failed to pre-load projects for reservation form",e)}Ln(),Mp(),rv({onAfterSubmit:Do}),zu||Hp(),pq(),fq()}const yq=Object.freeze(Object.defineProperty({__proto__:null,confirmReservation:Fp,deleteReservation:Bp,getReservationsEditContext:so,handleReservationsMutation:Do,initCreateReservationForm:rv,initializeReservationUI:hq,loadReservationForm:sS,openReservationEditor:Rp,registerReservationGlobals:Mp,renderDraftReservationSummary:He,renderReservations:Ln,setFlatpickrValue:Wv,setupEditReservationModalEvents:Zv,setupEquipmentDescriptionInputs:Kv,setupReservationEvents:Hp,showReservationDetails:Bo,updateEditReservationSummary:Rt},Symbol.toStringTag,{value:"Module"})),gq={},Ou="__ART_RATIO_LAST_DASHBOARD_TAB__",ra="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",dl="create-tab",rS=/^[a-z0-9\-]+$/i,bq=typeof import.meta<"u"&&gq&&!1;function gt(...e){bq&&console.log(...e)}function Uu(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function gs(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!rS.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function Vu(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!rS.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function iS(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let ps=null,cn=null,bs=!1,Mt=null,zh=null,Is=null,Ku=null,pr=null,ac=null,_d=null,Td=null,Cd=null,Oh=!1;function vq(){return ac||(ac=Ll(()=>Promise.resolve().then(()=>MP),void 0,import.meta.url).then(e=>{try{typeof e.initReports=="function"&&e.initReports()}catch(t){console.error("❌ [tabs.js] Failed to initialise reports module",t)}return e}).catch(e=>{throw console.error("❌ [tabs.js] Failed to load reports module",e),ac=null,e})),ac}function oS(){return _d||(_d=Ll(()=>Promise.resolve().then(()=>yq),void 0,import.meta.url)),_d}function Sq(){return Td||(Td=Ll(()=>Promise.resolve().then(()=>ZP),void 0,import.meta.url)),Td}function Aq(){return Cd||(Cd=Ll(()=>Promise.resolve().then(()=>gL),void 0,import.meta.url)),Cd}function kL(){gt("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");gt("📌 tabButtons:",e),gt("📌 tabContents:",t);const n=(i,{skipStore:o=!1,skipRender:l=!1}={})=>{if(!i)return;const d=e.filter(m=>m?.getAttribute("data-tab")===i),u=document.getElementById(i);if(!(!d.length||!u)&&(e.forEach(m=>{const p=m?.getAttribute("data-tab")===i;m.classList.toggle("active",p),p?(m.setAttribute("aria-selected","true"),m.setAttribute("tabindex","0"),Uu(m)):(m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1"))}),t.forEach(m=>{const p=m.id===i;m.style.display=p?"block":"none",m.classList.toggle("active",p)}),ps=i,Vu(Ou,i),typeof document<"u"&&document.dispatchEvent(new CustomEvent("dashboard:tabChanged",{detail:{tabId:i}})),o||Ft({dashboardTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",m)}),i!=="reservations-tab"&&(cn=null,Mt=null,iS(ra),o||Ft({dashboardSubTab:null}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",m)})),!l&&i==="customers-tab"&&(gt("👤 Rendering customers"),wa()),!l&&i==="equipment-tab"&&(gt("📦 Rendering equipment"),jt()),!l&&i==="maintenance-tab"&&(gt("🛠️ Rendering maintenance"),Aq().then(m=>{try{m.renderMaintenance?.()}catch(p){console.error("❌ [tabs.js] Failed to render maintenance",p)}}).catch(m=>console.error("❌ [tabs.js] Unable to load maintenance module",m))),!l&&i==="technicians-tab"&&(gt("🛠️ Rendering technicians"),$0()),i==="reservations-tab")){if(gt("📅 Rendering reservations"),!l){try{Hp()}catch{}try{Ln()}catch{}oS().then(async m=>{try{!Oh&&typeof m.initializeReservationUI=="function"&&(await m.initializeReservationUI(),Oh=!0)}catch(p){console.error("❌ [tabs.js] Failed to initialise reservations UI",p)}}).catch(m=>console.error("❌ [tabs.js] Unable to load reservations UI module",m))}if(!Mt){const m=gs(ra);Mt=cn||m||dl}Eq(),Mt&&(sc(Mt),Mt=null)}};Ku=n;const a=i=>{if(!i||i.dataset.tabKeyboardBound==="true")return;const o=i.getAttribute("aria-orientation")==="vertical";i.addEventListener("keydown",l=>{const d=l.key,u=Array.from(i.querySelectorAll('[role="tab"], .tab-button, .sub-tab-button')).filter(x=>x.matches("[data-tab], [data-sub-tab]"));if(!u.length)return;const m=l.target,p=Math.max(0,u.indexOf(m));let f=p;const h=()=>{f=(p-1+u.length)%u.length},g=()=>{f=(p+1)%u.length},y=()=>{f=0},E=()=>{f=u.length-1};let S=!1;switch(d){case"ArrowLeft":o||(h(),S=!0);break;case"ArrowRight":o||(g(),S=!0);break;case"ArrowUp":o&&(h(),S=!0);break;case"ArrowDown":o&&(g(),S=!0);break;case"Home":y(),S=!0;break;case"End":E(),S=!0;break;case"Enter":case" ":S=!0,m?.click();break}if(S){l.preventDefault();const x=u[f];x&&x!==m&&(x.focus(),x.click())}}),i.dataset.tabKeyboardBound="true"};document.querySelectorAll('[role="tablist"]').forEach(a),e.forEach(i=>{i&&(i.getAttribute("type")||i.setAttribute("type","button"),i.setAttribute("role","tab"),i.hasAttribute("tabindex")||i.setAttribute("tabindex",i.classList.contains("active")?"0":"-1"),i.addEventListener("click",()=>{const o=i.getAttribute("data-tab");if(gt("🖱️ Tab clicked:",o),n(o),o==="reservations-tab"){const l=cn||gs(ra)||dl;typeof Is=="function"?Is(l):Mt=l}else Ft({dashboardSubTab:null}).catch(l=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",l)})}))});const s=i=>{const o=document.querySelector("[data-tab].active"),l=gs(Ou),d=e[0]?.getAttribute("data-tab")||null,m=[i?.dashboardTab,l,ps,o?.getAttribute("data-tab"),d].filter(Boolean).find(h=>document.getElementById(h))||d;m&&(!bs||m!==ps)&&(gt("⭐ Initial tab:",m),n(m,{skipStore:!0}));const f=[i?.dashboardSubTab,gs(ra)].filter(Boolean).find(h=>document.getElementById(h));f&&(ps==="reservations-tab"&&typeof Is=="function"?(!bs||f!==cn)&&Is(f,{skipStore:!0}):Mt=f),bs||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),bs=!0)},r=typeof lt=="function"?lt():null;s(r||null),wl().then(i=>s(i||null)).catch(i=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",i),s(null)}),zh||(zh=El(i=>{if(!(!bs||!i))if(i.dashboardTab&&i.dashboardTab!==ps&&n(i.dashboardTab,{skipStore:!0}),ps==="reservations-tab"){if(i.dashboardSubTab&&i.dashboardSubTab!==cn)sc(i.dashboardSubTab);else if(!i.dashboardSubTab&&cn){const o=gs(ra);o?o!==cn&&sc(o):sc(null)}}else i.dashboardSubTab&&(Mt=i.dashboardSubTab)}))}function Eq(){gt("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(gt("📌 subTabButtons:",e),gt("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(dl)?dl:n[0]:null,s=(r,{skipStore:i=!1}={})=>{if(!n.length)return;let o=r;(!o||!n.includes(o))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:o,available:n}),o=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${o}"]`),d=document.getElementById(o);if(!l||!d){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:o});return}if(cn===o&&l.classList.contains("active")&&d.classList.contains("active")&&d.getAttribute("aria-hidden")==="false"){d.removeAttribute("hidden"),d.style.display="block",d.setAttribute("aria-hidden","false"),cn=o,Uu(l),i||(Vu(ra,o),Ft({dashboardSubTab:o}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}));return}e.forEach(m=>{m.classList.remove("active"),m.classList.contains("tab")&&m.classList.remove("tab-active"),m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),Uu(l),t.forEach(m=>{const p=m.id===o;m.classList.toggle("active",p),m.setAttribute("aria-hidden",p?"false":"true"),p?(m.removeAttribute("hidden"),m.style.display="block"):(m.setAttribute("hidden",""),m.style.display="none")}),cn=o,Vu(ra,o),i||Ft({dashboardSubTab:o}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}),typeof document<"u"&&document.dispatchEvent(new CustomEvent("reservations:subTabChanged",{detail:{subTabId:o}})),o==="my-reservations-tab"?(gt("📋 Rendering reservations list"),setTimeout(()=>{oS().then(m=>{try{m.renderReservations?.()}catch(p){console.error("❌ [tabs.js] Failed to render reservations list",p)}}).catch(m=>console.error("❌ [tabs.js] Unable to load reservations UI module",m))},50)):o==="calendar-tab"?(gt("📅 Rendering calendar view"),setTimeout(()=>{Sq().then(m=>{try{m.renderCalendar?.()}catch(p){console.error("❌ [tabs.js] Failed to render calendar",p)}}).catch(m=>console.error("❌ [tabs.js] Unable to load calendar module",m))},100)):o==="reports-tab"&&(gt("📊 Rendering reports view"),vq().then(m=>{const{renderReports:p}=m;setTimeout(()=>{try{p?.()}catch(f){console.error("❌ [tabs.js] Failed to render reports tab",f)}},50)}).catch(m=>{console.error("❌ [tabs.js] Unable to load reports tab",m)}))};if(Is=(r,i={})=>{r?s(r,i):(e.forEach(o=>{o.classList.remove("active"),o.classList.contains("tab")&&o.classList.remove("tab-active"),o.setAttribute("aria-selected","false"),o.setAttribute("tabindex","-1")}),t.forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-hidden","true"),o.setAttribute("hidden",""),o.style.display="none"}),cn=null,iS(ra))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const i=r.getAttribute("data-sub-tab");gt("🖱️ Sub-tab clicked:",i),s(i)}),r.dataset.subTabListenerAttached="true")}),Mt)s(Mt,{skipStore:!0}),Mt=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),i=a(),o=r?.getAttribute("data-sub-tab")||i;o&&(gt("⭐ Initial sub-tab:",o),s(o,{skipStore:!0}))}}function sc(e){typeof Is=="function"?Is(e,{skipStore:!0}):e&&(Mt=e)}function wq(){try{if(typeof lt=="function")return lt()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function jq({attemptsLeft:e=0}={}){if(!bs||typeof Ku!="function")return!1;const t=wq(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[ps,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,gs(Ou),a].filter(Boolean).find(o=>document.getElementById(o));if(!r)return!1;const i=()=>{const o=document.querySelector(`[data-tab].active[data-tab="${r}"]`),l=document.getElementById(r);return!!(o&&l?.classList.contains("active")&&l?.style.display!=="none")};if(r==="reservations-tab"){const o=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!o.length)return!1;const l=o[0]?.getAttribute("data-sub-tab")||null,u=[cn,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,gs(ra),l].filter(Boolean).find(h=>document.getElementById(h)),m=document.querySelector("#reservations-tab .sub-tab-button.active"),p=document.querySelector("#reservations-tab .sub-tab.active"),f=p?.id||m?.getAttribute("data-sub-tab")||null;if(u&&f===u&&i())return p&&(p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false")),!0;if(u)Mt=u;else if(e>0)return!1}else if(i())return!0;return Ku(r,{skipStore:!0,skipRender:!0}),!0}function zp(){if(!bs)return;let e=0;const t=5;pr&&(clearTimeout(pr),pr=null);const n=()=>{if(jq({attemptsLeft:t-e})){pr=null;return}if(e>=t){pr=null;return}e+=1,pr=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",zp);document.addEventListener("language:changed",zp);document.addEventListener("theme:changed",zp);let $t=[],yn=[],ro=null,za=!1,Uh=!1;const Y={};function Iq(){Y.form=document.getElementById("equipment-package-form"),Y.hiddenId=document.getElementById("equipment-package-id"),Y.nameInput=document.getElementById("equipment-package-name"),Y.codeInput=document.getElementById("equipment-package-code"),Y.priceInput=document.getElementById("equipment-package-price"),Y.descriptionInput=document.getElementById("equipment-package-description"),Y.openSelector=document.getElementById("equipment-package-open-selector"),Y.selectionWrapper=document.getElementById("equipment-package-selection-active"),Y.selectionCounter=document.getElementById("equipment-package-selection-counter"),Y.applySelection=document.getElementById("equipment-package-apply-selection"),Y.cancelSelection=document.getElementById("equipment-package-cancel-selection"),Y.itemsTableBody=document.querySelector("#equipment-package-items-table tbody"),Y.itemsEmptyMessage=document.getElementById("equipment-package-items-empty"),Y.resetButton=document.getElementById("equipment-package-reset"),Y.submitButton=document.getElementById("equipment-package-submit"),Y.tableBody=document.getElementById("equipment-packages-table-body"),Y.emptyRow=document.getElementById("equipment-packages-empty-row"),Y.countBadge=document.getElementById("equipment-packages-count"),Y.applySelection&&(Y.applySelection.style.display="none")}function cS(){const{equipment:e=[]}=ae()||{};return Array.isArray(e)?e:[]}function Op(){const e=new Map;return cS().forEach(t=>{const n=t?.id??t?.equipment_id??t?.equipmentId??null;n!=null&&e.set(String(n),t)}),e}function xq(){const e=new Map;return cS().forEach(t=>{const n=ve(t?.barcode);n&&!e.has(n)&&e.set(n,t)}),e}function Qr(e,{persist:t=!1}={}){$t=Array.isArray(e)?e.map(lS):[],Lq(),t&&(an({packages:$t}),document.dispatchEvent(new CustomEvent("packages:changed",{detail:{packages:$t}})))}function lS(e={}){const t=qq(e.items??e.equipment_ids??e.equipmentIds??[]);return{id:e.id!=null?String(e.id):"",package_code:e.package_code??e.code??e.slug??"",slug:e.slug??null,name:e.name??e.title??e.label??"",description:e.description??"",price:kq(e.price??e.total_price??e.package_price??0),is_active:_q(e.is_active??e.active??!0),items:t,created_at:e.created_at??null,updated_at:e.updated_at??null}}function qq(e){return Array.isArray(e)||(e=[]),e.map(t=>{if(t==null)return null;if(typeof t=="number"||typeof t=="string"){const n=String(t).trim();return n?{equipment_id:n,quantity:1,unit_price:null}:null}if(typeof t=="object"){const n=t.equipment_id??t.equipmentId??t.id??t.item_id??t.itemId??null;if(n==null)return null;const a=Number.isFinite(Number(t.quantity??t.qty))?Number(t.quantity??t.qty):1,s=Number.isFinite(Number(t.unit_price??t.price))?Number(t.unit_price??t.price):null;return{equipment_id:String(n),quantity:a>0?a:1,unit_price:s}}return null}).filter(Boolean)}function kq(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function _q(e){if(e===!0||e===!1)return e;if(e==null)return!0;const t=String(e).trim().toLowerCase();return!(t==="0"||t==="false"||t==="no")}function Tq(e){const t=e?.quantity??e?.qty??1,n=Number.parseFloat(b(String(t)));return!Number.isFinite(n)||n<=0?1:n}function Cq(e,t){const n=[e?.unit_price,e?.price];for(const s of n){if(s==null)continue;const r=Number.parseFloat(b(String(s)));if(Number.isFinite(r))return r}const a=e?.equipment_id??e?.equipmentId??e?.id;if(a!=null&&t instanceof Map){const s=t.get(String(a));if(s&&typeof s=="object"){const r=[s.unit_price,s.unitPrice,s.price,s.daily_rate,s.dailyRate];for(const i of r){if(i==null)continue;const o=Number.parseFloat(b(String(i)));if(Number.isFinite(o))return o}}}return 0}function Pq(e=null){const t=e instanceof Map?e:Op();return yn.reduce((n,a)=>{const s=Tq(a),r=Cq(a,t),i=Number.isFinite(s)&&s>0?s:1,o=Number.isFinite(r)&&r>0?r:0;return n+i*o},0)}function Vh(e){const t=Y.priceInput;if(!t)return;const n=t.dataset.autoCalculated==="false",a=!!(t.value&&t.value.trim());if(n&&a)return;if(!Number.isFinite(e)||yn.length===0){t.value="",t.dataset.autoCalculated="true";return}const s=e<0?0:e,r=Math.round(s*100)/100,i=Number.isInteger(r)?String(r):r.toFixed(2);t.value=i,t.dataset.autoCalculated="true"}function Fo(){if(!Y.itemsTableBody||!Y.itemsEmptyMessage)return;if(yn.length===0){Y.itemsTableBody.innerHTML="",Y.itemsEmptyMessage.hidden=!1,Vh(0);return}const e=Op(),t=yn.map((a,s)=>{const r=e.get(String(a.equipment_id)),i=r?.desc||r?.name||c("equipment.packages.items.unknown","معدة بدون اسم"),o=r?.barcode?b(String(r.barcode)):"",l=b(String(a.quantity??1)),d=o?`${i} — ${o}`:i;return`
      <tr data-package-item-index="${s}">
        <td>${d}</td>
        <td>${l}</td>
        <td>
          <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-item" data-index="${s}">🗑️</button>
        </td>
      </tr>
    `});Y.itemsTableBody.innerHTML=t.join(""),Y.itemsEmptyMessage.hidden=!0;const n=Pq(e);Vh(n)}function Lq(){if(!Y.tableBody||!Y.emptyRow)return;if(!$t.length){Y.tableBody.innerHTML="",Y.tableBody.appendChild(Y.emptyRow),Y.emptyRow.hidden=!1,Y.countBadge&&(Y.countBadge.textContent="0");return}const e=Op(),t=$t.map(n=>{const a=qn({...n,items:n.items}),s=a.map(o=>{const l=e.get(String(o.equipmentId??o.equipment_id)),d=l?.desc||l?.name||o.desc||c("equipment.packages.items.unknown","معدة بدون اسم"),u=b(String(o.qty??o.quantity??1)),m=o.barcode||l?.barcode,p=m?` (${b(String(m))})`:"";return`<li>${d}${p} × ${u}</li>`}),r=a.reduce((o,l)=>o+(Number(l.qty??l.quantity??1)||0),0),i=`${b(n.price.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`;return`
      <tr data-package-id="${n.id}">
        <td>${n.name||"—"}</td>
        <td>${n.package_code||"—"}</td>
        <td>${i}</td>
        <td>
          <details>
            <summary>${b(String(r||0))}</summary>
            <ul class="equipment-package-items-summary">${s.join("")}</ul>
          </details>
        </td>
        <td>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-action="edit-package" data-id="${n.id}">✏️</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete-package" data-id="${n.id}">🗑️</button>
          </div>
        </td>
      </tr>
    `});Y.tableBody.innerHTML=t.join(""),Y.emptyRow.hidden=!0,Y.countBadge&&(Y.countBadge.textContent=b(String($t.length)))}function dS(){ro=null,yn=[],Y.hiddenId&&(Y.hiddenId.value=""),Y.nameInput&&(Y.nameInput.value=""),Y.codeInput&&(Y.codeInput.value=""),Y.priceInput&&(Y.priceInput.value="",Y.priceInput.dataset.autoCalculated="true"),Y.descriptionInput&&(Y.descriptionInput.value=""),Y.submitButton&&(Y.submitButton.textContent=c("equipment.packages.form.actions.save","💾 حفظ الحزمة")),Fo(),va(!1)}function Nq(e){ro=e.id||null,yn=e.items.map(t=>({...t})),Y.hiddenId&&(Y.hiddenId.value=ro||""),Y.nameInput&&(Y.nameInput.value=e.name||""),Y.codeInput&&(Y.codeInput.value=e.package_code||""),Y.priceInput&&(Y.priceInput.value=e.price!=null?String(e.price):"",Y.priceInput.dataset.autoCalculated=e.price!=null?"false":"true"),Y.descriptionInput&&(Y.descriptionInput.value=e.description||""),Y.submitButton&&(Y.submitButton.textContent=c("equipment.packages.form.actions.update","💾 تحديث الحزمة")),Fo(),va(!1)}function va(e=za){za=e,Y.selectionWrapper&&(za?Y.selectionWrapper.hidden=!1:Y.selectionWrapper.hidden=!0),Y.openSelector&&(Y.openSelector.disabled=za),Y.cancelSelection&&(Y.cancelSelection.disabled=!za),uS()}function uS(){if(Y.selectionCounter){if(!za){Y.selectionCounter.textContent=c("equipment.packages.selection.counter","لم يتم اختيار عناصر بعد.");return}Y.selectionCounter.textContent=c("equipment.packages.selection.autoMode","أي معدة تختارها ستُضاف مباشرة إلى الحزمة. استخدم زر إلغاء للخروج من وضع الاختيار.")}}function $q(e){const t=e?.detail||{},n=!!t.active,a=t.selection||t.previous||{},s=a?.mode||a?.source||"";if(s!=="package-manager"&&s!=="equipment-packages"){!n&&za&&(va(!1),Wu());return}if(n){va(!0);return}va(!1),Wu()}function Dq(e){const t=e?.detail;if(!t)return;const n=t.selection||{},a=n?.mode||n?.source||"";if(a!=="package-manager"&&a!=="equipment-packages")return;const s=Array.isArray(t.barcodes)?t.barcodes:[],r=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,i=s.length?s:t.barcode?[t.barcode]:[];if(!i.length)return;const o=xq(),l=[],d=new Set;i.forEach(f=>{const h=ve(f);h&&!d.has(h)&&(d.add(h),l.push(h))});const u=Math.min(l.length,r);let m=0;const p=[];for(let f=0;f<u;f+=1){const h=l[f],g=o.get(h);if(!g)continue;const y=g?.id??g?.equipment_id??g?.equipmentId??null;if(y==null)continue;const E=g?.desc||g?.name||h,S=yn.find(x=>x.equipment_id===String(y));S?S.quantity+=1:yn.push({equipment_id:String(y),quantity:1,unit_price:Number.isFinite(Number(g?.price))?Number(g.price):null}),m+=1,p.push(E)}if(m>0){Fo(),uS();const f=m===1?c("equipment.packages.selection.itemAddedSingle","✅ تمت إضافة {name} إلى الحزمة"):c("equipment.packages.selection.itemAddedMulti","✅ تمت إضافة {count} معدات إلى الحزمة"),h=m===1?f.replace("{name}",p[0]||""):f.replace("{count}",b(String(m)));I(h)}else I(c("equipment.packages.selection.noMatch","⚠️ تعذر ربط المعدات المختارة بالحزم، تحقق من بيانات المعدات"),4e3)}function Bq(){va(!1),eo("package-cancel"),Wu()}function Wu(){Y.form&&(Y.form.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{Y.nameInput?.focus()},200))}function Pd(e){const t=Y.priceInput;if(!t)return;const n=t.value;if(n==null)return;const a=n.replace(/[\u066B\u066C\u060C،,]/gu,".");let r=b(a).replace(/[^0-9.]/gu,"");const i=r.indexOf(".");if(i!==-1){const o=r.slice(0,i+1),l=r.slice(i+1).replace(/\./g,"");r=`${o}${l}`}if(r!==n&&(t.value=r,typeof t.setSelectionRange=="function")){const o=r.length;try{t.setSelectionRange(o,o)}catch{}}e?.type==="input"&&(t.dataset.autoCalculated=r.trim()?"false":"true")}function Fq(){const e=Y.nameInput?.value.trim(),t=Y.codeInput?.value.trim(),n=Y.descriptionInput?.value.trim()??"",a=Y.priceInput?.value??"",s=Number.parseFloat(b(a));if(!e)return I(c("equipment.packages.validation.nameRequired","⚠️ يرجى إدخال اسم الحزمة")),null;if(!t)return I(c("equipment.packages.validation.codeRequired","⚠️ يرجى إدخال كود الحزمة")),null;if(!yn.length)return I(c("equipment.packages.validation.itemsRequired","⚠️ أضف عنصرًا واحدًا على الأقل للحزمة")),null;const r=yn.map(i=>({equipment_id:i.equipment_id,quantity:Number.isFinite(Number(i.quantity))?Number(i.quantity):1,unit_price:i.unit_price!=null&&Number.isFinite(Number(i.unit_price))?Number(i.unit_price):null}));return{package_code:t,name:e,description:n,price:Number.isFinite(s)?s:0,is_active:!0,items:r}}async function Rq(e){if(e.preventDefault(),!Y.form)return;const t=Fq();if(t)try{let n;ro?(n=await pe(`/packages/?id=${encodeURIComponent(ro)}`,{method:"PATCH",body:t}),I(c("equipment.packages.toast.updated","✅ تم تحديث الحزمة بنجاح"))):(n=await pe("/packages/",{method:"POST",body:t}),I(c("equipment.packages.toast.created","✅ تم إنشاء الحزمة بنجاح")));const a=lS(n?.data??n),s=$t.findIndex(r=>r.id===a.id);s>=0?$t.splice(s,1,a):$t=[a,...$t],Qr($t,{persist:!0}),dS()}catch(n){console.error("[equipmentPackagesManager] handlePackageSubmit error",n);const a=n?.message||c("equipment.packages.toast.saveFailed","❌ تعذر حفظ الحزمة");I(a,4e3)}}function Mq(e){const t=e.target.closest('[data-action="remove-item"]');if(!t)return;const n=Number(t.dataset.index);Number.isNaN(n)||(yn=yn.filter((a,s)=>s!==n),Fo())}async function Hq(e){const t=e.target.closest('[data-action="edit-package"]');if(t){const a=t.dataset.id;if(!a)return;const s=$t.find(r=>r.id===a);if(!s)return;Nq(s);return}const n=e.target.closest('[data-action="delete-package"]');if(n){const a=n.dataset.id;if(!a||!window.confirm(c("equipment.packages.confirm.delete","هل أنت متأكد من حذف الحزمة؟")))return;try{await pe(`/packages/?id=${encodeURIComponent(a)}`,{method:"DELETE"}),$t=$t.filter(r=>r.id!==a),Qr($t,{persist:!0}),I(c("equipment.packages.toast.deleted","🗑️ تم حذف الحزمة بنجاح"))}catch(r){console.error("[equipmentPackagesManager] delete package error",r),I(c("equipment.packages.toast.deleteFailed","❌ تعذر حذف الحزمة"),4e3)}}}async function zq(){try{const e=await pe("/packages/?all=1"),t=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];Qr(t,{persist:!0})}catch(e){console.warn("[equipmentPackagesManager] Failed to fetch packages from API, falling back to cache",e);const{packages:t=[]}=ae()||{};Qr(t,{persist:!1})}}function Oq(){const{packages:e=[]}=ae()||{};Array.isArray(e)&&e.length?Qr(e,{persist:!1}):Qr([],{persist:!1}),Fo(),va(!1)}function Uq(){if(za){va(!0);return}va(!0),Cb({mode:"package-manager",source:"equipment-packages",activatedAt:Date.now()});const e=document.querySelector('[data-tab="equipment-tab"]');e&&e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus();const t=document.getElementById("equipment-list");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},200)})}function Vq(){Y.form&&(Y.form.addEventListener("submit",Rq),Y.itemsTableBody?.addEventListener("click",Mq),Y.resetButton?.addEventListener("click",()=>{dS()}),Y.tableBody?.addEventListener("click",Hq),Y.openSelector?.addEventListener("click",e=>{e.preventDefault(),Uq()}),Y.cancelSelection?.addEventListener("click",e=>{e.preventDefault(),Bq()}),Y.priceInput&&!Y.priceInput.dataset.normalizedAttached&&(Y.priceInput.addEventListener("input",Pd),Y.priceInput.addEventListener("blur",Pd),Y.priceInput.dataset.normalizedAttached="true",Pd()),Uh||(document.addEventListener(Ga.change,$q),document.addEventListener(Ga.requestAdd,Dq),Uh=!0))}function _L(){typeof document>"u"||(Iq(),Y.form&&(Oq(),Vq(),zq()))}function Kh(){const e=document.getElementById("login-form");if(!e)return;window.__ART_RATIO_SKIP_PREF_FETCH__=!0,Gs({skipRemote:!0}),Ia(),DE();const t=document.getElementById("username"),n=document.getElementById("password"),a=document.querySelector('[data-action="toggle-password"]'),s=a?.querySelector('[data-role="password-toggle-label"]')||null,r=a?.querySelector('[data-icon="show"]')||null,i=a?.querySelector('[data-icon="hide"]')||null;async function o(){if(!(!t||!n))try{if(typeof navigator>"u"||typeof window>"u"||!("credentials"in navigator)||typeof navigator.credentials.get!="function"||!window.isSecureContext)return;const d=await navigator.credentials.get({password:!0,mediation:"optional"});d&&d.type==="password"&&(!t.value&&d.id&&(t.value=d.id),!n.value&&d.password&&(n.value=d.password))}catch(d){console.warn("⚠️ [login-page] Failed to retrieve stored credentials",d)}}function l(d){if(!a||!n)return;r&&r.classList.toggle("hidden",d),i&&i.classList.toggle("hidden",!d),a.setAttribute("aria-pressed",String(d));const p=c(d?"login.form.password.toggleHide":"login.form.password.toggleShow",d?"إخفاء كلمة المرور":"إظهار كلمة المرور");a.setAttribute("aria-label",p),s&&(s.textContent=p)}a&&n&&(l(n.type==="text"),a.addEventListener("click",()=>{const d=n.type==="password";n.type=d?"text":"password",l(d),n.focus({preventScroll:!0});try{const{length:u}=n.value;n.setSelectionRange(u,u)}catch{}}),document.addEventListener("language:changed",()=>{l(n.type==="text")})),e&&e.addEventListener("submit",async d=>{d.preventDefault();const u=t?t.value.trim():"",m=n?n.value.trim():"";await a0(u,m,{form:e})}),o()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Kh,{once:!0}):Kh();Zr({ar:{"projects.nav.brand":"نظام التأجير","projects.nav.projects":"المشاريع","projects.nav.customers":"العملاء","projects.nav.technicians":"طاقم العمل","projects.hero.title":"إدارة المشاريع","projects.hero.subtitle":"أنشئ ونسّق المشاريع، ووزّع المهام على الطاقم والمعدات، وتتبع المصاريف.","projects.form.title":"إنشاء مشروع جديد","projects.form.labels.type":"نوع المشروع","projects.form.labels.title":"اسم المشروع","projects.form.labels.client":"العميل","projects.form.labels.clientCompany":"شركة العميل","projects.form.labels.paymentStatus":"حالة الدفع","projects.form.labels.startDate":"📅 تاريخ البداية","projects.form.labels.startTime":"⏰ وقت البداية","projects.form.labels.endDate":"📅 تاريخ النهاية","projects.form.labels.endTime":"⏰ وقت النهاية","projects.form.labels.description":"تفاصيل المشروع","projects.form.labels.technician":"إضافة عضو طاقم","projects.form.labels.equipment":"إضافة معدة","projects.form.labels.quantity":"الكمية","projects.form.labels.expenses":"متطلبات المشروع","projects.form.labels.expenseLabel":"اسم المصروف","projects.form.labels.expenseAmount":"المبلغ (SR)","projects.form.placeholders.title":"مثال: تصوير منتج جديد","projects.form.placeholders.description":"ملخص عن المشروع والمتطلبات","projects.form.placeholders.type":"اختر نوع المشروع","projects.form.placeholders.clientCompany":"تعبأ تلقائيًا","projects.form.placeholders.startDate":"اختر تاريخ البداية","projects.form.placeholders.startTime":"اختر وقت البداية","projects.form.placeholders.endDate":"اختر تاريخ النهاية","projects.form.placeholders.endTime":"اختر وقت النهاية","projects.form.placeholders.client":"اكتب اسم العميل...","projects.form.placeholders.expenseLabel":"مثال: متطلب إضافي (رسوم موقع، معدات إضافية...)","projects.form.linkedReservation.title":"إنشاء حجز مرتبط","projects.form.linkedReservation.description":"أنشئ حجزًا مرتبطًا بالمشروع الحالي وسيتم تعبئة تفاصيله تلقائيًا.","projects.form.linkedReservation.button":"➕ إنشاء حجز مرتبط","projects.form.linkedReservation.missingClient":"⚠️ يرجى اختيار العميل قبل إنشاء الحجز المرتبط","projects.form.linkedReservation.missingSchedule":"⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إنشاء الحجز المرتبط","projects.form.linkedReservation.empty":"لم يتم إنشاء حجوزات مرتبطة بعد.","projects.form.linkedReservation.pendingItem":"سيتم ربط هذا الحجز تلقائيًا بعد حفظ المشروع.","projects.form.linkedReservation.buttonDisabled":"تم إنشاء حجز مرتبط لهذا المشروع. يمكنك متابعة التعديلات من شاشة الحجز.","projects.form.linkedReservation.meta.equipment":"عدد المعدات: {count}","projects.form.linkedReservation.meta.crew":"عدد الفريق: {count}","projects.form.linkedReservation.meta.crewNames":"أسماء الفريق: {names}","projects.form.linkedReservation.meta.total":"إجمالي الحجز: {amount}","projects.form.labels.discount":"الخصم","projects.form.labels.companyShare":"نسبة الشركة والضريبة","projects.form.labels.applyTax":"تطبيق الضريبة 15٪","projects.form.discount.percent":"٪ نسبة","projects.form.discount.amount":"💵 مبلغ","projects.form.companyShareToggle":"إضافة نسبة الشركة (10٪)","projects.form.selectClient":"اختر العميل","projects.form.selectTechnician":"اختر عضو الطاقم","projects.form.selectEquipment":"اختر المعدة","projects.form.types.commercial":"تصوير إعلان","projects.form.types.coverage":"تصوير تغطية","projects.form.types.photography":"تصوير فوتوغرافي","projects.form.types.social":"تصوير للتواصل الاجتماعي","projects.form.types.unknown":"نوع غير محدد","projects.form.buttons.addTechnician":"➕ إضافة للطاقم","projects.form.buttons.addEquipment":"➕ إضافة للمشروع","projects.form.buttons.addExpense":"➕ إضافة مصروف","projects.form.buttons.save":"🆕 إنشاء المشروع","projects.form.buttons.update":"🔁 تحديث المشروع","projects.form.taxLabel":"شامل الضريبة (15٪)","projects.form.paymentStatus.paid":"مدفوع","projects.form.paymentStatus.unpaid":"غير مدفوع","projects.form.paymentStatus.partial":"مدفوع جزئياً","projects.form.paymentProgress.label":"💰 الدفعة المستلمة","projects.form.paymentProgress.amount":"💵 مبلغ","projects.form.paymentProgress.percent":"٪ نسبة","projects.form.paymentProgress.placeholder":"0","projects.form.paymentProgress.hint":"أدخل المبلغ أو النسبة التي تم استلامها من قيمة المشروع","projects.paymentStatus.paid":"مدفوع","projects.paymentStatus.unpaid":"غير مدفوع","projects.paymentStatus.partial":"مدفوع جزئياً","projects.selected.emptyTechnicians":"لم يتم اختيار أي عضو بعد","projects.selected.emptyEquipment":"لم يتم اختيار أي معدات","projects.selected.emptyExpenses":"لم يتم تسجيل أي مصروف","projects.summary.title":"ملخص سريع","projects.summary.totalProjects":"إجمالي المشاريع","projects.summary.upcoming":"مشاريع قادمة","projects.summary.expenses":"إجمالي المصروفات","projects.summary.budget":"القيمة التقديرية (مع الضريبة)","projects.focus.title":"📌 نظرة سريعة على المشاريع","projects.focus.legend":"اختر بطاقة للاطلاع على التفاصيل أو التعديل السريع.","projects.focus.today":"مشاريع اليوم","projects.focus.thisWeek":"مشاريع هذا الأسبوع","projects.focus.upcoming":"مشاريع قادمة","projects.focus.recent":"أحدث المشاريع","projects.focus.empty":"لا توجد مشاريع لليوم أو هذا الأسبوع.","projects.focus.view":"عرض التفاصيل","projects.focus.edit":"تعديل","projects.focus.actions.confirm":"✔️ تأكيد المشروع","projects.focus.confirmed":"✅ مشروع مؤكد","projects.focus.toastNotFound":"⚠️ تعذّر العثور على المشروع في القائمة","projects.toast.linkReservationFailed":"⚠️ تعذّر ربط بعض الحجوزات بالمشروع، يرجى التحقق يدويًا","projects.toast.companyShareRequiresTax":"⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة","projects.timeline.title":"الجدول الزمني للمشاريع","projects.timeline.legend":"يُظهر الشريط مواعيد البداية والنهاية، والألوان تُمثّل حالة المشروع.","projects.timeline.legend.upcoming":"قادم","projects.timeline.legend.ongoing":"قيد التنفيذ","projects.timeline.legend.completed":"مكتمل","projects.timeline.legend.conflict":"تعارض","projects.timeline.empty":"لا توجد مشاريع ببيانات زمنية صالحة.","projects.timeline.conflict":"تعارض في التوقيت","projects.timeline.range":"{start} → {end}","projects.search.title":"بحث سريع","projects.search.placeholder":"ابحث عن مشروع بالاسم أو العميل","projects.subtabs.create":"إنشاء مشروع","projects.subtabs.list":"مشاريعي","projects.subtabs.reports":"تقارير المشاريع","projects.subtabs.expenses":"مصاريف المشاريع","projects.table.title":"قائمة المشاريع","projects.table.count":"{count} مشروع","projects.table.reservationsCount":"{count} حجوزات","projects.table.headers.project":"المشروع","projects.table.headers.client":"العميل","projects.table.headers.period":"الفترة","projects.table.headers.crew":"الطاقم","projects.table.headers.equipment":"المعدات","projects.table.headers.total":"الإجمالي (مع الضريبة)","projects.table.headers.expenses":"مصروفات (SR)","projects.table.emptyInitial":"لم يتم إنشاء مشاريع بعد.","projects.table.emptyFiltered":"لا توجد مشاريع مطابقة.","projects.modal.title":"تفاصيل المشروع","projects.details.overview.heading":"معلومات المشروع","projects.reports.pageTitle":"تقارير المشاريع - نظام التأجير","projects.reports.title":"لوحة تقارير المشاريع","projects.reports.subtitle":"تحليلات تفصيلية لأداء المشاريع، المواعيد النهائية، ونسب التنفيذ.","projects.reports.filters.search":"بحث","projects.reports.filters.searchPlaceholder":"بحث باسم المشروع أو العميل","projects.reports.filters.status":"حالة المشروع","projects.reports.filters.payment":"حالة الدفع","projects.reports.filters.paymentAll":"كل الحالات","projects.reports.filters.dateRange":"نطاق التاريخ","projects.reports.filters.range.all":"كل الوقت","projects.reports.filters.range.30":"آخر 30 يوم","projects.reports.filters.range.90":"آخر 90 يوم","projects.reports.filters.range.365":"آخر سنة","projects.reports.filters.range.custom":"تاريخ مخصص","projects.reports.filters.start":"من","projects.reports.filters.end":"إلى","projects.reports.filters.refresh":"تحديث","projects.reports.charts.status":"توزيع الحالات","projects.reports.charts.statusHint":"نسبة المشاريع حسب حالة التنفيذ","projects.reports.charts.timeline":"الإيرادات عبر الزمن","projects.reports.charts.timelineHint":"إجمالي قيمة المشاريع شهريًا","projects.reports.charts.expenses":"المصاريف مقابل القيمة","projects.reports.charts.expensesHint":"مقارنة المصاريف مع إجمالي قيمة المشروع","projects.reports.charts.clients":"أفضل العملاء","projects.reports.charts.clientsHint":"أعلى العملاء حسب قيمة المشاريع","projects.reports.loading.chart":"جارٍ تحديث الرسم...","projects.reports.table.title":"قائمة المشاريع","projects.reports.table.columns.project":"المشروع","projects.reports.table.columns.client":"العميل","projects.reports.table.columns.status":"الحالة","projects.reports.table.columns.period":"الفترة","projects.reports.table.columns.value":"القيمة","projects.reports.table.columns.payment":"الدفع","projects.reports.table.empty":"لا توجد مشاريع مطابقة للبحث الحالي.","projects.reports.table.meta":"عرض {count} من أصل {total} مشروع","projects.reports.kpi.totalProjects":"إجمالي المشاريع","projects.reports.kpi.totalProjectsMeta":"بعد تطبيق الفلاتر الحالية","projects.reports.kpi.totalValue":"القيمة الإجمالية","projects.reports.kpi.totalValueMeta":"يشمل المشاريع والحجوزات المرتبطة","projects.reports.kpi.unpaidValue":"قيمة غير مدفوعة","projects.reports.kpi.unpaidValueMeta":"مشاريع لم تُسدَّد بالكامل بعد","projects.reports.kpi.expenses":"إجمالي المصاريف","projects.reports.kpi.expensesMeta":"مصروفات المشاريع المشمولة","projects.reports.datasets.value":"القيمة الإجمالية","projects.reports.datasets.expenses":"المصاريف","projects.expenses.pageTitle":"مصاريف المشاريع - نظام التأجير","projects.expenses.title":"إدارة مصاريف المشاريع","projects.expenses.subtitle":"تابع المصاريف المرتبطة بالحجوزات والمشاريع مع إمكانية الربط مع فواتير العملاء.","projects.expenses.placeholder":"ستتم إضافة لوحة مخصصة لربط مصاريف المشاريع بالحجوزات قريباً.","projects.expenses.placeholderHint":"جهز الفواتير والفئات الآن لتسريع الإطلاق القادم.","projects.expenses.actions.addExpense":"➕ إضافة مصروف","projects.expenses.actions.importInvoice":"🧾 رفع فاتورة","projects.expenses.actions.export":"⬇️ تصدير","projects.expenses.kpi.total":"إجمالي المصاريف","projects.expenses.kpi.total.meta":"المصاريف المسجلة خلال الفترة الحالية","projects.expenses.kpi.pending":"بانتظار الموافقة","projects.expenses.kpi.pending.meta":"مصاريف تحتاج اعتماد المدير المالي","projects.expenses.kpi.approved":"تمت الموافقة","projects.expenses.kpi.approved.meta":"آخر المصروفات التي تم اعتمادها","projects.expenses.kpi.average":"متوسط المصروف لكل مشروع","projects.expenses.kpi.average.meta":"قيمة تقريبية استناداً للمشاريع النشطة","projects.expenses.breakdown.title":"توزيع المصاريف حسب التصنيف","projects.expenses.breakdown.hint":"راقب الصرف على المعدات، الطاقم، والتنقلات.","projects.expenses.breakdown.empty":"لم يتم تسجيل مصاريف مصنفة حتى الآن.","projects.expenses.timeline.title":"المصاريف عبر الجدول الزمني","projects.expenses.timeline.hint":"سجل المصاريف خلال الأشهر الماضية لمراقبة الاتجاهات.","projects.expenses.timeline.empty":"أضف مصروفات لعرض الرسم البياني التفاعلي.","projects.expenses.table.title":"سجل المصاريف التفصيلي","projects.expenses.table.hint":"استعرض المصاريف المرتبطة بكل مشروع مع حالة الموافقات.","projects.expenses.table.columns.project":"المشروع","projects.expenses.table.columns.category":"التصنيف","projects.expenses.table.columns.description":"الوصف","projects.expenses.table.columns.amount":"المبلغ","projects.expenses.table.columns.status":"الحالة","projects.expenses.table.columns.date":"تاريخ التسجيل","projects.expenses.table.empty":"ستظهر المصاريف المسجلة هنا فور إضافتها.","projects.toast.selectTechnician":"⚠️ يرجى اختيار عضو الطاقم","projects.toast.technicianAlreadyAdded":"⚠️ العضو مضاف بالفعل","projects.toast.technicianAdded":"✅ تمت إضافة عضو الطاقم","projects.toast.selectEquipment":"⚠️ يرجى اختيار المعدة","projects.toast.equipmentAdded":"✅ تمت إضافة المعدة للمشروع","projects.toast.missingExpenseLabel":"⚠️ يرجى إدخال وصف المصروف","projects.toast.invalidExpenseAmount":"⚠️ يرجى إدخال مبلغ صحيح","projects.toast.customerNotFound":"⚠️ لم يتم العثور على العميل بالاسم المدخل","projects.toast.missingRequiredFields":"⚠️ يرجى تعبئة البيانات المطلوبة","projects.toast.invalidDateRange":"⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية","projects.toast.saved":"✅ تم حفظ المشروع بنجاح","projects.toast.editReady":"✏️ تم تجهيز المشروع للتعديل. عدّل الحقول ثم احفظ التغييرات.","projects.toast.updated":"✅ تم تحديث المشروع بنجاح","projects.toast.editMissing":"⚠️ تعذّر العثور على المشروع المطلوب تعديله","projects.toast.confirmed":"✅ تم تأكيد المشروع","projects.toast.alreadyConfirmed":"ℹ️ المشروع مؤكّد مسبقًا","projects.toast.deleted":"🗑️ تم حذف المشروع","projects.confirm.delete":"هل أنت متأكد من حذف هذا المشروع؟","projects.fallback.unknownClient":"عميل غير معروف","projects.fallback.unknownEquipment":"معدة","projects.fallback.noDescription":"لا يوجد وصف","projects.fallback.untitled":"مشروع بدون اسم","projects.fallback.emptyList":"لا يوجد","projects.fallback.technicianName":"عضو {id}","projects.status.upcoming":"قادم","projects.status.ongoing":"قيد التنفيذ","projects.status.completed":"منتهٍ","projectCards.filters.search":"🔍 ابحث باسم المشروع أو الوصف...","projectCards.filters.status.all":"⚙️ كل الحالات","projectCards.filters.status.upcoming":"📅 مشاريع قادمة","projectCards.filters.status.ongoing":"⚙️ مشاريع قيد التنفيذ","projectCards.filters.status.completed":"✅ مشاريع منتهية","projectCards.stats.crew":"👥 عدد الطاقم: {count}","projectCards.stats.reservations":"🔗 الحجوزات: {count}","projectCards.stats.client":"👤 العميل: {name}","projectCards.stats.type":"🏷️ النوع: {label}","projectCards.stats.budget":"💰 التكلفة التقديرية (مع الضريبة): {amount}","projectCards.stats.expenses":"💸 المصروفات: {amount}","projectCards.stats.crewShort":"طاقم العمل","projectCards.stats.reservationsShort":"الحجوزات","projectCards.stats.budgetShort":"ميزانية المشروع","projectCards.stats.expensesShort":"إجمالي المصروفات","projectCards.stats.paymentStatus":"حالة الدفع","projectCards.stats.equipmentCount":"عدد المعدات","projectCards.stats.crewCount":"عدد الطاقم","projectCards.stats.reservationValue":"إجمالي الحجوزات","projectCards.stats.expensesTotal":"إجمالي المصاريف","projectCards.stats.reservationTotal":"إجمالي الحجز","projectCards.stats.taxTotal":"الضريبة","projectCards.stats.overallTotal":"المجموع الكلي","projectCards.groups.meta":"بيانات المشروع","projectCards.groups.reservations":"موجز الحجز","projectCards.groups.payment":"ملخص الدفع","projectCards.meta.code":"رقم المشروع","projectCards.meta.client":"العميل","projectCards.meta.company":"شركة العميل","projectCards.meta.type":"نوع المشروع","projectCards.meta.startDate":"تاريخ البداية","projectCards.meta.endDate":"تاريخ النهاية","projects.details.type":"نوع المشروع","projects.details.company":"شركة العميل","projects.details.client":"العميل","projects.details.crew":"الطاقم الفني ({count})","projects.details.equipment":"المعدات ({count})","projects.details.expenses":"المصروفات ({amount})","projects.details.subtotal":"الإجمالي قبل الضريبة:","projects.details.tax":"ضريبة القيمة المضافة (15٪):","projects.details.total":"الإجمالي بعد الضريبة:","projects.details.labels.projectTitle":"اسم المشروع","projects.details.labels.code":"رقم المشروع","projects.details.summary.projectSubtotal":"إجمالي المشروع","projects.details.summary.paymentStatus":"حالة الدفع","projects.details.summary.projectTax":"ضريبة المشروع (15٪)","projects.details.summary.projectTotal":"إجمالي المشروع بعد الضريبة","projects.details.summary.reservationsTotal":"إجمالي المعدات / طاقم العمل","projects.details.summary.combinedTax":"إجمالي الضريبة الكلية (15٪)","projects.details.summary.reservationsCount":"{count} حجوزات مرتبطة","projects.details.summary.overallTotal":"الإجمالي الكلي","projects.details.labels.start":"تاريخ البداية","projects.details.labels.end":"تاريخ النهاية","projects.details.labels.crewCount":"عدد الطاقم","projects.details.labels.equipmentCount":"عدد المعدات","projects.details.labels.reservationsCount":"عدد الحجوزات","projects.details.labels.notes":"ملاحظات المشروع","projects.details.chips.vatOn":"شامل الضريبة 15٪","projects.details.chips.vatOff":"غير شامل الضريبة","projects.details.chips.reservations":"{count} حجوزات","projects.details.noItems":"لا يوجد","projects.details.quantity":"{qty} قطعة","projects.details.reservations.title":"الحجوزات المرتبطة","projects.details.reservations.empty":"لا توجد حجوزات مرتبطة بهذا المشروع بعد.","projects.details.reservations.create":"➕ إنشاء حجز مرتبط","projects.details.actions.edit":"✏️ تعديل المشروع","projects.details.actions.delete":"🗑️ حذف المشروع","projects.details.reservations.view":"عرض الحجز","projects.details.reservations.count":"{count} حجوزات","projects.details.reservations.itemsCount":"{count} معدة","projects.details.reservations.crewCount":"{count} من الطاقم","projects.details.edit.heading":"تعديل المشروع","projects.details.edit.subheading":"قم بتحديث بيانات المشروع ثم احفظ التغييرات.","projects.details.edit.save":"💾 حفظ التعديلات","projects.details.edit.cancel":"إلغاء"},en:{"projects.nav.brand":"Rental System","projects.nav.projects":"Projects","projects.nav.customers":"Clients","projects.nav.technicians":"Crew","projects.hero.title":"Projects Management","projects.hero.subtitle":"Create and coordinate projects, assign crew and equipment, and track expenses.","projects.form.title":"Create New Project","projects.form.labels.type":"Project Type","projects.form.labels.title":"Project Name","projects.form.labels.client":"Client","projects.form.labels.clientCompany":"Client Company","projects.form.labels.paymentStatus":"Payment Status","projects.form.labels.startDate":"📅 Start Date","projects.form.labels.startTime":"⏰ Start Time","projects.form.labels.endDate":"📅 End Date","projects.form.labels.endTime":"⏰ End Time","projects.form.labels.description":"Project Details","projects.form.labels.technician":"Add Crew Member","projects.form.labels.equipment":"Add Equipment","projects.form.labels.quantity":"Quantity","projects.form.labels.expenses":"Project requirements","projects.form.labels.expenseLabel":"Expense Name","projects.form.labels.expenseAmount":"Amount (SR)","projects.form.placeholders.title":"Example: New product shoot","projects.form.placeholders.description":"Project brief and requirements","projects.form.placeholders.type":"Choose a project type","projects.form.placeholders.clientCompany":"Auto-filled from client record","projects.form.placeholders.startDate":"Select the start date","projects.form.placeholders.startTime":"Select the start time","projects.form.placeholders.endDate":"Select the end date (optional)","projects.form.placeholders.endTime":"Select the end time (optional)","projects.form.placeholders.client":"Type the client name...","projects.form.placeholders.expenseLabel":"Example: Location permit or extra gear","projects.form.linkedReservation.title":"Create Linked Reservation","projects.form.linkedReservation.description":"Create a reservation for this project and we'll pre-fill the matching details.","projects.form.linkedReservation.button":"➕ Create Linked Reservation","projects.form.linkedReservation.missingClient":"⚠️ Please select the client before creating the linked reservation.","projects.form.linkedReservation.missingSchedule":"⚠️ Please provide both start and end date/time before creating the linked reservation.","projects.form.linkedReservation.empty":"No linked reservations yet.","projects.form.linkedReservation.pendingItem":"This reservation will be linked automatically once the project is saved.","projects.form.linkedReservation.buttonDisabled":"A linked reservation was created. Manage further changes from the reservation itself.","projects.form.linkedReservation.meta.equipment":"Equipment count: {count}","projects.form.linkedReservation.meta.crew":"Crew count: {count}","projects.form.linkedReservation.meta.crewNames":"Crew names: {names}","projects.form.linkedReservation.meta.total":"Reservation total: {amount}","projects.form.labels.discount":"Discount","projects.form.labels.companyShare":"Company share & VAT","projects.form.labels.applyTax":"Apply VAT 15%","projects.form.discount.percent":"% Percent","projects.form.discount.amount":"💵 Amount","projects.form.companyShareToggle":"Include company share (10%)","projects.form.selectClient":"Select client","projects.form.selectTechnician":"Select crew member","projects.form.selectEquipment":"Select equipment","projects.form.types.commercial":"Commercial shoot","projects.form.types.coverage":"Event coverage","projects.form.types.photography":"Photography","projects.form.types.social":"Social media content","projects.form.types.unknown":"Unspecified type","projects.form.buttons.addTechnician":"➕ Add to Crew","projects.form.buttons.addEquipment":"➕ Add to Project","projects.form.buttons.addExpense":"➕ Add Expense","projects.form.buttons.save":"🆕 Create Project","projects.form.buttons.update":"🔁 Update Project","projects.form.taxLabel":"Include VAT (15%)","projects.form.paymentStatus.paid":"Paid","projects.form.paymentStatus.unpaid":"Unpaid","projects.form.paymentStatus.partial":"Partially Paid","projects.form.paymentProgress.label":"💰 Received Payment","projects.form.paymentProgress.amount":"💵 Amount","projects.form.paymentProgress.percent":"% Percent","projects.form.paymentProgress.placeholder":"0","projects.form.paymentProgress.hint":"Enter the amount or percentage received from the project total","projects.paymentStatus.paid":"Paid","projects.paymentStatus.unpaid":"Unpaid","projects.paymentStatus.partial":"Partially Paid","projects.selected.emptyTechnicians":"No crew members selected yet","projects.selected.emptyEquipment":"No equipment selected","projects.selected.emptyExpenses":"No expenses recorded","projects.summary.title":"Quick Overview","projects.summary.totalProjects":"Total Projects","projects.summary.upcoming":"Upcoming Projects","projects.summary.expenses":"Total Expenses","projects.summary.budget":"Estimated Value (with VAT)","projects.focus.title":"📌 Focus Projects","projects.focus.legend":"Tap a card to review details or jump to editing.","projects.focus.today":"Today's Projects","projects.focus.thisWeek":"This Week","projects.focus.upcoming":"Upcoming Projects","projects.focus.recent":"Latest Projects","projects.focus.empty":"No projects scheduled for today or this week.","projects.focus.view":"View details","projects.focus.edit":"Edit","projects.focus.actions.confirm":"✔️ Confirm project","projects.focus.confirmed":"✅ Project confirmed","projects.focus.toastNotFound":"⚠️ Could not find this project in the list","projects.toast.linkReservationFailed":"⚠️ Unable to link some reservations to the project. Please review them manually.","projects.toast.companyShareRequiresTax":"⚠️ Company share requires VAT to be enabled first.","projects.timeline.title":"Projects Timeline","projects.timeline.legend":"The bar shows project start and end, with colors reflecting status.","projects.timeline.legend.upcoming":"Upcoming","projects.timeline.legend.ongoing":"In Progress","projects.timeline.legend.completed":"Completed","projects.timeline.legend.conflict":"Conflict","projects.timeline.empty":"No projects with valid schedule to display.","projects.timeline.conflict":"Scheduling conflict","projects.timeline.range":"{start} → {end}","projects.search.title":"Quick Search","projects.search.placeholder":"Search by project name or client","projects.subtabs.create":"Create Project","projects.subtabs.list":"My Projects","projects.subtabs.reports":"Project Reports","projects.subtabs.expenses":"Project Expenses","projects.table.title":"Projects List","projects.table.count":"{count} project","projects.table.reservationsCount":"{count} reservations","projects.table.headers.project":"Project","projects.table.headers.client":"Client","projects.table.headers.period":"Schedule","projects.table.headers.crew":"Crew","projects.table.headers.equipment":"Equipment","projects.table.headers.total":"Total (with VAT)","projects.table.headers.expenses":"Expenses (SR)","projects.table.emptyInitial":"No projects have been created yet.","projects.table.emptyFiltered":"No matching projects found.","projects.modal.title":"Project Details","projects.details.overview.heading":"Project Information","projects.reports.pageTitle":"Project Reports - Rental System","projects.reports.title":"Project Reporting Dashboard","projects.reports.subtitle":"Detailed analytics for project performance, deadlines, and completion rates.","projects.reports.filters.search":"Search","projects.reports.filters.searchPlaceholder":"Search by project or client name","projects.reports.filters.status":"Project status","projects.reports.filters.payment":"Payment status","projects.reports.filters.paymentAll":"All payments","projects.reports.filters.dateRange":"Date range","projects.reports.filters.range.all":"All time","projects.reports.filters.range.30":"Last 30 days","projects.reports.filters.range.90":"Last 90 days","projects.reports.filters.range.365":"Last year","projects.reports.filters.range.custom":"Custom range","projects.reports.filters.start":"From","projects.reports.filters.end":"To","projects.reports.filters.refresh":"Refresh","projects.reports.charts.status":"Status distribution","projects.reports.charts.statusHint":"Share of projects per execution status","projects.reports.charts.timeline":"Revenue over time","projects.reports.charts.timelineHint":"Total project value by month","projects.reports.charts.expenses":"Expenses vs. value","projects.reports.charts.expensesHint":"Compare spend against total project value","projects.reports.charts.clients":"Top clients","projects.reports.charts.clientsHint":"Highest clients by project value","projects.reports.loading.chart":"Refreshing chart…","projects.reports.table.title":"Project list","projects.reports.table.columns.project":"Project","projects.reports.table.columns.client":"Client","projects.reports.table.columns.status":"Status","projects.reports.table.columns.period":"Period","projects.reports.table.columns.value":"Value","projects.reports.table.columns.payment":"Payment","projects.reports.table.empty":"No projects match the current filters.","projects.reports.table.meta":"Showing {count} of {total} projects","projects.reports.kpi.totalProjects":"Total projects","projects.reports.kpi.totalProjectsMeta":"After applying the current filters","projects.reports.kpi.totalValue":"Total value","projects.reports.kpi.totalValueMeta":"Includes projects and linked reservations","projects.reports.kpi.unpaidValue":"Outstanding value","projects.reports.kpi.unpaidValueMeta":"Projects not fully paid yet","projects.reports.kpi.expenses":"Total expenses","projects.reports.kpi.expensesMeta":"Expenses for included projects","projects.reports.datasets.value":"Total value","projects.reports.datasets.expenses":"Expenses","projects.expenses.pageTitle":"Project Expenses - Rental System","projects.expenses.title":"Manage Project Expenses","projects.expenses.subtitle":"Track expenses linked to bookings and projects with full invoicing visibility.","projects.expenses.placeholder":"A dedicated board for linking project expenses to bookings is coming soon.","projects.expenses.placeholderHint":"Prepare invoices and categories now to accelerate the upcoming release.","projects.expenses.actions.addExpense":"➕ Add expense","projects.expenses.actions.importInvoice":"🧾 Upload invoice","projects.expenses.actions.export":"⬇️ Export","projects.expenses.kpi.total":"Total expenses","projects.expenses.kpi.total.meta":"Expenses recorded during the current period","projects.expenses.kpi.pending":"Pending approval","projects.expenses.kpi.pending.meta":"Expenses awaiting financial manager approval","projects.expenses.kpi.approved":"Approved","projects.expenses.kpi.approved.meta":"Latest expenses that were approved","projects.expenses.kpi.average":"Average per project","projects.expenses.kpi.average.meta":"Estimated value based on active projects","projects.expenses.breakdown.title":"Expenses by category","projects.expenses.breakdown.hint":"Track spend on equipment, crew, and logistics.","projects.expenses.breakdown.empty":"No categorized expenses recorded yet.","projects.expenses.timeline.title":"Expenses over time","projects.expenses.timeline.hint":"Review spend across recent months to spot trends.","projects.expenses.timeline.empty":"Add expenses to unlock the interactive timeline.","projects.expenses.table.title":"Detailed expense ledger","projects.expenses.table.hint":"Review project expenses together with approval status.","projects.expenses.table.columns.project":"Project","projects.expenses.table.columns.category":"Category","projects.expenses.table.columns.description":"Description","projects.expenses.table.columns.amount":"Amount","projects.expenses.table.columns.status":"Status","projects.expenses.table.columns.date":"Logged on","projects.expenses.table.empty":"Registered expenses will appear here as soon as you add them.","projects.toast.selectTechnician":"⚠️ Please select a crew member","projects.toast.technicianAlreadyAdded":"⚠️ Crew member already added","projects.toast.technicianAdded":"✅ Crew member added","projects.toast.selectEquipment":"⚠️ Please select equipment","projects.toast.equipmentAdded":"✅ Equipment added to project","projects.toast.missingExpenseLabel":"⚠️ Please enter an expense description","projects.toast.invalidExpenseAmount":"⚠️ Please enter a valid amount","projects.toast.customerNotFound":"⚠️ Client name not found. Please select an existing client.","projects.toast.missingRequiredFields":"⚠️ Please fill in the required fields","projects.toast.invalidDateRange":"⚠️ End date must be after the start date","projects.toast.saved":"✅ Project saved successfully","projects.toast.editReady":"✏️ Project loaded for editing. Update the fields, then save.","projects.toast.updated":"✅ Project updated successfully","projects.toast.editMissing":"⚠️ Unable to find the project you tried to edit","projects.toast.confirmed":"✅ Project confirmed","projects.toast.alreadyConfirmed":"ℹ️ Project already confirmed","projects.toast.deleted":"🗑️ Project deleted","projects.confirm.delete":"Are you sure you want to delete this project?","projects.fallback.unknownClient":"Unknown client","projects.fallback.unknownEquipment":"Equipment","projects.fallback.noDescription":"No description","projects.fallback.untitled":"Untitled project","projects.fallback.emptyList":"None","projects.fallback.technicianName":"Member {id}","projects.status.upcoming":"Upcoming","projects.status.ongoing":"In Progress","projects.status.completed":"Completed","projectCards.filters.search":"🔍 Search by project name or description...","projectCards.filters.status.all":"⚙️ All statuses","projectCards.filters.status.upcoming":"📅 Upcoming projects","projectCards.filters.status.ongoing":"⚙️ In-progress projects","projectCards.filters.status.completed":"✅ Completed projects","projectCards.stats.crew":"👥 Crew members: {count}","projectCards.stats.reservations":"🔗 Reservations: {count}","projectCards.stats.client":"👤 Client: {name}","projectCards.stats.type":"🏷️ Type: {label}","projectCards.stats.budget":"💰 Estimated budget (with VAT): {amount}","projectCards.stats.expenses":"💸 Expenses: {amount}","projectCards.stats.crewShort":"Crew","projectCards.stats.reservationsShort":"Reservations","projectCards.stats.budgetShort":"Project budget","projectCards.stats.expensesShort":"Total expenses","projectCards.stats.paymentStatus":"Payment status","projectCards.stats.equipmentCount":"Equipment count","projectCards.stats.crewCount":"Crew count","projectCards.stats.reservationValue":"Reservation total","projectCards.stats.expensesTotal":"Expenses total","projectCards.stats.reservationTotal":"Linked reservation total","projectCards.stats.taxTotal":"VAT","projectCards.stats.overallTotal":"Grand total","projectCards.groups.meta":"Project info","projectCards.groups.reservations":"Reservation snapshot","projectCards.groups.payment":"Payment summary","projectCards.meta.code":"Project ID","projectCards.meta.client":"Client","projectCards.meta.company":"Client company","projectCards.meta.type":"Project type","projectCards.meta.startDate":"Start date","projectCards.meta.endDate":"End date","projects.details.type":"Project type","projects.details.company":"Client company","projects.details.client":"Client","projects.details.crew":"Crew ({count})","projects.details.equipment":"Equipment ({count})","projects.details.expenses":"Expenses ({amount})","projects.details.subtotal":"Subtotal before tax:","projects.details.tax":"VAT 15%:","projects.details.total":"Total with VAT:","projects.details.labels.projectTitle":"Project Name","projects.details.labels.code":"Project ID","projects.details.summary.projectSubtotal":"Project total","projects.details.summary.paymentStatus":"Payment status","projects.details.summary.projectTax":"Project VAT (15%)","projects.details.summary.projectTotal":"Project total (after VAT)","projects.details.summary.reservationsTotal":"Equipment / crew total","projects.details.summary.combinedTax":"Total VAT on combined amount (15%)","projects.details.summary.reservationsCount":"{count} linked reservations","projects.details.summary.overallTotal":"Overall total","projects.details.labels.start":"Start date","projects.details.labels.end":"End date","projects.details.labels.crewCount":"Crew count","projects.details.labels.equipmentCount":"Equipment quantity","projects.details.labels.reservationsCount":"Reservations count","projects.details.labels.notes":"Project notes","projects.details.chips.vatOn":"VAT enabled 15%","projects.details.chips.vatOff":"VAT disabled","projects.details.chips.reservations":"{count} reservations","projects.details.noItems":"None","projects.details.quantity":"{qty} pcs","projects.details.reservations.title":"Linked reservations","projects.details.reservations.empty":"No reservations linked to this project yet.","projects.details.reservations.create":"➕ Create linked reservation","projects.details.reservations.view":"View reservation","projects.details.actions.edit":"✏️ Edit Project","projects.details.actions.delete":"🗑️ Delete Project","projects.details.reservations.count":"{count} reservations","projects.details.reservations.itemsCount":"{count} item(s)","projects.details.reservations.crewCount":"{count} crew member(s)","projects.details.edit.heading":"Edit Project","projects.details.edit.subheading":"Update the project details, then save your changes.","projects.details.edit.save":"💾 Save Changes","projects.details.edit.cancel":"Cancel"}});Zr({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.hero.subtitle":"👋 هذه نظرة سريعة على بيانات العميل","customerDetails.fields.taxId":"🧾 الرقم الضريبي:","customerDetails.fields.document":"📎 مستند العميل","customerDetails.stats.reservations":"إجمالي الحجوزات","customerDetails.stats.upcoming":"حجوزات قادمة","customerDetails.stats.projects":"عدد المشاريع","customerDetails.stats.projectsEmpty":"لا توجد مشاريع مرتبطة بهذا العميل.","customerDetails.stats.lastActivity":"آخر نشاط","customerDetails.stats.lastActivityEmpty":"لا يوجد نشاط حديث","customerDetails.stats.reservationsDesc":"عدد الحجوزات الكلي","customerDetails.stats.upcomingEmpty":"لا توجد حجوزات قادمة","customerDetails.stats.nextReservation":"أقرب حجز: {date}","customerDetails.stats.projectsDesc":"المشاريع المرتبطة بالعميل","customerDetails.stats.payment":"قيمة المدفوع/المستحق","customerDetails.stats.paymentBreakdown":"مدفوع / مستحق","customerDetails.stats.paymentPaid":"المدفوع","customerDetails.stats.paymentOutstandingLabel":"المستحق","customerDetails.stats.totalValue":"القيمة الإجمالية: {amount}","customerDetails.stats.totalValueEmpty":"لم يتم رصد مبالغ بعد.","customerDetails.stats.paymentOutstanding":"المتبقي: {amount}","customerDetails.stats.paymentAllSet":"لا توجد مبالغ مستحقة","customerDetails.stats.paymentOutstandingEmpty":"لا توجد مبالغ مستحقة","customerDetails.stats.activityEmpty":"لا يوجد نشاط حديث","customerDetails.stats.activityOn":"بتاريخ {date}","customerDetails.stats.activityType.reservation":"حجز","customerDetails.stats.activityType.project":"مشروع","customerDetails.stats.activityType.customer":"بيانات العميل","customerDetails.stats.complianceEmpty":"لا توجد بيانات دفع كافية","customerDetails.stats.complianceProjects":"مشاريع مدفوعة بالكامل: {count} من {total}","customerDetails.stats.complianceLabel.excellent":"التزام ممتاز","customerDetails.stats.complianceLabel.good":"دفع في الوقت المحدد","customerDetails.stats.complianceLabel.average":"يحتاج متابعة","customerDetails.stats.complianceLabel.poor":"تأخير متكرر","customerDetails.document.open":"عرض المستند","customerDetails.document.defaultName":"المستند المرتبط","customerDetails.primaryNav.reservations":"📅 إدارة الحجوزات","customerDetails.primaryNav.projects":"📁 إدارة المشاريع","customerTabs.reservations":"📅 إدارة الحجوزات","customerTabs.projects":"📁 إدارة المشاريع","customerTabs.customerReservations":"📅 حجوزات العميل","customerTabs.customerProjects":"📁 مشاريع العميل","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.hero.subtitle":"👋 Here is a quick look at this client","customerDetails.fields.taxId":"🧾 Tax Number:","customerDetails.fields.document":"📎 Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"📅 Booking Management","customerDetails.primaryNav.projects":"📁 Project Management","customerTabs.reservations":"📅 Booking Management","customerTabs.projects":"📁 Project Management","customerTabs.customerReservations":"📅 Client Reservations","customerTabs.customerProjects":"📁 Client Projects","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});const Up=.15,Kq="bg-primary",Wq=2,mS={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},Qq={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"},Gq={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"};function Qu(e){if(!e)return null;const n=[e?.id,e?.reservationId,e?.reservation_id,e?.reservationID].find(a=>a!=null&&a!=="");return n!=null?String(n):null}function Vp(e=[]){const t=We();return e.map(n=>{const a=n?.reservation??n;if(!a||typeof a!="object")return null;let s=Number.isInteger(n?.index)&&n.index>=0?n.index:Number.isInteger(n?.reservationIndex)&&n.reservationIndex>=0?n.reservationIndex:null;if(!Number.isInteger(s)||s<0){const r=Qu(a);r&&(s=t.findIndex(i=>{const o=Qu(i);return o&&o===r}))}return{reservation:a,index:Number.isInteger(s)&&s>=0?s:-1}}).filter(Boolean)}function _n(e){return e?e.id!=null?String(e.id):e.projectId!=null?String(e.projectId):e.project_id!=null?String(e.project_id):null:null}function pS(e,{customer:t=null,techniciansMap:n=new Map,reservations:a=[]}={}){const r=Vp(a).map(({reservation:re})=>re),i=_n(e),o=i?Q(i):"",l=xl(e),d=c(`projects.status.${l}`,mS[l]),u=Qq[l]||"bg-secondary",m=e?.paymentStatus==="paid"?"paid":"unpaid",p=c(`projects.paymentStatus.${m}`,m==="paid"?"Paid":"Unpaid"),f=m==="paid"?"status-paid":"status-unpaid",h=[m==="paid"?"project-focus-card--paid":"project-focus-card--unpaid"],g=e?.confirmed===!0||e?.confirmed==="true";g&&h.push("project-focus-card--confirmed");const y=e?.projectCode||(i?`PRJ-${b(i)}`:""),E=y?b(String(y).replace(/^#/,"")):"",S=E?`<span class="project-code-badge project-focus-card__code">#${Q(E)}</span>`:"",x=Qp(e?.type),A=x?`<span class="badge project-focus-card__badge ${Kq}">${Q(x)}</span>`:"",C=`<span class="project-focus-card__status-chip ${u}">${Q(d)}</span>`,j=`<span class="reservation-chip ${f} project-focus-card__payment-chip">${Q(p)}</span>`,k=(e?.title||"").trim()||c("projects.fallback.untitled","Untitled project"),w=(e?.description||"").trim(),_=Q(w?d0(w,110):c("projects.fallback.noDescription","No description")),$=Array.isArray(e?.technicians)?e.technicians:[],q=$.map(re=>n.get(String(re))?.name).filter(Boolean),F=q.length?Yq(q):"",U=t?.customerName||e?.clientName||"",L=(e?.clientCompany||t?.companyName||"").trim(),B=r.reduce((re,ue)=>{const Pe=Wp(ue),ye=(Array.isArray(ue?.items)?ue.items:[]).reduce((Ce,X)=>Ce+(Number(X?.qty)||0),0),te=Array.isArray(ue?.technicians)?ue.technicians.length:0;return{total:re.total+Pe,equipment:re.equipment+ye,crew:re.crew+te}},{total:0,equipment:0,crew:0}),D=Number(B.total.toFixed(2)),K=B.equipment,Z=B.crew||$.length,R=Kp(e),M=R.applyTax?Number(((R.subtotal+D)*Up).toFixed(2)):0,H=Number((R.subtotal+D+M).toFixed(2)),V=[E?{icon:"🆔",label:c("projectCards.meta.code","رقم المشروع"),value:`#${E}`}:null,U?{icon:"👤",label:c("projectCards.meta.client","العميل"),value:U}:null,L?{icon:"🏢",label:c("projectCards.meta.company","شركة العميل"),value:L}:null,x?{icon:"🏷️",label:c("projectCards.meta.type","نوع المشروع"),value:x}:null,F?{icon:"👥",label:c("projectCards.stats.crewLabel","عدد الطاقم"),value:F}:null,{icon:"📅",label:c("projectCards.meta.startDate","تاريخ البداية"),value:Wh(e?.start)},{icon:"📅",label:c("projectCards.meta.endDate","تاريخ النهاية"),value:e?.end?Wh(e.end):"—"}].filter(Boolean),G=[{icon:"📦",label:c("projectCards.stats.equipmentCount","عدد المعدات"),value:b(String(K))},{icon:"😎",label:c("projectCards.stats.crewCount","عدد أفراد الطاقم"),value:b(String(Z))},{icon:"💵",label:c("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:dt(D)}],ie=[{icon:"💳",label:c("projectCards.stats.paymentStatus","حالة الدفع"),value:p},{icon:"💸",label:c("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:dt(R.expensesTotal)},{icon:"💰",label:c("projectCards.stats.projectSubtotal","التكلفة التقديرية"),value:dt(R.subtotal)},{icon:"🧾",label:c("projectCards.stats.taxTotal","الضريبة"),value:dt(M)},{icon:"💵",label:c("projectCards.stats.overallTotal","المجموع الكلي"),value:dt(H)}],ee=[Ld("projectCards.groups.meta","بيانات المشروع",V),Ld("projectCards.groups.reservations","موجز الحجز",G),Ld("projectCards.groups.payment","ملخص الدفع",ie)].filter(Boolean).join(""),oe=c("projects.focus.confirmed","✅ مشروع مؤكد"),W=c("projects.focus.pending","⌛ بانتظار التأكيد"),Se=`<div class="project-focus-card__actions"><span class="reservation-chip ${g?"status-confirmed":"status-pending"} project-focus-card__confirm-indicator">${Q(g?oe:W)}</span></div>`,we=[S,A,C,j].filter(Boolean).join(`
          `);return`
    <div class="project-card-grid__item">
      <article class="${["project-focus-card",...h].join(" ")}" data-project-id="${o}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${we}
        </div>
        <h6 class="project-focus-card__title">${Q(k)}</h6>
        <p class="project-focus-card__description">${_}</p>
        <div class="project-focus-card__sections">
          ${ee}
        </div>
        ${Se}
      </article>
    </div>
  `}function Ld(e,t,n=[]){if(!n.length)return"";const a=n.map(({icon:s,label:r,value:i})=>`
        <div class="project-focus-card__row">
          <span class="project-focus-card__row-label">${s?`<span class="project-focus-card__row-icon">${Q(s)}</span>`:""}${Q(r)}</span>
          <span class="project-focus-card__row-value">${Q(String(i))}</span>
        </div>
      `).join("");return`
    <div class="project-focus-card__section">
      <span class="project-focus-card__section-title">${Q(c(e,t))}</span>
      <div class="project-focus-card__section-box">
        ${a}
      </div>
    </div>
  `}function Yq(e=[]){if(!e.length)return"";const t=e.slice(0,Wq),n=e.length-t.length,a=Le()==="ar"?"، ":", ";let s=t.join(a);return n>0&&(s+=`${a}+${b(String(n))}`),s}function fS(e,{customer:t=null,reservations:n=[]}={}){const a=Vp(n),s=a.map(({reservation:H})=>H),r=Kp(e),i=s.reduce((H,V)=>H+Wp(V),0),o=Number(i.toFixed(2)),l=s.length,d=r.applyTax?Number(((r.subtotal+o)*Up).toFixed(2)):0,u=Number((r.subtotal+o+d).toFixed(2)),m=xl(e),p=c(`projects.status.${m}`,mS[m]),f=Gq[m]||"status-confirmed",h=_n(e)||"",g=e?.projectCode||(h?`PRJ-${b(h)}`:""),y=g?b(String(g).replace(/^#/,"")):"",E=y?`<span class="project-code-badge">#${Q(y)}</span>`:"",S=r.applyTax,x=S?c("projects.details.chips.vatOn","شامل الضريبة 15٪"):c("projects.details.chips.vatOff","غير شامل الضريبة"),A=S?"status-paid":"status-unpaid",C=e?.paymentStatus==="paid"?"paid":"unpaid",j=c(`projects.paymentStatus.${C}`,C==="paid"?"Paid":"Unpaid"),k=C==="paid"?"status-paid":"status-unpaid",_=c("projects.details.chips.reservations","{count} حجوزات").replace("{count}",b(String(l))),$=e?.confirmed===!0||e?.confirmed==="true"?`<span class="reservation-chip status-confirmed">${Q(c("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:"",q=t?.customerName||e?.clientName||"",F=(e?.clientCompany||t?.companyName||"").trim(),L=(e?.description||"").trim()||c("projects.fallback.noDescription","لا يوجد وصف"),B=[y?{icon:"🆔",label:c("projects.details.labels.code","رقم المشروع"),value:`#${y}`}:null,q?{icon:"👤",label:c("projects.details.client","العميل"),value:q}:null,F?{icon:"🏢",label:c("projects.details.company","شركة العميل"),value:F}:null,{icon:"🏷️",label:c("projects.details.type","نوع المشروع"),value:Qp(e?.type)},{icon:"🗓️",label:c("projects.details.labels.start","تاريخ البداية"),value:ul(e?.start)},{icon:"🗓️",label:c("projects.details.labels.end","تاريخ النهاية"),value:e?.end?ul(e.end):"—"},{icon:"🔗",label:c("projects.details.labels.reservationsCount","عدد الحجوزات"),value:b(String(l))}].filter(Boolean),D=c("projects.details.expenses","المصروفات ({amount})").replace("{amount}",dt(r.expensesTotal)),K=r.expensesTotal>0?`<ul class="project-details-list">${(e?.expenses||[]).map(H=>`
          <li>
            <span class="project-expense-label">${Q(H.label??"")}</span>
            <span class="project-expense-amount">${dt(H.amount)}</span>
          </li>
        `).join("")}</ul>`:`<div class="text-muted">${Q(c("projects.details.noItems","لا يوجد"))}</div>`,R=[{icon:"💳",label:c("projects.details.summary.paymentStatus","حالة الدفع"),value:j},{icon:"💼",label:c("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:dt(r.subtotal)},{icon:"💵",label:c("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:dt(o)},{icon:"🧮",label:c("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:dt(d)},{icon:"💰",label:c("projects.details.summary.overallTotal","الإجمالي الكلي"),value:dt(u)}].map(({icon:H,label:V,value:G})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${Q(H)} ${Q(V)}</span>
      <span class="summary-details-value">${Q(G)}</span>
    </div>
  `).join(""),M=Xq({project:e,reservations:a});return`
    <div class="project-details-header mb-4">
      <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
        <div>
          <h5 class="mb-2 d-flex flex-wrap align-items-center gap-2">
            <span class="text-muted project-details-title-label">${Q(c("projects.details.labels.projectTitle","اسم المشروع"))}:</span>
            <span class="fw-bold project-details-title-text">${Q((e?.title||"").trim()||c("projects.fallback.untitled","Untitled project"))}</span>
            ${E}
          </h5>
        </div>
        <div class="status-chips d-flex flex-wrap gap-2">
          <span class="status-chip ${f}">${Q(p)}</span>
          <span class="status-chip ${A}">${Q(x)}</span>
          <span class="reservation-chip ${k}">${Q(j)}</span>
          <span class="reservation-chip status-confirmed">${Q(_)}</span>
          ${$}
        </div>
      </div>
    </div>
    <div class="project-details-info mb-4">
      ${B.map(({icon:H,label:V,value:G})=>hS(H,V,G)).join("")}
    </div>
    <div class="project-details-section mb-4">
      <h6>${Q(c("projects.details.labels.notes","ملاحظات المشروع"))}</h6>
      <div class="project-notes">${Q(L)}</div>
    </div>
    <div class="project-details-section mb-4">
      <h6>${Q(D)}</h6>
      ${K}
    </div>
    <div class="project-details-summary summary-details mb-4">
      ${R}
    </div>
    ${M}
  `}function Xq({reservations:e=[],project:t=null}={}){const a=[...Vp(e)].sort((o,l)=>{const d=o?.reservation?.start?new Date(o.reservation.start).getTime():0;return(l?.reservation?.start?new Date(l.reservation.start).getTime():0)-d}),s=c("projects.details.reservations.title","الحجوزات المرتبطة"),r=c("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=a.length?`<div class="project-reservations-list">${a.map(({reservation:o,index:l})=>Jq(o,l,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${Q(r)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${Q(s)}</h6>
      </div>
      ${i}
    </section>
  `}function Jq(e,t=-1,n=null){const a=Qu(e)??"-",s=b(String(a)),r=Zq(e?.start,e?.end),i=Wp(e),o=dt(i),l=b(String((e?.items||[]).length)),d=b(String((e?.technicians||[]).length)),u=c("projects.details.reservations.itemsCount","{count} معدة").replace("{count}",l),m=c("projects.details.reservations.crewCount","{count} من الطاقم").replace("{count}",d),{effectiveConfirmed:p}=Vt(e,n),f=p?c("reservations.list.status.confirmed","✅ مؤكد"):c("reservations.list.status.pending","⏳ غير مؤكد"),h=p?"project-reservation-card__badge--confirmed":"project-reservation-card__badge--pending",g=e?.paid===!0||e?.paid==="paid",y=g?c("reservations.list.payment.paid","💳 مدفوع"):c("reservations.list.payment.unpaid","💳 غير مدفوع"),E=g?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",x=jo(e)?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${Q(c("reservations.list.status.completed","📁 منتهي"))}</span>`:"",A=Number.isInteger(t)&&t>=0?` data-index="${t}"`:"",C=`<button type="button" class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-ignore-project-modal="true" data-reservation-id="${Q(String(a??""))}"${A}>${Q(c("projects.details.reservations.view","عرض الحجز"))}</button>`;return`
    <article class="project-reservation-card" data-reservation-id="${Q(s)}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${Q(s)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${h}">${Q(f)}</span>
          <span class="project-reservation-card__badge ${E}">${Q(y)}</span>
          ${x}
        </div>
      </div>
      <div class="project-reservation-card__range">${Q(r)}</div>
      <div class="project-reservation-card__meta">
        <span>📦 ${Q(u)}</span>
        <span>😎 ${Q(m)}</span>
      </div>
      <div class="project-reservation-card__footer">
        <span class="text-muted">${Q(c("projectCards.stats.reservationValue","إجمالي الحجوزات"))}</span>
        <span class="fw-bold">${Q(o)}</span>
        ${C}
      </div>
    </article>
  `}function hS(e,t,n){return`
    <div class="res-info-row">
      <span class="label">${Q(e)} ${Q(t)}</span>
      <span class="separator">:</span>
      <span class="value">${Q(n)}</span>
    </div>
  `}function Kp(e){const t=Number(e?.equipmentEstimate)||0,n=l0(e),a=t+n,s=e?.applyTax===!0||e?.applyTax==="true",r=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let o=(e?.discountType==="amount"?"amount":"percent")==="amount"?r:a*(r/100);(!Number.isFinite(o)||o<0)&&(o=0),o>a&&(o=a);const l=Math.max(0,a-o),d=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",u=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,m=d&&s&&u>0?u:0,p=m>0?Number((l*(m/100)).toFixed(2)):0,f=l+p;let h=s?f*Up:0;(!Number.isFinite(h)||h<0)&&(h=0),h=Number(h.toFixed(2));let g=s?Number(e?.totalWithTax):f;return s?(!Number.isFinite(g)||g<=0)&&(g=Number((f+h).toFixed(2))):g=f,{equipmentEstimate:t,expensesTotal:n,baseSubtotal:a,discountAmount:o,subtotalAfterDiscount:l,companyShareAmount:p,subtotal:f,applyTax:s,taxAmount:h,totalWithTax:g}}function Wp(e){if(!e)return 0;const t=Array.isArray(e?.items)?e.items:[],n=e?.discount??0,a=Number(b(String(n)))||0,s=e?.discountType||"percent",r=Array.isArray(e?.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e?.technicians)?e.technicians:[],o=Js(t,a,s,!1,i,{start:e?.start,end:e?.end});if(Number.isFinite(o))return o;const l=Number(b(String(e?.cost??e?.total??0)));return Number.isFinite(l)?Math.round(l):0}function Wh(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const a=Le()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-GB",s=new Intl.DateTimeFormat(a,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return b(s.format(t))}function ul(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getFullYear()),r=String(t.getMinutes()).padStart(2,"0"),i=t.getHours(),o=i>=12?"PM":"AM",l=i%12||12,d=String(l).padStart(2,"0"),u=`${n}/${a}/${s} ${d}:${r} ${o}`;return b(u)}function Zq(e,t){if(!e)return"—";const n=ul(e);return t?`${n} - ${ul(t)}`:n}function Qp(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const n={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(n,e)}function yS(e,{clientName:t="",clientCompany:n=""}={}){const a=_n(e)||"",s=e?.projectCode||(a?`PRJ-${b(a)}`:""),r=s?b(String(s)):"",i=ek(e?.type),o=Qh(e?.start||""),l=Qh(e?.end||""),d=typeof e?.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",u=["paid","partial"].includes(d)?d:"unpaid",m=e?.applyTax===!0||e?.applyTax==="true",p=e?.description||"",f=e?.discountType==="amount"?"amount":"percent",h=b(String(e?.discount??e?.discountValue??0)),g=e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??Fe,y=Number.parseFloat(b(String(g))),E=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true"||m&&Number.isFinite(y)&&y>0,S=Number.isFinite(y)&&y>0?y:Fe,x=e?.paymentProgressType==="amount"?"amount":e?.paymentProgressType==="percent"?"percent":e?.payment_progress_type==="amount"?"amount":(e?.payment_progress_type==="percent","percent"),A=b(String(e?.paymentProgressValue??e?.payment_progress_value??(x==="amount"?e?.paidAmount??e?.paid_amount:e?.paidPercent??e?.paid_percent)??"")),C=c("projects.details.labels.code","رقم المشروع"),j=c("projects.form.labels.client","العميل"),k=c("projects.form.labels.clientCompany","شركة العميل"),w=[r?{icon:"🆔",label:C,value:`#${r}`}:null,t?{icon:"👤",label:j,value:t}:null,n?{icon:"🏢",label:k,value:n}:null].filter(Boolean),_=w.length?`<div class="project-details-info mb-3">
        ${w.map(({icon:q,label:F,value:U})=>hS(q,F,U)).join("")}
      </div>`:"",$=Gp(Array.isArray(e?.expenses)?e.expenses:[]);return`
    <div class="project-details-edit">
      <div class="project-details-header mb-3">
        <h5 class="fw-bold mb-1">${Q(c("projects.details.edit.heading","تعديل المشروع"))}</h5>
        <p class="text-muted small mb-0">${Q(c("projects.details.edit.subheading","قم بتحديث بيانات المشروع ثم احفظ التغييرات."))}</p>
      </div>
      ${_}
      <form id="project-details-edit-form" class="project-details-edit-form">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="project-edit-title">${Q(c("projects.form.labels.title","اسم المشروع"))}</label>
            <input type="text" class="form-control" id="project-edit-title" name="project-title" value="${Q(e?.title||"")}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-type">${Q(c("projects.form.labels.type","نوع المشروع"))}</label>
            <select class="form-select" id="project-edit-type" name="project-type" required>
              ${i}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-start-date">${Q(c("projects.form.labels.startDate","📅 تاريخ البداية"))}</label>
            <input type="date" class="form-control" id="project-edit-start-date" name="project-start-date" value="${Q(o.date)}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-start-time">${Q(c("projects.form.labels.startTime","⏰ وقت البداية"))}</label>
            <input type="time" class="form-control" id="project-edit-start-time" name="project-start-time" value="${Q(o.time)}">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-end-date">${Q(c("projects.form.labels.endDate","📅 تاريخ النهاية"))}</label>
            <input type="date" class="form-control" id="project-edit-end-date" name="project-end-date" value="${Q(l.date)}">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-end-time">${Q(c("projects.form.labels.endTime","⏰ وقت النهاية"))}</label>
            <input type="time" class="form-control" id="project-edit-end-time" name="project-end-time" value="${Q(l.time)}">
          </div>
          <div class="col-12">
            <label class="form-label" for="project-edit-description">${Q(c("projects.details.labels.notes","ملاحظات المشروع"))}</label>
            <textarea class="form-control" id="project-edit-description" name="project-description" rows="3">${Q(p)}</textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-expense-label">${Q(c("projects.form.labels.expenseLabel","اسم المصروف"))}</label>
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${Q(c("projects.form.placeholders.expenseLabel","مثال: رسوم موقع التصوير"))}">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-expense-amount">${Q(c("projects.form.labels.expenseAmount","المبلغ (SR)"))}</label>
            <input type="text" class="form-control" id="project-edit-expense-amount" inputmode="decimal" placeholder="0">
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="button" class="btn btn-sm btn-primary" data-action="add-expense">${Q(c("projects.form.buttons.addExpense","➕ إضافة مصروف"))}</button>
          </div>
          <div class="col-12">
            <div id="project-edit-expense-list" class="project-edit-expense-list">
              ${$}
            </div>
          </div>
        </div>
        <div class="row g-3 align-items-start mt-3">
          <div class="col-md-4">
            <label class="form-label" for="project-edit-discount">${Q(c("projects.form.labels.discount","الخصم"))}</label>
          <div class="input-group">
            <select id="project-edit-discount-type" name="project-discount-type" class="form-select">
              <option value="percent" ${f==="percent"?"selected":""}>${Q(c("projects.form.discount.percent","٪ نسبة"))}</option>
              <option value="amount" ${f==="amount"?"selected":""}>${Q(c("projects.form.discount.amount","💵 مبلغ"))}</option>
            </select>
            <input type="text" id="project-edit-discount" name="project-discount" class="form-control" value="${Q(h)}" placeholder="0" inputmode="decimal">
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label d-block" for="project-edit-company-share">${Q(c("projects.form.labels.companyShare","نسبة الشركة والضريبة"))}</label>
          <div class="d-flex flex-column gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-company-share" name="project-company-share" data-company-share="${Q(String(S))}" ${E?"checked":""}>
              <label class="form-check-label" for="project-edit-company-share">${Q(c("projects.form.companyShareToggle","إضافة نسبة الشركة (10٪)"))}</label>
            </div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-tax" name="project-apply-tax" ${m?"checked":""}>
              <label class="form-check-label" for="project-edit-tax">${Q(c("projects.form.taxLabel","شامل الضريبة (15٪)"))}</label>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="project-edit-payment-status">${Q(c("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" id="project-edit-payment-status" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${Q(c("projects.form.paymentStatus.unpaid","غير مدفوع"))}</option>
            <option value="partial" ${u==="partial"?"selected":""}>${Q(c("projects.form.paymentStatus.partial","مدفوع جزئياً"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${Q(c("projects.form.paymentStatus.paid","مدفوع"))}</option>
          </select>
          <label class="form-label mt-2" for="project-edit-payment-progress-value">${Q(c("projects.form.paymentProgress.label","💰 الدفعة المستلمة"))}</label>
          <div class="input-group">
            <select id="project-edit-payment-progress-type" name="project-payment-progress-type" class="form-select">
              <option value="amount" ${x==="amount"?"selected":""}>${Q(c("projects.form.paymentProgress.amount","💵 مبلغ"))}</option>
              <option value="percent" ${x!=="amount"?"selected":""}>${Q(c("projects.form.paymentProgress.percent","٪ نسبة"))}</option>
            </select>
            <input type="text" id="project-edit-payment-progress-value" name="project-payment-progress-value" class="form-control" value="${Q(A)}" placeholder="0" inputmode="decimal">
          </div>
          <small class="text-muted">${Q(c("projects.form.paymentProgress.hint","أدخل المبلغ أو النسبة التي تم استلامها من قيمة المشروع"))}</small>
        </div>
      </div>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mt-4">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel-edit">${Q(c("projects.details.edit.cancel","إلغاء"))}</button>
            <button type="submit" class="btn btn-sm btn-primary">${Q(c("projects.details.edit.save","💾 حفظ التعديلات"))}</button>
          </div>
        </div>
      </form>
    </div>
  `}function ek(e){const t=["commercial","coverage","photography","social"],n=t.map(s=>{const r=Q(c(`projects.form.types.${s}`,s)),i=String(s)===String(e)?" selected":"";return`<option value="${s}"${i}>${r}</option>`});if(e&&!t.includes(e)){const s=Q(Qp(e));n.push(`<option value="${Q(String(e))}" selected>${s}</option>`)}return`<option value="">${Q(c("projects.form.placeholders.type","اختر نوع المشروع"))}</option>${n.join("")}`}function Gp(e=[]){if(!Array.isArray(e)||e.length===0)return`<div class="text-muted small" data-empty>${Q(c("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const t=Q(c("actions.remove","إزالة"));return e.map(n=>{const a=Q(n?.label||""),s=Q(dt(n?.amount||0)),r=Q(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${s}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${r}" aria-label="${t}">✖</button>
        </div>
      `}).join("")}function Qh(e){if(!e)return{date:"",time:""};let t=e;t.includes(" ")&&(t=t.replace(" ","T"));const[n="",a=""]=t.split("T"),s=a.match(/(\d{1,2}:\d{2})/);return{date:n?n.slice(0,10):"",time:s?s[0]:""}}function ml(e,t){if(!e)return"";const n=t&&/\d{1,2}:\d{2}/.test(t)?t:"00:00",[a="00",s="00"]=n.split(":"),r=a.padStart(2,"0"),i=s.padStart(2,"0");return`${e}T${r}:${i}`}function gS(e){if(!e)return null;const t=e.projectId??e.project_id??e.projectID??null;return t!=null?String(t):null}async function bS(e,t){if(!e)return;const a=We().filter(o=>{const l=gS(o);return l&&l===String(e)});if(!a.length)return;const s=t==="paid",r=s?"paid":"unpaid";let i=!1;for(const o of a){const l=o?.id??o?.reservationId??o?.reservation_id;if(!l)continue;const d=o?.paid===!0||o?.paid==="paid",u=o?.paidStatus??o?.paymentStatus??(d?"paid":"unpaid");if(!(d===s&&u===r))try{await er(l,{paid_status:r,paid:s}),i=!0}catch(m){console.error("❌ [projectFocusTemplates] Failed to sync reservation payment status",m)}}i&&document.dispatchEvent(new CustomEvent("reservations:changed"))}const z={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},v={};function tk(){z.selectedTechnicians=[],z.selectedEquipment=[],z.expenses=[]}function N(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Qe(e){const t=Number(e)||0,a=Le()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",s=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${b(s)} SR`}function ua(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getFullYear()),r=String(t.getMinutes()).padStart(2,"0"),i=t.getHours(),o=i>=12?"PM":"AM",l=i%12||12,d=String(l).padStart(2,"0"),u=`${n}/${a}/${s} ${d}:${r} ${o}`;return b(u)}function nk(e){const t=Le(),n=b(String(e));return t==="en"?`${n} ${e===1?"project":"projects"}`:`${n} مشروع`}function Gh(e){v.tableCount&&(v.tableCount.dataset.count=String(e),v.tableCount.textContent=nk(e))}function ak(e){if(!e)return"";const t=e.dataset.emptyKey,n=e.dataset.empty||"";return t?c(t,n):n}function sk(){if(!Array.isArray(z.projects)||z.projects.length===0)return;let e=!1;const t=z.projects.map(n=>{if(n.projectCode)return n;const a=wg();return e=!0,{...n,projectCode:a}});e&&(z.projects=t)}function rk(){const{customers:e,technicians:t,equipment:n}=ae();z.customers=Array.isArray(e)?e:[],z.technicians=Array.isArray(t)?t:[],z.equipment=Array.isArray(n)?n:[],z.reservations=We(),z.projects=ir(),sk()}function Xl(){if(vS(),v.technicianSelect){const e=v.technicianSelect.value,t=N(c("projects.form.selectTechnician","اختر عضو الطاقم"));v.technicianSelect.innerHTML=`<option value="">${t}</option>`+z.technicians.map(n=>{const a=c("projects.fallback.technicianName","عضو {id}"),s=n.name||a.replace("{id}",b(String(n.id||"")));return`<option value="${n.id}">${N(s)}</option>`}).join(""),e&&(v.technicianSelect.value=e)}if(v.equipmentSelect){const e=v.equipmentSelect.value,t=N(c("projects.form.selectEquipment","اختر المعدة"));v.equipmentSelect.innerHTML=`<option value="">${t}</option>`+z.equipment.map(n=>{const a=n.desc||n.description||n.name||c("projects.fallback.unknownEquipment","معدة");return`<option value="${N(n.barcode||"")}">${N(a)}</option>`}).join(""),e&&(v.equipmentSelect.value=e)}}function Ls(e){if(!v.clientCompany)return;const t=e?.companyName||e?.company||"";v.clientCompany.value=t}function vS(){if(!v.client)return;ik();const e=v.client.dataset?.customerId;if(e){const t=z.customers.find(n=>String(n.id)===String(e));t?Ls(t):(v.client.dataset.customerId="",Ls(null))}else Ls(null);document.activeElement===v.client&&Gu()}function ik(){!v.client||!v.clientSuggestions||v.client.dataset.autocompleteAttached!=="true"&&(v.client.addEventListener("input",()=>{v.client.dataset.customerId="",Gu(),Ls(null)}),v.client.addEventListener("focus",()=>{Gu()}),v.client.addEventListener("blur",()=>{window.setTimeout(()=>io(),150)}),v.client.dataset.autocompleteAttached="true")}function io(){v.clientSuggestions&&(v.clientSuggestions.classList.remove("is-visible"),v.clientSuggestions.hidden=!0,v.clientSuggestions.innerHTML="")}function Gu(){if(!v.client||!v.clientSuggestions)return;if(!Array.isArray(z.customers)||z.customers.length===0){const a=ae();Array.isArray(a?.customers)&&a.customers.length&&(z.customers=a.customers)}const e=ok(),t=et(v.client.value||""),n=t?e.filter(a=>{const s=et(a.name).includes(t),r=et(a.company||"").includes(t);return s||r}).slice(0,10):e.slice(0,10);if(!n.length){io();return}v.clientSuggestions.innerHTML=n.map(a=>{const s=a.company?`<div class="suggestion-item__meta">${N(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${N(String(a.id))}" data-name="${N(a.name)}" data-company="${N(a.company||"")}">
          <div class="suggestion-item__primary">${N(a.name)}</div>
          ${s}
        </div>
      `}).join(""),v.clientSuggestions.hidden=!1,v.clientSuggestions.classList.add("is-visible"),v.clientSuggestions.scrollTop=0,v.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",s=>{s.preventDefault();const{id:r,name:i}=s.currentTarget.dataset;v.client&&(v.client.value=i||"",v.client.dataset.customerId=r||"");const o=s.currentTarget.dataset.company||"";Ls({companyName:o}),io()})})}function ok(){return Array.isArray(z.customers)?z.customers.map(e=>{const t=(e.customerName||e.name||"").trim();return t?{id:e.id,name:t,company:(e.companyName||e.company||"").trim()}:null}).filter(Boolean):[]}function ck(e,t=""){if(!Array.isArray(z.customers)||z.customers.length===0)return null;if(t){const s=z.customers.find(r=>String(r.id)===String(t));if(s)return s}const n=et(e||"");if(!n)return null;const a=z.customers.find(s=>et(s.customerName||s.name||"")===n);return a||z.customers.find(s=>et(s.customerName||s.name||"").includes(n))||null}function lk(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function dk(){v.form=document.getElementById("project-form"),v.title=document.getElementById("project-title"),v.type=document.getElementById("project-type"),v.client=document.getElementById("project-client"),v.clientSuggestions=document.getElementById("project-customer-suggestions"),v.clientCompany=document.getElementById("project-client-company"),v.paymentStatus=document.getElementById("project-payment-status"),v.startDate=document.getElementById("project-start-date"),v.startTime=document.getElementById("project-start-time"),v.endDate=document.getElementById("project-end-date"),v.endTime=document.getElementById("project-end-time"),v.description=document.getElementById("project-description"),v.technicianSelect=document.getElementById("project-technician-select"),v.addTechnicianBtn=document.getElementById("add-technician-btn"),v.technicianList=document.getElementById("project-technician-list"),v.equipmentSelect=document.getElementById("project-equipment-select"),v.equipmentQty=document.getElementById("project-equipment-qty"),v.addEquipmentBtn=document.getElementById("add-equipment-btn"),v.equipmentList=document.getElementById("project-equipment-list"),v.expenseLabel=document.getElementById("project-expense-label"),v.expenseAmount=document.getElementById("project-expense-amount"),v.addExpenseBtn=document.getElementById("add-expense-btn"),v.expenseList=document.getElementById("project-expense-list"),v.discountType=document.getElementById("project-discount-type"),v.discountValue=document.getElementById("project-discount"),v.companyShare=document.getElementById("project-company-share"),v.paymentProgressType=document.getElementById("project-payment-progress-type"),v.paymentProgressValue=document.getElementById("project-payment-progress-value"),v.taxCheckbox=document.getElementById("project-tax"),v.linkedReservationBtn=document.getElementById("project-linked-reservation-btn"),v.submitBtn=v.form?.querySelector('[type="submit"]'),v.projectsTableBody=document.getElementById("project-table-body"),v.projectsCount=document.getElementById("projects-count"),v.projectsUpcoming=document.getElementById("projects-upcoming"),v.projectsExpenses=document.getElementById("projects-expenses"),v.projectsBudget=document.getElementById("projects-budget"),v.tableCount=document.getElementById("project-table-count"),v.search=document.getElementById("project-search"),v.detailsModalEl=document.getElementById("projectDetailsModal"),v.detailsBody=document.getElementById("project-details-body"),v.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),v.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),v.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),v.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),v.timeline=document.getElementById("project-timeline"),v.focusCards=document.getElementById("project-focus-cards"),v.detailsModalEl&&!v.detailsModalEl.dataset.projectListenerAttached&&(v.detailsModalEl.addEventListener("hidden.bs.modal",()=>{v.detailsBody&&(v.detailsBody.dataset.projectId="")}),v.detailsModalEl.dataset.projectListenerAttached="true")}function uk(){const e=lk();if(!e)return;const t=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...t,...n].forEach(([a,s])=>{document.querySelector(a)&&e(a,s)})}function SS(){["startDate","startTime","endDate","endTime"].forEach(e=>{const t=v[e];t&&(t._flatpickr?t._flatpickr.clear():t.value="")})}function mk(){const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ti()),e.dataset.listenerAttached="true")}function Da(e){if(!e?.start)return Number.NaN;const t=new Date(e.start).getTime();return Number.isFinite(t)?t:Number.NaN}function Yh(e){if(e?.createdAt){const n=new Date(e.createdAt).getTime();if(Number.isFinite(n))return n}const t=Da(e);return Number.isFinite(t)?t:Number.NEGATIVE_INFINITY}function Xh(e,t){if(!e)return"";const n=t&&/\d{1,2}:\d{2}/.test(t)?t:"00:00",[a="00",s="00"]=n.split(":"),r=a.padStart(2,"0"),i=s.padStart(2,"0");return`${e}T${r}:${i}`}function AS(e,t){const n=String(e||"");return n.length<=t?n:`${n.slice(0,Math.max(0,t-1))}…`}function Jh(e){if(!e||typeof e!="string")return{date:"",time:""};let t=e.trim();if(!t)return{date:"",time:""};if(t.includes(" ")&&(t=t.replace(" ","T")),!t.includes("T"))return{date:t,time:""};const[n,a=""]=t.split("T");return{date:n,time:a}}function Jl(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function gn(){if(!v.projectsTableBody)return;const e=z.filters.search,t=z.projects.filter(a=>{if(!e)return!0;const s=z.customers.find(i=>String(i.id)===String(a.clientId));return b([a.title,a.description,s?.customerName,a.clientCompany,Jl(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(e)});if(!t.length){const a=z.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",s=z.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",r=N(c(a,s));v.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${r}</td></tr>`,Gh(0),z.visibleProjects=[],Zh([]);return}const n=[...t].sort((a,s)=>new Date(s.start||0)-new Date(a.start||0));z.visibleProjects=n,Gh(n.length),v.projectsTableBody.innerHTML=n.map(a=>pk(a)).join(""),Zh(n),ka()}function pk(e){const t=z.customers.find(x=>String(x.id)===String(e.clientId)),n=t?.customerName||c("projects.fallback.unknownClient","عميل غير معروف"),a=(e.clientCompany||t?.companyName||"").trim(),s=e.technicians?.length||0,r=(e.equipment||[]).reduce((x,A)=>x+(A.qty||0),0),{expensesTotal:i,totalWithTax:o}=oo(e),d=Zl(e.id).length,m=c("projects.table.reservationsCount","{count} حجوزات").replace("{count}",b(String(d))),p=d?`<span class="badge rounded-pill project-reservations-chip">${N(m)}</span>`:"",h=`<span class="badge project-type-badge">${N(Jl(e.type))}</span>`,g=e.projectCode||`PRJ-${b(String(e.id))}`,y=`<span class="project-code-badge">#${N(g)}</span>`,S=St()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${e.id}">${N(c("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${e.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${N(e.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${y}
            ${h}
          </div>
        </div>
        ${p}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${N(n)}</span><small class="text-muted">${N(a)}</small></div>`:N(n)}
      </td>
      <td>${Yp(e.start,e.end)}</td>
      <td>${b(String(s))}</td>
      <td>${b(String(r))}</td>
      <td>${Qe(o)}</td>
      <td>${Qe(i)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${e.id}">${N(c("actions.view","عرض"))}</button>
        ${S}
      </td>
    </tr>
  `}function Yp(e,t){if(!e)return"—";const n=ua(e);return t?`${n} - ${ua(t)}`:n}function Zh(e){if(!v.timeline)return;const n=(Array.isArray(e)?e:z.visibleProjects.length?z.visibleProjects:z.projects).map(m=>{if(!m?.start)return null;const p=new Date(m.start);if(Number.isNaN(p.getTime()))return null;let f=m.end?new Date(m.end):new Date(p);return Number.isNaN(f.getTime())&&(f=new Date(p)),f<=p&&(f=new Date(p.getTime()+xh)),{project:m,startDate:p,endDate:f}}).filter(Boolean).sort((m,p)=>m.startDate-p.startDate);if(!n.length){const m=N(c("projects.timeline.empty",v.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));v.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${m}</div>`;return}const a=n[0].startDate.getTime(),s=Math.max(...n.map(m=>m.endDate.getTime()));let r=s-a;r<=0&&(r=xh);const i=fk(n),o=c("projects.timeline.range","{start} → {end}"),l=c("projects.timeline.conflict","Scheduling conflict"),d=n.map(m=>{const{project:p,startDate:f,endDate:h}=m,g=h.getTime()-f.getTime();let y=(f.getTime()-a)/r*100;y=Math.max(0,Math.min(y,100));let E=g/r*100;E=Math.max(E,2.5),y+E>100&&(E=Math.max(1.5,100-y));const x=`project-timeline__item--${Xp(p)}`,A=i.has(p.id),C=(p.title||"").trim()||c("projects.fallback.untitled","Untitled project"),j=AS(C,26),k=z.customers.find(K=>String(K.id)===String(p.clientId)),w=k?.customerName||c("projects.fallback.unknownClient","Unknown client"),_=(p.clientCompany||k?.companyName||"").trim(),$=Jl(p.type),q=ua(f.toISOString()),F=ua(h.toISOString()),U=o.replace("{start}",q).replace("{end}",F),L=_?`${w} (${_})`:w,B=`${C} • ${$} • ${L} | ${U}`,D=A?`<span class="project-timeline__item-conflict" title="${N(l)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${x}${A?" project-timeline__item--conflict":""}" style="left:${y}%;width:${E}%;" title="${N(B)}">
          <span class="project-timeline__item-label">${N(j)}</span>
          ${D}
        </div>
      `}).join(""),u=`
    <div class="project-timeline__scale">
      <span>${N(ua(new Date(a).toISOString()))}</span>
      <span>${N(ua(new Date(s).toISOString()))}</span>
    </div>
  `;v.timeline.innerHTML=`
    ${u}
    <div class="project-timeline__track">
      ${d}
    </div>
  `}function fk(e){const t=new Set;for(let n=0;n<e.length;n+=1)for(let a=n+1;a<e.length;a+=1){const s=e[n],r=e[a];s.startDate<r.endDate&&r.startDate<s.endDate&&(t.add(s.project.id),t.add(r.project.id))}return t}function ka(){if(!v.focusCards)return;const e=hk();if(!e.length){const t=N(c("projects.focus.empty",v.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));v.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${t}</div></div>`;return}v.focusCards.innerHTML=e.join("")}function hk(){if(!Array.isArray(z.projects)||!z.projects.length)return[];const e=z.projects.filter(ey),t=z.projects.filter(r=>!ey(r)&&gk(r)),n=[],a=new Set,s=(r,i)=>{!r||a.has(r.id)||n.length>=jd||(a.add(r.id),n.push(yk(r,i)))};if(e.sort((r,i)=>Da(r)-Da(i)).forEach(r=>s(r,"today")),t.sort((r,i)=>Da(r)-Da(i)).forEach(r=>s(r,"thisWeek")),n.length<jd){const r=Date.now();[...z.projects].filter(o=>!a.has(o.id)).filter(o=>{const l=Da(o);return Number.isFinite(l)&&l>=r}).sort((o,l)=>Da(o)-Da(l)).forEach(o=>s(o,"upcoming"))}return n.length<jd&&[...z.projects].filter(i=>!a.has(i.id)).sort((i,o)=>Yh(o)-Yh(i)).forEach(i=>s(i,"recent")),n}function yk(e,t){const n=z.customers.find(J=>String(J.id)===String(e.clientId)),a=n?.customerName||c("projects.fallback.unknownClient","عميل غير معروف"),s=(e.clientCompany||n?.companyName||"").trim(),r=Array.isArray(e.technicians)?e.technicians.length:0,i=Zl(e.id),o=i.length,l=ES(e),{subtotal:d,applyTax:u}=oo(e),m=(e.description||"").trim(),p=m?AS(m,110):c("projects.fallback.noDescription","لا يوجد وصف"),f=Jl(e.type),h=typeof e.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",g=["paid","partial"].includes(h)?h:"unpaid",y=c(`projects.paymentStatus.${g}`,g==="paid"?"Paid":g==="partial"?"Partially Paid":"Unpaid"),E=g==="paid"?"status-paid":g==="partial"?"status-partial":"status-unpaid",S=g==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",x=e.confirmed===!0||e.confirmed==="true",A=N(String(e.id)),C=e.projectCode||`PRJ-${b(String(e.id))}`,j=b(C),k={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},w={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},_=k[t]||k.recent,$=c(_,w[t]||w.recent),q=Xp(e),F=c(`projects.status.${q}`,iv[q]||q),U=uI[q]||"bg-secondary",L=(e.title||"").trim()||c("projects.fallback.untitled","Untitled project"),B=[S];x&&B.push("project-focus-card--confirmed");const D=i.reduce((J,re)=>{const ue=Jp(re),Pe=(re.items||[]).reduce((ye,te)=>ye+(Number(te?.qty)||1),0),Te=(re.technicians||[]).length;return{total:J.total+ue,equipment:J.equipment+Pe,crew:J.crew+Te}},{total:0,equipment:0,crew:0}),K=Number(D.total.toFixed(2)),Z=D.equipment,R=D.crew||r,M=u?Number(((d+K)*mi).toFixed(2)):0,H=Number((d+K+M).toFixed(2)),V=`<span class="project-code-badge project-focus-card__code">#${N(j)}</span>`,G=f?`<span class="badge project-focus-card__badge bg-primary">${N(f)}</span>`:"",ie=$?`<span class="project-focus-card__meta-tag">${N($)}</span>`:"",ee=`<span class="project-focus-card__status-chip ${U}">${N(F)}</span>`,oe=`<span class="reservation-chip ${E} project-focus-card__payment-chip">${N(y)}</span>`,W=(J,re,ue)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${J?`<span class="project-focus-card__row-icon">${N(J)}</span>`:""}
        ${N(re)}
      </span>
      <span class="project-focus-card__row-value">${N(String(ue))}</span>
    </div>
  `,be=[{icon:"👤",label:c("projects.details.client","العميل"),value:a},s?{icon:"🏢",label:c("projects.details.company","شركة العميل"),value:s}:null,{icon:"🏷️",label:c("projects.details.type","نوع المشروع"),value:f},{icon:"📅",label:c("projects.focus.summary.range","الفترة الزمنية"),value:Yp(e.start,e.end)}].filter(Boolean).map(({icon:J,label:re,value:ue})=>W(J,re,ue)).join(""),he=[{icon:"💳",label:c("projectCards.stats.paymentStatus","حالة الدفع"),value:y},{icon:"💸",label:c("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:Qe(l)},{icon:"🧮",label:c("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:Qe(H)}].map(({icon:J,label:re,value:ue})=>W(J,re,ue)).join(""),Se=[{icon:"🔗",label:c("projectCards.stats.reservationsShort","الحجوزات"),value:b(String(o))},{icon:"📦",label:c("projectCards.stats.equipmentCount","عدد المعدات"),value:b(String(Z))},{icon:"😎",label:c("projectCards.stats.crewCount","عدد الطاقم"),value:b(String(R))},{icon:"💵",label:c("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:Qe(K)}].map(({icon:J,label:re,value:ue})=>W(J,re,ue)).join(""),we=x?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${N(c("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${A}">${N(c("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`;return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${B.filter(Boolean).join(" ")}" data-project-id="${A}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${V}
          ${G}
          ${ie}
          ${ee}
          ${oe}
        </div>
        <h6 class="project-focus-card__title">${N(L)}</h6>
        <p class="project-focus-card__description">${N(p)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${N(c("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${be}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${N(c("projects.focus.summary.payment","الجانب المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${he}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${N(c("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${Se}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${we}
        </div>
      </article>
    </div>
  `}function ey(e){if(!e?.start)return!1;const t=new Date(e.start);if(Number.isNaN(t.getTime()))return!1;const n=new Date;return t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()}function gk(e){if(!e?.start)return!1;const t=new Date(e.start);if(Number.isNaN(t.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const s=a.getDay(),r=s===0?6:s-1;a.setDate(a.getDate()-r);const i=new Date(a);return i.setDate(i.getDate()+7),t>=a&&t<i}function Xp(e){const t=new Date,n=e.start?new Date(e.start):null,a=e.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function ES(e){return typeof e.expensesTotal=="number"?e.expensesTotal:Array.isArray(e.expenses)?e.expenses.reduce((t,n)=>t+(Number(n.amount)||0),0):0}function oo(e){const t=Number(e?.equipmentEstimate)||0,n=ES(e),a=t+n,s=e?.applyTax===!0||e?.applyTax==="true",r=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let o=(e?.discountType==="amount"?"amount":"percent")==="amount"?r:a*(r/100);(!Number.isFinite(o)||o<0)&&(o=0),o>a&&(o=a);const l=Math.max(0,a-o),d=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",u=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,m=d&&s&&u>0?u:0,p=m>0?Number((l*(m/100)).toFixed(2)):0,f=l+p;let h=s?f*mi:0;(!Number.isFinite(h)||h<0)&&(h=0),h=Number(h.toFixed(2));let g=s?Number(e?.totalWithTax):f;return s?(!Number.isFinite(g)||g<=0)&&(g=Number((f+h).toFixed(2))):g=f,{equipmentEstimate:t,expensesTotal:n,baseSubtotal:a,discountAmount:o,subtotalAfterDiscount:l,companyShareAmount:p,subtotal:f,applyTax:s,taxAmount:h,totalWithTax:g}}function _a(){const e=z.projects.length,t=z.projects.filter(s=>{const r=s.start?new Date(s.start):null;return!r||Number.isNaN(r.getTime())?!1:r>new Date}).length,n=z.projects.reduce((s,r)=>s+oo(r).expensesTotal,0),a=z.projects.reduce((s,r)=>s+oo(r).totalWithTax,0);v.projectsCount&&(v.projectsCount.textContent=b(String(e))),v.projectsUpcoming&&(v.projectsUpcoming.textContent=b(String(t))),v.projectsExpenses&&(v.projectsExpenses.textContent=Qe(n)),v.projectsBudget&&(v.projectsBudget.textContent=Qe(a))}function Zl(e){return e?z.reservations.filter(t=>String(t.projectId)===String(e)):[]}function Jp(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(b(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=Js(t,a,s,!1,i,{start:e.start,end:e.end});if(Number.isFinite(o))return o;const l=Number(b(String(e.cost??0)));return Number.isFinite(l)?Math.round(l):0}function bk(e,t,n=null){if(!e)return"";const a=e.reservationId||e.id||`RES-${t+1}`,s=e.status||e.state||"pending",r=c(`reservations.status.${s}`,s),i=String(s).toLowerCase(),l={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[i]||"project-reservation-card__badge--info",d=e.paid===!0||e.paid==="paid"||e.paidStatus==="paid",u=d?c("reservations.details.paid","مدفوع"):c("reservations.details.unpaid","غير مدفوع"),m=d?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",p=e.completed===!0||e.completed==="true",f=c("reservations.details.completed","مكتمل"),h=p?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${N(f)}</span>`:"",g=Yp(e.start,e.end),y=Jp(e),E=Qe(y),S=c("projects.details.reservations.items","{count} عناصر").replace("{count}",b(String((e.items||[]).length))),x=c("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",b(String((e.technicians||[]).length)));return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${t}" data-reservation-index="${t}" data-project-id="${n?n.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${N(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${l}">${N(r)}</span>
          <span class="project-reservation-card__badge ${m}">${N(u)}</span>
          ${h}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${N(g)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${N(E)}</span>
          <span>📦 ${N(S)}</span>
          <span>😎 ${N(x)}</span>
        </div>
      </div>
    </article>
  `}function vk(e){const t=Zl(e.id).map(r=>({reservation:r,index:z.reservations.findIndex(i=>i===r)})).filter(({index:r})=>Number.isInteger(r)&&r>=0).sort((r,i)=>{const o=r.reservation.start?new Date(r.reservation.start).getTime():0;return(i.reservation.start?new Date(i.reservation.start).getTime():0)-o}),n=c("projects.details.reservations.title","الحجوزات المرتبطة"),a=c("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),s=t.length?`<div class="project-reservations-list">${t.map(({reservation:r,index:i})=>bk(r,i,e)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${N(a)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${N(n)}</h6>
      </div>
      ${s}
    </section>
  `}async function wS(e){if(z.projects.findIndex(n=>String(n.id)===String(e))!==-1&&window.confirm(c("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await tS(e),await Lo(),await Zs(),z.projects=ir(),z.reservations=We(),gn(),_a(),ka(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),I(c("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=or(n)?n.message:c("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");I(a,"error")}}async function Sk(e,t){if(!e)return!1;const a=We().filter(l=>String(l.projectId)===String(e));if(!a.length)return!1;const s=typeof t=="string"?t.toLowerCase():"unpaid",r=s==="paid",i=r?"paid":s==="partial"?"partial":"unpaid";let o=!1;for(const l of a){const d=l.id??l.reservationId;if(!d)continue;const u=l.paid===!0||l.paid==="paid",m=l.paidStatus||l.paymentStatus||(u?"paid":"unpaid");u===r&&m===i||(await er(d,{paid_status:i,paid:r}),o=!0)}return o&&(z.reservations=We()),o}async function Ak(e){if(!e)return!1;const t=We(),n=z.projects.find(r=>String(r.id)===String(e))||(ae().projects||[]).find?.(r=>String(r.id)===String(e))||null,a=t.filter(r=>String(r.projectId)===String(e));if(!a.length)return!1;let s=!1;for(const r of a){const i=r.id??r.reservationId;if(!i)continue;const o=Vt({...r,projectId:e},n);if(o.effectiveConfirmed)continue;const l=n?.status??o.projectStatus??"confirmed";await er(i,{confirmed:!0,status:l}),s=!0}return s&&(z.reservations=We()),s}async function Yu(e,t){if(!e)return!1;const n=await Sk(e,t);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let Nd=!1;const ed="projects:create:draft",Ek="projects.html#projects-section";let rc=!1;function jS(e){return e?e instanceof HTMLElement?e:typeof e=="string"?document.getElementById(e):null:null}function Zp(e=v.companyShare){const t=jS(e);if(!t||t.checked!==!0)return null;const n=t.dataset.companyShare??t.value??Fe,a=b(String(n).replace("%","").trim()),s=Number.parseFloat(a);return!Number.isFinite(s)||s<=0?Fe:s}function Tn(e=v.companyShare,t=Fe){const n=jS(e);if(!n)return;const a=n.dataset.companyShare??n.value??t,s=b(String(a).replace("%","").trim());let r=Number.parseFloat(s);(!Number.isFinite(r)||r<=0)&&(r=t),n.dataset.companyShare=String(r),n.checked=!0}function zi(e){const t=v.taxCheckbox,n=v.companyShare;if(!t||!n||rc)return;rc=!0;const a=()=>{I(c("projects.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"))};if(e==="share")if(n.checked){if(t.disabled){n.checked=!1,a(),rc=!1;return}t.checked||(t.checked=!0),Tn(n)}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Tn(n):n.checked&&(n.checked=!1));rc=!1}function td({equipmentEstimate:e=0,expensesTotal:t=0,discountValue:n=0,discountType:a="percent",applyTax:s=!1,companyShareEnabled:r=!1,companySharePercent:i=null}={}){const o=Number(e)+Number(t),l=Number.isFinite(Number(n))?Number(n):0;let d=0;a==="amount"?d=l:d=o*(l/100),(!Number.isFinite(d)||d<0)&&(d=0),d>o&&(d=o);const u=Math.max(0,o-d),m=r&&s&&Number.isFinite(Number(i))&&Number(i)>0?Number(i):0,p=m>0?Number((u*(m/100)).toFixed(2)):0,f=u+p;let h=s?f*mi:0;(!Number.isFinite(h)||h<0)&&(h=0),h=Number(h.toFixed(2));const g=Number((f+h).toFixed(2));return{baseSubtotal:o,discountAmount:d,subtotalAfterDiscount:u,companyShareAmount:p,taxableAmount:f,taxAmount:h,totalWithTax:g}}function wk(){v.form&&!v.form.dataset.listenerAttached&&(v.form.addEventListener("submit",Rk),v.form.dataset.listenerAttached="true"),v.form&&!v.form.dataset.resetListenerAttached&&(v.form.addEventListener("reset",()=>{v.client&&(v.client.dataset.customerId=""),io(),SS(),v.type&&(v.type.value=""),Ls(null),TS(),IS()}),v.form.dataset.resetListenerAttached="true"),xk(),v.search&&!v.search.dataset.listenerAttached&&(v.search.addEventListener("input",()=>{z.filters.search=b(v.search.value||"").trim().toLowerCase(),gn()}),v.search.dataset.listenerAttached="true")}function IS(){tk(),z.editingProjectId=null,v.form&&(delete v.form.dataset.editingId,v.form.dataset.mode="create"),is(),v.expenseLabel&&(v.expenseLabel.value=""),v.expenseAmount&&(v.expenseAmount.value=""),v.taxCheckbox&&(v.taxCheckbox.checked=!1),v.discountType&&(v.discountType.value="percent"),v.discountValue&&(v.discountValue.value=""),v.companyShare&&(v.companyShare.checked=!1,v.companyShare.dataset.companyShare=String(Fe)),v.paymentStatus&&(v.paymentStatus.value="unpaid"),v.paymentStatus?.dataset&&delete v.paymentStatus.dataset.userSelected,v.paymentProgressType&&(v.paymentProgressType.value="percent"),v.paymentProgressValue&&(v.paymentProgressValue.value=""),nd(),co(),zi("tax")}function jk(){v.addTechnicianBtn&&v.addTechnicianBtn.dataset.listenerAttached!=="true"&&(v.addTechnicianBtn.addEventListener("click",Pk),v.addTechnicianBtn.dataset.listenerAttached="true"),v.addEquipmentBtn&&v.addEquipmentBtn.dataset.listenerAttached!=="true"&&(v.addEquipmentBtn.addEventListener("click",Lk),v.addEquipmentBtn.dataset.listenerAttached="true")}function Ik(){$d(v.technicianList,e=>{if(e.matches('[data-action="remove-technician"]')){const t=e.dataset.id;z.selectedTechnicians=z.selectedTechnicians.filter(n=>n!==t),xS()}}),$d(v.equipmentList,e=>{if(e.matches('[data-action="remove-equipment"]')){const t=e.dataset.id;z.selectedEquipment=z.selectedEquipment.filter(n=>n.barcode!==t),qS()}}),$d(v.expenseList,e=>{if(e.matches('[data-action="remove-expense"]')){const t=e.dataset.id;z.expenses=z.expenses.filter(n=>String(n.id)!==String(t)),kS(),_a()}})}function xk(){v.discountValue&&v.discountValue.dataset.listenerAttached!=="true"&&(v.discountValue.addEventListener("input",e=>{const t=e.target;t instanceof HTMLInputElement&&(t.value=b(t.value||""))}),v.discountValue.dataset.listenerAttached="true"),v.companyShare&&v.companyShare.dataset.listenerAttached!=="true"&&(v.companyShare.addEventListener("change",()=>{zi("share")}),v.companyShare.dataset.listenerAttached="true"),v.taxCheckbox&&v.taxCheckbox.dataset.projectListenerAttached!=="true"&&(v.taxCheckbox.addEventListener("change",()=>{zi("tax")}),v.taxCheckbox.dataset.projectListenerAttached="true"),v.paymentStatus&&v.paymentStatus.dataset.billingListenerAttached!=="true"&&(v.paymentStatus.addEventListener("change",()=>{v.paymentStatus.dataset.userSelected="true"}),v.paymentStatus.dataset.billingListenerAttached="true"),v.paymentProgressValue&&v.paymentProgressValue.dataset.listenerAttached!=="true"&&(v.paymentProgressValue.addEventListener("input",e=>{const t=e.target;t instanceof HTMLInputElement&&(t.value=b(t.value||""))}),v.paymentProgressValue.dataset.listenerAttached="true"),zi(v.companyShare?.checked?"share":"tax")}function qk(){v.addExpenseBtn&&v.addExpenseBtn.dataset.listenerAttached!=="true"&&(v.addExpenseBtn.addEventListener("click",Nk),v.addExpenseBtn.dataset.listenerAttached="true"),v.expenseAmount&&v.expenseAmount.dataset.normalizeAttached!=="true"&&(v.expenseAmount.addEventListener("input",e=>{const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.selectionStart,a=b(t.value||"");if(t.value=a,n!=null){const s=Math.min(a.length,n);t.setSelectionRange(s,s)}}),v.expenseAmount.dataset.normalizeAttached="true")}function $d(e,t){!e||e.dataset.listenerAttached==="true"||(e.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&t(a)}),e.dataset.listenerAttached="true")}function kk({onViewDetails:e}){!v.projectsTableBody||v.projectsTableBody.dataset.listenerAttached==="true"||(v.projectsTableBody.addEventListener("click",t=>{const n=t.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;e?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!St()){Nn();return}const a=n.dataset.id;wS(a)}}}),v.projectsTableBody.dataset.listenerAttached="true")}function _k(){const{customers:e}=ae();z.customers=Array.isArray(e)?e:[],is(),gn(),ka()}function Tk(){const{technicians:e}=ae();z.technicians=Array.isArray(e)?e:[],is(),gn(),ka()}function Ck(e){const{reservations:t}=ae();z.reservations=Array.isArray(t)?t:[],gn();const n=v.detailsModalEl&&v.detailsModalEl.classList.contains("show"),a=v.detailsBody?.dataset.projectId;n&&a&&z.projects.find(r=>String(r.id)===String(a))&&e?.(a)}function Pk(){const e=v.technicianSelect?.value;if(!e){I(c("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(z.selectedTechnicians.includes(e)){I(c("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}z.selectedTechnicians.push(e),is(),I(c("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function Lk(){const e=v.equipmentSelect?.value;if(!e){I(c("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const t=Math.max(1,parseInt(v.equipmentQty?.value||"1",10)||1),n=z.selectedEquipment.find(a=>a.barcode===e);n?n.qty+=t:z.selectedEquipment.push({barcode:e,qty:t}),is(),I(c("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function Nk(){const e=(v.expenseLabel?.value||"").trim(),t=b(v.expenseAmount?.value||"0"),n=Number(t);if(!e){I(c("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){I(c("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}z.expenses.push({id:Date.now(),label:e,amount:n}),v.expenseLabel&&(v.expenseLabel.value=""),v.expenseAmount&&(v.expenseAmount.value=b(String(t))),is(),_a()}function is(){xS(),qS(),kS(),nd()}function xS(){v.technicianList&&ef(v.technicianList,z.selectedTechnicians,e=>{const n=z.technicians.find(a=>String(a.id)===String(e))?.name||c("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${N(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${N(String(e))}" aria-label="${N(c("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function qS(){v.equipmentList&&ef(v.equipmentList,z.selectedEquipment,e=>{const t=z.equipment.find(s=>String(s.barcode||"")===String(e.barcode)),n=t?.desc||t?.description||t?.name||c("projects.fallback.unknownEquipment","معدة"),a=b(String(e.qty||1));return`
      <span class="chip">
        ${N(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${N(String(e.barcode))}" aria-label="${N(c("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function kS(){v.expenseList&&ef(v.expenseList,z.expenses,e=>`
      <div class="expense-item">
        <span>${N(e.label)}</span>
        <span>${Qe(e.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${N(String(e.id))}" aria-label="${N(c("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function ef(e,t,n){if(e){if(!t||t.length===0){const a=N(ak(e));e.innerHTML=`<span class="text-muted">${a}</span>`;return}e.innerHTML=t.map(a=>n(a)).join("")}}function nd(){if(!v.submitBtn)return;const e=!!z.editingProjectId,t=e?"projects.form.buttons.update":"projects.form.buttons.save",n=e?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";v.submitBtn.textContent=c(t,n)}function $k(){return z.expenses.reduce((e,t)=>e+(Number(t.amount)||0),0)}function ty(e){return b(String(e||"")).trim().toLowerCase()}function Dk(){if(!Array.isArray(z.selectedEquipment)||z.selectedEquipment.length===0)return{items:[],missing:[]};const e=new Map((z.equipment||[]).map(a=>[ty(a?.barcode),a])),t=[],n=[];return z.selectedEquipment.forEach(a=>{const s=ty(a?.barcode);if(!s){t.push(a?.barcode||"");return}const r=e.get(s);if(!r||r.id==null){t.push(a?.barcode||s);return}const i=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:r.id,qty:Number.isInteger(i)&&i>0?i:1})}),{items:n,missing:t}}function Bk(e){return!e||!Array.isArray(e.equipment)?[]:e.equipment.map(t=>{const n=t?.equipmentId??t?.equipment_id??t?.id??null,a=Number.parseInt(String(t?.qty??t?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function Fk(){return z.selectedEquipment.reduce((e,t)=>{const n=z.equipment.find(s=>String(s.barcode||"")===String(t.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return e+a*(t.qty||1)},0)}async function Rk(e){if(e.preventDefault(),Nd)return;const t=v.title?.value.trim(),n=v.type?.value||"",a=v.client?.value?.trim()||"",s=v.client?.dataset?.customerId||"",r=v.startDate?.value?.trim()||"",i=v.startTime?.value?.trim()||"";if(!t||!n||!r){I(c("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const o=ck(a,s);if(!o){I(c("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),v.client?.focus();return}const l=String(o.id);v.client&&(v.client.dataset.customerId=l,v.client.value=o.customerName||o.name||v.client.value),Ls(o);const d=v.endDate?.value?.trim()||"",u=v.endTime?.value?.trim()||"",m=pl(r,i),p=d?pl(d,u):"",f=new Date(m),h=p?new Date(p):null;if(h&&f>h){I(c("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}v.expenseAmount&&(v.expenseAmount.value=b(v.expenseAmount.value||""));const g=$k(),y=Fk(),E=v.taxCheckbox?.checked===!0,S=v.discountType?.value==="amount"?"amount":"percent",x=b(v.discountValue?.value||"0");let A=Number.parseFloat(x);(!Number.isFinite(A)||A<0)&&(A=0);const C=v.companyShare,j=C?.checked===!0;let k=j?Number.parseFloat(b(String(C.dataset.companyShare??C.value??Fe))):null;(!Number.isFinite(k)||k<=0)&&(k=j?Fe:null);const w=td({equipmentEstimate:y,expensesTotal:g,discountValue:A,discountType:S,applyTax:E,companyShareEnabled:j,companySharePercent:k}),_=v.paymentProgressType?.value==="amount"?"amount":"percent",$=b(v.paymentProgressValue?.value||""),q=$?Number.parseFloat($):null,F=en({totalAmount:w.totalWithTax,progressType:_,progressValue:q,history:[]}),U=v.paymentStatus?.dataset?.userSelected==="true",L=(v.paymentStatus?.value||"unpaid").toLowerCase(),B=["paid","partial"].includes(L)?L:"unpaid",D=fn({manualStatus:U?B:null,paidAmount:F.paidAmount,paidPercent:F.paidPercent,totalAmount:w.totalWithTax}),K=U?B:D;!U&&v.paymentStatus&&(v.paymentStatus.value=K),v.paymentStatus?.dataset&&delete v.paymentStatus.dataset.userSelected;const{items:Z,missing:R}=Dk();if(R.length){I(c("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const M=!!z.editingProjectId,H=M?z.projects.find(ee=>String(ee.id)===String(z.editingProjectId)):null;if(M&&!H){I(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const V=o.companyName||o.company||"",G=v.description?.value.trim()||"",ie=No({projectCode:H?.projectCode||(M?null:wg()),title:t,type:n,clientId:l,clientCompany:V,description:G,start:m,end:p||null,applyTax:E,paymentStatus:K,equipmentEstimate:y,expenses:z.expenses.map(ee=>({id:ee.id,label:ee.label,amount:ee.amount})),discount:A,discountType:S,companyShareEnabled:j&&E,companySharePercent:j&&E?k:null,companyShareAmount:w.companyShareAmount,taxAmount:w.taxAmount,totalWithTax:w.totalWithTax,confirmed:H?.confirmed??!1,technicians:z.selectedTechnicians,equipment:Z,paidAmount:F.paidAmount,paidPercentage:F.paidPercent,paymentProgressType:F.paymentProgressType,paymentProgressValue:F.paymentProgressValue});Nd=!0;try{let ee=H?.projectId??H?.id??null;if(M){const W=await hi(ee??z.editingProjectId,ie);ee=W?.projectId??W?.id??ee,await Yu(ee,K),I(c("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const W=await eS(ie);ee=W?.projectId??W?.id??null,await Yu(ee,K),I(c("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}await Vk(ee)||TS(),z.editingProjectId=null,v.form.reset(),IS(),SS(),io(),v.client&&(v.client.dataset.customerId=""),v.type&&(v.type.value=""),z.projects=ir(),z.reservations=We(),gn(),_a(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(ee){console.error("❌ [projects] handleSubmitProject failed",ee);const oe=or(ee)?ee.message:c("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");I(oe,"error")}finally{Nd=!1}}function pl(e,t){if(!e)return"";const n=t&&/\d{1,2}:\d{2}/.test(t)?t:"00:00",[a="00",s="00"]=n.split(":"),r=a.padStart(2,"0"),i=s.padStart(2,"0");return`${e}T${r}:${i}`}function ad(){if(typeof window>"u"||!window.sessionStorage)return null;const e=window.sessionStorage.getItem(ed);if(!e)return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch(t){return console.warn("⚠️ [projects] Failed to parse project form draft",t),null}}function _S(e){if(!(typeof window>"u"||!window.sessionStorage))try{window.sessionStorage.setItem(ed,JSON.stringify(e))}catch(t){console.warn("⚠️ [projects] Unable to persist project form draft",t)}}function TS(){typeof window>"u"||!window.sessionStorage||(window.sessionStorage.removeItem(ed),co())}function Mk(){const e=ad()||{};return{...e,type:v.type?.value||"",title:v.title?.value||"",client:v.client?.value||"",customerId:v.client?.dataset.customerId||"",clientCompany:v.clientCompany?.value||"",paymentStatus:v.paymentStatus?.value||"unpaid",taxChecked:v.taxCheckbox?.checked===!0,discountType:v.discountType?.value||"percent",discountValue:v.discountValue?.value||"",companyShareEnabled:v.companyShare?.checked===!0,companySharePercent:v.companyShare?.dataset.companyShare||v.companyShare?.value||String(Fe),paymentProgressType:v.paymentProgressType?.value||"percent",paymentProgressValue:v.paymentProgressValue?.value||"",startDate:v.startDate?.value||"",startTime:v.startTime?.value||"",endDate:v.endDate?.value||"",endTime:v.endTime?.value||"",description:v.description?.value||"",expenses:Array.isArray(z.expenses)?z.expenses.map(t=>({...t})):[],technicians:Array.isArray(z.selectedTechnicians)?[...z.selectedTechnicians]:[],equipment:Array.isArray(z.selectedEquipment)?z.selectedEquipment.map(t=>({...t})):[],linkedReservationIds:Array.isArray(e.linkedReservationIds)?[...e.linkedReservationIds]:[],savedAt:Date.now()}}function Hk(){const e=ad();return e?(v.type&&(v.type.value=e.type||""),v.title&&(v.title.value=e.title||""),v.client&&(v.client.value=e.client||"",v.client.dataset.customerId=e.customerId||""),v.clientCompany&&(v.clientCompany.value=e.clientCompany||""),v.paymentStatus&&e.paymentStatus&&(v.paymentStatus.value=e.paymentStatus),v.taxCheckbox&&(v.taxCheckbox.checked=e.taxChecked===!0),v.discountType&&e.discountType&&(v.discountType.value=e.discountType),v.discountValue&&(v.discountValue.value=e.discountValue||""),v.companyShare&&(e.companySharePercent?v.companyShare.dataset.companyShare=String(e.companySharePercent):v.companyShare.dataset.companyShare=String(Fe),v.companyShare.checked=e.companyShareEnabled===!0),v.paymentProgressType&&e.paymentProgressType&&(v.paymentProgressType.value=e.paymentProgressType),v.paymentProgressValue&&(v.paymentProgressValue.value=e.paymentProgressValue||""),v.startDate&&(v.startDate.value=e.startDate||""),v.startTime&&(v.startTime.value=e.startTime||""),v.endDate&&(v.endDate.value=e.endDate||""),v.endTime&&(v.endTime.value=e.endTime||""),v.description&&(v.description.value=e.description||""),z.expenses=Array.isArray(e.expenses)?e.expenses.map(t=>({...t})):[],z.selectedTechnicians=Array.isArray(e.technicians)?[...e.technicians]:[],z.selectedEquipment=Array.isArray(e.equipment)?e.equipment.map(t=>({...t})):[],zi("tax"),co(),!0):(co(),!1)}function zk(){!v.linkedReservationBtn||v.linkedReservationBtn.dataset.listenerAttached==="true"||(v.linkedReservationBtn.addEventListener("click",Ok),v.linkedReservationBtn.dataset.listenerAttached="true")}function Ok(e){e.preventDefault();const t=Mk();if(!(t.customerId&&t.customerId!==""||t.client&&t.client.trim())){I(c("projects.form.linkedReservation.missingClient","⚠️ يرجى اختيار العميل قبل إنشاء الحجز"));return}const a=t.startDate&&t.startTime,s=t.endDate&&t.endTime;if(!a||!s){I(c("projects.form.linkedReservation.missingSchedule","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إنشاء الحجز"));return}_S(t);const r=Uk(t);let i="";try{i=encodeURIComponent(JSON.stringify(r))}catch(l){console.warn("⚠️ [projects] Unable to encode reservation context",l)}Ft({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(l=>{console.warn("⚠️ [projects] Failed to persist dashboard preference before redirect",l)});const o=i?`?reservationProjectContext=${i}`:"";window.location.href=`dashboard.html${o}#reservations`}function Uk(e){const t=pl(e.startDate,e.startTime)||null,n=pl(e.endDate,e.endTime)||null;return{fromProjectForm:!0,draftStorageKey:ed,returnUrl:Ek,start:t,end:n,customerId:e.customerId||null,customerName:e.client||"",clientCompany:e.clientCompany||"",projectTitle:e.title||"",projectType:e.type||"",description:e.description||""}}async function Vk(e){if(!e)return;const t=ad(),n=Array.isArray(t?.linkedReservationIds)?t.linkedReservationIds:[];if(!n.length)return;const a=[];let s=!1;for(const i of n){const o=i!=null?String(i):"";if(o)try{await er(o,{project_id:e}),s=!0}catch(l){console.error("❌ [projects] Failed to link reservation to project",o,l),a.push(o)}}if(s)try{await Zs(),z.reservations=We(),document.dispatchEvent(new CustomEvent("reservations:changed"))}catch(i){console.warn("⚠️ [projects] Failed to refresh reservations after linking",i)}const r={linkedReservationIds:a,savedAt:Date.now()};return _S(r),a.length&&I(c("projects.toast.linkReservationFailed","⚠️ تعذر ربط بعض الحجوزات بالمشروع، يرجى التحقق يدويًا"),"error"),co(),a.length}function Kk(){const e=new Map,t=a=>{if(!a)return;[a.id,a.reservationId,a.reservation_id,a.reservation_code].map(r=>r!=null?String(r):"").filter(Boolean).forEach(r=>{e.has(r)||e.set(r,a)})};Array.isArray(z.reservations)&&z.reservations.forEach(t);const n=ae();return Array.isArray(n?.reservations)&&n.reservations.forEach(t),e}function Wk(e){if(!e||typeof e!="object")return"";const t=[e.name,e.full_name,e.fullName,e.technician_name,e.technicianName,e.label,e.displayName];for(const n of t)if(typeof n=="string"&&n.trim())return n.trim();return""}function Qk(e){if(!e)return[];const t=new Set;(Array.isArray(e.techniciansDetails)?e.techniciansDetails:[]).forEach(s=>{const r=Wk(s);r&&t.add(r)});const a=Array.isArray(e.technicians)?e.technicians:[];if(a.length){const s=Array.isArray(z.technicians)?z.technicians:[];a.forEach(r=>{const i=s.find(l=>String(l?.id)===String(r)),o=i?.name||i?.full_name||"";o&&t.add(String(o).trim())})}return Array.from(t)}function co(){const e=document.getElementById("project-linked-reservation-summary");if(!e)return;const t=ad(),n=v.linkedReservationBtn,a=Array.isArray(t?.linkedReservationIds)?Array.from(new Set(t.linkedReservationIds.map(i=>String(i)).filter(Boolean))):[];if(!a.length){e.dataset.state="empty",e.innerHTML=`<p class="project-linked-reservation__summary-empty">${N(c("projects.form.linkedReservation.empty","لم يتم إنشاء حجوزات مرتبطة بعد."))}</p>`,n&&(n.disabled=!1,n.classList.remove("btn-disabled"),n.removeAttribute("aria-disabled"),n.title="");return}const s=Kk(),r=a.map(i=>{const o=s.get(i);if(!o)return`
        <li class="project-linked-reservation__summary-item">
          <div class="project-linked-reservation__summary-item-title">#${N(b(i))}</div>
          <div class="project-linked-reservation__summary-item-meta">
            <span>${N(c("projects.form.linkedReservation.pendingItem","تم إنشاء حجز جديد وسيتم ربطه بعد حفظ المشروع."))}</span>
          </div>
        </li>`;const l=o.reservation_code||o.reservationId||o.id||i,d=`#${b(String(l))}`,u=Array.isArray(o.items)?o.items:[],m=u.reduce((x,A)=>x+(Number(A?.qty)||0),0)||u.length||0,p=Qk(o),h=(Array.isArray(o.technicians)?o.technicians:[]).length||p.length||0,g=Jp(o),y=[],E=c("projects.form.linkedReservation.meta.equipment","عدد المعدات: {count}").replace("{count}",b(String(m)));y.push(E);const S=c("projects.form.linkedReservation.meta.crew","عدد الفريق: {count}").replace("{count}",b(String(h)));if(y.push(S),p.length){const x=typeof Le=="function"&&Le()==="en"?", ":"، ",A=c("projects.form.linkedReservation.meta.crewNames","أسماء الفريق: {names}").replace("{names}",p.join(x));y.push(A)}if(Number.isFinite(g)){const x=c("projects.form.linkedReservation.meta.total","إجمالي الحجز: {amount}").replace("{amount}",Qe(g));y.push(x)}return`
      <li class="project-linked-reservation__summary-item">
        <div class="project-linked-reservation__summary-item-title">${N(d)}</div>
        <div class="project-linked-reservation__summary-item-meta">
          ${y.map(x=>`<span>${N(x)}</span>`).join("")}
        </div>
      </li>`}).join("");e.dataset.state="has-linked",e.innerHTML=`<ul class="project-linked-reservation__summary-list">${r}</ul>`,n&&(n.disabled=!0,n.classList.add("btn-disabled"),n.setAttribute("aria-disabled","true"),n.title=c("projects.form.linkedReservation.buttonDisabled","تم إنشاء حجز مرتبط لهذا المشروع. يمكنك تعديل الحجز بعد حفظ المشروع."))}let Dd={},ut={initialized:!1,currentId:null,modal:{el:null,body:null}};function Xu(e=""){return b(String(e)).trim().toLowerCase()}function CS(e,t,n){if(!t||!n)return;const{startDate:a,endDate:s}=sr(e);t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a||"",n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s||""}function ny(e,{endOfDay:t=!1}={}){if(!e)return null;const n=String(e).trim();if(!n)return null;const a=n.includes("T")?n:`${n}T00:00:00`,s=new Date(a);return Number.isNaN(s.getTime())?null:(t?s.setHours(23,59,59,999):s.setHours(0,0,0,0),s)}function Bd(e){const t=[e?.start,e?.start_datetime,e?.startDatetime,e?.startDate,e?.createdAt,e?.created_at];for(const n of t){if(!n)continue;const a=new Date(n);if(!Number.isNaN(a.getTime()))return a.setHours(0,0,0,0),a}return null}function sd(e){if(!document.getElementById("customer-reservations"))return;const n=document.getElementById("customer-search-reservation"),a=document.getElementById("customer-filter-start-date"),s=document.getElementById("customer-filter-end-date"),r=document.getElementById("customer-reservation-date-range"),i=document.getElementById("customer-reservation-status-filter"),o=document.getElementById("customer-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),s&&window.flatpickr(s,{dateFormat:"Y-m-d"}));const l=()=>{let u=b(a?.value||"").trim(),m=b(s?.value||"").trim(),p=r?.value||"";if(new Set(["","today","week","month"]).has(p)||(p="",r&&(r.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),u="",m=""),!u&&!m&&p){const{startDate:h,endDate:g}=sr(p);u=h,m=g}return{searchTerm:Xu(n?.value||""),startDate:u,endDate:m,status:i?.value||"",quickRange:p,customerId:e}},d=()=>{Dd=l(),Ln("customer-reservations",Dd)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=b(n.value),d()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{r&&(r.value=""),d()}),a.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{r&&(r.value=""),d()}),s.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{CS(r.value,a,s),d()}),r.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",d),i.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),r&&(r.value=""),i&&(i.value=""),d()}),o.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{Ln("customer-reservations",Dd)},d()}function Ro(e){ut.currentId=e;const{container:t}=lo();t&&(ut.initialized||(Gk(),Yk(),Jk(),document.addEventListener("projects:changed",()=>{ut.currentId&&En()}),document.addEventListener("language:changed",()=>{ut.currentId&&En()}),document.addEventListener("technicians:updated",()=>{ut.currentId&&En()}),ut.initialized=!0),En())}function lo(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Gk(){const{searchInput:e,statusSelect:t,clearBtn:n,startInput:a,endInput:s,rangeSelect:r}=lo();window.flatpickr&&(a&&!a.dataset.datepickerAttached&&(window.flatpickr(a,{dateFormat:"Y-m-d"}),a.dataset.datepickerAttached="true"),s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true")),e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=b(e.value),En()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{En()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.value=b(a.value),r&&(r.value=""),En()}),a.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=b(s.value),r&&(r.value=""),En()}),s.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{CS(r.value,a,s),En()}),r.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:i,statusSelect:o,startInput:l,endInput:d,rangeSelect:u}=lo();i&&(i.value=""),o&&(o.value=""),u&&(u.value=""),l&&(l._flatpickr&&l._flatpickr.clear(),l.value=""),d&&(d._flatpickr&&d._flatpickr.clear(),d.value=""),En()}),n.dataset.listenerAttached="true")}function Yk(){const{container:e}=lo();!e||e.dataset.projectModalListenerAttached==="true"||(e.addEventListener("click",Xk),e.dataset.projectModalListenerAttached="true")}function Xk(e){const t=e.target.closest(".project-focus-card");if(!t||e.target.closest("[data-ignore-project-modal]"))return;const a=t.dataset.projectId?String(t.dataset.projectId):"";a&&Ju(a)}function Jk(){tf()}function tf(){if(ut.modal?.el&&ut.modal?.body)return!0;const e=document.getElementById("projectDetailsModal"),t=document.getElementById("project-details-body");return!e||!t?!1:(ut.modal={el:e,body:t},!0)}function En(){const{container:e,searchInput:t,statusSelect:n,startInput:a,endInput:s,rangeSelect:r}=lo();if(!e||!ut.currentId)return;const i=Xu(t?.value||""),o=n?.value||"";let l=b(a?.value||"").trim(),d=b(s?.value||"").trim(),u=r?.value||"";if(new Set(["","today","week","month"]).has(u)||(u="",r&&(r.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),l="",d=""),!l&&!d&&u){const{startDate:k,endDate:w}=sr(u);l=k,d=w}const p=ny(l),f=ny(d,{endOfDay:!0}),{projects:h=[],technicians:g=[],reservations:y=[],customers:E=[]}=ae(),S=new Map(g.map(k=>[String(k.id),k])),x=Zk(y),A=E.find(k=>String(k.id)===String(ut.currentId))||null,j=h.filter(k=>String(k.clientId)===String(ut.currentId)).filter(k=>{if(i){const w=[k.id,k.projectId,k.project_id,k.projectCode,k.project_code].map($=>$==null?"":b(String($)));if(!Xu([k.title,k.description,k.notes,...w].filter(Boolean).join(" ")).includes(i))return!1}if(o&&xl(k)!==o)return!1;if(p||f){const w=Bd(k);if(!w||p&&w<p||f&&w>f)return!1}return!0}).sort((k,w)=>{const _=Bd(k)?.getTime()||0;return(Bd(w)?.getTime()||0)-_});if(!j.length){const k=c("customerProjects.empty",e.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");e.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${k}</div></div>`;return}e.innerHTML=j.map(k=>{const w=_n(k),_=w?x.get(w)||[]:[];return pS(k,{customer:A,techniciansMap:S,reservations:_})}).join("")}function Zk(e=[]){const t=new Map;return e.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const s=String(a);t.has(s)||t.set(s,[]),t.get(s).push(n)}),t}function Ju(e){const t=String(e||"").trim();if(!t||!tf())return;const n=ut.modal;if(!n?.body)return;n.body.dataset.mode="view";const{projects:a=[],reservations:s=[],customers:r=[]}=ae(),i=s_(a,t);if(!i||ut.currentId&&i.clientId!=null&&String(i.clientId)!==String(ut.currentId))return;const o=r.find(u=>String(u.id)===String(i.clientId))||null,l=s.filter(u=>{const m=r_(u);return m&&m===t}),d=fS(i,{customer:o,reservations:l});n.body.innerHTML=d,e_(i),t_(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function e_(e){if(!e||!ut.modal?.body)return;const t=ut.modal.body.querySelector('[data-action="edit-project"]');t&&t.addEventListener("click",n=>{n.preventDefault(),n_(e)})}function t_(e){if(!e)return;const t=e.querySelectorAll('[data-action="view-reservation"]');if(!t.length)return;async function n(a){if(!Number.isInteger(a)||a<0)return!1;const s=Yl("showReservationDetails");if(typeof s=="function")return s(a),!0;try{const r=await Dp("showReservationDetails");if(typeof r=="function")return r(a),!0}catch(r){console.warn("⚠️ [customerDetails] Unable to resolve reservation UI handler",r)}return!1}t.forEach(a=>{a.dataset.listenerAttached!=="true"&&(a.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();const r=We();let i=Number.parseInt(a.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const l=a.dataset.reservationId;l&&(i=r.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(p=>p!=null&&String(p)===l)))}await n(i)||I(c("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),a.dataset.listenerAttached="true")})}function n_(e){if(!e||!tf())return;const t=ut.modal;if(!t?.body)return;const{customers:n=[]}=ae(),a=n.find(i=>String(i.id)===String(e.clientId))||null,s=a?.customerName||e.clientName||e.customerName||"",r=e.clientCompany||a?.companyName||a?.company||"";t.body.dataset.mode="edit",t.body.innerHTML=yS(e,{clientName:s,clientCompany:r}),a_(e,{clientName:s,clientCompany:r})}function a_(e,{clientName:t="",clientCompany:n=""}={}){if(!e||!ut.modal?.body)return;const a=ut.modal.body,s=a.querySelector("#customer-project-edit-form")||a.querySelector("#project-details-edit-form");if(!s)return;const r=s.querySelector('[data-action="cancel-edit"]');r&&r.addEventListener("click",C=>{C.preventDefault();const j=_n(e);j&&Ju(j)});const i=s.querySelector("#project-edit-expense-label"),o=s.querySelector("#project-edit-expense-amount"),l=s.querySelector('[data-action="add-expense"]'),d=s.querySelector("#project-edit-expense-list");s.querySelector('[name="project-start-date"]'),s.querySelector('[name="project-start-time"]'),s.querySelector('[name="project-end-date"]'),s.querySelector('[name="project-end-time"]');const u=s.querySelector("#project-edit-payment-status"),m=s.querySelector("#project-edit-tax"),p=s.querySelector("#project-edit-company-share"),f=s.querySelector("#project-edit-discount-type"),h=s.querySelector("#project-edit-discount"),g=s.querySelector("#project-edit-payment-progress-type"),y=s.querySelector("#project-edit-payment-progress-value"),E={expenses:Array.isArray(e?.expenses)?e.expenses.map(C=>({...C})):[]};let S=!1;const x=C=>{!m||!p||S||(S=!0,C==="share"?p.checked?(m.checked||(m.checked=!0),Tn(p,Fe)):m.checked&&(m.checked=!1):C==="tax"&&(m.checked?Tn(p,Fe):p.checked&&(p.checked=!1)),S=!1)},A=()=>{d&&(d.innerHTML=Gp(E.expenses))};A(),l&&!l.dataset.listenerAttached&&(l.addEventListener("click",C=>{C.preventDefault();const j=i?.value.trim()||"",k=b(o?.value||"0"),w=Number(k);if(!j){I(c("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),i?.focus();return}if(!Number.isFinite(w)||w<=0){I(c("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),o?.focus();return}E.expenses.push({id:`expense-${e.id}-${Date.now()}`,label:j,amount:w}),i&&(i.value=""),o&&(o.value=""),A()}),l.dataset.listenerAttached="true"),d&&!d.dataset.listenerAttached&&(d.addEventListener("click",C=>{const j=C.target.closest('[data-action="remove-expense"]');if(!j)return;const{id:k}=j.dataset;E.expenses=E.expenses.filter(w=>String(w.id)!==String(k)),A()}),d.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("input",C=>{const j=C.target;j instanceof HTMLInputElement&&(j.value=b(j.value||""))}),h.dataset.listenerAttached="true"),y&&!y.dataset.listenerAttached&&(y.addEventListener("input",C=>{const j=C.target;j instanceof HTMLInputElement&&(j.value=b(j.value||""))}),y.dataset.listenerAttached="true"),u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true"}),u.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>x("share")),p.dataset.listenerAttached="true"),m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>x("tax")),m.dataset.listenerAttached="true"),p?.checked&&Tn(p,Fe),x(p?.checked?"share":"tax"),s.addEventListener("submit",async C=>{if(C.preventDefault(),s.dataset.submitting==="true")return;const j=new FormData(s),k=(j.get("project-title")||"").toString().trim(),w=(j.get("project-type")||"").toString().trim(),_=(j.get("project-start-date")||"").toString().trim(),$=(j.get("project-start-time")||"").toString().trim(),q=(j.get("project-end-date")||"").toString().trim(),F=(j.get("project-end-time")||"").toString().trim(),U=(j.get("project-description")||"").toString().trim(),L=(j.get("project-payment-status")||"unpaid").toString().toLowerCase(),B=["paid","partial"].includes(L)?L:"unpaid",D=m?.checked===!0;if(!k||!w||!_){I(c("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const K=ml(_,$),Z=q?ml(q,F):"";if(Z){const ye=new Date(K),te=new Date(Z);if(!Number.isNaN(ye.getTime())&&!Number.isNaN(te.getTime())&&ye>te){I(c("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const R=_n(e);if(!R){I(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const M=Number(e?.equipmentEstimate??e?.equipment_estimate??0)||0,H=E.expenses.reduce((ye,te)=>ye+(Number(te.amount)||0),0),V=f?.value==="amount"?"amount":"percent",G=b(h?.value||"0");let ie=Number.parseFloat(G);(!Number.isFinite(ie)||ie<0)&&(ie=0);const ee=p?.checked===!0;let oe=ee?Zp(p):null;(!Number.isFinite(oe)||oe<=0)&&(oe=ee&&D?Fe:null);const W=td({equipmentEstimate:M,expensesTotal:H,discountValue:ie,discountType:V,applyTax:D,companyShareEnabled:ee,companySharePercent:oe}),be=g?.value==="amount"?"amount":"percent",he=b(y?.value||""),Se=he?Number.parseFloat(he):null,we=en({totalAmount:W.totalWithTax,progressType:be,progressValue:Se,history:[]}),J=u?.dataset?.userSelected==="true",re=fn({manualStatus:J?B:null,paidAmount:we.paidAmount,paidPercent:we.paidPercent,totalAmount:W.totalWithTax}),ue=J?B:re;!J&&u&&(u.value=ue),u?.dataset&&delete u.dataset.userSelected;const Pe=No({projectCode:e.projectCode,title:k,type:w,clientId:e.clientId,clientCompany:n,description:U,start:K,end:Z||null,applyTax:D,paymentStatus:ue,equipmentEstimate:M,expenses:E.expenses,discount:ie,discountType:V,companyShareEnabled:ee&&D,companySharePercent:ee&&D?oe:null,companyShareAmount:W.companyShareAmount,taxAmount:W.taxAmount,totalWithTax:W.totalWithTax,confirmed:e.confirmed,technicians:Array.isArray(e?.technicians)?e.technicians:[],equipment:Array.isArray(e?.equipment)?e.equipment:[],paidAmount:we.paidAmount,paidPercentage:we.paidPercent,paymentProgressType:we.paymentProgressType,paymentProgressValue:we.paymentProgressValue}),Te=s.querySelector('button[type="submit"]');Te&&(Te.disabled=!0,Te.dataset.originalText=Te.textContent||"",Te.textContent=c("projects.details.edit.saving","جاري الحفظ...")),s.dataset.submitting="true";try{const ye=await hi(R,Pe);await bS(R,ue),document.dispatchEvent(new CustomEvent("projects:changed")),I(c("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),En();const te=_n(ye)||R;te&&Ju(te)}catch(ye){console.error("❌ [customerDetails] Failed to update project from customer modal",ye);const te=typeof ye?.message=="string"?ye.message:c("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");I(te,"error")}finally{delete s.dataset.submitting,Te&&(Te.disabled=!1,Te.dataset.originalText&&(Te.textContent=Te.dataset.originalText,delete Te.dataset.originalText))}})}function s_(e=[],t){const n=String(t);return e.find(a=>[a?.id,a?.projectId,a?.project_id].some(r=>r!=null&&String(r)===n))||null}function r_(e){if(!e)return null;const t=e.projectId??e.project_id??e.projectID??null;return t!=null?String(t):null}Gs();Rs();Ia();vo();Il();const ic=document.getElementById("logout-btn");ic&&!ic.dataset.listenerAttached&&(ic.addEventListener("click",()=>ti()),ic.dataset.listenerAttached="true");$p({showReservationDetails:Bo});const i_=new URLSearchParams(window.location.search),xt=i_.get("id"),vs=document.getElementById("customer-details"),ay=document.getElementById("customer-hero-name"),o_=document.getElementById("customer-hero-phone"),c_=document.getElementById("customer-hero-company"),l_=document.getElementById("customer-hero-email"),d_=document.getElementById("customer-hero-tax"),sy=document.getElementById("customer-hero-summary"),ry=document.getElementById("dashboard-greeting-customer-name"),iy=document.getElementById("dashboard-greeting-customer-company"),oc=document.getElementById("customer-stat-projects"),cc=document.getElementById("customer-stat-projects-desc"),lc=document.getElementById("customer-stat-payment"),dc=document.getElementById("customer-stat-payment-desc"),uc=document.getElementById("customer-stat-upcoming"),mc=document.getElementById("customer-stat-upcoming-desc"),Ii=document.getElementById("customer-stat-activity"),pc=document.getElementById("customer-stat-activity-desc"),fc=document.getElementById("customer-stat-compliance"),xi=document.getElementById("customer-stat-compliance-desc"),oy=document.getElementById("sidebar-stat-projects"),cy=document.getElementById("sidebar-stat-reservations"),ly=document.getElementById("sidebar-stat-equipment"),dy=document.getElementById("sidebar-stat-technicians"),nf=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),Zu=Array.from(document.querySelectorAll("[data-customer-tab]")),u_=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(e=>[e.getAttribute("data-customer-tab-panel"),e])),Va=document.getElementById("edit-document-file"),Ar=document.getElementById("edit-document-preview"),uy=document.getElementById("edit-document-file-name"),uo=document.getElementById("edit-document-url"),mo=document.getElementById("edit-document-name");let Jt=null,ia="idle",Ba=null;nf.forEach(e=>{e.disabled=!0});let Ie=null,Pi=!1,Fa="",af="reservations";function Fn(e=""){const t=document.createElement("div");return t.textContent=e==null?"":String(e),t.innerHTML}function m_(e=""){const t=Fn(e).replace(/\r/g,""),n=`
`;return t.includes(n)?t.split(n).join("<br>"):t}function p_(e=null){Ba=e&&typeof e=="object"?{...e}:null,Jt=null,ia="idle",Va&&(Va.value=""),yr()}function yr(){if(!uy||!Ar)return;const e=ia==="uploading",t=!!Jt?.dataUrl;let n=c("customers.form.document.empty","لم يتم اختيار ملف بعد");e?n=c("customers.form.document.uploading","📤 جارٍ رفع الملف..."):ia==="error"?n=c("customers.form.document.uploadFailed","⚠️ فشل رفع الملف"):t?n=Jt?.fileName||c("customers.form.document.selected","تم إرفاق ملف."):Ba&&(Ba.fileName||Ba.url)&&(n=Ba.fileName||Ba.url),uy.textContent=n;const a=t||!!Ba?.url;Ar.disabled=e||!a}function f_(){if(!Va)return;const[e]=Va.files||[];if(!e){ia="idle",Jt=null,yr();return}ia="uploading",yr();const t=new FileReader;t.onload=()=>{if(typeof t.result!="string"){ia="error",Jt=null,yr();return}Jt={dataUrl:t.result,fileName:e.name,mimeType:e.type,size:e.size},uo&&(uo.value=t.result),mo&&(mo.value=e.name),ia="success",yr()},t.onerror=()=>{ia="error",Jt=null,yr()},t.readAsDataURL(e)}Va&&!Va.dataset.listenerAttached&&(Va.addEventListener("change",f_),Va.dataset.listenerAttached="true");Ar&&!Ar.dataset.listenerAttached&&(Ar.addEventListener("click",()=>{if(ia==="uploading")return;const e=Jt?.dataUrl||Ba?.url;e&&window.open(e,"_blank","noopener,noreferrer")}),Ar.dataset.listenerAttached="true");function hc(e,t,n,{hideWhenEmpty:a=!1}={}){if(!e)return;const s=n==null?"":String(n).trim(),r=s.length>0,i=r?s:"—";e.textContent=`${t} ${i}`,a?e.classList.toggle("hidden",!r):e.classList.remove("hidden")}function em(e){const t=c("customerDetails.pageTitle","معلومات العميل"),n=e?.customerName||"—",a=e?.phone?b(e.phone):"",s=e?.companyName||"",r=e?.email||"",i=e?.tax_id??e?.taxId??"";if(ay&&(ay.textContent=n),sy&&(sy.textContent=n!=="—"?n:t),hc(o_,"📞",a,{hideWhenEmpty:!1}),hc(c_,"🏢",s,{hideWhenEmpty:!0}),hc(l_,"📧",r,{hideWhenEmpty:!0}),hc(d_,"🧾",i,{hideWhenEmpty:!0}),ry&&(ry.textContent=n),iy){const o=[];s&&o.push(s),a&&o.push(`📞 ${a}`);const l=typeof i=="string"?i.trim():String(i||"").trim();l&&o.push(`🧾 ${l}`),iy.textContent=o.length?o.join(" • "):"—"}}function h_(e){if(e?.preventDefault?.(),!Ie)return;k_();const t=document.getElementById("editCustomerModal"),n=typeof bootstrap<"u"?bootstrap.Modal:null;if(!t||!n)return;(n.getInstance(t)||new n(t)).show()}function y_(){nf.forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",h_),e.dataset.listenerAttached="true")})}function tm(e){nf.forEach(t=>{t&&(t.disabled=!!e)})}y_();function nm(e){e&&(af=e,Zu.forEach(t=>{const n=t?.getAttribute("data-customer-tab")===e;t&&(t.classList.toggle("tab-active",n),t.classList.toggle("active",n),t.setAttribute("aria-selected",String(n)))}),u_.forEach((t,n)=>{t&&t.classList.toggle("hidden",n!==e)}),e==="projects"&&xt&&Ie&&Ro(xt))}function g_(){Zu.length&&(Zu.forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=e.getAttribute("data-customer-tab");t&&nm(t)}),e.dataset.listenerAttached="true")}),nm(af))}g_();function PS(e={}){if(!e||typeof e!="object")return null;const t=[e.document,e.attachment,e.file].find(x=>x&&typeof x=="object"),n=x=>{for(const A of x)if(typeof A=="string"&&A.trim()!=="")return A.trim();return""},a=x=>{for(const A of x){if(typeof A=="number"&&Number.isFinite(A))return Math.max(0,Math.trunc(A));if(typeof A=="string"&&A.trim()!==""&&/^\d+$/.test(A.trim()))return Math.max(0,parseInt(A.trim(),10))}return null},s=[e.document_url,e.documentUrl,e.url,e.href,e.link,t?.url,t?.href,t?.link],r=[e.document_path,e.documentPath,e.path,t?.path,t?.documentPath],i=[e.document_file_name,e.documentFileName,e.document_name,e.fileName,e.filename,e.name,t?.fileName,t?.filename,t?.name],o=[e.document_mime_type,e.documentMimeType,e.document_type,e.mimeType,e.contentType,e.type,t?.mimeType,t?.contentType,t?.type],l=[e.document_size,e.documentSize,e.size,t?.size,t?.length],d=[t?.data,t?.base64,t?.content,e.data,e.base64,e.content,e.document_data],u=n(s),m=n(i),p=n(o)||"application/octet-stream",f=n(r),h=n(d),g=a(l);if(!u&&!h)return null;let y=u,E=h;if(!y&&E&&E.startsWith("data:")){const x=E.indexOf(",");x!==-1&&(y=E,E=E.slice(x+1))}!y&&E&&(y=`${E.startsWith("data:")?"":`data:${p};base64,`}${E}`);const S={url:y,fileName:m,mimeType:p,path:f,data:E||null,size:g};return S.url&&/sirv\.com/i.test(S.url)&&(S.source="sirv"),S}function b_(){return document.documentElement.getAttribute("lang")||"ar"}function oa(e){const t=Number(e)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(t)}catch{return String(t)}}function my(e){if(!e)return"—";const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"—";const a=b_()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(t)}catch{const r=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),o=t.getFullYear();return`${r}/${i}/${o}`}}function py(e){if(!e)return"";const t=e.trim().split(/\s+/),n=t.pop()||"";return`<span class="currency-amount">${t.join(" ")}</span> <span class="currency-unit currency-unit--sm">${n}</span>`}function fy(e,t){const n=c("customerDetails.stats.paymentPaid","المدفوع"),a=c("customerDetails.stats.paymentOutstandingLabel","المستحق");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${n}</span>
      ${py(e)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${a}</span>
      ${py(t)}
    </div>
  `}const hy={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},v_={reservation:"Reservation",project:"Project",customer:"Client record"};function Fd(e=[]){let t=null;return e.forEach(n=>{if(!n)return;const a=n instanceof Date?n:new Date(n);Number.isNaN(a.getTime())||(!t||a>t)&&(t=a)}),t}function S_(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function yy({projects:e=0,reservations:t=0,equipment:n=0,technicians:a=0}={}){oy&&(oy.textContent=oa(e)),cy&&(cy.textContent=oa(t)),ly&&(ly.textContent=oa(n)),dy&&(dy.textContent=oa(a))}function Za(){if(!Ie||!xt){const A=dt(0);if(oc&&(oc.textContent="0"),cc&&(cc.textContent=c("customerDetails.stats.projectsEmpty","لا توجد مشاريع مرتبطة بهذا العميل.")),lc&&(lc.innerHTML=fy(A,A)),dc){const C=c("customerDetails.stats.paymentBreakdown","مدفوع / مستحق"),j=c("customerDetails.stats.paymentOutstandingEmpty","لا توجد مبالغ مستحقة");dc.textContent=`${C} • ${j}`}uc&&(uc.textContent="0"),mc&&(mc.textContent=c("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),Ii&&(Ii.textContent="—"),pc&&(pc.textContent=c("customerDetails.stats.activityEmpty","لا يوجد نشاط حديث")),fc&&(fc.textContent="0%"),xi&&(xi.textContent=c("customerDetails.stats.complianceEmpty","لا توجد بيانات دفع كافية")),yy({projects:0,reservations:0,equipment:0,technicians:0});return}const e=ae(),n=(Array.isArray(e.reservations)?e.reservations:[]).filter(A=>A?[A.customerId,A.customer_id,A.customer?.id].some(j=>j!=null&&String(j)===String(xt)):!1),a=n.length,s=Date.now(),r=n.filter(A=>{const C=A?.start??A?.startDatetime??A?.start_datetime??A?.start_date;if(!C)return!1;const j=new Date(C);return Number.isNaN(j.getTime())?!1:j.getTime()>=s}),i=r.map(A=>A?.start??A?.startDatetime??A?.start_datetime).map(A=>new Date(A)).filter(A=>!Number.isNaN(A.getTime())).sort((A,C)=>A-C)[0]||null,l=(Array.isArray(e.projects)?e.projects:[]).filter(A=>A?[A.clientId,A.client_id,A.customer_id].some(j=>j!=null&&String(j)===String(xt)):!1),d=l.length,u=l.reduce((A,C)=>{if(!C)return A;const j=Kp(C)||{},k=Number(j.totalWithTax??j.subtotal??0)||0;return String(C?.paymentStatus??C?.status??"").toLowerCase()==="paid"?(A.paid+=k,A.paidCount+=1):A.outstanding+=k,A},{paid:0,outstanding:0,paidCount:0}),m=d>0?Math.round(u.paidCount/d*100):0,p=[];if(n.forEach(A=>{const C=Fd([A?.updatedAt,A?.updated_at,A?.end,A?.endDatetime,A?.end_datetime,A?.start,A?.startDatetime,A?.start_datetime,A?.createdAt,A?.created_at]);C&&p.push({date:C,type:"reservation"})}),l.forEach(A=>{const C=Fd([A?.updatedAt,A?.updated_at,A?.end,A?.end_datetime,A?.start,A?.start_datetime,A?.createdAt,A?.created_at]);C&&p.push({date:C,type:"project"})}),!p.length){const A=Fd([Ie?.updated_at,Ie?.updatedAt,Ie?.created_at,Ie?.createdAt]);A&&p.push({date:A,type:"customer"})}const f=p.reduce((A,C)=>A?C.date>A.date?C:A:C,null),h=f?.date??null,g=f?.type??null,y=n.reduce((A,C)=>Array.isArray(C?.items)?A+C.items.length:A,0),E=new Set;n.forEach(A=>{Array.isArray(A?.technicians)&&A.technicians.forEach(C=>{const j=C!=null?String(C):"";j&&E.add(j)}),Array.isArray(A?.techniciansDetails)&&A.techniciansDetails.forEach(C=>{const j=C?.id??C?.technician_id??C?.technicianId;j!=null&&E.add(String(j))})}),oc&&(oc.textContent=oa(d)),cc&&(cc.textContent=d>0?c("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل"):c("customerDetails.stats.projectsEmpty","لا توجد مشاريع مرتبطة بهذا العميل."));const S=dt(u.paid),x=dt(u.outstanding);if(lc&&(lc.innerHTML=fy(S,x)),dc){const A=c("customerDetails.stats.paymentBreakdown","مدفوع / مستحق"),C=u.outstanding>0?c("customerDetails.stats.paymentOutstanding","المتبقي: {amount}").replace("{amount}",x):c("customerDetails.stats.paymentAllSet","لا توجد مبالغ مستحقة");dc.textContent=`${A} • ${C}`}if(uc&&(uc.textContent=oa(r.length)),mc&&(mc.textContent=r.length>0&&i?c("customerDetails.stats.nextReservation","أقرب حجز: {date}").replace("{date}",my(i)):c("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),Ii)if(g){const A=c(`customerDetails.stats.activityType.${g}`,v_[g]||g);Ii.textContent=A}else Ii.textContent="—";if(pc&&(pc.textContent=h?c("customerDetails.stats.activityOn","بتاريخ {date}").replace("{date}",my(h)):c("customerDetails.stats.activityEmpty","لا يوجد نشاط حديث")),fc&&(fc.textContent=`${oa(m)}%`),xi)if(d>0){const A=m>=90?"excellent":m>=70?"good":m>=40?"average":"poor",C=A?c(`customerDetails.stats.complianceLabel.${A}`,hy[A]||hy.poor):"",j=c("customerDetails.stats.complianceProjects","مشاريع مدفوعة بالكامل: {count} من {total}").replace("{count}",oa(u.paidCount)).replace("{total}",oa(d));xi.textContent=C?`${C} • ${j}`:j}else xi.textContent=c("customerDetails.stats.complianceEmpty","لا توجد بيانات دفع كافية");yy({projects:d,reservations:a,equipment:y,technicians:E.size})}function A_(e){const{customers:t}=ae();if(!Array.isArray(t))return null;const n=t.find(i=>String(i.id)===String(e));if(!n)return null;const a=n.tax_id??n.taxId??"",s=typeof a=="string"?a.trim():String(a||"").trim(),r=n.document??PS(n);return{...n,tax_id:s,taxId:s,document:r}}function E_(e={}){if(!e||typeof e!="object")return null;const t=e.id??e.customerId??e.customer_id??null,n=e.full_name??e.customerName??e.name??"",a=e.tax_id??e.taxId??e.vat_number??e.vatNumber??e.taxNumber??"",s=typeof a=="string"?a.trim():String(a||"").trim(),r=PS(e);return t==null?null:{id:String(t),customerName:n,full_name:n,phone:e.phone??"",companyName:e.company??e.company_name??e.companyName??"",company:e.company??e.company_name??e.companyName??"",email:e.email??"",address:e.address??"",notes:e.notes??"",tax_id:s,taxId:s,document:r,created_at:e.created_at??e.createdAt??null,updated_at:e.updated_at??e.updatedAt??null}}function w_(e){if(!e)return;const t=ae(),n=Array.isArray(t.customers)?[...t.customers]:[],a=n.findIndex(s=>String(s.id)===String(e.id));a>=0?n[a]={...n[a],...e}:n.push(e),an({customers:n})}async function j_(){const{technicians:e}=ae();if(!(Array.isArray(e)&&e.length>0))try{const t=await pe("/technicians/"),n=Array.isArray(t?.data)?t.data.map(Ys):[];n.length>0&&an({technicians:n})}catch(t){console.warn("⚠️ Failed to load technicians list",t)}}async function I_(e){if(e)try{const t=new URLSearchParams({customer_id:String(e),limit:"200"}),n=await pe(`/reservations/?${t.toString()}`),a=Array.isArray(n?.data)?n.data.map(ii):[];an({reservations:a})}catch(t){console.warn("⚠️ Failed to load customer reservations",t)}}async function x_(e){if(e)try{const t=new URLSearchParams({client_id:String(e),limit:"200"}),n=await pe(`/projects/?${t.toString()}`),a=Array.isArray(n?.data)?n.data.map($o):[];an({projects:a})}catch(t){console.warn("⚠️ Failed to load customer projects",t)}}async function q_(e,{showSpinner:t=!1}={}){if(e){t?(Pi=!0,Fa="",Oa()):(Pi=!0,Fa="");try{const n=await pe(`/customers/?id=${encodeURIComponent(e)}`),a=n?.data??n,s=E_(a);if(!s)throw new Error("Invalid customer payload received from server");Ie=s,w_(s),Pi=!1,Fa="",Oa(),await j_(),await Promise.all([I_(s.id),x_(s.id)]),sd(s.id),Ro(s.id),Za()}catch(n){if(Pi=!1,n instanceof Ge&&n.status===404){Ie=null,Fa="",Oa();return}console.error("⚠️ Failed to load customer details",n);const a=c("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");Ie?(Fa="",I(a),Oa()):(Fa=`${a}${n?.message?` (${n.message})`:""}`,Oa())}}}function Oa(){if(!vs)return;if(nm(af),!Ie){if(em(null),tm(!0),Za(),Pi){vs.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(Fa){vs.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${Fn(Fa)}</div>
        </div>
      `;return}const n=c("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.");vs.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${Fn(n)}</div>
      </div>
    `;return}em(Ie),tm(!1);const t=[{key:"customerDetails.fields.name",fallback:"👤 الاسم:",value:Ie.customerName||"—"},{key:"customerDetails.fields.phone",fallback:"📞 الجوال:",value:Ie.phone?b(Ie.phone):"—"},{key:"customerDetails.fields.company",fallback:"🏢 الشركة:",value:Ie.companyName||"—"},{key:"customerDetails.fields.email",fallback:"📧 البريد:",value:Ie.email||"—"},{key:"customerDetails.fields.address",fallback:"📍 العنوان:",value:Ie.address||"—"},{key:"customerDetails.fields.taxId",fallback:"🧾 الرقم الضريبي:",value:Ie.tax_id??Ie.taxId??"—"},{key:"customerDetails.fields.notes",fallback:"📝 الملاحظات:",value:Ie.notes||"—",multiline:!0},{key:"customerDetails.fields.document",fallback:"📎 مستند العميل",value:Ie.document??null,type:"document"}].map(n=>{const a=c(n.key,n.fallback);if(n.type==="document"){const l=n.value;let d='<span class="text-base-content/50">—</span>';if(l&&typeof l=="object"){const u=l.fileName?.trim()||l.path?.trim()||l.url||"";if(l.url){const m=Fn(u||c("customerDetails.document.defaultName","المستند المرتبط")),p=S_(l.url),f=Fn(c("customerDetails.document.open","عرض المستند"));d=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${m}</span><a class="btn btn-outline btn-sm" href="${p}" target="_blank" rel="noopener noreferrer">${f}</a></div>`}else u&&(d=`<span class="text-base-content break-all">${Fn(u)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${n.key}">${Fn(a)}</span>
          <div class="mt-2">${d}</div>
        </article>
      `}const r=(n.value==null?"":String(n.value)).trim(),i=r.length>0?r:"—",o=n.multiline?m_(i):Fn(i);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${n.key}">${Fn(a)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${o}</p>
      </article>
    `}).join("");vs.innerHTML=t,Za()}function k_(){document.getElementById("edit-id").value=Ie?.id||"",document.getElementById("edit-name").value=Ie?.customerName||"",document.getElementById("edit-phone").value=b(Ie?.phone||""),document.getElementById("edit-company").value=Ie?.companyName||"",document.getElementById("edit-email").value=Ie?.email||"",document.getElementById("edit-address").value=Ie?.address||"",document.getElementById("edit-tax-id").value=b(Ie?.tax_id??Ie?.taxId??"");const e=Ie?.document??null;uo&&(uo.value=e?.url||""),mo&&(mo.value=e?.fileName||""),p_(e),document.getElementById("edit-notes").value=Ie?.notes||""}const yc=document.getElementById("save-edit-btn");yc&&!yc.dataset.listenerAttached&&(yc.addEventListener("click",()=>{if(!Ie)return;const e=document.getElementById("edit-id").value,t=document.getElementById("edit-name").value.trim(),n=b(document.getElementById("edit-phone").value.trim()),a=document.getElementById("edit-company").value.trim(),s=document.getElementById("edit-email").value.trim(),r=document.getElementById("edit-address").value.trim(),i=b(document.getElementById("edit-tax-id").value.trim()),o=(uo?.value||"").trim(),l=(mo?.value||"").trim(),d=document.getElementById("edit-notes").value.trim();if(!t||!n){I(c("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const u=ae(),m=Array.isArray(u.customers)?u.customers:[],p=m.findIndex(y=>String(y.id)===String(e));if(p===-1){I(c("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}const f=m[p]?.document??null;let h=f;Jt?.dataUrl?h={...f||{},url:Jt.dataUrl,fileName:l||Jt.fileName||f?.fileName||"",mimeType:Jt.mimeType||f?.mimeType,size:Jt.size??f?.size}:o?h={...f||{},url:o,fileName:l||f?.fileName||""}:l&&f?h={...f,fileName:l}:!o&&!l&&(h=f),m[p]={...m[p],customerName:t,phone:n,companyName:a,email:s,address:r,notes:d,tax_id:i,taxId:i,document:h},an({customers:m}),Ie=m[p],Oa(),sd(xt),Ro(xt),Za(),document.dispatchEvent(new CustomEvent("customers:changed")),I(c("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),yc.dataset.listenerAttached="true");async function __(){if(vs){if(!xt){em(null),tm(!0),Za(),vs.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${c("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}Ie=A_(xt),Ie&&(Oa(),sd(xt),Ro(xt),Za()),await q_(xt,{showSpinner:!Ie})}}__();const LS=()=>{!xt||!Ie||Za()};document.addEventListener("reservations:changed",LS);document.addEventListener("projects:changed",LS);document.addEventListener("language:changed",()=>{Oa(),xt&&Ie&&(sd(xt),Ro(xt),Za())});Zr({ar:{"technicianDetails.pageTitle":"معلومات عضو الطاقم","technicianDetails.title":"😎 بيانات عضو الطاقم","technicianDetails.actions.back":"⬅️ العودة","technicianDetails.actions.edit":"✏️ تعديل عضو الطاقم","technicianDetails.hero.subtitle":"راجع نشاط عضو الطاقم ومهامه الحالية.","technicianDetails.hero.helper":"استخدم هذه الصفحة لمتابعة حجوزات ومشاريع عضو الطاقم.","technicianTabs.reservations":"📅 حجوزات الفني","technicianTabs.projects":"📁 مشاريع الفني","technicianFinancial.stats.total":"💼 إجمالي المستحقات","technicianFinancial.stats.paid":"💰 المبالغ المدفوعة","technicianFinancial.stats.outstanding":"🧾 المبلغ المتبقي","technicianFinancial.stats.totalDesc":"مرتبطة بـ {count} مهام","technicianFinancial.stats.paidDesc":"تم تسجيل {count} دفعات","technicianFinancial.stats.outstandingDesc":"المتبقي {amount}","technicianFinancial.actions.viewDetails":"📊 عرض التفاصيل","technicianFinancial.modal.title":"📊 الملخص المالي للفني","technicianFinancial.modal.subtitle":"نظرة تفصيلية على مستحقات العضو والمدفوعات السابقة والحالية.","technicianFinancial.list.title":"تفاصيل الحجوزات والمشاريع","technicianFinancial.assignments.empty":"لا توجد حجوزات أو مشاريع مرتبطة لعرضها.","technicianFinancial.list.reservation":"الحجز / المشروع","technicianFinancial.list.period":"الفترة","technicianFinancial.list.due":"المستحق","technicianFinancial.list.status":"حالة الدفع","technicianFinancial.list.outstanding":"المتبقي","technicianFinancial.list.settled":"لا يوجد","technicianFinancial.list.reservationFallback":"حجز رقم {id}","technicianFinancial.list.projectReference":"مشروع #{id}","technicianFinancial.status.paid":"مدفوع","technicianFinancial.status.partial":"مدفوع جزئياً","technicianFinancial.status.unpaid":"غير مدفوع","technicianFinancial.payouts.title":"💸 سجل الدفعات الداخلية","technicianFinancial.payouts.helper":"سجّل المبالغ التي تم دفعها لهذا العضو من الشركة لضمان تتبع السداد.","technicianFinancial.payouts.empty":"لا توجد دفعات مسجلة بعد.","technicianFinancial.payouts.form.amount":"💰 المبلغ","technicianFinancial.payouts.form.date":"📅 تاريخ الدفع","technicianFinancial.payouts.form.note":"📝 ملاحظات (اختياري)","technicianFinancial.payouts.form.submit":"💸 تسجيل الدفعة","technicianFinancial.payouts.confirmDelete":"❌ هل تريد حذف هذه الدفعة؟","technicianFinancial.payouts.confirmTitle":"🗑️ حذف الدفعة","technicianFinancial.payouts.confirmMessage":"هل أنت متأكد من حذف هذه الدفعة؟ لا يمكن التراجع عن هذا الإجراء.","technicianFinancial.payouts.confirmCancel":"إلغاء","technicianFinancial.payouts.confirmAccept":"🗑️ حذف","technicianFinancial.payouts.toast.added":"✅ تم تسجيل الدفعة.","technicianFinancial.payouts.toast.removed":"🗑️ تم حذف الدفعة.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ أدخل قيمة صحيحة للمبلغ.","technicianFinancial.payouts.toast.failed":"⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ لا يمكن تحديد عضو الطاقم حالياً.","technicianDetails.filters.search":"🔍 ابحث باسم العميل أو اكتب رقم الحجز (مثل #123) أو المشروع...","technicianDetails.fields.role":"👔 الوظيفة:","technicianDetails.fields.department":"🧩 القسم:","technicianDetails.fields.phone":"📞 الجوال:","technicianDetails.fields.wage":"💰 الأجر اليومي:","technicianDetails.fields.total":"💼 التكلفة الإجمالية:","technicianDetails.fields.baseStatus":"⚙️ الحالة الأساسية:","technicianDetails.fields.notes":"📝 الملاحظات:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"غير محدد","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ لا يوجد معرف عضو طاقم في الرابط.","technicianDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العضو.","technicianDetails.errors.loadFailed":"❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.","technicianDetails.errors.reservationsLoadFailed":"❌ تعذر تحميل حجوزات هذا العضو حالياً.","technicianDetails.status.loading":"⏳ جارٍ تحميل بيانات عضو الطاقم...","technicianDetails.edit.modalTitle":"✏️ تعديل بيانات عضو الطاقم","technicians.picker.actions.apply":"تم","technicianProjects.title":"📁 مشاريع الفني","technicianReservations.title":"📅 حجوزات الفني","technicianProjects.empty":"لا توجد مشاريع مرتبطة بهذا العضو."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"😎 Crew Member Profile","technicianDetails.actions.back":"⬅️ Back","technicianDetails.actions.edit":"✏️ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew member’s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"📅 Technician Reservations","technicianTabs.projects":"📁 Technician Projects","technicianFinancial.stats.total":"💼 Total Due","technicianFinancial.stats.paid":"💰 Paid Amount","technicianFinancial.stats.outstanding":"🧾 Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"📊 View details","technicianFinancial.modal.title":"📊 Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"💸 Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"💰 Amount","technicianFinancial.payouts.form.date":"📅 Payment date","technicianFinancial.payouts.form.note":"📝 Notes (optional)","technicianFinancial.payouts.form.submit":"💸 Record payout","technicianFinancial.payouts.confirmDelete":"❌ Delete this payout?","technicianFinancial.payouts.confirmTitle":"🗑️ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"🗑️ Delete","technicianFinancial.payouts.toast.added":"✅ Payout logged successfully.","technicianFinancial.payouts.toast.removed":"🗑️ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"⚠️ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"⚠️ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"⚠️ Unable to determine the crew member right now.","technicianDetails.filters.search":"🔍 Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"👔 Role:","technicianDetails.fields.department":"🧩 Department:","technicianDetails.fields.phone":"📞 Phone:","technicianDetails.fields.wage":"💰 Daily Rate:","technicianDetails.fields.total":"💼 Total Charge:","technicianDetails.fields.baseStatus":"⚙️ Base Status:","technicianDetails.fields.notes":"📝 Notes:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"⚠️ Crew member not found.","technicianDetails.errors.loadFailed":"❌ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"❌ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"⏳ Loading crew member details...","technicianDetails.edit.modalTitle":"✏️ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"📁 Technician Projects","technicianReservations.title":"📅 Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let Rd={},ct={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},gy=!1;function am(e=""){return b(String(e)).replace(/[٬،]/g,"").trim().toLowerCase()}function NS(e,t,n){if(!t||!n)return;const{startDate:a,endDate:s}=sr(e);t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a||"",n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s||""}function Ua(e){if(!Array.isArray(e))return[];const t=new Set;return e.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||t.has(n)?!1:(t.add(n),!0))}async function $S(e){const t=document.getElementById("technician-reservations");if(!t)return;if(!gy){try{await pi({suppressError:!1,force:!0})}catch(u){console.error("❌ [technician-details] Failed to hydrate reservations list",u),t.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${c("technicianDetails.errors.reservationsLoadFailed","❌ تعذر تحميل حجوزات هذا العضو حالياً.")}</p>`;return}gy=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),s=document.getElementById("technician-filter-end-date"),r=document.getElementById("technician-reservation-date-range"),i=document.getElementById("technician-reservation-status-filter"),o=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),s&&window.flatpickr(s,{dateFormat:"Y-m-d"}));const l=()=>{let u=b(a?.value||"").trim(),m=b(s?.value||"").trim(),p=r?.value||"";if(new Set(["","today","week","month"]).has(p)||(p="",r&&(r.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),u="",m=""),!u&&!m&&p){const{startDate:g,endDate:y}=sr(p);u=g,m=y}return{searchTerm:am(n?.value||""),startDate:u,endDate:m,status:i?.value||"",quickRange:p,technicianId:e}},d=()=>{Rd=l(),Ln("technician-reservations",Rd)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=b(n.value),d()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{r&&(r.value=""),d()}),a.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{r&&(r.value=""),d()}),s.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{NS(r.value,a,s),d()}),r.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",d),i.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),r&&(r.value=""),i&&(i.value=""),d()}),o.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{Ln("technician-reservations",Rd)},d()}function DS(e){ct.currentId=e;const{container:t}=Gr();t&&(ct.initialized||(T_(),C_(),N_(),document.addEventListener("projects:changed",()=>{ct.currentId&&ln()}),document.addEventListener("language:changed",()=>{ct.currentId&&ln()}),document.addEventListener("customers:changed",()=>{ct.currentId&&ln()}),document.addEventListener("technicians:updated",()=>{ct.currentId&&ln()}),ct.initialized=!0),ln())}function Gr(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function T_(){const{searchInput:e,statusSelect:t,clearBtn:n,startInput:a,endInput:s,rangeSelect:r}=Gr();e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=b(e.value),ln()}),e.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{r&&(r.value=""),ln()}),a.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(s,{dateFormat:"Y-m-d"}),s.addEventListener("change",()=>{r&&(r.value=""),ln()}),s.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{NS(r.value,a,s),ln()}),r.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{ln()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:i,statusSelect:o,startInput:l,endInput:d,rangeSelect:u}=Gr();i&&(i.value=""),o&&(o.value=""),l&&(l._flatpickr&&l._flatpickr.clear(),l.value=""),d&&(d._flatpickr&&d._flatpickr.clear(),d.value=""),u&&(u.value=""),ln()}),n.dataset.listenerAttached="true")}function C_(){const{container:e}=Gr();!e||e.dataset.projectModalListenerAttached==="true"||(e.addEventListener("click",L_),e.dataset.projectModalListenerAttached="true")}function P_(){const{container:e}=Gr();e&&e.querySelectorAll(".project-focus-card").forEach(t=>{t.dataset.technicianModalListenerAttached!=="true"&&(t.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const s=t.dataset.projectId?String(t.dataset.projectId):"";s&&fl(s)}),t.dataset.technicianModalListenerAttached="true")})}function L_(e){const t=e.target.closest(".project-focus-card");if(!t||(console.debug("[technician] card click",t.dataset.projectId),!t)||e.target.closest("[data-ignore-project-modal]"))return;const a=t.dataset.projectId?String(t.dataset.projectId):"";a&&fl(a)}function N_(){sf()}function sf(){if(ct.modal?.el&&ct.modal?.body)return!0;const e=document.getElementById("projectDetailsModal"),t=document.getElementById("project-details-body");return!e||!t?!1:(ct.modal={el:e,body:t},!0)}function ln(){const{container:e,searchInput:t,statusSelect:n,startInput:a,endInput:s}=Gr();if(!e||!ct.currentId)return;const r=am(t?.value||""),i=n?.value||"",o=a?.value||"",l=s?.value||"",d=o?new Date(`${o}T00:00:00`):null,u=l?new Date(`${l}T23:59:59`):null,{projects:m=[],customers:p=[],technicians:f=[],reservations:h=[]}=ae(),g=new Map(p.map(w=>[String(w.id),w])),y=new Map(f.map(w=>[String(w.id),w])),E=new Map(m.map(w=>[String(w.id),w])),S=$_(h),x=String(ct.currentId),A=new Map,C=(w,_=null)=>{if(!w)return;const $=w.id!=null?String(w.id):w.projectId!=null?String(w.projectId):null;if($&&!A.has($)){const q=_??Ua(w?.technicians);A.set($,{...w,technicians:q})}};m.forEach(w=>{const _=Ua(w?.technicians);_.length&&_.includes(x)&&C({...w,technicians:_},_)}),h.forEach(w=>{if(!w?.projectId)return;const _=Ua(w.technicians);if(!_.includes(x))return;const $=String(w.projectId),q=A.get($),F=E.get($),{effectiveConfirmed:U}=Vt(w,F??q??null);if(q){const L=Ua(q.technicians),B=Array.from(new Set([...L,..._]));A.set($,{...q,technicians:B,confirmed:q.confirmed||U});return}if(F){const L=Ua(F?.technicians),B=Array.from(new Set([...L,..._]));C({...F,technicians:B,confirmed:Vt(w,F).effectiveConfirmed},B);return}C({id:$,title:w.projectTitle||w.title||w.project_title||`#${$}`,description:w.notes||"",start:w.projectStart||w.start||null,end:w.projectEnd||w.end||null,technicians:_,clientId:w.projectClientId??w.customerId??null,confirmed:U,status:w.status??null,equipmentEstimate:w.totalAmount??w.total_amount??0,createdAt:w.start??w.created_at??null},_)});const j=Array.from(A.values());ct.projectsMap=A,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:A,keys:()=>Array.from(A.keys())}});const k=j.filter(w=>{if(r){const _=g.get(String(w.clientId))?.customerName||"",$=[w.id,w.projectId,w.project_id,w.projectCode,w.project_code,w.reference,w.reference_code,w.code,_n(w)];if(!am([w.title,w.description,_,$.filter(F=>F!=null&&F!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(r))return!1}if(i&&M_(w)!==i)return!1;if(d||u){const _=w.start||w.createdAt||w.created_at||null,$=w.end||w.projectEnd||w.project_end||null,q=_?new Date(_):null,F=$?new Date($):q;if(d&&q&&q<d||u&&F&&F>u)return!1}return!0}).sort((w,_)=>{const $=new Date(w.start||w.createdAt||0).getTime();return new Date(_.start||_.createdAt||0).getTime()-$});if(!k.length){const w=c("technicianProjects.empty",e.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العضو.");e.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${w}</div></div>`;return}e.innerHTML=k.map(w=>{const _=_n(w),$=_?S.get(_)||[]:[],q=g.get(String(w.clientId))||null;return pS(w,{customer:q,techniciansMap:y,reservations:$})}).join(""),P_()}function $_(e=[]){const t=new Map;return e.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const s=String(a);t.has(s)||t.set(s,[]),t.get(s).push(n)}),t}function fl(e){const t=String(e||"").trim();if(console.debug("[technician] open details",t),!t||!sf())return;const n=ct.modal;if(!n?.body)return;const{projects:a=[],reservations:s=[],customers:r=[]}=ae(),i=ct.projectsMap?.get(t)||null;let o=i??by(a,t);if(o||(o=by(a,t)),!o)return;const l=String(ct.currentId||"");let d=Ua(o.technicians);if(!d.length&&i&&(d=Ua(i.technicians),o={...i,...o}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:t,activeTechnicianId:l,normalizedTechnicians:d}}}),l&&!d.includes(l)){console.debug("[technician] open details skipped (technician not in project)",{normalizedId:t,activeTechnicianId:l,normalizedTechnicians:d});return}o={...o,technicians:d};const u=r.find(p=>String(p.id)===String(o.clientId))||null,m=s.filter(p=>{const f=gS(p);return f&&f===t});n.body.dataset.mode="view",n.body.innerHTML=fS(o,{customer:u,reservations:m}),D_(o),B_(n.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(n.el).show():(n.el.classList.add("show"),n.el.style.display="block")}function D_(e){if(!e||!ct.modal?.body)return;const t=ct.modal.body.querySelector('[data-action="edit-project"]');t&&t.addEventListener("click",n=>{n.preventDefault(),F_(e)})}function B_(e){if(!e)return;const t=e.querySelectorAll('[data-action="view-reservation"]');if(!t.length)return;async function n(a){if(!Number.isInteger(a)||a<0)return!1;const s=Yl("showReservationDetails");if(typeof s=="function")return s(a),!0;try{const r=await Dp("showReservationDetails");if(typeof r=="function")return r(a),!0}catch(r){console.warn("⚠️ [technicianDetails] Unable to resolve reservation UI handler",r)}return!1}t.forEach(a=>{a.dataset.listenerAttached!=="true"&&(a.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();const r=We();let i=Number.parseInt(a.dataset.index||"",10);if(!Number.isInteger(i)||i<0){const l=a.dataset.reservationId;l&&(i=r.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(p=>p!=null&&String(p)===l)))}await n(i)||I(c("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),a.dataset.listenerAttached="true")})}function F_(e){if(!e||!sf())return;const t=ct.modal;if(!t?.body)return;const{customers:n=[]}=ae(),a=n.find(o=>String(o.id)===String(e.clientId))||null,s=a?.customerName||e.clientName||e.customerName||"",r=e.clientCompany||a?.companyName||a?.company||"",i=Array.isArray(e?.expenses)?e.expenses.map((o,l)=>({id:o?.id||`expense-${e.id}-${l}-${Date.now()}`,label:o?.label||"",amount:Number(o?.amount)||0})):[];t.body.dataset.mode="edit",t.body.innerHTML=yS(e,{clientName:s,clientCompany:r}),R_(e,{clientName:s,clientCompany:r,expenses:i})}function R_(e,{clientName:t="",clientCompany:n="",expenses:a=[]}={}){const s=ct.modal?.body;if(!e||!s)return;const r=s.querySelector("#project-details-edit-form");if(!r)return;const i={clientCompany:n,expenses:Array.isArray(a)?[...a]:[]},o=r.querySelector('[data-action="cancel-edit"]');o&&o.addEventListener("click",$=>{$.preventDefault(),fl(e.id)});const l=r.querySelector("#project-edit-expense-label"),d=r.querySelector("#project-edit-expense-amount"),u=r.querySelector('[data-action="add-expense"]'),m=r.querySelector("#project-edit-expense-list"),p=r.querySelector('[name="project-start-date"]'),f=r.querySelector('[name="project-start-time"]'),h=r.querySelector('[name="project-end-date"]'),g=r.querySelector('[name="project-end-time"]'),y=r.querySelector("#project-edit-payment-status"),E=r.querySelector("#project-edit-tax"),S=r.querySelector("#project-edit-company-share"),x=r.querySelector("#project-edit-discount-type"),A=r.querySelector("#project-edit-discount"),C=r.querySelector("#project-edit-payment-progress-type"),j=r.querySelector("#project-edit-payment-progress-value");let k=!1;const w=$=>{!E||!S||k||(k=!0,$==="share"?S.checked?(E.checked||(E.checked=!0),Tn(S,Fe)):E.checked&&(E.checked=!1):$==="tax"&&(E.checked?Tn(S,Fe):S.checked&&(S.checked=!1)),k=!1)},_=()=>{m&&(m.innerHTML=Gp(i.expenses))};_(),u&&!u.dataset.listenerAttached&&(u.addEventListener("click",$=>{$.preventDefault();const q=l?.value.trim()||"",F=b(d?.value||"0"),U=Number(F);if(!q){I(c("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),l?.focus();return}if(!Number.isFinite(U)||U<=0){I(c("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),d?.focus();return}i.expenses.push({id:`expense-${e.id}-${Date.now()}`,label:q,amount:U}),l&&(l.value=""),d&&(d.value=""),_()}),u.dataset.listenerAttached="true"),m&&!m.dataset.listenerAttached&&(m.addEventListener("click",$=>{const q=$.target.closest('[data-action="remove-expense"]');if(!q)return;const{id:F}=q.dataset;i.expenses=i.expenses.filter(U=>String(U.id)!==String(F)),_()}),m.dataset.listenerAttached="true"),A&&!A.dataset.listenerAttached&&(A.addEventListener("input",$=>{const q=$.target;q instanceof HTMLInputElement&&(q.value=b(q.value||""))}),A.dataset.listenerAttached="true"),j&&!j.dataset.listenerAttached&&(j.addEventListener("input",$=>{const q=$.target;q instanceof HTMLInputElement&&(q.value=b(q.value||""))}),j.dataset.listenerAttached="true"),y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>{y.dataset.userSelected="true"}),y.dataset.listenerAttached="true"),S&&!S.dataset.listenerAttached&&(S.addEventListener("change",()=>w("share")),S.dataset.listenerAttached="true"),E&&!E.dataset.listenerAttached&&(E.addEventListener("change",()=>w("tax")),E.dataset.listenerAttached="true"),S?.checked&&Tn(S,Fe),w(S?.checked?"share":"tax"),r.addEventListener("submit",async $=>{if($.preventDefault(),r.dataset.submitting==="true")return;const q=r.querySelector('[name="project-title"]'),F=r.querySelector('[name="project-type"]'),U=r.querySelector('[name="project-description"]'),L=q?.value.trim()||"",B=F?.value||"",D=p?.value.trim()||"",K=f?.value.trim()||"",Z=U?.value.trim()||"",R=y?.value?.toLowerCase()||"unpaid",M=["paid","partial"].includes(R)?R:"unpaid",H=E?.checked===!0;if(!L||!B||!D){I(c("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),q?.focus();return}const V=h?.value.trim()||"",G=g?.value.trim()||"",ie=ml(D,K),ee=V?ml(V,G):"";if(ee){const fe=new Date(ie),qe=new Date(ee);if(!Number.isNaN(fe.getTime())&&!Number.isNaN(qe.getTime())&&fe>qe){I(c("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),h?.focus();return}}const oe=_n(e);if(!oe){I(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const W=Number(e?.equipmentEstimate??e?.equipment_estimate??0)||0,be=i.expenses.reduce((fe,qe)=>fe+(Number(qe.amount)||0),0),he=x?.value==="amount"?"amount":"percent",Se=b(A?.value||"0");let we=Number.parseFloat(Se);(!Number.isFinite(we)||we<0)&&(we=0);const J=S?.checked===!0;let re=J?Zp(S):null;(!Number.isFinite(re)||re<=0)&&(re=J&&H?Fe:null);const ue=td({equipmentEstimate:W,expensesTotal:be,discountValue:we,discountType:he,applyTax:H,companyShareEnabled:J,companySharePercent:re}),Pe=C?.value==="amount"?"amount":"percent",Te=b(j?.value||""),ye=Te?Number.parseFloat(Te):null,te=en({totalAmount:ue.totalWithTax,progressType:Pe,progressValue:ye,history:[]}),Ce=y?.dataset?.userSelected==="true",X=fn({manualStatus:Ce?M:null,paidAmount:te.paidAmount,paidPercent:te.paidPercent,totalAmount:ue.totalWithTax}),Ae=Ce?M:X;!Ce&&y&&(y.value=Ae),y?.dataset&&delete y.dataset.userSelected;const Ne=No({projectCode:e.projectCode,title:L,type:B,clientId:e.clientId,clientCompany:i.clientCompany,description:Z,start:ie,end:ee||null,applyTax:H,paymentStatus:Ae,equipmentEstimate:W,expenses:i.expenses,discount:we,discountType:he,companyShareEnabled:J&&H,companySharePercent:J&&H?re:null,companyShareAmount:ue.companyShareAmount,taxAmount:ue.taxAmount,totalWithTax:ue.totalWithTax,confirmed:e.confirmed,technicians:Array.isArray(e?.technicians)?e.technicians:[],equipment:Array.isArray(e?.equipment)?e.equipment:[],paidAmount:te.paidAmount,paidPercentage:te.paidPercent,paymentProgressType:te.paymentProgressType,paymentProgressValue:te.paymentProgressValue}),je=r.querySelector('button[type="submit"]');je&&(je.disabled=!0,je.dataset.originalText=je.textContent||"",je.textContent=c("projects.details.edit.saving","جاري الحفظ...")),r.dataset.submitting="true";try{const fe=await hi(oe,Ne);await bS(oe,Ae),document.dispatchEvent(new CustomEvent("projects:changed")),I(c("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),ln();const qe=_n(fe)||oe;qe&&fl(qe)}catch(fe){console.error("❌ [technicianDetails] Failed to update project from modal",fe);const qe=typeof fe?.message=="string"?fe.message:c("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");I(qe,"error")}finally{delete r.dataset.submitting,je&&(je.disabled=!1,je.dataset.originalText&&(je.textContent=je.dataset.originalText,delete je.dataset.originalText))}})}function by(e=[],t){const n=String(t);return e.find(a=>[a?.id,a?.projectId,a?.project_id].some(r=>r!=null&&String(r)===n))||null}function M_(e){const t=new Date,n=e.start?new Date(e.start):null,a=e.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}async function H_(e,{signal:t}={}){const n=new URLSearchParams;e&&n.set("technician_id",e);const a=n.toString(),s=await pe(`/technician-payouts/${a?`?${a}`:""}`,{signal:t});return Array.isArray(s?.data)?s.data:[]}async function z_({technicianId:e,amount:t,note:n,paidAt:a}){return(await pe("/technician-payouts/",{method:"POST",body:{technician_id:e,amount:t,note:n,paid_at:a}}))?.data??null}async function O_(e){return(await pe(`/technician-payouts/?id=${encodeURIComponent(e)}`,{method:"DELETE"}))?.data??null}Gs();Rs();vo();const U_=new URLSearchParams(window.location.search),Bt=U_.get("id"),aa=document.getElementById("technician-details"),vy=document.getElementById("technician-hero-name"),V_=document.getElementById("technician-hero-status"),Sy=document.getElementById("technician-hero-role"),gc=document.getElementById("dashboard-greeting-technician-name"),qi=document.getElementById("dashboard-greeting-technician-role"),K_=document.getElementById("dashboard-greeting-technician-status"),Ay=document.getElementById("dashboard-greeting-technician-role-badge"),Ey=document.getElementById("sidebar-stat-projects"),wy=document.getElementById("sidebar-stat-reservations"),jy=document.getElementById("sidebar-stat-equipment"),Iy=document.getElementById("sidebar-stat-technicians"),rn={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},Dt=document.getElementById("technician-financial-modal"),bc=document.getElementById("technician-financial-open"),xy=document.getElementById("technician-financial-modal-total"),qy=document.getElementById("technician-financial-modal-paid"),ky=document.getElementById("technician-financial-modal-outstanding"),Md=document.getElementById("technician-financial-modal-empty"),Hd=document.getElementById("technician-financial-modal-table-wrapper"),zd=document.getElementById("technician-financial-modal-rows"),W_=Array.from(document.querySelectorAll("[data-financial-modal-close]")),Er=document.getElementById("technician-payout-form"),Lt=document.getElementById("technician-payout-amount"),Cr=document.getElementById("technician-payout-date"),Q_=document.getElementById("technician-payout-note"),xs=document.getElementById("technician-payouts-list"),Od=document.getElementById("technician-payouts-empty"),Pr=document.getElementById("technician-payout-confirm-modal"),Ra=document.getElementById("technician-payout-confirm-yes"),G_=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),sm=Array.from(document.querySelectorAll("[data-technician-tab]")),Y_=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(e=>[e.getAttribute("data-technician-tab-panel"),e]));let rf="reservations",Zt=null,fs={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Ud=[],hl=null;Ia();function of(){return document.documentElement.getAttribute("lang")||"ar"}function vc(e){const t=Number(e)||0,a=of()==="ar"?"ar-SA-u-nu-latn":"en-US";try{return new Intl.NumberFormat(a,{maximumFractionDigits:0}).format(t)}catch{return b(String(t))||"0"}}function Oi({projects:e=0,reservations:t=0,equipment:n=0,technicians:a=0}={}){Ey&&(Ey.textContent=vc(e)),wy&&(wy.textContent=vc(t)),jy&&(jy.textContent=vc(n)),Iy&&(Iy.textContent=vc(a))}function X_(e){if(!e||typeof e!="object")return 0;const t=[e.quantity,e.qty,e.count];for(const n of t){if(n==null||n==="")continue;const a=Number(b(String(n)));if(Number.isFinite(a))return a>0?a:0}return 1}function J_(e,t){if(!Array.isArray(e)||!e.length)return{projects:0,reservations:0,equipment:0,technicians:t?1:0};const n=new Set,a=new Set;t&&a.add(String(t));let s=0;return e.forEach(r=>{if(!r)return;r.projectId!=null&&n.add(String(r.projectId)),Ua(r.technicians).forEach(o=>a.add(o)),Array.isArray(r.items)&&r.items.forEach(o=>{s+=X_(o)})}),{projects:n.size,reservations:e.length,equipment:s,technicians:a.size||(t?1:0)}}function dn(e){const t=Number(e)||0,a=of()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const s=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${b(s)} SR`}catch{const r=Math.round(t);return`${b(String(r))} SR`}}function rm(e){if(!e)return"—";const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"—";const a=of()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(t)}catch{const r=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),o=t.getFullYear();return`${r}/${i}/${o}`}}function Lr(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _y(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.rate,e.wage];for(const n of t){if(n==null||n==="")continue;const a=Number(b(String(n)));if(Number.isFinite(a))return a}return 0}function Z_(e){const t=typeof e=="string"?e.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="technician-payment-badge technician-payment-badge--unpaid";return t==="paid"?(n="technicianFinancial.status.paid",a="technician-payment-badge technician-payment-badge--paid"):t==="partial"&&(n="technicianFinancial.status.partial",a="technician-payment-badge technician-payment-badge--partial"),`<span class="${a}" data-i18n data-i18n-key="${n}">${c(n,n)}</span>`}function Ty(e){const{totals:t,metrics:n}=e,a=Number(n.assignments??0),s=Number(n.payoutsCount??0),r=c("technicianFinancial.stats.totalDesc","مرتبطة بـ {count} مهام").replace("{count}",b(String(a))),i=c("technicianFinancial.stats.paidDesc","{count} دفعات مسجلة").replace("{count}",b(String(s))),o=c("technicianFinancial.stats.outstandingDesc","المتبقي {amount}"),l=t.outstanding>0?o.replace("{amount}",dn(t.outstanding)):"—";rn.total&&(rn.total.textContent=dn(t.total)),rn.totalDesc&&(rn.totalDesc.textContent=a>0?r:"—"),rn.paid&&(rn.paid.textContent=dn(t.paid)),rn.paidDesc&&(rn.paidDesc.textContent=s>0?i:"—"),rn.outstanding&&(rn.outstanding.textContent=dn(t.outstanding)),rn.outstandingDesc&&(rn.outstandingDesc.textContent=l)}function im(e){const{totals:t,breakdown:n,payouts:a}=e;if(xy&&(xy.textContent=dn(t.total)),qy&&(qy.textContent=dn(t.paid)),ky&&(ky.textContent=dn(t.outstanding)),!(!zd||!Hd||!Md)){if(!n.length)zd.innerHTML="",Hd.classList.add("hidden"),Md.classList.remove("hidden");else{Md.classList.add("hidden"),Hd.classList.remove("hidden");const s=n.map(r=>{const i=r.period||"—",o=r.outstandingAmount>0?dn(r.outstandingAmount):`<span class="text-success">${c("technicianFinancial.list.settled","لا يوجد")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${Lr(r.label)}</div>
            <div class="text-xs text-base-content/60">${Lr(r.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${Lr(i)}</td>
          <td>${dn(r.dueAmount)}</td>
          <td>${Z_(r.paidStatus)}</td>
          <td>${o}</td>
        </tr>
      `}).join("");zd.innerHTML=s}eT(a)}}function eT(e=[]){if(!xs||!Od)return;if(!Array.isArray(e)||e.length===0){xs.innerHTML="",Od.classList.remove("hidden");return}const t=e.map(n=>{const a=dn(n.amount||0),s=rm(n.paidAt||n.createdAt),r=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${Lr(n.note)}</p>`:"",i=c("actions.delete","🗑️ حذف");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${Lr(s)}</span>
          </div>
          ${r}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${Lr(n.id)}" data-i18n data-i18n-key="actions.delete">${i}</button>
      </li>
    `}).join("");xs.innerHTML=t,Od.classList.add("hidden")}function BS(e){const t=e instanceof Date?e:new Date(e);return Number.isNaN(t.getTime())?"":t.toISOString().slice(0,10)}function tT(e){if(!e)return new Date;const t=new Date(`${e}T00:00:00`);return Number.isNaN(t.getTime())?new Date:t}function nT(e){const t=b(String(e??""));if(!t)return"";const s=t.replace(/[٬،]/g,"").replace(/[٫,]/g,".").replace(/[^0-9.]/g,"").split("."),r=s[0]||"",i=s.length>1?s.slice(1).join(""):"",o=r.replace(/^0+(\d)/,"$1"),l=o.length?o:i?"0":"",d=i?i.replace(/\D/g,"").slice(0,2):"";return d?`${l}.${d}`:l}function aT(e){if(e.preventDefault(),!Bt){I(c("technicianFinancial.payouts.toast.invalidTechnician","⚠️ لا يمكن تحديد عضو الطاقم حالياً."));return}const t=Lt?.value??"",n=Number.parseFloat(b(String(t)));if(!Number.isFinite(n)||n<=0){I(c("technicianFinancial.payouts.toast.invalidAmount","⚠️ أدخل قيمة صحيحة للمبلغ.")),Lt?.focus();return}const a=Q_?.value?.trim()||"",s=tT(Cr?.value||null),r=Er?.querySelector('button[type="submit"]');r&&(r.disabled=!0),z_({technicianId:Bt,amount:Number(n.toFixed(2)),note:a,paidAt:s.toISOString()}).then(i=>{I(c("technicianFinancial.payouts.toast.added","✅ تم تسجيل الدفعة.")),Er?.reset(),Cr&&(Cr.value=BS(i?.paidAt||new Date)),Zt&&Mo(Zt)}).catch(i=>{console.error("❌ [technician-page] Failed to create technician payout",i);const o=i?.message||c("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.");I(o)}).finally(()=>{r&&(r.disabled=!1)})}function sT(e){e&&iT(e)}function rT(){Dt&&(Dt.classList.remove("hidden"),Dt.classList.add("show"),Dt.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),Cr&&!Cr.value&&(Cr.value=BS(new Date)))}function cf(){Dt&&(Dt.classList.remove("show"),Dt.classList.remove("modal-open"),Dt.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function iT(e){Pr&&(hl=e||null,Pr.classList.remove("hidden"),Pr.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function om(){Pr&&(Pr.classList.remove("show","modal-open"),Pr.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),hl=null,Ra&&(Ra.disabled=!1))}function FS(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function oT(e){if(e.preventDefault(),!Zt)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...Zt}}))}catch(a){console.error("⚠️ [technician-page] Failed to prefill technician edit modal",a)}const t=document.getElementById("editTechnicianModal");if(!t||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(t).show()}function RS(){FS().forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",oT),e.dataset.listenerAttached="true")})}async function Mo(e){if(fs={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Ty(fs),im(fs),Oi(),!Bt||!e)return;try{await pi({suppressError:!0})}catch(y){console.error("⚠️ [technician-page] Failed to load reservations for financial summary",y)}const n=We(),a=String(Bt);try{const y=await H_(a);Ud=Array.isArray(y)?y:[]}catch(y){console.error("⚠️ [technician-page] Failed to load technician payouts from API",y),Ud=[]}const s=n.filter(y=>!y||String(y.status||"").toLowerCase()==="cancelled"?!1:(Array.isArray(y.technicians)?y.technicians.map(S=>String(S)):[]).includes(a)),r=J_(s,a);Oi(r);const i=s.map((y,E)=>{const S=Array.isArray(y.techniciansDetails)?y.techniciansDetails.find(U=>{const L=U?.id??U?.technician_id??U?.technicianId??U?.ID;return L!=null&&String(L)===a}):null,x=_y(S)||_y(e),A=Math.max(1,ri(y.start,y.end)),C=Math.max(0,Math.round(x*A)),j=c("technicianFinancial.list.reservationFallback","حجز رقم {id}").replace("{id}",b(String(y.reservationId||y.id||"?"))),k=y.title&&y.title.trim().length?y.title.trim():j,w=[];if(y.reservationId||y.id){const U=y.reservationId||y.id;w.push(`#${b(String(U))}`)}if(y.projectId&&w.push(c("technicianFinancial.list.projectReference","مشروع #{id}").replace("{id}",b(String(y.projectId)))),y.status){const U=`reservations.status.${y.status}`;w.push(c(U,y.status))}const _=rm(y.start),$=rm(y.end),q=_===$?_:`${_} – ${$}`,F=(()=>{const U=y.start||y.startDatetime||y.createdAt||y.created_at,L=U?new Date(U).getTime():NaN;return Number.isNaN(L)?E:L})();return{label:k,reference:w.join(" • ")||"—",period:q,dueAmount:C,paidAmount:0,outstandingAmount:C,paidStatus:"unpaid",sortKey:F,originalIndex:E}}),o=Ud.map(y=>({...y,amount:Number(y.amount)||0}));let l=o.reduce((y,E)=>y+E.amount,0);const u=[...i].sort((y,E)=>y.sortKey===E.sortKey?y.originalIndex-E.originalIndex:y.sortKey-E.sortKey).map(y=>{const E={...y},S=Number(y.dueAmount)||0,x=Math.min(S,Math.max(0,Number(l.toFixed(2))));x>0&&(l=Number((l-x).toFixed(2))),E.paidAmount=Number(x.toFixed(2));const A=Math.max(0,Number((S-x).toFixed(2)));return E.outstandingAmount=A,A<=.009?(E.paidStatus="paid",E.outstandingAmount=0):x>0?E.paidStatus="partial":E.paidStatus="unpaid",E}).sort((y,E)=>y.originalIndex-E.originalIndex).map(({sortKey:y,originalIndex:E,...S})=>S),m=u.reduce((y,E)=>y+E.dueAmount,0),p=o.reduce((y,E)=>y+(Number(E.amount)||0),0),f=Math.max(0,Number((m-p).toFixed(2))),h={total:Math.max(0,Number(m.toFixed(2))),paid:Math.max(0,Number(p.toFixed(2))),outstanding:f},g={assignments:u.length,payoutsCount:o.length,outstandingAmount:f};fs={totals:h,metrics:g,breakdown:u,payouts:o},Ty(fs),im(fs)}function fr(e,t,n,{hideWhenEmpty:a=!1}={}){if(!e)return;const s=n==null?"":String(n).trim(),r=s.length>0;e.textContent=r?`${t} ${s}`:`${t} —`,a?e.classList.toggle("hidden",!r):r||e.classList.remove("hidden")}function Cy(e){const t=[V_,K_].filter(Boolean);if(!t.length)return;const n=typeof e=="string"?e.toLowerCase():"";if(!n){t.forEach(o=>{o.className="technician-badge hidden",o.textContent="—"});return}const a=n==="busy",s=["technician-badge"];s.push(a?"technician-badge--status-busy":"technician-badge--status-available");const r=a?"technicians.status.busy":"technicians.status.available",i=a?"⛔ مشغول":"✅ متاح";t.forEach(o=>{o.className=s.join(" "),o.classList.remove("hidden"),o.setAttribute("data-i18n",""),o.setAttribute("data-i18n-key",r),o.textContent=c(r,i)})}function wr(e){if(!e){fr(vy,"😎","—"),fr(Sy,"🎯","",{hideWhenEmpty:!0}),gc&&(gc.textContent="—"),qi&&(qi.textContent="—"),fr(Ay,"🎯","",{hideWhenEmpty:!0}),Cy(null);return}if(fr(vy,"😎",e.name||"—"),fr(Sy,"🎯",e.role||"",{hideWhenEmpty:!0}),gc&&(gc.textContent=e.name||"—"),qi){const t=e.role?e.role:"";if(t)qi.textContent=`🎯 ${t}`;else{const n=c("technicianDetails.fallback.role","غير محدد");qi.textContent=`🎯 ${n}`}}fr(Ay,"🎯",e.role||"",{hideWhenEmpty:!0}),Cy(e.status||e.baseStatus||"available")}function po(e){FS().forEach(t=>{t.disabled=!!e})}function Dc(e){e&&(rf=e,sm.forEach(t=>{if(!t)return;const n=t.getAttribute("data-technician-tab")===e;t.classList.toggle("tab-active",n),t.classList.toggle("active",n),t.setAttribute("aria-selected",String(n))}),Y_.forEach((t,n)=>{t&&t.classList.toggle("hidden",n!==e)}),e==="projects"&&Bt&&DS(Bt),e==="reservations"&&Bt&&$S(Bt))}function cT(){sm.length&&(sm.forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=e.getAttribute("data-technician-tab");t&&Dc(t)}),e.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("data-technician-tab-trigger");n&&Dc(n)}),e.dataset.listenerAttached="true")}),Dc(rf))}wr(null);po(!0);cT();RS();bc&&!bc.dataset.listenerAttached&&(bc.addEventListener("click",()=>{im(fs),rT()}),bc.dataset.listenerAttached="true");W_.forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{cf()}),e.dataset.listenerAttached="true")});Er&&!Er.dataset.listenerAttached&&(Er.addEventListener("submit",aT),Er.dataset.listenerAttached="true");xs&&!xs.dataset.listenerAttached&&(xs.addEventListener("click",e=>{const t=e.target.closest("[data-payout-remove]");if(!t)return;const n=t.getAttribute("data-payout-remove");sT(n)}),xs.dataset.listenerAttached="true");if(Lt&&!Lt.dataset.normalizerAttached){const e=()=>{const t=nT(Lt.value);if(t!==Lt.value){const n=t.length;Lt.value=t,Lt.setSelectionRange&&Lt.setSelectionRange(n,n)}};Lt.addEventListener("input",e),Lt.addEventListener("blur",()=>{if(e(),Lt.value){const t=Number.parseFloat(Lt.value);Number.isFinite(t)&&(Lt.value=t.toFixed(2))}}),Lt.dataset.normalizerAttached="true"}G_.forEach(e=>{!e||e.dataset.listenerAttached||(e.addEventListener("click",om),e.dataset.listenerAttached="true")});Ra&&!Ra.dataset.listenerAttached&&(Ra.addEventListener("click",()=>{if(!hl){om();return}Ra.disabled=!0,O_(hl).then(()=>{I(c("technicianFinancial.payouts.toast.removed","🗑️ تم حذف الدفعة.")),om(),Zt&&Mo(Zt)}).catch(e=>{console.error("❌ [technician-page] Failed to remove technician payout",e);const t=e?.message||c("technicianFinancial.payouts.toast.failed","⚠️ تعذر تسجيل الدفعة، حاول مرة أخرى.");I(t),Ra.disabled=!1})}),Ra.dataset.listenerAttached="true");Dt&&!Dt.dataset.listenerAttached&&(Dt.addEventListener("click",e=>{e.target===Dt&&cf()}),Dt.dataset.listenerAttached="true");document.addEventListener("keydown",e=>{e.key==="Escape"&&Dt&&Dt.classList.contains("modal-open")&&cf()});$p({showReservationDetails:Bo});const Sc=document.getElementById("logout-btn");Sc&&!Sc.dataset.listenerAttached&&(Sc.addEventListener("click",()=>ti()),Sc.dataset.listenerAttached="true");function lT(e){const t=Number(e??0);return Number.isFinite(t)?t.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function dT(e){const t=Number(e??0);if(!Number.isFinite(t)||t<=0)return"";const n=c("technicians.badge.perDay","/اليوم");return`${dn(t)} ${n}`}function Py(e){const t=Number(e??0);return!Number.isFinite(t)||t<=0?"":dn(t)}function MS(e){if(!aa)return;if(wr(e),!e){aa.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${c("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,po(!0);return}const t=e.phone?b(e.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${c("reservations.details.technicians.phoneUnknown","غير متوفر")}</span>`,n=e.role?e.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${c("technicianDetails.fallback.role","غير محدد")}</span>`,a=e.department?e.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${c("technicianDetails.fallback.department","—")}</span>`,s=e.notes?e.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${c("technicianDetails.fallback.notes","—")}</span>`,i=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${c("reservations.create.summary.currency","SR")}</span>`,o=dT(e.dailyWage)||`${lT(e.dailyWage)} ${i}`,l=Py(e.dailyTotal),d=o,u=l||Py(e.dailyWage)||o;console.debug("[technician] amounts",{id:e.id,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,wageValue:d,totalValue:u});const p=[{key:"technicianDetails.fields.role",value:n},{key:"technicianDetails.fields.department",value:a},{key:"technicianDetails.fields.phone",value:t},{key:"technicianDetails.fields.wage",value:d},{key:"technicianDetails.fields.total",value:u||`0 ${i}`},{key:"technicianDetails.fields.notes",value:s}].map(({key:f,value:h})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${f}">${c(f)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${h}</p>
    </article>
  `).join("");aa.innerHTML=p,RS(),po(!1),Dc(rf)}async function uT(){if(!aa)return;if(!Bt){wr(null),Oi(),po(!0),Zt=null,aa.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${c("technicianDetails.errors.missingId","⚠️ لا يوجد معرف عضو طاقم في الرابط.")}</p>`;return}aa.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${c("technicianDetails.status.loading","⏳ جارٍ تحميل بيانات عضو الطاقم...")}</p>`,po(!0),wr(null);let e=null,t=null;try{await ai(),Ut()}catch(n){t=n,console.error("❌ [technician-details] Failed to refresh technician from API",n)}if(e=Tl(Bt),!e){t?aa.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${c("technicianDetails.errors.loadFailed","❌ تعذر تحميل بيانات عضو الطاقم. حاول مرة أخرى لاحقًا.")}</p>`:aa.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${c("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,wr(null),Oi(),Zt=null;return}if(!e){aa.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${c("technicianDetails.errors.notFound","⚠️ لم يتم العثور على عضو الطاقم المطلوب.")}</p>`,wr(null),Oi(),Zt=null;return}Zt=e,await Mo(e),MS(e),$S(Bt),DS(Bt)}Ut();uT();const mT=async()=>{if(!Bt)return;Ut();const e=Tl(Bt);e&&(Zt=e,await Mo(e),MS(e))};window.addEventListener("technicians:updated",mT);const pT=()=>{!Bt||!Zt||Mo(Zt)};document.addEventListener("reservations:changed",pT,{passive:!0});let Ly=null;function fT(e){e&&HS()!==e&&Ft({[Sp]:e}).catch(t=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",t)})}function HS(){return lt()?.[Sp]||""}function zS(e){e&&cm()!==e&&Ft({[Ap]:e}).catch(t=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",t)})}function cm(){return lt()?.[Ap]||""}function hT(e){if(!e)return"";const t=e.trim();return t?Object.values(qh).includes(t)?t:qh[t]||"":""}function yT(){if(typeof window>"u")return"";try{const t=new URLSearchParams(window.location.search||"").get("subTab");if(t){const n=hT(t);if(n)return n}}catch{}return""}function OS(e,t){!e||!v.tabPanes||!v.tabButtons||(v.tabButtons.forEach(n=>{const a=n===t;n.classList.toggle("active",a),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",a)}),v.tabPanes.forEach(n=>{n.dataset.tabPane===e?n.classList.remove("d-none"):n.classList.add("d-none")}),t&&fT(e))}function gT(){if(!v.tabButtons||!v.tabButtons.length)return;v.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const s=n.dataset.tabTarget;s&&(OS(s,n),s==="projects-section"&&(z.filters.search="",v.search&&(v.search.value=""),gn(),ka(),_a()))}),n.dataset.tabListenerAttached="true")});const e=HS(),t=e&&v.tabButtons.find(n=>n.dataset.tabTarget===e);t&&t.click()}function lf(e,t){!e||!v.projectSubTabButtons||!v.projectSubTabPanes||(v.projectSubTabButtons.forEach(n=>{const a=n===t;n.classList.toggle("active",a),n.classList.contains("tab")&&n.classList.toggle("tab-active",a)}),v.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===e?n.classList.remove("d-none"):n.classList.add("d-none")}))}function bT(){!v.projectSubTabButtons||!v.projectSubTabButtons.length||(v.projectSubTabButtons.forEach(e=>{e.dataset.tabListenerAttached!=="true"&&(e.addEventListener("click",t=>{t.preventDefault();const n=e.dataset.projectSubtabTarget;n&&(lf(n,e),zS(n))}),e.dataset.tabListenerAttached="true")}),vT())}function vT(){const t=yT()||cm();if(!t)return;const n=v.projectSubTabButtons?.[0],a=v.projectSubTabButtons?.find(r=>r.dataset.projectSubtabTarget===t)||n,s=a?.dataset.projectSubtabTarget;s&&(t!==cm()&&zS(s),lf(s,a))}function ST(){return v.tabButtons?v.tabButtons.find(t=>t.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Ny(e={}){if(e){if(v.tabButtons&&v.tabButtons.length){const n=v.tabButtons.find(s=>s.classList.contains("active"))?.dataset.tabTarget||"",a=e[Sp];if(a&&a!==n){const s=v.tabButtons.find(r=>r.dataset.tabTarget===a);s&&OS(a,s)}}if(v.projectSubTabButtons&&v.projectSubTabButtons.length&&ST()){const n=v.projectSubTabButtons.find(s=>s.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=e[Ap];if(a&&a!==n){const s=v.projectSubTabButtons.find(r=>r.dataset.projectSubtabTarget===a);s&&lf(a,s)}}}}function AT(){Ly||(Ly=El(e=>{Ny(e)})),wl().then(e=>{Ny(e)}).catch(e=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",e)})}function Ns(e){const t=z.projects.find(qe=>String(qe.id)===String(e));if(!t||!v.detailsBody)return;v.detailsBody.dataset.mode="view",v.detailsBody.dataset.projectId=String(t.id);const a=(z.customers.length?z.customers:ae().customers||[]).find(qe=>String(qe.id)===String(t.clientId)),s=WS(t.type),i=t.description?.trim()||c("projects.fallback.noDescription","لا يوجد وصف"),o=a?.customerName||c("projects.fallback.unknownClient","عميل غير معروف"),l=a?.phone??a?.customerPhone??t.clientPhone??t.customerPhone??"",d=l?b(String(l).trim()):c("projects.details.client.noPhone","لا يوجد رقم متاح"),u=a?.email??t.clientEmail??t.customerEmail??"",m=u?String(u).trim():c("projects.details.client.noEmail","لا يوجد بريد متاح"),p=(t.clientCompany||a?.companyName||"").trim(),f=t.projectCode||`PRJ-${b(String(t.id))}`,h=b(f),g=Zl(t.id),y=g.reduce((qe,ze)=>qe+$T(ze),0),E=Number(y.toFixed(2)),S=g.length,{subtotal:x,applyTax:A,expensesTotal:C}=oo(t),j=x,k=A?Number(((j+E)*mi).toFixed(2)):0,w=Number((j+E+k).toFixed(2)),_=Xp(t),$=c(`projects.status.${_}`,iv[_]||_),F={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[_]||"status-confirmed",U=A?c("projects.details.chips.vatOn","شامل الضريبة 15٪"):c("projects.details.chips.vatOff","غير شامل الضريبة"),L=A?"status-paid":"status-unpaid",B=c("projects.details.chips.reservations","{count} حجوزات").replace("{count}",b(String(S))),D=typeof t.paymentStatus=="string"?t.paymentStatus.toLowerCase():"",K=PT(t),Z=K.length>0,R=Z?0:Number(t.paidAmount)||0,M=Z?0:Number(t.paidPercent)||0,H=en({totalAmount:w,paidAmount:R,paidPercent:M,history:K}),V=fn({manualStatus:D||"unpaid",paidAmount:H.paidAmount,paidPercent:H.paidPercent,totalAmount:w}),G=c(`projects.paymentStatus.${V}`,V==="paid"?"Paid":V==="partial"?"Partial":"Unpaid"),ie=V==="paid"?"status-paid":V==="partial"?"status-partial":"status-unpaid",ee=Number.isFinite(Number(H.paidAmount))?Number(H.paidAmount):0,oe=Number.isFinite(Number(H.paidPercent))?Number(H.paidPercent):0,W=Math.max(0,Number((w-ee).toFixed(2))),be=Qe(ee),he=`${b(oe.toFixed(2))}%`,Se=Qe(W),we=TT(K),J=c("projects.focus.confirmed","✅ مشروع مؤكد"),re=t.confirmed===!0||t.confirmed==="true"?`<span class="reservation-chip status-confirmed">${N(J)}</span>`:"",Pe=[{icon:"💼",label:c("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:Qe(j)},{icon:"🔗",label:c("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:Qe(E)},{icon:"🧮",label:c("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:Qe(k)},{icon:"💰",label:c("projects.details.summary.overallTotal","الإجمالي الكلي"),value:Qe(w)},{icon:"💳",label:c("projects.details.summary.paidAmount","إجمالي المدفوع"),value:be},{icon:"📊",label:c("projects.details.summary.paidPercent","نسبة المدفوع"),value:he},{icon:"💸",label:c("projects.details.summary.remainingAmount","المتبقي للدفع"),value:Se}].map(({icon:qe,label:ze,value:Je})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${qe} ${N(ze)}</span>
      <span class="summary-details-value">${N(Je)}</span>
    </div>
  `).join(""),Te=c("projects.details.labels.code","رقم المشروع"),ye=`
    <div class="project-details-code-badge" title="${N(Te)}">
      <span class="project-details-code-badge__label">
        <span class="project-details-code-badge__icon" aria-hidden="true">🗂️</span>
        ${N(Te)}
      </span>
      <span class="project-details-code-badge__value">${N(h)}</span>
    </div>
  `,te=[{icon:"👤",label:c("projects.details.client","العميل"),value:o},{icon:"📞",label:c("projects.details.labels.clientPhone","رقم العميل"),value:d},{icon:"✉️",label:c("projects.details.labels.clientEmail","البريد الإلكتروني"),value:m},p?{icon:"🏢",label:c("projects.details.company","شركة العميل"),value:p}:null,{icon:"🏷️",label:c("projects.details.type","نوع المشروع"),value:s},$y("start",t.start),$y("end",t.end)].filter(Boolean),Ce=c("projects.details.overview.heading","معلومات المشروع"),X=`
    <div class="project-details-outline">
      <h6 class="project-details-outline__title">${N(Ce)}</h6>
      <ul class="project-details-outline__list">
        ${te.map(({icon:qe,label:ze,value:Je,meta:Ye})=>`
          <li>
            <span class="project-details-outline__label">${N(qe)} ${N(ze)}</span>
            <span class="project-details-outline__value-group">
              <span class="project-details-outline__value">${N(Je)}</span>
              ${Ye?`<span class="project-details-outline__meta">${N(Ye)}</span>`:""}
            </span>
          </li>
        `).join("")}
      </ul>
    </div>
  `,Ae=[`<span class="reservation-chip ${F}">${N($)}</span>`,`<span class="reservation-chip ${L}">${N(U)}</span>`,`<span class="reservation-chip status-info">${N(B)}</span>`,`<span class="reservation-chip ${ie}">${N(G)}</span>`,re].filter(Boolean).join(""),Ne=c("projects.details.expensesTotal","إجمالي المصاريف"),je=c("projects.details.reservationsTotal","إجمالي الحجوزات");v.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div class="project-details-header__info">
          <div class="project-details-chips">${Ae}</div>
        </div>
        <div class="project-details-header__code">
          ${ye}
          <h4 class="project-details-title">${N(t.title)}</h4>
        </div>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${X}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card project-details-outline">
            <h6>${N(c("projects.details.summary.title","ملخص مالي"))}</h6>
            ${Pe}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${N(c("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${N(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${N(c("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${N(Ne)}</span>
          <strong>${Qe(C)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${N(je)}</span>
          <strong>${Qe(E)}</strong>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${N(c("reservations.paymentHistory.title","سجل الدفعات"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${N(c("projects.details.paymentOverview.total","الإجمالي الكلي"))}</span>
          <strong>${N(Qe(w))}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${N(c("projects.details.paymentOverview.paid","المدفوع"))}</span>
          <strong>${N(be)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${N(c("projects.details.paymentOverview.percent","نسبة المدفوع"))}</span>
          <strong>${N(he)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${N(c("projects.details.paymentOverview.remaining","المتبقي"))}</span>
          <strong>${N(Se)}</strong>
        </div>
      </div>
      <div class="reservation-payment-history-modal mt-3">
        ${we}
      </div>
    </section>
    ${vk(t)}
    <div class="project-details-footer">
      <button type="button" class="modal-action-btn modal-action-btn--primary" data-action="create-reservation">
        ${N(c("projects.details.reservations.create","➕ إنشاء حجز مرتبط"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--ghost" data-action="edit-project">
        ${N(c("projects.details.actions.edit","✏️ تعديل المشروع"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--danger" data-action="delete-project">
        ${N(c("projects.details.actions.delete","🗑️ حذف المشروع"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--ghost" id="project-details-export-btn">
        ${N(c("projects.details.actions.exportPdf","👁️ معاينة PDF"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--ghost" data-bs-dismiss="modal">
        ${N(c("actions.close","إغلاق"))}
      </button>
    </div>
  `,jT(t);const fe=v.detailsBody.querySelector("#project-details-export-btn");fe&&fe.addEventListener("click",async qe=>{if(qe.preventDefault(),fe.blur(),!fe.disabled){fe.disabled=!0;try{await Tx({project:t})}catch(ze){console.error("❌ [projects/details] export project PDF failed",ze),I(c("projects.details.exportFailed","⚠️ تعذر تصدير المشروع إلى PDF"),"error")}finally{fe.disabled=!1}}}),v.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(v.detailsModalEl).show()}function ET({onOpenProject:e}){!v.focusCards||v.focusCards.dataset.listenerAttached==="true"||(v.focusCards.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(n){const{action:s,id:r}=n.dataset;if(s==="confirm-project"){t.preventDefault(),t.stopPropagation(),qT(r);return}s==="view"?e?.(r):s==="highlight"&&wT(r);return}const a=t.target.closest(".project-focus-card");a?.dataset.projectId&&e?.(a.dataset.projectId)}),v.focusCards.dataset.listenerAttached="true")}function wT(e){if(!v.projectsTableBody)return;const t=`tr[data-project-id="${CSS.escape(String(e))}"]`,n=v.projectsTableBody.querySelector(t);if(!n){I(c("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function jT(e){if(!v.detailsBody)return;const t=v.detailsBody.querySelector('[data-action="create-reservation"]'),n=v.detailsBody.querySelector('[data-action="edit-project"]'),a=v.detailsBody.querySelector('[data-action="delete-project"]'),s=v.detailsBody.querySelector(".project-reservations-list");if(t&&e&&t.addEventListener("click",r=>{r.preventDefault(),xT(e)}),n&&e&&n.addEventListener("click",r=>{r.preventDefault(),US(e)}),a&&e&&a.addEventListener("click",async r=>{r.preventDefault();const i=r.currentTarget;i.disabled=!0;try{await wS(e.id),!z.projects.some(l=>String(l.id)===String(e.id))&&v.detailsModalEl&&window.bootstrap?.Modal.getInstance(v.detailsModalEl)?.hide()}finally{z.projects.some(l=>String(l.id)===String(e.id))&&(i.disabled=!1)}}),s){const r=async i=>{if(!Number.isInteger(i)||i<0)return!1;const o=Yl("showReservationDetails");if(typeof o=="function")return o(i),!0;try{const l=await Dp("showReservationDetails");if(typeof l=="function")return l(i),!0}catch(l){console.warn("⚠️ [projects/projectDetails] Unable to resolve reservation UI handler",l)}return!1};s.addEventListener("click",async i=>{const o=i.target.closest('[data-action="view-reservation"]');if(!o)return;const l=o.dataset.index||o.dataset.reservationIndex,d=Number.parseInt(l||"-1",10);if(!Number.isInteger(d)||d<0)return;await r(d)||(window.location.href="dashboard.html#reservations")}),s.addEventListener("keydown",i=>{if(!["Enter"," "].includes(i.key))return;const o=i.target.closest('[data-action="view-reservation"]');o&&(i.preventDefault(),o.click())})}}function US(e){if(!e||!v.detailsBody)return;const t=z.projects.find(u=>String(u.id)===String(e.id));if(!t)return;const n=z.customers.find(u=>String(u.id)===String(t.clientId));n?.customerName||n?.name||t.clientName||t.customerName,t.clientCompany||n?.companyName||n?.company;const a=Array.isArray(t.expenses)?t.expenses.map((u,m)=>({id:u?.id||`expense-${t.id}-${m}-${Date.now()}`,label:u?.label||"",amount:Number(u?.amount)||0})):[];let s=Array.isArray(t.paymentHistory)?t.paymentHistory.map((u,m)=>({type:u?.type==="percent"?"percent":"amount",amount:Number.isFinite(Number(u?.amount))?Number(u.amount):null,percentage:Number.isFinite(Number(u?.percentage))?Number(u.percentage):null,value:Number.isFinite(Number(u?.value))?Number(u.value):null,note:u?.note??null,recordedAt:u?.recordedAt??u?.recorded_at??new Date().toISOString(),key:`payment-${t.id}-${m}`})):[],r=s.reduce((u,m)=>u+(Number(m?.amount)||0),0),i=s.reduce((u,m)=>u+(Number(m?.percentage)||0),0),o=Number.isFinite(Number(t.paidAmount))?Number(t.paidAmount):0,l=Number.isFinite(Number(t.paidPercent))?Number(t.paidPercent):0;if(!s.length&&(o>0||l>0)){const u=t.updatedAt??t.createdAt??new Date().toISOString();l>0?s=[{type:"percent",amount:Number.isFinite(o)&&o>0?o:null,percentage:l,value:l,note:null,recordedAt:u,key:`legacy-payment-${t.id}-percent`}]:o>0&&(s=[{type:"amount",amount:o,percentage:null,value:o,note:null,recordedAt:u,key:`legacy-payment-${t.id}-amount`}]),r=s.reduce((m,p)=>m+(Number(p?.amount)||0),0),i=s.reduce((m,p)=>m+(Number(p?.percentage)||0),0),o=0,l=0}r>0&&Math.abs(o-r)<.01&&(o=0),i>0&&Math.abs(l-i)<.01&&(l=0);const d={expenses:a,payments:s,basePaidAmount:o,basePaidPercent:l};v.detailsBody.dataset.mode="edit",v.detailsBody.innerHTML=kT(t,d),IT(t,d)}function IT(e,t={expenses:[]}){const n=v.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",R=>{R.preventDefault(),Ns(e.id)});const s=n.querySelector("#project-edit-expense-label"),r=n.querySelector("#project-edit-expense-amount"),i=n.querySelector('[data-action="add-expense"]'),o=n.querySelector("#project-edit-expense-list"),l=n.querySelector('[name="project-start-date"]'),d=n.querySelector('[name="project-start-time"]'),u=n.querySelector('[name="project-end-date"]'),m=n.querySelector('[name="project-end-time"]'),p=n.querySelector('[name="project-payment-status"]'),f=n.querySelector("#project-edit-tax"),h=n.querySelector("#project-edit-company-share"),g=n.querySelector("#project-edit-discount"),y=n.querySelector("#project-edit-discount-type"),E=n.querySelector("#project-edit-payment-progress-type"),S=n.querySelector("#project-edit-payment-progress-value"),x=n.querySelector("#project-edit-payment-add"),A=n.querySelector("#project-edit-payment-history"),C=n.querySelector("#project-edit-payment-summary"),j=c("reservations.create.summary.currency","SR");let k=!1;const w=()=>(Array.isArray(t.payments)||(t.payments=[]),t.payments),_=()=>{const R=Number(e.equipmentEstimate)||0,M=Array.isArray(t.expenses)?t.expenses.reduce((be,he)=>be+(Number(he.amount)||0),0):0,H=y?.value==="amount"?"amount":"percent",V=b(g?.value||"0");let G=Number.parseFloat(V);(!Number.isFinite(G)||G<0)&&(G=0);const ie=f?.checked===!0,ee=h?.checked===!0;let oe=ee?Zp(h):null;(!Number.isFinite(oe)||oe<=0)&&(oe=ee?Fe:null);const W=td({equipmentEstimate:R,expensesTotal:M,discountValue:G,discountType:H,applyTax:ie,companyShareEnabled:ee,companySharePercent:oe});return{equipmentEstimate:R,expensesTotal:M,discountValue:G,discountTypeValue:H,applyTax:ie,companyShareEnabled:ee,companySharePercent:oe,finance:W}},$=()=>{const R=_(),M=w(),H=en({totalAmount:R.finance.totalWithTax,paidAmount:t.basePaidAmount||0,paidPercent:t.basePaidPercent||0,history:M});return{...R,payments:M,progress:H}},q=()=>{A&&(A.innerHTML=CT(w()))},F=()=>{if(!C)return;const{finance:R,progress:M}=$(),H=Number.isFinite(Number(R.totalWithTax))?Number(R.totalWithTax):0,V=Number.isFinite(Number(M.paidAmount))?Number(M.paidAmount):0,G=Number.isFinite(Number(M.paidPercent))?Number(M.paidPercent):0,ie=Math.max(0,Math.round((H-V)*100)/100),ee=[{label:c("projects.form.paymentSummary.total","الإجمالي الكلي"),value:Qe(H)},{label:c("projects.form.paymentSummary.paidAmount","إجمالي المدفوع"),value:Qe(V)},{label:c("projects.form.paymentSummary.paidPercent","نسبة الدفعات"),value:`${b(G.toFixed(2))}%`},{label:c("projects.form.paymentSummary.remaining","المتبقي"),value:Qe(ie)}];C.innerHTML=ee.map(({label:oe,value:W})=>`
        <div class="project-details-grid-item">
          <span>${N(oe)}</span>
          <strong>${N(W)}</strong>
        </div>
      `).join("")},U=(R="auto")=>{if(!p)return;const M=p.dataset?.userSelected==="true";if(R==="auto"&&M)return;const{finance:H,progress:V}=$(),G=fn({manualStatus:M?p.value:e.paymentStatus||"unpaid",paidAmount:V.paidAmount,paidPercent:V.paidPercent,totalAmount:H.totalWithTax});M||(p.value=G)},L=()=>{q(),F(),U("auto")},B=1e-4,D=()=>{const R=E?.value==="amount"?"amount":"percent",M=b(S?.value||"").replace("%","").trim();let H=Number.parseFloat(M);if(!Number.isFinite(H)||H<=0){I(c("projects.toast.paymentInvalid","⚠️ يرجى إدخال قيمة دفعة صحيحة")),S?.focus();return}const V=$(),G=Number.isFinite(Number(V.finance.totalWithTax))?Number(V.finance.totalWithTax):0;if(G<=0){I(c("projects.toast.paymentTotalMissing","⚠️ يرجى التأكد من إدخال البيانات المالية للمشروع قبل تسجيل الدفعة"));return}const ie=Number(V.progress.paidAmount)||0,ee=Number(V.progress.paidPercent)||0;let oe=null,W=null;if(R==="percent"){const he=Math.max(0,100-ee);if(he<=B){I(c("projects.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة المشروع، لا يمكن إضافة دفعة جديدة"));return}if(H>he){H=he;const Se=b(H.toFixed(2));I(c("projects.toast.paymentCappedPercent","ℹ️ تم ضبط الدفعة إلى {value}% لاستكمال 100%").replace("{value}",Se))}W=Math.round(H*100)/100,G>0&&(oe=Math.round(W/100*G*100)/100)}else{const he=Math.max(0,G-ie);if(he<=B){I(c("projects.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة المشروع، لا يمكن إضافة دفعة جديدة"));return}if(H>he){H=he;const Se=`${b(H.toFixed(2))} ${j}`;I(c("projects.toast.paymentCappedAmount","ℹ️ تم ضبط الدفعة إلى {amount} لاستكمال المبلغ المتبقي").replace("{amount}",Se))}oe=Math.round(H*100)/100,G>0&&(W=Math.round(oe/G*100*100)/100)}const be={type:R,amount:oe??null,percentage:W??null,value:R==="amount"?oe:W,note:null,recordedAt:new Date().toISOString()};t.payments=[...w(),be],S&&(S.value=""),E&&(E.value="percent"),L(),I(c("projects.toast.paymentAdded","✅ تم تسجيل الدفعة"))},K=R=>{!f||!h||k||(k=!0,R==="share"?h.checked?(f.checked||(f.checked=!0),Tn(h)):f.checked&&(f.checked=!1):R==="tax"&&(f.checked?Tn(h):h.checked&&(h.checked=!1)),k=!1)};function Z(){o&&(o.innerHTML=VS(t.expenses))}Z(),L(),g&&!g.dataset.listenerAttached&&(g.addEventListener("input",R=>{const M=R.target;M instanceof HTMLInputElement&&(M.value=b(M.value||""),F(),U("auto"))}),g.dataset.listenerAttached="true"),y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>{F(),U("auto")}),y.dataset.listenerAttached="true"),S&&!S.dataset.listenerAttached&&(S.addEventListener("input",R=>{const M=R.target;M instanceof HTMLInputElement&&(M.value=b(M.value||""))}),S.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>{p.dataset.userSelected="true"}),p.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("input",R=>{const M=R.target;M instanceof HTMLInputElement&&(M.value=b(M.value||""))}),r.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("change",()=>{K("share"),F(),U("auto")}),h.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>{K("tax"),F(),U("auto")}),f.dataset.listenerAttached="true"),h?.checked&&Tn(h),K(h?.checked?"share":"tax"),F(),U("auto"),i&&i.addEventListener("click",R=>{R.preventDefault();const M=s?.value.trim()||"",H=b(r?.value||"0"),V=Number(H);if(!M){I(c("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),s?.focus();return}if(!Number.isFinite(V)||V<=0){I(c("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),r?.focus();return}t.expenses.push({id:`expense-${e.id}-${Date.now()}`,label:M,amount:V}),s&&(s.value=""),r&&(r.value=""),Z(),F(),U("auto")}),o&&o.addEventListener("click",R=>{const M=R.target.closest('[data-action="remove-expense"]');if(!M)return;const{id:H}=M.dataset;t.expenses=t.expenses.filter(V=>String(V.id)!==String(H)),Z(),F(),U("auto")}),x&&!x.dataset.listenerAttached&&(x.addEventListener("click",R=>{R.preventDefault(),D()}),x.dataset.listenerAttached="true"),A&&!A.dataset.listenerAttached&&(A.addEventListener("click",R=>{const M=R.target.closest('[data-action="remove-payment"]');if(!M)return;const H=Number.parseInt(M.dataset.index||"-1",10);if(!Number.isInteger(H)||H<0)return;const V=w();if(H>=V.length)return;const G=V.filter((ie,ee)=>ee!==H);t.payments=G,L(),I(c("projects.toast.paymentRemoved","🗑️ تم حذف الدفعة"))}),A.dataset.listenerAttached="true"),n.addEventListener("submit",async R=>{if(R.preventDefault(),n.dataset.submitting==="true")return;const M=n.querySelector('[name="project-title"]'),H=n.querySelector('[name="project-type"]'),V=n.querySelector('[name="project-description"]'),G=M?.value.trim()||"",ie=H?.value||"",ee=l?.value.trim()||"",oe=d?.value.trim()||"",W=V?.value.trim()||"",be=(p?.value||"unpaid").toLowerCase(),he=["paid","partial"].includes(be)?be:"unpaid";if(!G||!ie||!ee){I(c("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),M?.focus();return}const Se=u?.value.trim()||"",we=m?.value.trim()||"",J=Xh(ee,oe),re=Se?Xh(Se,we):"",ue=new Date(J),Pe=re?new Date(re):null;if(Pe&&ue>Pe){I(c("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),u?.focus();return}if(z.projects.findIndex(De=>String(De.id)===String(e.id))===-1){I(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const ye=_(),{equipmentEstimate:te,discountValue:Ce,discountTypeValue:X,applyTax:Ae,companyShareEnabled:Ne,companySharePercent:je,finance:fe}=ye,qe=E?.value==="amount"?"amount":"percent",ze=b(S?.value||"");let Je=ze?Number.parseFloat(ze):null,Ye=[...w()];if(Number.isFinite(Je)&&Je>0&&Number.isFinite(Number(fe.totalWithTax))){const De=en({totalAmount:fe.totalWithTax,paidAmount:t.basePaidAmount||0,paidPercent:t.basePaidPercent||0,history:Ye}),At=new Date().toISOString();if(qe==="percent"){const Tt=Math.max(0,100-(De.paidPercent||0));if(Tt>B){const Ca=Math.min(Je,Tt),sn=Math.round(Ca*100)/100,ls=fe.totalWithTax>0?Math.round(sn/100*fe.totalWithTax*100)/100:null;Ye=[...Ye,{type:"percent",amount:ls,percentage:sn,value:sn,note:null,recordedAt:At}]}}else{const Tt=Math.max(0,fe.totalWithTax-(De.paidAmount||0));if(Tt>B){const Ca=Math.min(Je,Tt),sn=Math.round(Ca*100)/100,ls=fe.totalWithTax>0?Math.round(sn/fe.totalWithTax*100*100)/100:null;Ye=[...Ye,{type:"amount",amount:sn,percentage:ls,value:sn,note:null,recordedAt:At}]}}Ye!==t.payments&&(t.payments=Ye,L()),S&&(S.value=""),E&&(E.value="percent"),Je=null}const _t=en({totalAmount:fe.totalWithTax,paidAmount:t.basePaidAmount||0,paidPercent:t.basePaidPercent||0,history:Ye}),Zn=p?.dataset?.userSelected==="true",Ta=fn({manualStatus:Zn?he:e.paymentStatus||he,paidAmount:_t.paidAmount,paidPercent:_t.paidPercent,totalAmount:fe.totalWithTax}),cs=Zn?he:Ta;!Zn&&p&&(p.value=cs),p?.dataset&&delete p.dataset.userSelected,t.payments=Ye;const ce=No({projectCode:e.projectCode,title:G,type:ie,clientId:e.clientId,clientCompany:e.clientCompany,description:W,start:J,end:re||null,applyTax:Ae,paymentStatus:cs,equipmentEstimate:te,expenses:t.expenses,discount:Ce,discountType:X,companyShareEnabled:Ne&&Ae,companySharePercent:Ne&&Ae?je:null,companyShareAmount:fe.companyShareAmount,taxAmount:fe.taxAmount,totalWithTax:fe.totalWithTax,confirmed:e.confirmed,technicians:Array.isArray(e.technicians)?e.technicians:[],equipment:Bk(e),paidAmount:_t.paidAmount,paidPercentage:_t.paidPercent,paymentProgressType:_t.paymentProgressType,paymentProgressValue:_t.paymentProgressValue,payments:Ye});n.dataset.submitting="true";try{const De=await hi(e.projectId??e.id,ce),At=De?.projectId??De?.id??e.id;await Yu(At,cs),z.projects=ir(),z.reservations=We(),I(c("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),gn(),ka(),_a(),Ns(e.id)}catch(De){console.error("❌ [projects] Failed to update project from details view",De);const At=or(De)?De.message:c("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");I(At,"error")}finally{delete n.dataset.submitting}})}function xT(e){if(!e)return;const t={projectId:e.id,customerId:e.clientId||null,start:e.start||null,end:e.end||null,forceNotes:!!e.description};Ft({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(s=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",s)});let n="";try{n=encodeURIComponent(JSON.stringify(t))}catch(s){console.warn("⚠️ [projects] Unable to encode reservation context",s)}v.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(v.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function qT(e){if(!e)return;const t=z.projects.find(n=>String(n.id)===String(e));if(!t){I(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(t.confirmed===!0||t.confirmed==="true"){I(c("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await hi(t.projectId??t.id,{confirmed:!0});const n=await Ak(e);z.projects=ir(),z.reservations=We(),gn(),ka(),_a(),v.detailsModalEl&&v.detailsModalEl.classList.contains("show")&&v.detailsBody?.dataset.projectId===String(e)&&Ns(e),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),I(c("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=or(n)?n.message:c("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");I(a,"error")}}function kT(e,t={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=Jh(e.start||""),{date:s,time:r}=Jh(e.end||""),i=e.applyTax===!0||e.applyTax==="true",o=typeof e.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",l=["paid","partial"].includes(o)?o:"unpaid",d=e.discountType==="amount"?"amount":"percent",u=b(String(e.discount??e.discountValue??0)),m=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??e.companyShareAmountPercent??Fe,p=Number.parseFloat(b(String(m))),f=Number.isFinite(p)&&p>0?p:Fe,h=e.companyShareEnabled===!0||e.companyShareEnabled==="true"||e.company_share_enabled===!0||e.company_share_enabled==="true"||i&&Number.isFinite(p)&&p>0;return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-12 col-xl-8">
          <label class="form-label">${N(c("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control project-edit-input-wide" name="project-title" value="${N(e.title||"")}" required>
        </div>
        <div class="col-12 col-sm-6 col-xl-4 d-flex flex-column">
          <label class="form-label">${N(c("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select project-edit-select-lg" name="project-type" required>
            ${_T(e.type)}
          </select>
        </div>
        <div class="col-12">
          <div class="project-edit-inline-group project-edit-inline-group--dates">
            <div class="project-edit-inline-field">
              <label class="form-label">${N(c("projects.form.labels.startDate","تاريخ البدء"))}</label>
              <input type="date" class="form-control" name="project-start-date" value="${N(n)}" required>
            </div>
            <div class="project-edit-inline-field">
              <label class="form-label">${N(c("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
              <input type="date" class="form-control" name="project-end-date" value="${N(s)}">
            </div>
          </div>
          <div class="project-edit-inline-group project-edit-inline-group--times mt-2">
            <div class="project-edit-inline-field">
              <label class="form-label">${N(c("projects.form.labels.startTime","وقت البدء"))}</label>
              <input type="time" class="form-control" name="project-start-time" value="${N(a)}">
            </div>
            <div class="project-edit-inline-field">
              <label class="form-label">${N(c("projects.form.labels.endTime","وقت الانتهاء"))}</label>
              <input type="time" class="form-control" name="project-end-time" value="${N(r)}">
            </div>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">${N(c("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control project-edit-textarea" name="project-description" rows="5">${N(e.description||"")}</textarea>
        </div>
        <div class="col-12 col-md-4 col-xl-3">
          <label class="form-label">${N(c("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select project-edit-select-xs" name="project-payment-status" id="project-edit-payment-status">
            <option value="unpaid" ${l==="unpaid"?"selected":""}>${N(c("projects.paymentStatus.unpaid","غير مدفوع"))}</option>
            <option value="partial" ${l==="partial"?"selected":""}>${N(c("projects.paymentStatus.partial","مدفوع جزئياً"))}</option>
            <option value="paid" ${l==="paid"?"selected":""}>${N(c("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
      </div>

      <div class="row g-3 align-items-start mt-1">
        <div class="col-sm-6 col-lg-4 col-xl-3">
          <label class="form-label" for="project-edit-discount">${N(c("projects.form.labels.discount","الخصم"))}</label>
          <div class="input-group project-edit-input-group">
            <select id="project-edit-discount-type" name="project-discount-type" class="form-select project-edit-select-xs">
              <option value="percent" ${d==="percent"?"selected":""}>${N(c("projects.form.discount.percent","٪ نسبة"))}</option>
              <option value="amount" ${d==="amount"?"selected":""}>${N(c("projects.form.discount.amount","💵 مبلغ"))}</option>
            </select>
            <input type="text" id="project-edit-discount" name="project-discount" class="form-control project-edit-input-xs" value="${N(u)}" placeholder="0" inputmode="decimal">
          </div>
        </div>
        <div class="col-sm-6 col-lg-4 col-xl-3">
          <label class="form-label d-block" for="project-edit-company-share">${N(c("projects.form.labels.companyShare","نسبة الشركة والضريبة"))}</label>
          <div class="d-flex flex-column gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-company-share" name="project-company-share" data-company-share="${N(String(f))}" ${h?"checked":""}>
              <label class="form-check-label" for="project-edit-company-share">${N(c("projects.form.companyShareToggle","إضافة نسبة الشركة (10٪)"))}</label>
            </div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-tax" name="project-apply-tax" ${i?"checked":""}>
              <label class="form-check-label" for="project-edit-tax">${N(c("projects.form.taxLabel","شامل الضريبة (15٪)"))}</label>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-4 col-xl-3">
          <label class="form-label" for="project-edit-payment-progress-value">${N(c("projects.form.paymentProgress.label","💰 الدفعة المستلمة"))}</label>
          <div class="input-group project-edit-input-group">
            <select id="project-edit-payment-progress-type" name="project-payment-progress-type" class="form-select project-edit-select-xs">
              <option value="amount" >${N(c("projects.form.paymentProgress.amount","💵 مبلغ"))}</option>
              <option value="percent" selected>${N(c("projects.form.paymentProgress.percent","٪ نسبة"))}</option>
            </select>
            <input type="text" id="project-edit-payment-progress-value" name="project-payment-progress-value" class="form-control project-edit-input-xs" value="${N("")}" placeholder="0" inputmode="decimal">
          </div>
          <button type="button" class="modal-action-btn modal-action-btn--ghost project-edit-add-btn mt-2" id="project-edit-payment-add">${N(c("reservations.paymentHistory.actions.add","➕ إضافة دفعة"))}</button>
        </div>
      </div>

      <section class="project-edit-payment-history mt-4">
        <div id="project-edit-payment-summary" class="project-details-grid mb-3"></div>
        <div class="reservation-payment-history-block">
          <div class="reservation-payment-history__header">
            <h6 class="reservation-payment-history__title">${N(c("reservations.paymentHistory.title","سجل الدفعات"))}</h6>
          </div>
          <div id="project-edit-payment-history" class="reservation-payment-history"></div>
        </div>
      </section>

      <section class="project-edit-expenses mt-4">
        <h6 class="mb-2">${N(c("projects.form.labels.expenses","متطلبات المشروع"))}</h6>
        <div class="project-edit-expense-form">
          <div class="project-edit-expense-label-col">
            <input type="text" class="form-control project-edit-input-wide" id="project-edit-expense-label" placeholder="${N(c("projects.form.placeholders.expenseLabel","وصف المتطلب"))}">
          </div>
          <div class="project-edit-expense-amount-col">
            <input type="text" class="form-control project-edit-input-xs" id="project-edit-expense-amount" placeholder="${N(c("projects.form.placeholders.expenseAmount","المبلغ"))}" inputmode="decimal">
          </div>
          <div class="project-edit-expense-action-col">
            <button type="button" class="modal-action-btn modal-action-btn--warning project-edit-add-btn" data-action="add-expense">${N(c("projects.form.buttons.addExpense","➕ إضافة مصروف"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${VS(t.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${N(c("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${N(c("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function _T(e){return["commercial","coverage","photography","social"].map(n=>{const a=WS(n),s=n===e?"selected":"";return`<option value="${N(n)}" ${s}>${N(a)}</option>`}).join("")}function VS(e=[]){if(!Array.isArray(e)||e.length===0)return`<div class="text-muted small" data-empty>${N(c("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const t=N(c("actions.remove","إزالة"));return e.map(n=>{const a=N(n?.label||""),s=N(Qe(n?.amount||0)),r=N(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${s}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${r}" aria-label="${t}">✖</button>
        </div>
      `}).join("")}function TT(e=[]){return!Array.isArray(e)||e.length===0?`<div class="reservation-payment-history-empty">${N(c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة"))}</div>`:`<ul class="reservation-payment-history-list">${e.map(t=>{const n=t?.type==="percent"?c("reservations.paymentHistory.type.percent","دفعة نسبة"):t?.type==="amount"?c("reservations.paymentHistory.type.amount","دفعة مالية"):c("reservations.paymentHistory.type.unknown","دفعة"),a=Number.isFinite(Number(t?.amount))&&Number(t.amount)>0?N(Qe(Number(t.amount))):"—",s=Number.isFinite(Number(t?.percentage))&&Number(t.percentage)>0?`${b(Number(t.percentage).toFixed(2))}%`:"—",r=t?.recordedAt?b(ua(t.recordedAt)):"—",i=t?.note?`<div class="payment-history-note">${N(b(t.note))}</div>`:"";return`
      <li>
        <div class="payment-history-entry">
          <span class="payment-history-entry__type">${N(n)}</span>
          <span class="payment-history-entry__amount">${a}</span>
          <span class="payment-history-entry__percent">${s}</span>
          <span class="payment-history-entry__date">${r}</span>
        </div>
        ${i}
      </li>
    `}).join("")}</ul>`}function CT(e=[]){if(!Array.isArray(e)||e.length===0)return`<div class="reservation-payment-history__empty">${N(c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة"))}</div>`;const t=e.map((n,a)=>{const s=n?.type==="percent"?c("reservations.paymentHistory.type.percent","دفعة نسبة"):c("reservations.paymentHistory.type.amount","دفعة مالية"),r=Number.isFinite(Number(n?.amount))&&Number(n.amount)>0?N(Qe(Number(n.amount))):"—",i=Number.isFinite(Number(n?.percentage))&&Number(n.percentage)>0?`${b(Number(n.percentage).toFixed(2))}%`:"—",o=n?.recordedAt?b(ua(n.recordedAt)):"—",l=n?.note?N(b(n.note)):"",d=N(c("reservations.paymentHistory.actions.delete","حذف الدفعة"));return`
      <tr>
        <td>${N(s)}</td>
        <td>${r}</td>
        <td>${i}</td>
        <td>${o}</td>
        <td>${l}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${a}" aria-label="${d}">🗑️</button>
        </td>
      </tr>
    `}).join("");return`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${N(c("reservations.paymentHistory.headers.method","نوع الدفعة"))}</th>
            <th>${N(c("reservations.paymentHistory.headers.amount","المبلغ"))}</th>
            <th>${N(c("reservations.paymentHistory.headers.percent","النسبة"))}</th>
            <th>${N(c("reservations.paymentHistory.headers.date","التاريخ"))}</th>
            <th>${N(c("reservations.paymentHistory.headers.note","ملاحظات"))}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${t}</tbody>
      </table>
    </div>
  `}function PT(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(LT).filter(Boolean);if(n.length>0)return n;const a=yl(e.paidPercent??e.paid_percent),s=yl(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,i=KS(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:i}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:i}]:[]}function LT(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.toLowerCase().trim():null;n!=="percent"&&(n="amount");const a=yl(e.amount??(n==="amount"?e.value:null)),s=yl(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,i=e.note??e.memo??null,o=KS(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:i&&String(i).trim().length?String(i).trim():null,recordedAt:o}}function yl(e){if(e==null||e==="")return null;const t=b(String(e)).replace(/%/g,"").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function KS(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function $y(e,t){if(!t)return null;const{date:n,time:a}=NT(ua(t)),s=e==="start",r=s?"⏱️":"⌛",i=s?c("projects.details.labels.start","بداية الحجز"):c("projects.details.labels.end","نهاية الحجز");return{icon:r,label:i,value:n,meta:a}}function NT(e){if(!e||e==="—")return{date:"—",time:""};const t=e.split(" ").filter(Boolean),n=t.shift()||"—",a=t.join(" ");return{date:n,time:a}}function WS(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function $T(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(b(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=Js(t,a,s,!1,i,{start:e.start,end:e.end});if(Number.isFinite(o))return o;const l=Number(b(String(e.cost??0)));return Number.isFinite(l)?Math.round(l):0}function QS(e){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(e);if(a)return a}catch{}const t=window.location.hash?window.location.hash.replace(/^#/,""):"";if(t&&t.includes(`${e}=`))try{const a=new URLSearchParams(t).get(e);if(a)return a}catch{}return null}function DT(){return QS(xu)}function BT(){return QS(qu)}function FT(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const e=new URLSearchParams(window.location.search||""),t=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[xu,qu].forEach(l=>{e.has(l)&&(e.delete(l),n=!0)});let a=t,s=!1;if(t)try{const l=new URLSearchParams(t);let d=!1;[xu,qu].forEach(u=>{l.has(u)&&(l.delete(u),d=!0)}),d&&(a=l.toString(),s=!0)}catch{}if(!n&&!s)return;const r=window.location.pathname,i=e.toString(),o=`${r}${i?`?${i}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",o)}catch{}}function RT(){const e=DT(),t=BT();e&&(z.pendingProjectDetailId=e),t&&(z.pendingProjectEditId=t,z.pendingProjectDetailId||(z.pendingProjectDetailId=t)),(e||t)&&FT()}function MT(){if(!z.pendingProjectDetailId)return;const e=z.pendingProjectDetailId,t=String(e),n=z.projects.find(s=>[s?.id,s?.projectId,s?.project_id].some(i=>i!=null&&String(i)===t));if(!n)return;z.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??t;if(Ns(a),z.pendingProjectEditId!=null){const s=String(z.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(i=>i!=null&&String(i)===s)&&(z.pendingProjectEditId=null,setTimeout(()=>US(n),0))}}function HT(){document.addEventListener("DOMContentLoaded",()=>{AT(),RT(),dk(),nd(),uk(),gT(),bT(),mk(),wk(),jk(),Ik(),qk(),zk(),kk({onViewDetails:Ns}),ET({onOpenProject:Ns}),vS(),zT()}),document.addEventListener("language:changed",Dy),document.addEventListener("language:translationsReady",Dy),document.addEventListener("customers:changed",OT),document.addEventListener("technicians:updated",UT),document.addEventListener("reservations:changed",()=>Ck(Ns)),document.addEventListener(ei.USER_UPDATED,()=>{gn()})}async function zT(){try{await pi({suppressError:!0}),await Lo()}catch(e){console.error("❌ [projects] Failed to initialise projects data",e);const t=e?.message||c("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");I(t,"error")}finally{rk(),Xl(),Hk(),is(),gn(),_a(),ka(),MT()}}function Dy(){Xl(),is(),gn(),_a(),ka(),nd()}function OT(){_k(),Xl()}function UT(){Tk(),Xl()}Gs();Il();Rs();Mp();HT();document.addEventListener("DOMContentLoaded",()=>{vo(),Ia()});const By=.15,Ac={},VT="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let Ui=0;const Oe={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},le={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},Ec=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let Gt=null;const GS=["upcoming","ongoing","completed"];async function KT({forceProjects:e=!1}={}){try{await pi({suppressError:!0}),await Gl({force:e})}catch(t){console.error("❌ [projectsReports] Failed to load initial data",t),or(t)&&console.warn("Projects API error:",t.message)}ZS()}async function WT(){YT(),XS(),await QT();try{await KT({forceProjects:!0}),tA(),nC(),wn()}finally{JS()}document.addEventListener("language:changed",sC),document.addEventListener("projects:changed",()=>{lm().catch(e=>{console.error("❌ [projectsReports] Failed to refresh after projects change",e)})}),document.addEventListener("reservations:changed",()=>{lm().catch(e=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",e)})}),window.addEventListener("storage",rC)}document.addEventListener("DOMContentLoaded",WT);async function QT(){if(Gt)return Gt;if(typeof window>"u")return null;if(window.ApexCharts)return Gt=window.ApexCharts,Gt;try{await GT(VT),Gt=window.ApexCharts||null}catch(e){console.warn("ApexCharts failed to load",e),Gt=null}return Gt}function GT(e){return new Promise((t,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const a=document.querySelector(`script[src="${e}"]`);if(a){if(a.dataset.loaded==="true"){t();return}a.addEventListener("load",t,{once:!0}),a.addEventListener("error",()=>n(new Error(`Failed to load script ${e}`)),{once:!0});return}const s=document.createElement("script");s.src=e,s.async=!0,s.dataset.loaded="false",s.onload=()=>{s.dataset.loaded="true",t()},s.onerror=()=>n(new Error(`Failed to load script ${e}`)),document.head.appendChild(s)})}function YT(){le.search=document.getElementById("reports-search"),le.statusChips=document.getElementById("reports-status-chips"),le.payment=document.getElementById("reports-payment"),le.dateRange=document.getElementById("reports-date-range"),le.customRangeWrapper=document.getElementById("reports-custom-range"),le.startDate=document.getElementById("reports-start-date"),le.endDate=document.getElementById("reports-end-date"),le.refreshBtn=document.getElementById("reports-refresh"),le.kpiGrid=document.getElementById("reports-kpi-grid"),le.table=document.getElementById("reports-table"),le.tableBody=le.table?.querySelector("tbody"),le.tableMeta=document.getElementById("reports-table-meta"),le.tableEmpty=document.getElementById("reports-empty"),le.chartCards={},le.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(e=>{const t=e.dataset.chartCard;if(!t)return;le.chartCards[t]=e;const n=e.querySelector("[data-chart-loading]");n&&(le.chartLoaders[t]=n)})}function YS(e){const t=!!e;Object.entries(le.chartCards||{}).forEach(([n,a])=>{if(!a)return;a.classList.toggle("is-loading",t),a.setAttribute("aria-busy",t?"true":"false");const s=le.chartLoaders?.[n];s&&(s.hidden=!t)})}function XS(){Ui+=1,Ui===1&&YS(!0)}function JS(){Ui=Math.max(0,Ui-1),Ui===0&&YS(!1)}function ZS(){const{customers:e=[]}=ae();Oe.customers=Array.isArray(e)?e:[],Oe.reservations=We();const t=new Map(Oe.customers.map(a=>[String(a.id),a])),n=ir();Oe.projects=Array.isArray(n)?n.map(a=>XT(a,t)):[],Oe.totalProjects=Oe.projects.length}function XT(e,t){const n=e.paymentStatus==="paid"?"paid":"unpaid",a=t.get(String(e.clientId)),s=JT(e.id),r=s.reduce((y,E)=>y+ZT(E),0),i=eC(e),o=Number(e?.equipmentEstimate)||0,l=Number((o+i).toFixed(2)),d=e?.applyTax===!0||e?.applyTax==="true",u=d?Number((l*By).toFixed(2)):0,m=d?Number(((l+r)*By).toFixed(2)):0,p=Number((l+r+m).toFixed(2)),f=tC(e),h=e.start?new Date(e.start):null,g=e.end?new Date(e.end):null;return{raw:e,id:e.id,projectCode:e.projectCode||e.id,title:(e.title||"").trim(),clientId:e.clientId,clientName:a?.customerName||a?.name||"",clientCompany:e.clientCompany||a?.companyName||"",type:e.type||e.projectType||"",description:e.description||"",paymentStatus:n,confirmed:e.confirmed===!0||e.confirmed==="true",start:h,end:g,applyTax:d,status:f,reservationsTotal:Number(r.toFixed(2)),expensesTotal:i,subtotal:l,taxAmount:u,combinedTaxAmount:m,overallTotal:p,unpaidValue:n==="paid"?0:p,reservationsCount:s.length}}function JT(e){return Array.isArray(Oe.reservations)?Oe.reservations.filter(t=>String(t.projectId)===String(e)):[]}function ZT(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(b(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=Js(t,a,s,!1,i,{start:e.start,end:e.end});if(Number.isFinite(o))return o;const l=Number(b(String(e.cost??0)));return Number.isFinite(l)?Math.round(l):0}function eC(e){return typeof e.expensesTotal=="number"?Number(e.expensesTotal)||0:Array.isArray(e.expenses)?e.expenses.reduce((t,n)=>t+(Number(n.amount)||0),0):0}function tC(e){const t=new Date,n=e.start?new Date(e.start):null,a=e.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function nC(){if(le.search){let e;le.search.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>{Oe.filters.search=le.search.value.trim(),wn()},180)})}le.payment&&(le.payment.value=Oe.filters.payment,le.payment.addEventListener("change",()=>{Oe.filters.payment=le.payment.value||"all",wn()})),le.dateRange&&(le.dateRange.addEventListener("change",aC),le.dateRange.value=Oe.filters.range),le.startDate&&le.startDate.addEventListener("change",()=>{Oe.filters.startDate=le.startDate.value,Oe.filters.range==="custom"&&wn()}),le.endDate&&le.endDate.addEventListener("change",()=>{Oe.filters.endDate=le.endDate.value,Oe.filters.range==="custom"&&wn()}),le.refreshBtn&&le.refreshBtn.addEventListener("click",()=>{if(Oe.filters.range!=="custom"){wn();return}Oe.filters.startDate=le.startDate?.value||"",Oe.filters.endDate=le.endDate?.value||"",wn()})}function aC(e){const t=e.target.value;Oe.filters.range=t,t==="custom"?le.customRangeWrapper?.classList.add("active"):(le.customRangeWrapper?.classList.remove("active"),Oe.filters.startDate="",Oe.filters.endDate="",le.startDate&&(le.startDate.value=""),le.endDate&&(le.endDate.value=""),wn())}async function lm(){XS();try{await Promise.all([Lo(),Zs()])}catch(e){console.error("❌ [projectsReports] Data mutation refresh failed",e),or(e)&&console.warn("Projects API error:",e.message)}finally{ZS(),wn(),JS()}}function sC(){tA(),wn()}function rC(e){e.key&&!["projects","reservations","customers"].includes(e.key)||lm().catch(t=>{console.error("❌ [projectsReports] Storage sync failed",t)})}function wn(){const e=iC();df(),lC(e),uC(e),mC(e),pC(e),fC(e),hC(e)}function iC(){const{search:e,statuses:t,payment:n,range:a,startDate:s,endDate:r}=Oe.filters,i=eA(e),o=new Date,l=Number(a);let d=null;if(a==="custom"){d=s?new Date(s):null;const u=r?new Date(r):null;return Oe.projects.filter(m=>!Fy(m,t)||!Ry(m,n)||!My(m,i)?!1:cC(m.start,d,u))}return a!=="all"&&Number.isFinite(l)&&(d=new Date,d.setDate(o.getDate()-l)),Oe.projects.filter(u=>!Fy(u,t)||!Ry(u,n)||!My(u,i)?!1:a==="all"?!0:oC(u.start,d,o))}function Fy(e,t){return t.includes(e.status)}function Ry(e,t){return t==="all"?!0:e.paymentStatus===t}function My(e,t){return t?eA([e.title,e.projectCode,e.clientName,e.clientCompany,e.type,e.description].filter(Boolean).join(" ")).includes(t):!0}function oC(e,t,n){return!e||!(e instanceof Date)||Number.isNaN(e.getTime())?!1:t?e>=t&&e<=n:!0}function cC(e,t,n){if(!t&&!n)return!0;if(!e||Number.isNaN(e.getTime()))return!1;const a=e.getTime();return!(t&&!Number.isNaN(t.getTime())&&a<t.getTime()||n&&!Number.isNaN(n.getTime())&&a>n.getTime())}function eA(e){return e?b(String(e)).toLowerCase().trim():""}function lC(e){if(!le.kpiGrid)return;const t=e.length,n=e.reduce((i,o)=>i+o.overallTotal,0),a=e.reduce((i,o)=>i+o.unpaidValue,0),s=e.reduce((i,o)=>i+o.expensesTotal,0),r=[{icon:Ec.projects,label:c("projects.reports.kpi.totalProjects","Total projects"),value:dm(t),meta:c("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:Ec.value,label:c("projects.reports.kpi.totalValue","Total value"),value:Bc(n),meta:c("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:Ec.outstanding,label:c("projects.reports.kpi.unpaidValue","Outstanding value"),value:Bc(a),meta:c("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:Ec.expenses,label:c("projects.reports.kpi.expenses","Total expenses"),value:Bc(s),meta:c("projects.reports.kpi.expensesMeta","Expenses for included projects")}];le.kpiGrid.innerHTML=r.map(({icon:i,label:o,value:l,meta:d})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${i}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${Qt(o)}</p>
        <p class="reports-kpi-value">${Qt(l)}</p>
        <span class="reports-kpi-meta">${Qt(d)}</span>
      </div>
    </div>
  `).join("")}function tA(){if(!le.statusChips)return;const e=GS.map(t=>{const n=c(`projects.status.${t}`,t);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${t}">${Qt(n)}</button>`}).join("");le.statusChips.innerHTML=e,le.statusChips.dataset.listenerAttached||(le.statusChips.addEventListener("click",dC),le.statusChips.dataset.listenerAttached="true"),df()}function dC(e){const t=e.target.closest("[data-status]");if(!t)return;const n=t.dataset.status;if(!n)return;const a=new Set(Oe.filters.statuses);a.has(n)?a.delete(n):a.add(n),a.size===0&&GS.forEach(s=>a.add(s)),Oe.filters.statuses=Array.from(a),df(),wn()}function df(){if(!le.statusChips)return;const e=new Set(Oe.filters.statuses);le.statusChips.querySelectorAll("[data-status]").forEach(t=>{t.classList.toggle("is-active",e.has(t.dataset.status))})}function uC(e){if(!Gt)return;const t=document.getElementById("reports-status-chart");if(!t)return;const n=["upcoming","ongoing","completed"],a=n.map(l=>e.filter(d=>d.status===l).length),s=n.map(l=>c(`projects.status.${l}`,l)),i=a.reduce((l,d)=>l+d,0)>0?a:[],o={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:s,series:i,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:l=>Number.isFinite(l)?`${Math.round(l)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:l=>Qs(l)}},noData:{text:c("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};rd("status",t,o)}function mC(e){if(!Gt)return;const t=document.getElementById("reports-timeline-chart");if(!t)return;const n=new Map,a=new Intl.DateTimeFormat(gC(),{month:"short",year:"numeric"});e.forEach(u=>{if(!u.start||Number.isNaN(u.start.getTime()))return;const m=`${u.start.getFullYear()}-${u.start.getMonth()+1}`,p=n.get(m)||{total:0,label:a.format(u.start)};p.total+=u.overallTotal,n.set(m,p)});const r=Array.from(n.keys()).sort((u,m)=>{const[p,f]=u.split("-").map(Number),[h,g]=m.split("-").map(Number);return p===h?f-g:p-h}).slice(-12),i=r.map(u=>n.get(u)?.label||u),o=r.map(u=>Math.round(n.get(u)?.total||0)),l=o.length?[{name:c("projects.reports.datasets.value","Total value"),data:o}]:[],d={chart:{type:"area",height:320,toolbar:{show:!1}},series:l,xaxis:{categories:i,labels:{rotate:-35}},yaxis:{labels:{formatter:u=>Qs(u)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:u=>Qs(u)}},noData:{text:c("projects.reports.noData","لا توجد بيانات متاحة")}};rd("timeline",t,d)}function pC(e){if(!Gt)return;const t=document.getElementById("reports-expense-chart");if(!t)return;const n=[...e].sort((d,u)=>u.overallTotal-d.overallTotal).slice(0,6),a=n.map(d=>d.title||d.projectCode),s=n.map(d=>Math.round(d.overallTotal)),r=n.map(d=>Math.round(d.expensesTotal)),i=a.length?[{name:c("projects.reports.datasets.value","Total value"),data:s},{name:c("projects.reports.datasets.expenses","Expenses"),data:r}]:[],l={chart:{type:"bar",height:Math.max(320,a.length*60||0),toolbar:{show:!1}},series:i,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:a,labels:{formatter:d=>Qs(d)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:d=>Qs(d)}},noData:{text:c("projects.reports.noData","لا توجد بيانات متاحة")}};rd("expenses",t,l)}function fC(e){if(!Gt)return;const t=document.getElementById("reports-clients-chart");if(!t)return;const n=new Map;e.forEach(l=>{const d=l.clientName||l.clientCompany||c("projects.fallback.unknownClient","Unknown client"),u=n.get(d)||0;n.set(d,u+l.overallTotal)});const a=Array.from(n.entries()).sort((l,d)=>d[1]-l[1]).slice(0,6),s=a.map(([l])=>l),r=a.map(([,l])=>Math.round(l)),i=r.length?[{name:c("projects.reports.datasets.value","Total value"),data:r}]:[],o={chart:{type:"bar",height:320,toolbar:{show:!1}},series:i,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:s,labels:{rotate:-35}},yaxis:{labels:{formatter:l=>Qs(l)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:l=>Qs(l)}},legend:{show:!1},noData:{text:c("projects.reports.noData","لا توجد بيانات متاحة")}};rd("clients",t,o)}function rd(e,t,n={}){if(!Gt||!t)return;if(Ac[e]){try{Ac[e].destroy()}catch(s){console.warn(`⚠️ [projectsReports] Failed to destroy ${e} chart`,s)}delete Ac[e]}t.innerHTML="";const a={...n};Array.isArray(a.series)||(a.series=[]);try{const s=new Gt(t,a);Ac[e]=s,s.render().catch(r=>{console.error(`❌ [projectsReports] Failed to render ${e} chart`,r)})}catch(s){console.error(`❌ [projectsReports] Failed to render ${e} chart`,s)}}function hC(e){if(!le.table||!le.tableBody||!le.tableEmpty)return;if(!e.length){le.table.style.display="none",le.tableEmpty.classList.add("active"),le.tableMeta&&(le.tableMeta.textContent="");return}le.table.style.display="",le.tableEmpty.classList.remove("active");const t=e.map(n=>{const a=yC(n.start,n.end),s=c(`projects.status.${n.status}`,n.status),r=c(`projects.paymentStatus.${n.paymentStatus}`,n.paymentStatus),i=n.clientCompany?`${Qt(n.clientName)} <small class="text-muted">${Qt(n.clientCompany)}</small>`:Qt(n.clientName||c("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${Qt(n.title||n.projectCode)}</span>
            <small class="text-muted">${Qt(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${i}</td>
        <td>${Qt(s)}</td>
        <td>${Qt(a)}</td>
        <td>${Qt(Bc(n.overallTotal))}</td>
        <td>${Qt(r)}</td>
      </tr>
    `}).join("");if(le.tableBody.innerHTML=t,le.tableMeta){const n=c("projects.reports.table.meta","Showing {count} of {total} projects");le.tableMeta.textContent=n.replace("{count}",dm(e.length)).replace("{total}",dm(Oe.totalProjects))}}function yC(e,t){if(!e&&!t)return"—";const n=e?mt(e.toISOString()):"—",a=t?mt(t.toISOString()):"—";return t?`${n} → ${a}`:n}function Bc(e){const t=Number(e)||0,a=Le()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",s=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${b(s)} SR`}function dm(e){const n=Le()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return b(new Intl.NumberFormat(n).format(e))}function Qs(e){const n=Le()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return b(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(e))}function gC(){return Le()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function Qt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}Zr({ar:{"users.nav.brand":"🛡️ إدارة المستخدمين","users.actions.refresh":"🔄 تحديث القائمة","users.form.title":"➕ إضافة أو تعديل مستخدم","users.form.subtitle":"يمكنك إضافة مستخدم جديد، تعديل بياناته، أو إعادة تعيين كلمة المرور.","users.form.adminOnly":"متاح للمسؤولين فقط","users.form.fields.username":"👤 اسم المستخدم","users.form.fields.password":"🔑 كلمة المرور","users.form.fields.role":"🎯 الصلاحية","users.form.placeholders.username":"مثال: admin","users.form.placeholders.password":"كلمة المرور الجديدة (اختياري للتعديل)","users.form.help.password":"متطلبات كلمة المرور: 8 أحرف على الأقل.","users.form.selectRole":"اختر الصلاحية","users.roles.admin":"مسؤول","users.roles.manager":"مدير","users.roles.technician":"فني","users.form.actions.cancel":"إلغاء","users.form.actions.submit":"💾 حفظ المستخدم","users.form.actions.update":"💾 تحديث المستخدم","users.actions.edit":"✏️ تعديل","users.actions.logs":"📜 السجلات","users.actions.delete":"🗑️ حذف","users.table.title":"👥 قائمة المستخدمين","users.table.subtitle":"استعرض جميع المستخدمين، مع إمكانية التعديل أو حذف الحسابات، والاطلاع على السجلات.","users.table.search":"ابحث بالاسم أو الصلاحية","users.table.headers.username":"👤 اسم المستخدم","users.table.headers.role":"🎯 الصلاحية","users.table.headers.lastLogin":"آخر تسجيل دخول","users.table.headers.createdAt":"تاريخ الإنشاء","users.table.headers.sessions":"سجلات الجلسات","users.table.headers.activity":"سجلات النشاط","users.table.headers.actions":"⚙️ الإجراءات","users.table.loading":"⏳ جارٍ تحميل المستخدمين...","users.table.empty":"لا توجد حسابات حالياً.","users.table.emptyFilter":"لا توجد نتائج مطابقة لخيارات البحث.","users.table.selfBadge":"🧑‍💻 أنت","users.logs.title":"📜 سجلات المستخدم","users.logs.sessionsTitle":"🕒 سجلات الجلسات","users.logs.activityTitle":"📘 سجلات النشاط","users.logs.loading":"جارٍ تحميل السجلات...","users.logs.headers.login":"تسجيل الدخول","users.logs.headers.logout":"تسجيل الخروج","users.logs.headers.ip":"عنوان IP","users.logs.headers.timestamp":"التاريخ","users.logs.headers.action":"الإجراء","users.logs.headers.details":"تفاصيل","users.logs.emptySessions":"لا توجد سجلات جلسات متاحة.","users.logs.emptyActivity":"لا توجد سجلات نشاط متاحة.","users.logs.actions.loginSuccess":"تم تسجيل الدخول بنجاح","users.logs.actions.logout":"تم تسجيل الخروج","users.logs.actions.preferencesUpdate":"تم تحديث التفضيلات","users.logs.actions.authorizationDenied":"تم رفض التفويض بسبب الصلاحيات","users.logs.actions.reservationCreate":"تم إنشاء حجز","users.logs.actions.reservationUpdate":"تم تحديث الحجز","users.logs.actions.reservationDelete":"تم حذف الحجز","users.logs.actions.reservationConfirm":"تم تأكيد الحجز","users.logs.actions.maintenanceCreate":"تم إنشاء تذكرة صيانة","users.logs.actions.maintenanceUpdate":"تم تحديث تذكرة الصيانة","users.logs.actions.maintenanceClose":"تم إغلاق تذكرة الصيانة","users.logs.actions.projectCreate":"تم إنشاء مشروع","users.logs.actions.projectUpdate":"تم تحديث المشروع","users.logs.actions.projectDelete":"تم حذف المشروع","users.logs.actions.unknown":"نشاط عام","users.logs.details.empty":"لا توجد بيانات","users.logs.actions.close":"إغلاق","users.messages.created":"✅ تم إنشاء المستخدم بنجاح.","users.messages.updated":"✅ تم تحديث بيانات المستخدم.","users.messages.deleted":"🗑️ تم حذف المستخدم.","users.messages.loadFailed":"تعذر تحميل قائمة المستخدمين. حاول مرة أخرى.","users.messages.logsFailed":"تعذر تحميل سجلات المستخدم المحدد.","users.messages.deleteConfirm":"هل أنت متأكد من حذف هذا المستخدم؟ لا يمكن التراجع.","users.messages.deleteBlockedSelf":"لا يمكنك حذف الحساب الذي تستخدمه حالياً.","users.messages.saveBlocked":"يرجى تحديد حساب لتعديله أو إدخال البيانات المطلوبة.","users.messages.validation.passwordRequired":"يجب إدخال كلمة مرور عند إنشاء مستخدم جديد.","users.messages.validation.roleRequired":"يرجى تحديد صلاحية للمستخدم.","users.messages.notAdmin":"هذه الصفحة متاحة للمسؤولين فقط.","users.messages.createdAt":"أنشئ في {date}","users.messages.lastLogin":"آخر دخول في {date}","users.badges.currentUser":"🧑‍💻 الحساب الحالي","users.badges.role.admin":"مسؤول","users.badges.role.manager":"مدير","users.badges.role.technician":"فني"},en:{"users.nav.brand":"🛡️ User Management","users.actions.refresh":"🔄 Refresh List","users.form.title":"➕ Add or Update User","users.form.subtitle":"Create a new user, adjust their permissions, or reset the password.","users.form.adminOnly":"Admins only","users.form.fields.username":"👤 Username","users.form.fields.password":"🔑 Password","users.form.fields.role":"🎯 Role","users.form.placeholders.username":"e.g. admin","users.form.placeholders.password":"New password (optional when editing)","users.form.help.password":"Password must be at least 8 characters long.","users.form.selectRole":"Select a role","users.roles.admin":"Admin","users.roles.manager":"Manager","users.roles.technician":"Technician","users.form.actions.cancel":"Cancel","users.form.actions.submit":"💾 Save User","users.form.actions.update":"💾 Update User","users.actions.edit":"✏️ Edit","users.actions.logs":"📜 Logs","users.actions.delete":"🗑️ Delete","users.table.title":"👥 Users List","users.table.subtitle":"Review all accounts, edit or delete them, and inspect audit logs.","users.table.search":"Search by username or role","users.table.headers.username":"👤 Username","users.table.headers.role":"🎯 Role","users.table.headers.lastLogin":"Last Login","users.table.headers.createdAt":"Created At","users.table.headers.sessions":"Sessions","users.table.headers.activity":"Activity","users.table.headers.actions":"⚙️ Actions","users.table.loading":"⏳ Loading users...","users.table.empty":"No accounts found yet.","users.table.emptyFilter":"No results match your filters.","users.table.selfBadge":"🧑‍💻 You","users.logs.title":"📜 User Logs","users.logs.sessionsTitle":"🕒 Session Logs","users.logs.activityTitle":"📘 Activity Logs","users.logs.loading":"Loading logs...","users.logs.headers.login":"Login","users.logs.headers.logout":"Logout","users.logs.headers.ip":"IP Address","users.logs.headers.timestamp":"Timestamp","users.logs.headers.action":"Action","users.logs.headers.details":"Details","users.logs.emptySessions":"No session history available.","users.logs.emptyActivity":"No activity history available.","users.logs.actions.loginSuccess":"Successful login","users.logs.actions.logout":"User signed out","users.logs.actions.preferencesUpdate":"Preferences updated","users.logs.actions.authorizationDenied":"Authorisation denied","users.logs.actions.reservationCreate":"Reservation created","users.logs.actions.reservationUpdate":"Reservation updated","users.logs.actions.reservationDelete":"Reservation deleted","users.logs.actions.reservationConfirm":"Reservation confirmed","users.logs.actions.maintenanceCreate":"Maintenance ticket created","users.logs.actions.maintenanceUpdate":"Maintenance ticket updated","users.logs.actions.maintenanceClose":"Maintenance ticket closed","users.logs.actions.projectCreate":"Project created","users.logs.actions.projectUpdate":"Project updated","users.logs.actions.projectDelete":"Project deleted","users.logs.actions.unknown":"General activity","users.logs.details.empty":"No data","users.logs.actions.close":"Close","users.messages.created":"✅ User created successfully.","users.messages.updated":"✅ User updated successfully.","users.messages.deleted":"🗑️ User removed.","users.messages.loadFailed":"Failed to load users. Please try again.","users.messages.logsFailed":"Could not load logs for that user.","users.messages.deleteConfirm":"Are you sure you want to delete this user? This cannot be undone.","users.messages.deleteBlockedSelf":"You cannot delete the account you are currently using.","users.messages.saveBlocked":"Select an account to edit or provide the required information.","users.messages.validation.passwordRequired":"Password is required when creating a new user.","users.messages.validation.roleRequired":"Please choose a role for the user.","users.messages.notAdmin":"This page is restricted to administrator accounts.","users.messages.createdAt":"Created at {date}","users.messages.lastLogin":"Last login at {date}","users.badges.currentUser":"🧑‍💻 Current account","users.badges.role.admin":"Admin","users.badges.role.manager":"Manager","users.badges.role.technician":"Technician"}});Gs();vo();const at={users:[],filtered:[],loading:!1,processing:!1,editingId:null},bC={LOGIN_SUCCESS:{key:"users.logs.actions.loginSuccess",fallback:"Successful login"},LOGOUT:{key:"users.logs.actions.logout",fallback:"User signed out"},PREFERENCES_UPDATE:{key:"users.logs.actions.preferencesUpdate",fallback:"Preferences updated"},AUTHORIZATION_DENIED:{key:"users.logs.actions.authorizationDenied",fallback:"Authorisation denied"},RESERVATION_CREATE:{key:"users.logs.actions.reservationCreate",fallback:"Reservation created"},RESERVATION_UPDATE:{key:"users.logs.actions.reservationUpdate",fallback:"Reservation updated"},RESERVATION_DELETE:{key:"users.logs.actions.reservationDelete",fallback:"Reservation deleted"},RESERVATION_CONFIRM:{key:"users.logs.actions.reservationConfirm",fallback:"Reservation confirmed"},MAINTENANCE_CREATE:{key:"users.logs.actions.maintenanceCreate",fallback:"Maintenance ticket created"},MAINTENANCE_UPDATE:{key:"users.logs.actions.maintenanceUpdate",fallback:"Maintenance ticket updated"},MAINTENANCE_CLOSE:{key:"users.logs.actions.maintenanceClose",fallback:"Maintenance ticket closed"},PROJECT_CREATE:{key:"users.logs.actions.projectCreate",fallback:"Project created"},PROJECT_UPDATE:{key:"users.logs.actions.projectUpdate",fallback:"Project updated"},PROJECT_DELETE:{key:"users.logs.actions.projectDelete",fallback:"Project deleted"}},vC={true:{key:"common.boolean.yes",fallback:"Yes"},false:{key:"common.boolean.no",fallback:"No"}},SC={errorAlert:"#users-error",refreshBtn:"#refresh-users-btn",logoutBtn:"#logout-btn",form:"#user-form",cancelBtn:"#user-cancel-btn",usernameInput:"#user-username",passwordInput:"#user-password",roleSelect:"#user-role",idInput:"#user-id",submitBtn:'#user-form button[type="submit"]',searchInput:"#users-search",tableBody:"#users-table tbody",sessionsBody:"#user-sessions-body",activityBody:"#user-activity-body",modal:"#userLogsModal",modalTitle:"#userLogsModalLabel"},se={};let Vd=null;function AC(){Object.entries(SC).forEach(([e,t])=>{se[e]=document.querySelector(t)})}function $e(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function EC(e){return e.replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase())}function uf(e){if(!e)return"";const t=e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/[_\-]+/g," ").replace(/\s+/g," ").trim();return EC(t||e)}function wC(e){const t=String(e||"").trim().toUpperCase();if(!t)return c("users.logs.actions.unknown","General activity");const n=bC[t];return n?c(n.key,n.fallback):uf(t)}function nA(e){const t=vC[String(!!e)];return t?c(t.key,t.fallback):e?"Yes":"No"}function jC(e){if(!Array.isArray(e)||e.length===0)return`<span class="text-muted">${$e(c("users.logs.details.empty","No data"))}</span>`;if(e.every(n=>n==null||["string","number","boolean"].includes(typeof n))){const n=e.map(a=>a==null?c("users.logs.details.empty","No data"):typeof a=="boolean"?nA(a):typeof a=="number"?b(String(a)):String(a)).join("، ");return`<span class="users-logs-detail-text">${$e(n)}</span>`}try{return`<pre class="users-logs-detail-code">${$e(JSON.stringify(e,null,2))}</pre>`}catch{return`<span class="users-logs-detail-text">${$e(String(e))}</span>`}}function um(e){if(e==null||e==="")return`<span class="text-muted">${$e(c("users.logs.details.empty","No data"))}</span>`;if(typeof e=="boolean"){const t=nA(e);return`<span class="${e?"users-logs-status users-logs-status--yes":"users-logs-status users-logs-status--no"}">${$e(t)}</span>`}if(typeof e=="number")return`<span class="users-logs-detail-text">${$e(b(String(e)))}</span>`;if(typeof e=="string")return`<span class="users-logs-detail-text">${$e(e)}</span>`;if(Array.isArray(e))return jC(e);if(typeof e=="object"){const t=Object.entries(e);return t.length===0?`<span class="text-muted">${$e(c("users.logs.details.empty","No data"))}</span>`:`<div class="users-logs-details users-logs-details--nested">${t.map(([a,s])=>{const r=uf(a);return`
        <div class="users-logs-detail-row users-logs-detail-row--nested">
          <span class="users-logs-detail-key">${$e(r)}</span>
          <span class="users-logs-detail-value">${um(s)}</span>
        </div>
      `}).join("")}</div>`}try{return`<span class="users-logs-detail-text">${$e(String(e))}</span>`}catch{return`<span class="text-muted">${$e(c("users.logs.details.empty","No data"))}</span>`}}function Wa(e){if(se.errorAlert){if(!e){se.errorAlert.classList.add("d-none"),se.errorAlert.textContent="";return}se.errorAlert.textContent=e,se.errorAlert.classList.remove("d-none")}}function Hy(e){at.loading=e,se.refreshBtn&&(se.refreshBtn.disabled=e),mm()}function fo(e){if(at.processing=e,!se.form)return;se.form.querySelectorAll("input, select, button").forEach(n=>{n.disabled=e&&n.type!=="search"})}function ho(e){return e?mt(e):"—"}function IC(e){const t=(e||"").toLowerCase(),n={admin:c("users.badges.role.admin","Admin"),manager:c("users.badges.role.manager","Manager"),technician:c("users.badges.role.technician","Technician")};return`<span class="${t==="admin"?"badge badge-outline badge-error":t==="manager"?"badge badge-outline badge-primary":"badge badge-outline"}">${$e(n[t]||e||"")}</span>`}function xC(){return`<span class="badge badge-outline badge-info">${$e(c("users.badges.currentUser","🧑‍💻 Current account"))}</span>`}function qC(e){const t=$e(e.username||""),n=$e(ho(e.last_login)),a=$e(ho(e.created_at)),s=b(String(e.session_count??0)),r=b(String(e.activity_count??0)),i=e.is_current_user?"disabled":"",o=e.is_current_user?` <span class="ms-1">${xC()}</span>`:"",l=$e(c("users.actions.edit","✏️ Edit")),d=$e(c("users.actions.logs","📜 Logs")),u=$e(c("users.actions.delete","🗑️ Delete"));return`
    <tr data-user-id="${e.id}">
      <td class="font-semibold text-base-content">${t}${o}</td>
      <td>${IC(e.role)}</td>
      <td>${n}</td>
      <td>${a}</td>
      <td><span class="badge badge-outline badge-primary badge-sm">${s}</span></td>
      <td><span class="badge badge-outline badge-secondary badge-sm">${r}</span></td>
      <td>
        <div class="flex flex-wrap items-center gap-1.5" role="group">
          <button type="button" class="btn btn-ghost btn-sm" data-action="logs" data-id="${e.id}" title="${d}">📜</button>
          <button type="button" class="btn btn-outline btn-sm" data-action="edit" data-id="${e.id}" title="${l}">✏️</button>
          <button type="button" class="btn btn-outline btn-error btn-sm" data-action="delete" data-id="${e.id}" ${i} title="${u}">🗑️</button>
        </div>
      </td>
    </tr>
  `}function mm(){if(se.tableBody){if(at.loading){se.tableBody.innerHTML=`
      <tr>
        <td colspan="7" class="text-center text-muted">${$e(c("users.table.loading","⏳ Loading users..."))}</td>
      </tr>
    `;return}if(!Array.isArray(at.filtered)||at.filtered.length===0){const e=!!(se.searchInput&&se.searchInput.value.trim()),t=e?"users.table.emptyFilter":"users.table.empty";se.tableBody.innerHTML=`
      <tr>
        <td colspan="7" class="text-center text-muted">${$e(c(t,e?"No results match your filters.":"No accounts found yet."))}</td>
      </tr>
    `;return}se.tableBody.innerHTML=at.filtered.map(qC).join("")}}function pm(){const e=(se.searchInput?.value||"").trim().toLowerCase();if(!e){at.filtered=[...at.users],mm();return}at.filtered=at.users.filter(t=>{const n=(t.username||"").toLowerCase().includes(e),a=(t.role||"").toLowerCase().includes(e);return n||a}),mm()}async function id(){if(!at.loading){Wa(""),Hy(!0);try{const e=await pe("/users/"),t=Array.isArray(e?.data)?e.data:[];at.users=t.map(n=>({...n})),pm()}catch(e){console.error("❌ Failed to load users",e);const t=e instanceof Ge?e.message:c("users.messages.loadFailed","Failed to load users. Please try again.");Wa(t),at.users=[],at.filtered=[]}finally{Hy(!1)}}}function mf({editing:e,user:t}){const n=!!(e&&t);if(at.editingId=n?Number(t.id):null,!se.idInput||!se.usernameInput||!se.passwordInput||!se.roleSelect||!se.submitBtn||!se.cancelBtn)return;se.idInput.value=n?String(t.id):"",se.usernameInput.value=n?String(t.username||""):"",se.roleSelect.value=n?String(t.role||""):"",se.passwordInput.value="",se.passwordInput.required=!n;const a=n?"users.form.actions.update":"users.form.actions.submit";se.submitBtn.dataset.i18nKey=a,se.submitBtn.textContent=c(a,n?"Update user":"Save user"),n?(se.cancelBtn.classList.remove("d-none"),se.usernameInput.focus()):se.cancelBtn.classList.add("d-none")}function pf(){se.form&&(se.form.reset(),mf({editing:!1,user:null}))}function ff(e){return at.users.find(t=>Number(t.id)===Number(e))}async function kC(e){if(e.preventDefault(),!se.usernameInput||!se.passwordInput||!se.roleSelect)return;const t=se.usernameInput.value.trim(),n=se.passwordInput.value,a=se.roleSelect.value.trim().toLowerCase();if(!t){I(c("users.messages.saveBlocked","Select an account to edit or provide the required information.")),se.usernameInput.focus();return}if(!a){I(c("users.messages.validation.roleRequired","Please choose a role for the user.")),se.roleSelect.focus();return}const s=Number.isFinite(at.editingId);if(!s&&n.trim()===""){I(c("users.messages.validation.passwordRequired","Password is required when creating a new user.")),se.passwordInput.focus();return}const r={username:t,role:a};n.trim()!==""&&(r.password=n),fo(!0),Wa("");try{s?(await pe(`/users/?id=${at.editingId}`,{method:"PATCH",body:r}),I(c("users.messages.updated","✅ User updated successfully."))):(await pe("/users/",{method:"POST",body:r}),I(c("users.messages.created","✅ User created successfully."))),pf(),await id()}catch(i){if(console.error("❌ Failed to save user",i),i instanceof Ge){const o=i.payload?.error||i.message;Wa(o)}else Wa(c("users.messages.loadFailed","Failed to load users. Please try again."))}finally{fo(!1)}}function _C(){pf()}async function TC(e){const t=ff(e);if(!t)return;if(t.is_current_user){I(c("users.messages.deleteBlockedSelf","You cannot delete the account you are currently using."));return}if(window.confirm(c("users.messages.deleteConfirm","Are you sure you want to delete this user? This cannot be undone."))){fo(!0);try{await pe(`/users/?id=${e}`,{method:"DELETE"}),I(c("users.messages.deleted","🗑️ User removed.")),at.editingId===Number(e)&&pf(),await id()}catch(a){console.error("❌ Failed to delete user",a),a instanceof Ge?Wa(a.payload?.error||a.message):Wa(c("users.messages.loadFailed","Failed to load users. Please try again."))}finally{fo(!1)}}}function fm(e){if(se.sessionsBody){if(!Array.isArray(e)||e.length===0){se.sessionsBody.innerHTML=`
      <tr>
        <td colspan="3" class="text-center text-muted">${$e(c("users.logs.emptySessions","No session history available."))}</td>
      </tr>
    `;return}se.sessionsBody.innerHTML=e.map(t=>`
    <tr>
      <td>${$e(ho(t.login_time))}</td>
      <td>${$e(ho(t.logout_time))}</td>
      <td>${$e(t.ip_address||"—")}</td>
    </tr>
  `).join("")}}function CC(e){if(e&&typeof e=="object"&&!Array.isArray(e)){const t=Object.entries(e);return t.length?`<div class="users-logs-details">${t.map(([a,s])=>{const r=uf(a);return`
        <div class="users-logs-detail-row">
          <span class="users-logs-detail-key">${$e(r)}</span>
          <span class="users-logs-detail-value">${um(s)}</span>
        </div>
      `}).join("")}</div>`:`<span class="text-muted">${$e(c("users.logs.details.empty","No data"))}</span>`}return um(e)}function hm(e){if(se.activityBody){if(!Array.isArray(e)||e.length===0){se.activityBody.innerHTML=`
      <tr>
        <td colspan="3" class="text-center text-muted">${$e(c("users.logs.emptyActivity","No activity history available."))}</td>
      </tr>
    `;return}se.activityBody.innerHTML=e.map(t=>`
    <tr>
      <td>${$e(ho(t.timestamp))}</td>
      <td>${$e(wC(t.action))}</td>
      <td>${CC(t.details)}</td>
    </tr>
  `).join("")}}async function PC(e){const t=ff(e);if(!t||!se.modal||!se.modalTitle)return;const n=se.modal;Vd=Vd||new window.bootstrap.Modal(n,{backdrop:"static"}),se.modalTitle.textContent=`${c("users.logs.title","User Logs")} — ${t.username}`;const a=$e(c("users.logs.loading","Loading logs..."));se.sessionsBody&&(se.sessionsBody.innerHTML=`
      <tr>
        <td colspan="3" class="text-center text-muted">${a}</td>
      </tr>
    `),se.activityBody&&(se.activityBody.innerHTML=`
      <tr>
        <td colspan="3" class="text-center text-muted">${a}</td>
      </tr>
    `),Vd.show();try{const s=await pe(`/users/?scope=logs&user_id=${e}&limit=50`),r=Array.isArray(s?.data?.sessions)?s.data.sessions:[],i=Array.isArray(s?.data?.activity)?s.data.activity:[];fm(r),hm(i)}catch(s){console.error("❌ Failed to load user logs",s),I(c("users.messages.logsFailed","Could not load logs for that user.")),fm([]),hm([])}}function LC(e){const t=e.target.closest("button[data-action]");if(!t)return;const n=t.dataset.action,a=Number(t.dataset.id);if(!(!Number.isFinite(a)||a<=0)){if(n==="edit"){const s=ff(a);s&&mf({editing:!0,user:s});return}if(n==="delete"){TC(a).catch(s=>{console.error("❌ Delete handler failed",s)});return}n==="logs"&&PC(a).catch(s=>{console.error("❌ Logs handler failed",s)})}}function NC(){se.logoutBtn&&se.logoutBtn.addEventListener("click",()=>ti()),se.refreshBtn&&se.refreshBtn.addEventListener("click",()=>{id().catch(e=>console.error("❌ Refresh failed",e))}),se.form&&se.form.addEventListener("submit",kC),se.cancelBtn&&se.cancelBtn.addEventListener("click",_C),se.searchInput&&se.searchInput.addEventListener("input",()=>pm()),se.tableBody&&se.tableBody.addEventListener("click",LC),se.modal&&se.modal.addEventListener("hidden.bs.modal",()=>{fm([]),hm([])}),document.addEventListener("language:changed",()=>{const e=at.editingId?"users.form.actions.update":"users.form.actions.submit";se.submitBtn&&(se.submitBtn.textContent=c(e,at.editingId?"Update user":"Save user")),pm()})}async function $C(){try{const e=await Im({refresh:!0});return e?(e.role||"").toLowerCase()!=="admin"?(Wa(c("users.messages.notAdmin","This page is restricted to administrator accounts.")),fo(!0),se.form&&se.form.querySelectorAll("input, select, button").forEach(n=>{n.disabled=!0}),setTimeout(()=>{window.location.href="home.html"},2500),!1):!0:(window.location.href="login.html",!1)}catch(e){return console.error("❌ Failed to verify account role",e),window.location.href="login.html",!1}}async function zy(){AC(),Ia(),NC(),await $C()&&(mf({editing:!1,user:null}),await id())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Rs().finally(()=>{zy().catch(e=>console.error("❌ Bootstrap failed",e))})},{once:!0}):Rs().finally(()=>{zy().catch(e=>console.error("❌ Bootstrap failed",e))});const P={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function DC(e){P.callbacks.onRender=typeof e=="function"?e:null}function BC(e){P.callbacks.onBeforeRender=typeof e=="function"?e:null}function FC(e){P.callbacks.onAfterRender=typeof e=="function"?e:null}function RC(e){P.callbacks.onTrendDrilldown=typeof e=="function"?e:null}function MC(e){P.callbacks.onStatusDrilldown=typeof e=="function"?e:null}function HC(e){P.callbacks.onPaymentDrilldown=typeof e=="function"?e:null}function de(e,t,n=t){const s=Le()==="en"?n??t:t;return c(e,s)}function Kd(){P.formatters.cachedLocale=null,P.formatters.numberFormatter=null}function hf(){return(Le()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function aA(){const e=Le();if(e!==P.formatters.cachedLocale||!P.formatters.numberFormatter||!P.formatters.currencyFormatter){P.formatters.cachedLocale=e;const t=hf();P.formatters.numberFormatter=new Intl.NumberFormat(t,{maximumFractionDigits:0}),P.formatters.currencyFormatter=new Intl.NumberFormat(t,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:P.formatters.numberFormatter,currencyFormatter:P.formatters.currencyFormatter}}function nt(e){const{numberFormatter:t}=aA(),n=t.format(Math.round(e||0));return b(n)}function yt(e){const{currencyFormatter:t}=aA(),n=Number.isFinite(Number(e))?Number(e):0,a=t.format(n);return`${b(a)} SR`}function gl(e){const t=e instanceof Date?e:new Date(e);if(!(t instanceof Date)||Number.isNaN(t.getTime()))return"";const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${s}`}function zC(e){if(!e)return"—";const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=new Intl.DateTimeFormat(hf(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return b(n.format(t))}function OC(e){return new Intl.DateTimeFormat(hf(),{month:"short"}).format(e)}const UC=ae()||{};let $s=(UC.maintenance||[]).map(yf);function Ho(){return $s}function zo(e){return $s=Array.isArray(e)?e.map(yf):[],an({maintenance:$s}),YC(),$s}async function sA(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),a=await pe(`/maintenance/${n?`?${n}`:""}`),s=a?.data??a;let r=[];Array.isArray(s)?r=s:s&&typeof s=="object"&&(Array.isArray(s.items)?r=s.items:Array.isArray(s.results)?r=s.results:Array.isArray(s.data)?r=s.data:Array.isArray(s.records)&&(r=s.records));const i=r.map(yi);return zo(i)}async function rA(e){const t=await pe("/maintenance/",{method:"POST",body:e}),n=yi(t?.data??{});return zo([n,...$s.filter(a=>a.id!==n.id)]),n}async function iA(e,t){const n=await pe(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=yi(n?.data??{});return zo($s.map(s=>String(s.id)===String(e)?a:s)),a}async function oA(e){await pe(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),zo($s.filter(t=>String(t.id)!==String(e)))}function cA({equipmentId:e,technicianId:t,issue:n,priority:a,status:s,scheduledAt:r,resolutionReport:i}){return{equipment_id:e,technician_id:t||null,maintenance_type:null,priority:a??"medium",reported_at:null,scheduled_at:r||null,status:s??"open",notes:n??"",resolution_report:i??null,repair_cost:null}}function yi(e={}){return lA({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function yf(e={}){return lA(e)}function lA(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=KC(e.status_raw??e.status??"open"),s=WC(a),r=GC(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:QC(e.priority??"medium"),status:s,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:VC(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function VC(e){if(e==null||e==="")return null;const t=Number.parseFloat(b(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function KC(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function WC(e){const t=gf(e);return["completed","cancelled"].includes(t)?"closed":"open"}function QC(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function GC(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function gf(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function YC(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function Yr(e){return e instanceof Ge}const TL=Object.freeze(Object.defineProperty({__proto__:null,buildMaintenancePayload:cA,categorizeMaintenanceStatus:gf,createMaintenanceRequest:rA,deleteMaintenanceRequest:oA,getMaintenanceState:Ho,isApiError:Yr,mapLegacyMaintenanceTicket:yf,mapMaintenanceFromApi:yi,refreshMaintenanceFromApi:sA,setMaintenanceState:zo,updateMaintenanceRequest:iA},Symbol.toStringTag,{value:"Module"}));function dA(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function uA(e={}){const t=String(e?.barcode??"").trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function mA(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:s}}function XC(){let e;try{e=ae()}catch(l){return console.warn("⚠️ [reports] Failed to access cached data",l),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:s=[],projects:r=[],maintenance:i=[]}=e;return t.length||n.length||a.length||s.length||r.length?(P.data.reservations=Array.isArray(t)?t.map(Wm):[],P.data.customers=Array.isArray(n)?n.map(dA):[],P.data.equipment=Array.isArray(a)?a.map(uA):[],P.data.technicians=Array.isArray(s)?s.map(Ys):[],P.data.projects=Array.isArray(r)?r.map(mA):[],P.data.projectsMap=new Map(P.data.projects.map(l=>[l.id,l])),P.data.maintenance=Array.isArray(i)?i.map(yi):[],P.techniciansIndex=new Map((P.data.technicians||[]).map(l=>[String(l.id),l])),!0):!1}async function pA({silent:e=!1}={}){if(!P.loading){P.loading=!0,P.errorMessage="",e||P.callbacks.onBeforeRender?.();try{const[t,n,a,s,r,i]=await Promise.all([pe("/reservations/?limit=500"),pe("/customers/?limit=500"),pe("/equipment/?limit=500"),pe("/technicians/?limit=500"),pe("/projects/?limit=500"),pe("/maintenance/?limit=500")]);P.data.reservations=Array.isArray(t?.data)?t.data.map(o=>ii(o)):[],P.data.customers=Array.isArray(n?.data)?n.data.map(dA):[],P.data.equipment=Array.isArray(a?.data)?a.data.map(uA):[],P.data.technicians=Array.isArray(s?.data)?s.data.map(Ys):[],P.data.projects=Array.isArray(r?.data)?r.data.map(mA):[],P.data.projectsMap=new Map(P.data.projects.map(o=>[o.id,o])),P.data.maintenance=Array.isArray(i?.data)?i.data.map(yi):[],P.techniciansIndex=new Map((P.data.technicians||[]).map(o=>[String(o.id),o]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),P.errorMessage=t instanceof Ge?t.message:de("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),(!P.data.projectsMap||!(P.data.projectsMap instanceof Map))&&(P.data.projectsMap=new Map)}finally{P.loading=!1,e||P.callbacks.onAfterRender?.()}}}const JC=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),Oy=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),ZC=1440*60*1e3;function fA(e){return b(String(e||"")).toLowerCase().trim()}function bl(e){return(e||"").toString().trim()}function eP(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const s=a.getTime()-n.getTime();return s<=0?1:Math.max(1,Math.ceil(s/ZC))}function Oo(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;eP(e.start,e.end);const t=Number(e.discount??e.discountValue??0)||0,n=e.discountType||e.discount_type||"percent",a=String(n).toLowerCase()==="amount"?"amount":"percent",s=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1",r=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,i=r!=null?xe(r):Number.NaN,l=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null)===!0&&Number.isFinite(i)&&i>0?i:null,d=Array.isArray(e.crewAssignments)?e.crewAssignments:[],u=d.length?d.map(y=>y?.technicianId).filter(Boolean):Array.isArray(e.technicians)?e.technicians:[],m=xa({items:Array.isArray(e.items)?e.items:[],technicianIds:u,crewAssignments:d,discount:t,discountType:a,applyTax:s,start:e.start,end:e.end,companySharePercent:l}),p=Number(e.cost);let f=m.finalTotal,h=m.taxAmount;if(Number.isFinite(p)&&p>0&&(f=Ee(p),s)){const y=f-m.taxableAmount;Number.isFinite(y)&&y>=0&&(h=Ee(y))}const g={rentalDays:m.rentalDays,equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal,crewCostTotal:m.crewCostTotal,discountAmount:m.discountAmount,subtotalAfterDiscount:m.subtotalAfterDiscount,taxableAmount:m.taxableAmount,taxAmount:h,finalTotal:f,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,netProfit:m.netProfit,companyShareEnabled:m.companySharePercent>0};return e.__financials=g,g}function hA(e){return e?.projectId&&P.data.projectsMap.get(String(e.projectId))||null}function Uy(e=""){const t=String(e).toLowerCase().trim();return t?JC.get(t)||t:""}function tP(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&Oy.has(a))return Oy.get(a)}return e?.paid===!0||e?.paid==="true"}function gi(e){const t=hA(e),n=Vt(e,t),a=Uy(n.projectStatus);let s=Uy(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(s=a),(!s||s==="cancelled")&&(s=n.effectiveConfirmed?"confirmed":"pending"),(jo(e)||a==="completed")&&(s="completed");const r=n.effectiveConfirmed||s==="confirmed"||s==="completed";r&&s!=="completed"&&(s="confirmed");const i=tP(e),o=e?.paidStatus??e?.paid_status??(i?"paid":"unpaid");return{statusValue:s,confirmed:r,paid:i,paidStatus:o}}function nP(e){const t=e.length;let n=0,a=0,s=0,r=0,i=0,o=0,l=0,d=0,u=0;e.forEach(p=>{const{statusValue:f,confirmed:h,paid:g}=gi(p);f==="completed"&&(a+=1),h&&(n+=1),g&&(s+=1);const y=Oo(p);r+=y.finalTotal,i+=y.companyShareAmount,o+=y.taxAmount,l+=y.crewTotal,d+=y.crewCostTotal??0,u+=y.netProfit});const m=t?r/t:0;return{total:t,confirmed:n,completed:a,paidCount:s,revenue:r,average:m,companyShareTotal:i,taxTotal:o,crewTotal:l,crewCostTotal:d,netProfit:u}}function yA({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const i=t?new Date(`${t}T00:00:00`):null,o=n?new Date(`${n}T23:59:59`):null;return{startDate:Vy(i)?i:null,endDate:Vy(o)?o:null}}let s=new Date(a),r=null;switch(e){case"last30":{r=new Date(a),r.setDate(r.getDate()-29);break}case"thisWeek":{const i=new Date(a),l=(i.getDay()-6+7)%7;i.setDate(i.getDate()-l),i.setHours(0,0,0,0);const d=new Date(i);d.setDate(i.getDate()+6),d.setHours(23,59,59,999),r=i,s=d;break}case"thisMonth":{r=new Date(a.getFullYear(),a.getMonth(),1),s=new Date(a.getFullYear(),a.getMonth()+1,0),s.setHours(23,59,59,999);break}case"thisQuarter":{const i=Math.floor(a.getMonth()/3);r=new Date(a.getFullYear(),i*3,1),s=new Date(a.getFullYear(),(i+1)*3,0),s.setHours(23,59,59,999);break}case"thisYear":{r=new Date(a.getFullYear(),0,1),s=new Date(a.getFullYear(),12,0),s.setHours(23,59,59,999);break}case"all":default:r=null,s=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:s}}function Vy(e){return e instanceof Date&&!Number.isNaN(e.getTime())}function aP(e,t){const{startDate:n,endDate:a}=yA(t);let s=0;const r=[];return(e||[]).forEach(i=>{if(!i)return;const o=typeof i.repairCost=="number"?i.repairCost:Number.parseFloat(b(String(i.repairCost??"")));if(!Number.isFinite(o)||o<=0)return;const l=String(i.statusRaw??i.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const u=i.resolvedAt??i.resolved_at??null,m=i.reportedAt??i.reported_at??null,p=i.createdAt??i.created_at??null,f=u?new Date(u):null,h=m?new Date(m):p?new Date(p):null,g=f&&!Number.isNaN(f.getTime())?f:h&&!Number.isNaN(h.getTime())?h:null;if(g&&(n&&g<n||a&&g>a))return;const y=Math.round(o*100)/100;s+=y,r.push({id:i.id,cost:y,date:g})}),{total:s,items:r}}function sP(e,t){const n=Number.isFinite(t)?t:0;return{...e,maintenanceExpense:n,netProfit:(e.netProfit||0)-n}}function rP(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const s=new Date(t.getFullYear(),t.getMonth()-a,1),r=s.getFullYear(),i=s.getMonth(),o=e.filter(g=>{const y=g?.start?new Date(g.start):null;return y&&y.getFullYear()===r&&y.getMonth()===i}),l=o.length;let d=0,u=0,m=0;o.forEach(g=>{const y=Oo(g);d+=y.finalTotal,u+=y.netProfit,m+=y.companyShareAmount});const p=OC(s),f=new Date(s.getFullYear(),s.getMonth(),1),h=new Date(s.getFullYear(),s.getMonth()+1,0);n.push({label:p,count:l,revenue:d,netProfit:u,companyShare:m,periodStart:f,periodEnd:h,startInput:gl(f),endInput:gl(h)})}return n}function iP(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(i=>{const{statusValue:o,confirmed:l}=gi(i);o==="completed"?t.completed+=1:o==="confirmed"||l?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,s=t.pending,r=t.completed;return[{label:de("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:de("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-pending",filterKey:"pending"},{label:de("reservations.reports.status.completedLabel","منتهية","Completed"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-completed",filterKey:"completed"}]}function oP(e){const t=e.length||1,n=e.filter(s=>gi(s).paid).length,a=e.length-n;return[{label:de("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:de("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function cP(e,t){const n=new Map,a=new Map((t||[]).map(s=>[String(s.id),s]));return e.forEach(s=>{const r=String(s?.customerId??"unknown"),i=n.get(r)||{count:0,revenue:0},o=Oo(s);i.count+=1,i.revenue+=o.finalTotal,n.set(r,i)}),Array.from(n.entries()).map(([s,r])=>({name:a.get(s)?.customerName||de("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:r.count,revenue:r.revenue})).sort((s,r)=>r.revenue-s.revenue).slice(0,5)}function lP(e,t){const n=new Map,a=new Map((t||[]).map(r=>[bl(r?.barcode),r])),s=de("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");return e.forEach(r=>{(r?.items||[]).forEach(i=>{const o=bl(i?.barcode),l=o?a.get(o):null,d=i?.desc||i?.description||i?.name||l?.desc||l?.description||l?.name||"",u=d&&d.trim()?d:s,m=et(u)||"unknown",p=Number(i?.qty)||1,f=Number(i?.price)||0,h=p*f,g=n.get(m)||{name:u,count:0,revenue:0};g.name=u,g.count+=p,g.revenue+=h,n.set(m,g)})}),Array.from(n.values()).sort((r,i)=>i.count!==r.count?i.count-r.count:i.revenue-r.revenue).slice(0,5)}function dP(e,t,n,a,s){const r=[],i=e?.reservationId||e?.id;i&&r.push(i),e?.notes&&r.push(e.notes);const{statusValue:o,paidStatus:l}=gi(e);o&&r.push(o);const d=e?.paymentStatus||e?.payment_status;d&&r.push(d),e?.paid!=null&&r.push(e.paid?"paid":"unpaid"),l&&r.push(l);const u=n.get(String(e?.customerId));u&&r.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const m=hA(e);return m&&r.push(m.title,m.code,m.status),r.push(gA(l)),(e?.items||[]).forEach(f=>{f?.desc&&r.push(f.desc),f?.barcode&&r.push(f.barcode);const h=a.get(bl(f?.barcode));h&&r.push(h.desc,h.description,h.name)}),(e?.technicians||[]).forEach(f=>{const h=s.get(String(f));h&&r.push(h.name,h.role,h.department)}),fA(r.filter(Boolean).join(" ")).includes(t)}function uP(e,t,n,a,s){const{startDate:r,endDate:i}=yA(t),o=fA(t.search),l=!!o,d=new Map((n||[]).map(p=>[String(p.id),p])),u=new Map((a||[]).map(p=>[bl(p?.barcode),p])),m=new Map((s||[]).map(p=>[String(p.id),p]));return(e||[]).filter(p=>{const f=p?.start?new Date(p.start):null;if(!f||Number.isNaN(f.getTime())||r&&f<r||i&&f>i)return!1;const{statusValue:h,confirmed:g,paid:y}=gi(p);if(t.status==="confirmed"&&!(h==="confirmed"||h==="completed"||g)||t.status==="pending"&&h!=="pending"||t.status==="completed"&&h!=="completed"||t.payment==="paid"&&!y||t.payment==="unpaid"&&y)return!1;if(t.share&&t.share!=="all"){const S=Oo(p).companySharePercent>0;if(t.share==="with"&&!S||t.share==="without"&&S)return!1}return!(l&&!dP(p,o,d,u,m))})}function gA(e){const t=String(e??"").toLowerCase();return t==="paid"?de("reservations.reports.payment.paidLabel","مدفوعة","Paid"):t==="partial"?de("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):de("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function bf(e){if(P.loadedScripts.has(e))return P.loadedScripts.get(e);const t=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,n=new Promise((a,s)=>{const r=()=>{t&&(t.dataset.loaded="true"),a()},i=l=>s(l);if(t){if(t.dataset.loaded==="true"){a();return}t.addEventListener("load",r,{once:!0}),t.addEventListener("error",i,{once:!0});return}const o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>{o.dataset.loaded="true",a()},o.onerror=l=>s(l),document.head.appendChild(o)});return P.loadedScripts.set(e,n),n}function vf(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(P.apexChartsReady||(P.apexChartsReady=bf("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),P.apexChartsReady)}function mP(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(P.html2PdfReady||(P.html2PdfReady=bf("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),P.html2PdfReady)}function pP(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(P.xlsxReady||(P.xlsxReady=bf("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),P.xlsxReady)}function vl(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function Ka(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}n.innerHTML=t.map(a=>{const s=Math.min(Math.max(a.percent??0,0),100),r=de("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",nt(a.rawCount??a.value??0)),i=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${a.label}</span>
            <span class="reports-progress-value">${nt(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}async function fP(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const n=Array.isArray(e)?e:[];if(P.lastTrendData=n,!n.length){P.charts.trend&&(P.charts.trend.destroy(),P.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await vf();if(!a){t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=n.map(f=>f.label),r=n.map(f=>Math.round(f.count||0)),i=n.map(f=>Number(f.revenue||0)),o=n.map(f=>Number(f.netProfit||0)),l=r.reduce((f,h)=>f+(Number.isFinite(h)?h:0),0),d=i.reduce((f,h)=>f+(Number.isFinite(h)?h:0),0),u=o.reduce((f,h)=>f+(Number.isFinite(h)?h:0),0);if(l===0&&d===0&&u===0){P.charts.trend&&(P.charts.trend.destroy(),P.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const m=[{name:de("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:r},{name:de("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:i},{name:de("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:o,yAxisIndex:1}],p={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(f,h,g)=>{if(g?.dataPointIndex!=null){const y=P.lastTrendData[g.dataPointIndex];P.callbacks.onTrendDrilldown?.(y,g.dataPointIndex)}}}},theme:{mode:vl()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:s,labels:{style:{colors:vl()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:de("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:f=>nt(f)},title:{text:de("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:de("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:f=>yt(f)},title:{text:de("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(f,{seriesIndex:h})=>h===0?nt(f):yt(f)}}};P.charts.trend?(P.charts.trend.updateOptions({...p},!0,!0),P.charts.trend.updateSeries(m,!0)):(t.innerHTML="",P.charts.trend=new a(t,{...p,series:m}),P.charts.trend.render())}catch(a){console.error("⚠️ [reports] Failed to render trend chart",a),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}async function hP(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(!t)return;const a=Array.isArray(e)?e:[];P.lastStatusData=a;const s=a.map(i=>Math.max(0,i.value||0)),r=s.reduce((i,o)=>i+o,0);if(!a.length||r===0){P.charts.status&&(P.charts.status.destroy(),P.charts.status=null),Ka(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const i=await vf();if(!i){Ka(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const o=a.map(d=>d.label),l={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(d,u,m)=>{if(m?.dataPointIndex!=null){const p=P.lastStatusData[m.dataPointIndex];p?.filterKey&&P.callbacks.onStatusDrilldown?.(p,m.dataPointIndex)}}}},theme:{mode:vl()},labels:o,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:d=>`${Math.round(d)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:de("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>nt(s.reduce((d,u)=>d+u,0))}}}}},tooltip:{y:{formatter:(d,u)=>{const m=P.lastStatusData?.[u?.seriesIndex||0],p=m?`${nt(m.percent)}%`:`${nt(d)}%`;return`${nt(m?m.rawCount??m.value??0:d)} / ${p}`}}}};P.charts.status?(P.charts.status.updateOptions({...l},!0,!0),P.charts.status.updateSeries(s,!0)):(t.innerHTML="",P.charts.status=new i(t,{...l,series:s}),P.charts.status.render()),Ka(n,a)}catch(i){console.error("⚠️ [reports] Failed to render status chart",i),Ka(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}async function yP(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(!t)return;const a=Array.isArray(e)?e:[];P.lastPaymentData=a;const s=a.map(i=>Math.max(0,i.value||0)),r=s.reduce((i,o)=>i+o,0);if(!a.length||r===0){P.charts.payment&&(P.charts.payment.destroy(),P.charts.payment=null),Ka(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const i=await vf();if(!i){Ka(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const o=a.map(d=>d.label),l={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(d,u,m)=>{if(m?.dataPointIndex!=null){const p=P.lastPaymentData[m.dataPointIndex];p?.filterKey&&P.callbacks.onPaymentDrilldown?.(p,m.dataPointIndex)}}}},theme:{mode:vl()},labels:o,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:d=>`${Math.round(d)}%`},tooltip:{y:{formatter:(d,u)=>{const m=P.lastPaymentData?.[u?.seriesIndex||0],p=m?`${nt(m.percent)}%`:`${nt(d)}%`;return`${nt(m?m.rawCount??m.value??0:d)} / ${p}`}}}};P.charts.payment?(P.charts.payment.updateOptions({...l},!0,!0),P.charts.payment.updateSeries(s,!0)):(t.innerHTML="",P.charts.payment=new i(t,{...l,series:s}),P.charts.payment.render()),Ka(n,a)}catch(i){console.error("⚠️ [reports] Failed to render payment chart",i),Ka(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}function gP(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),o=document.getElementById("reports-kpi-confirmed-meta"),l=document.getElementById("reports-kpi-paid"),d=document.getElementById("reports-kpi-paid-meta"),u=e.total||0,m=e.revenue||0,p=e.confirmed||0,f=e.paidCount||0,h=e.average||0,g=e.companyShareTotal||0,y=e.taxTotal||0,E=e.crewTotal||0,S=e.crewCostTotal||0,x=e.netProfit||0,A=e.maintenanceExpense||0,C=u?Math.round(p/u*100):0,j=u?Math.round(f/u*100):0;if(t&&(t.textContent=nt(u)),n){const k=de("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",nt(e.completed||0));n.textContent=k}if(a&&(a.textContent=yt(m)),s)if(u===0)s.textContent=de("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.");else{const k=de("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");s.textContent=k.replace("{net}",yt(x)).replace("{share}",yt(g)).replace("{average}",yt(h))}if(r)if(m>0){const k=[{label:de("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:yt(m)},{label:de("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:yt(g)},{label:de("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:yt(y)},{label:de("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:yt(E)},{label:de("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:yt(S)}];A>0&&k.push({label:de("reservations.reports.kpi.revenue.details.maintenance","مصاريف الصيانة","Maintenance expenses"),value:`−${yt(A)}`}),k.push({label:de("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:yt(x)}),r.innerHTML=k.map(({label:w,value:_})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${w}</span>
            <span class="reports-kpi-detail-value">${_}</span>
          </div>
        `).join(""),r.classList.remove("hidden")}else r.innerHTML="",r.classList.add("hidden");if(i&&(i.textContent=`${C}%`),o){const k=de("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",nt(p));o.textContent=k}if(l&&(l.textContent=`${j}%`),d){const k=de("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",nt(f));d.textContent=k}}function An(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function od(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function bP(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${de("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const s=new Map((t||[]).map(o=>[String(o.id),o]));new Map((n||[]).map(o=>[String(o.id),o]));const r={code:de("reservations.reports.results.headers.id","الحجز","Reservation"),customer:de("reservations.reports.results.headers.customer","العميل","Customer"),date:de("reservations.reports.results.headers.date","التاريخ","Date"),status:de("reservations.reports.results.headers.status","الحالة","Status"),payment:de("reservations.reports.results.headers.payment","الدفع","Payment"),total:de("reservations.reports.results.headers.total","الإجمالي","Total"),share:de("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:de("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=[...e].sort((o,l)=>new Date(l.start||0)-new Date(o.start||0)).slice(0,20).map(o=>{const l=vP(o,s),d={[r.code]:l.code.text,[r.customer]:l.customer.text,[r.date]:l.date.text,[r.status]:l.status.text,[r.payment]:l.payment.text,[r.total]:l.total.text,[r.share]:l.share.text,[r.net]:l.net.text};return{formatted:l,exportRow:d}});return a.innerHTML=i.map(({formatted:o})=>`
      <tr data-drilldown="reservation" data-search="${od(o.code.text)}">
        <td data-report-column="code">${o.code.html}</td>
        <td data-report-column="customer">${o.customer.html}</td>
        <td data-report-column="date">${o.date.html}</td>
        <td data-report-column="status">${o.status.html}</td>
        <td data-report-column="payment">${o.payment.html}</td>
        <td data-report-column="total">${o.total.html}</td>
        <td data-report-column="share">${o.share.html}</td>
        <td data-report-column="net">${o.net.html}</td>
      </tr>
    `).join(""),i.map(({exportRow:o})=>o)}function vP(e,t,n){const a=e?.reservationId||e?.id||"—",s=b(String(a)),i=t.get(String(e?.customerId))?.customerName||de("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),o=gi(e),l=SP(o.statusValue),d=AP(o.statusValue,l),u=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],m=EP(o.paidStatus,u),p=u.length;let f=m.html;if(p>0){const A=de("reservations.paymentHistory.countLabel","{count} دفعة","{count} payments").replace("{count}",nt(p));f=`<div class="reports-payment-cell">${m.html}<small class="reports-payment-subtext">${An(A)}</small></div>`}const h=zC(e?.start),g=Oo(e),y=yt(g.finalTotal),E=g.companySharePercent>0?`${nt(g.companySharePercent)}% (${yt(g.companyShareAmount)})`:de("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),S=yt(g.netProfit),x=An(i);return{code:{html:An(s),text:s},customer:{html:x,text:i},date:{html:An(h),text:h},status:d,payment:{html:f,text:m.text},total:{html:An(y),text:y},share:{html:An(E),text:E},net:{html:An(S),text:S}}}function SP(e){switch(e){case"completed":return Fc(de("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return Fc(de("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return Fc(de("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return b(e||"—")}}function AP(e,t){const n=Fc(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${An(n)}</span>`,text:n}}function EP(e,t=[]){const n=gA(e),a=String(e??"").toLowerCase(),s=a==="paid"?"paid":a==="partial"?"partial":"unpaid";let r="";const i=de("reservations.create.summary.currency","ريال","SR");Array.isArray(t)&&t.length&&(r=t.map(d=>{const u=d?.recordedAt?gl(d.recordedAt):"—",m=Number.isFinite(Number(d?.amount))&&Number(d.amount)>0?`${b(Number(d.amount).toFixed(2))} ${i}`:"",p=Number.isFinite(Number(d?.percentage))&&Number(d.percentage)>0?`${b(Number(d.percentage).toFixed(2))}%`:"",f=[u];return m&&f.push(m),p&&f.push(p),f.filter(Boolean).join(" • ")}).join(`
`));const o=r?` title="${od(r)}"`:"";return{html:`<span class="reservation-chip status-${s}"${o}>${An(n)}</span>`,text:n}}function Fc(e){return b(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function Sf(e){const t=gl(new Date).replace(/-/g,"");return`${de("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${t}.${e}`}function wP(e,t,n){const a=new Blob([e],{type:n}),s=URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function ym(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(s=>{const r=t.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);n.push(r.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;wP(a,Sf("csv"),"text/csv;charset=utf-8;")}async function jP(e){try{const t=await pP();if(!t){ym(e);return}const n=t.utils.json_to_sheet(e),a=t.utils.book_new(),s=de("reservations.reports.export.sheetName","الحجوزات","Reservations");t.utils.book_append_sheet(a,n,s),t.writeFile(a,Sf("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),ym(e)}}async function IP(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await mP();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=Sf("pdf");cv();const a=[];Ep(e,window,a),wp(e,window,a);try{await t().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(s){console.error("⚠️ [reports] export failed",s)}finally{yI(a)}}async function xP(e,t){switch(e){case"pdf":await IP();break;case"excel":await jP(t);break;case"csv":default:ym(t);break}}function qP(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${de("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${od(n.name)}">
        <td>${An(n.name)}</td>
        <td>${nt(n.count)}</td>
        <td>${yt(n.revenue)}</td>
      </tr>
    `).join("")}}function kP(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${de("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${od(n.name)}">
        <td>${An(n.name)}</td>
        <td>${nt(n.count)}</td>
        <td>${yt(n.revenue)}</td>
      </tr>
    `).join("")}}const Sa=P.filters;function _P(e){if(P.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(n=>{const a=n.dataset.columnToggle;a&&(n.checked=P.columnPreferences[a]!==!1,n.addEventListener("change",()=>{P.columnPreferences[a]=n.checked,e()}))}),P.columnControlsBound=!0,e())}function bA(){Object.entries(P.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{n.classList.toggle("hidden",!t)})})}function TP(e){if(P.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(n=>{n.addEventListener("click",async()=>{const{export:a=""}=n.dataset;if(a){n.disabled=!0;try{await e(a)}catch(s){console.error("⚠️ [reports] export failed",s)}finally{n.disabled=!1}}})}),P.exportHandlersBound=!0)}function CP(e,t){P.searchDebounceTimer&&(clearTimeout(P.searchDebounceTimer),P.searchDebounceTimer=null),P.searchDebounceTimer=setTimeout(()=>{Sa.search=e||"",t()},220)}function PP(e,t){e&&(Sa.range="custom",Sa.start=e.startInput||null,Sa.end=e.endInput||null,t())}function LP(e,t){e&&(Sa.status=Sa.status===e?"all":e,t())}function NP(e,t){e&&(Sa.payment=Sa.payment===e?"all":e,t())}function $P(e,t){e&&(Sa.search=e,t())}const _e=P.filters;function Ky(){Kd(),it(),setTimeout(()=>{Kd(),it(),Rc()},0),setTimeout(()=>{Kd(),it(),Rc()},60),Rc()}function jr(){_e.range==="custom"&&it()}function Rc(e,t){if(!window.flatpickr)return;e&&(P.startDateInputRef=e),t&&(P.endDateInputRef=t);const n=P.startDateInputRef,a=P.endDateInputRef;if(!n&&!a)return;const s=DP(),r=i=>{const o={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(o.locale=s),o};if(P.startDatePicker&&(P.startDatePicker.destroy(),P.startDatePicker=null),P.endDatePicker&&(P.endDatePicker.destroy(),P.endDatePicker=null),n&&(P.startDatePicker=window.flatpickr(n,r({onChange(i,o){_e.start=o||null,P.endDatePicker&&(i?.length?P.endDatePicker.set("minDate",i[0]):P.endDatePicker.set("minDate",null)),jr()},onValueUpdate(i,o){_e.start=o||null,jr()}}))),a&&(P.endDatePicker=window.flatpickr(a,r({onChange(i,o){_e.end=o||null,P.startDatePicker&&(i?.length?P.startDatePicker.set("maxDate",i[0]):P.startDatePicker.set("maxDate",null)),jr()},onValueUpdate(i,o){_e.end=o||null,jr()}}))),P.startDatePicker&&n){P.startDatePicker.setDate(n.value,!1);const i=P.endDatePicker?.selectedDates?.[0]||P.endDateInputRef?.value;i&&P.startDatePicker.set("maxDate",i)}if(P.endDatePicker&&a){P.endDatePicker.setDate(a.value,!1);const i=P.startDatePicker?.selectedDates?.[0]||P.startDateInputRef?.value;i&&P.endDatePicker.set("minDate",i)}}function DP(){return(Le()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function gm(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function Ss(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),r=document.getElementById("reports-start"),i=document.getElementById("reports-end"),o=document.getElementById("reports-custom-range");e&&e.value!==_e.range&&(e.value=_e.range),t&&t.value!==_e.status&&(t.value=_e.status),n&&n.value!==_e.payment&&(n.value=_e.payment),a&&a.value!==_e.share&&(a.value=_e.share),s&&s.value!==_e.search&&(s.value=_e.search||""),r&&r.value!==(_e.start||"")&&(r.value=_e.start||""),i&&i.value!==(_e.end||"")&&(i.value=_e.end||""),gm(o,_e.range==="custom")}function bm({active:e,icon:t,title:n,subtitle:a}){const s=document.getElementById("reports-empty-state");if(!s)return;const r=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),o=s.querySelector("p");P.emptyDefaults.icon===null&&r&&(P.emptyDefaults.icon=r.textContent),P.emptyDefaults.title===null&&i&&(P.emptyDefaults.title=i.textContent),P.emptyDefaults.subtitle===null&&o&&(P.emptyDefaults.subtitle=o.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!r||!i||!o)&&(e?(r.textContent=t!==void 0?t:P.emptyDefaults.icon??r.textContent,i.textContent=n!==void 0?n:P.emptyDefaults.title??i.textContent,o.textContent=a!==void 0?a:P.emptyDefaults.subtitle??o.textContent):(r.textContent=P.emptyDefaults.icon??r.textContent,i.textContent=P.emptyDefaults.title??i.textContent,o.textContent=P.emptyDefaults.subtitle??o.textContent))}function BP(e){bm({active:!!e})}function FP(){if(P.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=s=>{const r=s.target?.closest("[data-drilldown]");if(!r)return;const i=r.dataset.search||"";$P(i,()=>{Ss(),it()})};e?.addEventListener("click",a),t?.addEventListener("click",a),n?.addEventListener("click",a),P.drilldownBound=!0}function hr(){pA({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function it(){if(Ss(),P.loading){bm({active:!0,icon:"⏳",title:de("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:de("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(P.errorMessage){bm({active:!0,icon:"⚠️",title:P.errorMessage,subtitle:de("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a,maintenance:s}=P.data,r=uP(e,_e,t,n,a),i=nP(r),o=aP(s,_e),l=sP(i,o.total),d=rP(r),u=iP(r),m=oP(r),p=cP(r,t),f=lP(r,n);gP(l),fP(d),hP(u),yP(m),qP(p),kP(f);const h=bP(r,t,a);bA(),BP(r.length===0),P.lastSnapshot.filtered=r,P.lastSnapshot.metrics=l,P.lastSnapshot.trend=d,P.lastSnapshot.statusBreakdown=u,P.lastSnapshot.paymentBreakdown=m,P.lastSnapshot.tableRows=h,P.lastSnapshot.maintenance=o}function RP(){if(P.initialized)return;P.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),r=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),o=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;Ss(),XC()&&it(),e.addEventListener("change",()=>{_e.range=e.value,gm(o,_e.range==="custom"),_e.range!=="custom"&&(_e.start=null,_e.end=null),it()}),t?.addEventListener("change",()=>{_e.status=t.value,it()}),n?.addEventListener("change",()=>{_e.payment=n.value,it()}),a?.addEventListener("change",()=>{_e.share=a.value,it()}),l?.addEventListener("input",()=>{const u=l.value||"";CP(u,()=>{Ss(),it()})}),s?.addEventListener("change",()=>{_e.start=s.value||null,jr()}),r?.addEventListener("change",()=>{_e.end=r.value||null,jr()}),i?.addEventListener("click",()=>{_e.range==="custom"&&(_e.start=s?.value||null,_e.end=r?.value||null),it()}),Rc(s,r),gm(o,_e.range==="custom"),P.languageListenerAttached||(document.addEventListener("language:changed",Ky),document.addEventListener("language:translationsReady",Ky),P.languageListenerAttached=!0),P.dataListenersAttached||(document.addEventListener("reservations:changed",hr),document.addEventListener("customers:changed",hr),document.addEventListener("equipment:changed",hr),document.addEventListener("projects:changed",hr),document.addEventListener("technicians:updated",hr),window.addEventListener("maintenance:updated",hr),P.dataListenersAttached=!0),_P(bA),TP(async u=>{const m=P.lastSnapshot.tableRows||[];if(!m.length){console.warn("[reports] No reservation data to export");return}await xP(u,m)}),FP(),P.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>it(),0)}),P.themeListenerAttached=!0),DC(it),BC(()=>{it()}),FC(()=>{it()}),RC(u=>{PP(u,()=>{Ss(),it()})}),MC(u=>{LP(u?.filterKey,()=>{Ss(),it()})}),HC(u=>{NP(u?.filterKey,()=>{Ss(),it()})}),pA().catch(u=>{console.error("❌ [reports] Failed to initialise reports data",u)})}const MP=Object.freeze(Object.defineProperty({__proto__:null,initReports:RP,renderReports:it},Symbol.toStringTag,{value:"Module"})),HP={limit:200};let Ke=null,Wy=!1,Qy=!1,Gy=!1,Yy=null,Wd=null,Xy=!1,Qd=null,Gd=null,Yd=!1,na="",wc=null;const Xd=new Map;function ma(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Af(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Jy(){try{if(typeof FullCalendar<"u")return FullCalendar}catch{}return typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof global<"u"&&global.FullCalendar?global.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}async function zP(){const e=Jy();return e||wc||(wc=new Promise(t=>{try{const n="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js",a=document.createElement("script");a.src=n,a.async=!0,a.onload=()=>t(Jy()),a.onerror=()=>t(null),document.head.appendChild(a)}catch{t(null)}}),wc)}function OP(){if(typeof window>"u")return null;const e=window.tui?.Calendar||window.toastui?.Calendar||window.Calendar;return typeof e=="function"?e:null}function UP(e){return Xd.has(e)||Xd.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),Xd.get(e)}function Ef(e,t,n=!1){if(n){const u=(Le?.()==="en"?"en":"ar")==="en"?"All day":"طوال اليوم";return c("calendar.labels.allDay",u)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const s=Le?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",r=UP(s),i=r.format(a);if(!t)return i;const o=new Date(t);if(Number.isNaN(o.getTime()))return i;const l=r.format(o);return i===l?i:`${i} – ${l}`}function VP({paid:e,confirmed:t,completed:n}){const a=["calendar-event"];return(n===!0||n==="true")&&a.push("calendar-event--completed"),t===!0||t==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function KP(e){try{const{event:t}=e||{},n=t?.extendedProps||{},a=Ef(t?.startStr,t?.endStr,t?.allDay),s=n?.reservationId?String(n.reservationId):t?.id!=null?String(t.id):"—",r=n?.customerName||c("calendar.labels.unknownCustomer","غير معروف"),i=n?.confirmed===!0||n?.confirmed==="true",o=n?.paid===!0||n?.paid==="paid",l=n?.completed===!0||n?.completed==="true",d=(h,g)=>`<span class="calendar-chip ${h}">${ma(g)}</span>`,u=i?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),m=o?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),p=[d(i?"status-confirmed":"status-pending",u),d(o?"status-paid":"status-unpaid",m)];return l&&p.push(d("status-completed",c("calendar.badges.completed","منتهي"))),{html:`
      <div class="calendar-event-wrapper">
        <div class="calendar-event-card">
          <div class="calendar-event-card__head">
            <span class="calendar-event-card__time">${ma(a||"")}</span>
            <span class="calendar-event-card__id">${ma(s)}</span>
          </div>
          <div class="calendar-event-card__customer">${ma(r)}</div>
          <div class="calendar-event-card__chips">${p.join("")}</div>
        </div>
      </div>`}}catch{return{html:""}}}function WP(){const{calendarEl:e}=Af();if(!e)return;const t=e.querySelector(".fc-header-toolbar");if(!t)return;t.classList.add("calendar-toolbar"),t.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const n=t.querySelector(".fc-toolbar-title");n&&n.classList.add("calendar-toolbar__title"),t.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function $a({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:s}=Af();if(!a||!s)return;const r=typeof t=="string"?t.trim().length>0:!!t,i=!e&&!r&&!!n,o=e||r||i;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",i),s.dataset.initialized||(s.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),s.dataset.initialized="true"),s.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),s.classList.toggle("hidden",!o),!o){s.innerHTML="",s.removeAttribute("data-status");return}let l="";e?l=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):r?l=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):i&&(l=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const d=e?"loading":r?"error":"empty";if(s.setAttribute("data-status",d),s.classList.add(`calendar-status-card--${d}`),s.innerHTML="",e){const m=document.createElement("span");m.className="loading loading-spinner loading-md text-primary",m.setAttribute("aria-hidden","true"),s.appendChild(m)}else{const m=document.createElement("span");m.className="calendar-status-card__icon",m.setAttribute("aria-hidden","true"),m.textContent=r?"⚠️":"🗓️",s.appendChild(m)}const u=document.createElement("span");u.className="calendar-status-card__message text-center text-sm font-semibold",u.textContent=l,s.appendChild(u)}function vA(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const s=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:s==="paid",{effectiveConfirmed:i}=Vt(e,t),o=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let d=!!e.completed;if(!d&&a){const u=new Date(a);Number.isNaN(u.getTime())||(d=u<new Date)}return{id:e.id??o??n,start:n,end:a||n,paid:r,confirmed:i,completed:d,reservationId:o??"",customerName:l,raw:e}}function QP(e=[]){const{projects:t=[]}=ae(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&s!==""&&n.get(String(s))||null,i=vA(a,r);if(!i)return null;const o=VP({paid:i.paid,confirmed:i.confirmed,completed:i.completed});return{id:i.id,title:"",start:i.start,end:i.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:o,extendedProps:{...a,raw:a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}async function Zy(){if(Yd)return We();Yd=!0,na="";try{await pi({suppressError:!1,params:HP})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),na=oi(e)?e.message:e instanceof Error&&e.message||""}finally{Yd=!1}return We()}function ki(){if(Ke){try{typeof Ke.destroy=="function"&&Ke.destroy()}catch{}Ke=null}}function eg(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function SA(){jf()}function GP(){Wy||(document.addEventListener("language:changed",()=>{Ke&&Ke.setOption("locale",Le()),jf()}),Wy=!0),Qy||(document.addEventListener("reservations:changed",()=>{SA()}),Qy=!0)}function wf(e){return e<=480?"xs":e<=768?"sm":"lg"}function AA(){if(typeof window>"u")return"month";const e=window.innerWidth||1024,t=wf(e);return t==="xs"?"day":t==="sm"?"week":"month"}function Li(){if(!Ke)return;const e=typeof window<"u"&&window.innerWidth||1024,t=wf(e),n=Ke.__isFullCalendar?EA():AA();Yy!==t&&typeof Ke.changeView=="function"&&(Yy=t,Ke.changeView(n,!0))}function YP(){Gy||typeof window>"u"||(window.addEventListener("resize",()=>{Wd&&clearTimeout(Wd),Wd=setTimeout(()=>{Li()},160)},{passive:!0}),Gy=!0)}function XP(){if(Xy||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{Gd&&clearTimeout(Gd),Gd=setTimeout(()=>{SA()},80)};Qd=new MutationObserver(e),Qd.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&Qd.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Xy=!0}function tg(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=ae()||{},{reservations:a=[],customers:s=[],projects:r=[],technicians:i=[]}=n,o=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},l=[o.id,o.reservationId,o.reservation_id,o.reservationCode,o.reservation_code].map(w=>w==null?"":String(w)).filter(w=>w.length>0);let d=-1,u=null;l.length>0&&(d=a.findIndex(w=>{const _=[w?.id,w?.reservationId,w?.reservation_id,w?.reservationCode,w?.reservation_code].map($=>$==null?"":String($)).filter($=>$.length>0);return _.length===0?!1:_.some($=>l.includes($))}),d>=0&&(u=a[d]));let m;u?(m={...o,...u},Array.isArray(u.items)&&u.items.length&&(m.items=u.items),Array.isArray(u.packages)&&u.packages.length&&(m.packages=u.packages)):m=o;const p=m.projectId??m.project_id??null,f=p!=null&&r.find(w=>String(w.id)===String(p))||null,h=m.customerId??m.customer_id,g=s.find(w=>String(w.id)===String(h)),y=Ut(),E=[...Array.isArray(y)?y:[],...Array.isArray(i)?i:[]],S=new Map;E.forEach(w=>{if(!w||w.id==null)return;const _=String(w.id),$=S.get(_)||{};S.set(_,{...$,...w})});const x=Array.from(S.values());let A="";try{A=al(m,g,x,d>=0?d:0,f)}catch(w){console.error("❌ [calendar] Failed to build reservation details for calendar modal",w),t.innerHTML=`<p class="text-sm text-error">${ma(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"))}</p>`;return}t.innerHTML=A,t.classList.add("calendar-reservation-details");try{es()?.then(()=>{try{const w=Array.from(new Map((Ut()||[]).map($=>[String($.id),$])).values()),_=al(m,g,w,d>=0?d:0,f);t.innerHTML=_,t.classList.add("calendar-reservation-details")}catch{}}).catch(()=>{})}catch{}t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(w=>{w instanceof HTMLElement&&(w.setAttribute("disabled","true"),w.setAttribute("aria-disabled","true"),w.setAttribute("tabindex","-1"))});const j=t.querySelector('[data-action="open-project"]');j&&(f?j.addEventListener("click",()=>{const w=f?.id!=null?String(f.id):"",_=w?`projects.html?project=${encodeURIComponent(w)}`:"projects.html";window.location.href=_}):j instanceof HTMLElement&&j.setAttribute("disabled","true"));const k=document.getElementById("calendarReservationModal");k&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(k).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function jf(){GP(),YP(),XP();const{calendarEl:e}=Af();if(!e)return;const t=OP();if(!t){(async()=>{const n=await zP();if(!n||typeof n.Calendar!="function"){const r=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");$a({error:r}),ki();return}$a({loading:!0});const a=await Zy();if(na){const r=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");$a({loading:!1,error:na||r}),ki();return}const s=QP(a);Ke?Ke.batchRendering?.(()=>{Ke.removeAllEvents(),Ke.addEventSource(s)}):(Ke=new n.Calendar(e,{initialView:EA(),locale:Le(),timeZone:"local",expandRows:!0,height:"auto",contentHeight:"auto",slotMinTime:"06:00:00",slotMaxTime:"24:00:00",slotDuration:"00:30:00",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},dayMaxEventRows:2,fixedWeekCount:!0,showNonCurrentDates:!0,views:{dayGridMonth:{dayMaxEventRows:2,fixedWeekCount:!0}},moreLinkClick:"popover",lazyFetching:!1,noEventsContent(){return c("calendar.noEvents","لا توجد حجوزات لعرضها في هذا النطاق")},buttonText:{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")},events:s,eventContent:KP,eventClick(r){tg(r.event.extendedProps)},windowResize:Li,datesSet(){WP()}}),Ke.render(),Ke.__isFullCalendar=!0),Li(),eg(s),$a({loading:!1,error:"",empty:s.length===0})})();return}(async()=>{$a({loading:!0});const n=await Zy();if(na){const i=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");$a({loading:!1,error:na||i}),ki();return}const a=JP(n);ki();const s=AA();Ke=new t("#calendar",{defaultView:s,usageStatistics:!1,isReadOnly:!0,week:{taskView:!1,hourStart:6,hourEnd:24},month:{visibleWeeksCount:0,startDayOfWeek:0,isAlways6Weeks:!0,maxVisibleEventCount:6,moreLayerSize:420},template:{time(i){const o=i?.raw?.paid===!0||i?.raw?.paid==="paid",l=i?.raw?.confirmed===!0||i?.raw?.confirmed==="true",d=i?.raw?.completed===!0||i?.raw?.completed==="true",u=c("calendar.labels.unknownCustomer","غير معروف"),m=Ef(i.start?.toString?.()||i.start,i.end?.toString?.()||i.end,i.isAllDay),p=i?.raw?.reservationId?String(i.raw.reservationId):"—",f=i?.raw?.customerName||u,h=(S,x)=>`<span class="badge ${S} badge-sm">${ma(x)}</span>`,g=l?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),y=o?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),E=[h(l?"badge-success":"badge-warning",g),h(o?"badge-info":"badge-error",y)];return d&&E.push(h("badge-neutral",c("calendar.badges.completed","منتهي"))),`
            <div class="card bg-base-100/90 border border-base-200 shadow-sm rounded-xl p-2">
              <div class="flex items-baseline justify-between text-[0.8rem]">
                <span class="font-bold">${ma(m||"")}</span>
                <span class="font-semibold">${ma(p)}</span>
              </div>
              <div class="mt-1 font-semibold text-sm truncate">${ma(f)}</div>
              <div class="mt-1 flex gap-1 flex-wrap">${E.join("")}</div>
            </div>
          `}}}),Ke.__isTui=!0;const r=i=>{if(i)try{tg(i)}catch{}};typeof Ke.on=="function"&&(Ke.on("clickSchedule",i=>r(i?.schedule?.raw||i?.schedule)),Ke.on("clickEvent",i=>r(i?.event?.raw||i?.event)));try{typeof Ke.createSchedules=="function"?Ke.createSchedules(a):typeof Ke.createEvents=="function"&&Ke.createEvents(a)}catch{}Li(),eg(a),$a({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{Li()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),na=n instanceof Error&&n.message||na||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");$a({loading:!1,error:na||a}),ki()})}function JP(e=[]){const{projects:t=[]}=ae(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&n.get(String(s))||null,i=vA(a,r);if(!i)return null;const o=Ef(i.start,i.end,!1),l=i.customerName||"",d=[o,l].filter(Boolean).join(" · ");return{id:String(i.id),calendarId:"default",title:d,category:"time",isAllDay:!1,isAllday:!1,start:i.start,end:i.end,raw:{...a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}function EA(){if(typeof window>"u")return"dayGridMonth";const e=window.innerWidth||1024,t=wf(e);return t==="xs"?"timeGridDay":t==="sm"?"timeGridWeek":"dayGridMonth"}const ZP=Object.freeze(Object.defineProperty({__proto__:null,renderCalendar:jf},Symbol.toStringTag,{value:"Module"}));function vm(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getFullYear()).slice(-2);return`${n}/${a}/${s}`}let Qa=Ho(),Ds=[],Vi=null,Nr=!1,Ir="",Bs=Qa.length>0,jn={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},If=null,Nt=null,pt=null,Yt=null,Xr=null,Ki=null,Jr=null,vt=null;async function yo({showToastOnError:e=!0}={}){if(!Nr){Nr=!0,Ir="",pn();try{await sA(),Bs=!0}catch(t){t&&typeof t=="object"&&Number(t.status)===401?(Bs=Qa.length>0,Ir=""):(Bs=Qa.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),Ir=Yr(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&I(Ir,"error"))}finally{Nr=!1,Qa=Ho(),pn()}}}function Sm(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function pa(e){return b(String(e||"")).trim().toLowerCase()}function xf(e=""){return b(String(e)).trim().toLowerCase()}function eL(e={}){const t=String(e?.desc??"").trim(),n=b(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function tL(e){const t=b(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Sl(e){return b(String(e||"")).trim().toLowerCase()}function Ze(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function nL(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function os(){return Qa=Ho(),Qa}function wA(e){return os().find(n=>Number(n.id)===Number(e))||null}function jA(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function qf(){const{equipment:e=[]}=ae(),t=c("maintenance.table.noName","بدون اسم");return Ds=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),s=pa(a),r=Number.parseInt(n?.qty??n?.quantity??0,10),i=Number.isFinite(r)?Math.max(r,0):1,o=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"متاح",d=n?.desc||n?.description||n?.name||t,u=eL({desc:d,displayBarcode:a,barcode:s});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:s,displayBarcode:a,desc:d,status:l,statusNormalized:jA(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:i,image:o,searchValue:u,searchValueNormalized:Sl(u),descriptionNormalized:xf(d)}}),Ds.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),Ds}function kf(){const e=new Set,t=new Map;return os().filter(n=>n.status==="open").forEach(n=>{const a=pa(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function IA(e){const t=pa(e);if(!t)return 0;const{map:n}=kf();return n.get(t)||0}function cd(e){const t=pa(e);return t&&(Ds.length?Ds:qf()).find(a=>a.barcode===t)||null}function aL(e){const t=Ds.length?Ds:qf();if(!t.length)return null;const n=Sl(e);if(n){const o=t.find(l=>l.searchValueNormalized===n);if(o)return o}const{description:a,barcode:s}=tL(e);if(s){const o=pa(s);if(o){const l=t.find(d=>d.barcode===o);if(l)return l}}const r=xf(a||e);if(!r)return null;const i=t.find(o=>o.descriptionNormalized===r);return i||t.find(o=>o.descriptionNormalized.includes(r))||null}function Am(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,r=(t||kf().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||r>=1:r>=a}function As({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),s&&(s.value="")),r&&(r.textContent=Sm(),r.classList.remove("maintenance-selected-info--has-selection")),Vi=null}function xA(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر"),s=c("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),r=c("maintenance.info.categoryLabel","القسم"),i=e.displayBarcode||e.barcode||a,o=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,d=IA(o),u=Math.max(l-d,0),m=e.category?`
    <div class="maintenance-selected-info__meta">${r}: <strong>${Ze(e.category)}</strong></div>
  `:"",p=l>0?`
    <div class="maintenance-selected-info__meta">
      ${s}: <strong>${u}</strong> / ${l}
    </div>
  `:"",f=e.image?`<img class="maintenance-selected-info__image" src="${Ze(e.image)}" alt="${Ze(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${f}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${Ze(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${Ze(i)}</strong></div>
      ${p}
      ${m}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function _f(e,{silent:t=!1}={}){if(!e)return!1;if(Am(e))return t||I(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),s&&(s.value=e.searchValue||e.desc),xA(e),Vi=e,!0}function qA(e,{showFeedback:t=!0}={}){const n=cd(e);return n?_f(n,{silent:!t}):(t&&I(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function kA(e,{showFeedback:t=!0}={}){const n=aL(e);return n?_f(n,{silent:!t}):(t&&I(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function Tf(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=qf(),{map:s}=kf();e&&(e.innerHTML=a.map(i=>`<option value="${Ze(i.searchValue||i.desc)}"></option>`).join(""));const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const i=cd(r.value);!i||Am(i,s)?(As({keepInputs:!0,silent:!0}),i&&Am(i,s)&&I(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):_f(i,{silent:!0})}else As({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),qA(t.value)||As({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const i=()=>{if(!n.value){As({keepInputs:!0,silent:!0});return}kA(n.value)||As({keepInputs:!0,silent:!0})};n.addEventListener("change",i),n.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),i())}),n.dataset.listenerAttached="true"}}async function Al(){try{await di({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{jt(),Tf()}}function _A(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;If=t.Modal.getOrCreateInstance(e),Nt||(Nt=e.querySelector("#maintenance-close-report")),pt||(pt=e.querySelector("#maintenance-close-cost")),pt&&pt.dataset.normalizeAttached!=="true"&&(pt.addEventListener("input",a=>{sL(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),pt.dataset.normalizeAttached="true"),Yt||(Yt=e.querySelector("#maintenance-close-submit")),Xr||(Xr=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",iL),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",TA),e.dataset.listenerAttached="true"),!0}function TA(){jn={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},Nt&&(Nt.value="",Nt.classList.remove("is-invalid")),pt&&(pt.value="",pt.classList.remove("is-invalid")),Xr&&(Xr.innerHTML=""),go(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),n&&(n.textContent=c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.")),Yt&&(Yt.textContent=c("maintenance.closeModal.confirm","إغلاق التذكرة"))}}function CA(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(Ki=t.Modal.getOrCreateInstance(e),Jr||(Jr=e.querySelector("#maintenance-report-modal-content")),vt||(vt=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",PA),e.dataset.listenerAttached="true"),vt&&vt.dataset.listenerAttached!=="true"&&(vt.addEventListener("click",mL),vt.dataset.listenerAttached="true"),!0):!1}function PA(){Jr&&(Jr.innerHTML=""),vt&&(vt.hidden=!0,vt.disabled=!1,delete vt.dataset.id)}function go(e){if(!Yt)return;const t=jn.mode==="edit",n=t?c("maintenance.closeModal.editSaving","⏳ جاري الحفظ..."):c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),a=t?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(Yt.disabled=!0,Yt.dataset.loading="true",Yt.textContent=n):(Yt.disabled=!1,Yt.removeAttribute("data-loading"),Yt.textContent=a)}function sL(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=b(t).replace(/٫/g,".").replace(/٬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:s}=e;if(e.value=n,a!==null&&s!==null)try{e.setSelectionRange(a,s)}catch{}}}function rL(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const r=b(n).replace(/٫/g,".").replace(/٬/g,",").replace(/[^0-9.,-]/g,"");if(!r)return{provided:!0,value:null,error:"invalid"};const i=r.includes(","),o=r.includes(".");let l=r;i&&!o?l=r.replace(",","."):i&&o&&(l=r.replace(/,/g,""));const d=Number.parseFloat(l);return!Number.isFinite(d)||d<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(d*100)/100,error:null}}function LA(e,{mode:t="close"}={}){const n=wA(e);if(!n){I(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!_A()){const l=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(l===null)return;const d=l.trim();if(!d){I(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}NA(e,d);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(b(String(n.repairCost))):null,s=Number.isFinite(a)?Math.round(a*100)/100:null,r=t==="edit"?"edit":"close";if(jn={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:s,resolvedAt:n.resolvedAt||null,mode:r},Nt&&(Nt.value=n.resolutionReport||"",Nt.classList.remove("is-invalid")),pt&&(s!==null?pt.value=b(s.toFixed(2)):pt.value="",pt.classList.remove("is-invalid")),Xr){const l=c("maintenance.report.barcode","الباركود"),d=c("maintenance.report.notAvailable","غير متوفر"),u=jn.equipmentDesc||d,m=jn.equipmentBarcode?b(jn.equipmentBarcode):d;Xr.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${u}</div>
          <div class="maintenance-close-modal__ticket-meta">${l}: <span>${m}</span></div>
        </div>
      </div>
    `}go(!1);const i=r==="edit";Yt&&(Yt.textContent=i?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة"));const o=document.getElementById("closeMaintenanceModal");if(o){const l=o.querySelector("#maintenance-close-modal-title"),d=o.querySelector(".maintenance-close-modal__subtitle");l&&(l.textContent=i?c("maintenance.closeModal.editTitle","✏️ تعديل بيانات الإغلاق"):c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),d&&(d.textContent=i?c("maintenance.closeModal.editSubtitle","يمكنك تحديث تقرير الإصلاح وتكلفته."):c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة."))}If?.show(),setTimeout(()=>{Nt?.focus(),Nt?.setSelectionRange(Nt.value.length,Nt.value.length)},150)}async function iL(e){if(e?.preventDefault(),!jn.id){I(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!Nt)return;const t=Nt.value.trim();if(!t){I(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),Nt.focus();return}pt&&pt.classList.remove("is-invalid");const n=pt?rL(pt.value,jn.repairCost):{provided:!1,value:null,error:null};if(n.error){I(c("maintenance.toast.invalidRepairCost","⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح"),"error"),pt?.classList.add("is-invalid"),pt?.focus();return}go(!0),(await NA(jn.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:jn.mode,resolvedAt:jn.resolvedAt})).success?If?.hide():go(!1)}function oL(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(m=>m.status==="open").length,s=n-a,r=m=>b(String(m)),i=c("maintenance.stats.summaryTitle","ملخص الصيانة"),o=c("maintenance.filters.status.open","قيد الصيانة"),l=c("maintenance.filters.status.closed","مغلقة"),d=c("maintenance.stats.totalLabel","إجمالي التذاكر"),u=(m,p,f)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${f}">
      <span class="maintenance-summary__value">${r(m)}</span>
      <span class="maintenance-summary__label">${p}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${i}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${u(a,o,"open")}
        ${u(s,l,"closed")}
        ${u(n,d,"total")}
      </div>
    </section>
  `}function cL(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=gf(n)||"open",s={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},r=s[a]??s.open,i=r?c(r.key,r.fallback):c("maintenance.status.open","قيد الصيانة"),o=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():i,l=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&l.push(r.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${o}</span>`}function lL(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),s=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${s}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const s=cL(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",i=(()=>{const x=c("maintenance.priority.high","مرتفعة"),A=c("maintenance.priority.medium","متوسطة"),C=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${x}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${C}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${A}</span>`}})(),o=[],l=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),d=c("maintenance.actions.view","👁️ عرض التقرير"),u=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?o.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):o.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${d}</button>`),St()&&o.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${u}</button>`);const m=o.join(""),p=c("maintenance.table.noBarcode","بدون باركود"),f=c("maintenance.report.none","—"),h=a.equipmentBarcode?b(a.equipmentBarcode):p,g=a.issue?b(a.issue):f,y=a.repairCost!=null?Number.parseFloat(b(String(a.repairCost))):null,E=a.status==="closed"&&Number.isFinite(y)?`<div class="maintenance-repair-cost">${Ze(c("maintenance.table.repairCost","💰 تكلفة الإصلاح: {amount}").replace("{amount}",b(y.toFixed(2))))}</div>`:"",S=a.createdAt?b(vm(a.createdAt)||mt(a.createdAt)):"—";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${h}</small>
          </td>
          <td class="maintenance-issue-text">${g}${E}</td>
          <td>${i}</td>
          <td>${S}</td>
          <td>${s}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${m}
            </div>
          </td>
        </tr>
      `}).join("")}}function dL(e){if(!Bs||Nr){I(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")LA(a);else if(n==="view")uL(a);else if(n==="delete"){if(!St()){Nn();return}pL(a).catch(s=>{console.error("❌ [maintenance] deleteTicket failed",s)})}}}async function NA(e,t,n={}){const a=wA(e);if(!a)return I(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const s=(t??"").trim();if(!s)return I(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const r=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:nL(new Date)||new Date().toISOString(),i={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:s,resolved_at:r};n?.repairCostProvided&&(i.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await iA(e,i),await yo({showToastOnError:!1});const o=document.getElementById("maintenance-status-filter");return o&&o.value==="open"&&(o.value="all"),await Al(),pn(),I(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(o){if(console.error("❌ [maintenance] closeTicket failed",o),Yr(o)&&o.status===404)return await yo({showToastOnError:!1}),await Al(),pn(),I(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const l=Yr(o)?o.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return I(l,"error"),{success:!1,error:o}}}function uL(e){const n=os().find(A=>Number(A.id)===Number(e));if(!n)return;if(n.id,!CA()){const A=c("maintenance.report.equipment","المعدة"),C=c("maintenance.report.barcode","الباركود"),j=c("maintenance.report.issue","الوصف"),k=c("maintenance.report.createdAt","تاريخ الإنشاء"),w=c("maintenance.report.closedAt","تاريخ الإغلاق"),_=c("maintenance.report.summary","التقرير"),$=c("maintenance.report.repairCost","تكلفة الإصلاح"),q=c("maintenance.report.currencyLabel","ريال"),F=Number.parseFloat(b(String(n.repairCost??""))),U=Number.isFinite(F)?`${b(F.toFixed(2))} ${q}`:B,L=c("maintenance.report.notAvailable","غير متوفر"),B=c("maintenance.report.none","—"),D=[`${A}: ${n.equipmentDesc}`,`${C}: ${n.equipmentBarcode?b(n.equipmentBarcode):L}`,`${j}: ${n.issue?b(n.issue):B}`,`${k}: ${n.createdAt?b(vm(n.createdAt)||mt(n.createdAt)):B}`,`${w}: ${n.resolvedAt?b(mt(n.resolvedAt)):B}`,`${$}: ${U}`,`${_}: ${n.resolutionReport?b(n.resolutionReport):B}`].join(`
`);alert(D);return}const a=c("maintenance.report.equipment","المعدة"),s=c("maintenance.report.barcode","الباركود"),r=c("maintenance.report.issue","الوصف"),i=c("maintenance.report.createdAt","تاريخ الإنشاء"),o=c("maintenance.report.closedAt","تاريخ الإغلاق"),l=c("maintenance.report.repairCost","تكلفة الإصلاح"),d=c("maintenance.report.summary","التقرير"),u=c("maintenance.report.notAvailable","غير متوفر"),m=c("maintenance.report.none","—"),p=Number.parseFloat(b(String(n.repairCost??""))),f=Number.isFinite(p)?b(p.toFixed(2)):null,h=c("maintenance.report.currencyLabel","ريال"),g=[{label:a,value:`<span class="maintenance-report-modal__value">${Ze(n.equipmentDesc||m)}</span>`},{label:s,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${Ze(b(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${Ze(u)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${Ze(b(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${Ze(m)}</span>`},{label:i,value:n.createdAt?`<span class="maintenance-report-modal__value">${Ze(b(vm(n.createdAt)||mt(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${Ze(m)}</span>`},{label:o,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${Ze(b(mt(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${Ze(m)}</span>`},{label:l,value:f?`<span class="maintenance-report-modal__value">${Ze(f)} ${Ze(h)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${Ze(m)}</span>`}],y=n.resolutionReport?b(n.resolutionReport):"",E=y?`<p>${Ze(y).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${Ze(m)}</p>`,S=g.map(A=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${Ze(A.label)}</span>
        ${A.value}
      </div>
    `).join(""),x=`
    <div class="maintenance-report-modal__summary">
      <h6>${Ze(d)}</h6>
      ${E}
    </div>
  `;if(Jr&&(Jr.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${S}
        </div>
        ${x}
      </div>
    `),vt){const A=St()&&n.status==="closed";vt.hidden=!A,vt.disabled=!A,vt.textContent=c("maintenance.actions.editClosed","✏️ تعديل بيانات الإغلاق"),A?vt.dataset.id=String(n.id):delete vt.dataset.id}Ki?.show()}function mL(){if(!vt)return;const e=Number(vt.dataset.id);if(!e){Ki?.hide();return}if(!St()){Ki?.hide(),Nn();return}Ki?.hide(),setTimeout(()=>{LA(e,{mode:"edit"})},220)}async function pL(e){if(!St()){Nn();return}if(!os().find(a=>Number(a.id)===Number(e))){I(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await oA(e),await yo({showToastOnError:!1}),await Al(),I(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const s=Yr(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");I(s,"error")}}async function fL(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let i=Vi,o=pa(a?.value);if(!i&&o&&(i=cd(o)),!i&&t?.value&&qA(t.value,{showFeedback:!0})&&(i=Vi,o=pa(i?.barcode)),!i&&n?.value&&kA(n.value,{showFeedback:!0})&&(i=Vi,o=pa(i?.barcode)),!i||!o){I(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=ae();let d=(l||[]).find(y=>pa(y?.barcode)===o);if(!d&&i&&(d={id:i.id,barcode:i.barcode,desc:i.desc,name:i.desc,status:i.status||"متاح",quantity:i.quantity,qty:i.quantity}),!d||d.id==null){I(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),As();return}const u=Number.parseInt(d.qty??d.quantity??i?.quantity??1,10),m=Number.isFinite(u)&&u>0?u:1,p=IA(o);if(jA(d.status||i?.status)==="maintenance"&&m<=1){I(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(p>=m){I(c("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const h=cA({equipmentId:d.id,technicianId:null,issue:s?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await rA(h),await yo({showToastOnError:!1}),await Al(),I(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),As(),s&&(s.value=""),r&&(r.value="medium");const g=document.getElementById("maintenance-status-filter");g&&(g.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=Yr(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");I(n,"error")}}function hL({status:e="all",query:t="",priority:n="all"}={}){let s=os();e!=="all"&&(s=s.filter(i=>i.status===e)),n!=="all"&&(s=s.filter(i=>String(i.priority||"medium")===n));const r=Sl(t||"");return r&&(s=s.filter(i=>{const o=xf(i.equipmentDesc||""),l=Sl(i.equipmentBarcode||"");return o.includes(r)||l.includes(r)})),s}function pn(){const e=os();Tf(),oL(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",s=document.getElementById("maintenance-search")?.value||"",i=document.getElementById("maintenance-priority-filter")?.value||"all",o=document.getElementById("maintenance-table-body"),l=document.getElementById("maintenance-empty-state");if(!o)return;if(Nr&&!Bs){const u=c("maintenance.table.loading","جاري التحميل...");o.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${u}</td></tr>`,l&&l.classList.remove("active");return}if(Ir&&!Bs){o.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${Ir}</td></tr>`,l&&l.classList.remove("active");return}const d=hL({status:n,query:s,priority:i});lL(d)}function yL(){os(),Tf(),Bs=Qa.length>0,Nr=!1,pn(),yo({showToastOnError:!1}),_A()&&TA(),CA()&&PA();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",r=>{fL(r).catch(i=>{console.error("❌ [maintenance] submit handler failed",i)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{pn()}),t.dataset.listenerAttached="true");const n=document.getElementById("maintenance-priority-filter");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{pn()}),n.dataset.listenerAttached="true");const a=document.getElementById("maintenance-search");if(a&&!a.dataset.listenerAttached){const r=()=>pn();a.addEventListener("input",r),a.addEventListener("change",r),a.dataset.listenerAttached="true"}const s=document.querySelector(".maintenance-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",dL),s.dataset.listenerAttached="true")}os();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=cd(e.value);n?xA(n):t&&(t.textContent=Sm())}else t&&(t.textContent=Sm());pn(),go(!1)});document.addEventListener(ei.USER_UPDATED,()=>{pn()});window.addEventListener("maintenance:updated",()=>{Qa=Ho(),pn()});const gL=Object.freeze(Object.defineProperty({__proto__:null,initMaintenance:yL,renderMaintenance:pn},Symbol.toStringTag,{value:"Module"})),jc={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let Em=!1;const bL=1632,vL=1776;function SL(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-bL)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-vL)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function AL(e){try{const t=SL(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function Ic(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=AL(t))}function xc(e){try{const t=typeof e=="function"?e():null;return Array.isArray(t)?t.length:0}catch{return 0}}function ng(){Em=!1;const e=xc(()=>ae()?.projects),t=xc(()=>ae()?.reservations),n=xc(()=>ae()?.equipment),a=xc(()=>ae()?.technicians);jc.projects.forEach(s=>Ic(s,e)),jc.reservations.forEach(s=>Ic(s,t)),jc.equipment.forEach(s=>Ic(s,n)),jc.technicians.forEach(s=>Ic(s,a))}function ag(){Em||(Em=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(ng):setTimeout(ng,16))}function EL(){["reservations:changed","reservations:updated","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:updated","language:changed"].forEach(t=>{document.addEventListener(t,ag,{passive:!0})}),ag()}const CL=Object.freeze(Object.defineProperty({__proto__:null,initDashboardMetrics:EL},Symbol.toStringTag,{value:"Module"}));export{Ll as _,Gs as a,Ia as b,Rs as c,_L as d,IL as e,ae as f,Yl as g,jL as h,vo as i,xL as j,CL as k,ti as l,TL as m,qL as p,jt as r,kL as s,wL as t,Sj as u,Dp as w};
