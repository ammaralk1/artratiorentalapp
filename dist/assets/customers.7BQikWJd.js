import{l as C,A as w,t as a,u as Q,n as R,a as B,b as M,s as d,c as tt,d as et}from"./auth.Bu23w_7X.js";let p=null,k=!1,S="";const nt=C()||{};let D=(nt.customers||[]).map(T),g=null,N="idle",z=null;function H(t){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(b=>b&&typeof b=="object"),n=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],s=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],o=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],i=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],r=[t.document_size,t.documentSize,t.size,e?.size,e?.length],l=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],u=b=>{for(const f of b)if(typeof f=="string"&&f.trim()!=="")return f.trim();return""},c=b=>{for(const f of b){if(typeof f=="number"&&Number.isFinite(f))return Math.max(0,Math.trunc(f));if(typeof f=="string"&&f.trim()!==""&&/^\d+$/.test(f.trim()))return Math.max(0,parseInt(f.trim(),10))}return null},m=u(n),v=u(o),I=u(i)||"application/octet-stream",A=u(s),K=u(l),Z=c(r);if(!m&&!K)return null;let _=m,y=K;if(!_&&y&&y.startsWith("data:")){const b=y.indexOf(",");b!==-1&&(_=y,y=y.slice(b+1))}!_&&y&&(_=`${y.startsWith("data:")?"":`data:${I};base64,`}${y}`);const U={url:_,fileName:v,mimeType:I,path:A,data:y||null,size:Z};return U.url&&/sirv\.com/i.test(U.url)&&(U.source="sirv"),U}function j(){N="idle",z=null}function P(t,e){N=t,z=e||null,x()}function V(){return N==="uploading"}function $(t){return!t||typeof t!="object"?!1:!!t.url||!!t.data}function ot(t){if(!$(t))return null;const e={},n=typeof t.url=="string"?t.url.trim():"",s=t.size;let o=n;return o||(o=J(t)),o?(e.url=o,t.path&&(e.path=t.path),t.mimeType&&(e.mimeType=t.mimeType),t.fileName&&(e.fileName=t.fileName),typeof s=="number"&&Number.isFinite(s)?e.size=Math.max(0,Math.trunc(s)):typeof s=="string"&&s.trim()!==""&&/^\d+$/.test(s.trim())&&(e.size=Math.max(0,parseInt(s.trim(),10))),e):null}function T(t={}){if(!t||typeof t!="object")return{id:"",full_name:"",customerName:"",name:"",phone:"",email:"",address:"",company:"",notes:"",created_at:null,updated_at:null};const e=t.id??t.customerId??t.reservationId??t.customerID,n=t.full_name??t.customerName??t.name??"",s=typeof n=="string"?n.trim():String(n||"").trim(),o=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",i=H(t);return{id:e!=null?String(e):"",full_name:s,customerName:s,name:s,phone:t.phone??t.phoneNumber??"",email:t.email??"",address:t.address??"",company:t.company??t.companyName??"",notes:t.notes??"",tax_id:typeof o=="string"?o.trim():String(o||"").trim(),taxId:typeof o=="string"?o.trim():String(o||"").trim(),document:i,created_at:t.created_at??null,updated_at:t.updated_at??null}}function X(){document.dispatchEvent(new CustomEvent("customers:changed"))}function L(){return D}function F(t){D=Array.isArray(t)?t.map(T):[],et({customers:D})}function h(){return{form:document.getElementById("customer-form"),idInput:document.getElementById("customer-id"),nameInput:document.getElementById("customer-name"),phoneInput:document.getElementById("customer-phone"),emailInput:document.getElementById("customer-email"),addressInput:document.getElementById("customer-address"),companyInput:document.getElementById("customer-company"),notesInput:document.getElementById("customer-notes"),taxInput:document.getElementById("customer-tax-id"),documentInput:document.getElementById("customer-document"),documentNameLabel:document.getElementById("customer-document-name"),documentPreviewBtn:document.getElementById("customer-document-preview"),submitBtn:document.getElementById("submit-btn"),cancelBtn:document.getElementById("customer-cancel-btn")}}function st(){const{submitBtn:t}=h();t&&(t.disabled=V())}function x(){const{documentNameLabel:t,documentPreviewBtn:e}=h(),n=V(),s=$(g);if(e&&(e.disabled=!s||n),t){let i=a("customers.form.document.empty","لم يتم اختيار ملف بعد");n?i=a("customers.form.document.uploading","📤 جارٍ رفع الملف..."):N==="error"?i=z||a("customers.form.document.uploadFailed","⚠️ فشل رفع الملف"):s&&(i=g?.fileName?.trim()||a("customers.form.document.selected","تم إرفاق ملف.")),t.textContent=i}st()}function O(t="add"){const{submitBtn:e}=h();if(!e)return;const n=t==="update"?"customers.form.actions.update":"customers.form.actions.submit",s=t==="update"?"💾 حفظ التعديل":"➕ إضافة عميل";e.textContent=a(n,s)}function W(t){const{cancelBtn:e}=h();e&&(t?e.classList.remove("d-none"):e.classList.add("d-none"),e.textContent=a("customers.form.actions.cancel","إلغاء التعديل"))}function q(){const t=!!p;O(t?"update":"add"),W(t),x()}function G(){const{form:t,idInput:e,phoneInput:n}=h();t?.reset(),e&&(e.value=""),n&&(n.value=n.value.trim()),g=null,j(),x(),p=null,O("add"),W(!1)}function it(t){const{idInput:e,nameInput:n,phoneInput:s,emailInput:o,addressInput:i,companyInput:r,notesInput:l,taxInput:u,documentInput:c}=h();!t||!n||!s||(e&&(e.value=t.id),n.value=t.full_name||"",s.value=R(t.phone||""),o&&(o.value=t.email||""),i&&(i.value=t.address||""),r&&(r.value=t.company||""),l&&(l.value=t.notes||""),u&&(u.value=t.tax_id||""),c&&(c.value=""),g=t.document?{...t.document}:null,j(),x(),p=t.id,O("update"),W(!0))}function at(){const{idInput:t,nameInput:e,phoneInput:n,emailInput:s,addressInput:o,companyInput:i,notesInput:r,taxInput:l}=h();if(!e||!n)return null;const u=e.value.trim(),c=R(n.value.trim());if(n.value=c,!u||!c)return d(a("customers.toast.missingFields","يرجى تعبئة الاسم ورقم الهاتف"),"error"),null;if(V())return d(a("customers.form.document.uploadingWait","⏳ يرجى الانتظار حتى يكتمل رفع الملف"),"info"),null;if(N==="error"){const A=z||a("customers.form.document.uploadFailed","⚠️ فشل رفع الملف، حاول مرة أخرى");return d(A,"error"),null}const m={full_name:u,phone:c,email:s?.value.trim()||"",address:o?.value.trim()||"",company:i?.value.trim()||"",notes:r?.value.trim()||""},v=l?.value.trim()||"";m.tax_id=v,m.taxId=v;const I=ot(g);return I&&(m.document=I),{payload:m,id:t?.value||p||""}}async function ct(t){const{documentInput:e}=h(),n=t.target?.files&&t.target.files[0];if(!n){g=null,j(),x(),e&&(e.value="");return}P("uploading");try{const s=new FormData;s.append("file",n),p&&s.append("customer_id",p);const i=(await B("/uploads/sirv.php",{method:"POST",body:s}))?.data;if(!i||!i.url)throw new Error("Missing upload URL from server response");g={url:i.url,path:i.path||"",fileName:i.fileName||n.name,mimeType:i.mimeType||n.type||"application/octet-stream",size:typeof i.size=="number"?i.size:n.size,source:i.source||"sirv"},P("success"),d(a("customers.form.document.uploadSuccess","✅ تم رفع الملف بنجاح"),"success")}catch(s){console.error("[customers] Failed to upload document to Sirv",s),g=null;const o=s instanceof M?s.message:a("customers.form.document.uploadFailed","⚠️ تعذر رفع الملف، حاول مرة أخرى");P("error",o),d(o,"error")}finally{e&&(e.value=""),x()}}function J(t){if(!t||typeof t!="object")return"";const e=typeof t.url=="string"?t.url.trim():"";if(e)return e;const n=typeof t.data=="string"?t.data.trim():"";return n?`data:${t.mimeType||"application/octet-stream"};base64,${n}`:""}function rt(){if(!$(g)){d(a("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const t=J(g);if(!t){d(a("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل."),"info");return}window.open(t,"_blank","noopener")}async function Y({showToastOnError:t=!0}={}){k=!0,S="",E();try{const e=await B("/customers/"),n=Array.isArray(e?.data)?e.data.map(T):[];F(n)}catch(e){S=e instanceof M?e.message:a("customers.toast.fetchFailed","تعذر تحميل قائمة العملاء"),t&&d(S,"error")}finally{k=!1,E()}}async function ut(t){t.preventDefault();const e=at();if(!e)return;const{payload:n}=e,s=!!p;try{if(s){const o=p,i=await B(`/customers/?id=${encodeURIComponent(o)}`,{method:"PATCH",body:n}),r=T(i?.data),l=H(n.document),u={...r,document:r.document??l,tax_id:r.tax_id??n.tax_id??"",taxId:r.taxId??n.taxId??""},c=L().map(m=>String(m.id)===String(o)?u:m);F(c),d(a("customers.toast.updateSuccess","تم تحديث بيانات العميل بنجاح"))}else{const o=await B("/customers/",{method:"POST",body:n}),i=T(o?.data),r=H(n.document),l={...i,document:i.document??r,tax_id:i.tax_id??n.tax_id??"",taxId:i.taxId??n.taxId??""},u=[...L(),l];F(u),d(a("customers.toast.createSuccess","تمت إضافة العميل بنجاح"))}E(),G(),X()}catch(o){const i=o instanceof M?o.message:a("customers.toast.submitFailed","حدث خطأ أثناء حفظ بيانات العميل");d(i,"error")}}async function dt(t){const e=t.target;if(!(e instanceof HTMLElement))return;const n=e.closest("button");if(n instanceof HTMLElement){if(n.classList.contains("customer-delete-btn")){if(!Q()){tt();return}const s=n.dataset.id;if(!confirm(a("customers.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العميل؟")))return;try{await B(`/customers/?id=${encodeURIComponent(s)}`,{method:"DELETE"});const o=L().filter(i=>String(i.id)!==String(s));F(o),E(),String(p)===String(s)&&G(),d(a("customers.toast.deleteSuccess","تم حذف العميل")),X()}catch(o){const i=o instanceof M?o.message:a("customers.toast.deleteFailed","تعذر حذف العميل، يرجى المحاولة مجدداً");d(i,"error")}return}if(n.classList.contains("customer-view-file-btn")){const s=n.dataset.id,o=L().find(r=>String(r.id)===String(s));if(!$(o?.document)){d(a("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const i=J(o.document);if(!i){d(a("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل."),"info");return}window.open(i,"_blank","noopener");return}if(n.classList.contains("customer-edit-btn")){const s=n.dataset.id,o=L().find(i=>String(i.id)===String(s));if(!o)return;it(o)}}}function lt(t){const e=t.target.value.trim().toLowerCase(),s=L().filter(i=>{const r=i.full_name?.toLowerCase()||"",l=i.phone?.toLowerCase()||"",u=i.company?.toLowerCase()||"";return r.includes(e)||l.includes(e)||u.includes(e)}),o=e?a("customers.table.noResults","لا توجد نتائج مطابقة"):void 0;E(s,{emptyMessage:o})}function mt(){const{form:t,cancelBtn:e}=h();t&&t.addEventListener("submit",ut);const{documentInput:n,documentPreviewBtn:s}=h();n&&!n.dataset.listenerAttached&&(n.addEventListener("change",ct),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("click",rt),s.dataset.listenerAttached="true"),e&&e.addEventListener("click",()=>{G()});const o=document.getElementById("customers-table");o&&o.addEventListener("click",dt);const i=document.getElementById("search-customer-input");i&&i.addEventListener("input",lt),x()}document.addEventListener("DOMContentLoaded",()=>{mt(),E(),q(),Y()});document.addEventListener("language:changed",()=>{q(),E()});document.addEventListener("customers:refreshRequested",()=>{Y({showToastOnError:!1}),q()});document.addEventListener(w.USER_UPDATED,()=>{E()});function E(t,e={}){const n=Array.isArray(t),s=n?t:L(),o=document.getElementById("customers-table");if(!o)return;if(o.innerHTML="",!n){if(k){o.innerHTML=`<tr><td colspan='5'>${a("customers.table.loading","جاري التحميل...")}</td></tr>`;return}if(S){o.innerHTML=`<tr><td colspan='5' class='text-danger'>${S}</td></tr>`;return}}if(s.length===0){const c=e.emptyMessage||a("customers.table.empty","لا يوجد عملاء");o.innerHTML=`<tr><td colspan='5'>${c}</td></tr>`;return}const i=a("customers.actions.edit","✏️ تعديل"),r=a("customers.actions.delete","🗑️ حذف"),l=a("customers.actions.viewDocument","📎 عرض الملف"),u=Q();s.forEach(c=>{const m=p&&String(p)===String(c.id),v=document.createElement("tr");m&&v.classList.add("customer-table-row-editing");const I=[`<button type="button" class="customer-action-btn customer-action-btn--edit customer-edit-btn" data-id="${c.id}">${i}</button>`];$(c.document)&&I.push(`<button type="button" class="customer-action-btn customer-action-btn--file customer-view-file-btn" data-id="${c.id}">${l}</button>`),u&&I.push(`<button type="button" class="customer-action-btn customer-action-btn--delete customer-delete-btn" data-id="${c.id}">${r}</button>`),v.innerHTML=`
      <td><a href="customer.html?id=${c.id}" class="text-decoration-none">${c.full_name}</a></td>
      <td>${R(c.phone)}</td>
      <td>${c.company||""}</td>
      <td class="table-notes-cell">${c.notes||"—"}</td>
      <td class="table-actions-cell">
        <div class="table-action-buttons">
          ${I.join("")}
        </div>
      </td>
    `,o.appendChild(v)})}export{E as r};
