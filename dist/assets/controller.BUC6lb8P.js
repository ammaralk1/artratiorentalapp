import{d as ne,n as S,t as c,j as h,b as $e,z as Ma,y as Mt,v as Va,w as za,u as Ha}from"./auth.TVJ8X2CT.js";import{g as Ve,r as it,f as en,a as Ua,i as Fn,b as hn}from"./details.aZ73shIC.js";import{k as tn,l as bn,n as Ie,s as In,o as gt,b as pt,D as Qe,p as et,q as tt,h as Mn,c as kt,e as wt,t as Vn,v as Oa,w as zn,x as Ga,y as Wa,z as Hn,a as vt,d as Ja,A as Vt,B as zt,C as ot,E as Sn,F as En,g as Un,G as Qa,H as Ka,I as Ya,u as Xa,r as Za,J as es,j as ts}from"./reservationsService.qONKBTBX.js";import{l as nn,o as On,p as ns,q as Ke,u as xt,v as fe,n as R,w as Gn,x as an,y as Te,z as jt,A as At,B as as,C as Wn,D as Jn,E as Qn,s as ft,F as Kn,G as Ye,b as sn,H as ss,I as rs,J as is,K as Yn,L as os,M as cs,k as Xn,N as kn}from"./state.BcSvKqfh.js";import{s as rn,E as Zn,a as ds,c as ls,b as us,r as ms}from"./equipment.XGjk1pcx.js";import{g as ps,a as fs,b as ys}from"./reservationPdf.UllNkH8s.js";import{o as gs}from"./view.BFFO1XGg.js";import{d as vs,c as hs}from"./reservationsActions.D4CLybEk.js";import{ensureProjectsLoaded as bs}from"./projectsService.C-t3q7Yb.js";import{s as Is}from"./uiBridge.BLZZT8b9.js";const Ss="__DEBUG_CREW__";function Es(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Ss);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function wn(e,n){if(Es())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const ea="projects:create:draft",ta="projects.html#projects-section";let Ht=null,na=[],Ut=new Map,Ot=new Map,Bt=new Map,Rt=!1,It=null,An=!1,aa=[];const Fe="reservations:create:draft";let at=!1;function Tt(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function on(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function ks(){if(typeof document>"u"||!Tt())return null;try{const{input:n,hidden:t}=rt(),{input:a,hidden:r}=_e(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",o=document.getElementById("res-start-time")?.value||"",d=document.getElementById("res-end-time")?.value||"",p=document.getElementById("res-notes")?.value||"",l=document.getElementById("res-discount")?.value||"",m=document.getElementById("res-discount-type")?.value||"percent",f=!!document.getElementById("res-tax")?.checked,y=!!document.getElementById("res-company-share")?.checked,g=y?Ze("res-company-share"):null,I=document.getElementById("res-payment-status")?.value||"unpaid",k=document.getElementById("res-payment-progress-type")?.value||"percent",v=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:o,endTime:d,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:p,discount:String(l||""),discountType:m,taxEnabled:f,companyShareEnabled:y,companySharePercent:g,paymentStatus:I,paymentProgressType:k,paymentProgressValue:String(v||""),items:fe()||[],technicianIds:Wa()||[],crewAssignments:tn()||[]}}catch{return null}}function Me(){if(at)return;const e=Tt(),n=on();if(!e&&!n)return;const t=ks();if(t){try{const r=(()=>{const i=e?e.getItem(Fe):null,o=!i&&n?n.getItem(Fe):null,d=i||o;return d?JSON.parse(d):null})(),s=i=>{if(!i)return!1;const o=Array.isArray(i.items)&&i.items.length>0,d=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,p=!!(i.startDate||i.endDate||i.startTime||i.endTime),l=!!(i.customerId||i.customerLabel);return o||d||p||l};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(Fe,a),n&&n!==e&&n.setItem(Fe,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function sa(){const e=Tt(),n=on();if(!(!e&&!n))try{e&&e.removeItem(Fe),n&&n!==e&&n.removeItem(Fe)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function ws(){const e=Tt(),n=on();if(!e&&!n)return;at=!0;let t=null;try{const a=e?e.getItem(Fe):null,r=!a&&n?n.getItem(Fe):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),at=!1;return}if(t)try{if(t.startDate||t.startTime){const i=Ke(t.startDate||"",t.startTime||"");He("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=Ke(t.endDate||"",t.endTime||"");He("res-end","res-end-time",i)}if(t.customerId){we({selectedValue:String(t.customerId)});const{input:i,hidden:o}=rt();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){we({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=rt();i&&(i.value=t.customerLabel),o&&(o.value="");try{const d=qt(t.customerLabel,{allowPartial:!0});d&&(o.value=String(d.id),i.value=d.label,i.dataset.selectedId=String(d.id))}catch{}}if(t.projectId)ze({selectedValue:String(t.projectId)});else if(t.projectLabel){ze({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=_e();i&&(i.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",ge(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(xt(t.items),Se()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{In(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{In(t.technicianIds)}catch{}je();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}O()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{at=!1}}function As(e){if(!e)return null;let n=aa.find(a=>a.id===e)||null;if(n)return n;const t=ss(e);return t?(n={id:e,name:is(t)||e,price:rs(t),items:sn(t),raw:t},n):null}function Pt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Lt(e){return S(String(e||"")).trim().toLowerCase()}function Bs(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=S(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function ra(e){const n=S(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function ia(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function oa(e){if(!e)return null;const n=S(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function ca(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=S(String(n))}}function Xe(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function rt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function _e(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function be(){const{input:e,hidden:n}=_e();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function Je(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function da(e,n,{allowPartial:t=!1}={}){const a=Ie(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,o)=>{o.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function qt(e,n={}){return da(Ut,e,n)}function Gt(e,n={}){return da(Ot,e,n)}function ge(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function la(e){na=Array.isArray(e)?[...e]:[]}function cn(){return na}function dn(e){return e&&cn().find(n=>String(n.id)===String(e))||null}function Bn(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function Ze(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??Qe,a=S(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:Qe}function Ae(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??Qe,a=S(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=Qe),n.dataset.companyShare=String(r),n.checked=!0}function Wt(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Rt){O();return}Rt=!0;const a=()=>{Rt=!1,O()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Qe)),n.disabled){t.checked=!1,h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),Ae()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Ae():t.checked&&(t.checked=!1));a()}function Ps(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function Pn(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function Ln(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function we({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=rt();if(!t||!a||!r)return;const s=nn()||[],i=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const d=new Set;Ut=new Map;const p=s.filter(u=>u&&u.id!=null).map(u=>({id:String(u.id),label:Ln(u)||o})).filter(u=>{if(!u.label)return!1;const y=Ie(u.label);return!y||d.has(y)?!1:(d.add(y),Ut.set(y,u),!0)}).sort((u,y)=>u.label.localeCompare(y.label,void 0,{sensitivity:"base"}));r.innerHTML=p.map(u=>`<option value="${Pt(u.label)}"></option>`).join("");const l=n?"":t.value,m=e?String(e):a.value?String(a.value):"",f=m?s.find(u=>String(u.id)===m):null;if(f){const u=Ln(f)||o;a.value=String(f.id),t.value=u,t.dataset.selectedId=String(f.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":l}function ze({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=_e();if(!a||!r||!s)return;const i=Array.isArray(n)?n:cn()||[],o=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const d=[...i].filter(g=>g&&g.id!=null).sort((g,I)=>String(I.createdAt||I.start||"").localeCompare(String(g.createdAt||g.start||""))),p=t?"":a.value,l=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),m=new Set;Ot=new Map;const f=d.map(g=>{const I=Bn(g)||l;return{id:String(g.id),label:I}}).filter(g=>{if(!g.label)return!1;const I=Ie(g.label);return!I||m.has(I)?!1:(m.add(I),Ot.set(I,g),!0)});s.innerHTML=f.map(g=>`<option value="${Pt(g.label)}"></option>`).join("");const u=e?String(e):r.value?String(r.value):"",y=u?d.find(g=>String(g.id)===u):null;if(y){const g=Bn(y)||l;r.value=String(y.id),a.value=g,a.dataset.selectedId=String(y.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":p}function He(e,n,t){const{date:a,time:r}=Kn(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const o=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,o)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,o)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function ua(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||ze({selectedValue:a});const s=(nn()||[]).find(l=>String(l.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";we(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=Pn(e,"start"),d=Pn(e,"end");o&&He("res-start","res-start-time",o),d&&He("res-end","res-end-time",d);const p=document.getElementById("res-notes");p&&e.description&&(n||!p.value)&&(p.value=e.description),O(),je()}function ma({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:ne(),r=Array.isArray(a)?a:[];la(r);const s=n!=null?String(n):t.value?String(t.value):"";ze({selectedValue:s,projectsList:r}),je(),O()}function je(){const{input:e,hidden:n}=_e(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),p=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),m=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(Je(t,be),a&&Je(a,be)),r&&Je(r,be),s&&Je(s,be),i&&Je(i,be),o&&Je(o,be),d&&Je(d,be),m)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=p),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=p),r&&(r.value="unpaid",ge(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=p),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=p),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=p),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=p),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=p);else{if(t){const f=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",f&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}Wt("tax"),O()}function ln(){const{input:e,hidden:n}=_e();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Gt(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=dn(s.id);i?ua(i,{skipProjectSelectUpdate:!0}):(je(),O())}else n.value="",e.dataset.selectedId="",je(),O()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Gt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Me()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function un(){const{input:e,hidden:n}=rt();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?qt(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),O()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?qt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Me()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function Ls(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){ut({clearValue:!0});return}let t=null;try{const p=decodeURIComponent(n);t=JSON.parse(p)}catch(p){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",p)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),ut({clearValue:!1}),!t)return;t.fromProjectForm&&(It={draftStorageKey:t.draftStorageKey||ea,returnUrl:t.returnUrl||ta});const s=document.getElementById("res-project");if(t.projectId){s&&(ze({selectedValue:String(t.projectId)}),je());const p=dn(t.projectId);p?ua(p,{forceNotes:!!t.forceNotes}):O(),ut()}else{s&&ze({selectedValue:""});const p=t.projectTitle?t.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");Hs(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),p)}t.start&&He("res-start","res-start-time",t.start),t.end&&He("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(t.customerId){const l=(nn()||[]).find(m=>String(m.id)===String(t.customerId));l?.id!=null&&(we({selectedValue:String(l.id)}),o&&(o.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else t.customerName&&i?(we({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",o&&(o.value="")):we({selectedValue:""});const d=document.getElementById("res-notes");d&&t.description&&!d.value&&(d.value=t.description),O()}function De(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Ke(e,t),end:Ke(n,a)}}function pa(e){const n=Lt(e);if(n){const o=Bt.get(n);if(o)return o}const{description:t,barcode:a}=ra(e);if(a){const o=en(a);if(o)return o}const r=Ie(t||e);if(!r)return null;let s=Gn();if(!s?.length){const o=ne();s=Array.isArray(o?.equipment)?o.equipment:[],s.length&&Yn(s)}const i=s.find(o=>Ie(o?.desc||o?.description||"")===r);return i||s.find(o=>Ie(o?.desc||o?.description||"").includes(r))||null}function fa(e,n="equipment-description-options"){const t=Lt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(d=>Lt(d.value)===t)||Bt.has(t))return!0;const{description:r}=ra(e);if(!r)return!1;const s=Ie(r);return s?(Gn()||[]).some(o=>Ie(o?.desc||o?.description||"")===s):!1}const qs={available:0,reserved:1,maintenance:2,retired:3};function $s(e){return qs[e]??5}function qn(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Cs(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${qn(t)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${qn(t)})`}function Ue(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=rn(),a=ne(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];Yn(s);const i=new Map;s.forEach(p=>{const l=Bs(p),m=Lt(l);if(!m||!l)return;const f=Ve(p),u=$s(f),y=i.get(m);if(!y){i.set(m,{normalized:m,value:l,bestItem:p,bestStatus:f,bestPriority:u,statuses:new Set([f])});return}y.statuses.add(f),u<y.bestPriority&&(y.bestItem=p,y.bestStatus=f,y.bestPriority=u,y.value=l)}),Bt=new Map;const d=Array.from(i.values()).sort((p,l)=>p.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(p=>{Bt.set(p.normalized,p.bestItem);const l=Cs(p),m=Pt(p.value);if(l===p.value)return`<option value="${m}"></option>`;const f=Pt(l);return`<option value="${m}" label="${f}"></option>`}).join("");e&&(e.innerHTML=d),n&&(n.innerHTML=d)}function ya(e,n,t={}){const{silent:a=!1}=t,r=R(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=De();if(!s||!i){const y=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||h(y),{success:!1,message:y}}const o=fe();if(mn(o).has(r)){const y=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||h(y),{success:!1,message:y}}const p=an(r,s,i);if(p.length){const y=p.map(I=>I.name).join(", "),g=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${y}`);return a||h(g),{success:!1,message:g}}if(Te(r,s,i)){const y=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const g=new URLSearchParams({type:"equipment",id:r,start:s,end:i});$e(`/reservations/availability.php?${g.toString()}`).then(I=>{const k=Array.isArray(I?.conflicts)?I.conflicts:[],v=Array.from(new Set(k.map(b=>b?.reservation_code||(b?.reservation_id!=null?`#${b.reservation_id}`:null)).filter(Boolean))),w=v.length?`${y}: ${v.join("ØŒ ")}`:y;h(w)}).catch(()=>h(y))}catch{h(y)}return{success:!1,message:y}}const l=en(r);if(!l){const y=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||h(y),{success:!1,message:y}}const m=Ve(l);if(m==="maintenance"||m==="retired"){const y=Xe(m);return a||h(y),{success:!1,message:y}}const f=et(l);if(!f){const y=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||h(y),{success:!1,message:y}}jt({id:f,equipmentId:f,barcode:r,desc:l.desc,qty:1,price:l.price,image:it(l)}),n&&(n.value=""),Se(),O();const u=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||h(u),{success:!0,message:u,barcode:r}}function Jt(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=pa(n);if(!t){h(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Ua(t.barcode),r=Ve(a||t);if(r==="maintenance"||r==="retired"){h(Xe(r));return}const s=R(t.barcode);if(!s){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=et(t);if(!i){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,image:it(t)},{start:d,end:p}=De();if(!d||!p){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const l=fe();if(mn(l).has(s)){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const f=an(s,d,p);if(f.length){const u=f.map(y=>y.name).join(", ");h(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${u}`));return}if(Te(s,d,p)){const u=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const y=new URLSearchParams({type:"equipment",id:s,start:d,end:p});$e(`/reservations/availability.php?${y.toString()}`).then(g=>{const I=Array.isArray(g?.conflicts)?g.conflicts:[],k=Array.from(new Set(I.map(w=>w?.reservation_code||(w?.reservation_id!=null?`#${w.reservation_id}`:null)).filter(Boolean))),v=k.length?`${u}: ${k.join("ØŒ ")}`:u;h(v)}).catch(()=>h(u))}catch{h(u)}return}jt(o),Se(),O(),h(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function xs(){Ue();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Jt(e))});const n=()=>{fa(e.value,"equipment-description-options")&&Jt(e)};e.addEventListener("focus",()=>{if(Ue(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function $n(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function mn(e=fe()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=R(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=R(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function js(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=De();if(!n||!t){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}ds({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):h(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(Zn.change,n=>{$n(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),$n(e,us()))}function Ts(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,o=null;const d=[],p=new Set;s.forEach(m=>{const f=R(m);f&&!p.has(f)&&(p.add(f),d.push(f))});const l=Math.min(r,d.length);for(let m=0;m<l;m+=1){const f=d[m],u=ya(f,null,{silent:!0});u.success&&(i+=1),u.message&&(o=u.message)}if(i>0){const f=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",S(String(i)));h(f)}else o&&h(o)}function ga(){js(),!(An||typeof document>"u")&&(document.addEventListener(Zn.requestAdd,Ts),An=!0)}function ht(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function Qt(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=ht();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=n==="package";s&&(s.disabled=o),i&&(i.disabled=o),r&&(r.disabled=n!=="package"||r.options.length===0),os(n),n==="package"&&_t()}function _t(){const{packageSelect:e,packageHint:n}=ht();if(!e)return;const t=On();aa=t,ns(t.map(o=>o.raw??o));const a=c("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,p=S(d.toFixed(2)),l=`${o.name} â€” ${p} ${a}`;return`<option value="${o.id}">${l}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),ba()}function _s(e,n){const t=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const o=s?.desc||S(String(s?.barcode??s?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const d=i.map(p=>p.name).join(", ");return`â€¢ ${o} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${d})`}return`â€¢ ${o} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function va(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=Ye(e);if(!s)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=As(s);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(u=>u?.type==="package"&&Ye(u.packageId)===s))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(Wn(s,t,a,r)){const u=i.name||s;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${u} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:sn(i.raw??{}),d=mn(n),p=[],l=new Set;if(o.forEach(u=>{const y=R(u?.normalizedBarcode??u?.barcode);if(y){if(l.has(y)){p.push({item:u,type:"internal"});return}l.add(y),d.has(y)&&p.push({item:u,type:"external"})}}),p.length){const u=p.map(({item:g})=>g?.desc||g?.description||g?.name||g?.barcode||g?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(g=>S(String(g))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:p.some(g=>g.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",u):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",u),duplicates:p}}const m=[];return o.forEach(u=>{const y=R(u?.normalizedBarcode??u?.barcode);if(y&&Te(y,t,a,r)){const g=an(y,t,a,r);m.push({item:u,blockingPackages:g})}}),m.length?{success:!1,reason:"item_conflict",message:_s(i,m),conflicts:m}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:o.map(u=>({equipmentId:u?.equipmentId??null,barcode:u?.barcode??u?.normalizedBarcode??"",normalizedBarcode:R(u?.normalizedBarcode??u?.barcode),desc:u?.desc??"",qty:Number.isFinite(Number(u?.qty))?Number(u.qty):1,price:Number.isFinite(Number(u?.price))?Number(u.price):0})),image:o.find(u=>u?.image)?.image??null},packageInfo:i}}function ha(e,{silent:n=!1}={}){const t=Ye(e);if(!t)return n||h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=De(),s=fe(),i=va(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const d={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");h(i.message||d)}return i}return jt(i.package),Se(),O(),n||h(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function ba(){const{packageSelect:e}=ht();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;ha(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Ds(){const{packageAddButton:e,packageSelect:n}=ht();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}ha(t)}),e.dataset.listenerAttached="true")}function Ia(){const{modeRadios:e}=ht();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&Qt(r.target.value)}),a.dataset.listenerAttached="true")}),Ds(),ba();const n=At(),t=e.find(a=>a.value===n);t&&(t.checked=!0),Qt(n)}function Se(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=fe(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),d=c("reservations.equipment.actions.increaseDays","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£ÙŠØ§Ù…"),p=c("reservations.equipment.actions.decreaseDays","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£ÙŠØ§Ù…"),l=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="6" class="text-center">${a}</td></tr>`;return}const m=gt(t);n.innerHTML=m.map(f=>{const u=f.items[0]||{},y=it(u)||f.image,g=y?`<img src="${y}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',I=S(String(f.count)),k=Number.isFinite(Number(f.unitPrice))?Number(f.unitPrice):0,v=(()=>{const N=(f?.items||[]).map(x=>{const B=x?.days,P=Number.parseFloat(S(String(B??"")));return Number.isFinite(P)&&P>0?Math.round(P):null}).filter(x=>x!=null);if(N.length){const x=Math.max(...N);return Math.min(365,Math.max(1,x))}try{const{start:x,end:B}=De(),P=pt(x,B);return Number.isFinite(P)&&P>0?P:1}catch{return 1}})(),w=S(String(v)),b=k*f.count*v,q=`${S(k.toFixed(2))} ${r}`,C=`${S(b.toFixed(2))} ${r}`,j=f.items.some(N=>N?.type==="package"),H=f.barcodes.map(N=>S(String(N||""))).filter(Boolean),J=H.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${H.map(N=>`<li>${N}</li>`).join("")}
            </ul>
          </details>`:"";let ae="";if(j){const N=new Map;if(f.items.forEach(x=>{Array.isArray(x?.packageItems)&&x.packageItems.forEach(B=>{if(!B)return;const P=R(B.barcode||B.desc||Math.random()),U=N.get(P);if(U){U.qty+=Number.isFinite(Number(B.qty))?Number(B.qty):1;return}N.set(P,{desc:B.desc||B.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(B.qty))?Number(B.qty):1,barcode:B.barcode??B.normalizedBarcode??""})})}),N.size){const x=Array.from(N.values()).map(B=>{const P=S(String(B.qty)),U=B.desc||S(String(B.barcode||"")),_=B.barcode?` <span class="reservation-package-items__barcode">(${S(String(B.barcode))})</span>`:"";return`<li>${U}${_} Ã— ${P}</li>`}).join("");ae=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${x}
              </ul>
            </details>
          `}}const F=j?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",G=j?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${f.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${g}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${f.description||"-"}</div>
                ${j?`${ae||""}${J||""}`:J}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${f.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${f.key}" aria-label="${o}" ${j?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${I}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${f.key}" aria-label="${i}" ${j?"disabled":""}>+</button>
            </div>
          </td>
          <td>
            <div class="${F}" data-group-key="${f.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-days-group" data-group-key="${f.key}" aria-label="${p}"${G}>âˆ’</button>
              <span class="reservation-qty-value">${w}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-days-group" data-group-key="${f.key}" aria-label="${d}"${G}>+</button>
            </div>
          </td>
          <td>${q}</td>
          <td>${C}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${f.key}" aria-label="${l}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Ns(e){const n=fe(),a=gt(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(as(r),Se(),O())}function Rs(e){const n=fe(),t=n.filter(a=>tt(a)!==e);t.length!==n.length&&(xt(t),Se(),O())}function Fs(e){const n=fe(),a=gt(n).find(m=>m.key===e);if(!a)return;const{start:r,end:s}=De();if(!r||!s){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(m=>R(m.barcode))),{equipment:o=[]}=ne(),d=(o||[]).find(m=>{const f=R(m?.barcode);return!f||i.has(f)||tt({desc:m?.desc||m?.description||m?.name||"",price:Number(m?.price)||0})!==e||!Fn(m)?!1:!Te(f,r,s)});if(!d){h(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const p=R(d.barcode),l=et(d);if(!l){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}jt({id:l,equipmentId:l,barcode:p,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,image:it(d)}),Se(),O()}function O(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(S(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:p,end:l}=De();i&&Ae();const m=Ze(),f=document.getElementById("res-payment-progress-type"),u=document.getElementById("res-payment-progress-value"),y=ia(f),g=oa(u);tn(),bn({selectedItems:fe(),discount:t,discountType:r,applyTax:i,paidStatus:d,paymentProgressType:y,paymentProgressValue:g,start:p,end:l,companySharePercent:m,paymentHistory:[]});const I=bn.lastResult;I?(ca(u,I.paymentProgressValue),o&&(o.value=I.paymentStatus,ge(o,I.paymentStatus))):ge(o,d);try{Me()}catch{}}function Ms(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=S(o.target.value),O()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",O),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if(be()){t.checked=!1,h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Wt("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(be()){a.checked=!1,h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Wt("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if(be()){r.value="unpaid",ge(r,"unpaid"),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ge(r),O()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",o=>{if(be()){s.value="percent",h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",O()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(be()){i.value="",h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=S(o.target.value),O()}),i.dataset.listenerAttached="true"),O()}function Vs(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const o=()=>{try{Me()}catch{}};s.addEventListener("input",o),s.addEventListener("change",o),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const o=()=>{try{Me()}catch{}};i.addEventListener("input",o),i.addEventListener("change",o),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){O();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),O()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{Me()}catch{}}});const r=()=>{try{Me()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Cn(){const{input:e,hidden:n}=rt(),{input:t,hidden:a}=_e(),{customers:r}=ne();let s=n?.value?String(n.value):"";if(!s&&e?.value){const A=qt(e.value,{allowPartial:!0});A&&(s=String(A.id),n&&(n.value=s),e.value=A.label,e.dataset.selectedId=s)}const i=r.find(A=>String(A.id)===s);if(!i){h(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&t?.value){const A=Gt(t.value,{allowPartial:!0});A&&(d=String(A.id),a&&(a.value=d),t.value=A.label,t.dataset.selectedId=d)}const p=document.getElementById("res-start").value,l=document.getElementById("res-end").value,m=document.getElementById("res-start-time")?.value||"00:00",f=document.getElementById("res-end-time")?.value||"00:00";if(!p||!l){h(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const u=`${p}T${m}`,y=`${l}T${f}`,g=new Date(u),I=new Date(y);if(Number.isNaN(g.getTime())||Number.isNaN(I.getTime())||g>=I){h(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const k=tn();k.map(A=>A.technicianId).filter(Boolean);const v=fe();if(v.length===0&&k.length===0){h(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const w=document.getElementById("res-notes")?.value||"",b=parseFloat(S(document.getElementById("res-discount")?.value))||0,q=document.getElementById("res-discount-type")?.value||"percent",C=document.getElementById("res-payment-status"),j=C?.value||"unpaid",H=document.getElementById("res-payment-progress-type"),J=document.getElementById("res-payment-progress-value"),ae=ia(H),F=oa(J),G=d?dn(d):null,N=Ps(G);if(d&&!G){h(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const A of v){const M=Ve(A.barcode);if(M==="maintenance"||M==="retired"){h(Xe(M));return}}const x=[];for(const A of v){const M=R(A.barcode);if(Te(M,u,y)){const K=A?.desc||A?.name||A?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");x.push({label:S(String(K)),barcode:M})}}if(x.length){const A=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let M=null;try{const Q=Array.from(new Set(x.map(Z=>Z.barcode).filter(Boolean))),ue=new Map;await Promise.all(Q.map(async Z=>{const me=new URLSearchParams({type:"equipment",id:Z,start:u,end:y}),pe=await $e(`/reservations/availability.php?${me.toString()}`),Le=Array.isArray(pe?.conflicts)?pe.conflicts:[],Re=Array.from(new Set(Le.map(E=>E?.reservation_code||(E?.reservation_id!=null?`#${E.reservation_id}`:null)).filter(Boolean)));ue.set(Z,Re)})),M=x.map(({label:Z,barcode:me})=>{const pe=ue.get(me)||[];return pe.length?`${Z} (${pe.join("ØŒ ")})`:Z}).join("ØŒ ")}catch{}const K=M||x.map(Q=>Q.label).filter(Boolean).map(String).join("ØŒ ");h(`${A}: ${K}`,"warning",6e3);return}const B=[];for(const A of v){if(A?.type!=="package")continue;const M=A.packageId??A.package_id??null;if(M&&Wn(M,u,y)){const K=A.desc||A.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let Q=[];try{const ue=new URLSearchParams({type:"package",id:String(M),start:u,end:y}),Z=await $e(`/reservations/availability.php?${ue.toString()}`),me=Array.isArray(Z?.conflicts)?Z.conflicts:[];Q=Array.from(new Set(me.map(pe=>pe?.reservation_code||(pe?.reservation_id!=null?`#${pe.reservation_id}`:null)).filter(Boolean)))}catch{}B.push({label:S(String(K)),codes:Q})}}if(B.length){const A=B.map(({label:K,codes:Q})=>Q&&Q.length?`${K} (${Q.join("ØŒ ")})`:K).join("ØŒ "),M=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");h(`${M}: ${A}`,"warning",6e3);return}const P=[];for(const A of k){if(!A?.technicianId||!Jn(A.technicianId,u,y))continue;const M=A?.technicianName||A?.positionLabel||String(A.technicianId);let K=[];try{K=Qn(A.technicianId,u,y,null)}catch{}P.push({label:S(String(M)),codes:K})}if(P.length){const A=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),M=P.map(({label:K,codes:Q})=>Q&&Q.length?`${K} (${Q.join("ØŒ ")})`:K).join("ØŒ ");h(`${A}: ${M}`);return}const U=document.getElementById("res-tax"),_=document.getElementById("res-company-share"),L=!!d;L?(U&&(U.checked=!1,U.disabled=!0,U.classList.add("disabled"),U.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),_&&(_.checked=!1,_.disabled=!0,_.classList.add("disabled"),_.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),C&&(C.value="unpaid",C.disabled=!0,ge(C,"unpaid"),C.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),H&&(H.disabled=!0,H.classList.add("disabled")),J&&(J.value="",J.disabled=!0,J.classList.add("disabled"))):(U&&(U.disabled=!1,U.classList.remove("disabled"),U.title=""),_&&(_.disabled=!1,_.classList.remove("disabled"),_.title=""),C&&(C.disabled=!1,C.title=""),H&&(H.disabled=!1,H.classList.remove("disabled")),J&&(J.disabled=!1,J.classList.remove("disabled")));const T=L?!1:U?.checked||!1,$=!!_?.checked;if(!L&&$!==T){h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let Y=$?Ze():null;$&&(!Number.isFinite(Y)||Y<=0)&&(Ae(),Y=Ze());const ie=$&&T&&Number.isFinite(Y)&&Y>0;T&&Ae();const he=Mn(v,b,q,T,k,{start:u,end:y,companySharePercent:ie?Y:0}),Be=Ma(),se=kt({totalAmount:he,progressType:ae,progressValue:F,history:[]});J&&ca(J,se.paymentProgressValue);const nt=[];se.paymentProgressValue!=null&&se.paymentProgressValue>0&&nt.push({type:se.paymentProgressType||ae,value:se.paymentProgressValue,amount:se.paidAmount,percentage:se.paidPercent,recordedAt:new Date().toISOString()});const Pe=wt({manualStatus:j,paidAmount:se.paidAmount,paidPercent:se.paidPercent,totalAmount:he});C&&(C.value=Pe,ge(C,Pe));const Ee=typeof G?.paymentStatus=="string"?G.paymentStatus.toLowerCase():null,Ge=Ee&&["paid","partial","unpaid"].includes(Ee)?Ee:"unpaid",de=Vn({reservationCode:Be,customerId:o,start:u,end:y,status:N?"confirmed":"pending",title:null,location:null,notes:w,projectId:d||null,totalAmount:he,discount:L?0:b,discountType:L?"percent":q,applyTax:T,paidStatus:L?Ge:Pe,confirmed:N,items:v.map(A=>({...A,equipmentId:A.equipmentId??A.id})),crewAssignments:k,companySharePercent:L||!ie?null:Y,companyShareEnabled:L?!1:ie,paidAmount:L?0:se.paidAmount,paidPercentage:L?0:se.paidPercent,paymentProgressType:L?null:se.paymentProgressType,paymentProgressValue:L?null:se.paymentProgressValue,paymentHistory:L?[]:nt});try{wn("about to submit",{crewAssignments:k,techniciansPayload:de?.technicians,payload:de});const A=await Oa(de);wn("server response",{reservation:A?.id??A?.reservationId??A?.reservation_code,technicians:A?.technicians,crewAssignments:A?.crewAssignments,techniciansDetails:A?.techniciansDetails}),rn(),Ue(),ft(),Sa(),h(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const M=document.getElementById("sub-tab-trigger-my-reservations-tab");M&&typeof M.click=="function"&&setTimeout(()=>M.click(),0)}catch{}typeof Ht=="function"&&Ht({type:"created",reservation:A}),zs(A)}catch(A){console.error("âŒ [reservations/createForm] Failed to create reservation",A);const M=zn(A)?A.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");h(M,"error"),L&&(h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),ut({clearValue:!1}))}}function zs(e){if(!It)return;const{draftStorageKey:n=ea,returnUrl:t=ta}=It,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}It=null,t&&(window.location.href=t)}function ut({clearValue:e=!1}={}){const{input:n,hidden:t}=_e();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,je())}function Hs(e,n=""){const{input:t,hidden:a}=_e();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),je())}function Sa(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),we({selectedValue:"",resetInput:!0});try{He("res-start","res-start-time","")}catch{}try{He("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),ut({clearValue:!1}),ze({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",ge(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),Ga(),xt([]),ls("form-reset"),Se(),je(),O(),sa()}function Us(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",n=>{const t=n.target.closest("button[data-action]");if(!t)return;const{action:a,groupKey:r}=t.dataset;if(a==="decrease-group"&&r){Ns(r);return}if(a==="increase-group"&&r){Fs(r);return}if(a==="decrease-days-group"&&r){Gs(r);return}if(a==="increase-days-group"&&r){Os(r);return}if(a==="remove-group"&&r){Rs(r);return}}),e.dataset.listenerAttached="true")}function Ea(e){const n=(e?.items||[]).map(t=>{const a=t?.days,r=Number.parseFloat(S(String(a??"")));return Number.isFinite(r)&&r>0?Math.round(r):null}).filter(t=>t!=null);if(n.length){const t=Math.max(...n);return Math.min(365,Math.max(1,t))}try{const{start:t,end:a}=De(),r=pt(t,a);return Number.isFinite(r)&&r>0?r:1}catch{return 1}}function ka(e,n){const t=fe(),a=Math.min(365,Math.max(1,Math.round(Number(n)||1))),r=t.map(s=>tt(s)!==e||s?.type==="package"?s:{...s,days:a});xt(r)}function Os(e){const n=fe(),a=gt(n).find(s=>s.key===e);if(!a)return;const r=Ea(a);ka(e,r+1),Se(),O()}function Gs(e){const n=fe(),a=gt(n).find(i=>i.key===e);if(!a)return;const r=Ea(a),s=Math.max(1,r-1);ka(e,s),Se(),O()}function Ws(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(At()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,ya(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||At()!=="single")return;const{start:s,end:i}=De();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function Js(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await Cn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await Cn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),Sa();try{sa()}catch{}h(c("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function Mr({onAfterSubmit:e}={}){Ht=typeof e=="function"?e:null,at=!0;const{customers:n,projects:t}=ne();cs(n||[]),we(),un(),la(t||[]),ma({projectsList:t}),ln(),Ue(),_t(),xs(),ga(),Ia(),Vs(),Ms(),Us(),Ws(),Js(),ws(),Ls(),O(),Se();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Me()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}at=!1}function wa(){Ue(),_t(),ma(),we(),un(),ln(),ga(),Ia(),Se(),O()}if(typeof document<"u"){const e=()=>{we(),ze({projectsList:cn()}),un(),ln(),O()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Ue()}),document.addEventListener("packages:changed",()=>{_t(),At()==="package"&&Qt("package")})}typeof window<"u"&&(window.getCompanySharePercent=Ze);function bt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function Qs(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function Ks(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=Qs(t);if(a!==null)return a}return null}function xn(e,n=0){const t=Ks(e);if(t!=null)return t;const a=bt(e.createdAt??e.created_at);if(a!=null)return a;const r=bt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=bt(e.start);if(s!=null)return s;const i=bt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(n)?n:0}function Ys({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((v,w)=>({reservation:v,index:w})),i=n.searchTerm||"",o=n.searchReservationId||"",d=n.searchCustomerName||"",p=n.searchProjectId||"",l=n.startDate||"",m=n.endDate||"",f=n.status||"",u=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,y=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,g=l?new Date(`${l}T00:00:00`):null,I=m?new Date(`${m}T23:59:59`):null,k=s.filter(({reservation:v})=>{const w=t.get(String(v.customerId)),b=r?.get?.(String(v.projectId)),q=v.start?new Date(v.start):null,C=Hn(v),{effectiveConfirmed:j}=vt(v,b);if(u!=null&&String(v.customerId)!==String(u)||y!=null&&!(Array.isArray(v.technicians)?v.technicians.map(G=>String(G)):[]).includes(String(y))||f==="confirmed"&&!j||f==="pending"&&j||f==="completed"&&!C)return!1;if(f==="cancelled"){const F=String(v?.status||v?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(F))return!1}if(g&&q&&q<g||I&&q&&q>I)return!1;if(o){const F=[v.reservationId,v.id,v.reservation_id,v.reservationCode,v.reservation_code,v.code,v.reference,v.referenceNumber,v.reference_number],G=Ie(F.filter(x=>x!=null&&x!=="").map(String).join(" ")).replace(/\s+/g,""),N=o.replace(/\s+/g,"");if(!G.includes(N))return!1}if(d&&!Ie(w?.customerName||v.customerName||"").includes(d))return!1;if(p){const F=[v.projectId,v.project_id,v.projectID,b?.id,b?.projectCode,b?.project_code],G=Ie(F.filter(x=>x!=null&&x!=="").map(String).join(" ")).replace(/\s+/g,""),N=p.replace(/\s+/g,"");if(!G.includes(N))return!1}if(!i)return!0;const H=v.items?.map?.(F=>`${F.barcode} ${F.desc}`).join(" ")||"",J=(v.technicians||[]).map(F=>a.get(String(F))?.name).filter(Boolean).join(" ");return Ie([v.reservationId,w?.customerName||v.customerName,v.notes,H,J,b?.title].filter(Boolean).join(" ")).includes(i)});return k.sort((v,w)=>{const b=xn(v.reservation,v.index),q=xn(w.reservation,w.index);return b!==q?q-b:w.index-v.index}),k}function Xs({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=c("reservations.create.summary.currency","SR"),s=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),d=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),p=c("reservations.list.crew.separator","ØŒ "),l=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),m=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),f=c("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ"),u=c("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),y=c("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),g=c("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),I=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),k=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),v=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),w={client:c("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:b,index:q})=>{const C=n.get(String(b.customerId)),j=b.projectId?a?.get?.(String(b.projectId)):null,H=Hn(b),J=b.items?.length||0,ae=Array.isArray(b.crewAssignments)?b.crewAssignments:[],F=(b.technicians||[]).map(X=>t.get(String(X))).filter(Boolean),G=ae.length?ae.map(X=>{const qe=X.positionLabel??X.position_name??X.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),dt=X.technicianName??t.get(String(X.technicianId??""))?.name??null;return dt?`${S(qe)} (${S(dt)})`:S(qe)}):F.map(X=>X.name),N=G.length?G.join(p):"â€”",x=S(String(b.reservationId??"")),B=b.start?S(Mt(b.start)):"-",P=b.end?S(Mt(b.end)):"-",U=b.discount??b.discountValue??b.discount_value??b.discountAmount??0,_=Number.parseFloat(S(String(U))),L=Number.isFinite(_)?_:0,T=b.discountType??b.discount_type??b.discountMode??"percent",$=String(T).toLowerCase()==="amount"?"amount":"percent",Y=!!(b.applyTax??b.apply_tax??b.taxApplied),ie=b.companySharePercent??b.company_share_percent??b.companyShare??b.company_share,he=b.companyShareEnabled??b.company_share_enabled??b.companyShareApplied,Be=Number.parseFloat(S(String(ie))),nt=(he===!0||Number.isFinite(Be)&&Be>0)&&Number.isFinite(Be)?Be:0;let Pe=0;try{const X=Ja({items:b.items||[],technicianIds:b.technicians||[],crewAssignments:Array.isArray(b.crewAssignments)?b.crewAssignments:[],discount:L,discountType:$,applyTax:Y,start:b.start,end:b.end,companySharePercent:nt,groupingSource:b}),qe=Number(X?.finalTotal||0);Pe=Number.isFinite(qe)?Number(qe.toFixed(2)):0}catch{Pe=0}const Ee=Number.parseFloat(S(String(b.cost??0)))||0,Ge=Pe>0?Pe:Ee,de=b.paymentHistory||b.payment_history||[],A=kt({totalAmount:Ge,paidAmount:de.length?0:b.paidAmount,paidPercent:de.length?0:b.paidPercent,history:de});let K=wt({manualStatus:null,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:Ge});if(j)try{const{totalWithTax:X}=gs(j)||{totalWithTax:0},qe=j.paymentHistory||j.payments||[],dt=kt({totalAmount:X,paidAmount:qe.length?0:j.paidAmount,paidPercent:qe.length?0:j.paidPercent,history:qe}),vn=wt({manualStatus:null,paidAmount:dt.paidAmount,paidPercent:dt.paidPercent,totalAmount:X});vn&&(K=vn)}catch{}const Q=K==="paid",ue=K==="partial",{effectiveConfirmed:Z,projectLinked:me}=vt(b,j),pe=Z?"status-confirmed":"status-pending",Le=Q?"status-paid":ue?"status-partial":"status-unpaid";let Re=`<span class="reservation-chip status-chip ${pe}">${Z?l:m}</span>`;const E=Q?u:ue?g:y;let D=`<span class="reservation-chip status-chip ${Le}">${E}</span>`,V=Q?" tile-paid":ue?" tile-partial":" tile-unpaid";H&&(V+=" tile-completed");let z="";H&&(Re=`<span class="reservation-chip status-chip status-completed">${f}</span>`,D=`<span class="reservation-chip status-chip status-completed">${E}</span>`,z=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…Ù†ØªÙ‡ÙŠ").replace(/\"/g,"&quot;")}"`);let ee=!me&&!Z?`<button class="tile-confirm" data-reservation-index="${q}" data-action="confirm">${I}</button>`:"";const re=ee?`<div class="tile-actions">${ee}</div>`:"",oe=S(Ge.toFixed(2)),W=S(String(J)),le=b.notes?S(b.notes):o,We=d.replace("{count}",W),te=b.applyTax?`<small>${s}</small>`:"";let ct=k;return b.projectId&&(ct=j?.title?S(j.title):v),`
      <div class="${ee?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${V}"${z} data-reservation-index="${q}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${x}</div>
          <div class="tile-badges">
            ${Re}
            ${D}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${w.client}</span>
            <span class="tile-value">${C?.customerName||b.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.project}</span>
            <span class="tile-value">${ct}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.start}</span>
            <span class="tile-value tile-inline">${B}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.end}</span>
            <span class="tile-value tile-inline">${P}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.cost}</span>
            <span class="tile-value">${oe} ${r} ${te}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.equipment}</span>
            <span class="tile-value">${We}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${w.crew}</span>
            <span class="tile-value">${G.length?N:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${le}</span>
          </div>
        </div>
        ${re}
      </div>
    `}).join("")}function Zs({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a}={}){const r=ft(),{reservations:s=[],customers:i=[],technicians:o=[],projects:d=[]}=ne(),p=s.map(v=>{const w=Vt(v);return{...w,id:v.id??w.id,reservationId:v.reservationId??v.reservation_id??w.reservationId,reservationCode:v.reservationCode??v.reservation_code??w.reservationCode}}),l=p,m=Array.isArray(r)?r:o||[],f=new Map((d||[]).map(v=>[String(v.id),v])),u=document.getElementById(e);if(!u){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!l||l.length===0){u.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const y=n||ps(),g=new Map(i.map(v=>[String(v.id),v])),I=new Map(m.map(v=>[String(v.id),v])),k=Ys({reservations:p,filters:y,customersMap:g,techniciansMap:I,projectsMap:f});if(k.length===0){u.innerHTML=`<p>${c("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}u.innerHTML=`<div class="reservations-grid">${Xs({entries:k,customersMap:g,techniciansMap:I,projectsMap:f})}</div>`,u.querySelectorAll('[data-action="details"]').forEach(v=>{const w=Number(v.dataset.reservationIndex);Number.isNaN(w)||v.addEventListener("click",()=>{typeof t=="function"&&t(w)})}),u.querySelectorAll('button[data-action="confirm"]').forEach(v=>{const w=Number(v.dataset.reservationIndex);Number.isNaN(w)||v.addEventListener("click",b=>{b.stopPropagation(),typeof a=="function"&&a(w,b)})})}function er(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=ne(),o=r.map(g=>{const I=Vt(g);return{...I,id:g.id??I.id,reservationId:g.reservationId??g.reservation_id??I.reservationId,reservationCode:g.reservationCode??g.reservation_code??I.reservationCode}}),d=r[e];if(!d)return h(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const p=o[e]??Vt(d),l=s.find(g=>String(g.id)===String(d.customerId)),m=d.projectId?i.find(g=>String(g.id)===String(d.projectId)):null,f=document.getElementById("reservation-details-body"),u=document.getElementById("reservationDetailsModal"),y=()=>{const g=()=>{u&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(u)?.hide()},I=document.getElementById("reservation-details-edit-btn");I&&(I.onclick=()=>{g(),typeof n=="function"&&n(e,{reservation:d,customer:l,getEditContext:a})});const k=document.getElementById("reservation-details-delete-btn");k&&(k.onclick=()=>{g(),typeof t=="function"&&t(e,{reservation:d,customer:l})});const v=f?.querySelector('[data-action="open-project"]');v&&m&&v.addEventListener("click",()=>{g();const q=m?.id!=null?String(m.id):"",C=q?`projects.html?project=${encodeURIComponent(q)}`:"projects.html";window.location.href=C});const w=document.getElementById("reservation-details-export-btn");w&&(w.onclick=async q=>{q?.preventDefault?.(),q?.stopPropagation?.(),w.blur();try{await fs({reservation:d,customer:l,project:m})}catch(C){console.error("âŒ [reservations] export to PDF failed",C),h(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const b=document.getElementById("reservation-details-checklist-btn");b&&(b.onclick=async q=>{q?.preventDefault?.(),q?.stopPropagation?.(),b.blur();try{await ys({reservation:d,customer:l,project:m})}catch(C){console.error("âŒ [reservations] export checklist PDF failed",C),h(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const q=f?.querySelector("[data-tech-slider]");if(q){const C=q.querySelector("[data-slider-track]"),j=q.querySelector("[data-slider-prev]"),H=q.querySelector("[data-slider-next]");if(C&&(j||H)){const J=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",ae=()=>{const N=C.querySelector(".reservation-technician-card"),x=N&&N.getBoundingClientRect().width||220,B=12,P=Math.max(1,Math.floor(C.clientWidth/(x+B)));return Math.max(x+B,Math.floor(P*(x+B)*.9))},F=()=>{const N=Math.max(0,C.scrollWidth-C.clientWidth-2),x=C.scrollLeft<=1,B=C.scrollLeft>=N;j&&(j.disabled=x),H&&(H.disabled=B)},G=N=>{const x=ae()*N,B=J?-x:x;C.scrollBy({left:B,behavior:"smooth"})};j?.addEventListener("click",()=>G(-1)),H?.addEventListener("click",()=>G(1)),C.addEventListener("scroll",F,{passive:!0}),window.addEventListener("resize",F,{passive:!0}),setTimeout(F,0)}}}catch{}};if(f){const g=ft()||[];f.innerHTML=hn(p,l,g,e,m),y(),Xn().then(()=>{const I=ft()||[];f.innerHTML=hn(p,l,I,e,m),y()}).catch(()=>{})}return u&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(u).show(),!0}function Oe(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:Ke(e,t),end:Ke(n,a)}}function $t(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function pn(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Aa(){const{container:e,select:n,hint:t,addButton:a}=pn();if(!n)return;const r=n.value,s=On(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,d=s.map(l=>{const m=Number.isFinite(Number(l.price))?Number(l.price):0,f=S(m.toFixed(2)),u=`${l.name} â€” ${f} ${i}`;return`<option value="${$t(l.id)}">${$t(u)}</option>`}).join("");n.innerHTML=`${o}${d}`;const p=s.length>0;n.disabled=!p,a&&(a.disabled=!p),e&&(e.hidden=!p,e.setAttribute("aria-hidden",p?"false":"true")),t&&(p?(t.textContent=c("reservations.create.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),p&&r&&s.some(l=>l.id===r)?n.value=r:n.selectedIndex=0}function tr(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||h(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=ve(),{start:s,end:i}=Oe(),{reservations:o=[]}=ne(),d=a!=null&&o[a]||null,p=d?.id??d?.reservationId??null,l=va(t,{existingItems:r,start:s,end:i,ignoreReservationId:p});if(!l.success)return n||h(l.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),l;const m=[...r,l.package];return Ne(a,m),xe(m),ye(),n||h(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),l}function jn(){const{select:e}=pn();if(!e)return;const n=e.value||"";tr(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function nr(){const{addButton:e,select:n}=pn();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{jn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),jn())}),n.dataset.listenerAttached="true"),Aa()}function xe(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.increaseDays","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£ÙŠØ§Ù…"),d=c("reservations.equipment.actions.decreaseDays","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£ÙŠØ§Ù…"),p=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="6" class="text-center">${t}</td></tr>`,_n(n);return}const{groups:l}=ot({items:e});n.innerHTML=l.map(m=>{const f=m.items[0]||{},u=it(f)||m.image,y=u?`<img src="${u}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',g=String(m?.type||"").toLowerCase()==="package"||m.items.some(P=>P?.type==="package"),I=S(String(m.count)),k=Sn(m.unitPrice),v=Number.isFinite(k)?En(k):0,w=(()=>{const P=(m?.items||[]).map(U=>{const _=U?.days,L=Number.parseFloat(S(String(_??"")));return Number.isFinite(L)&&L>0?Math.round(L):null}).filter(U=>U!=null);if(P.length){const U=Math.max(...P);return Math.min(365,Math.max(1,U))}try{const{start:U,end:_}=Oe(),L=typeof pt=="function"?pt(U,_):1;return Number.isFinite(L)&&L>0?L:1}catch{return 1}})(),b=Sn(m.totalPrice),q=Number.isFinite(b)?b:v*(Number.isFinite(m.count)?m.count:1)*w,C=En(q),j=`${S(v.toFixed(2))} ${a}`,H=`${S(C.toFixed(2))} ${a}`,J=m.barcodes.map(P=>S(String(P||""))).filter(Boolean),ae=J.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${J.map(P=>`<li>${P}</li>`).join("")}
            </ul>
          </details>`:"";let F="";if(g){const P=new Map,U=L=>{const T=Number.parseFloat(S(String(L??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(T)||T<=0||T>99?1:Math.round(T)},_=[];if(Array.isArray(m.packageItems)&&m.packageItems.length&&_.push(...m.packageItems),m.items.forEach(L=>{Array.isArray(L?.packageItems)&&_.push(...L.packageItems)}),_.forEach(L=>{if(!L)return;const T=R(L.barcode||L.normalizedBarcode||L.desc||Math.random());if(!T)return;const $=P.get(T),Y=U(L.qtyPerPackage??L.perPackageQty??L.quantityPerPackage??L.qty??L.quantity??1),ie=Math.max(1,Math.min(Y,99));if($){$.qty=ie;return}P.set(T,{desc:L.desc||L.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:ie,barcode:L.barcode??L.normalizedBarcode??""})}),P.size){const L=Array.from(P.values()).map(T=>{const $=S(String(T.qty>0?Math.min(T.qty,99):1)),Y=$t(T.desc||""),ie=T.barcode?` <span class="reservation-package-items__barcode">(${$t(S(String(T.barcode)))})</span>`:"";return`<li>${Y}${ie} Ã— ${$}</li>`}).join("");F=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${L}
              </ul>
            </details>
          `}}const G=g?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",N=g?' disabled aria-disabled="true" tabindex="-1"':"",x=g?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",B=g?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${m.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${y}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${m.description||"-"}</div>
                ${g?`${F||""}${ae||""}`:ae}
              </div>
            </div>
          </td>
          <td>
            <div class="${G}" data-group-key="${m.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${m.key}" aria-label="${i}"${N}>âˆ’</button>
              <span class="reservation-qty-value">${I}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${m.key}" aria-label="${s}"${N}>+</button>
            </div>
          </td>
          <td>
            <div class="${x}" data-group-key="${m.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-days-group" data-group-key="${m.key}" aria-label="${d}"${B}>âˆ’</button>
              <span class="reservation-qty-value">${S(String(w))}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-days-group" data-group-key="${m.key}" aria-label="${o}"${B}>+</button>
            </div>
          </td>
          <td>${j}</td>
          <td>${H}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${m.key}" aria-label="${p}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),_n(n)}function ar(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Dt(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Nt();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(ne()?.projects||[]).find(d=>String(d.id)===String(t)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(n=o)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Tn();return}const a=c("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const o=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${S(Number(s.amount).toFixed(2))} ${a}`:"â€”",d=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${S(Number(s.percentage).toFixed(2))}%`:"â€”",p=s?.recordedAt?S(Mt(s.recordedAt)):"â€”",l=ar(s?.type),m=s?.note?S(s.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${p}</td>
        <td>${m}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Tn()}function sr(){if(yt()){h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=$a(e);let a=Ca(n);if(!Number.isFinite(a)||a<=0){h(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=zt.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,o=Number(r?.paidAmount)||0,d=c("reservations.create.summary.currency","SR");let p=null,l=null;if(t==="percent"){const f=Math.max(0,100-i);if(f<=1e-4){h(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const u=Math.min(a,f);if(u!==a){const y=S(u.toFixed(2));h(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",y)),a=u}l=Number(a.toFixed(2)),s>0&&(p=a/100*s)}else{const f=Math.max(0,s-o);if(f<=1e-4){h(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const u=Math.min(a,f);if(u!==a){const y=`${S(u.toFixed(2))} ${d}`;h(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",y)),a=u}p=Number(a.toFixed(2)),s>0&&(l=p/s*100)}p!=null&&(p=Number(p.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const m={type:t,value:a,amount:p,percentage:l,recordedAt:new Date().toISOString()};br(m),fn(Nt()),Dt(),ye(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),h(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Tn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(yt()){t.preventDefault(),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}sr()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(yt()){t.preventDefault(),h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(Ir(r),fn(Nt()),Dt(),ye(),h(c("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function rr(e){const{index:n,items:t}=ve(),{groups:a}=ot({items:t}),r=a.find(o=>o.key===e);if(!r||r.items.some(o=>o?.type==="package"))return;let s=-1;for(let o=t.length-1;o>=0;o-=1){const d=t[o];if(tt(d)===e&&d?.type!=="package"){s=o;break}}if(s<0)return;const i=t.filter((o,d)=>d!==s);Ne(n,i),xe(i),ye()}function ir(e){const{index:n,items:t}=ve(),{groups:a}=ot({items:t}),r=a.find(o=>o.key===e);if(!r)return;let s=t.filter(o=>tt(o)!==e);if(r.items.some(o=>o&&o.type==="package")){const o=Ye(r.packageId??r.items.find(m=>m?.type==="package")?.packageId??""),d=R(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(m=>{if(!m||typeof m!="object"||m.type!=="package")return!0;const f=Ye(m.packageId??m.package_id??m.id??""),u=R(m.barcode??m.package_code??"");return!(o&&f===o||d&&u&&u===d)});const p=new Set,l=new Set;r.items.forEach(m=>{(Array.isArray(m?.packageItems)?m.packageItems:[]).forEach(u=>{const y=R(u?.barcode||u?.normalizedBarcode||"");y&&p.add(y);const g=u?.equipmentId??u?.equipment_id??null;g!=null&&l.add(String(g))})}),(p.size||l.size)&&(s=s.filter(m=>{const f=R(m?.barcode||""),u=m?.equipmentId??m?.id??null;return!(f&&p.has(f)||u!=null&&l.has(String(u)))}))}s.length!==t.length&&(Ne(n,s),xe(s),ye())}function or(e){const{index:n,items:t}=ve(),{groups:a}=ot({items:t}),r=a.find(I=>I.key===e);if(!r||r.items.some(I=>I?.type==="package"))return;const{start:s,end:i}=Oe();if(!s||!i){h(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=ne(),d=n!=null&&o[n]||null,p=d?.id??d?.reservationId??null,l=new Set(t.map(I=>R(I.barcode))),{equipment:m=[]}=ne(),f=(m||[]).find(I=>{const k=R(I?.barcode);return!k||l.has(k)||tt({desc:I?.desc||I?.description||I?.name||"",price:Number(I?.price)||0})!==e||!Fn(I)?!1:!Te(k,s,i,p)});if(!f){h(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=R(f.barcode),y=et(f);if(!y){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=[...t,{id:y,equipmentId:y,barcode:u,desc:f.desc||f.description||f.name||r.description||"",qty:1,price:Number.isFinite(Number(f.price))?Number(f.price):r.unitPrice,image:it(f)}];Ne(n,g),xe(g),ye()}function Ba(e){const n=(e?.items||[]).map(t=>{const a=t?.days,r=Number.parseFloat(S(String(a??"")));return Number.isFinite(r)&&r>0?Math.round(r):null}).filter(t=>t!=null);if(n.length){const t=Math.max(...n);return Math.min(365,Math.max(1,t))}try{const{start:t,end:a}=Oe(),r=pt(t,a);return Number.isFinite(r)&&r>0?r:1}catch{return 1}}function Pa(e,n){const{index:t,items:a}=ve(),r=Math.min(365,Math.max(1,Math.round(Number(n)||1))),s=a.map(i=>tt(i)!==e||i?.type==="package"?i:{...i,days:r});Ne(t,s)}function cr(e){const{items:n}=ve(),{groups:t}=ot({items:n}),a=t.find(s=>s.key===e);if(!a)return;const r=Ba(a);Pa(e,r+1),xe(ve().items),ye()}function dr(e){const{items:n}=ve(),{groups:t}=ot({items:n}),a=t.find(s=>s.key===e);if(!a)return;const r=Ba(a);Pa(e,Math.max(1,r-1)),xe(ve().items),ye()}function _n(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",n=>{const t=n.target.closest("button[data-action]");if(!t)return;const{action:a,groupKey:r,itemIndex:s}=t.dataset;if(a==="decrease-edit-group"&&r){rr(r);return}if(a==="increase-edit-group"&&r){or(r);return}if(a==="decrease-edit-days-group"&&r){dr(r);return}if(a==="increase-edit-days-group"&&r){cr(r);return}if(a==="remove-edit-group"&&r){ir(r);return}if(a==="remove-edit-item"){const i=Number(s);Number.isNaN(i)||mr(i)}}),e.dataset.groupListenerAttached="true")}function yt(){return!!document.getElementById("edit-res-project")?.value}function lr(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{yt()&&(h(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function ur(e){const n=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,o,d].forEach(lr),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const p=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(p)try{const f=(ne()?.projects||[]).find(y=>String(y.id)===String(p)),u=typeof f?.paymentStatus=="string"?f.paymentStatus.toLowerCase():null;u&&["paid","partial","unpaid"].includes(u)&&(l=u)}catch{}r.value=l,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=n),d&&(d.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function ye(){const e=document.getElementById("edit-res-summary");if(!e)return;Dt();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),ge(a),ye()}),a.dataset.listenerAttached="true");const r=S(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",o=yt();ur(o);const d=document.getElementById("edit-res-tax"),p=o?!1:d?.checked||!1,l=!o&&a?.dataset?.userSelected==="true";let m="unpaid";if(o){const w=document.getElementById("edit-res-project")?.value||"";if(w)try{const q=(ne()?.projects||[]).find(j=>String(j.id)===String(w)),C=typeof q?.paymentStatus=="string"?q.paymentStatus.toLowerCase():null;C&&["paid","partial","unpaid"].includes(C)&&(m=C)}catch{}}else m=l&&a?.value||"unpaid";let f=null;!o&&p&&(Ae("edit-res-company-share"),f=Ze("edit-res-company-share"),(!Number.isFinite(f)||f<=0)&&(Ae("edit-res-company-share"),f=Ze("edit-res-company-share")));const{items:u=[],payments:y=[]}=ve(),{start:g,end:I}=Oe(),k=zt({items:u,discount:s,discountType:i,applyTax:p,paidStatus:m,start:g,end:I,companySharePercent:f,paymentHistory:y});e.innerHTML=k;const v=zt.lastResult;if(v&&a){const w=v.paymentStatus;l?ge(a,a.value):(a.value!==w&&(a.value=w),a.dataset&&delete a.dataset.userSelected,ge(a,w))}else a&&ge(a,a.value)}function mr(e){if(e==null)return;const{index:n,items:t}=ve();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);Ne(n,a),xe(a),ye()}async function pr(e){const n=e?.value??"",t=R(n);if(!t)return;const a=en(t);if(!a){h(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Ve(a);if(r==="maintenance"||r==="retired"){h(Xe(r));return}const s=R(t),{index:i,items:o=[]}=ve();if(o.findIndex(I=>R(I.barcode)===s)>-1){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:p,end:l}=Oe();if(!p||!l){h(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:m=[]}=ne(),f=i!=null&&m[i]||null,u=f?.id??f?.reservationId??null;if(Te(s,p,l,u)){try{const I=new URLSearchParams({type:"equipment",id:s,start:p,end:l});u!=null&&I.set("ignore",String(u));const k=await $e(`/reservations/availability.php?${I.toString()}`),v=Array.isArray(k?.conflicts)?k.conflicts:[],w=Array.from(new Set(v.map(q=>q?.reservation_code||(q?.reservation_id!=null?`#${q.reservation_id}`:null)).filter(Boolean))),b=w.length?`: ${w.join("ØŒ ")}`:"";h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+b,"warning",6e3)}catch{h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const y=et(a);if(!y){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const g=[...o,{id:y,equipmentId:y,barcode:s,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];Ne(i,g),e&&(e.value=""),xe(g),ye()}async function Ct(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=pa(n),a=R(t?.barcode||n);if(!t||!a){h(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Ve(t);if(r==="maintenance"||r==="retired"){h(Xe(r));return}const{start:s,end:i}=Oe();if(!s||!i){h(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:d=[]}=ve();if(d.some(g=>R(g.barcode)===a)){h(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:l=[]}=ne(),m=o!=null&&l[o]||null,f=m?.id??m?.reservationId??null;if(Te(a,s,i,f)){try{const g=new URLSearchParams({type:"equipment",id:a,start:s,end:i});f!=null&&g.set("ignore",String(f));const I=await $e(`/reservations/availability.php?${g.toString()}`),k=Array.isArray(I?.conflicts)?I.conflicts:[],v=Array.from(new Set(k.map(b=>b?.reservation_code||(b?.reservation_id!=null?`#${b.reservation_id}`:null)).filter(Boolean))),w=v.length?`: ${v.join("ØŒ ")}`:"";h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©")+w,"warning",6e3)}catch{h(c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),"warning",6e3)}return}const u=et(t);if(!u){h(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const y=[...d,{id:u,equipmentId:u,barcode:a,desc:t.desc,qty:1,price:t.price,image:t.image||t.imageUrl||t.img||null}];Ne(o,y),xe(y),ye(),e.value=""}function La(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Ct(e))});const n=()=>{fa(e.value,"edit-res-equipment-description-options")&&Ct(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{ye()});const e=()=>{nr()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Aa()})}typeof window<"u"&&(window.getEditReservationDateRange=Oe,window.renderEditPaymentHistory=Dt);function fr(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){Jt(e);return}Ct(e)}}function Vr(){Ue(),La()}function yr(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let st=null,ke=[],Ce=[],Kt=null,ce={},Ft=!1,Dn=!1;function gr(){if(!Dn)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{Ta(ce).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Dn=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const vr="__DEBUG_CREW__";function hr(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(vr);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Nn(e,n){if(hr())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function mt(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=a.dataset.confirmLabel||"âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯",o=a.dataset.pendingLabel||"â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯";a.innerHTML=s?i:o,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function St(){return document.getElementById("edit-res-confirmed")?.value==="true"}function ve(){return{index:st,items:ke,payments:Ce}}function Ne(e,n,t=Ce){st=typeof e=="number"?e:null,ke=Array.isArray(n)?[...n]:[],Ce=Array.isArray(t)?[...t]:[]}function qa(){st=null,ke=[],es(),Ce=[]}function Nt(){return[...Ce]}function fn(e){Ce=Array.isArray(e)?[...e]:[]}function br(e){e&&(Ce=[...Ce,e])}function Ir(e){!Number.isInteger(e)||e<0||(Ce=Ce.filter((n,t)=>t!==e))}function Et(e,n=1){const t=Number.parseFloat(S(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function Yt(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(S(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function Sr(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?R(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:Et(e.qty??e.quantity??e.count??1),price:Yt(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function Er(e,n=0){if(!e||typeof e!="object")return null;const t=Ye(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:sn(e)).map(f=>Sr(f)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=Yt(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const f=Yt(i,0);f>0&&a>0&&(o=Number((f/a).toFixed(2)))}const d=e.package_code??e.packageCode??e.barcode??null,l=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,d,t].find(f=>f!=null&&String(f).trim()!=="")||`Package ${t}`,m=e.image??e.cover??e.thumbnail??s.find(f=>f?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:S(String(l)),name:S(String(l)),qty:a,price:o,barcode:d,packageItems:s,image:m}}function kr(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function wr(e={},n=[]){const t=Array.isArray(n)?n.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return t;const r=a.map((o,d)=>Er(o,d)).filter(Boolean);if(!r.length)return t;const s=new Map;r.forEach(o=>{const d=Et(o.qty??o.quantity??1);if(o.barcode){const p=R(o.barcode);if(p){const l=`package::${p}`;s.set(l,(s.get(l)??0)+d)}}(o.packageItems||[]).forEach(p=>{if(!p)return;const l=d*Et(p.qty??p.quantity??1),m=p.equipmentId??null,f=p.normalizedBarcode||(p.barcode?R(p.barcode):null);if(m!=null){const u=`equipment::${String(m)}`;s.set(u,(s.get(u)??0)+l)}if(f){const u=`barcode::${f}`;s.set(u,(s.get(u)??0)+l)}})});const i=[];return t.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const I=Ye(o.packageId??o.package_id??o.id??"");r.some(v=>v.packageId===I)||i.push({...o});return}const d=Et(o.qty??o.quantity??1),p=et(o),l=o.barcode?R(o.barcode):null,m=[];p!=null&&m.push(`equipment::${String(p)}`),l&&m.push(`barcode::${l}`);const f=m.map(I=>s.get(I)??0).filter(I=>I>0);if(!f.length){i.push({...o});return}const u=Math.min(...f);if(u<=0){i.push({...o});return}const y=Math.min(u,d);if(kr(s,m,y),y>=d)return;const g=d-y;i.push({...o,qty:g,quantity:g})}),[...i,...r.map(o=>({...o}))]}function Ar(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function $a(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function Ca(e){if(!e)return null;const n=S(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function Br(e,n){if(e){e.value="";return}}function lt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function xa(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(S(String(e.value??""))),a=Number.parseFloat(S(String(e.amount??""))),r=Number.parseFloat(S(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,o=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?s??null:o==="percent"?i??null:Number.isFinite(t)?t:null,p=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:p}}function Pr(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((d,p)=>String(p.createdAt||p.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${lt(a)}</option>`];i.forEach(d=>{o.push(`<option value="${lt(d.id)}">${lt(d.title||a)}</option>`)}),s&&!i.some(d=>String(d.id)===s)&&o.push(`<option value="${lt(s)}">${lt(r)}</option>`),t.innerHTML=o.join(""),s?t.value=s:t.value=""}function ja(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const d=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",d&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}Xt("tax");const o=ce?.updateEditReservationSummary;typeof o=="function"&&o()}function Xt(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=ce?.updateEditReservationSummary;typeof s=="function"&&s()};if(Ft){a();return}Ft=!0;const r=()=>{Ft=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(Qe)),n.disabled){t.checked=!1,h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),Ae("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?Ae("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function Rn(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:o,projects:d}=ne(),l=Un()?.[e];if(!l){h(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}ce={...ce,reservation:l,projects:d||[]},n?.(),Pr(d||[],l);const m=l.projectId&&d?.find?.($=>String($.id)===String(l.projectId))||null,{effectiveConfirmed:f,projectLinked:u}=vt(l,m),y=l.items?l.items.map($=>({...$,equipmentId:$.equipmentId??$.equipment_id??$.id,barcode:R($?.barcode)})):[],g=wr(l,y),k=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map($=>xa($)).filter(Boolean);Ne(e,g,k);const v=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),w=o?.find?.($=>String($.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const b=document.getElementById("edit-res-id");b&&(b.value=l.reservationId||l.id);const q=document.getElementById("edit-res-customer");q&&(q.value=w?.customerName||v);const C=typeof a=="function"?a(l.start):{date:"",time:""},j=typeof a=="function"?a(l.end):{date:"",time:""};t?.("edit-res-start",C.date),t?.("edit-res-start-time",C.time),t?.("edit-res-end",j.date),t?.("edit-res-end-time",j.time);const H=document.getElementById("edit-res-notes");H&&(H.value=l.notes||"");const J=document.getElementById("edit-res-discount");if(J){const $=u?0:l.discount??0;J.value=S($)}const ae=document.getElementById("edit-res-discount-type");ae&&(ae.value=u?"percent":l.discountType||"percent");const F=l.projectId?!1:!!l.applyTax,G=document.getElementById("edit-res-tax");G&&(G.checked=F);const N=document.getElementById("edit-res-company-share");if(N){const $=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,Y=$!=null?Number.parseFloat(S(String($).replace("%","").trim())):NaN,ie=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,he=ie!=null?ie===!0||ie===1||ie==="1"||String(ie).toLowerCase()==="true":Number.isFinite(Y)&&Y>0,Be=he&&Number.isFinite(Y)&&Y>0?Y:Qe,se=F||he;N.checked=se,N.dataset.companyShare=String(Be)}mt(f,{disable:u});const x=document.getElementById("edit-res-paid"),B=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");x&&(x.value=B,x.dataset&&delete x.dataset.userSelected);const P=document.getElementById("edit-res-payment-progress-type"),U=document.getElementById("edit-res-payment-progress-value");P?.dataset?.userSelected&&delete P.dataset.userSelected,P&&(P.value="percent"),Br(U);const _=document.getElementById("edit-res-cancelled");if(_){const $=String(l?.status||l?.reservationStatus||"").toLowerCase();_.checked=["cancelled","canceled"].includes($),_.checked&&mt(f,{disable:!0})}let L=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map($=>String($));if(!Array.isArray(L)||L.length===0){const $=Qa(l.id??l.reservationId??l.reservation_code??null);Array.isArray($)&&$.length&&(L=$)}try{await Xn()}catch($){console.warn("[reservationsEdit] positions load failed (non-fatal)",$)}if(Ka(L),r?.(g),typeof window<"u"){const $=window?.renderEditPaymentHistory;typeof $=="function"&&$()}ja(),s?.();const T=document.getElementById("editReservationModal");Kt=Ar(T,i),Kt?.show?.();try{Lr?.(ce)}catch($){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",$)}gr()}async function Ta({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(st===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),p=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),m=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",f=document.getElementById("edit-res-notes")?.value||"",u=S(document.getElementById("edit-res-discount")?.value||"0");let y=parseFloat(u)||0,g=document.getElementById("edit-res-discount-type")?.value||"percent";const I=St(),k=document.getElementById("edit-res-paid"),v=k?.dataset?.userSelected==="true",w=v&&k?.value||"unpaid",b=document.getElementById("edit-res-payment-progress-type"),q=document.getElementById("edit-res-payment-progress-value"),C=$a(b),j=Ca(q),H=document.getElementById("edit-res-project")?.value||"",ae=document.getElementById("edit-res-cancelled")?.checked===!0,F=Ya();F.map(E=>E?.technicianId).filter(Boolean);const G=document.getElementById("edit-res-company-share"),N=document.getElementById("edit-res-tax");if(!d||!l){h(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const x=typeof e=="function"?e:(E,D)=>`${E}T${D||"00:00"}`,B=x(d,p),P=x(l,m);if(B&&P&&new Date(B)>new Date(P)){h(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const _=Un()?.[st];if(!_){h(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(ke)||ke.length===0&&F.length===0){h(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const L=typeof n=="function"?n:()=>!1,T=_.id??_.reservationId;for(const E of ke){if(E?.type==="package"&&Array.isArray(E.packageItems)){for(const V of E.packageItems){const z=V?.barcode??V?.normalizedBarcode??"";if(!z)continue;const ee=Ve(z);if(ee!=="reserved"&&ee!=="available"){h(Xe(ee));return}}continue}const D=Ve(E.barcode);if(D!=="reserved"&&D!=="available"){h(Xe(D));return}}{const E=typeof t=="function"?t:()=>!1;for(const D of ke){if(D?.type!=="package")continue;const V=D.packageId??D.package_id??null,z=D.desc||D.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(V&&E(V,B,P,T)){const ee=Array.isArray(D?.packageItems)?D.packageItems.map(W=>R(W?.barcode??W?.normalizedBarcode??"")).filter(Boolean):[];let re=kn(ee,B,P,T);if(!re.length)try{const W=new URLSearchParams;W.set("type","package"),W.set("id",String(V)),W.set("start",B),W.set("end",P),T!=null&&W.set("ignore",String(T));const le=await $e(`/reservations/availability.php?${W.toString()}`),We=Array.isArray(le?.conflicts)?le.conflicts:[];re=Array.from(new Set(We.map(te=>te?.reservation_code||(te?.reservation_id!=null?`#${te.reservation_id}`:null)).filter(Boolean)))}catch{}const oe=re.length?` (${re.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(z))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+oe,"warning",-1);return}if(Array.isArray(D?.packageItems)&&D.packageItems.length){const ee=(D.packageItems||[]).map(W=>R(W?.barcode??W?.normalizedBarcode??"")).filter(Boolean),re=ee.length,oe=ee.filter(W=>L(W,B,P,T)).length;if(re>0&&oe>=re){const W=(D.packageItems||[]).map(te=>R(te?.barcode??te?.normalizedBarcode??"")).filter(Boolean);let le=kn(W,B,P,T);if(!le.length)try{const te=new URLSearchParams;te.set("type","package"),V!=null&&te.set("id",String(V)),te.set("start",B),te.set("end",P),T!=null&&te.set("ignore",String(T));const ct=await $e(`/reservations/availability.php?${te.toString()}`),gn=Array.isArray(ct?.conflicts)?ct.conflicts:[];le=Array.from(new Set(gn.map(X=>X?.reservation_code||(X?.reservation_id!=null?`#${X.reservation_id}`:null)).filter(Boolean)))}catch{}const We=le.length?` (${le.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(z))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+We,"warning",6e3);return}}}}const $=[];for(const E of ke){if(E?.type==="package"&&Array.isArray(E.packageItems)){for(const V of E.packageItems){const z=R(V?.barcode??V?.normalizedBarcode??"");if(z&&L(z,B,P,T)){const ee=V?.desc||V?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");$.push({label:S(String(ee)),barcode:z})}}continue}const D=R(E.barcode);if(L(D,B,P,T)){const V=E?.desc||E?.name||E?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");$.push({label:S(String(V)),barcode:D})}}if($.length){const E=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let D=null;try{const z=Array.from(new Set($.map(re=>re.barcode).filter(Boolean))),ee=new Map;await Promise.all(z.map(async re=>{const oe=new URLSearchParams;oe.set("type","equipment"),oe.set("id",re),oe.set("start",B),oe.set("end",P),T!=null&&oe.set("ignore",String(T));const W=await $e(`/reservations/availability.php?${oe.toString()}`),le=Array.isArray(W?.conflicts)?W.conflicts:[],We=Array.from(new Set(le.map(te=>te?.reservation_code||(te?.reservation_id!=null?`#${te.reservation_id}`:null)).filter(Boolean)));ee.set(re,We)})),D=$.map(({label:re,barcode:oe})=>{const W=ee.get(oe)||[];return W.length?`${re} (${W.join("ØŒ ")})`:re}).join("ØŒ ")}catch{}const V=D||$.map(z=>z.label).filter(Boolean).map(String).join("ØŒ ");h(`${E}: ${V}`,"warning",6e3);return}const Y=typeof t=="function"?t:()=>!1;for(const E of ke){if(E?.type!=="package")continue;const D=E.packageId??E.package_id??null;if(D&&Y(D,B,P,T)){const V=E.desc||E.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const z=new URLSearchParams;z.set("type","package"),z.set("id",String(D)),z.set("start",B),z.set("end",P),T!=null&&z.set("ignore",String(T));const ee=await $e(`/reservations/availability.php?${z.toString()}`),re=Array.isArray(ee?.conflicts)?ee.conflicts:[],oe=Array.from(new Set(re.map(le=>le?.reservation_code||(le?.reservation_id!=null?`#${le.reservation_id}`:null)).filter(Boolean))),W=oe.length?` (${oe.join("ØŒ ")})`:"";h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(V))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+W,"warning",6e3)}catch{h(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${S(String(V))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const ie=typeof a=="function"?a:()=>!1,he=[];for(const E of F){if(!E?.technicianId||!ie(E.technicianId,B,P,T))continue;const D=E?.technicianName||E?.positionLabel||String(E.technicianId);let V=[];try{V=Qn(E.technicianId,B,P,T)}catch{}he.push({label:S(String(D)),codes:V})}if(he.length){const E=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),D=he.map(({label:V,codes:z})=>z&&z.length?`${V} (${z.join("ØŒ ")})`:V).join("ØŒ ");h(`${E}: ${D}`,"warning",6e3);return}const Be=Array.isArray(ce.projects)&&ce.projects.length?ce.projects:ne().projects||[],se=H&&Be.find(E=>String(E.id)===String(H))||null,nt={..._,projectId:H?String(H):null,confirmed:I},{effectiveConfirmed:Pe,projectLinked:Ee,projectStatus:Ge}=vt(nt,se);let de=!!G?.checked,A=!!N?.checked;if(Ee&&(de&&(G.checked=!1,de=!1),A=!1),!Ee&&de!==A){h(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}A&&(Ae("edit-res-company-share"),de=!!G?.checked);let M=de?getCompanySharePercent("edit-res-company-share"):null;de&&(!Number.isFinite(M)||M<=0)&&(Ae("edit-res-company-share"),M=getCompanySharePercent("edit-res-company-share"));const K=de&&A&&Number.isFinite(M)&&M>0,Q=Ee?!1:A;Ee&&(y=0,g="percent");const ue=Mn(ke,y,g,Q,F,{start:B,end:P,companySharePercent:K?M:0});let Z=Nt();if(Number.isFinite(j)&&j>0){const E=ue;let D=null,V=null;C==="amount"?(D=j,E>0&&(V=j/E*100)):(V=j,E>0&&(D=j/100*E));const z=xa({type:C,value:j,amount:D,percentage:V,recordedAt:new Date().toISOString()});z&&(Z=[...Z,z],fn(Z)),q&&(q.value="")}const me=kt({totalAmount:ue,history:Z}),pe=wt({manualStatus:w,paidAmount:me.paidAmount,paidPercent:me.paidPercent,totalAmount:ue});k&&!v&&(k.value=pe,k.dataset&&delete k.dataset.userSelected);let Le=_.status??"pending";Ee?Le=se?.status??Ge??Le:ae?Le="cancelled":["completed","cancelled"].includes(String(Le).toLowerCase())||(Le=I?"confirmed":"pending");const Re=Vn({reservationCode:_.reservationCode??_.reservationId??null,customerId:_.customerId,start:B,end:P,status:Le,title:_.title??null,location:_.location??null,notes:f,projectId:H?String(H):null,totalAmount:ue,discount:y,discountType:g,applyTax:Q,paidStatus:pe,confirmed:Pe,items:ke.map(E=>({...E,equipmentId:E.equipmentId??E.id})),crewAssignments:F,companySharePercent:K?M:null,companyShareEnabled:K,paidAmount:me.paidAmount,paidPercentage:me.paidPercent,paymentProgressType:me.paymentProgressType,paymentProgressValue:me.paymentProgressValue,paymentHistory:Z});try{Nn("about to submit",{editingIndex:st,crewAssignments:F,techniciansPayload:Re?.technicians,payload:Re});const E=await Xa(_.id||_.reservationId,Re);Nn("server response",{reservation:E?.id??E?.reservationId??E?.reservation_code,technicians:E?.technicians,crewAssignments:E?.crewAssignments,techniciansDetails:E?.techniciansDetails}),await Za(),rn(),ft(),ms(),h(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),qa(),o?.({type:"updated",reservation:E}),s?.(),i?.(),Kt?.hide?.()}catch(E){console.error("âŒ [reservationsEdit] Failed to update reservation",E);const D=zn(E)?E.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");h(D,"error")}}function Lr(e={}){ce={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=ce,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=S(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{Xt("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{Xt("share")}),d.dataset.listenerAttached="true");const p=document.getElementById("edit-res-payment-progress-type");p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>{p.dataset.userSelected="true",n?.()}),p.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=S(l.value)}),l.dataset.listenerAttached="true"),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const m=document.getElementById("edit-res-project");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{ja();const k=Array.isArray(ce.projects)&&ce.projects.length?ce.projects:ne().projects||[],v=m.value&&k.find(j=>String(j.id)===String(m.value))||null,b={...ce?.reservation??{},projectId:m.value||null,confirmed:St()},{effectiveConfirmed:q,projectLinked:C}=vt(b,v);mt(q,{disable:C}),n?.()}),m.dataset.listenerAttached="true");const f=document.getElementById("edit-res-confirmed-btn");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{if(f.disabled)return;const k=!St();mt(k),n?.()}),f.dataset.listenerAttached="true");const u=document.getElementById("edit-res-cancelled");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&mt(St(),{disable:u.checked}),n?.()}),u.dataset.listenerAttached="true");const y=document.getElementById("save-reservation-changes");y&&!y.dataset.listenerAttached&&(y.addEventListener("click",()=>{Ta(ce).catch(k=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",k)})}),y.dataset.listenerAttached="true");const g=document.getElementById("edit-res-equipment-barcode");if(g&&!g.dataset.listenerAttached){let k=null;const v=()=>{g.value?.trim()&&(clearTimeout(k),k=null,t?.(g))};g.addEventListener("keydown",b=>{b.key==="Enter"&&(b.preventDefault(),v())});const w=()=>{if(clearTimeout(k),!g.value?.trim())return;const{start:b,end:q}=getEditReservationDateRange();!b||!q||(k=setTimeout(()=>{v()},150))};g.addEventListener("input",w),g.addEventListener("change",v),g.dataset.listenerAttached="true"}La?.();const I=document.getElementById("editReservationModal");I&&!I.dataset.cleanupAttached&&(I.addEventListener("hidden.bs.modal",()=>{qa(),n?.(),r?.([])}),I.dataset.cleanupAttached="true")}function zr(){return bs().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=ne()||{};ts(e||[]),wa()})}function yn(e=null){wa(),_a(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function qr(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Zt(){return{populateEquipmentDescriptionLists:Ue,setFlatpickrValue:yr,splitDateTime:Kn,renderEditItems:xe,updateEditReservationSummary:ye,addEquipmentByDescription:fr,addEquipmentToEditingReservation:pr,addEquipmentToEditingByDescription:Ct,combineDateTime:Ke,hasEquipmentConflict:Te,hasTechnicianConflict:Jn,renderReservations:_a,handleReservationsMutation:yn,ensureModal:qr}}function _a(e="reservations-list",n=null){Zs({containerId:e,filters:n,onShowDetails:Da,onConfirmReservation:Ra})}function Da(e){return er(e,{getEditContext:Zt,onEdit:(n,{reservation:t})=>{Fa(n,t)},onDelete:Na})}function Na(e){return Va()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?vs(e,{onAfterChange:yn}):!1:(za(),!1)}function Ra(e){return hs(e,{onAfterChange:yn})}function Fa(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}Rn(e,Zt());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}Rn(e,Zt());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}Ha({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function Hr(){Is({showReservationDetails:Da,deleteReservation:Na,confirmReservation:Ra,openReservationEditor:Fa})}export{Vr as a,_a as b,wa as c,O as d,Da as e,Na as f,Zt as g,yn as h,Mr as i,Ra as j,yr as k,zr as l,Fa as o,Hr as r,Lr as s,ye as u};
