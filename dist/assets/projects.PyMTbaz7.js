import"./app.BkkBR8h4.js";/* empty css              */import{b as G,m as Y,c as J,i as X,t as m,l as Q,n as w,E as I,g as E}from"./maintenance.BnsilVv3.js";import{i as Z}from"./dashboardShell.C_ArwTjw.js";import"./projects.JaIf0Mb4.js";import"./customers.CDqN0Nx5.js";import{a2 as tt,O as et,J as at,a3 as j,a4 as rt,a5 as nt,w as st}from"./projects.LJ2hsl-k.js";import{z as ot,k as it,d as lt}from"./reservations.DRN0EUrN.js";import"./reports.Db7PepGB.js";G();Y();J();ot();tt();document.addEventListener("DOMContentLoaded",()=>{Z(),X()});const $=.15,D={},ct="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let x=0;const c={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},r={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},T=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let h=null;const z=["upcoming","ongoing","completed"];async function ut({forceProjects:t=!1}={}){try{await et({suppressError:!0}),await at({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),j(e)&&console.warn("Projects API error:",e.message)}V()}async function dt(){ft(),H(),await pt();try{await ut({forceProjects:!0}),W(),wt(),y()}finally{q()}document.addEventListener("language:changed",Ct),document.addEventListener("projects:changed",()=>{N().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{N().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",Dt)}document.addEventListener("DOMContentLoaded",dt);async function pt(){if(h)return h;if(typeof window>"u")return null;if(window.ApexCharts)return h=window.ApexCharts,h;try{await mt(ct),h=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),h=null}return h}function mt(t){return new Promise((e,a)=>{if(typeof document>"u"){a(new Error("Document is not available to load scripts."));return}const n=document.querySelector(`script[src="${t}"]`);if(n){if(n.dataset.loaded==="true"){e();return}n.addEventListener("load",e,{once:!0}),n.addEventListener("error",()=>a(new Error(`Failed to load script ${t}`)),{once:!0});return}const o=document.createElement("script");o.src=t,o.async=!0,o.dataset.loaded="false",o.onload=()=>{o.dataset.loaded="true",e()},o.onerror=()=>a(new Error(`Failed to load script ${t}`)),document.head.appendChild(o)})}function ft(){r.search=document.getElementById("reports-search"),r.statusChips=document.getElementById("reports-status-chips"),r.payment=document.getElementById("reports-payment"),r.dateRange=document.getElementById("reports-date-range"),r.customRangeWrapper=document.getElementById("reports-custom-range"),r.startDate=document.getElementById("reports-start-date"),r.endDate=document.getElementById("reports-end-date"),r.refreshBtn=document.getElementById("reports-refresh"),r.kpiGrid=document.getElementById("reports-kpi-grid"),r.table=document.getElementById("reports-table"),r.tableBody=r.table?.querySelector("tbody"),r.tableMeta=document.getElementById("reports-table-meta"),r.tableEmpty=document.getElementById("reports-empty"),r.chartCards={},r.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;r.chartCards[e]=t;const a=t.querySelector("[data-chart-loading]");a&&(r.chartLoaders[e]=a)})}function O(t){const e=!!t;Object.entries(r.chartCards||{}).forEach(([a,n])=>{if(!n)return;n.classList.toggle("is-loading",e),n.setAttribute("aria-busy",e?"true":"false");const o=r.chartLoaders?.[a];o&&(o.hidden=!e)})}function H(){x+=1,x===1&&O(!0)}function q(){x=Math.max(0,x-1),x===0&&O(!1)}function V(){const{customers:t=[]}=Q();c.customers=Array.isArray(t)?t:[],c.reservations=lt();const e=new Map(c.customers.map(n=>[String(n.id),n])),a=nt();c.projects=Array.isArray(a)?a.map(n=>ht(n,e)):[],c.totalProjects=c.projects.length}function ht(t,e){const a=t.paymentStatus==="paid"?"paid":"unpaid",n=e.get(String(t.clientId)),o=gt(t.id),u=o.reduce((K,_)=>K+yt(_),0),d=bt(t),p=Number(t?.equipmentEstimate)||0,s=Number((p+d).toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true",l=i?Number((s*$).toFixed(2)):0,g=i?Number(((s+u)*$).toFixed(2)):0,b=Number((s+u+g).toFixed(2)),A=vt(t),C=t.start?new Date(t.start):null,L=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:n?.customerName||n?.name||"",clientCompany:t.clientCompany||n?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:a,confirmed:t.confirmed===!0||t.confirmed==="true",start:C,end:L,applyTax:i,status:A,reservationsTotal:Number(u.toFixed(2)),expensesTotal:d,subtotal:s,taxAmount:l,combinedTaxAmount:g,overallTotal:b,unpaidValue:a==="paid"?0:b,reservationsCount:o.length}}function gt(t){return Array.isArray(c.reservations)?c.reservations.filter(e=>String(e.projectId)===String(t)):[]}function yt(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],a=t.discount??0,n=Number(w(String(a)))||0,o=t.discountType||"percent",u=Array.isArray(t.crewAssignments)?t.crewAssignments:[],d=u.length?u:Array.isArray(t.technicians)?t.technicians:[],p=st(e,n,o,!1,d,{start:t.start,end:t.end});if(Number.isFinite(p))return p;const s=Number(w(String(t.cost??0)));return Number.isFinite(s)?Math.round(s):0}function bt(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,a)=>e+(Number(a.amount)||0),0):0}function vt(t){const e=new Date,a=t.start?new Date(t.start):null,n=t.end?new Date(t.end):null;return a&&!Number.isNaN(a.getTime())&&a>e?"upcoming":n&&!Number.isNaN(n.getTime())&&n<e?"completed":"ongoing"}function wt(){if(r.search){let t;r.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{c.filters.search=r.search.value.trim(),y()},180)})}r.payment&&(r.payment.value=c.filters.payment,r.payment.addEventListener("change",()=>{c.filters.payment=r.payment.value||"all",y()})),r.dateRange&&(r.dateRange.addEventListener("change",xt),r.dateRange.value=c.filters.range),r.startDate&&r.startDate.addEventListener("change",()=>{c.filters.startDate=r.startDate.value,c.filters.range==="custom"&&y()}),r.endDate&&r.endDate.addEventListener("change",()=>{c.filters.endDate=r.endDate.value,c.filters.range==="custom"&&y()}),r.refreshBtn&&r.refreshBtn.addEventListener("click",()=>{if(c.filters.range!=="custom"){y();return}c.filters.startDate=r.startDate?.value||"",c.filters.endDate=r.endDate?.value||"",y()})}function xt(t){const e=t.target.value;c.filters.range=e,e==="custom"?r.customRangeWrapper?.classList.add("active"):(r.customRangeWrapper?.classList.remove("active"),c.filters.startDate="",c.filters.endDate="",r.startDate&&(r.startDate.value=""),r.endDate&&(r.endDate.value=""),y())}async function N(){H();try{await Promise.all([rt(),it()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),j(t)&&console.warn("Projects API error:",t.message)}finally{V(),y(),q()}}function Ct(){W(),y()}function Dt(t){t.key&&!["projects","reservations","customers"].includes(t.key)||N().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function y(){const t=Tt();R(),St(t),Lt(t),Nt(t),Mt(t),Rt(t),It(t)}function Tt(){const{search:t,statuses:e,payment:a,range:n,startDate:o,endDate:u}=c.filters,d=U(t),p=new Date,s=Number(n);let i=null;if(n==="custom"){i=o?new Date(o):null;const l=u?new Date(u):null;return c.projects.filter(g=>!P(g,e)||!B(g,a)||!F(g,d)?!1:Et(g.start,i,l))}return n!=="all"&&Number.isFinite(s)&&(i=new Date,i.setDate(p.getDate()-s)),c.projects.filter(l=>!P(l,e)||!B(l,a)||!F(l,d)?!1:n==="all"?!0:kt(l.start,i,p))}function P(t,e){return e.includes(t.status)}function B(t,e){return e==="all"?!0:t.paymentStatus===e}function F(t,e){return e?U([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function kt(t,e,a){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=a:!0}function Et(t,e,a){if(!e&&!a)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const n=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&n<e.getTime()||a&&!Number.isNaN(a.getTime())&&n>a.getTime())}function U(t){return t?w(String(t)).toLowerCase().trim():""}function St(t){if(!r.kpiGrid)return;const e=t.length,a=t.reduce((d,p)=>d+p.overallTotal,0),n=t.reduce((d,p)=>d+p.unpaidValue,0),o=t.reduce((d,p)=>d+p.expensesTotal,0),u=[{icon:T.projects,label:m("projects.reports.kpi.totalProjects","Total projects"),value:M(e),meta:m("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:T.value,label:m("projects.reports.kpi.totalValue","Total value"),value:k(a),meta:m("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:T.outstanding,label:m("projects.reports.kpi.unpaidValue","Outstanding value"),value:k(n),meta:m("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:T.expenses,label:m("projects.reports.kpi.expenses","Total expenses"),value:k(o),meta:m("projects.reports.kpi.expensesMeta","Expenses for included projects")}];r.kpiGrid.innerHTML=u.map(({icon:d,label:p,value:s,meta:i})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${d}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${f(p)}</p>
        <p class="reports-kpi-value">${f(s)}</p>
        <span class="reports-kpi-meta">${f(i)}</span>
      </div>
    </div>
  `).join("")}function W(){if(!r.statusChips)return;const t=z.map(e=>{const a=m(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${f(a)}</button>`}).join("");r.statusChips.innerHTML=t,r.statusChips.dataset.listenerAttached||(r.statusChips.addEventListener("click",At),r.statusChips.dataset.listenerAttached="true"),R()}function At(t){const e=t.target.closest("[data-status]");if(!e)return;const a=e.dataset.status;if(!a)return;const n=new Set(c.filters.statuses);n.has(a)?n.delete(a):n.add(a),n.size===0&&z.forEach(o=>n.add(o)),c.filters.statuses=Array.from(n),R(),y()}function R(){if(!r.statusChips)return;const t=new Set(c.filters.statuses);r.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Lt(t){if(!h)return;const e=document.getElementById("reports-status-chart");if(!e)return;const a=["upcoming","ongoing","completed"],n=a.map(s=>t.filter(i=>i.status===s).length),o=a.map(s=>m(`projects.status.${s}`,s)),d=n.reduce((s,i)=>s+i,0)>0?n:[],p={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:o,series:d,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:s=>Number.isFinite(s)?`${Math.round(s)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:s=>v(s)}},noData:{text:m("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};S("status",e,p)}function Nt(t){if(!h)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const a=new Map,n=new Intl.DateTimeFormat(Pt(),{month:"short",year:"numeric"});t.forEach(l=>{if(!l.start||Number.isNaN(l.start.getTime()))return;const g=`${l.start.getFullYear()}-${l.start.getMonth()+1}`,b=a.get(g)||{total:0,label:n.format(l.start)};b.total+=l.overallTotal,a.set(g,b)});const u=Array.from(a.keys()).sort((l,g)=>{const[b,A]=l.split("-").map(Number),[C,L]=g.split("-").map(Number);return b===C?A-L:b-C}).slice(-12),d=u.map(l=>a.get(l)?.label||l),p=u.map(l=>Math.round(a.get(l)?.total||0)),s=p.length?[{name:m("projects.reports.datasets.value","Total value"),data:p}]:[],i={chart:{type:"area",height:320,toolbar:{show:!1}},series:s,xaxis:{categories:d,labels:{rotate:-35}},yaxis:{labels:{formatter:l=>v(l)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:l=>v(l)}},noData:{text:m("projects.reports.noData","لا توجد بيانات متاحة")}};S("timeline",e,i)}function Mt(t){if(!h)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const a=[...t].sort((i,l)=>l.overallTotal-i.overallTotal).slice(0,6),n=a.map(i=>i.title||i.projectCode),o=a.map(i=>Math.round(i.overallTotal)),u=a.map(i=>Math.round(i.expensesTotal)),d=n.length?[{name:m("projects.reports.datasets.value","Total value"),data:o},{name:m("projects.reports.datasets.expenses","Expenses"),data:u}]:[],s={chart:{type:"bar",height:Math.max(320,n.length*60||0),toolbar:{show:!1}},series:d,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:n,labels:{formatter:i=>v(i)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:i=>v(i)}},noData:{text:m("projects.reports.noData","لا توجد بيانات متاحة")}};S("expenses",e,s)}function Rt(t){if(!h)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const a=new Map;t.forEach(s=>{const i=s.clientName||s.clientCompany||m("projects.fallback.unknownClient","Unknown client"),l=a.get(i)||0;a.set(i,l+s.overallTotal)});const n=Array.from(a.entries()).sort((s,i)=>i[1]-s[1]).slice(0,6),o=n.map(([s])=>s),u=n.map(([,s])=>Math.round(s)),d=u.length?[{name:m("projects.reports.datasets.value","Total value"),data:u}]:[],p={chart:{type:"bar",height:320,toolbar:{show:!1}},series:d,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:o,labels:{rotate:-35}},yaxis:{labels:{formatter:s=>v(s)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:s=>v(s)}},legend:{show:!1},noData:{text:m("projects.reports.noData","لا توجد بيانات متاحة")}};S("clients",e,p)}function S(t,e,a={}){if(!h||!e)return;if(D[t]){try{D[t].destroy()}catch(o){console.warn(`⚠️ [projectsReports] Failed to destroy ${t} chart`,o)}delete D[t]}e.innerHTML="";const n={...a};Array.isArray(n.series)||(n.series=[]);try{const o=new h(e,n);D[t]=o,o.render().catch(u=>{console.error(`❌ [projectsReports] Failed to render ${t} chart`,u)})}catch(o){console.error(`❌ [projectsReports] Failed to render ${t} chart`,o)}}function It(t){if(!r.table||!r.tableBody||!r.tableEmpty)return;if(!t.length){r.table.style.display="none",r.tableEmpty.classList.add("active"),r.tableMeta&&(r.tableMeta.textContent="");return}r.table.style.display="",r.tableEmpty.classList.remove("active");const e=t.map(a=>{const n=$t(a.start,a.end),o=m(`projects.status.${a.status}`,a.status),u=m(`projects.paymentStatus.${a.paymentStatus}`,a.paymentStatus),d=a.clientCompany?`${f(a.clientName)} <small class="text-muted">${f(a.clientCompany)}</small>`:f(a.clientName||m("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${f(a.title||a.projectCode)}</span>
            <small class="text-muted">${f(`#${a.projectCode}`)}</small>
          </div>
        </td>
        <td>${d}</td>
        <td>${f(o)}</td>
        <td>${f(n)}</td>
        <td>${f(k(a.overallTotal))}</td>
        <td>${f(u)}</td>
      </tr>
    `}).join("");if(r.tableBody.innerHTML=e,r.tableMeta){const a=m("projects.reports.table.meta","Showing {count} of {total} projects");r.tableMeta.textContent=a.replace("{count}",M(t.length)).replace("{total}",M(c.totalProjects))}}function $t(t,e){if(!t&&!e)return"—";const a=t?I(t.toISOString()):"—",n=e?I(e.toISOString()):"—";return e?`${a} → ${n}`:a}function k(t){const e=Number(t)||0,n=E()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.NumberFormat(n,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${w(o)} SR`}function M(t){const a=E()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return w(new Intl.NumberFormat(a).format(t))}function v(t){const a=E()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return w(new Intl.NumberFormat(a,{notation:"compact",compactDisplay:"short"}).format(t))}function Pt(){return E()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function f(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
