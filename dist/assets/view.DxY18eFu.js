import{n as _,p as $t,t as c,v as te}from"./auth.C-UmjYUR.js";import{a as ee,h as ne,C as St,c as se,e as ae,d as re}from"./reservationsService.D2fW55Hk.js";const m={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],servicesClientPriceTotal:0,filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null,pendingLinkedToast:!1},y={};function je(){m.selectedTechnicians=[],m.selectedEquipment=[],m.expenses=[],m.servicesClientPriceTotal=0}function d(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function I(t){const e=Number(t)||0,a=$t()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${_(i)} SR`}function L(t){if(!t)return"â€”";const e=new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const s=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getFullYear()),n=String(e.getMinutes()).padStart(2,"0"),r=e.getHours(),o=r>=12?"PM":"AM",l=r%12||12,h=String(l).padStart(2,"0"),T=`${s}/${a}/${i} ${h}:${n} ${o}`;return _(T)}function ie(t){const e=$t(),s=_(String(t));return e==="en"?`${s} ${t===1?"project":"projects"}`:`${s} Ù…Ø´Ø±ÙˆØ¹`}function _t(t){y.tableCount&&(y.tableCount.dataset.count=String(t),y.tableCount.textContent=ie(t))}function $e(t){if(!t)return"";const e=t.dataset.emptyKey,s=t.dataset.empty||"";return e?c(e,s):s}const Se="project",Ne="editProject",Q=3600*1e3,lt=.15,K=6,Ce="projectsTab",we="projectsSubTab",xe={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab",templates:"projects-templates-tab"},oe={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed",cancelled:"Cancelled",conflict:"Conflict"};function Nt(t){if(!t)return"";if(t instanceof Date)return t.toISOString();let e=String(t).trim();return e?(e.includes(" ")&&!e.includes("T")&&(e=e.replace(" ","T")),e):""}function A(t){if(!t?.start)return Number.NaN;const e=Nt(t.start),s=new Date(e).getTime();return Number.isFinite(s)?s:Number.NaN}function k(t){if(t?.createdAt){const s=Nt(t.createdAt),a=new Date(s).getTime();if(Number.isFinite(a))return a}const e=A(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function Pe(t,e){if(!t)return"";const s=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",i="00"]=s.split(":"),n=a.padStart(2,"0"),r=i.padStart(2,"0");return`${t}T${n}:${r}`}function Ct(t,e){const s=String(t||"");return s.length<=e?s:`${s.slice(0,Math.max(0,e-1))}â€¦`}function Ae(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[s,a=""]=e.split("T");return{date:s,time:a}}function Z(t){if(!t)return c("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return c(e,t)}function De(){if(!y.projectsTableBody)return;const t=m.filters.search,e=m.projects.filter(a=>{if(!t)return!0;const i=m.customers.find(r=>String(r.id)===String(a.clientId));return _([a.title,a.description,i?.customerName,a.clientCompany,Z(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=m.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",i=m.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",n=d(c(a,i));y.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${n}</td></tr>`,_t(0),m.visibleProjects=[],Tt([]);return}const s=[...e].sort((a,i)=>{const n=k(a),r=k(i);if(Number.isFinite(n)&&Number.isFinite(r)&&n!==r)return r-n;const o=A(a),l=A(i);return Number.isFinite(o)&&Number.isFinite(l)?l-o:0});m.visibleProjects=s,_t(s.length),y.projectsTableBody.innerHTML=s.map(a=>ce(a)).join(""),Tt(s),me()}function ce(t){const e=m.customers.find(N=>String(N.id)===String(t.clientId)),s=e?.customerName||c("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),a=(t.clientCompany||e?.companyName||"").trim(),i=t.technicians?.length||0,n=(t.equipment||[]).reduce((N,F)=>N+(F.qty||0),0),{expensesTotal:r,totalWithTax:o}=Y(t),h=ut(t.id).length,p=c("projects.table.reservationsCount","{count} Ø­Ø¬ÙˆØ²Ø§Øª").replace("{count}",_(String(h))),f=h?`<span class="badge rounded-pill project-reservations-chip">${d(p)}</span>`:"",$=`<span class="badge project-type-badge">${d(Z(t.type))}</span>`,S=t.projectCode||`PRJ-${_(String(t.id))}`,v=`<span class="project-code-badge">#${d(S)}</span>`,D=te()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${d(c("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${d(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${v}
            ${$}
          </div>
        </div>
        ${f}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${d(s)}</span><small class="text-muted">${d(a)}</small></div>`:d(s)}
      </td>
      <td>${le(t.start,t.end)}</td>
      <td>${_(String(i))}</td>
      <td>${_(String(n))}</td>
      <td>${I(o)}</td>
      <td>${I(r)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${d(c("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${D}
      </td>
    </tr>
  `}function le(t,e){if(!t)return"â€”";const s=L(t),a=e?L(e):"",i=l=>{const h=String(l).split(" ").filter(Boolean),T=h.shift()||"",p=h.join(" ");return{date:T,time:p}},n=i(s),r=a?i(a):{date:"",time:""};if(r.date&&n.date===r.date){const l=n.time&&r.time?`Ù…Ù† ${n.time} Ø¥Ù„Ù‰ ${r.time}`:"";return`
      <div class="date-range">
        <div class="date-line">${n.date}</div>
        ${l?`<div class="time-line">${l}</div>`:""}
      </div>
    `}const o=n.time&&r.time?`Ù…Ù† ${n.time} Ø¥Ù„Ù‰ ${r.time}`:"";return`
    <div class="date-range">
      <div class="date-line">${n.date}</div>
      ${r.date?`<div class="date-line">${r.date}</div>`:""}
      ${o?`<div class="time-line">${o}</div>`:""}
    </div>
  `}function de(t,e){if(!t)return{dateHtml:"â€”",timeText:""};const s=L(t),a=e?L(e):"",i=h=>{const T=String(h).split(" ").filter(Boolean),p=T.shift()||"",f=T.join(" ");return{date:p,time:f}},n=i(s),r=a?i(a):{date:"",time:""};let o="",l="";return r.date&&n.date===r.date?(o=`<div class="date-range"><div class="date-line">${n.date}</div></div>`,l=`Ù…Ù† ${n.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${r.time||"â€”:â€”"}`):(o=`<div class="date-range"><div class="date-line">${n.date}</div>`+(r.date?`<div class="date-line">${r.date}</div>`:"")+"</div>",l=`Ù…Ù† ${n.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${r.time||"â€”:â€”"}`),{dateHtml:o,timeText:l}}function Tt(t){if(!y.timeline)return;const s=(Array.isArray(t)?t:m.visibleProjects.length?m.visibleProjects:m.projects).map(p=>{if(!p?.start)return null;const f=new Date(p.start);if(Number.isNaN(f.getTime()))return null;let b=p.end?new Date(p.end):new Date(f);return Number.isNaN(b.getTime())&&(b=new Date(f)),b<=f&&(b=new Date(f.getTime()+Q)),{project:p,startDate:f,endDate:b}}).filter(Boolean).sort((p,f)=>p.startDate-f.startDate);if(!s.length){const p=d(c("projects.timeline.empty",y.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));y.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${p}</div>`;return}const a=s[0].startDate.getTime(),i=Math.max(...s.map(p=>p.endDate.getTime()));let n=i-a;n<=0&&(n=Q);const r=ue(s),o=c("projects.timeline.range","{start} â†’ {end}"),l=c("projects.timeline.conflict","Scheduling conflict"),h=s.map(p=>{const{project:f,startDate:b,endDate:$}=p,S=$.getTime()-b.getTime();let v=(b.getTime()-a)/n*100;v=Math.max(0,Math.min(v,100));let w=S/n*100;w=Math.max(w,2.5),v+w>100&&(w=Math.max(1.5,100-v));const N=`project-timeline__item--${wt(f)}`,F=r.has(f.id),B=(f.title||"").trim()||c("projects.fallback.untitled","Untitled project"),W=Ct(B,26),R=m.customers.find(C=>String(C.id)===String(f.clientId)),E=R?.customerName||c("projects.fallback.unknownClient","Unknown client"),O=(f.clientCompany||R?.companyName||"").trim(),tt=Z(f.type),V=L(b.toISOString()),G=L($.toISOString()),et=o.replace("{start}",V).replace("{end}",G),nt=O?`${E} (${O})`:E,M=`${B} â€¢ ${tt} â€¢ ${nt} | ${et}`,mt=F?`<span class="project-timeline__item-conflict" title="${d(l)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${N}${F?" project-timeline__item--conflict":""}" style="left:${v}%;width:${w}%;" title="${d(M)}">
          <span class="project-timeline__item-label">${d(W)}</span>
          ${mt}
        </div>
      `}).join(""),T=`
    <div class="project-timeline__scale">
      <span>${d(L(new Date(a).toISOString()))}</span>
      <span>${d(L(new Date(i).toISOString()))}</span>
    </div>
  `;y.timeline.innerHTML=`
    ${T}
    <div class="project-timeline__track">
      ${h}
    </div>
  `}function ue(t){const e=new Set;for(let s=0;s<t.length;s+=1)for(let a=s+1;a<t.length;a+=1){const i=t[s],n=t[a];i.startDate<n.endDate&&n.startDate<i.endDate&&(e.add(i.project.id),e.add(n.project.id))}return e}function me(){if(!y.focusCards)return;const t=pe();if(!t.length){const e=d(c("projects.focus.empty",y.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));y.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}y.focusCards.innerHTML=t.join("")}function pe(){if(!Array.isArray(m.projects)||!m.projects.length)return[];const t=m.projects.filter(jt),e=m.projects.filter(n=>!jt(n)&&ge(n)),s=[],a=new Set,i=(n,r)=>{!n||a.has(n.id)||s.length>=K||(a.add(n.id),s.push(fe(n,r)))};if(t.sort((n,r)=>A(n)-A(r)).forEach(n=>i(n,"today")),e.sort((n,r)=>A(n)-A(r)).forEach(n=>i(n,"thisWeek")),s.length<K){const n=Date.now();[...m.projects].filter(o=>!a.has(o.id)).filter(o=>{const l=A(o);return Number.isFinite(l)&&l>=n}).sort((o,l)=>A(o)-A(l)).forEach(o=>i(o,"upcoming"))}return s.length<K&&[...m.projects].filter(r=>!a.has(r.id)).filter(r=>!Number.isFinite(A(r))).sort((r,o)=>k(o)-k(r)).forEach(r=>i(r,"recent")),s.length===0&&[...m.projects].sort((r,o)=>k(o)-k(r)).slice(0,K).forEach(r=>i(r,"recent")),s.length<K&&[...m.projects].filter(r=>!a.has(r.id)).sort((r,o)=>k(o)-k(r)).forEach(r=>i(r,"recent")),s}function fe(t,e){const s=m.customers.find(g=>String(g.id)===String(t.clientId)),a=s?.customerName||c("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");(t.clientCompany||s?.companyName||"").trim();const i=Array.isArray(t.technicians)?t.technicians.length:0,n=ut(t.id),r=n.length;xt(t);const o=Number(t?.servicesClientPrice??0),{applyTax:l}=Y(t),h=(t.description||"").trim(),T=h?Ct(h,110):c("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),p=Z(t.type),f=Y(t)||{},b=Number(f.subtotal||0),$=(n||[]).reduce((g,u)=>g+(Number(u?.totalAmount)||dt(u)||0),0),S=f.applyTax?Number(((b+$)*lt).toFixed(2)):0,v=Number((b+$+S).toFixed(2)),w=t.paymentHistory||t.payments||[],D=se({totalAmount:v,paidAmount:w.length?0:t.paidAmount,paidPercent:w.length?0:t.paidPercent,history:w}),N=ae({manualStatus:null,paidAmount:D.paidAmount,paidPercent:D.paidPercent,totalAmount:v}),F=c(`projects.paymentStatus.${N}`,N==="paid"?"Paid":N==="partial"?"Partially Paid":"Unpaid"),B=N==="paid"?"status-paid":N==="partial"?"status-partial":"status-unpaid",W=N==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",R=t.confirmed===!0||t.confirmed==="true",E=d(String(t.id)),O=t.projectCode||`PRJ-${_(String(t.id))}`,tt=_(O);try{const u=(new URL(window.location.href).searchParams.get("paymentDebug")||"").toLowerCase();(u==="1"||u==="true"||u==="yes")&&console.debug("[PaymentDebug][card]",{projectId:t?.id,projectTaxableBase:b,combinedReservationsTotal:$,combinedTax:S,combinedTotalWithTax:v,paidAmount:D.paidAmount,paidPercent:D.paidPercent,paymentStatus:N})}catch{}const V={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},G={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},et=V[e]||V.recent;c(et,G[e]||G.recent);const nt=wt(t),M=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":nt;c(`projects.status.${M}`,oe[M]||M);const C=(()=>{try{const g=t.start?new Date(t.start):null,u=t.end?new Date(t.end):g?new Date(g.getTime()+Q):null;return!g||!u||Number.isNaN(g.getTime())||Number.isNaN(u.getTime())?!1:m.projects.some(j=>{if(!j||String(j.id)===String(t.id))return!1;const x=j.start?new Date(j.start):null,P=j.end?new Date(j.end):x?new Date(x.getTime()+Q):null;if(!x||!P||Number.isNaN(x.getTime())||Number.isNaN(P.getTime()))return!1;const U=Math.max(g.getTime(),x.getTime()),it=Math.min(u.getTime(),P.getTime());return U<it})}catch{return!1}})()&&(M==="upcoming"||M==="ongoing")?"conflict":M,Pt=C==="upcoming"?"timeline-status-badge timeline-status-badge--upcoming":C==="ongoing"?"timeline-status-badge timeline-status-badge--ongoing":C==="completed"?"timeline-status-badge timeline-status-badge--completed":C==="cancelled"?"timeline-status-badge timeline-status-badge--cancelled":"timeline-status-badge timeline-status-badge--conflict",At=(t.title||"").trim()||c("projects.fallback.untitled","Untitled project"),st=C==="cancelled"?[]:[W];C==="cancelled"?st.push("project-focus-card--cancelled"):R&&st.push("project-focus-card--confirmed");const z=n.reduce((g,u)=>{const j=Array.isArray(u.items)?u.items:[],x=Array.isArray(u.crewAssignments)?u.crewAssignments:[],P=x.length?x:Array.isArray(u.technicians)?u.technicians:[],U=re({items:j,technicianIds:Array.isArray(P)&&!P.length?P:[],crewAssignments:Array.isArray(P)&&P.length&&typeof P[0]=="object"?P:[],discount:u.discount??0,discountType:u.discountType||"percent",applyTax:!1,start:u.start,end:u.end,companySharePercent:null}),it=dt(u),Gt=(()=>{try{const{groups:ht}=St(u);return(ht||[]).reduce((ot,q)=>{if(String(q?.type||"").toLowerCase()==="package"){const Qt=Array.isArray(q?.packageItems)?q.packageItems:[],Zt=new Set(Qt.map(ct=>(ct?.normalizedBarcode||ct?.barcode||ct?.equipmentId||"").toString()));return ot+Zt.size}const vt=Number.isFinite(Number(q?.count))?Number(q.count):Number.isFinite(Number(q?.quantity))?Number(q.quantity):1;return ot+(vt>0?vt:1)},0)}catch{return(Array.isArray(u?.items)?u.items:[]).length||0}})(),Xt=(u.technicians||[]).length;return{netTotal:g.netTotal+it,equipmentMoney:g.equipmentMoney+Number(U.equipmentTotal||0),crewMoney:g.crewMoney+Number(U.crewTotal||0),equipmentCount:g.equipmentCount+Gt,crewCount:g.crewCount+Xt}},{netTotal:0,equipmentMoney:0,crewMoney:0,equipmentCount:0,crewCount:0}),Dt=Number(z.netTotal.toFixed(2)),Ft=z.equipmentCount,Et=z.crewCount||i,Mt=Number(o||0),X=Number((z.equipmentMoney+z.crewMoney+Mt).toFixed(2)),pt=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let H=(t?.discountType==="amount"?"amount":"percent")==="amount"?pt:X*(pt/100);(!Number.isFinite(H)||H<0)&&(H=0),H>X&&(H=X);const at=Math.max(0,X-H),kt=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",ft=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,gt=kt&&l&&ft>0?ft:0,bt=Number((at*(gt/100)).toFixed(2)),Lt=l?Number(((at+bt)*lt).toFixed(2)):0,It=Number((at+bt+Lt).toFixed(2)),Rt=`<span class="project-code-badge project-focus-card__code">#${d(tt)}</span>`,qt="",Bt="",Ot=c(`projects.status.${C}`,C),Ht=`<span class="${Pt}">${d(Ot)}</span>`,Ut=`<span class="reservation-chip ${B} project-focus-card__payment-chip">${d(F)}</span>`,rt=(g,u,j)=>{const x=String(j||""),U=x.trim().startsWith("<");return`
      <div class="project-focus-card__row">
        <span class="project-focus-card__row-label">
          ${g?`<span class="project-focus-card__row-icon">${d(g)}</span>`:""}
          ${d(u)}
        </span>
        <span class="project-focus-card__row-value">${U?x:d(x)}</span>
      </div>
    `},{dateHtml:Wt,timeText:yt}=de(t.start,t.end),zt=[{icon:"ğŸ‘¤",label:c("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:a},{icon:"ğŸ·ï¸",label:c("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`<span class="project-type-chip project-type-chip--${t.type||"default"}">${d(p)}</span>`},{icon:"ğŸ“…",label:c("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Wt},yt?{icon:"â°",label:c("projects.focus.summary.time","Ø§Ù„ÙˆÙ‚Øª"),value:yt}:null].filter(Boolean).map(({icon:g,label:u,value:j})=>rt(g,u,j)).join(""),Jt=gt>0&&l?` ${c("projects.details.chips.vatOn","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)")}`:"",Kt=`${c("projects.details.summary.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")}${Jt}`,Yt=[{icon:"ğŸ’¼",label:c("projectCards.stats.servicesClientPrice","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"),value:I(o)},{icon:"ğŸ’µ",label:Kt,value:I(It)}].map(({icon:g,label:u,value:j})=>rt(g,u,j)).join(""),Vt=[{icon:"ğŸ”—",label:c("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:_(String(r))},{icon:"ğŸ“¦",label:c("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:_(String(Ft))},{icon:"ğŸ˜",label:c("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:_(String(Et))},{icon:"ğŸ’µ",label:c("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:I(Dt)}].map(({icon:g,label:u,value:j})=>rt(g,u,j)).join("");let J="";return C==="cancelled"?J=`<span class="reservation-chip status-cancelled project-focus-card__confirm-indicator">${d(c("projects.focus.cancelled","Ù…Ø´Ø±ÙˆØ¹ Ù…Ù„ØºÙŠ"))}</span>`:R?C!=="completed"?J=`<button class="btn btn-sm btn-warning project-focus-card__confirm-btn" data-action="close-project" data-id="${E}">${d(c("projects.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`:J=`<span class="reservation-chip status-completed project-focus-card__confirm-indicator">${d(c("projects.status.completed","Ù…ØºÙ„Ù‚"))}</span>`:J=`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${E}">${d(c("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`,`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${[...st,C==="completed"?"project-focus-card--completed":""].filter(Boolean).join(" ")}" data-project-id="${E}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${Rt}
          ${qt}
          ${Bt}
          ${Ht}
          ${Ut}
        </div>
        <h6 class="project-focus-card__title">${d(At)}</h6>
        <p class="project-focus-card__description">${d(T)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(c("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${zt}
            </div>
          </div>
          <!-- Show reservations above the financial summary -->
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(c("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${Vt}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(c("projects.focus.summary.payment","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${Yt}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${J}
        </div>
      </article>
    </div>
  `}function jt(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const s=new Date;return e.getFullYear()===s.getFullYear()&&e.getMonth()===s.getMonth()&&e.getDate()===s.getDate()}function ge(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const s=new Date,a=new Date(s);a.setHours(0,0,0,0);const i=a.getDay(),n=i===0?6:i-1;a.setDate(a.getDate()-n);const r=new Date(a);return r.setDate(r.getDate()+7),e>=a&&e<r}function wt(t){try{const i=typeof t?.status=="string"?t.status.toLowerCase().trim():null;if(i){if(i==="cancelled"||i==="canceled"||i==="Ù…Ù„ØºÙŠ"||i==="Ù…Ù„ØºÙ‰")return"cancelled";if(i==="completed"||i==="Ù…ÙƒØªÙ…Ù„"||i==="Ù…ØºÙ„Ù‚")return"completed";if(i==="ongoing"||i==="in_progress"||i==="in-progress"||i==="Ø¬Ø§Ø±ÙŠ"||i==="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°")return"ongoing";if(i==="upcoming"||i==="Ù‚Ø§Ø¯Ù…")return"upcoming"}}catch{}const e=new Date,s=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return s&&!Number.isNaN(s.getTime())&&s>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function xt(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,s)=>e+(Number(s.amount)||0),0):0}function Y(t){const e=Number(t?.equipmentEstimate)||0,s=xt(t),a=e+s,i=t?.applyTax===!0||t?.applyTax==="true",n=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let o=(t?.discountType==="amount"?"amount":"percent")==="amount"?n:a*(n/100);(!Number.isFinite(o)||o<0)&&(o=0),o>a&&(o=a);const l=Math.max(0,a-o),h=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",T=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,p=i||h&&T>0,f=h&&p&&T>0?T:0,b=f>0?Number((l*(f/100)).toFixed(2)):0,$=l+b;let S=p?$*lt:0;(!Number.isFinite(S)||S<0)&&(S=0),S=Number(S.toFixed(2));let v=p?Number(t?.totalWithTax):$;return p?(!Number.isFinite(v)||v<=0)&&(v=Number(($+S).toFixed(2))):v=$,{equipmentEstimate:e,expensesTotal:s,baseSubtotal:a,discountAmount:o,subtotalAfterDiscount:l,companyShareAmount:b,subtotal:$,applyTax:p,taxAmount:S,totalWithTax:v}}function Fe(){const t=m.projects.length,e=m.projects.filter(i=>{const n=i.start?new Date(i.start):null;return!n||Number.isNaN(n.getTime())?!1:n>new Date}).length,s=m.projects.reduce((i,n)=>i+Y(n).expensesTotal,0),a=m.projects.reduce((i,n)=>i+Y(n).totalWithTax,0);y.projectsCount&&(y.projectsCount.textContent=_(String(t))),y.projectsUpcoming&&(y.projectsUpcoming.textContent=_(String(e))),y.projectsExpenses&&(y.projectsExpenses.textContent=I(s)),y.projectsBudget&&(y.projectsBudget.textContent=I(a))}function ut(t){return t?m.reservations.filter(e=>{const s=e?.projectId??e?.project_id??null;return s!=null&&String(s)===String(t)}):[]}function dt(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],s=t.discount??0,a=Number(_(String(s)))||0,i=t.discountType||"percent",n=Array.isArray(t.crewAssignments)?t.crewAssignments:[],r=n.length?n:Array.isArray(t.technicians)?t.technicians:[],o=ne(e,a,i,!1,r,{start:t.start,end:t.end,companySharePercent:0});if(Number.isFinite(o))return o;const l=Number(_(String(t.cost??0)));return Number.isFinite(l)?Math.round(l):0}function be(t){try{const{groups:e}=St(t);return(e||[]).reduce((s,a)=>{if(String(a?.type||"").toLowerCase()==="package"){const r=Array.isArray(a?.packageItems)?a.packageItems:[],o=new Set(r.map(l=>(l?.normalizedBarcode||l?.barcode||l?.equipmentId||"").toString()));return s+o.size}const n=Number.isFinite(Number(a?.count))?Number(a.count):Number.isFinite(Number(a?.quantity))?Number(a.quantity):1;return s+(n>0?n:1)},0)}catch{return(Array.isArray(t?.items)?t.items:[]).length||0}}function ye(t,e,s=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,i=t.status||t.state||"pending",n=String(i).toLowerCase(),{effectiveConfirmed:r}=ee(t,s),o=r?"confirmed":n,l=c(`reservations.list.status.${o}`,o==="confirmed"?"âœ… Ù…Ø¤ÙƒØ¯":o==="pending"?"â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯":o),T={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[o]||"project-reservation-card__badge--info",p=typeof s?.paymentStatus=="string"?s.paymentStatus.toLowerCase():null,f=p&&["paid","partial","unpaid"].includes(p)?p:String(t.paidStatus||t.paymentStatus||(t.paid?"paid":"unpaid")).toLowerCase(),b=f==="paid"?"paid":f==="partial"?"partial":"unpaid",$=b==="paid"?c("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"):b==="partial"?c("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"):c("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),S=b==="paid"?"project-reservation-card__badge--paid":b==="partial"?"project-reservation-card__badge--partial":"project-reservation-card__badge--unpaid",v=t.completed===!0||t.completed==="true",w=c("reservations.details.completed","Ù…ØºÙ„Ù‚"),D=v?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${d(w)}</span>`:"",N=dt(t),F=I(N),B=be(t),W=(t.technicians||[]).length,R=c("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),E=c("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),O=c("projectCards.stats.reservationTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${e}" data-reservation-index="${e}" data-project-id="${s?s.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${d(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${T}">${d(l)}</span>
          <span class="project-reservation-card__badge ${S}">${d($)}</span>
          ${D}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__meta project-reservation-card__meta--vertical">
          <span>ğŸ˜ ${d(R)}: ${_(String(W))}</span>
          <span>ğŸ“¦ ${d(E)}: ${_(String(B))}</span>
          <span>ğŸ’µ ${d(O)}: ${d(F)}</span>
        </div>
      </div>
    </article>
  `}function Ee(t){const e=ut(t.id).map(n=>{const r=n?.id??n?.reservationId??n?.reservation_code??n?.reservation_id,o=m.reservations.findIndex(l=>{const h=l?.id??l?.reservationId??l?.reservation_code??l?.reservation_id;return r!=null&&h!=null&&String(h)===String(r)});return{reservation:n,index:o}}).filter(({index:n})=>Number.isInteger(n)&&n>=0).sort((n,r)=>{const o=n.reservation.start?new Date(n.reservation.start).getTime():0;return(r.reservation.start?new Date(r.reservation.start).getTime():0)-o}),s=c("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),a=c("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),i=e.length?`<div class="project-reservations-list">${e.map(({reservation:n,index:r})=>ye(n,r,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${d(a)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${d(s)}</h6>
      </div>
      ${i}
    </section>
  `}export{Ce as P,me as a,we as b,xe as c,y as d,Se as e,L as f,Ne as g,lt as h,d as i,je as j,$e as k,I as l,dt as m,ut as n,Y as o,wt as p,oe as q,De as r,m as s,Ee as t,Fe as u,Ae as v,Pe as w};
