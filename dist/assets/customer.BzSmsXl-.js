const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.B5dITXmB.js","./controller.siFgUZXw.js","./auth.B4XUmSYg.js","./auth.Bv6C5uE6.css","./details.Bny9K0Xr.js","./state.DnWIUPO4.js","./reservationsService.DZ-N01gk.js","./equipment.9WuoT98d.js","./reservationsFilters.BpziFc1x.js","./view.Dbljb8vp.js","./quotePdf.C2lQPEPC.js","./canvasColorUtils.CviLtv6S.js","./reservationsActions.B0-uMTYt.js","./projectsService.GA8uKd8c.js","./uiBridge.BLZZT8b9.js"])))=>i.map(i=>d[i]);
import{r as Ne,n as A,d as K,t as d,j as B,a as Pe,c as Le,i as Ce,m as _e,l as Be,b as Bt,A as Re,h as ht}from"./auth.B4XUmSYg.js";import"./dashboard.za_9Wx-G.js";import{e as Mt,g as we,c as Fe}from"./form.BosfmE7y.js";import{_ as De,g as Me,w as $e,s as qe}from"./uiBridge.BLZZT8b9.js";import{r as Qt}from"./reservationsFilters.BpziFc1x.js";import{d as He,f as $t,m as Ue}from"./state.DnWIUPO4.js";import{g as Ct,b as Ve,a as ze,c as Oe,d as ee,s as We,e as Ye,r as Ke,f as ae,P as Qe}from"./projectFocusTemplates.DbapH4iX.js";import{buildProjectPayload as Je,updateProjectApi as Xe,mapProjectFromApi as Ge}from"./projectsService.GA8uKd8c.js";import{g as Ze,c as Vt,d as ta,D as Et,m as ea}from"./reservationsService.DZ-N01gk.js";import{i as aa}from"./dashboardShell.DF2kUed9.js";import"./view.Dbljb8vp.js";Ne({ar:{"customerDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.title":"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.hero.subtitle":"ğŸ‘‹ Ù‡Ø°Ù‡ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.fields.taxId":"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:","customerDetails.fields.document":"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.reservations":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.stats.upcoming":"Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.projects":"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerDetails.stats.projectsEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.stats.lastActivity":"Ø¢Ø®Ø± Ù†Ø´Ø§Ø·","customerDetails.stats.lastActivityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.reservationsDesc":"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ","customerDetails.stats.upcomingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.nextReservation":"Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}","customerDetails.stats.projectsDesc":"Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.payment":"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentBreakdown":"Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentPaid":"Ø§Ù„Ù…Ø¯ÙÙˆØ¹","customerDetails.stats.paymentOutstandingLabel":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.totalValue":"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: {amount}","customerDetails.stats.totalValueEmpty":"Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ù…Ø¨Ø§Ù„Øº Ø¨Ø¹Ø¯.","customerDetails.stats.paymentOutstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}","customerDetails.stats.paymentAllSet":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.paymentOutstandingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.activityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.activityOn":"Ø¨ØªØ§Ø±ÙŠØ® {date}","customerDetails.stats.activityType.reservation":"Ø­Ø¬Ø²","customerDetails.stats.activityType.project":"Ù…Ø´Ø±ÙˆØ¹","customerDetails.stats.activityType.customer":"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.complianceEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©","customerDetails.stats.complianceProjects":"Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}","customerDetails.stats.complianceLabel.excellent":"Ø§Ù„ØªØ²Ø§Ù… Ù…Ù…ØªØ§Ø²","customerDetails.stats.complianceLabel.good":"Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯","customerDetails.stats.complianceLabel.average":"ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©","customerDetails.stats.complianceLabel.poor":"ØªØ£Ø®ÙŠØ± Ù…ØªÙƒØ±Ø±","customerDetails.document.open":"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯","customerDetails.document.defaultName":"Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·","customerDetails.primaryNav.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.primaryNav.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerTabs.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.customerReservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerTabs.customerProjects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","customerDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²...","customerDetails.fields.name":"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:","customerDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","customerDetails.fields.company":"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:","customerDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","customerDetails.fields.address":"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:","customerDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","customerDetails.toast.missingRequired":"âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†","customerDetails.toast.notFound":"âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","customerDetails.toast.updateSuccess":"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...","customerDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.loadFailed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","customerDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"ğŸ‘¤ Client Profile","customerDetails.hero.subtitle":"ğŸ‘‹ Here is a quick look at this client","customerDetails.fields.taxId":"ğŸ§¾ Tax Number:","customerDetails.fields.document":"ğŸ“ Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"ğŸ“… Booking Management","customerDetails.primaryNav.projects":"ğŸ“ Project Management","customerTabs.reservations":"ğŸ“… Booking Management","customerTabs.projects":"ğŸ“ Project Management","customerTabs.customerReservations":"ğŸ“… Client Reservations","customerTabs.customerProjects":"ğŸ“ Client Projects","customerDetails.actions.back":"â¬…ï¸ Back","customerDetails.actions.edit":"âœï¸ Edit Client","customerDetails.filters.search":"ğŸ” Search by client or reservation ID...","customerDetails.fields.name":"ğŸ‘¤ Name:","customerDetails.fields.phone":"ğŸ“ Phone:","customerDetails.fields.company":"ğŸ¢ Company:","customerDetails.fields.email":"ğŸ“§ Email:","customerDetails.fields.address":"ğŸ“ Address:","customerDetails.fields.notes":"ğŸ“ Notes:","customerDetails.toast.missingRequired":"âš ï¸ Name and phone are required","customerDetails.toast.notFound":"âš ï¸ Client not found","customerDetails.toast.updateSuccess":"âœ… Client information updated","customerDetails.status.loading":"â³ Loading client information...","customerDetails.errors.notFound":"âš ï¸ This client could not be found.","customerDetails.errors.loadFailed":"âš ï¸ Failed to load client information.","customerDetails.errors.missingId":"âš ï¸ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"âœï¸ Edit Client","customerProjects.title":"ğŸ“ Client Projects","customerProjects.empty":"No projects are linked to this client."}});let qt={},x={initialized:!1,currentId:null,modal:{el:null,body:null}};function zt(t=""){return A(String(t)).trim().toLowerCase()}function Ee(t,a,e){if(!a||!e)return;const{startDate:n,endDate:s}=Qt(t);a._flatpickr?n?a._flatpickr.setDate(n,!1,"Y-m-d"):a._flatpickr.clear():a.value=n||"",e._flatpickr?s?e._flatpickr.setDate(s,!1,"Y-m-d"):e._flatpickr.clear():e.value=s||""}function ne(t,{endOfDay:a=!1}={}){if(!t)return null;const e=String(t).trim();if(!e)return null;const n=e.includes("T")?e:`${e}T00:00:00`,s=new Date(n);return Number.isNaN(s.getTime())?null:(a?s.setHours(23,59,59,999):s.setHours(0,0,0,0),s)}function Ht(t){const a=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const e of a){if(!e)continue;const n=new Date(e);if(!Number.isNaN(n.getTime()))return n.setHours(0,0,0,0),n}return null}function Rt(t){if(!document.getElementById("customer-reservations"))return;const e=document.getElementById("customer-search-reservation"),n=document.getElementById("customer-filter-start-date"),s=document.getElementById("customer-filter-end-date"),i=document.getElementById("customer-reservation-date-range"),c=document.getElementById("customer-reservation-status-filter"),v=document.getElementById("customer-clear-filters");window.flatpickr&&(n&&window.flatpickr(n,{dateFormat:"Y-m-d"}),s&&window.flatpickr(s,{dateFormat:"Y-m-d"}));const u=()=>{let m=A(n?.value||"").trim(),h=A(s?.value||"").trim(),f=i?.value||"";if(new Set(["","today","week","month"]).has(f)||(f="",i&&(i.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),m="",h=""),!m&&!h&&f){const{startDate:j,endDate:k}=Qt(f);m=j,h=k}return{searchTerm:zt(e?.value||""),startDate:m,endDate:h,status:c?.value||"",quickRange:f,customerId:t}},g=()=>{qt=u(),se("customer-reservations",qt)};e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=A(e.value),g()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{i&&(i.value=""),g()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{i&&(i.value=""),g()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Ee(i.value,n,s),g()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",g),c.dataset.listenerAttached="true"),v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{e&&(e.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i.value=""),c&&(c.value=""),g()}),v.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{se("customer-reservations",qt)},g()}function vt(t){x.currentId=t;const{container:a}=ft();a&&(x.initialized||(na(),sa(),ia(),document.addEventListener("projects:changed",()=>{x.currentId&&w()}),document.addEventListener("language:changed",()=>{x.currentId&&w()}),document.addEventListener("technicians:updated",()=>{x.currentId&&w()}),x.initialized=!0),w())}function ft(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function na(){const{searchInput:t,statusSelect:a,clearBtn:e,startInput:n,endInput:s,rangeSelect:i}=ft();window.flatpickr&&(n&&!n.dataset.datepickerAttached&&(window.flatpickr(n,{dateFormat:"Y-m-d"}),n.dataset.datepickerAttached="true"),s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=A(t.value),w()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{w()}),a.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{n.value=A(n.value),i&&(i.value=""),w()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=A(s.value),i&&(i.value=""),w()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{Ee(i.value,n,s),w()}),i.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{const{searchInput:c,statusSelect:v,startInput:u,endInput:g,rangeSelect:m}=ft();c&&(c.value=""),v&&(v.value=""),m&&(m.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),g&&(g._flatpickr&&g._flatpickr.clear(),g.value=""),w()}),e.dataset.listenerAttached="true")}function sa(){const{container:t}=ft();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",ra),t.dataset.projectModalListenerAttached="true")}function ra(t){const a=t.target.closest(".project-focus-card");if(!a||t.target.closest("[data-ignore-project-modal]"))return;const n=a.dataset.projectId?String(a.dataset.projectId):"";n&&_t(n)}function ia(){Jt()}function Jt(){if(x.modal?.el&&x.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");if(!t||!a){const s=document.createElement("div");s.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${d("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(s.firstElementChild)}const e=document.getElementById("projectDetailsModal"),n=document.getElementById("project-details-body");return!e||!n?!1:(x.modal={el:e,body:n},!0)}function w(){const{container:t,searchInput:a,statusSelect:e,startInput:n,endInput:s,rangeSelect:i}=ft();if(!t||!x.currentId)return;const c=zt(a?.value||""),v=e?.value||"";let u=A(n?.value||"").trim(),g=A(s?.value||"").trim(),m=i?.value||"";if(new Set(["","today","week","month"]).has(m)||(m="",i&&(i.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),u="",g=""),!u&&!g&&m){const{startDate:o,endDate:E}=Qt(m);u=o,g=E}const f=ne(u),p=ne(g,{endOfDay:!0}),{projects:j=[],technicians:k=[],reservations:_=[],customers:b=[]}=K(),T=new Map(k.map(o=>[String(o.id),o])),N=oa(_),I=b.find(o=>String(o.id)===String(x.currentId))||null,S=j.filter(o=>String(o.clientId)===String(x.currentId)).filter(o=>{if(c){const E=[o.id,o.projectId,o.project_id,o.projectCode,o.project_code].map(r=>r==null?"":A(String(r)));if(!zt([o.title,o.description,o.notes,...E].filter(Boolean).join(" ")).includes(c))return!1}if(v&&He(o)!==v)return!1;if(f||p){const E=Ht(o);if(!E||f&&E<f||p&&E>p)return!1}return!0}).sort((o,E)=>{const P=Ht(o)?.getTime()||0;return(Ht(E)?.getTime()||0)-P});if(!S.length){const o=d("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${o}</div></div>`;return}t.innerHTML=S.map(o=>{const E=Ct(o),P=E?N.get(E)||[]:[];return Ve(o,{customer:I,techniciansMap:T,reservations:P})}).join(""),t.querySelectorAll(".project-focus-card").forEach(o=>{o.dataset.customerModalListenerAttached!=="true"&&(o.addEventListener("click",E=>{if(E.target.closest("[data-ignore-project-modal]"))return;const r=o.dataset.projectId?String(o.dataset.projectId):"";r&&_t(r)}),o.dataset.customerModalListenerAttached="true")})}function oa(t=[]){const a=new Map;return t.forEach(e=>{const n=e?.projectId??e?.project_id??e?.projectID;if(n==null)return;const s=String(n);a.has(s)||a.set(s,[]),a.get(s).push(e)}),a}function _t(t){const a=String(t||"").trim();if(!a||!Jt())return;const e=x.modal;if(!e?.body)return;e.body.dataset.mode="view";const{projects:n=[],reservations:s=[],customers:i=[]}=K(),c=ma(n,a);if(!c||x.currentId&&c.clientId!=null&&String(c.clientId)!==String(x.currentId))return;const v=i.find(m=>String(m.id)===String(c.clientId))||null,u=s.filter(m=>{const h=pa(m);return h&&h===a}),g=ze(c,{customer:v,reservations:u});e.body.innerHTML=g,ca(c),la(e.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e.el).show():(e.el.classList.add("show"),e.el.style.display="block")}function ca(t){if(!t||!x.modal?.body)return;const a=x.modal.body.querySelector('[data-action="edit-project"]');a&&a.addEventListener("click",e=>{e.preventDefault(),da(t)})}function la(t){if(!t)return;const a=t.querySelectorAll('[data-action="view-reservation"]');if(!a.length)return;async function e(n){if(!Number.isInteger(n)||n<0)return!1;const s=Me("showReservationDetails");if(typeof s=="function")return s(n),!0;try{const i=await $e("showReservationDetails");if(typeof i=="function")return i(n),!0}catch(i){console.warn("âš ï¸ [customerDetails] Unable to resolve reservation UI handler",i)}return!1}a.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();const i=Ze();let c=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(c)||c<0){const u=n.dataset.reservationId;u&&(c=i.findIndex(m=>[m?.id,m?.reservationId,m?.reservation_id].some(f=>f!=null&&String(f)===u)))}await e(c)||B(d("projects.details.reservations.viewUnavailable","ØªØ¹Ø°Ø± ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"))}),n.dataset.listenerAttached="true")})}function da(t){if(!t||!Jt())return;const a=x.modal;if(!a?.body)return;const{customers:e=[]}=K(),n=e.find(c=>String(c.id)===String(t.clientId))||null,s=n?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||n?.companyName||n?.company||"";a.body.dataset.mode="edit",a.body.innerHTML=Oe(t,{clientName:s,clientCompany:i}),ua(t,{clientName:s,clientCompany:i})}function ua(t,{clientName:a="",clientCompany:e=""}={}){if(!t||!x.modal?.body)return;const n=x.modal.body,s=n.querySelector("#customer-project-edit-form")||n.querySelector("#project-details-edit-form");if(!s)return;const i=s.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",S=>{S.preventDefault();const o=Ct(t);o&&_t(o)});const c=s.querySelector("#project-edit-expense-label"),v=s.querySelector("#project-edit-expense-amount"),u=s.querySelector("#project-edit-expense-note"),g=s.querySelector('[data-action="add-expense"]'),m=s.querySelector("#project-edit-expense-list");s.querySelector('[name="project-start-date"]'),s.querySelector('[name="project-start-time"]'),s.querySelector('[name="project-end-date"]'),s.querySelector('[name="project-end-time"]');const h=s.querySelector("#project-edit-payment-status"),f=s.querySelector("#project-edit-tax"),p=s.querySelector("#project-edit-company-share"),j=s.querySelector("#project-edit-discount-type"),k=s.querySelector("#project-edit-discount"),_=s.querySelector("#project-edit-payment-progress-type"),b=s.querySelector("#project-edit-payment-progress-value"),T={expenses:Array.isArray(t?.expenses)?t.expenses.map(S=>({...S})):[]};let N=!1;const I=S=>{!f||!p||N||(N=!0,S==="share"?p.checked?(f.checked||(f.checked=!0),Mt(p,Et)):f.checked&&(f.checked=!1):S==="tax"&&(f.checked?Mt(p,Et):p.checked&&(p.checked=!1)),N=!1)},$=()=>{m&&(m.innerHTML=Ye(T.expenses))};$(),g&&!g.dataset.listenerAttached&&(g.addEventListener("click",S=>{S.preventDefault();const o=c?.value.trim()||"",E=A(v?.value||"0"),P=Number(E);if(!o){B(d("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),c?.focus();return}if(!Number.isFinite(P)||P<=0){B(d("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),v?.focus();return}T.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:o,amount:P,note:(u?.value||"").trim()}),c&&(c.value=""),v&&(v.value=""),u&&(u.value=""),$()}),g.dataset.listenerAttached="true"),m&&!m.dataset.listenerAttached&&(m.addEventListener("click",S=>{const o=S.target.closest('[data-action="remove-expense"]');if(!o)return;const{id:E}=o.dataset;T.expenses=T.expenses.filter(P=>String(P.id)!==String(E)),$()}),m.dataset.listenerAttached="true"),k&&!k.dataset.listenerAttached&&(k.addEventListener("input",S=>{const o=S.target;o instanceof HTMLInputElement&&(o.value=A(o.value||""))}),k.dataset.listenerAttached="true"),b&&!b.dataset.listenerAttached&&(b.addEventListener("input",S=>{const o=S.target;o instanceof HTMLInputElement&&(o.value=A(o.value||""))}),b.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("change",()=>{h.dataset.userSelected="true"}),h.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>I("share")),p.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>I("tax")),f.dataset.listenerAttached="true"),p?.checked&&Mt(p,Et),I(p?.checked?"share":"tax"),s.addEventListener("submit",async S=>{if(S.preventDefault(),s.dataset.submitting==="true")return;const o=new FormData(s),E=(o.get("project-title")||"").toString().trim(),P=(o.get("project-type")||"").toString().trim(),r=(o.get("project-start-date")||"").toString().trim(),l=(o.get("project-start-time")||"").toString().trim(),D=(o.get("project-end-date")||"").toString().trim(),nt=(o.get("project-end-time")||"").toString().trim(),Q=(o.get("project-description")||"").toString().trim(),Dt=(o.get("project-payment-status")||"unpaid").toString().toLowerCase(),st=["paid","partial"].includes(Dt)?Dt:"unpaid",J=f?.checked===!0;if(!E||!P||!r){B(d("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"));return}const rt=ee(r,l),G=D?ee(D,nt):"";if(G){const F=new Date(rt),q=new Date(G);if(!Number.isNaN(F.getTime())&&!Number.isNaN(q.getTime())&&F>q){B(d("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"));return}}const Z=Ct(t);if(!Z){B(d("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const it=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,Ae=T.expenses.reduce((F,q)=>F+(Number(q.amount)||0),0),Zt=j?.value==="amount"?"amount":"percent",Ie=A(k?.value||"0");let ot=Number.parseFloat(Ie);(!Number.isFinite(ot)||ot<0)&&(ot=0);const ct=p?.checked===!0;let lt=ct?we(p):null;(!Number.isFinite(lt)||lt<=0)&&(lt=ct&&J?Et:null);const dt=Fe({equipmentEstimate:it,expensesTotal:Ae,discountValue:ot,discountType:Zt,applyTax:J,companyShareEnabled:ct,companySharePercent:lt}),xe=_?.value==="amount"?"amount":"percent",te=A(b?.value||""),je=te?Number.parseFloat(te):null,tt=Vt({totalAmount:dt.totalWithTax,progressType:xe,progressValue:je,history:[]}),wt=h?.dataset?.userSelected==="true",ke=ta({manualStatus:wt?st:null,paidAmount:tt.paidAmount,paidPercent:tt.paidPercent,totalAmount:dt.totalWithTax}),Ft=wt?st:ke;!wt&&h&&(h.value=Ft),h?.dataset&&delete h.dataset.userSelected;const Te=Je({projectCode:t.projectCode,title:E,type:P,clientId:t.clientId,clientCompany:e,description:Q,start:rt,end:G||null,applyTax:J,paymentStatus:Ft,equipmentEstimate:it,expenses:T.expenses,discount:ot,discountType:Zt,companyShareEnabled:ct&&J,companySharePercent:ct&&J?lt:null,companyShareAmount:dt.companyShareAmount,taxAmount:dt.taxAmount,totalWithTax:dt.totalWithTax,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[],paidAmount:tt.paidAmount,paidPercentage:tt.paidPercent,paymentProgressType:tt.paymentProgressType,paymentProgressValue:tt.paymentProgressValue}),R=s.querySelector('button[type="submit"]');R&&(R.disabled=!0,R.dataset.originalText=R.textContent||"",R.textContent=d("projects.details.edit.saving","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...")),s.dataset.submitting="true";try{const F=await Xe(Z,Te);await We(Z,Ft),document.dispatchEvent(new CustomEvent("projects:changed")),B(d("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),w();const q=Ct(F)||Z;q&&_t(q)}catch(F){console.error("âŒ [customerDetails] Failed to update project from customer modal",F);const q=typeof F?.message=="string"?F.message:d("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");B(q,"error")}finally{delete s.dataset.submitting,R&&(R.disabled=!1,R.dataset.originalText&&(R.textContent=R.dataset.originalText,delete R.dataset.originalText))}})}function ma(t=[],a){const e=String(a);return t.find(n=>[n?.id,n?.projectId,n?.project_id].some(i=>i!=null&&String(i)===e))||null}function pa(t){if(!t)return null;const a=t.projectId??t.project_id??t.projectID??null;return a!=null?String(a):null}async function se(t,a){try{const e=await De(()=>import("./reservationsUI.B5dITXmB.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url);try{e.renderReservations?.(t,a)}catch(n){console.error("âŒ [customer-details] renderReservations failed",n)}}catch(e){console.error("âŒ [customer-details] Failed to load reservations UI module",e)}}Pe();Le();Ce();aa();_e();const bt=document.getElementById("logout-btn");bt&&!bt.dataset.listenerAttached&&(bt.addEventListener("click",()=>Be()),bt.dataset.listenerAttached="true");qe({showReservationDetails(t){De(()=>import("./reservationsUI.B5dITXmB.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url).then(a=>{try{a.showReservationDetails?.(t)}catch(e){console.error("âŒ showReservationDetails failed",e)}}).catch(a=>console.error("âŒ Failed to load reservations UI module",a))}});const fa=new URLSearchParams(window.location.search),L=fa.get("id"),X=document.getElementById("customer-details"),re=document.getElementById("customer-hero-name"),ya=document.getElementById("customer-hero-phone"),ga=document.getElementById("customer-hero-company"),ha=document.getElementById("customer-hero-email"),va=document.getElementById("customer-hero-tax"),ie=document.getElementById("customer-hero-summary"),oe=document.getElementById("dashboard-greeting-customer-name"),ce=document.getElementById("dashboard-greeting-customer-company"),St=document.getElementById("customer-stat-projects"),At=document.getElementById("customer-stat-projects-desc"),It=document.getElementById("customer-stat-payment"),xt=document.getElementById("customer-stat-payment-desc"),jt=document.getElementById("customer-stat-upcoming"),kt=document.getElementById("customer-stat-upcoming-desc"),ut=document.getElementById("customer-stat-activity"),Tt=document.getElementById("customer-stat-activity-desc"),Nt=document.getElementById("customer-stat-compliance"),mt=document.getElementById("customer-stat-compliance-desc"),le=document.getElementById("sidebar-stat-projects"),de=document.getElementById("sidebar-stat-reservations"),ue=document.getElementById("sidebar-stat-equipment"),me=document.getElementById("sidebar-stat-technicians"),Xt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),Ot=Array.from(document.querySelectorAll("[data-customer-tab]")),Da=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),W=document.getElementById("edit-document-file"),at=document.getElementById("edit-document-preview"),pe=document.getElementById("edit-document-file-name"),yt=document.getElementById("edit-document-url"),gt=document.getElementById("edit-document-name");let C=null,H="idle",V=null;Xt.forEach(t=>{t.disabled=!0});let y=null,pt=!1,z="",Gt="reservations";function M(t=""){const a=document.createElement("div");return a.textContent=t==null?"":String(t),a.innerHTML}function Ea(t=""){const a=M(t).replace(/\r/g,""),e=`
`;return a.includes(e)?a.split(e).join("<br>"):a}function ba(t=null){V=t&&typeof t=="object"?{...t}:null,C=null,H="idle",W&&(W.value=""),et()}function et(){if(!pe||!at)return;const t=H==="uploading",a=!!C?.dataUrl;let e=d("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?e=d("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):H==="error"?e=d("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):a?e=C?.fileName||d("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):V&&(V.fileName||V.url)&&(e=V.fileName||V.url),pe.textContent=e;const n=a||!!V?.url;at.disabled=t||!n}function Sa(){if(!W)return;const[t]=W.files||[];if(!t){H="idle",C=null,et();return}H="uploading",et();const a=new FileReader;a.onload=()=>{if(typeof a.result!="string"){H="error",C=null,et();return}C={dataUrl:a.result,fileName:t.name,mimeType:t.type,size:t.size},yt&&(yt.value=a.result),gt&&(gt.value=t.name),H="success",et()},a.onerror=()=>{H="error",C=null,et()},a.readAsDataURL(t)}W&&!W.dataset.listenerAttached&&(W.addEventListener("change",Sa),W.dataset.listenerAttached="true");at&&!at.dataset.listenerAttached&&(at.addEventListener("click",()=>{if(H==="uploading")return;const t=C?.dataUrl||V?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),at.dataset.listenerAttached="true");function Pt(t,a,e,{hideWhenEmpty:n=!1}={}){if(!t)return;const s=e==null?"":String(e).trim(),i=s.length>0,c=i?s:"â€”";t.textContent=`${a} ${c}`,n?t.classList.toggle("hidden",!i):t.classList.remove("hidden")}function Wt(t){const a=d("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),e=t?.customerName||"â€”",n=t?.phone?A(t.phone):"",s=t?.companyName||"",i=t?.email||"",c=t?.tax_id??t?.taxId??"";if(re&&(re.textContent=e),ie&&(ie.textContent=e!=="â€”"?e:a),Pt(ya,"ğŸ“",n,{hideWhenEmpty:!1}),Pt(ga,"ğŸ¢",s,{hideWhenEmpty:!0}),Pt(ha,"ğŸ“§",i,{hideWhenEmpty:!0}),Pt(va,"ğŸ§¾",c,{hideWhenEmpty:!0}),oe&&(oe.textContent=e),ce){const v=[];s&&v.push(s),n&&v.push(`ğŸ“ ${n}`);const u=typeof c=="string"?c.trim():String(c||"").trim();u&&v.push(`ğŸ§¾ ${u}`),ce.textContent=v.length?v.join(" â€¢ "):"â€”"}}function Aa(t){if(t?.preventDefault?.(),!y)return;wa();const a=document.getElementById("editCustomerModal"),e=typeof bootstrap<"u"?bootstrap.Modal:null;if(!a||!e)return;(e.getInstance(a)||new e(a)).show()}function Ia(){Xt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Aa),t.dataset.listenerAttached="true")})}function Yt(t){Xt.forEach(a=>{a&&(a.disabled=!!t)})}Ia();function Kt(t){t&&(Gt=t,Ot.forEach(a=>{const e=a?.getAttribute("data-customer-tab")===t;a&&(a.classList.toggle("tab-active",e),a.classList.toggle("active",e),a.setAttribute("aria-selected",String(e)))}),Da.forEach((a,e)=>{a&&a.classList.toggle("hidden",e!==t)}),t==="projects"&&L&&y&&vt(L))}function xa(){Ot.length&&(Ot.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const a=t.getAttribute("data-customer-tab");a&&Kt(a)}),t.dataset.listenerAttached="true")}),Kt(Gt))}xa();function be(t={}){if(!t||typeof t!="object")return null;const a=[t.document,t.attachment,t.file].find(N=>N&&typeof N=="object"),e=N=>{for(const I of N)if(typeof I=="string"&&I.trim()!=="")return I.trim();return""},n=N=>{for(const I of N){if(typeof I=="number"&&Number.isFinite(I))return Math.max(0,Math.trunc(I));if(typeof I=="string"&&I.trim()!==""&&/^\d+$/.test(I.trim()))return Math.max(0,parseInt(I.trim(),10))}return null},s=[t.document_url,t.documentUrl,t.url,t.href,t.link,a?.url,a?.href,a?.link],i=[t.document_path,t.documentPath,t.path,a?.path,a?.documentPath],c=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,a?.fileName,a?.filename,a?.name],v=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,a?.mimeType,a?.contentType,a?.type],u=[t.document_size,t.documentSize,t.size,a?.size,a?.length],g=[a?.data,a?.base64,a?.content,t.data,t.base64,t.content,t.document_data],m=e(s),h=e(c),f=e(v)||"application/octet-stream",p=e(i),j=e(g),k=n(u);if(!m&&!j)return null;let _=m,b=j;if(!_&&b&&b.startsWith("data:")){const N=b.indexOf(",");N!==-1&&(_=b,b=b.slice(N+1))}!_&&b&&(_=`${b.startsWith("data:")?"":`data:${f};base64,`}${b}`);const T={url:_,fileName:h,mimeType:f,path:p,data:b||null,size:k};return T.url&&/sirv\.com/i.test(T.url)&&(T.source="sirv"),T}function ja(){return document.documentElement.getAttribute("lang")||"ar"}function U(t){const a=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(a)}catch{return String(a)}}function fe(t){if(!t)return"â€”";const a=t instanceof Date?t:new Date(t);if(Number.isNaN(a.getTime()))return"â€”";const n=ja()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(n,{dateStyle:"medium"}).format(a)}catch{const i=String(a.getMonth()+1).padStart(2,"0"),c=String(a.getDate()).padStart(2,"0"),v=a.getFullYear();return`${i}/${c}/${v}`}}function ye(t){if(!t)return"";const a=t.trim().split(/\s+/),e=a.pop()||"";return`<span class="currency-amount">${a.join(" ")}</span> <span class="currency-unit currency-unit--sm">${e}</span>`}function ge(t,a){const e=d("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),n=d("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${e}</span>
      ${ye(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${n}</span>
      ${ye(a)}
    </div>
  `}const he={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},ka={reservation:"Reservation",project:"Project",customer:"Client record"};function Ut(t=[]){let a=null;return t.forEach(e=>{if(!e)return;const n=e instanceof Date?e:new Date(e);Number.isNaN(n.getTime())||(!a||n>a)&&(a=n)}),a}function Ta(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function ve({projects:t=0,reservations:a=0,equipment:e=0,technicians:n=0}={}){le&&(le.textContent=U(t)),de&&(de.textContent=U(a)),ue&&(ue.textContent=U(e)),me&&(me.textContent=U(n))}function Y(){if(!y||!L){const r=$t(0);if(St&&(St.textContent="0"),At&&(At.textContent=d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),It&&(It.innerHTML=ge(r,r)),xt){const l=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),D=d("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");xt.textContent=`${l} â€¢ ${D}`}jt&&(jt.textContent="0"),kt&&(kt.textContent=d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),ut&&(ut.textContent="â€”"),Tt&&(Tt.textContent=d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Nt&&(Nt.textContent="0%"),mt&&(mt.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),ve({projects:0,reservations:0,equipment:0,technicians:0});return}const t=K(),e=(Array.isArray(t.reservations)?t.reservations:[]).filter(r=>r?[r.customerId,r.customer_id,r.customer?.id].some(D=>D!=null&&String(D)===String(L)):!1),n=e.length,s=Date.now(),i=e.filter(r=>{const l=r?.start??r?.startDatetime??r?.start_datetime??r?.start_date;if(!l)return!1;const D=new Date(l);return Number.isNaN(D.getTime())?!1:D.getTime()>=s}),c=i.map(r=>r?.start??r?.startDatetime??r?.start_datetime).map(r=>new Date(r)).filter(r=>!Number.isNaN(r.getTime())).sort((r,l)=>r-l)[0]||null,u=(Array.isArray(t.projects)?t.projects:[]).filter(r=>r?[r.clientId,r.client_id,r.customer_id].some(D=>D!=null&&String(D)===String(L)):!1),g=u.length,m=e.filter(r=>{const l=String(r?.status||r?.reservationStatus||"").toLowerCase();return!(l==="cancelled"||l==="canceled"||l==="Ù…Ù„ØºÙŠ"||l==="Ù…Ù„ØºÙ‰"||l==="Ù…Ù„ØºÙŠØ©")}),h=new Map;m.forEach(r=>{const l=r?.projectId??r?.project_id??null;if(l==null)return;const D=String(l);h.has(D)||h.set(D,[]),h.get(D).push(r)});let f=0,p=0,j=0,k=0;u.forEach(r=>{const l=Ke(r)||{},D=r?.id??r?.projectId??r?.project_id??null,Q=(D!=null?h.get(String(D))||[]:[]).reduce((Z,it)=>Z+(Number(it?.totalAmount)||ae(it)||0),0),Dt=l.applyTax?Number(((Number(l.subtotal||0)+Q)*Qe).toFixed(2)):0,st=Number((Number(l.subtotal||0)+Q+Dt).toFixed(2)),J=Vt({totalAmount:st,paidAmount:Number(r?.paidAmount)||null,paidPercent:Number(r?.paidPercent)||null}),rt=Math.max(0,Number(J.paidAmount||0)),G=Math.max(0,Number((st-rt).toFixed(2)));f+=rt,p+=G,k+=1,G<=.5&&(j+=1)}),m.filter(r=>r?.projectId==null&&r?.project_id==null).forEach(r=>{const l=Number(r?.totalAmount)||ae(r)||0,D=Vt({totalAmount:l,paidAmount:Number(r?.paidAmount)||null,paidPercent:Number(r?.paidPercent)||null,progressType:r?.paymentProgressType??null,progressValue:r?.paymentProgressValue??null,history:Array.isArray(r?.paymentHistory)?r.paymentHistory:[]}),nt=Math.max(0,Number(D.paidAmount||0)),Q=Math.max(0,Number((l-nt).toFixed(2)));f+=nt,p+=Q,k+=1,Q<=.5&&(j+=1)});const b=k>0?Math.round(j/k*100):0,T=[];if(e.forEach(r=>{const l=Ut([r?.updatedAt,r?.updated_at,r?.end,r?.endDatetime,r?.end_datetime,r?.start,r?.startDatetime,r?.start_datetime,r?.createdAt,r?.created_at]);l&&T.push({date:l,type:"reservation"})}),u.forEach(r=>{const l=Ut([r?.updatedAt,r?.updated_at,r?.end,r?.end_datetime,r?.start,r?.start_datetime,r?.createdAt,r?.created_at]);l&&T.push({date:l,type:"project"})}),!T.length){const r=Ut([y?.updated_at,y?.updatedAt,y?.created_at,y?.createdAt]);r&&T.push({date:r,type:"customer"})}const N=T.reduce((r,l)=>r?l.date>r.date?l:r:l,null),I=N?.date??null,$=N?.type??null,S=e.reduce((r,l)=>Array.isArray(l?.items)?r+l.items.length:r,0),o=new Set;e.forEach(r=>{Array.isArray(r?.technicians)&&r.technicians.forEach(l=>{const D=l!=null?String(l):"";D&&o.add(D)}),Array.isArray(r?.techniciansDetails)&&r.techniciansDetails.forEach(l=>{const D=l?.id??l?.technician_id??l?.technicianId;D!=null&&o.add(String(D))})}),St&&(St.textContent=U(g)),At&&(At.textContent=g>0?d("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const E=$t(f),P=$t(p);if(It&&(It.innerHTML=ge(E,P)),xt){const r=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),l=p>0?d("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",P):d("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");xt.textContent=`${r} â€¢ ${l}`}if(jt&&(jt.textContent=U(i.length)),kt&&(kt.textContent=i.length>0&&c?d("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",fe(c)):d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),ut)if($){const r=d(`customerDetails.stats.activityType.${$}`,ka[$]||$);ut.textContent=r}else ut.textContent="â€”";if(Tt&&(Tt.textContent=I?d("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",fe(I)):d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Nt&&(Nt.textContent=`${U(b)}%`),mt)if(k>0){const r=b>=90?"excellent":b>=70?"good":b>=40?"average":"poor",l=r?d(`customerDetails.stats.complianceLabel.${r}`,he[r]||he.poor):"",D=d("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",U(j)).replace("{total}",U(k));mt.textContent=l?`${l} â€¢ ${D}`:D}else mt.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");ve({projects:g,reservations:n,equipment:S,technicians:o.size})}function Na(t){const{customers:a}=K();if(!Array.isArray(a))return null;const e=a.find(c=>String(c.id)===String(t));if(!e)return null;const n=e.tax_id??e.taxId??"",s=typeof n=="string"?n.trim():String(n||"").trim(),i=e.document??be(e);return{...e,tax_id:s,taxId:s,document:i}}function Pa(t={}){if(!t||typeof t!="object")return null;const a=t.id??t.customerId??t.customer_id??null,e=t.full_name??t.customerName??t.name??"",n=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",s=typeof n=="string"?n.trim():String(n||"").trim(),i=be(t);return a==null?null:{id:String(a),customerName:e,full_name:e,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:s,taxId:s,document:i,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function La(t){if(!t)return;const a=K(),e=Array.isArray(a.customers)?[...a.customers]:[],n=e.findIndex(s=>String(s.id)===String(t.id));n>=0?e[n]={...e[n],...t}:e.push(t),ht({customers:e})}async function Ca(){const{technicians:t}=K();if(!(Array.isArray(t)&&t.length>0))try{const a=await Bt("/technicians/"),e=Array.isArray(a?.data)?a.data.map(Ue):[];e.length>0&&ht({technicians:e})}catch(a){console.warn("âš ï¸ Failed to load technicians list",a)}}async function _a(t){if(t)try{const a=new URLSearchParams({customer_id:String(t),limit:"200"}),e=await Bt(`/reservations/?${a.toString()}`),n=Array.isArray(e?.data)?e.data.map(ea):[];ht({reservations:n})}catch(a){console.warn("âš ï¸ Failed to load customer reservations",a)}}async function Ba(t){if(t)try{const a=new URLSearchParams({client_id:String(t),limit:"200"}),e=await Bt(`/projects/?${a.toString()}`),n=Array.isArray(e?.data)?e.data.map(Ge):[];ht({projects:n})}catch(a){console.warn("âš ï¸ Failed to load customer projects",a)}}async function Ra(t,{showSpinner:a=!1}={}){if(t){a?(pt=!0,z="",O()):(pt=!0,z="");try{const e=await Bt(`/customers/?id=${encodeURIComponent(t)}`),n=e?.data??e,s=Pa(n);if(!s)throw new Error("Invalid customer payload received from server");y=s,La(s),pt=!1,z="",O(),await Ca(),await Promise.all([_a(s.id),Ba(s.id)]),Rt(s.id),vt(s.id),Y()}catch(e){if(pt=!1,e instanceof Re&&e.status===404){y=null,z="",O();return}console.error("âš ï¸ Failed to load customer details",e);const n=d("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");y?(z="",B(n),O()):(z=`${n}${e?.message?` (${e.message})`:""}`,O())}}}function O(){if(!X)return;if(Kt(Gt),!y){if(Wt(null),Yt(!0),Y(),pt){X.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(z){X.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${M(z)}</div>
        </div>
      `;return}const e=d("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");X.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${M(e)}</div>
      </div>
    `;return}Wt(y),Yt(!1);const a=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:y.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:y.phone?A(y.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:y.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:y.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:y.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:y.tax_id??y.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:y.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:y.document??null,type:"document"}].map(e=>{const n=d(e.key,e.fallback);if(e.type==="document"){const u=e.value;let g='<span class="text-base-content/50">â€”</span>';if(u&&typeof u=="object"){const m=u.fileName?.trim()||u.path?.trim()||u.url||"";if(u.url){const h=M(m||d("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),f=Ta(u.url),p=M(d("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));g=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${h}</span><a class="btn btn-outline btn-sm" href="${f}" target="_blank" rel="noopener noreferrer">${p}</a></div>`}else m&&(g=`<span class="text-base-content break-all">${M(m)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${M(n)}</span>
          <div class="mt-2">${g}</div>
        </article>
      `}const i=(e.value==null?"":String(e.value)).trim(),c=i.length>0?i:"â€”",v=e.multiline?Ea(c):M(c);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${M(n)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${v}</p>
      </article>
    `}).join("");X.innerHTML=a,Y()}function wa(){document.getElementById("edit-id").value=y?.id||"",document.getElementById("edit-name").value=y?.customerName||"",document.getElementById("edit-phone").value=A(y?.phone||""),document.getElementById("edit-company").value=y?.companyName||"",document.getElementById("edit-email").value=y?.email||"",document.getElementById("edit-address").value=y?.address||"",document.getElementById("edit-tax-id").value=A(y?.tax_id??y?.taxId??"");const t=y?.document??null;yt&&(yt.value=t?.url||""),gt&&(gt.value=t?.fileName||""),ba(t),document.getElementById("edit-notes").value=y?.notes||""}const Lt=document.getElementById("save-edit-btn");Lt&&!Lt.dataset.listenerAttached&&(Lt.addEventListener("click",()=>{if(!y)return;const t=document.getElementById("edit-id").value,a=document.getElementById("edit-name").value.trim(),e=A(document.getElementById("edit-phone").value.trim()),n=document.getElementById("edit-company").value.trim(),s=document.getElementById("edit-email").value.trim(),i=document.getElementById("edit-address").value.trim(),c=A(document.getElementById("edit-tax-id").value.trim()),v=(yt?.value||"").trim(),u=(gt?.value||"").trim(),g=document.getElementById("edit-notes").value.trim();if(!a||!e){B(d("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const m=K(),h=Array.isArray(m.customers)?m.customers:[],f=h.findIndex(_=>String(_.id)===String(t));if(f===-1){B(d("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const p=h[f]?.document??null;let j=p;C?.dataUrl?j={...p||{},url:C.dataUrl,fileName:u||C.fileName||p?.fileName||"",mimeType:C.mimeType||p?.mimeType,size:C.size??p?.size}:v?j={...p||{},url:v,fileName:u||p?.fileName||""}:u&&p?j={...p,fileName:u}:!v&&!u&&(j=p),h[f]={...h[f],customerName:a,phone:e,companyName:n,email:s,address:i,notes:g,tax_id:c,taxId:c,document:j},ht({customers:h}),y=h[f],O(),Rt(L),vt(L),Y(),document.dispatchEvent(new CustomEvent("customers:changed")),B(d("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),Lt.dataset.listenerAttached="true");async function Fa(){if(X){if(!L){Wt(null),Yt(!0),Y(),X.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${d("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}y=Na(L),y&&(O(),Rt(L),vt(L),Y()),await Ra(L,{showSpinner:!y})}}Fa();const Se=()=>{!L||!y||Y()};document.addEventListener("reservations:changed",Se);document.addEventListener("projects:changed",Se);document.addEventListener("language:changed",()=>{O(),L&&y&&(Rt(L),vt(L),Y())});
