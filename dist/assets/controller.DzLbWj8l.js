import{n as I,j as P,t as c,d as Be,b as It,h as qi,p as je,z as _i,y as Nt,B as $r,C as Ci,v as $i,w as xi,u as Li}from"./auth.CBLJBoUs.js";import{i as Ni,y as qt,z as wn,A as os,B as Pi,C as Jt,p as Ti,D as ji,E as xr,F as Lr,G as Bi,H as Di}from"./reservationsActions.BeW7gGir.js";import{n as lt,s as tt,p as ut,a as kn,b as mn,d as is,k as tn,D as zt,g as Sa,r as Nr,c as Fn,e as Rn,h as cs,l as ls,o as Gs,q as Ws,t as nn,v as vt,w as an,x as Pr,y as Fi,z as Tr,A as Ri,B as Mi,C as jr,E as Ma,F as Br,G as Dr,H as Oa,I as Oi,J as zi,K as Hi,u as Ki,L as Vi,j as Ui}from"./reservationsService.Cbi_xeWO.js";import{s as fn,i as yn,j as Ys,o as ds,p as Fr,q as us,u as Rr,v as Qi,w as Xt,x as Hn,y as mt,n as be,z as Mr,A as ps,l as Tt,B as gn,C as wa,D as aa,E as Gi,F as Or,G as zr,H as Hr,I as st,J as Kr,b as ms,K as Wi,L as Yi,M as Vr,N as Ji,O as Xi,k as Ur}from"./technicians.CCQ6o1ru.js";import{s as fs,E as Qr,a as Zi,d as Gr,e as ec,c as tc,r as nc,f as ac}from"./uiBridge.BQsg4oHo.js";import{q as sc}from"./quotePdf.WC1ebubv.js";import{s as ys,a as gs,e as hs,p as rc}from"./canvasColorUtils.CviLtv6S.js";import{ensureProjectsLoaded as oc}from"./projectsService.CyltrRsR.js";function Wr(e){const t=new Date;if(t.setHours(0,0,0,0),e==="today")return{startDate:Gt(t),endDate:Gt(t)};if(e==="week"){const n=new Date(t),a=n.getDay(),s=a===0?6:a-1;n.setDate(n.getDate()-s);const r=new Date(n);return r.setDate(n.getDate()+6),{startDate:Gt(n),endDate:Gt(r)}}if(e==="month"){const n=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0);return{startDate:Gt(n),endDate:Gt(a)}}return e==="upcoming"?{startDate:Gt(t),endDate:""}:{startDate:"",endDate:""}}function ic(){const e=document.getElementById("search-reservation"),t=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date"),a=document.getElementById("reservation-date-range"),s=document.getElementById("reservation-status-filter");let r=I(t?.value||"").trim(),o=I(n?.value||"").trim(),i=a?.value||"";if(new Set(["","today","week","month"]).has(i)||(i="",a&&(a.value=""),sa(t),sa(n),r="",o=""),!r&&!o&&i){const u=Wr(i);r=u.startDate,o=u.endDate}return{searchTerm:lt(e?.value||""),startDate:r,endDate:o,status:s?.value||"",quickRange:i}}function mu(e){const t=()=>{typeof e=="function"&&e()},n=document.getElementById("search-reservation");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=I(n.value),t()}),n.dataset.listenerAttached="true");const a=document.getElementById("filter-start-date");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{const l=document.getElementById("reservation-date-range");l&&(l.value=""),t()}),a.dataset.listenerAttached="true");const s=document.getElementById("filter-end-date");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{const l=document.getElementById("reservation-date-range");l&&(l.value=""),t()}),s.dataset.listenerAttached="true");const r=document.getElementById("reservation-date-range");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{cc(r.value),t()}),r.dataset.listenerAttached="true");const o=document.getElementById("reservation-status-filter");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",t),o.dataset.listenerAttached="true");const i=document.getElementById("clear-filters");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",()=>{n&&(n.value=""),sa(a),sa(s),r&&(r.value=""),o&&(o.value=""),t()}),i.dataset.listenerAttached="true")}function cc(e){const t=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date");if(!t||!n)return;const{startDate:a,endDate:s}=Wr(e);t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a,n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s}function Gt(e){if(!e)return"";const t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().split("T")[0]}function sa(e){e&&(e._flatpickr&&e._flatpickr.clear(),e.value="")}const lc=""+new URL("Tajawal-400.ttf",import.meta.url).href,dc=""+new URL("Tajawal-500.ttf",import.meta.url).href,Js=""+new URL("Tajawal-700.ttf",import.meta.url).href,uc="reservations.quote.sequence",Xs={reservation:"reservations.quote.togglePrefs.v1",project:"projects.quote.togglePrefs.v1",reservationChecklist:"reservations.checklist.togglePrefs.v1"},Yr="https://help.artratio.sa/guide/quote-preview",We={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"Ø´Ø±ÙƒØ© ÙÙˆØ¯ Ø¢Ø±Øª Ù„Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø´Ø±ÙƒØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯)",commercialRegistry:"4030485240",beneficiaryName:"Ø´Ø±ÙƒØ© ÙÙˆØ¯ Ø¢Ø±Øª Ù„Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø´Ø±ÙƒØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯)",bankName:"Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ",accountNumber:"Ù£Ù¥Ù¨Ù Ù Ù Ù Ù¡Ù Ù Ù Ù¦Ù Ù¨Ù¦Ù Ù¦Ù¥Ù§Ù Ù¦",iban:"SA1680000358608016065706",approvalNote:"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ØªØ¹ØªØ¨Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…."},pc=["ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„ Ù‡Ùˆ 12 Ø³Ø§Ø¹Ø©ØŒ ÙˆÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù†ØµÙ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ 20 Ø³Ø§Ø¹Ø©ØŒ Ø«Ù… ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.","ÙŠÙ…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ø£Ù†Ø´Ø·Ø© ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©.","ÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø£ÙŠ ØªÙ„Ù Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù†.","ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©.","ÙŠØªÙ… ÙØ±Ø¶ Ø±Ø³ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù‚Ø¨Ù„ 24 Ø³Ø§Ø¹Ø©."],pt=[...pc],mc=["ÙŠØªÙ… Ø¯ÙØ¹ 50% Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±ØŒ ÙˆÙŠØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù€ 50% Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.","ÙŠØ­ØµÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ±Ø§Ù‡ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ØŒ Ø¨ÙŠÙ†Ù…Ø§ ØªØ­ØªÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… ÙˆÙ„Ø§ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø§ Ù„Ù… ÙŠÙØªÙÙ‚ Ø¹Ù„Ù‰ ØºÙŠØ± Ø°Ù„Ùƒ.","ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ù„Ù„ØªÙ†ÙÙŠØ°ØŒ ÙˆØ£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ ØªØ®Ø¶Ø¹ Ù„Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©.","Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ØªÙˆÙÙŠØ± Ø§Ù„ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„ØªØµÙˆÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙˆØ£ÙŠ ØªØ£Ø®ÙŠØ± Ù†Ø§ØªØ¬ Ø¹Ù† Ø°Ù„Ùƒ Ù‚Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….","ØªÙØ­ÙÙŽØ¸ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù…Ø¯Ø© 12 Ø´Ù‡Ø±Ø§Ù‹ ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ø±ÙƒØ©ØŒ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø·Ù„Ø¨ Ù†Ø³Ø® Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ù„Ø§Ù„ ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©.","ÙŠØªØ­Ù…Ù‘Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„ Ø¢Ù…Ù†Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØµÙˆÙŠØ±ØŒ ÙˆÙŠØ¶Ù…Ù† Ø§ØªØ®Ø§Ø° ÙƒØ§ÙØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…ØªÙ‡Ù…."];function za(e){return e?e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0):[...pt]}function fc(){const e=document.getElementById("reservation-terms");if(e&&e.value.trim().length>0){const a=za(e.value);if(a.length)return a}const t=document.getElementById("edit-res-terms");if(t&&t.value.trim().length>0){const a=za(t.value);if(a.length)return a}const n=pt.join(`
`);return e&&e.value.trim().length===0&&(e.value=n),t&&t.value.trim().length===0&&(t.value=n),[...pt]}const yc=[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"financialSummary",labelKey:"reservations.quote.sections.financial",fallback:"Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"payment",labelKey:"reservations.quote.sections.payment",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹",defaultSelected:!1}],ka=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>h(I(String(t+1)))},{id:"code",labelKey:"reservations.details.table.headers.code",fallback:"Ø§Ù„ÙƒÙˆØ¯",render:e=>{if(e?.isPackage){const t=e?.packageCodeResolved||e?.barcode||"";return h(t||"-")}return h(e?.barcode||"-")}},{id:"description",labelKey:"reservations.details.table.headers.description",fallback:"Ø§Ù„ÙˆØµÙ",render:e=>{const t=String(e?.desc||e?.description||"-");return`<div class="quote-cell quote-cell--desc">${h(t)}</div>`}},{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:e=>h(I(String(e?.qty||1)))},{id:"unitPrice",labelKey:"reservations.quote.columns.unitPrice",fallback:"Ù„ÙƒÙ„ ÙŠÙˆÙ…",render:e=>h(I(Number(e?.unitPriceValue||0).toFixed(2)))},{id:"price",labelKey:"reservations.quote.columns.total",fallback:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",render:e=>h(I(Number(e?.price||0).toFixed(2)))}],Ia=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>h(I(String(t+1)))},{id:"position",labelKey:"reservations.details.crew.position",fallback:"Ø§Ù„Ù…Ù†ØµØ¨",render:e=>{const t=typeof je=="function"?je():"ar",n=e?.positionLabelEn??e?.position_label_en??e?.position_name_en??e?.positionLabelAlt??e?.position_label_alt??e?.role,a=e?.positionLabel??e?.position_name??e?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return h(I(String(t==="en"&&n?n:a)))}},{id:"unitPrice",labelKey:"reservations.quote.columns.unitPrice",fallback:"Ù„ÙƒÙ„ ÙŠÙˆÙ…",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return h(`${I(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}},{id:"price",labelKey:"reservations.quote.columns.total",fallback:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return h(`${I(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}}],Ft={customerInfo:[{id:"customerName",labelKey:"reservations.details.labels.customer",fallback:"Ø§Ù„Ø¹Ù…ÙŠÙ„"},{id:"customerCompany",labelKey:"reservations.details.labels.company",fallback:"Ø§Ù„Ø´Ø±ÙƒØ©"},{id:"customerPhone",labelKey:"reservations.details.labels.phone",fallback:"Ø§Ù„Ù‡Ø§ØªÙ"},{id:"customerEmail",labelKey:"reservations.details.labels.email",fallback:"Ø§Ù„Ø¨Ø±ÙŠØ¯"}],reservationInfo:[{id:"reservationId",labelKey:"reservations.details.labels.reservationId",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationStart",labelKey:"reservations.details.labels.start",fallback:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationEnd",labelKey:"reservations.details.labels.end",fallback:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationDuration",labelKey:"reservations.details.labels.duration",fallback:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"}],projectInfo:[{id:"projectTitle",labelKey:"reservations.details.labels.project",fallback:"Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectCode",labelKey:"reservations.details.labels.code",fallback:"Ø§Ù„Ø±Ù…Ø²"}],financialSummary:[{id:"discountAmount",labelKey:"reservations.details.labels.discount",fallback:"Ø§Ù„Ø®ØµÙ…"},{id:"subtotalBeforeTax",labelKey:"reservations.details.labels.subtotalBeforeTax",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"taxAmount",labelKey:"reservations.details.labels.tax",fallback:"Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"finalTotal",labelKey:"reservations.details.labels.total",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"}],payment:[{id:"beneficiary",labelKey:"reservations.quote.labels.beneficiary",fallback:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"},{id:"bank",labelKey:"reservations.quote.labels.bank",fallback:"Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"},{id:"account",labelKey:"reservations.quote.labels.account",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"},{id:"iban",labelKey:"reservations.quote.labels.iban",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"}],items:[...ka.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"}],crew:[...Ia.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©"},{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"}]},Jr=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>h(I(String(t+1)))},{id:"label",labelKey:null,fallback:"Ø§Ù„Ø¨Ù†Ø¯",render:e=>h(e?.label||"-")},{id:"amount",labelKey:null,fallback:"Ø§Ù„Ø³Ø¹Ø±",render:e=>{const t=Number.isFinite(Number(e?.salePrice??e?.sale_price))?Number(e?.salePrice??e?.sale_price):Number(e?.amount??0)||0;return h(qe(t,c("reservations.create.summary.currency","SR")))}},{id:"note",labelKey:null,fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª",render:e=>h(e?.note||"-")}],gc=[{id:"customerInfo",labelKey:"projects.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"projectInfo",labelKey:"projects.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"projectExpenses",labelKey:"projects.quote.sections.expenses",fallback:"Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©",defaultSelected:!0},{id:"projectCrew",labelKey:"projects.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0},{id:"financialSummary",labelKey:"projects.quote.sections.financial",fallback:"Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",defaultSelected:!0},{id:"projectEquipment",labelKey:"projects.quote.sections.equipment",fallback:"Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"projectNotes",labelKey:"projects.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"payment",labelKey:"reservations.quote.sections.payment",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹",defaultSelected:!1}],hc={customerInfo:Ft.customerInfo,projectInfo:[{id:"projectTitle",labelKey:"projects.details.overview.heading",fallback:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectCode",labelKey:"projects.details.labels.code",fallback:"Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectType",labelKey:"projects.details.type",fallback:"Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectStart",labelKey:"projects.details.start",fallback:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectEnd",labelKey:"projects.details.end",fallback:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectDuration",labelKey:"projects.details.duration",fallback:"Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectStatus",labelKey:"projects.details.status",fallback:"Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"}],financialSummary:[{id:"reservationsTotal",labelKey:"projects.details.reservationsTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"},{id:"discountAmount",labelKey:"projects.details.summary.discount",fallback:"Ø§Ù„Ø®ØµÙ…"},{id:"taxAmount",labelKey:"projects.details.summary.combinedTax",fallback:"Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"overallTotal",labelKey:"projects.details.summary.overallTotal",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"}],payment:Ft.payment,projectExpenses:[...Jr.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"expensesSubtotal",labelKey:"projects.details.expensesTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"}],projectCrew:[...Ia.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©"},{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"}],projectEquipment:[...ka.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"}],projectNotes:[]},ja=new Map;function Aa(e="reservation"){if(ja.has(e))return ja.get(e);const t=e==="project"?gc:e==="reservationChecklist"?[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0}]:yc,n=e==="project"?hc:e==="reservationChecklist"?{customerInfo:Ft.customerInfo,reservationInfo:Ft.reservationInfo,projectInfo:Ft.projectInfo,notes:[],items:Ft.items,crew:Ft.crew}:Ft,a=new Set(t.map(({id:o})=>o)),s=Object.fromEntries(Object.entries(n).map(([o,i=[]])=>[o,new Set(i.map(l=>l.id))])),r={sectionDefs:t,fieldDefs:n,sectionIdSet:a,fieldIdMap:s};return ja.set(e,r),r}function Ea(e="reservation"){return Aa(e).sectionDefs}function Xr(e="reservation"){return Aa(e).fieldDefs}function Zr(e="reservation"){return Aa(e).sectionIdSet}function eo(e="reservation"){return Aa(e).fieldIdMap}function to(e){switch(e){case"export":return c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF...");case"render":default:return c("reservations.quote.status.rendering","Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...")}}const bc="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",vc="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",Sc="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",no=sc.trim(),ao=`
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 400; font-display: swap; src: url(${JSON.stringify(lc)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 500; font-display: swap; src: url(${JSON.stringify(dc)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 600; font-display: swap; src: url(${JSON.stringify(Js)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 700; font-display: swap; src: url(${JSON.stringify(Js)}) format('truetype'); }
`,so=/^data:image\/svg\+xml/i,wc=/\.svg($|[?#])/i,_n=512,Ha="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/B8AAusB9YwpClgAAAAASUVORK5CYII=",ro=96,oo=25.4,Ka=210,Wn=297,Cn=Math.round(Ka/oo*ro),$n=Math.round(Wn/oo*ro);function xe(e){const t=Number(e),n=Number.isFinite(t)?t:0;try{const a=Math.abs(n%1)>1e-9;return I(n.toLocaleString("en-US",{minimumFractionDigits:a?2:0,maximumFractionDigits:2}))}catch{return Number.isInteger(n)?I(String(n)):I(n.toFixed(2))}}let ra=!1,oa=null;function bs(){ra||(oa=async function(){try{if(!m||!X?.modal?.classList.contains("show")||(m.context||"reservation")!=="reservation")return;const n=m.reservation;if(!n)return;const a=[n.id,n.reservationId,n.reservation_id,n.reservationCode,n.reservation_code].map(d=>d==null?"":String(d)).filter(d=>d.length>0);if(!a.length)return;const s=Sa(),r=(Array.isArray(s)?s:[]).find(d=>[d?.id,d?.reservationId,d?.reservation_id,d?.reservationCode,d?.reservation_code].map(b=>b==null?"":String(b)).filter(b=>b.length>0).some(b=>a.includes(b)));if(!r)return;const o=xa(r),{totalsDisplay:i,totals:l,rentalDays:u}=js(r,o,m.project);m.reservation=r,m.crewAssignments=o,m.totals=l,m.totalsDisplay=i,m.rentalDays=u,m.context==="reservationChecklist"&&mo(),Jn(),Je()}catch(t){console.warn("[reservationPdf] live update failed",t)}},document.addEventListener("reservations:changed",oa),ra=!0)}function io(){if(ra){try{document.removeEventListener("reservations:changed",oa)}catch{}oa=null,ra=!1}}const co=2,lo=/safari/i,kc=/(iphone|ipad|ipod)/i,Zs=/(iphone|ipad|ipod)/i,Ic=/(crios|fxios|edgios|opios)/i,ia="[reservations/pdf]";let X=null,m=null,Et=1,In=null,An=null,Rt=null,cn=null,Ln=!1;const ca="quoteBlockOffsets",er=1800,la="quoteInfoAlignments",Ac=["customer","reservation","project","projectCustomer","projectDetails"],vs={customer:"left",reservation:"left",project:"left",projectCustomer:"left",projectDetails:"left"},Va={project:{customer:"left",reservation:"left",project:"left",projectCustomer:"left",projectDetails:"left"},reservationChecklist:{customer:"left",reservation:"left",project:"left",projectCustomer:"left",projectDetails:"left"}};let hn=!1,Ss=!1,Mn=!1;const ws={project:{"project-title":{x:-182.78680419921875,y:-5.0181427001953125},"project-content":{x:-140.1977996826172,y:-4.7384796142578125}}},ln={blockOffsets:"data-block-offsets",infoAlignments:"data-info-alignments",context:"data-quote-source-context"};function uo(e){return I(String(e??"")).trim().toLowerCase()}function po(e){return e==null?"":I(String(e)).trim().toLowerCase()}function ks(){const e=Be()||{},t=Array.isArray(e.equipment)?e.equipment:[],n=new Map,a=new Map;return t.forEach(s=>{if(!s||typeof s!="object")return;[s.id,s.equipment_id,s.equipmentId,s.item_id,s.itemId].forEach(o=>{o==null||o===""||n.set(String(o),s)});const r=po(s.barcode);r&&a.set(r,s)}),{byId:n,byBarcode:a}}function Ec(e={},t){if(!t)return null;const n=[e.equipmentId,e.equipment_id,e.id,e.itemId,e.item_id];for(const s of n){if(s==null||s==="")continue;const r=String(s);if(t.byId.has(r))return t.byId.get(r)}const a=[e.barcode,e.normalizedBarcode,e.code];for(const s of a){const r=po(s);if(r&&t.byBarcode.has(r))return t.byBarcode.get(r)}return null}function Is(e,t,n=new Set){const a=new Set;if(!e||typeof e!="object")return a;const s=o=>{const i=typeof o=="string"?o.trim():"";i&&a.add(i)};if(s(e.lessor??e.owner??e.lessor_name??e.lessorName),Array.isArray(e.packageItems)&&e.packageItems.length>0&&!n.has(e)&&(n.add(e),e.packageItems.forEach(o=>{Is(o,t,n).forEach(i=>a.add(i))}),n.delete(e)),!a.size){const o=Ec(e,t);o&&s(o.lessor??o.owner??o.lessor_name??o.lessorName)}return a}function qc(e,t,n){if(!(t instanceof Set)||t.size===0)return!0;const a=Is(e,n);if(!a.size)return!1;for(const s of a){const r=uo(s);if(r&&t.has(r))return!0}return!1}function _c(e,t){const n=Array.isArray(e?.items)?e.items:[],a=new Map;n.forEach(r=>{Is(r,t).forEach(o=>{const i=uo(o);i&&(a.has(i)||a.set(i,{key:i,label:o,count:0}),a.get(i).count+=1)})});const s=new Intl.Collator("ar",{sensitivity:"base"});return Array.from(a.values()).sort((r,o)=>s.compare(r.label,o.label))}function mo(){if(!m||m.context!=="reservationChecklist")return;const e=ks();m.checklistEquipmentLookup=e;const t=_c(m.reservation,e),n=new Set(t.map(s=>s.key)),a=m.checklistLessorFilter instanceof Set?m.checklistLessorFilter:new Set;Array.from(a).forEach(s=>{n.has(s)||a.delete(s)}),m.checklistLessorOptions=t,m.checklistLessorFilter=a,da()}function da(){if(!X?.checklistLessorContainer)return;const e=X.checklistLessorContainer,t=X.checklistLessorOptionsHost;if(!m||m.context!=="reservationChecklist"){e.hidden=!0;return}const n=Array.isArray(m.checklistLessorOptions)?m.checklistLessorOptions:[],a=m.checklistLessorFilter instanceof Set?m.checklistLessorFilter:new Set;if(!t){e.hidden=!0;return}if(!n.length){e.hidden=!0,t.innerHTML=`<p class="text-muted" data-lessor-empty>${h(c("reservations.checklist.controls.lessors.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¤Ø¬Ø± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø¹Ø¯Ø§Øª."))}</p>`;const r=e.querySelector("[data-lessor-clear]");r&&(r.disabled=!0);return}e.hidden=!1,t.innerHTML=n.map(r=>{const o=`checklist-lessor-${r.key}`,i=r.count?` <small>(${h(I(String(r.count)))})</small>`:"";return`
      <label for="${o}" style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="${o}" value="${r.key}" ${a.has(r.key)?"checked":""}>
        <span>${h(r.label)}${i}</span>
      </label>
    `}).join(""),t.querySelectorAll('input[type="checkbox"]').forEach(r=>{r.addEventListener("change",()=>{m.checklistLessorFilter instanceof Set||(m.checklistLessorFilter=new Set),r.checked?m.checklistLessorFilter.add(r.value):m.checklistLessorFilter.delete(r.value),da(),Je()})});const s=e.querySelector("[data-lessor-clear]");s&&(s.disabled=a.size===0,s.onclick=()=>{m.checklistLessorFilter instanceof Set&&(m.checklistLessorFilter.clear(),da(),Je())})}function fo(){if(!m?.reservation||m.context!=="reservationChecklist")return m?.reservation||null;const e=m.checklistLessorFilter;if(!(e instanceof Set)||e.size===0)return m.reservation;const t=m.checklistEquipmentLookup||ks();m.checklistEquipmentLookup=t;const n=Array.isArray(m.reservation.items)?m.reservation.items:[],a=n.filter(s=>qc(s,e,t));return a.length===n.length?m.reservation:{...m.reservation,items:a}}function tr(e){try{return encodeURIComponent(JSON.stringify(e))}catch{return""}}function nr(e,t){if(!e)return null;const n=e.getAttribute(t);if(!n)return null;try{return JSON.parse(decodeURIComponent(n))}catch{return null}}function Cc(e={}){const t=[],n=e.context||Ct(e);if(t.push(`${ln.context}="${h(String(n))}"`),e.blockOffsets&&Object.keys(e.blockOffsets).length){const a=tr(e.blockOffsets);a&&t.push(`${ln.blockOffsets}="${a}"`)}if(e.infoAlignments&&Object.keys(e.infoAlignments).length){const a=tr(e.infoAlignments);a&&t.push(`${ln.infoAlignments}="${a}"`)}return t.length?` ${t.join(" ")}`:""}let Ot=null;function yo(e){return e&&typeof e=="object"?e:Ot||m||null}function Ct(e=null){return yo(e)?.context||"reservation"}function $c(e="reservation"){try{const n=JSON.parse(localStorage.getItem(ca)||"{}")?.[e];if(n&&typeof n=="object")return JSON.parse(JSON.stringify(n))}catch{}return{}}function go(e,t={}){try{const n=JSON.parse(localStorage.getItem(ca)||"{}");t&&Object.keys(t).length>0?n[e]=t:delete n[e],localStorage.setItem(ca,JSON.stringify(n))}catch{}}function As(e){if(!e)return;const t=Ct(e),n=$c(t);e.blockOffsets={...ws[t]||{},...n},Ss=!1,hn=!1,qa()}function xc(e,t={}){if(!e)return;e.querySelectorAll("[data-drag-key]").forEach(a=>{const s=a.dataset.dragKey,r=t?.[s],o=Number(r?.x)||0,i=Number(r?.y)||0;o||i?a.style.transform=`translate(${o}px, ${i}px)`:a.style.transform="",a.dataset.dragX=String(o),a.dataset.dragY=String(i)})}function Es(e){try{const t=e?.getElementById("quotation-pdf-root");if(!t)return;t.dataset.blockDragMode=hn?"on":"off"}catch{}}function qa(){const e=X?.blockDragToggle;if(e){const n=hn?c("reservations.quote.drag.disable","ðŸ”’ Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ"):c("reservations.quote.drag.enable","ðŸŽ¯ ÙˆØ¶Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª");e.setAttribute("aria-label",n),e.setAttribute("title",n),e.classList.toggle("is-active",hn)}const t=X?.blockDragSave;t&&(t.disabled=!Ss)}function Lc(e){hn=!!e,qa();try{Es(X?.previewFrame?.contentDocument)}catch{}}function qs(e=!0){Ss=!!e,qa()}function Nc(){if(!m)return;const e=Ct(m),t=m.blockOffsets||{};go(e,t),qs(!1),P(c("reservations.quote.drag.saved","âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª."))}function Pc(){if(!m)return;const e=Ct(m);m.blockOffsets={...ws[e]||{}},go(e,m.blockOffsets),qs(!1),Je(),P(c("reservations.quote.drag.reset","â†º ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ."))}function ar(e){return Math.min(Math.max(e,-er),er)}function Tc(e="reservation"){try{const n=JSON.parse(localStorage.getItem(la)||"{}")?.[e];if(n&&typeof n=="object")return{...n}}catch{}return null}function jc(e,t={}){try{const n=JSON.parse(localStorage.getItem(la)||"{}");n[e]=t,localStorage.setItem(la,JSON.stringify(n))}catch{}}function _s(e){if(!e||Mn)return;const t=Ct(e),n=Tc(t);e.infoAlignments={...vs,...Va[t]||{},...n||{}},Mn=!0}function ho(e,t){const n=yo(e),a=n?.infoAlignments;if(a&&Object.prototype.hasOwnProperty.call(a,t))return a[t];const s=Ct(n);return Va[s]?.[t]?Va[s][t]:vs[t]||"right"}function Nn(e,t){return`info-plain info-plain--align-${ho(e,t)}`}function Bc(e,t){if(!m)return;const n=Ac.includes(e)?e:"customer",a=["left","center","right"].includes(t)?t:"right";m.infoAlignments||(m.infoAlignments={...vs}),m.infoAlignments[n]=a;const s=Ct(m);jc(s,m.infoAlignments),Je(),_a()}function _a(){if(!X?.alignTarget)return;const e=X.alignTarget.value||"customer",t=ho(m,e);(X.alignButtons||[]).forEach(n=>{const a=n.dataset.alignValue;a&&n.classList.toggle("is-active",a===t)})}async function Dc(){try{if(!m)return;const e=Ct(m),t=JSON.parse(localStorage.getItem(ca)||"{}"),n=JSON.parse(localStorage.getItem(la)||"{}"),a={context:e,blockOffsets:m.blockOffsets||t[e]||{},infoAlignments:m.infoAlignments||n[e]||{}},s=JSON.stringify(a,null,2);let r=!1;if(navigator?.clipboard?.writeText)try{await navigator.clipboard.writeText(s),r=!0}catch{r=!1}r?P(c("reservations.quote.align.copied","âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©")):window.prompt(c("reservations.quote.align.copyPrompt","Ø§Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©"),s)}catch(e){console.error("[quote align export] failed",e),P(c("reservations.quote.align.copyFailed","âš ï¸ ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹"),"error")}}function Fc(e){try{const t=e?.getElementById("quotation-pdf-root");if(!t)return;Array.from(t.querySelectorAll("[data-drag-key]")).forEach(a=>{if(a.dataset.blockDragHandleAttached==="true")return;a.style.position=a.style.position||"relative",a.style.touchAction="none";const s=e.createElement("button");s.type="button",s.className="quote-block-drag-handle",s.setAttribute("data-block-handle",a.dataset.dragKey||""),s.setAttribute("aria-label",c("reservations.quote.drag.handle","Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…")),s.innerHTML='<span aria-hidden="true">â ¿</span>';const r=o=>{t.dataset.blockDragMode==="on"&&Rc(o,a)};s.addEventListener("pointerdown",r),a.prepend(s),a.dataset.blockDragHandleAttached="true"}),Es(e)}catch{}}function Rc(e,t){if(!t||!m)return;e.preventDefault(),e.stopPropagation();const n=t.ownerDocument||document,a=e.pointerId;t.setPointerCapture?.(a);const s=e.clientX,r=e.clientY,o=Number(t.dataset.dragX||0),i=Number(t.dataset.dragY||0);let l=o,u=i;const d=t.dataset.dragKey,y=p=>{p.preventDefault();const f=p.clientX-s,S=p.clientY-r;l=ar(o+f),u=ar(i+S),t.style.transform=`translate(${l}px, ${u}px)`,t.dataset.dragTempX=String(l),t.dataset.dragTempY=String(u)},b=()=>{n.removeEventListener("pointermove",y),n.removeEventListener("pointerup",b),t.releasePointerCapture?.(a);const p=Number(t.dataset.dragTempX??o),f=Number(t.dataset.dragTempY??i);t.dataset.dragX=String(p),t.dataset.dragY=String(f),t.dataset.dragTempX="",t.dataset.dragTempY="",m.blockOffsets||(m.blockOffsets={}),Math.abs(p)<=.5&&Math.abs(f)<=.5?delete m.blockOffsets[d]:m.blockOffsets[d]={x:p,y:f},qs(!0)};n.addEventListener("pointermove",y),n.addEventListener("pointerup",b)}function Yt(e="render",{message:t,actionLabel:n,onAction:a,showSpinner:s=e!=="error"}={}){if(!X?.statusIndicator||!X?.statusText)return;X.statusKind=e;const r=t||to(e);X.statusText.textContent=r,X.statusSpinner&&(X.statusSpinner.hidden=!s),X.statusAction&&(X.statusAction.hidden=!0,X.statusAction.onclick=null,n&&typeof a=="function"&&(X.statusAction.textContent=n,X.statusAction.hidden=!1,X.statusAction.onclick=o=>{o.preventDefault(),a()})),X.statusIndicator.hidden=!1,requestAnimationFrame(()=>{X.statusIndicator.classList.add("is-visible")})}function dn(e){try{return String(e||"").toLowerCase().normalize("NFKD").replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,"").replace(/\s+/g," ").trim()}catch{return String(e||"").trim().toLowerCase()}}function Pn(e){!X?.statusIndicator||!X?.statusText||(X.statusKind=null,X.statusIndicator.classList.remove("is-visible"),setTimeout(()=>{X?.statusIndicator&&(X.statusIndicator.hidden=!0,X.statusAction&&(X.statusAction.hidden=!0,X.statusAction.onclick=null),X.statusSpinner&&(X.statusSpinner.hidden=!1))},220))}function Ua(){return!!window?.bootstrap?.Modal}function Mc(e){if(e&&!e.classList.contains("show")){e.classList.add("show"),e.style.display="block",e.removeAttribute("aria-hidden"),e.setAttribute("aria-modal","true"),e.getAttribute("role")||e.setAttribute("role","dialog"),document.body.classList.add("modal-open"),Rt||(Rt=document.createElement("div"),Rt.className="modal-backdrop fade show",Rt.dataset.quotePdfFallbackBackdrop="true",document.body.appendChild(Rt)),cn||(cn=t=>{t.key==="Escape"&&Qa(e)},document.addEventListener("keydown",cn));try{e.focus({preventScroll:!0})}catch{}}}function Qa(e){if(!(!e||!e.classList.contains("show"))){try{const t=e.ownerDocument?.activeElement;if(t&&e.contains(t)){try{t.blur()}catch{}try{e.ownerDocument?.body?.focus({preventScroll:!0})}catch{}}}catch{}e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal"),document.body.classList.remove("modal-open"),Rt&&(Rt.remove(),Rt=null),cn&&(document.removeEventListener("keydown",cn),cn=null);try{io()}catch{}}}function Oc(e){if(e){if(Ua()){const t=window.bootstrap.Modal.getOrCreateInstance(e);try{const n=()=>{try{const a=document.activeElement;if(a&&e.contains(a)){try{a.blur()}catch{}try{document.body?.focus({preventScroll:!0})}catch{}}}catch{}try{io()}catch{}try{e.removeEventListener("hidden.bs.modal",n)}catch{}};e.addEventListener("hidden.bs.modal",n,{once:!0}),e.addEventListener("hide.bs.modal",()=>{try{const a=document.activeElement;if(a&&e.contains(a))try{a.blur()}catch{}}catch{}})}catch{}t.show();return}Mc(e)}}function zc(){if(Ln)return;Ln=!0;const e=c("reservations.quote.toast.viewGuide","ðŸ“˜ Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹"),t=c("reservations.quote.toast.retry","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"),n=c("reservations.quote.toast.assetsFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± Ø¶Ù…Ù† Ø¹Ø±Ø¶ Ø³Ø¹Ø±."),a=!!X?.modal?.classList.contains("show"),s=()=>{X?.modal?.classList.contains("show")&&(Yt("render"),Ln=!1,Je())};$r({message:n,duration:9e3,actionLabel:a?t:void 0,onAction:a?s:void 0,linkLabel:e,linkHref:Yr}),a&&Yt("error",{message:n,actionLabel:t,onAction:s,showSpinner:!1})}function Kn(e="reservation"){const t={},n=Xr(e);return Object.entries(n).forEach(([a,s=[]])=>{t[a]=new Set(s.filter(r=>r?.default!==!1).map(r=>r.id))}),t}function Cs(e={}){const t={};return Object.entries(e).forEach(([n,a])=>{t[n]=new Set(Array.from(a||[]))}),t}function Hc(e={},t){if(t)return e[t]||(e[t]=new Set),e[t]}function $s(e={},t,n){const a=e?.[t];return a?a instanceof Set?a.has(n):Array.isArray(a)?a.includes(n):!!a?.[n]:!0}function Ca(e="reservation"){return Object.fromEntries(Ea(e).map(({id:t})=>[t,!1]))}function xs(e,t){return e.sectionExpansions||(e.sectionExpansions=Ca(e.context||"reservation")),t&&typeof e.sectionExpansions[t]!="boolean"&&(e.sectionExpansions[t]=!1),e.sectionExpansions}function Kc(e,t){return xs(e,t)?.[t]!==!1}function Ls(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches}function Vc(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||navigator.platform||"";return kc.test(e)}function Uc(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=lo.test(e),n=e.includes("Chrome")||e.includes("CriOS")||e.includes("Chromium"),a=e.includes("Edg");return t&&!n&&!a}function bo(){return Vc()&&Uc()}function $a(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=navigator.platform||"",n=Number.isFinite(navigator.maxTouchPoints)?navigator.maxTouchPoints:0,a=Zs.test(e)||Zs.test(t),s=/Macintosh/i.test(e)&&n>1;return lo.test(e)&&!Ic.test(e)&&(a||s)}function Ba(e,...t){try{console.log(`${ia} ${e}`,...t)}catch{}}function Lt(e,...t){try{console.warn(`${ia} ${e}`,...t)}catch{}}function Qc(e,t,...n){try{t?console.error(`${ia} ${e}`,t,...n):console.error(`${ia} ${e}`,...n)}catch{}}function Re(e,{blockType:t="section",extraAttributes:n=""}={}){if(!e)return"";const a=n?` ${n.trim()}`:"";return e.replace(/^(<\w+)/,`$1 data-quote-block data-block-type="${t}"${a}`)}function Gc(e,t="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶."){const n=h(c(e,t));return Re(`<section class="quote-section quote-placeholder">${n}</section>`,{blockType:"placeholder"})}function ua(e,t){return Array.isArray(e)&&e.length?e:[Gc(t)]}const Wc=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;function vo(e=""){return Wc.test(e)}function Yc(){const e=window.CanvasRenderingContext2D?.prototype;if(!e||e.__artRatioDirectionPatched)return;const t=n=>{const a=e[n];typeof a=="function"&&(e[n]=function(r,...o){if(typeof r!="string"||!vo(r))return a.call(this,r,...o);let i,l=!1;try{"direction"in this&&(i=this.direction,i!=="rtl"&&(this.direction="rtl"),l=!0)}catch{}try{if(!l){const u=this.canvas;u&&u.style?.direction!=="rtl"&&(u.__artRatioOriginalDirection=u.style.direction,u.style.direction="rtl")}return a.call(this,r,...o)}finally{if(l&&i!==void 0&&i!=="rtl")try{this.direction=i}catch{}else if(!l){const u=this.canvas;u&&u.__artRatioOriginalDirection!==void 0&&(u.style.direction=u.__artRatioOriginalDirection,delete u.__artRatioOriginalDirection)}}})};t("fillText"),t("strokeText"),e.__artRatioDirectionPatched=!0}function sr(e,t=_n){if(typeof e!="string"&&typeof e!="number")return t;const n=parseFloat(String(e).replace(/[^0-9.+-]/g,""));return Number.isFinite(n)&&n>0?n:t}function Jc(e){if(!e)return{width:_n,height:_n};const t=e.getAttribute?.("width"),n=e.getAttribute?.("height");let a=t?sr(t,0):0,s=n?sr(n,0):0;if(a>0&&s>0)return{width:a,height:s};const r=e.getAttribute?.("viewBox");if(r){const o=r.trim().split(/[\s,]+/).map(i=>parseFloat(i||"0"));if(o.length>=4){const[,,i,l]=o;a=a||(Number.isFinite(i)&&i>0?i:0),s=s||(Number.isFinite(l)&&l>0?l:0)}}return{width:a||_n,height:s||_n}}function So(e=""){return typeof e!="string"?!1:so.test(e)||wc.test(e)}function Xc(e=""){const t=e.indexOf(",");if(t===-1)return"";const n=e.slice(0,t),a=e.slice(t+1);try{return/;base64/i.test(n)?typeof atob=="function"?atob(a):"":decodeURIComponent(a)}catch(s){return console.warn("[reservations/pdf] failed to decode SVG data URI",s),""}}function Zc(e,{crossOrigin:t}={}){return new Promise((n,a)=>{const s=new Image;t&&(s.crossOrigin=t),s.onload=()=>n(s),s.onerror=r=>{const o=r?.message||`Unable to load image from ${e}`;a(new Error(o))},s.src=e})}async function wo(e,t={}){if(!e)return null;const n=document,a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a);try{const r=await Zc(s),o=n.createElement("canvas"),i=Math.max(t.width||r.naturalWidth||r.width||0,1),l=Math.max(t.height||r.naturalHeight||r.height||i,1);o.width=i,o.height=l;const u=o.getContext("2d");return u.clearRect(0,0,i,l),u.drawImage(r,0,0,i,l),o.toDataURL("image/png")}catch(r){return console.warn("[reservations/pdf] failed to rasterize SVG content",r),null}finally{URL.revokeObjectURL(s)}}async function el(e){if(!e)return null;if(so.test(e))return Xc(e);try{const t=await fetch(e,{mode:"cors",credentials:"omit",cache:"default"});return t.ok?await t.text():(console.warn("[reservations/pdf] failed to fetch SVG image",e,t.status),null)}catch(t){return console.warn("[reservations/pdf] error fetching SVG image",e,t),null}}async function tl(e){if(!e)return!1;const t=e.getAttribute?.("src")||"";if(!So(t))return!1;const n=await el(t);if(!n)return e.dataset.svgRasterization="failed",e.setAttribute("src",Ha),!1;const a=await wo(n);return a?(e.dataset.svgOriginalSrc=t,e.setAttribute("src",a),e.setAttribute("data-rasterized","true"),!0):(e.dataset.svgRasterization="failed",e.setAttribute("src",Ha),!1)}async function nl(e){if(!e||e.tagName?.toLowerCase()!=="svg")return!1;const n=new XMLSerializer().serializeToString(e),a=Jc(e),s=await wo(n,a),o=(e.ownerDocument||document).createElement("img");o.setAttribute("src",s||Ha),o.setAttribute("alt",e.getAttribute("aria-label")||e.getAttribute("title")||""),o.setAttribute("data-svg-replaced","true"),e.hasAttribute("class")&&o.setAttribute("class",e.getAttribute("class")),e.hasAttribute("style")&&o.setAttribute("style",e.getAttribute("style"));const i=e.getAttribute("width"),l=e.getAttribute("height");return i&&o.setAttribute("width",i),l&&o.setAttribute("height",l),e.parentNode?.replaceChild(o,e),!!s}async function ko(e){if(!e)return;const t=Array.from(e.querySelectorAll?.("img")||[]),n=Array.from(e.querySelectorAll?.("svg")||[]),a=[];t.forEach(s=>{So(s.getAttribute?.("src"))&&a.push(tl(s))}),n.forEach(s=>{a.push(nl(s))}),a.length&&await Promise.allSettled(a)}function al(e,{pixelRatio:t=1}={}){if(!e)return null;const n=e.ownerDocument||document,s=(n.defaultView||window).getComputedStyle?.(e);if(!s)return null;const r=(F,j=0)=>{const W=parseFloat(F);return Number.isFinite(W)?W:j},o=r(s.paddingTop),i=r(s.paddingBottom),l=r(s.paddingRight),u=r(s.paddingLeft),d=r(s.borderRadius),y=r(s.fontSize,14),b=(()=>{const F=s.lineHeight;if(!F||F==="normal")return y*1.6;const j=r(F,y*1.6);return j>0?j:y*1.6})(),p=Math.max(e.clientWidth||0,e.scrollWidth||0,r(s.width,0));if(p<=0)return null;const f=Math.max(1,p-u-l),S=e.textContent||"",A=S.split(/\r?\n/),k=n.createElement("canvas"),w=k.getContext("2d");if(!w)return null;const O=s.fontStyle||"normal",K=s.fontVariant||"normal",Y=s.fontWeight||"400",v=s.fontFamily||"sans-serif",N=s.fontStretch||"normal",q=F=>F.join(" "),E=[],J=F=>w.measureText(F).width;w.font=`${O} ${K} ${Y} ${N} ${y}px ${v}`,A.forEach(F=>{const j=F.trim();if(j.length===0){E.push("");return}const W=j.split(/\s+/);let oe=[];W.forEach((te,me)=>{const ve=te.trim();if(!ve)return;const Q=q(oe.concat(ve));if(J(Q)<=f||oe.length===0){oe.push(ve);return}E.push(q(oe)),oe=[ve]}),oe.length&&E.push(q(oe))}),E.length||E.push("");const B=o+i+E.length*b,Z=Math.ceil(Math.max(1,p)*t),D=Math.ceil(Math.max(1,B)*t);k.width=Z,k.height=D,k.style.width=`${Math.max(1,p)}px`,k.style.height=`${Math.max(1,B)}px`,w.scale(t,t);const U=s.backgroundColor&&s.backgroundColor!=="rgba(0, 0, 0, 0)"?s.backgroundColor:"#ffffff";if(d>0){w.save(),w.beginPath();const F=Math.max(1,p),j=Math.max(1,B),W=Math.min(d,F/2,j/2);w.moveTo(W,0),w.lineTo(F-W,0),w.quadraticCurveTo(F,0,F,W),w.lineTo(F,j-W),w.quadraticCurveTo(F,j,F-W,j),w.lineTo(W,j),w.quadraticCurveTo(0,j,0,j-W),w.lineTo(0,W),w.quadraticCurveTo(0,0,W,0),w.closePath(),w.clip()}if(w.fillStyle=U,w.fillRect(0,0,Math.max(1,p),Math.max(1,B)),w.font=`${O} ${K} ${Y} ${N} ${y}px ${v}`,w.fillStyle=s.color||"#000000",w.textBaseline="top",w.textAlign="right","direction"in w)try{w.direction="rtl"}catch{}const L=Math.max(0,p-l);let T=o;E.forEach(F=>{const j=F.length?F:" ";w.fillText(j,L,T,f),T+=b});const R=n.createElement("img");let V;try{V=k.toDataURL("image/png")}catch(F){return Lt("note canvas toDataURL failed",F),null}return R.src=V,R.alt=S,R.style.width=`${Math.max(1,p)}px`,R.style.height=`${Math.max(1,B)}px`,R.style.display="block",R.setAttribute("data-quote-note-image","true"),{image:R,canvas:k,totalHeight:B,width:p}}function sl(e,{pixelRatio:t=1}={}){if(!e||!$a())return;Array.from(e.querySelectorAll?.(".quote-notes")||[]).forEach(a=>{if(!a||a.dataset.quoteNoteRasterized==="true"||!vo(a.textContent||""))return;let s;try{s=al(a,{pixelRatio:t})}catch(r){Lt("failed to rasterize note content",r),s=null}s&&(a.dataset.quoteNoteRasterized="true",a.innerHTML="",a.appendChild(s.image))})}function Ga(e,t="export",{toastMessage:n,suppressToast:a=!1}={}){Qc(`${t} failed`,e);const s=!!(e&&e.__artRatioPdfNotified);if(!a&&!s){const r=c("reservations.quote.errors.exportFailed","âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDFØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."),o=n||r,i=c("reservations.quote.toast.viewGuide","ðŸ“˜ Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹"),l=c("reservations.quote.toast.retry","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"),u=["exportQuoteAsPdf","renderQuotePreview","layoutQuoteDocument","pageCapture"].includes(t),d=()=>{t==="exportQuoteAsPdf"?(Yt("export"),Lo()):(Yt("render"),Ln=!1,Je())};if($r({message:o,duration:9e3,actionLabel:u?l:void 0,onAction:u?d:void 0,linkLabel:i,linkHref:Yr}),X?.modal?.classList.contains("show")&&Yt("error",{message:o,actionLabel:u?l:void 0,onAction:u?d:void 0,showSpinner:!1}),e&&typeof e=="object")try{Object.defineProperty(e,"__artRatioPdfNotified",{value:!0,writable:!1,enumerable:!1,configurable:!0})}catch{}}}function Wa({container:e,safariWindowRef:t,mobileWindowRef:n}={}){try{n&&!n.closed&&n.close()}catch(a){Lt("failed to close mobile window",a)}try{t&&!t.closed&&t.close()}catch(a){Lt("failed to close safari window",a)}e&&e.parentNode&&e.parentNode.removeChild(e)}function Ns(e){return new Promise((t,n)=>{const a=document.querySelector(`script[src="${e}"]`);if(a){a.addEventListener("load",()=>t()),a.addEventListener("error",r=>n(r)),a.readyState==="complete"&&t();return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>t(),s.onerror=r=>n(r),document.head.appendChild(s)})}function rr(){const e=[window.jspdf?.jsPDF,typeof window.jspdf=="function"?window.jspdf:null,window.jsPDF?.jsPDF,typeof window.jsPDF=="function"?window.jsPDF:null].filter(t=>typeof t=="function");return e.length?e[0]:null}function or(){return typeof window.html2canvas=="function"?window.html2canvas:null}async function rl(){const e=or();return e||(An||(An=Ns(vc).catch(t=>{throw An=null,t}).then(()=>{const t=or();if(!t)throw An=null,new Error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© html2canvas Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");return t})),An)}async function ol(){const e=rr();return e||(In||(In=Ns(Sc).catch(t=>{throw In=null,t}).then(()=>{const t=rr();if(!t)throw In=null,new Error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© jsPDF Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");return t})),In)}async function il(){if(window.html2pdf||await Ns(bc),window.html2pdf&&!window.html2pdf.__artRatioConfigured){const e=window.html2pdf.defaultOptions||window.html2pdf.defaultOpt||{},t={...e.html2canvas||{}};t.useCORS=!0,t.allowTaint=!1,t.logging=!0;const n={unit:"mm",format:"a4",orientation:"portrait",compress:!0,...e.jsPDF||{}},a={image:{type:"jpeg",quality:.95,...e.image||{}},margin:e.margin??[0,0,0,0],filename:e.filename||"document.pdf",html2canvas:t,jsPDF:n};window.html2pdf.defaultOptions=a,window.html2pdf.defaultOpt=a,window.html2pdf.__artRatioConfigured=!0}rc(),Yc()}function h(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Io(e="reservation"){return Xs[e]||Xs.reservation}function cl(){try{window.localStorage?.removeItem?.(uc)}catch{}}function ll(e="reservation"){try{cl();const t=Io(e),n=window.localStorage?.getItem?.(t);if(!n)return null;const a=JSON.parse(n);return a&&typeof a=="object"?a:null}catch(t){return console.warn("âš ï¸ [reservations/pdf] failed to read toggle preferences",t),null}}function dl(e,t="reservation"){try{const n=Io(t);if(!e){window.localStorage?.removeItem?.(n);return}window.localStorage?.setItem?.(n,JSON.stringify(e))}catch(n){console.warn("âš ï¸ [reservations/pdf] failed to persist toggle preferences",n)}}function ul(e){if(!e)return{ids:null,emptyExplicitly:!1};if(e instanceof Set)return{ids:Array.from(e),emptyExplicitly:e.size===0};if(Array.isArray(e))return{ids:e.slice(),emptyExplicitly:e.length===0};if(typeof e=="object"){const t=Object.entries(e).filter(([,n])=>!!n);return{ids:t.map(([n])=>n),emptyExplicitly:t.length===0}}return{ids:null,emptyExplicitly:!1}}function pl(e,t="reservation"){if(!e)return null;const n=Zr(t),a=eo(t),s=Array.from(e.sections instanceof Set?e.sections:new Set(e.sections||[])).filter(i=>n.has(i)),r={},o=e.fields||{};return Object.entries(a).forEach(([i,l])=>{const u=o[i];if(u==null)return;const{ids:d,emptyExplicitly:y}=ul(u);if(!d&&!y)return;const b=Array.isArray(d)?d.filter(p=>l.has(p)):[];(b.length>0||y)&&(r[i]=b)}),{version:1,sections:s,fields:r}}function Ao(e){if(!e)return;const t=e.context||"reservation",n=pl(e,t);n&&dl(n,t)}function Ps(e){if(!e)return;const t=e.context||"reservation",n=ll(t);if(!n)return;const a=Zr(t),s=Array.isArray(n.sections)?n.sections.filter(r=>a.has(r)):[];if(s.length&&(e.sections=new Set(s)),n.fields&&typeof n.fields=="object"){const r=Cs(e.fields||Kn(t)),o=eo(t);Object.entries(n.fields).forEach(([i,l])=>{const u=o[i];if(!u)return;const d=Array.isArray(l)?l.filter(y=>u.has(y)):[];r[i]=new Set(d)}),e.fields=r}}function Ts(e=new Date){try{return e.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return e.toISOString().slice(0,10)}}function xa(e){const t=fn()||[],{technicians:n=[]}=Be(),a=[].concat(Array.isArray(t)?t:[]).concat(Array.isArray(n)?n:[]),s=new Map;return a.forEach(o=>{if(!o||o.id==null)return;const i=String(o.id),l=s.get(i)||{};s.set(i,{...l,...o})}),(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(o=>({technicianId:o}))).map((o,i)=>{const l=o?.technicianId!=null?s.get(String(o.technicianId)):null;let u=o.positionLabel??o.position_name??o.position_label??o.role??o.position??l?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");(!u||u.trim()==="")&&(u=o.positionLabelAr??o.position_label_ar??o.positionLabelEn??o.position_label_en??o.position_name_ar??o.position_name_en??l?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"));try{const b=typeof yn=="function"?yn()||[]:[];let p=null;if(o?.positionId!=null&&(p=b.find(f=>String(f?.id)===String(o.positionId))||null),!p){const f=o.positionKey??o.position_key??o.positionName??o.position_name??o.position??"";if(f&&(p=typeof Ys=="function"&&Ys(f)||null,!p&&b.length)){const S=String(f).trim().toLowerCase();p=b.find(A=>[A.name,A.labelAr,A.labelEn].filter(Boolean).map(k=>String(k).toLowerCase()).includes(S))||null}}if(p){const f=p.labelAr||p.labelEn||p.name||"";f&&f.trim()&&(u=f)}}catch{}const d=tt(ut(o.positionCost??o.position_cost??o.cost??o.daily_wage??o.dailyWage??l?.dailyWage??l?.wage??0)),y=tt(ut(o.positionClientPrice??o.position_client_price??o.client_price??o.clientPrice??o.daily_total??o.dailyTotal??o.total??l?.dailyTotal??l?.total??l?.total_wage??0));return{assignmentId:o.assignmentId??o.assignment_id??`crew-${i}`,positionId:o.positionId??o.position_id??null,positionLabel:u,positionLabelAlt:o.positionLabelAlt??o.position_label_alt??"",positionCost:d,positionClientPrice:y,technicianId:o.technicianId!=null?String(o.technicianId):l?.id!=null?String(l.id):null,technicianName:o.technicianName??o.technician_name??l?.name??null,technicianRole:o.technicianRole??l?.role??null}})}function js(e,t,n){const{projectLinked:a}=kn(e,n);mn(e.start,e.end);const s=e.discount??e.discountValue??0,r=Number(I(String(s)))||0,o=e.discountType??e.discount_type??"percent",i=String(o).toLowerCase()==="amount"?"amount":"percent",l=a?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),u=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,d=u!=null?ut(u):Number.NaN,b=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied)===!0&&Number.isFinite(d)&&d>0?d:null,p=Array.isArray(t)?t.map(K=>K?.technicianId).filter(Boolean):[],f=is({items:Array.isArray(e.items)?e.items:[],technicianIds:p,crewAssignments:Array.isArray(t)?t:[],discount:r,discountType:i,applyTax:l,start:e.start,end:e.end,companySharePercent:b,groupingSource:e}),S=ut(e.cost??e.total??e.finalTotal),A=Number.isFinite(S),k=a?f.finalTotal:A?tt(S):f.finalTotal,w={equipmentTotal:f.equipmentTotal,equipmentCostTotal:f.equipmentCostTotal,crewTotal:f.crewTotal,crewCostTotal:f.crewCostTotal,discountAmount:f.discountAmount,subtotalAfterDiscount:f.subtotalAfterDiscount,taxableAmount:f.taxableAmount,taxAmount:f.taxAmount,finalTotal:k,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,netProfit:f.netProfit},O={equipmentTotal:xe(f.equipmentTotal),equipmentCostTotal:xe(f.equipmentCostTotal),crewTotal:xe(f.crewTotal),discountAmount:xe(f.discountAmount),subtotalAfterDiscount:xe(f.subtotalAfterDiscount),taxableAmount:xe(f.taxableAmount),taxAmount:xe(f.taxAmount),finalTotal:xe(k),companySharePercent:I((Number.isFinite(f.companySharePercent)?f.companySharePercent:0).toFixed(2)),companyShareAmount:xe(f.companyShareAmount),netProfit:I(f.netProfit.toFixed(2))};return{totals:w,totalsDisplay:O,rentalDays:f.rentalDays}}function bn(e){if(e==null||e==="")return null;const t=Number.parseFloat(I(String(e)));return Number.isFinite(t)?t:null}function Eo(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function ml(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n!=="percent"&&(n="amount");const a=bn(e.amount??(n==="amount"?e.value:null)),s=bn(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,o=e.note??e.memo??null,i=Eo(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:o,recordedAt:i}}function fl(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(ml).filter(Boolean);if(n.length>0)return n;const a=bn(e.paidPercent??e.paid_percent),s=bn(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,o=Eo(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:o}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:o}]:[]}function yl(e){if(!e)return c("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function gl(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function hl(e){if(Array.isArray(e?.expenses)&&e.expenses.some(a=>Number.isFinite(Number(a?.salePrice??a?.sale_price))))return e.expenses.reduce((a,s)=>a+(Number(s?.salePrice??s?.sale_price)||0),0);const t=Number(e?.servicesClientPrice??e?.services_client_price);return Number.isFinite(t)&&t>=0?t:typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((n,a)=>n+(Number(a?.amount)||0),0):0}function bl(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(I(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],o=r.length?r:Array.isArray(e.technicians)?e.technicians:[],i=cs(t,a,s,!1,o,{start:e.start,end:e.end,companySharePercent:0});if(Number.isFinite(i))return i;const l=Number(I(String(e.cost??0)));return Number.isFinite(l)?Math.round(l):0}function vl(e,t){if(!e)return"â€”";const n=Nt(e);return t?`${n} - ${Nt(t)}`:n}function qe(e,t="SR",n=2){const a=Number(e);return`${xe(a)} ${t}`}function ir(e,t=2){if(!Number.isFinite(Number(e)))return"0%";const n=Number.isInteger(t)?t:2;return`${I(Number(e).toFixed(n))}%`}function qo(){if(!m)return!1;if((m.context||"reservation")==="project"){const a=m.project||{};if([a.companyShareEnabled,a.company_share_enabled,a.companyShareApplied,a.company_share_applied].some(r=>r===!0||r==="true"))return!0;const s=m.projectTotals||{};return!!(Number.isFinite(Number(s.companyShareAmount))&&Number(s.companyShareAmount)>0)}const t=m.reservation||{};if([t.companyShareEnabled,t.company_share_enabled,t.companyShareApplied,t.company_share_applied].some(a=>a===!0||a==="true"))return!0;const n=m.totals||{};return Number.isFinite(Number(n.companyShareAmount))&&Number(n.companyShareAmount)>0}function Sl(){if(!m)return!1;if((m.context||"reservation")==="project"){const a=m.project||{};if([a.applyTax,a.apply_tax].some(r=>r===!0||r==="true"))return!0;const s=m.projectTotals||{};return[s.applyTax].some(r=>r===!0||r==="true")?!0:Number.isFinite(Number(s.taxAmount))&&Number(s.taxAmount)>0}const t=m.reservation||{};if([t.applyTax,t.apply_tax,t.taxApplied,t.tax_applied].some(a=>a===!0||a==="true"))return!0;const n=m.totals||{};return Number.isFinite(Number(n.taxAmount))&&Number(n.taxAmount)>0}function wl(){return qo()&&Sl()}function kl(){if(!m)return null;const t=(m.context||"reservation")==="project"?[m.project?.companySharePercent,m.project?.company_share_percent,m.project?.companyShare,m.project?.company_share,m.projectTotals?.companySharePercent,m.projectTotals?.projectSharePercent]:[m.reservation?.companySharePercent,m.reservation?.company_share_percent,m.reservation?.companyShare,m.reservation?.company_share,m.totals?.companySharePercent];for(let n=0;n<t.length;n+=1){const a=t[n],s=Number(a);if(Number.isFinite(s)&&s>0)return s}return null}function Il(){if(!qo())return 0;const e=kl();return Number.isFinite(e)&&e>0?e:zt}function Al(){if(!wl())return 1;const e=Il();return e>0?1+e/100:1}function it(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return t;const n=Al();return n===1?t:Number((t*n).toFixed(2))}function El(e){if(!e?.start)return null;if(!e?.end)return 1;const t=mn(e.start,e.end);return Number.isFinite(t)?t:1}function ql(e){return Number.isFinite(e)?e<=1?"ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯":`${I(String(Math.round(e)))} Ø£ÙŠØ§Ù…`:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}function cr(e){const t=c("reservations.create.summary.currency","SR"),n=Be()||{},a=Array.isArray(n.customers)?n.customers:[],s=Array.isArray(n.projects)?n.projects:[],r=Array.isArray(n.technicians)?n.technicians:[];let o=[];try{const g=Sa?.()||[];o=Array.isArray(g)&&g.length?g:n.reservations||[]}catch{o=n.reservations||[]}const i=e?.id!=null?s.find(g=>String(g.id)===String(e.id))||e:e||null,l={projectStatusLabel:c("projects.status.ongoing","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"),paymentStatusLabel:c("projects.paymentStatus.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹")};if(!i)return{project:null,customer:null,clientInfo:{name:"-",company:"-",phone:"-",email:"-"},projectInfo:{title:"-",code:"-",typeLabel:"-",startDisplay:"-",endDisplay:"-",durationLabel:"-",statusLabel:l.projectStatusLabel},expenses:[],equipment:[],reservations:[],totals:{equipmentEstimate:0,expensesTotal:0,baseSubtotal:0,discountAmount:0,subtotalAfterDiscount:0,companyShareAmount:0,subtotal:0,applyTax:!1,taxAmount:0,totalWithTax:0},totalsDisplay:{projectSubtotal:qe(0,t),expensesTotal:qe(0,t),reservationsTotal:qe(0,t),discountAmount:qe(0,t),taxAmount:qe(0,t),overallTotal:qe(0,t),paidAmount:qe(0,t),remainingAmount:qe(0,t)},projectTotals:{combinedTaxAmount:0,overallTotal:0,reservationsTotal:0,paidAmount:0,paidPercent:0,remainingAmount:0,paymentStatus:"unpaid"},paymentSummary:{status:"unpaid",statusLabel:l.paymentStatusLabel,paidAmount:0,paidPercent:0,remainingAmount:0,paidAmountDisplay:qe(0,t),remainingAmountDisplay:qe(0,t),paidPercentDisplay:ir(0)},notes:"",currencyLabel:t,projectStatus:"ongoing",projectStatusLabel:l.projectStatusLabel,projectDurationDays:null,projectDurationLabel:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",paymentHistory:[]};const u=i.clientId??i.customerId??i.client_id??i.customer_id??null,d=u!=null&&a.find(g=>String(g.id)===String(u))||null,y=d?.customerName??d?.name??i.clientName??i.customerName??c("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),b=(i.clientCompany||d?.companyName||d?.company||"").trim(),p=d?.phone??d?.customerPhone??i.clientPhone??i.customerPhone??"",f=p?I(String(p).trim()):c("projects.details.client.noPhone","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…ØªØ§Ø­"),S=d?.email??i.clientEmail??i.customerEmail??"",A=S?String(S).trim():c("projects.details.client.noEmail","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ù…ØªØ§Ø­"),k=i.projectCode||`PRJ-${I(String(i.id??""))}`,w=I(String(k)),O=(i.title||"").trim()||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"),K=yl(i.type),Y=i.start?Nt(i.start):"â€”",v=i.end?Nt(i.end):"â€”",N=El(i),q=N!=null?ql(N):"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",E=gl(i),J={upcoming:"Ù‚Ø§Ø¯Ù…",ongoing:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",completed:"Ù…ÙƒØªÙ…Ù„"},B=c(`projects.status.${E}`,J[E]||E),Z=i.id!=null?String(i.id):null,D=Z?o.filter(g=>{const $=g?.projectId??g?.project_id??null;return $!=null&&String($)===Z}):[];D.map(g=>{const $=g.reservationId||g.id||"",M=g.status||g.state||"pending",ee=String(M).toLowerCase(),ne=c(`reservations.status.${ee}`,ee),se=bl(g),ge=g.start?new Date(g.start).getTime():0;return{reservationId:I(String($||"-")),status:ee,statusLabel:ne,total:se,totalLabel:qe(se,t),dateRange:vl(g.start,g.end),startTimestamp:Number.isNaN(ge)?0:ge}}).sort((g,$)=>$.startTimestamp-g.startTimestamp).map(({startTimestamp:g,...$})=>$);let U=0,L=0;try{D.forEach(g=>{const $=is({items:Array.isArray(g.items)?g.items:[],technicianIds:Array.isArray(g.technicians)?g.technicians:[],crewAssignments:Array.isArray(g.crewAssignments)?g.crewAssignments:[],discount:Number(g.discount??0)||0,discountType:g.discountType||"percent",applyTax:!1,start:g.start,end:g.end,groupingSource:g,companySharePercent:0});U+=Number($.equipmentTotal||0),L+=Number($.crewTotal||0)})}catch{}const T=hl(i),R=Number(U+L+T),V=[];try{D.forEach(g=>{const{groups:$}=tn(g);$.forEach(M=>{const ee=Number(M?.count??M?.quantity??1)||1,ne=Number(M?.unitPrice);let se=Number.isFinite(ne)?ne:0;if(!se||se<=0){const He=Number(M?.totalPrice);Number.isFinite(He)&&ee>0&&(se=Number((He/ee).toFixed(2)))}Number.isFinite(se)||(se=0);const ge=M?.type==="package"||Array.isArray(M?.items)&&M.items.some(He=>He?.type==="package"),ie=Array.isArray(M?.barcodes)&&M.barcodes.length?M.barcodes[0]:Array.isArray(M?.items)&&M.items.length?M.items[0]?.barcode:null;let ce=M?.packageDisplayCode??M?.package_code??M?.code??M?.packageCode??(Array.isArray(M?.items)&&M.items.length?M.items[0]?.package_code??M.items[0]?.code??M.items[0]?.packageCode:null);const Ge=He=>{const ot=(He==null?"":String(He)).trim();return!!(!ot||/^pkg-/i.test(ot)||/^\d+$/.test(ot)&&ot.length<=4)};if(!ce||Ge(ce)){const He=M?.packageId??M?.package_id??(Array.isArray(M?.items)&&M.items.length?M.items[0]?.packageId??M.items[0]?.package_id:null);if(He)try{const ot=ds(He);ot&&ot.package_code&&(ce=ot.package_code)}catch{}}if(!ce||Ge(ce))try{const He=dn(M?.description||"");if(He){const ot=Fr();let ht=ot.find($t=>dn($t?.name||$t?.title||$t?.label||"")===He);ht||(ht=ot.find($t=>{const Ut=dn($t?.name||$t?.title||$t?.label||"");return Ut.includes(He)||He.includes(Ut)})),ht&&ht.package_code&&(ce=ht.package_code)}}catch{}const Ke=ge?ce??ie??"":M?.barcode??ie??"",ft=Ke!=null?String(Ke):"",rn=Number.isFinite(Number(M?.totalPrice))?Number(M.totalPrice):Number((se*ee).toFixed(2));V.push({...M,isPackage:ge,desc:M?.description,barcode:ft,packageCodeResolved:ce||"",qty:ee,price:se,totalPrice:tt(rn),unitPriceValue:se})})})}catch{}const F=new Map;D.forEach(g=>{const $=Array.isArray(g.items)?g.items:[],M=mn(g.start,g.end),ee=g.reservationId||g.id||"";$.forEach((ne,se)=>{if(!ne)return;const ge=ne.barcode||ne.code||ne.id||ne.desc||ne.description||`item-${se}`,ie=String(ge||`item-${se}`),ce=F.get(ie)||{description:ne.desc||ne.description||ne.name||ne.barcode||`#${I(String(se+1))}`,totalQuantity:0,reservationsCount:0,reservationIds:new Set,totalCost:0},Ge=Number(ne.qty)||1,Ke=Number(ne.price)||0;ce.totalQuantity+=Ge,ce.reservationIds.add(String(ee));const ft=Ke*Ge*Math.max(1,M);Number.isFinite(ft)&&(ce.totalCost+=ft),F.set(ie,ce)})});const j=Array.from(F.values()).map(g=>({description:g.description,totalQuantity:g.totalQuantity,reservationsCount:g.reservationIds.size,displayCost:qe(g.totalCost,t)})),W=new Map((r||[]).filter(Boolean).map(g=>[String(g.id),g])),oe=new Map,te=g=>{if(!g)return;let $=null;typeof g=="object"?$=g.id??g.technicianId??g.technician_id??g.userId??g.user_id??null:(typeof g=="string"||typeof g=="number")&&($=g);const M=$!=null?String($):null,ee=M&&W.has(M)?W.get(M):typeof g=="object"?g:null,ne=ee?.name||ee?.full_name||ee?.fullName||ee?.displayName||(typeof g=="string"?g:null),se=ee?.role||ee?.title||null,ge=ee?.phone||ee?.mobile||ee?.contact||null;if(!ne&&!M)return;const ie=M||ne;oe.has(ie)||oe.set(ie,{id:M,name:ne||"-",role:se||null,phone:ge||null})};Array.isArray(i?.technicians)&&i.technicians.forEach(g=>te(g)),D.forEach(g=>{(Array.isArray(g.crewAssignments)&&g.crewAssignments.length?g.crewAssignments:Array.isArray(g.technicians)?g.technicians.map(M=>({technicianId:M})):[]).forEach(M=>te(M))});const me=Array.from(oe.values()),ve=Array.isArray(i.expenses)?i.expenses.map(g=>{const $=Number(g?.salePrice??g?.sale_price??g?.amount)||0;return{label:g?.label||g?.name||"-",amount:$,displayAmount:qe($,t),note:g?.note||g?.description||""}}):[],Q=i?.applyTax===!0||i?.applyTax==="true",Ae=Number.parseFloat(i?.discount??i?.discountValue??0)||0;let ke=(i?.discountType==="amount"?"amount":"percent")==="amount"?Ae:R*(Ae/100);(!Number.isFinite(ke)||ke<0)&&(ke=0),ke>R&&(ke=R);const Me=Math.max(0,R-ke),Le=i?.companyShareEnabled===!0||i?.company_share_enabled===!0||i?.companyShareApplied===!0||i?.company_share_applied===!0,Ne=Number.parseFloat(i?.companySharePercent??i?.company_share_percent??i?.companyShare??i?.company_share??0)||0,_e=Le&&Ne>0?Ne:0,et=_e>0?Number((Me*(_e/100)).toFixed(2)):0,Oe=Number((Me+et).toFixed(2)),Pe=Q?Number((Oe*Ni).toFixed(2)):0,De=Number((Oe+Pe).toFixed(2)),G=fl(i),pe=bn(i.paidAmount??i.paid_amount)||0,H=bn(i.paidPercent??i.paid_percent)||0,ae=Fn({totalAmount:De,paidAmount:pe,paidPercent:H,history:G}),Ce=typeof i.paymentStatus=="string"?i.paymentStatus.toLowerCase():"",Ie=Rn({manualStatus:Ce,paidAmount:ae.paidAmount,paidPercent:ae.paidPercent,totalAmount:De}),we={paid:"Ù…Ø¯ÙÙˆØ¹",partial:"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹",unpaid:"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"},Te=c(`projects.paymentStatus.${Ie}`,we[Ie]||Ie),$e=Number(ae.paidAmount||0),Fe=Number(ae.paidPercent||0),C=Math.max(0,Number((De-$e).toFixed(2))),le={projectSubtotal:qe(Oe,t),expensesTotal:qe(T,t),reservationsTotal:qe(Oe,t),discountAmount:qe(ke,t),taxAmount:qe(Pe,t),overallTotal:qe(De,t),paidAmount:qe($e,t),remainingAmount:qe(C,t)},re={status:Ie,statusLabel:Te,paidAmount:$e,paidPercent:Fe,remainingAmount:C,paidAmountDisplay:qe($e,t),remainingAmountDisplay:qe(C,t),paidPercentDisplay:ir(Fe)},_=(i.description||"").trim();return{project:i,customer:d,clientInfo:{name:y,company:b||"â€”",phone:f,email:A},projectInfo:{title:O,code:w,typeLabel:K,startDisplay:Y,endDisplay:v,durationLabel:q,statusLabel:B},expenses:ve,equipment:j,crew:me,equipmentItems:V,crewAssignments:D.flatMap(g=>xa(g)),totals:{equipmentEstimate:U,expensesTotal:T,baseSubtotal:R,discountAmount:ke,subtotalAfterDiscount:Me,companyShareAmount:et,subtotal:Oe,applyTax:Q,taxAmount:Pe,totalWithTax:De},totalsDisplay:le,projectTotals:{combinedTaxAmount:Pe,overallTotal:De,reservationsTotal:Oe,paidAmount:$e,paidPercent:Fe,remainingAmount:C,paymentStatus:Ie},paymentSummary:re,notes:_,currencyLabel:t,projectStatus:E,projectStatusLabel:B,projectDurationDays:N,projectDurationLabel:q,paymentHistory:G}}function _l({project:e,clientInfo:t={},projectInfo:n={},projectCrew:a=[],projectExpenses:s=[],projectEquipment:r=[],totalsDisplay:o={},projectTotals:i={},paymentSummary:l={},currencyLabel:u="SR",sections:d,fieldSelections:y={},quoteNumber:b,quoteDate:p,terms:f=pt,rootAttributes:S=""}){const A=Cs(y),k=(C,le)=>$s(A,C,le),w=C=>d?.has?.(C),O=`<div class="quote-placeholder">${h(c("reservations.quote.placeholder.noFields","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."))}</div>`,K=(C,le)=>`<div class="info-plain__item">
      <span class="info-plain__label">${h(C)}</span>
      <span class="info-plain__separator">:</span>
      <span class="info-plain__value">${h(le)}</span>
    </div>`,Y=(C,le,{variant:re="inline"}={})=>re==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${h(C)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${h(le)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${h(C)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${h(le)}</span>
    </span>`,v=(C,le)=>`<div class="payment-row">
      <span class="payment-row__label">${h(C)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${h(le)}</span>
    </div>`,N=(C,le,re)=>{const _=`${C}-title`,z=`${C}-content`;return`
      <div class="quote-section__head" data-drag-key="${h(_)}">
        ${le}
      </div>
      <div class="quote-section__body" data-drag-key="${h(z)}">
        ${re}
      </div>
    `},q=[];k("customerInfo","customerName")&&q.push(K(c("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.name||"-")),k("customerInfo","customerCompany")&&q.push(K(c("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.company||"â€”")),k("customerInfo","customerPhone")&&q.push(K(c("projects.details.labels.clientPhone","Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.phone||"-")),k("customerInfo","customerEmail")&&q.push(K(c("projects.details.labels.clientEmail","Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"),t.email||"-"));const E=Nn(m,"projectCustomer"),J=w("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        ${N("customer",`<h3 class="quote-section__title">${h(c("projects.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"))}</h3>`,q.length?`<div class="${E}">${q.join("")}</div>`:O)}
      </section>`:"",B=[];k("projectInfo","projectType")&&B.push(K(c("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.typeLabel||"-")),k("projectInfo","projectTitle")&&B.push(K(c("projects.details.projectTitle","Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.title||"-")),k("projectInfo","projectCode")&&B.push(K(c("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.code||"-")),k("projectInfo","projectStart")&&B.push(K(c("projects.details.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.startDisplay||"-")),k("projectInfo","projectEnd")&&B.push(K(c("projects.details.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.endDisplay||"-")),k("projectInfo","projectDuration")&&B.push(K(c("projects.details.duration","Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.durationLabel||"-")),k("projectInfo","projectStatus")&&B.push(K(c("projects.details.status","Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.statusLabel||"-"));const Z=Nn(m,"projectDetails"),D=w("projectInfo")?`<section class="quote-section quote-section--plain quote-section--project">
        ${N("project",`<h3 class="quote-section__title">${h(c("projects.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>`,B.length?`<div class="${Z}">${B.join("")}</div>`:O)}
      </section>`:"",U=Ia.filter(C=>k("projectCrew",C.id)),L=Array.isArray(m?.crewAssignments)?m.crewAssignments:[],T=C=>{const le=C&&C.positionId!=null?`id:${String(C.positionId)}`:(()=>{const z=(C?.positionLabel||C?.position_name||C?.position||"").trim().toLowerCase();return z?`label:${z}`:""})(),re=Number.isFinite(Number(C?.positionClientPrice))?Number(C.positionClientPrice):0,_=re>0?`|p:${re.toFixed(2)}`:"";return`${le}${_}`};(()=>{const C=new Map;return L.forEach(le=>{const re=T(le);re&&C.set(re,(C.get(re)||0)+1)}),C})();const R=(()=>{const C=[];if(U.forEach(g=>{g.id==="position"?(C.push({...g,render:$=>{const M=typeof je=="function"?je():"ar";let ee=$?.positionLabelEn??$?.position_label_en??$?.position_name_en??$?.positionLabelAlt??$?.position_label_alt??$?.role;if(!ee&&M==="en")try{const ge=typeof yn=="function"?yn():[];let ie=null;if($?.positionId!=null&&(ie=ge.find(ce=>String(ce.id)===String($.positionId))||null),!ie){const ce=$?.positionKey??$?.position_key??$?.positionName??$?.position_name??$?.position??"";if(ce){const Ge=String(ce).toLowerCase();ie=ge.find(Ke=>String(Ke.name).toLowerCase()===Ge)||null}}ie&&(ee=ie.labelEn??ie.label_en??ie.name_en??ee)}catch{}const ne=$?.positionLabel??$?.position_name??$?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return h(I(String(M==="en"&&ee?ee:ne)))}}),k("projectCrew","quantity")&&C.push({id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:$=>h(I(String(Math.max(1,Number($?.__count||1)))))})):g.id==="price"?C.push({...g,render:$=>{const M=Number.isFinite(Number($?.positionClientPrice))?Number($.positionClientPrice):0,ee=Math.max(1,Number($?.__count||1)),ne=Math.max(1,Number(m?.rentalDays||1)),ge=it(M)*ee*ne;return h(`${xe(ge)} ${c("reservations.create.summary.currency","SR")}`)}}):g.id==="unitPrice"?C.push({...g,render:$=>{const M=Number.isFinite(Number($?.positionClientPrice))?Number($.positionClientPrice):0,ee=it(M);return h(`${xe(ee)} ${c("reservations.create.summary.currency","SR")}`)}}):C.push(g)}),k("projectCrew","days")){const g=Math.max(1,Number(m?.rentalDays||1)),$=C.findIndex(ee=>ee.id==="price"),M=Math.max(0,$);C.splice(M,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(I(String(g)))})}const le=new Map(C.map(g=>[g.id,g])),re=new Set,_=[],z=g=>{const $=le.get(g);$&&!re.has(g)&&(_.push($),re.add(g))};return z("rowNumber"),z("position"),z("unitPrice"),z("quantity"),z("days"),z("price"),C.forEach(g=>{re.has(g.id)||(_.push(g),re.add(g.id))}),_})(),V=(()=>{const C=new Map;return L.forEach(le=>{const re=T(le);if(!re)return;const _=C.get(re);_?_.__count+=1:C.set(re,{...le,__count:1})}),Array.from(C.values())})(),F=(()=>{try{const C=Math.max(1,Number(m?.rentalDays||1)),le=(V||[]).reduce((re,_)=>{const z=Number.isFinite(Number(_?.positionClientPrice))?Number(_.positionClientPrice):0,g=Math.max(1,Number(_?.__count||1)),$=it(z);return re+$*g*C},0);return xe(le)}catch{return"0.00"}})(),j=w("projectCrew")?R.length?`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.crew","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${R.map(C=>`<th>${h(C.labelKey?c(C.labelKey,C.fallback):C.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${V.length?V.map((C,le)=>`<tr>${R.map(re=>`<td><div class="quote-cell">${re.render(C,le)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(R.length,1)}" class="empty">${h(c("projects.details.crew.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù‚Ù… ÙÙ†ÙŠ Ù…Ø±ØªØ¨Ø·."))}</td></tr>`}
              </tbody>
            </table>
            ${k("projectCrew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${F} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.crew","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            ${O}
          </section>`:"",W=[];k("financialSummary","discountAmount")&&W.push(Y(c("reservations.details.labels.discount","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…"),o.discountAmount||qe(0,u)));const oe=c("projects.details.summary.preTaxTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©");k("financialSummary","reservationsTotal")&&W.push(Y(oe,o.reservationsTotal||qe(0,u))),k("financialSummary","taxAmount")&&W.push(Y(c("projects.details.summary.combinedTax","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),o.taxAmount||qe(0,u)));const te=[];k("financialSummary","overallTotal")&&te.push(Y(c("projects.details.summary.overallTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"),o.overallTotal||qe(0,u),{variant:"final"}));const me=w("financialSummary")?!W.length&&!te.length?`<section class="quote-section quote-section--financial">${O}</section>`:`<section class="quote-section quote-section--financial">
          ${N("projectFinancial",`<h3>${h(c("projects.quote.sections.financial","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</h3>`,`<div class="totals-block">
              ${W.length?`<div class="totals-inline">${W.join("")}</div>`:""}
              ${te.length?`<div class="totals-final">${te.join("")}</div>`:""}
            </div>`)}
        </section>`:"",ve=Jr.filter(C=>k("projectExpenses",C.id)),Q=(()=>{const C=[...ve];return C.forEach(le=>{le.id==="amount"&&(le.render=re=>{const _=re?.salePrice??re?.sale_price,z=_??re?.amount,g=Number(z),$=it(Number.isFinite(g)?g:0);return h(qe($,u))})}),C})(),Ae=(()=>{try{const C=s.reduce((le,re)=>{const _=re?.salePrice??re?.sale_price,z=_??re?.amount,g=Number(z),$=it(Number.isFinite(g)?g:0);return le+$},0);return xe(C)}catch{return xe(0)}})(),ue=w("projectExpenses")?Q.length?`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.expenses","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Q.map(C=>`<th>${h(C.labelKey?c(C.labelKey,C.fallback):C.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${s.length?s.map((C,le)=>`<tr>${Q.map(re=>`<td><div class="quote-cell">${re.render(C,le)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(Q.length,1)}" class="empty">${h(c("projects.details.expenses.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©."))}</td></tr>`}
              </tbody>
            </table>
            ${k("projectExpenses","expensesSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("projects.details.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${Ae} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.expenses","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</h3>
            ${O}
          </section>`:"",ke=ka.filter(C=>k("projectEquipment",C.id)),Me=(()=>{let C=[];if(ke.forEach(z=>{z.id==="price"?C.push({...z,render:g=>{const $=Number.isFinite(Number(g?.unitPriceValue))?Number(g.unitPriceValue):0,M=Number.isFinite(Number(g?.qty))?Math.max(1,Number(g.qty)):1,ee=Math.max(1,Number(m?.rentalDays||1)),se=it($)*M*ee;return h(`${xe(se)} ${c("reservations.create.summary.currency","SR")}`)}}):z.id==="unitPrice"?C.push({...z,render:g=>{const $=Number.isFinite(Number(g?.unitPriceValue))?Number(g.unitPriceValue):0,M=it($);return h(`${xe(M)} ${c("reservations.create.summary.currency","SR")}`)}}):C.push(z)}),k("projectEquipment","days")){const z=Math.max(1,Number(m?.rentalDays||1)),g=C.findIndex(M=>M.id==="price"),$=Math.max(0,g);C.splice($,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(I(String(z)))})}const le=new Map(C.map(z=>[z.id,z])),re=C.filter(z=>!["unitPrice","quantity","days","price"].includes(z.id)),_=["unitPrice","quantity","days","price"].map(z=>le.get(z)).filter(Boolean);return C=[...re,..._],C})(),Le=Array.isArray(m?.equipmentItems)?m.equipmentItems:[],Ne=(()=>{try{const C=Math.max(1,Number(m?.rentalDays||1)),le=(Le||[]).reduce((re,_)=>{const z=Number.isFinite(Number(_?.unitPriceValue))?Number(_.unitPriceValue):0,g=Number.isFinite(Number(_?.qty))?Math.max(1,Number(_.qty)):1,$=it(z);return re+$*g*C},0);return xe(le)}catch{return"0.00"}})(),_e=w("projectEquipment")?Me.length?`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Me.map(C=>`<th>${h(C.labelKey?c(C.labelKey,C.fallback):C.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${Le.length?Le.map((C,le)=>`<tr>${Me.map(re=>`<td><div class="quote-cell">${re.render(C,le)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(Me.length,1)}" class="empty">${h(c("projects.details.equipment.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."))}</td></tr>`}
              </tbody>
            </table>
            ${k("projectEquipment","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.equipmentTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${Ne} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            ${O}
          </section>`:"",et=(e?.description||"").trim()||"",Oe=w("projectNotes")?`<section class="quote-section">
        <h3>${h(c("projects.quote.sections.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>
        <div class="quote-notes">${h(et||c("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹."))}</div>
      </section>`:"",Pe=[];k("payment","beneficiary")&&Pe.push(v(c("reservations.quote.labels.beneficiary","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"),We.beneficiaryName)),k("payment","bank")&&Pe.push(v(c("reservations.quote.labels.bank","Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"),We.bankName)),k("payment","account")&&Pe.push(v(c("reservations.quote.labels.account","Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"),I(We.accountNumber))),k("payment","iban")&&Pe.push(v(c("reservations.quote.labels.iban","Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"),I(We.iban)));const De=`<section class="quote-section">
      <div class="payment-block">
        <h3>${h(c("reservations.quote.sections.payment","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹"))}</h3>
        <div class="payment-rows">${Pe.length?Pe.join(""):O}</div>
      </div>
      <p class="quote-approval-note">${h(We.approvalNote)}</p>
    </section>`,G=Array.isArray(f)&&f.length?f:pt,pe=`<footer class="quote-footer">
        <h4>${h(c("reservations.quote.labels.terms","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©"))}</h4>
        <ul>${G.map(C=>`<li>${h(C)}</li>`).join("")}</ul>
      </footer>`,H=[],ae=[];if(D&&ae.push({key:"project",html:D}),J&&ae.push({key:"customer",html:J}),ae.length>1){const C=ae.find(_=>_.key==="project"),le=ae.find(_=>_.key==="customer"),re=[];C?.html&&re.push(C.html),le?.html&&re.push(le.html),H.push(Re(`<div class="quote-section-row quote-section-row--primary">${re.join("")}</div>`,{blockType:"group"}))}else ae.length===1&&H.push(Re(ae[0].html));const Ce=[];j&&Ce.push(Re(j,{blockType:"table",extraAttributes:'data-table-id="project-crew"'})),ue&&Ce.push(Re(ue,{blockType:"table",extraAttributes:'data-table-id="project-expenses"'})),_e&&Ce.push(Re(_e,{blockType:"table",extraAttributes:'data-table-id="project-equipment"'}));const Ie=[];me&&Ie.push(Re(me,{blockType:"summary"})),Oe&&Ie.push(Re(Oe));let we=[];we=[...w("payment")?[Re(De,{blockType:"payment"})]:[],Re(pe,{blockType:"footer"})];const Te=[...ua(H,"projects.quote.placeholder.primary"),...Ce,...ua(Ie,"projects.quote.placeholder.summary"),...we],$e=typeof je=="function"?je():"ar",Fe=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${h(We.logoUrl)}" alt="${h(We.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${h(c("projects.quote.title","Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h1>
        <p class="quote-company-name">${h(c("quote.companyName",We.companyName))}</p>
        <p class="quote-company-cr">${h(c("reservations.quote.labels.cr","Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"))}: ${h(We.commercialRegistry)}</p>
        <p class="quote-company-license">${h(c("reservations.quote.labels.mediaLicense","ØªØ±Ø®ÙŠØµ Ø¥Ø¹Ù„Ø§Ù…ÙŠ"))}: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${h(c("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
          <strong>${h(b)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${h(c("projects.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${h(p)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl" data-lang="${h($e)}"${S}>
      <style>${ao}${no}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${Fe}
          ${Te.join("")}
        </div>
      </div>
    </div>
  `}function _o(e={}){const t={context:e?.context||Ct(),blockOffsets:e?.blockOffsets||m?.blockOffsets||null,infoAlignments:e?.infoAlignments||m?.infoAlignments||null},n=Cc(t),a=Ot;Ot=t;try{if(e?.context==="project")return _l({...e,rootAttributes:n});const{reservation:s,customer:r,project:o,crewAssignments:i,totals:l,totalsDisplay:u,rentalDays:d,currencyLabel:y,sections:b,fieldSelections:p={},quoteNumber:f,quoteDate:S,terms:A=pt}=e,k=I(String(s?.reservationId??s?.id??"")),w=typeof je=="function"?je():"ar",O=s.start?I(Nt(s.start)):"-",K=s.end?I(Nt(s.end)):"-",Y=r?.customerName||r?.full_name||r?.name||"-",v=r?.phone||"-",N=r?.email||"-",q=r?.company||r?.company_name||"-",E=I(v),J=o?.title||o?.name||c("reservations.details.project.none","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),B=o?.code||o?.projectCode||"",Z=I(String(d)),D=s?.notes||"",U=Array.isArray(A)&&A.length?A:pt,L=Cs(p),T=(x,ye)=>$s(L,x,ye),R=x=>b?.has?.(x),V=`<div class="quote-placeholder">${h(c("reservations.quote.placeholder.noFields","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."))}</div>`,F=(x,ye)=>{const he=w==="en"?": ":" / ";return`<div class="info-plain__item">${h(x)}<span class="info-plain__slash">${he}</span><strong class="info-plain__value">${h(ye)}</strong></div>`},j=(x,ye,{variant:he="inline"}={})=>he==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${h(x)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${h(ye)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${h(x)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${h(ye)}</span>
    </span>`,W=(x,ye)=>`<div class="payment-row">
      <span class="payment-row__label">${h(x)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${h(ye)}</span>
    </div>`,oe=(x,ye,he)=>{const Ee=`${x}-title`,Ve=`${x}-content`;return`
      <div class="quote-section__head" data-drag-key="${h(Ee)}">
        ${ye}
      </div>
      <div class="quote-section__body" data-drag-key="${h(Ve)}">
        ${he}
      </div>
    `},te=[];T("customerInfo","customerName")&&te.push(F(c("reservations.details.labels.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„"),Y)),T("customerInfo","customerCompany")&&te.push(F(c("reservations.details.labels.company","Ø§Ù„Ø´Ø±ÙƒØ©"),q)),T("customerInfo","customerPhone")&&te.push(F(c("reservations.details.labels.phone","Ø§Ù„Ù‡Ø§ØªÙ"),E)),T("customerInfo","customerEmail")&&te.push(F(c("reservations.details.labels.email","Ø§Ù„Ø¨Ø±ÙŠØ¯"),N));const me=Nn(m,"customer"),ve=R("customerInfo")&&te.length?`<section class="quote-section quote-section--plain quote-section--customer">
            ${oe("customer",`<h3 class="quote-section__title">${h(c("reservations.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"))}</h3>`,`<div class="${me}">${te.join("")}</div>`)}
          </section>`:"",Q=[];T("reservationInfo","reservationId")&&Q.push(F(c("reservations.details.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"),k||"-")),T("reservationInfo","reservationStart")&&Q.push(F(c("reservations.details.labels.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),O)),T("reservationInfo","reservationEnd")&&Q.push(F(c("reservations.details.labels.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),K)),T("reservationInfo","reservationDuration")&&Q.push(F(c("reservations.details.labels.duration","Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),Z));const Ae=Nn(m,"reservation"),ue=R("reservationInfo")&&Q.length?`<section class="quote-section quote-section--plain quote-section--reservation">
            ${oe("reservation",`<h3 class="quote-section__title">${h(c("reservations.quote.sections.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"))}</h3>`,`<div class="${Ae}">${Q.join("")}</div>`)}
          </section>`:"",ke=[];T("projectInfo","projectTitle")&&ke.push(F(c("reservations.details.labels.project","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),J)),T("projectInfo","projectCode")&&ke.push(F(c("reservations.details.labels.code","Ø§Ù„Ø±Ù…Ø²"),B||"-"));const Me=Nn(m,"project"),Le=R("projectInfo")&&ke.length?`<section class="quote-section quote-section--plain quote-section--project">
            ${oe("project",`<h3 class="quote-section__title">${h(c("reservations.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>`,`<div class="${Me}">${ke.join("")}</div>`)}
          </section>`:"",Ne=[];T("financialSummary","discountAmount")&&Ne.push(j(c("reservations.details.labels.discount","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…"),`${u.discountAmount} ${y}`)),T("financialSummary","subtotalBeforeTax")&&Ne.push(j(c("reservations.details.labels.subtotalBeforeTax","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),`${u.taxableAmount} ${y}`)),T("financialSummary","taxAmount")&&Ne.push(j(c("reservations.details.labels.tax","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),`${u.taxAmount} ${y}`));const _e=T("financialSummary","finalTotal"),et=[];_e&&et.push(j(c("reservations.details.labels.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),`${u.finalTotal} ${y}`,{variant:"final"}));const Oe=et.length?`<div class="totals-final">${et.join("")}</div>`:"",Pe=R("financialSummary")?!Ne.length&&!_e?`<section class="quote-section quote-section--financial">${V}</section>`:`<section class="quote-section quote-section--financial">
          ${oe("financial",`<h3 class="quote-section__title">${h(c("reservations.details.labels.summary","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</h3>`,`<div class="totals-block">
              ${Ne.length?`<div class="totals-inline">${Ne.join("")}</div>`:""}
              ${Oe}
            </div>`)}
        </section>`:"",{groups:De}=tn(s),G=De.map(x=>{const ye=Number(x?.count??x?.quantity??1)||1,he=Number(x?.unitPrice);let Ee=Number.isFinite(he)?he:0;if(!Ee||Ee<=0){const ze=Number(x?.totalPrice);Number.isFinite(ze)&&ye>0&&(Ee=Number((ze/ye).toFixed(2)))}Number.isFinite(Ee)||(Ee=0);const Ve=x?.type==="package"||Array.isArray(x?.items)&&x.items.some(ze=>ze?.type==="package"),at=Array.isArray(x?.barcodes)&&x.barcodes.length?x.barcodes[0]:Array.isArray(x?.items)&&x.items.length?x.items[0]?.barcode:null;let de=x?.packageDisplayCode??x?.package_code??x?.code??x?.packageCode??(Array.isArray(x?.items)&&x.items.length?x.items[0]?.package_code??x.items[0]?.code??x.items[0]?.packageCode:null);const fe=ze=>{const Qe=(ze==null?"":String(ze)).trim();return!!(!Qe||/^pkg-/i.test(Qe)||/^\d+$/.test(Qe)&&Qe.length<=4)};if(!de||fe(de)){const ze=x?.packageId??x?.package_id??(Array.isArray(x?.items)&&x.items.length?x.items[0]?.packageId??x.items[0]?.package_id:null);if(ze)try{const Qe=ds(ze);Qe&&Qe.package_code&&(de=Qe.package_code)}catch{}}if(!de||fe(de))try{const ze=dn(x?.description||"");if(ze){const Qe=Fr();let Dt=Qe.find(xt=>dn(xt?.name||xt?.title||xt?.label||"")===ze);Dt||(Dt=Qe.find(xt=>{const on=dn(xt?.name||xt?.title||xt?.label||"");return on.includes(ze)||ze.includes(on)})),Dt&&Dt.package_code&&(de=Dt.package_code)}}catch{}const Ue=Ve?de??at??"":x?.barcode??at??"",Xe=Ue!=null?String(Ue):"";let kt=Number.isFinite(Number(x?.totalPrice))?Number(x.totalPrice):Number((Ee*ye).toFixed(2));return kt=tt(kt),{...x,isPackage:Ve,desc:x?.description,barcode:Xe,packageCodeResolved:de||"",qty:ye,price:kt,totalPrice:kt,unitPriceValue:Ee}}),pe=ka.filter(x=>T("items",x.id)),H=(()=>{let x=[];pe.forEach(de=>{de.id==="price"?x.push({...de,render:fe=>{const Ue=Number.isFinite(Number(fe?.unitPriceValue))?Number(fe.unitPriceValue):0,Xe=Number.isFinite(Number(fe?.qty))?Math.max(1,Number(fe.qty)):1,kt=Math.max(1,Number(m?.rentalDays||1)),Qe=it(Ue)*Xe*kt;return h(`${xe(Qe)} ${c("reservations.create.summary.currency","SR")}`)}}):de.id==="unitPrice"?x.push({...de,render:fe=>{const Ue=Number.isFinite(Number(fe?.unitPriceValue))?Number(fe.unitPriceValue):0,Xe=it(Ue);return h(`${xe(Xe)} ${c("reservations.create.summary.currency","SR")}`)}}):x.push(de)});const ye=Math.max(1,Number(m?.rentalDays||1));if(T("items","days")){const de=x.findIndex(Ue=>Ue.id==="price"),fe=Math.max(0,de);x.splice(fe,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(I(String(ye)))})}const he=new Map(x.map(de=>[de.id,de])),Ee=x.filter(de=>!["unitPrice","quantity","days","price"].includes(de.id)),Ve=["unitPrice","quantity"];he.has("days")&&Ve.push("days"),Ve.push("price");const at=Ve.map(de=>he.get(de)).filter(Boolean);return x=[...Ee,...at],x})(),ae=H.length>0,Ce=ae?H.map(x=>`<th>${h(x.labelKey?c(x.labelKey,x.fallback):x.fallback)}</th>`).join(""):"",we=G.length>0?G.map((x,ye)=>`<tr>${H.map(he=>`<td><div class="quote-cell">${he.render(x,ye)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(H.length,1)}" class="empty">${h(c("reservations.details.noItems","ðŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø­Ø§Ù„ÙŠØ§Ù‹."))}</td></tr>`,Te=(()=>{try{const x=Math.max(1,Number(m?.rentalDays||1)),ye=G.reduce((he,Ee)=>{const Ve=Number.isFinite(Number(Ee?.unitPriceValue))?Number(Ee.unitPriceValue):0,at=Number.isFinite(Number(Ee?.qty))?Math.max(1,Number(Ee.qty)):1,de=it(Ve);return he+de*at*x},0);return xe(ye)}catch{return xe(0)}})(),$e=R("items")?ae?`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.items.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Ce}</tr>
              </thead>
              <tbody>${we}</tbody>
            </table>
            ${T("items","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.equipmentTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${Te} ${y}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.items.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            ${V}
          </section>`:"",Fe=Ia.filter(x=>T("crew",x.id)),C=!0,le=Fe.length>0,re=Array.isArray(i)?i:[],_=x=>{const ye=x&&x.positionId!=null?`id:${String(x.positionId)}`:(()=>{const Ve=(x?.positionLabel||x?.position_name||x?.position||"").trim().toLowerCase();return Ve?`label:${Ve}`:""})(),he=Number.isFinite(Number(x?.positionClientPrice))?Number(x.positionClientPrice):0,Ee=he>0?`|p:${he.toFixed(2)}`:"";return`${ye}${Ee}`},z=(()=>{const x=new Map;return re.forEach(ye=>{const he=_(ye);he&&x.set(he,(x.get(he)||0)+1)}),x})(),g=(()=>{let x=[],ye=null;if(Fe.forEach(de=>{de.id==="position"?(x.push({...de,render:fe=>{const Ue=typeof je=="function"?je():"ar";let Xe=fe?.positionLabelEn??fe?.position_label_en??fe?.position_name_en??fe?.positionLabelAlt??fe?.position_label_alt??fe?.role;if(!Xe&&Ue==="en")try{const on=typeof yn=="function"?yn():[];let Qt=null;if(fe?.positionId!=null&&(Qt=on.find(Qn=>String(Qn.id)===String(fe.positionId))||null),!Qt){const Qn=fe?.positionKey??fe?.position_key??fe?.positionName??fe?.position_name??fe?.position??"";if(Qn){const Ai=String(Qn).toLowerCase();Qt=on.find(Ei=>String(Ei.name).toLowerCase()===Ai)||null}}Qt&&(Xe=Qt.labelEn??Qt.label_en??Qt.name_en??Xe)}catch{}const kt=fe?.positionLabel??fe?.position_name??fe?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),ze=Ue==="en"&&Xe?Xe:kt;if(C)return h(I(String(ze)));const Qe=_(fe),Dt=Qe&&z.get(Qe)||0,xt=Dt>1?` Ã— ${I(String(Dt))}`:"";return h(I(String(ze))+xt)}}),T("crew","quantity")&&(ye={id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:fe=>{const Ue=Number(fe?.__count||1);return h(I(String(Math.max(1,Ue))))}})):de.id==="price"?C&&x.push({...de,render:fe=>{const Ue=Number.isFinite(Number(fe?.positionClientPrice))?Number(fe.positionClientPrice):0,Xe=Math.max(1,Number(fe?.__count||1)),kt=Math.max(1,Number(m?.rentalDays||1)),Qe=it(Ue)*Xe*kt;return h(`${xe(Qe)} ${c("reservations.create.summary.currency","SR")}`)}}):de.id==="unitPrice"?x.push({...de,render:fe=>{const Ue=Number.isFinite(Number(fe?.positionClientPrice))?Number(fe.positionClientPrice):0,Xe=it(Ue);return h(`${xe(Xe)} ${c("reservations.create.summary.currency","SR")}`)}}):x.push(de)}),ye&&x.push(ye),T("crew","days")){const de=Math.max(1,Number(m?.rentalDays||1)),fe=x.findIndex(Xe=>Xe.id==="price"),Ue=Math.max(0,fe);x.splice(Ue,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(I(String(de)))})}const he=new Map(x.map(de=>[de.id,de])),Ee=new Set,Ve=[],at=de=>{const fe=he.get(de);fe&&!Ee.has(de)&&(Ve.push(fe),Ee.add(de))};return at("rowNumber"),at("position"),at("unitPrice"),at("quantity"),at("days"),at("price"),x.forEach(de=>{Ee.has(de.id)||(Ve.push(de),Ee.add(de.id))}),x=Ve,x})(),$=le?g.map(x=>`<th>${h(x.labelKey?c(x.labelKey,x.fallback):x.fallback)}</th>`).join(""):"",M=C?(()=>{const x=new Map;return re.forEach(ye=>{const he=_(ye);if(!he)return;const Ee=x.get(he);Ee?Ee.__count+=1:x.set(he,{...ye,__count:1})}),Array.from(x.values())})():re,ee=M.length?M.map((x,ye)=>`<tr>${g.map(he=>`<td><div class="quote-cell">${he.render(x,ye)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(g.length,1)}" class="empty">${h(c("reservations.details.noCrew","ðŸ˜Ž Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²."))}</td></tr>`,ne=(()=>{try{const x=Math.max(1,Number(m?.rentalDays||1)),ye=M.reduce((he,Ee)=>{const Ve=Number.isFinite(Number(Ee?.positionClientPrice))?Number(Ee.positionClientPrice):0,at=Math.max(1,Number(Ee?.__count||1)),de=it(Ve);return he+de*at*x},0);return xe(ye)}catch{return xe(0)}})(),se=R("crew")?le?`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.technicians.title","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${$}</tr>
              </thead>
              <tbody>${ee}</tbody>
            </table>
            ${T("crew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${ne} ${y}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.technicians.title","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            ${V}
          </section>`:"",ge=R("notes")?`<section class="quote-section">
        <h3>${h(c("reservations.details.labels.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²"))}</h3>
        <div class="quote-notes">${h(D||c("reservations.quote.emptyNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©."))}</div>
      </section>`:"",ie=[];T("payment","beneficiary")&&ie.push(W(c("reservations.quote.labels.beneficiary","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"),We.beneficiaryName)),T("payment","bank")&&ie.push(W(c("reservations.quote.labels.bank","Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"),We.bankName)),T("payment","account")&&ie.push(W(c("reservations.quote.labels.account","Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"),I(We.accountNumber))),T("payment","iban")&&ie.push(W(c("reservations.quote.labels.iban","Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"),I(We.iban)));const ce=`<section class="quote-section">
      <div class="payment-block">
        <h3>${h(c("reservations.quote.sections.payment","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹"))}</h3>
        <div class="payment-rows">${ie.length?ie.join(""):V}</div>
      </div>
      <p class="quote-approval-note">${h(We.approvalNote)}</p>
    </section>`,Ge=`<footer class="quote-footer">
        <h4>${h(c("reservations.quote.labels.terms","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©"))}</h4>
        <ul>${U.map(x=>`<li>${h(x)}</li>`).join("")}</ul>
      </footer>`,Ke=[];if(ve&&ue){const ye=(typeof je=="function"?je():"ar")==="en"?`${ue}${ve}`:`${ve}${ue}`;Ke.push(Re(`<div class="quote-section-row">${ye}</div>`,{blockType:"group"}))}else ue&&Ke.push(Re(ue)),ve&&Ke.push(Re(ve));if(Le)try{const x=typeof je=="function"?je():"ar",ye='<section class="quote-section quote-section--empty"></section>',he=x==="en"?`<div class="quote-section-row">${ye}${Le}</div>`:`<div class="quote-section-row">${ye}${Le}</div>`;Ke.push(Re(he,{blockType:"group"}))}catch{Ke.push(Re(Le))}const ft=[];$e&&ft.push(Re($e,{blockType:"table",extraAttributes:'data-table-id="items"'})),se&&ft.push(Re(se,{blockType:"table",extraAttributes:'data-table-id="crew"'}));const rn=[];Pe&&rn.push(Re(Pe,{blockType:"summary"})),ge&&rn.push(Re(ge));let He=[];if((e?.context||"reservation")!=="reservationChecklist")He=[...R("payment")?[Re(ce,{blockType:"payment"})]:[],Re(Ge,{blockType:"footer"})];else{const x=String(e?.checklistNotes||"").trim(),ye=String(e?.checklistNotesTitle||"").trim()||c("reservations.checklist.controls.notes.sectionTitleDefault","Ù…Ù„Ø§Ø­Ø¸Ø§Øª");if(x.length>0){const he=`<section class="quote-section">
        <h3>${h(ye)}</h3>
        <div class="quote-notes">${h(x)}</div>
      </section>`;He=[Re(he)]}}const ot=[...e?.context==="reservationChecklist"?Ke:ua(Ke,"reservations.quote.placeholder.page1"),...ft,...e?.context==="reservationChecklist"?rn:ua(rn,"reservations.quote.placeholder.page2"),...He],ht=e?.context==="reservationChecklist",$t=e?.checklistType==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":e?.checklistType==="both"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",Ut=typeof je=="function"?je():"ar",bi=e?.checklistType==="crew"?"Crew List":e?.checklistType==="both"?"Equipment & Crew List":"Equipment List",vi=ht?Ut==="en"?bi:$t:c("reservations.quote.title","Ø¹Ø±Ø¶ Ø³Ø¹Ø±"),Si=ht?`<div class="quote-header__meta" ${Ut==="en"?'dir="ltr"':""}>
        <div class="quote-header__meta-item">
          <span>${h(c("reservations.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${h(S)}</strong>
        </div>
      </div>`:`<div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${h(c("reservations.details.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²","Reservation ID"))}</span>
          <strong>${h(f)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${h(c("reservations.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${h(S)}</strong>
        </div>
      </div>`,wi=!ht||!e?.hideLogo,ki=!ht||!e?.hideCompany,Ii=`
    <header class="quote-header" data-quote-header-template style="${Number.isFinite(Number(e?.headerOffset))?`margin-top:${Number(e.headerOffset)}px;`:""}">
      <div class="quote-header__logo">
        ${wi?`<img class="quote-logo" src="${h(We.logoUrl)}" alt="${h(We.companyName)}" crossorigin="anonymous"/>`:'<span class="quote-logo quote-logo--placeholder" aria-hidden="true"></span>'}
      </div>
      <div class="quote-header__title">
        <h1>${h(vi)}</h1>
        ${ki?`
          <p class="quote-company-name">${h(c("quote.companyName",We.companyName))}</p>
          <p class="quote-company-cr">${h(c("reservations.quote.labels.cr","Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"))}: ${h(We.commercialRegistry)}</p>
          <p class="quote-company-license">${h(c("reservations.quote.labels.mediaLicense","ØªØ±Ø®ÙŠØµ Ø¥Ø¹Ù„Ø§Ù…ÙŠ"))}: 159460</p>
        `:""}
      </div>
      ${Si}
    </header>
  `.trim();return`
      <div id="quotation-pdf-root" dir="${h(ht&&Ut==="en"?"ltr":"rtl")}" data-lang="${h(Ut)}"${n}>
        <style>${ao}${no}</style>
        <div class="quote-document" data-quote-document>
          <div class="quote-preview-pages" data-quote-pages></div>
          <div class="quote-content-source" data-quote-source>
            ${Ii}
            ${ot.join("")}
          </div>
        </div>
      </div>
    `}finally{Ot=a}}async function Bs(){try{const e=Be();if((Array.isArray(e?.packages)?e.packages:[]).length>0)return;const n=await It("/packages/?all=1"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];a.length&&(qi({packages:a}),document.dispatchEvent?.(new CustomEvent("packages:changed",{detail:{packages:a}})))}catch{}}function Cl(e){return e?e.complete?e.naturalHeight===0?Promise.reject(new Error(`image failed to load: ${e.src||"unknown"}`)):Promise.resolve():new Promise((t,n)=>{const a=()=>{r(),t()},s=()=>{r(),n(new Error(`image failed to load: ${e.src||"unknown"}`))},r=()=>{e.removeEventListener("load",a),e.removeEventListener("error",s)};e.addEventListener("load",a,{once:!0}),e.addEventListener("error",s,{once:!0})}):Promise.resolve()}async function On(e){if(!e)return;const t=e.ownerDocument||document,n=t.defaultView||window,a=Array.from(e.querySelectorAll?.("img")||[]),s=t.fonts?.ready?t.fonts.ready:Promise.resolve(),r=a.map(i=>Cl(i)),o=[s,...r].map(i=>i.catch(l=>(Lt("asset load failed",l),zc(),null)));await Promise.all(o),await new Promise(i=>n.requestAnimationFrame(()=>i()))}async function pa(e,{context:t="preview"}={}){if(!e)return;const n=t==="preview",a=e.ownerDocument||document;e.setAttribute("data-quote-render-context",t);const s=e.querySelector("[data-quote-pages]"),r=e.querySelector("[data-quote-source]"),o=r?.querySelector("[data-quote-header-template]");if(!s||!r||!o)return;s.style.display="block",s.style.margin="0",s.style.padding="0",s.style.gap="0px",s.style.rowGap="0px",s.style.columnGap="0px",s.style.alignItems="stretch",s.style.justifyContent="flex-start",await ko(r),await On(r),s.innerHTML="";const i=Array.from(r.querySelectorAll(":scope > [data-quote-block]")),l=e.getAttribute(ln.context)||null,u=nr(e,ln.blockOffsets),d=nr(e,ln.infoAlignments),y=Ot,b=l||u||d;b&&(Ot={context:l||null,blockOffsets:u||null,infoAlignments:d||null});let p=null,f=null;const S=q=>{q.style.margin="0 auto",q.style.breakInside="avoid",q.style.pageBreakInside="avoid",q.style.pageBreakAfter="auto",q.style.breakAfter="auto"},A=()=>{const q=a.createElement("div"),E=s.childElementCount===0;if(q.className="quote-page",q.dataset.pageIndex=String(s.childElementCount),E){q.classList.add("quote-page--primary");const B=o.cloneNode(!0);B.removeAttribute("data-quote-header-template"),q.appendChild(B)}else q.classList.add("quote-page--continuation");const J=a.createElement("main");J.className="quote-body",q.appendChild(J),s.appendChild(q),S(q),p=q,f=J},k=()=>{(!p||!f||!f.isConnected)&&A()},w=()=>{if(!p||!f||f.childElementCount>0)return;const q=p;p=null,f=null,q.parentNode&&q.parentNode.removeChild(q)},O=()=>{p=null,f=null},K=()=>p?p.scrollHeight-p.clientHeight>co:!1,Y=(q,{allowOverflow:E=!1}={})=>(k(),f.appendChild(q),K()&&!E?(f.removeChild(q),w(),!1):!0),v=q=>{const E=q.cloneNode(!0);E.removeAttribute?.("data-quote-block"),E.removeAttribute?.("data-block-type"),E.removeAttribute?.("data-table-id"),!Y(E)&&(O(),!Y(E)&&Y(E,{allowOverflow:!0}))},N=q=>{const E=q.querySelector("table");if(!E){v(q);return}const J=q.querySelector("h3"),B=E.querySelector("thead"),Z=Array.from(E.querySelectorAll("tbody tr"));if(!Z.length){v(q);return}let D=null,U=0;const L=(R=!1)=>{const V=q.cloneNode(!1);V.removeAttribute("data-quote-block"),V.removeAttribute("data-block-type"),V.removeAttribute("data-table-id"),V.classList.add("quote-section--table-fragment"),R&&V.classList.add("quote-section--table-fragment--continued");const F=J?J.cloneNode(!0):null;F&&V.appendChild(F);const j=E.cloneNode(!1);j.classList.add("quote-table--fragment"),B&&j.appendChild(B.cloneNode(!0));const W=a.createElement("tbody");return j.appendChild(W),V.appendChild(j),{section:V,body:W}},T=(R=!1)=>D||(D=L(R),Y(D.section)||(O(),Y(D.section)||Y(D.section,{allowOverflow:!0})),D);Z.forEach(R=>{T(U>0);const V=R.cloneNode(!0);if(D.body.appendChild(V),K()&&(D.body.removeChild(V),D.body.childElementCount||(f.removeChild(D.section),D=null,w()),O(),D=null,T(U>0),D.body.appendChild(V),K())){D.section.classList.add("quote-section--table-fragment--overflow"),U+=1;return}U+=1}),D=null;try{const R=q.querySelector(":scope > .quote-table-subtotal");R&&v(R)}catch{}};try{if(!i.length)return;i.forEach(L=>{L.getAttribute("data-block-type")==="table"?N(L):v(L)});const q=Array.from(s.children),E=[];if(q.forEach((L,T)=>{const R=L.querySelector(".quote-body");if(T!==0&&(!R||R.childElementCount===0)){L.remove();return}E.push(L)}),!n){const L=a.defaultView||window,T=Math.min(3,Math.max(1,L.devicePixelRatio||1)),R=$a()?Math.min(2,T):T;E.forEach(V=>sl(V,{pixelRatio:R}))}E.forEach((L,T)=>{const R=T===0;L.style.pageBreakAfter="auto",L.style.breakAfter="auto",L.style.pageBreakBefore=R?"auto":"always",L.style.breakBefore=R?"auto":"page",n?L.style.boxShadow="":L.style.boxShadow="none"});const J=E[E.length-1]||null;p=J,f=J?.querySelector(".quote-body")||null,await On(s);const B=L=>L&&typeof L=="object"&&Object.keys(L).length>0,D=ws[Ct(m||(l?{context:l}:null))]||{},U=B(u)?u:B(m?.blockOffsets)?m.blockOffsets:D;try{xc(e,U)}catch{}}finally{b&&(Ot=y)}n&&(s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="flex-start",s.style.rowGap="18px",s.style.columnGap="0px",s.style.gap="18px")}function Co(e=0){return e<=0?new Promise(t=>requestAnimationFrame(()=>t())):new Promise(t=>setTimeout(t,e))}function $o(e){return e?Array.from(e.querySelectorAll(".quote-page")).some(n=>n.scrollHeight-n.clientHeight>co):!1}function Ds(e,t="#000000"){if(!e)return;e.querySelectorAll('[style*="color"], [class*="text"], h1, h2, h3, h4, h5, h6, p, span, th, td, li, strong, em, label, dt, dd, caption, div').forEach(a=>{a instanceof HTMLElement&&a.style.setProperty("color",t,"important")})}async function $l(e,{filename:t,safariWindowRef:n=null,mobileWindowRef:a=null}){if(!e)return;const s=Array.from(e.querySelectorAll(".quote-page"));if(!s.length)throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙØ­Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");const[r,o]=await Promise.all([ol(),rl()]),i=e.ownerDocument||document,l=i?.defaultView?.getComputedStyle?.(e)?.direction,d=[e.getAttribute?.("dir"),e.style?.direction,l,i?.documentElement?.getAttribute?.("dir")].some(v=>typeof v=="string"&&v.toLowerCase().startsWith("rtl")),y=typeof window<"u"&&window.devicePixelRatio||1,b=Ls(),p=bo(),f=$a();let S;f?S=1.5:p?S=Math.min(1.7,Math.max(1.2,y*1.1)):b?S=Math.min(1.8,Math.max(1.25,y*1.2)):S=Math.min(2,Math.max(1.6,y*1.4));const A=f||p?.9:b?.92:.95,k=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),w={scale:S,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!d,removeContainer:!1,logging:!0};let O=0;const K=c("reservations.quote.errors.browserLimit","ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");try{for(let v=0;v<s.length;v+=1){const N=s[v];await ko(N),await On(N);const q=N.ownerDocument||document,E=q.createElement("div");Object.assign(E.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const J=N.cloneNode(!0);J.style.width=`${Cn}px`,J.style.maxWidth=`${Cn}px`,J.style.minWidth=`${Cn}px`,J.style.height=`${$n}px`,J.style.maxHeight=`${$n}px`,J.style.minHeight=`${$n}px`,J.style.position="relative",J.style.background="#ffffff",Ds(J);const B=q.createElement("div"),Z=Array.from(e?.attributes||[]),D=e?.id&&typeof e.id=="string"&&e.id.trim().length?e.id:"quotation-pdf-root";if(B.id=D,Z.forEach(ue=>{!ue?.name||ue.name==="id"||B.setAttribute(ue.name,ue.value)}),!B.hasAttribute("dir")){const ue=e?.getAttribute("dir")||q.documentElement?.getAttribute("dir")||"rtl";B.setAttribute("dir",ue)}const U=q.createElement("iframe");U.setAttribute("title","quote-pdf-capture"),Object.assign(U.style,{position:"absolute",width:`${Cn}px`,height:`${$n}px`,border:"0",top:"0",left:"0",opacity:"0",pointerEvents:"none"}),E.appendChild(U),q.body.appendChild(E);const L=U.contentDocument||U.contentWindow?.document;L.open(),L.write("<!DOCTYPE html><html><head></head><body></body></html>"),L.close(),L.documentElement.setAttribute("dir",B.getAttribute("dir")||"rtl");const T=L.head,R=L.body;Array.from(e.children||[]).forEach(ue=>{ue&&ue.tagName==="STYLE"&&T.appendChild(ue.cloneNode(!0))});const V=L.createElement("div");V.className="quote-document",V.setAttribute("data-quote-document","");const F=L.createElement("div");F.className="quote-preview-pages",F.setAttribute("data-quote-pages",""),F.appendChild(J),V.appendChild(F),B.appendChild(V),R.appendChild(B);let j;try{await On(B);const ue=L.defaultView||U.contentWindow||window;gs(B,ue),hs(B,ue),ys(B),j=await o(B,{...w,scale:S,backgroundColor:"#ffffff",scrollX:0,scrollY:0})}catch(ue){throw Ga(ue,"pageCapture",{toastMessage:K}),ue}finally{E.parentNode?.removeChild(E)}if(!j)continue;const W=j.width||1,te=(j.height||1)/W;let me=Ka,ve=me*te,Q=0;if(ve>Wn){const ue=Wn/ve;ve=Wn,me=me*ue,Q=Math.max(0,(Ka-me)/2)}const Ae=j.toDataURL("image/jpeg",A);O>0&&k.addPage(),k.addImage(Ae,"JPEG",Q,0,me,ve,`page-${O+1}`,"FAST"),O+=1,await new Promise(ue=>window.requestAnimationFrame(ue))}}catch(v){throw Wa({safariWindowRef:n,mobileWindowRef:a}),v}if(O===0)throw Wa({safariWindowRef:n,mobileWindowRef:a}),new Error("PDF generation produced no pages.");if(p||f){const v=k.output("blob");if(f){const N=URL.createObjectURL(v);Pn();try{window.location.assign(N)}catch(q){Lt("mobile safari blob navigation failed",q)}finally{setTimeout(()=>URL.revokeObjectURL(N),6e4)}}else{const N=URL.createObjectURL(v),q=()=>p&&n&&!n.closed?n:a&&!a.closed?a:null,E=(B,Z)=>{if(Pn(),!B){window.location.assign(Z);return}try{B.location.replace(Z),B.focus?.()}catch(D){Lt("direct blob navigation failed",D);try{B.document.open(),B.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${h(c("reservations.quote.actions.export","ØªÙ†Ø²ÙŠÙ„ PDF"))}</title><style>html,body{margin:0;height:100%;background:#0f172a;color:#f8fafc;font-family:'Tajawal',sans-serif;} iframe{border:none;width:100%;height:100%;display:block;}</style></head><body><iframe src="${Z}" title="PDF preview"></iframe></body></html>`),B.document.close()}catch(U){Lt("iframe blob delivery failed",U),window.location.assign(Z)}}},J=q();E(J,N),setTimeout(()=>URL.revokeObjectURL(N),6e4)}}else{Pn();const v=k.output("bloburl"),N=document.createElement("a");N.href=v,N.download=t,N.rel="noopener",N.style.display="none",document.body.appendChild(N),N.click(),setTimeout(()=>{URL.revokeObjectURL(v),N.remove()},2e3)}}function Je(){if(!m||!X)return;const{previewFrame:e}=X;if(!e)return;No();const t=m.context||"reservation",n=t==="reservationChecklist"?fo():m.reservation,a=_o({context:t,reservation:n||m.reservation,customer:m.customer,project:m.project,crewAssignments:m.crewAssignments,totals:m.totals,totalsDisplay:m.totalsDisplay,rentalDays:m.rentalDays,currencyLabel:m.currencyLabel,sections:m.sections,fieldSelections:m.fields,quoteNumber:m.quoteNumber,quoteDate:m.quoteDateLabel,terms:m.terms,checklistType:m.checklistType,checklistNotes:m.checklistNotes,checklistNotesTitle:m.checklistNotesTitle,hideLogo:!!m.hideLogo,hideCompany:!!m.hideCompany,headerOffset:Number(m.headerOffset||0),projectCrew:m.projectCrew,projectExpenses:m.projectExpenses,projectEquipment:m.projectEquipment,projectInfo:m.projectInfo,clientInfo:m.clientInfo,paymentSummary:m.paymentSummary,projectTotals:m.projectTotals,blockOffsets:m.blockOffsets,infoAlignments:m.infoAlignments});Yt("render"),e.srcdoc=`<!DOCTYPE html>${a}`,e.addEventListener("load",async()=>{try{const s=e.contentDocument,r=s?.defaultView||window,o=s?.documentElement||s;o&&(ys(o),gs(o,r),hs(o,r));const i=s?.getElementById("quotation-pdf-root");try{i&&(await pa(i,{context:"preview"}),await Co(120),$o(i)&&await pa(i,{context:"preview"}),Ds(i))}catch(f){console.error("[reservations/pdf] failed to layout preview document",f)}const l=Array.from(s?.querySelectorAll?.(".quote-page")||[]);try{if(m?.context==="reservationChecklist"&&m?.hideCompany){const S=s.querySelector(".quote-header");if(S&&!S.dataset.dragReady){S.style.cursor="grab";let A=!1,k=0,w=Number(m.headerOffset||0);const O=v=>{A=!0,k=v.clientY||v.touches?.[0]?.clientY||0,w=Number(m.headerOffset||0),S.style.cursor="grabbing",s.addEventListener("mousemove",K),s.addEventListener("mouseup",Y,{once:!0}),s.addEventListener("touchmove",K,{passive:!1}),s.addEventListener("touchend",Y,{once:!0})},K=v=>{if(!A)return;const q=(v.clientY||v.touches?.[0]?.clientY||0)-k,E=Math.max(0,Math.min(240,w+q));S.style.marginTop=`${E}px`,m.headerOffset=E,v.preventDefault?.()},Y=()=>{A=!1,S.style.cursor="grab",s.removeEventListener("mousemove",K),s.removeEventListener("touchmove",K)};S.addEventListener("mousedown",O),S.addEventListener("touchstart",O,{passive:!0}),S.dataset.dragReady="true"}}}catch{}Fc(s),Es(s),_a();const u=s?.querySelector(".quote-preview-pages"),d=Cn;let y=18;if(u&&s?.defaultView){const f=s.defaultView.getComputedStyle(u),S=parseFloat(f.rowGap||f.gap||`${y}`);Number.isFinite(S)&&S>=0&&(y=S)}const b=$n,p=l.length?l.length*b+Math.max(0,(l.length-1)*y):b;if(e.dataset.baseWidth=String(d),e.dataset.baseHeight=String(p),e.style.width=`${d}px`,e.style.minWidth=`${d}px`,e.style.height=`${p}px`,e.style.minHeight=`${p}px`,X?.previewFrameWrapper&&!X?.userAdjustedZoom){const f=X.previewFrameWrapper.clientWidth-24;f>0&&f<d?Et=Math.max(f/d,.3):Et=1}xo(Et)}finally{Pn()}},{once:!0})}function xl(e){if(!m)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(t.checked?m.sections.add(n):m.sections.delete(n),Ao(m),Yn(),Je())}function Ll(e){if(!m)return;const t=e.currentTarget,n=t?.dataset?.sectionId,a=t?.dataset?.fieldId;if(!n||!a)return;const s=m.context||"reservation",r=m.fields||(m.fields=Kn(s)),o=Hc(r,n);t.checked?o.add(a):o.delete(a),Ao(m),Je()}function Nl(e){if(!m)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(xs(m,n),m.sectionExpansions[n]=t.open)}function Yn(){if(!X?.toggles||!m)return;const{toggles:e}=X,t=m.fields||{},n=m.context||"reservation";xs(m);const a=Ea(n),s=Xr(n),r=a.map(({id:o,labelKey:i,fallback:l})=>{const u=c(i,l),d=m.sections.has(o),y=s[o]||[],b=Kc(m,o),p=y.length?`<div class="quote-toggle-sublist">
          ${y.map(f=>{const S=$s(t,o,f.id),A=d?"":"disabled",k=f.labelKey?c(f.labelKey,f.fallback):f.fallback;return`
              <label class="quote-toggle quote-toggle--field">
                <input type="checkbox" data-field-toggle data-section-id="${o}" data-field-id="${f.id}" ${S?"checked":""} ${A}>
                <span>${h(k)}</span>
              </label>
            `}).join("")}
        </div>`:"";return`
      <details class="quote-toggle-group" data-section-group data-section-id="${o}" ${b?"open":""}>
        <summary class="quote-toggle-summary">
          <label class="quote-toggle quote-toggle--section">
            <input type="checkbox" data-section-toggle data-section-id="${o}" ${d?"checked":""}>
            <span>${h(u)}</span>
          </label>
          ${y.length?'<span class="quote-toggle-caret" aria-hidden="true"></span>':""}
        </summary>
        ${p}
      </details>
    `}).join("");e.innerHTML=r,e.querySelectorAll("input[data-section-toggle]").forEach(o=>{o.addEventListener("change",xl)}),e.querySelectorAll("input[data-field-toggle]").forEach(o=>{o.addEventListener("change",Ll)}),e.querySelectorAll("details[data-section-group]").forEach(o=>{o.addEventListener("toggle",Nl)})}function Pl(){if(X?.modal)return X;const e=document.createElement("div");e.id="reservationQuoteModal",e.className="modal fade quote-preview-modal",e.tabIndex=-1,e.setAttribute("aria-labelledby","reservationQuoteModalLabel"),e.setAttribute("aria-hidden","true"),e.style.display="none",e.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationQuoteModalLabel">${h(c("reservations.quote.previewTitle","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="quote-preview-layout">
            <aside class="quote-preview-sidebar">
              <h6>${h(c("reservations.quote.toggleHeading","Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØµØ¯ÙŠØ±Ù‡Ø§"))}</h6>
              <div class="quote-toggle-list" data-quote-toggles></div>
              <div class="quote-meta-info" data-quote-meta></div>
              <div class="quote-terms-editor" data-quote-terms-editor>
                <label class="quote-terms-editor__label" for="quote-terms-input">${h(c("reservations.quote.termsEditor.title","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)"))}</label>
                <textarea id="quote-terms-input" class="quote-terms-editor__textarea" rows="6" data-quote-terms-input placeholder="${h(c("reservations.quote.termsEditor.placeholder","Ø§ÙƒØªØ¨ ÙƒÙ„ Ø´Ø±Ø· ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„"))}"></textarea>
                <button type="button" class="quote-terms-reset" data-quote-terms-reset>${h(c("reservations.quote.termsEditor.reset","Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"))}</button>
              </div>
            </aside>
            <section class="quote-preview-panel">
              <div class="quote-preview" data-quote-preview></div>
            </section>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">${h(c("reservations.quote.actions.close","Ø¥ØºÙ„Ø§Ù‚"))}</button>
          <button type="button" class="btn btn-primary" data-quote-download>
            ${h(c("reservations.quote.actions.export","ðŸ“„ ØªÙ†Ø²ÙŠÙ„ PDF"))}
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector("[data-quote-toggles]"),n=e.querySelector("[data-quote-preview]"),a=e.querySelector("[data-quote-meta]"),s=e.querySelector("[data-quote-terms-input]"),r=e.querySelector("[data-quote-terms-reset]"),o=e.querySelector("[data-quote-download]"),i=e.querySelector(".modal-header"),l=i?.querySelector(".btn-close"),u=Array.from(e.querySelectorAll('[data-bs-dismiss="modal"]')),d=document.createElement("div");d.className="quote-preview-header-actions",i&&i.insertBefore(d,l||null);const y=[],b=(V=null)=>{y.forEach(F=>{F!==V&&(F.menu.hidden=!0,F.toggle.setAttribute("aria-expanded","false"),F.wrapper.classList.remove("is-open"))})},p=(V,F,j)=>{y.push({wrapper:V,toggle:F,menu:j})},f=V=>{if(!y.length)return;const F=V.target;y.some(W=>W.wrapper.contains(F))||b()};document.addEventListener("click",f),document.addEventListener("keydown",V=>{V.key==="Escape"&&b()});const S=({label:V,icon:F,content:j})=>{const W=document.createElement("div");W.className="quote-controls-dropdown";const oe=document.createElement("button");oe.type="button",oe.className="quote-controls-dropdown__toggle",oe.setAttribute("aria-haspopup","true"),oe.setAttribute("aria-expanded","false"),oe.innerHTML=`
      ${F?`<span class="quote-controls-dropdown__icon" aria-hidden="true">${h(F)}</span>`:""}
      <span class="quote-controls-dropdown__label">${h(V)}</span>
      <span class="quote-controls-dropdown__caret" aria-hidden="true">â–¾</span>
    `;const te=document.createElement("div");return te.className="quote-controls-dropdown__menu",te.hidden=!0,te.appendChild(j),W.appendChild(oe),W.appendChild(te),oe.addEventListener("click",me=>{me.stopPropagation();const ve=W.classList.contains("is-open");b(),ve||(W.classList.add("is-open"),te.hidden=!1,oe.setAttribute("aria-expanded","true"))}),p(W,oe,te),W},A=document.createElement("iframe");A.className="quote-preview-frame",A.setAttribute("title",c("reservations.quote.previewTitle","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø±Ø¶ Ø³Ø¹Ø±")),A.setAttribute("loading","lazy"),A.setAttribute("frameborder","0");const k=document.createElement("div");k.className="quote-preview-zoom-controls",k.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-zoom-out title="${h(c("reservations.quote.zoom.out","ØªØµØºÙŠØ±"))}">âˆ’</button>
    <span class="quote-preview-zoom-value" data-zoom-value>100%</span>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-in title="${h(c("reservations.quote.zoom.in","ØªÙƒØ¨ÙŠØ±"))}">+</button>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-reset title="${h(c("reservations.quote.zoom.reset","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·"))}">1:1</button>
  `;const w=document.createElement("div");w.className="quote-preview-zoom-controls quote-preview-drag-controls",w.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-block-drag-toggle title="${h(c("reservations.quote.drag.enable","ÙˆØ¶Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª"))}" aria-label="${h(c("reservations.quote.drag.enable","ÙˆØ¶Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª"))}">
      <span aria-hidden="true">â†•ï¸</span>
    </button>
    <button type="button" class="quote-preview-zoom-btn" data-block-drag-save disabled title="${h(c("reservations.quote.drag.save","ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}" aria-label="${h(c("reservations.quote.drag.save","ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}">
      <span aria-hidden="true">ðŸ’¾</span>
    </button>
    <button type="button" class="quote-preview-zoom-btn" data-block-drag-reset title="${h(c("reservations.quote.drag.resetBtn","ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}" aria-label="${h(c("reservations.quote.drag.resetBtn","ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}">
      <span aria-hidden="true">âŸ²</span>
    </button>
  `;const O=document.createElement("div");O.className="quote-preview-zoom-controls quote-preview-align-controls";const K=h(c("reservations.quote.align.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),Y=h(c("reservations.quote.align.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²")),v=h(c("reservations.quote.align.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));O.innerHTML=`
    <select class="quote-preview-align-select" data-align-target>
      <option value="customer">${K}</option>
      <option value="reservation">${Y}</option>
      <option value="project">${v}</option>
    </select>
    <div class="quote-preview-align-buttons">
      <button type="button" class="quote-preview-zoom-btn" data-align-value="left" title="${h(c("reservations.quote.align.left","Ù…Ø­Ø§Ø°Ø§Ø© ÙŠØ³Ø§Ø±"))}">â¬…ï¸</button>
      <button type="button" class="quote-preview-zoom-btn" data-align-value="center" title="${h(c("reservations.quote.align.center","Ù…Ø­Ø§Ø°Ø§Ø© ÙˆØ³Ø·"))}">â†”ï¸</button>
      <button type="button" class="quote-preview-zoom-btn" data-align-value="right" title="${h(c("reservations.quote.align.right","Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†"))}">âž¡ï¸</button>
    </div>
    <button type="button" class="quote-preview-zoom-btn" data-layout-export title="${h(c("reservations.quote.align.export","Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"))}">ðŸ“‹</button>
  `;const N=document.createElement("div");N.className="quote-preview-frame-wrapper",N.appendChild(A),n.innerHTML="";const q=document.createElement("div");q.className="quote-preview-scroll",q.appendChild(N),n.appendChild(q);const E=document.createElement("div");E.className="quote-preview-status",E.setAttribute("role","status"),E.setAttribute("aria-live","polite"),E.hidden=!0,E.innerHTML=`
    <span class="quote-preview-spinner" data-quote-status-spinner aria-hidden="true"></span>
    <span data-quote-status-text>${h(to("render"))}</span>
    <button type="button" class="quote-preview-status-action" data-quote-status-action hidden></button>
  `,n.appendChild(E);const J=c("reservations.quote.dropdown.drag","Ø§Ù„ØªØ­Ø±ÙŠÙƒ"),B=c("reservations.quote.dropdown.align","Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©"),Z=S({label:J,icon:"ðŸŽšï¸",content:w}),D=S({label:B,icon:"ðŸ“",content:O});d.appendChild(k),d.appendChild(Z),d.appendChild(D),o?.addEventListener("click",async()=>{if(m){o.disabled=!0;try{await Lo()}finally{o.disabled=!1}}});const U=()=>{Ua()||Qa(e)};u.forEach(V=>{V?.addEventListener("click",U)}),l&&!u.includes(l)&&l.addEventListener("click",U),e.addEventListener("click",V=>{Ua()||V.target===e&&Qa(e)}),X={modal:e,toggles:t,preview:n,previewScroll:q,previewFrameWrapper:N,zoomControls:k,zoomValue:k.querySelector("[data-zoom-value]"),previewFrame:A,meta:a,downloadBtn:o,statusIndicator:E,statusText:E.querySelector("[data-quote-status-text]"),statusSpinner:E.querySelector("[data-quote-status-spinner]"),statusAction:E.querySelector("[data-quote-status-action]"),termsInput:s,termsReset:r,statusKind:null,userAdjustedZoom:!1,blockDragToggle:w.querySelector("[data-block-drag-toggle]"),blockDragSave:w.querySelector("[data-block-drag-save]"),blockDragReset:w.querySelector("[data-block-drag-reset]"),alignTarget:O.querySelector("[data-align-target]"),alignButtons:Array.from(O.querySelectorAll("[data-align-value]")),layoutExportBtn:O.querySelector("[data-layout-export]")};const L=k.querySelector("[data-zoom-out]"),T=k.querySelector("[data-zoom-in]"),R=k.querySelector("[data-zoom-reset]");return L?.addEventListener("click",()=>lr(-.1)),T?.addEventListener("click",()=>lr(.1)),R?.addEventListener("click",()=>ma(1,{markManual:!0})),X.blockDragToggle?.addEventListener("click",()=>Lc(!hn)),X.blockDragSave?.addEventListener("click",Nc),X.blockDragReset?.addEventListener("click",Pc),X.alignTarget?.addEventListener("change",()=>_a()),(X.alignButtons||[]).forEach(V=>{V.addEventListener("click",()=>{const F=X.alignTarget?.value||"customer",j=V.dataset.alignValue||"right";Bc(F,j)})}),X.layoutExportBtn?.addEventListener("click",Dc),qa(),No(),s&&s.addEventListener("input",Tl),r&&r.addEventListener("click",jl),ma(Et),X}function ma(e,{silent:t=!1,markManual:n=!1}={}){Et=Math.min(Math.max(e,.25),2.2),n&&X&&(X.userAdjustedZoom=!0),xo(Et),!t&&X?.zoomValue&&(X.zoomValue.textContent=`${Math.round(Et*100)}%`)}function lr(e){ma(Et+e,{markManual:!0})}function xo(e){if(!X?.previewFrame||!X.previewFrameWrapper)return;const t=X.previewFrame,n=X.previewFrameWrapper,a=Number(t.dataset.baseWidth)||794,s=Number(t.dataset.baseHeight)||t.contentDocument?.body?.scrollHeight||1123;t.style.transform=`scale(${e})`,t.style.transformOrigin="top center",Ls()?(n.style.width="100%",n.style.maxWidth="100%",n.style.minWidth="0"):(n.style.width=`${a}px`,n.style.maxWidth=`${a}px`,n.style.minWidth=`${a}px`),n.style.minHeight=`${s}px`,n.style.height=`${s}px`}function Jn(){if(!X?.meta||!m)return;const{meta:e}=X;(m.context||"reservation")==="reservationChecklist"?e.innerHTML=`
      <div class="quote-meta-card">
        <div><span>${h(c("reservations.quote.labels.dateGregorian","Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ"))}</span><strong>${h(m.quoteDateLabel)}</strong></div>
      </div>
    `:e.innerHTML=`
      <div class="quote-meta-card">
        <div><span>${h(c("reservations.quote.labels.number","Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</span><strong>${h(m.quoteNumber)}</strong></div>
        <div><span>${h(c("reservations.quote.labels.dateGregorian","Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ"))}</span><strong>${h(m.quoteDateLabel)}</strong></div>
      </div>
    `}function Fs(){if(!X?.termsInput)return;const e=(m?.terms&&m.terms.length?m.terms:pt).join(`
`);X.termsInput.value!==e&&(X.termsInput.value=e)}function Tl(e){if(!m)return;const t=za(e?.target?.value??"");if(t.length){m.terms=t;const n=document.getElementById("reservation-terms");n&&(n.value=e.target.value);const a=document.getElementById("edit-res-terms");a&&(a.value=e.target.value)}else{m.terms=[...pt],Fs();const n=pt.join(`
`),a=document.getElementById("reservation-terms");a&&(a.value=n);const s=document.getElementById("edit-res-terms");s&&(s.value=n)}Je()}function jl(e){if(e?.preventDefault?.(),!m)return;m.terms=[...pt];const t=document.getElementById("reservation-terms");t&&(t.value=pt.join(`
`));const n=document.getElementById("edit-res-terms");n&&(n.value=pt.join(`
`)),Fs(),Je()}async function Lo(){if(!m)return;Yt("export");const t=!Ls()&&bo(),n=$a(),a=null,s=!n&&t?window.open("","_blank"):null;(l=>{if(l)try{l.document.open(),l.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${h(c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF..."))}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${h(c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF..."))}</h1><p>${h(c("reservations.quote.status.exportingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±..."))}</p></div></body></html>`),l.document.close()}catch(u){Lt("failed to prime download window",u)}})(s);let o=null;const i=c("reservations.quote.errors.browserLimit","ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");try{await il(),Ba("html2pdf ensured");const l=m.context||"reservation",u=l==="reservationChecklist"?fo():m.reservation,d=_o({context:l,reservation:u||m.reservation,customer:m.customer,project:m.project,crewAssignments:m.crewAssignments,totals:m.totals,totalsDisplay:m.totalsDisplay,rentalDays:m.rentalDays,currencyLabel:m.currencyLabel,sections:m.sections,fieldSelections:m.fields,quoteNumber:m.quoteNumber,quoteDate:m.quoteDateLabel,terms:m.terms,checklistType:m.checklistType,checklistNotes:m.checklistNotes,checklistNotesTitle:m.checklistNotesTitle,hideLogo:!!m.hideLogo,hideCompany:!!m.hideCompany,headerOffset:Number(m.headerOffset||0),projectCrew:m.projectCrew,projectExpenses:m.projectExpenses,projectEquipment:m.projectEquipment,projectInfo:m.projectInfo,clientInfo:m.clientInfo,paymentSummary:m.paymentSummary,projectTotals:m.projectTotals,blockOffsets:m.blockOffsets,infoAlignments:m.infoAlignments});o=document.createElement("div"),o.innerHTML=d,Object.assign(o.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(o),ys(o),gs(o),hs(o),Ba("export container prepared");const y=o.firstElementChild;if(y){try{const p=typeof je=="function"?je():y.getAttribute("data-lang")||"ar",S=m?.context==="reservationChecklist"&&p==="en"?"ltr":"rtl";y.setAttribute("dir",S),y.style.direction=S,y.setAttribute("data-lang",p),y.style.textAlign=""}catch{}y.setAttribute("data-theme","light"),y.classList.remove("dark","dark-mode"),y.style.margin="0",y.style.padding="0",y.style.width="210mm",y.style.maxWidth="210mm",y.style.marginLeft="auto",y.style.marginRight="auto",y.scrollTop=0,y.scrollLeft=0;try{await pa(y,{context:"export"}),await Co(120),$o(y)&&await pa(y,{context:"export"}),await On(y),Ds(y),Ba("layout complete for export document")}catch(p){Ga(p,"layoutQuoteDocument",{suppressToast:!0})}}const b=l==="reservationChecklist"?(()=>{const p=m?.reservation?.reservationCode||m?.reservation?.reservationId||m?.reservation?.id||"res",f=m?.checklistType==="crew"?"crew":m?.checklistType==="both"?"equipment-crew":"equipment";return`checklist-${String(p)}-${f}.pdf`})():`quotation-${m.quoteNumber}.pdf`;await $l(y,{filename:b,safariWindowRef:s,mobileWindowRef:a})}catch(l){Wa({container:o,safariWindowRef:s,mobileWindowRef:a}),o=null,Ga(l,"exportQuoteAsPdf",{toastMessage:i})}finally{o&&o.parentNode&&o.parentNode.removeChild(o),Pn()}}function Rs(){const e=Pl();if(e?.modal){if(Ln=!1,Et=1,X&&(X.userAdjustedZoom=!1),ma(Et,{silent:!0}),m?.context==="reservationChecklist")try{const t=e.modal.querySelector("#reservationQuoteModalLabel"),n=e.modal.querySelector(".quote-preview-sidebar"),a=e.modal.querySelector("[data-quote-terms-editor]");a&&(a.style.display="none");let s=n.querySelector("[data-checklist-controls]");if(!s){s=document.createElement("div"),s.setAttribute("data-checklist-controls","");const r=h(c("reservations.checklist.controls.items","Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")),o=h(c("reservations.checklist.controls.crew","Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ")),i=h(c("reservations.checklist.controls.both","Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ")),l=h(c("reservations.checklist.controls.hideLogo","Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø¹Ø§Ø±")),u=h(c("reservations.checklist.controls.hideCompany","Ø¥Ø®ÙØ§Ø¡ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©")),d=h(c("reservations.checklist.controls.notes.title","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù„Ø³ØªØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)")),y=h(c("reservations.checklist.controls.notes.placeholder","Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø³ØªØ©")),b=typeof je=="function"?je():"ar",p=h(b==="en"?c("language.toggle.labelAr","ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"):c("language.toggle.labelEn","ðŸ‡¬ðŸ‡§ English")),f=h(c("reservations.checklist.controls.lessors.title","ðŸ¢ ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¤Ø¬Ø±")),S=h(c("reservations.checklist.controls.lessors.clear","Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø§Ù„Ù…Ø¤Ø¬Ø±ÙŠÙ†"));s.innerHTML=`
          <div class="quote-meta-card" style="margin-bottom:10px">
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:6px">
                <input type="radio" name="checklist-type" value="items" checked>
                <span data-i18n data-i18n-key="reservations.checklist.controls.items">${r}</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="radio" name="checklist-type" value="crew">
                <span data-i18n data-i18n-key="reservations.checklist.controls.crew">${o}</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="radio" name="checklist-type" value="both">
                <span data-i18n data-i18n-key="reservations.checklist.controls.both">${i}</span>
              </label>
            </div>
          </div>
          <div class="quote-meta-card" style="margin-bottom:10px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button type="button" class="btn btn-sm btn-light" data-checklist-lang>${p}</button>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" data-checklist-hide-logo>
                <span data-i18n data-i18n-key="reservations.checklist.controls.hideLogo">${l}</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" data-checklist-hide-company>
                <span data-i18n data-i18n-key="reservations.checklist.controls.hideCompany">${u}</span>
              </label>
            </div>
          </div>
          <div class="quote-terms-editor" data-checklist-notes>
            <label class="quote-terms-editor__label" for="checklist-notes-title-input" data-i18n data-i18n-key="reservations.checklist.controls.notes.titleLabel">${h(c("reservations.checklist.controls.notes.titleLabel","Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"))}</label>
            <input id="checklist-notes-title-input" class="quote-terms-editor__input" type="text" value="${h(c("reservations.checklist.controls.notes.sectionTitleDefault","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"))}" data-i18n-value-key="reservations.checklist.controls.notes.sectionTitleDefault">
            <label class="quote-terms-editor__label" for="checklist-notes-input" data-i18n data-i18n-key="reservations.checklist.controls.notes.title">${d}</label>
            <textarea id="checklist-notes-input" class="quote-terms-editor__textarea" rows="4" data-i18n-placeholder-key="reservations.checklist.controls.notes.placeholder" placeholder="${y}"></textarea>
          </div>
          <div class="quote-meta-card" data-checklist-lessors hidden>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;">
              <span data-i18n data-i18n-key="reservations.checklist.controls.lessors.title">${f}</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-lessor-clear>${S}</button>
            </div>
            <div data-lessor-options style="display:flex;flex-direction:column;gap:6px;"></div>
          </div>
        `,n.prepend(s),s.querySelectorAll('input[name="checklist-type"]').forEach(q=>{q.addEventListener("change",()=>{const E=s.querySelector('input[name="checklist-type"]:checked')?.value||"items";m.checklistType=E==="crew"||E==="both"?E:"items";const J=new Set(["customerInfo","reservationInfo","projectInfo","notes"]);if(m.checklistType==="crew"?J.add("crew"):m.checklistType==="both"?(J.add("items"),J.add("crew")):J.add("items"),m.sections=J,t){const B=je?.()||"ar",Z=m.checklistType==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":m.checklistType==="both"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",D=m.checklistType==="crew"?"Crew List":m.checklistType==="both"?"Equipment & Crew List":"Equipment List";t.textContent=B==="en"?D:Z}Yn(),Jn(),Je()})});const k=s.querySelector("#checklist-notes-input"),w=s.querySelector("#checklist-notes-title-input"),O=()=>{try{const q=je?.()||"ar",E=q==="en"?"ltr":"rtl",J=q==="en"?"left":"right";k&&(k.setAttribute("dir",E),k.style.textAlign=J),w&&(w.setAttribute("dir",E),w.style.textAlign=J)}catch{}};O();try{const q=()=>O();document.addEventListener("language:changed",q),s._onLangChanged=q}catch{}k.addEventListener("input",q=>{m.checklistNotes=String(q.target.value||""),Je()}),w.addEventListener("input",q=>{m.checklistNotesTitle=String(q.target.value||""),Je()});const K=s.querySelector("[data-checklist-lang]");if(K){const q=()=>{const E=je?.()||"ar";K.textContent=E==="ar"?"ðŸ‡¬ðŸ‡§ English":"ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"};q(),K.addEventListener("click",()=>{const J=(je?.()||"ar")==="ar"?"en":"ar";try{_i?.(J)}catch{}if(q(),O(),t){const B=je?.()||"ar",Z=m.checklistType,D=Z==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":Z==="both"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",U=Z==="crew"?"Crew List":Z==="both"?"Equipment & Crew List":"Equipment List";t.textContent=B==="en"?U:D}Yn(),Jn(),Je()})}const Y=s.querySelector("[data-checklist-hide-logo]"),v=s.querySelector("[data-checklist-hide-company]");(()=>{Y&&(Y.checked=!!m.hideLogo),v&&(v.checked=!!m.hideCompany)})(),Y?.addEventListener("change",q=>{m.hideLogo=!!q.target.checked,Je()}),v?.addEventListener("change",q=>{m.hideCompany=!!q.target.checked,Je()})}e.checklistControls=s,e.checklistLessorContainer=s.querySelector("[data-checklist-lessors]"),e.checklistLessorOptionsHost=s.querySelector("[data-lessor-options]"),da(),t&&(t.textContent=m.checklistType==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");try{e.previewFrame?.setAttribute("title","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„Ø³ØªØ©")}catch{}}catch{}Yn(),Jn(),Fs(),Je(),Oc(e.modal)}}async function Bl({reservation:e,customer:t,project:n}){if(!e){P(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}await Bs();const a=xa(e),{totalsDisplay:s,totals:r,rentalDays:o}=js(e,a,n),i=c("reservations.create.summary.currency","SR"),u=(p=>{if(!p)return"1";const S=[p.reservationCode,p.reservation_code,p.reservationId,p.reservation_id,p.id].find(w=>w!=null&&String(w).trim()!==""),A=I(String(S??"1"));return A.replace(/\D+/g,"")||A||"1"})(e),d=Number.parseInt(u,10)||1,y=new Date,b=fc();m={context:"reservation",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:o,currencyLabel:i,projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(Ea("reservation").filter(p=>p.defaultSelected).map(p=>p.id)),sectionExpansions:Ca("reservation"),fields:Kn("reservation"),terms:b,quoteSequence:d,quoteNumber:u,quoteDate:y,quoteDateLabel:Ts(y),sequenceCommitted:!1},Mn=!1,Ps(m),As(m),_s(m),Rs();try{bs()}catch{}}async function Dl({reservation:e,customer:t,project:n}){if(!e){P(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}await Bs();const a=xa(e),{totalsDisplay:s,totals:r,rentalDays:o}=js(e,a,n),i=c("reservations.create.summary.currency","SR"),l=new Date;m={context:"reservationChecklist",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:o,currencyLabel:i,checklistType:"items",checklistNotes:"",projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(["customerInfo","reservationInfo","projectInfo","notes","items"]),sectionExpansions:Ca("reservationChecklist"),fields:Kn("reservationChecklist"),terms:[],quoteDate:l,quoteDateLabel:Ts(l),sequenceCommitted:!1},m.checklistLessorFilter=new Set,m.checklistLessorOptions=[],m.checklistEquipmentLookup=ks(),Mn=!1,mo(),Ps(m),As(m),_s(m),Rs();try{bs()}catch{}}async function fu({project:e}){if(!e){P(c("projects.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));return}await Bs();let t=cr(e);const{project:n}=t;if(!n){P(c("projects.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));return}try{(!Array.isArray(t.equipmentItems)||t.equipmentItems.length===0)&&n?.id!=null&&(await Nr({project_id:n.id}),t=cr(n))}catch(l){console.warn("[reservationPdf] refreshReservationsForProject failed, proceeding with snapshot/state",l)}const s=(l=>{if(!l)return"1";const d=[l.projectCode,l.project_code,l.code,l.id].find(p=>p!=null&&String(p).trim()!==""),y=I(String(d??"1"));return y.replace(/\D+/g,"")||y||"1"})(n),r=Number.parseInt(s,10)||1,o=new Date,i=[...mc];m={context:"project",reservation:null,customer:t.customer,project:n,technicians:t.crew||[],clientInfo:t.clientInfo,projectInfo:t.projectInfo,projectCrew:t.crew,projectExpenses:t.expenses,projectEquipment:t.equipment,equipmentItems:t.equipmentItems||[],crewAssignments:t.crewAssignments||[],totals:t.totals,projectTotals:t.projectTotals,totalsDisplay:t.totalsDisplay,rentalDays:t.projectDurationDays,currencyLabel:t.currencyLabel,sections:new Set(Ea("project").filter(l=>l.defaultSelected).map(l=>l.id)),sectionExpansions:Ca("project"),fields:Kn("project"),terms:i,quoteSequence:r,quoteNumber:s,quoteDate:o,quoteDateLabel:Ts(o),sequenceCommitted:!1,paymentSummary:t.paymentSummary,projectNotes:t.notes,paymentHistory:t.paymentHistory},Mn=!1,Ps(m),As(m),_s(m),Rs();try{bs()}catch{}}function Fl(e="reservation"){return e==="project"?[{value:"projectCustomer",label:c("projects.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")},{value:"projectDetails",label:c("projects.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}]:[{value:"customer",label:c("reservations.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")},{value:"reservation",label:c("reservations.quote.sections.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²")},{value:"project",label:c("reservations.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}]}function No(){if(!X?.alignTarget)return;const e=m?.context||"reservation",t=Fl(e),n=X.alignTarget,a=n.value;n.innerHTML=t.map(s=>`<option value="${h(s.value)}">${h(s.label)}</option>`).join(""),t.some(s=>s.value===a)?n.value=a:n.value=t[0]?.value||"",_a()}const Rl="__DEBUG_CREW__";function Ml(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Rl);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function dr(e,t){if(Ml())try{console.log(`ðŸªµ [crew-debug:create] ${e}`,t)}catch{}}const Po="projects:create:draft",To="projects.html#projects-section";let Ya=null,jo=[],Ja=new Map,Xa=new Map,fa=new Map,Da=!1,Xn=null,ur=!1,Bo=[];function Ol(e){return new Promise(t=>setTimeout(t,e))}async function zl({reservationCode:e}={}){if(!e)return null;try{await Ol(600);const t=await It(`/reservations/?search=${encodeURIComponent(String(e))}&limit=5`),n=Array.isArray(t?.data)?t.data:[];return n.length&&(n.find(s=>String(s?.reservation_code||s?.reservationCode)===String(e))||n[0])||null}catch{return null}}function pr(e){fs(),Vt(),fn(),ni(),P(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const t=document.getElementById("sub-tab-trigger-my-reservations-tab");t&&typeof t.click=="function"&&setTimeout(()=>t.click(),0)}catch{}typeof Ya=="function"&&Ya({type:"created",reservation:e}),ud(e)}function vn(e=[],t){const n=Array.isArray(e)?e.map(s=>I(String(s??"")).trim()).filter(Boolean):[];if(!n.length)return t||c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(n.length===1)return c("reservations.toast.equipmentConflictSingle","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø­Ø¬Ø² Ø±Ù‚Ù… {code}").replace("{code}",n[0]);const a=n.join("ØŒ ");return c("reservations.toast.equipmentConflictMultiple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø­Ø¬ÙˆØ²Ø§Øª Ø£Ø±Ù‚Ø§Ù…: {codes}").replace("{codes}",a)}const Mt="reservations:create:draft";let un=!1;function La(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function Ms(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function Hl(){if(typeof document>"u"||!La())return null;try{const{input:t,hidden:n}=Sn(),{input:a,hidden:s}=jt(),r=document.getElementById("res-start")?.value||"",o=document.getElementById("res-end")?.value||"",i=document.getElementById("res-start-time")?.value||"",l=document.getElementById("res-end-time")?.value||"",u=document.getElementById("res-notes")?.value||"",d=document.getElementById("res-discount")?.value||"",y=document.getElementById("res-discount-type")?.value||"percent",b=!!document.getElementById("res-tax")?.checked,f=!!document.getElementById("res-company-share")?.checked,S=f?en("res-company-share"):null,A=document.getElementById("res-payment-status")?.value||"unpaid",k=document.getElementById("res-payment-progress-type")?.value||"percent",w=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:r,endDate:o,startTime:i,endTime:l,customerId:n?.value||"",customerLabel:t?.value||"",projectId:s?.value||"",projectLabel:a?.value||"",notes:u,discount:String(d||""),discountType:y,taxEnabled:b,companyShareEnabled:f,companySharePercent:S,paymentStatus:A,paymentProgressType:k,paymentProgressValue:String(w||""),items:mt()||[],technicianIds:Mi()||[],crewAssignments:ls()||[]}}catch{return null}}function At(){if(un)return;const e=La(),t=Ms();if(!e&&!t)return;const n=Hl();if(n){try{const s=(()=>{const o=e?e.getItem(Mt):null,i=!o&&t?t.getItem(Mt):null,l=o||i;return l?JSON.parse(l):null})(),r=o=>{if(!o)return!1;const i=Array.isArray(o.items)&&o.items.length>0,l=Array.isArray(o.technicianIds)&&o.technicianIds.length>0,u=!!(o.startDate||o.endDate||o.startTime||o.endTime),d=!!(o.customerId||o.customerLabel);return i||l||u||d};if(r(s)&&!r(n))return}catch{}try{const a=JSON.stringify(n);e&&e.setItem(Mt,a),t&&t!==e&&t.setItem(Mt,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function Do(){const e=La(),t=Ms();if(!(!e&&!t))try{e&&e.removeItem(Mt),t&&t!==e&&t.removeItem(Mt)}catch(n){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",n)}}function Kl(){const e=La(),t=Ms();if(!e&&!t)return;un=!0;let n=null;try{const a=e?e.getItem(Mt):null,s=!a&&t?t.getItem(Mt):null,r=a||s;n=r?JSON.parse(r):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),un=!1;return}if(n)try{if(n.startDate||n.startTime){const o=Xt(n.startDate||"",n.startTime||"");Kt("res-start","res-start-time",o)}if(n.endDate||n.endTime){const o=Xt(n.endDate||"",n.endTime||"");Kt("res-end","res-end-time",o)}if(n.customerId){bt({selectedValue:String(n.customerId)});const{input:o,hidden:i}=Sn();o&&(o.dataset.selectedId=String(n.customerId))}else if(n.customerLabel){bt({selectedValue:"",resetInput:!0});const{input:o,hidden:i}=Sn();o&&(o.value=n.customerLabel),i&&(i.value="");try{const l=ha(n.customerLabel,{allowPartial:!0});l&&(i.value=String(l.id),o.value=l.label,o.dataset.selectedId=String(l.id))}catch{}}if(n.projectId)Ht({selectedValue:String(n.projectId)});else if(n.projectLabel){Ht({selectedValue:"",resetInput:!0});const{input:o,hidden:i}=jt();o&&(o.value=n.projectLabel),i&&(i.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=n.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=n.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=n.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!n.taxEnabled);const s=document.getElementById("res-company-share");s&&(s.checked=!!n.companyShareEnabled,n.companySharePercent!=null&&(s.dataset.companyShare=String(n.companySharePercent)));const r=document.getElementById("res-payment-status");if(r&&(r.value=n.paymentStatus||r.value||"unpaid",dt(r,r.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=n.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=n.paymentProgressValue||""),Array.isArray(n.items)&&(Hn(n.items),nt()),Array.isArray(n.crewAssignments)&&n.crewAssignments.length)try{Ws(n.crewAssignments)}catch{}else if(Array.isArray(n.technicianIds)&&n.technicianIds.length)try{Ws(n.technicianIds)}catch{}Pt();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(o=>document.getElementById(o)).filter(Boolean).forEach(o=>{o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}Se()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{un=!1}}function Vl(e){if(!e)return null;let t=Bo.find(a=>a.id===e)||null;if(t)return t;const n=ds(e);return n?(t={id:e,name:Yi(n)||e,price:Wi(n),items:ms(n),raw:n},t):null}function ya(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ga(e){return I(String(e||"")).trim().toLowerCase()}function Ul(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=I(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function Fo(e){const t=I(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Ro(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Mo(e){if(!e)return null;const t=I(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Oo(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=I(String(t))}}function Zt(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function Sn(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function jt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function gt(){const{input:e,hidden:t}=jt();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function Wt(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const r=document.querySelector(`label[for="${e.id}"]`);r&&n.add(r)}const s=r=>{t()&&P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};n.forEach(r=>{!r||r.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(o=>{r.addEventListener(o,s,{capture:!0})}),r.dataset.linkedGuardAttached="true")})}function zo(e,t,{allowPartial:n=!1}={}){const a=lt(t);if(!a)return null;const s=e.get(a);if(s)return s;if(!n)return null;const r=[];return e.forEach((o,i)=>{i.includes(a)&&r.push(o)}),r.length===1?r[0]:null}function ha(e,t={}){return zo(Ja,e,t)}function Za(e,t={}){return zo(Xa,e,t)}function dt(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Ho(e){jo=Array.isArray(e)?[...e]:[]}function Os(){return jo}function zs(e){return e&&Os().find(t=>String(t.id)===String(e))||null}function mr(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function en(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??zt,a=I(String(n).replace("%","").trim()),s=parseFloat(a);return Number.isFinite(s)?s:zt}function St(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??zt,a=I(String(n).replace("%","").trim()),s=parseFloat(a);(!Number.isFinite(s)||s<=0)&&(s=zt),t.dataset.companyShare=String(s),t.checked=!0}function es(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(Da){Se();return}Da=!0;const a=()=>{Da=!1,Se()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(zt)),t.disabled){n.checked=!1,P(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}t.checked||(t.checked=!0),St()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?St():n.checked&&(n.checked=!1));a()}function Ql(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function fr(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const s=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${s}`}return""}function yr(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function bt({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:s}=Sn();if(!n||!a||!s)return;const r=us()||[],o=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),i=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");n.setAttribute("placeholder",o);const l=new Set;Ja=new Map;const u=r.filter(p=>p&&p.id!=null).map(p=>({id:String(p.id),label:yr(p)||i})).filter(p=>{if(!p.label)return!1;const f=lt(p.label);return!f||l.has(f)?!1:(l.add(f),Ja.set(f,p),!0)}).sort((p,f)=>p.label.localeCompare(f.label,void 0,{sensitivity:"base"}));s.innerHTML=u.map(p=>`<option value="${ya(p.label)}"></option>`).join("");const d=t?"":n.value,y=e?String(e):a.value?String(a.value):"",b=y?r.find(p=>String(p.id)===y):null;if(b){const p=yr(b)||i;a.value=String(b.id),n.value=p,n.dataset.selectedId=String(b.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":d}function Ht({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:s,list:r}=jt();if(!a||!s||!r)return;const o=Array.isArray(t)?t:Os()||[],i=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",i);const l=[...o].filter(S=>S&&S.id!=null).sort((S,A)=>String(A.createdAt||A.start||"").localeCompare(String(S.createdAt||S.start||""))),u=n?"":a.value,d=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),y=new Set;Xa=new Map;const b=l.map(S=>{const A=mr(S)||d;return{id:String(S.id),label:A}}).filter(S=>{if(!S.label)return!1;const A=lt(S.label);return!A||y.has(A)?!1:(y.add(A),Xa.set(A,S),!0)});r.innerHTML=b.map(S=>`<option value="${ya(S.label)}"></option>`).join("");const p=e?String(e):s.value?String(s.value):"",f=p?l.find(S=>String(S.id)===p):null;if(f){const S=mr(f)||d;s.value=String(f.id),a.value=S,a.dataset.selectedId=String(f.id)}else s.value="",a.dataset.selectedId="",a.value=n?"":u}function Kt(e,t,n){const{date:a,time:s}=Kr(n),r=document.getElementById(e),o=document.getElementById(t);if(r){if(a)if(r._flatpickr){const i=r._flatpickr.config?.dateFormat||"Y-m-d";r._flatpickr.setDate(a,!1,i)}else r.value=a;else r._flatpickr?r._flatpickr.clear():r.value="";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}if(o){if(s)if(o._flatpickr){const i=o._flatpickr.config?.dateFormat||"H:i";o._flatpickr.setDate(s,!1,i)}else o.value=s;else o._flatpickr?o._flatpickr.clear():o.value="";o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}}function Ko(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||Ht({selectedValue:a});const r=(us()||[]).find(d=>String(d.id)===String(e.clientId)),o=r?.id!=null?String(r.id):"";bt(o?{selectedValue:o}:{selectedValue:"",resetInput:!0});const i=fr(e,"start"),l=fr(e,"end");i&&Kt("res-start","res-start-time",i),l&&Kt("res-end","res-end-time",l);const u=document.getElementById("res-notes");u&&e.description&&(t||!u.value)&&(u.value=e.description),Se(),Pt()}function Vo({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:Be(),s=Array.isArray(a)?a:[];Ho(s);const r=t!=null?String(t):n.value?String(n.value):"";Ht({selectedValue:r,projectsList:s}),Pt(),Se()}function Pt(){const{input:e,hidden:t}=jt(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),s=document.getElementById("res-payment-status"),r=document.getElementById("res-payment-progress-type"),o=document.getElementById("res-payment-progress-value"),i=document.getElementById("res-discount"),l=document.getElementById("res-discount-type"),u=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),y=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(Wt(n,gt),a&&Wt(a,gt)),s&&Wt(s,gt),r&&Wt(r,gt),o&&Wt(o,gt),i&&Wt(i,gt),l&&Wt(l,gt),y)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),s&&(s.value="unpaid",dt(s,"unpaid"),s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),o&&(o.value="",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),i&&(i.value="0",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),l&&(l.value="percent",l.disabled=!0,l.classList.add("reservation-input-disabled"),l.title=u);else{if(n){const b=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",b&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),l&&(l.disabled=!1,l.classList.remove("reservation-input-disabled"),l.title="")}es("tax"),Se()}function Hs(){const{input:e,hidden:t}=jt();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Za(s,{allowPartial:a}):null;if(r){t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id);const o=zs(r.id);o?Ko(o,{skipProjectSelectUpdate:!0}):(Pt(),Se())}else t.value="",e.dataset.selectedId="",Pt(),Se()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Za(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="");try{At()}catch{}}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Ks(){const{input:e,hidden:t}=Sn();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?ha(s,{allowPartial:a}):null;r?(t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id)):(t.value="",e.dataset.selectedId=""),Se()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?ha(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="");try{At()}catch{}}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Gl(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){Tn({clearValue:!0});return}let n=null;try{const u=decodeURIComponent(t);n=JSON.parse(u)}catch(u){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,s),Tn({clearValue:!1}),!n)return;n.fromProjectForm&&(Xn={draftStorageKey:n.draftStorageKey||Po,returnUrl:n.returnUrl||To});const r=document.getElementById("res-project");if(n.projectId){r&&(Ht({selectedValue:String(n.projectId)}),Pt());const u=zs(n.projectId);u?Ko(u,{forceNotes:!!n.forceNotes}):Se(),Tn()}else{r&&Ht({selectedValue:""});const u=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");pd(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),u)}n.start&&Kt("res-start","res-start-time",n.start),n.end&&Kt("res-end","res-end-time",n.end);const o=document.getElementById("res-customer-input"),i=document.getElementById("res-customer");if(n.customerId){const d=(us()||[]).find(y=>String(y.id)===String(n.customerId));d?.id!=null&&(bt({selectedValue:String(d.id)}),i&&(i.value=String(d.id)),o&&(o.value=d.customerName||d.name||o.value))}else n.customerName&&o?(bt({selectedValue:""}),o.value=n.customerName,o.dataset.selectedId="",i&&(i.value="")):bt({selectedValue:""});const l=document.getElementById("res-notes");l&&n.description&&!l.value&&(l.value=n.description),Se()}function Bt(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Xt(e,n),end:Xt(t,a)}}function En(){if(!Gr())return;const{start:e,end:t}=Bt();!e||!t||ec({start:e,end:t})}function Uo(e){const t=ga(e);if(t){const i=fa.get(t);if(i)return i}const{description:n,barcode:a}=Fo(e);if(a){const i=os(a);if(i)return i}const s=lt(n||e);if(!s)return null;let r=Mr();if(!r?.length){const i=Be();r=Array.isArray(i?.equipment)?i.equipment:[],r.length&&Vr(r)}const o=r.find(i=>lt(i?.desc||i?.description||"")===s);return o||r.find(i=>lt(i?.desc||i?.description||"").includes(s))||null}function Qo(e,t="equipment-description-options"){const n=ga(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(l=>ga(l.value)===n)||fa.has(n))return!0;const{description:s}=Fo(e);if(!s)return!1;const r=lt(s);return r?(Mr()||[]).some(i=>lt(i?.desc||i?.description||"")===r):!1}const Wl={available:0,reserved:1,maintenance:2,retired:3};function Yl(e){return Wl[e]??5}function gr(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Jl(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(s=>s!=="available")||e.bestStatus;if(n==="available")return`${t} â€” ${gr(n)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${t} â€” ${a} (${gr(n)})`}function Vt(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=fs(),a=Be(),s=Array.isArray(n)&&n.length?n:a?.equipment||[],r=Array.isArray(s)?s:[];Vr(r);const o=new Map;r.forEach(u=>{const d=Ul(u),y=ga(d);if(!y||!d)return;const b=qt(u),p=Yl(b),f=o.get(y);if(!f){o.set(y,{normalized:y,value:d,bestItem:u,bestStatus:b,bestPriority:p,statuses:new Set([b])});return}f.statuses.add(b),p<f.bestPriority&&(f.bestItem=u,f.bestStatus=b,f.bestPriority=p,f.value=d)}),fa=new Map;const l=Array.from(o.values()).sort((u,d)=>u.value.localeCompare(d.value,"ar",{sensitivity:"base"})).map(u=>{fa.set(u.normalized,u.bestItem);const d=Jl(u),y=ya(u.value);if(d===u.value)return`<option value="${y}"></option>`;const b=ya(d);return`<option value="${y}" label="${b}"></option>`}).join("");e&&(e.innerHTML=l),t&&(t.innerHTML=l)}function Go(e,t,n={}){const{silent:a=!1}=n,s=be(e);if(!s)return{success:!1,message:null};const{start:r,end:o}=Bt();if(!r||!o){const f=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||P(f),{success:!1,message:f}}const i=mt();if(Vs(i).has(s)){const f=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||P(f),{success:!1,message:f}}const u=ps(s,r,o);if(u.length){const f=u.map(A=>A.name).join(", "),S=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${f}`);return a||P(S),{success:!1,message:S}}if(Tt(s,r,o)){const f=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),S=gn([s],r,o),A=vn(S,f);if(!a)if(S.length)P(A);else try{const k=new URLSearchParams({type:"equipment",id:s,start:r,end:o});It(`/reservations/availability.php?${k.toString()}`).then(w=>{const O=Array.isArray(w?.conflicts)?w.conflicts:[],K=Array.from(new Set(O.map(v=>v?.reservation_code||(v?.reservation_id!=null?`#${v.reservation_id}`:null)).filter(Boolean))),Y=vn(K,f);P(Y)}).catch(()=>P(A))}catch{P(A)}return{success:!1,message:A}}const d=os(s);if(!d){const f=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||P(f),{success:!1,message:f}}const y=qt(d);if(y==="maintenance"||y==="retired"){const f=Zt(y);return a||P(f),{success:!1,message:f}}const b=an(d);if(!b){const f=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||P(f),{success:!1,message:f}}wa({id:b,equipmentId:b,barcode:s,desc:d.desc,qty:1,price:d.price,cost:Jt(d),image:wn(d)}),t&&(t.value=""),nt(),Se();const p=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||P(p),{success:!0,message:p,barcode:s}}function ts(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Uo(t);if(!n){P(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Pi(n.barcode),s=qt(a||n);if(s==="maintenance"||s==="retired"){P(Zt(s));return}const r=be(n.barcode);if(!r){P(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o=an(n);if(!o){P(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i={id:o,equipmentId:o,barcode:r,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,cost:Jt(n),image:wn(n)},{start:l,end:u}=Bt();if(!l||!u){P(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const d=mt();if(Vs(d).has(r)){P(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const b=ps(r,l,u);if(b.length){const p=b.map(f=>f.name).join(", ");P(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${p}`));return}if(Tt(r,l,u)){const p=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),f=gn([r],l,u),S=vn(f,p);if(f.length)P(S);else try{const A=new URLSearchParams({type:"equipment",id:r,start:l,end:u});It(`/reservations/availability.php?${A.toString()}`).then(k=>{const w=Array.isArray(k?.conflicts)?k.conflicts:[],O=Array.from(new Set(w.map(Y=>Y?.reservation_code||(Y?.reservation_id!=null?`#${Y.reservation_id}`:null)).filter(Boolean))),K=vn(O,p);P(K)}).catch(()=>P(S))}catch{P(S)}return}wa(i),nt(),Se(),P(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function Xl(){Vt();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),ts(e))});const t=()=>{Qo(e.value,"equipment-description-options")&&ts(e)};e.addEventListener("focus",()=>{if(Vt(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function hr(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function Vs(e=mt()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=be(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(s=>{const r=be(s?.normalizedBarcode??s?.barcode);r&&t.add(r)})}),t}function Zl(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=Bt();if(!t||!n){P(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}Zi({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):P(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(Qr.change,t=>{hr(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),hr(e,Gr()))}function ed(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],s=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=a.length?a:t.barcode?[t.barcode]:[];if(!r.length)return;let o=0,i=null;const l=[],u=new Set;r.forEach(y=>{const b=be(y);b&&!u.has(b)&&(u.add(b),l.push(b))});const d=Math.min(s,l.length);for(let y=0;y<d;y+=1){const b=l[y],p=Go(b,null,{silent:!0});p.success&&(o+=1),p.message&&(i=p.message)}if(o>0){const b=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",I(String(o)));P(b)}else i&&P(i)}function Wo(){Zl(),!(ur||typeof document>"u")&&(document.addEventListener(Qr.requestAdd,ed),ur=!0)}function Vn(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),s=document.getElementById("reservation-package-hint"),r=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:s,packageAddButton:r}}function ns(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:s}=Vn();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const r=document.getElementById("equipment-barcode"),o=document.getElementById("equipment-description"),i=t==="package";r&&(r.disabled=i),o&&(o.disabled=i),s&&(s.disabled=t!=="package"||s.options.length===0),Ji(t),t==="package"&&Na()}function Na(){const{packageSelect:e,packageHint:t}=Vn();if(!e)return;const n=Rr();Bo=n,Qi(n.map(i=>i.raw??i));const a=c("reservations.create.summary.currency","SR"),s=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,r=n.map(i=>{const l=Number.isFinite(Number(i.price))?Number(i.price):0,u=I(l.toFixed(2)),d=`${i.name} â€” ${u} ${a}`;return`<option value="${i.id}">${d}</option>`}).join("");e.innerHTML=`${s}${r}`,e.selectedIndex=0;const o=n.length>0;e.disabled=!o,t&&(o?(t.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),Xo()}function td(e,t){const n=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${n} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),s=t.map(({item:r,blockingPackages:o})=>{const i=r?.desc||I(String(r?.barcode??r?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(o)&&o.length){const l=o.map(u=>u.name).join(", ");return`â€¢ ${i} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${l})`}return`â€¢ ${i} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...s].join(`
`)}function Yo(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:s=null}={}){const r=st(e);if(!r)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const o=Vl(r);if(!o)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(t.some(p=>p?.type==="package"&&st(p.packageId)===r))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(Or(r,n,a,s)){const p=o.name||r;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${p} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const i=Array.isArray(o.items)&&o.items.length?o.items:ms(o.raw??{}),l=Vs(t),u=[],d=new Set;if(i.forEach(p=>{const f=be(p?.normalizedBarcode??p?.barcode);if(f){if(d.has(f)){u.push({item:p,type:"internal"});return}d.add(f),l.has(f)&&u.push({item:p,type:"external"})}}),u.length){const p=u.map(({item:S})=>S?.desc||S?.description||S?.name||S?.barcode||S?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(S=>I(String(S))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(S=>S.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",p):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",p),duplicates:u}}const y=[];return i.forEach(p=>{const f=be(p?.normalizedBarcode??p?.barcode);if(f&&Tt(f,n,a,s)){const S=ps(f,n,a,s);y.push({item:p,blockingPackages:S})}}),y.length?{success:!1,reason:"item_conflict",message:td(o,y),conflicts:y}:{success:!0,package:{id:`package::${r}`,packageId:r,type:"package",desc:o.name||`Package ${r}`,qty:1,price:Number.isFinite(Number(o.price))?Number(o.price):0,cost:Number.isFinite(Number(o.cost))?Number(o.cost):0,barcode:o.code||o.raw?.package_code||`pkg-${r}`,packageItems:i.map(p=>({equipmentId:p?.equipmentId??null,barcode:p?.barcode??p?.normalizedBarcode??"",normalizedBarcode:be(p?.normalizedBarcode??p?.barcode),desc:p?.desc??"",qty:Number.isFinite(Number(p?.qty))?Number(p.qty):1,price:Number.isFinite(Number(p?.price))?Number(p.price):0,cost:0})),image:i.find(p=>p?.image)?.image??null},packageInfo:o}}function Jo(e,{silent:t=!1}={}){const n=st(e);if(!n)return t||P(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:s}=Bt(),r=mt(),o=Yo(n,{existingItems:r,start:a,end:s});if(!o.success){if(!t){const l={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[o.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");P(o.message||l)}return o}return wa(o.package),nt(),Se(),t||P(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:o.package}}function Xo(){const{packageSelect:e}=Vn();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;Jo(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function nd(){const{packageAddButton:e,packageSelect:t}=Vn();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){P(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Jo(n)}),e.dataset.listenerAttached="true")}function Zo(){const{modeRadios:e}=Vn();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",s=>{s.target.checked&&ns(s.target.value)}),a.dataset.listenerAttached="true")}),nd(),Xo();const t=aa(),n=e.find(a=>a.value===t);n&&(n.checked=!0),ns(t)}function ad(e={}){const t=[e.packageId,e.package_id,e.packageCode,e.package_code,e.packageDisplayCode,e.barcode,e.key];for(const n of t){if(!n)continue;const a=st(n);if(a)return a;const s=I(String(n)).trim().toLowerCase();if(s)return s}return null}function Fa(e={}){if(!e||typeof e!="object")return null;const t=st(e.packageId??e.package_id??e.package_code??e.packageCode??e.barcode??e.id??null);if(t)return t;const n=e.package_code??e.packageCode??e.barcode??null;return n?I(String(n)).trim().toLowerCase():null}function nt(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=mt(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),s=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),o=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),l=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(n.length===0){t.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;try{At()}catch{}return}const u=nn(n);t.innerHTML=u.map(d=>{const y=d.items[0]||{},b=wn(y)||d.image,p=b?`<img src="${b}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ðŸŽ¥</div>',f=I(String(d.count)),S=Number.isFinite(Number(d.unitPrice))?Number(d.unitPrice):0,A=(()=>{try{const{start:L,end:T}=Bt(),R=mn(L,T);return Number.isFinite(R)&&R>0?R:1}catch{return 1}})(),k=I(String(A)),w=S*d.count*A,O=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${d.key}"
          min="0"
          step="0.01"
          value="${I(String(S))}"
          aria-label="${c("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,K=`${I(w.toFixed(2))} ${s}`,Y=Number.isFinite(Number(d.unitCost))?Number(d.unitCost):0,v=d.items.some(L=>L?.type==="package"),N=d.barcodes.map(L=>I(String(L||""))).filter(Boolean),q=N.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${N.map(L=>`<li>${L}</li>`).join("")}
            </ul>
          </details>`:"";let E="";if(v){const L=new Map;if(d.items.forEach(T=>{Array.isArray(T?.packageItems)&&T.packageItems.forEach(R=>{if(!R)return;const V=be(R.barcode||R.desc||Math.random()),F=L.get(V);if(F){F.qty+=Number.isFinite(Number(R.qty))?Number(R.qty):1;return}L.set(V,{desc:R.desc||R.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(R.qty))?Number(R.qty):1,barcode:R.barcode??R.normalizedBarcode??""})})}),L.size){const T=Array.from(L.values()).map(R=>{const V=I(String(R.qty)),F=R.desc||I(String(R.barcode||"")),j=R.barcode?` <span class="reservation-package-items__barcode">(${I(String(R.barcode))})</span>`:"";return`<li>${F}${j} Ã— ${V}</li>`}).join("");E=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${T}
              </ul>
            </details>
          `}}const J=(()=>{if(!v)return null;for(let L=0;L<n.length;L+=1){const T=n[L];if(!(!T||String(T.type||"").toLowerCase()!=="package")&&vt(T)===d.key)return L}return null})(),B=v?ad(d):null,Z=B?`data-package-identity="${B}"`:"",D=J!=null&&Number.isInteger(J)?`data-package-index="${J}"`:"",U=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          data-group-key="${d.key}"
          ${Z}
          ${D}
          min="0"
          step="0.01"
          value="${I(String(Y))}"
          aria-label="${c("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `;return`
        <tr data-group-key="${d.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${p}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${d.description||"-"}</div>
                ${v?`${E||""}${q||""}`:q}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${d.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${d.key}" aria-label="${i}" ${v?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${d.key}" aria-label="${o}" ${v?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${k}</span></td>
          <td>${O}</td>
          <td>${U}</td>
          <td>${K}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${d.key}" aria-label="${l}">ðŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("");try{At()}catch{}}function sd(e){const t=mt(),a=nn(t).find(r=>r.key===e);if(!a)return;const s=a.itemIndices[a.itemIndices.length-1];s!=null&&(Gi(s),nt(),Se())}function rd(e){const t=mt(),n=t.filter(a=>vt(a)!==e);n.length!==t.length&&(Hn(n),nt(),Se())}function od(e,t){const n=ei(t),a=Number.isFinite(n)&&n>=0?ti(n):0,s=mt(),o=nn(s).find(l=>l.key===e);if(!o||!Array.isArray(o.itemIndices))return;const i=[...s];o.itemIndices.forEach(l=>{i[l]&&(i[l]={...i[l],price:a,unit_price:a})}),Hn(i),nt(),Se()}function id(e,t){const n=ei(t),a=Number.isFinite(n)&&n>=0?ti(n):0,s=mt(),o=nn(s).find(l=>l.key===e);if(!o||!Array.isArray(o.itemIndices))return;const i=[...s];o.itemIndices.forEach(l=>{if(i[l]){const u={...i[l],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};i[l]=u}}),Hn(i),nt(),Se()}function ei(e){const t=I(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),n=Number.parseFloat(t);return Number.isFinite(n)?n:NaN}function ti(e){const t=Number(e);return!Number.isFinite(t)||t<0?0:Number(t.toFixed(2))}function cd(e){const t=mt(),a=nn(t).find(y=>y.key===e);if(!a)return;const{start:s,end:r}=Bt();if(!s||!r){P(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const o=new Set(t.map(y=>be(y.barcode))),{equipment:i=[]}=Be(),l=(i||[]).find(y=>{const b=be(y?.barcode);if(!b||o.has(b)||vt({desc:y?.desc||y?.description||y?.name||"",price:Number(y?.price)||0})!==e)return!1;const f=qt(y);return f==="maintenance"||f==="retired"?!1:!Tt(b,s,r)});if(!l){P(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const u=be(l.barcode),d=an(l);if(!d){P(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}wa({id:d,equipmentId:d,barcode:u,desc:l.desc||l.description||l.name||a.description||"",qty:1,price:Number.isFinite(Number(l.price))?Number(l.price):a.unitPrice,cost:Number.isFinite(Number(l.cost))?Number(l.cost):Number.isFinite(Number(l.unit_cost))?Number(l.unit_cost):Number(a.unitCost)||0,image:wn(l)}),nt(),Se()}function Se(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(I(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",s=e?"percent":a,r=document.getElementById("res-tax"),o=e?!1:r?.checked||!1,i=document.getElementById("res-payment-status"),l=i?.value||"unpaid",{start:u,end:d}=Bt();o&&St();const y=en(),b=document.getElementById("res-payment-progress-type"),p=document.getElementById("res-payment-progress-value"),f=Ro(b),S=Mo(p);ls(),Gs({selectedItems:mt(),discount:n,discountType:s,applyTax:o,paidStatus:l,paymentProgressType:f,paymentProgressValue:S,start:u,end:d,companySharePercent:y,paymentHistory:[]});const A=Gs.lastResult;A?(Oo(p,A.paymentProgressValue),i&&(i.value=A.paymentStatus,dt(i,A.paymentStatus))):dt(i,l);try{At()}catch{}}function ld(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",i=>{i.target.value=I(i.target.value),Se()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",Se),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(gt()){n.checked=!1,P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}es("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(gt()){a.checked=!1,P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}es("share")}),a.dataset.listenerAttached="true");const s=document.getElementById("res-payment-status");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{if(gt()){s.value="unpaid",dt(s,"unpaid"),P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}dt(s),Se()}),s.dataset.listenerAttached="true");const r=document.getElementById("res-payment-progress-type");r&&!r.dataset.listenerAttached?(r.dataset.userSelected!=="true"&&(r.value="percent"),r.addEventListener("change",i=>{if(gt()){r.value="percent",P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}r.dataset.userSelected="true",Se()}),r.dataset.listenerAttached="true"):r&&r.dataset.userSelected!=="true"&&!r.value&&(r.value="percent");const o=document.getElementById("res-payment-progress-value");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",i=>{if(gt()){o.value="",P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}i.target.value=I(i.target.value),Se()}),o.dataset.listenerAttached="true"),Se()}function dd(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;try{const r=document.getElementById("res-start"),o=document.getElementById("res-end");if(r&&!r.dataset.persistAttached){const i=()=>{try{At()}catch{}},l=()=>{try{nt(),Se()}catch{}En()};r.addEventListener("input",i),r.addEventListener("change",i),r.addEventListener("input",l),r.addEventListener("change",l),r.dataset.persistAttached="true"}if(o&&!o.dataset.persistAttached){const i=()=>{try{At()}catch{}},l=()=>{try{nt(),Se()}catch{}En()};o.addEventListener("input",i),o.addEventListener("change",i),o.addEventListener("input",l),o.addEventListener("change",l),o.dataset.persistAttached="true"}}catch{}let n=!1;const a=()=>{const r=e.value?.trim();if(!r){Se();return}const o=t.dataset.syncedWithStart;(!t.value?.trim()||o!=="false")&&(n=!0,t.value=r,t.dataset.syncedWithStart="true",t.dataset.syncedValue=r,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),Se();try{nt()}catch{}En()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{if(!n){t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false";try{At()}catch{}try{nt(),Se()}catch{}En()}});const s=()=>{try{At()}catch{}En()};e.addEventListener("input",s),e.addEventListener("change",s),t.addEventListener("change",s),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function br(){const{input:e,hidden:t}=Sn(),{input:n,hidden:a}=jt(),{customers:s}=Be();let r=t?.value?String(t.value):"";if(!r&&e?.value){const G=ha(e.value,{allowPartial:!0});G&&(r=String(G.id),t&&(t.value=r),e.value=G.label,e.dataset.selectedId=r)}const o=s.find(G=>String(G.id)===r);if(!o){P(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const i=o.id;let l=a?.value?String(a.value):"";if(!l&&n?.value){const G=Za(n.value,{allowPartial:!0});G&&(l=String(G.id),a&&(a.value=l),n.value=G.label,n.dataset.selectedId=l)}const u=document.getElementById("res-start").value,d=document.getElementById("res-end").value,y=document.getElementById("res-start-time")?.value||"00:00",b=document.getElementById("res-end-time")?.value||"00:00";if(!u||!d){P(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const p=`${u}T${y}`,f=`${d}T${b}`,S=new Date(p),A=new Date(f);if(Number.isNaN(S.getTime())||Number.isNaN(A.getTime())||S>=A){P(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const k=ls();k.map(G=>G.technicianId).filter(Boolean);const w=mt();if(w.length===0&&k.length===0){P(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const O=document.getElementById("res-notes")?.value||"",K=parseFloat(I(document.getElementById("res-discount")?.value))||0,Y=document.getElementById("res-discount-type")?.value||"percent",v=document.getElementById("res-payment-status"),N=v?.value||"unpaid",q=document.getElementById("res-payment-progress-type"),E=document.getElementById("res-payment-progress-value"),J=Ro(q),B=Mo(E),Z=l?zs(l):null,D=Ql(Z);if(l&&!Z){P(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const G of w){const pe=qt(G.barcode);if(pe==="maintenance"||pe==="retired"){P(Zt(pe));return}}const U=[];for(const G of w){const pe=be(G.barcode);if(Tt(pe,p,f)){const H=G?.desc||G?.name||G?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");U.push({label:I(String(H)),barcode:pe})}}if(U.length){const G=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let pe=null;try{const ae=Array.from(new Set(U.map(Ie=>Ie.barcode).filter(Boolean))),Ce=new Map;await Promise.all(ae.map(async Ie=>{const we=new URLSearchParams({type:"equipment",id:Ie,start:p,end:f}),Te=await It(`/reservations/availability.php?${we.toString()}`),$e=Array.isArray(Te?.conflicts)?Te.conflicts:[],Fe=Array.from(new Set($e.map(C=>C?.reservation_code||(C?.reservation_id!=null?`#${C.reservation_id}`:null)).filter(Boolean)));Ce.set(Ie,Fe)})),pe=U.map(({label:Ie,barcode:we})=>{const Te=Ce.get(we)||[];return Te.length?`${Ie} (${Te.join("ØŒ ")})`:Ie}).join("ØŒ ")}catch{}const H=pe||U.map(ae=>ae.label).filter(Boolean).map(String).join("ØŒ ");P(`${G}: ${H}`,"warning",6e3);return}const L=[];for(const G of w){if(G?.type!=="package")continue;const pe=G.packageId??G.package_id??null;if(pe&&Or(pe,p,f)){const H=G.desc||G.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let ae=[];try{const Ce=new URLSearchParams({type:"package",id:String(pe),start:p,end:f}),Ie=await It(`/reservations/availability.php?${Ce.toString()}`),we=Array.isArray(Ie?.conflicts)?Ie.conflicts:[];ae=Array.from(new Set(we.map(Te=>Te?.reservation_code||(Te?.reservation_id!=null?`#${Te.reservation_id}`:null)).filter(Boolean)))}catch{}L.push({label:I(String(H)),codes:ae})}}if(L.length){const G=L.map(({label:H,codes:ae})=>ae&&ae.length?`${H} (${ae.join("ØŒ ")})`:H).join("ØŒ "),pe=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");P(`${pe}: ${G}`,"warning",6e3);return}const T=[];for(const G of k){if(!G?.technicianId||!zr(G.technicianId,p,f))continue;const pe=G?.technicianName||G?.positionLabel||String(G.technicianId);let H=[];try{H=Hr(G.technicianId,p,f,null)}catch{}T.push({label:I(String(pe)),codes:H})}if(T.length){const G=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),pe=T.map(({label:H,codes:ae})=>ae&&ae.length?`${H} (${ae.join("ØŒ ")})`:H).join("ØŒ ");P(`${G}: ${pe}`);return}const R=document.getElementById("res-tax"),V=document.getElementById("res-company-share"),F=!!l;F?(R&&(R.checked=!1,R.disabled=!0,R.classList.add("disabled"),R.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),V&&(V.checked=!1,V.disabled=!0,V.classList.add("disabled"),V.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),v&&(v.value="unpaid",v.disabled=!0,dt(v,"unpaid"),v.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),q&&(q.disabled=!0,q.classList.add("disabled")),E&&(E.value="",E.disabled=!0,E.classList.add("disabled"))):(R&&(R.disabled=!1,R.classList.remove("disabled"),R.title=""),V&&(V.disabled=!1,V.classList.remove("disabled"),V.title=""),v&&(v.disabled=!1,v.title=""),q&&(q.disabled=!1,q.classList.remove("disabled")),E&&(E.disabled=!1,E.classList.remove("disabled")));const j=F?!1:R?.checked||!1,W=!!V?.checked;if(!F&&W!==j){P(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let oe=W?en():null;W&&(!Number.isFinite(oe)||oe<=0)&&(St(),oe=en());const te=W&&j&&Number.isFinite(oe)&&oe>0;j&&St();const me=cs(w,K,Y,j,k,{start:p,end:f,companySharePercent:te?oe:0}),ve=Ci(),Q=Fn({totalAmount:me,progressType:J,progressValue:B,history:[]});E&&Oo(E,Q.paymentProgressValue);const Ae=[];Q.paymentProgressValue!=null&&Q.paymentProgressValue>0&&Ae.push({type:Q.paymentProgressType||J,value:Q.paymentProgressValue,amount:Q.paidAmount,percentage:Q.paidPercent,recordedAt:new Date().toISOString()});const ue=Rn({manualStatus:N,paidAmount:Q.paidAmount,paidPercent:Q.paidPercent,totalAmount:me});v&&(v.value=ue,dt(v,ue));const ke=typeof Z?.paymentStatus=="string"?Z.paymentStatus.toLowerCase():null,Me=ke&&["paid","partial","unpaid"].includes(ke)?ke:"unpaid",Le=new Map,Ne=new Map,_e=new Map;document.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(G=>{const pe=ut(G.value),H=Number.isFinite(pe)&&pe>=0?tt(pe):null;if(H===null)return;const ae=G.dataset.packageIndex;if(ae!==void 0&&ae!==""){const we=Number.parseInt(ae,10);if(Number.isInteger(we)&&we>=0){Ne.set(we,H);const Te=w[we];if(Te){const $e=Fa(Te);$e&&_e.set($e,H)}}}const Ce=G.dataset.packageIdentity;if(Ce){const we=st(Ce)||I(String(Ce)).trim().toLowerCase();we&&_e.set(we,H)}const Ie=G.dataset.groupKey;Ie&&Le.set(Ie,H)});const Oe=w.map((G,pe)=>{let H=Ne.has(pe)?Ne.get(pe):void 0;if(H===void 0){const ae=Fa(G);ae&&(H=_e.get(ae))}if(H===void 0){const ae=vt(G);ae&&(H=Le.get(ae))}return H===void 0?G:{...G,cost:H,unit_cost:H,rental_cost:H,purchase_price:H,internal_cost:H,equipment_cost:H,package_cost:H,packageCost:H}}),Pe=(()=>{const G=[];Oe.forEach((H,ae)=>{if(String(H?.type||"").toLowerCase()!=="package")return;const Ce=Number.isFinite(Number(H.qty??H.quantity))?Number(H.qty??H.quantity):1,Ie=Number.isFinite(Number(H.unit_price??H.price))?Number(H.unit_price??H.price):0;let we=Number.isFinite(Number(H.unit_cost??H.cost))?Number(H.unit_cost??H.cost):0;const Te=vt(H),$e=Fa(H),Fe=(Ne.has(ae)?Ne.get(ae):void 0)??($e?_e.get($e):void 0)??(Te!==void 0?Le.get(Te):void 0);Fe!==void 0&&Number.isFinite(Fe)&&(we=tt(Fe));const C=Fe!==void 0?2:Number.isFinite(we)&&we>0?1:0;G.push({__dedupeKey:$e??`pkg-${ae}`,__priority:C,package_code:H.package_code??H.packageCode??H.barcode??H.code??null,name:H.name??H.desc??H.package_name??null,quantity:Ce,unit_price:Ie,unit_cost:we,package_cost:we,packageCost:we,cost:we,items:Array.isArray(H.packageItems)?H.packageItems:[]})});const pe=new Map;return G.forEach(H=>{const ae=H.__dedupeKey;(!pe.has(ae)||(H.__priority??0)>=(pe.get(ae).__priority??0))&&pe.set(ae,H)}),Array.from(pe.values()).map(H=>{const{__dedupeKey:ae,__priority:Ce,...Ie}=H;return Ie})})(),De=Pr({reservationCode:ve,customerId:i,start:p,end:f,status:D?"confirmed":"pending",title:null,location:null,notes:O,projectId:l||null,totalAmount:me,discount:F?0:K,discountType:F?"percent":Y,applyTax:j,paidStatus:F?Me:ue,confirmed:D,items:Oe.map(G=>({...G,equipmentId:G.equipmentId??G.id})),packages:Pe,crewAssignments:k,companySharePercent:F||!te?null:oe,companyShareEnabled:F?!1:te,paidAmount:F?0:Q.paidAmount,paidPercentage:F?0:Q.paidPercent,paymentProgressType:F?null:Q.paymentProgressType,paymentProgressValue:F?null:Q.paymentProgressValue,paymentHistory:F?[]:Ae});try{dr("about to submit",{crewAssignments:k,techniciansPayload:De?.technicians,payload:De});const G=await Fi(De);dr("server response",{reservation:G?.id??G?.reservationId??G?.reservation_code,technicians:G?.technicians,crewAssignments:G?.crewAssignments,techniciansDetails:G?.techniciansDetails}),pr(G)}catch(G){if(console.error("âŒ [reservations/createForm] Failed to create reservation",G),G?.name==="AbortError"){const H=await zl({reservationCode:ve});if(H){pr(H);return}}const pe=Tr(G)?G.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(pe,"error"),F&&(P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),Tn({clearValue:!1}))}}function ud(e){if(!Xn)return;const{draftStorageKey:t=Po,returnUrl:n=To}=Xn,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const s=window.sessionStorage.getItem(t),r=s?JSON.parse(s)||{}:{},o=Array.isArray(r.linkedReservationIds)?r.linkedReservationIds:[],i=String(a);o.includes(i)||o.push(i),r.linkedReservationIds=o,window.sessionStorage.setItem(t,JSON.stringify(r))}catch(s){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",s)}Xn=null,n&&(window.location.href=n)}function Tn({clearValue:e=!1}={}){const{input:t,hidden:n}=jt();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,Pt())}function pd(e,t=""){const{input:n,hidden:a}=jt();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),Pt())}function ni(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),bt({selectedValue:"",resetInput:!0});try{Kt("res-start","res-start-time","")}catch{}try{Kt("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),Tn({clearValue:!1}),Ht({selectedValue:"",resetInput:!0});const s=document.getElementById("equipment-description");s&&(s.value="");const r=document.getElementById("res-payment-status");r&&(r.value="unpaid",dt(r,"unpaid"));const o=document.getElementById("res-payment-progress-type");o&&(o.value="percent");const i=document.getElementById("res-payment-progress-value");i&&(i.value=""),Ri(),Hn([]),tc("form-reset"),nt(),Pt(),Se(),Do()}function md(){const e=document.getElementById("reservation-items");if(!e||e.dataset.listenerAttached)return;e.addEventListener("click",n=>{const a=n.target.closest("button[data-action]");if(!a)return;const{action:s,groupKey:r}=a.dataset;if(s==="decrease-group"&&r){sd(r);return}if(s==="increase-group"&&r){cd(r);return}if(s==="remove-group"&&r){rd(r);return}});const t=n=>{const a=n.target.closest(".reservation-unit-price-input");if(a){const r=a.dataset.groupKey;r&&od(r,a.value);return}const s=n.target.closest(".reservation-unit-cost-input");if(s){const r=s.dataset.groupKey;r&&id(r,s.value)}};e.addEventListener("change",t),e.dataset.listenerAttached="true"}function fd(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(aa()!=="single")return;const s=e.value;s?.trim()&&(clearTimeout(t),t=null,Go(s,e))};e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||aa()!=="single")return;const{start:r,end:o}=Bt();!r||!o||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function yd(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await br()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async a=>{a.preventDefault(),await br()}),t.dataset.listenerAttached="true");const n=document.getElementById("clear-reservation-form-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",a=>{a.preventDefault(),ni();try{Do()}catch{}P(c("reservations.toast.formCleared","ðŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),n.dataset.listenerAttached="true")}function yu({onAfterSubmit:e}={}){Ya=typeof e=="function"?e:null,un=!0;const{customers:t,projects:n}=Be();Xi(t||[]),bt(),Ks(),Ho(n||[]),Vo({projectsList:n}),Hs(),Vt(),Na(),Xl(),Wo(),Zo(),dd(),ld(),md(),fd(),yd(),Kl(),Gl(),Se(),nt();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{At()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}un=!1}function ai(){Vt(),Na(),Vo(),bt(),Ks(),Hs(),Wo(),Zo(),nt(),Se()}if(typeof document<"u"){const e=()=>{bt(),Ht({projectsList:Os()}),Ks(),Hs(),Se()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Vt()}),document.addEventListener("packages:changed",()=>{Na(),aa()==="package"&&ns("package")})}typeof window<"u"&&(window.getCompanySharePercent=en);function Gn(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function gd(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],s=Number.parseInt(a,10);return Number.isFinite(s)?s:null}function hd(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=gd(n);if(a!==null)return a}return null}function vr(e,t=0){const n=hd(e);if(n!=null)return n;const a=Gn(e.createdAt??e.created_at);if(a!=null)return a;const s=Gn(e.updatedAt??e.updated_at);if(s!=null)return s;const r=Gn(e.start);if(r!=null)return r;const o=Gn(e.end);if(o!=null)return o;const i=Number(e.id??e.reservationId);return Number.isFinite(i)?i:Number.isFinite(t)?t:0}function bd({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:s}){const r=e.map((w,O)=>({reservation:w,index:O})),o=t.searchTerm||"",i=t.searchReservationId||"",l=t.searchCustomerName||"",u=t.searchProjectId||"",d=t.startDate||"",y=t.endDate||"",b=t.status||"",p=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,f=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,S=d?new Date(`${d}T00:00:00`):null,A=y?new Date(`${y}T23:59:59`):null,k=r.filter(({reservation:w})=>{const O=n.get(String(w.customerId)),K=s?.get?.(String(w.projectId)),Y=w.start?new Date(w.start):null,v=jr(w),{effectiveConfirmed:N}=kn(w,K);if(p!=null&&String(w.customerId)!==String(p)||f!=null&&!(Array.isArray(w.technicians)?w.technicians.map(Z=>String(Z)):[]).includes(String(f))||b==="confirmed"&&!N||b==="pending"&&N||b==="completed"&&!v)return!1;if(b==="cancelled"){const B=String(w?.status||w?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(B))return!1}if(S&&Y&&Y<S||A&&Y&&Y>A)return!1;if(i){const B=[w.reservationId,w.id,w.reservation_id,w.reservationCode,w.reservation_code,w.code,w.reference,w.referenceNumber,w.reference_number],Z=lt(B.filter(U=>U!=null&&U!=="").map(String).join(" ")).replace(/\s+/g,""),D=i.replace(/\s+/g,"");if(!Z.includes(D))return!1}if(l&&!lt(O?.customerName||w.customerName||"").includes(l))return!1;if(u){const B=[w.projectId,w.project_id,w.projectID,K?.id,K?.projectCode,K?.project_code],Z=lt(B.filter(U=>U!=null&&U!=="").map(String).join(" ")).replace(/\s+/g,""),D=u.replace(/\s+/g,"");if(!Z.includes(D))return!1}if(!o)return!0;const q=w.items?.map?.(B=>`${B.barcode} ${B.desc}`).join(" ")||"",E=(w.technicians||[]).map(B=>a.get(String(B))?.name).filter(Boolean).join(" ");return lt([w.reservationId,O?.customerName||w.customerName,w.notes,q,E,K?.title].filter(Boolean).join(" ")).includes(o)});return k.sort((w,O)=>{const K=vr(w.reservation,w.index),Y=vr(O.reservation,O.index);return K!==Y?Y-K:O.index-w.index}),k}function vd({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const s=c("reservations.create.summary.currency","SR"),r=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),o=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),i=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),l=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),u=c("reservations.list.crew.separator","ØŒ "),d=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),y=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),b=c("reservations.list.status.completed","ðŸ“ Ù…ØºÙ„Ù‚"),p=c("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ"),f=c("reservations.list.payment.paid","ðŸ’³ Ù…Ø¯ÙÙˆØ¹"),S=c("reservations.list.payment.unpaid","ðŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),A=c("reservations.list.payment.partial","ðŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),k=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),w=c("reservations.list.actions.close","ðŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),O=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),K=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),Y={client:c("reservations.list.labels.client","ðŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ðŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ðŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ðŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ðŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ðŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ðŸ˜Ž Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:v,index:N})=>{const q=t.get(String(v.customerId)),E=v.projectId?a?.get?.(String(v.projectId)):null,J=v.id??v.reservationId??v.reservation_code??v.reservationCode??"",B=jr(v),Z=String(v?.status||v?.reservationStatus||"").toLowerCase(),D=Z==="cancelled"||Z==="canceled",U=v.items?.length||0,L=Array.isArray(v.crewAssignments)?v.crewAssignments:[],T=(v.technicians||[]).map(ie=>n.get(String(ie))).filter(Boolean),R=L.length?L.map(ie=>{const ce=ie.positionLabel??ie.position_name??ie.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),Ge=ie.technicianName??n.get(String(ie.technicianId??""))?.name??null;return Ge?`${I(ce)} (${I(Ge)})`:I(ce)}):T.map(ie=>ie.name),V=R.length?R.join(u):"â€”",F=I(String(v.reservationId??"")),j=v.start?I(Nt(v.start)):"-",W=v.end?I(Nt(v.end)):"-",oe=v.discount??v.discountValue??v.discount_value??v.discountAmount??0,te=Number.parseFloat(I(String(oe))),me=Number.isFinite(te)?te:0,ve=v.discountType??v.discount_type??v.discountMode??"percent",Q=String(ve).toLowerCase()==="amount"?"amount":"percent",Ae=!!(v.applyTax??v.apply_tax??v.taxApplied),ue=v.companySharePercent??v.company_share_percent??v.companyShare??v.company_share,ke=v.companyShareEnabled??v.company_share_enabled??v.companyShareApplied,Me=Number.parseFloat(I(String(ue))),Ne=(ke===!0||Number.isFinite(Me)&&Me>0)&&Number.isFinite(Me)?Me:0;let _e=0;try{const ie=is({items:v.items||[],technicianIds:v.technicians||[],crewAssignments:Array.isArray(v.crewAssignments)?v.crewAssignments:[],discount:me,discountType:Q,applyTax:Ae,start:v.start,end:v.end,companySharePercent:Ne,groupingSource:v}),ce=Number(ie?.finalTotal||0);_e=Number.isFinite(ce)?Number(ce.toFixed(2)):0}catch{_e=0}const et=Number.parseFloat(I(String(v.cost??0)))||0,Oe=_e>0?_e:et,Pe=v.paymentHistory||v.payment_history||[],De=Fn({totalAmount:Oe,paidAmount:Pe.length?0:v.paidAmount,paidPercent:Pe.length?0:v.paidPercent,history:Pe});let pe=Rn({manualStatus:null,paidAmount:De.paidAmount,paidPercent:De.paidPercent,totalAmount:Oe});if(E)try{const{totalWithTax:ie}=Ti(E)||{totalWithTax:0},ce=E.paymentHistory||E.payments||[],Ge=Fn({totalAmount:ie,paidAmount:ce.length?0:E.paidAmount,paidPercent:ce.length?0:E.paidPercent,history:ce}),Ke=Rn({manualStatus:null,paidAmount:Ge.paidAmount,paidPercent:Ge.paidPercent,totalAmount:ie});Ke&&(pe=Ke)}catch{}const H=pe==="paid",ae=pe==="partial",{effectiveConfirmed:Ce,projectLinked:Ie}=kn(v,E),we=Ce?"status-confirmed":"status-pending",Te=H?"status-paid":ae?"status-partial":"status-unpaid",$e=H?f:ae?A:S;let Fe=`<span class="reservation-chip status-chip ${we}">${Ce?d:y}</span>`,C=`<span class="reservation-chip status-chip ${Te}">${$e}</span>`,le="",re="";D?(Fe=`<span class="reservation-chip status-chip status-cancelled">${p}</span>`,C="",le=" tile-cancelled"):(le=H?" tile-paid":ae?" tile-partial":" tile-unpaid",B&&(le+=" tile-completed",Fe=`<span class="reservation-chip status-chip status-completed">${b}</span>`,C=H?`<span class="reservation-chip status-chip status-completed">${$e}</span>`:`<span class="reservation-chip status-chip ${Te}">${$e}</span>`,re=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`));let _="";!Ie&&!D&&(Ce?B||(_=`<button class="tile-confirm" data-reservation-index="${N}" data-reservation-id="${J}" data-action="close">${w}</button>`):_=`<button class="tile-confirm" data-reservation-index="${N}" data-reservation-id="${J}" data-action="confirm">${k}</button>`);const z=_?`<div class="tile-actions">${_}</div>`:"",g=I(Oe.toFixed(2)),$=I(String(U)),M=v.notes?I(v.notes):i,ee=l.replace("{count}",$),ne=v.applyTax?`<small>${r}</small>`:"";let se=O;return v.projectId&&(se=E?.title?I(E.title):K),`
      <div class="${_?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${le}"${re} data-reservation-index="${N}" data-reservation-id="${J}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${F}</div>
          <div class="tile-badges">
            ${Fe}
            ${C}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${Y.client}</span>
            <span class="tile-value">${q?.customerName||v.customerName||o}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.project}</span>
            <span class="tile-value">${se}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.start}</span>
            <span class="tile-value tile-inline">${j}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.end}</span>
            <span class="tile-value tile-inline">${W}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.cost}</span>
            <span class="tile-value">${g} ${s} ${ne}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.equipment}</span>
            <span class="tile-value">${ee}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.crew}</span>
            <span class="tile-value">${R.length?V:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ðŸ“ ${M}</span>
          </div>
        </div>
        ${z}
      </div>
    `}).join("")}const jn=8;function Sr(e,t){const n=Number.parseInt(e,10);return!Number.isFinite(n)||n<=0?1:Math.min(n,Math.max(1,t))}function wr(e={}){const t=Object.entries(e||{}).map(([n,a])=>[n,a==null?"":String(a)]).sort(([n],[a])=>n.localeCompare(a));return JSON.stringify(t)}function Sd(e,t){const a=Math.floor(2.5);let s=Math.max(1,e-a),r=Math.min(t,s+5-1);r-s+1<5&&(s=Math.max(1,r-5+1));const o=[];for(let i=s;i<=r;i+=1)o.push(i);return o}function wd({currentPage:e,totalPages:t,totalItems:n}){if(t<=1)return"";const a=c("reservations.list.pagination.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"),s=c("reservations.list.pagination.next","Ø§Ù„ØªØ§Ù„ÙŠ"),r=c("reservations.list.pagination.page","ØµÙØ­Ø© {page}"),o=c("reservations.list.pagination.range","{from}-{to} Ù…Ù† {total}"),i=(e-1)*jn+1,l=Math.min(n,e*jn),u=o.replace("{from}",i).replace("{to}",l).replace("{total}",n),d=Sd(e,t).map(y=>{const b=r.replace("{page}",y),p=y===e;return`<button type="button" class="reservation-page-btn${p?" is-active":""}" data-page="${y}" aria-label="${b}"${p?' aria-current="page"':""}>${y}</button>`}).join("");return`
    <div class="reservations-pagination" data-total-pages="${t}">
      <div class="reservations-pagination__controls">
        <button type="button" class="reservation-page-nav" data-page="${e-1}" ${e<=1?"disabled":""} aria-label="${a}">â€¹</button>
        <div class="reservation-page-list">${d}</div>
        <button type="button" class="reservation-page-nav" data-page="${e+1}" ${e>=t?"disabled":""} aria-label="${s}">â€º</button>
      </div>
      <div class="reservations-pagination__summary">${u}</div>
    </div>
  `}function kd({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a,onCloseReservation:s,onReopenReservation:r}={}){const o=fn(),{reservations:i=[],customers:l=[],technicians:u=[],projects:d=[]}=Be(),y=i.map(D=>{const U=Ma(D);return{...U,id:D.id??U.id,reservationId:D.reservationId??D.reservation_id??U.reservationId,reservationCode:D.reservationCode??D.reservation_code??U.reservationCode}}),b=y,p=Array.isArray(o)?o:u||[],f=new Map((d||[]).map(D=>[String(D.id),D])),S=document.getElementById(e);if(!S){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!b||b.length===0){S.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const A=t||ic(),k=new Map(l.map(D=>[String(D.id),D])),w=new Map(p.map(D=>[String(D.id),D])),O=bd({reservations:y,filters:A,customersMap:k,techniciansMap:w,projectsMap:f});if(O.length===0){S.innerHTML=`<p>${c("reservations.list.noResults","ðŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`,S.dataset.reservationsPage="1",S.dataset.reservationsFilters=wr(A);return}const K=Math.ceil(O.length/jn),Y=wr(A),N=(S.dataset.reservationsFilters||"")!==Y,q=Sr(S.dataset.reservationsPage,K);let E=N?1:q;S.dataset.reservationsFilters=Y;const J=()=>{S.querySelectorAll('[data-action="details"]').forEach(D=>{const U=Number(D.dataset.reservationIndex),L=D.dataset.reservationId||null;Number.isNaN(U)||D.addEventListener("click",()=>{typeof n=="function"&&n(U,L)})}),S.querySelectorAll('button[data-action="confirm"]').forEach(D=>{const U=Number(D.dataset.reservationIndex),L=D.dataset.reservationId||null;Number.isNaN(U)||D.addEventListener("click",T=>{T.stopPropagation(),typeof a=="function"&&a(U,T,L)})}),S.querySelectorAll('button[data-action="close"]').forEach(D=>{const U=Number(D.dataset.reservationIndex),L=D.dataset.reservationId||null;Number.isNaN(U)||D.addEventListener("click",T=>{T.stopPropagation(),typeof s=="function"&&s(U,T,L)})})},B=()=>{S.querySelectorAll(".reservations-pagination [data-page]").forEach(U=>{const L=Number.parseInt(U.dataset.page,10);Number.isFinite(L)&&U.addEventListener("click",T=>{U.disabled||(T.preventDefault(),T.stopPropagation(),Z(L))})})},Z=D=>{E=Sr(D,K),S.dataset.reservationsPage=String(E);const U=(E-1)*jn,L=O.slice(U,U+jn),T=vd({entries:L,customersMap:k,techniciansMap:w,projectsMap:f}),R=wd({currentPage:E,totalPages:K,totalItems:O.length});S.innerHTML=`<div class="reservations-grid">${T}</div>${R}`,J(),B()};Z(E)}function Id(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:s=[],customers:r=[],projects:o=[]}=Be(),i=s.map(A=>{const k=Ma(A);return{...k,id:A.id??k.id,reservationId:A.reservationId??A.reservation_id??k.reservationId,reservationCode:A.reservationCode??A.reservation_code??k.reservationCode}}),l=s[e];if(!l)return P(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;let u=i[e]??Ma(l);const d=r.find(A=>String(A.id)===String(l.customerId)),y=l.projectId?o.find(A=>String(A.id)===String(l.projectId)):null,b=document.getElementById("reservation-details-body"),p=document.getElementById("reservationDetailsModal"),f=(A,k=null)=>{if(b){const w=k??(fn()||[]);b.innerHTML=ji(A,d,w,e,y)}},S=()=>{const A=()=>{p&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(p)?.hide()},k=document.getElementById("reservation-details-edit-btn");k&&(k.onclick=()=>{A(),typeof t=="function"&&t(e,{reservation:l,customer:d,getEditContext:a})});const w=document.getElementById("reservation-details-delete-btn");w&&(w.onclick=()=>{A(),typeof n=="function"&&n(e,{reservation:l,customer:d})});const O=b?.querySelector('[data-action="open-project"]');O&&y&&O.addEventListener("click",()=>{A();const v=y?.id!=null?String(y.id):"",N=v?`projects.html?project=${encodeURIComponent(v)}`:"projects.html";window.location.href=N});const K=document.getElementById("reservation-details-export-btn");K&&(K.onclick=async v=>{v?.preventDefault?.(),v?.stopPropagation?.(),K.blur();try{await Bl({reservation:l,customer:d,project:y})}catch(N){console.error("âŒ [reservations] export to PDF failed",N),P(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const Y=document.getElementById("reservation-details-checklist-btn");Y&&(Y.onclick=async v=>{v?.preventDefault?.(),v?.stopPropagation?.(),Y.blur();try{await Dl({reservation:l,customer:d,project:y})}catch(N){console.error("âŒ [reservations] export checklist PDF failed",N),P(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const v=b?.querySelector("[data-tech-slider]");if(v){const N=v.querySelector("[data-slider-track]"),q=v.querySelector("[data-slider-prev]"),E=v.querySelector("[data-slider-next]");if(N&&(q||E)){const J=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",B=()=>{const U=N.querySelector(".reservation-technician-card"),L=U&&U.getBoundingClientRect().width||220,T=12,R=Math.max(1,Math.floor(N.clientWidth/(L+T)));return Math.max(L+T,Math.floor(R*(L+T)*.9))},Z=()=>{const U=Math.max(0,N.scrollWidth-N.clientWidth-2),L=N.scrollLeft<=1,T=N.scrollLeft>=U;q&&(q.disabled=L),E&&(E.disabled=T)},D=U=>{const L=B()*U,T=J?-L:L;N.scrollBy({left:T,behavior:"smooth"})};q?.addEventListener("click",()=>D(-1)),E?.addEventListener("click",()=>D(1)),N.addEventListener("scroll",Z,{passive:!0}),window.addEventListener("resize",Z,{passive:!0}),setTimeout(Z,0)}}}catch{}};if(b&&(f(u),S(),Ur().then(()=>{const A=fn()||[];f(u,A),S()}).catch(()=>{})),Br(u)){const A=u.id||u.reservationId||u.reservation_code;Dr(A).then(k=>{k&&(u=k,f(u),S())}).catch(()=>{})}return p&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(p).show(),!0}function Ad(){try{const e=window.__EDIT_RESERVATION_RANGE__;if(e&&typeof e=="object")return{start:typeof e.start=="string"?e.start:null,end:typeof e.end=="string"?e.end:null}}catch{}return{start:null,end:null}}function kr(e,t){const n=Ad(),a={start:e||n.start||null,end:t||n.end||null};try{window.__EDIT_RESERVATION_RANGE__=a}catch{}return a}function sn(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";let s=null,r=null;if(e&&(s=Xt(e,n)||`${e}T${n}`),t&&(r=Xt(t,a)||`${t}T${a}`),!s||!r){const o=kr(s,r);s=s||o.start,r=r||o.end}else kr(s,r);return{start:s||null,end:r||null}}function ba(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Us(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Zn(){const{container:e,select:t,hint:n,addButton:a}=Us();if(!t)return;const s=t.value,r=Rr(),o=c("reservations.create.summary.currency","SR"),i=`<option value="" disabled selected>${c("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,l=r.map(d=>{const y=Number.isFinite(Number(d.price))?Number(d.price):0,b=I(y.toFixed(2)),p=`${d.name} â€” ${b} ${o}`;return`<option value="${ba(d.id)}">${ba(p)}</option>`}).join("");t.innerHTML=`${i}${l}`;const u=r.length>0;t.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),n&&(u?(n.textContent=c("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),u&&s&&r.some(d=>d.id===s)?t.value=s:t.selectedIndex=0}function Ed(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||P(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:s=[]}=Ze(),{start:r,end:o}=sn(),{reservations:i=[]}=Be(),l=a!=null&&i[a]||null,u=l?.id??l?.reservationId??null,d=Yo(n,{existingItems:s,start:r,end:o,ignoreReservationId:u});if(!d.success)return t||P(d.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),d;const y=[...s,d.package];return wt(a,y),ct(y),rt(),t||P(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),d}function Ir(){const{select:e}=Us();if(!e)return;const t=e.value||"";Ed(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function qd(){const{addButton:e,select:t}=Us();t&&!t.dataset.langRefreshAttached&&(document.addEventListener("language:changed",Zn),document.addEventListener("language:translationsReady",Zn),t.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Ir()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Ir())}),t.dataset.listenerAttached="true"),Zn()}function ct(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),r=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="7" class="text-center">${n}</td></tr>`,Er(t);return}const{groups:l}=tn({items:e},{preserveOriginalOrder:!0}),u=c("reservations.equipment.table.reorder","Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨");t.innerHTML=l.map(d=>{const y=d.items[0]||{},b=wn(y)||d.image,p=b?`<img src="${b}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ðŸŽ¥</div>',f=String(d?.type||"").toLowerCase()==="package"||d.items.some(j=>j?.type==="package"),S=I(String(d.count)),A=ut(d.unitPrice),k=Number.isFinite(A)?tt(A):0,w=ut(d.unitCost);let O=Number.isFinite(w)?tt(w):0;const K=(()=>{try{const{start:j,end:W}=sn(),oe=typeof mn=="function"?mn(j,W):1;return Number.isFinite(oe)&&oe>0?oe:1}catch{return 1}})(),Y=(()=>{const j=d.count??d.quantity??1;if(typeof j=="number")return Number.isFinite(j)&&j>0?j:1;const W=Number.parseFloat(I(String(j)).replace(/[^0-9.]/g,""));return Number.isFinite(W)&&W>0?W:1})(),v=tt(k*Y*K),N=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${d.key}"
          min="0"
          step="0.01"
          value="${I(String(k))}"
          aria-label="${c("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,q=`edit-unit-cost-${d.key}`,E=(()=>{for(let j=0;j<e.length;j+=1){const W=e[j];if(!(!W||String(W.type||"").toLowerCase()!=="package")&&vt(W)===d.key)return j}return null})();if(E!=null&&Number.isInteger(E)&&e[E]){const j=e[E],W=ut(j.unit_cost??j.cost??j.package_cost??j.packageCost);Number.isFinite(W)&&(O=tt(W))}const J=(()=>{if(!f)return null;const j=[d.packageId,d.package_id,d.packageCode,d.package_code,d.packageDisplayCode,d.barcode,d.key];for(const W of j){if(!W)continue;const oe=st(W);if(oe)return oe;const te=I(String(W)).trim().toLowerCase();if(te)return te}return null})(),B=J?`data-package-identity="${J}"`:"",Z=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${q}"
          data-group-key="${d.key}"
          ${B}
          ${E!=null&&Number.isInteger(E)?`data-package-index="${E}"`:""}
          min="0"
          step="0.01"
          value="${I(String(O))}"
          aria-label="${c("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,D=`${I(v.toFixed(2))} ${a}`,U=`
        <span
          class="reservation-row-handle"
          data-drag-handle="true"
          draggable="true"
          title="${u}"
          aria-label="${u}"
          role="button"
          tabindex="0"
        >
          â‹®â‹®
        </span>
      `,L=d.barcodes.map(j=>I(String(j||""))).filter(Boolean),T=L.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${L.map(j=>`<li>${j}</li>`).join("")}
            </ul>
          </details>`:"";let R="";if(f){const j=new Map,W=te=>{const me=Number.parseFloat(I(String(te??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(me)||me<=0||me>99?1:Math.round(me)},oe=[];if(Array.isArray(d.packageItems)&&d.packageItems.length&&oe.push(...d.packageItems),d.items.forEach(te=>{Array.isArray(te?.packageItems)&&oe.push(...te.packageItems)}),oe.forEach(te=>{if(!te)return;const me=be(te.barcode||te.normalizedBarcode||te.desc||Math.random());if(!me)return;const ve=j.get(me),Q=W(te.qtyPerPackage??te.perPackageQty??te.quantityPerPackage??te.qty??te.quantity??1),Ae=Math.max(1,Math.min(Q,99));if(ve){ve.qty=Ae;return}j.set(me,{desc:te.desc||te.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Ae,barcode:te.barcode??te.normalizedBarcode??""})}),j.size){const te=Array.from(j.values()).map(me=>{const ve=I(String(me.qty>0?Math.min(me.qty,99):1)),Q=ba(me.desc||""),Ae=me.barcode?` <span class="reservation-package-items__barcode">(${ba(I(String(me.barcode)))})</span>`:"";return`<li>${Q}${Ae} Ã— ${ve}</li>`}).join("");R=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${te}
              </ul>
            </details>
          `}}const V=f?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",F=f?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${d.key}" data-drag-row="true" draggable="true">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-drag">
                ${U}
              </div>
              <div class="reservation-item-thumb-wrapper">${p}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${d.description||"-"}</div>
                ${f?`${R||""}${T||""}`:T}
              </div>
            </div>
          </td>
          <td>
            <div class="${V}" data-group-key="${d.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${d.key}" aria-label="${o}"${F}>âˆ’</button>
              <span class="reservation-qty-value">${S}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${d.key}" aria-label="${r}"${F}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${I(String(K))}</span></td>
          <td>${N}</td>
          <td>${Z}</td>
          <td>${D}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${d.key}" aria-label="${i}">ðŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Cd(t),Er(t)}function _d(e=[]){if(!Array.isArray(e)||!e.length)return;const{index:t,items:n}=Ze();if(!Array.isArray(n)||!n.length)return;const{groups:a}=tn({items:n},{preserveOriginalOrder:!0}),s=new Map;a.forEach(l=>{Array.isArray(l.itemIndices)&&l.itemIndices.length&&s.set(l.key,[...l.itemIndices])});const r=new Set,o=[];if(e.forEach(l=>{const u=s.get(l);!u||!u.length||u.forEach(d=>{r.has(d)||n[d]&&(o.push(n[d]),r.add(d))})}),!o.length||(n.forEach((l,u)=>{r.has(u)||o.push(l)}),o.length!==n.length))return;if(o.every((l,u)=>l===n[u])){ct(n);return}wt(t,o),ct(o),rt()}function Cd(e){if(!e||e.dataset.dragListenerAttached==="true")return;let t=null;const n=()=>Array.from(e.querySelectorAll("tr[data-group-key]")).map(s=>s.dataset.groupKey),a=s=>{const r=e.querySelector("tr[data-group-key].is-dragging");if(r&&r.classList.remove("is-dragging"),!t)return;const o=t.initialOrder||[];if(t=null,!s){ct(Ze().items);return}const i=n();if(o.length===i.length&&o.every((u,d)=>u===i[d])){ct(Ze().items);return}_d(i)};e.addEventListener("dragstart",s=>{if(s.target.closest("button, input, textarea, select, a[href]")&&!s.target.closest("[data-drag-handle]"))return;const o=s.target.closest("[data-drag-handle], tr[data-group-key]");if(!o)return;const i=o.closest("tr[data-group-key]");if(i){t={key:i.dataset.groupKey,initialOrder:n()},i.classList.add("is-dragging");try{s.dataTransfer?.setData?.("text/plain",i.dataset.groupKey||""),s.dataTransfer.effectAllowed="move"}catch{}}}),e.addEventListener("dragover",s=>{if(!t)return;const r=s.target.closest("tr[data-group-key]"),o=e.querySelector("tr[data-group-key].is-dragging");if(!r||!o||r===o)return;s.preventDefault();const i=r.getBoundingClientRect();s.clientY>i.top+i.height/2?r.after(o):r.before(o)}),e.addEventListener("drop",s=>{t&&(s.preventDefault(),a(!0))}),e.addEventListener("dragend",()=>{t&&a(!1)}),e.dataset.dragListenerAttached="true"}function $d(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ðŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Pa(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let t=Ta();const n=document.getElementById("edit-res-project")?.value||"";if(n)try{const o=(Be()?.projects||[]).find(l=>String(l.id)===String(n)),i=Array.isArray(o?.paymentHistory)?o.paymentHistory:Array.isArray(o?.payment_history)?o.payment_history:Array.isArray(o?.payments)?o.payments:Array.isArray(o?.paymentLogs)?o.paymentLogs:[];Array.isArray(i)&&i.length&&(t=i)}catch{}if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Ar();return}const a=c("reservations.create.summary.currency","SR"),s=t.map((r,o)=>{const i=Number.isFinite(Number(r?.amount))&&Number(r.amount)>0?`${I(Number(r.amount).toFixed(2))} ${a}`:"â€”",l=Number.isFinite(Number(r?.percentage))&&Number(r.percentage)>0?`${I(Number(r.percentage).toFixed(2))}%`:"â€”",u=r?.recordedAt?I(Nt(r.recordedAt)):"â€”",d=$d(r?.type),y=r?.note?I(r.note):"";return`
      <tr>
        <td>${d}</td>
        <td>${i}</td>
        <td>${l}</td>
        <td>${u}</td>
        <td>${y}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${o}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ðŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${s}</tbody>
      </table>
    </div>
  `,Ar()}function xd(){if(zn()){P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=oi(e);let a=ii(t);if(!Number.isFinite(a)||a<=0){P(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const s=Oa.lastResult,r=Number(s?.total)||0,o=Number(s?.paidPercent)||0,i=Number(s?.paidAmount)||0,l=c("reservations.create.summary.currency","SR");let u=null,d=null;if(n==="percent"){const b=Math.max(0,100-o);if(b<=1e-4){P(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const p=Math.min(a,b);if(p!==a){const f=I(p.toFixed(2));P(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",f)),a=p}d=Number(a.toFixed(2)),r>0&&(u=a/100*r)}else{const b=Math.max(0,r-i);if(b<=1e-4){P(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const p=Math.min(a,b);if(p!==a){const f=`${I(p.toFixed(2))} ${l}`;P(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",f)),a=p}u=Number(a.toFixed(2)),r>0&&(d=u/r*100)}u!=null&&(u=Number(u.toFixed(2))),d!=null&&(d=Number(d.toFixed(2)));const y={type:n,value:a,amount:u,percentage:d,recordedAt:new Date().toISOString()};Vd(y),Qs(Ta()),Pa(),rt(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),P(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Ar(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(zn()){n.preventDefault(),P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}xd()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(zn()){n.preventDefault(),P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const s=Number(a.dataset.index);Number.isNaN(s)||(Ud(s),Qs(Ta()),Pa(),rt(),P(c("reservations.toast.paymentRemoved","ðŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),t.dataset.listenerAttached="true")}function Ld(e){const{index:t,items:n}=Ze(),{groups:a}=tn({items:n}),s=a.find(i=>i.key===e);if(!s||s.items.some(i=>i?.type==="package"))return;let r=-1;for(let i=n.length-1;i>=0;i-=1){const l=n[i];if(vt(l)===e&&l?.type!=="package"){r=i;break}}if(r<0)return;const o=n.filter((i,l)=>l!==r);wt(t,o),ct(o),rt()}function Nd(e){const{index:t,items:n}=Ze(),{groups:a}=tn({items:n}),s=a.find(i=>i.key===e);if(!s)return;let r=n.filter(i=>vt(i)!==e);if(s.items.some(i=>i&&i.type==="package")){const i=st(s.packageId??s.items.find(y=>y?.type==="package")?.packageId??""),l=be(s.package_code??s.packageDisplayCode??s.barcode??"");r=r.filter(y=>{if(!y||typeof y!="object"||y.type!=="package")return!0;const b=st(y.packageId??y.package_id??y.id??""),p=be(y.barcode??y.package_code??"");return!(i&&b===i||l&&p&&p===l)});const u=new Set,d=new Set;s.items.forEach(y=>{(Array.isArray(y?.packageItems)?y.packageItems:[]).forEach(p=>{const f=be(p?.barcode||p?.normalizedBarcode||"");f&&u.add(f);const S=p?.equipmentId??p?.equipment_id??null;S!=null&&d.add(String(S))})}),(u.size||d.size)&&(r=r.filter(y=>{const b=be(y?.barcode||""),p=y?.equipmentId??y?.id??null;return!(b&&u.has(b)||p!=null&&d.has(String(p)))}))}r.length!==n.length&&(wt(t,r),ct(r),rt())}function Pd(e){const{index:t,items:n}=Ze(),{groups:a}=tn({items:n}),s=a.find(A=>A.key===e);if(!s||s.items.some(A=>A?.type==="package"))return;const{start:r,end:o}=sn();if(!r||!o){P(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:i=[]}=Be(),l=t!=null&&i[t]||null,u=l?.id??l?.reservationId??null,d=new Set(n.map(A=>be(A.barcode))),{equipment:y=[]}=Be(),b=(y||[]).find(A=>{const k=be(A?.barcode);if(!k||d.has(k)||vt({desc:A?.desc||A?.description||A?.name||"",price:Number(A?.price)||0})!==e)return!1;const O=qt(A);return O==="maintenance"||O==="retired"?!1:!Tt(k,r,o,u)});if(!b){P(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const p=be(b.barcode),f=an(b);if(!f){P(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const S=[...n,{id:f,equipmentId:f,barcode:p,desc:b.desc||b.description||b.name||s.description||"",qty:1,price:Number.isFinite(Number(b.price))?Number(b.price):s.unitPrice,cost:Jt(b),image:wn(b)}];wt(t,S),ct(S),rt()}function Td(e,t,n=null){const a=ut(t),s=Number.isFinite(a)&&a>=0?tt(a):0,{index:r,items:o}=Ze();if(!Array.isArray(o))return;const l=nn(o).find(y=>y.key===e);if(!l)return;const u=Number.isInteger(n)?[n]:Array.isArray(l.itemIndices)?l.itemIndices:[];if(!u.length)return;const d=[...o];u.forEach(y=>{if(d[y]){const b={...d[y],cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s};d[y]=b}}),wt(r,d),ct(d),rt()}function jd(e,t){const n=ut(t),a=Number.isFinite(n)&&n>=0?tt(n):0,{index:s,items:r}=Ze();if(!Array.isArray(r))return;const i=nn(r).find(u=>u.key===e);if(!i||!Array.isArray(i.itemIndices))return;const l=[...r];i.itemIndices.forEach(u=>{l[u]&&(l[u]={...l[u],price:a,unit_price:a})}),wt(s,l),ct(l),rt()}function Er(e){if(!e||e.dataset.groupListenerAttached)return;e.addEventListener("click",a=>{const s=a.target.closest("button[data-action]");if(!s)return;const{action:r,groupKey:o,itemIndex:i}=s.dataset;if(r==="decrease-edit-group"&&o){Ld(o);return}if(r==="increase-edit-group"&&o){Pd(o);return}if(r==="remove-edit-group"&&o){Nd(o);return}if(r==="remove-edit-item"){const l=Number(i);Number.isNaN(l)||Fd(l)}});const t=a=>{const s=a.target.closest(".reservation-unit-cost-input");if(!s)return;const r=s.dataset.groupKey;if(!r)return;const o=s.dataset.packageIndex??"",i=o!==""?Number.parseInt(o,10):null;Td(r,s.value,Number.isInteger(i)?i:null)},n=a=>{const s=a.target.closest(".reservation-unit-price-input");if(!s)return;const r=s.dataset.groupKey;r&&jd(r,s.value)};e.addEventListener("change",t),e.addEventListener("change",n),e.dataset.groupListenerAttached="true"}function zn(){return!!document.getElementById("edit-res-project")?.value}function Bd(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{zn()&&(P(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(s=>a.addEventListener(s,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function Dd(e){const t=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),s=document.getElementById("edit-res-paid"),r=document.getElementById("edit-res-payment-progress-type"),o=document.getElementById("edit-res-payment-progress-value"),i=document.getElementById("edit-res-payment-add"),l=document.getElementById("edit-res-payment-history");if([n,a,s,r,o,i,l].forEach(Bd),e){if(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),s){const u=document.getElementById("edit-res-project")?.value||"";let d="unpaid";if(u)try{const b=(Be()?.projects||[]).find(f=>String(f.id)===String(u)),p=typeof b?.paymentStatus=="string"?b.paymentStatus.toLowerCase():null;p&&["paid","partial","unpaid"].includes(p)&&(d=p)}catch{}s.value=d,s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t,s.dataset&&delete s.dataset.userSelected}r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t),o&&(o.value="",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),i&&(i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),l&&(l.dataset.linkedDisabled="true")}else n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),l&&(l.dataset.linkedDisabled="false")}function rt(){const e=document.getElementById("edit-res-summary");if(!e)return;Pa();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),dt(a),rt()}),a.dataset.listenerAttached="true");const s=I(t?.value||"0");t&&(t.value=s);const r=parseFloat(s)||0,o=n?.value||"percent",i=zn();Dd(i);const l=document.getElementById("edit-res-tax"),u=i?!1:l?.checked||!1,d=!i&&a?.dataset?.userSelected==="true";let y="unpaid";if(i){const O=document.getElementById("edit-res-project")?.value||"";if(O)try{const Y=(Be()?.projects||[]).find(N=>String(N.id)===String(O)),v=typeof Y?.paymentStatus=="string"?Y.paymentStatus.toLowerCase():null;v&&["paid","partial","unpaid"].includes(v)&&(y=v)}catch{}}else y=d&&a?.value||"unpaid";let b=null;!i&&u&&(St("edit-res-company-share"),b=en("edit-res-company-share"),(!Number.isFinite(b)||b<=0)&&(St("edit-res-company-share"),b=en("edit-res-company-share")));const{items:p=[],payments:f=[]}=Ze(),{start:S,end:A}=sn(),k=Oa({items:p,discount:r,discountType:o,applyTax:u,paidStatus:y,start:S,end:A,companySharePercent:b,paymentHistory:f});e.innerHTML=k;const w=Oa.lastResult;if(w&&a){const O=w.paymentStatus;d?dt(a,a.value):(a.value!==O&&(a.value=O),a.dataset&&delete a.dataset.userSelected,dt(a,O))}else a&&dt(a,a.value)}function Fd(e){if(e==null)return;const{index:t,items:n}=Ze();if(!Array.isArray(n))return;const a=n.filter((s,r)=>r!==e);wt(t,a),ct(a),rt()}async function Rd(e){const t=e?.value??"",n=be(t)||I(String(t)).trim().toLowerCase();if(!n)return;const a=os(n);if(!a){P(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const s=qt(a);if(s==="maintenance"||s==="retired"){P(Zt(s));return}const r=be(n),{index:o,items:i=[]}=Ze();if(i.findIndex(k=>be(k.barcode)===r)>-1){P(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:u,end:d}=sn();if(!u||!d){P(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:y=[]}=Be(),b=o!=null&&y[o]||null,p=b?.id??b?.reservationId??null;if(Tt(r,u,d,p)){const k=c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),w=gn([r],u,d,p),O=vn(w,k);P(O);return}const f=an(a);if(!f){P(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const S=typeof Jt=="function"?Jt(a):Number.isFinite(Number(a?.cost))?Number(a.cost):0,A=[...i,{id:f,equipmentId:f,barcode:r,desc:a.desc,qty:1,price:a.price,cost:S,image:a.image||a.imageUrl||a.img||null}];wt(o,A),e&&(e.value=""),ct(A),rt()}async function va(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Uo(t),a=be(n?.barcode||t)||I(String(n?.barcode||t)).trim().toLowerCase();if(!n||!a){P(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const s=qt(n);if(s==="maintenance"||s==="retired"){P(Zt(s));return}const{start:r,end:o}=sn();if(!r||!o){P(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:i,items:l=[]}=Ze();if(l.some(A=>be(A.barcode)===a)){P(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:d=[]}=Be(),y=i!=null&&d[i]||null,b=y?.id??y?.reservationId??null;if(Tt(a,r,o,b)){const A=c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),k=gn([a],r,o,b),w=vn(k,A);P(w);return}const p=an(n);if(!p){P(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const f=typeof Jt=="function"?Jt(n):Number.isFinite(Number(n?.cost))?Number(n.cost):0,S=[...l,{id:p,equipmentId:p,barcode:a,desc:n.desc,qty:1,price:n.price,cost:f,image:n.image||n.imageUrl||n.img||null}];wt(i,S),ct(S),rt(),e.value=""}function si(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),va(e))});const t=()=>{Qo(e.value,"edit-res-equipment-description-options")&&va(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{rt()});const e=()=>{qd()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Zn()})}typeof window<"u"&&(window.getEditReservationDateRange=sn,window.renderEditPaymentHistory=Pa);function Md(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){ts(e);return}va(e)}}function gu(){Vt(),si()}function Od(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let pn=null,yt=[],_t=[],as=null,Ye={},Ra=!1,qr=!1;function zd(){if(!qr)try{document.addEventListener("click",e=>{const t=e.target?.closest?.("#save-reservation-changes");if(t){try{if(t.dataset.listenerAttached==="true")return}catch{}try{t.dataset.saving||(t.dataset.saving="true",setTimeout(()=>{try{delete t.dataset.saving}catch{}},1200))}catch{}try{di(Ye).catch(n=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",n)})}catch(n){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",n)}}},!0),qr=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Hd="__DEBUG_CREW__";function Kd(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Hd);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function _r(e,t){if(Kd())try{console.log(`ðŸªµ [crew-debug:edit] ${e}`,t)}catch{}}function Bn(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),s=document.getElementById("edit-res-confirmed-wrapper"),r=!!e;if(n&&(n.value=r?"true":"false"),a){const o=c("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),i=c("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=r?o:i,a.dataset.state=r?"confirmed":"pending",a.classList.toggle("btn-success",r&&!t),a.classList.toggle("btn-outline-secondary",!r||t),a.disabled=t,a.setAttribute("aria-pressed",r?"true":"false")}s&&s.classList.toggle("is-disabled",t)}function xn(){return document.getElementById("edit-res-confirmed")?.value==="true"}function Ze(){return{index:pn,items:yt,payments:_t}}function wt(e,t,n=_t){pn=typeof e=="number"?e:null,yt=Array.isArray(t)?[...t]:[],_t=Array.isArray(n)?[...n]:[]}function ri(){pn=null,yt=[],Vi(),_t=[]}function Ta(){return[..._t]}function Qs(e){_t=Array.isArray(e)?[...e]:[]}function Vd(e){e&&(_t=[..._t,e])}function Ud(e){!Number.isInteger(e)||e<0||(_t=_t.filter((t,n)=>n!==e))}function ea(e,t=1){const n=Number.parseFloat(I(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function Dn(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(I(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function Qd(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?be(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:ea(e.qty??e.quantity??e.count??1),price:Dn(e.price??e.unit_price??e.unitPrice??0),cost:Dn(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.purchase_price??0),image:e.image??e.image_url??e.imageUrl??null}}function Gd(e,t=0){if(!e||typeof e!="object")return null;const n=st(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=1,r=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:ms(e)).map(p=>Qd(p)).filter(Boolean),o=e.total_price??e.totalPrice??e.total??null;let i=Dn(e.unit_price??e.unitPrice??e.price??null,0);if((!i||i===0)&&o!=null){const p=Dn(o,0);p>0&&a>0&&(i=Number((p/a).toFixed(2)))}let l=Dn(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??null,0);(!l||l===0)&&r.length&&(l=0);const u=e.package_code??e.packageCode??e.barcode??null,y=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,u,n].find(p=>p!=null&&String(p).trim()!=="")||`Package ${n}`,b=e.image??e.cover??e.thumbnail??r.find(p=>p?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:I(String(y)),name:I(String(y)),qty:a,price:i,cost:l,unit_cost:l,rental_cost:l,purchase_price:l,internal_cost:l,equipment_cost:l,barcode:u,packageItems:r,image:b}}function Wd(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const s=e.get(a);if(s==null)return;const r=s-n;e.set(a,r>0?r:0)})}function Yd(e={},t=[]){const n=Array.isArray(t)?t.map(u=>({...u})):[],a=new Map;Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(u=>{if(!u||typeof u!="object")return;const d=st(u.packageId??u.package_id??u.package_code??u.packageCode??u.code??u.id??"");d&&a.set(d,u)});const r=(Array.isArray(e?.packages)?e.packages:[]).map(u=>{const d=st(u.packageId??u.package_id??u.package_code??u.packageCode??u.code??u.id??"");if(!d||!a.has(d))return u;const y=ut(u.unit_cost??u.unitCost??u.cost??u.rental_cost??u.purchase_price??u.internal_cost??u.equipment_cost??u.item_cost);if(Number.isFinite(y)&&y>0)return u;const b=a.get(d),p=ut(b.unit_cost??b.unitCost??b.cost??b.package_cost??b.rental_cost??b.purchase_price??b.internal_cost??b.equipment_cost??b.item_cost);if(!Number.isFinite(p)||p<=0)return u;const f=tt(p);return{...u,unit_cost:f,unitCost:f,cost:f,rental_cost:u.rental_cost??f,purchase_price:u.purchase_price??f,internal_cost:u.internal_cost??f,equipment_cost:u.equipment_cost??f,item_cost:u.item_cost??f}});if(!r.length)return n;const o=r.map((u,d)=>Gd(u,d)).filter(Boolean);if(!o.length)return n;const i=new Map;o.forEach(u=>{const d=ea(u.qty??u.quantity??1);if(u.barcode){const y=be(u.barcode);if(y){const b=`package::${y}`;i.set(b,(i.get(b)??0)+d)}}(u.packageItems||[]).forEach(y=>{if(!y)return;const b=d*ea(y.qty??y.quantity??1),p=y.equipmentId??null,f=y.normalizedBarcode||(y.barcode?be(y.barcode):null);if(p!=null){const S=`equipment::${String(p)}`;i.set(S,(i.get(S)??0)+b)}if(f){const S=`barcode::${f}`;i.set(S,(i.get(S)??0)+b)}})});const l=[];return n.forEach(u=>{if(!u||typeof u!="object"){l.push(u);return}if(u.type==="package"){const w=st(u.packageId??u.package_id??u.id??"");o.some(K=>K.packageId===w)||l.push({...u});return}const d=ea(u.qty??u.quantity??1),y=an(u),b=u.barcode?be(u.barcode):null,p=[];y!=null&&p.push(`equipment::${String(y)}`),b&&p.push(`barcode::${b}`);const f=p.map(w=>i.get(w)??0).filter(w=>w>0);if(!f.length){l.push({...u});return}const S=Math.min(...f);if(S<=0){l.push({...u});return}const A=Math.min(S,d);if(Wd(i,p,A),A>=d)return;const k=d-A;l.push({...u,qty:k,quantity:k})}),[...l,...o.map(u=>({...u}))]}function Jd(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function oi(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function ii(e){if(!e)return null;const t=I(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Xd(e,t){if(e){e.value="";return}}function qn(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ci(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(I(String(e.value??""))),a=Number.parseFloat(I(String(e.amount??""))),s=Number.parseFloat(I(String(e.percentage??""))),r=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,o=Number.isFinite(s)?s:t==="percent"&&Number.isFinite(n)?n:null,i=t??(Number.isFinite(r)?"amount":Number.isFinite(o)?"percent":null),l=i==="amount"?r??null:i==="percent"?o??null:Number.isFinite(n)?n:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:i,value:l,amount:Number.isFinite(r)?r:null,percentage:Number.isFinite(o)?o:null,note:e.note??null,recordedAt:u}}function Zd(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),s=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),r=t?.projectId?String(t.projectId):"",o=Array.isArray(e)?[...e].sort((l,u)=>String(u.createdAt||u.start||"").localeCompare(String(l.createdAt||l.start||""))):[],i=[`<option value="">${qn(a)}</option>`];o.forEach(l=>{i.push(`<option value="${qn(l.id)}">${qn(l.title||a)}</option>`)}),r&&!o.some(l=>String(l.id)===r)&&i.push(`<option value="${qn(r)}">${qn(s)}</option>`),n.innerHTML=i.join(""),r?n.value=r:n.value=""}function li(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),s=document.getElementById("edit-res-discount-type"),r=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=r),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=r),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=r),s&&(s.value="percent",s.disabled=!0,s.classList.add("disabled","reservation-input-disabled"),s.title=r);else{if(t){const l=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",l&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("disabled","reservation-input-disabled"),s.title="")}ss("tax");const i=Ye?.updateEditReservationSummary;typeof i=="function"&&i()}function ss(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const r=Ye?.updateEditReservationSummary;typeof r=="function"&&r()};if(Ra){a();return}Ra=!0;const s=()=>{Ra=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(zt)),t.disabled){n.checked=!1,P(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),s();return}t.checked||(t.checked=!0),St("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?St("edit-res-company-share"):n.checked&&(n.checked=!1));s()}async function Cr(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:s,updateEditReservationSummary:r,ensureModal:o}={}){const{customers:i,projects:l}=Be();let d=Sa()?.[e];if(!d){P(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}if(Br(d))try{const Q=await Dr(d.id||d.reservationId||d.reservation_code);Q&&(d=Q)}catch(Q){console.warn("[reservationsEdit] Failed to hydrate reservation packages",Q)}Ye={...Ye,reservation:d,projects:l||[]},t?.(),Zd(l||[],d);const y=d.projectId&&l?.find?.(Q=>String(Q.id)===String(d.projectId))||null,{effectiveConfirmed:b,projectLinked:p}=kn(d,y),f=d.items?d.items.map(Q=>({...Q,equipmentId:Q.equipmentId??Q.equipment_id??Q.id,barcode:be(Q?.barcode)})):[],S=Yd(d,f),k=(Array.isArray(d.paymentHistory)?d.paymentHistory:Array.isArray(d.payment_history)?d.payment_history:[]).map(Q=>ci(Q)).filter(Boolean);wt(e,S,k);const w=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),O=i?.find?.(Q=>String(Q.id)===String(d.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const K=document.getElementById("edit-res-id");K&&(K.value=d.reservationId||d.id);const Y=document.getElementById("edit-res-customer");Y&&(Y.value=O?.customerName||w);const v=typeof a=="function"?a(d.start):{date:"",time:""},N=typeof a=="function"?a(d.end):{date:"",time:""};n?.("edit-res-start",v.date),n?.("edit-res-start-time",v.time),n?.("edit-res-end",N.date),n?.("edit-res-end-time",N.time);const q=(Q,Ae,ue)=>{if(!Q&&ue)return ue;if(!Q)return"";const ke=Ae&&Ae.length?Ae:"00:00";return`${Q}T${ke}`},E=q(v.date,v.time,d.start),J=q(N.date,N.time,d.end);try{window.__EDIT_RESERVATION_RANGE__={start:E||null,end:J||null}}catch{}const B=document.getElementById("edit-res-notes");B&&(B.value=d.notes||"");const Z=document.getElementById("edit-res-discount");if(Z){const Q=p?0:d.discount??0;Z.value=I(Q)}const D=document.getElementById("edit-res-discount-type");D&&(D.value=p?"percent":d.discountType||"percent");const U=d.projectId?!1:!!d.applyTax,L=document.getElementById("edit-res-tax");L&&(L.checked=U);const T=document.getElementById("edit-res-company-share");if(T){const Q=d.companySharePercent??d.company_share_percent??d.companyShare??d.company_share??null,Ae=Q!=null?Number.parseFloat(I(String(Q).replace("%","").trim())):NaN,ue=d.companyShareEnabled??d.company_share_enabled??d.companyShareApplied??d.company_share_applied??null,ke=ue!=null?ue===!0||ue===1||ue==="1"||String(ue).toLowerCase()==="true":Number.isFinite(Ae)&&Ae>0,Me=ke&&Number.isFinite(Ae)&&Ae>0?Ae:zt,Le=U||ke;T.checked=Le,T.dataset.companyShare=String(Me)}Bn(b,{disable:p});const R=document.getElementById("edit-res-close-btn"),V=document.getElementById("edit-res-reopen-btn");R&&(R.disabled=!(b&&!p)||String(d.status||"").toLowerCase()==="completed"),V&&(V.disabled=String(d.status||"").toLowerCase()!=="completed");const F=document.getElementById("edit-res-paid"),j=d.paidStatus??(d.paid===!0||d.paid==="paid"?"paid":"unpaid");F&&(F.value=j,F.dataset&&delete F.dataset.userSelected);const W=document.getElementById("edit-res-payment-progress-type"),oe=document.getElementById("edit-res-payment-progress-value");W?.dataset?.userSelected&&delete W.dataset.userSelected,W&&(W.value="percent"),Xd(oe);const te=document.getElementById("edit-res-cancelled");if(te){const Q=String(d?.status||d?.reservationStatus||"").toLowerCase();te.checked=["cancelled","canceled"].includes(Q),te.checked&&Bn(b,{disable:!0})}let me=Array.isArray(d.crewAssignments)&&d.crewAssignments.length?d.crewAssignments:Array.isArray(d.techniciansDetails)&&d.techniciansDetails.length?d.techniciansDetails:(d.technicians||[]).map(Q=>String(Q));if(!Array.isArray(me)||me.length===0){const Q=Oi(d.id??d.reservationId??d.reservation_code??null);Array.isArray(Q)&&Q.length&&(me=Q)}try{await Ur()}catch(Q){console.warn("[reservationsEdit] positions load failed (non-fatal)",Q)}if(zi(me),s?.(S),typeof window<"u"){const Q=window?.renderEditPaymentHistory;typeof Q=="function"&&Q()}li(),r?.();const ve=document.getElementById("editReservationModal");as=Jd(ve,o),as?.show?.();try{eu?.(Ye)}catch(Q){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",Q)}zd()}async function di({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:s,renderReservations:r,populateEquipmentDescriptionLists:o,handleReservationsMutation:i}={}){if(pn===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const l=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end")?.value?.trim(),y=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",b=document.getElementById("edit-res-notes")?.value||"",p=I(document.getElementById("edit-res-discount")?.value||"0");let f=parseFloat(p)||0,S=document.getElementById("edit-res-discount-type")?.value||"percent";const A=xn(),k=document.getElementById("edit-res-paid"),w=k?.dataset?.userSelected==="true",O=w&&k?.value||"unpaid",K=document.getElementById("edit-res-payment-progress-type"),Y=document.getElementById("edit-res-payment-progress-value"),v=oi(K),N=ii(Y),q=document.getElementById("edit-res-project")?.value||"",J=document.getElementById("edit-res-cancelled")?.checked===!0,B=Hi();B.map(_=>_?.technicianId).filter(Boolean);const Z=document.getElementById("edit-res-company-share"),D=document.getElementById("edit-res-tax");if(!l||!d){P(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const U=typeof e=="function"?e:(_,z)=>`${_}T${z||"00:00"}`,L=U(l,u),T=U(d,y);if(L&&T&&new Date(L)>new Date(T)){P(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const V=Sa()?.[pn];if(!V){P(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(yt)||yt.length===0&&B.length===0){P(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const F=typeof t=="function"?t:()=>!1,j=V.id??V.reservationId;for(const _ of yt){if(_?.type==="package"&&Array.isArray(_.packageItems)){for(const g of _.packageItems){const $=g?.barcode??g?.normalizedBarcode??"";if(!$)continue;const M=qt($);if(M!=="reserved"&&M!=="available"){P(Zt(M));return}}continue}const z=qt(_.barcode);if(z!=="reserved"&&z!=="available"){P(Zt(z));return}}{const _=typeof n=="function"?n:()=>!1;for(const z of yt){if(z?.type!=="package")continue;const g=z.packageId??z.package_id??null,$=z.desc||z.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(g&&_(g,L,T,j)){const M=Array.isArray(z?.packageItems)?z.packageItems.map(se=>be(se?.barcode??se?.normalizedBarcode??"")).filter(Boolean):[];let ee=gn(M,L,T,j);if(!ee.length)try{const se=new URLSearchParams;se.set("type","package"),se.set("id",String(g)),se.set("start",L),se.set("end",T),j!=null&&se.set("ignore",String(j));const ge=await It(`/reservations/availability.php?${se.toString()}`),ie=Array.isArray(ge?.conflicts)?ge.conflicts:[];ee=Array.from(new Set(ie.map(ce=>ce?.reservation_code||(ce?.reservation_id!=null?`#${ce.reservation_id}`:null)).filter(Boolean)))}catch{}const ne=ee.length?` (${ee.join("ØŒ ")})`:"";P(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String($))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ne,"warning",-1);return}if(Array.isArray(z?.packageItems)&&z.packageItems.length){const M=(z.packageItems||[]).map(se=>be(se?.barcode??se?.normalizedBarcode??"")).filter(Boolean),ee=M.length,ne=M.filter(se=>F(se,L,T,j)).length;if(ee>0&&ne>=ee){const se=(z.packageItems||[]).map(ce=>be(ce?.barcode??ce?.normalizedBarcode??"")).filter(Boolean);let ge=gn(se,L,T,j);if(!ge.length)try{const ce=new URLSearchParams;ce.set("type","package"),g!=null&&ce.set("id",String(g)),ce.set("start",L),ce.set("end",T),j!=null&&ce.set("ignore",String(j));const Ge=await It(`/reservations/availability.php?${ce.toString()}`),Ke=Array.isArray(Ge?.conflicts)?Ge.conflicts:[];ge=Array.from(new Set(Ke.map(ft=>ft?.reservation_code||(ft?.reservation_id!=null?`#${ft.reservation_id}`:null)).filter(Boolean)))}catch{}const ie=ge.length?` (${ge.join("ØŒ ")})`:"";P(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String($))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ie,"warning",6e3);return}}}}const W=[];for(const _ of yt){if(_?.type==="package"&&Array.isArray(_.packageItems)){for(const g of _.packageItems){const $=be(g?.barcode??g?.normalizedBarcode??"");if($&&F($,L,T,j)){const M=g?.desc||g?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");W.push({label:I(String(M)),barcode:$})}}continue}const z=be(_.barcode);if(F(z,L,T,j)){const g=_?.desc||_?.name||_?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");W.push({label:I(String(g)),barcode:z})}}if(W.length){const _=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let z=null;try{const $=Array.from(new Set(W.map(ee=>ee.barcode).filter(Boolean))),M=new Map;await Promise.all($.map(async ee=>{const ne=new URLSearchParams;ne.set("type","equipment"),ne.set("id",ee),ne.set("start",L),ne.set("end",T),j!=null&&ne.set("ignore",String(j));const se=await It(`/reservations/availability.php?${ne.toString()}`),ge=Array.isArray(se?.conflicts)?se.conflicts:[],ie=Array.from(new Set(ge.map(ce=>ce?.reservation_code||(ce?.reservation_id!=null?`#${ce.reservation_id}`:null)).filter(Boolean)));M.set(ee,ie)})),z=W.map(({label:ee,barcode:ne})=>{const se=M.get(ne)||[];return se.length?`${ee} (${se.join("ØŒ ")})`:ee}).join("ØŒ ")}catch{}const g=z||W.map($=>$.label).filter(Boolean).map(String).join("ØŒ ");P(`${_}: ${g}`,"warning",6e3);return}const oe=typeof n=="function"?n:()=>!1;for(const _ of yt){if(_?.type!=="package")continue;const z=_.packageId??_.package_id??null;if(z&&oe(z,L,T,j)){const g=_.desc||_.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const $=new URLSearchParams;$.set("type","package"),$.set("id",String(z)),$.set("start",L),$.set("end",T),j!=null&&$.set("ignore",String(j));const M=await It(`/reservations/availability.php?${$.toString()}`),ee=Array.isArray(M?.conflicts)?M.conflicts:[],ne=Array.from(new Set(ee.map(ge=>ge?.reservation_code||(ge?.reservation_id!=null?`#${ge.reservation_id}`:null)).filter(Boolean))),se=ne.length?` (${ne.join("ØŒ ")})`:"";P(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String(g))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+se,"warning",6e3)}catch{P(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String(g))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const te=typeof a=="function"?a:()=>!1,me=[];for(const _ of B){if(!_?.technicianId||!te(_.technicianId,L,T,j))continue;const z=_?.technicianName||_?.positionLabel||String(_.technicianId);let g=[];try{g=Hr(_.technicianId,L,T,j)}catch{}me.push({label:I(String(z)),codes:g})}if(me.length){const _=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),z=me.map(({label:g,codes:$})=>$&&$.length?`${g} (${$.join("ØŒ ")})`:g).join("ØŒ ");P(`${_}: ${z}`,"warning",6e3);return}const ve=Array.isArray(Ye.projects)&&Ye.projects.length?Ye.projects:Be().projects||[],Q=q&&ve.find(_=>String(_.id)===String(q))||null,Ae={...V,projectId:q?String(q):null,confirmed:A},{effectiveConfirmed:ue,projectLinked:ke,projectStatus:Me}=kn(Ae,Q);let Le=!!Z?.checked,Ne=!!D?.checked;if(ke&&(Le&&(Z.checked=!1,Le=!1),Ne=!1),!ke&&Le!==Ne){P(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}Ne&&(St("edit-res-company-share"),Le=!!Z?.checked);let _e=Le?getCompanySharePercent("edit-res-company-share"):null;Le&&(!Number.isFinite(_e)||_e<=0)&&(St("edit-res-company-share"),_e=getCompanySharePercent("edit-res-company-share"));const et=Le&&Ne&&Number.isFinite(_e)&&_e>0,Oe=ke?!1:Ne;ke&&(f=0,S="percent");const Pe=cs(yt,f,S,Oe,B,{start:L,end:T,companySharePercent:et?_e:0});let De=Ta();if(Number.isFinite(N)&&N>0){const _=Pe;let z=null,g=null;v==="amount"?(z=N,_>0&&(g=N/_*100)):(g=N,_>0&&(z=N/100*_));const $=ci({type:v,value:N,amount:z,percentage:g,recordedAt:new Date().toISOString()});$&&(De=[...De,$],Qs(De)),Y&&(Y.value="")}const G=Fn({totalAmount:Pe,history:De}),pe=new Map,H=new Map,ae=new Map,Ie=document.getElementById("editReservationModal")||document,we=_=>{const z=st(_.packageId??_.package_id??_.package_code??_.packageCode??_.barcode??_.id??null);if(z)return z;const g=_.package_code??_.packageCode??_.barcode??null;return g?I(String(g)).trim().toLowerCase():null};Ie.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(_=>{const z=ut(_.value),g=Number.isFinite(z)&&z>=0?tt(z):null;if(g===null)return;const $=_.dataset.packageIndex;if($!==void 0&&$!==""){const ne=Number.parseInt($,10);if(Number.isInteger(ne)&&ne>=0){H.set(ne,g);const se=yt[ne];if(se){const ge=we(se);ge&&ae.set(ge,g)}}}const M=_.dataset.packageIdentity;if(M){const ne=st(M)||I(String(M)).trim().toLowerCase();ne&&ae.set(ne,g)}const ee=_.dataset.groupKey;ee&&pe.set(ee,g)});const $e=yt.map((_,z)=>{let g=H.has(z)?H.get(z):void 0;if(g===void 0){const $=vt(_);$&&(g=pe.get($))}return g===void 0?_:{..._,cost:g,unit_cost:g,rental_cost:g,purchase_price:g,internal_cost:g,equipment_cost:g}}),Fe=Rn({manualStatus:O,paidAmount:G.paidAmount,paidPercent:G.paidPercent,totalAmount:Pe});k&&!w&&(k.value=Fe,k.dataset&&delete k.dataset.userSelected);let C=V.status??"pending";ke?C=Q?.status??Me??C:J?C="cancelled":["completed","cancelled"].includes(String(C).toLowerCase())||(C=A?"confirmed":"pending");const le=(()=>{const _=[];$e.forEach((g,$)=>{if(String(g?.type||"").toLowerCase()!=="package")return;const M=Number.isFinite(Number(g.qty??g.quantity))?Number(g.qty??g.quantity):1,ee=Number.isFinite(Number(g.unit_price??g.price))?Number(g.unit_price??g.price):0;let ne=Number.isFinite(Number(g.unit_cost??g.cost))?Number(g.unit_cost??g.cost):0;const se=vt(g),ge=we(g),ie=(H.has($)?H.get($):void 0)??(ge?ae.get(ge):void 0)??(se!==void 0?pe.get(se):void 0);ie!==void 0&&Number.isFinite(ie)&&(ne=tt(ie));const ce=ie!==void 0?2:Number.isFinite(ne)&&ne>0?1:0;_.push({__dedupeKey:ge??`pkg-${$}`,__priority:ce,package_code:g.package_code??g.packageCode??g.barcode??g.code??null,name:g.name??g.desc??g.package_name??null,quantity:M,unit_price:ee,unit_cost:ne,package_cost:ne,packageCost:ne,cost:ne,items:Array.isArray(g.packageItems)?g.packageItems:[]})});const z=new Map;return _.forEach(g=>{const $=g.__dedupeKey;(!z.has($)||(g.__priority??0)>=(z.get($).__priority??0))&&z.set($,g)}),Array.from(z.values()).map(g=>{const{__dedupeKey:$,__priority:M,...ee}=g;return ee})})(),re=Pr({reservationCode:V.reservationCode??V.reservationId??null,customerId:V.customerId,start:L,end:T,status:C,title:V.title??null,location:V.location??null,notes:b,projectId:q?String(q):null,totalAmount:Pe,discount:f,discountType:S,applyTax:Oe,paidStatus:Fe,confirmed:ue,items:$e.map(_=>({..._,equipmentId:_.equipmentId??_.id})),crewAssignments:B,companySharePercent:et?_e:null,companyShareEnabled:et,paidAmount:G.paidAmount,paidPercentage:G.paidPercent,paymentProgressType:G.paymentProgressType,paymentProgressValue:G.paymentProgressValue,paymentHistory:De,packages:le});try{_r("about to submit",{editingIndex:pn,crewAssignments:B,techniciansPayload:re?.technicians,payload:re});const _=await Ki(V.id||V.reservationId,re);_r("server response",{reservation:_?.id??_?.reservationId??_?.reservation_code,technicians:_?.technicians,crewAssignments:_?.crewAssignments,techniciansDetails:_?.techniciansDetails}),await Nr(),fs(),fn(),nc(),P(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),s?.(),ri(),i?.({type:"updated",reservation:_}),r?.(),o?.(),as?.hide?.()}catch(_){console.error("âŒ [reservationsEdit] Failed to update reservation",_);const z=Tr(_)?_.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");P(z,"error")}}function eu(e={}){Ye={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:s}=Ye,r=document.getElementById("edit-res-discount");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=I(r.value),t?.()}),r.dataset.listenerAttached="true");const o=document.getElementById("edit-res-discount-type");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>t?.()),o.dataset.listenerAttached="true");const i=document.getElementById("edit-res-tax");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ss("tax")}),i.dataset.listenerAttached="true");const l=document.getElementById("edit-res-company-share");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{ss("share")}),l.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",t?.()}),u.dataset.listenerAttached="true");const d=document.getElementById("edit-res-payment-progress-value");d&&!d.dataset.listenerAttached&&(d.addEventListener("input",()=>{d.value=I(d.value)}),d.dataset.listenerAttached="true");const y=["edit-res-start","edit-res-end"],b=["edit-res-start-time","edit-res-end-time"],p=v=>{const N=document.getElementById(v);if(!N||N.dataset.editDateListenerAttached==="true")return;const q=()=>{try{t?.()}catch{}try{const E=typeof Ze=="function"?Ze().items:[];s?.(E)}catch{}};N.addEventListener("input",q),N.addEventListener("change",q),N.dataset.editDateListenerAttached="true"};y.forEach(p),b.forEach(p),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const f=document.getElementById("edit-res-project");f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>{li();const v=Array.isArray(Ye.projects)&&Ye.projects.length?Ye.projects:Be().projects||[],N=f.value&&v.find(Z=>String(Z.id)===String(f.value))||null,E={...Ye?.reservation??{},projectId:f.value||null,confirmed:xn()},{effectiveConfirmed:J,projectLinked:B}=kn(E,N);Bn(J,{disable:B}),t?.()}),f.dataset.listenerAttached="true");const S=document.getElementById("edit-res-confirmed-btn");S&&!S.dataset.listenerAttached&&(S.addEventListener("click",()=>{if(S.disabled)return;const v=!xn();Bn(v);const N=document.getElementById("edit-res-close-btn");N&&(N.disabled=!v),t?.()}),S.dataset.listenerAttached="true");const A=document.getElementById("edit-res-cancelled");A&&!A.dataset.listenerAttached&&(A.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&Bn(xn(),{disable:A.checked});const N=document.getElementById("edit-res-close-btn");N&&(N.disabled=A.checked||!xn()),t?.()}),A.dataset.listenerAttached="true");const k=document.getElementById("save-reservation-changes");k&&!k.dataset.listenerAttached&&(k.addEventListener("click",()=>{di(Ye).catch(v=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",v)})}),k.dataset.listenerAttached="true");const w=document.getElementById("edit-res-close-btn");w&&!w.dataset.listenerAttached&&(w.addEventListener("click",()=>{try{const{index:v}=Ze(),N=document.getElementById("closeReservationModal"),q=document.getElementById("close-reservation-notes"),E=document.getElementById("close-reservation-submit"),J=document.getElementById("edit-res-notes")?.value||"";if(q&&(q.value=J),E&&E.__tmpCloseListener&&(E.removeEventListener("click",E.__tmpCloseListener),E.__tmpCloseListener=null),E){const B=async()=>{const Z=q?.value||"";try{await xr(v,Z,{onAfterChange:Ye?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(N)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(N))?.hide?.()}catch{}}};E.__tmpCloseListener=B,E.addEventListener("click",B,{once:!0})}N&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(N).show()}catch(v){console.warn("[reservationsEdit] failed to open close modal",v)}}),w.dataset.listenerAttached="true");const O=document.getElementById("edit-res-reopen-btn");O&&!O.dataset.listenerAttached&&(O.addEventListener("click",async()=>{try{const{index:v}=Ze();await Lr(v,{onAfterChange:Ye?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{O.disabled=!0}catch{}}catch(v){console.warn("[reservationsEdit] failed to reopen reservation",v)}}),O.dataset.listenerAttached="true");const K=document.getElementById("edit-res-equipment-barcode");if(K&&!K.dataset.listenerAttached){let v=null;const N=()=>{K.value?.trim()&&(clearTimeout(v),v=null,n?.(K))};K.addEventListener("keydown",E=>{E.key==="Enter"&&(E.preventDefault(),N())});const q=()=>{if(clearTimeout(v),!K.value?.trim())return;const{start:E,end:J}=getEditReservationDateRange();!E||!J||(v=setTimeout(()=>{N()},150))};K.addEventListener("input",q),K.addEventListener("change",N),K.dataset.listenerAttached="true"}si?.();const Y=document.getElementById("editReservationModal");Y&&!Y.dataset.cleanupAttached&&(Y.addEventListener("hidden.bs.modal",()=>{ri(),t?.(),s?.([])}),Y.dataset.cleanupAttached="true")}function hu(){return oc().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=Be()||{};Ui(e||[]),ai()})}function Un(e=null){ai(),ui(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function tu(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function rs(){return{populateEquipmentDescriptionLists:Vt,setFlatpickrValue:Od,splitDateTime:Kr,renderEditItems:ct,updateEditReservationSummary:rt,addEquipmentByDescription:Md,addEquipmentToEditingReservation:Rd,addEquipmentToEditingByDescription:va,combineDateTime:Xt,hasEquipmentConflict:Tt,hasTechnicianConflict:zr,renderReservations:ui,handleReservationsMutation:Un,ensureModal:tu}}function ui(e="reservations-list",t=null){kd({containerId:e,filters:t,onShowDetails:pi,onConfirmReservation:fi,onCloseReservation:nu,onReopenReservation:yi})}function pi(e){return Id(e,{getEditContext:rs,onEdit:(t,{reservation:n})=>{hi(t,n)},onDelete:mi})}function mi(e){return $i()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?Bi(e,{onAfterChange:Un}):!1:(xi(),!1)}function fi(e){return Di(e,{onAfterChange:Un})}function yi(e){return Lr(e,{onAfterChange:Un})}let ta=null,na=null;function gi(){const e=document.getElementById("closeReservationModal"),t=document.getElementById("close-reservation-notes"),n=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:t,submit:n,cancel:a}}function nu(e,t=null,n=null){ta=e,na=n??null;const{modal:a,note:s}=gi();s&&(s.value=""),a&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(a).show()}function au(){const{modal:e,note:t,submit:n,cancel:a}=gi();e&&(n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async()=>{const s=t?.value||"";try{await xr(ta,s,{onAfterChange:Un,reservationId:na})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}ta=null,na=null}}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{ta=null,na=null}),a.dataset.listenerAttached="true"))}function hi(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",r)}Cr(e,rs());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",r)}Cr(e,rs());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const r=t.id??t.reservationId;n.set("reservationEditId",String(r));try{localStorage.setItem("pendingReservationEditId",String(r)),localStorage.removeItem("pendingReservationEditIndex")}catch(o){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",o)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",r)}}Li({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(r=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",r)});const a=n.toString(),s=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=s}function bu(){ac({showReservationDetails:pi,deleteReservation:mi,confirmReservation:fi,openReservationEditor:hi,reopenReservation:yi});try{au()}catch{}}export{bu as a,mu as b,gu as c,ui as d,fu as e,ai as f,rs as g,Un as h,yu as i,Se as j,pi as k,hu as l,mi as m,fi as n,hi as o,At as p,Od as q,Wr as r,eu as s,rt as u};
