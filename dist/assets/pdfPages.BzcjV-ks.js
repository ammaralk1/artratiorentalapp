import{t as d,r as z,f as at,c as st,p as it,a as ct,b as $,d as K,e as lt}from"./calculations.37hi9VUg.js";import{e as pt}from"./reports.f-5_iav5.js";import{s as dt,c as mt,d as ut,q as ht}from"./controller.CRiN912Z.js";import{n as Y}from"./auth.D26aJb88.js";import"./reservationsService.BABq2xlS.js";import"./dashboard.Clxl1E8f.js";/* empty css              */import"./dashboardShell.DSlrRq8a.js";import"./customers.9QukT3kn.js";import"./maintenanceService.Brky0jy-.js";const U=96,X=25.4,Q=210,ft=297,I=Math.round(Q/X*U),O=Math.round(ft/X*U),F=U/X,gt=/safari/i,bt=/(iphone|ipad|ipod)/i,yt=/(crios|fxios|edgios|opios)/i;function V(){try{const o=navigator.userAgent||"";return bt.test(o)&&gt.test(o)&&!yt.test(o)}catch{return!1}}function xt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function wt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const r=document.createElement("style");r.textContent=String(ht).trim(),t.appendChild(r);const l=document.createElement("div");l.className="quote-preview-pages",l.setAttribute("data-quote-pages",""),t.appendChild(l);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; table-layout:fixed; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    .rpt-table th, .rpt-table td { vertical-align: middle !important; line-height: 1.6; }
    .rpt-table th > *, .rpt-table td > * { vertical-align: middle !important; }
    /* Use the same robust centering wrapper used by quotes, but right-justify for RTL numbers/text */
    .rpt-table .quote-cell { display:flex; align-items:center; justify-content:flex-end; width:100%; min-height:18px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function Z(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),r=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(r)?Math.max(90,Math.min(100,r))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function B({rightMm:o,topMm:t,scale:r}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((r||1)*1e3)/10))}catch{}}function vt(o){try{const t=Z(),r=document.createElement("div");r.setAttribute("data-rpt-controls",""),Object.assign(r.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const l="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";r.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${l}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${l}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${l}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(r,e);const h=()=>{const y=Number(r.querySelector("[data-rpt-right]").value),m=Number(r.querySelector("[data-rpt-top]").value),w=Number(r.querySelector("[data-rpt-scale]").value),x=Math.max(.9,Math.min(1,w/100));B({rightMm:y,topMm:m,scale:x});const P=y*F,c=m*F;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${P}px, ${c}px) scale(${x})`})};r.querySelector("[data-rpt-apply]").addEventListener("click",h),r.querySelector("[data-rpt-reset]").addEventListener("click",()=>{r.querySelector("[data-rpt-right]").value=0,r.querySelector("[data-rpt-top]").value=0,r.querySelector("[data-rpt-scale]").value=100,B({rightMm:0,topMm:0,scale:1});const y=o.querySelector("[data-quote-pages]");Object.assign(y.style,{transform:"none"})});const i=t.rightMm*F,n=t.topMm*F;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${i}px, ${n}px) scale(${t.scale})`})}catch{}}function G({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function Ct(o){const t=document.createElement("div");t.className="rpt-header";const r=document.createElement("h1");r.textContent=d("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const l=document.createElement("p");l.className="rpt-subtitle",l.textContent=`${lt(new Date)} • ${d("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(r),t.appendChild(l);const e=document.createElement("div");e.className="rpt-kpis";const h=(i,n)=>{const y=document.createElement("div");return y.className="rpt-kpi",y.innerHTML=`<div class="label">${i}</div><div class="value">${n}</div>`,y};return e.appendChild(h(d("reservations.reports.kpi.total.label","الحجوزات","Reservations"),K(o.total||0))),e.appendChild(h(d("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),$(o.revenue||0))),e.appendChild(h(d("reservations.reports.kpi.net.label","صافي الربح","Net profit"),$(o.netProfit||0))),e.appendChild(h(d("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),$(o.companyShareTotal||0))),e.appendChild(h(d("reservations.reports.kpi.tax.label","الضريبة","Tax"),$(o.taxTotal||0))),e.appendChild(h(d("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),$(o.maintenanceExpense||0))),t.appendChild(e),t}function Pt(){try{const o=z?.data||{},t=z?.lastSnapshot?.filtered||o.reservations||[],r=new Map((o.customers||[]).map(n=>[String(n.id),n])),l=[...t].sort((n,y)=>new Date(y?.start||0)-new Date(n?.start||0)),e={code:d("reservations.reports.results.headers.id","الحجز","Reservation"),customer:d("reservations.reports.results.headers.customer","العميل","Customer"),date:d("reservations.reports.results.headers.date","التاريخ","Date"),status:d("reservations.reports.results.headers.status","الحالة","Status"),payment:d("reservations.reports.results.headers.payment","الدفع","Payment"),total:d("reservations.reports.results.headers.total","الإجمالي","Total"),share:d("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:d("reservations.reports.results.headers.net","صافي الربح","Net profit")},h=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],i=l.map(n=>{const y=n?.reservationId||n?.id||"—",m=Y(String(y)),x=r.get(String(n?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),P=at(n?.start),c=st(n),f=(()=>{switch(c.statusValue){case"completed":return String(d("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(d("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(d("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return Y(String(c.statusValue||"—"))}})(),k=it(c.paidStatus),v=ct(n),q=$(v.finalTotal),W=v.companySharePercent>0?`${K(v.companySharePercent)}% (${$(v.companyShareAmount)})`:d("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),s=$(v.netProfit);return{[e.code]:m,[e.customer]:x,[e.date]:P,[e.status]:f,[e.payment]:k,[e.total]:q,[e.share]:W,[e.net]:s}});return{headers:h,rows:i}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function J(o){const t=document.createElement("table");t.className="rpt-table";const r=document.createElement("thead"),l=document.createElement("tr");o.forEach(h=>{const i=document.createElement("th");i.textContent=h,l.appendChild(i)}),r.appendChild(l);const e=document.createElement("tbody");return t.appendChild(r),t.appendChild(e),{table:t,tbody:e}}function Mt(o,t,r,l){const e=o.querySelector("[data-quote-pages]"),h=G({primary:!0});e.appendChild(h);const i=Ct(l);h.appendChild(i);let{table:n,tbody:y}=J(r);h.appendChild(n);const m=18,w=28,x=[];for(let f=0;f<t.length;f+=w)x.push(t.slice(f,f+w));if(x.length){const f=x[0];if(f.length>m){const k=f.splice(m);x.length>1?x[1]=k.concat(x[1]):x.push(k)}}const P=(f,k)=>{const v=document.createElement("tr");r.forEach(q=>{const W=document.createElement("td"),s=document.createElement("div");s.className="quote-cell",s.textContent=k[q]!=null?String(k[q]):"",W.appendChild(s),v.appendChild(W)}),f.appendChild(v)};(x.shift()||t).forEach(f=>P(y,f)),x.forEach(f=>{const k=G({primary:!1});e.appendChild(k);const v=J(r);k.appendChild(v.table),f.forEach(q=>P(v.tbody,q))})}function Et(o=[],{context:t="preview"}={}){const l=(z.lastSnapshot||{}).metrics||{};let e,h=o&&o.length?o:null;if(h)e=Object.keys(h[0]||{});else{const y=Pt();e=y.headers,h=y.rows}const i=wt(t),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${I}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(i);try{dt(i),mt(i),ut(i)}catch{}return Mt(i,h||[],e,l),i.parentElement?.removeChild(i),n.parentElement?.removeChild(n),t==="preview"&&vt(i),i}async function Wt(o=[],{action:t="save"}={}){const r=Et(o,{context:"export"}),l=document.createElement("div");Object.assign(l.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),l.appendChild(r),document.body.appendChild(l);try{if(t==="print"){if(V()){const c=window.open("","_blank");if(!c)throw new Error("Popup blocked");const f=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${d("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{c.document.open(),c.document.write(f),c.document.close()}catch{}const k=r.cloneNode(!0);try{c.document.body.appendChild(k)}catch{}try{c.document?.fonts?.ready&&await c.document.fonts.ready}catch{}await new Promise(v=>setTimeout(v,60));try{c.focus(),c.print()}catch{}return}const m=document.createElement("iframe");Object.assign(m.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0",opacity:"0",pointerEvents:"none"}),document.body.appendChild(m);const w=m.contentWindow?.document,x=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${d("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{w.open(),w.write(x),w.close()}catch{}const P=r.cloneNode(!0);try{w.body.appendChild(P)}catch{}try{w.fonts?.ready&&await w.fonts.ready}catch{}await new Promise(c=>setTimeout(c,60));try{m.contentWindow?.focus(),m.contentWindow?.print()}catch{}setTimeout(()=>{try{m.remove()}catch{}},1500);return}const i=V()&&!xt()?window.open("","_blank"):null;if(i)try{i.document.open(),i.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${d("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${d("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${d("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),i.document.close()}catch{}await pt();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const n=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,y=window.html2canvas;if(typeof n=="function"&&typeof y=="function"){const m=Z(),w=new n({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),P={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},c=Array.from(r.querySelectorAll(".quote-page"));let f=0;const k=(s,p=250)=>{try{const a=s.getContext("2d"),{width:g,height:C}=s,u=new Uint8ClampedArray(g*4),M=b=>{const R=a.getImageData(0,b,g,1).data||u;let _=0;for(let S=0;S<g;S+=1){const T=S*4,N=R[T],D=R[T+1],j=R[T+2];if((N<p||D<p||j<p)&&(_+=1,_>Math.max(2,Math.ceil(g*.003))))return!1}return!0};let E=0;for(let b=0;b<C;b+=2)if(!M(b)){E=b;break}return E}catch{return 0}},v=(s,p=245)=>{try{const a=s.getContext("2d"),{width:g,height:C}=s,u=Math.floor(g*.55),M=Math.max(10,g-u),E=Math.max(3,Math.ceil(M*.015));for(let b=0;b<C;b+=2){const R=a.getImageData(u,b,M,1).data;let _=0;for(let S=0;S<M;S+=1){const T=S*4,N=R[T],D=R[T+1],j=R[T+2];if((N<p||D<p||j<p)&&(_+=1,_>=E))return b}}return 0}catch{return 0}},q=(s,p=250)=>{try{const a=s.getContext("2d"),{width:g,height:C}=s,u=E=>{const b=a.getImageData(0,E,g,1).data;let R=0;for(let _=0;_<g;_+=1){const S=_*4,T=b[S],N=b[S+1],D=b[S+2];if((T<p||N<p||D<p)&&(R+=1,R>Math.max(2,Math.ceil(g*.003))))return!1}return!0};let M=0;for(let E=C-1;E>=0;E-=2)if(!u(E)){M=C-1-E;break}return M}catch{return 0}},W=(s,p,a)=>{try{const{width:g,height:C}=s,u=Math.max(0,Math.min(C-1,Math.round(p))),M=Math.max(0,Math.min(C-u,Math.round(a))),E=Math.max(1,C-u-M);if(u===0&&M===0)return s;const b=document.createElement("canvas");return b.width=g,b.height=E,b.getContext("2d").drawImage(s,0,-u),b}catch{return s}};for(let s=0;s<c.length;s+=1){const p=c[s],a=p.ownerDocument||document,g=a.createElement("div");Object.assign(g.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const C=a.createElement("div");C.id="quotation-pdf-root",C.setAttribute("data-quote-render-context","export"),C.style.width=`${I}px`,C.style.maxWidth=`${I}px`,C.style.minWidth=`${I}px`,C.style.background="#ffffff";const u=p.cloneNode(!0);u.style.width=`${I}px`,u.style.maxWidth=`${I}px`,u.style.minWidth=`${I}px`,u.style.height=`${O}px`,u.style.maxHeight=`${O}px`,u.style.minHeight=`${O}px`,u.style.position="relative",u.style.background="#ffffff",u.style.overflow="hidden",C.appendChild(u),g.appendChild(C),a.body.appendChild(g);let M;try{M=await y(u,{...P,scrollX:0,scrollY:0,windowWidth:I,windowHeight:O})}finally{g.parentNode?.removeChild(g)}if(!M)continue;const E=k(M,246),b=v(M,244),R=Math.max(E,b),_=q(M,246),S=W(M,R,_),T=Math.max(.9,Math.min(1,m.scale||1)),N=Q*T,D=S.height/S.width*N;let j=Number(m.rightMm)||0;const tt=p.classList.contains("quote-page--primary")?6:12;let L=0;try{const A=p.querySelector(".rpt-header")||p.firstElementChild;if(A){const rt=A.getBoundingClientRect(),nt=p.getBoundingClientRect();L=Math.max(0,rt.top-nt.top)}}catch{L=0}const et=L/F;let H=(Number(m.topMm)||0)+tt-et;H<-80&&(H=-80);const ot=S.toDataURL("image/jpeg",.95);f>0&&w.addPage(),w.addImage(ot,"JPEG",j,H,N,D,`page-${f+1}`,"FAST"),f+=1,await new Promise(A=>requestAnimationFrame(A))}if(f===0)throw new Error("PDF generation produced no pages");if(t==="print"){const s=w.output("bloburl");if(i)try{i.location.href=s}catch{}else await new Promise(p=>{const a=document.createElement("iframe");Object.assign(a.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),a.onload=()=>{try{a.contentWindow?.focus(),a.contentWindow?.print()}catch{}setTimeout(()=>{a.remove(),p()},700)},a.src=s,document.body.appendChild(a)})}else try{const s=w.output("blob"),p=URL.createObjectURL(s),a=document.createElement("a");a.href=p,a.download="reservations-report.pdf",a.rel="noopener",a.style.display="none",document.body.appendChild(a),a.click(),setTimeout(()=>{try{URL.revokeObjectURL(p),a.remove()}catch{}},1500)}catch{w.save("reservations-report.pdf")}}else{const m=window.html2pdf().set({margin:0,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(r).toPdf();if(t==="print"){const w=await m.get("pdf").then(x=>x.output("bloburl"));await new Promise(x=>{const P=document.createElement("iframe");Object.assign(P.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),P.onload=()=>{try{P.contentWindow?.focus(),P.contentWindow?.print()}catch{}setTimeout(()=>{P.remove(),x()},700)},P.src=w,document.body.appendChild(P)})}else await m.save("reservations-report.pdf")}}finally{l.remove()}}export{Et as buildReportsPdfPages,Wt as exportReportsPdf};
