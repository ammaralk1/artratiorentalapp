import{n as H,r as K,i as O,p as U,l as W,m as E}from"./reservationsService.C3U8WkU3.js";import{t as G,n as A,g as k}from"./auth.BPBw1s1U.js";const g={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function st(t){g.callbacks.onRender=typeof t=="function"?t:null}function ct(t){g.callbacks.onBeforeRender=typeof t=="function"?t:null}function lt(t){g.callbacks.onAfterRender=typeof t=="function"?t:null}function ut(t){g.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function it(t){g.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function mt(t){g.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function b(t,e,s=e){const r=k()==="en"?s??e:e;return G(t,r)}function dt(){g.formatters.cachedLocale=null,g.formatters.numberFormatter=null}function L(){return(k()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function $(){const t=k();if(t!==g.formatters.cachedLocale||!g.formatters.numberFormatter||!g.formatters.currencyFormatter){g.formatters.cachedLocale=t;const e=L();g.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),g.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:g.formatters.numberFormatter,currencyFormatter:g.formatters.currencyFormatter}}function pt(t){const{numberFormatter:e}=$(),s=e.format(Math.round(t||0));return A(s)}function ft(t){const{currencyFormatter:e}=$(),s=Number.isFinite(Number(t))?Number(t):0,n=e.format(s);return`${A(n)} SR`}function I(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${r}`}function ht(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const s=new Intl.DateTimeFormat(L(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return A(s.format(e))}function Q(t){return new Intl.DateTimeFormat(L(),{month:"short"}).format(t)}const J=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),Y=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),X=1440*60*1e3,D={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function C(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const s=t[0]||{},n=t[e-1]||{},r=`${s.id??s.reservationId??""}-${s.start??""}`,a=`${n.id??n.reservationId??""}-${n.start??""}`,o=g.formatters?.cachedLocale||"ar";return`${e}|${r}|${a}|${o}`}function F(t,e){return t.get(e)}function P(t,e,s){if(t.set(e,s),t.size>64){const n=t.keys().next().value;t.delete(n)}return s}function B(t){return A(String(t||"")).toLowerCase().trim()}function x(t){return(t||"").toString().trim()}function Z(t,e){if(!t||!e)return 1;const s=new Date(t),n=new Date(e);if(Number.isNaN(s.getTime())||Number.isNaN(n.getTime()))return 1;const r=n.getTime()-s.getTime();return r<=0?1:Math.max(1,Math.ceil(r/X))}function R(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;Z(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,s=t.discountType||t.discount_type||"percent",n=String(s).toLowerCase()==="amount"?"amount":"percent",r=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",a=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,o=a!=null?U(a):Number.NaN,c=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(o)&&o>0?o:null,l=Array.isArray(t.crewAssignments)?t.crewAssignments:[],f=l.length?l.map(y=>y?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],m=W({items:Array.isArray(t.items)?t.items:[],technicianIds:f,crewAssignments:l,discount:e,discountType:n,applyTax:r,start:t.start,end:t.end,companySharePercent:c}),i=Number(t.cost);let p=m.finalTotal,d=m.taxAmount;if(Number.isFinite(i)&&i>0&&(p=E(i),r)){const y=p-m.taxableAmount;Number.isFinite(y)&&y>=0&&(d=E(y))}const h={rentalDays:m.rentalDays,equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal,crewCostTotal:m.crewCostTotal,discountAmount:m.discountAmount,subtotalAfterDiscount:m.subtotalAfterDiscount,taxableAmount:m.taxableAmount,taxAmount:d,finalTotal:p,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,netProfit:m.netProfit,companyShareEnabled:m.companySharePercent>0};return t.__financials=h,h}function z(t){return t?.projectId&&g.data.projectsMap.get(String(t.projectId))||null}function j(t=""){const e=String(t).toLowerCase().trim();return e?J.get(e)||e:""}function v(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const s of e){const n=String(s||"").toLowerCase().trim();if(n&&Y.has(n))return Y.get(n)}return t?.paid===!0||t?.paid==="true"}function T(t){const e=z(t),s=K(t,e),n=j(s.projectStatus);let r=j(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");s.projectLinked&&n&&r!=="cancelled"&&(r=n),r||(r=s.effectiveConfirmed?"confirmed":"pending"),r!=="cancelled"&&(O(t)||n==="completed")&&(r="completed");let a=s.effectiveConfirmed||r==="confirmed"||r==="completed";r==="cancelled"&&(a=!1),a&&r!=="completed"&&r!=="cancelled"&&(r="confirmed");const o=v(t),u=t?.paidStatus??t?.paid_status??(o?"paid":"unpaid");return{statusValue:r,confirmed:a,paid:o,paidStatus:u}}function gt(t){const e=t.length;let s=0,n=0,r=0,a=0,o=0,u=0,c=0,l=0,f=0,m=0;t.forEach(p=>{const{statusValue:d,confirmed:h,paid:y}=T(p);if(d==="completed"&&(n+=1),d==="cancelled"&&(r+=1),h&&(s+=1),y&&d!=="cancelled"&&(a+=1),d!=="cancelled"){const w=R(p);o+=w.finalTotal,u+=w.companyShareAmount,c+=w.taxAmount,l+=w.crewTotal,f+=w.crewCostTotal??0,m+=w.netProfit}});const i=e?o/e:0;return{total:e,confirmed:s,completed:n,cancelled:r,activeTotal:Math.max(0,e-r),paidCount:a,revenue:o,average:i,companyShareTotal:u,taxTotal:c,crewTotal:l,crewCostTotal:f,netProfit:m}}function V({range:t,start:e,end:s}){const n=new Date;if(n.setHours(23,59,59,999),t==="custom"){const o=e?new Date(`${e}T00:00:00`):null,u=s?new Date(`${s}T23:59:59`):null;return{startDate:q(o)?o:null,endDate:q(u)?u:null}}let r=new Date(n),a=null;switch(t){case"last30":{a=new Date(n),a.setDate(a.getDate()-29);break}case"thisWeek":{const o=new Date(n),c=(o.getDay()-6+7)%7;o.setDate(o.getDate()-c),o.setHours(0,0,0,0);const l=new Date(o);l.setDate(o.getDate()+6),l.setHours(23,59,59,999),a=o,r=l;break}case"thisMonth":{a=new Date(n.getFullYear(),n.getMonth(),1),r=new Date(n.getFullYear(),n.getMonth()+1,0),r.setHours(23,59,59,999);break}case"thisQuarter":{const o=Math.floor(n.getMonth()/3);a=new Date(n.getFullYear(),o*3,1),r=new Date(n.getFullYear(),(o+1)*3,0),r.setHours(23,59,59,999);break}case"thisYear":{a=new Date(n.getFullYear(),0,1),r=new Date(n.getFullYear(),12,0),r.setHours(23,59,59,999);break}case"all":default:a=null,r=null;break}return a&&a.setHours(0,0,0,0),{startDate:a,endDate:r}}function q(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function yt(t,e){const{startDate:s,endDate:n}=V(e);let r=0;const a=[];return(t||[]).forEach(o=>{if(!o)return;const u=typeof o.repairCost=="number"?o.repairCost:Number.parseFloat(A(String(o.repairCost??"")));if(!Number.isFinite(u)||u<=0)return;const c=String(o.statusRaw??o.status??"").toLowerCase();if(!(c==="closed"||c==="completed"||c==="cancelled"))return;const f=o.resolvedAt??o.resolved_at??null,m=o.reportedAt??o.reported_at??null,i=o.createdAt??o.created_at??null,p=f?new Date(f):null,d=m?new Date(m):i?new Date(i):null,h=p&&!Number.isNaN(p.getTime())?p:d&&!Number.isNaN(d.getTime())?d:null;if(h&&(s&&h<s||n&&h>n))return;const y=Math.round(u*100)/100;r+=y,a.push({id:o.id,cost:y,date:h})}),{total:r,items:a}}function wt(t,e){const s=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:s,netProfit:(t.netProfit||0)-s}}function bt(t){const e=`trend:${C(t)}`,s=F(D.trend,e);if(s)return s;const n=new Date,r=[],a=(t||[]).map(c=>c?.start?new Date(c.start):null).filter(c=>c&&!Number.isNaN(c.getTime()));let o=6,u=new Date(n.getFullYear(),n.getMonth(),1);if(a.length){const c=new Date(Math.min(...a.map(d=>d.getTime()))),l=new Date(Math.max(...a.map(d=>d.getTime()))),f=new Date(c.getFullYear(),c.getMonth(),1);u=new Date(l.getFullYear(),l.getMonth(),1);const m=u.getFullYear()-f.getFullYear(),i=u.getMonth()-f.getMonth(),p=m*12+i;o=Math.min(12,Math.max(6,p+1))}for(let c=o-1;c>=0;c-=1){const l=new Date(u.getFullYear(),u.getMonth()-c,1),f=l.getFullYear(),m=l.getMonth(),i=t.filter(N=>{const M=N?.start?new Date(N.start):null;return M&&M.getFullYear()===f&&M.getMonth()===m}),p=i.length;let d=0,h=0,y=0;i.forEach(N=>{const M=R(N);d+=M.finalTotal,h+=M.netProfit,y+=M.companyShareAmount});const w=Q(l),S=new Date(l.getFullYear(),l.getMonth(),1),_=new Date(l.getFullYear(),l.getMonth()+1,0);r.push({label:w,count:p,revenue:d,netProfit:h,companyShare:y,periodStart:S,periodEnd:_,startInput:I(S),endInput:I(_)})}return P(D.trend,e,r)}function Dt(t){const e=`status:${C(t)}`,s=F(D.status,e);if(s)return s;const n={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(f=>{const{statusValue:m,confirmed:i}=T(f);m==="completed"?n.completed+=1:m==="cancelled"?n.cancelled+=1:m==="confirmed"||i?n.confirmed+=1:n.pending+=1});const r=Math.max(1,(t||[]).length),a=n.confirmed,o=n.pending,u=n.completed,c=n.cancelled,l=[{label:b("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/r*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:b("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:o,percent:Math.round(o/r*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:b("reservations.reports.status.completedLabel","منتهية","Completed"),value:u,percent:Math.round(u/r*100)||0,rawCount:u,className:"status-completed",filterKey:"completed"},{label:b("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:c,percent:Math.round(c/r*100)||0,rawCount:c,className:"status-cancelled",filterKey:"cancelled"}];return P(D.status,e,l)}function St(t){const e=`payment:${C(t)}`,s=F(D.payment,e);if(s)return s;const n=t.length||1;let r=0,a=0,o=0;(t||[]).forEach(c=>{const{paidStatus:l}=T(c);l==="paid"?r+=1:l==="partial"?a+=1:o+=1});const u=[{label:b("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-paid",filterKey:"paid"},{label:b("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-partial",filterKey:"partial"},{label:b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-unpaid",filterKey:"unpaid"}];return P(D.payment,e,u)}function Nt(t,e){const s=`topCustomers:${C(t)}`,n=F(D.topCustomers,s);if(n)return n;const r=new Map,a=new Map((e||[]).map(u=>[String(u.id),u]));t.forEach(u=>{const c=String(u?.customerId??"unknown"),l=r.get(c)||{count:0,revenue:0},f=R(u);l.count+=1,l.revenue+=f.finalTotal,r.set(c,l)});const o=Array.from(r.entries()).map(([u,c])=>({name:a.get(u)?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:c.count,revenue:c.revenue})).sort((u,c)=>c.revenue-u.revenue).slice(0,5);return P(D.topCustomers,s,o)}function Mt(t,e){const s=`topEquipment:${C(t)}`,n=F(D.topEquipment,s);if(n)return n;const r=new Map,a=new Map((e||[]).map(c=>[x(c?.barcode),c])),o=b("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(c=>{(c?.items||[]).forEach(l=>{const f=x(l?.barcode),m=f?a.get(f):null,i=l?.desc||l?.description||l?.name||m?.desc||m?.description||m?.name||"",p=i&&i.trim()?i:o,d=H(p)||"unknown",h=Number(l?.qty)||1,y=Number(l?.price)||0,w=h*y,S=r.get(d)||{name:p,count:0,revenue:0};S.name=p,S.count+=h,S.revenue+=w,r.set(d,S)})});const u=Array.from(r.values()).sort((c,l)=>l.count!==c.count?l.count-c.count:l.revenue-c.revenue).slice(0,5);return P(D.topEquipment,s,u)}function Tt(){Object.values(D).forEach(t=>t.clear())}function tt(t,e,s,n,r){const a=[],o=t?.reservationId||t?.id;o&&a.push(o),t?.notes&&a.push(t.notes);const{statusValue:u,paidStatus:c}=T(t);u&&a.push(u);const l=t?.paymentStatus||t?.payment_status;l&&a.push(l),t?.paid!=null&&a.push(t.paid?"paid":"unpaid"),c&&a.push(c);const f=s.get(String(t?.customerId));f&&a.push(f.customerName,f.company_name||f.companyName,f.contact_person||"");const m=z(t);return m&&a.push(m.title,m.code,m.status),a.push(et(c)),(t?.items||[]).forEach(p=>{p?.desc&&a.push(p.desc),p?.barcode&&a.push(p.barcode);const d=n.get(x(p?.barcode));d&&a.push(d.desc,d.description,d.name)}),(t?.technicians||[]).forEach(p=>{const d=r.get(String(p));d&&a.push(d.name,d.role,d.department)}),B(a.filter(Boolean).join(" ")).includes(e)}function At(t,e,s,n,r){const{startDate:a,endDate:o}=V(e),u=B(e.search),c=!!u,l=new Map((s||[]).map(i=>[String(i.id),i])),f=new Map((n||[]).map(i=>[x(i?.barcode),i])),m=new Map((r||[]).map(i=>[String(i.id),i]));return(t||[]).filter(i=>{if(i&&i.projectId!=null&&String(i.projectId).trim()!=="")return!1;const p=i?.start?new Date(i.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let d=i?.end?new Date(i.end):p;if(Number.isNaN(d.getTime())&&(d=p),a&&d<a||o&&p>o)return!1;const{statusValue:h,confirmed:y,paid:w,paidStatus:S}=T(i);if(e.status==="confirmed"&&!(h==="confirmed"||h==="completed"||y)||e.status==="pending"&&h!=="pending"||e.status==="completed"&&h!=="completed"||e.status==="cancelled"&&h!=="cancelled"||e.payment==="paid"&&!w||e.payment==="unpaid"&&w||e.payment==="partial"&&S!=="partial")return!1;if(e.share&&e.share!=="all"){const N=R(i).companySharePercent>0;if(e.share==="with"&&!N||e.share==="without"&&N)return!1}return!(c&&!tt(i,u,l,f,m))})}function et(t){const e=String(t??"").toLowerCase();return e==="paid"?b("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?b("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function nt(t=[]){if(!Array.isArray(t)||!t.length)return 0;let e=0;return t.forEach(s=>{const n=Number(s?.amount);Number.isFinite(n)&&n>0&&(e+=n)}),e}function at(t){const e=R(t),s=Number(e.finalTotal||0);let n=Number(t?.paidAmount);if(!Number.isFinite(n)||n<=0){const a=nt(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(a)&&a>0&&(n=a)}if((!Number.isFinite(n)||n<=0)&&Number.isFinite(Number(t?.paidPercent))){const a=Number(t.paidPercent);a>0&&a<=100&&(n=a/100*s)}return Number.isFinite(n)||(n=0),Math.max(0,Math.round((s-n)*100)/100)}function Ct(t,e,s=5){const n=new Map((e||[]).map(a=>[String(a.id),a])),r=[];return(t||[]).forEach(a=>{const{paidStatus:o,statusValue:u}=T(a);if(u==="cancelled"||o!=="unpaid"&&o!=="partial")return;const c=at(a);if(!Number.isFinite(c)||c<=0)return;const l=n.get(String(a.customerId));r.push({id:a.id||a.reservationId||"",code:a.reservationCode||a.reservationId||a.id||"",customer:l?.customerName||a.customerName||"",outstanding:c,paidStatus:o})}),r.sort((a,o)=>o.outstanding-a.outstanding).slice(0,s)}export{mt as A,dt as B,R as a,ft as b,T as c,pt as d,I as e,ht as f,Tt as g,V as h,At as i,gt as j,yt as k,wt as l,bt as m,Dt as n,St as o,et as p,Nt as q,g as r,Mt as s,b as t,Ct as u,st as v,ct as w,lt as x,ut as y,it as z};
