import{h as ye,g as ee,s as te,j as we,r as ve}from"./reservationsService.BABq2xlS.js";import{t as i,g as H,l as K}from"./auth.D26aJb88.js";import{e as Ce,b as ne}from"./controller.CR8SjxvR.js";const Ee={limit:200};let u=null,ae=!1,re=!1,se=!1,oe=null,z=null,ie=!1,G=null,O=null,P=!1,S="",$=null;const U=new Map;function L(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Z(){const e=document.getElementById("calendar"),n=document.getElementById("calendar-panel")||e?.parentElement||null,r=document.getElementById("calendar-status");return{calendarEl:e,panelEl:n,statusEl:r}}function le(){try{if(typeof FullCalendar<"u")return FullCalendar}catch{}return typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof global<"u"&&global.FullCalendar?global.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}async function Se(){const e=le();return e||$||($=new Promise(n=>{try{const r="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js",a=document.createElement("script");a.src=r,a.async=!0,a.onload=()=>n(le()),a.onerror=()=>n(null),document.head.appendChild(a)}catch{n(null)}}),$)}function Le(){if(typeof window>"u")return null;const e=window.tui?.Calendar||window.toastui?.Calendar||window.Calendar;return typeof e=="function"?e:null}function xe(e){return U.has(e)||U.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),U.get(e)}function J(e,n,r=!1){if(r){const f=(H?.()==="en"?"en":"ar")==="en"?"All day":"طوال اليوم";return i("calendar.labels.allDay",f)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const s=H?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",l=xe(s),t=l.format(a);if(!n)return t;const d=new Date(n);if(Number.isNaN(d.getTime()))return t;const g=l.format(d);return t===g?t:`${t} – ${g}`}function _e({paid:e,confirmed:n,completed:r,cancelled:a}){const s=["calendar-event"];return(r===!0||r==="true")&&s.push("calendar-event--completed"),(a===!0||a==="true")&&s.push("calendar-event--cancelled"),n===!0||n==="true"?s.push("calendar-event--confirmed"):s.push("calendar-event--pending"),e===!0||e==="paid"?s.push("calendar-event--paid"):s.push("calendar-event--unpaid"),s}function ke(e){try{const{event:n}=e||{},r=n?.extendedProps||{},a=J(n?.startStr,n?.endStr,n?.allDay),s=r?.reservationId?String(r.reservationId):n?.id!=null?String(n.id):"—",l=r?.customerName||i("calendar.labels.unknownCustomer","غير معروف"),t=r?.confirmed===!0||r?.confirmed==="true",d=r?.paid===!0||r?.paid==="paid",g=r?.completed===!0||r?.completed==="true",m=(T,A)=>`<span class="calendar-chip ${T}">${L(A)}</span>`,f=t?i("calendar.badges.confirmed","مؤكد"):i("calendar.badges.pending","غير مؤكد"),c=d?i("calendar.badges.paid","مدفوع"):i("calendar.badges.unpaid","غير مدفوع"),k=r?.cancelled===!0||r?.cancelled==="true";let w=[];return k?w=[m("status-cancelled",i("calendar.badges.cancelled","ملغي"))]:(w=[m(t?"status-confirmed":"status-pending",f),m(d?"status-paid":"status-unpaid",c)],g&&w.push(m("status-completed",i("calendar.badges.completed","منتهي")))),{html:`
      <div class="calendar-event-wrapper">
        <div class="calendar-event-card">
          <div class="calendar-event-card__head">
            <span class="calendar-event-card__time">${L(a||"")}</span>
            <span class="calendar-event-card__id">${L(s)}</span>
          </div>
          <div class="calendar-event-card__customer">${L(l)}</div>
          <div class="calendar-event-card__chips">${w.join("")}</div>
        </div>
      </div>`}}catch{return{html:""}}}function Me(){const{calendarEl:e}=Z();if(!e)return;const n=e.querySelector(".fc-header-toolbar");if(!n)return;n.classList.add("calendar-toolbar"),n.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const r=n.querySelector(".fc-toolbar-title");r&&r.classList.add("calendar-toolbar__title"),n.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function x({loading:e=!1,error:n="",empty:r=!1}={}){const{panelEl:a,statusEl:s}=Z();if(!a||!s)return;const l=typeof n=="string"?n.trim().length>0:!!n,t=!e&&!l&&!!r,d=e||l||t;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",l),a.classList.toggle("is-empty",t),s.dataset.initialized||(s.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),s.dataset.initialized="true"),s.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),s.classList.toggle("hidden",!d),!d){s.innerHTML="",s.removeAttribute("data-status");return}let g="";e?g=i("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):l?g=typeof n=="string"&&n.trim().length>0?n:i("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):t&&(g=i("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const m=e?"loading":l?"error":"empty";if(s.setAttribute("data-status",m),s.classList.add(`calendar-status-card--${m}`),s.innerHTML="",e){const c=document.createElement("span");c.className="loading loading-spinner loading-md text-primary",c.setAttribute("aria-hidden","true"),s.appendChild(c)}else{const c=document.createElement("span");c.className="calendar-status-card__icon",c.setAttribute("aria-hidden","true"),c.textContent=l?"⚠️":"🗓️",s.appendChild(c)}const f=document.createElement("span");f.className="calendar-status-card__message text-center text-sm font-semibold",f.textContent=g,s.appendChild(f)}function fe(e,n=null){if(!e||typeof e!="object")return null;const r=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??r;if(!r)return null;const s=String(e.status??e.reservationStatus??"").toLowerCase(),l=e.paidStatus??e.paid_status??null,t=e.paid!=null?e.paid:l==="paid",{effectiveConfirmed:d}=ve(e,n),g=e.reservationId??e.reservationCode??e.reservation_code??e.id??r,m=e.customerName??e.customer_name??"";let f=!!e.completed;if(!f&&a){const c=new Date(a);Number.isNaN(c.getTime())||(f=c<new Date)}return{id:e.id??g??r,start:r,end:a||r,paid:t,confirmed:d,completed:f,cancelled:s==="cancelled"||s==="canceled",reservationId:g??"",customerName:m,raw:e}}function Te(e=[]){const{projects:n=[]}=K(),r=new Map(n.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,l=s!=null&&s!==""&&r.get(String(s))||null,t=fe(a,l);if(!t)return null;const d=_e({paid:t.paid,confirmed:t.confirmed,completed:t.completed,cancelled:t.cancelled});return{id:t.id,title:"",start:t.start,end:t.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:d,extendedProps:{...a,raw:a,paid:t.paid,confirmed:t.confirmed,completed:t.completed,cancelled:t.cancelled,reservationId:t.reservationId,customerName:t.customerName}}}).filter(Boolean)}async function de(){if(P)return ee();P=!0,S="";try{await Ce({suppressError:!1,params:Ee})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),S=ye(e)?e.message:e instanceof Error&&e.message||""}finally{P=!1}return ee()}function N(){if(u){try{typeof u.destroy=="function"&&u.destroy()}catch{}u=null}}function ce(e){const n={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:n})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:n}))}function me(){ge()}function Ae(){ae||(document.addEventListener("language:changed",()=>{u&&u.setOption("locale",H()),ge()}),ae=!0),re||(document.addEventListener("reservations:changed",()=>{me()}),re=!0)}function Q(e){return e<=480?"xs":e<=768?"sm":"lg"}function pe(){if(typeof window>"u")return"month";const e=window.innerWidth||1024,n=Q(e);return n==="xs"?"day":n==="sm"?"week":"month"}function D(){if(!u)return;const e=typeof window<"u"&&window.innerWidth||1024,n=Q(e),r=u.__isFullCalendar?he():pe();oe!==n&&typeof u.changeView=="function"&&(oe=n,u.changeView(r,!0))}function Ie(){se||typeof window>"u"||(window.addEventListener("resize",()=>{z&&clearTimeout(z),z=setTimeout(()=>{D()},160)},{passive:!0}),se=!0)}function je(){if(ie||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{O&&clearTimeout(O),O=setTimeout(()=>{me()},80)};G=new MutationObserver(e),G.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&G.observe(document.body,{attributes:!0,attributeFilter:["class"]}),ie=!0}function ue(e){const n=document.getElementById("calendar-reservation-details");if(!n){alert(i("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const r=K()||{},{reservations:a=[],customers:s=[],projects:l=[],technicians:t=[]}=r,d=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},g=[d.id,d.reservationId,d.reservation_id,d.reservationCode,d.reservation_code].map(o=>o==null?"":String(o)).filter(o=>o.length>0);let m=-1,f=null;g.length>0&&(m=a.findIndex(o=>{const h=[o?.id,o?.reservationId,o?.reservation_id,o?.reservationCode,o?.reservation_code].map(p=>p==null?"":String(p)).filter(p=>p.length>0);return h.length===0?!1:h.some(p=>g.includes(p))}),m>=0&&(f=a[m]));let c;f?(c={...d,...f},Array.isArray(f.items)&&f.items.length&&(c.items=f.items),Array.isArray(f.packages)&&f.packages.length&&(c.packages=f.packages)):c=d;const k=c.projectId??c.project_id??null,w=k!=null&&l.find(o=>String(o.id)===String(k))||null,M=c.customerId??c.customer_id,T=s.find(o=>String(o.id)===String(M)),A=te(),B=[...Array.isArray(A)?A:[],...Array.isArray(t)?t:[]],R=new Map;B.forEach(o=>{if(!o||o.id==null)return;const h=String(o.id),p=R.get(h)||{};R.set(h,{...p,...o})});const V=Array.from(R.values());let X="";try{X=ne(c,T,V,m>=0?m:0,w)}catch(o){console.error("❌ [calendar] Failed to build reservation details for calendar modal",o),n.innerHTML=`<p class="text-sm text-error">${L(i("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"))}</p>`;return}n.innerHTML=X,n.classList.add("calendar-reservation-details");try{const o=n.querySelector("[data-tech-slider]");if(o){const h=o.querySelector("[data-slider-track]"),p=o.querySelector("[data-slider-prev]"),b=o.querySelector("[data-slider-next]");if(h&&(p||b)){const I=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",j=()=>{const C=h.querySelector(".reservation-technician-card"),v=C&&C.getBoundingClientRect().width||220,y=12,E=Math.max(1,Math.floor(h.clientWidth/(v+y)));return Math.max(v+y,Math.floor(E*(v+y)*.9))},F=()=>{const C=Math.max(0,h.scrollWidth-h.clientWidth-2),v=h.scrollLeft<=1,y=h.scrollLeft>=C;p&&(p.disabled=v),b&&(b.disabled=y)},q=C=>{const v=j()*C,y=I?-v:v;h.scrollBy({left:y,behavior:"smooth"})};p?.addEventListener("click",()=>q(-1)),b?.addEventListener("click",()=>q(1)),h.addEventListener("scroll",F,{passive:!0}),window.addEventListener("resize",F,{passive:!0}),setTimeout(F,0)}}}catch{}try{we()?.then(()=>{try{const o=Array.from(new Map((te()||[]).map(p=>[String(p.id),p])).values()),h=ne(c,T,o,m>=0?m:0,w);n.innerHTML=h,n.classList.add("calendar-reservation-details");try{const p=n.querySelector("[data-tech-slider]");if(p){const b=p.querySelector("[data-slider-track]"),I=p.querySelector("[data-slider-prev]"),j=p.querySelector("[data-slider-next]");if(b&&(I||j)){const F=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",q=()=>{const y=b.querySelector(".reservation-technician-card"),E=y&&y.getBoundingClientRect().width||220,_=12,be=Math.max(1,Math.floor(b.clientWidth/(E+_)));return Math.max(E+_,Math.floor(be*(E+_)*.9))},C=()=>{const y=Math.max(0,b.scrollWidth-b.clientWidth-2),E=b.scrollLeft<=1,_=b.scrollLeft>=y;I&&(I.disabled=E),j&&(j.disabled=_)},v=y=>{const E=q()*y,_=F?-E:E;b.scrollBy({left:_,behavior:"smooth"})};I?.addEventListener("click",()=>v(-1)),j?.addEventListener("click",()=>v(1)),b.addEventListener("scroll",C,{passive:!0}),window.addEventListener("resize",C,{passive:!0}),setTimeout(C,0)}}}catch{}}catch{}}).catch(()=>{})}catch{}n.querySelector(".reservation-modal-actions")?.remove(),n.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(o=>{o instanceof HTMLElement&&(o.setAttribute("disabled","true"),o.setAttribute("aria-disabled","true"),o.setAttribute("tabindex","-1"))});const W=n.querySelector('[data-action="open-project"]');W&&(w?W.addEventListener("click",()=>{const o=w?.id!=null?String(w.id):"",h=o?`projects.html?project=${encodeURIComponent(o)}`:"projects.html";window.location.href=h}):W instanceof HTMLElement&&W.setAttribute("disabled","true"));const Y=document.getElementById("calendarReservationModal");Y&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(Y).show():alert(i("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function ge(){Ae(),Ie(),je();const{calendarEl:e}=Z();if(!e)return;const n=Le();if(!n){(async()=>{const r=await Se();if(!r||typeof r.Calendar!="function"){const l=i("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");x({error:l}),N();return}x({loading:!0});const a=await de();if(S){const l=i("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");x({loading:!1,error:S||l}),N();return}const s=Te(a);u?u.batchRendering?.(()=>{u.removeAllEvents(),u.addEventSource(s)}):(u=new r.Calendar(e,{initialView:he(),locale:H(),timeZone:"local",expandRows:!0,height:"auto",contentHeight:"auto",slotMinTime:"06:00:00",slotMaxTime:"24:00:00",slotDuration:"00:30:00",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},dayMaxEventRows:2,fixedWeekCount:!0,showNonCurrentDates:!0,views:{dayGridMonth:{dayMaxEventRows:2,fixedWeekCount:!0}},moreLinkClick:"popover",lazyFetching:!1,noEventsContent(){return i("calendar.noEvents","لا توجد حجوزات لعرضها في هذا النطاق")},buttonText:{today:i("calendar.buttons.today","اليوم"),month:i("calendar.buttons.month","شهر"),week:i("calendar.buttons.week","أسبوع"),day:i("calendar.buttons.day","يوم")},events:s,eventContent:ke,eventClick(l){ue(l.event.extendedProps)},windowResize:D,datesSet(){Me()}}),u.render(),u.__isFullCalendar=!0),D(),ce(s),x({loading:!1,error:"",empty:s.length===0})})();return}(async()=>{x({loading:!0});const r=await de();if(S){const t=i("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");x({loading:!1,error:S||t}),N();return}const a=Re(r);N();const s=pe();u=new n("#calendar",{defaultView:s,usageStatistics:!1,isReadOnly:!0,week:{taskView:!1,hourStart:6,hourEnd:24},month:{visibleWeeksCount:0,startDayOfWeek:0,isAlways6Weeks:!0,maxVisibleEventCount:6,moreLayerSize:420},template:{time(t){const d=t?.raw?.paid===!0||t?.raw?.paid==="paid",g=t?.raw?.confirmed===!0||t?.raw?.confirmed==="true",m=t?.raw?.completed===!0||t?.raw?.completed==="true",f=i("calendar.labels.unknownCustomer","غير معروف"),c=J(t.start?.toString?.()||t.start,t.end?.toString?.()||t.end,t.isAllDay),k=t?.raw?.reservationId?String(t.raw.reservationId):"—",w=t?.raw?.customerName||f,M=(R,V)=>`<span class="badge ${R} badge-sm">${L(V)}</span>`,T=g?i("calendar.badges.confirmed","مؤكد"):i("calendar.badges.pending","غير مؤكد"),A=d?i("calendar.badges.paid","مدفوع"):i("calendar.badges.unpaid","غير مدفوع"),B=[M(g?"badge-success":"badge-warning",T),M(d?"badge-info":"badge-error",A)];return m&&B.push(M("badge-neutral",i("calendar.badges.completed","منتهي"))),`
            <div class="card bg-base-100/90 border border-base-200 shadow-sm rounded-xl p-2">
              <div class="flex items-baseline justify-between text-[0.8rem]">
                <span class="font-bold">${L(c||"")}</span>
                <span class="font-semibold">${L(k)}</span>
              </div>
              <div class="mt-1 font-semibold text-sm truncate">${L(w)}</div>
              <div class="mt-1 flex gap-1 flex-wrap">${B.join("")}</div>
            </div>
          `}}}),u.__isTui=!0;const l=t=>{if(t)try{ue(t)}catch{}};typeof u.on=="function"&&(u.on("clickSchedule",t=>l(t?.schedule?.raw||t?.schedule)),u.on("clickEvent",t=>l(t?.event?.raw||t?.event)));try{typeof u.createSchedules=="function"?u.createSchedules(a):typeof u.createEvents=="function"&&u.createEvents(a)}catch{}D(),ce(a),x({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{D()},120)})().catch(r=>{console.error("❌ [calendar] renderCalendar failed",r),S=r instanceof Error&&r.message||S||"";const a=i("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");x({loading:!1,error:S||a}),N()})}function Re(e=[]){const{projects:n=[]}=K(),r=new Map(n.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,l=s!=null&&r.get(String(s))||null,t=fe(a,l);if(!t)return null;const d=J(t.start,t.end,!1),g=t.customerName||"",m=[d,g].filter(Boolean).join(" · ");return{id:String(t.id),calendarId:"default",title:m,category:"time",isAllDay:!1,isAllday:!1,start:t.start,end:t.end,raw:{...a,paid:t.paid,confirmed:t.confirmed,completed:t.completed,reservationId:t.reservationId,customerName:t.customerName}}}).filter(Boolean)}function he(){if(typeof window>"u")return"dayGridMonth";const e=window.innerWidth||1024,n=Q(e);return n==="xs"?"timeGridDay":n==="sm"?"timeGridWeek":"dayGridMonth"}export{ge as renderCalendar};
