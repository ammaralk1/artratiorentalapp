import{d as q,n as S,b as H,A as Oe,s as we,f as At,t as p,h as N,o as Nt,j as We}from"./auth.js";const Tt=q()||{};let j=(Tt.technicians||[]).map(Ye);function Ue(){return j}function ae(e){return j=Array.isArray(e)?e.map(Ye):[],we({technicians:j}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),j}async function It(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,r])=>{r!=null&&r!==""&&t.set(s,String(r))});const n=t.toString(),a=await H(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(be):[];return ae(i)}async function Et(e){const t=await H("/technicians/",{method:"POST",body:e}),n=be(t?.data??{});return ae([...j,n]),n}async function ke(e,t){const n=await H(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=be(n?.data??{}),i=j.map(s=>String(s.id)===String(e)?a:s);return ae(i),a}async function Pt(e){await H(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ae(j.filter(t=>String(t.id)!==String(e)))}function Ke({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,dailyTotal:r,status:o,notes:l,active:c=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,daily_total:r??null,status:o??"available",notes:l??null,active:c?1:0}}function be(e={}){return Je({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function Ye(e={}){return Je(e)}function Je(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",r=e.department??e.team??"",o=$e(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=$e(e.daily_total??e.dailyTotal??e.total??e.total_wage??o),c=Re(e.baseStatus??e.status??"available"),f=Re(e.status??e.baseStatus??"available"),h=e.notes??"",g=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:r,dailyWage:o,dailyTotal:l,status:f,baseStatus:c,notes:h,active:g}}function $e(e){const t=Number.parseFloat(S(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Re(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function de(e){return e instanceof Oe}let x=null,Me=!1,oe=!1,te="",ye=!1;async function Ze({showToastOnError:e=!0}={}){if(!oe){oe=!0,te="",D();try{await It(),ye=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),te=de(t)?t.message:p("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&N(te,"error")}finally{oe=!1,D()}}}function Ge(){return Ue()}function se(e=""){return S(String(e)).trim().toLowerCase()}function ze(e){return e==null?"":String(e)}function Y(e=""){return S(String(e)).replace(/[^0-9+]/g,"")}function F(e=""){const t=S(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function K(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function ve(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=p(n,a)}function Se(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=p("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function _e(){ve(x?"update":"add"),Se(!!x),D()}function Bt(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,r)=>s.localeCompare(r,"ar",{sensitivity:"base"})),i=p("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function me(){const e=document.getElementById("technician-form");e&&(e.reset(),x=null,ve("add"),Se(!1))}function Dt(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-wage"),r=document.getElementById("technician-total"),o=document.getElementById("technician-notes");!t||!n||!a||!s||!r||(t.value=e.name||"",n.value=Y(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s.value=F(e.dailyWage!=null?e.dailyWage:""),r.value=F(e.dailyTotal!=null?e.dailyTotal:""),o&&(o.value=e.notes||""),x=String(e.id),ve("update"),Se(!0))}function Ft(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-wage"),s=document.getElementById("technician-total"),r=document.getElementById("technician-notes");if(!e||!t||!n||!i||!s)return null;const o=e.value.trim(),l=Y(t.value.trim());t.value=l;const c=n.value.trim(),f=a?.value.trim()||"",h=F(i.value.trim());i.value=h;const g=h===""?0:parseFloat(h),b=F(s.value.trim());s.value=b;const d=b===""?null:parseFloat(b),m="available",v=r?.value.trim()||"";return o?l?c?Number.isNaN(g)||g<0?(N(p("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),i.focus(),null):d!=null&&(Number.isNaN(d)||d<0)?(N(p("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),s.focus(),null):{name:o,phone:l,role:c,department:f,dailyWage:Number.isFinite(g)?g:0,dailyTotal:d==null?null:Number(d),status:m,baseStatus:m,notes:v}:(N(p("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),n.focus(),null):(N(p("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(N(p("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function Ct(e){e.preventDefault();const t=Ft();if(!t)return;const n=Ke({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{x?(await ke(x,n),N(p("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await Et(n),N(p("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),me(),D()}catch(a){console.error("âŒ [technicians] handleTechnicianSubmit failed",a);const i=de(a)?a.message:p("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");N(i,"error")}}function Lt(){me()}function xt(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=Y(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=F(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=F(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==i&&(t.total.value=i);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),K(t.phone,Y),K(t.wage,F),K(t.total,F)}function $t(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),r=document.getElementById("edit-technician-total"),o=document.getElementById("edit-technician-status"),l=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!r||!o)return null;const c=e.value.trim(),f=t.value.trim(),h=Y(n.value.trim());n.value=h;const g=a.value.trim(),b=i?.value.trim()||"",d=F(s.value.trim());s.value=d;const m=d===""?0:parseFloat(d),v=F(r.value.trim());r.value=v;const y=v===""?null:parseFloat(v),_=o.value||"available",A=l?.value.trim()||"";return c?f?h?g?Number.isNaN(m)||m<0?(N(p("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),s.focus(),null):y!=null&&(Number.isNaN(y)||y<0)?(N(p("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),r.focus(),null):{id:c,name:f,phone:h,role:g,department:b,dailyWage:Number.isFinite(m)?m:0,dailyTotal:y==null?null:Number(y),status:_,baseStatus:_,notes:A}:(N(p("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),a.focus(),null):(N(p("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(N(p("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(N(p("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Rt(){const e=$t();if(!e)return;const t=Ke({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await ke(e.id,t),N(p("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),D()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const a=de(n)?n.message:p("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");N(a,"error")}}function D(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=se(t?.value||"");if(oe&&!ye){const c=p("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}if(te&&!ye){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${te}</td></tr>`;return}const a=Qe(),{reservations:i=[]}=q(),s=new Date;Bt(a);const r=document.getElementById("technician-role-filter"),o=se(r?.value||""),l=a.filter(c=>o&&se(c.role||"")!==o?!1:n?se([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const c=p("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}e.innerHTML=l.map(c=>{const f=x&&String(x)===String(c.id),b=(Xe(c.id,i,s)?"busy":c.status||c.baseStatus||"available")==="busy"?{label:p("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:p("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},d=p("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),m=p("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),v=We(),y=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${c.id}">${d}</button>`];return v&&y.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${c.id}">${m}</button>`),`
      <tr${f?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${c.id}" class="text-decoration-none">${c.name}</a></td>
        <td>${c.role||""}</td>
        <td>${c.department||"â€”"}</td>
        <td><span class="${b.className}"><span class="technician-status-badge__text">${b.label}</span></span></td>
        <td class="table-notes-cell">${c.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${y.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Mt(e){const t=Ge().find(n=>String(n.id)===String(e));if(!t){N(p("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}Dt(t),N(p("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function zt(e){if(!We()){Nt();return}if(confirm(p("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await Pt(e),N(p("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),x&&String(x)===String(e)&&me(),D()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=de(t)?t.message:p("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");N(n,"error")}}function gn(){Ae(),D()}function bn(e){return Ge().find(t=>String(t.id)===String(e))||null}function Xe(e,t=[],n){const a=ze(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(l=>ze(l)===a))return!1;const r=new Date(i.start),o=new Date(i.end);return Number.isNaN(r.getTime())||Number.isNaN(o.getTime())?!1:r<=n&&n<o}):!1}function Qe(){const e=q().reservations||[],t=Ue();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const r=s.baseStatus||s.status||"available";let o=r==="busy"?"busy":r;return Xe(s.id,e,n)&&(o="busy"),(o!==s.status||r!==s.baseStatus)&&(a=!0),{...s,baseStatus:r,status:o}});return a?(ae(i),i):t}function Ae(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",o=>{Ct(o).catch(l=>{console.error("âŒ [technicians] submit handler failed",l)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Lt),n.dataset.listenerAttached="true"),K(document.getElementById("technician-phone"),Y),K(document.getElementById("technician-wage"),F),K(document.getElementById("technician-total"),F);const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",o=>{const l=o.target;if(l instanceof HTMLElement){if(l.classList.contains("technician-edit-btn")){const c=l.dataset.id;Mt(c)}if(l.classList.contains("technician-delete-btn")){const c=l.dataset.id;zt(c).catch(f=>{console.error("âŒ [technicians] delete handler failed",f)})}}}),a.dataset.listenerAttached="true");const i=document.getElementById("search-technician-input");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{i.value=S(i.value),D()}),i.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{D()}),s.dataset.listenerAttached="true");const r=document.getElementById("save-technician-changes");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{Rt().catch(o=>{console.error("âŒ [technicians] modal save failed",o)})}),r.dataset.listenerAttached="true"),Me||(document.addEventListener("technician:prefill",o=>{const l=o.detail;l&&xt(l)}),Me=!0),t&&me()}window.addEventListener("DOMContentLoaded",()=>{Ae(),D(),_e(),Ze()});const et=()=>{D()};window.addEventListener("technicians:updated",et);document.addEventListener("technicians:updated",et);document.addEventListener("technicians:refreshRequested",()=>{Ae(),D(),_e(),Ze({showToastOnError:!1})});document.addEventListener("language:changed",()=>{_e()});document.addEventListener(At.USER_UPDATED,()=>{D()});let J=[],tt=[],nt=[];function vn(){return J}function Sn(e){J=Array.isArray(e)?e:[]}function _n(e){J=[...J,e]}function An(e){Number.isInteger(e)&&e>=0&&(J=J.filter((t,n)=>n!==e))}function Nn(){return tt}function Tn(e){tt=Array.isArray(e)?e:[]}function In(){return nt}function En(e){nt=Array.isArray(e)?e:[]}function Pn(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),s=a?a.slice(0,10):"",r=i.match(/(\d{1,2}:\d{2})/);let o="";if(r){const[l="00",c="00"]=r[0].split(":");o=`${l.padStart(2,"0")}:${c.padStart(2,"0")}`}return{date:s,time:o}}function re(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function ne(e){return S(String(e||"")).trim().toLowerCase()}const qt=864e13;function ee(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const i=new Date(a);if(!Number.isNaN(i.getTime()))return i}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function Bn(e,t,n,a=null){if(!e||!t||!n)return!1;const i=ee(t),s=ee(n);if(!i||!s||i>=s)return!1;const r=ne(e);if(!r)return!1;const o=q()||{},l=Array.isArray(o.reservations)?o.reservations:[],c=Array.isArray(o.maintenance)?o.maintenance:[],f=Array.isArray(o.equipment)?o.equipment:[],h=Wt(f),g=at(a);return l.some(d=>{if(!d||!Array.isArray(d.items)||d.items.length===0||it(d,g)||!d.start||!d.end)return!1;const m=ee(d.start),v=ee(d.end);return!m||!v||!(m<s&&v>i)?!1:d.items.some(_=>ne(_?.barcode)===r)})?!0:c.some(d=>{if(!Ht(d)||!jt(d,h).has(r))return!1;const{start:v,end:y}=Ot(d);if(!v&&!y)return!0;const _=v??new Date(0),A=y??new Date(qt);return _<s&&A>i})}function Ht(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(wt(e))return!1;for(const n of t){const a=Vt(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function Vt(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function jt(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(r=>{const o=ne(r);o&&n.add(o)});const i=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(i){const r=ne(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number);r&&n.add(r)}return[e?.equipmentId,e?.equipment_id,i?.id,i?.equipmentId,i?.equipment_id].map(r=>r!=null?String(r):"").filter(Boolean).forEach(r=>{const o=t.get(r);if(!o)return;const l=ne(o?.barcode??o?.equipmentBarcode??o?.code??o?.serial??o?.serialNumber??o?.serial_number);l&&n.add(l)}),n}function Ot(e){const t=he([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=he([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function wt(e){return!!he([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function he(e=[]){for(const t of e){const n=ee(t);if(n)return n}return null}function Wt(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(i=>i!=null?String(i):"").filter(Boolean).forEach(i=>{t.has(i)||t.set(i,n)})}),t}function Ut(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:r=[]}=q(),o=String(e),l=at(a);return r.some(c=>{if(!c?.start||!c?.end||it(c,l))return!1;const f=new Date(c.start),h=new Date(c.end);return Number.isNaN(f.getTime())||Number.isNaN(h.getTime())||!(f<s&&h>i)?!1:(Array.isArray(c.technicians)?c.technicians:[]).some(d=>String(d)===o)})}function at(e){return U(e,new Set)}function it(e,t){if(!t||t.size===0)return!1;const n=U([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function U(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(s=>U(s,t)),t;if(Array.isArray(e))return e.forEach(s=>U(s,t)),t;if(typeof e=="object"){const s=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let r=!1;return s.forEach(o=>{Object.prototype.hasOwnProperty.call(e,o)&&(r=!0,U(e[o],t))}),r||Object.values(e).forEach(o=>U(o,t)),t}const n=S(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],i=n.replace(/\D+/g,"");if(i){a.push(i);const s=Number.parseInt(i,10);Number.isNaN(s)||a.push(String(s))}return a.forEach(s=>{s&&t.add(s)}),t}let O=[],M=[],z=[],ce="create",Ne=()=>{},Te=()=>{};function kt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=S(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function st(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const i of t){if(i==null||i==="")continue;const s=parseFloat(S(String(i)));if(Number.isFinite(s)){n=s;break}}if((!Number.isFinite(n)||n<=0)&&(n=kt(e)),!Number.isFinite(n)||n<=0)return"â€”";const a=p("technicians.table.wageSuffix","SR");return`${S(String(n))} ${a}`}function qe(e=""){return S(String(e)).trim().toLowerCase()}function rt(e){return!O||!O.length?null:O.find(t=>String(t?.id)===String(e))||null}function Kt(e,t="create"){t==="edit"?Pe(z.filter(n=>String(n)!==String(e))):Ee(M.filter(n=>String(n)!==String(e)))}function le(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=p("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const s=rt(i)||{},r=p("reservations.crew.fallbackName","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… {id}").replace("{id}",i),o=s.name||r,l=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",c=st(s),f=c!=="â€”"?`<small class="technician-chip-wage">ğŸ’° ${c}</small>`:"",h=p("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${o}</span>
          ${l}
          ${f}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${h}">âœ–</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>Kt(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function ot(){return ce==="edit"?z:M}function ue(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=qe(t?.value||""),a=new Set(ot().map(String)),s=(O||[]).filter(r=>n?qe([r.name,r.phone,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const r=p("reservations.crew.searchEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${r}</td></tr>`;return}e.innerHTML=s.map(r=>{const o=st(r);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${r.id}" ${a.has(String(r.id))?"checked":""}>
        </td>
        <td>${r.name||"-"}</td>
        <td>${r.role||"â€”"}</td>
        <td>${r.department||"â€”"}</td>
        <td>${o}</td>
      </tr>
    `}).join("")}function Yt(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function Jt(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",f=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",h=o?re(o,c):null,g=l?re(l,f):null;let b=null;const d=document.getElementById("edit-res-index")?.value;if(d!=null){const m=Number.parseInt(d,10);if(Number.isInteger(m)){const{reservations:v=[]}=q(),y=v?.[m];y&&(b=y.id??y.reservationId??null)}}return{start:h,end:g,ignoreReservationId:b}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?re(t,a):null,r=n?re(n,i):null;return{start:s,end:r,ignoreReservationId:null}}function Z(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=ot().length;if(t){const n=p("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",S(String(t)));e.textContent=n}else e.textContent=p("technicians.picker.selectionInfo","No crew selected yet")}function Zt(){const e=Yt().map(String),{start:t,end:n,ignoreReservationId:a}=Jt(ce);if(t&&n){const s=e.filter(r=>Ut(r,t,n,a));if(s.length>0){const r=s.map(l=>rt(l)?.name||l).join(p("reservations.list.crew.separator","ØŒ ")),o=p("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",r);s.forEach(l=>{const c=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(l))}"]`);c&&(c.checked=!1)}),N(o),Z();return}}ce==="edit"?Pe(e):Ee(e),Z();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function He(e="create"){ce=e;const t=Qe();Array.isArray(t)&&t.length&&(O=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),ue(),Z();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function Gt(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>He("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>He("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{ue(),Z()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Zt),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{Z(),ue()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),Ie()}function Ie(){le("selected-technicians-list",M,"create"),le("edit-selected-technicians-list",z,"edit")}function Dn({onDraftChange:e,onEditChange:t}={}){Ne=typeof e=="function"?e:()=>{},Te=typeof t=="function"?t:()=>{},Ie(),Gt()}function Xt(e=[]){O=Array.isArray(e)?e:[]}function Qt(){return[...M]}function en(){return[...z]}function Ee(e=[]){M=Array.isArray(e)?e.map(String):[],le("selected-technicians-list",M,"create"),Ne()}function Pe(e=[]){z=Array.isArray(e)?e.map(String):[],le("edit-selected-technicians-list",z,"edit"),Te()}function Fn(){Ee([])}function Cn(){Pe([])}function Ln(e=[]){Xt(e);const t=new Set(O.map(o=>String(o.id))),n=M.filter(o=>t.has(String(o))),a=z.filter(o=>t.has(String(o))),i=n.length!==M.length,s=a.length!==z.length;M=n,z=a,Ie(),i&&Ne(),s&&Te();const r=document.getElementById("selectTechniciansModal");r&&r.classList.contains("show")&&(ue(),Z())}const ct=10;function lt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function tn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=Number(n);if(Number.isFinite(a))return a}return lt(e)}function nn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=q();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));if(!s)return a;const r=lt(s),o=tn(s);return{costPerDay:a.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:a.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const an=1440*60*1e3,k=.01;function W(e){if(e==null||e==="")return null;const t=S(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Ve(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let i=Number.isFinite(e)?e:0;if(i<t&&(i=t),i>n&&(i=n),a!=null){const s=10**a;i=Math.round(i*s)/s}return i}function ut(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function Be({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:i=null,history:s=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,o=t==="amount"?"amount":t==="percent"?"percent":null;let l=W(a),c=W(i);const f=W(n);let h=0,g=0;Array.isArray(s)&&s.length&&s.forEach(y=>{if(!y)return;const _=y.type==="amount"||y.type==="percent"?y.type:null,A=W(y.value),P=W(y.amount),T=W(y.percentage);if(_==="amount"){const I=P??A;I!=null&&(h+=I,r>0&&(g+=I/r*100))}else if(_==="percent"){const I=T??A;I!=null&&(g+=I,r>0&&(h+=I/100*r))}else P!=null&&(h+=P,r>0&&(g+=P/r*100)),T!=null&&(g+=T,r>0&&(h+=T/100*r))}),o==="amount"&&f!=null?l=f:o==="percent"&&f!=null?c=f:o===null&&f!=null&&(c!=null?c=f:l=f),(l==null||l<=0)&&c!=null&&c>0&&r>0&&(l=r*(c/100)),(c==null||c<=0)&&l!=null&&l>0&&r>0&&(c=l/r*100);const b=l??0,d=c??0;l=b+h,c=d+g,l=Ve(l??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),c=Ve(c??0,{min:0,max:100,precision:2});let m=o;return m||(l>0&&r>0?m="amount":c>0&&(m="percent")),{paidAmount:l,paidPercent:c,paymentProgressType:m,paymentProgressValue:m==="amount"?l:m==="percent"?c:null}}function De({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const i=ut(e),s=Number.isFinite(Number(a))?Number(a):0,r=Number.isFinite(Number(t))?Number(t):0,o=Number.isFinite(Number(n))?Number(n):0;if(i==="paid")return"paid";const l=s>0&&r>=s-k,c=o>=100-k*100;if(l||c)return"paid";const f=r>k||o>k;return i==="partial"||f?"partial":"unpaid"}function sn(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/an;return Math.max(1,Math.ceil(s))}function G({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:i=!1,start:s=null,end:r=null,companySharePercent:o=null}={}){const l=sn(s,r),f=(e||[]).reduce((X,E)=>X+(Number(E?.qty)||1)*(Number(E?.price)||0),0)*l,{costPerDay:h,totalPerDay:g}=nn(t),b=g*l,d=h*l,m=f+b,v=Number(n)||0;let y=a==="amount"?v:m*(v/100);(!Number.isFinite(y)||y<0)&&(y=0),y>m&&(y=m);const _=Math.max(0,m-y);let A=Number.isFinite(o)?Number(o):null;i&&(!Number.isFinite(A)||A<=0)&&(A=ct);const P=A&&A>0?A:0,T=P>0?Math.max(0,_*(P/100)):0,I=_+T;let B=i?I*.15:0;(!Number.isFinite(B)||B<0)&&(B=0),B=Number(B.toFixed(2));const u=I+B,V=Math.max(0,Number(u.toFixed(2))),L=Math.max(0,f+b-d);return{rentalDays:l,equipmentTotal:f,crewTotal:b,crewCostTotal:d,discountAmount:y,subtotalAfterDiscount:_,taxableAmount:I,taxAmount:B,finalTotal:V,companySharePercent:P,companyShareAmount:T,netProfit:L}}function xn(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:r=null,companySharePercent:o=null}={}){return G({items:e,technicianIds:i,discount:t,discountType:n,applyTax:a,start:s,end:r,companySharePercent:o}).finalTotal}function dt({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paymentStatus:s,paidAmount:r=0,paidPercent:o=0,companySharePercent:l=null,companyShareAmount:c=null,taxAmount:f=null,netProfit:h=null,totalKey:g="reservations.summary.total"}){const b=p("reservations.create.summary.currency","SR"),d=S(String(e)),m=S(String(t)),v=S(String(n??1)),y=S(String(a)),_=ut(s),A=_==="paid"?"Ù…Ø¯ÙÙˆØ¹":_==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",P=p(`reservations.create.paymentStatus.${_}`,A),T=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,I=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,B=T>k||I>k,u=p("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),V=S(T.toFixed(2)),L=S(I.toFixed(I%1?2:0)),X=p("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),E=p("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),pt=p("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),ft=p("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),yt=p("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),ht=p(g.replace(".total",".totalLabel"),"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©"),gt=p("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),bt=p("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),fe=Number.isFinite(h)?Math.max(0,Number(h)):null,w=[{label:X,value:m},{label:E,value:v},{label:pt,value:y}];if(i){let $=p("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(f)&&f>0&&($=`${S(Number(f).toFixed(2))} ${b}`),w.push({label:ft,value:$})}const ie=Number.isFinite(l)?Number(l):null;if(ie!==null&&ie>0){const $=Number.isFinite(c)?Number(c):e*(ie/100),Q=S(String(ie)),St=S(Number.isFinite($)?$.toFixed(2):"0"),_t=`${Q}% (${St} ${b})`;w.push({label:gt,value:_t})}if(fe!==null&&Math.abs(fe-Number(e))>.009){const $=S(fe.toFixed(2));w.push({label:bt,value:`${$} ${b}`})}w.push({label:yt,value:P}),B&&w.push({label:u,value:`${V} ${b} (${L}%)`});const vt=`${d} ${b}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${w.map(({label:$,value:Q})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${$}</span>
            ${Q?`<span class="reservation-summary-value">${Q}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${ht}</span>
          <span class="reservation-summary-value">${vt}</span>
        </div>
      </div>
    </div>
  `}function rn({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,paymentProgressType:s=null,paymentProgressValue:r=null,start:o,end:l,companySharePercent:c=null,paymentHistory:f=[]}){const h=Qt(),g=h.length,b=Number.isFinite(c)?Number(c):null,d=G({items:e,technicianIds:h,discount:t,discountType:n,applyTax:a,start:o,end:l,companySharePercent:b}),m=Be({totalAmount:d.finalTotal,progressType:s,progressValue:r,history:f}),v=De({manualStatus:i,paidAmount:m.paidAmount,paidPercent:m.paidPercent,totalAmount:d.finalTotal}),y=dt({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:g,applyTax:a,paymentStatus:v,paidAmount:m.paidAmount,paidPercent:m.paidPercent,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit}),_={paymentStatus:v,paidAmount:m.paidAmount,paidPercent:m.paidPercent,paymentProgressType:m.paymentProgressType,paymentProgressValue:m.paymentProgressValue,total:d.finalTotal};return rn.lastResult=_,cn(y),y}function on({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,paymentProgressType:s=null,paymentProgressValue:r=null,start:o,end:l,companySharePercent:c=null,paymentHistory:f=[]}){const h=en(),g=h.length,b=Number.isFinite(c)?Number(c):null,d=G({items:e,technicianIds:h,discount:t,discountType:n,applyTax:a,start:o,end:l,companySharePercent:b}),m=Be({totalAmount:d.finalTotal,progressType:s,progressValue:r,history:f}),v=De({manualStatus:i,paidAmount:m.paidAmount,paidPercent:m.paidPercent,totalAmount:d.finalTotal}),y=dt({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:g,applyTax:a,paymentStatus:v,paidAmount:m.paidAmount,paidPercent:m.paidPercent,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit,totalKey:"reservations.summary.totalAfterEdit"}),_={html:y,paymentStatus:v,paidAmount:m.paidAmount,paidPercent:m.paidPercent,paymentProgressType:m.paymentProgressType,paymentProgressValue:m.paymentProgressValue,total:d.finalTotal};return on.lastResult=_,y}function cn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,je(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,je(n,e))}function je(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const ln=q()||{};let R=(ln.reservations||[]).map(dn);function $n(){return R}function pe(e){return R=Array.isArray(e)?e.map(Ce):[],R.length?console.debug("[reservationsService] setReservationsState first paymentHistory",R[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),we({reservations:R}),R}async function Rn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),i=(await H(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const r=s.map(Fe);return pe(r)}async function Mn(e){const t=await H("/reservations/",{method:"POST",body:e}),n=Fe(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=Le(e.payment_history);a.length&&(n.paymentHistory=a)}if(n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=G({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,pe([...R,n]),n}async function un(e,t){const n=await H(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Fe(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const s=Le(t.payment_history);s.length&&(a.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if(a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const s=G({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=s.companyShareAmount,a.cost=s.finalTotal,a.totalAmount=s.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const i=R.map(s=>String(s.id)===String(e)?a:s);return pe(i),a}async function zn(e){await H(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=R.filter(n=>String(n.id)!==String(e));pe(t)}async function qn(e){return un(e,{status:"confirmed",confirmed:!0})}function Fe(e={}){return Ce({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function dn(e={}){return Ce(e)}function Ce(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(mn):[],i=Array.isArray(e.technicians)?e.technicians:[],s=i.map(E=>E==null?null:String(typeof E=="object"?E.id??E.technician_id??E.technicianId??E.ID??"":E)).filter(E=>E&&E!==""),r=e.start??e.start_datetime??"",o=e.end??e.end_datetime??"";let l=C(e.total_amount??e.totalAmount??e.cost??0);const c=C(e.discount??0),f=e.discount_type??e.discountType??"percent",h=["percent","amount"].includes(f)?f:"percent",g=!!(e.apply_tax??e.applyTax??!1);let b=yn(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const d=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),m=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,v=m!=null?Number.parseFloat(S(String(m).replace("%","").trim())):NaN,y=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let _=y!=null?y===!0||y===1||y==="1"||String(y).toLowerCase()==="true":Number.isFinite(v)&&v>0,A=_&&Number.isFinite(v)?Number(v):0;const P=e.company_share_amount??e.companyShareAmount;let T=Number.isFinite(Number(P))?Number(P):NaN;g&&A<=0&&(A=ct,_=!0);const I=G({items:a,technicianIds:s,discount:c,discountType:h,applyTax:g,start:r,end:o,companySharePercent:A>0?A:null});(!Number.isFinite(l)||l<=0||g)&&(l=I.finalTotal),(!Number.isFinite(T)||T<0)&&(T=I.companyShareAmount),T=Number.isFinite(T)?Number(T.toFixed(2)):0,!_&&A>0&&(_=!0);const B=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],u=pn(B),V=Le(u),L=Be({totalAmount:l,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:V});b=De({manualStatus:b,paidAmount:L.paidAmount,paidPercent:L.paidPercent,totalAmount:l});const X=b==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:o,status:fn(e.status??(d?"confirmed":"pending")),confirmed:d,location:e.location??"",notes:e.notes??"",discount:c,discountType:h,applyTax:g,paid:X,paidStatus:b,paidAmount:L.paidAmount,paidPercent:L.paidPercent,paymentProgressType:L.paymentProgressType,paymentProgressValue:L.paymentProgressValue,paymentHistory:V,payment_history:V,totalAmount:l,cost:l,projectId:e.project_id??e.projectId??null,items:a,technicians:s,techniciansDetails:i.map(E=>typeof E=="object"?E:{id:Number(E)||E}),startDatetime:r,endDatetime:o,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:A,companyShareAmount:T,companyShareEnabled:_}}function mn(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=mt(e.quantity??e.qty??1),a=C(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:S(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function Hn({reservationCode:e,customerId:t,start:n,end:a,status:i,title:s,location:r,notes:o,projectId:l,totalAmount:c,discount:f,discountType:h,applyTax:g,paidStatus:b,confirmed:d,items:m,technicians:v,companySharePercent:y,companyShareEnabled:_,paidAmount:A,paidPercentage:P,paymentProgressType:T,paymentProgressValue:I,paymentHistory:B}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:s??null,location:r??null,notes:o??null,project_id:l||null,total_amount:c??0,discount:f??0,discount_type:h??"percent",apply_tax:g?1:0,paid_status:b??"unpaid",paid_amount:Number.isFinite(A)?C(A):0,paid_percentage:Number.isFinite(P)?Number(P.toFixed(2)):0,payment_progress_type:T??null,payment_progress_value:Number.isFinite(I)?Number(I.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(u=>({type:ge(u?.type??u?.payment_type??u?.method??u?.paymentMethod),value:u?.value!=null?C(u.value):null,amount:u?.amount!=null?C(u.amount):u?.payment_amount!=null?C(u.payment_amount):null,percentage:u?.percentage!=null?Number(u.percentage):u?.payment_percentage!=null?Number(u.payment_percentage):null,note:u?.note??u?.notes??u?.comment??u?.payment_note??null,recorded_at:u?.recordedAt??u?.recorded_at??u?.createdAt??u?.created_at??u?.payment_date??u?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(u=>({type:ge(u?.type??u?.payment_type??u?.method??u?.paymentMethod),value:u?.value!=null?C(u.value):null,amount:u?.amount!=null?C(u.amount):u?.payment_amount!=null?C(u.payment_amount):null,percentage:u?.percentage!=null?Number(u.percentage):u?.payment_percentage!=null?Number(u.payment_percentage):null,note:u?.note??u?.notes??u?.comment??u?.payment_note??null,recorded_at:u?.recordedAt??u?.recorded_at??u?.createdAt??u?.created_at??u?.payment_date??u?.date??new Date().toISOString()})):[],confirmed:d===void 0?null:!!d,items:Array.isArray(m)?m.map(u=>({equipment_id:u.equipmentId??u.equipment_id??u.id,quantity:mt(u.qty??u.quantity??1),unit_price:C(u.price??u.unit_price??0),notes:u.notes??null})):[],company_share_percent:_&&Number.isFinite(y)?Number(y):null,company_share_enabled:_?1:0,technicians:Array.isArray(v)?v.map(u=>typeof u=="object"&&u!==null?{id:u.id??u.technician_id??u.technicianId??u.ID,role:u.role??null,notes:u.notes??null}:Number.isNaN(Number(u))?String(u):Number(u)):[]}}function Le(e){const t=xe(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const a=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,i=ge(a),s=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,r=s!=null?Number.parseFloat(S(String(s))):null,o=n.amount!=null?Number.parseFloat(S(String(n.amount))):n.payment_amount!=null?Number.parseFloat(S(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(S(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(S(String(n.payment_percentage))):null,c=Number.isFinite(o)?o:i==="amount"&&Number.isFinite(r)?r:null,f=Number.isFinite(l)?l:i==="percent"&&Number.isFinite(r)?r:null,h=i??(c!=null?"amount":f!=null?"percent":null),g=h==="amount"?c:h==="percent"?f:Number.isFinite(r)?r:null,b=n.note??n.notes??n.comment??n.payment_note??null,d=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:h,value:g,amount:c,percentage:f,note:b,recordedAt:d}}).filter(n=>n&&n.type)}function ge(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function xe(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of t)if(Array.isArray(e[r]))return e[r];const a=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(a))return a;const i=Object.values(e);if(i.length&&i.every(r=>r&&typeof r=="object")){const r=i.map(o=>o);if(r.every(o=>!Array.isArray(o)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return xe(t)}catch{return[]}return[]}function pn(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=xe(t);if(Array.isArray(n)&&n.length)return n}return[]}function C(e){const t=Number(S(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function mt(e){const t=Number.parseInt(S(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function fn(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return"pending"}}function yn(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function Vn(e){return e instanceof Oe}export{An as A,Qt as B,Ut as C,ct as D,Hn as E,Mn as F,In as G,Fn as H,Sn as I,En as J,zn as K,qn as L,on as M,Pe as N,en as O,Cn as P,Rn as a,be as b,Fe as c,gn as d,Be as e,De as f,$n as g,bn as h,Vn as i,sn as j,xn as k,Dn as l,dn as m,Ln as n,ne as o,Bn as p,Nn as q,It as r,Qe as s,rn as t,un as u,re as v,Pn as w,Tn as x,vn as y,_n as z};
