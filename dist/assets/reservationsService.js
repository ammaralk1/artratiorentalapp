import{d as M,n as I,b as U,A as Ge,s as pn,a as li,m as ui,c as di,i as pi,l as mi,e as J,t as m,f as fi,h as P,j as mn,o as gi}from"./auth.js";const hi=M()||{};let ge=(hi.technicians||[]).map(yn);function fn(){return ge}function xe(e){return ge=Array.isArray(e)?e.map(yn):[],pn({technicians:ge}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),ge}async function It(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,c])=>{c!=null&&c!==""&&t.set(s,String(c))});const n=t.toString(),i=await U(`/technicians/${n?`?${n}`:""}`),o=Array.isArray(i?.data)?i.data.map(At):[];return xe(o)}async function yi(e){const t=await U("/technicians/",{method:"POST",body:e}),n=At(t?.data??{});return xe([...ge,n]),n}async function gn(e,t){const n=await U(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=At(n?.data??{}),o=ge.map(s=>String(s.id)===String(e)?i:s);return xe(o),i}async function bi(e){await U(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),xe(ge.filter(t=>String(t.id)!==String(e)))}function hn({name:e,phone:t,email:n,role:i,department:o,dailyWage:s,dailyTotal:c,status:a,notes:r,active:l=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:i??"",department:o??null,daily_wage:s??0,daily_total:c??null,status:a??"available",notes:r??null,active:l?1:0}}function At(e={}){return bn({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function yn(e={}){return bn(e)}function bn(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",i=e.phone??"",o=e.email??null,s=e.specialization??e.role??e.position??"",c=e.department??e.team??"",a=Qt(e.daily_wage??e.dailyWage??e.wage??e.rate??0),r=Qt(e.daily_total??e.dailyTotal??e.total??e.total_wage??a),l=Wt(e.baseStatus??e.status??"available"),d=Wt(e.status??e.baseStatus??"available"),u=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:i,email:o,role:s,department:c,dailyWage:a,dailyTotal:r,status:d,baseStatus:l,notes:u,active:p}}function Qt(e){const t=Number.parseFloat(I(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Wt(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function et(e){return e instanceof Ge}li();ui();di();document.addEventListener("DOMContentLoaded",()=>{pi();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>mi()),e.dataset.listenerAttached="true")});function Ye(e){const t=Number(e)||0,i=J()==="ar"?"ar-SA-u-nu-latn":"en-US",o=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${I(o)} SR`}function Ka(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function Qa(e){const t=new Date,n=e?.start?new Date(e.start):null,i=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":i&&!Number.isNaN(i.getTime())&&i<t?"completed":"ongoing"}function Wa(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function fe(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const _i="technicianPositions:updated";let Y=[],_n=!1,Fe=null;function Pt(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function In({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:o}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:i??null,label_en:o??null}}function Ii(e){return Y=Array.isArray(e)?e.map(Pt).filter(t=>t.name!=="").sort((t,n)=>ve(t).localeCompare(ve(n),"ar",{sensitivity:"base"})):[],_n=!0,tt(),le()}function tt(){try{const e={positions:le()},t=new CustomEvent(_i,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function ve(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function le(){return Y.map(e=>({...e}))}function An(e){const t=String(e??"").trim().toLowerCase();return t&&Y.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function Ai({forceRefresh:e=!1}={}){return _n&&!e?le():(Fe&&!e||(Fe=U("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return Ii(n)}).finally(()=>{Fe=null})),Fe)}async function Me({forceRefresh:e=!1}={}){try{return await Ai({forceRefresh:e})}catch(t){throw t instanceof Ge?t:new Ge(t?.message||m("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function Pi({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:o}){const s=In({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:o}),c=await U("/technician-positions/",{method:"POST",body:s}),a=Pt(c?.data??{});return Y=[...Y,a],Y.sort((r,l)=>ve(r).localeCompare(ve(l),"ar",{sensitivity:"base"})),tt(),a}async function Ni(e,{name:t,cost:n,clientPrice:i,labelAr:o,labelEn:s}){if(!e)throw new Error("Position id is required");const c=In({name:t,cost:n,clientPrice:i,labelAr:o,labelEn:s}),a=await U(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:c}),r=Pt(a?.data??{});return Y=Y.map(l=>l.id===r.id?r:l),Y.sort((l,d)=>ve(l).localeCompare(ve(d),"ar",{sensitivity:"base"})),tt(),r}async function vi(e){if(!e)throw new Error("Position id is required");return await U(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Y=Y.filter(t=>t.id!==Number(e)),tt(),le()}const lt="__ART_RATIO_TECH_SUB_TAB__",Pn=["technicians-management","technicians-positions"];let j=null,Gt=!1,Qe=!1,we="",ut=!1,te=null,he="technicians-management";const Yt=Si();Yt&&(he=Yt);async function Nn({showToastOnError:e=!0}={}){if(!Qe){Qe=!0,we="",V();try{await It(),ut=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),we=et(t)?t.message:m("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&P(we,"error")}finally{Qe=!1,V()}}}function vn(){return fn()}function Oe(e=""){return I(String(e)).trim().toLowerCase()}function Jt(e){return e==null?"":String(e)}function Se(e=""){return I(String(e)).replace(/[^0-9+]/g,"")}function O(e=""){const t=I(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...i]=t.split(".");return`${n}.${i.join("")}`}function Ne(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const i=e.selectionEnd;e.value=n,i!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function Si(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(lt);return e&&Pn.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function Ci(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Pn.includes(e)){window.localStorage.removeItem(lt);return}window.localStorage.setItem(lt,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function Sn(e,t=0,n=null){const i=String(e??"").trim(),o=i?An(i):null;return o?{matchedPosition:o,dailyWage:Number.isFinite(o.cost)?o.cost:0,dailyTotal:o.clientPrice==null?null:Number.isFinite(o.clientPrice)?o.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Cn(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function dt(e,t=J()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function ki(e,t=J()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function kn(){const{container:e,body:t}=Cn();!e||!t||(t.textContent="",e.hidden=!0)}function Nt(e,t={}){const{container:n,body:i}=Cn();if(!n||!i)return;const o=String(e??"").trim();if(!o){kn();return}const s=Sn(o,t?.dailyWage??0,t?.dailyTotal??null),c=Ye(s.dailyWage||0),a=s.dailyTotal!=null?Ye(s.dailyTotal):m("technicians.positionSummary.noClientPrice","â€”");s.matchedPosition?i.textContent=m("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",a):i.textContent=m("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",a),n.hidden=!1}function je(){const e=document.getElementById("technician-position-options");if(!e)return;const t=le(),n=J(),i=new Set,o=[];t.forEach(s=>{const c=dt(s,n).trim();c&&!i.has(c.toLowerCase())&&(o.push(`<option value="${fe(c)}"></option>`),i.add(c.toLowerCase()));const a=ki(s,n).trim();a&&!i.has(a.toLowerCase())&&(o.push(`<option value="${fe(a)}"></option>`),i.add(a.toLowerCase()));const r=s.name?.trim();r&&!i.has(r.toLowerCase())&&(o.push(`<option value="${fe(r)}"></option>`),i.add(r.toLowerCase()))}),e.innerHTML=o.join("")}function Zt(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),o=t.map(a=>a?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(a=>{if(!a)return;const l=a.getAttribute("data-tech-tab")===o;a.classList.toggle("tab-active",l),a.classList.toggle("active",l),a.setAttribute("aria-selected",l?"true":"false"),a.setAttribute("tabindex",l?"0":"-1")}),n.forEach(a=>{if(!a)return;const l=a.getAttribute("data-tech-tab-panel")===o;a.hidden=!l,a.classList.toggle("active",l)}),he=o,Ci(o);const c=t.find(a=>a?.getAttribute("data-tech-tab")===o)?.closest("[data-tab-scroll]");c&&c.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),o==="technicians-positions"&&(ce(),Me().then(()=>{ce()}).catch(a=>{console.error("âŒ [technicians] failed to load positions for tab switch",a),P(a?.message||m("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function vt(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",i=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=m(n,i)}function St(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=m("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function Ct(){vt(j?"update":"add"),St(!!j),V()}function Ei(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,i=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,c)=>s.localeCompare(c,"ar",{sensitivity:"base"})),o=m("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${o}</option>`+i.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&i.includes(n)?t.value=n:t.value="",t.value}function nt(){const e=document.getElementById("technician-form");e&&(e.reset(),j=null,vt("add"),St(!1),kn())}function Ti(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),i=document.getElementById("technician-role"),o=document.getElementById("technician-department"),s=document.getElementById("technician-notes");!t||!n||!i||(t.value=e.name||"",n.value=Se(e.phone||""),i.value=e.role||"",o&&(o.value=e.department||""),s&&(s.value=e.notes||""),j=String(e.id),vt("update"),St(!0),Nt(i.value,e))}function qi(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),i=document.getElementById("technician-department"),o=document.getElementById("technician-notes");if(!e||!t||!n)return null;const s=e.value.trim(),c=Se(t.value.trim());t.value=c;const a=n.value.trim(),r=i?.value.trim()||"",l="available",d=o?.value.trim()||"",u=j?Tn(j):null,{dailyWage:p,dailyTotal:g}=Sn(a,u?.dailyWage??0,u?.dailyTotal??null);return s?c?a?!Number.isFinite(p)||p<0?(P(m("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):g!=null&&(!Number.isFinite(g)||g<0)?(P(m("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(Nt(a,{dailyWage:p,dailyTotal:g}),{name:s,phone:c,role:a,department:r,dailyWage:Number.isFinite(p)?p:0,dailyTotal:g==null?null:Number(g),status:l,baseStatus:l,notes:d}):(P(m("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),n.focus(),null):(P(m("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(P(m("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function Li(e){e.preventDefault();try{await Me()}catch(i){console.error("âŒ [technicians] failed to load positions before submit",i);const o=i?.message||m("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(o,"error");return}const t=qi();if(!t)return;const n=hn({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{j?(await gn(j,n),P(m("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await yi(n),P(m("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),nt(),V()}catch(i){console.error("âŒ [technicians] handleTechnicianSubmit failed",i);const o=et(i)?i.message:m("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(o,"error")}}function Fi(){nt()}function Bi(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=Se(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const i=O(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==i&&(t.wage.value=i);const o=O(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==o&&(t.total.value=o);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),Ne(t.phone,Se),Ne(t.wage,O),Ne(t.total,O)}function Di(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),i=document.getElementById("edit-technician-role"),o=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),c=document.getElementById("edit-technician-total"),a=document.getElementById("edit-technician-status"),r=document.getElementById("edit-technician-notes");if(!e||!t||!n||!i||!s||!c||!a)return null;const l=e.value.trim(),d=t.value.trim(),u=Se(n.value.trim());n.value=u;const p=i.value.trim(),g=o?.value.trim()||"",y=O(s.value.trim());s.value=y;const _=y===""?0:parseFloat(y),h=O(c.value.trim());c.value=h;const b=h===""?null:parseFloat(h),A=a.value||"available",C=r?.value.trim()||"";return l?d?u?p?Number.isNaN(_)||_<0?(P(m("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),s.focus(),null):b!=null&&(Number.isNaN(b)||b<0)?(P(m("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),c.focus(),null):{id:l,name:d,phone:u,role:p,department:g,dailyWage:Number.isFinite(_)?_:0,dailyTotal:b==null?null:Number(b),status:A,baseStatus:A,notes:C}:(P(m("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),i.focus(),null):(P(m("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(P(m("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(P(m("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function wi(){const e=Di();if(!e)return;const t=hn({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await gn(e.id,t),P(m("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),V()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const i=et(n)?n.message:m("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");P(i,"error")}}function V(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Oe(t?.value||"");if(Qe&&!ut){const l=m("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}if(we&&!ut){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${we}</td></tr>`;return}const i=Ln(),{reservations:o=[]}=M(),s=new Date;Ei(i);const c=document.getElementById("technician-role-filter"),a=Oe(c?.value||""),r=i.filter(l=>a&&Oe(l.role||"")!==a?!1:n?Oe([l.name,l.phone,l.role,l.department,l.notes].filter(Boolean).join(" ")).includes(n):!0);if(r.length===0){const l=m("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}e.innerHTML=r.map(l=>{const d=j&&String(j)===String(l.id),g=(qn(l.id,o,s)?"busy":l.status||l.baseStatus||"available")==="busy"?{label:m("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:m("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},y=m("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),_=m("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),h=mn(),b=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${l.id}">${y}</button>`];return h&&b.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${l.id}">${_}</button>`),`
      <tr${d?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${l.id}" class="text-decoration-none">${l.name}</a></td>
        <td>${l.role||""}</td>
        <td>${l.department||"â€”"}</td>
        <td><span class="${g.className}"><span class="technician-status-badge__text">${g.label}</span></span></td>
        <td class="table-notes-cell">${l.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${b.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function it(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function En(e="add"){const{submitBtn:t,cancelBtn:n}=it(),i=e==="update";if(t){const o=i?"positions.form.actions.update":"positions.form.actions.submit",s=i?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=m(o,s)}n&&(n.classList.toggle("d-none",!i),n.textContent=m("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function kt(){const{form:e,idInput:t,nameArInput:n,nameEnInput:i,costInput:o,clientPriceInput:s}=it();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),i&&(i.value=""),o&&(o.value=""),s&&(s.value=""),te=null,En("add")}function $i(e){const{idInput:t,nameArInput:n,nameEnInput:i,costInput:o,clientPriceInput:s}=it();!e||!o||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),i&&(i.value=e.labelEn||""),o.value=O(e.cost??0),s&&(s.value=e.clientPrice==null?"":O(e.clientPrice)),te=e.id||null,En("update"))}function Ri(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:i}=it();if(!n)return null;const o=e?.value.trim()||"",s=t?.value.trim()||"",c=s||o,a=te?le().find(p=>String(p.id)===String(te)):null,r=O(n.value.trim());n.value=r;const l=r===""?0:parseFloat(r),d=i?O(i.value.trim()):"";i&&(i.value=d);const u=d===""?null:parseFloat(d);return c?!Number.isFinite(l)||l<0?(P(m("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):u!=null&&(!Number.isFinite(u)||u<0)?(P(m("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),i?.focus(),null):{id:te,name:a?.name||c,cost:Number(l.toFixed(2)),clientPrice:u==null?null:Number(u.toFixed(2)),labelAr:o||null,labelEn:s||null}:(P(m("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function Ce(){const e=document.getElementById("technician-role");if(!e)return;const t=j?Tn(j):null;Nt(e.value,t||{})}function ce(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=le();if(t&&(t.textContent=I(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${m("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(i=>{const o=te&&String(te)===String(i.id),s=Ye(i.cost||0),c=i.clientPrice==null?m("technicians.positionSummary.noClientPrice","â€”"):Ye(i.clientPrice),a=dt(i,"ar")||"â€”",r=dt(i,"en")||"â€”",l=m("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),d=m("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${o?' class="technician-table-row-editing"':""}>
        <td>${fe(a)}</td>
        <td>${fe(r)}</td>
        <td>${fe(s)}</td>
        <td>${fe(c)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${i.id}">${l}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${i.id}">${d}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function zi(e){e.preventDefault();const t=Ri();if(t)try{const n=!!te;n?await Ni(t.id,t):await Pi(t);const i=n?m("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):m("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");P(i),kt(),ce(),je(),Ce()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const i=n?.message||m("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(i,"error")}}function xi(){kt()}async function Mi(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Me();const i=le().find(o=>String(o.id)===String(n));if(!i){P(m("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}$i(i),ce();return}if(t.classList.contains("position-delete-btn")){if(!confirm(m("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await vi(n),te&&String(te)===String(n)&&kt(),P(m("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),ce(),je(),Ce()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||m("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(n,"error")}}function ji(e){const t=vn().find(n=>String(n.id)===String(e));if(!t){P(m("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}Ti(t),P(m("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function Hi(e){if(!mn()){gi();return}if(confirm(m("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await bi(e),P(m("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),j&&String(j)===String(e)&&nt(),V()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=et(t)?t.message:m("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");P(n,"error")}}function Ga(){Et(),V()}function Tn(e){return vn().find(t=>String(t.id)===String(e))||null}function qn(e,t=[],n){const i=Jt(e);return i?t.some(o=>{if(!o||!o.start||!o.end||!(Array.isArray(o.technicians)?o.technicians:[]).some(r=>Jt(r)===i))return!1;const c=new Date(o.start),a=new Date(o.end);return Number.isNaN(c.getTime())||Number.isNaN(a.getTime())?!1:c<=n&&n<a}):!1}function Ln(){const e=M().reservations||[],t=fn();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let i=!1;const o=t.map(s=>{if(!s)return s;const c=s.baseStatus||s.status||"available";let a=c==="busy"?"busy":c;return qn(s.id,e,n)&&(a="busy"),(a!==s.status||c!==s.baseStatus)&&(i=!0),{...s,baseStatus:c,status:a}});return i?(xe(o),o):t}function Et(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{Li(p).catch(g=>{console.error("âŒ [technicians] submit handler failed",g)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Fi),n.dataset.listenerAttached="true"),Ne(document.getElementById("technician-phone"),Se);const i=document.getElementById("technician-role");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{Ce()}),i.dataset.listenerAttached="true");const o=document.getElementById("technicians-table");o&&!o.dataset.listenerAttached&&(o.addEventListener("click",p=>{const g=p.target;if(g instanceof HTMLElement){if(g.classList.contains("technician-edit-btn")){const y=g.dataset.id;ji(y)}if(g.classList.contains("technician-delete-btn")){const y=g.dataset.id;Hi(y).catch(_=>{console.error("âŒ [technicians] delete handler failed",_)})}}}),o.dataset.listenerAttached="true");const s=document.getElementById("search-technician-input");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=I(s.value),V()}),s.dataset.listenerAttached="true");const c=document.getElementById("technician-role-filter");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{V()}),c.dataset.listenerAttached="true");const a=document.getElementById("save-technician-changes");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{wi().catch(p=>{console.error("âŒ [technicians] modal save failed",p)})}),a.dataset.listenerAttached="true");const r=document.getElementById("position-form");r&&!r.dataset.listenerAttached&&(r.addEventListener("submit",p=>{zi(p).catch(g=>{console.error("âŒ [technicians] position submit failed",g)})}),r.dataset.listenerAttached="true");const l=document.getElementById("position-cancel-btn");l&&!l.dataset.listenerAttached&&(l.addEventListener("click",xi),l.dataset.listenerAttached="true");const d=document.getElementById("positions-table");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",Mi),d.dataset.listenerAttached="true"),Ne(document.getElementById("position-cost"),O),Ne(document.getElementById("position-client-price"),O);const u=document.querySelector("[data-tech-tabs]");u&&!u.dataset.listenerAttached&&(u.querySelectorAll("[data-tech-tab]").forEach(g=>{g&&g.addEventListener("click",()=>{const y=g.getAttribute("data-tech-tab");Zt(y)})}),u.dataset.listenerAttached="true"),Zt(he),Me().then(()=>{je(),he==="technicians-positions"&&ce(),Ce()}).catch(p=>{console.error("âŒ [technicians] failed to load technician positions",p),P(p?.message||m("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),Gt||(document.addEventListener("technician:prefill",p=>{const g=p.detail;g&&Bi(g)}),Gt=!0),t&&nt(),he==="technicians-positions"&&ce()}window.addEventListener("DOMContentLoaded",()=>{Et(),V(),Ct(),Nn()});const Fn=()=>{V()};window.addEventListener("technicians:updated",Fn);document.addEventListener("technicians:updated",Fn);document.addEventListener("technicians:refreshRequested",()=>{Et(),V(),Ct(),Nn({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Ct(),je(),he==="technicians-positions"&&ce(),Ce()});document.addEventListener(fi.USER_UPDATED,()=>{V()});const Bn=()=>{je(),he==="technicians-positions"&&ce(),Ce()};window.addEventListener("technicianPositions:updated",Bn);document.addEventListener("technicianPositions:updated",Bn);function Be(e){return I(String(e||"")).trim().toLowerCase()}function Z(e){const t=String(e??"").trim().toLowerCase();return t||""}function Dn(){const{packages:e=[]}=M();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function Je(e){const t=Z(e);return t&&Dn().find(i=>Z(i?.id??i?.packageId??i?.package_id)===t)||null}function ye(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(a=>({barcode:a}))),n.forEach(a=>{if(!a)return;if(typeof a=="string"||typeof a=="number"){const p=Be(a);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof a!="object")return;const r=Be(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number),l=[a.equipmentId,a.equipment_id,a.itemId,a.item_id,a.id].find(p=>p!=null&&p!==""),d=[a.unit_price,a.unitPrice,a.price,a.daily_rate].find(p=>Number.isFinite(Number(p))),u=[a.quantity,a.qty,a.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:l!=null?String(l):null,barcode:a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??"",normalizedBarcode:r,qty:u!=null?Number(u):1,price:d!=null?Number(d):0,desc:a.description??a.desc??a.name??"",image:a.image??a.imageUrl??a.img??null})});const i=new Map,{equipment:o=[]}=M()||{},s=new Map,c=new Map;return(Array.isArray(o)?o:[]).forEach(a=>{if(!a||typeof a!="object")return;[a.id,a.equipment_id,a.equipmentId,a.item_id,a.itemId].map(d=>d!=null?String(d):"").filter(Boolean).forEach(d=>{s.has(d)||s.set(d,a)});const l=Be(a.barcode);l&&!c.has(l)&&c.set(l,a)}),t.forEach(a=>{if(a.equipmentId&&s.has(a.equipmentId)){const r=s.get(a.equipmentId);if(r){if(a.desc||(a.desc=r.desc||r.description||r.name||""),a.barcode||(a.barcode=r.barcode||""),a.price==null||a.price===0){const l=r.price??r.unit_price,d=Number(l);Number.isFinite(d)&&d>=0&&d<1e6&&(a.price=d)}a.image||(a.image=r.image||r.imageUrl||r.img||null)}}else if(a.normalizedBarcode&&c.has(a.normalizedBarcode)){const r=c.get(a.normalizedBarcode);if(r){if(a.desc||(a.desc=r.desc||r.description||r.name||""),a.barcode||(a.barcode=r.barcode||""),a.price==null||a.price===0){const l=r.price??r.unit_price,d=Number(l);Number.isFinite(d)&&d>=0&&d<1e6&&(a.price=d)}a.image||(a.image=r.image||r.imageUrl||r.img||null)}}}),t.forEach(a=>{const r=a.normalizedBarcode||(a.barcode?Be(a.barcode):""),l=r||(a.equipmentId?`id:${a.equipmentId}`:null);if(!l)return;if(!i.has(l)){i.set(l,{...a,normalizedBarcode:r});return}const d=i.get(l);d.qty+=a.qty,!d.price&&a.price&&(d.price=a.price),!d.desc&&a.desc&&(d.desc=a.desc),!d.image&&a.image&&(d.image=a.image)}),Array.from(i.values())}function Vi(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const i of t){const o=Number(i);if(Number.isFinite(o))return o}return ye(e).reduce((i,o)=>i+(o.price||0)*(o.qty||1),0)}function Oi(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Ui(){return Dn().map(t=>{const n=Z(t?.id??t?.packageId??t?.package_id??t?.code),i=Oi(t)||n||"package",o=Vi(t);return{id:n,name:i,price:o,code:t?.package_code??t?.code??n,items:ye(t),raw:t}}).filter(t=>t.id)}function Ki(e){const t=Be(e);return t?Ui().filter(n=>n.items.some(i=>i.normalizedBarcode===t)):[]}function Qi(e){return ye(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let ke=[],wn=[],$n=[],Rn="single";function Ya(){return ke}function Ja(e){ke=Array.isArray(e)?e:[]}function Za(e){ke=[...ke,e]}function Xa(e){Number.isInteger(e)&&e>=0&&(ke=ke.filter((t,n)=>n!==e))}function eo(){return wn}function to(e){wn=Array.isArray(e)?e:[]}function no(){return $n}function io(e){$n=Array.isArray(e)?e:[]}function ao(e){}function oo(){return Rn==="package"?"package":"single"}function so(e){Rn=e==="package"?"package":"single"}function co(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[i="",o=""]=n.split("T"),s=i?i.slice(0,10):"",c=o.match(/(\d{1,2}:\d{2})/);let a="";if(c){const[r="00",l="00"]=c[0].split(":");a=`${r.padStart(2,"0")}:${l.padStart(2,"0")}`}return{date:s,time:a}}function Ue(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function W(e){return I(String(e||"")).trim().toLowerCase()}const Wi=864e13;function ae(e){if(!e&&e!==0)return null;if(e instanceof Date){const i=e.getTime();return Number.isNaN(i)?null:new Date(i)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const i=new Date(e);return Number.isNaN(i.getTime())?null:i}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const o=new Date(i);if(!Number.isNaN(o.getTime()))return o}}if(!t.includes("T")&&t.includes(" ")){const i=t.indexOf(" ");t=`${t.slice(0,i)}T${t.slice(i+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const i=new Date(`${t}Z`);if(!Number.isNaN(i.getTime()))return i}return null}function ro(e,t,n,i=null){if(!e||!t||!n)return!1;const o=ae(t),s=ae(n);if(!o||!s||o>=s)return!1;const c=W(e);if(!c)return!1;const a=M()||{},r=Array.isArray(a.reservations)?a.reservations:[],l=Array.isArray(a.maintenance)?a.maintenance:[],d=Array.isArray(a.equipment)?a.equipment:[],u=aa(d),p=Lt(i);return r.some(y=>{if(!y||Ft(y,p)||!y.start||!y.end)return!1;const _=ae(y.start),h=ae(y.end);return!_||!h||!(_<s&&h>o)?!1:Yi(y,c)})?!0:l.some(y=>{if(!Xi(y)||!ta(y,u).has(c))return!1;const{start:h,end:b}=na(y);if(!h&&!b)return!0;const A=h??new Date(0),C=b??new Date(Wi);return A<s&&C>o})}function Gi(e,t,n,i=null){const o=Z(e);if(!o||!t||!n)return!1;const s=ae(t),c=ae(n);if(!s||!c||s>=c)return!1;const a=M()||{},r=Array.isArray(a.reservations)?a.reservations:[],l=Lt(i);return r.some(d=>{if(!d?.start||!d?.end||Ft(d,l))return!1;const u=ae(d.start),p=ae(d.end);return!u||!p||!(u<c&&p>s)?!1:Ji(d,o)})}function lo(e,t,n,i=null){const o=W(e);if(!o||!t||!n)return[];const s=Ki(o);return s.length?s.filter(c=>Gi(c.id,t,n,i)):[]}function zn(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(i=>{const o=e[i];Array.isArray(o)&&o.length&&t.push(o)}),t}function Yi(e,t){if(!t||!e||typeof e!="object")return!1;const n=W(e?.barcode);if(n&&n===t)return!0;const i=zn(e);for(const o of i)for(const s of o)if(Zi(s).has(t))return!0;return!1}function Ji(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const s of n){if(!s&&s!==0)continue;const c=Z(s);if(c&&c===t)return!0}const i=e.packages;if(Array.isArray(i))for(const s of i){const c=Z(s);if(c&&c===t)return!0}const o=zn(e);for(const s of o)for(const c of s)if(Tt(c).has(t))return!0;return!1}function Zi(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const s=W(e);return s&&t.add(s),t}if(typeof e!="object")return t;const n=W(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(s=>{const c=e[s];Array.isArray(c)&&c.forEach(a=>{if(a!=null){if(typeof a=="string"||typeof a=="number"){const r=W(a);r&&t.add(r);return}if(typeof a=="object"){const r=W(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number);r&&t.add(r)}}})});const o=Tt(e);return o.size&&o.forEach(s=>{const c=Je(s);if(!c)return;Qi(c).forEach(r=>{const l=r.normalizedBarcode??W(r.barcode);l&&t.add(l)})}),t}function Tt(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(i=>{const o=Z(i);o&&t.add(o)}),e.package&&typeof e.package=="object"&&Tt(e.package).forEach(o=>t.add(o)),Array.isArray(e.packages)&&e.packages.forEach(i=>{const o=Z(i);o&&t.add(o)}),t}function Xi(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(ia(e))return!1;for(const n of t){const i=ea(n);if(i){if(i==="completed"||i==="cancelled"||i==="closed")return!1;if(i==="open"||i==="in_progress")return!0}}return!0}function ea(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function ta(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(c=>{const a=W(c);a&&n.add(a)});const o=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(o){const c=W(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number);c&&n.add(c)}return[e?.equipmentId,e?.equipment_id,o?.id,o?.equipmentId,o?.equipment_id].map(c=>c!=null?String(c):"").filter(Boolean).forEach(c=>{const a=t.get(c);if(!a)return;const r=W(a?.barcode??a?.equipmentBarcode??a?.code??a?.serial??a?.serialNumber??a?.serial_number);r&&n.add(r)}),n}function na(e){const t=pt([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=pt([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function ia(e){return!!pt([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function pt(e=[]){for(const t of e){const n=ae(t);if(n)return n}return null}function aa(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(o=>o!=null?String(o):"").filter(Boolean).forEach(o=>{t.has(o)||t.set(o,n)})}),t}function qt(e,t,n,i=null){if(!e||!t||!n)return!1;const o=new Date(t),s=new Date(n);if(Number.isNaN(o.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:c=[]}=M(),a=String(e),r=Lt(i);return c.some(l=>{if(!l?.start||!l?.end||Ft(l,r))return!1;const d=new Date(l.start),u=new Date(l.end);return Number.isNaN(d.getTime())||Number.isNaN(u.getTime())||!(d<s&&u>o)?!1:(Array.isArray(l.technicians)?l.technicians:[]).some(y=>String(y)===a)})}function Lt(e){return Ae(e,new Set)}function Ft(e,t){if(!t||t.size===0)return!1;const n=Ae([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const i of n)if(t.has(i))return!0;return!1}function Ae(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(s=>Ae(s,t)),t;if(Array.isArray(e))return e.forEach(s=>Ae(s,t)),t;if(typeof e=="object"){const s=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return s.forEach(a=>{Object.prototype.hasOwnProperty.call(e,a)&&(c=!0,Ae(e[a],t))}),c||Object.values(e).forEach(a=>Ae(a,t)),t}const n=I(String(e??"")).trim();if(!n)return t;const i=[n,n.toLowerCase(),n.toUpperCase()],o=n.replace(/\D+/g,"");if(o){i.push(o);const s=Number.parseInt(o,10);Number.isNaN(s)||i.push(String(s))}return i.forEach(s=>{s&&t.add(s)}),t}const oa=()=>m("reservations.create.summary.currency","SR");let Ee=[],de=[],oe=[],se=[],w="create",xn=()=>{},Mn=()=>{};const We=new Map,mt=450;function sa(e){const t=We.get(e);return t!=null&&Date.now()-t<mt}function ca(e){We.set(e,Date.now()),setTimeout(()=>{const t=We.get(e);t!=null&&Date.now()-t>=mt&&We.delete(e)},mt+50)}function $e(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function be(e={}){return{...e,assignmentId:e.assignmentId||$e()}}function at(e){if(!e)return null;const t=String(e),n=Ee.find(o=>String(o?.id)===t);if(n)return{...n};const{technicians:i=[]}=M();return i.find(o=>String(o?.id)===t)||null}function Re(e={},t=J()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Bt(e={},t=J()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function jn(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=de.find(s=>String(s.id).trim().toLowerCase()===n);if(i)return i;const o=An(e);return o||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function Xt(e){const t=jn(e,e?.name??""),n=J(),i=Re(t,n)||t?.name||"",o=Bt(t,n);return ft({assignmentId:$e(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:o,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function ft(e={}){const t={assignmentId:e.assignmentId||$e(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=jn(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=J(),o=Re(n,i)||t.positionLabel,s=Bt(n,i);t.positionLabel=o||t.positionLabel||n?.name||"",t.positionLabelAlt=s||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=at(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function ot(){de=le()}function ra(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return be(ft(t));const n=at(t),i=n?{assignmentId:$e(),positionLabel:n.role||m("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:$e(),positionLabel:m("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return be(ft(i))}).filter(Boolean):[]}function pe(e="create"){return e==="edit"?se.map(be):oe.map(be)}function re(e="create",t=[]){const n=ra(t);e==="edit"?(se=n,Te("edit-selected-technicians-list",se,"edit"),Mn()):(oe=n,Te("selected-technicians-list",oe,"create"),xn()),ze()}function Dt(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),r=document.getElementById("edit-res-end")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",u=a?Ue(a,l):null,p=r?Ue(r,d):null;let g=null;const y=document.getElementById("edit-res-index")?.value;if(y!=null){const _=Number.parseInt(y,10);if(Number.isInteger(_)){const{reservations:h=[]}=M(),b=h?.[_];b&&(g=b.id??b.reservationId??null)}}return{start:u,end:p,ignoreReservationId:g}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",o=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?Ue(t,i):null,c=n?Ue(n,o):null;return{start:s,end:c,ignoreReservationId:null}}function ze(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=pe(w).length;if(t){const n=m("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",I(String(t)));e.textContent=n}else e.textContent=m("technicians.picker.selectionInfo","No crew selected yet")}function Ze(e){const t=Number.isFinite(e)?e:0;return`${I(t.toFixed(2))} ${oa()}`}function la(e){const t=pe(w),n=new Set(t.filter(l=>l.assignmentId!==e&&l.technicianId).map(l=>l.technicianId)),i=Ee.length?Ee:M().technicians||[],{start:o,end:s,ignoreReservationId:c}=Dt(w),a=!!(o&&s);return i.map(l=>{const d=String(l.id),u=n.has(d),p=a?qt(d,o,s,c):!1,g=I(l.name||l.full_name||l.fullName||l.email||d);return{id:d,label:g,disabled:u||p,conflict:p,taken:u}})}function G(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=pe(w);if(!t.length){const n=m("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=m("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}e.innerHTML=t.map((n,i)=>{const o=I(String(i+1)),s=Ze(n.positionClientPrice||0),c=la(n.assignmentId),a=m("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),r=n.technicianId!=null?String(n.technicianId):"",l=n.technicianName?I(n.technicianName):"",d=`crew-assignment-options-${n.assignmentId}`,u=m("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),p=m("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),g=c.map(b=>{const A=r===b.id,N=b.disabled&&!A?`${b.label} ${b.conflict?p:u}`:b.label;return`
        <option value="${b.label}"
                data-id="${b.id}"
                data-disabled="${b.disabled?"true":"false"}"
                data-conflict="${b.conflict?"true":"false"}"
                data-taken="${b.taken?"true":"false"}"
                label="${N}"></option>
      `}).join(""),y=n.positionLabelAlt?`<div class="text-muted small">${I(n.positionLabelAlt)}</div>`:"",_=m("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),h=m("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${o}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${I(n.positionLabel||m("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${y}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${h}">${s}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${d}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${a}"
              value="${r?l:""}"
              aria-label="${m("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${d}">
              ${g}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${_}">
            ${_}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{Hn(n.dataset.assignmentId,w)}),n.dataset.listenerAttached="true")}),ua(e)}function ua(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,o=()=>{da(n,i)};n.addEventListener("change",o),n.addEventListener("blur",o),n.dataset.listenerAttached="true"})}function da(e,t){if(!t||sa(t))return;ca(t);const n=e.value?.trim()??"";if(!n){Ke(t,"");return}const i=e.getAttribute("list"),o=i?document.getElementById(i):null,s=o?Array.from(o.options):[],c=I(n).toLowerCase(),a=s.find(l=>I(l.value).toLowerCase()===c);if(!a){P(m("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",Ke(t,"");return}if(a.dataset.disabled==="true"){a.dataset.conflict==="true"?P(m("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯")):P(m("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±")),e.value="";return}const r=a.dataset.id;if(!r){P(m("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",Ke(t,"");return}Ke(t,r)}function gt(){const e=document.getElementById("crew-position-list");if(!e)return;ot();const t=document.getElementById("crew-position-search"),n=I(String(t?.value||"")).trim().toLowerCase(),o=pe(w).reduce((a,r)=>{const l=r?.positionId!=null?String(r.positionId):null;return l&&a.set(l,(a.get(l)||0)+1),a},new Map),s=de.filter(a=>n?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(l=>I(String(l)).toLowerCase()).join(" ").includes(n):!0);if(!s.length){e.innerHTML=`<div class="text-muted">${m("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const c=J();e.innerHTML=s.map(a=>{const r=Re(a,c)||a.name||"",l=Bt(a,c),d=Ze(a.clientPrice||0),u=Ze(a.cost||0),p=l?`<span class="crew-position-card__subtitle">${I(l)}</span>`:"",g=m("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),y=m("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),_=m("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),h=o.get(String(a.id))||0,b=m("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",I(String(h)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${I(r)}">
        ${h>0?`<span class="crew-position-card__badge" aria-label="${b}">${I(String(h))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${I(r)}</h6>
            ${p}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${y}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary crew-position-add-btn" data-position-id="${a.id}">
            ${_}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",r=>{r.stopPropagation(),rt(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{rt(a.dataset.positionId)}),a.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),rt(a.dataset.positionId))}),a.dataset.cardListenerAttached="true")})}function rt(e){ot();const t=de.find(o=>String(o.id)===String(e)),n=Xt(t||{id:null,name:""}),i=pe(w);i.push(n),re(w,i),G(),P(m("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Hn(e,t="create"){if(!e)return;const n=pe(t).filter(i=>i.assignmentId!==e);re(t,n),G(),P(m("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function Ke(e,t){if(!e)return;const n=pe(w),i=n.find(l=>l.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,re(w,n),G(),P(m("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(n.find(l=>l.assignmentId!==e&&l.technicianId===t)){P(m("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),G();return}const s=at(t),{start:c,end:a,ignoreReservationId:r}=Dt(w);if(c&&a&&qt(String(t),c,a,r)){P(m("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯")),G();return}s?(i.technicianId=String(s.id),i.technicianName=s.name??null,i.technicianRole=s.role??null,i.technicianPhone=s.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),re(w,n),G(),i.technicianName?P(m("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",I(i.technicianName)),"success"):P(m("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function en(e="create"){w=e,G(),ze();let t=Ln();if(!Array.isArray(t)||t.length===0)try{const i=await It();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(Ee=t);try{await Me()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}ot(),gt(),G(),ze();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function pa(){return pe(w).map(be)}function ma(){const e=pa(),{start:t,end:n,ignoreReservationId:i}=Dt(w);if(t&&n){const s=e.filter(c=>c.technicianId&&qt(c.technicianId,t,n,i));if(s.length>0){const c=s.map(r=>r.technicianName||r.technicianId).join(m("reservations.list.crew.separator","ØŒ ")),a=m("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",c);s.forEach(r=>{r.technicianId=null,r.technicianName=null}),re(w,e),G(),P(a),ze();return}}re(w,e);const o=document.getElementById("selectTechniciansModal");o&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(o)?.hide?.(),P(m("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function Te(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${m("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}ot(),i.innerHTML=t.map(o=>{let s=o.positionLabel??o.position_label??o.position_name??o.role??o.position??"";if(!s||String(s).trim()===""){const u=o.positionId?de.find(g=>String(g.id)===String(o.positionId)):null,p=!u&&o.positionKey?de.find(g=>String(g.name).toLowerCase()===String(o.positionKey).toLowerCase()):null;s=u?Re(u,J())||u?.name||"":p&&(Re(p,J())||p?.name)||""}const c=I(s||m("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=o.technicianName?`${I(o.technicianName)}`:m("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let r=Number(o.positionClientPrice);if(!Number.isFinite(r)||r<=0){const u=[o.position_client_price,o.client_price,o.customer_price,o.daily_total,o.dailyTotal,o.total];for(const p of u){const g=Number(p);if(Number.isFinite(g)&&g>0){r=g;break}}}if((!Number.isFinite(r)||r<=0)&&(o.positionId||o.positionKey)){const u=o.positionId?de.find(y=>String(y.id)===String(o.positionId)):null,p=!u&&o.positionKey?de.find(y=>String(y.name).toLowerCase()===String(o.positionKey).toLowerCase()):null,g=u||p||null;g&&Number.isFinite(Number(g.clientPrice))&&(r=Number(g.clientPrice))}const l=Ze(Number.isFinite(r)&&r>0?r:0),d=m("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${o.assignmentId}">
        <span class="technician-chip-name">${c}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${l}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${o.assignmentId}" aria-label="${d}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",()=>{Hn(o.dataset.assignmentId,o.dataset.context)}),o.dataset.listenerAttached="true")})}}function fa(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",c=>{const a=document.getElementById("res-customer")?.value?.trim(),r=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),d=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),p=!!(r&&l),g=!!(d&&u),y=!!a;if(!p||!g){c.preventDefault(),P(m("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!y){c.preventDefault(),P(m("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}en("create")}),e.dataset.listenerAttached="true";const s=()=>{const c=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),r=document.getElementById("res-end")?.value?.trim(),l=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),u=!!(c&&a&&r&&l&&d);e.setAttribute("aria-disabled",String(!u)),e.dataset.ready=u?"true":"false",e.classList.toggle("is-disabled",!u)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(c=>document.getElementById(c)).filter(Boolean).forEach(c=>{["input","change"].forEach(a=>c.addEventListener(a,s))}),s()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>en("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{gt()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",ma),i.dataset.listenerAttached="true");const o=document.getElementById("selectTechniciansModal");o&&!o.dataset.listenerAttached&&window.bootstrap?.Modal&&(o.addEventListener("shown.bs.modal",async()=>{if(!Ee.length&&(!M().technicians||M().technicians.length===0))try{await It()}catch(s){console.warn("[crew-picker] fetch on show failed",s)}gt(),G(),ze()}),o.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("crew-position-search");s&&(s.value="")}),o.dataset.listenerAttached="true"),Te("selected-technicians-list",oe,"create"),Te("edit-selected-technicians-list",se,"edit")}function uo({onDraftChange:e,onEditChange:t}={}){xn=typeof e=="function"?e:()=>{},Mn=typeof t=="function"?t:()=>{},fa()}function ga(){return oe.map(be)}function ha(){return se.map(be)}function tn(){return oe.map(e=>e.technicianId).filter(Boolean).map(String)}function nn(){return se.map(e=>e.technicianId).filter(Boolean).map(String)}function po(e=[]){re("edit",e)}function mo(){re("create",[])}function fo(){re("edit",[])}function an(e=[]){return e.map(t=>{if(t.technicianId){const n=at(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function go(e=[]){Array.isArray(e)&&e.length&&(Ee=e),oe=an(oe),se=an(se),Te("selected-technicians-list",oe,"create"),Te("edit-selected-technicians-list",se,"edit"),G()}function on(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Vn(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=I(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),o=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const s=t.includes(","),c=t.includes(".");if(s&&c){const r=t.lastIndexOf(","),l=t.lastIndexOf(".");r>l?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(s){const r=t.split(",");r.length===2&&r[1].length===3?t=r.join(""):t=t.replace(/,/g,".")}else if(c){const r=t.split(".");if(r.length===2){const[,l]=r;if(l.length===3){const d=r.join("");/^[0-9]+$/.test(d)&&(t=d)}}else r.length>2&&(t=on(t))}if(t=t.replace(/,/g,""),t=on(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const a=Number.parseFloat(t);return Number.isFinite(a)?o?-a:a:Number.NaN}function D(e){return Vn(e)}function z(e){const t=Vn(e);if(!Number.isFinite(t))return 0;let n=t,i=0;for(;Math.abs(n)>1e5&&i<8;)n/=10,i+=1;return Number(n.toFixed(2))}function De(e){return I(String(e??"")).trim().toLowerCase()}function On(e=""){return I(String(e)).trim().toLowerCase()}const ya=2;function ba(e){const t=D(e);return Number.isFinite(t)?t.toFixed(ya):"0.00"}function sn(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(I(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return z(i)}return 1}function _a(e={}){const t=e?.desc||e?.description||e?.name||"",n=On(t),i=ba(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function Ia(e=[]){const t=new Map;return e.forEach((n,i)=>{const o=_a(n);if(!o)return;if(!t.has(o)){const c=n?.desc||n?.description||n?.name||"",a=On(c),r=rn(n),l=n?.image||n?.imageUrl||n?.img||"";t.set(o,{key:o,description:c,normalizedDescription:a,unitPrice:r,image:l,items:[],itemIndices:[],barcodes:[]})}const s=t.get(o);s.items.push(n),s.itemIndices.push(i),n?.barcode&&s.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,o)=>i+sn(o),0)})).map(n=>{const i=n.quantity||0,o=n.items.reduce((l,d)=>{const u=rn(d),p=sn(d);return l+u*p},0),s=z(o),c=D(n.unitPrice),a=Number.isFinite(c)?c:0,r=i>0?z(s/i):z(a);return{...n,quantity:i,count:i,totalPrice:s,unitPrice:r}})}function cn(e={}){return(ye(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??De(n?.barcode),qty:(()=>{const i=Number.parseFloat(I(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),price:(()=>{const i=D(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})()}))}function ht(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(I(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function Aa(e={},t=[],n=null){const i=e.unit_price??e.unitPrice??e.price,o=D(i);if(Number.isFinite(o)&&o>0)return z(o);const s=e.total_price??e.totalPrice??e.total,c=D(s),a=Number.parseFloat(I(String(n)).replace(/[^0-9.]/g,"")),r=Number.isFinite(a)&&a>0?a:ht(e);if(Number.isFinite(c)&&c>0&&r>0)return z(c/r);if(Array.isArray(t)&&t.length){const l=t.reduce((d,u)=>{const p=D(u.price??u.unit_price??u.unitPrice),g=Number.parseFloat(I(String(u.qty??u.quantity??1)).replace(/[^0-9.]/g,"")),y=Number.isFinite(g)&&g>0?g:1;return d+p*y},0);if(l>0&&r>0)return z(l/r)}return 0}function ho(e={}){const t=Array.isArray(e?.items)?e.items:[],n=Ia(t),i=new Map,o=(u,p=0,g="packages")=>{if(!u||typeof u!="object")return;const _=Z(u?.package_code??u?.packageId??u?.package_id??u?.code??u?.id??u?.barcode??`pkg-${p}`)||`pkg-${p}`;if(!i.has(_)){i.set(_,{source:u,normalizedId:_,index:p,itemSource:g==="items"?u:null});return}const h=i.get(_);if(h.source||(h.source=u),g==="items"&&(h.itemSource=u,h.source&&typeof h.source=="object")){const b=Array.isArray(h.source.packageItems)&&h.source.packageItems.length>0,A=Array.isArray(u.packageItems)&&u.packageItems.length>0;!b&&A&&(h.source={...h.source,packageItems:u.packageItems}),!h.source.image&&u.image&&(h.source={...h.source,image:u.image})}};Array.isArray(e?.packages)&&e.packages.forEach((u,p)=>o(u,p,"packages")),t.forEach((u,p)=>{u&&typeof u=="object"&&(u.type==="package"||Array.isArray(u?.packageItems))&&o(u,p+i.size,"items")});const s=[],c=new Set,a=new Set;i.forEach(({source:u,itemSource:p=null,normalizedId:g},y)=>{const _=u||{},h=p&&typeof p=="object"?p:null;let b=cn(_);(!Array.isArray(b)||b.length===0)&&h&&(b=cn(h)),b.forEach(S=>{const v=S?.normalizedBarcode??De(S?.barcode);v&&c.add(v);const R=S?.equipmentId??S?.equipment_id??null;R!=null&&a.add(String(R))});let A=ht(_);if(h){const S=ht(h);Number.isFinite(S)&&S>0&&(A=S)}(!Number.isFinite(A)||A<=0)&&(A=1);let C=Aa(_,b,A);const N=[h?.price,h?.unit_price,h?.unitPrice];for(const S of N){const v=D(S);if(Number.isFinite(v)&&v>0){C=z(v);break}}C=z(C);const E=[h?.total,h?.total_price,h?.totalPrice,_?.total,_?.total_price,_?.totalPrice];let k=NaN;for(const S of E){const v=D(S);if(Number.isFinite(v)&&v>=0){k=v;break}}Number.isFinite(k)||(k=C*A),k=z(k);const F=[_?.displayCode,_?.display_code,_?.package_code,_?.packageCode,_?.code,_?.barcode,_?.packageId,_?.package_id,h?.displayCode,h?.display_code,h?.package_code,h?.packageCode,h?.code,h?.barcode,h?.packageId,h?.package_id,g,y].find(S=>S==null?!1:String(S).trim().length>0),B=F!=null?I(String(F)).trim():"";if(B){const S=De(B);S&&c.add(S)}const $=b.map(S=>I(String(S?.barcode??S?.normalizedBarcode??""))).filter(Boolean),H=[_?.name,_?.package_name,_?.title,h?.name,h?.desc,h?.package_name,B,I(String(y))].find(S=>S!=null&&String(S).trim()!=="")||I(String(B||y)),K=b.find(S=>S?.image)?.image??_?.image??h?.image??null;s.push({key:`package::${y}`,description:H,normalizedDescription:I(String(H)),unitPrice:C,totalPrice:k,quantity:A,count:A,image:K,barcodes:$,barcode:B,package_code:B,packageDisplayCode:B,items:[{type:"package",packageItems:b,packageId:g,desc:H,price:C,qty:A,barcode:B}],type:"package",packageItems:b,packageId:g})});const r=new Set(Array.from(c).map(u=>De(u)).filter(Boolean)),l=n.filter(u=>!(u.items.some(y=>y?.type==="package")&&s.length>0||u.items.every(y=>{const _=Pa(y),h=_!=null?String(_):null;if(h&&a.has(h))return!0;const b=y?.barcode?De(y.barcode):null;return!!(b&&r.has(b))})));return{groups:s.length?[...s,...l]:n,packageGroups:s,groupedItems:n,filteredGroupedItems:l,packagesMap:i}}function Pa(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function rn(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=D(n);if(Number.isFinite(i))return i}return 0}function yo(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Na(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function bo(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,o=i!=null&&i!==""&&i!=="null",s=o?Na(t?.status??t?.status_label??t?.statusLabel??""):null,c=o&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:n,projectLinked:o,projectStatus:s,projectConfirmed:c,effectiveConfirmed:o?c:n}}const Un=10;function Kn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=D(n);if(Number.isFinite(i))return z(i)}return 0}function va(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=D(n);if(Number.isFinite(i))return z(i)}return Kn(e)}function Sa(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=M();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,o)=>{const s=n.get(String(o));if(!s)return i;const c=Kn(s),a=va(s);return{costPerDay:i.costPerDay+(Number.isFinite(c)?c:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const Ca=1440*60*1e3,Pe=.01;function Ie(e){if(e==null||e==="")return null;const t=I(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function ln(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let o=Number.isFinite(e)?e:0;if(o<t&&(o=t),o>n&&(o=n),i!=null){const s=10**i;o=Math.round(o*s)/s}return o}function Qn(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function wt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:o=null,history:s=[]}={}){const c=Number.isFinite(Number(e))?Number(e):0,a=t==="amount"?"amount":t==="percent"?"percent":null;let r=Ie(i),l=Ie(o);const d=Ie(n);let u=0,p=0;Array.isArray(s)&&s.length&&s.forEach(A=>{if(!A)return;const C=A.type==="amount"||A.type==="percent"?A.type:null,N=Ie(A.value),E=Ie(A.amount),k=Ie(A.percentage);if(C==="amount"){const L=E??N;L!=null&&(u+=L,c>0&&(p+=L/c*100))}else if(C==="percent"){const L=k??N;L!=null&&(p+=L,c>0&&(u+=L/100*c))}else E!=null&&(u+=E,c>0&&(p+=E/c*100)),k!=null&&(p+=k,c>0&&(u+=k/100*c))});function g(A=[]){return!Array.isArray(A)||A.length===0?{costPerDay:0,totalPerDay:0}:A.reduce((C,N)=>{const E=D(N?.positionCost??N?.position_cost??N?.cost??N?.dailyWage??N?.daily_wage??0),k=D(N?.positionClientPrice??N?.position_client_price??N?.clientPrice??N?.dailyTotal??N?.daily_total??N?.total??0),L=Number.isFinite(E)?E:0,F=Number.isFinite(k)?k:0;return{costPerDay:C.costPerDay+L,totalPerDay:C.totalPerDay+F}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=g),a==="amount"&&d!=null?r=d:a==="percent"&&d!=null?l=d:a===null&&d!=null&&(l!=null?l=d:r=d),(r==null||r<=0)&&l!=null&&l>0&&c>0&&(r=c*(l/100)),(l==null||l<=0)&&r!=null&&r>0&&c>0&&(l=r/c*100);const y=r??0,_=l??0;r=y+u,l=_+p,r=ln(r??0,{min:0,max:c>0?c:Number.POSITIVE_INFINITY,precision:2}),l=ln(l??0,{min:0,max:100,precision:2});let h=a;return h||(r>0&&c>0?h="amount":l>0&&(h="percent")),{paidAmount:r,paidPercent:l,paymentProgressType:h,paymentProgressValue:h==="amount"?r:h==="percent"?l:null}}function $t({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const o=Qn(e),s=Number.isFinite(Number(i))?Number(i):0,c=Number.isFinite(Number(t))?Number(t):0,a=Number.isFinite(Number(n))?Number(n):0;if(o==="paid")return"paid";const r=s>0&&c>=s-Pe,l=a>=100-Pe*100;if(r||l)return"paid";const d=c>Pe||a>Pe;return o==="partial"||d?"partial":"unpaid"}function ka(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const o=i.getTime()-n.getTime();if(o<=0)return 1;const s=o/Ca;return Math.max(1,Math.ceil(s))}function qe({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:o="percent",applyTax:s=!1,start:c=null,end:a=null,companySharePercent:r=null}={}){const l=ka(c,a),d=(e||[]).reduce((S,v)=>{const R=D(v?.qty??v?.quantity??v?.count??1),q=Number.isFinite(R)&&R>0?R:1,X=D(v?.price??v?.unit_price??v?.unitPrice),Q=Number.isFinite(X)?X:0;return S+q*Q},0),u=z(d*l),p=Array.isArray(n)?n:[],g=p.length?p.map(S=>S?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:y,totalPerDay:_}=p.length?p.reduce((S,v)=>{const R=D(v?.positionCost??v?.position_cost??v?.cost??v?.dailyWage??v?.daily_wage??0),q=D(v?.positionClientPrice??v?.position_client_price??v?.clientPrice??v?.dailyTotal??v?.daily_total??v?.total??0),X=Number.isFinite(R)?R:0,Q=Number.isFinite(q)?q:0;return{costPerDay:S.costPerDay+X,totalPerDay:S.totalPerDay+Q}},{costPerDay:0,totalPerDay:0}):Sa(g),h=z(_*l),b=z(y*l),A=z(u+h),C=Number(i)||0;let N=o==="amount"?C:A*(C/100);(!Number.isFinite(N)||N<0)&&(N=0),N>A&&(N=A);const E=Math.max(0,A-N);let k=Number.isFinite(r)?Number(r):null;s&&(!Number.isFinite(k)||k<=0)&&(k=Un);const L=k&&k>0?k:0,F=L>0?Math.max(0,E*(L/100)):0,B=E+F;let $=s?B*.15:0;(!Number.isFinite($)||$<0)&&($=0),$=Number($.toFixed(2));const f=B+$,H=Math.max(0,Number(f.toFixed(2))),K=Math.max(0,Math.max(0,u+h-N)-b);return{rentalDays:l,equipmentTotal:u,crewTotal:h,crewCostTotal:b,discountAmount:N,subtotalAfterDiscount:E,taxableAmount:B,taxAmount:$,finalTotal:H,companySharePercent:L,companyShareAmount:F,netProfit:K}}function _o(e=[],t=0,n="percent",i=!1,o=[],{start:s=null,end:c=null,companySharePercent:a=null}={}){const r=p=>p&&typeof p=="object"&&(p.positionId!==void 0||p.position_id!==void 0||p.positionLabel!==void 0||p.position_name!==void 0||p.positionClientPrice!==void 0),l=Array.isArray(o)&&o.some(r)?o:[],d=l.length?l.map(p=>p?.technicianId).filter(Boolean):Array.isArray(o)?o:[];return qe({items:e,technicianIds:d,crewAssignments:l,discount:t,discountType:n,applyTax:i,start:s,end:c,companySharePercent:a}).finalTotal}function Wn({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:o,paymentStatus:s,paidAmount:c=0,paidPercent:a=0,companySharePercent:r=null,companyShareAmount:l=null,taxAmount:d=null,netProfit:u=null,totalKey:p="reservations.summary.total",equipmentTotal:g=null,crewTotal:y=null}){const _=m("reservations.create.summary.currency","SR"),h=I(String(e)),b=I(String(t)),A=I(String(n??1)),C=I(String(i)),N=Qn(s),E=N==="paid"?"Ù…Ø¯ÙÙˆØ¹":N==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",k=m(`reservations.create.paymentStatus.${N}`,E),L=Number.isFinite(Number(c))?Math.max(0,Number(c)):0,F=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,B=L>Pe||F>Pe,$=m("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),f=I(L.toFixed(2)),H=I(F.toFixed(F%1?2:0)),K=m("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),S=m("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),v=m("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),R=m("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),q=m("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),X=m("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),Q=m("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),Ot=m(p.replace(".total",".totalLabel"),"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©"),ai=m("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),oi=m("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),ct=Number.isFinite(u)?Math.max(0,Number(u)):null,ue=[{label:K,value:b},{label:S,value:A},{label:v,value:C}],Ut=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;Ut!=null&&ue.push({label:R,value:`${I(Ut.toFixed(2))} ${_}`});const Kt=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;if(Kt!=null&&ue.push({label:q,value:`${I(Kt.toFixed(2))} ${_}`}),o){let ie=m("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(d)&&d>0&&(ie=`${I(Number(d).toFixed(2))} ${_}`),ue.push({label:X,value:ie})}const Ve=Number.isFinite(r)?Number(r):null;if(Ve!==null&&Ve>0){const ie=Number.isFinite(l)?Number(l):e*(Ve/100),Le=I(String(Ve)),ci=I(Number.isFinite(ie)?ie.toFixed(2):"0"),ri=`${Le}% (${ci} ${_})`;ue.push({label:ai,value:ri})}if(ct!==null&&Math.abs(ct-Number(e))>.009){const ie=I(ct.toFixed(2));ue.push({label:oi,value:`${ie} ${_}`})}ue.push({label:Q,value:k}),B&&ue.push({label:$,value:`${f} ${_} (${H}%)`});const si=`${h} ${_}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${ue.map(({label:ie,value:Le})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${ie}</span>
            ${Le?`<span class="reservation-summary-value">${Le}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${Ot}</span>
          <span class="reservation-summary-value">${si}</span>
        </div>
      </div>
    </div>
  `}function Ea({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:o,paymentProgressType:s=null,paymentProgressValue:c=null,start:a,end:r,companySharePercent:l=null,paymentHistory:d=[]}){const u=ga(),p=typeof tn=="function"?tn()??[]:[],g=Array.isArray(p)?p.map(String):[],y=u.length?u.map(k=>k?.technicianId).filter(Boolean).map(String):g,_=u.length||y.length,h=Number.isFinite(l)?Number(l):null,b=qe({items:e,technicianIds:y,crewAssignments:u,discount:t,discountType:n,applyTax:i,start:a,end:r,companySharePercent:h}),A=wt({totalAmount:b.finalTotal,progressType:s,progressValue:c,history:d}),C=$t({manualStatus:o,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:b.finalTotal}),N=Wn({total:b.finalTotal,itemsCount:e.length,rentalDays:b.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:b.companySharePercent,companyShareAmount:b.companyShareAmount,taxAmount:b.taxAmount,netProfit:b.netProfit,equipmentTotal:b.equipmentTotal,crewTotal:b.crewTotal}),E={paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:b.finalTotal};return Ea.lastResult=E,qa(N),N}function Ta({items:e,discount:t,discountType:n,applyTax:i,paidStatus:o,paymentProgressType:s=null,paymentProgressValue:c=null,start:a,end:r,companySharePercent:l=null,paymentHistory:d=[]}){const u=ha(),p=typeof nn=="function"?nn()??[]:[],g=Array.isArray(p)?p.map(String):[],y=u.length?u.map(k=>k?.technicianId).filter(Boolean).map(String):g,_=u.length||y.length,h=Number.isFinite(l)?Number(l):null,b=qe({items:e,technicianIds:y,crewAssignments:u,discount:t,discountType:n,applyTax:i,start:a,end:r,companySharePercent:h}),A=wt({totalAmount:b.finalTotal,progressType:s,progressValue:c,history:d}),C=$t({manualStatus:o,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:b.finalTotal}),N=Wn({total:b.finalTotal,itemsCount:e.length,rentalDays:b.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:b.companySharePercent,companyShareAmount:b.companyShareAmount,taxAmount:b.taxAmount,netProfit:b.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:b.equipmentTotal,crewTotal:b.crewTotal}),E={html:N,paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:b.finalTotal};return Ta.lastResult=E,N}function qa(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,un(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,un(n,e))}function un(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const La=M()||{};let ee=(La.reservations||[]).map(wa);function me(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const Gn="__reservation_packages_cache__";function Yn(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Jn(){const e=Yn();if(!e)return{};try{const t=e.getItem(Gn);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function dn(e){const t=Yn();if(t)try{t.setItem(Gn,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function Fa(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,o=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",s=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,c=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return i||o||s||c})}function Io(e){return[]}function Zn(e=[]){return Array.isArray(e)?e.map((t,n)=>ii(t,n)).filter(Boolean).map((t,n)=>{const i=Z(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),o=Xe(t,i).map(l=>{const d=x(l.qty??l.quantity??l.count??l.units??l.unit_qty??l.unitQty??l.unit_count??l.unitCount??l.package_quantity??l.packageQty??1),u=me(T(l.price??l.unit_price??0));return{...l,qty:d,quantity:d,price:u,unit_price:u}}),s=x(t.quantity??t.qty??1);let c=me(T(t.unit_price??t.unitPrice??t.price??0));if(!c||c<=0){const l=o.reduce((d,u)=>d+(u.price||0)*(u.qty||1),0);l>0&&s>0&&(c=me(Number((l/s).toFixed(2))))}const a=T(t.total_price??t.totalPrice??t.total??c*s),r=a>0?me(a):me(Number((c*s).toFixed(2)));return{...t,packageId:i,package_id:i,qty:s,quantity:s,unit_price:c,unitPrice:c,price:c,total_price:r,total:r,packageItems:o}}):[]}function He(e,t){if(!e)return;const n=Jn(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],dn(n));return}n[i]=Zn(t),dn(n)}function Ba(e){if(!e)return[];const t=Jn(),n=String(e),i=t[n];return Array.isArray(i)?Zn(i):[]}function Rt(e,t=0){if(e==null)return null;if(typeof e!="object"){const C=e!=null?String(e):null;return{assignmentId:`crew-${t}-${C??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:C,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,o=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,s=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let c=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";c||(c=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,r=e.position_label_en??null,l=e.position_label_alt??r??a??"",d=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,u=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,p=me(D(d)),g=me(D(u)),y=e&&typeof e.technician=="object"?e.technician:null,_=e.technician_id??e.technicianId??e.id??y?.id??e.userId??e.user_id??null,h=e.technician_name??e.technicianName??e.name??y?.name??e.full_name??null,b=e.role??y?.role??e.specialization??null,A=e.technician_phone??y?.phone??e.phone??null;return{assignmentId:String(n),positionId:o!=null?String(o):null,positionKey:s!=null?String(s):null,positionLabel:c!=null?String(c):"",positionLabelAlt:l!=null?String(l):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:r!=null?String(r):null,positionCost:Number.isFinite(p)?p:0,positionClientPrice:Number.isFinite(g)?g:0,technicianId:_!=null?String(_):null,technicianName:h!=null?String(h):null,technicianRole:b!=null?String(b):null,technicianPhone:A!=null?String(A):null,notes:e.notes??null}}function Ao(){return ee}function st(e){ee=Array.isArray(e)?e.map(xt):[],ee.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;He(n,t.packages);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];Fa(i)}),ee.length?console.debug("[reservationsService] setReservationsState first paymentHistory",ee[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),pn({reservations:ee});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return ee}async function Po(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,r])=>{r!=null&&r!==""&&t.set(a,String(r))});const n=t.toString(),o=(await U(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(o)?s=o:o&&typeof o=="object"&&(Array.isArray(o.items)?s=o.items:Array.isArray(o.results)?s=o.results:Array.isArray(o.data)?s=o.data:Array.isArray(o.records)&&(s=o.records));const c=s.map(zt);return st(c)}async function No(e){const t=await U("/reservations/",{method:"POST",body:e}),n=zt(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const i=Mt(e.payment_history);i.length&&(n.paymentHistory=i)}if((!Array.isArray(n.crewAssignments)||n.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const i=e.technicians.map((o,s)=>Rt(o,s)).filter(Boolean);i.length&&(n.crewAssignments=i,n.techniciansDetails=i.map((o,s)=>{const c=e.technicians[s];return typeof c=="object"?{...c,...o}:o}))}if(Array.isArray(e?.packages)&&e.packages.length){const i=Vt({packages:e.packages});n.packages=_e(n.packages,i)}{const i=Ht(n.items||[],n.packages||[]);n.items=i.items,n.packages=_e(n.packages||[],i.packages)}if(He(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const i=qe({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=i.companyShareAmount,n.cost=i.finalTotal,n.totalAmount=i.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,st([...ee,n]),n}async function Da(e,t){const n=await U(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=zt(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const s=Mt(t.payment_history);s.length&&(i.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const s=t.technicians.map((c,a)=>Rt(c,a)).filter(Boolean);s.length&&(i.crewAssignments=s,i.techniciansDetails=s.map((c,a)=>{const r=t.technicians[a];return typeof r=="object"?{...r,...c}:c}))}if(Array.isArray(t?.packages)&&t.packages.length){const s=Vt({packages:t.packages});i.packages=_e(i.packages,s)}{const s=Ht(i.items||[],i.packages||[]);i.items=s.items,i.packages=_e(i.packages||[],s.packages)}if(He(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const s=qe({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=s.companyShareAmount,i.cost=s.finalTotal,i.totalAmount=s.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const o=ee.map(s=>String(s.id)===String(e)?i:s);return st(o),i}async function vo(e){await U(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=ee.filter(n=>String(n.id)!==String(e));st(t),He(e,null)}async function So(e){return Da(e,{status:"confirmed",confirmed:!0})}function zt(e={}){return xt({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function wa(e={}){return xt(e)}function xt(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map($a):[],o=Vt(e);const s=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let c=s.map((q,X)=>Rt(q,X)).filter(Boolean),a=c.map((q,X)=>{const Q=s?.[X];return{...Q&&typeof Q=="object"?{...Q}:Q!=null?{id:Q}:{},...q}});const r=c.map(q=>q.technicianId).filter(q=>q!=null&&q!=="").map(q=>Number.isNaN(Number(q))?String(q):Number(q)),l=e.start??e.start_datetime??"",d=e.end??e.end_datetime??"";let u=T(e.total_amount??e.totalAmount??e.cost??0);const p=T(e.discount??0),g=e.discount_type??e.discountType??"percent",y=["percent","amount"].includes(g)?g:"percent",_=!!(e.apply_tax??e.applyTax??!1);let h=Oa(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const b=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),A=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,C=A!=null?Number.parseFloat(I(String(A).replace("%","").trim())):NaN,N=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let E=N!=null?N===!0||N===1||N==="1"||String(N).toLowerCase()==="true":Number.isFinite(C)&&C>0,k=E&&Number.isFinite(C)?Number(C):0;const L=e.company_share_amount??e.companyShareAmount;let F=Number.isFinite(Number(L))?Number(L):NaN;_&&k<=0&&(k=Un,E=!0);const B=qe({items:i,technicianIds:r,crewAssignments:c,discount:p,discountType:y,applyTax:_,start:l,end:d,companySharePercent:k>0?k:null});(!Number.isFinite(u)||u<=0||_)&&(u=B.finalTotal),(!Number.isFinite(F)||F<0)&&(F=B.companyShareAmount),F=Number.isFinite(F)?Number(F.toFixed(2)):0,!E&&k>0&&(E=!0);const $=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],f=Ra($),H=Mt(f),K=t??n??e.reservation_code??e.reservationId??null;if(o.length)He(K,o);else{const q=Ba(K);q.length&&(o=_e(o,q))}const S=Ht(i,o);i=S.items,o=_e(o,S.packages);const v=wt({totalAmount:u,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:H});h=$t({manualStatus:h,paidAmount:v.paidAmount,paidPercent:v.paidPercent,totalAmount:u});const R=h==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:l,end:d,status:Va(e.status??(b?"confirmed":"pending")),confirmed:b,location:e.location??"",notes:e.notes??"",discount:p,discountType:y,applyTax:_,paid:R,paidStatus:h,paidAmount:v.paidAmount,paidPercent:v.paidPercent,paymentProgressType:v.paymentProgressType,paymentProgressValue:v.paymentProgressValue,paymentHistory:H,payment_history:H,totalAmount:u,cost:u,projectId:e.project_id??e.projectId??null,items:i,technicians:r,crewAssignments:c,techniciansDetails:a,startDatetime:l,endDatetime:d,customerPhone:e.customer_phone??e.customerPhone??null,packages:o,companySharePercent:k,companyShareAmount:F,companyShareEnabled:E}}function $a(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=x(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=T(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),o=I(String(e.barcode??e.code??e.serial??"")),s=e.description??e.desc??e.name??e.title??"",c={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:o,desc:s,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},a=Xn(e.type??e.item_type??e.kind??null),r=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,l=ne(r),d=Xe(e,l);if(a==="package"||l||d.length){c.type="package";const u=l||(t!=null?String(t):c.id?ne(c.id):"");u&&(c.packageId=u,c.package_id=u,c.package_code=e.package_code??e.packageCode??u),c.name=s||c.package_code||u||"",c.barcode=c.barcode||I(String(e.package_code??e.packageCode??"")),c.packageItems=d;const p=ti({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(c.price)||c.price<=0||c.price>p*10)&&(c.price=p),c.qtyPerPackage=d.length?d[0]?.qtyPerPackage??c.qtyPerPackage:c.qtyPerPackage,c.totalQuantity=n}return c}function Co({reservationCode:e,customerId:t,start:n,end:i,status:o,title:s,location:c,notes:a,projectId:r,totalAmount:l,discount:d,discountType:u,applyTax:p,paidStatus:g,confirmed:y,items:_,packages:h,crewAssignments:b=[],technicians:A=b,companySharePercent:C,companyShareEnabled:N,paidAmount:E,paidPercentage:k,paymentProgressType:L,paymentProgressValue:F,paymentHistory:B}){const $=Array.isArray(b)?b:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:o??"pending",title:s??null,location:c??null,notes:a??null,project_id:r||null,total_amount:l??0,discount:d??0,discount_type:u??"percent",apply_tax:p?1:0,paid_status:g??"unpaid",paid_amount:Number.isFinite(E)?T(E):0,paid_percentage:Number.isFinite(k)?Number(k.toFixed(2)):0,payment_progress_type:L??null,payment_progress_value:Number.isFinite(F)?Number(F.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(f=>({type:yt(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?T(f.value):null,amount:f?.amount!=null?T(f.amount):f?.payment_amount!=null?T(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(f=>({type:yt(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?T(f.value):null,amount:f?.amount!=null?T(f.amount):f?.payment_amount!=null?T(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],confirmed:y===void 0?null:!!y,items:za(_),packages:xa(_,h),company_share_percent:N&&Number.isFinite(C)?Number(C):null,company_share_enabled:N?1:0,technicians:$.length?$.map((f,H)=>{const K=f.technicianId??f.technician_id??f.id??null,S=f.positionId??f.position_id??f.position??f.position_code??null,v=f.positionLabel??f.position_name??f.role??null,R=T(f.positionCost??f.position_cost??f.cost??f.daily_wage??f.dailyWage??0),q=T(f.positionClientPrice??f.position_client_price??f.client_price??f.clientPrice??f.daily_total??f.dailyTotal??f.total??0);return{id:K,technician_id:K,role:v??f.technicianRole??null,notes:f.notes??null,position_id:S,position_key:f.positionKey??f.position_key??null,position_name:v,position_label_ar:f.positionLabelAr??f.position_label_ar??null,position_label_en:f.positionLabelEn??f.position_label_en??null,position_cost:R,position_client_price:q,client_price:q,cost:R,assignment_id:f.assignmentId??f.assignment_id??`crew-${H}`}}):Array.isArray(A)?A.map(f=>typeof f=="object"&&f!==null?{id:f.id??f.technician_id??f.technicianId??f.ID,role:f.role??null,notes:f.notes??null}:Number.isNaN(Number(f))?String(f):Number(f)):[]}}function Mt(e){const t=jt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,o=yt(i),s=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,c=s!=null?Number.parseFloat(I(String(s))):null,a=n.amount!=null?Number.parseFloat(I(String(n.amount))):n.payment_amount!=null?Number.parseFloat(I(String(n.payment_amount))):null,r=n.percentage!=null?Number.parseFloat(I(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(I(String(n.payment_percentage))):null,l=Number.isFinite(a)?a:o==="amount"&&Number.isFinite(c)?c:null,d=Number.isFinite(r)?r:o==="percent"&&Number.isFinite(c)?c:null,u=o??(l!=null?"amount":d!=null?"percent":null),p=u==="amount"?l:u==="percent"?d:Number.isFinite(c)?c:null,g=n.note??n.notes??n.comment??n.payment_note??null,y=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:u,value:p,amount:l,percentage:d,note:g,recordedAt:y}}).filter(n=>n&&n.type)}function yt(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function jt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const c of t)if(Array.isArray(e[c]))return e[c];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(c=>Array.isArray(c));if(Array.isArray(i))return i;const o=Object.values(e);if(o.length&&o.every(c=>c&&typeof c=="object")){const c=o.map(a=>a);if(c.every(a=>!Array.isArray(a)))return c}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(c=>c in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return jt(t)}catch{return[]}return[]}function Ra(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=jt(t);if(Array.isArray(n)&&n.length)return n}return[]}function za(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const o=x(n.qty??n.quantity??1);n.packageItems.forEach(s=>{const c=s?.equipmentId??s?.equipment_id??s?.id??null;if(c==null)return;const a=x(s?.qty??s?.quantity??1),r=o*a;t.push({equipment_id:bt(c),quantity:r,unit_price:T(s?.price??s?.unit_price??0),notes:s?.notes??null})});return}const i=n.equipmentId??n.equipment_id??n.id??null;i!=null&&t.push({equipment_id:bt(i),quantity:x(n.qty??n.quantity??1),unit_price:T(n.price??n.unit_price??0),notes:n.notes??null})}),t}function bt(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function xa(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const o=x(i.qty??i.quantity??1),s=Array.isArray(i.packageItems)?i.packageItems.map(c=>{const a=c?.equipmentId??c?.equipment_id??c?.id??null;return a==null?null:{equipment_id:bt(a),quantity:x(c?.qty??c?.quantity??c?.count??c?.units??c?.unit_qty??c?.unitQty??c?.unit_count??c?.unitCount??c?.package_quantity??c?.packageQty??1),unit_price:T(c?.price??c?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:o,unit_price:T(i.price??i.unit_price??0),items:s})}),n}function Xn(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function ne(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return Z(t)}function _t(e){return e==null?"":I(String(e)).trim().toLowerCase()}function ei(e={},t=1){if(!e||typeof e!="object"){const r=I(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:r,normalizedBarcode:_t(r),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=x(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),o=T(e.unit_price??e.unitPrice??e.price??0),s=I(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),c=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let a;if(c!=null)a=x(c,{fallback:1,max:99});else if(t>0){const r=i/t;Number.isFinite(r)&&r>0&&Number.isInteger(r)?a=x(r,{fallback:1,max:99}):a=Math.min(i,99)}else a=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:a,quantity:a,qtyPerPackage:a,totalQuantity:i,price:o,unit_price:o,barcode:s,normalizedBarcode:_t(e.normalizedBarcode??s),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function Ma(e={},t={}){const n=ne(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=x(e.quantity??e.qty??t.qty??t.quantity??1,{fallback:1,max:9999}),o=T(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),s=I(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:s,desc:t.desc??t.description??e.name??e.desc??e.title??s,qty:i,quantity:i,price:o,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:s,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function Ht(e=[],t=[]){const n=ja(e),i=Array.isArray(t)?_e(t,n.packages):n.packages,o=new Map;return i.forEach(s=>{const c=ne(s.packageId??s.package_id??s.id);c&&o.set(c,s)}),n.packages.forEach(s=>{const c=ne(s.packageId??s.package_id??s.id);if(!c)return;const a=o.get(c);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=s.packageItems),!a.name&&s.name&&(a.name=s.name),!a.image&&s.image&&(a.image=s.image))}),{items:n.items,packages:Array.from(o.values())}}function ja(e=[]){const t=new Map;if(e.forEach(s=>{const c=ne(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(!c)return;const a=c;t.has(a)||t.set(a,{base:s,items:[]}),t.get(a).items.push(s)}),!t.size)return{items:e,packages:[]};const n=[],i=[],o=new Set;return e.forEach(s=>{const c=ne(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(c&&t.has(c)){if(o.has(c))return;const a=t.get(c),r=a.base||s,l=a.items.map(u=>ei(u,1)),d={packageId:c,package_id:c,package_code:r.package_code??r.packageCode??r.barcode??I(String(c)),name:r.package_name??r.packageName??r.desc??r.name??`Package ${c}`,quantity:x(r.package_quantity??r.packageQty??r.qty??1,{fallback:1,max:9999}),unit_price:T(r.package_price??r.packagePrice??r.price??0),packageItems:l,image:r.image??null};i.push(d),n.push(Ma(d,r)),o.add(c);return}n.push(s)}),{items:n,packages:i}}function Xe(e={},t=""){if(!e||typeof e!="object")return[];const n=ne(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let o=ye({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),s=[];if((!Array.isArray(o)||o.length===0)&&n){const l=Je(n);l&&(o=ye(l),s=Array.isArray(o)?o:[])}else if(n){const l=Je(n);l&&(s=ye(l)||[])}if(!Array.isArray(o)||o.length===0)return[];const c=x(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=o.map(l=>ei(l,c));if(s.length){const l=new Map;s.forEach(d=>{if(!d)return;const u=_t(d.barcode)||(d.equipmentId!=null?`id:${d.equipmentId}`:null)||(d.equipment_id!=null?`id:${d.equipment_id}`:null);u&&l.set(u,d)}),a.forEach(d=>{const u=d.normalizedBarcode||(d.equipmentId?`id:${d.equipmentId}`:null);if(!u||!l.has(u))return;const p=l.get(u),g=x(p.quantity??p.qty??1,{fallback:d.qtyPerPackage??1,max:99});d.qtyPerPackage=g,d.qty=g,d.quantity=g;const y=T(p.unit_price??p.unitPrice??p.price??d.price);d.price=y,d.unit_price=y,!d.desc&&p.desc&&(d.desc=p.desc),!d.image&&p.image&&(d.image=p.image)})}const r=new Map;return a.forEach(l=>{const d=l.normalizedBarcode||(l.equipmentId?`id:${l.equipmentId}`:null);if(d){if(r.has(d)){const u=r.get(d);u.qty+=l.qty,u.quantity+=l.quantity,(!Number.isFinite(u.qtyPerPackage)||u.qtyPerPackage<=0)&&(u.qtyPerPackage=l.qtyPerPackage),(!u.price||u.price===0)&&l.price&&(u.price=l.price,u.unit_price=l.unit_price),!u.desc&&l.desc&&(u.desc=l.desc),!u.image&&l.image&&(u.image=l.image);return}r.set(d,{...l})}}),Array.from(r.values())}function ti(e={},t=[],n=1){if(Array.isArray(t)&&t.length){const o=t.reduce((s,c)=>{const a=Number.isFinite(Number(c.price))?Number(c.price):0,r=Number.isFinite(Number(c.qtyPerPackage))&&Number(c.qtyPerPackage)>0?Number(c.qtyPerPackage):Number.isFinite(Number(c.qty))&&Number(c.qty)>0?Number(c.qty):1;return s+a*r},0);if(o>0)return Number(o.toFixed(2))}const i=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(i))){const o=T(i);return n>0?Number((o/n).toFixed(2)):o}return Number.isFinite(Number(e.unit_price??e.unitPrice??e.price))?T(e.unit_price??e.unitPrice??e.price):0}function ni(e,t){if(!e)return t;if(!t)return e;const n={...e},i=o=>{(n[o]===void 0||n[o]===null||n[o]==="")&&(n[o]=t[o])};return["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=Ha(n.packageItems,t.packageItems),n.items=n.packageItems),n}function Ha(e=[],t=[]){const n=new Map,i=o=>{o.forEach(s=>{if(!s)return;const c=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(c){if(n.has(c)){const a=n.get(c);a.qty+=s.qty??0,a.quantity+=s.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(s.qtyPerPackage)&&(a.qtyPerPackage=s.qtyPerPackage),(!a.price||a.price===0)&&s.price&&(a.price=s.price,a.unit_price=s.unit_price),!a.desc&&s.desc&&(a.desc=s.desc),!a.image&&s.image&&(a.image=s.image);return}n.set(c,{...s})}})};return i(e),i(t),Array.from(n.values())}function _e(e=[],t=[]){const n=[],i=new Map,o=s=>{Array.isArray(s)&&s.forEach(c=>{if(!c||typeof c!="object")return;const a=c.packageId||c.package_id||c.package_code||c.id;if(a)if(i.has(a)){const r=i.get(a);n[r]=ni(n[r],c)}else i.set(a,n.length),n.push({...c})})};return o(e),o(t),n}function ii(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const u=ne(e),p=u?Je(u):null,g=p?Xe(p,u):[],y=p?T(p.price??p.unit_price??p.unitPrice??0):0,_=1,h=Number((y*_).toFixed(2));return{id:`package::${u||t}`,packageId:u||`pkg-${t}`,package_id:u||`pkg-${t}`,package_code:I(String(e))||u||`pkg-${t}`,name:p?.name??p?.package_name??p?.packageName??I(String(e))??"",desc:p?.name??I(String(e))??"",quantity:_,qty:_,unit_price:y,unitPrice:y,price:y,total:h,total_price:h,barcode:I(String(e)),packageItems:g,items:g,type:"package",image:p?.image??null}}if(typeof e!="object")return null;const n=ne(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=x(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),o=Xe(e,n),s=ti(e,o,i),c=e.total_price??e.totalPrice??e.total??s*i,a=Number.isFinite(Number(c))?T(c):Number((s*i).toFixed(2)),r=e.package_code??e.packageCode??e.code??n,l=I(String(e.barcode??r??"")),d=e.image??e.cover??e.thumbnail??o.find(u=>u.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:r,name:e.name??e.package_name??e.packageName??e.title??e.description??r??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??r??n,quantity:i,qty:i,unit_price:s,unitPrice:s,price:s,total:a,total_price:a,barcode:l,packageItems:o,items:o,type:"package",image:d}}function Vt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,o=(a,r=n.length)=>{const l=ii(a,r);if(!l)return;const d=l.packageId||l.package_code||l.id||`pkg-${r}`;if(i.has(d)){const u=i.get(d);n[u]=ni(n[u],l)}else i.set(d,n.length),n.push(l)};t.forEach(a=>{a.forEach((r,l)=>{o(r,l+n.length)})}),n.length===0&&e.package&&o(e.package,0);const s=Array.isArray(e.items)?e.items:[],c=(a={})=>!a||typeof a!="object"?!1:!!(Xn(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(l=>typeof l=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return s.forEach((a,r)=>{c(a)&&o(a,n.length+r)}),n}function T(e){const t=D(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function x(e,{fallback:t=1,max:n=1e6}={}){const i=D(e);if(!Number.isFinite(i))return t;const o=Math.round(i);return o<=0||o>n?t:o}function Va(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return"pending"}}function Oa(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function ko(e){return e instanceof Ge}export{no as $,ro as A,Ui as B,ao as C,Un as D,eo as E,ga as F,Ea as G,Ue as H,Z as I,Za as J,Gi as K,Ya as L,lo as M,Ia as N,co as O,Je as P,Vi as Q,Oi as R,to as S,Pa as T,oo as U,Xa as V,_a as W,Ja as X,qt as Y,Co as Z,No as _,Po as a,mo as a0,io as a1,so as a2,ho as a3,z as a4,D as a5,qe as a6,le as a7,xt as a8,Me as a9,vo as aa,So as ab,Ta as ac,ha as ad,fo as ae,Io as af,po as ag,wa as ah,go as b,ko as c,Qa as d,bo as e,Ga as f,Ao as g,ye as h,uo as i,wt as j,$t as k,Ye as l,At as m,W as n,zt as o,Tn as p,ka as q,It as r,Ln as s,Ka as t,fe as u,Wa as v,_o as w,yo as x,Da as y,On as z};
