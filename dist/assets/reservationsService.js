import{d as F,n as S,b as x,A as De,s as Le,f as Xe,t as u,h as E,o as Ze,j as Pe}from"./auth.js";const et=F()||{};let k=(et.technicians||[]).map(xe);function Ce(){return k}function Y(e){return k=Array.isArray(e)?e.map(xe):[],Le({technicians:k}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),k}async function tt(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,c])=>{c!=null&&c!==""&&t.set(s,String(c))});const n=t.toString(),a=await x(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(re):[];return Y(i)}async function nt(e){const t=await x("/technicians/",{method:"POST",body:e}),n=re(t?.data??{});return Y([...k,n]),n}async function $e(e,t){const n=await x(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=re(n?.data??{}),i=k.map(s=>String(s.id)===String(e)?a:s);return Y(i),a}async function at(e){await x(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Y(k.filter(t=>String(t.id)!==String(e)))}function Fe({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,dailyTotal:c,status:r,notes:o,active:l=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,daily_total:c??null,status:r??"available",notes:o??null,active:l?1:0}}function re(e={}){return Re({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,status:e.status,notes:e.notes,active:e.active})}function xe(e={}){return Re(e)}function Re(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",c=e.department??e.team??"",r=Se(e.daily_wage??e.dailyWage??e.wage??e.rate??0),o=Se(e.daily_total??e.dailyTotal??e.total??e.total_wage??r),l=Te(e.baseStatus??e.status??"available"),p=Te(e.status??e.baseStatus??"available"),d=e.notes??"",h=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:c,dailyWage:r,dailyTotal:o,status:p,baseStatus:l,notes:d,active:h}}function Se(e){const t=Number.parseFloat(S(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Te(e){switch(String(e??"").trim().toLowerCase()){case"available":case"ŸÖÿ™ÿßÿ≠":return"available";case"busy":case"ŸÖÿ¥ÿ∫ŸàŸÑ":case"ŸÇŸäÿØ ÿßŸÑÿπŸÖŸÑ":return"busy";case"leave":case"ÿ•ÿ¨ÿßÿ≤ÿ©":case"ÿÆÿßÿ±ÿ¨ ÿßŸÑÿÆÿØŸÖÿ©":return"leave";case"inactive":case"ŸÖÿ™ŸàŸÇŸÅ":return"inactive";default:return"available"}}function ae(e){return e instanceof De}let B=null,Ee=!1,X=!1,K="",oe=!1;async function ke({showToastOnError:e=!0}={}){if(!X){X=!0,K="",A();try{await tt(),oe=!0}catch(t){console.error("‚ùå [technicians] loadTechniciansFromApi failed",t),K=ae(t)?t.message:u("technicians.toast.fetchFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©"),e&&E(K,"error")}finally{X=!1,A()}}}function Me(){return Ce()}function J(e=""){return S(String(e)).trim().toLowerCase()}function Ie(e){return e==null?"":String(e)}function V(e=""){return S(String(e)).replace(/[^0-9+]/g,"")}function _(e=""){const t=S(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function j(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function le(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ":"‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ∂Ÿà ÿ∑ÿßŸÇŸÖ";t.textContent=u(n,a)}function ue(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=u("technicians.form.actions.cancel","ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑ"))}function de(){le(B?"update":"add"),ue(!!B),A()}function it(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,c)=>s.localeCompare(c,"ar",{sensitivity:"base"})),i=u("technicians.search.filters.allRoles","üëî ŸÉŸÑ ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function ie(){const e=document.getElementById("technician-form");e&&(e.reset(),B=null,le("add"),ue(!1))}function st(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-wage"),c=document.getElementById("technician-total"),r=document.getElementById("technician-notes");!t||!n||!a||!s||!c||(t.value=e.name||"",n.value=V(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s.value=_(e.dailyWage!=null?e.dailyWage:""),c.value=_(e.dailyTotal!=null?e.dailyTotal:""),r&&(r.value=e.notes||""),B=String(e.id),le("update"),ue(!0))}function ct(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-wage"),s=document.getElementById("technician-total"),c=document.getElementById("technician-notes");if(!e||!t||!n||!i||!s)return null;const r=e.value.trim(),o=V(t.value.trim());t.value=o;const l=n.value.trim(),p=a?.value.trim()||"",d=_(i.value.trim());i.value=d;const h=d===""?0:parseFloat(d),v=_(s.value.trim());s.value=v;const g=v===""?null:parseFloat(v),b="available",T=c?.value.trim()||"";return r?o?l?Number.isNaN(h)||h<0?(E(u("technicians.toast.invalidWage","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ£ÿ¨ÿ± ÿßŸÑŸäŸàŸÖŸä")),i.focus(),null):g!=null&&(Number.isNaN(g)||g<0)?(E(u("technicians.toast.invalidTotal","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©")),s.focus(),null):{name:r,phone:o,role:l,department:p,dailyWage:Number.isFinite(h)?h:0,dailyTotal:g==null?null:Number(g),status:b,baseStatus:b,notes:T}:(E(u("technicians.toast.missingRole","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ∏ŸäŸÅÿ©")),n.focus(),null):(E(u("technicians.toast.missingPhone","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ")),t.focus(),null):(E(u("technicians.toast.missingName","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),e.focus(),null)}async function ot(e){e.preventDefault();const t=ct();if(!t)return;const n=Fe({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{B?(await $e(B,n),E(u("technicians.toast.updateSuccess","üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"))):(await nt(n),E(u("technicians.toast.addSuccess","‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"))),ie(),A()}catch(a){console.error("‚ùå [technicians] handleTechnicianSubmit failed",a);const i=ae(a)?a.message:u("technicians.toast.saveFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");E(i,"error")}}function rt(){ie()}function lt(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=V(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=_(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=_(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==i&&(t.total.value=i);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),j(t.phone,V),j(t.wage,_),j(t.total,_)}function ut(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),c=document.getElementById("edit-technician-total"),r=document.getElementById("edit-technician-status"),o=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!c||!r)return null;const l=e.value.trim(),p=t.value.trim(),d=V(n.value.trim());n.value=d;const h=a.value.trim(),v=i?.value.trim()||"",g=_(s.value.trim());s.value=g;const b=g===""?0:parseFloat(g),T=_(c.value.trim());c.value=T;const f=T===""?null:parseFloat(T),I=r.value||"available",m=o?.value.trim()||"";return l?p?d?h?Number.isNaN(b)||b<0?(E(u("technicians.toast.invalidWage","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ£ÿ¨ÿ± ÿßŸÑŸäŸàŸÖŸä")),s.focus(),null):f!=null&&(Number.isNaN(f)||f<0)?(E(u("technicians.toast.invalidTotal","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©")),c.focus(),null):{id:l,name:p,phone:d,role:h,department:v,dailyWage:Number.isFinite(b)?b:0,dailyTotal:f==null?null:Number(f),status:I,baseStatus:I,notes:m}:(E(u("technicians.toast.missingRole","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ∏ŸäŸÅÿ©")),a.focus(),null):(E(u("technicians.toast.missingPhone","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ")),n.focus(),null):(E(u("technicians.toast.missingName","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),t.focus(),null):(E(u("technicians.toast.unidentified","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®")),null)}async function dt(){const e=ut();if(!e)return;const t=Fe({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await $e(e.id,t),E(u("technicians.toast.updateSuccess","üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),A()}catch(n){console.error("‚ùå [technicians] handleTechnicianModalSave failed",n);const a=ae(n)?n.message:u("technicians.toast.updateFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ");E(a,"error")}}function A(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=J(t?.value||"");if(X&&!oe){const l=u("technicians.table.loading","ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}if(K&&!oe){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${K}</td></tr>`;return}const a=qe(),{reservations:i=[]}=F(),s=new Date;it(a);const c=document.getElementById("technician-role-filter"),r=J(c?.value||""),o=a.filter(l=>r&&J(l.role||"")!==r?!1:n?J([l.name,l.phone,l.role,l.department,l.notes].filter(Boolean).join(" ")).includes(n):!0);if(o.length===0){const l=u("technicians.table.empty","ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿπÿ∂ÿßÿ° ŸÅŸä ÿßŸÑÿ∑ÿßŸÇŸÖ ÿ®ÿπÿØ.");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}e.innerHTML=o.map(l=>{const p=B&&String(B)===String(l.id),v=(ze(l.id,i,s)?"busy":l.status||l.baseStatus||"available")==="busy"?{label:u("technicians.status.busy","‚õî ŸÖÿ¥ÿ∫ŸàŸÑ"),className:"technician-status-badge technician-status-badge--busy"}:{label:u("technicians.status.available","‚úÖ ŸÖÿ™ÿßÿ≠"),className:"technician-status-badge technician-status-badge--available"},g=u("technicians.actions.edit","‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ"),b=u("technicians.actions.delete","üóëÔ∏è ÿ≠ÿ∞ŸÅ"),T=Pe(),f=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${l.id}">${g}</button>`];return T&&f.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${l.id}">${b}</button>`),`
      <tr${p?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${l.id}" class="text-decoration-none">${l.name}</a></td>
        <td>${l.role||""}</td>
        <td>${l.department||"‚Äî"}</td>
        <td><span class="${v.className}"><span class="technician-status-badge__text">${v.label}</span></span></td>
        <td class="table-notes-cell">${l.notes||"‚Äî"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${f.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function mt(e){const t=Me().find(n=>String(n.id)===String(e));if(!t){E(u("technicians.toast.dataNotFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"));return}st(t),E(u("technicians.toast.editReady","‚úèÔ∏è ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ ÿßŸÑÿ¢ŸÜ ÿ´ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ"))}async function pt(e){if(!Pe()){Ze();return}if(confirm(u("technicians.toast.deleteConfirm","‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿπÿ∂Ÿàÿü")))try{await at(e),E(u("technicians.toast.deleteSuccess","üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),B&&String(B)===String(e)&&ie(),A()}catch(t){console.error("‚ùå [technicians] handleDeleteClick failed",t);const n=ae(t)?t.message:u("technicians.toast.deleteFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");E(n,"error")}}function kt(){me(),A()}function Mt(e){return Me().find(t=>String(t.id)===String(e))||null}function ze(e,t=[],n){const a=Ie(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(o=>Ie(o)===a))return!1;const c=new Date(i.start),r=new Date(i.end);return Number.isNaN(c.getTime())||Number.isNaN(r.getTime())?!1:c<=n&&n<r}):!1}function qe(){const e=F().reservations||[],t=Ce();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const c=s.baseStatus||s.status||"available";let r=c==="busy"?"busy":c;return ze(s.id,e,n)&&(r="busy"),(r!==s.status||c!==s.baseStatus)&&(a=!0),{...s,baseStatus:c,status:r}});return a?(Y(i),i):t}function me(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",r=>{ot(r).catch(o=>{console.error("‚ùå [technicians] submit handler failed",o)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",rt),n.dataset.listenerAttached="true"),j(document.getElementById("technician-phone"),V),j(document.getElementById("technician-wage"),_),j(document.getElementById("technician-total"),_);const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",r=>{const o=r.target;if(o instanceof HTMLElement){if(o.classList.contains("technician-edit-btn")){const l=o.dataset.id;mt(l)}if(o.classList.contains("technician-delete-btn")){const l=o.dataset.id;pt(l).catch(p=>{console.error("‚ùå [technicians] delete handler failed",p)})}}}),a.dataset.listenerAttached="true");const i=document.getElementById("search-technician-input");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{i.value=S(i.value),A()}),i.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{A()}),s.dataset.listenerAttached="true");const c=document.getElementById("save-technician-changes");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",()=>{dt().catch(r=>{console.error("‚ùå [technicians] modal save failed",r)})}),c.dataset.listenerAttached="true"),Ee||(document.addEventListener("technician:prefill",r=>{const o=r.detail;o&&lt(o)}),Ee=!0),t&&ie()}window.addEventListener("DOMContentLoaded",()=>{me(),A(),de(),ke()});const we=()=>{A()};window.addEventListener("technicians:updated",we);document.addEventListener("technicians:updated",we);document.addEventListener("technicians:refreshRequested",()=>{me(),A(),de(),ke({showToastOnError:!1})});document.addEventListener("language:changed",()=>{de()});document.addEventListener(Xe.USER_UPDATED,()=>{A()});let H=[],je=[],Ve=[];function zt(){return H}function qt(e){H=Array.isArray(e)?e:[]}function wt(e){H=[...H,e]}function jt(e){Number.isInteger(e)&&e>=0&&(H=H.filter((t,n)=>n!==e))}function Vt(){return je}function Ht(e){je=Array.isArray(e)?e:[]}function Wt(){return Ve}function Ut(e){Ve=Array.isArray(e)?e:[]}function Ot(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),s=a?a.slice(0,10):"",c=i.match(/(\d{1,2}:\d{2})/);let r="";if(c){const[o="00",l="00"]=c[0].split(":");r=`${o.padStart(2,"0")}:${l.padStart(2,"0")}`}return{date:s,time:r}}function Q(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function Ne(e){return S(String(e||"")).trim().toLowerCase()}function Kt(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:c=[]}=F(),r=Ne(e);return c.some(o=>{if(!o||!o.items||o.items.length===0||a&&(String(o.id)===String(a)||String(o.reservationId)===String(a))||!o.start||!o.end)return!1;const l=new Date(o.start),p=new Date(o.end);return Number.isNaN(l.getTime())||Number.isNaN(p.getTime())||!(l<s&&p>i)?!1:o.items.some(h=>Ne(h?.barcode)===r)})}function ft(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:c=[]}=F(),r=String(e);return c.some(o=>{if(!o?.start||!o?.end||a&&(String(o.id)===String(a)||String(o.reservationId)===String(a)))return!1;const l=new Date(o.start),p=new Date(o.end);return Number.isNaN(l.getTime())||Number.isNaN(p.getTime())||!(l<s&&p>i)?!1:(Array.isArray(o.technicians)?o.technicians:[]).some(v=>String(v)===r)})}let M=[],L=[],P=[],Z="create",pe=()=>{},fe=()=>{};function ht(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=S(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function He(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const i of t){if(i==null||i==="")continue;const s=parseFloat(S(String(i)));if(Number.isFinite(s)){n=s;break}}if((!Number.isFinite(n)||n<=0)&&(n=ht(e)),!Number.isFinite(n)||n<=0)return"‚Äî";const a=u("technicians.table.wageSuffix","SR");return`${S(String(n))} ${a}`}function Ae(e=""){return S(String(e)).trim().toLowerCase()}function We(e){return!M||!M.length?null:M.find(t=>String(t?.id)===String(e))||null}function yt(e,t="create"){t==="edit"?ge(P.filter(n=>String(n)!==String(e))):ye(L.filter(n=>String(n)!==String(e)))}function ee(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=u("reservations.crew.none","ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿπÿ∂Ÿà ŸÖŸÜ ÿßŸÑÿ∑ÿßŸÇŸÖ.");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const s=We(i)||{},c=u("reservations.crew.fallbackName","ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ {id}").replace("{id}",i),r=s.name||c,o=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",l=He(s),p=l!=="‚Äî"?`<small class="technician-chip-wage">üí∞ ${l}</small>`:"",d=u("reservations.crew.removeAria","ÿ•ÿ≤ÿßŸÑÿ©");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${r}</span>
          ${o}
          ${p}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${d}">‚úñ</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>yt(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function Ue(){return Z==="edit"?P:L}function te(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=Ae(t?.value||""),a=new Set(Ue().map(String)),s=(M||[]).filter(c=>n?Ae([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const c=u("reservations.crew.searchEmpty","ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${c}</td></tr>`;return}e.innerHTML=s.map(c=>{const r=He(c);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${c.id}" ${a.has(String(c.id))?"checked":""}>
        </td>
        <td>${c.name||"-"}</td>
        <td>${c.role||"‚Äî"}</td>
        <td>${c.department||"‚Äî"}</td>
        <td>${r}</td>
      </tr>
    `}).join("")}function gt(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function bt(e="create"){if(e==="edit"){const r=document.getElementById("edit-res-start")?.value?.trim(),o=document.getElementById("edit-res-end")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=r?Q(r,l):null,h=o?Q(o,p):null;let v=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const b=Number.parseInt(g,10);if(Number.isInteger(b)){const{reservations:T=[]}=F(),f=T?.[b];f&&(v=f.id??f.reservationId??null)}}return{start:d,end:h,ignoreReservationId:v}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?Q(t,a):null,c=n?Q(n,i):null;return{start:s,end:c,ignoreReservationId:null}}function W(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=Ue().length;if(t){const n=u("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",S(String(t)));e.textContent=n}else e.textContent=u("technicians.picker.selectionInfo","No crew selected yet")}function vt(){const e=gt().map(String),{start:t,end:n,ignoreReservationId:a}=bt(Z);if(t&&n){const s=e.filter(c=>ft(c,t,n,a));if(s.length>0){const c=s.map(o=>We(o)?.name||o).join(u("reservations.list.crew.separator","ÿå ")),r=u("reservations.toast.technicianSelectionConflict","‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± {names} ŸÑÿ£ŸÜŸáŸÖ ŸÖÿ±ÿ™ÿ®ÿ∑ŸàŸÜ ÿ®ÿ≠ÿ¨ÿ≤ ÿ¢ÿÆÿ± ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©").replace("{names}",c);s.forEach(o=>{const l=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(o))}"]`);l&&(l.checked=!1)}),E(r),W();return}}Z==="edit"?ge(e):ye(e),W();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function _e(e="create"){Z=e;const t=qe();Array.isArray(t)&&t.length&&(M=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),te(),W();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function St(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>_e("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>_e("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{te(),W()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",vt),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{W(),te()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),he()}function he(){ee("selected-technicians-list",L,"create"),ee("edit-selected-technicians-list",P,"edit")}function Yt({onDraftChange:e,onEditChange:t}={}){pe=typeof e=="function"?e:()=>{},fe=typeof t=="function"?t:()=>{},he(),St()}function Tt(e=[]){M=Array.isArray(e)?e:[]}function Et(){return[...L]}function It(){return[...P]}function ye(e=[]){L=Array.isArray(e)?e.map(String):[],ee("selected-technicians-list",L,"create"),pe()}function ge(e=[]){P=Array.isArray(e)?e.map(String):[],ee("edit-selected-technicians-list",P,"edit"),fe()}function Gt(){ye([])}function Jt(){ge([])}function Qt(e=[]){Tt(e);const t=new Set(M.map(r=>String(r.id))),n=L.filter(r=>t.has(String(r))),a=P.filter(r=>t.has(String(r))),i=n.length!==L.length,s=a.length!==P.length;L=n,P=a,he(),i&&pe(),s&&fe();const c=document.getElementById("selectTechniciansModal");c&&c.classList.contains("show")&&(te(),W())}const Oe=10;function Ke(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function Nt(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=Number(n);if(Number.isFinite(a))return a}return Ke(e)}function At(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=F();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));if(!s)return a;const c=Ke(s),r=Nt(s);return{costPerDay:a.costPerDay+(Number.isFinite(c)?c:0),totalPerDay:a.totalPerDay+(Number.isFinite(r)?r:0)}},{costPerDay:0,totalPerDay:0})}const _t=1440*60*1e3;function Bt(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/_t;return Math.max(1,Math.ceil(s))}function U({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:i=!1,start:s=null,end:c=null,companySharePercent:r=null}={}){const o=Bt(s,c),p=(e||[]).reduce((w,G)=>w+(Number(G?.qty)||1)*(Number(G?.price)||0),0)*o,{costPerDay:d,totalPerDay:h}=At(t),v=h*o,g=d*o,b=p+v,T=Number(n)||0;let f=a==="amount"?T:b*(T/100);(!Number.isFinite(f)||f<0)&&(f=0),f>b&&(f=b);const I=Math.max(0,b-f);let m=Number.isFinite(r)?Number(r):null;i&&(!Number.isFinite(m)||m<=0)&&(m=Oe);const C=m&&m>0?m:0,N=C>0?Math.max(0,I*(C/100)):0,$=I+N;let y=i?$*.15:0;(!Number.isFinite(y)||y<0)&&(y=0),y=Number(y.toFixed(2));const ce=$+y,q=Math.max(0,Number(ce.toFixed(2))),R=Math.max(0,q-y-N-g);return{rentalDays:o,equipmentTotal:p,crewTotal:v,crewCostTotal:g,discountAmount:f,subtotalAfterDiscount:I,taxableAmount:$,taxAmount:y,finalTotal:q,companySharePercent:C,companyShareAmount:N,netProfit:R}}function Xt(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:c=null,companySharePercent:r=null}={}){return U({items:e,technicianIds:i,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:r}).finalTotal}function Ye({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paidStatus:s,companySharePercent:c=null,companyShareAmount:r=null,taxAmount:o=null,netProfit:l=null,totalKey:p="reservations.summary.total"}){const d=u("reservations.create.summary.currency","SR"),h=S(String(e)),v=S(String(t)),g=S(String(n??1)),b=S(String(a)),T=s==="paid"?u("reservations.create.paymentStatus.paid","ŸÖÿØŸÅŸàÿπ"):u("reservations.create.paymentStatus.unpaid","ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ"),f=u("reservations.summary.itemsLabel","üì¶ ÿπÿØÿØ ÿßŸÑŸÖÿπÿØÿßÿ™"),I=u("reservations.summary.durationLabel","‚è±Ô∏è ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ"),m=u("reservations.summary.crewLabel","üòé ÿπÿØÿØ ÿßŸÑŸÅÿ±ŸäŸÇ"),C=u("reservations.summary.taxLabelShort","üßæ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©"),N=u("reservations.summary.paymentLabelShort","üí≥ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ"),$=u(p.replace(".total",".totalLabel"),"üí∞ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©"),y=u("reservations.summary.companyShareLabel","üè¶ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ¥ÿ±ŸÉÿ©"),ce=u("reservations.details.labels.netProfit","üíµ ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠"),q=Number.isFinite(l)?Math.max(0,Number(l)):null,R=[{label:f,value:v},{label:I,value:g},{label:m,value:b}];if(i){let D=u("reservations.summary.taxIncludedValue","ÿ¥ÿßŸÖŸÑ 15%");Number.isFinite(o)&&o>0&&(D=`${S(Number(o).toFixed(2))} ${d}`),R.push({label:C,value:D})}const w=Number.isFinite(c)?Number(c):null;if(w!==null&&w>0){const D=Number.isFinite(r)?Number(r):e*(w/100),O=S(String(w)),Je=S(Number.isFinite(D)?D.toFixed(2):"0"),Qe=`${O}% (${Je} ${d})`;R.push({label:y,value:Qe})}if(q!==null&&Math.abs(q-Number(e))>.009){const D=S(q.toFixed(2));R.push({label:ce,value:`${D} ${d}`})}R.push({label:N,value:T});const G=`${h} ${d}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${R.map(({label:D,value:O})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${D}</span>
            ${O?`<span class="reservation-summary-value">${O}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${$}</span>
          <span class="reservation-summary-value">${G}</span>
        </div>
      </div>
    </div>
  `}function Zt({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:c,companySharePercent:r=null}){const o=Et(),l=o.length,p=Number.isFinite(r)?Number(r):null,d=U({items:e,technicianIds:o,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:p}),h=Ye({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:l,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit});Dt(h)}function en({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:c,companySharePercent:r=null}){const o=It(),l=o.length,p=Number.isFinite(r)?Number(r):null,d=U({items:e,technicianIds:o,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:p});return Ye({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:l,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit,totalKey:"reservations.summary.totalAfterEdit"})}function Dt(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Be(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Be(n,e))}function Be(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Lt=F()||{};let z=(Lt.reservations||[]).map(Ct);function tn(){return z}function se(e){return z=Array.isArray(e)?e.map(ve):[],Le({reservations:z}),z}async function nn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,o])=>{o!=null&&o!==""&&t.set(r,String(o))});const n=t.toString(),i=(await x(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const c=s.map(be);return se(c)}async function an(e){const t=await x("/reservations/",{method:"POST",body:e}),n=be(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=U({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,se([...z,n]),n}async function Pt(e,t){const n=await x(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=be(n?.data??{});if(!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const s=U({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=s.companyShareAmount,a.cost=s.finalTotal,a.totalAmount=s.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const i=z.map(s=>String(s.id)===String(e)?a:s);return se(i),a}async function sn(e){await x(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=z.filter(n=>String(n.id)!==String(e));se(t)}async function cn(e){return Pt(e,{status:"confirmed",confirmed:!0})}function be(e={}){return ve({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount})}function Ct(e={}){return ve(e)}function ve(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map($t):[],i=Array.isArray(e.technicians)?e.technicians:[],s=i.map(y=>y==null?null:String(typeof y=="object"?y.id??y.technician_id??y.technicianId??y.ID??"":y)).filter(y=>y&&y!==""),c=e.start??e.start_datetime??"",r=e.end??e.end_datetime??"";let o=ne(e.total_amount??e.totalAmount??e.cost??0);const l=ne(e.discount??0),p=e.discount_type??e.discountType??"percent",d=["percent","amount"].includes(p)?p:"percent",h=!!(e.apply_tax??e.applyTax??!1),v=xt(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid",g=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),b=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,T=b!=null?Number.parseFloat(S(String(b).replace("%","").trim())):NaN,f=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let I=f!=null?f===!0||f===1||f==="1"||String(f).toLowerCase()==="true":Number.isFinite(T)&&T>0,m=I&&Number.isFinite(T)?Number(T):0;const C=e.company_share_amount??e.companyShareAmount;let N=Number.isFinite(Number(C))?Number(C):NaN;h&&m<=0&&(m=Oe,I=!0);const $=U({items:a,technicianIds:s,discount:l,discountType:d,applyTax:h,start:c,end:r,companySharePercent:m>0?m:null});return(!Number.isFinite(o)||o<=0||h)&&(o=$.finalTotal),(!Number.isFinite(N)||N<0)&&(N=$.companyShareAmount),N=Number.isFinite(N)?Number(N.toFixed(2)):0,!I&&m>0&&(I=!0),{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:c,end:r,status:Ft(e.status??(g?"confirmed":"pending")),confirmed:g,location:e.location??"",notes:e.notes??"",discount:l,discountType:d,applyTax:h,paid:v==="paid",paidStatus:v,totalAmount:o,cost:o,projectId:e.project_id??e.projectId??null,items:a,technicians:s,techniciansDetails:i.map(y=>typeof y=="object"?y:{id:Number(y)||y}),startDatetime:c,endDatetime:r,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:m,companyShareAmount:N,companyShareEnabled:I}}function $t(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=Ge(e.quantity??e.qty??1),a=ne(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:S(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function on({reservationCode:e,customerId:t,start:n,end:a,status:i,title:s,location:c,notes:r,projectId:o,totalAmount:l,discount:p,discountType:d,applyTax:h,paidStatus:v,confirmed:g,items:b,technicians:T,companySharePercent:f,companyShareEnabled:I}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:s??null,location:c??null,notes:r??null,project_id:o||null,total_amount:l??0,discount:p??0,discount_type:d??"percent",apply_tax:h?1:0,paid_status:v??"unpaid",confirmed:g===void 0?null:!!g,items:Array.isArray(b)?b.map(m=>({equipment_id:m.equipmentId??m.equipment_id??m.id,quantity:Ge(m.qty??m.quantity??1),unit_price:ne(m.price??m.unit_price??0),notes:m.notes??null})):[],company_share_percent:I&&Number.isFinite(f)?Number(f):null,company_share_enabled:I?1:0,technicians:Array.isArray(T)?T.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function ne(e){const t=Number(S(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Ge(e){const t=Number.parseInt(S(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function Ft(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"ŸÖÿπŸÑŸÇ":case"ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±":return"pending";case"confirmed":case"ŸÖÿ§ŸÉÿØ":return"confirmed";case"in_progress":case"in-progress":case"ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞":case"ÿ¨ÿßÿ±Ÿä":return"in_progress";case"completed":case"ŸÖŸÉÿ™ŸÖŸÑ":return"completed";case"cancelled":case"ŸÖŸÑÿ∫Ÿä":return"cancelled";default:return"pending"}}function xt(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"ŸÖÿØŸÅŸàÿπ":return"paid";case"partial":case"ŸÖÿØŸÅŸàÿπ ÿ¨ÿ≤ÿ¶ŸäÿßŸã":case"partial_paid":return"partial";case"unpaid":case"ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ":case"not_paid":default:return"unpaid"}}function rn(e){return e instanceof De}export{ft as A,on as B,an as C,Oe as D,Wt as E,Gt as F,qt as G,Ut as H,en as I,ge as J,It as K,Jt as L,sn as M,cn as N,nn as a,re as b,be as c,kt as d,Mt as e,Bt as f,tn as g,Xt as h,rn as i,Yt as j,Qt as k,Vt as l,Ct as m,Ne as n,Zt as o,Q as p,Ot as q,tt as r,qe as s,Ht as t,Pt as u,zt as v,Kt as w,wt as x,jt as y,Et as z};
