import{d as R,n as v,b as D,A as Se,s as gt,a as rn,m as cn,c as ln,i as un,l as dn,e as Ne,t as m,f as mn,h as A,j as bt,o as pn}from"./auth.js";const fn=R()||{};let Z=(fn.technicians||[]).map(_t);function vt(){return Z}function fe(e){return Z=Array.isArray(e)?e.map(_t):[],gt({technicians:Z}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),Z}async function hn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,r])=>{r!=null&&r!==""&&t.set(o,String(r))});const n=t.toString(),a=await D(`/technicians/${n?`?${n}`:""}`),s=Array.isArray(a?.data)?a.data.map(ze):[];return fe(s)}async function yn(e){const t=await D("/technicians/",{method:"POST",body:e}),n=ze(t?.data??{});return fe([...Z,n]),n}async function St(e,t){const n=await D(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=ze(n?.data??{}),s=Z.map(o=>String(o.id)===String(e)?a:o);return fe(s),a}async function gn(e){await D(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),fe(Z.filter(t=>String(t.id)!==String(e)))}function At({name:e,phone:t,email:n,role:a,department:s,dailyWage:o,dailyTotal:r,status:i,notes:c,active:l=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:s??null,daily_wage:o??0,daily_total:r??null,status:i??"available",notes:c??null,active:l?1:0}}function ze(e={}){return It({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function _t(e={}){return It(e)}function It(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",s=e.email??null,o=e.specialization??e.role??e.position??"",r=e.department??e.team??"",i=rt(e.daily_wage??e.dailyWage??e.wage??e.rate??0),c=rt(e.daily_total??e.dailyTotal??e.total??e.total_wage??i),l=ct(e.baseStatus??e.status??"available"),u=ct(e.status??e.baseStatus??"available"),h=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:s,role:o,department:r,dailyWage:i,dailyTotal:c,status:u,baseStatus:l,notes:h,active:p}}function rt(e){const t=Number.parseFloat(v(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function ct(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function Ee(e){return e instanceof Se}rn();cn();ln();document.addEventListener("DOMContentLoaded",()=>{un();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>dn()),e.dataset.listenerAttached="true")});function Ae(e){const t=Number(e)||0,a=Ne()==="ar"?"ar-SA-u-nu-latn":"en-US",s=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${v(s)} SR`}function Fa(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function Da(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function xa(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}…`:""}function Y(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const bn="technicianPositions:updated";let q=[],Tt=!1,de=null;function we(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function Nt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:s??null}}function vn(e){return q=Array.isArray(e)?e.map(we).filter(t=>t.name!=="").sort((t,n)=>ae(t).localeCompare(ae(n),"ar",{sensitivity:"base"})):[],Tt=!0,Pe(),W()}function Pe(){try{const e={positions:W()},t=new CustomEvent(bn,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function ae(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function W(){return q.map(e=>({...e}))}function Sn(e){const t=String(e??"").trim().toLowerCase();return t&&q.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function An({forceRefresh:e=!1}={}){return Tt&&!e?W():(de&&!e||(de=D("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return vn(n)}).finally(()=>{de=null})),de)}async function Be({forceRefresh:e=!1}={}){try{return await An({forceRefresh:e})}catch(t){throw t instanceof Se?t:new Se(t?.message||m("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"))}}async function _n({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}){const o=Nt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}),r=await D("/technician-positions/",{method:"POST",body:o}),i=we(r?.data??{});return q=[...q,i],q.sort((c,l)=>ae(c).localeCompare(ae(l),"ar",{sensitivity:"base"})),Pe(),i}async function In(e,{name:t,cost:n,clientPrice:a,labelAr:s,labelEn:o}){if(!e)throw new Error("Position id is required");const r=Nt({name:t,cost:n,clientPrice:a,labelAr:s,labelEn:o}),i=await D(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:r}),c=we(i?.data??{});return q=q.map(l=>l.id===c.id?c:l),q.sort((l,u)=>ae(l).localeCompare(ae(u),"ar",{sensitivity:"base"})),Pe(),c}async function Tn(e){if(!e)throw new Error("Position id is required");return await D(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),q=q.filter(t=>t.id!==Number(e)),Pe(),W()}const xe="__ART_RATIO_TECH_SUB_TAB__",Et=["technicians-management","technicians-positions"];let C=null,lt=!1,ve=!1,pe="",$e=!1,z=null,G="technicians-management";const ut=Nn();ut&&(G=ut);async function Pt({showToastOnError:e=!0}={}){if(!ve){ve=!0,pe="",L();try{await hn(),$e=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),pe=Ee(t)?t.message:m("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&A(pe,"error")}finally{ve=!1,L()}}}function Bt(){return vt()}function ge(e=""){return v(String(e)).trim().toLowerCase()}function dt(e){return e==null?"":String(e)}function ie(e=""){return v(String(e)).replace(/[^0-9+]/g,"")}function F(e=""){const t=v(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function ne(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function Nn(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(xe);return e&&Et.includes(e)?e:null}catch(e){return console.warn("⚠️ [technicians] Failed to read stored sub-tab",e),null}}function En(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Et.includes(e)){window.localStorage.removeItem(xe);return}window.localStorage.setItem(xe,e)}catch(t){console.warn("⚠️ [technicians] Failed to store sub-tab",t)}}function Ct(e,t=0,n=null){const a=String(e??"").trim(),s=a?Sn(a):null;return s?{matchedPosition:s,dailyWage:Number.isFinite(s.cost)?s.cost:0,dailyTotal:s.clientPrice==null?null:Number.isFinite(s.clientPrice)?s.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Lt(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function qe(e,t=Ne()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Pn(e,t=Ne()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function Ft(){const{container:e,body:t}=Lt();!e||!t||(t.textContent="",e.hidden=!0)}function ke(e,t={}){const{container:n,body:a}=Lt();if(!n||!a)return;const s=String(e??"").trim();if(!s){Ft();return}const o=Ct(s,t?.dailyWage??0,t?.dailyTotal??null),r=Ae(o.dailyWage||0),i=o.dailyTotal!=null?Ae(o.dailyTotal):m("technicians.positionSummary.noClientPrice","—");o.matchedPosition?a.textContent=m("technicians.positionSummary.match","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",r).replace("{price}",i):a.textContent=m("technicians.positionSummary.custom","لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}").replace("{cost}",r).replace("{price}",i),n.hidden=!1}function he(){const e=document.getElementById("technician-position-options");if(!e)return;const t=W(),n=Ne(),a=new Set,s=[];t.forEach(o=>{const r=qe(o,n).trim();r&&!a.has(r.toLowerCase())&&(s.push(`<option value="${Y(r)}"></option>`),a.add(r.toLowerCase()));const i=Pn(o,n).trim();i&&!a.has(i.toLowerCase())&&(s.push(`<option value="${Y(i)}"></option>`),a.add(i.toLowerCase()));const c=o.name?.trim();c&&!a.has(c.toLowerCase())&&(s.push(`<option value="${Y(c)}"></option>`),a.add(c.toLowerCase()))}),e.innerHTML=s.join("")}function mt(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),s=t.map(i=>i?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(i=>{if(!i)return;const l=i.getAttribute("data-tech-tab")===s;i.classList.toggle("tab-active",l),i.classList.toggle("active",l),i.setAttribute("aria-selected",l?"true":"false"),i.setAttribute("tabindex",l?"0":"-1")}),n.forEach(i=>{if(!i)return;const l=i.getAttribute("data-tech-tab-panel")===s;i.hidden=!l,i.classList.toggle("active",l)}),G=s,En(s);const r=t.find(i=>i?.getAttribute("data-tech-tab")===s)?.closest("[data-tab-scroll]");r&&r.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),s==="technicians-positions"&&(O(),Be().then(()=>{O()}).catch(i=>{console.error("❌ [technicians] failed to load positions for tab switch",i),A(i?.message||m("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}))}function He(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=m(n,a)}function Ve(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=m("technicians.form.actions.cancel","إلغاء التعديل"))}function je(){He(C?"update":"add"),Ve(!!C),L()}function Bn(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(o=>(o?.role||"").trim()).filter(Boolean))).sort((o,r)=>o.localeCompare(r,"ar",{sensitivity:"base"})),s=m("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${s}</option>`+a.map(o=>`<option value="${o}">${o}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function Ce(){const e=document.getElementById("technician-form");e&&(e.reset(),C=null,He("add"),Ve(!1),Ft())}function Cn(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),s=document.getElementById("technician-department"),o=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=ie(e.phone||""),a.value=e.role||"",s&&(s.value=e.department||""),o&&(o.value=e.notes||""),C=String(e.id),He("update"),Ve(!0),ke(a.value,e))}function Ln(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),s=document.getElementById("technician-notes");if(!e||!t||!n)return null;const o=e.value.trim(),r=ie(t.value.trim());t.value=r;const i=n.value.trim(),c=a?.value.trim()||"",l="available",u=s?.value.trim()||"",h=C?xt(C):null,{dailyWage:p,dailyTotal:y}=Ct(i,h?.dailyWage??0,h?.dailyTotal??null);return o?r?i?!Number.isFinite(p)||p<0?(A(m("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),null):y!=null&&(!Number.isFinite(y)||y<0)?(A(m("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),null):(ke(i,{dailyWage:p,dailyTotal:y}),{name:o,phone:r,role:i,department:c,dailyWage:Number.isFinite(p)?p:0,dailyTotal:y==null?null:Number(y),status:l,baseStatus:l,notes:u}):(A(m("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(A(m("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(A(m("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function Fn(e){e.preventDefault();try{await Be()}catch(a){console.error("❌ [technicians] failed to load positions before submit",a);const s=a?.message||m("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");A(s,"error");return}const t=Ln();if(!t)return;const n=At({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{C?(await St(C,n),A(m("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await yn(n),A(m("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),Ce(),L()}catch(a){console.error("❌ [technicians] handleTechnicianSubmit failed",a);const s=Ee(a)?a.message:m("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");A(s,"error")}}function Dn(){Ce()}function xn(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=ie(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=F(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const s=F(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==s&&(t.total.value=s);const o=e.baseStatus||e.status||"available";t.status.value!==o&&(t.status.value=o),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),ne(t.phone,ie),ne(t.wage,F),ne(t.total,F)}function $n(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),s=document.getElementById("edit-technician-department"),o=document.getElementById("edit-technician-wage"),r=document.getElementById("edit-technician-total"),i=document.getElementById("edit-technician-status"),c=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!o||!r||!i)return null;const l=e.value.trim(),u=t.value.trim(),h=ie(n.value.trim());n.value=h;const p=a.value.trim(),y=s?.value.trim()||"",f=F(o.value.trim());o.value=f;const g=f===""?0:parseFloat(f),S=F(r.value.trim());r.value=S;const b=S===""?null:parseFloat(S),_=i.value||"available",I=c?.value.trim()||"";return l?u?h?p?Number.isNaN(g)||g<0?(A(m("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),o.focus(),null):b!=null&&(Number.isNaN(b)||b<0)?(A(m("technicians.toast.invalidTotal","⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية")),r.focus(),null):{id:l,name:u,phone:h,role:p,department:y,dailyWage:Number.isFinite(g)?g:0,dailyTotal:b==null?null:Number(b),status:_,baseStatus:_,notes:I}:(A(m("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),a.focus(),null):(A(m("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(A(m("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(A(m("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function qn(){const e=$n();if(!e)return;const t=At({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await St(e.id,t),A(m("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),L()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const a=Ee(n)?n.message:m("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");A(a,"error")}}function L(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=ge(t?.value||"");if(ve&&!$e){const l=m("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}if(pe&&!$e){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${pe}</td></tr>`;return}const a=qt(),{reservations:s=[]}=R(),o=new Date;Bn(a);const r=document.getElementById("technician-role-filter"),i=ge(r?.value||""),c=a.filter(l=>i&&ge(l.role||"")!==i?!1:n?ge([l.name,l.phone,l.role,l.department,l.notes].filter(Boolean).join(" ")).includes(n):!0);if(c.length===0){const l=m("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}e.innerHTML=c.map(l=>{const u=C&&String(C)===String(l.id),y=($t(l.id,s,o)?"busy":l.status||l.baseStatus||"available")==="busy"?{label:m("technicians.status.busy","⛔ مشغول"),className:"technician-status-badge technician-status-badge--busy"}:{label:m("technicians.status.available","✅ متاح"),className:"technician-status-badge technician-status-badge--available"},f=m("technicians.actions.edit","✏️ تعديل"),g=m("technicians.actions.delete","🗑️ حذف"),S=bt(),b=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${l.id}">${f}</button>`];return S&&b.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${l.id}">${g}</button>`),`
      <tr${u?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${l.id}" class="text-decoration-none">${l.name}</a></td>
        <td>${l.role||""}</td>
        <td>${l.department||"—"}</td>
        <td><span class="${y.className}"><span class="technician-status-badge__text">${y.label}</span></span></td>
        <td class="table-notes-cell">${l.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${b.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Le(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function Dt(e="add"){const{submitBtn:t,cancelBtn:n}=Le(),a=e==="update";if(t){const s=a?"positions.form.actions.update":"positions.form.actions.submit",o=a?"💾 حفظ المنصب":"➕ إضافة منصب";t.textContent=m(s,o)}n&&(n.classList.toggle("d-none",!a),n.textContent=m("positions.form.actions.cancel","إلغاء"))}function Oe(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:s,clientPriceInput:o}=Le();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),s&&(s.value=""),o&&(o.value=""),z=null,Dt("add")}function Rn(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:s,clientPriceInput:o}=Le();!e||!s||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),s.value=F(e.cost??0),o&&(o.value=e.clientPrice==null?"":F(e.clientPrice)),z=e.id||null,Dt("update"))}function Mn(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=Le();if(!n)return null;const s=e?.value.trim()||"",o=t?.value.trim()||"",r=o||s,i=z?W().find(p=>String(p.id)===String(z)):null,c=F(n.value.trim());n.value=c;const l=c===""?0:parseFloat(c),u=a?F(a.value.trim()):"";a&&(a.value=u);const h=u===""?null:parseFloat(u);return r?!Number.isFinite(l)||l<0?(A(m("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),n.focus(),null):h!=null&&(!Number.isFinite(h)||h<0)?(A(m("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),a?.focus(),null):{id:z,name:i?.name||r,cost:Number(l.toFixed(2)),clientPrice:h==null?null:Number(h.toFixed(2)),labelAr:s||null,labelEn:o||null}:(A(m("positions.toast.invalidName","⚠️ يرجى إدخال اسم المنصب")),e&&e.focus(),null)}function se(){const e=document.getElementById("technician-role");if(!e)return;const t=C?xt(C):null;ke(e.value,t||{})}function O(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=W();if(t&&(t.textContent=v(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${m("positions.table.empty","لا توجد مناصب بعد.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const s=z&&String(z)===String(a.id),o=Ae(a.cost||0),r=a.clientPrice==null?m("technicians.positionSummary.noClientPrice","—"):Ae(a.clientPrice),i=qe(a,"ar")||"—",c=qe(a,"en")||"—",l=m("positions.table.actions.edit","✏️ تعديل"),u=m("positions.table.actions.delete","🗑️ حذف");return`
      <tr${s?' class="technician-table-row-editing"':""}>
        <td>${Y(i)}</td>
        <td>${Y(c)}</td>
        <td>${Y(o)}</td>
        <td>${Y(r)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${l}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${u}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function zn(e){e.preventDefault();const t=Mn();if(t)try{const n=!!z;n?await In(t.id,t):await _n(t);const a=n?m("positions.toast.updateSuccess","💾 تم حفظ بيانات المنصب"):m("positions.toast.addSuccess","✅ تم إضافة المنصب");A(a),Oe(),O(),he(),se()}catch(n){console.error("❌ [technicians] handlePositionSubmit failed",n);const a=n?.message||m("positions.toast.saveFailed","⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى");A(a,"error")}}function wn(){Oe()}async function kn(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Be();const a=W().find(s=>String(s.id)===String(n));if(!a){A(m("positions.toast.notFound","⚠️ تعذر العثور على بيانات المنصب"),"error");return}Rn(a),O();return}if(t.classList.contains("position-delete-btn")){if(!confirm(m("positions.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا المنصب؟")))return;await Tn(n),z&&String(z)===String(n)&&Oe(),A(m("positions.toast.deleteSuccess","🗑️ تم حذف المنصب")),O(),he(),se()}}catch(t){console.error("❌ [technicians] handlePositionsTableClick failed",t);const n=t?.message||m("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");A(n,"error")}}function Hn(e){const t=Bt().find(n=>String(n.id)===String(e));if(!t){A(m("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}Cn(t),A(m("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function Vn(e){if(!bt()){pn();return}if(confirm(m("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await gn(e),A(m("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),C&&String(C)===String(e)&&Ce(),L()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=Ee(t)?t.message:m("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");A(n,"error")}}function $a(){Ue(),L()}function xt(e){return Bt().find(t=>String(t.id)===String(e))||null}function $t(e,t=[],n){const a=dt(e);return a?t.some(s=>{if(!s||!s.start||!s.end||!(Array.isArray(s.technicians)?s.technicians:[]).some(c=>dt(c)===a))return!1;const r=new Date(s.start),i=new Date(s.end);return Number.isNaN(r.getTime())||Number.isNaN(i.getTime())?!1:r<=n&&n<i}):!1}function qt(){const e=R().reservations||[],t=vt();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const s=t.map(o=>{if(!o)return o;const r=o.baseStatus||o.status||"available";let i=r==="busy"?"busy":r;return $t(o.id,e,n)&&(i="busy"),(i!==o.status||r!==o.baseStatus)&&(a=!0),{...o,baseStatus:r,status:i}});return a?(fe(s),s):t}function Ue(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{Fn(p).catch(y=>{console.error("❌ [technicians] submit handler failed",y)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Dn),n.dataset.listenerAttached="true"),ne(document.getElementById("technician-phone"),ie);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{se()}),a.dataset.listenerAttached="true");const s=document.getElementById("technicians-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",p=>{const y=p.target;if(y instanceof HTMLElement){if(y.classList.contains("technician-edit-btn")){const f=y.dataset.id;Hn(f)}if(y.classList.contains("technician-delete-btn")){const f=y.dataset.id;Vn(f).catch(g=>{console.error("❌ [technicians] delete handler failed",g)})}}}),s.dataset.listenerAttached="true");const o=document.getElementById("search-technician-input");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",()=>{o.value=v(o.value),L()}),o.dataset.listenerAttached="true");const r=document.getElementById("technician-role-filter");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{L()}),r.dataset.listenerAttached="true");const i=document.getElementById("save-technician-changes");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",()=>{qn().catch(p=>{console.error("❌ [technicians] modal save failed",p)})}),i.dataset.listenerAttached="true");const c=document.getElementById("position-form");c&&!c.dataset.listenerAttached&&(c.addEventListener("submit",p=>{zn(p).catch(y=>{console.error("❌ [technicians] position submit failed",y)})}),c.dataset.listenerAttached="true");const l=document.getElementById("position-cancel-btn");l&&!l.dataset.listenerAttached&&(l.addEventListener("click",wn),l.dataset.listenerAttached="true");const u=document.getElementById("positions-table");u&&!u.dataset.listenerAttached&&(u.addEventListener("click",kn),u.dataset.listenerAttached="true"),ne(document.getElementById("position-cost"),F),ne(document.getElementById("position-client-price"),F);const h=document.querySelector("[data-tech-tabs]");h&&!h.dataset.listenerAttached&&(h.querySelectorAll("[data-tech-tab]").forEach(y=>{y&&y.addEventListener("click",()=>{const f=y.getAttribute("data-tech-tab");mt(f)})}),h.dataset.listenerAttached="true"),mt(G),Be().then(()=>{he(),G==="technicians-positions"&&O(),se()}).catch(p=>{console.error("❌ [technicians] failed to load technician positions",p),A(p?.message||m("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}),lt||(document.addEventListener("technician:prefill",p=>{const y=p.detail;y&&xn(y)}),lt=!0),t&&Ce(),G==="technicians-positions"&&O()}window.addEventListener("DOMContentLoaded",()=>{Ue(),L(),je(),Pt()});const Rt=()=>{L()};window.addEventListener("technicians:updated",Rt);document.addEventListener("technicians:updated",Rt);document.addEventListener("technicians:refreshRequested",()=>{Ue(),L(),je(),Pt({showToastOnError:!1})});document.addEventListener("language:changed",()=>{je(),he(),G==="technicians-positions"&&O(),se()});document.addEventListener(mn.USER_UPDATED,()=>{L()});const Mt=()=>{he(),G==="technicians-positions"&&O(),se()};window.addEventListener("technicianPositions:updated",Mt);document.addEventListener("technicianPositions:updated",Mt);function me(e){return v(String(e||"")).trim().toLowerCase()}function U(e){const t=String(e??"").trim().toLowerCase();return t||""}function zt(){const{packages:e=[]}=R();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function jn(e){const t=U(e);return t&&zt().find(a=>U(a?.id??a?.packageId??a?.package_id)===t)||null}function We(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(i=>({barcode:i}))),n.forEach(i=>{if(!i)return;if(typeof i=="string"||typeof i=="number"){const p=me(i);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof i!="object")return;const c=me(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number),l=[i.equipmentId,i.equipment_id,i.itemId,i.item_id,i.id].find(p=>p!=null&&p!==""),u=[i.unit_price,i.unitPrice,i.price,i.daily_rate].find(p=>Number.isFinite(Number(p))),h=[i.quantity,i.qty,i.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:l!=null?String(l):null,barcode:i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??"",normalizedBarcode:c,qty:h!=null?Number(h):1,price:u!=null?Number(u):0,desc:i.description??i.desc??i.name??"",image:i.image??i.imageUrl??i.img??null})});const a=new Map,{equipment:s=[]}=R()||{},o=new Map,r=new Map;return(Array.isArray(s)?s:[]).forEach(i=>{if(!i||typeof i!="object")return;[i.id,i.equipment_id,i.equipmentId,i.item_id,i.itemId].map(u=>u!=null?String(u):"").filter(Boolean).forEach(u=>{o.has(u)||o.set(u,i)});const l=me(i.barcode);l&&!r.has(l)&&r.set(l,i)}),t.forEach(i=>{if(i.equipmentId&&o.has(i.equipmentId)){const c=o.get(i.equipmentId);if(c){if(i.desc||(i.desc=c.desc||c.description||c.name||""),i.barcode||(i.barcode=c.barcode||""),i.price==null||i.price===0){const l=c.price??c.unit_price;Number.isFinite(Number(l))&&(i.price=Number(l))}i.image||(i.image=c.image||c.imageUrl||c.img||null)}}else if(i.normalizedBarcode&&r.has(i.normalizedBarcode)){const c=r.get(i.normalizedBarcode);if(c){if(i.desc||(i.desc=c.desc||c.description||c.name||""),i.barcode||(i.barcode=c.barcode||""),i.price==null||i.price===0){const l=c.price??c.unit_price;Number.isFinite(Number(l))&&(i.price=Number(l))}i.image||(i.image=c.image||c.imageUrl||c.img||null)}}}),t.forEach(i=>{const c=i.normalizedBarcode||(i.barcode?me(i.barcode):""),l=c||(i.equipmentId?`id:${i.equipmentId}`:null);if(!l)return;if(!a.has(l)){a.set(l,{...i,normalizedBarcode:c});return}const u=a.get(l);u.qty+=i.qty,!u.price&&i.price&&(u.price=i.price),!u.desc&&i.desc&&(u.desc=i.desc),!u.image&&i.image&&(u.image=i.image)}),Array.from(a.values())}function On(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const a of t){const s=Number(a);if(Number.isFinite(s))return s}return We(e).reduce((a,s)=>a+(s.price||0)*(s.qty||1),0)}function Un(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Wn(){return zt().map(t=>{const n=U(t?.id??t?.packageId??t?.package_id??t?.code),a=Un(t)||n||"package",s=On(t);return{id:n,name:a,price:s,code:t?.package_code??t?.code??n,items:We(t),raw:t}}).filter(t=>t.id)}function Kn(e){const t=me(e);return t?Wn().filter(n=>n.items.some(a=>a.normalizedBarcode===t)):[]}function Yn(e){return We(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let oe=[],wt=[],kt=[],Ht="single";function qa(){return oe}function Ra(e){oe=Array.isArray(e)?e:[]}function Ma(e){oe=[...oe,e]}function za(e){Number.isInteger(e)&&e>=0&&(oe=oe.filter((t,n)=>n!==e))}function wa(){return wt}function ka(e){wt=Array.isArray(e)?e:[]}function Ha(){return kt}function Va(e){kt=Array.isArray(e)?e:[]}function ja(e){}function Oa(){return Ht==="package"?"package":"single"}function Ua(e){Ht=e==="package"?"package":"single"}function Wa(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",s=""]=n.split("T"),o=a?a.slice(0,10):"",r=s.match(/(\d{1,2}:\d{2})/);let i="";if(r){const[c="00",l="00"]=r[0].split(":");i=`${c.padStart(2,"0")}:${l.padStart(2,"0")}`}return{date:o,time:i}}function be(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function $(e){return v(String(e||"")).trim().toLowerCase()}const Zn=864e13;function H(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const s=new Date(a);if(!Number.isNaN(s.getTime()))return s}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function Ka(e,t,n,a=null){if(!e||!t||!n)return!1;const s=H(t),o=H(n);if(!s||!o||s>=o)return!1;const r=$(e);if(!r)return!1;const i=R()||{},c=Array.isArray(i.reservations)?i.reservations:[],l=Array.isArray(i.maintenance)?i.maintenance:[],u=Array.isArray(i.equipment)?i.equipment:[],h=sa(u),p=Ye(a);return c.some(f=>{if(!f||Ze(f,p)||!f.start||!f.end)return!1;const g=H(f.start),S=H(f.end);return!g||!S||!(g<o&&S>s)?!1:Jn(f,r)})?!0:l.some(f=>{if(!ea(f)||!na(f,h).has(r))return!1;const{start:S,end:b}=aa(f);if(!S&&!b)return!0;const _=S??new Date(0),I=b??new Date(Zn);return _<o&&I>s})}function Gn(e,t,n,a=null){const s=U(e);if(!s||!t||!n)return!1;const o=H(t),r=H(n);if(!o||!r||o>=r)return!1;const i=R()||{},c=Array.isArray(i.reservations)?i.reservations:[],l=Ye(a);return c.some(u=>{if(!u?.start||!u?.end||Ze(u,l))return!1;const h=H(u.start),p=H(u.end);return!h||!p||!(h<r&&p>o)?!1:Xn(u,s)})}function Ya(e,t,n,a=null){const s=$(e);if(!s||!t||!n)return[];const o=Kn(s);return o.length?o.filter(r=>Gn(r.id,t,n,a)):[]}function Vt(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(a=>{const s=e[a];Array.isArray(s)&&s.length&&t.push(s)}),t}function Jn(e,t){if(!t||!e||typeof e!="object")return!1;const n=$(e?.barcode);if(n&&n===t)return!0;const a=Vt(e);for(const s of a)for(const o of s)if(Qn(o).has(t))return!0;return!1}function Xn(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const o of n){if(!o&&o!==0)continue;const r=U(o);if(r&&r===t)return!0}const a=e.packages;if(Array.isArray(a))for(const o of a){const r=U(o);if(r&&r===t)return!0}const s=Vt(e);for(const o of s)for(const r of o)if(Ke(r).has(t))return!0;return!1}function Qn(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const o=$(e);return o&&t.add(o),t}if(typeof e!="object")return t;const n=$(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(o=>{const r=e[o];Array.isArray(r)&&r.forEach(i=>{if(i!=null){if(typeof i=="string"||typeof i=="number"){const c=$(i);c&&t.add(c);return}if(typeof i=="object"){const c=$(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number);c&&t.add(c)}}})});const s=Ke(e);return s.size&&s.forEach(o=>{const r=jn(o);if(!r)return;Yn(r).forEach(c=>{const l=c.normalizedBarcode??$(c.barcode);l&&t.add(l)})}),t}function Ke(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(a=>{const s=U(a);s&&t.add(s)}),e.package&&typeof e.package=="object"&&Ke(e.package).forEach(s=>t.add(s)),Array.isArray(e.packages)&&e.packages.forEach(a=>{const s=U(a);s&&t.add(s)}),t}function ea(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(ia(e))return!1;for(const n of t){const a=ta(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function ta(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="مكتمل"||t==="مغلق"?"completed":t==="cancelled"||t==="canceled"||t==="ملغي"?"cancelled":t==="in_progress"||t==="in-progress"||t==="قيد_التنفيذ"||t==="جاري_العمل"||t==="inprogress"?"in_progress":t==="open"||t==="قيد_الصيانة"||t==="قيد_الانتظار"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("تنفيذ")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function na(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(r=>{const i=$(r);i&&n.add(i)});const s=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(s){const r=$(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);r&&n.add(r)}return[e?.equipmentId,e?.equipment_id,s?.id,s?.equipmentId,s?.equipment_id].map(r=>r!=null?String(r):"").filter(Boolean).forEach(r=>{const i=t.get(r);if(!i)return;const c=$(i?.barcode??i?.equipmentBarcode??i?.code??i?.serial??i?.serialNumber??i?.serial_number);c&&n.add(c)}),n}function aa(e){const t=Re([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=Re([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function ia(e){return!!Re([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function Re(e=[]){for(const t of e){const n=H(t);if(n)return n}return null}function sa(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{t.has(s)||t.set(s,n)})}),t}function oa(e,t,n,a=null){if(!e||!t||!n)return!1;const s=new Date(t),o=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:r=[]}=R(),i=String(e),c=Ye(a);return r.some(l=>{if(!l?.start||!l?.end||Ze(l,c))return!1;const u=new Date(l.start),h=new Date(l.end);return Number.isNaN(u.getTime())||Number.isNaN(h.getTime())||!(u<o&&h>s)?!1:(Array.isArray(l.technicians)?l.technicians:[]).some(f=>String(f)===i)})}function Ye(e){return ee(e,new Set)}function Ze(e,t){if(!t||t.size===0)return!1;const n=ee([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function ee(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(o=>ee(o,t)),t;if(Array.isArray(e))return e.forEach(o=>ee(o,t)),t;if(typeof e=="object"){const o=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let r=!1;return o.forEach(i=>{Object.prototype.hasOwnProperty.call(e,i)&&(r=!0,ee(e[i],t))}),r||Object.values(e).forEach(i=>ee(i,t)),t}const n=v(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],s=n.replace(/\D+/g,"");if(s){a.push(s);const o=Number.parseInt(s,10);Number.isNaN(o)||a.push(String(o))}return a.forEach(o=>{o&&t.add(o)}),t}let J=[],V=[],j=[],_e="create",Ge=()=>{},Je=()=>{};function ra(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=v(String(n)),s=Number.parseFloat(a);if(Number.isFinite(s))return s}return 0}function jt(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const s of t){if(s==null||s==="")continue;const o=parseFloat(v(String(s)));if(Number.isFinite(o)){n=o;break}}if((!Number.isFinite(n)||n<=0)&&(n=ra(e)),!Number.isFinite(n)||n<=0)return"—";const a=m("technicians.table.wageSuffix","SR");return`${v(String(n))} ${a}`}function pt(e=""){return v(String(e)).trim().toLowerCase()}function Ot(e){return!J||!J.length?null:J.find(t=>String(t?.id)===String(e))||null}function ca(e,t="create"){t==="edit"?et(j.filter(n=>String(n)!==String(e))):Qe(V.filter(n=>String(n)!==String(e)))}function Ie(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const s=m("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.");a.innerHTML=`<span class="text-muted">${s}</span>`;return}a.innerHTML=t.map(s=>{const o=Ot(s)||{},r=m("reservations.crew.fallbackName","عضو الطاقم {id}").replace("{id}",s),i=o.name||r,c=o.role?`<small class="technician-chip-role">${o.role}</small>`:"",l=jt(o),u=l!=="—"?`<small class="technician-chip-wage">💰 ${l}</small>`:"",h=m("reservations.crew.removeAria","إزالة");return`
        <span class="technician-chip" data-id="${s}">
          <span class="technician-chip-name">${i}</span>
          ${c}
          ${u}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${s}" aria-label="${h}">✖</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(s=>{s.dataset.listenerAttached||(s.addEventListener("click",()=>ca(s.dataset.id,s.dataset.context)),s.dataset.listenerAttached="true")})}}function Ut(){return _e==="edit"?j:V}function Te(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=pt(t?.value||""),a=new Set(Ut().map(String)),o=(J||[]).filter(r=>n?pt([r.name,r.phone,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(o.length===0){const r=m("reservations.crew.searchEmpty","لا يوجد نتائج مطابقة.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${r}</td></tr>`;return}e.innerHTML=o.map(r=>{const i=jt(r);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${r.id}" ${a.has(String(r.id))?"checked":""}>
        </td>
        <td>${r.name||"-"}</td>
        <td>${r.role||"—"}</td>
        <td>${r.department||"—"}</td>
        <td>${i}</td>
      </tr>
    `}).join("")}function la(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function ua(e="create"){if(e==="edit"){const i=document.getElementById("edit-res-start")?.value?.trim(),c=document.getElementById("edit-res-end")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",h=i?be(i,l):null,p=c?be(c,u):null;let y=null;const f=document.getElementById("edit-res-index")?.value;if(f!=null){const g=Number.parseInt(f,10);if(Number.isInteger(g)){const{reservations:S=[]}=R(),b=S?.[g];b&&(y=b.id??b.reservationId??null)}}return{start:h,end:p,ignoreReservationId:y}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",s=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=t?be(t,a):null,r=n?be(n,s):null;return{start:o,end:r,ignoreReservationId:null}}function re(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=Ut().length;if(t){const n=m("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",v(String(t)));e.textContent=n}else e.textContent=m("technicians.picker.selectionInfo","No crew selected yet")}function da(){const e=la().map(String),{start:t,end:n,ignoreReservationId:a}=ua(_e);if(t&&n){const o=e.filter(r=>oa(r,t,n,a));if(o.length>0){const r=o.map(c=>Ot(c)?.name||c).join(m("reservations.list.crew.separator","، ")),i=m("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",r);o.forEach(c=>{const l=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(c))}"]`);l&&(l.checked=!1)}),A(i),re();return}}_e==="edit"?et(e):Qe(e),re();const s=document.getElementById("selectTechniciansModal");s&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s)?.hide?.()}function ft(e="create"){_e=e;const t=qt();Array.isArray(t)&&t.length&&(J=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),Te(),re();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function ma(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ft("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>ft("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Te(),re()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",da),a.dataset.listenerAttached="true");const s=document.getElementById("selectTechniciansModal");s&&!s.dataset.listenerAttached&&window.bootstrap?.Modal&&(s.addEventListener("shown.bs.modal",()=>{re(),Te()}),s.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("technician-picker-search");o&&(o.value="")}),s.dataset.listenerAttached="true"),Xe()}function Xe(){Ie("selected-technicians-list",V,"create"),Ie("edit-selected-technicians-list",j,"edit")}function Za({onDraftChange:e,onEditChange:t}={}){Ge=typeof e=="function"?e:()=>{},Je=typeof t=="function"?t:()=>{},Xe(),ma()}function pa(e=[]){J=Array.isArray(e)?e:[]}function fa(){return[...V]}function ha(){return[...j]}function Qe(e=[]){V=Array.isArray(e)?e.map(String):[],Ie("selected-technicians-list",V,"create"),Ge()}function et(e=[]){j=Array.isArray(e)?e.map(String):[],Ie("edit-selected-technicians-list",j,"edit"),Je()}function Ga(){Qe([])}function Ja(){et([])}function Xa(e=[]){pa(e);const t=new Set(J.map(i=>String(i.id))),n=V.filter(i=>t.has(String(i))),a=j.filter(i=>t.has(String(i))),s=n.length!==V.length,o=a.length!==j.length;V=n,j=a,Xe(),s&&Ge(),o&&Je();const r=document.getElementById("selectTechniciansModal");r&&r.classList.contains("show")&&(Te(),re())}const Wt=10;function Kt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function ya(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=Number(n);if(Number.isFinite(a))return a}return Kt(e)}function ga(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=R();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,s)=>{const o=n.get(String(s));if(!o)return a;const r=Kt(o),i=ya(o);return{costPerDay:a.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:a.totalPerDay+(Number.isFinite(i)?i:0)}},{costPerDay:0,totalPerDay:0})}const ba=1440*60*1e3,te=.01;function Q(e){if(e==null||e==="")return null;const t=v(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function ht(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let s=Number.isFinite(e)?e:0;if(s<t&&(s=t),s>n&&(s=n),a!=null){const o=10**a;s=Math.round(s*o)/o}return s}function Yt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function tt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:s=null,history:o=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,i=t==="amount"?"amount":t==="percent"?"percent":null;let c=Q(a),l=Q(s);const u=Q(n);let h=0,p=0;Array.isArray(o)&&o.length&&o.forEach(b=>{if(!b)return;const _=b.type==="amount"||b.type==="percent"?b.type:null,I=Q(b.value),P=Q(b.amount),T=Q(b.percentage);if(_==="amount"){const N=P??I;N!=null&&(h+=N,r>0&&(p+=N/r*100))}else if(_==="percent"){const N=T??I;N!=null&&(p+=N,r>0&&(h+=N/100*r))}else P!=null&&(h+=P,r>0&&(p+=P/r*100)),T!=null&&(p+=T,r>0&&(h+=T/100*r))}),i==="amount"&&u!=null?c=u:i==="percent"&&u!=null?l=u:i===null&&u!=null&&(l!=null?l=u:c=u),(c==null||c<=0)&&l!=null&&l>0&&r>0&&(c=r*(l/100)),(l==null||l<=0)&&c!=null&&c>0&&r>0&&(l=c/r*100);const y=c??0,f=l??0;c=y+h,l=f+p,c=ht(c??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),l=ht(l??0,{min:0,max:100,precision:2});let g=i;return g||(c>0&&r>0?g="amount":l>0&&(g="percent")),{paidAmount:c,paidPercent:l,paymentProgressType:g,paymentProgressValue:g==="amount"?c:g==="percent"?l:null}}function nt({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const s=Yt(e),o=Number.isFinite(Number(a))?Number(a):0,r=Number.isFinite(Number(t))?Number(t):0,i=Number.isFinite(Number(n))?Number(n):0;if(s==="paid")return"paid";const c=o>0&&r>=o-te,l=i>=100-te*100;if(c||l)return"paid";const u=r>te||i>te;return s==="partial"||u?"partial":"unpaid"}function va(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const s=a.getTime()-n.getTime();if(s<=0)return 1;const o=s/ba;return Math.max(1,Math.ceil(o))}function ce({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:s=!1,start:o=null,end:r=null,companySharePercent:i=null}={}){const c=va(o,r),u=(e||[]).reduce((le,E)=>le+(Number(E?.qty)||1)*(Number(E?.price)||0),0)*c,{costPerDay:h,totalPerDay:p}=ga(t),y=p*c,f=h*c,g=u+y,S=Number(n)||0;let b=a==="amount"?S:g*(S/100);(!Number.isFinite(b)||b<0)&&(b=0),b>g&&(b=g);const _=Math.max(0,g-b);let I=Number.isFinite(i)?Number(i):null;s&&(!Number.isFinite(I)||I<=0)&&(I=Wt);const P=I&&I>0?I:0,T=P>0?Math.max(0,_*(P/100)):0,N=_+T;let B=s?N*.15:0;(!Number.isFinite(B)||B<0)&&(B=0),B=Number(B.toFixed(2));const d=N+B,K=Math.max(0,Number(d.toFixed(2))),M=Math.max(0,u+y-f);return{rentalDays:c,equipmentTotal:u,crewTotal:y,crewCostTotal:f,discountAmount:b,subtotalAfterDiscount:_,taxableAmount:N,taxAmount:B,finalTotal:K,companySharePercent:P,companyShareAmount:T,netProfit:M}}function Qa(e=[],t=0,n="percent",a=!1,s=[],{start:o=null,end:r=null,companySharePercent:i=null}={}){return ce({items:e,technicianIds:s,discount:t,discountType:n,applyTax:a,start:o,end:r,companySharePercent:i}).finalTotal}function Zt({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:s,paymentStatus:o,paidAmount:r=0,paidPercent:i=0,companySharePercent:c=null,companyShareAmount:l=null,taxAmount:u=null,netProfit:h=null,totalKey:p="reservations.summary.total"}){const y=m("reservations.create.summary.currency","SR"),f=v(String(e)),g=v(String(t)),S=v(String(n??1)),b=v(String(a)),_=Yt(o),I=_==="paid"?"مدفوع":_==="partial"?"مدفوع جزئياً":"غير مدفوع",P=m(`reservations.create.paymentStatus.${_}`,I),T=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,N=Number.isFinite(Number(i))?Math.max(0,Number(i)):0,B=T>te||N>te,d=m("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),K=v(T.toFixed(2)),M=v(N.toFixed(N%1?2:0)),le=m("reservations.summary.itemsLabel","📦 عدد المعدات"),E=m("reservations.summary.durationLabel","⏱️ عدد الأيام"),Jt=m("reservations.summary.crewLabel","😎 عدد الفريق"),Xt=m("reservations.summary.taxLabelShort","🧾 الضريبة"),Qt=m("reservations.summary.paymentLabelShort","💳 حالة الدفع"),en=m(p.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),tn=m("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),nn=m("reservations.details.labels.netProfit","💵 صافي الربح"),De=Number.isFinite(h)?Math.max(0,Number(h)):null,X=[{label:le,value:g},{label:E,value:S},{label:Jt,value:b}];if(s){let w=m("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(u)&&u>0&&(w=`${v(Number(u).toFixed(2))} ${y}`),X.push({label:Xt,value:w})}const ye=Number.isFinite(c)?Number(c):null;if(ye!==null&&ye>0){const w=Number.isFinite(l)?Number(l):e*(ye/100),ue=v(String(ye)),sn=v(Number.isFinite(w)?w.toFixed(2):"0"),on=`${ue}% (${sn} ${y})`;X.push({label:tn,value:on})}if(De!==null&&Math.abs(De-Number(e))>.009){const w=v(De.toFixed(2));X.push({label:nn,value:`${w} ${y}`})}X.push({label:Qt,value:P}),B&&X.push({label:d,value:`${K} ${y} (${M}%)`});const an=`${f} ${y}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${X.map(({label:w,value:ue})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${w}</span>
            ${ue?`<span class="reservation-summary-value">${ue}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${en}</span>
          <span class="reservation-summary-value">${an}</span>
        </div>
      </div>
    </div>
  `}function Sa({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:s,paymentProgressType:o=null,paymentProgressValue:r=null,start:i,end:c,companySharePercent:l=null,paymentHistory:u=[]}){const h=fa(),p=h.length,y=Number.isFinite(l)?Number(l):null,f=ce({items:e,technicianIds:h,discount:t,discountType:n,applyTax:a,start:i,end:c,companySharePercent:y}),g=tt({totalAmount:f.finalTotal,progressType:o,progressValue:r,history:u}),S=nt({manualStatus:s,paidAmount:g.paidAmount,paidPercent:g.paidPercent,totalAmount:f.finalTotal}),b=Zt({total:f.finalTotal,itemsCount:e.length,rentalDays:f.rentalDays,techniciansCount:p,applyTax:a,paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,taxAmount:f.taxAmount,netProfit:f.netProfit}),_={paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,paymentProgressType:g.paymentProgressType,paymentProgressValue:g.paymentProgressValue,total:f.finalTotal};return Sa.lastResult=_,_a(b),b}function Aa({items:e,discount:t,discountType:n,applyTax:a,paidStatus:s,paymentProgressType:o=null,paymentProgressValue:r=null,start:i,end:c,companySharePercent:l=null,paymentHistory:u=[]}){const h=ha(),p=h.length,y=Number.isFinite(l)?Number(l):null,f=ce({items:e,technicianIds:h,discount:t,discountType:n,applyTax:a,start:i,end:c,companySharePercent:y}),g=tt({totalAmount:f.finalTotal,progressType:o,progressValue:r,history:u}),S=nt({manualStatus:s,paidAmount:g.paidAmount,paidPercent:g.paidPercent,totalAmount:f.finalTotal}),b=Zt({total:f.finalTotal,itemsCount:e.length,rentalDays:f.rentalDays,techniciansCount:p,applyTax:a,paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,taxAmount:f.taxAmount,netProfit:f.netProfit,totalKey:"reservations.summary.totalAfterEdit"}),_={html:b,paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,paymentProgressType:g.paymentProgressType,paymentProgressValue:g.paymentProgressValue,total:f.finalTotal};return Aa.lastResult=_,b}function _a(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,yt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,yt(n,e))}function yt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Ia=R()||{};let k=(Ia.reservations||[]).map(Na);function ei(){return k}function Fe(e){return k=Array.isArray(e)?e.map(it):[],k.length?console.debug("[reservationsService] setReservationsState first paymentHistory",k[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),gt({reservations:k}),k}async function ti(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([i,c])=>{c!=null&&c!==""&&t.set(i,String(c))});const n=t.toString(),s=(await D(`/reservations/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(s)?o=s:s&&typeof s=="object"&&(Array.isArray(s.items)?o=s.items:Array.isArray(s.results)?o=s.results:Array.isArray(s.data)?o=s.data:Array.isArray(s.records)&&(o=s.records));const r=o.map(at);return Fe(r)}async function ni(e){const t=await D("/reservations/",{method:"POST",body:e}),n=at(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=st(e.payment_history);a.length&&(n.paymentHistory=a)}if(n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=ce({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Fe([...k,n]),n}async function Ta(e,t){const n=await D(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=at(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const o=st(t.payment_history);o.length&&(a.paymentHistory=o,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if(a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const o=ce({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=o.companyShareAmount,a.cost=o.finalTotal,a.totalAmount=o.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const s=k.map(o=>String(o.id)===String(e)?a:o);return Fe(s),a}async function ai(e){await D(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=k.filter(n=>String(n.id)!==String(e));Fe(t)}async function ii(e){return Ta(e,{status:"confirmed",confirmed:!0})}function at(e={}){return it({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function Na(e={}){return it(e)}function it(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(Ea):[],s=Array.isArray(e.technicians)?e.technicians:[],o=s.map(E=>E==null?null:String(typeof E=="object"?E.id??E.technician_id??E.technicianId??E.ID??"":E)).filter(E=>E&&E!==""),r=e.start??e.start_datetime??"",i=e.end??e.end_datetime??"";let c=x(e.total_amount??e.totalAmount??e.cost??0);const l=x(e.discount??0),u=e.discount_type??e.discountType??"percent",h=["percent","amount"].includes(u)?u:"percent",p=!!(e.apply_tax??e.applyTax??!1);let y=Ca(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const f=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),g=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,S=g!=null?Number.parseFloat(v(String(g).replace("%","").trim())):NaN,b=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let _=b!=null?b===!0||b===1||b==="1"||String(b).toLowerCase()==="true":Number.isFinite(S)&&S>0,I=_&&Number.isFinite(S)?Number(S):0;const P=e.company_share_amount??e.companyShareAmount;let T=Number.isFinite(Number(P))?Number(P):NaN;p&&I<=0&&(I=Wt,_=!0);const N=ce({items:a,technicianIds:o,discount:l,discountType:h,applyTax:p,start:r,end:i,companySharePercent:I>0?I:null});(!Number.isFinite(c)||c<=0||p)&&(c=N.finalTotal),(!Number.isFinite(T)||T<0)&&(T=N.companyShareAmount),T=Number.isFinite(T)?Number(T.toFixed(2)):0,!_&&I>0&&(_=!0);const B=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],d=Pa(B),K=st(d),M=tt({totalAmount:c,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:K});y=nt({manualStatus:y,paidAmount:M.paidAmount,paidPercent:M.paidPercent,totalAmount:c});const le=y==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:i,status:Ba(e.status??(f?"confirmed":"pending")),confirmed:f,location:e.location??"",notes:e.notes??"",discount:l,discountType:h,applyTax:p,paid:le,paidStatus:y,paidAmount:M.paidAmount,paidPercent:M.paidPercent,paymentProgressType:M.paymentProgressType,paymentProgressValue:M.paymentProgressValue,paymentHistory:K,payment_history:K,totalAmount:c,cost:c,projectId:e.project_id??e.projectId??null,items:a,technicians:o,techniciansDetails:s.map(E=>typeof E=="object"?E:{id:Number(E)||E}),startDatetime:r,endDatetime:i,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:I,companyShareAmount:T,companyShareEnabled:_}}function Ea(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=Gt(e.quantity??e.qty??1),a=x(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:v(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function si({reservationCode:e,customerId:t,start:n,end:a,status:s,title:o,location:r,notes:i,projectId:c,totalAmount:l,discount:u,discountType:h,applyTax:p,paidStatus:y,confirmed:f,items:g,technicians:S,companySharePercent:b,companyShareEnabled:_,paidAmount:I,paidPercentage:P,paymentProgressType:T,paymentProgressValue:N,paymentHistory:B}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:s??"pending",title:o??null,location:r??null,notes:i??null,project_id:c||null,total_amount:l??0,discount:u??0,discount_type:h??"percent",apply_tax:p?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(I)?x(I):0,paid_percentage:Number.isFinite(P)?Number(P.toFixed(2)):0,payment_progress_type:T??null,payment_progress_value:Number.isFinite(N)?Number(N.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(d=>({type:Me(d?.type??d?.payment_type??d?.method??d?.paymentMethod),value:d?.value!=null?x(d.value):null,amount:d?.amount!=null?x(d.amount):d?.payment_amount!=null?x(d.payment_amount):null,percentage:d?.percentage!=null?Number(d.percentage):d?.payment_percentage!=null?Number(d.payment_percentage):null,note:d?.note??d?.notes??d?.comment??d?.payment_note??null,recorded_at:d?.recordedAt??d?.recorded_at??d?.createdAt??d?.created_at??d?.payment_date??d?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(d=>({type:Me(d?.type??d?.payment_type??d?.method??d?.paymentMethod),value:d?.value!=null?x(d.value):null,amount:d?.amount!=null?x(d.amount):d?.payment_amount!=null?x(d.payment_amount):null,percentage:d?.percentage!=null?Number(d.percentage):d?.payment_percentage!=null?Number(d.payment_percentage):null,note:d?.note??d?.notes??d?.comment??d?.payment_note??null,recorded_at:d?.recordedAt??d?.recorded_at??d?.createdAt??d?.created_at??d?.payment_date??d?.date??new Date().toISOString()})):[],confirmed:f===void 0?null:!!f,items:Array.isArray(g)?g.map(d=>({equipment_id:d.equipmentId??d.equipment_id??d.id,quantity:Gt(d.qty??d.quantity??1),unit_price:x(d.price??d.unit_price??0),notes:d.notes??null})):[],company_share_percent:_&&Number.isFinite(b)?Number(b):null,company_share_enabled:_?1:0,technicians:Array.isArray(S)?S.map(d=>typeof d=="object"&&d!==null?{id:d.id??d.technician_id??d.technicianId??d.ID,role:d.role??null,notes:d.notes??null}:Number.isNaN(Number(d))?String(d):Number(d)):[]}}function st(e){const t=ot(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const a=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,s=Me(a),o=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,r=o!=null?Number.parseFloat(v(String(o))):null,i=n.amount!=null?Number.parseFloat(v(String(n.amount))):n.payment_amount!=null?Number.parseFloat(v(String(n.payment_amount))):null,c=n.percentage!=null?Number.parseFloat(v(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(v(String(n.payment_percentage))):null,l=Number.isFinite(i)?i:s==="amount"&&Number.isFinite(r)?r:null,u=Number.isFinite(c)?c:s==="percent"&&Number.isFinite(r)?r:null,h=s??(l!=null?"amount":u!=null?"percent":null),p=h==="amount"?l:h==="percent"?u:Number.isFinite(r)?r:null,y=n.note??n.notes??n.comment??n.payment_note??null,f=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:h,value:p,amount:l,percentage:u,note:y,recordedAt:f}}).filter(n=>n&&n.type)}function Me(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function ot(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of t)if(Array.isArray(e[r]))return e[r];const a=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(a))return a;const s=Object.values(e);if(s.length&&s.every(r=>r&&typeof r=="object")){const r=s.map(i=>i);if(r.every(i=>!Array.isArray(i)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return ot(t)}catch{return[]}return[]}function Pa(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=ot(t);if(Array.isArray(n)&&n.length)return n}return[]}function x(e){const t=Number(v(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Gt(e){const t=Number.parseInt(v(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function Ba(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return"pending"}}function Ca(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function oi(e){return e instanceof Se}export{Aa as $,wa as A,Sa as B,be as C,Wt as D,Wa as E,ka as F,qa as G,Ya as H,Ma as I,Oa as J,za as K,fa as L,oa as M,si as N,ni as O,Ha as P,U as Q,jn as R,On as S,Un as T,Gn as U,Ga as V,Ra as W,Va as X,Ua as Y,ai as Z,ii as _,ti as a,ha as a0,Ja as a1,et as a2,Na as a3,Xa as b,oi as c,Da as d,$a as e,We as f,ei as g,tt as h,Za as i,nt as j,Ae as k,at as l,ze as m,$ as n,xt as o,va as p,Fa as q,hn as r,qt as s,Y as t,xa as u,Qa as v,Ta as w,Ka as x,Wn as y,ja as z};
