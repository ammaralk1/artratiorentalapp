import{d as O,n as v,b as D,A as be,s as dt,a as Xt,m as en,c as tn,i as nn,l as an,e as Te,t as d,f as sn,h as A,j as mt,o as on}from"./auth.js";const rn=O()||{};let k=(rn.technicians||[]).map(ht);function pt(){return k}function me(e){return k=Array.isArray(e)?e.map(ht):[],dt({technicians:k}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),k}async function cn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,o])=>{o!=null&&o!==""&&t.set(s,String(o))});const n=t.toString(),a=await D(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(Me):[];return me(i)}async function ln(e){const t=await D("/technicians/",{method:"POST",body:e}),n=Me(t?.data??{});return me([...k,n]),n}async function ft(e,t){const n=await D(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Me(n?.data??{}),i=k.map(s=>String(s.id)===String(e)?a:s);return me(i),a}async function un(e){await D(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),me(k.filter(t=>String(t.id)!==String(e)))}function yt({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,dailyTotal:o,status:r,notes:l,active:c=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,daily_total:o??null,status:r??"available",notes:l??null,active:c?1:0}}function Me(e={}){return gt({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function ht(e={}){return gt(e)}function gt(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",o=e.department??e.team??"",r=tt(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=tt(e.daily_total??e.dailyTotal??e.total??e.total_wage??r),c=nt(e.baseStatus??e.status??"available"),p=nt(e.status??e.baseStatus??"available"),y=e.notes??"",h=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:o,dailyWage:r,dailyTotal:l,status:p,baseStatus:c,notes:y,active:h}}function tt(e){const t=Number.parseFloat(v(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function nt(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function Ee(e){return e instanceof be}Xt();en();tn();document.addEventListener("DOMContentLoaded",()=>{nn();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>an()),e.dataset.listenerAttached="true")});function ve(e){const t=Number(e)||0,a=Te()==="ar"?"ar-SA-u-nu-latn":"en-US",i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${v(i)} SR`}function fa(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function ya(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function ha(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function W(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const dn="technicianPositions:updated";let $=[],bt=!1,ce=null;function we(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function vt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:i}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:i??null}}function mn(e){return $=Array.isArray(e)?e.map(we).filter(t=>t.name!=="").sort((t,n)=>ee(t).localeCompare(ee(n),"ar",{sensitivity:"base"})):[],bt=!0,Ie(),j()}function Ie(){try{const e={positions:j()},t=new CustomEvent(dn,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function ee(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function j(){return $.map(e=>({...e}))}function pn(e){const t=String(e??"").trim().toLowerCase();return t&&$.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function fn({forceRefresh:e=!1}={}){return bt&&!e?j():(ce&&!e||(ce=D("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return mn(n)}).finally(()=>{ce=null})),ce)}async function Ne({forceRefresh:e=!1}={}){try{return await fn({forceRefresh:e})}catch(t){throw t instanceof be?t:new be(t?.message||d("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function yn({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:i}){const s=vt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:i}),o=await D("/technician-positions/",{method:"POST",body:s}),r=we(o?.data??{});return $=[...$,r],$.sort((l,c)=>ee(l).localeCompare(ee(c),"ar",{sensitivity:"base"})),Ie(),r}async function hn(e,{name:t,cost:n,clientPrice:a,labelAr:i,labelEn:s}){if(!e)throw new Error("Position id is required");const o=vt({name:t,cost:n,clientPrice:a,labelAr:i,labelEn:s}),r=await D(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:o}),l=we(r?.data??{});return $=$.map(c=>c.id===l.id?l:c),$.sort((c,p)=>ee(c).localeCompare(ee(p),"ar",{sensitivity:"base"})),Ie(),l}async function gn(e){if(!e)throw new Error("Position id is required");return await D(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),$=$.filter(t=>t.id!==Number(e)),Ie(),j()}const Fe="__ART_RATIO_TECH_SUB_TAB__",St=["technicians-management","technicians-positions"];let L=null,at=!1,ge=!1,ue="",De=!1,M=null,K="technicians-management";const it=bn();it&&(K=it);async function At({showToastOnError:e=!0}={}){if(!ge){ge=!0,ue="",C();try{await cn(),De=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),ue=Ee(t)?t.message:d("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&A(ue,"error")}finally{ge=!1,C()}}}function _t(){return pt()}function ye(e=""){return v(String(e)).trim().toLowerCase()}function st(e){return e==null?"":String(e)}function te(e=""){return v(String(e)).replace(/[^0-9+]/g,"")}function F(e=""){const t=v(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function X(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function bn(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(Fe);return e&&St.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function vn(e){try{if(typeof window>"u"||!window.localStorage)return;if(!St.includes(e)){window.localStorage.removeItem(Fe);return}window.localStorage.setItem(Fe,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function Tt(e,t=0,n=null){const a=String(e??"").trim(),i=a?pn(a):null;return i?{matchedPosition:i,dailyWage:Number.isFinite(i.cost)?i.cost:0,dailyTotal:i.clientPrice==null?null:Number.isFinite(i.clientPrice)?i.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Et(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function xe(e,t=Te()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Sn(e,t=Te()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function It(){const{container:e,body:t}=Et();!e||!t||(t.textContent="",e.hidden=!0)}function qe(e,t={}){const{container:n,body:a}=Et();if(!n||!a)return;const i=String(e??"").trim();if(!i){It();return}const s=Tt(i,t?.dailyWage??0,t?.dailyTotal??null),o=ve(s.dailyWage||0),r=s.dailyTotal!=null?ve(s.dailyTotal):d("technicians.positionSummary.noClientPrice","â€”");s.matchedPosition?a.textContent=d("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",o).replace("{price}",r):a.textContent=d("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",o).replace("{price}",r),n.hidden=!1}function pe(){const e=document.getElementById("technician-position-options");if(!e)return;const t=j(),n=Te(),a=new Set,i=[];t.forEach(s=>{const o=xe(s,n).trim();o&&!a.has(o.toLowerCase())&&(i.push(`<option value="${W(o)}"></option>`),a.add(o.toLowerCase()));const r=Sn(s,n).trim();r&&!a.has(r.toLowerCase())&&(i.push(`<option value="${W(r)}"></option>`),a.add(r.toLowerCase()));const l=s.name?.trim();l&&!a.has(l.toLowerCase())&&(i.push(`<option value="${W(l)}"></option>`),a.add(l.toLowerCase()))}),e.innerHTML=i.join("")}function ot(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),i=t.map(r=>r?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(r=>{if(!r)return;const c=r.getAttribute("data-tech-tab")===i;r.classList.toggle("tab-active",c),r.classList.toggle("active",c),r.setAttribute("aria-selected",c?"true":"false"),r.setAttribute("tabindex",c?"0":"-1")}),n.forEach(r=>{if(!r)return;const c=r.getAttribute("data-tech-tab-panel")===i;r.hidden=!c,r.classList.toggle("active",c)}),K=i,vn(i);const o=t.find(r=>r?.getAttribute("data-tech-tab")===i)?.closest("[data-tab-scroll]");o&&o.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),i==="technicians-positions"&&(V(),Ne().then(()=>{V()}).catch(r=>{console.error("âŒ [technicians] failed to load positions for tab switch",r),A(r?.message||d("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function ze(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=d(n,a)}function He(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=d("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function Ve(){ze(L?"update":"add"),He(!!L),C()}function An(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,o)=>s.localeCompare(o,"ar",{sensitivity:"base"})),i=d("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function Pe(){const e=document.getElementById("technician-form");e&&(e.reset(),L=null,ze("add"),He(!1),It())}function _n(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=te(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s&&(s.value=e.notes||""),L=String(e.id),ze("update"),He(!0),qe(a.value,e))}function Tn(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-notes");if(!e||!t||!n)return null;const s=e.value.trim(),o=te(t.value.trim());t.value=o;const r=n.value.trim(),l=a?.value.trim()||"",c="available",p=i?.value.trim()||"",y=L?Pt(L):null,{dailyWage:h,dailyTotal:f}=Tt(r,y?.dailyWage??0,y?.dailyTotal??null);return s?o?r?!Number.isFinite(h)||h<0?(A(d("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):f!=null&&(!Number.isFinite(f)||f<0)?(A(d("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(qe(r,{dailyWage:h,dailyTotal:f}),{name:s,phone:o,role:r,department:l,dailyWage:Number.isFinite(h)?h:0,dailyTotal:f==null?null:Number(f),status:c,baseStatus:c,notes:p}):(A(d("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),n.focus(),null):(A(d("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(A(d("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function En(e){e.preventDefault();try{await Ne()}catch(a){console.error("âŒ [technicians] failed to load positions before submit",a);const i=a?.message||d("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");A(i,"error");return}const t=Tn();if(!t)return;const n=yt({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{L?(await ft(L,n),A(d("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await ln(n),A(d("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),Pe(),C()}catch(a){console.error("âŒ [technicians] handleTechnicianSubmit failed",a);const i=Ee(a)?a.message:d("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");A(i,"error")}}function In(){Pe()}function Nn(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=te(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=F(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=F(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==i&&(t.total.value=i);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),X(t.phone,te),X(t.wage,F),X(t.total,F)}function Pn(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),o=document.getElementById("edit-technician-total"),r=document.getElementById("edit-technician-status"),l=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!o||!r)return null;const c=e.value.trim(),p=t.value.trim(),y=te(n.value.trim());n.value=y;const h=a.value.trim(),f=i?.value.trim()||"",m=F(s.value.trim());s.value=m;const g=m===""?0:parseFloat(m),S=F(o.value.trim());o.value=S;const b=S===""?null:parseFloat(S),_=r.value||"available",T=l?.value.trim()||"";return c?p?y?h?Number.isNaN(g)||g<0?(A(d("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),s.focus(),null):b!=null&&(Number.isNaN(b)||b<0)?(A(d("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),o.focus(),null):{id:c,name:p,phone:y,role:h,department:f,dailyWage:Number.isFinite(g)?g:0,dailyTotal:b==null?null:Number(b),status:_,baseStatus:_,notes:T}:(A(d("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),a.focus(),null):(A(d("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(A(d("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(A(d("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Bn(){const e=Pn();if(!e)return;const t=yt({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await ft(e.id,t),A(d("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),C()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const a=Ee(n)?n.message:d("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");A(a,"error")}}function C(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=ye(t?.value||"");if(ge&&!De){const c=d("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}if(ue&&!De){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${ue}</td></tr>`;return}const a=Lt(),{reservations:i=[]}=O(),s=new Date;An(a);const o=document.getElementById("technician-role-filter"),r=ye(o?.value||""),l=a.filter(c=>r&&ye(c.role||"")!==r?!1:n?ye([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const c=d("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}e.innerHTML=l.map(c=>{const p=L&&String(L)===String(c.id),f=(Bt(c.id,i,s)?"busy":c.status||c.baseStatus||"available")==="busy"?{label:d("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:d("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},m=d("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),g=d("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),S=mt(),b=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${c.id}">${m}</button>`];return S&&b.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${c.id}">${g}</button>`),`
      <tr${p?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${c.id}" class="text-decoration-none">${c.name}</a></td>
        <td>${c.role||""}</td>
        <td>${c.department||"â€”"}</td>
        <td><span class="${f.className}"><span class="technician-status-badge__text">${f.label}</span></span></td>
        <td class="table-notes-cell">${c.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${b.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Be(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function Nt(e="add"){const{submitBtn:t,cancelBtn:n}=Be(),a=e==="update";if(t){const i=a?"positions.form.actions.update":"positions.form.actions.submit",s=a?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=d(i,s)}n&&(n.classList.toggle("d-none",!a),n.textContent=d("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function Oe(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:i,clientPriceInput:s}=Be();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),i&&(i.value=""),s&&(s.value=""),M=null,Nt("add")}function Ln(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:i,clientPriceInput:s}=Be();!e||!i||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),i.value=F(e.cost??0),s&&(s.value=e.clientPrice==null?"":F(e.clientPrice)),M=e.id||null,Nt("update"))}function Cn(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=Be();if(!n)return null;const i=e?.value.trim()||"",s=t?.value.trim()||"",o=s||i,r=M?j().find(h=>String(h.id)===String(M)):null,l=F(n.value.trim());n.value=l;const c=l===""?0:parseFloat(l),p=a?F(a.value.trim()):"";a&&(a.value=p);const y=p===""?null:parseFloat(p);return o?!Number.isFinite(c)||c<0?(A(d("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):y!=null&&(!Number.isFinite(y)||y<0)?(A(d("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),a?.focus(),null):{id:M,name:r?.name||o,cost:Number(c.toFixed(2)),clientPrice:y==null?null:Number(y.toFixed(2)),labelAr:i||null,labelEn:s||null}:(A(d("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function ne(){const e=document.getElementById("technician-role");if(!e)return;const t=L?Pt(L):null;qe(e.value,t||{})}function V(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=j();if(t&&(t.textContent=v(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${d("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const i=M&&String(M)===String(a.id),s=ve(a.cost||0),o=a.clientPrice==null?d("technicians.positionSummary.noClientPrice","â€”"):ve(a.clientPrice),r=xe(a,"ar")||"â€”",l=xe(a,"en")||"â€”",c=d("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),p=d("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${i?' class="technician-table-row-editing"':""}>
        <td>${W(r)}</td>
        <td>${W(l)}</td>
        <td>${W(s)}</td>
        <td>${W(o)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${c}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${p}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function Fn(e){e.preventDefault();const t=Cn();if(t)try{const n=!!M;n?await hn(t.id,t):await yn(t);const a=n?d("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):d("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");A(a),Oe(),V(),pe(),ne()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const a=n?.message||d("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");A(a,"error")}}function Dn(){Oe()}async function xn(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Ne();const a=j().find(i=>String(i.id)===String(n));if(!a){A(d("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}Ln(a),V();return}if(t.classList.contains("position-delete-btn")){if(!confirm(d("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await gn(n),M&&String(M)===String(n)&&Oe(),A(d("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),V(),pe(),ne()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||d("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");A(n,"error")}}function $n(e){const t=_t().find(n=>String(n.id)===String(e));if(!t){A(d("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}_n(t),A(d("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function Rn(e){if(!mt()){on();return}if(confirm(d("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await un(e),A(d("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),L&&String(L)===String(e)&&Pe(),C()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=Ee(t)?t.message:d("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");A(n,"error")}}function ga(){je(),C()}function Pt(e){return _t().find(t=>String(t.id)===String(e))||null}function Bt(e,t=[],n){const a=st(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(l=>st(l)===a))return!1;const o=new Date(i.start),r=new Date(i.end);return Number.isNaN(o.getTime())||Number.isNaN(r.getTime())?!1:o<=n&&n<r}):!1}function Lt(){const e=O().reservations||[],t=pt();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const o=s.baseStatus||s.status||"available";let r=o==="busy"?"busy":o;return Bt(s.id,e,n)&&(r="busy"),(r!==s.status||o!==s.baseStatus)&&(a=!0),{...s,baseStatus:o,status:r}});return a?(me(i),i):t}function je(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",h=>{En(h).catch(f=>{console.error("âŒ [technicians] submit handler failed",f)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",In),n.dataset.listenerAttached="true"),X(document.getElementById("technician-phone"),te);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{ne()}),a.dataset.listenerAttached="true");const i=document.getElementById("technicians-table");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",h=>{const f=h.target;if(f instanceof HTMLElement){if(f.classList.contains("technician-edit-btn")){const m=f.dataset.id;$n(m)}if(f.classList.contains("technician-delete-btn")){const m=f.dataset.id;Rn(m).catch(g=>{console.error("âŒ [technicians] delete handler failed",g)})}}}),i.dataset.listenerAttached="true");const s=document.getElementById("search-technician-input");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=v(s.value),C()}),s.dataset.listenerAttached="true");const o=document.getElementById("technician-role-filter");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{C()}),o.dataset.listenerAttached="true");const r=document.getElementById("save-technician-changes");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{Bn().catch(h=>{console.error("âŒ [technicians] modal save failed",h)})}),r.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",h=>{Fn(h).catch(f=>{console.error("âŒ [technicians] position submit failed",f)})}),l.dataset.listenerAttached="true");const c=document.getElementById("position-cancel-btn");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",Dn),c.dataset.listenerAttached="true");const p=document.getElementById("positions-table");p&&!p.dataset.listenerAttached&&(p.addEventListener("click",xn),p.dataset.listenerAttached="true"),X(document.getElementById("position-cost"),F),X(document.getElementById("position-client-price"),F);const y=document.querySelector("[data-tech-tabs]");y&&!y.dataset.listenerAttached&&(y.querySelectorAll("[data-tech-tab]").forEach(f=>{f&&f.addEventListener("click",()=>{const m=f.getAttribute("data-tech-tab");ot(m)})}),y.dataset.listenerAttached="true"),ot(K),Ne().then(()=>{pe(),K==="technicians-positions"&&V(),ne()}).catch(h=>{console.error("âŒ [technicians] failed to load technician positions",h),A(h?.message||d("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),at||(document.addEventListener("technician:prefill",h=>{const f=h.detail;f&&Nn(f)}),at=!0),t&&Pe(),K==="technicians-positions"&&V()}window.addEventListener("DOMContentLoaded",()=>{je(),C(),Ve(),At()});const Ct=()=>{C()};window.addEventListener("technicians:updated",Ct);document.addEventListener("technicians:updated",Ct);document.addEventListener("technicians:refreshRequested",()=>{je(),C(),Ve(),At({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Ve(),pe(),K==="technicians-positions"&&V(),ne()});document.addEventListener(sn.USER_UPDATED,()=>{C()});const Ft=()=>{pe(),K==="technicians-positions"&&V(),ne()};window.addEventListener("technicianPositions:updated",Ft);document.addEventListener("technicianPositions:updated",Ft);let ae=[],Dt=[],xt=[];function ba(){return ae}function va(e){ae=Array.isArray(e)?e:[]}function Sa(e){ae=[...ae,e]}function Aa(e){Number.isInteger(e)&&e>=0&&(ae=ae.filter((t,n)=>n!==e))}function _a(){return Dt}function Ta(e){Dt=Array.isArray(e)?e:[]}function Ea(){return xt}function Ia(e){xt=Array.isArray(e)?e:[]}function Na(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),s=a?a.slice(0,10):"",o=i.match(/(\d{1,2}:\d{2})/);let r="";if(o){const[l="00",c="00"]=o[0].split(":");r=`${l.padStart(2,"0")}:${c.padStart(2,"0")}`}return{date:s,time:r}}function he(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function de(e){return v(String(e||"")).trim().toLowerCase()}const Mn=864e13;function le(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const i=new Date(a);if(!Number.isNaN(i.getTime()))return i}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function Pa(e,t,n,a=null){if(!e||!t||!n)return!1;const i=le(t),s=le(n);if(!i||!s||i>=s)return!1;const o=de(e);if(!o)return!1;const r=O()||{},l=Array.isArray(r.reservations)?r.reservations:[],c=Array.isArray(r.maintenance)?r.maintenance:[],p=Array.isArray(r.equipment)?r.equipment:[],y=On(p),h=$t(a);return l.some(m=>{if(!m||!Array.isArray(m.items)||m.items.length===0||Rt(m,h)||!m.start||!m.end)return!1;const g=le(m.start),S=le(m.end);return!g||!S||!(g<s&&S>i)?!1:m.items.some(_=>de(_?.barcode)===o)})?!0:c.some(m=>{if(!wn(m)||!zn(m,y).has(o))return!1;const{start:S,end:b}=Hn(m);if(!S&&!b)return!0;const _=S??new Date(0),T=b??new Date(Mn);return _<s&&T>i})}function wn(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(Vn(e))return!1;for(const n of t){const a=qn(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function qn(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function zn(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(o=>{const r=de(o);r&&n.add(r)});const i=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(i){const o=de(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number);o&&n.add(o)}return[e?.equipmentId,e?.equipment_id,i?.id,i?.equipmentId,i?.equipment_id].map(o=>o!=null?String(o):"").filter(Boolean).forEach(o=>{const r=t.get(o);if(!r)return;const l=de(r?.barcode??r?.equipmentBarcode??r?.code??r?.serial??r?.serialNumber??r?.serial_number);l&&n.add(l)}),n}function Hn(e){const t=$e([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=$e([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function Vn(e){return!!$e([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function $e(e=[]){for(const t of e){const n=le(t);if(n)return n}return null}function On(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(i=>i!=null?String(i):"").filter(Boolean).forEach(i=>{t.has(i)||t.set(i,n)})}),t}function jn(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:o=[]}=O(),r=String(e),l=$t(a);return o.some(c=>{if(!c?.start||!c?.end||Rt(c,l))return!1;const p=new Date(c.start),y=new Date(c.end);return Number.isNaN(p.getTime())||Number.isNaN(y.getTime())||!(p<s&&y>i)?!1:(Array.isArray(c.technicians)?c.technicians:[]).some(m=>String(m)===r)})}function $t(e){return Z(e,new Set)}function Rt(e,t){if(!t||t.size===0)return!1;const n=Z([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function Z(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(s=>Z(s,t)),t;if(Array.isArray(e))return e.forEach(s=>Z(s,t)),t;if(typeof e=="object"){const s=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let o=!1;return s.forEach(r=>{Object.prototype.hasOwnProperty.call(e,r)&&(o=!0,Z(e[r],t))}),o||Object.values(e).forEach(r=>Z(r,t)),t}const n=v(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],i=n.replace(/\D+/g,"");if(i){a.push(i);const s=Number.parseInt(i,10);Number.isNaN(s)||a.push(String(s))}return a.forEach(s=>{s&&t.add(s)}),t}let Y=[],z=[],H=[],Se="create",Ue=()=>{},We=()=>{};function Un(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=v(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function Mt(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const i of t){if(i==null||i==="")continue;const s=parseFloat(v(String(i)));if(Number.isFinite(s)){n=s;break}}if((!Number.isFinite(n)||n<=0)&&(n=Un(e)),!Number.isFinite(n)||n<=0)return"â€”";const a=d("technicians.table.wageSuffix","SR");return`${v(String(n))} ${a}`}function rt(e=""){return v(String(e)).trim().toLowerCase()}function wt(e){return!Y||!Y.length?null:Y.find(t=>String(t?.id)===String(e))||null}function Wn(e,t="create"){t==="edit"?Ye(H.filter(n=>String(n)!==String(e))):Ke(z.filter(n=>String(n)!==String(e)))}function Ae(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=d("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const s=wt(i)||{},o=d("reservations.crew.fallbackName","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… {id}").replace("{id}",i),r=s.name||o,l=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",c=Mt(s),p=c!=="â€”"?`<small class="technician-chip-wage">ğŸ’° ${c}</small>`:"",y=d("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${r}</span>
          ${l}
          ${p}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${y}">âœ–</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>Wn(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function qt(){return Se==="edit"?H:z}function _e(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=rt(t?.value||""),a=new Set(qt().map(String)),s=(Y||[]).filter(o=>n?rt([o.name,o.phone,o.role,o.department,o.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const o=d("reservations.crew.searchEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${o}</td></tr>`;return}e.innerHTML=s.map(o=>{const r=Mt(o);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${o.id}" ${a.has(String(o.id))?"checked":""}>
        </td>
        <td>${o.name||"-"}</td>
        <td>${o.role||"â€”"}</td>
        <td>${o.department||"â€”"}</td>
        <td>${r}</td>
      </tr>
    `}).join("")}function kn(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function Kn(e="create"){if(e==="edit"){const r=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",y=r?he(r,c):null,h=l?he(l,p):null;let f=null;const m=document.getElementById("edit-res-index")?.value;if(m!=null){const g=Number.parseInt(m,10);if(Number.isInteger(g)){const{reservations:S=[]}=O(),b=S?.[g];b&&(f=b.id??b.reservationId??null)}}return{start:y,end:h,ignoreReservationId:f}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?he(t,a):null,o=n?he(n,i):null;return{start:s,end:o,ignoreReservationId:null}}function ie(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=qt().length;if(t){const n=d("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",v(String(t)));e.textContent=n}else e.textContent=d("technicians.picker.selectionInfo","No crew selected yet")}function Yn(){const e=kn().map(String),{start:t,end:n,ignoreReservationId:a}=Kn(Se);if(t&&n){const s=e.filter(o=>jn(o,t,n,a));if(s.length>0){const o=s.map(l=>wt(l)?.name||l).join(d("reservations.list.crew.separator","ØŒ ")),r=d("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",o);s.forEach(l=>{const c=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(l))}"]`);c&&(c.checked=!1)}),A(r),ie();return}}Se==="edit"?Ye(e):Ke(e),ie();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function ct(e="create"){Se=e;const t=Lt();Array.isArray(t)&&t.length&&(Y=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),_e(),ie();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function Gn(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ct("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>ct("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{_e(),ie()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Yn),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{ie(),_e()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),ke()}function ke(){Ae("selected-technicians-list",z,"create"),Ae("edit-selected-technicians-list",H,"edit")}function Ba({onDraftChange:e,onEditChange:t}={}){Ue=typeof e=="function"?e:()=>{},We=typeof t=="function"?t:()=>{},ke(),Gn()}function Jn(e=[]){Y=Array.isArray(e)?e:[]}function Zn(){return[...z]}function Qn(){return[...H]}function Ke(e=[]){z=Array.isArray(e)?e.map(String):[],Ae("selected-technicians-list",z,"create"),Ue()}function Ye(e=[]){H=Array.isArray(e)?e.map(String):[],Ae("edit-selected-technicians-list",H,"edit"),We()}function La(){Ke([])}function Ca(){Ye([])}function Fa(e=[]){Jn(e);const t=new Set(Y.map(r=>String(r.id))),n=z.filter(r=>t.has(String(r))),a=H.filter(r=>t.has(String(r))),i=n.length!==z.length,s=a.length!==H.length;z=n,H=a,ke(),i&&Ue(),s&&We();const o=document.getElementById("selectTechniciansModal");o&&o.classList.contains("show")&&(_e(),ie())}const zt=10;function Ht(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function Xn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=Number(n);if(Number.isFinite(a))return a}return Ht(e)}function ea(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=O();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));if(!s)return a;const o=Ht(s),r=Xn(s);return{costPerDay:a.costPerDay+(Number.isFinite(o)?o:0),totalPerDay:a.totalPerDay+(Number.isFinite(r)?r:0)}},{costPerDay:0,totalPerDay:0})}const ta=1440*60*1e3,Q=.01;function J(e){if(e==null||e==="")return null;const t=v(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function lt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let i=Number.isFinite(e)?e:0;if(i<t&&(i=t),i>n&&(i=n),a!=null){const s=10**a;i=Math.round(i*s)/s}return i}function Vt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function Ge({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:i=null,history:s=[]}={}){const o=Number.isFinite(Number(e))?Number(e):0,r=t==="amount"?"amount":t==="percent"?"percent":null;let l=J(a),c=J(i);const p=J(n);let y=0,h=0;Array.isArray(s)&&s.length&&s.forEach(b=>{if(!b)return;const _=b.type==="amount"||b.type==="percent"?b.type:null,T=J(b.value),P=J(b.amount),E=J(b.percentage);if(_==="amount"){const I=P??T;I!=null&&(y+=I,o>0&&(h+=I/o*100))}else if(_==="percent"){const I=E??T;I!=null&&(h+=I,o>0&&(y+=I/100*o))}else P!=null&&(y+=P,o>0&&(h+=P/o*100)),E!=null&&(h+=E,o>0&&(y+=E/100*o))}),r==="amount"&&p!=null?l=p:r==="percent"&&p!=null?c=p:r===null&&p!=null&&(c!=null?c=p:l=p),(l==null||l<=0)&&c!=null&&c>0&&o>0&&(l=o*(c/100)),(c==null||c<=0)&&l!=null&&l>0&&o>0&&(c=l/o*100);const f=l??0,m=c??0;l=f+y,c=m+h,l=lt(l??0,{min:0,max:o>0?o:Number.POSITIVE_INFINITY,precision:2}),c=lt(c??0,{min:0,max:100,precision:2});let g=r;return g||(l>0&&o>0?g="amount":c>0&&(g="percent")),{paidAmount:l,paidPercent:c,paymentProgressType:g,paymentProgressValue:g==="amount"?l:g==="percent"?c:null}}function Je({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const i=Vt(e),s=Number.isFinite(Number(a))?Number(a):0,o=Number.isFinite(Number(t))?Number(t):0,r=Number.isFinite(Number(n))?Number(n):0;if(i==="paid")return"paid";const l=s>0&&o>=s-Q,c=r>=100-Q*100;if(l||c)return"paid";const p=o>Q||r>Q;return i==="partial"||p?"partial":"unpaid"}function na(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/ta;return Math.max(1,Math.ceil(s))}function se({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:i=!1,start:s=null,end:o=null,companySharePercent:r=null}={}){const l=na(s,o),p=(e||[]).reduce((oe,N)=>oe+(Number(N?.qty)||1)*(Number(N?.price)||0),0)*l,{costPerDay:y,totalPerDay:h}=ea(t),f=h*l,m=y*l,g=p+f,S=Number(n)||0;let b=a==="amount"?S:g*(S/100);(!Number.isFinite(b)||b<0)&&(b=0),b>g&&(b=g);const _=Math.max(0,g-b);let T=Number.isFinite(r)?Number(r):null;i&&(!Number.isFinite(T)||T<=0)&&(T=zt);const P=T&&T>0?T:0,E=P>0?Math.max(0,_*(P/100)):0,I=_+E;let B=i?I*.15:0;(!Number.isFinite(B)||B<0)&&(B=0),B=Number(B.toFixed(2));const u=I+B,U=Math.max(0,Number(u.toFixed(2))),R=Math.max(0,p+f-m);return{rentalDays:l,equipmentTotal:p,crewTotal:f,crewCostTotal:m,discountAmount:b,subtotalAfterDiscount:_,taxableAmount:I,taxAmount:B,finalTotal:U,companySharePercent:P,companyShareAmount:E,netProfit:R}}function Da(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:o=null,companySharePercent:r=null}={}){return se({items:e,technicianIds:i,discount:t,discountType:n,applyTax:a,start:s,end:o,companySharePercent:r}).finalTotal}function Ot({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paymentStatus:s,paidAmount:o=0,paidPercent:r=0,companySharePercent:l=null,companyShareAmount:c=null,taxAmount:p=null,netProfit:y=null,totalKey:h="reservations.summary.total"}){const f=d("reservations.create.summary.currency","SR"),m=v(String(e)),g=v(String(t)),S=v(String(n??1)),b=v(String(a)),_=Vt(s),T=_==="paid"?"Ù…Ø¯ÙÙˆØ¹":_==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",P=d(`reservations.create.paymentStatus.${_}`,T),E=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,I=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,B=E>Q||I>Q,u=d("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),U=v(E.toFixed(2)),R=v(I.toFixed(I%1?2:0)),oe=d("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),N=d("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),Ut=d("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),Wt=d("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),kt=d("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),Kt=d(h.replace(".total",".totalLabel"),"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©"),Yt=d("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),Gt=d("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),Ce=Number.isFinite(y)?Math.max(0,Number(y)):null,G=[{label:oe,value:g},{label:N,value:S},{label:Ut,value:b}];if(i){let w=d("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(p)&&p>0&&(w=`${v(Number(p).toFixed(2))} ${f}`),G.push({label:Wt,value:w})}const fe=Number.isFinite(l)?Number(l):null;if(fe!==null&&fe>0){const w=Number.isFinite(c)?Number(c):e*(fe/100),re=v(String(fe)),Zt=v(Number.isFinite(w)?w.toFixed(2):"0"),Qt=`${re}% (${Zt} ${f})`;G.push({label:Yt,value:Qt})}if(Ce!==null&&Math.abs(Ce-Number(e))>.009){const w=v(Ce.toFixed(2));G.push({label:Gt,value:`${w} ${f}`})}G.push({label:kt,value:P}),B&&G.push({label:u,value:`${U} ${f} (${R}%)`});const Jt=`${m} ${f}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${G.map(({label:w,value:re})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${w}</span>
            ${re?`<span class="reservation-summary-value">${re}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${Kt}</span>
          <span class="reservation-summary-value">${Jt}</span>
        </div>
      </div>
    </div>
  `}function aa({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,paymentProgressType:s=null,paymentProgressValue:o=null,start:r,end:l,companySharePercent:c=null,paymentHistory:p=[]}){const y=Zn(),h=y.length,f=Number.isFinite(c)?Number(c):null,m=se({items:e,technicianIds:y,discount:t,discountType:n,applyTax:a,start:r,end:l,companySharePercent:f}),g=Ge({totalAmount:m.finalTotal,progressType:s,progressValue:o,history:p}),S=Je({manualStatus:i,paidAmount:g.paidAmount,paidPercent:g.paidPercent,totalAmount:m.finalTotal}),b=Ot({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:h,applyTax:a,paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit}),_={paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,paymentProgressType:g.paymentProgressType,paymentProgressValue:g.paymentProgressValue,total:m.finalTotal};return aa.lastResult=_,sa(b),b}function ia({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,paymentProgressType:s=null,paymentProgressValue:o=null,start:r,end:l,companySharePercent:c=null,paymentHistory:p=[]}){const y=Qn(),h=y.length,f=Number.isFinite(c)?Number(c):null,m=se({items:e,technicianIds:y,discount:t,discountType:n,applyTax:a,start:r,end:l,companySharePercent:f}),g=Ge({totalAmount:m.finalTotal,progressType:s,progressValue:o,history:p}),S=Je({manualStatus:i,paidAmount:g.paidAmount,paidPercent:g.paidPercent,totalAmount:m.finalTotal}),b=Ot({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:h,applyTax:a,paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit,totalKey:"reservations.summary.totalAfterEdit"}),_={html:b,paymentStatus:S,paidAmount:g.paidAmount,paidPercent:g.paidPercent,paymentProgressType:g.paymentProgressType,paymentProgressValue:g.paymentProgressValue,total:m.finalTotal};return ia.lastResult=_,b}function sa(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,ut(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,ut(n,e))}function ut(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const oa=O()||{};let q=(oa.reservations||[]).map(ca);function xa(){return q}function Le(e){return q=Array.isArray(e)?e.map(Qe):[],q.length?console.debug("[reservationsService] setReservationsState first paymentHistory",q[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),dt({reservations:q}),q}async function $a(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,l])=>{l!=null&&l!==""&&t.set(r,String(l))});const n=t.toString(),i=(await D(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const o=s.map(Ze);return Le(o)}async function Ra(e){const t=await D("/reservations/",{method:"POST",body:e}),n=Ze(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=Xe(e.payment_history);a.length&&(n.paymentHistory=a)}if(n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=se({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Le([...q,n]),n}async function ra(e,t){const n=await D(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Ze(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const s=Xe(t.payment_history);s.length&&(a.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if(a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const s=se({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=s.companyShareAmount,a.cost=s.finalTotal,a.totalAmount=s.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const i=q.map(s=>String(s.id)===String(e)?a:s);return Le(i),a}async function Ma(e){await D(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=q.filter(n=>String(n.id)!==String(e));Le(t)}async function wa(e){return ra(e,{status:"confirmed",confirmed:!0})}function Ze(e={}){return Qe({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function ca(e={}){return Qe(e)}function Qe(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(la):[],i=Array.isArray(e.technicians)?e.technicians:[],s=i.map(N=>N==null?null:String(typeof N=="object"?N.id??N.technician_id??N.technicianId??N.ID??"":N)).filter(N=>N&&N!==""),o=e.start??e.start_datetime??"",r=e.end??e.end_datetime??"";let l=x(e.total_amount??e.totalAmount??e.cost??0);const c=x(e.discount??0),p=e.discount_type??e.discountType??"percent",y=["percent","amount"].includes(p)?p:"percent",h=!!(e.apply_tax??e.applyTax??!1);let f=ma(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const m=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),g=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,S=g!=null?Number.parseFloat(v(String(g).replace("%","").trim())):NaN,b=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let _=b!=null?b===!0||b===1||b==="1"||String(b).toLowerCase()==="true":Number.isFinite(S)&&S>0,T=_&&Number.isFinite(S)?Number(S):0;const P=e.company_share_amount??e.companyShareAmount;let E=Number.isFinite(Number(P))?Number(P):NaN;h&&T<=0&&(T=zt,_=!0);const I=se({items:a,technicianIds:s,discount:c,discountType:y,applyTax:h,start:o,end:r,companySharePercent:T>0?T:null});(!Number.isFinite(l)||l<=0||h)&&(l=I.finalTotal),(!Number.isFinite(E)||E<0)&&(E=I.companyShareAmount),E=Number.isFinite(E)?Number(E.toFixed(2)):0,!_&&T>0&&(_=!0);const B=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],u=ua(B),U=Xe(u),R=Ge({totalAmount:l,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:U});f=Je({manualStatus:f,paidAmount:R.paidAmount,paidPercent:R.paidPercent,totalAmount:l});const oe=f==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:o,end:r,status:da(e.status??(m?"confirmed":"pending")),confirmed:m,location:e.location??"",notes:e.notes??"",discount:c,discountType:y,applyTax:h,paid:oe,paidStatus:f,paidAmount:R.paidAmount,paidPercent:R.paidPercent,paymentProgressType:R.paymentProgressType,paymentProgressValue:R.paymentProgressValue,paymentHistory:U,payment_history:U,totalAmount:l,cost:l,projectId:e.project_id??e.projectId??null,items:a,technicians:s,techniciansDetails:i.map(N=>typeof N=="object"?N:{id:Number(N)||N}),startDatetime:o,endDatetime:r,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:T,companyShareAmount:E,companyShareEnabled:_}}function la(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=jt(e.quantity??e.qty??1),a=x(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:v(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function qa({reservationCode:e,customerId:t,start:n,end:a,status:i,title:s,location:o,notes:r,projectId:l,totalAmount:c,discount:p,discountType:y,applyTax:h,paidStatus:f,confirmed:m,items:g,technicians:S,companySharePercent:b,companyShareEnabled:_,paidAmount:T,paidPercentage:P,paymentProgressType:E,paymentProgressValue:I,paymentHistory:B}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:s??null,location:o??null,notes:r??null,project_id:l||null,total_amount:c??0,discount:p??0,discount_type:y??"percent",apply_tax:h?1:0,paid_status:f??"unpaid",paid_amount:Number.isFinite(T)?x(T):0,paid_percentage:Number.isFinite(P)?Number(P.toFixed(2)):0,payment_progress_type:E??null,payment_progress_value:Number.isFinite(I)?Number(I.toFixed(2)):null,payment_history:Array.isArray(B)?B.map(u=>({type:Re(u?.type??u?.payment_type??u?.method??u?.paymentMethod),value:u?.value!=null?x(u.value):null,amount:u?.amount!=null?x(u.amount):u?.payment_amount!=null?x(u.payment_amount):null,percentage:u?.percentage!=null?Number(u.percentage):u?.payment_percentage!=null?Number(u.payment_percentage):null,note:u?.note??u?.notes??u?.comment??u?.payment_note??null,recorded_at:u?.recordedAt??u?.recorded_at??u?.createdAt??u?.created_at??u?.payment_date??u?.date??new Date().toISOString()})):[],payments:Array.isArray(B)?B.map(u=>({type:Re(u?.type??u?.payment_type??u?.method??u?.paymentMethod),value:u?.value!=null?x(u.value):null,amount:u?.amount!=null?x(u.amount):u?.payment_amount!=null?x(u.payment_amount):null,percentage:u?.percentage!=null?Number(u.percentage):u?.payment_percentage!=null?Number(u.payment_percentage):null,note:u?.note??u?.notes??u?.comment??u?.payment_note??null,recorded_at:u?.recordedAt??u?.recorded_at??u?.createdAt??u?.created_at??u?.payment_date??u?.date??new Date().toISOString()})):[],confirmed:m===void 0?null:!!m,items:Array.isArray(g)?g.map(u=>({equipment_id:u.equipmentId??u.equipment_id??u.id,quantity:jt(u.qty??u.quantity??1),unit_price:x(u.price??u.unit_price??0),notes:u.notes??null})):[],company_share_percent:_&&Number.isFinite(b)?Number(b):null,company_share_enabled:_?1:0,technicians:Array.isArray(S)?S.map(u=>typeof u=="object"&&u!==null?{id:u.id??u.technician_id??u.technicianId??u.ID,role:u.role??null,notes:u.notes??null}:Number.isNaN(Number(u))?String(u):Number(u)):[]}}function Xe(e){const t=et(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const a=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,i=Re(a),s=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,o=s!=null?Number.parseFloat(v(String(s))):null,r=n.amount!=null?Number.parseFloat(v(String(n.amount))):n.payment_amount!=null?Number.parseFloat(v(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(v(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(v(String(n.payment_percentage))):null,c=Number.isFinite(r)?r:i==="amount"&&Number.isFinite(o)?o:null,p=Number.isFinite(l)?l:i==="percent"&&Number.isFinite(o)?o:null,y=i??(c!=null?"amount":p!=null?"percent":null),h=y==="amount"?c:y==="percent"?p:Number.isFinite(o)?o:null,f=n.note??n.notes??n.comment??n.payment_note??null,m=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:y,value:h,amount:c,percentage:p,note:f,recordedAt:m}}).filter(n=>n&&n.type)}function Re(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function et(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const o of t)if(Array.isArray(e[o]))return e[o];const a=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(o=>Array.isArray(o));if(Array.isArray(a))return a;const i=Object.values(e);if(i.length&&i.every(o=>o&&typeof o=="object")){const o=i.map(r=>r);if(o.every(r=>!Array.isArray(r)))return o}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(o=>o in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return et(t)}catch{return[]}return[]}function ua(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=et(t);if(Array.isArray(n)&&n.length)return n}return[]}function x(e){const t=Number(v(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function jt(e){const t=Number.parseInt(v(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function da(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return"pending"}}function ma(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function za(e){return e instanceof be}export{Na as A,Ta as B,ba as C,zt as D,Sa as E,Aa as F,Zn as G,jn as H,qa as I,Ra as J,Ea as K,La as L,va as M,Ia as N,Ma as O,wa as P,ia as Q,Qn as R,Ca as S,Ye as T,ca as U,$a as a,Fa as b,za as c,ya as d,ga as e,Ge as f,xa as g,Je as h,Ba as i,ve as j,Ze as k,Pt as l,Me as m,na as n,fa as o,W as p,Da as q,cn as r,Lt as s,ha as t,ra as u,de as v,Pa as w,_a as x,aa as y,he as z};
