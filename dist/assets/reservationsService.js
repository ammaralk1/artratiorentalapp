import{d as $,n as _,b as L,A as Pe,s as Bt,a as Nn,m as Tn,c as Pn,i as En,l as kn,e as qe,t as p,f as Cn,h as v,j as Ft,o as Bn}from"./auth.js";const Fn=$()||{};let G=(Fn.technicians||[]).map(xt);function qt(){return G}function _e(e){return G=Array.isArray(e)?e.map(xt):[],Bt({technicians:G}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),G}async function qn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,o])=>{o!=null&&o!==""&&t.set(s,String(o))});const n=t.toString(),a=await L(`/technicians/${n?`?${n}`:""}`),r=Array.isArray(a?.data)?a.data.map(Ke):[];return _e(r)}async function Ln(e){const t=await L("/technicians/",{method:"POST",body:e}),n=Ke(t?.data??{});return _e([...G,n]),n}async function Lt(e,t){const n=await L(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Ke(n?.data??{}),r=G.map(s=>String(s.id)===String(e)?a:s);return _e(r),a}async function Dn(e){await L(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),_e(G.filter(t=>String(t.id)!==String(e)))}function Dt({name:e,phone:t,email:n,role:a,department:r,dailyWage:s,dailyTotal:o,status:i,notes:l,active:c=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:r??null,daily_wage:s??0,daily_total:o??null,status:i??"available",notes:l??null,active:c?1:0}}function Ke(e={}){return Rt({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function xt(e={}){return Rt(e)}function Rt(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",r=e.email??null,s=e.specialization??e.role??e.position??"",o=e.department??e.team??"",i=bt(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=bt(e.daily_total??e.dailyTotal??e.total??e.total_wage??i),c=_t(e.baseStatus??e.status??"available"),u=_t(e.status??e.baseStatus??"available"),d=e.notes??"",m=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:r,role:s,department:o,dailyWage:i,dailyTotal:l,status:u,baseStatus:c,notes:d,active:m}}function bt(e){const t=Number.parseFloat(_(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function _t(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function Le(e){return e instanceof Pe}Nn();Tn();Pn();document.addEventListener("DOMContentLoaded",()=>{En();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>kn()),e.dataset.listenerAttached="true")});function Ee(e){const t=Number(e)||0,a=qe()==="ar"?"ar-SA-u-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${_(r)} SR`}function Xa(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function ei(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function ti(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function J(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const xn="technicianPositions:updated";let R=[],$t=!1,pe=null;function Ye(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function zt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:r}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:r??null}}function Rn(e){return R=Array.isArray(e)?e.map(Ye).filter(t=>t.name!=="").sort((t,n)=>se(t).localeCompare(se(n),"ar",{sensitivity:"base"})):[],$t=!0,De(),Y()}function De(){try{const e={positions:Y()},t=new CustomEvent(xn,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function se(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function Y(){return R.map(e=>({...e}))}function $n(e){const t=String(e??"").trim().toLowerCase();return t&&R.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function zn({forceRefresh:e=!1}={}){return $t&&!e?Y():(pe&&!e||(pe=L("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return Rn(n)}).finally(()=>{pe=null})),pe)}async function xe({forceRefresh:e=!1}={}){try{return await zn({forceRefresh:e})}catch(t){throw t instanceof Pe?t:new Pe(t?.message||p("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function Mn({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:r}){const s=zt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:r}),o=await L("/technician-positions/",{method:"POST",body:s}),i=Ye(o?.data??{});return R=[...R,i],R.sort((l,c)=>se(l).localeCompare(se(c),"ar",{sensitivity:"base"})),De(),i}async function wn(e,{name:t,cost:n,clientPrice:a,labelAr:r,labelEn:s}){if(!e)throw new Error("Position id is required");const o=zt({name:t,cost:n,clientPrice:a,labelAr:r,labelEn:s}),i=await L(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:o}),l=Ye(i?.data??{});return R=R.map(c=>c.id===l.id?l:c),R.sort((c,u)=>se(c).localeCompare(se(u),"ar",{sensitivity:"base"})),De(),l}async function jn(e){if(!e)throw new Error("Position id is required");return await L(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),R=R.filter(t=>t.id!==Number(e)),De(),Y()}const je="__ART_RATIO_TECH_SUB_TAB__",Mt=["technicians-management","technicians-positions"];let B=null,At=!1,Te=!1,he="",He=!1,w=null,Z="technicians-management";const vt=Hn();vt&&(Z=vt);async function wt({showToastOnError:e=!0}={}){if(!Te){Te=!0,he="",F();try{await qn(),He=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),he=Le(t)?t.message:p("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&v(he,"error")}finally{Te=!1,F()}}}function jt(){return qt()}function Ie(e=""){return _(String(e)).trim().toLowerCase()}function St(e){return e==null?"":String(e)}function oe(e=""){return _(String(e)).replace(/[^0-9+]/g,"")}function q(e=""){const t=_(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function re(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function Hn(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(je);return e&&Mt.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function Vn(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Mt.includes(e)){window.localStorage.removeItem(je);return}window.localStorage.setItem(je,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function Ht(e,t=0,n=null){const a=String(e??"").trim(),r=a?$n(a):null;return r?{matchedPosition:r,dailyWage:Number.isFinite(r.cost)?r.cost:0,dailyTotal:r.clientPrice==null?null:Number.isFinite(r.clientPrice)?r.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Vt(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function Ve(e,t=qe()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function On(e,t=qe()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function Ot(){const{container:e,body:t}=Vt();!e||!t||(t.textContent="",e.hidden=!0)}function Qe(e,t={}){const{container:n,body:a}=Vt();if(!n||!a)return;const r=String(e??"").trim();if(!r){Ot();return}const s=Ht(r,t?.dailyWage??0,t?.dailyTotal??null),o=Ee(s.dailyWage||0),i=s.dailyTotal!=null?Ee(s.dailyTotal):p("technicians.positionSummary.noClientPrice","â€”");s.matchedPosition?a.textContent=p("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",o).replace("{price}",i):a.textContent=p("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",o).replace("{price}",i),n.hidden=!1}function Ae(){const e=document.getElementById("technician-position-options");if(!e)return;const t=Y(),n=qe(),a=new Set,r=[];t.forEach(s=>{const o=Ve(s,n).trim();o&&!a.has(o.toLowerCase())&&(r.push(`<option value="${J(o)}"></option>`),a.add(o.toLowerCase()));const i=On(s,n).trim();i&&!a.has(i.toLowerCase())&&(r.push(`<option value="${J(i)}"></option>`),a.add(i.toLowerCase()));const l=s.name?.trim();l&&!a.has(l.toLowerCase())&&(r.push(`<option value="${J(l)}"></option>`),a.add(l.toLowerCase()))}),e.innerHTML=r.join("")}function It(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),r=t.map(i=>i?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(i=>{if(!i)return;const c=i.getAttribute("data-tech-tab")===r;i.classList.toggle("tab-active",c),i.classList.toggle("active",c),i.setAttribute("aria-selected",c?"true":"false"),i.setAttribute("tabindex",c?"0":"-1")}),n.forEach(i=>{if(!i)return;const c=i.getAttribute("data-tech-tab-panel")===r;i.hidden=!c,i.classList.toggle("active",c)}),Z=r,Vn(r);const o=t.find(i=>i?.getAttribute("data-tech-tab")===r)?.closest("[data-tab-scroll]");o&&o.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),r==="technicians-positions"&&(K(),xe().then(()=>{K()}).catch(i=>{console.error("âŒ [technicians] failed to load positions for tab switch",i),v(i?.message||p("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function Je(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=p(n,a)}function Ge(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=p("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function Ze(){Je(B?"update":"add"),Ge(!!B),F()}function Un(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,o)=>s.localeCompare(o,"ar",{sensitivity:"base"})),r=p("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${r}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function Re(){const e=document.getElementById("technician-form");e&&(e.reset(),B=null,Je("add"),Ge(!1),Ot())}function Wn(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),r=document.getElementById("technician-department"),s=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=oe(e.phone||""),a.value=e.role||"",r&&(r.value=e.department||""),s&&(s.value=e.notes||""),B=String(e.id),Je("update"),Ge(!0),Qe(a.value,e))}function Kn(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),r=document.getElementById("technician-notes");if(!e||!t||!n)return null;const s=e.value.trim(),o=oe(t.value.trim());t.value=o;const i=n.value.trim(),l=a?.value.trim()||"",c="available",u=r?.value.trim()||"",d=B?Wt(B):null,{dailyWage:m,dailyTotal:h}=Ht(i,d?.dailyWage??0,d?.dailyTotal??null);return s?o?i?!Number.isFinite(m)||m<0?(v(p("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):h!=null&&(!Number.isFinite(h)||h<0)?(v(p("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(Qe(i,{dailyWage:m,dailyTotal:h}),{name:s,phone:o,role:i,department:l,dailyWage:Number.isFinite(m)?m:0,dailyTotal:h==null?null:Number(h),status:c,baseStatus:c,notes:u}):(v(p("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),n.focus(),null):(v(p("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(v(p("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function Yn(e){e.preventDefault();try{await xe()}catch(a){console.error("âŒ [technicians] failed to load positions before submit",a);const r=a?.message||p("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(r,"error");return}const t=Kn();if(!t)return;const n=Dt({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{B?(await Lt(B,n),v(p("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await Ln(n),v(p("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),Re(),F()}catch(a){console.error("âŒ [technicians] handleTechnicianSubmit failed",a);const r=Le(a)?a.message:p("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(r,"error")}}function Qn(){Re()}function Jn(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=oe(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=q(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const r=q(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==r&&(t.total.value=r);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),re(t.phone,oe),re(t.wage,q),re(t.total,q)}function Gn(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),r=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),o=document.getElementById("edit-technician-total"),i=document.getElementById("edit-technician-status"),l=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!o||!i)return null;const c=e.value.trim(),u=t.value.trim(),d=oe(n.value.trim());n.value=d;const m=a.value.trim(),h=r?.value.trim()||"",f=q(s.value.trim());s.value=f;const y=f===""?0:parseFloat(f),A=q(o.value.trim());o.value=A;const b=A===""?null:parseFloat(A),S=i.value||"available",N=l?.value.trim()||"";return c?u?d?m?Number.isNaN(y)||y<0?(v(p("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),s.focus(),null):b!=null&&(Number.isNaN(b)||b<0)?(v(p("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),o.focus(),null):{id:c,name:u,phone:d,role:m,department:h,dailyWage:Number.isFinite(y)?y:0,dailyTotal:b==null?null:Number(b),status:S,baseStatus:S,notes:N}:(v(p("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),a.focus(),null):(v(p("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(v(p("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(v(p("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Zn(){const e=Gn();if(!e)return;const t=Dt({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await Lt(e.id,t),v(p("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),F()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const a=Le(n)?n.message:p("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");v(a,"error")}}function F(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Ie(t?.value||"");if(Te&&!He){const c=p("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}if(he&&!He){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${he}</td></tr>`;return}const a=Yt(),{reservations:r=[]}=$(),s=new Date;Un(a);const o=document.getElementById("technician-role-filter"),i=Ie(o?.value||""),l=a.filter(c=>i&&Ie(c.role||"")!==i?!1:n?Ie([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const c=p("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}e.innerHTML=l.map(c=>{const u=B&&String(B)===String(c.id),h=(Kt(c.id,r,s)?"busy":c.status||c.baseStatus||"available")==="busy"?{label:p("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:p("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},f=p("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),y=p("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),A=Ft(),b=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${c.id}">${f}</button>`];return A&&b.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${c.id}">${y}</button>`),`
      <tr${u?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${c.id}" class="text-decoration-none">${c.name}</a></td>
        <td>${c.role||""}</td>
        <td>${c.department||"â€”"}</td>
        <td><span class="${h.className}"><span class="technician-status-badge__text">${h.label}</span></span></td>
        <td class="table-notes-cell">${c.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${b.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function $e(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function Ut(e="add"){const{submitBtn:t,cancelBtn:n}=$e(),a=e==="update";if(t){const r=a?"positions.form.actions.update":"positions.form.actions.submit",s=a?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=p(r,s)}n&&(n.classList.toggle("d-none",!a),n.textContent=p("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function Xe(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:r,clientPriceInput:s}=$e();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),r&&(r.value=""),s&&(s.value=""),w=null,Ut("add")}function Xn(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:r,clientPriceInput:s}=$e();!e||!r||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),r.value=q(e.cost??0),s&&(s.value=e.clientPrice==null?"":q(e.clientPrice)),w=e.id||null,Ut("update"))}function ea(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=$e();if(!n)return null;const r=e?.value.trim()||"",s=t?.value.trim()||"",o=s||r,i=w?Y().find(m=>String(m.id)===String(w)):null,l=q(n.value.trim());n.value=l;const c=l===""?0:parseFloat(l),u=a?q(a.value.trim()):"";a&&(a.value=u);const d=u===""?null:parseFloat(u);return o?!Number.isFinite(c)||c<0?(v(p("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):d!=null&&(!Number.isFinite(d)||d<0)?(v(p("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),a?.focus(),null):{id:w,name:i?.name||o,cost:Number(c.toFixed(2)),clientPrice:d==null?null:Number(d.toFixed(2)),labelAr:r||null,labelEn:s||null}:(v(p("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function ce(){const e=document.getElementById("technician-role");if(!e)return;const t=B?Wt(B):null;Qe(e.value,t||{})}function K(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=Y();if(t&&(t.textContent=_(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${p("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const r=w&&String(w)===String(a.id),s=Ee(a.cost||0),o=a.clientPrice==null?p("technicians.positionSummary.noClientPrice","â€”"):Ee(a.clientPrice),i=Ve(a,"ar")||"â€”",l=Ve(a,"en")||"â€”",c=p("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),u=p("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${r?' class="technician-table-row-editing"':""}>
        <td>${J(i)}</td>
        <td>${J(l)}</td>
        <td>${J(s)}</td>
        <td>${J(o)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${c}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${u}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function ta(e){e.preventDefault();const t=ea();if(t)try{const n=!!w;n?await wn(t.id,t):await Mn(t);const a=n?p("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):p("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");v(a),Xe(),K(),Ae(),ce()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const a=n?.message||p("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(a,"error")}}function na(){Xe()}async function aa(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await xe();const a=Y().find(r=>String(r.id)===String(n));if(!a){v(p("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}Xn(a),K();return}if(t.classList.contains("position-delete-btn")){if(!confirm(p("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await jn(n),w&&String(w)===String(n)&&Xe(),v(p("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),K(),Ae(),ce()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||p("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(n,"error")}}function ia(e){const t=jt().find(n=>String(n.id)===String(e));if(!t){v(p("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}Wn(t),v(p("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function ra(e){if(!Ft()){Bn();return}if(confirm(p("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await Dn(e),v(p("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),B&&String(B)===String(e)&&Re(),F()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=Le(t)?t.message:p("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(n,"error")}}function ni(){et(),F()}function Wt(e){return jt().find(t=>String(t.id)===String(e))||null}function Kt(e,t=[],n){const a=St(e);return a?t.some(r=>{if(!r||!r.start||!r.end||!(Array.isArray(r.technicians)?r.technicians:[]).some(l=>St(l)===a))return!1;const o=new Date(r.start),i=new Date(r.end);return Number.isNaN(o.getTime())||Number.isNaN(i.getTime())?!1:o<=n&&n<i}):!1}function Yt(){const e=$().reservations||[],t=qt();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const r=t.map(s=>{if(!s)return s;const o=s.baseStatus||s.status||"available";let i=o==="busy"?"busy":o;return Kt(s.id,e,n)&&(i="busy"),(i!==s.status||o!==s.baseStatus)&&(a=!0),{...s,baseStatus:o,status:i}});return a?(_e(r),r):t}function et(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",m=>{Yn(m).catch(h=>{console.error("âŒ [technicians] submit handler failed",h)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Qn),n.dataset.listenerAttached="true"),re(document.getElementById("technician-phone"),oe);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{ce()}),a.dataset.listenerAttached="true");const r=document.getElementById("technicians-table");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",m=>{const h=m.target;if(h instanceof HTMLElement){if(h.classList.contains("technician-edit-btn")){const f=h.dataset.id;ia(f)}if(h.classList.contains("technician-delete-btn")){const f=h.dataset.id;ra(f).catch(y=>{console.error("âŒ [technicians] delete handler failed",y)})}}}),r.dataset.listenerAttached="true");const s=document.getElementById("search-technician-input");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=_(s.value),F()}),s.dataset.listenerAttached="true");const o=document.getElementById("technician-role-filter");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{F()}),o.dataset.listenerAttached="true");const i=document.getElementById("save-technician-changes");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",()=>{Zn().catch(m=>{console.error("âŒ [technicians] modal save failed",m)})}),i.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",m=>{ta(m).catch(h=>{console.error("âŒ [technicians] position submit failed",h)})}),l.dataset.listenerAttached="true");const c=document.getElementById("position-cancel-btn");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",na),c.dataset.listenerAttached="true");const u=document.getElementById("positions-table");u&&!u.dataset.listenerAttached&&(u.addEventListener("click",aa),u.dataset.listenerAttached="true"),re(document.getElementById("position-cost"),q),re(document.getElementById("position-client-price"),q);const d=document.querySelector("[data-tech-tabs]");d&&!d.dataset.listenerAttached&&(d.querySelectorAll("[data-tech-tab]").forEach(h=>{h&&h.addEventListener("click",()=>{const f=h.getAttribute("data-tech-tab");It(f)})}),d.dataset.listenerAttached="true"),It(Z),xe().then(()=>{Ae(),Z==="technicians-positions"&&K(),ce()}).catch(m=>{console.error("âŒ [technicians] failed to load technician positions",m),v(m?.message||p("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),At||(document.addEventListener("technician:prefill",m=>{const h=m.detail;h&&Jn(h)}),At=!0),t&&Re(),Z==="technicians-positions"&&K()}window.addEventListener("DOMContentLoaded",()=>{et(),F(),Ze(),wt()});const Qt=()=>{F()};window.addEventListener("technicians:updated",Qt);document.addEventListener("technicians:updated",Qt);document.addEventListener("technicians:refreshRequested",()=>{et(),F(),Ze(),wt({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Ze(),Ae(),Z==="technicians-positions"&&K(),ce()});document.addEventListener(Cn.USER_UPDATED,()=>{F()});const Jt=()=>{Ae(),Z==="technicians-positions"&&K(),ce()};window.addEventListener("technicianPositions:updated",Jt);document.addEventListener("technicianPositions:updated",Jt);function ge(e){return _(String(e||"")).trim().toLowerCase()}function H(e){const t=String(e??"").trim().toLowerCase();return t||""}function Gt(){const{packages:e=[]}=$();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function tt(e){const t=H(e);return t&&Gt().find(a=>H(a?.id??a?.packageId??a?.package_id)===t)||null}function ye(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(i=>({barcode:i}))),n.forEach(i=>{if(!i)return;if(typeof i=="string"||typeof i=="number"){const m=ge(i);if(!m)return;t.push({equipmentId:null,barcode:m,normalizedBarcode:m,qty:1,price:0,desc:""});return}if(typeof i!="object")return;const l=ge(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number),c=[i.equipmentId,i.equipment_id,i.itemId,i.item_id,i.id].find(m=>m!=null&&m!==""),u=[i.unit_price,i.unitPrice,i.price,i.daily_rate].find(m=>Number.isFinite(Number(m))),d=[i.quantity,i.qty,i.count].find(m=>Number.isFinite(Number(m))&&Number(m)>0);t.push({equipmentId:c!=null?String(c):null,barcode:i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??"",normalizedBarcode:l,qty:d!=null?Number(d):1,price:u!=null?Number(u):0,desc:i.description??i.desc??i.name??"",image:i.image??i.imageUrl??i.img??null})});const a=new Map,{equipment:r=[]}=$()||{},s=new Map,o=new Map;return(Array.isArray(r)?r:[]).forEach(i=>{if(!i||typeof i!="object")return;[i.id,i.equipment_id,i.equipmentId,i.item_id,i.itemId].map(u=>u!=null?String(u):"").filter(Boolean).forEach(u=>{s.has(u)||s.set(u,i)});const c=ge(i.barcode);c&&!o.has(c)&&o.set(c,i)}),t.forEach(i=>{if(i.equipmentId&&s.has(i.equipmentId)){const l=s.get(i.equipmentId);if(l){if(i.desc||(i.desc=l.desc||l.description||l.name||""),i.barcode||(i.barcode=l.barcode||""),i.price==null||i.price===0){const c=l.price??l.unit_price,u=Number(c);Number.isFinite(u)&&u>=0&&u<1e6&&(i.price=u)}i.image||(i.image=l.image||l.imageUrl||l.img||null)}}else if(i.normalizedBarcode&&o.has(i.normalizedBarcode)){const l=o.get(i.normalizedBarcode);if(l){if(i.desc||(i.desc=l.desc||l.description||l.name||""),i.barcode||(i.barcode=l.barcode||""),i.price==null||i.price===0){const c=l.price??l.unit_price,u=Number(c);Number.isFinite(u)&&u>=0&&u<1e6&&(i.price=u)}i.image||(i.image=l.image||l.imageUrl||l.img||null)}}}),t.forEach(i=>{const l=i.normalizedBarcode||(i.barcode?ge(i.barcode):""),c=l||(i.equipmentId?`id:${i.equipmentId}`:null);if(!c)return;if(!a.has(c)){a.set(c,{...i,normalizedBarcode:l});return}const u=a.get(c);u.qty+=i.qty,!u.price&&i.price&&(u.price=i.price),!u.desc&&i.desc&&(u.desc=i.desc),!u.image&&i.image&&(u.image=i.image)}),Array.from(a.values())}function sa(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const a of t){const r=Number(a);if(Number.isFinite(r))return r}return ye(e).reduce((a,r)=>a+(r.price||0)*(r.qty||1),0)}function oa(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function ca(){return Gt().map(t=>{const n=H(t?.id??t?.packageId??t?.package_id??t?.code),a=oa(t)||n||"package",r=sa(t);return{id:n,name:a,price:r,code:t?.package_code??t?.code??n,items:ye(t),raw:t}}).filter(t=>t.id)}function la(e){const t=ge(e);return t?ca().filter(n=>n.items.some(a=>a.normalizedBarcode===t)):[]}function ua(e){return ye(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let le=[],Zt=[],Xt=[],en="single";function ai(){return le}function ii(e){le=Array.isArray(e)?e:[]}function ri(e){le=[...le,e]}function si(e){Number.isInteger(e)&&e>=0&&(le=le.filter((t,n)=>n!==e))}function oi(){return Zt}function ci(e){Zt=Array.isArray(e)?e:[]}function li(){return Xt}function ui(e){Xt=Array.isArray(e)?e:[]}function di(e){}function mi(){return en==="package"?"package":"single"}function pi(e){en=e==="package"?"package":"single"}function fi(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",r=""]=n.split("T"),s=a?a.slice(0,10):"",o=r.match(/(\d{1,2}:\d{2})/);let i="";if(o){const[l="00",c="00"]=o[0].split(":");i=`${l.padStart(2,"0")}:${c.padStart(2,"0")}`}return{date:s,time:i}}function Ne(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function x(e){return _(String(e||"")).trim().toLowerCase()}const da=864e13;function O(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const r=new Date(a);if(!Number.isNaN(r.getTime()))return r}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function gi(e,t,n,a=null){if(!e||!t||!n)return!1;const r=O(t),s=O(n);if(!r||!s||r>=s)return!1;const o=x(e);if(!o)return!1;const i=$()||{},l=Array.isArray(i.reservations)?i.reservations:[],c=Array.isArray(i.maintenance)?i.maintenance:[],u=Array.isArray(i.equipment)?i.equipment:[],d=va(u),m=at(a);return l.some(f=>{if(!f||it(f,m)||!f.start||!f.end)return!1;const y=O(f.start),A=O(f.end);return!y||!A||!(y<s&&A>r)?!1:pa(f,o)})?!0:c.some(f=>{if(!ha(f)||!ba(f,d).has(o))return!1;const{start:A,end:b}=_a(f);if(!A&&!b)return!0;const S=A??new Date(0),N=b??new Date(da);return S<s&&N>r})}function ma(e,t,n,a=null){const r=H(e);if(!r||!t||!n)return!1;const s=O(t),o=O(n);if(!s||!o||s>=o)return!1;const i=$()||{},l=Array.isArray(i.reservations)?i.reservations:[],c=at(a);return l.some(u=>{if(!u?.start||!u?.end||it(u,c))return!1;const d=O(u.start),m=O(u.end);return!d||!m||!(d<o&&m>s)?!1:fa(u,r)})}function hi(e,t,n,a=null){const r=x(e);if(!r||!t||!n)return[];const s=la(r);return s.length?s.filter(o=>ma(o.id,t,n,a)):[]}function tn(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(a=>{const r=e[a];Array.isArray(r)&&r.length&&t.push(r)}),t}function pa(e,t){if(!t||!e||typeof e!="object")return!1;const n=x(e?.barcode);if(n&&n===t)return!0;const a=tn(e);for(const r of a)for(const s of r)if(ga(s).has(t))return!0;return!1}function fa(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const s of n){if(!s&&s!==0)continue;const o=H(s);if(o&&o===t)return!0}const a=e.packages;if(Array.isArray(a))for(const s of a){const o=H(s);if(o&&o===t)return!0}const r=tn(e);for(const s of r)for(const o of s)if(nt(o).has(t))return!0;return!1}function ga(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const s=x(e);return s&&t.add(s),t}if(typeof e!="object")return t;const n=x(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(s=>{const o=e[s];Array.isArray(o)&&o.forEach(i=>{if(i!=null){if(typeof i=="string"||typeof i=="number"){const l=x(i);l&&t.add(l);return}if(typeof i=="object"){const l=x(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number);l&&t.add(l)}}})});const r=nt(e);return r.size&&r.forEach(s=>{const o=tt(s);if(!o)return;ua(o).forEach(l=>{const c=l.normalizedBarcode??x(l.barcode);c&&t.add(c)})}),t}function nt(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(a=>{const r=H(a);r&&t.add(r)}),e.package&&typeof e.package=="object"&&nt(e.package).forEach(r=>t.add(r)),Array.isArray(e.packages)&&e.packages.forEach(a=>{const r=H(a);r&&t.add(r)}),t}function ha(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(Aa(e))return!1;for(const n of t){const a=ya(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function ya(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function ba(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(o=>{const i=x(o);i&&n.add(i)});const r=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(r){const o=x(r.barcode??r.equipmentBarcode??r.code??r.serial??r.serialNumber??r.serial_number);o&&n.add(o)}return[e?.equipmentId,e?.equipment_id,r?.id,r?.equipmentId,r?.equipment_id].map(o=>o!=null?String(o):"").filter(Boolean).forEach(o=>{const i=t.get(o);if(!i)return;const l=x(i?.barcode??i?.equipmentBarcode??i?.code??i?.serial??i?.serialNumber??i?.serial_number);l&&n.add(l)}),n}function _a(e){const t=Oe([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=Oe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function Aa(e){return!!Oe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function Oe(e=[]){for(const t of e){const n=O(t);if(n)return n}return null}function va(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(r=>r!=null?String(r):"").filter(Boolean).forEach(r=>{t.has(r)||t.set(r,n)})}),t}function Sa(e,t,n,a=null){if(!e||!t||!n)return!1;const r=new Date(t),s=new Date(n);if(Number.isNaN(r.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:o=[]}=$(),i=String(e),l=at(a);return o.some(c=>{if(!c?.start||!c?.end||it(c,l))return!1;const u=new Date(c.start),d=new Date(c.end);return Number.isNaN(u.getTime())||Number.isNaN(d.getTime())||!(u<s&&d>r)?!1:(Array.isArray(c.technicians)?c.technicians:[]).some(f=>String(f)===i)})}function at(e){return ae(e,new Set)}function it(e,t){if(!t||t.size===0)return!1;const n=ae([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function ae(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(s=>ae(s,t)),t;if(Array.isArray(e))return e.forEach(s=>ae(s,t)),t;if(typeof e=="object"){const s=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let o=!1;return s.forEach(i=>{Object.prototype.hasOwnProperty.call(e,i)&&(o=!0,ae(e[i],t))}),o||Object.values(e).forEach(i=>ae(i,t)),t}const n=_(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],r=n.replace(/\D+/g,"");if(r){a.push(r);const s=Number.parseInt(r,10);Number.isNaN(s)||a.push(String(s))}return a.forEach(s=>{s&&t.add(s)}),t}let X=[],U=[],W=[],ke="create",rt=()=>{},st=()=>{};function Ia(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=_(String(n)),r=Number.parseFloat(a);if(Number.isFinite(r))return r}return 0}function nn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const r of t){if(r==null||r==="")continue;const s=parseFloat(_(String(r)));if(Number.isFinite(s)){n=s;break}}if((!Number.isFinite(n)||n<=0)&&(n=Ia(e)),!Number.isFinite(n)||n<=0)return"â€”";const a=p("technicians.table.wageSuffix","SR");return`${_(String(n))} ${a}`}function Nt(e=""){return _(String(e)).trim().toLowerCase()}function an(e){return!X||!X.length?null:X.find(t=>String(t?.id)===String(e))||null}function Na(e,t="create"){t==="edit"?lt(W.filter(n=>String(n)!==String(e))):ct(U.filter(n=>String(n)!==String(e)))}function Ce(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const r=p("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….");a.innerHTML=`<span class="text-muted">${r}</span>`;return}a.innerHTML=t.map(r=>{const s=an(r)||{},o=p("reservations.crew.fallbackName","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… {id}").replace("{id}",r),i=s.name||o,l=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",c=nn(s),u=c!=="â€”"?`<small class="technician-chip-wage">ğŸ’° ${c}</small>`:"",d=p("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
        <span class="technician-chip" data-id="${r}">
          <span class="technician-chip-name">${i}</span>
          ${l}
          ${u}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${r}" aria-label="${d}">âœ–</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(r=>{r.dataset.listenerAttached||(r.addEventListener("click",()=>Na(r.dataset.id,r.dataset.context)),r.dataset.listenerAttached="true")})}}function rn(){return ke==="edit"?W:U}function Be(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=Nt(t?.value||""),a=new Set(rn().map(String)),s=(X||[]).filter(o=>n?Nt([o.name,o.phone,o.role,o.department,o.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const o=p("reservations.crew.searchEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${o}</td></tr>`;return}e.innerHTML=s.map(o=>{const i=nn(o);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${o.id}" ${a.has(String(o.id))?"checked":""}>
        </td>
        <td>${o.name||"-"}</td>
        <td>${o.role||"â€”"}</td>
        <td>${o.department||"â€”"}</td>
        <td>${i}</td>
      </tr>
    `}).join("")}function Ta(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function Pa(e="create"){if(e==="edit"){const i=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=i?Ne(i,c):null,m=l?Ne(l,u):null;let h=null;const f=document.getElementById("edit-res-index")?.value;if(f!=null){const y=Number.parseInt(f,10);if(Number.isInteger(y)){const{reservations:A=[]}=$(),b=A?.[y];b&&(h=b.id??b.reservationId??null)}}return{start:d,end:m,ignoreReservationId:h}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",r=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?Ne(t,a):null,o=n?Ne(n,r):null;return{start:s,end:o,ignoreReservationId:null}}function ue(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=rn().length;if(t){const n=p("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",_(String(t)));e.textContent=n}else e.textContent=p("technicians.picker.selectionInfo","No crew selected yet")}function Ea(){const e=Ta().map(String),{start:t,end:n,ignoreReservationId:a}=Pa(ke);if(t&&n){const s=e.filter(o=>Sa(o,t,n,a));if(s.length>0){const o=s.map(l=>an(l)?.name||l).join(p("reservations.list.crew.separator","ØŒ ")),i=p("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",o);s.forEach(l=>{const c=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(l))}"]`);c&&(c.checked=!1)}),v(i),ue();return}}ke==="edit"?lt(e):ct(e),ue();const r=document.getElementById("selectTechniciansModal");r&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(r)?.hide?.()}function Tt(e="create"){ke=e;const t=Yt();Array.isArray(t)&&t.length&&(X=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),Be(),ue();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function ka(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Tt("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>Tt("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Be(),ue()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Ea),a.dataset.listenerAttached="true");const r=document.getElementById("selectTechniciansModal");r&&!r.dataset.listenerAttached&&window.bootstrap?.Modal&&(r.addEventListener("shown.bs.modal",()=>{ue(),Be()}),r.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),r.dataset.listenerAttached="true"),ot()}function ot(){Ce("selected-technicians-list",U,"create"),Ce("edit-selected-technicians-list",W,"edit")}function yi({onDraftChange:e,onEditChange:t}={}){rt=typeof e=="function"?e:()=>{},st=typeof t=="function"?t:()=>{},ot(),ka()}function Ca(e=[]){X=Array.isArray(e)?e:[]}function Ba(){return[...U]}function Fa(){return[...W]}function ct(e=[]){U=Array.isArray(e)?e.map(String):[],Ce("selected-technicians-list",U,"create"),rt()}function lt(e=[]){W=Array.isArray(e)?e.map(String):[],Ce("edit-selected-technicians-list",W,"edit"),st()}function bi(){ct([])}function _i(){lt([])}function Ai(e=[]){Ca(e);const t=new Set(X.map(i=>String(i.id))),n=U.filter(i=>t.has(String(i))),a=W.filter(i=>t.has(String(i))),r=n.length!==U.length,s=a.length!==W.length;U=n,W=a,ot(),r&&rt(),s&&st();const o=document.getElementById("selectTechniciansModal");o&&o.classList.contains("show")&&(Be(),ue())}const sn=10;function on(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function qa(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=Number(n);if(Number.isFinite(a))return a}return on(e)}function La(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=$();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,r)=>{const s=n.get(String(r));if(!s)return a;const o=on(s),i=qa(s);return{costPerDay:a.costPerDay+(Number.isFinite(o)?o:0),totalPerDay:a.totalPerDay+(Number.isFinite(i)?i:0)}},{costPerDay:0,totalPerDay:0})}const Da=1440*60*1e3,ie=.01;function ne(e){if(e==null||e==="")return null;const t=_(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Pt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let r=Number.isFinite(e)?e:0;if(r<t&&(r=t),r>n&&(r=n),a!=null){const s=10**a;r=Math.round(r*s)/s}return r}function cn(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function ut({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:r=null,history:s=[]}={}){const o=Number.isFinite(Number(e))?Number(e):0,i=t==="amount"?"amount":t==="percent"?"percent":null;let l=ne(a),c=ne(r);const u=ne(n);let d=0,m=0;Array.isArray(s)&&s.length&&s.forEach(b=>{if(!b)return;const S=b.type==="amount"||b.type==="percent"?b.type:null,N=ne(b.value),P=ne(b.amount),k=ne(b.percentage);if(S==="amount"){const I=P??N;I!=null&&(d+=I,o>0&&(m+=I/o*100))}else if(S==="percent"){const I=k??N;I!=null&&(m+=I,o>0&&(d+=I/100*o))}else P!=null&&(d+=P,o>0&&(m+=P/o*100)),k!=null&&(m+=k,o>0&&(d+=k/100*o))}),i==="amount"&&u!=null?l=u:i==="percent"&&u!=null?c=u:i===null&&u!=null&&(c!=null?c=u:l=u),(l==null||l<=0)&&c!=null&&c>0&&o>0&&(l=o*(c/100)),(c==null||c<=0)&&l!=null&&l>0&&o>0&&(c=l/o*100);const h=l??0,f=c??0;l=h+d,c=f+m,l=Pt(l??0,{min:0,max:o>0?o:Number.POSITIVE_INFINITY,precision:2}),c=Pt(c??0,{min:0,max:100,precision:2});let y=i;return y||(l>0&&o>0?y="amount":c>0&&(y="percent")),{paidAmount:l,paidPercent:c,paymentProgressType:y,paymentProgressValue:y==="amount"?l:y==="percent"?c:null}}function dt({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const r=cn(e),s=Number.isFinite(Number(a))?Number(a):0,o=Number.isFinite(Number(t))?Number(t):0,i=Number.isFinite(Number(n))?Number(n):0;if(r==="paid")return"paid";const l=s>0&&o>=s-ie,c=i>=100-ie*100;if(l||c)return"paid";const u=o>ie||i>ie;return r==="partial"||u?"partial":"unpaid"}function xa(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const r=a.getTime()-n.getTime();if(r<=0)return 1;const s=r/Da;return Math.max(1,Math.ceil(s))}function de({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:r=!1,start:s=null,end:o=null,companySharePercent:i=null}={}){const l=xa(s,o),u=(e||[]).reduce((ee,D)=>ee+(Number(D?.qty)||1)*(Number(D?.price)||0),0)*l,{costPerDay:d,totalPerDay:m}=La(t),h=m*l,f=d*l,y=u+h,A=Number(n)||0;let b=a==="amount"?A:y*(A/100);(!Number.isFinite(b)||b<0)&&(b=0),b>y&&(b=y);const S=Math.max(0,y-b);let N=Number.isFinite(i)?Number(i):null;r&&(!Number.isFinite(N)||N<=0)&&(N=sn);const P=N&&N>0?N:0,k=P>0?Math.max(0,S*(P/100)):0,I=S+k;let C=r?I*.15:0;(!Number.isFinite(C)||C<0)&&(C=0),C=Number(C.toFixed(2));const z=I+C,g=Math.max(0,Number(z.toFixed(2))),Q=Math.max(0,u+h-f);return{rentalDays:l,equipmentTotal:u,crewTotal:h,crewCostTotal:f,discountAmount:b,subtotalAfterDiscount:S,taxableAmount:I,taxAmount:C,finalTotal:g,companySharePercent:P,companyShareAmount:k,netProfit:Q}}function vi(e=[],t=0,n="percent",a=!1,r=[],{start:s=null,end:o=null,companySharePercent:i=null}={}){return de({items:e,technicianIds:r,discount:t,discountType:n,applyTax:a,start:s,end:o,companySharePercent:i}).finalTotal}function ln({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:r,paymentStatus:s,paidAmount:o=0,paidPercent:i=0,companySharePercent:l=null,companyShareAmount:c=null,taxAmount:u=null,netProfit:d=null,totalKey:m="reservations.summary.total"}){const h=p("reservations.create.summary.currency","SR"),f=_(String(e)),y=_(String(t)),A=_(String(n??1)),b=_(String(a)),S=cn(s),N=S==="paid"?"Ù…Ø¯ÙÙˆØ¹":S==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",P=p(`reservations.create.paymentStatus.${S}`,N),k=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,I=Number.isFinite(Number(i))?Math.max(0,Number(i)):0,C=k>ie||I>ie,z=p("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),g=_(k.toFixed(2)),Q=_(I.toFixed(I%1?2:0)),ee=p("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),D=p("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),Me=p("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),E=p("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),yn=p("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),bn=p(m.replace(".total",".totalLabel"),"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©"),_n=p("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),An=p("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),we=Number.isFinite(d)?Math.max(0,Number(d)):null,te=[{label:ee,value:y},{label:D,value:A},{label:Me,value:b}];if(r){let V=p("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(V=`${_(Number(u).toFixed(2))} ${h}`),te.push({label:E,value:V})}const Se=Number.isFinite(l)?Number(l):null;if(Se!==null&&Se>0){const V=Number.isFinite(c)?Number(c):e*(Se/100),me=_(String(Se)),Sn=_(Number.isFinite(V)?V.toFixed(2):"0"),In=`${me}% (${Sn} ${h})`;te.push({label:_n,value:In})}if(we!==null&&Math.abs(we-Number(e))>.009){const V=_(we.toFixed(2));te.push({label:An,value:`${V} ${h}`})}te.push({label:yn,value:P}),C&&te.push({label:z,value:`${g} ${h} (${Q}%)`});const vn=`${f} ${h}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${te.map(({label:V,value:me})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${V}</span>
            ${me?`<span class="reservation-summary-value">${me}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${bn}</span>
          <span class="reservation-summary-value">${vn}</span>
        </div>
      </div>
    </div>
  `}function Ra({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:r,paymentProgressType:s=null,paymentProgressValue:o=null,start:i,end:l,companySharePercent:c=null,paymentHistory:u=[]}){const d=Ba(),m=d.length,h=Number.isFinite(c)?Number(c):null,f=de({items:e,technicianIds:d,discount:t,discountType:n,applyTax:a,start:i,end:l,companySharePercent:h}),y=ut({totalAmount:f.finalTotal,progressType:s,progressValue:o,history:u}),A=dt({manualStatus:r,paidAmount:y.paidAmount,paidPercent:y.paidPercent,totalAmount:f.finalTotal}),b=ln({total:f.finalTotal,itemsCount:e.length,rentalDays:f.rentalDays,techniciansCount:m,applyTax:a,paymentStatus:A,paidAmount:y.paidAmount,paidPercent:y.paidPercent,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,taxAmount:f.taxAmount,netProfit:f.netProfit}),S={paymentStatus:A,paidAmount:y.paidAmount,paidPercent:y.paidPercent,paymentProgressType:y.paymentProgressType,paymentProgressValue:y.paymentProgressValue,total:f.finalTotal};return Ra.lastResult=S,za(b),b}function $a({items:e,discount:t,discountType:n,applyTax:a,paidStatus:r,paymentProgressType:s=null,paymentProgressValue:o=null,start:i,end:l,companySharePercent:c=null,paymentHistory:u=[]}){const d=Fa(),m=d.length,h=Number.isFinite(c)?Number(c):null,f=de({items:e,technicianIds:d,discount:t,discountType:n,applyTax:a,start:i,end:l,companySharePercent:h}),y=ut({totalAmount:f.finalTotal,progressType:s,progressValue:o,history:u}),A=dt({manualStatus:r,paidAmount:y.paidAmount,paidPercent:y.paidPercent,totalAmount:f.finalTotal}),b=ln({total:f.finalTotal,itemsCount:e.length,rentalDays:f.rentalDays,techniciansCount:m,applyTax:a,paymentStatus:A,paidAmount:y.paidAmount,paidPercent:y.paidPercent,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,taxAmount:f.taxAmount,netProfit:f.netProfit,totalKey:"reservations.summary.totalAfterEdit"}),S={html:b,paymentStatus:A,paidAmount:y.paidAmount,paidPercent:y.paidPercent,paymentProgressType:y.paymentProgressType,paymentProgressValue:y.paymentProgressValue,total:f.finalTotal};return $a.lastResult=S,b}function za(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Et(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Et(n,e))}function Et(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Ma=$()||{};let M=(Ma.reservations||[]).map(Ha);function fe(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const un="__reservation_packages_cache__";function dn(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function mn(){const e=dn();if(!e)return{};try{const t=e.getItem(un);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function kt(e){const t=dn();if(t)try{t.setItem(un,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function pn(e=[]){return Array.isArray(e)?e.map((t,n)=>hn(t,n)).filter(Boolean).map((t,n)=>{const a=H(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),r=Fe(t,a).map(c=>{const u=j(c.qty??c.quantity??1),d=fe(T(c.price??c.unit_price??0));return{...c,qty:u,quantity:u,price:d,unit_price:d}}),s=j(t.quantity??t.qty??1);let o=fe(T(t.unit_price??t.unitPrice??t.price??0));if(!o||o<=0){const c=r.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);c>0&&s>0&&(o=fe(Number((c/s).toFixed(2))))}const i=T(t.total_price??t.totalPrice??t.total??o*s),l=i>0?fe(i):fe(Number((o*s).toFixed(2)));return{...t,packageId:a,package_id:a,qty:s,quantity:s,unit_price:o,unitPrice:o,price:o,total_price:l,total:l,packageItems:r}}):[]}function ve(e,t){if(!e)return;const n=mn(),a=String(e);if(!Array.isArray(t)||t.length===0){n[a]&&(delete n[a],kt(n));return}n[a]=pn(t),kt(n)}function wa(e){if(!e)return[];const t=mn(),n=String(e),a=t[n];return Array.isArray(a)?pn(a):[]}function Si(){return M}function ze(e){return M=Array.isArray(e)?e.map(pt):[],M.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;ve(n,t.packages)}),M.length?console.debug("[reservationsService] setReservationsState first paymentHistory",M[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),Bt({reservations:M}),M}async function Ii(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([i,l])=>{l!=null&&l!==""&&t.set(i,String(l))});const n=t.toString(),r=(await L(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(r)?s=r:r&&typeof r=="object"&&(Array.isArray(r.items)?s=r.items:Array.isArray(r.results)?s=r.results:Array.isArray(r.data)?s=r.data:Array.isArray(r.records)&&(s=r.records));const o=s.map(mt);return ze(o)}async function Ni(e){const t=await L("/reservations/",{method:"POST",body:e}),n=mt(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=ft(e.payment_history);a.length&&(n.paymentHistory=a)}if(Array.isArray(e?.packages)&&e.packages.length){const a=yt({packages:e.packages});n.packages=ht(n.packages,a)}if(ve(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=de({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,ze([...M,n]),n}async function ja(e,t){const n=await L(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=mt(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const s=ft(t.payment_history);s.length&&(a.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if(Array.isArray(t?.packages)&&t.packages.length){const s=yt({packages:t.packages});a.packages=ht(a.packages,s)}if(ve(a.id??a.reservationId??a.reservation_code??e,a.packages),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const s=de({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=s.companyShareAmount,a.cost=s.finalTotal,a.totalAmount=s.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const r=M.map(s=>String(s.id)===String(e)?a:s);return ze(r),a}async function Ti(e){await L(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=M.filter(n=>String(n.id)!==String(e));ze(t),ve(e,null)}async function Pi(e){return ja(e,{status:"confirmed",confirmed:!0})}function mt(e={}){return pt({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function Ha(e={}){return pt(e)}function pt(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(Va):[];let r=yt(e);const s=Array.isArray(e.technicians)?e.technicians:[],o=s.map(E=>E==null?null:String(typeof E=="object"?E.id??E.technician_id??E.technicianId??E.ID??"":E)).filter(E=>E&&E!==""),i=e.start??e.start_datetime??"",l=e.end??e.end_datetime??"";let c=T(e.total_amount??e.totalAmount??e.cost??0);const u=T(e.discount??0),d=e.discount_type??e.discountType??"percent",m=["percent","amount"].includes(d)?d:"percent",h=!!(e.apply_tax??e.applyTax??!1);let f=Ga(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const y=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),A=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,b=A!=null?Number.parseFloat(_(String(A).replace("%","").trim())):NaN,S=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let N=S!=null?S===!0||S===1||S==="1"||String(S).toLowerCase()==="true":Number.isFinite(b)&&b>0,P=N&&Number.isFinite(b)?Number(b):0;const k=e.company_share_amount??e.companyShareAmount;let I=Number.isFinite(Number(k))?Number(k):NaN;h&&P<=0&&(P=sn,N=!0);const C=de({items:a,technicianIds:o,discount:u,discountType:m,applyTax:h,start:i,end:l,companySharePercent:P>0?P:null});(!Number.isFinite(c)||c<=0||h)&&(c=C.finalTotal),(!Number.isFinite(I)||I<0)&&(I=C.companyShareAmount),I=Number.isFinite(I)?Number(I.toFixed(2)):0,!N&&P>0&&(N=!0);const z=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],g=Oa(z),Q=ft(g),ee=t??n??e.reservation_code??e.reservationId??null;if(r.length)ve(ee,r);else{const E=wa(ee);E.length&&(r=ht(r,E))}const D=ut({totalAmount:c,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:Q});f=dt({manualStatus:f,paidAmount:D.paidAmount,paidPercent:D.paidPercent,totalAmount:c});const Me=f==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:i,end:l,status:Ja(e.status??(y?"confirmed":"pending")),confirmed:y,location:e.location??"",notes:e.notes??"",discount:u,discountType:m,applyTax:h,paid:Me,paidStatus:f,paidAmount:D.paidAmount,paidPercent:D.paidPercent,paymentProgressType:D.paymentProgressType,paymentProgressValue:D.paymentProgressValue,paymentHistory:Q,payment_history:Q,totalAmount:c,cost:c,projectId:e.project_id??e.projectId??null,items:a,technicians:o,techniciansDetails:s.map(E=>typeof E=="object"?E:{id:Number(E)||E}),startDatetime:i,endDatetime:l,customerPhone:e.customer_phone??e.customerPhone??null,packages:r,companySharePercent:P,companyShareAmount:I,companyShareEnabled:N}}function Va(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=j(e.quantity??e.qty??e.count??1),a=T(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),r=_(String(e.barcode??e.code??e.serial??"")),s=e.description??e.desc??e.name??e.title??"",o={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:r,desc:s,qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},i=fn(e.type??e.item_type??e.kind??null),l=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,c=be(l),u=Fe(e,c);if(i==="package"||c||u.length){o.type="package";const d=c||(t!=null?String(t):o.id?be(o.id):"");d&&(o.packageId=d,o.package_id=d,o.package_code=e.package_code??e.packageCode??d),o.name=s||o.package_code||d||"",o.barcode=o.barcode||_(String(e.package_code??e.packageCode??"")),o.packageItems=u}return o}function Ei({reservationCode:e,customerId:t,start:n,end:a,status:r,title:s,location:o,notes:i,projectId:l,totalAmount:c,discount:u,discountType:d,applyTax:m,paidStatus:h,confirmed:f,items:y,packages:A,technicians:b,companySharePercent:S,companyShareEnabled:N,paidAmount:P,paidPercentage:k,paymentProgressType:I,paymentProgressValue:C,paymentHistory:z}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:r??"pending",title:s??null,location:o??null,notes:i??null,project_id:l||null,total_amount:c??0,discount:u??0,discount_type:d??"percent",apply_tax:m?1:0,paid_status:h??"unpaid",paid_amount:Number.isFinite(P)?T(P):0,paid_percentage:Number.isFinite(k)?Number(k.toFixed(2)):0,payment_progress_type:I??null,payment_progress_value:Number.isFinite(C)?Number(C.toFixed(2)):null,payment_history:Array.isArray(z)?z.map(g=>({type:Ue(g?.type??g?.payment_type??g?.method??g?.paymentMethod),value:g?.value!=null?T(g.value):null,amount:g?.amount!=null?T(g.amount):g?.payment_amount!=null?T(g.payment_amount):null,percentage:g?.percentage!=null?Number(g.percentage):g?.payment_percentage!=null?Number(g.payment_percentage):null,note:g?.note??g?.notes??g?.comment??g?.payment_note??null,recorded_at:g?.recordedAt??g?.recorded_at??g?.createdAt??g?.created_at??g?.payment_date??g?.date??new Date().toISOString()})):[],payments:Array.isArray(z)?z.map(g=>({type:Ue(g?.type??g?.payment_type??g?.method??g?.paymentMethod),value:g?.value!=null?T(g.value):null,amount:g?.amount!=null?T(g.amount):g?.payment_amount!=null?T(g.payment_amount):null,percentage:g?.percentage!=null?Number(g.percentage):g?.payment_percentage!=null?Number(g.payment_percentage):null,note:g?.note??g?.notes??g?.comment??g?.payment_note??null,recorded_at:g?.recordedAt??g?.recorded_at??g?.createdAt??g?.created_at??g?.payment_date??g?.date??new Date().toISOString()})):[],confirmed:f===void 0?null:!!f,items:Ua(y),packages:Wa(y,A),company_share_percent:N&&Number.isFinite(S)?Number(S):null,company_share_enabled:N?1:0,technicians:Array.isArray(b)?b.map(g=>typeof g=="object"&&g!==null?{id:g.id??g.technician_id??g.technicianId??g.ID,role:g.role??null,notes:g.notes??null}:Number.isNaN(Number(g))?String(g):Number(g)):[]}}function ft(e){const t=gt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const a=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,r=Ue(a),s=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,o=s!=null?Number.parseFloat(_(String(s))):null,i=n.amount!=null?Number.parseFloat(_(String(n.amount))):n.payment_amount!=null?Number.parseFloat(_(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(_(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(_(String(n.payment_percentage))):null,c=Number.isFinite(i)?i:r==="amount"&&Number.isFinite(o)?o:null,u=Number.isFinite(l)?l:r==="percent"&&Number.isFinite(o)?o:null,d=r??(c!=null?"amount":u!=null?"percent":null),m=d==="amount"?c:d==="percent"?u:Number.isFinite(o)?o:null,h=n.note??n.notes??n.comment??n.payment_note??null,f=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:m,amount:c,percentage:u,note:h,recordedAt:f}}).filter(n=>n&&n.type)}function Ue(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function gt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const o of t)if(Array.isArray(e[o]))return e[o];const a=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(o=>Array.isArray(o));if(Array.isArray(a))return a;const r=Object.values(e);if(r.length&&r.every(o=>o&&typeof o=="object")){const o=r.map(i=>i);if(o.every(i=>!Array.isArray(i)))return o}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(o=>o in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return gt(t)}catch{return[]}return[]}function Oa(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=gt(t);if(Array.isArray(n)&&n.length)return n}return[]}function Ua(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const r=j(n.qty??n.quantity??1);n.packageItems.forEach(s=>{const o=s?.equipmentId??s?.equipment_id??s?.id??null;if(o==null)return;const i=j(s?.qty??s?.quantity??1),l=r*i;t.push({equipment_id:We(o),quantity:l,unit_price:T(s?.price??s?.unit_price??0),notes:s?.notes??null})});return}const a=n.equipmentId??n.equipment_id??n.id??null;a!=null&&t.push({equipment_id:We(a),quantity:j(n.qty??n.quantity??1),unit_price:T(n.price??n.unit_price??0),notes:n.notes??null})}),t}function We(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function Wa(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(a=>{if(!a||typeof a!="object"||a.type!=="package")return;const r=j(a.qty??a.quantity??1),s=Array.isArray(a.packageItems)?a.packageItems.map(o=>{const i=o?.equipmentId??o?.equipment_id??o?.id??null;return i==null?null:{equipment_id:We(i),quantity:j(o?.qty??o?.quantity??1),unit_price:T(o?.price??o?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:a.packageId??a.package_id??a.barcode??null,name:a.desc??a.name??"",quantity:r,unit_price:T(a.price??a.unit_price??0),items:s})}),n}function fn(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function be(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return H(t)}function Ct(e){return e==null?"":_(String(e)).trim().toLowerCase()}function Ka(e={}){if(!e||typeof e!="object"){const s=_(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,price:0,unit_price:0,barcode:s,normalizedBarcode:Ct(s),desc:"",image:null}}const t=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,n=j(e.quantity??e.qty??e.count??1),a=T(e.unit_price??e.unitPrice??e.price??0),r=_(String(e.barcode??e.normalizedBarcode??e.code??e.serial??""));return{equipmentId:t!=null?String(t):null,equipment_id:t,qty:n,quantity:n,price:a,unit_price:a,barcode:r,normalizedBarcode:Ct(e.normalizedBarcode??r),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function Fe(e={},t=""){if(!e||typeof e!="object")return[];const n=be(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),a=[];Array.isArray(e.packageItems)&&a.push(...e.packageItems),Array.isArray(e.package_items)&&a.push(...e.package_items),Array.isArray(e.items)&&a.push(...e.items),Array.isArray(e.equipment)&&a.push(...e.equipment),Array.isArray(e.contents)&&a.push(...e.contents);let r=ye({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:a,packageItems:a});if((!Array.isArray(r)||r.length===0)&&n){const i=tt(n);i&&(r=ye(i))}if(!Array.isArray(r)||r.length===0)return[];const s=r.map(i=>Ka(i)),o=new Map;return s.forEach(i=>{const l=i.normalizedBarcode||(i.equipmentId?`id:${i.equipmentId}`:null);if(l){if(o.has(l)){const c=o.get(l);c.qty+=i.qty,c.quantity+=i.quantity,(!c.price||c.price===0)&&i.price&&(c.price=i.price,c.unit_price=i.unit_price),!c.desc&&i.desc&&(c.desc=i.desc),!c.image&&i.image&&(c.image=i.image);return}o.set(l,{...i})}}),Array.from(o.values())}function Ya(e={},t=[],n=1){const a=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(a))){const r=T(a);return n>0?Number((r/n).toFixed(2)):r}if(Number.isFinite(Number(e.unit_price??e.unitPrice??e.price)))return T(e.unit_price??e.unitPrice??e.price);if(Array.isArray(t)&&t.length){const r=t.reduce((s,o)=>s+(Number.isFinite(Number(o.price))?Number(o.price):0),0);if(r>0)return Number(r.toFixed(2))}return 0}function gn(e,t){if(!e)return t;if(!t)return e;const n={...e},a=r=>{(n[r]===void 0||n[r]===null||n[r]==="")&&(n[r]=t[r])};return["name","desc","barcode","image"].forEach(a),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=Qa(n.packageItems,t.packageItems),n.items=n.packageItems),n}function Qa(e=[],t=[]){const n=new Map,a=r=>{r.forEach(s=>{if(!s)return;const o=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(o){if(n.has(o)){const i=n.get(o);i.qty+=s.qty??0,i.quantity+=s.quantity??0,(!i.price||i.price===0)&&s.price&&(i.price=s.price,i.unit_price=s.unit_price),!i.desc&&s.desc&&(i.desc=s.desc),!i.image&&s.image&&(i.image=s.image);return}n.set(o,{...s})}})};return a(e),a(t),Array.from(n.values())}function ht(e=[],t=[]){const n=[],a=new Map,r=s=>{Array.isArray(s)&&s.forEach(o=>{if(!o||typeof o!="object")return;const i=o.packageId||o.package_id||o.package_code||o.id;if(i)if(a.has(i)){const l=a.get(i);n[l]=gn(n[l],o)}else a.set(i,n.length),n.push({...o})})};return r(e),r(t),n}function hn(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const d=be(e),m=d?tt(d):null,h=m?Fe(m,d):[],f=m?T(m.price??m.unit_price??m.unitPrice??0):0,y=1,A=Number((f*y).toFixed(2));return{id:`package::${d||t}`,packageId:d||`pkg-${t}`,package_id:d||`pkg-${t}`,package_code:_(String(e))||d||`pkg-${t}`,name:m?.name??m?.package_name??m?.packageName??_(String(e))??"",desc:m?.name??_(String(e))??"",quantity:y,qty:y,unit_price:f,unitPrice:f,price:f,total:A,total_price:A,barcode:_(String(e)),packageItems:h,items:h,type:"package",image:m?.image??null}}if(typeof e!="object")return null;const n=be(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,a=j(e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1),r=Fe(e,n),s=Ya(e,r,a),o=e.total_price??e.totalPrice??e.total??s*a,i=Number.isFinite(Number(o))?T(o):Number((s*a).toFixed(2)),l=e.package_code??e.packageCode??e.code??n,c=_(String(e.barcode??l??"")),u=e.image??e.cover??e.thumbnail??r.find(d=>d.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:l,name:e.name??e.package_name??e.packageName??e.title??e.description??l??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??l??n,quantity:a,qty:a,unit_price:s,unitPrice:s,price:s,total:i,total_price:i,barcode:c,packageItems:r,items:r,type:"package",image:u}}function yt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],a=new Map,r=(i,l=n.length)=>{const c=hn(i,l);if(!c)return;const u=c.packageId||c.package_code||c.id||`pkg-${l}`;if(a.has(u)){const d=a.get(u);n[d]=gn(n[d],c)}else a.set(u,n.length),n.push(c)};t.forEach(i=>{i.forEach((l,c)=>{r(l,c+n.length)})}),n.length===0&&e.package&&r(e.package,0);const s=Array.isArray(e.items)?e.items:[],o=(i={})=>!i||typeof i!="object"?!1:!!(fn(i.type??i.item_type??i.kind??null)==="package"||i.packageItems&&Array.isArray(i.packageItems)&&i.packageItems.length||i.items&&Array.isArray(i.items)&&i.items.length&&i.items.every(c=>typeof c=="object")||i.packageId||i.package_id||i.package_code||i.packageCode||i.bundleId||i.bundle_id);return s.forEach((i,l)=>{o(i)&&r(i,n.length+l)}),n}function T(e){const t=Number(_(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function j(e){const t=Number.parseInt(_(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function Ja(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return"pending"}}function Ga(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function ki(e){return e instanceof Pe}export{$a as $,di as A,oi as B,Ra as C,sn as D,Ne as E,ri as F,ma as G,ai as H,hi as I,fi as J,tt as K,sa as L,oa as M,ci as N,mi as O,si as P,ii as Q,Ba as R,Sa as S,Ei as T,Ni as U,li as V,bi as W,ui as X,pi as Y,Ti as Z,Pi as _,Ii as a,Fa as a0,_i as a1,lt as a2,Ha as a3,Ai as b,ki as c,ei as d,ni as e,ye as f,Si as g,ut as h,yi as i,dt as j,Ee as k,mt as l,Ke as m,x as n,Wt as o,xa as p,Xa as q,qn as r,Yt as s,J as t,ti as u,vi as v,ja as w,gi as x,H as y,ca as z};
