import{d as F,n as S,b as x,A as Le,s as Pe,f as tt,t as u,h as T,o as nt,j as Ce}from"./auth.js";const at=F()||{};let k=(at.technicians||[]).map(Re);function $e(){return k}function G(e){return k=Array.isArray(e)?e.map(Re):[],Pe({technicians:k}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),k}async function it(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,c])=>{c!=null&&c!==""&&t.set(s,String(c))});const n=t.toString(),a=await x(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(le):[];return G(i)}async function st(e){const t=await x("/technicians/",{method:"POST",body:e}),n=le(t?.data??{});return G([...k,n]),n}async function Fe(e,t){const n=await x(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=le(n?.data??{}),i=k.map(s=>String(s.id)===String(e)?a:s);return G(i),a}async function ct(e){await x(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),G(k.filter(t=>String(t.id)!==String(e)))}function xe({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,dailyTotal:c,status:o,notes:l,active:r=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,daily_total:c??null,status:o??"available",notes:l??null,active:r?1:0}}function le(e={}){return ke({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function Re(e={}){return ke(e)}function ke(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",c=e.department??e.team??"",o=Ie(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=Ie(e.daily_total??e.dailyTotal??e.total??e.total_wage??o),r=Te(e.baseStatus??e.status??"available"),p=Te(e.status??e.baseStatus??"available"),d=e.notes??"",h=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:c,dailyWage:o,dailyTotal:l,status:p,baseStatus:r,notes:d,active:h}}function Ie(e){const t=Number.parseFloat(S(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Te(e){switch(String(e??"").trim().toLowerCase()){case"available":case"ŸÖÿ™ÿßÿ≠":return"available";case"busy":case"ŸÖÿ¥ÿ∫ŸàŸÑ":case"ŸÇŸäÿØ ÿßŸÑÿπŸÖŸÑ":return"busy";case"leave":case"ÿ•ÿ¨ÿßÿ≤ÿ©":case"ÿÆÿßÿ±ÿ¨ ÿßŸÑÿÆÿØŸÖÿ©":return"leave";case"inactive":case"ŸÖÿ™ŸàŸÇŸÅ":return"inactive";default:return"available"}}function ie(e){return e instanceof Le}let B=null,Ee=!1,Z=!1,Y="",re=!1;async function Me({showToastOnError:e=!0}={}){if(!Z){Z=!0,Y="",N();try{await it(),re=!0}catch(t){console.error("‚ùå [technicians] loadTechniciansFromApi failed",t),Y=ie(t)?t.message:u("technicians.toast.fetchFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©"),e&&T(Y,"error")}finally{Z=!1,N()}}}function ze(){return $e()}function Q(e=""){return S(String(e)).trim().toLowerCase()}function Ne(e){return e==null?"":String(e)}function V(e=""){return S(String(e)).replace(/[^0-9+]/g,"")}function _(e=""){const t=S(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function j(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function ue(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ":"‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ∂Ÿà ÿ∑ÿßŸÇŸÖ";t.textContent=u(n,a)}function de(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=u("technicians.form.actions.cancel","ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑ"))}function me(){ue(B?"update":"add"),de(!!B),N()}function ot(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,c)=>s.localeCompare(c,"ar",{sensitivity:"base"})),i=u("technicians.search.filters.allRoles","üëî ŸÉŸÑ ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function se(){const e=document.getElementById("technician-form");e&&(e.reset(),B=null,ue("add"),de(!1))}function rt(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-wage"),c=document.getElementById("technician-total"),o=document.getElementById("technician-notes");!t||!n||!a||!s||!c||(t.value=e.name||"",n.value=V(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s.value=_(e.dailyWage!=null?e.dailyWage:""),c.value=_(e.dailyTotal!=null?e.dailyTotal:""),o&&(o.value=e.notes||""),B=String(e.id),ue("update"),de(!0))}function lt(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-wage"),s=document.getElementById("technician-total"),c=document.getElementById("technician-notes");if(!e||!t||!n||!i||!s)return null;const o=e.value.trim(),l=V(t.value.trim());t.value=l;const r=n.value.trim(),p=a?.value.trim()||"",d=_(i.value.trim());i.value=d;const h=d===""?0:parseFloat(d),g=_(s.value.trim());s.value=g;const y=g===""?null:parseFloat(g),b="available",I=c?.value.trim()||"";return o?l?r?Number.isNaN(h)||h<0?(T(u("technicians.toast.invalidWage","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ£ÿ¨ÿ± ÿßŸÑŸäŸàŸÖŸä")),i.focus(),null):y!=null&&(Number.isNaN(y)||y<0)?(T(u("technicians.toast.invalidTotal","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©")),s.focus(),null):{name:o,phone:l,role:r,department:p,dailyWage:Number.isFinite(h)?h:0,dailyTotal:y==null?null:Number(y),status:b,baseStatus:b,notes:I}:(T(u("technicians.toast.missingRole","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ∏ŸäŸÅÿ©")),n.focus(),null):(T(u("technicians.toast.missingPhone","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ")),t.focus(),null):(T(u("technicians.toast.missingName","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),e.focus(),null)}async function ut(e){e.preventDefault();const t=lt();if(!t)return;const n=xe({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{B?(await Fe(B,n),T(u("technicians.toast.updateSuccess","üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"))):(await st(n),T(u("technicians.toast.addSuccess","‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"))),se(),N()}catch(a){console.error("‚ùå [technicians] handleTechnicianSubmit failed",a);const i=ie(a)?a.message:u("technicians.toast.saveFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");T(i,"error")}}function dt(){se()}function mt(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=V(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=_(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=_(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==i&&(t.total.value=i);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),j(t.phone,V),j(t.wage,_),j(t.total,_)}function pt(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),c=document.getElementById("edit-technician-total"),o=document.getElementById("edit-technician-status"),l=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!c||!o)return null;const r=e.value.trim(),p=t.value.trim(),d=V(n.value.trim());n.value=d;const h=a.value.trim(),g=i?.value.trim()||"",y=_(s.value.trim());s.value=y;const b=y===""?0:parseFloat(y),I=_(c.value.trim());c.value=I;const f=I===""?null:parseFloat(I),E=o.value||"available",m=l?.value.trim()||"";return r?p?d?h?Number.isNaN(b)||b<0?(T(u("technicians.toast.invalidWage","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ£ÿ¨ÿ± ÿßŸÑŸäŸàŸÖŸä")),s.focus(),null):f!=null&&(Number.isNaN(f)||f<0)?(T(u("technicians.toast.invalidTotal","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©")),c.focus(),null):{id:r,name:p,phone:d,role:h,department:g,dailyWage:Number.isFinite(b)?b:0,dailyTotal:f==null?null:Number(f),status:E,baseStatus:E,notes:m}:(T(u("technicians.toast.missingRole","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ∏ŸäŸÅÿ©")),a.focus(),null):(T(u("technicians.toast.missingPhone","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ")),n.focus(),null):(T(u("technicians.toast.missingName","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),t.focus(),null):(T(u("technicians.toast.unidentified","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®")),null)}async function ft(){const e=pt();if(!e)return;const t=xe({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await Fe(e.id,t),T(u("technicians.toast.updateSuccess","üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),N()}catch(n){console.error("‚ùå [technicians] handleTechnicianModalSave failed",n);const a=ie(n)?n.message:u("technicians.toast.updateFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ");T(a,"error")}}function N(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Q(t?.value||"");if(Z&&!re){const r=u("technicians.table.loading","ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}if(Y&&!re){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${Y}</td></tr>`;return}const a=we(),{reservations:i=[]}=F(),s=new Date;ot(a);const c=document.getElementById("technician-role-filter"),o=Q(c?.value||""),l=a.filter(r=>o&&Q(r.role||"")!==o?!1:n?Q([r.name,r.phone,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const r=u("technicians.table.empty","ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿπÿ∂ÿßÿ° ŸÅŸä ÿßŸÑÿ∑ÿßŸÇŸÖ ÿ®ÿπÿØ.");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}e.innerHTML=l.map(r=>{const p=B&&String(B)===String(r.id),g=(qe(r.id,i,s)?"busy":r.status||r.baseStatus||"available")==="busy"?{label:u("technicians.status.busy","‚õî ŸÖÿ¥ÿ∫ŸàŸÑ"),className:"technician-status-badge technician-status-badge--busy"}:{label:u("technicians.status.available","‚úÖ ŸÖÿ™ÿßÿ≠"),className:"technician-status-badge technician-status-badge--available"},y=u("technicians.actions.edit","‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ"),b=u("technicians.actions.delete","üóëÔ∏è ÿ≠ÿ∞ŸÅ"),I=Ce(),f=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${r.id}">${y}</button>`];return I&&f.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${r.id}">${b}</button>`),`
      <tr${p?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${r.id}" class="text-decoration-none">${r.name}</a></td>
        <td>${r.role||""}</td>
        <td>${r.department||"‚Äî"}</td>
        <td><span class="${g.className}"><span class="technician-status-badge__text">${g.label}</span></span></td>
        <td class="table-notes-cell">${r.notes||"‚Äî"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${f.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function ht(e){const t=ze().find(n=>String(n.id)===String(e));if(!t){T(u("technicians.toast.dataNotFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"));return}rt(t),T(u("technicians.toast.editReady","‚úèÔ∏è ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ ÿßŸÑÿ¢ŸÜ ÿ´ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ"))}async function yt(e){if(!Ce()){nt();return}if(confirm(u("technicians.toast.deleteConfirm","‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿπÿ∂Ÿàÿü")))try{await ct(e),T(u("technicians.toast.deleteSuccess","üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),B&&String(B)===String(e)&&se(),N()}catch(t){console.error("‚ùå [technicians] handleDeleteClick failed",t);const n=ie(t)?t.message:u("technicians.toast.deleteFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");T(n,"error")}}function qt(){pe(),N()}function wt(e){return ze().find(t=>String(t.id)===String(e))||null}function qe(e,t=[],n){const a=Ne(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(l=>Ne(l)===a))return!1;const c=new Date(i.start),o=new Date(i.end);return Number.isNaN(c.getTime())||Number.isNaN(o.getTime())?!1:c<=n&&n<o}):!1}function we(){const e=F().reservations||[],t=$e();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const c=s.baseStatus||s.status||"available";let o=c==="busy"?"busy":c;return qe(s.id,e,n)&&(o="busy"),(o!==s.status||c!==s.baseStatus)&&(a=!0),{...s,baseStatus:c,status:o}});return a?(G(i),i):t}function pe(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",o=>{ut(o).catch(l=>{console.error("‚ùå [technicians] submit handler failed",l)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",dt),n.dataset.listenerAttached="true"),j(document.getElementById("technician-phone"),V),j(document.getElementById("technician-wage"),_),j(document.getElementById("technician-total"),_);const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",o=>{const l=o.target;if(l instanceof HTMLElement){if(l.classList.contains("technician-edit-btn")){const r=l.dataset.id;ht(r)}if(l.classList.contains("technician-delete-btn")){const r=l.dataset.id;yt(r).catch(p=>{console.error("‚ùå [technicians] delete handler failed",p)})}}}),a.dataset.listenerAttached="true");const i=document.getElementById("search-technician-input");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{i.value=S(i.value),N()}),i.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{N()}),s.dataset.listenerAttached="true");const c=document.getElementById("save-technician-changes");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",()=>{ft().catch(o=>{console.error("‚ùå [technicians] modal save failed",o)})}),c.dataset.listenerAttached="true"),Ee||(document.addEventListener("technician:prefill",o=>{const l=o.detail;l&&mt(l)}),Ee=!0),t&&se()}window.addEventListener("DOMContentLoaded",()=>{pe(),N(),me(),Me()});const je=()=>{N()};window.addEventListener("technicians:updated",je);document.addEventListener("technicians:updated",je);document.addEventListener("technicians:refreshRequested",()=>{pe(),N(),me(),Me({showToastOnError:!1})});document.addEventListener("language:changed",()=>{me()});document.addEventListener(tt.USER_UPDATED,()=>{N()});let H=[],Ve=[],He=[];function jt(){return H}function Vt(e){H=Array.isArray(e)?e:[]}function Ht(e){H=[...H,e]}function Wt(e){Number.isInteger(e)&&e>=0&&(H=H.filter((t,n)=>n!==e))}function Ut(){return Ve}function Ot(e){Ve=Array.isArray(e)?e:[]}function Kt(){return He}function Yt(e){He=Array.isArray(e)?e:[]}function Gt(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),s=a?a.slice(0,10):"",c=i.match(/(\d{1,2}:\d{2})/);let o="";if(c){const[l="00",r="00"]=c[0].split(":");o=`${l.padStart(2,"0")}:${r.padStart(2,"0")}`}return{date:s,time:o}}function X(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function Ae(e){return S(String(e||"")).trim().toLowerCase()}function Jt(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:c=[]}=F(),o=Ae(e),l=We(a);return c.some(r=>{if(!r||!Array.isArray(r.items)||r.items.length===0||Ue(r,l)||!r.start||!r.end)return!1;const p=new Date(r.start),d=new Date(r.end);return Number.isNaN(p.getTime())||Number.isNaN(d.getTime())||!(p<s&&d>i)?!1:r.items.some(g=>Ae(g?.barcode)===o)})}function gt(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:c=[]}=F(),o=String(e),l=We(a);return c.some(r=>{if(!r?.start||!r?.end||Ue(r,l))return!1;const p=new Date(r.start),d=new Date(r.end);return Number.isNaN(p.getTime())||Number.isNaN(d.getTime())||!(p<s&&d>i)?!1:(Array.isArray(r.technicians)?r.technicians:[]).some(y=>String(y)===o)})}function We(e){return w(e,new Set)}function Ue(e,t){if(!t||t.size===0)return!1;const n=w([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function w(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(s=>w(s,t)),t;if(Array.isArray(e))return e.forEach(s=>w(s,t)),t;if(typeof e=="object"){const s=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return s.forEach(o=>{Object.prototype.hasOwnProperty.call(e,o)&&(c=!0,w(e[o],t))}),c||Object.values(e).forEach(o=>w(o,t)),t}const n=S(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],i=n.replace(/\D+/g,"");if(i){a.push(i);const s=Number.parseInt(i,10);Number.isNaN(s)||a.push(String(s))}return a.forEach(s=>{s&&t.add(s)}),t}let M=[],L=[],P=[],ee="create",fe=()=>{},he=()=>{};function bt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=S(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function Oe(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const i of t){if(i==null||i==="")continue;const s=parseFloat(S(String(i)));if(Number.isFinite(s)){n=s;break}}if((!Number.isFinite(n)||n<=0)&&(n=bt(e)),!Number.isFinite(n)||n<=0)return"‚Äî";const a=u("technicians.table.wageSuffix","SR");return`${S(String(n))} ${a}`}function _e(e=""){return S(String(e)).trim().toLowerCase()}function Ke(e){return!M||!M.length?null:M.find(t=>String(t?.id)===String(e))||null}function vt(e,t="create"){t==="edit"?be(P.filter(n=>String(n)!==String(e))):ge(L.filter(n=>String(n)!==String(e)))}function te(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=u("reservations.crew.none","ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿπÿ∂Ÿà ŸÖŸÜ ÿßŸÑÿ∑ÿßŸÇŸÖ.");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const s=Ke(i)||{},c=u("reservations.crew.fallbackName","ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ {id}").replace("{id}",i),o=s.name||c,l=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",r=Oe(s),p=r!=="‚Äî"?`<small class="technician-chip-wage">üí∞ ${r}</small>`:"",d=u("reservations.crew.removeAria","ÿ•ÿ≤ÿßŸÑÿ©");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${o}</span>
          ${l}
          ${p}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${d}">‚úñ</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>vt(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function Ye(){return ee==="edit"?P:L}function ne(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=_e(t?.value||""),a=new Set(Ye().map(String)),s=(M||[]).filter(c=>n?_e([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const c=u("reservations.crew.searchEmpty","ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${c}</td></tr>`;return}e.innerHTML=s.map(c=>{const o=Oe(c);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${c.id}" ${a.has(String(c.id))?"checked":""}>
        </td>
        <td>${c.name||"-"}</td>
        <td>${c.role||"‚Äî"}</td>
        <td>${c.department||"‚Äî"}</td>
        <td>${o}</td>
      </tr>
    `}).join("")}function St(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function It(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),r=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=o?X(o,r):null,h=l?X(l,p):null;let g=null;const y=document.getElementById("edit-res-index")?.value;if(y!=null){const b=Number.parseInt(y,10);if(Number.isInteger(b)){const{reservations:I=[]}=F(),f=I?.[b];f&&(g=f.id??f.reservationId??null)}}return{start:d,end:h,ignoreReservationId:g}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?X(t,a):null,c=n?X(n,i):null;return{start:s,end:c,ignoreReservationId:null}}function W(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=Ye().length;if(t){const n=u("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",S(String(t)));e.textContent=n}else e.textContent=u("technicians.picker.selectionInfo","No crew selected yet")}function Tt(){const e=St().map(String),{start:t,end:n,ignoreReservationId:a}=It(ee);if(t&&n){const s=e.filter(c=>gt(c,t,n,a));if(s.length>0){const c=s.map(l=>Ke(l)?.name||l).join(u("reservations.list.crew.separator","ÿå ")),o=u("reservations.toast.technicianSelectionConflict","‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± {names} ŸÑÿ£ŸÜŸáŸÖ ŸÖÿ±ÿ™ÿ®ÿ∑ŸàŸÜ ÿ®ÿ≠ÿ¨ÿ≤ ÿ¢ÿÆÿ± ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©").replace("{names}",c);s.forEach(l=>{const r=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(l))}"]`);r&&(r.checked=!1)}),T(o),W();return}}ee==="edit"?be(e):ge(e),W();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function Be(e="create"){ee=e;const t=we();Array.isArray(t)&&t.length&&(M=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),ne(),W();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function Et(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Be("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>Be("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{ne(),W()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Tt),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{W(),ne()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),ye()}function ye(){te("selected-technicians-list",L,"create"),te("edit-selected-technicians-list",P,"edit")}function Qt({onDraftChange:e,onEditChange:t}={}){fe=typeof e=="function"?e:()=>{},he=typeof t=="function"?t:()=>{},ye(),Et()}function Nt(e=[]){M=Array.isArray(e)?e:[]}function At(){return[...L]}function _t(){return[...P]}function ge(e=[]){L=Array.isArray(e)?e.map(String):[],te("selected-technicians-list",L,"create"),fe()}function be(e=[]){P=Array.isArray(e)?e.map(String):[],te("edit-selected-technicians-list",P,"edit"),he()}function Xt(){ge([])}function Zt(){be([])}function en(e=[]){Nt(e);const t=new Set(M.map(o=>String(o.id))),n=L.filter(o=>t.has(String(o))),a=P.filter(o=>t.has(String(o))),i=n.length!==L.length,s=a.length!==P.length;L=n,P=a,ye(),i&&fe(),s&&he();const c=document.getElementById("selectTechniciansModal");c&&c.classList.contains("show")&&(ne(),W())}const Ge=10;function Je(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function Bt(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=Number(n);if(Number.isFinite(a))return a}return Je(e)}function Dt(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=F();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));if(!s)return a;const c=Je(s),o=Bt(s);return{costPerDay:a.costPerDay+(Number.isFinite(c)?c:0),totalPerDay:a.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const Lt=1440*60*1e3;function Pt(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/Lt;return Math.max(1,Math.ceil(s))}function U({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:i=!1,start:s=null,end:c=null,companySharePercent:o=null}={}){const l=Pt(s,c),p=(e||[]).reduce((q,J)=>q+(Number(J?.qty)||1)*(Number(J?.price)||0),0)*l,{costPerDay:d,totalPerDay:h}=Dt(t),g=h*l,y=d*l,b=p+g,I=Number(n)||0;let f=a==="amount"?I:b*(I/100);(!Number.isFinite(f)||f<0)&&(f=0),f>b&&(f=b);const E=Math.max(0,b-f);let m=Number.isFinite(o)?Number(o):null;i&&(!Number.isFinite(m)||m<=0)&&(m=Ge);const C=m&&m>0?m:0,A=C>0?Math.max(0,E*(C/100)):0,$=E+A;let v=i?$*.15:0;(!Number.isFinite(v)||v<0)&&(v=0),v=Number(v.toFixed(2));const oe=$+v,O=Math.max(0,Number(oe.toFixed(2))),R=Math.max(0,p+g-y);return{rentalDays:l,equipmentTotal:p,crewTotal:g,crewCostTotal:y,discountAmount:f,subtotalAfterDiscount:E,taxableAmount:$,taxAmount:v,finalTotal:O,companySharePercent:C,companyShareAmount:A,netProfit:R}}function tn(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:c=null,companySharePercent:o=null}={}){return U({items:e,technicianIds:i,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:o}).finalTotal}function Qe({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paidStatus:s,companySharePercent:c=null,companyShareAmount:o=null,taxAmount:l=null,netProfit:r=null,totalKey:p="reservations.summary.total"}){const d=u("reservations.create.summary.currency","SR"),h=S(String(e)),g=S(String(t)),y=S(String(n??1)),b=S(String(a)),I=s==="paid"?u("reservations.create.paymentStatus.paid","ŸÖÿØŸÅŸàÿπ"):u("reservations.create.paymentStatus.unpaid","ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ"),f=u("reservations.summary.itemsLabel","üì¶ ÿπÿØÿØ ÿßŸÑŸÖÿπÿØÿßÿ™"),E=u("reservations.summary.durationLabel","‚è±Ô∏è ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ"),m=u("reservations.summary.crewLabel","üòé ÿπÿØÿØ ÿßŸÑŸÅÿ±ŸäŸÇ"),C=u("reservations.summary.taxLabelShort","üßæ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©"),A=u("reservations.summary.paymentLabelShort","üí≥ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ"),$=u(p.replace(".total",".totalLabel"),"üí∞ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©"),v=u("reservations.summary.companyShareLabel","üè¶ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ¥ÿ±ŸÉÿ©"),oe=u("reservations.details.labels.netProfit","üíµ ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠"),O=Number.isFinite(r)?Math.max(0,Number(r)):null,R=[{label:f,value:g},{label:E,value:y},{label:m,value:b}];if(i){let D=u("reservations.summary.taxIncludedValue","ÿ¥ÿßŸÖŸÑ 15%");Number.isFinite(l)&&l>0&&(D=`${S(Number(l).toFixed(2))} ${d}`),R.push({label:C,value:D})}const q=Number.isFinite(c)?Number(c):null;if(q!==null&&q>0){const D=Number.isFinite(o)?Number(o):e*(q/100),K=S(String(q)),Ze=S(Number.isFinite(D)?D.toFixed(2):"0"),et=`${K}% (${Ze} ${d})`;R.push({label:v,value:et})}if(O!==null&&Math.abs(O-Number(e))>.009){const D=S(O.toFixed(2));R.push({label:oe,value:`${D} ${d}`})}R.push({label:A,value:I});const J=`${h} ${d}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${R.map(({label:D,value:K})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${D}</span>
            ${K?`<span class="reservation-summary-value">${K}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${$}</span>
          <span class="reservation-summary-value">${J}</span>
        </div>
      </div>
    </div>
  `}function nn({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:c,companySharePercent:o=null}){const l=At(),r=l.length,p=Number.isFinite(o)?Number(o):null,d=U({items:e,technicianIds:l,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:p}),h=Qe({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:r,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit});Ct(h)}function an({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:c,companySharePercent:o=null}){const l=_t(),r=l.length,p=Number.isFinite(o)?Number(o):null,d=U({items:e,technicianIds:l,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:p});return Qe({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:r,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit,totalKey:"reservations.summary.totalAfterEdit"})}function Ct(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,De(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,De(n,e))}function De(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const $t=F()||{};let z=($t.reservations||[]).map(xt);function sn(){return z}function ce(e){return z=Array.isArray(e)?e.map(Se):[],Pe({reservations:z}),z}async function cn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),i=(await x(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const c=s.map(ve);return ce(c)}async function on(e){const t=await x("/reservations/",{method:"POST",body:e}),n=ve(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=U({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,ce([...z,n]),n}async function Ft(e,t){const n=await x(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=ve(n?.data??{});if(!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const s=U({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=s.companyShareAmount,a.cost=s.finalTotal,a.totalAmount=s.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const i=z.map(s=>String(s.id)===String(e)?a:s);return ce(i),a}async function rn(e){await x(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=z.filter(n=>String(n.id)!==String(e));ce(t)}async function ln(e){return Ft(e,{status:"confirmed",confirmed:!0})}function ve(e={}){return Se({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount})}function xt(e={}){return Se(e)}function Se(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(Rt):[],i=Array.isArray(e.technicians)?e.technicians:[],s=i.map(v=>v==null?null:String(typeof v=="object"?v.id??v.technician_id??v.technicianId??v.ID??"":v)).filter(v=>v&&v!==""),c=e.start??e.start_datetime??"",o=e.end??e.end_datetime??"";let l=ae(e.total_amount??e.totalAmount??e.cost??0);const r=ae(e.discount??0),p=e.discount_type??e.discountType??"percent",d=["percent","amount"].includes(p)?p:"percent",h=!!(e.apply_tax??e.applyTax??!1),g=Mt(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid",y=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),b=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,I=b!=null?Number.parseFloat(S(String(b).replace("%","").trim())):NaN,f=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let E=f!=null?f===!0||f===1||f==="1"||String(f).toLowerCase()==="true":Number.isFinite(I)&&I>0,m=E&&Number.isFinite(I)?Number(I):0;const C=e.company_share_amount??e.companyShareAmount;let A=Number.isFinite(Number(C))?Number(C):NaN;h&&m<=0&&(m=Ge,E=!0);const $=U({items:a,technicianIds:s,discount:r,discountType:d,applyTax:h,start:c,end:o,companySharePercent:m>0?m:null});return(!Number.isFinite(l)||l<=0||h)&&(l=$.finalTotal),(!Number.isFinite(A)||A<0)&&(A=$.companyShareAmount),A=Number.isFinite(A)?Number(A.toFixed(2)):0,!E&&m>0&&(E=!0),{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:c,end:o,status:kt(e.status??(y?"confirmed":"pending")),confirmed:y,location:e.location??"",notes:e.notes??"",discount:r,discountType:d,applyTax:h,paid:g==="paid",paidStatus:g,totalAmount:l,cost:l,projectId:e.project_id??e.projectId??null,items:a,technicians:s,techniciansDetails:i.map(v=>typeof v=="object"?v:{id:Number(v)||v}),startDatetime:c,endDatetime:o,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:m,companyShareAmount:A,companyShareEnabled:E}}function Rt(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=Xe(e.quantity??e.qty??1),a=ae(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:S(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function un({reservationCode:e,customerId:t,start:n,end:a,status:i,title:s,location:c,notes:o,projectId:l,totalAmount:r,discount:p,discountType:d,applyTax:h,paidStatus:g,confirmed:y,items:b,technicians:I,companySharePercent:f,companyShareEnabled:E}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:s??null,location:c??null,notes:o??null,project_id:l||null,total_amount:r??0,discount:p??0,discount_type:d??"percent",apply_tax:h?1:0,paid_status:g??"unpaid",confirmed:y===void 0?null:!!y,items:Array.isArray(b)?b.map(m=>({equipment_id:m.equipmentId??m.equipment_id??m.id,quantity:Xe(m.qty??m.quantity??1),unit_price:ae(m.price??m.unit_price??0),notes:m.notes??null})):[],company_share_percent:E&&Number.isFinite(f)?Number(f):null,company_share_enabled:E?1:0,technicians:Array.isArray(I)?I.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function ae(e){const t=Number(S(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Xe(e){const t=Number.parseInt(S(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function kt(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"ŸÖÿπŸÑŸÇ":case"ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±":return"pending";case"confirmed":case"ŸÖÿ§ŸÉÿØ":return"confirmed";case"in_progress":case"in-progress":case"ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞":case"ÿ¨ÿßÿ±Ÿä":return"in_progress";case"completed":case"ŸÖŸÉÿ™ŸÖŸÑ":return"completed";case"cancelled":case"ŸÖŸÑÿ∫Ÿä":return"cancelled";default:return"pending"}}function Mt(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"ŸÖÿØŸÅŸàÿπ":return"paid";case"partial":case"ŸÖÿØŸÅŸàÿπ ÿ¨ÿ≤ÿ¶ŸäÿßŸã":case"partial_paid":return"partial";case"unpaid":case"ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ":case"not_paid":default:return"unpaid"}}function dn(e){return e instanceof Le}export{gt as A,un as B,on as C,Ge as D,Kt as E,Xt as F,Vt as G,Yt as H,an as I,be as J,_t as K,Zt as L,rn as M,ln as N,cn as a,le as b,ve as c,qt as d,wt as e,Pt as f,sn as g,tn as h,dn as i,Qt as j,en as k,Ut as l,xt as m,Ae as n,nn as o,X as p,Gt as q,it as r,we as s,Ot as t,Ft as u,jt as v,Jt as w,Ht as x,Wt as y,At as z};
