import{d as V,n as I,b as O,A as Ue,s as an,a as ti,m as ni,c as ii,i as ai,l as si,e as ce,t as f,f as oi,h as N,j as sn,o as ci}from"./auth.js";const ri=V()||{};let me=(ri.technicians||[]).map(ln);function on(){return me}function ze(e){return me=Array.isArray(e)?e.map(ln):[],an({technicians:me}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),me}async function li(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,c])=>{c!=null&&c!==""&&t.set(a,String(c))});const n=t.toString(),i=await O(`/technicians/${n?`?${n}`:""}`),s=Array.isArray(i?.data)?i.data.map(ft):[];return ze(s)}async function ui(e){const t=await O("/technicians/",{method:"POST",body:e}),n=ft(t?.data??{});return ze([...me,n]),n}async function cn(e,t){const n=await O(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=ft(n?.data??{}),s=me.map(a=>String(a.id)===String(e)?i:a);return ze(s),i}async function di(e){await O(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ze(me.filter(t=>String(t.id)!==String(e)))}function rn({name:e,phone:t,email:n,role:i,department:s,dailyWage:a,dailyTotal:c,status:o,notes:r,active:l=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:i??"",department:s??null,daily_wage:a??0,daily_total:c??null,status:o??"available",notes:r??null,active:l?1:0}}function ft(e={}){return un({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function ln(e={}){return un(e)}function un(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",i=e.phone??"",s=e.email??null,a=e.specialization??e.role??e.position??"",c=e.department??e.team??"",o=xt(e.daily_wage??e.dailyWage??e.wage??e.rate??0),r=xt(e.daily_total??e.dailyTotal??e.total??e.total_wage??o),l=Mt(e.baseStatus??e.status??"available"),d=Mt(e.status??e.baseStatus??"available"),u=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:i,email:s,role:a,department:c,dailyWage:o,dailyTotal:r,status:d,baseStatus:l,notes:u,active:p}}function xt(e){const t=Number.parseFloat(I(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Mt(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function Ge(e){return e instanceof Ue}ti();ni();ii();document.addEventListener("DOMContentLoaded",()=>{ai();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>si()),e.dataset.listenerAttached="true")});function Oe(e){const t=Number(e)||0,i=ce()==="ar"?"ar-SA-u-nu-latn":"en-US",s=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${I(s)} SR`}function Ma(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function ja(e){const t=new Date,n=e?.start?new Date(e.start):null,i=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":i&&!Number.isNaN(i.getTime())&&i<t?"completed":"ongoing"}function Ha(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}…`:""}function pe(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const pi="technicianPositions:updated";let K=[],dn=!1,qe=null;function gt(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function pn({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:i??null,label_en:s??null}}function mi(e){return K=Array.isArray(e)?e.map(gt).filter(t=>t.name!=="").sort((t,n)=>Ne(t).localeCompare(Ne(n),"ar",{sensitivity:"base"})):[],dn=!0,Ye(),re()}function Ye(){try{const e={positions:re()},t=new CustomEvent(pi,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function Ne(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function re(){return K.map(e=>({...e}))}function mn(e){const t=String(e??"").trim().toLowerCase();return t&&K.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function fi({forceRefresh:e=!1}={}){return dn&&!e?re():(qe&&!e||(qe=O("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return mi(n)}).finally(()=>{qe=null})),qe)}async function Re({forceRefresh:e=!1}={}){try{return await fi({forceRefresh:e})}catch(t){throw t instanceof Ue?t:new Ue(t?.message||f("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"))}}async function gi({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}){const a=pn({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:s}),c=await O("/technician-positions/",{method:"POST",body:a}),o=gt(c?.data??{});return K=[...K,o],K.sort((r,l)=>Ne(r).localeCompare(Ne(l),"ar",{sensitivity:"base"})),Ye(),o}async function hi(e,{name:t,cost:n,clientPrice:i,labelAr:s,labelEn:a}){if(!e)throw new Error("Position id is required");const c=pn({name:t,cost:n,clientPrice:i,labelAr:s,labelEn:a}),o=await O(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:c}),r=gt(o?.data??{});return K=K.map(l=>l.id===r.id?r:l),K.sort((l,d)=>Ne(l).localeCompare(Ne(d),"ar",{sensitivity:"base"})),Ye(),r}async function yi(e){if(!e)throw new Error("Position id is required");return await O(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),K=K.filter(t=>t.id!==Number(e)),Ye(),re()}const at="__ART_RATIO_TECH_SUB_TAB__",fn=["technicians-management","technicians-positions"];let x=null,jt=!1,Ve=!1,Be="",st=!1,J=null,fe="technicians-management";const Ht=bi();Ht&&(fe=Ht);async function gn({showToastOnError:e=!0}={}){if(!Ve){Ve=!0,Be="",H();try{await li(),st=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),Be=Ge(t)?t.message:f("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&N(Be,"error")}finally{Ve=!1,H()}}}function hn(){return on()}function je(e=""){return I(String(e)).trim().toLowerCase()}function Vt(e){return e==null?"":String(e)}function ve(e=""){return I(String(e)).replace(/[^0-9+]/g,"")}function U(e=""){const t=I(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...i]=t.split(".");return`${n}.${i.join("")}`}function Pe(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const i=e.selectionEnd;e.value=n,i!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function bi(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(at);return e&&fn.includes(e)?e:null}catch(e){return console.warn("⚠️ [technicians] Failed to read stored sub-tab",e),null}}function _i(e){try{if(typeof window>"u"||!window.localStorage)return;if(!fn.includes(e)){window.localStorage.removeItem(at);return}window.localStorage.setItem(at,e)}catch(t){console.warn("⚠️ [technicians] Failed to store sub-tab",t)}}function yn(e,t=0,n=null){const i=String(e??"").trim(),s=i?mn(i):null;return s?{matchedPosition:s,dailyWage:Number.isFinite(s.cost)?s.cost:0,dailyTotal:s.clientPrice==null?null:Number.isFinite(s.clientPrice)?s.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function bn(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function ot(e,t=ce()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Ii(e,t=ce()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function _n(){const{container:e,body:t}=bn();!e||!t||(t.textContent="",e.hidden=!0)}function ht(e,t={}){const{container:n,body:i}=bn();if(!n||!i)return;const s=String(e??"").trim();if(!s){_n();return}const a=yn(s,t?.dailyWage??0,t?.dailyTotal??null),c=Oe(a.dailyWage||0),o=a.dailyTotal!=null?Oe(a.dailyTotal):f("technicians.positionSummary.noClientPrice","—");a.matchedPosition?i.textContent=f("technicians.positionSummary.match","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",c).replace("{price}",o):i.textContent=f("technicians.positionSummary.custom","لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}").replace("{cost}",c).replace("{price}",o),n.hidden=!1}function we(){const e=document.getElementById("technician-position-options");if(!e)return;const t=re(),n=ce(),i=new Set,s=[];t.forEach(a=>{const c=ot(a,n).trim();c&&!i.has(c.toLowerCase())&&(s.push(`<option value="${pe(c)}"></option>`),i.add(c.toLowerCase()));const o=Ii(a,n).trim();o&&!i.has(o.toLowerCase())&&(s.push(`<option value="${pe(o)}"></option>`),i.add(o.toLowerCase()));const r=a.name?.trim();r&&!i.has(r.toLowerCase())&&(s.push(`<option value="${pe(r)}"></option>`),i.add(r.toLowerCase()))}),e.innerHTML=s.join("")}function Ut(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),s=t.map(o=>o?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(o=>{if(!o)return;const l=o.getAttribute("data-tech-tab")===s;o.classList.toggle("tab-active",l),o.classList.toggle("active",l),o.setAttribute("aria-selected",l?"true":"false"),o.setAttribute("tabindex",l?"0":"-1")}),n.forEach(o=>{if(!o)return;const l=o.getAttribute("data-tech-tab-panel")===s;o.hidden=!l,o.classList.toggle("active",l)}),fe=s,_i(s);const c=t.find(o=>o?.getAttribute("data-tech-tab")===s)?.closest("[data-tab-scroll]");c&&c.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),s==="technicians-positions"&&(se(),Re().then(()=>{se()}).catch(o=>{console.error("❌ [technicians] failed to load positions for tab switch",o),N(o?.message||f("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}))}function yt(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",i=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=f(n,i)}function bt(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=f("technicians.form.actions.cancel","إلغاء التعديل"))}function _t(){yt(x?"update":"add"),bt(!!x),H()}function Ai(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,i=Array.from(new Set(e.map(a=>(a?.role||"").trim()).filter(Boolean))).sort((a,c)=>a.localeCompare(c,"ar",{sensitivity:"base"})),s=f("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${s}</option>`+i.map(a=>`<option value="${a}">${a}</option>`).join(""),n&&i.includes(n)?t.value=n:t.value="",t.value}function Je(){const e=document.getElementById("technician-form");e&&(e.reset(),x=null,yt("add"),bt(!1),_n())}function Pi(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),i=document.getElementById("technician-role"),s=document.getElementById("technician-department"),a=document.getElementById("technician-notes");!t||!n||!i||(t.value=e.name||"",n.value=ve(e.phone||""),i.value=e.role||"",s&&(s.value=e.department||""),a&&(a.value=e.notes||""),x=String(e.id),yt("update"),bt(!0),ht(i.value,e))}function Ni(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-notes");if(!e||!t||!n)return null;const a=e.value.trim(),c=ve(t.value.trim());t.value=c;const o=n.value.trim(),r=i?.value.trim()||"",l="available",d=s?.value.trim()||"",u=x?An(x):null,{dailyWage:p,dailyTotal:y}=yn(o,u?.dailyWage??0,u?.dailyTotal??null);return a?c?o?!Number.isFinite(p)||p<0?(N(f("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),null):y!=null&&(!Number.isFinite(y)||y<0)?(N(f("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),null):(ht(o,{dailyWage:p,dailyTotal:y}),{name:a,phone:c,role:o,department:r,dailyWage:Number.isFinite(p)?p:0,dailyTotal:y==null?null:Number(y),status:l,baseStatus:l,notes:d}):(N(f("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(N(f("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(N(f("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function vi(e){e.preventDefault();try{await Re()}catch(i){console.error("❌ [technicians] failed to load positions before submit",i);const s=i?.message||f("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");N(s,"error");return}const t=Ni();if(!t)return;const n=rn({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{x?(await cn(x,n),N(f("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await ui(n),N(f("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),Je(),H()}catch(i){console.error("❌ [technicians] handleTechnicianSubmit failed",i);const s=Ge(i)?i.message:f("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");N(s,"error")}}function Si(){Je()}function ki(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=ve(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const i=U(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==i&&(t.wage.value=i);const s=U(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==s&&(t.total.value=s);const a=e.baseStatus||e.status||"available";t.status.value!==a&&(t.status.value=a),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),Pe(t.phone,ve),Pe(t.wage,U),Pe(t.total,U)}function Ci(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),i=document.getElementById("edit-technician-role"),s=document.getElementById("edit-technician-department"),a=document.getElementById("edit-technician-wage"),c=document.getElementById("edit-technician-total"),o=document.getElementById("edit-technician-status"),r=document.getElementById("edit-technician-notes");if(!e||!t||!n||!i||!a||!c||!o)return null;const l=e.value.trim(),d=t.value.trim(),u=ve(n.value.trim());n.value=u;const p=i.value.trim(),y=s?.value.trim()||"",h=U(a.value.trim());a.value=h;const b=h===""?0:parseFloat(h),g=U(c.value.trim());c.value=g;const _=g===""?null:parseFloat(g),A=o.value||"available",S=r?.value.trim()||"";return l?d?u?p?Number.isNaN(b)||b<0?(N(f("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),a.focus(),null):_!=null&&(Number.isNaN(_)||_<0)?(N(f("technicians.toast.invalidTotal","⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية")),c.focus(),null):{id:l,name:d,phone:u,role:p,department:y,dailyWage:Number.isFinite(b)?b:0,dailyTotal:_==null?null:Number(_),status:A,baseStatus:A,notes:S}:(N(f("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),i.focus(),null):(N(f("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(N(f("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(N(f("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function Ti(){const e=Ci();if(!e)return;const t=rn({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await cn(e.id,t),N(f("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),H()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const i=Ge(n)?n.message:f("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");N(i,"error")}}function H(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=je(t?.value||"");if(Ve&&!st){const l=f("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}if(Be&&!st){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${Be}</td></tr>`;return}const i=Nn(),{reservations:s=[]}=V(),a=new Date;Ai(i);const c=document.getElementById("technician-role-filter"),o=je(c?.value||""),r=i.filter(l=>o&&je(l.role||"")!==o?!1:n?je([l.name,l.phone,l.role,l.department,l.notes].filter(Boolean).join(" ")).includes(n):!0);if(r.length===0){const l=f("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='6'>${l}</td></tr>`;return}e.innerHTML=r.map(l=>{const d=x&&String(x)===String(l.id),y=(Pn(l.id,s,a)?"busy":l.status||l.baseStatus||"available")==="busy"?{label:f("technicians.status.busy","⛔ مشغول"),className:"technician-status-badge technician-status-badge--busy"}:{label:f("technicians.status.available","✅ متاح"),className:"technician-status-badge technician-status-badge--available"},h=f("technicians.actions.edit","✏️ تعديل"),b=f("technicians.actions.delete","🗑️ حذف"),g=sn(),_=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${l.id}">${h}</button>`];return g&&_.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${l.id}">${b}</button>`),`
      <tr${d?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${l.id}" class="text-decoration-none">${l.name}</a></td>
        <td>${l.role||""}</td>
        <td>${l.department||"—"}</td>
        <td><span class="${y.className}"><span class="technician-status-badge__text">${y.label}</span></span></td>
        <td class="table-notes-cell">${l.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${_.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Ze(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function In(e="add"){const{submitBtn:t,cancelBtn:n}=Ze(),i=e==="update";if(t){const s=i?"positions.form.actions.update":"positions.form.actions.submit",a=i?"💾 حفظ المنصب":"➕ إضافة منصب";t.textContent=f(s,a)}n&&(n.classList.toggle("d-none",!i),n.textContent=f("positions.form.actions.cancel","إلغاء"))}function It(){const{form:e,idInput:t,nameArInput:n,nameEnInput:i,costInput:s,clientPriceInput:a}=Ze();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),i&&(i.value=""),s&&(s.value=""),a&&(a.value=""),J=null,In("add")}function Ei(e){const{idInput:t,nameArInput:n,nameEnInput:i,costInput:s,clientPriceInput:a}=Ze();!e||!s||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),i&&(i.value=e.labelEn||""),s.value=U(e.cost??0),a&&(a.value=e.clientPrice==null?"":U(e.clientPrice)),J=e.id||null,In("update"))}function qi(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:i}=Ze();if(!n)return null;const s=e?.value.trim()||"",a=t?.value.trim()||"",c=a||s,o=J?re().find(p=>String(p.id)===String(J)):null,r=U(n.value.trim());n.value=r;const l=r===""?0:parseFloat(r),d=i?U(i.value.trim()):"";i&&(i.value=d);const u=d===""?null:parseFloat(d);return c?!Number.isFinite(l)||l<0?(N(f("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),n.focus(),null):u!=null&&(!Number.isFinite(u)||u<0)?(N(f("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),i?.focus(),null):{id:J,name:o?.name||c,cost:Number(l.toFixed(2)),clientPrice:u==null?null:Number(u.toFixed(2)),labelAr:s||null,labelEn:a||null}:(N(f("positions.toast.invalidName","⚠️ يرجى إدخال اسم المنصب")),e&&e.focus(),null)}function Se(){const e=document.getElementById("technician-role");if(!e)return;const t=x?An(x):null;ht(e.value,t||{})}function se(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=re();if(t&&(t.textContent=I(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${f("positions.table.empty","لا توجد مناصب بعد.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(i=>{const s=J&&String(J)===String(i.id),a=Oe(i.cost||0),c=i.clientPrice==null?f("technicians.positionSummary.noClientPrice","—"):Oe(i.clientPrice),o=ot(i,"ar")||"—",r=ot(i,"en")||"—",l=f("positions.table.actions.edit","✏️ تعديل"),d=f("positions.table.actions.delete","🗑️ حذف");return`
      <tr${s?' class="technician-table-row-editing"':""}>
        <td>${pe(o)}</td>
        <td>${pe(r)}</td>
        <td>${pe(a)}</td>
        <td>${pe(c)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${i.id}">${l}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${i.id}">${d}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function Fi(e){e.preventDefault();const t=qi();if(t)try{const n=!!J;n?await hi(t.id,t):await gi(t);const i=n?f("positions.toast.updateSuccess","💾 تم حفظ بيانات المنصب"):f("positions.toast.addSuccess","✅ تم إضافة المنصب");N(i),It(),se(),we(),Se()}catch(n){console.error("❌ [technicians] handlePositionSubmit failed",n);const i=n?.message||f("positions.toast.saveFailed","⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى");N(i,"error")}}function Li(){It()}async function Bi(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Re();const i=re().find(s=>String(s.id)===String(n));if(!i){N(f("positions.toast.notFound","⚠️ تعذر العثور على بيانات المنصب"),"error");return}Ei(i),se();return}if(t.classList.contains("position-delete-btn")){if(!confirm(f("positions.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا المنصب؟")))return;await yi(n),J&&String(J)===String(n)&&It(),N(f("positions.toast.deleteSuccess","🗑️ تم حذف المنصب")),se(),we(),Se()}}catch(t){console.error("❌ [technicians] handlePositionsTableClick failed",t);const n=t?.message||f("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");N(n,"error")}}function $i(e){const t=hn().find(n=>String(n.id)===String(e));if(!t){N(f("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}Pi(t),N(f("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function Di(e){if(!sn()){ci();return}if(confirm(f("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await di(e),N(f("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),x&&String(x)===String(e)&&Je(),H()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=Ge(t)?t.message:f("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");N(n,"error")}}function Va(){At(),H()}function An(e){return hn().find(t=>String(t.id)===String(e))||null}function Pn(e,t=[],n){const i=Vt(e);return i?t.some(s=>{if(!s||!s.start||!s.end||!(Array.isArray(s.technicians)?s.technicians:[]).some(r=>Vt(r)===i))return!1;const c=new Date(s.start),o=new Date(s.end);return Number.isNaN(c.getTime())||Number.isNaN(o.getTime())?!1:c<=n&&n<o}):!1}function Nn(){const e=V().reservations||[],t=on();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let i=!1;const s=t.map(a=>{if(!a)return a;const c=a.baseStatus||a.status||"available";let o=c==="busy"?"busy":c;return Pn(a.id,e,n)&&(o="busy"),(o!==a.status||c!==a.baseStatus)&&(i=!0),{...a,baseStatus:c,status:o}});return i?(ze(s),s):t}function At(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{vi(p).catch(y=>{console.error("❌ [technicians] submit handler failed",y)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Si),n.dataset.listenerAttached="true"),Pe(document.getElementById("technician-phone"),ve);const i=document.getElementById("technician-role");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{Se()}),i.dataset.listenerAttached="true");const s=document.getElementById("technicians-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",p=>{const y=p.target;if(y instanceof HTMLElement){if(y.classList.contains("technician-edit-btn")){const h=y.dataset.id;$i(h)}if(y.classList.contains("technician-delete-btn")){const h=y.dataset.id;Di(h).catch(b=>{console.error("❌ [technicians] delete handler failed",b)})}}}),s.dataset.listenerAttached="true");const a=document.getElementById("search-technician-input");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{a.value=I(a.value),H()}),a.dataset.listenerAttached="true");const c=document.getElementById("technician-role-filter");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{H()}),c.dataset.listenerAttached="true");const o=document.getElementById("save-technician-changes");o&&!o.dataset.listenerAttached&&(o.addEventListener("click",()=>{Ti().catch(p=>{console.error("❌ [technicians] modal save failed",p)})}),o.dataset.listenerAttached="true");const r=document.getElementById("position-form");r&&!r.dataset.listenerAttached&&(r.addEventListener("submit",p=>{Fi(p).catch(y=>{console.error("❌ [technicians] position submit failed",y)})}),r.dataset.listenerAttached="true");const l=document.getElementById("position-cancel-btn");l&&!l.dataset.listenerAttached&&(l.addEventListener("click",Li),l.dataset.listenerAttached="true");const d=document.getElementById("positions-table");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",Bi),d.dataset.listenerAttached="true"),Pe(document.getElementById("position-cost"),U),Pe(document.getElementById("position-client-price"),U);const u=document.querySelector("[data-tech-tabs]");u&&!u.dataset.listenerAttached&&(u.querySelectorAll("[data-tech-tab]").forEach(y=>{y&&y.addEventListener("click",()=>{const h=y.getAttribute("data-tech-tab");Ut(h)})}),u.dataset.listenerAttached="true"),Ut(fe),Re().then(()=>{we(),fe==="technicians-positions"&&se(),Se()}).catch(p=>{console.error("❌ [technicians] failed to load technician positions",p),N(p?.message||f("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}),jt||(document.addEventListener("technician:prefill",p=>{const y=p.detail;y&&ki(y)}),jt=!0),t&&Je(),fe==="technicians-positions"&&se()}window.addEventListener("DOMContentLoaded",()=>{At(),H(),_t(),gn()});const vn=()=>{H()};window.addEventListener("technicians:updated",vn);document.addEventListener("technicians:updated",vn);document.addEventListener("technicians:refreshRequested",()=>{At(),H(),_t(),gn({showToastOnError:!1})});document.addEventListener("language:changed",()=>{_t(),we(),fe==="technicians-positions"&&se(),Se()});document.addEventListener(oi.USER_UPDATED,()=>{H()});const Sn=()=>{we(),fe==="technicians-positions"&&se(),Se()};window.addEventListener("technicianPositions:updated",Sn);document.addEventListener("technicianPositions:updated",Sn);function Fe(e){return I(String(e||"")).trim().toLowerCase()}function G(e){const t=String(e??"").trim().toLowerCase();return t||""}function kn(){const{packages:e=[]}=V();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function Qe(e){const t=G(e);return t&&kn().find(i=>G(i?.id??i?.packageId??i?.package_id)===t)||null}function ge(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(o=>({barcode:o}))),n.forEach(o=>{if(!o)return;if(typeof o=="string"||typeof o=="number"){const p=Fe(o);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof o!="object")return;const r=Fe(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number),l=[o.equipmentId,o.equipment_id,o.itemId,o.item_id,o.id].find(p=>p!=null&&p!==""),d=[o.unit_price,o.unitPrice,o.price,o.daily_rate].find(p=>Number.isFinite(Number(p))),u=[o.quantity,o.qty,o.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:l!=null?String(l):null,barcode:o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??"",normalizedBarcode:r,qty:u!=null?Number(u):1,price:d!=null?Number(d):0,desc:o.description??o.desc??o.name??"",image:o.image??o.imageUrl??o.img??null})});const i=new Map,{equipment:s=[]}=V()||{},a=new Map,c=new Map;return(Array.isArray(s)?s:[]).forEach(o=>{if(!o||typeof o!="object")return;[o.id,o.equipment_id,o.equipmentId,o.item_id,o.itemId].map(d=>d!=null?String(d):"").filter(Boolean).forEach(d=>{a.has(d)||a.set(d,o)});const l=Fe(o.barcode);l&&!c.has(l)&&c.set(l,o)}),t.forEach(o=>{if(o.equipmentId&&a.has(o.equipmentId)){const r=a.get(o.equipmentId);if(r){if(o.desc||(o.desc=r.desc||r.description||r.name||""),o.barcode||(o.barcode=r.barcode||""),o.price==null||o.price===0){const l=r.price??r.unit_price,d=Number(l);Number.isFinite(d)&&d>=0&&d<1e6&&(o.price=d)}o.image||(o.image=r.image||r.imageUrl||r.img||null)}}else if(o.normalizedBarcode&&c.has(o.normalizedBarcode)){const r=c.get(o.normalizedBarcode);if(r){if(o.desc||(o.desc=r.desc||r.description||r.name||""),o.barcode||(o.barcode=r.barcode||""),o.price==null||o.price===0){const l=r.price??r.unit_price,d=Number(l);Number.isFinite(d)&&d>=0&&d<1e6&&(o.price=d)}o.image||(o.image=r.image||r.imageUrl||r.img||null)}}}),t.forEach(o=>{const r=o.normalizedBarcode||(o.barcode?Fe(o.barcode):""),l=r||(o.equipmentId?`id:${o.equipmentId}`:null);if(!l)return;if(!i.has(l)){i.set(l,{...o,normalizedBarcode:r});return}const d=i.get(l);d.qty+=o.qty,!d.price&&o.price&&(d.price=o.price),!d.desc&&o.desc&&(d.desc=o.desc),!d.image&&o.image&&(d.image=o.image)}),Array.from(i.values())}function zi(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const i of t){const s=Number(i);if(Number.isFinite(s))return s}return ge(e).reduce((i,s)=>i+(s.price||0)*(s.qty||1),0)}function Ri(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function wi(){return kn().map(t=>{const n=G(t?.id??t?.packageId??t?.package_id??t?.code),i=Ri(t)||n||"package",s=zi(t);return{id:n,name:i,price:s,code:t?.package_code??t?.code??n,items:ge(t),raw:t}}).filter(t=>t.id)}function xi(e){const t=Fe(e);return t?wi().filter(n=>n.items.some(i=>i.normalizedBarcode===t)):[]}function Mi(e){return ge(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let ke=[],Cn=[],Tn=[],En="single";function Ua(){return ke}function Oa(e){ke=Array.isArray(e)?e:[]}function Qa(e){ke=[...ke,e]}function Wa(e){Number.isInteger(e)&&e>=0&&(ke=ke.filter((t,n)=>n!==e))}function Ka(){return Cn}function Ga(e){Cn=Array.isArray(e)?e:[]}function Ya(){return Tn}function Ja(e){Tn=Array.isArray(e)?e:[]}function Za(e){}function Xa(){return En==="package"?"package":"single"}function es(e){En=e==="package"?"package":"single"}function ts(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[i="",s=""]=n.split("T"),a=i?i.slice(0,10):"",c=s.match(/(\d{1,2}:\d{2})/);let o="";if(c){const[r="00",l="00"]=c[0].split(":");o=`${r.padStart(2,"0")}:${l.padStart(2,"0")}`}return{date:a,time:o}}function He(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function W(e){return I(String(e||"")).trim().toLowerCase()}const ji=864e13;function te(e){if(!e&&e!==0)return null;if(e instanceof Date){const i=e.getTime();return Number.isNaN(i)?null:new Date(i)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const i=new Date(e);return Number.isNaN(i.getTime())?null:i}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const s=new Date(i);if(!Number.isNaN(s.getTime()))return s}}if(!t.includes("T")&&t.includes(" ")){const i=t.indexOf(" ");t=`${t.slice(0,i)}T${t.slice(i+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const i=new Date(`${t}Z`);if(!Number.isNaN(i.getTime()))return i}return null}function ns(e,t,n,i=null){if(!e||!t||!n)return!1;const s=te(t),a=te(n);if(!s||!a||s>=a)return!1;const c=W(e);if(!c)return!1;const o=V()||{},r=Array.isArray(o.reservations)?o.reservations:[],l=Array.isArray(o.maintenance)?o.maintenance:[],d=Array.isArray(o.equipment)?o.equipment:[],u=Ji(d),p=Nt(i);return r.some(h=>{if(!h||vt(h,p)||!h.start||!h.end)return!1;const b=te(h.start),g=te(h.end);return!b||!g||!(b<a&&g>s)?!1:Vi(h,c)})?!0:l.some(h=>{if(!Qi(h)||!Ki(h,u).has(c))return!1;const{start:g,end:_}=Gi(h);if(!g&&!_)return!0;const A=g??new Date(0),S=_??new Date(ji);return A<a&&S>s})}function Hi(e,t,n,i=null){const s=G(e);if(!s||!t||!n)return!1;const a=te(t),c=te(n);if(!a||!c||a>=c)return!1;const o=V()||{},r=Array.isArray(o.reservations)?o.reservations:[],l=Nt(i);return r.some(d=>{if(!d?.start||!d?.end||vt(d,l))return!1;const u=te(d.start),p=te(d.end);return!u||!p||!(u<c&&p>a)?!1:Ui(d,s)})}function is(e,t,n,i=null){const s=W(e);if(!s||!t||!n)return[];const a=xi(s);return a.length?a.filter(c=>Hi(c.id,t,n,i)):[]}function qn(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(i=>{const s=e[i];Array.isArray(s)&&s.length&&t.push(s)}),t}function Vi(e,t){if(!t||!e||typeof e!="object")return!1;const n=W(e?.barcode);if(n&&n===t)return!0;const i=qn(e);for(const s of i)for(const a of s)if(Oi(a).has(t))return!0;return!1}function Ui(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const a of n){if(!a&&a!==0)continue;const c=G(a);if(c&&c===t)return!0}const i=e.packages;if(Array.isArray(i))for(const a of i){const c=G(a);if(c&&c===t)return!0}const s=qn(e);for(const a of s)for(const c of a)if(Pt(c).has(t))return!0;return!1}function Oi(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const a=W(e);return a&&t.add(a),t}if(typeof e!="object")return t;const n=W(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(a=>{const c=e[a];Array.isArray(c)&&c.forEach(o=>{if(o!=null){if(typeof o=="string"||typeof o=="number"){const r=W(o);r&&t.add(r);return}if(typeof o=="object"){const r=W(o.barcode??o.equipmentBarcode??o.code??o.serial??o.serialNumber??o.serial_number);r&&t.add(r)}}})});const s=Pt(e);return s.size&&s.forEach(a=>{const c=Qe(a);if(!c)return;Mi(c).forEach(r=>{const l=r.normalizedBarcode??W(r.barcode);l&&t.add(l)})}),t}function Pt(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(i=>{const s=G(i);s&&t.add(s)}),e.package&&typeof e.package=="object"&&Pt(e.package).forEach(s=>t.add(s)),Array.isArray(e.packages)&&e.packages.forEach(i=>{const s=G(i);s&&t.add(s)}),t}function Qi(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(Yi(e))return!1;for(const n of t){const i=Wi(n);if(i){if(i==="completed"||i==="cancelled"||i==="closed")return!1;if(i==="open"||i==="in_progress")return!0}}return!0}function Wi(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="مكتمل"||t==="مغلق"?"completed":t==="cancelled"||t==="canceled"||t==="ملغي"?"cancelled":t==="in_progress"||t==="in-progress"||t==="قيد_التنفيذ"||t==="جاري_العمل"||t==="inprogress"?"in_progress":t==="open"||t==="قيد_الصيانة"||t==="قيد_الانتظار"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("تنفيذ")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function Ki(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(c=>{const o=W(c);o&&n.add(o)});const s=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(s){const c=W(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);c&&n.add(c)}return[e?.equipmentId,e?.equipment_id,s?.id,s?.equipmentId,s?.equipment_id].map(c=>c!=null?String(c):"").filter(Boolean).forEach(c=>{const o=t.get(c);if(!o)return;const r=W(o?.barcode??o?.equipmentBarcode??o?.code??o?.serial??o?.serialNumber??o?.serial_number);r&&n.add(r)}),n}function Gi(e){const t=ct([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=ct([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function Yi(e){return!!ct([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function ct(e=[]){for(const t of e){const n=te(t);if(n)return n}return null}function Ji(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{t.has(s)||t.set(s,n)})}),t}function Zi(e,t,n,i=null){if(!e||!t||!n)return!1;const s=new Date(t),a=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(a.getTime()))return!1;const{reservations:c=[]}=V(),o=String(e),r=Nt(i);return c.some(l=>{if(!l?.start||!l?.end||vt(l,r))return!1;const d=new Date(l.start),u=new Date(l.end);return Number.isNaN(d.getTime())||Number.isNaN(u.getTime())||!(d<a&&u>s)?!1:(Array.isArray(l.technicians)?l.technicians:[]).some(h=>String(h)===o)})}function Nt(e){return Ie(e,new Set)}function vt(e,t){if(!t||t.size===0)return!1;const n=Ie([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const i of n)if(t.has(i))return!0;return!1}function Ie(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(a=>Ie(a,t)),t;if(Array.isArray(e))return e.forEach(a=>Ie(a,t)),t;if(typeof e=="object"){const a=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return a.forEach(o=>{Object.prototype.hasOwnProperty.call(e,o)&&(c=!0,Ie(e[o],t))}),c||Object.values(e).forEach(o=>Ie(o,t)),t}const n=I(String(e??"")).trim();if(!n)return t;const i=[n,n.toLowerCase(),n.toUpperCase()],s=n.replace(/\D+/g,"");if(s){i.push(s);const a=Number.parseInt(s,10);Number.isNaN(a)||i.push(String(a))}return i.forEach(a=>{a&&t.add(a)}),t}const Xi=()=>f("reservations.create.summary.currency","SR");let $e=[],Xe=[],ne=[],ie=[],w="create",Fn=()=>{},Ln=()=>{};function De(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function he(e={}){return{...e,assignmentId:e.assignmentId||De()}}function et(e){if(!e)return null;const t=String(e),n=$e.find(s=>String(s?.id)===t);if(n)return{...n};const{technicians:i=[]}=V();return i.find(s=>String(s?.id)===t)||null}function St(e={},t=ce()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function kt(e={},t=ce()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function Bn(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=Xe.find(a=>String(a.id).trim().toLowerCase()===n);if(i)return i;const s=mn(e);return s||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function Ot(e){const t=Bn(e,e?.name??""),n=ce(),i=St(t,n)||t?.name||"",s=kt(t,n);return rt({assignmentId:De(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:s,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function rt(e={}){const t={assignmentId:e.assignmentId||De(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=Bn(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=ce(),s=St(n,i)||t.positionLabel,a=kt(n,i);t.positionLabel=s||t.positionLabel||n?.name||"",t.positionLabelAlt=a||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=et(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function Ct(){Xe=re()}function ea(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return he(rt(t));const n=et(t),i=n?{assignmentId:De(),positionLabel:n.role||f("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:De(),positionLabel:f("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return he(rt(i))}).filter(Boolean):[]}function be(e="create"){return e==="edit"?ie.map(he):ne.map(he)}function oe(e="create",t=[]){const n=ea(t);e==="edit"?(ie=n,Ce("edit-selected-technicians-list",ie,"edit"),Ln()):(ne=n,Ce("selected-technicians-list",ne,"create"),Fn()),tt()}function ta(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),r=document.getElementById("edit-res-end")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",u=o?He(o,l):null,p=r?He(r,d):null;let y=null;const h=document.getElementById("edit-res-index")?.value;if(h!=null){const b=Number.parseInt(h,10);if(Number.isInteger(b)){const{reservations:g=[]}=V(),_=g?.[b];_&&(y=_.id??_.reservationId??null)}}return{start:u,end:p,ignoreReservationId:y}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",s=document.getElementById("res-end-time")?.value?.trim()||"00:00",a=t?He(t,i):null,c=n?He(n,s):null;return{start:a,end:c,ignoreReservationId:null}}function tt(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=be(w).length;if(t){const n=f("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",I(String(t)));e.textContent=n}else e.textContent=f("technicians.picker.selectionInfo","No crew selected yet")}function We(e){const t=Number.isFinite(e)?e:0;return`${I(t.toFixed(2))} ${Xi()}`}function na(e){const t=be(w),n=new Set(t.filter(a=>a.assignmentId!==e&&a.technicianId).map(a=>a.technicianId));return($e.length?$e:V().technicians||[]).map(a=>{const c=String(a.id),o=n.has(c),r=[a.name||c];a.role&&r.push(`(${a.role})`);const l=I(r.join(" "));return{id:c,label:l,disabled:o}})}function ae(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=be(w);if(!t.length){const n=f("technicians.picker.noAssignments","لم يتم إضافة أي مناصب بعد"),i=f("technicians.picker.assignments.hint","استخدم قائمة المناصب على اليسار لإضافة طاقم العمل.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">🧑‍🤝‍🧑</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}e.innerHTML=t.map((n,i)=>{const s=I(String(i+1)),a=We(n.positionClientPrice||0),c=na(n.assignmentId),o=f("technicians.picker.noTechnicianOption","— بدون تعيين —"),r=n.technicianId!=null?String(n.technicianId):"",l=f("technicians.picker.optionAssigned","(مستخدم)"),d=[`<option value=""${r===""?" selected":""}>${o}</option>`,...c.map(h=>{const b=r===h.id,g=h.disabled&&!b,_=g&&!b?`${h.label} ${l}`:h.label,A=g?' disabled data-disabled="true"':"",S=b?" selected":"";return`<option value="${h.id}"${A}${S}>${_}</option>`})].join(""),u=n.positionLabelAlt?`<div class="text-muted small">${I(n.positionLabelAlt)}</div>`:"",p=f("technicians.picker.actions.remove","إزالة"),y=f("technicians.picker.assignments.price","سعر العميل");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${s}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${I(n.positionLabel||f("reservations.crew.positionFallback","منصب بدون اسم"))}</div>
            ${u}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${y}">${a}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <select
            class="form-select crew-assignment-select"
            data-assignment-id="${n.assignmentId}"
            aria-label="${f("technicians.picker.assignments.member","عضو الطاقم")}"
          >
            ${d}
          </select>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${p}">
            ${p}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{$n(n.dataset.assignmentId,w)}),n.dataset.listenerAttached="true")}),ia(e)}function ia(e){e.querySelectorAll(".crew-assignment-select").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("change",i=>{const{assignmentId:s}=n.dataset;sa(s,i.target.value)}),n.dataset.listenerAttached="true")})}function lt(){const e=document.getElementById("crew-position-list");if(!e)return;Ct();const t=document.getElementById("crew-position-search"),n=I(String(t?.value||"")).trim().toLowerCase(),i=Xe.filter(a=>n?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(o=>I(String(o)).toLowerCase()).join(" ").includes(n):!0);if(!i.length){e.innerHTML=`<div class="text-muted">${f("technicians.picker.noPositions","لا توجد مناصب مطابقة.")}</div>`;return}const s=ce();e.innerHTML=i.map(a=>{const c=St(a,s)||a.name||"",o=kt(a,s),r=We(a.clientPrice||0),l=We(a.cost||0),d=o?`<span class="crew-position-card__subtitle">${I(o)}</span>`:"",u=f("technicians.picker.positionCostLabel","التكلفة"),p=f("technicians.picker.positionClientPriceLabel","سعر العميل"),y=f("technicians.picker.actions.addPosition","إضافة المنصب");return`
      <article class="crew-position-card" data-position-id="${a.id}">
        <div class="crew-position-card__layout">
          <header class="crew-position-card__header">
            <div class="crew-position-card__icon" aria-hidden="true">🎯</div>
            <div class="crew-position-card__titles">
              <h6 class="crew-position-card__title">${I(c)}</h6>
              ${d}
            </div>
          </header>
          <div class="crew-position-card__meta-grid">
            <div class="crew-position-card__meta-item">
              <span class="crew-position-card__meta-label">${u}</span>
              <span class="crew-position-card__meta-value">${l}</span>
            </div>
            <div class="crew-position-card__meta-item">
              <span class="crew-position-card__meta-label">${p}</span>
              <span class="crew-position-card__meta-value">${r}</span>
            </div>
          </div>
        </div>
        <div class="crew-position-card__actions">
          <button type="button" class="btn btn-sm btn-primary crew-position-add-btn" data-position-id="${a.id}">
            ${y}
          </button>
        </div>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",()=>{aa(a.dataset.positionId)}),a.dataset.listenerAttached="true")})}function aa(e){Ct();const t=Xe.find(s=>String(s.id)===String(e)),n=Ot(t||{id:null,name:""}),i=be(w);i.push(n),oe(w,i),ae(),N(f("technicians.picker.toast.positionAdded","✅ تم إضافة المنصب إلى القائمة"),"success")}function $n(e,t="create"){if(!e)return;const n=be(t).filter(i=>i.assignmentId!==e);oe(t,n),ae(),N(f("technicians.picker.toast.positionRemoved","🗑️ تم حذف المنصب من القائمة"))}function sa(e,t){if(!e)return;const n=be(w),i=n.find(c=>c.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,oe(w,n),ae(),N(f("technicians.picker.toast.assignmentCleared","ℹ️ تمت إزالة التعيين من هذا المنصب"));return}if(n.find(c=>c.assignmentId!==e&&c.technicianId===t)){N(f("technicians.picker.duplicateTechnician","⚠️ لا يمكن تعيين نفس الشخص لأكثر من منصب في نفس الحجز")),ae();return}const a=et(t);a?(i.technicianId=String(a.id),i.technicianName=a.name??null,i.technicianRole=a.role??null,i.technicianPhone=a.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),oe(w,n),ae(),i.technicianName?N(f("technicians.picker.toast.assignmentApplied","✅ تم تعيين {name} على هذا المنصب").replace("{name}",I(i.technicianName)),"success"):N(f("technicians.picker.toast.assignmentIdApplied","✅ تم تعيين العضو المحدد على هذا المنصب"),"success")}async function Qt(e="create"){w=e;const t=Nn();Array.isArray(t)&&t.length&&($e=t);try{await Re()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}Ct(),lt(),ae(),tt();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function oa(){return be(w).map(he)}function ca(){const e=oa(),{start:t,end:n,ignoreReservationId:i}=ta(w);if(t&&n){const a=e.filter(c=>c.technicianId&&Zi(c.technicianId,t,n,i));if(a.length>0){const c=a.map(r=>r.technicianName||r.technicianId).join(f("reservations.list.crew.separator","، ")),o=f("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",c);a.forEach(r=>{r.technicianId=null,r.technicianName=null}),oe(w,e),ae(),N(o),tt();return}}oe(w,e);const s=document.getElementById("selectTechniciansModal");s&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s)?.hide?.(),N(f("technicians.picker.toast.selectionApplied","✅ تم حفظ الطاقم بنجاح"),"success")}function Ce(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${f("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.")}</span>`;return}i.innerHTML=t.map(s=>{const a=I(s.positionLabel||f("reservations.crew.positionFallback","منصب بدون اسم")),c=s.technicianName?`${I(s.technicianName)}`:f("technicians.picker.noTechnicianOption","— بدون تعيين —"),o=We(Number(s.positionClientPrice)||0),r=f("reservations.crew.removeAria","إزالة");return`
      <span class="technician-chip" data-assignment-id="${s.assignmentId}">
        <span class="technician-chip-name">${a}</span>
        <small class="technician-chip-role">${c}</small>
        <small class="technician-chip-wage">💼 ${o}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${s.assignmentId}" aria-label="${r}">✖</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(s=>{s.dataset.listenerAttached||(s.addEventListener("click",()=>{$n(s.dataset.assignmentId,s.dataset.context)}),s.dataset.listenerAttached="true")})}}function ra(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Qt("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>Qt("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{lt()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",ca),i.dataset.listenerAttached="true");const s=document.getElementById("selectTechniciansModal");s&&!s.dataset.listenerAttached&&window.bootstrap?.Modal&&(s.addEventListener("shown.bs.modal",()=>{lt(),ae(),tt()}),s.addEventListener("hidden.bs.modal",()=>{const a=document.getElementById("crew-position-search");a&&(a.value="")}),s.dataset.listenerAttached="true"),Ce("selected-technicians-list",ne,"create"),Ce("edit-selected-technicians-list",ie,"edit")}function as({onDraftChange:e,onEditChange:t}={}){Fn=typeof e=="function"?e:()=>{},Ln=typeof t=="function"?t:()=>{},ra()}function la(){return ne.map(he)}function ua(){return ie.map(he)}function Wt(){return ne.map(e=>e.technicianId).filter(Boolean).map(String)}function Kt(){return ie.map(e=>e.technicianId).filter(Boolean).map(String)}function ss(e=[]){oe("edit",e)}function os(){oe("create",[])}function cs(){oe("edit",[])}function Gt(e=[]){return e.map(t=>{if(t.technicianId){const n=et(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function rs(e=[]){Array.isArray(e)&&e.length&&($e=e),ne=Gt(ne),ie=Gt(ie),Ce("selected-technicians-list",ne,"create"),Ce("edit-selected-technicians-list",ie,"edit"),ae()}function Yt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Dn(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=I(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),s=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const a=t.includes(","),c=t.includes(".");if(a&&c){const r=t.lastIndexOf(","),l=t.lastIndexOf(".");r>l?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(a){const r=t.split(",");r.length===2&&r[1].length===3?t=r.join(""):t=t.replace(/,/g,".")}else if(c){const r=t.split(".");if(r.length===2){const[,l]=r;if(l.length===3){const d=r.join("");/^[0-9]+$/.test(d)&&(t=d)}}else r.length>2&&(t=Yt(t))}if(t=t.replace(/,/g,""),t=Yt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const o=Number.parseFloat(t);return Number.isFinite(o)?s?-o:o:Number.NaN}function $(e){return Dn(e)}function z(e){const t=Dn(e);if(!Number.isFinite(t))return 0;let n=t,i=0;for(;Math.abs(n)>1e5&&i<8;)n/=10,i+=1;return Number(n.toFixed(2))}function Le(e){return I(String(e??"")).trim().toLowerCase()}function zn(e=""){return I(String(e)).trim().toLowerCase()}const da=2;function pa(e){const t=$(e);return Number.isFinite(t)?t.toFixed(da):"0.00"}function Jt(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(I(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return z(i)}return 1}function ma(e={}){const t=e?.desc||e?.description||e?.name||"",n=zn(t),i=pa(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function fa(e=[]){const t=new Map;return e.forEach((n,i)=>{const s=ma(n);if(!s)return;if(!t.has(s)){const c=n?.desc||n?.description||n?.name||"",o=zn(c),r=Xt(n),l=n?.image||n?.imageUrl||n?.img||"";t.set(s,{key:s,description:c,normalizedDescription:o,unitPrice:r,image:l,items:[],itemIndices:[],barcodes:[]})}const a=t.get(s);a.items.push(n),a.itemIndices.push(i),n?.barcode&&a.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,s)=>i+Jt(s),0)})).map(n=>{const i=n.quantity||0,s=n.items.reduce((l,d)=>{const u=Xt(d),p=Jt(d);return l+u*p},0),a=z(s),c=$(n.unitPrice),o=Number.isFinite(c)?c:0,r=i>0?z(a/i):z(o);return{...n,quantity:i,count:i,totalPrice:a,unitPrice:r}})}function Zt(e={}){return(ge(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??Le(n?.barcode),qty:(()=>{const i=Number.parseFloat(I(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),price:(()=>{const i=$(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})()}))}function ut(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(I(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function ga(e={},t=[],n=null){const i=e.unit_price??e.unitPrice??e.price,s=$(i);if(Number.isFinite(s)&&s>0)return z(s);const a=e.total_price??e.totalPrice??e.total,c=$(a),o=Number.parseFloat(I(String(n)).replace(/[^0-9.]/g,"")),r=Number.isFinite(o)&&o>0?o:ut(e);if(Number.isFinite(c)&&c>0&&r>0)return z(c/r);if(Array.isArray(t)&&t.length){const l=t.reduce((d,u)=>{const p=$(u.price??u.unit_price??u.unitPrice),y=Number.parseFloat(I(String(u.qty??u.quantity??1)).replace(/[^0-9.]/g,"")),h=Number.isFinite(y)&&y>0?y:1;return d+p*h},0);if(l>0&&r>0)return z(l/r)}return 0}function ls(e={}){const t=Array.isArray(e?.items)?e.items:[],n=fa(t),i=new Map,s=(u,p=0,y="packages")=>{if(!u||typeof u!="object")return;const b=G(u?.package_code??u?.packageId??u?.package_id??u?.code??u?.id??u?.barcode??`pkg-${p}`)||`pkg-${p}`;if(!i.has(b)){i.set(b,{source:u,normalizedId:b,index:p,itemSource:y==="items"?u:null});return}const g=i.get(b);if(g.source||(g.source=u),y==="items"&&(g.itemSource=u,g.source&&typeof g.source=="object")){const _=Array.isArray(g.source.packageItems)&&g.source.packageItems.length>0,A=Array.isArray(u.packageItems)&&u.packageItems.length>0;!_&&A&&(g.source={...g.source,packageItems:u.packageItems}),!g.source.image&&u.image&&(g.source={...g.source,image:u.image})}};Array.isArray(e?.packages)&&e.packages.forEach((u,p)=>s(u,p,"packages")),t.forEach((u,p)=>{u&&typeof u=="object"&&(u.type==="package"||Array.isArray(u?.packageItems))&&s(u,p+i.size,"items")});const a=[],c=new Set,o=new Set;i.forEach(({source:u,itemSource:p=null,normalizedId:y},h)=>{const b=u||{},g=p&&typeof p=="object"?p:null;let _=Zt(b);(!Array.isArray(_)||_.length===0)&&g&&(_=Zt(g)),_.forEach(k=>{const C=k?.normalizedBarcode??Le(k?.barcode);C&&c.add(C);const j=k?.equipmentId??k?.equipment_id??null;j!=null&&o.add(String(j))});let A=ut(b);if(g){const k=ut(g);Number.isFinite(k)&&k>0&&(A=k)}(!Number.isFinite(A)||A<=0)&&(A=1);let S=ga(b,_,A);const P=[g?.price,g?.unit_price,g?.unitPrice];for(const k of P){const C=$(k);if(Number.isFinite(C)&&C>0){S=z(C);break}}S=z(S);const T=[g?.total,g?.total_price,g?.totalPrice,b?.total,b?.total_price,b?.totalPrice];let v=NaN;for(const k of T){const C=$(k);if(Number.isFinite(C)&&C>=0){v=C;break}}Number.isFinite(v)||(v=S*A),v=z(v);const F=[b?.displayCode,b?.display_code,b?.package_code,b?.packageCode,b?.code,b?.barcode,b?.packageId,b?.package_id,g?.displayCode,g?.display_code,g?.package_code,g?.packageCode,g?.code,g?.barcode,g?.packageId,g?.package_id,y,h].find(k=>k==null?!1:String(k).trim().length>0),L=F!=null?I(String(F)).trim():"";if(L){const k=Le(L);k&&c.add(k)}const D=_.map(k=>I(String(k?.barcode??k?.normalizedBarcode??""))).filter(Boolean),M=[b?.name,b?.package_name,b?.title,g?.name,g?.desc,g?.package_name,L,I(String(h))].find(k=>k!=null&&String(k).trim()!=="")||I(String(L||h)),Q=_.find(k=>k?.image)?.image??b?.image??g?.image??null;a.push({key:`package::${h}`,description:M,normalizedDescription:I(String(M)),unitPrice:S,totalPrice:v,quantity:A,count:A,image:Q,barcodes:D,barcode:L,package_code:L,packageDisplayCode:L,items:[{type:"package",packageItems:_,packageId:y,desc:M,price:S,qty:A,barcode:L}],type:"package",packageItems:_,packageId:y})});const r=new Set(Array.from(c).map(u=>Le(u)).filter(Boolean)),l=n.filter(u=>!(u.items.some(h=>h?.type==="package")&&a.length>0||u.items.every(h=>{const b=ha(h),g=b!=null?String(b):null;if(g&&o.has(g))return!0;const _=h?.barcode?Le(h.barcode):null;return!!(_&&r.has(_))})));return{groups:a.length?[...a,...l]:n,packageGroups:a,groupedItems:n,filteredGroupedItems:l,packagesMap:i}}function ha(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function Xt(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=$(n);if(Number.isFinite(i))return i}return 0}function us(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function ya(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function ds(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,s=i!=null&&i!==""&&i!=="null",a=s?ya(t?.status??t?.status_label??t?.statusLabel??""):null,c=s&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(a));return{reservationConfirmed:n,projectLinked:s,projectStatus:a,projectConfirmed:c,effectiveConfirmed:s?c:n}}const Rn=10;function wn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=$(n);if(Number.isFinite(i))return z(i)}return 0}function ba(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=$(n);if(Number.isFinite(i))return z(i)}return wn(e)}function _a(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=V();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,s)=>{const a=n.get(String(s));if(!a)return i;const c=wn(a),o=ba(a);return{costPerDay:i.costPerDay+(Number.isFinite(c)?c:0),totalPerDay:i.totalPerDay+(Number.isFinite(o)?o:0)}},{costPerDay:0,totalPerDay:0})}const Ia=1440*60*1e3,Ae=.01;function _e(e){if(e==null||e==="")return null;const t=I(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function en(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let s=Number.isFinite(e)?e:0;if(s<t&&(s=t),s>n&&(s=n),i!=null){const a=10**i;s=Math.round(s*a)/a}return s}function xn(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function Tt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:s=null,history:a=[]}={}){const c=Number.isFinite(Number(e))?Number(e):0,o=t==="amount"?"amount":t==="percent"?"percent":null;let r=_e(i),l=_e(s);const d=_e(n);let u=0,p=0;Array.isArray(a)&&a.length&&a.forEach(A=>{if(!A)return;const S=A.type==="amount"||A.type==="percent"?A.type:null,P=_e(A.value),T=_e(A.amount),v=_e(A.percentage);if(S==="amount"){const q=T??P;q!=null&&(u+=q,c>0&&(p+=q/c*100))}else if(S==="percent"){const q=v??P;q!=null&&(p+=q,c>0&&(u+=q/100*c))}else T!=null&&(u+=T,c>0&&(p+=T/c*100)),v!=null&&(p+=v,c>0&&(u+=v/100*c))});function y(A=[]){return!Array.isArray(A)||A.length===0?{costPerDay:0,totalPerDay:0}:A.reduce((S,P)=>{const T=$(P?.positionCost??P?.position_cost??P?.cost??P?.dailyWage??P?.daily_wage??0),v=$(P?.positionClientPrice??P?.position_client_price??P?.clientPrice??P?.dailyTotal??P?.daily_total??P?.total??0),q=Number.isFinite(T)?T:0,F=Number.isFinite(v)?v:0;return{costPerDay:S.costPerDay+q,totalPerDay:S.totalPerDay+F}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=y),o==="amount"&&d!=null?r=d:o==="percent"&&d!=null?l=d:o===null&&d!=null&&(l!=null?l=d:r=d),(r==null||r<=0)&&l!=null&&l>0&&c>0&&(r=c*(l/100)),(l==null||l<=0)&&r!=null&&r>0&&c>0&&(l=r/c*100);const h=r??0,b=l??0;r=h+u,l=b+p,r=en(r??0,{min:0,max:c>0?c:Number.POSITIVE_INFINITY,precision:2}),l=en(l??0,{min:0,max:100,precision:2});let g=o;return g||(r>0&&c>0?g="amount":l>0&&(g="percent")),{paidAmount:r,paidPercent:l,paymentProgressType:g,paymentProgressValue:g==="amount"?r:g==="percent"?l:null}}function Et({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const s=xn(e),a=Number.isFinite(Number(i))?Number(i):0,c=Number.isFinite(Number(t))?Number(t):0,o=Number.isFinite(Number(n))?Number(n):0;if(s==="paid")return"paid";const r=a>0&&c>=a-Ae,l=o>=100-Ae*100;if(r||l)return"paid";const d=c>Ae||o>Ae;return s==="partial"||d?"partial":"unpaid"}function Aa(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const s=i.getTime()-n.getTime();if(s<=0)return 1;const a=s/Ia;return Math.max(1,Math.ceil(a))}function Te({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:s="percent",applyTax:a=!1,start:c=null,end:o=null,companySharePercent:r=null}={}){const l=Aa(c,o),d=(e||[]).reduce((k,C)=>{const j=$(C?.qty??C?.quantity??C?.count??1),B=Number.isFinite(j)&&j>0?j:1,le=$(C?.price??C?.unit_price??C?.unitPrice),X=Number.isFinite(le)?le:0;return k+B*X},0),u=z(d*l),p=Array.isArray(n)?n:[],y=p.length?p.map(k=>k?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:h,totalPerDay:b}=p.length?calculateCrewDailyTotalsFromAssignments(p):_a(y),g=z(b*l),_=z(h*l),A=z(u+g),S=Number(i)||0;let P=s==="amount"?S:A*(S/100);(!Number.isFinite(P)||P<0)&&(P=0),P>A&&(P=A);const T=Math.max(0,A-P);let v=Number.isFinite(r)?Number(r):null;a&&(!Number.isFinite(v)||v<=0)&&(v=Rn);const q=v&&v>0?v:0,F=q>0?Math.max(0,T*(q/100)):0,L=T+F;let D=a?L*.15:0;(!Number.isFinite(D)||D<0)&&(D=0),D=Number(D.toFixed(2));const m=L+D,M=Math.max(0,Number(m.toFixed(2))),Q=Math.max(0,Math.max(0,u+g-P)-_);return{rentalDays:l,equipmentTotal:u,crewTotal:g,crewCostTotal:_,discountAmount:P,subtotalAfterDiscount:T,taxableAmount:L,taxAmount:D,finalTotal:M,companySharePercent:q,companyShareAmount:F,netProfit:Q}}function ps(e=[],t=0,n="percent",i=!1,s=[],{start:a=null,end:c=null,companySharePercent:o=null}={}){const r=p=>p&&typeof p=="object"&&(p.positionId!==void 0||p.position_id!==void 0||p.positionLabel!==void 0||p.position_name!==void 0||p.positionClientPrice!==void 0),l=Array.isArray(s)&&s.some(r)?s:[],d=l.length?l.map(p=>p?.technicianId).filter(Boolean):Array.isArray(s)?s:[];return Te({items:e,technicianIds:d,crewAssignments:l,discount:t,discountType:n,applyTax:i,start:a,end:c,companySharePercent:o}).finalTotal}function Mn({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:s,paymentStatus:a,paidAmount:c=0,paidPercent:o=0,companySharePercent:r=null,companyShareAmount:l=null,taxAmount:d=null,netProfit:u=null,totalKey:p="reservations.summary.total",equipmentTotal:y=null,crewTotal:h=null}){const b=f("reservations.create.summary.currency","SR"),g=I(String(e)),_=I(String(t)),A=I(String(n??1)),S=I(String(i)),P=xn(a),T=P==="paid"?"مدفوع":P==="partial"?"مدفوع جزئياً":"غير مدفوع",v=f(`reservations.create.paymentStatus.${P}`,T),q=Number.isFinite(Number(c))?Math.max(0,Number(c)):0,F=Number.isFinite(Number(o))?Math.max(0,Number(o)):0,L=q>Ae||F>Ae,D=f("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),m=I(q.toFixed(2)),M=I(F.toFixed(F%1?2:0)),Q=f("reservations.summary.itemsLabel","📦 عدد المعدات"),k=f("reservations.summary.durationLabel","⏱️ عدد الأيام"),C=f("reservations.summary.crewLabel","😎 عدد الفريق"),j=f("reservations.details.labels.itemsTotal","💼 إجمالي المعدات"),B=f("reservations.details.labels.crewTotal","😎 إجمالي الفريق"),le=f("reservations.summary.taxLabelShort","🧾 الضريبة"),X=f("reservations.summary.paymentLabelShort","💳 حالة الدفع"),zt=f(p.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),Yn=f("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),Jn=f("reservations.details.labels.netProfit","💵 صافي الربح"),it=Number.isFinite(u)?Math.max(0,Number(u)):null,ue=[{label:Q,value:_},{label:k,value:A},{label:C,value:S}],Rt=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;Rt!=null&&ue.push({label:j,value:`${I(Rt.toFixed(2))} ${b}`});const wt=Number.isFinite(Number(h))?Math.max(0,Number(h)):null;if(wt!=null&&ue.push({label:B,value:`${I(wt.toFixed(2))} ${b}`}),s){let ee=f("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(d)&&d>0&&(ee=`${I(Number(d).toFixed(2))} ${b}`),ue.push({label:le,value:ee})}const Me=Number.isFinite(r)?Number(r):null;if(Me!==null&&Me>0){const ee=Number.isFinite(l)?Number(l):e*(Me/100),Ee=I(String(Me)),Xn=I(Number.isFinite(ee)?ee.toFixed(2):"0"),ei=`${Ee}% (${Xn} ${b})`;ue.push({label:Yn,value:ei})}if(it!==null&&Math.abs(it-Number(e))>.009){const ee=I(it.toFixed(2));ue.push({label:Jn,value:`${ee} ${b}`})}ue.push({label:X,value:v}),L&&ue.push({label:D,value:`${m} ${b} (${M}%)`});const Zn=`${g} ${b}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${ue.map(({label:ee,value:Ee})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${ee}</span>
            ${Ee?`<span class="reservation-summary-value">${Ee}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${zt}</span>
          <span class="reservation-summary-value">${Zn}</span>
        </div>
      </div>
    </div>
  `}function Pa({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:s,paymentProgressType:a=null,paymentProgressValue:c=null,start:o,end:r,companySharePercent:l=null,paymentHistory:d=[]}){const u=la(),p=typeof Wt=="function"?Wt()??[]:[],y=Array.isArray(p)?p.map(String):[],h=u.length?u.map(v=>v?.technicianId).filter(Boolean).map(String):y,b=u.length||h.length,g=Number.isFinite(l)?Number(l):null,_=Te({items:e,technicianIds:h,crewAssignments:u,discount:t,discountType:n,applyTax:i,start:o,end:r,companySharePercent:g}),A=Tt({totalAmount:_.finalTotal,progressType:a,progressValue:c,history:d}),S=Et({manualStatus:s,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:_.finalTotal}),P=Mn({total:_.finalTotal,itemsCount:e.length,rentalDays:_.rentalDays,techniciansCount:b,applyTax:i,paymentStatus:S,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:_.companySharePercent,companyShareAmount:_.companyShareAmount,taxAmount:_.taxAmount,netProfit:_.netProfit,equipmentTotal:_.equipmentTotal,crewTotal:_.crewTotal}),T={paymentStatus:S,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:_.finalTotal};return Pa.lastResult=T,va(P),P}function Na({items:e,discount:t,discountType:n,applyTax:i,paidStatus:s,paymentProgressType:a=null,paymentProgressValue:c=null,start:o,end:r,companySharePercent:l=null,paymentHistory:d=[]}){const u=ua(),p=typeof Kt=="function"?Kt()??[]:[],y=Array.isArray(p)?p.map(String):[],h=u.length?u.map(v=>v?.technicianId).filter(Boolean).map(String):y,b=u.length||h.length,g=Number.isFinite(l)?Number(l):null,_=Te({items:e,technicianIds:h,crewAssignments:u,discount:t,discountType:n,applyTax:i,start:o,end:r,companySharePercent:g}),A=Tt({totalAmount:_.finalTotal,progressType:a,progressValue:c,history:d}),S=Et({manualStatus:s,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:_.finalTotal}),P=Mn({total:_.finalTotal,itemsCount:e.length,rentalDays:_.rentalDays,techniciansCount:b,applyTax:i,paymentStatus:S,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:_.companySharePercent,companyShareAmount:_.companyShareAmount,taxAmount:_.taxAmount,netProfit:_.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:_.equipmentTotal,crewTotal:_.crewTotal}),T={html:P,paymentStatus:S,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:_.finalTotal};return Na.lastResult=T,P}function va(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,tn(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,tn(n,e))}function tn(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Sa=V()||{};let Y=(Sa.reservations||[]).map(Ea);function de(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const jn="__reservation_packages_cache__";function Hn(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Vn(){const e=Hn();if(!e)return{};try{const t=e.getItem(jn);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function nn(e){const t=Hn();if(t)try{t.setItem(jn,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function Un(e=[]){return Array.isArray(e)?e.map((t,n)=>Gn(t,n)).filter(Boolean).map((t,n)=>{const i=G(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),s=Ke(t,i).map(l=>{const d=R(l.qty??l.quantity??l.count??l.units??l.unit_qty??l.unitQty??l.unit_count??l.unitCount??l.package_quantity??l.packageQty??1),u=de(E(l.price??l.unit_price??0));return{...l,qty:d,quantity:d,price:u,unit_price:u}}),a=R(t.quantity??t.qty??1);let c=de(E(t.unit_price??t.unitPrice??t.price??0));if(!c||c<=0){const l=s.reduce((d,u)=>d+(u.price||0)*(u.qty||1),0);l>0&&a>0&&(c=de(Number((l/a).toFixed(2))))}const o=E(t.total_price??t.totalPrice??t.total??c*a),r=o>0?de(o):de(Number((c*a).toFixed(2)));return{...t,packageId:i,package_id:i,qty:a,quantity:a,unit_price:c,unitPrice:c,price:c,total_price:r,total:r,packageItems:s}}):[]}function xe(e,t){if(!e)return;const n=Vn(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],nn(n));return}n[i]=Un(t),nn(n)}function ka(e){if(!e)return[];const t=Vn(),n=String(e),i=t[n];return Array.isArray(i)?Un(i):[]}function Ca(e,t=0){if(e==null)return null;if(typeof e!="object"){const g=e!=null?String(e):null;return{assignmentId:`crew-${t}-${g??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:g,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e.position_id??e.positionId??e.position??e.position_code??null,s=e.position_key??e.positionKey??e.position_code??e.positionId??null;let a=e.position_name??e.positionName??e.position_label??e.role??e.position??"";a||(a=e.position_label_ar??e.position_name_ar??e.position_label_en??e.position_name_en??"");const c=e.position_label_ar??null,o=e.position_label_en??null,r=e.position_label_alt??o??c??"",l=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,u=de($(l)),p=de($(d)),y=e.technician_id??e.technicianId??e.id??e.userId??e.user_id??null,h=e.technician_name??e.technicianName??e.name??e.full_name??null,b=e.role??e.specialization??null;return{assignmentId:String(n),positionId:i!=null?String(i):null,positionKey:s!=null?String(s):null,positionLabel:a!=null?String(a):"",positionLabelAlt:r!=null?String(r):"",positionLabelAr:c!=null?String(c):null,positionLabelEn:o!=null?String(o):null,positionCost:Number.isFinite(u)?u:0,positionClientPrice:Number.isFinite(p)?p:0,technicianId:y!=null?String(y):null,technicianName:h!=null?String(h):null,technicianRole:b!=null?String(b):null,notes:e.notes??null}}function ms(){return Y}function nt(e){return Y=Array.isArray(e)?e.map(Ft):[],Y.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;xe(n,t.packages)}),Y.length?console.debug("[reservationsService] setReservationsState first paymentHistory",Y[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),an({reservations:Y}),Y}async function fs(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,r])=>{r!=null&&r!==""&&t.set(o,String(r))});const n=t.toString(),s=(await O(`/reservations/${n?`?${n}`:""}`))?.data;let a=[];Array.isArray(s)?a=s:s&&typeof s=="object"&&(Array.isArray(s.items)?a=s.items:Array.isArray(s.results)?a=s.results:Array.isArray(s.data)?a=s.data:Array.isArray(s.records)&&(a=s.records));const c=a.map(qt);return nt(c)}async function gs(e){const t=await O("/reservations/",{method:"POST",body:e}),n=qt(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const i=Lt(e.payment_history);i.length&&(n.paymentHistory=i)}if(Array.isArray(e?.packages)&&e.packages.length){const i=Dt({packages:e.packages});n.packages=ye(n.packages,i)}{const i=$t(n.items||[],n.packages||[]);n.items=i.items,n.packages=ye(n.packages||[],i.packages)}if(xe(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const i=Te({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=i.companyShareAmount,n.cost=i.finalTotal,n.totalAmount=i.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,nt([...Y,n]),n}async function Ta(e,t){const n=await O(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=qt(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const a=Lt(t.payment_history);a.length&&(i.paymentHistory=a,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if(Array.isArray(t?.packages)&&t.packages.length){const a=Dt({packages:t.packages});i.packages=ye(i.packages,a)}{const a=$t(i.items||[],i.packages||[]);i.items=a.items,i.packages=ye(i.packages||[],a.packages)}if(xe(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const a=Te({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=a.companyShareAmount,i.cost=a.finalTotal,i.totalAmount=a.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const s=Y.map(a=>String(a.id)===String(e)?i:a);return nt(s),i}async function hs(e){await O(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=Y.filter(n=>String(n.id)!==String(e));nt(t),xe(e,null)}async function ys(e){return Ta(e,{status:"confirmed",confirmed:!0})}function qt(e={}){return Ft({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function Ea(e={}){return Ft(e)}function Ft(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(qa):[],s=Dt(e);const a=Array.isArray(e.technicians)&&e.technicians.length?e.technicians:Array.isArray(e.techniciansDetails)?e.techniciansDetails:[],c=a.map((B,le)=>Ca(B,le)).filter(Boolean),o=c.map((B,le)=>{const X=a?.[le];return{...X&&typeof X=="object"?{...X}:X!=null?{id:X}:{},...B}}),r=c.map(B=>B.technicianId).filter(B=>B!=null&&B!=="").map(B=>Number.isNaN(Number(B))?String(B):Number(B)),l=e.start??e.start_datetime??"",d=e.end??e.end_datetime??"";let u=E(e.total_amount??e.totalAmount??e.cost??0);const p=E(e.discount??0),y=e.discount_type??e.discountType??"percent",h=["percent","amount"].includes(y)?y:"percent",b=!!(e.apply_tax??e.applyTax??!1);let g=wa(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const _=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),A=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,S=A!=null?Number.parseFloat(I(String(A).replace("%","").trim())):NaN,P=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let T=P!=null?P===!0||P===1||P==="1"||String(P).toLowerCase()==="true":Number.isFinite(S)&&S>0,v=T&&Number.isFinite(S)?Number(S):0;const q=e.company_share_amount??e.companyShareAmount;let F=Number.isFinite(Number(q))?Number(q):NaN;b&&v<=0&&(v=Rn,T=!0);const L=Te({items:i,technicianIds:r,crewAssignments:c,discount:p,discountType:h,applyTax:b,start:l,end:d,companySharePercent:v>0?v:null});(!Number.isFinite(u)||u<=0||b)&&(u=L.finalTotal),(!Number.isFinite(F)||F<0)&&(F=L.companyShareAmount),F=Number.isFinite(F)?Number(F.toFixed(2)):0,!T&&v>0&&(T=!0);const D=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],m=Fa(D),M=Lt(m),Q=t??n??e.reservation_code??e.reservationId??null;if(s.length)xe(Q,s);else{const B=ka(Q);B.length&&(s=ye(s,B))}const k=$t(i,s);i=k.items,s=ye(s,k.packages);const C=Tt({totalAmount:u,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:M});g=Et({manualStatus:g,paidAmount:C.paidAmount,paidPercent:C.paidPercent,totalAmount:u});const j=g==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:l,end:d,status:Ra(e.status??(_?"confirmed":"pending")),confirmed:_,location:e.location??"",notes:e.notes??"",discount:p,discountType:h,applyTax:b,paid:j,paidStatus:g,paidAmount:C.paidAmount,paidPercent:C.paidPercent,paymentProgressType:C.paymentProgressType,paymentProgressValue:C.paymentProgressValue,paymentHistory:M,payment_history:M,totalAmount:u,cost:u,projectId:e.project_id??e.projectId??null,items:i,technicians:r,crewAssignments:c,techniciansDetails:o,startDatetime:l,endDatetime:d,customerPhone:e.customer_phone??e.customerPhone??null,packages:s,companySharePercent:v,companyShareAmount:F,companyShareEnabled:T}}function qa(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=E(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),s=I(String(e.barcode??e.code??e.serial??"")),a=e.description??e.desc??e.name??e.title??"",c={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:s,desc:a,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},o=On(e.type??e.item_type??e.kind??null),r=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,l=Z(r),d=Ke(e,l);if(o==="package"||l||d.length){c.type="package";const u=l||(t!=null?String(t):c.id?Z(c.id):"");u&&(c.packageId=u,c.package_id=u,c.package_code=e.package_code??e.packageCode??u),c.name=a||c.package_code||u||"",c.barcode=c.barcode||I(String(e.package_code??e.packageCode??"")),c.packageItems=d;const p=Wn({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(c.price)||c.price<=0||c.price>p*10)&&(c.price=p),c.qtyPerPackage=d.length?d[0]?.qtyPerPackage??c.qtyPerPackage:c.qtyPerPackage,c.totalQuantity=n}return c}function bs({reservationCode:e,customerId:t,start:n,end:i,status:s,title:a,location:c,notes:o,projectId:r,totalAmount:l,discount:d,discountType:u,applyTax:p,paidStatus:y,confirmed:h,items:b,packages:g,crewAssignments:_=[],technicians:A=_,companySharePercent:S,companyShareEnabled:P,paidAmount:T,paidPercentage:v,paymentProgressType:q,paymentProgressValue:F,paymentHistory:L}){const D=Array.isArray(_)?_:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:s??"pending",title:a??null,location:c??null,notes:o??null,project_id:r||null,total_amount:l??0,discount:d??0,discount_type:u??"percent",apply_tax:p?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(T)?E(T):0,paid_percentage:Number.isFinite(v)?Number(v.toFixed(2)):0,payment_progress_type:q??null,payment_progress_value:Number.isFinite(F)?Number(F.toFixed(2)):null,payment_history:Array.isArray(L)?L.map(m=>({type:dt(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?E(m.value):null,amount:m?.amount!=null?E(m.amount):m?.payment_amount!=null?E(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],payments:Array.isArray(L)?L.map(m=>({type:dt(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?E(m.value):null,amount:m?.amount!=null?E(m.amount):m?.payment_amount!=null?E(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],confirmed:h===void 0?null:!!h,items:La(b),packages:Ba(b,g),company_share_percent:P&&Number.isFinite(S)?Number(S):null,company_share_enabled:P?1:0,technicians:D.length?D.map((m,M)=>{const Q=m.technicianId??m.technician_id??m.id??null,k=m.positionId??m.position_id??m.position??m.position_code??null,C=m.positionLabel??m.position_name??m.role??null,j=E(m.positionCost??m.position_cost??m.cost??m.daily_wage??m.dailyWage??0),B=E(m.positionClientPrice??m.position_client_price??m.client_price??m.clientPrice??m.daily_total??m.dailyTotal??m.total??0);return{id:Q,technician_id:Q,role:C??m.technicianRole??null,notes:m.notes??null,position_id:k,position_key:m.positionKey??m.position_key??null,position_name:C,position_label_ar:m.positionLabelAr??m.position_label_ar??null,position_label_en:m.positionLabelEn??m.position_label_en??null,position_cost:j,position_client_price:B,client_price:B,cost:j,assignment_id:m.assignmentId??m.assignment_id??`crew-${M}`}}):Array.isArray(A)?A.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function Lt(e){const t=Bt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,s=dt(i),a=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,c=a!=null?Number.parseFloat(I(String(a))):null,o=n.amount!=null?Number.parseFloat(I(String(n.amount))):n.payment_amount!=null?Number.parseFloat(I(String(n.payment_amount))):null,r=n.percentage!=null?Number.parseFloat(I(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(I(String(n.payment_percentage))):null,l=Number.isFinite(o)?o:s==="amount"&&Number.isFinite(c)?c:null,d=Number.isFinite(r)?r:s==="percent"&&Number.isFinite(c)?c:null,u=s??(l!=null?"amount":d!=null?"percent":null),p=u==="amount"?l:u==="percent"?d:Number.isFinite(c)?c:null,y=n.note??n.notes??n.comment??n.payment_note??null,h=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:u,value:p,amount:l,percentage:d,note:y,recordedAt:h}}).filter(n=>n&&n.type)}function dt(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Bt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const c of t)if(Array.isArray(e[c]))return e[c];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(c=>Array.isArray(c));if(Array.isArray(i))return i;const s=Object.values(e);if(s.length&&s.every(c=>c&&typeof c=="object")){const c=s.map(o=>o);if(c.every(o=>!Array.isArray(o)))return c}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(c=>c in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Bt(t)}catch{return[]}return[]}function Fa(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Bt(t);if(Array.isArray(n)&&n.length)return n}return[]}function La(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const s=R(n.qty??n.quantity??1);n.packageItems.forEach(a=>{const c=a?.equipmentId??a?.equipment_id??a?.id??null;if(c==null)return;const o=R(a?.qty??a?.quantity??1),r=s*o;t.push({equipment_id:pt(c),quantity:r,unit_price:E(a?.price??a?.unit_price??0),notes:a?.notes??null})});return}const i=n.equipmentId??n.equipment_id??n.id??null;i!=null&&t.push({equipment_id:pt(i),quantity:R(n.qty??n.quantity??1),unit_price:E(n.price??n.unit_price??0),notes:n.notes??null})}),t}function pt(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function Ba(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const s=R(i.qty??i.quantity??1),a=Array.isArray(i.packageItems)?i.packageItems.map(c=>{const o=c?.equipmentId??c?.equipment_id??c?.id??null;return o==null?null:{equipment_id:pt(o),quantity:R(c?.qty??c?.quantity??c?.count??c?.units??c?.unit_qty??c?.unitQty??c?.unit_count??c?.unitCount??c?.package_quantity??c?.packageQty??1),unit_price:E(c?.price??c?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:s,unit_price:E(i.price??i.unit_price??0),items:a})}),n}function On(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function Z(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return G(t)}function mt(e){return e==null?"":I(String(e)).trim().toLowerCase()}function Qn(e={},t=1){if(!e||typeof e!="object"){const r=I(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:r,normalizedBarcode:mt(r),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=E(e.unit_price??e.unitPrice??e.price??0),a=I(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),c=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let o;if(c!=null)o=R(c,{fallback:1,max:99});else if(t>0){const r=i/t;Number.isFinite(r)&&r>0&&Number.isInteger(r)?o=R(r,{fallback:1,max:99}):o=Math.min(i,99)}else o=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:o,quantity:o,qtyPerPackage:o,totalQuantity:i,price:s,unit_price:s,barcode:a,normalizedBarcode:mt(e.normalizedBarcode??a),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function $a(e={},t={}){const n=Z(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=R(e.quantity??e.qty??t.qty??t.quantity??1,{fallback:1,max:9999}),s=E(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),a=I(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:a,desc:t.desc??t.description??e.name??e.desc??e.title??a,qty:i,quantity:i,price:s,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:a,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function $t(e=[],t=[]){const n=Da(e),i=Array.isArray(t)?ye(t,n.packages):n.packages,s=new Map;return i.forEach(a=>{const c=Z(a.packageId??a.package_id??a.id);c&&s.set(c,a)}),n.packages.forEach(a=>{const c=Z(a.packageId??a.package_id??a.id);if(!c)return;const o=s.get(c);o&&((!Array.isArray(o.packageItems)||o.packageItems.length===0)&&(o.packageItems=a.packageItems),!o.name&&a.name&&(o.name=a.name),!o.image&&a.image&&(o.image=a.image))}),{items:n.items,packages:Array.from(s.values())}}function Da(e=[]){const t=new Map;if(e.forEach(a=>{const c=Z(a.packageId??a.package_id??a.packageCode??a.package_code??a.bundleId??a.bundle_id??null);if(!c)return;const o=c;t.has(o)||t.set(o,{base:a,items:[]}),t.get(o).items.push(a)}),!t.size)return{items:e,packages:[]};const n=[],i=[],s=new Set;return e.forEach(a=>{const c=Z(a.packageId??a.package_id??a.packageCode??a.package_code??a.bundleId??a.bundle_id??null);if(c&&t.has(c)){if(s.has(c))return;const o=t.get(c),r=o.base||a,l=o.items.map(u=>Qn(u,1)),d={packageId:c,package_id:c,package_code:r.package_code??r.packageCode??r.barcode??I(String(c)),name:r.package_name??r.packageName??r.desc??r.name??`Package ${c}`,quantity:R(r.package_quantity??r.packageQty??r.qty??1,{fallback:1,max:9999}),unit_price:E(r.package_price??r.packagePrice??r.price??0),packageItems:l,image:r.image??null};i.push(d),n.push($a(d,r)),s.add(c);return}n.push(a)}),{items:n,packages:i}}function Ke(e={},t=""){if(!e||typeof e!="object")return[];const n=Z(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let s=ge({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),a=[];if((!Array.isArray(s)||s.length===0)&&n){const l=Qe(n);l&&(s=ge(l),a=Array.isArray(s)?s:[])}else if(n){const l=Qe(n);l&&(a=ge(l)||[])}if(!Array.isArray(s)||s.length===0)return[];const c=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),o=s.map(l=>Qn(l,c));if(a.length){const l=new Map;a.forEach(d=>{if(!d)return;const u=mt(d.barcode)||(d.equipmentId!=null?`id:${d.equipmentId}`:null)||(d.equipment_id!=null?`id:${d.equipment_id}`:null);u&&l.set(u,d)}),o.forEach(d=>{const u=d.normalizedBarcode||(d.equipmentId?`id:${d.equipmentId}`:null);if(!u||!l.has(u))return;const p=l.get(u),y=R(p.quantity??p.qty??1,{fallback:d.qtyPerPackage??1,max:99});d.qtyPerPackage=y,d.qty=y,d.quantity=y;const h=E(p.unit_price??p.unitPrice??p.price??d.price);d.price=h,d.unit_price=h,!d.desc&&p.desc&&(d.desc=p.desc),!d.image&&p.image&&(d.image=p.image)})}const r=new Map;return o.forEach(l=>{const d=l.normalizedBarcode||(l.equipmentId?`id:${l.equipmentId}`:null);if(d){if(r.has(d)){const u=r.get(d);u.qty+=l.qty,u.quantity+=l.quantity,(!Number.isFinite(u.qtyPerPackage)||u.qtyPerPackage<=0)&&(u.qtyPerPackage=l.qtyPerPackage),(!u.price||u.price===0)&&l.price&&(u.price=l.price,u.unit_price=l.unit_price),!u.desc&&l.desc&&(u.desc=l.desc),!u.image&&l.image&&(u.image=l.image);return}r.set(d,{...l})}}),Array.from(r.values())}function Wn(e={},t=[],n=1){if(Array.isArray(t)&&t.length){const s=t.reduce((a,c)=>{const o=Number.isFinite(Number(c.price))?Number(c.price):0,r=Number.isFinite(Number(c.qtyPerPackage))&&Number(c.qtyPerPackage)>0?Number(c.qtyPerPackage):Number.isFinite(Number(c.qty))&&Number(c.qty)>0?Number(c.qty):1;return a+o*r},0);if(s>0)return Number(s.toFixed(2))}const i=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(i))){const s=E(i);return n>0?Number((s/n).toFixed(2)):s}return Number.isFinite(Number(e.unit_price??e.unitPrice??e.price))?E(e.unit_price??e.unitPrice??e.price):0}function Kn(e,t){if(!e)return t;if(!t)return e;const n={...e},i=s=>{(n[s]===void 0||n[s]===null||n[s]==="")&&(n[s]=t[s])};return["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=za(n.packageItems,t.packageItems),n.items=n.packageItems),n}function za(e=[],t=[]){const n=new Map,i=s=>{s.forEach(a=>{if(!a)return;const c=a.normalizedBarcode||(a.equipmentId?`id:${a.equipmentId}`:null);if(c){if(n.has(c)){const o=n.get(c);o.qty+=a.qty??0,o.quantity+=a.quantity??0,(!Number.isFinite(o.qtyPerPackage)||o.qtyPerPackage<=0)&&Number.isFinite(a.qtyPerPackage)&&(o.qtyPerPackage=a.qtyPerPackage),(!o.price||o.price===0)&&a.price&&(o.price=a.price,o.unit_price=a.unit_price),!o.desc&&a.desc&&(o.desc=a.desc),!o.image&&a.image&&(o.image=a.image);return}n.set(c,{...a})}})};return i(e),i(t),Array.from(n.values())}function ye(e=[],t=[]){const n=[],i=new Map,s=a=>{Array.isArray(a)&&a.forEach(c=>{if(!c||typeof c!="object")return;const o=c.packageId||c.package_id||c.package_code||c.id;if(o)if(i.has(o)){const r=i.get(o);n[r]=Kn(n[r],c)}else i.set(o,n.length),n.push({...c})})};return s(e),s(t),n}function Gn(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const u=Z(e),p=u?Qe(u):null,y=p?Ke(p,u):[],h=p?E(p.price??p.unit_price??p.unitPrice??0):0,b=1,g=Number((h*b).toFixed(2));return{id:`package::${u||t}`,packageId:u||`pkg-${t}`,package_id:u||`pkg-${t}`,package_code:I(String(e))||u||`pkg-${t}`,name:p?.name??p?.package_name??p?.packageName??I(String(e))??"",desc:p?.name??I(String(e))??"",quantity:b,qty:b,unit_price:h,unitPrice:h,price:h,total:g,total_price:g,barcode:I(String(e)),packageItems:y,items:y,type:"package",image:p?.image??null}}if(typeof e!="object")return null;const n=Z(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),s=Ke(e,n),a=Wn(e,s,i),c=e.total_price??e.totalPrice??e.total??a*i,o=Number.isFinite(Number(c))?E(c):Number((a*i).toFixed(2)),r=e.package_code??e.packageCode??e.code??n,l=I(String(e.barcode??r??"")),d=e.image??e.cover??e.thumbnail??s.find(u=>u.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:r,name:e.name??e.package_name??e.packageName??e.title??e.description??r??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??r??n,quantity:i,qty:i,unit_price:a,unitPrice:a,price:a,total:o,total_price:o,barcode:l,packageItems:s,items:s,type:"package",image:d}}function Dt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,s=(o,r=n.length)=>{const l=Gn(o,r);if(!l)return;const d=l.packageId||l.package_code||l.id||`pkg-${r}`;if(i.has(d)){const u=i.get(d);n[u]=Kn(n[u],l)}else i.set(d,n.length),n.push(l)};t.forEach(o=>{o.forEach((r,l)=>{s(r,l+n.length)})}),n.length===0&&e.package&&s(e.package,0);const a=Array.isArray(e.items)?e.items:[],c=(o={})=>!o||typeof o!="object"?!1:!!(On(o.type??o.item_type??o.kind??null)==="package"||o.packageItems&&Array.isArray(o.packageItems)&&o.packageItems.length||o.items&&Array.isArray(o.items)&&o.items.length&&o.items.every(l=>typeof l=="object")||o.packageId||o.package_id||o.package_code||o.packageCode||o.bundleId||o.bundle_id);return a.forEach((o,r)=>{c(o)&&s(o,n.length+r)}),n}function E(e){const t=$(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function R(e,{fallback:t=1,max:n=1e6}={}){const i=$(e);if(!Number.isFinite(i))return t;const s=Math.round(i);return s<=0||s>n?t:s}function Ra(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return"pending"}}function wa(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function _s(e){return e instanceof Ue}export{Ya as $,ns as A,wi as B,Za as C,Rn as D,Ka as E,la as F,Pa as G,He as H,G as I,Qa as J,Hi as K,Ua as L,is as M,fa as N,ts as O,Qe as P,zi as Q,Ri as R,Ga as S,ha as T,Xa as U,Wa as V,ma as W,Oa as X,Zi as Y,bs as Z,gs as _,fs as a,os as a0,Ja as a1,es as a2,ls as a3,z as a4,$ as a5,Te as a6,Ft as a7,hs as a8,ys as a9,Na as aa,ua as ab,cs as ac,ss as ad,Ea as ae,rs as b,_s as c,ja as d,ds as e,Va as f,ms as g,ge as h,as as i,Tt as j,Et as k,Oe as l,ft as m,W as n,qt as o,An as p,Aa as q,li as r,Nn as s,Ma as t,pe as u,Ha as v,ps as w,us as x,Ta as y,zn as z};
