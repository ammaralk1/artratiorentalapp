import{d as O,n as A,b as M,A as Le,s as Vt,a as Rn,m as Mn,c as wn,i as jn,l as Vn,e as we,t as y,f as Hn,h as v,j as Ht,o as On}from"./auth.js";const Un=O()||{};let ae=(Un.technicians||[]).map(Wt);function Ot(){return ae}function ke(e){return ae=Array.isArray(e)?e.map(Wt):[],Vt({technicians:ae}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),ae}async function Qn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,c])=>{c!=null&&c!==""&&t.set(s,String(c))});const n=t.toString(),a=await M(`/technicians/${n?`?${n}`:""}`),r=Array.isArray(a?.data)?a.data.map(at):[];return ke(r)}async function Wn(e){const t=await M("/technicians/",{method:"POST",body:e}),n=at(t?.data??{});return ke([...ae,n]),n}async function Ut(e,t){const n=await M(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=at(n?.data??{}),r=ae.map(s=>String(s.id)===String(e)?a:s);return ke(r),a}async function Kn(e){await M(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ke(ae.filter(t=>String(t.id)!==String(e)))}function Qt({name:e,phone:t,email:n,role:a,department:r,dailyWage:s,dailyTotal:c,status:i,notes:o,active:u=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:r??null,daily_wage:s??0,daily_total:c??null,status:i??"available",notes:o??null,active:u?1:0}}function at(e={}){return Kt({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function Wt(e={}){return Kt(e)}function Kt(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",r=e.email??null,s=e.specialization??e.role??e.position??"",c=e.department??e.team??"",i=Tt(e.daily_wage??e.dailyWage??e.wage??e.rate??0),o=Tt(e.daily_total??e.dailyTotal??e.total??e.total_wage??i),u=Et(e.baseStatus??e.status??"available"),l=Et(e.status??e.baseStatus??"available"),d=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:r,role:s,department:c,dailyWage:i,dailyTotal:o,status:l,baseStatus:u,notes:d,active:p}}function Tt(e){const t=Number.parseFloat(A(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Et(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function je(e){return e instanceof Le}Rn();Mn();wn();document.addEventListener("DOMContentLoaded",()=>{jn();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Vn()),e.dataset.listenerAttached="true")});function ze(e){const t=Number(e)||0,a=we()==="ar"?"ar-SA-u-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${A(r)} SR`}function _i(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function Ai(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function Ii(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}…`:""}function ne(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Gn="technicianPositions:updated";let V=[],Gt=!1,Ae=null;function it(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function Yt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:r}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:r??null}}function Yn(e){return V=Array.isArray(e)?e.map(it).filter(t=>t.name!=="").sort((t,n)=>me(t).localeCompare(me(n),"ar",{sensitivity:"base"})):[],Gt=!0,Ve(),te()}function Ve(){try{const e={positions:te()},t=new CustomEvent(Gn,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function me(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function te(){return V.map(e=>({...e}))}function Jn(e){const t=String(e??"").trim().toLowerCase();return t&&V.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function Zn({forceRefresh:e=!1}={}){return Gt&&!e?te():(Ae&&!e||(Ae=M("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return Yn(n)}).finally(()=>{Ae=null})),Ae)}async function He({forceRefresh:e=!1}={}){try{return await Zn({forceRefresh:e})}catch(t){throw t instanceof Le?t:new Le(t?.message||y("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"))}}async function Xn({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:r}){const s=Yt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:r}),c=await M("/technician-positions/",{method:"POST",body:s}),i=it(c?.data??{});return V=[...V,i],V.sort((o,u)=>me(o).localeCompare(me(u),"ar",{sensitivity:"base"})),Ve(),i}async function ea(e,{name:t,cost:n,clientPrice:a,labelAr:r,labelEn:s}){if(!e)throw new Error("Position id is required");const c=Yt({name:t,cost:n,clientPrice:a,labelAr:r,labelEn:s}),i=await M(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:c}),o=it(i?.data??{});return V=V.map(u=>u.id===o.id?o:u),V.sort((u,l)=>me(u).localeCompare(me(l),"ar",{sensitivity:"base"})),Ve(),o}async function ta(e){if(!e)throw new Error("Position id is required");return await M(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),V=V.filter(t=>t.id!==Number(e)),Ve(),te()}const Ge="__ART_RATIO_TECH_SUB_TAB__",Jt=["technicians-management","technicians-positions"];let D=null,qt=!1,Fe=!1,Pe="",Ye=!1,Q=null,ie="technicians-management";const Ct=na();Ct&&(ie=Ct);async function Zt({showToastOnError:e=!0}={}){if(!Fe){Fe=!0,Pe="",x();try{await Qn(),Ye=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),Pe=je(t)?t.message:y("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&v(Pe,"error")}finally{Fe=!1,x()}}}function Xt(){return Ot()}function Ce(e=""){return A(String(e)).trim().toLowerCase()}function Bt(e){return e==null?"":String(e)}function fe(e=""){return A(String(e)).replace(/[^0-9+]/g,"")}function R(e=""){const t=A(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function pe(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function na(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(Ge);return e&&Jt.includes(e)?e:null}catch(e){return console.warn("⚠️ [technicians] Failed to read stored sub-tab",e),null}}function aa(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Jt.includes(e)){window.localStorage.removeItem(Ge);return}window.localStorage.setItem(Ge,e)}catch(t){console.warn("⚠️ [technicians] Failed to store sub-tab",t)}}function en(e,t=0,n=null){const a=String(e??"").trim(),r=a?Jn(a):null;return r?{matchedPosition:r,dailyWage:Number.isFinite(r.cost)?r.cost:0,dailyTotal:r.clientPrice==null?null:Number.isFinite(r.clientPrice)?r.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function tn(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function Je(e,t=we()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function ia(e,t=we()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function nn(){const{container:e,body:t}=tn();!e||!t||(t.textContent="",e.hidden=!0)}function rt(e,t={}){const{container:n,body:a}=tn();if(!n||!a)return;const r=String(e??"").trim();if(!r){nn();return}const s=en(r,t?.dailyWage??0,t?.dailyTotal??null),c=ze(s.dailyWage||0),i=s.dailyTotal!=null?ze(s.dailyTotal):y("technicians.positionSummary.noClientPrice","—");s.matchedPosition?a.textContent=y("technicians.positionSummary.match","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",c).replace("{price}",i):a.textContent=y("technicians.positionSummary.custom","لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}").replace("{cost}",c).replace("{price}",i),n.hidden=!1}function Te(){const e=document.getElementById("technician-position-options");if(!e)return;const t=te(),n=we(),a=new Set,r=[];t.forEach(s=>{const c=Je(s,n).trim();c&&!a.has(c.toLowerCase())&&(r.push(`<option value="${ne(c)}"></option>`),a.add(c.toLowerCase()));const i=ia(s,n).trim();i&&!a.has(i.toLowerCase())&&(r.push(`<option value="${ne(i)}"></option>`),a.add(i.toLowerCase()));const o=s.name?.trim();o&&!a.has(o.toLowerCase())&&(r.push(`<option value="${ne(o)}"></option>`),a.add(o.toLowerCase()))}),e.innerHTML=r.join("")}function Ft(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),r=t.map(i=>i?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(i=>{if(!i)return;const u=i.getAttribute("data-tech-tab")===r;i.classList.toggle("tab-active",u),i.classList.toggle("active",u),i.setAttribute("aria-selected",u?"true":"false"),i.setAttribute("tabindex",u?"0":"-1")}),n.forEach(i=>{if(!i)return;const u=i.getAttribute("data-tech-tab-panel")===r;i.hidden=!u,i.classList.toggle("active",u)}),ie=r,aa(r);const c=t.find(i=>i?.getAttribute("data-tech-tab")===r)?.closest("[data-tab-scroll]");c&&c.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),r==="technicians-positions"&&(Z(),He().then(()=>{Z()}).catch(i=>{console.error("❌ [technicians] failed to load positions for tab switch",i),v(i?.message||y("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}))}function st(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=y(n,a)}function ct(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=y("technicians.form.actions.cancel","إلغاء التعديل"))}function ot(){st(D?"update":"add"),ct(!!D),x()}function ra(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,c)=>s.localeCompare(c,"ar",{sensitivity:"base"})),r=y("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${r}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function Oe(){const e=document.getElementById("technician-form");e&&(e.reset(),D=null,st("add"),ct(!1),nn())}function sa(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),r=document.getElementById("technician-department"),s=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=fe(e.phone||""),a.value=e.role||"",r&&(r.value=e.department||""),s&&(s.value=e.notes||""),D=String(e.id),st("update"),ct(!0),rt(a.value,e))}function ca(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),r=document.getElementById("technician-notes");if(!e||!t||!n)return null;const s=e.value.trim(),c=fe(t.value.trim());t.value=c;const i=n.value.trim(),o=a?.value.trim()||"",u="available",l=r?.value.trim()||"",d=D?rn(D):null,{dailyWage:p,dailyTotal:g}=en(i,d?.dailyWage??0,d?.dailyTotal??null);return s?c?i?!Number.isFinite(p)||p<0?(v(y("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),null):g!=null&&(!Number.isFinite(g)||g<0)?(v(y("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),null):(rt(i,{dailyWage:p,dailyTotal:g}),{name:s,phone:c,role:i,department:o,dailyWage:Number.isFinite(p)?p:0,dailyTotal:g==null?null:Number(g),status:u,baseStatus:u,notes:l}):(v(y("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(v(y("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(v(y("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function oa(e){e.preventDefault();try{await He()}catch(a){console.error("❌ [technicians] failed to load positions before submit",a);const r=a?.message||y("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");v(r,"error");return}const t=ca();if(!t)return;const n=Qt({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{D?(await Ut(D,n),v(y("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await Wn(n),v(y("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),Oe(),x()}catch(a){console.error("❌ [technicians] handleTechnicianSubmit failed",a);const r=je(a)?a.message:y("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");v(r,"error")}}function ua(){Oe()}function la(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=fe(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=R(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const r=R(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==r&&(t.total.value=r);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),pe(t.phone,fe),pe(t.wage,R),pe(t.total,R)}function da(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),r=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),c=document.getElementById("edit-technician-total"),i=document.getElementById("edit-technician-status"),o=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!c||!i)return null;const u=e.value.trim(),l=t.value.trim(),d=fe(n.value.trim());n.value=d;const p=a.value.trim(),g=r?.value.trim()||"",m=R(s.value.trim());s.value=m;const f=m===""?0:parseFloat(m),h=R(c.value.trim());c.value=h;const _=h===""?null:parseFloat(h),I=i.value||"available",N=o?.value.trim()||"";return u?l?d?p?Number.isNaN(f)||f<0?(v(y("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),s.focus(),null):_!=null&&(Number.isNaN(_)||_<0)?(v(y("technicians.toast.invalidTotal","⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية")),c.focus(),null):{id:u,name:l,phone:d,role:p,department:g,dailyWage:Number.isFinite(f)?f:0,dailyTotal:_==null?null:Number(_),status:I,baseStatus:I,notes:N}:(v(y("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),a.focus(),null):(v(y("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(v(y("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(v(y("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function pa(){const e=da();if(!e)return;const t=Qt({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await Ut(e.id,t),v(y("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),x()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const a=je(n)?n.message:y("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");v(a,"error")}}function x(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Ce(t?.value||"");if(Fe&&!Ye){const u=y("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='6'>${u}</td></tr>`;return}if(Pe&&!Ye){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${Pe}</td></tr>`;return}const a=cn(),{reservations:r=[]}=O(),s=new Date;ra(a);const c=document.getElementById("technician-role-filter"),i=Ce(c?.value||""),o=a.filter(u=>i&&Ce(u.role||"")!==i?!1:n?Ce([u.name,u.phone,u.role,u.department,u.notes].filter(Boolean).join(" ")).includes(n):!0);if(o.length===0){const u=y("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='6'>${u}</td></tr>`;return}e.innerHTML=o.map(u=>{const l=D&&String(D)===String(u.id),g=(sn(u.id,r,s)?"busy":u.status||u.baseStatus||"available")==="busy"?{label:y("technicians.status.busy","⛔ مشغول"),className:"technician-status-badge technician-status-badge--busy"}:{label:y("technicians.status.available","✅ متاح"),className:"technician-status-badge technician-status-badge--available"},m=y("technicians.actions.edit","✏️ تعديل"),f=y("technicians.actions.delete","🗑️ حذف"),h=Ht(),_=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${u.id}">${m}</button>`];return h&&_.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${u.id}">${f}</button>`),`
      <tr${l?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${u.id}" class="text-decoration-none">${u.name}</a></td>
        <td>${u.role||""}</td>
        <td>${u.department||"—"}</td>
        <td><span class="${g.className}"><span class="technician-status-badge__text">${g.label}</span></span></td>
        <td class="table-notes-cell">${u.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${_.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Ue(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function an(e="add"){const{submitBtn:t,cancelBtn:n}=Ue(),a=e==="update";if(t){const r=a?"positions.form.actions.update":"positions.form.actions.submit",s=a?"💾 حفظ المنصب":"➕ إضافة منصب";t.textContent=y(r,s)}n&&(n.classList.toggle("d-none",!a),n.textContent=y("positions.form.actions.cancel","إلغاء"))}function ut(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:r,clientPriceInput:s}=Ue();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),r&&(r.value=""),s&&(s.value=""),Q=null,an("add")}function ma(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:r,clientPriceInput:s}=Ue();!e||!r||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),r.value=R(e.cost??0),s&&(s.value=e.clientPrice==null?"":R(e.clientPrice)),Q=e.id||null,an("update"))}function fa(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=Ue();if(!n)return null;const r=e?.value.trim()||"",s=t?.value.trim()||"",c=s||r,i=Q?te().find(p=>String(p.id)===String(Q)):null,o=R(n.value.trim());n.value=o;const u=o===""?0:parseFloat(o),l=a?R(a.value.trim()):"";a&&(a.value=l);const d=l===""?null:parseFloat(l);return c?!Number.isFinite(u)||u<0?(v(y("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),n.focus(),null):d!=null&&(!Number.isFinite(d)||d<0)?(v(y("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),a?.focus(),null):{id:Q,name:i?.name||c,cost:Number(u.toFixed(2)),clientPrice:d==null?null:Number(d.toFixed(2)),labelAr:r||null,labelEn:s||null}:(v(y("positions.toast.invalidName","⚠️ يرجى إدخال اسم المنصب")),e&&e.focus(),null)}function ge(){const e=document.getElementById("technician-role");if(!e)return;const t=D?rn(D):null;rt(e.value,t||{})}function Z(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=te();if(t&&(t.textContent=A(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${y("positions.table.empty","لا توجد مناصب بعد.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const r=Q&&String(Q)===String(a.id),s=ze(a.cost||0),c=a.clientPrice==null?y("technicians.positionSummary.noClientPrice","—"):ze(a.clientPrice),i=Je(a,"ar")||"—",o=Je(a,"en")||"—",u=y("positions.table.actions.edit","✏️ تعديل"),l=y("positions.table.actions.delete","🗑️ حذف");return`
      <tr${r?' class="technician-table-row-editing"':""}>
        <td>${ne(i)}</td>
        <td>${ne(o)}</td>
        <td>${ne(s)}</td>
        <td>${ne(c)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${u}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${l}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function ga(e){e.preventDefault();const t=fa();if(t)try{const n=!!Q;n?await ea(t.id,t):await Xn(t);const a=n?y("positions.toast.updateSuccess","💾 تم حفظ بيانات المنصب"):y("positions.toast.addSuccess","✅ تم إضافة المنصب");v(a),ut(),Z(),Te(),ge()}catch(n){console.error("❌ [technicians] handlePositionSubmit failed",n);const a=n?.message||y("positions.toast.saveFailed","⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى");v(a,"error")}}function ya(){ut()}async function ha(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await He();const a=te().find(r=>String(r.id)===String(n));if(!a){v(y("positions.toast.notFound","⚠️ تعذر العثور على بيانات المنصب"),"error");return}ma(a),Z();return}if(t.classList.contains("position-delete-btn")){if(!confirm(y("positions.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا المنصب؟")))return;await ta(n),Q&&String(Q)===String(n)&&ut(),v(y("positions.toast.deleteSuccess","🗑️ تم حذف المنصب")),Z(),Te(),ge()}}catch(t){console.error("❌ [technicians] handlePositionsTableClick failed",t);const n=t?.message||y("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");v(n,"error")}}function ba(e){const t=Xt().find(n=>String(n.id)===String(e));if(!t){v(y("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}sa(t),v(y("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function _a(e){if(!Ht()){On();return}if(confirm(y("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await Kn(e),v(y("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),D&&String(D)===String(e)&&Oe(),x()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=je(t)?t.message:y("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");v(n,"error")}}function Si(){lt(),x()}function rn(e){return Xt().find(t=>String(t.id)===String(e))||null}function sn(e,t=[],n){const a=Bt(e);return a?t.some(r=>{if(!r||!r.start||!r.end||!(Array.isArray(r.technicians)?r.technicians:[]).some(o=>Bt(o)===a))return!1;const c=new Date(r.start),i=new Date(r.end);return Number.isNaN(c.getTime())||Number.isNaN(i.getTime())?!1:c<=n&&n<i}):!1}function cn(){const e=O().reservations||[],t=Ot();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const r=t.map(s=>{if(!s)return s;const c=s.baseStatus||s.status||"available";let i=c==="busy"?"busy":c;return sn(s.id,e,n)&&(i="busy"),(i!==s.status||c!==s.baseStatus)&&(a=!0),{...s,baseStatus:c,status:i}});return a?(ke(r),r):t}function lt(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{oa(p).catch(g=>{console.error("❌ [technicians] submit handler failed",g)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",ua),n.dataset.listenerAttached="true"),pe(document.getElementById("technician-phone"),fe);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{ge()}),a.dataset.listenerAttached="true");const r=document.getElementById("technicians-table");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",p=>{const g=p.target;if(g instanceof HTMLElement){if(g.classList.contains("technician-edit-btn")){const m=g.dataset.id;ba(m)}if(g.classList.contains("technician-delete-btn")){const m=g.dataset.id;_a(m).catch(f=>{console.error("❌ [technicians] delete handler failed",f)})}}}),r.dataset.listenerAttached="true");const s=document.getElementById("search-technician-input");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=A(s.value),x()}),s.dataset.listenerAttached="true");const c=document.getElementById("technician-role-filter");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{x()}),c.dataset.listenerAttached="true");const i=document.getElementById("save-technician-changes");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",()=>{pa().catch(p=>{console.error("❌ [technicians] modal save failed",p)})}),i.dataset.listenerAttached="true");const o=document.getElementById("position-form");o&&!o.dataset.listenerAttached&&(o.addEventListener("submit",p=>{ga(p).catch(g=>{console.error("❌ [technicians] position submit failed",g)})}),o.dataset.listenerAttached="true");const u=document.getElementById("position-cancel-btn");u&&!u.dataset.listenerAttached&&(u.addEventListener("click",ya),u.dataset.listenerAttached="true");const l=document.getElementById("positions-table");l&&!l.dataset.listenerAttached&&(l.addEventListener("click",ha),l.dataset.listenerAttached="true"),pe(document.getElementById("position-cost"),R),pe(document.getElementById("position-client-price"),R);const d=document.querySelector("[data-tech-tabs]");d&&!d.dataset.listenerAttached&&(d.querySelectorAll("[data-tech-tab]").forEach(g=>{g&&g.addEventListener("click",()=>{const m=g.getAttribute("data-tech-tab");Ft(m)})}),d.dataset.listenerAttached="true"),Ft(ie),He().then(()=>{Te(),ie==="technicians-positions"&&Z(),ge()}).catch(p=>{console.error("❌ [technicians] failed to load technician positions",p),v(p?.message||y("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}),qt||(document.addEventListener("technician:prefill",p=>{const g=p.detail;g&&la(g)}),qt=!0),t&&Oe(),ie==="technicians-positions"&&Z()}window.addEventListener("DOMContentLoaded",()=>{lt(),x(),ot(),Zt()});const on=()=>{x()};window.addEventListener("technicians:updated",on);document.addEventListener("technicians:updated",on);document.addEventListener("technicians:refreshRequested",()=>{lt(),x(),ot(),Zt({showToastOnError:!1})});document.addEventListener("language:changed",()=>{ot(),Te(),ie==="technicians-positions"&&Z(),ge()});document.addEventListener(Hn.USER_UPDATED,()=>{x()});const un=()=>{Te(),ie==="technicians-positions"&&Z(),ge()};window.addEventListener("technicianPositions:updated",un);document.addEventListener("technicianPositions:updated",un);function Se(e){return A(String(e||"")).trim().toLowerCase()}function H(e){const t=String(e??"").trim().toLowerCase();return t||""}function ln(){const{packages:e=[]}=O();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function De(e){const t=H(e);return t&&ln().find(a=>H(a?.id??a?.packageId??a?.package_id)===t)||null}function re(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(i=>({barcode:i}))),n.forEach(i=>{if(!i)return;if(typeof i=="string"||typeof i=="number"){const p=Se(i);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof i!="object")return;const o=Se(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number),u=[i.equipmentId,i.equipment_id,i.itemId,i.item_id,i.id].find(p=>p!=null&&p!==""),l=[i.unit_price,i.unitPrice,i.price,i.daily_rate].find(p=>Number.isFinite(Number(p))),d=[i.quantity,i.qty,i.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:u!=null?String(u):null,barcode:i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??"",normalizedBarcode:o,qty:d!=null?Number(d):1,price:l!=null?Number(l):0,desc:i.description??i.desc??i.name??"",image:i.image??i.imageUrl??i.img??null})});const a=new Map,{equipment:r=[]}=O()||{},s=new Map,c=new Map;return(Array.isArray(r)?r:[]).forEach(i=>{if(!i||typeof i!="object")return;[i.id,i.equipment_id,i.equipmentId,i.item_id,i.itemId].map(l=>l!=null?String(l):"").filter(Boolean).forEach(l=>{s.has(l)||s.set(l,i)});const u=Se(i.barcode);u&&!c.has(u)&&c.set(u,i)}),t.forEach(i=>{if(i.equipmentId&&s.has(i.equipmentId)){const o=s.get(i.equipmentId);if(o){if(i.desc||(i.desc=o.desc||o.description||o.name||""),i.barcode||(i.barcode=o.barcode||""),i.price==null||i.price===0){const u=o.price??o.unit_price,l=Number(u);Number.isFinite(l)&&l>=0&&l<1e6&&(i.price=l)}i.image||(i.image=o.image||o.imageUrl||o.img||null)}}else if(i.normalizedBarcode&&c.has(i.normalizedBarcode)){const o=c.get(i.normalizedBarcode);if(o){if(i.desc||(i.desc=o.desc||o.description||o.name||""),i.barcode||(i.barcode=o.barcode||""),i.price==null||i.price===0){const u=o.price??o.unit_price,l=Number(u);Number.isFinite(l)&&l>=0&&l<1e6&&(i.price=l)}i.image||(i.image=o.image||o.imageUrl||o.img||null)}}}),t.forEach(i=>{const o=i.normalizedBarcode||(i.barcode?Se(i.barcode):""),u=o||(i.equipmentId?`id:${i.equipmentId}`:null);if(!u)return;if(!a.has(u)){a.set(u,{...i,normalizedBarcode:o});return}const l=a.get(u);l.qty+=i.qty,!l.price&&i.price&&(l.price=i.price),!l.desc&&i.desc&&(l.desc=i.desc),!l.image&&i.image&&(l.image=i.image)}),Array.from(a.values())}function Aa(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const a of t){const r=Number(a);if(Number.isFinite(r))return r}return re(e).reduce((a,r)=>a+(r.price||0)*(r.qty||1),0)}function Ia(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Sa(){return ln().map(t=>{const n=H(t?.id??t?.packageId??t?.package_id??t?.code),a=Ia(t)||n||"package",r=Aa(t);return{id:n,name:a,price:r,code:t?.package_code??t?.code??n,items:re(t),raw:t}}).filter(t=>t.id)}function va(e){const t=Se(e);return t?Sa().filter(n=>n.items.some(a=>a.normalizedBarcode===t)):[]}function Pa(e){return re(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let ye=[],dn=[],pn=[],mn="single";function vi(){return ye}function Pi(e){ye=Array.isArray(e)?e:[]}function Ni(e){ye=[...ye,e]}function ki(e){Number.isInteger(e)&&e>=0&&(ye=ye.filter((t,n)=>n!==e))}function Ti(){return dn}function Ei(e){dn=Array.isArray(e)?e:[]}function qi(){return pn}function Ci(e){pn=Array.isArray(e)?e:[]}function Bi(e){}function Fi(){return mn==="package"?"package":"single"}function Li(e){mn=e==="package"?"package":"single"}function zi(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",r=""]=n.split("T"),s=a?a.slice(0,10):"",c=r.match(/(\d{1,2}:\d{2})/);let i="";if(c){const[o="00",u="00"]=c[0].split(":");i=`${o.padStart(2,"0")}:${u.padStart(2,"0")}`}return{date:s,time:i}}function Be(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function j(e){return A(String(e||"")).trim().toLowerCase()}const Na=864e13;function G(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const r=new Date(a);if(!Number.isNaN(r.getTime()))return r}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function Di(e,t,n,a=null){if(!e||!t||!n)return!1;const r=G(t),s=G(n);if(!r||!s||r>=s)return!1;const c=j(e);if(!c)return!1;const i=O()||{},o=Array.isArray(i.reservations)?i.reservations:[],u=Array.isArray(i.maintenance)?i.maintenance:[],l=Array.isArray(i.equipment)?i.equipment:[],d=Da(l),p=pt(a);return o.some(m=>{if(!m||mt(m,p)||!m.start||!m.end)return!1;const f=G(m.start),h=G(m.end);return!f||!h||!(f<s&&h>r)?!1:Ta(m,c)})?!0:u.some(m=>{if(!Ca(m)||!Fa(m,d).has(c))return!1;const{start:h,end:_}=La(m);if(!h&&!_)return!0;const I=h??new Date(0),N=_??new Date(Na);return I<s&&N>r})}function ka(e,t,n,a=null){const r=H(e);if(!r||!t||!n)return!1;const s=G(t),c=G(n);if(!s||!c||s>=c)return!1;const i=O()||{},o=Array.isArray(i.reservations)?i.reservations:[],u=pt(a);return o.some(l=>{if(!l?.start||!l?.end||mt(l,u))return!1;const d=G(l.start),p=G(l.end);return!d||!p||!(d<c&&p>s)?!1:Ea(l,r)})}function xi(e,t,n,a=null){const r=j(e);if(!r||!t||!n)return[];const s=va(r);return s.length?s.filter(c=>ka(c.id,t,n,a)):[]}function fn(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(a=>{const r=e[a];Array.isArray(r)&&r.length&&t.push(r)}),t}function Ta(e,t){if(!t||!e||typeof e!="object")return!1;const n=j(e?.barcode);if(n&&n===t)return!0;const a=fn(e);for(const r of a)for(const s of r)if(qa(s).has(t))return!0;return!1}function Ea(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const s of n){if(!s&&s!==0)continue;const c=H(s);if(c&&c===t)return!0}const a=e.packages;if(Array.isArray(a))for(const s of a){const c=H(s);if(c&&c===t)return!0}const r=fn(e);for(const s of r)for(const c of s)if(dt(c).has(t))return!0;return!1}function qa(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const s=j(e);return s&&t.add(s),t}if(typeof e!="object")return t;const n=j(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(s=>{const c=e[s];Array.isArray(c)&&c.forEach(i=>{if(i!=null){if(typeof i=="string"||typeof i=="number"){const o=j(i);o&&t.add(o);return}if(typeof i=="object"){const o=j(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number);o&&t.add(o)}}})});const r=dt(e);return r.size&&r.forEach(s=>{const c=De(s);if(!c)return;Pa(c).forEach(o=>{const u=o.normalizedBarcode??j(o.barcode);u&&t.add(u)})}),t}function dt(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(a=>{const r=H(a);r&&t.add(r)}),e.package&&typeof e.package=="object"&&dt(e.package).forEach(r=>t.add(r)),Array.isArray(e.packages)&&e.packages.forEach(a=>{const r=H(a);r&&t.add(r)}),t}function Ca(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(za(e))return!1;for(const n of t){const a=Ba(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function Ba(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="مكتمل"||t==="مغلق"?"completed":t==="cancelled"||t==="canceled"||t==="ملغي"?"cancelled":t==="in_progress"||t==="in-progress"||t==="قيد_التنفيذ"||t==="جاري_العمل"||t==="inprogress"?"in_progress":t==="open"||t==="قيد_الصيانة"||t==="قيد_الانتظار"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("تنفيذ")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function Fa(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(c=>{const i=j(c);i&&n.add(i)});const r=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(r){const c=j(r.barcode??r.equipmentBarcode??r.code??r.serial??r.serialNumber??r.serial_number);c&&n.add(c)}return[e?.equipmentId,e?.equipment_id,r?.id,r?.equipmentId,r?.equipment_id].map(c=>c!=null?String(c):"").filter(Boolean).forEach(c=>{const i=t.get(c);if(!i)return;const o=j(i?.barcode??i?.equipmentBarcode??i?.code??i?.serial??i?.serialNumber??i?.serial_number);o&&n.add(o)}),n}function La(e){const t=Ze([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=Ze([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function za(e){return!!Ze([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function Ze(e=[]){for(const t of e){const n=G(t);if(n)return n}return null}function Da(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(r=>r!=null?String(r):"").filter(Boolean).forEach(r=>{t.has(r)||t.set(r,n)})}),t}function xa(e,t,n,a=null){if(!e||!t||!n)return!1;const r=new Date(t),s=new Date(n);if(Number.isNaN(r.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:c=[]}=O(),i=String(e),o=pt(a);return c.some(u=>{if(!u?.start||!u?.end||mt(u,o))return!1;const l=new Date(u.start),d=new Date(u.end);return Number.isNaN(l.getTime())||Number.isNaN(d.getTime())||!(l<s&&d>r)?!1:(Array.isArray(u.technicians)?u.technicians:[]).some(m=>String(m)===i)})}function pt(e){return le(e,new Set)}function mt(e,t){if(!t||t.size===0)return!1;const n=le([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function le(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(s=>le(s,t)),t;if(Array.isArray(e))return e.forEach(s=>le(s,t)),t;if(typeof e=="object"){const s=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return s.forEach(i=>{Object.prototype.hasOwnProperty.call(e,i)&&(c=!0,le(e[i],t))}),c||Object.values(e).forEach(i=>le(i,t)),t}const n=A(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],r=n.replace(/\D+/g,"");if(r){a.push(r);const s=Number.parseInt(r,10);Number.isNaN(s)||a.push(String(s))}return a.forEach(s=>{s&&t.add(s)}),t}let se=[],Y=[],J=[],xe="create",ft=()=>{},gt=()=>{};function $a(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=A(String(n)),r=Number.parseFloat(a);if(Number.isFinite(r))return r}return 0}function gn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];let n=null;for(const r of t){if(r==null||r==="")continue;const s=parseFloat(A(String(r)));if(Number.isFinite(s)){n=s;break}}if((!Number.isFinite(n)||n<=0)&&(n=$a(e)),!Number.isFinite(n)||n<=0)return"—";const a=y("technicians.table.wageSuffix","SR");return`${A(String(n))} ${a}`}function Lt(e=""){return A(String(e)).trim().toLowerCase()}function yn(e){return!se||!se.length?null:se.find(t=>String(t?.id)===String(e))||null}function Ra(e,t="create"){t==="edit"?bt(J.filter(n=>String(n)!==String(e))):ht(Y.filter(n=>String(n)!==String(e)))}function $e(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const r=y("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.");a.innerHTML=`<span class="text-muted">${r}</span>`;return}a.innerHTML=t.map(r=>{const s=yn(r)||{},c=y("reservations.crew.fallbackName","عضو الطاقم {id}").replace("{id}",r),i=s.name||c,o=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",u=gn(s),l=u!=="—"?`<small class="technician-chip-wage">💰 ${u}</small>`:"",d=y("reservations.crew.removeAria","إزالة");return`
        <span class="technician-chip" data-id="${r}">
          <span class="technician-chip-name">${i}</span>
          ${o}
          ${l}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${r}" aria-label="${d}">✖</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(r=>{r.dataset.listenerAttached||(r.addEventListener("click",()=>Ra(r.dataset.id,r.dataset.context)),r.dataset.listenerAttached="true")})}}function hn(){return xe==="edit"?J:Y}function Re(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=Lt(t?.value||""),a=new Set(hn().map(String)),s=(se||[]).filter(c=>n?Lt([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const c=y("reservations.crew.searchEmpty","لا يوجد نتائج مطابقة.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${c}</td></tr>`;return}e.innerHTML=s.map(c=>{const i=gn(c);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${c.id}" ${a.has(String(c.id))?"checked":""}>
        </td>
        <td>${c.name||"-"}</td>
        <td>${c.role||"—"}</td>
        <td>${c.department||"—"}</td>
        <td>${i}</td>
      </tr>
    `}).join("")}function Ma(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function wa(e="create"){if(e==="edit"){const i=document.getElementById("edit-res-start")?.value?.trim(),o=document.getElementById("edit-res-end")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=i?Be(i,u):null,p=o?Be(o,l):null;let g=null;const m=document.getElementById("edit-res-index")?.value;if(m!=null){const f=Number.parseInt(m,10);if(Number.isInteger(f)){const{reservations:h=[]}=O(),_=h?.[f];_&&(g=_.id??_.reservationId??null)}}return{start:d,end:p,ignoreReservationId:g}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",r=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?Be(t,a):null,c=n?Be(n,r):null;return{start:s,end:c,ignoreReservationId:null}}function he(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=hn().length;if(t){const n=y("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",A(String(t)));e.textContent=n}else e.textContent=y("technicians.picker.selectionInfo","No crew selected yet")}function ja(){const e=Ma().map(String),{start:t,end:n,ignoreReservationId:a}=wa(xe);if(t&&n){const s=e.filter(c=>xa(c,t,n,a));if(s.length>0){const c=s.map(o=>yn(o)?.name||o).join(y("reservations.list.crew.separator","، ")),i=y("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",c);s.forEach(o=>{const u=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(o))}"]`);u&&(u.checked=!1)}),v(i),he();return}}xe==="edit"?bt(e):ht(e),he();const r=document.getElementById("selectTechniciansModal");r&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(r)?.hide?.()}function zt(e="create"){xe=e;const t=cn();Array.isArray(t)&&t.length&&(se=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),Re(),he();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function Va(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>zt("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>zt("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Re(),he()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",ja),a.dataset.listenerAttached="true");const r=document.getElementById("selectTechniciansModal");r&&!r.dataset.listenerAttached&&window.bootstrap?.Modal&&(r.addEventListener("shown.bs.modal",()=>{he(),Re()}),r.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),r.dataset.listenerAttached="true"),yt()}function yt(){$e("selected-technicians-list",Y,"create"),$e("edit-selected-technicians-list",J,"edit")}function $i({onDraftChange:e,onEditChange:t}={}){ft=typeof e=="function"?e:()=>{},gt=typeof t=="function"?t:()=>{},yt(),Va()}function Ha(e=[]){se=Array.isArray(e)?e:[]}function Oa(){return[...Y]}function Ua(){return[...J]}function ht(e=[]){Y=Array.isArray(e)?e.map(String):[],$e("selected-technicians-list",Y,"create"),ft()}function bt(e=[]){J=Array.isArray(e)?e.map(String):[],$e("edit-selected-technicians-list",J,"edit"),gt()}function Ri(){ht([])}function Mi(){bt([])}function wi(e=[]){Ha(e);const t=new Set(se.map(i=>String(i.id))),n=Y.filter(i=>t.has(String(i))),a=J.filter(i=>t.has(String(i))),r=n.length!==Y.length,s=a.length!==J.length;Y=n,J=a,yt(),r&&ft(),s&&gt();const c=document.getElementById("selectTechniciansModal");c&&c.classList.contains("show")&&(Re(),he())}function Dt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),a=t.join("");return n?`${a}.${n}`:a}function bn(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=A(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),a=t.indexOf("-"),r=a!==-1&&(n===-1||a<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const s=t.includes(","),c=t.includes(".");if(s&&c){const o=t.lastIndexOf(","),u=t.lastIndexOf(".");o>u?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(s){const o=t.split(",");o.length===2&&o[1].length===3?t=o.join(""):t=t.replace(/,/g,".")}else if(c){const o=t.split(".");if(o.length===2){const[,u]=o;if(u.length===3){const l=o.join("");/^[0-9]+$/.test(l)&&(t=l)}}else o.length>2&&(t=Dt(t))}if(t=t.replace(/,/g,""),t=Dt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const i=Number.parseFloat(t);return Number.isFinite(i)?r?-i:i:Number.NaN}function z(e){return bn(e)}function F(e){const t=bn(e);if(!Number.isFinite(t))return 0;let n=t,a=0;for(;Math.abs(n)>1e5&&a<8;)n/=10,a+=1;return Number(n.toFixed(2))}function ve(e){return A(String(e??"")).trim().toLowerCase()}function _n(e=""){return A(String(e)).trim().toLowerCase()}const Qa=2;function Wa(e){const t=z(e);return Number.isFinite(t)?t.toFixed(Qa):"0.00"}function xt(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const a=Number.parseFloat(A(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(a)&&a>0)return F(a)}return 1}function Ka(e={}){const t=e?.desc||e?.description||e?.name||"",n=_n(t),a=Wa(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${a}`}function Ga(e=[]){const t=new Map;return e.forEach((n,a)=>{const r=Ka(n);if(!r)return;if(!t.has(r)){const c=n?.desc||n?.description||n?.name||"",i=_n(c),o=Rt(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(r,{key:r,description:c,normalizedDescription:i,unitPrice:o,image:u,items:[],itemIndices:[],barcodes:[]})}const s=t.get(r);s.items.push(n),s.itemIndices.push(a),n?.barcode&&s.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((a,r)=>a+xt(r),0)})).map(n=>{const a=n.quantity||0,r=n.items.reduce((u,l)=>{const d=Rt(l),p=xt(l);return u+d*p},0),s=F(r),c=z(n.unitPrice),i=Number.isFinite(c)?c:0,o=a>0?F(s/a):F(i);return{...n,quantity:a,count:a,totalPrice:s,unitPrice:o}})}function $t(e={}){return(re(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??ve(n?.barcode),qty:(()=>{const a=Number.parseFloat(A(String(n?.qty??n?.quantity??1)));return Number.isFinite(a)&&a>0?a:1})(),price:(()=>{const a=z(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(a)?a:0})()}))}function Xe(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(A(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function Ya(e={},t=[],n=null){const a=e.unit_price??e.unitPrice??e.price,r=z(a);if(Number.isFinite(r)&&r>0)return F(r);const s=e.total_price??e.totalPrice??e.total,c=z(s),i=Number.parseFloat(A(String(n)).replace(/[^0-9.]/g,"")),o=Number.isFinite(i)&&i>0?i:Xe(e);if(Number.isFinite(c)&&c>0&&o>0)return F(c/o);if(Array.isArray(t)&&t.length){const u=t.reduce((l,d)=>{const p=z(d.price??d.unit_price??d.unitPrice),g=Number.parseFloat(A(String(d.qty??d.quantity??1)).replace(/[^0-9.]/g,"")),m=Number.isFinite(g)&&g>0?g:1;return l+p*m},0);if(u>0&&o>0)return F(u/o)}return 0}function ji(e={}){const t=Array.isArray(e?.items)?e.items:[],n=Ga(t),a=new Map,r=(d,p=0,g="packages")=>{if(!d||typeof d!="object")return;const f=H(d?.package_code??d?.packageId??d?.package_id??d?.code??d?.id??d?.barcode??`pkg-${p}`)||`pkg-${p}`;if(!a.has(f)){a.set(f,{source:d,normalizedId:f,index:p,itemSource:g==="items"?d:null});return}const h=a.get(f);if(h.source||(h.source=d),g==="items"&&(h.itemSource=d,h.source&&typeof h.source=="object")){const _=Array.isArray(h.source.packageItems)&&h.source.packageItems.length>0,I=Array.isArray(d.packageItems)&&d.packageItems.length>0;!_&&I&&(h.source={...h.source,packageItems:d.packageItems}),!h.source.image&&d.image&&(h.source={...h.source,image:d.image})}};Array.isArray(e?.packages)&&e.packages.forEach((d,p)=>r(d,p,"packages")),t.forEach((d,p)=>{d&&typeof d=="object"&&(d.type==="package"||Array.isArray(d?.packageItems))&&r(d,p+a.size,"items")});const s=[],c=new Set,i=new Set;a.forEach(({source:d,itemSource:p=null,normalizedId:g},m)=>{const f=d||{},h=p&&typeof p=="object"?p:null;let _=$t(f);(!Array.isArray(_)||_.length===0)&&h&&(_=$t(h)),_.forEach(S=>{const q=S?.normalizedBarcode??ve(S?.barcode);q&&c.add(q);const ee=S?.equipmentId??S?.equipment_id??null;ee!=null&&i.add(String(ee))});let I=Xe(f);if(h){const S=Xe(h);Number.isFinite(S)&&S>0&&(I=S)}(!Number.isFinite(I)||I<=0)&&(I=1);let N=Ya(f,_,I);const T=[h?.price,h?.unit_price,h?.unitPrice];for(const S of T){const q=z(S);if(Number.isFinite(q)&&q>0){N=F(q);break}}N=F(N);const B=[h?.total,h?.total_price,h?.totalPrice,f?.total,f?.total_price,f?.totalPrice];let P=NaN;for(const S of B){const q=z(S);if(Number.isFinite(q)&&q>=0){P=q;break}}Number.isFinite(P)||(P=N*I),P=F(P);const E=f?.package_code??f?.packageId??f?.package_id??f?.barcode??h?.package_code??h?.packageId??h?.package_id??h?.barcode??null;if(E){const S=ve(E);S&&c.add(S)}const $=_.map(S=>A(String(S?.barcode??S?.normalizedBarcode??""))).filter(Boolean),w=[f?.name,f?.package_name,f?.title,h?.name,h?.desc,h?.package_name,A(String(E??m))].find(S=>S!=null&&String(S).trim()!=="")||A(String(E??m)),X=_.find(S=>S?.image)?.image??f?.image??h?.image??null;s.push({key:`package::${m}`,description:w,normalizedDescription:A(String(w)),unitPrice:N,totalPrice:P,quantity:I,count:I,image:X,barcodes:$,barcode:E,package_code:E,items:[{type:"package",packageItems:_,packageId:g,desc:w,price:N,qty:I,barcode:E}],type:"package",packageItems:_,packageId:g})});const o=new Set(Array.from(c).map(d=>ve(d)).filter(Boolean)),u=n.filter(d=>!(d.items.some(m=>m?.type==="package")&&s.length>0||d.items.every(m=>{const f=Ja(m),h=f!=null?String(f):null;if(h&&i.has(h))return!0;const _=m?.barcode?ve(m.barcode):null;return!!(_&&o.has(_))})));return{groups:s.length?[...s,...u]:n,packageGroups:s,groupedItems:n,filteredGroupedItems:u,packagesMap:a}}function Ja(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function Rt(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const a=z(n);if(Number.isFinite(a))return a}return 0}function Vi(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Za(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function Hi(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,r=a!=null&&a!==""&&a!=="null",s=r?Za(t?.status??t?.status_label??t?.statusLabel??""):null,c=r&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:n,projectLinked:r,projectStatus:s,projectConfirmed:c,effectiveConfirmed:r?c:n}}const An=10;function In(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=z(n);if(Number.isFinite(a))return F(a)}return 0}function Xa(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=z(n);if(Number.isFinite(a))return F(a)}return In(e)}function ei(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=O();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,r)=>{const s=n.get(String(r));if(!s)return a;const c=In(s),i=Xa(s);return{costPerDay:a.costPerDay+(Number.isFinite(c)?c:0),totalPerDay:a.totalPerDay+(Number.isFinite(i)?i:0)}},{costPerDay:0,totalPerDay:0})}const ti=1440*60*1e3,de=.01;function ue(e){if(e==null||e==="")return null;const t=A(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Mt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let r=Number.isFinite(e)?e:0;if(r<t&&(r=t),r>n&&(r=n),a!=null){const s=10**a;r=Math.round(r*s)/s}return r}function Sn(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function _t({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:r=null,history:s=[]}={}){const c=Number.isFinite(Number(e))?Number(e):0,i=t==="amount"?"amount":t==="percent"?"percent":null;let o=ue(a),u=ue(r);const l=ue(n);let d=0,p=0;Array.isArray(s)&&s.length&&s.forEach(_=>{if(!_)return;const I=_.type==="amount"||_.type==="percent"?_.type:null,N=ue(_.value),T=ue(_.amount),B=ue(_.percentage);if(I==="amount"){const P=T??N;P!=null&&(d+=P,c>0&&(p+=P/c*100))}else if(I==="percent"){const P=B??N;P!=null&&(p+=P,c>0&&(d+=P/100*c))}else T!=null&&(d+=T,c>0&&(p+=T/c*100)),B!=null&&(p+=B,c>0&&(d+=B/100*c))}),i==="amount"&&l!=null?o=l:i==="percent"&&l!=null?u=l:i===null&&l!=null&&(u!=null?u=l:o=l),(o==null||o<=0)&&u!=null&&u>0&&c>0&&(o=c*(u/100)),(u==null||u<=0)&&o!=null&&o>0&&c>0&&(u=o/c*100);const g=o??0,m=u??0;o=g+d,u=m+p,o=Mt(o??0,{min:0,max:c>0?c:Number.POSITIVE_INFINITY,precision:2}),u=Mt(u??0,{min:0,max:100,precision:2});let f=i;return f||(o>0&&c>0?f="amount":u>0&&(f="percent")),{paidAmount:o,paidPercent:u,paymentProgressType:f,paymentProgressValue:f==="amount"?o:f==="percent"?u:null}}function At({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const r=Sn(e),s=Number.isFinite(Number(a))?Number(a):0,c=Number.isFinite(Number(t))?Number(t):0,i=Number.isFinite(Number(n))?Number(n):0;if(r==="paid")return"paid";const o=s>0&&c>=s-de,u=i>=100-de*100;if(o||u)return"paid";const l=c>de||i>de;return r==="partial"||l?"partial":"unpaid"}function ni(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const r=a.getTime()-n.getTime();if(r<=0)return 1;const s=r/ti;return Math.max(1,Math.ceil(s))}function be({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:r=!1,start:s=null,end:c=null,companySharePercent:i=null}={}){const o=ni(s,c),u=(e||[]).reduce((X,S)=>{const q=z(S?.qty??S?.quantity??S?.count??1),ee=Number.isFinite(q)&&q>0?q:1,C=z(S?.price??S?.unit_price??S?.unitPrice),We=Number.isFinite(C)?C:0;return X+ee*We},0),l=F(u*o),{costPerDay:d,totalPerDay:p}=ei(t),g=F(p*o),m=F(d*o),f=F(l+g),h=Number(n)||0;let _=a==="amount"?h:f*(h/100);(!Number.isFinite(_)||_<0)&&(_=0),_>f&&(_=f);const I=Math.max(0,f-_);let N=Number.isFinite(i)?Number(i):null;r&&(!Number.isFinite(N)||N<=0)&&(N=An);const T=N&&N>0?N:0,B=T>0?Math.max(0,I*(T/100)):0,P=I+B;let E=r?P*.15:0;(!Number.isFinite(E)||E<0)&&(E=0),E=Number(E.toFixed(2));const $=P+E,b=Math.max(0,Number($.toFixed(2))),w=Math.max(0,Math.max(0,l+g-_)-m);return{rentalDays:o,equipmentTotal:l,crewTotal:g,crewCostTotal:m,discountAmount:_,subtotalAfterDiscount:I,taxableAmount:P,taxAmount:E,finalTotal:b,companySharePercent:T,companyShareAmount:B,netProfit:w}}function Oi(e=[],t=0,n="percent",a=!1,r=[],{start:s=null,end:c=null,companySharePercent:i=null}={}){return be({items:e,technicianIds:r,discount:t,discountType:n,applyTax:a,start:s,end:c,companySharePercent:i}).finalTotal}function vn({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:r,paymentStatus:s,paidAmount:c=0,paidPercent:i=0,companySharePercent:o=null,companyShareAmount:u=null,taxAmount:l=null,netProfit:d=null,totalKey:p="reservations.summary.total"}){const g=y("reservations.create.summary.currency","SR"),m=A(String(e)),f=A(String(t)),h=A(String(n??1)),_=A(String(a)),I=Sn(s),N=I==="paid"?"مدفوع":I==="partial"?"مدفوع جزئياً":"غير مدفوع",T=y(`reservations.create.paymentStatus.${I}`,N),B=Number.isFinite(Number(c))?Math.max(0,Number(c)):0,P=Number.isFinite(Number(i))?Math.max(0,Number(i)):0,E=B>de||P>de,$=y("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),b=A(B.toFixed(2)),w=A(P.toFixed(P%1?2:0)),X=y("reservations.summary.itemsLabel","📦 عدد المعدات"),S=y("reservations.summary.durationLabel","⏱️ عدد الأيام"),q=y("reservations.summary.crewLabel","😎 عدد الفريق"),ee=y("reservations.summary.taxLabelShort","🧾 الضريبة"),C=y("reservations.summary.paymentLabelShort","💳 حالة الدفع"),We=y(p.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),Ln=y("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),zn=y("reservations.details.labels.netProfit","💵 صافي الربح"),Ke=Number.isFinite(d)?Math.max(0,Number(d)):null,oe=[{label:X,value:f},{label:S,value:h},{label:q,value:_}];if(r){let K=y("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(l)&&l>0&&(K=`${A(Number(l).toFixed(2))} ${g}`),oe.push({label:ee,value:K})}const qe=Number.isFinite(o)?Number(o):null;if(qe!==null&&qe>0){const K=Number.isFinite(u)?Number(u):e*(qe/100),_e=A(String(qe)),xn=A(Number.isFinite(K)?K.toFixed(2):"0"),$n=`${_e}% (${xn} ${g})`;oe.push({label:Ln,value:$n})}if(Ke!==null&&Math.abs(Ke-Number(e))>.009){const K=A(Ke.toFixed(2));oe.push({label:zn,value:`${K} ${g}`})}oe.push({label:C,value:T}),E&&oe.push({label:$,value:`${b} ${g} (${w}%)`});const Dn=`${m} ${g}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${oe.map(({label:K,value:_e})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${K}</span>
            ${_e?`<span class="reservation-summary-value">${_e}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${We}</span>
          <span class="reservation-summary-value">${Dn}</span>
        </div>
      </div>
    </div>
  `}function ai({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:r,paymentProgressType:s=null,paymentProgressValue:c=null,start:i,end:o,companySharePercent:u=null,paymentHistory:l=[]}){const d=Oa(),p=d.length,g=Number.isFinite(u)?Number(u):null,m=be({items:e,technicianIds:d,discount:t,discountType:n,applyTax:a,start:i,end:o,companySharePercent:g}),f=_t({totalAmount:m.finalTotal,progressType:s,progressValue:c,history:l}),h=At({manualStatus:r,paidAmount:f.paidAmount,paidPercent:f.paidPercent,totalAmount:m.finalTotal}),_=vn({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:p,applyTax:a,paymentStatus:h,paidAmount:f.paidAmount,paidPercent:f.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit}),I={paymentStatus:h,paidAmount:f.paidAmount,paidPercent:f.paidPercent,paymentProgressType:f.paymentProgressType,paymentProgressValue:f.paymentProgressValue,total:m.finalTotal};return ai.lastResult=I,ri(_),_}function ii({items:e,discount:t,discountType:n,applyTax:a,paidStatus:r,paymentProgressType:s=null,paymentProgressValue:c=null,start:i,end:o,companySharePercent:u=null,paymentHistory:l=[]}){const d=Ua(),p=d.length,g=Number.isFinite(u)?Number(u):null,m=be({items:e,technicianIds:d,discount:t,discountType:n,applyTax:a,start:i,end:o,companySharePercent:g}),f=_t({totalAmount:m.finalTotal,progressType:s,progressValue:c,history:l}),h=At({manualStatus:r,paidAmount:f.paidAmount,paidPercent:f.paidPercent,totalAmount:m.finalTotal}),_=vn({total:m.finalTotal,itemsCount:e.length,rentalDays:m.rentalDays,techniciansCount:p,applyTax:a,paymentStatus:h,paidAmount:f.paidAmount,paidPercent:f.paidPercent,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,taxAmount:m.taxAmount,netProfit:m.netProfit,totalKey:"reservations.summary.totalAfterEdit"}),I={html:_,paymentStatus:h,paidAmount:f.paidAmount,paidPercent:f.paidPercent,paymentProgressType:f.paymentProgressType,paymentProgressValue:f.paymentProgressValue,total:m.finalTotal};return ii.lastResult=I,_}function ri(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,wt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,wt(n,e))}function wt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const si=O()||{};let U=(si.reservations||[]).map(ui);function Ie(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const Pn="__reservation_packages_cache__";function Nn(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function kn(){const e=Nn();if(!e)return{};try{const t=e.getItem(Pn);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function jt(e){const t=Nn();if(t)try{t.setItem(Pn,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function Tn(e=[]){return Array.isArray(e)?e.map((t,n)=>Fn(t,n)).filter(Boolean).map((t,n)=>{const a=H(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),r=Me(t,a).map(u=>{const l=L(u.qty??u.quantity??u.count??u.units??u.unit_qty??u.unitQty??u.unit_count??u.unitCount??u.package_quantity??u.packageQty??1),d=Ie(k(u.price??u.unit_price??0));return{...u,qty:l,quantity:l,price:d,unit_price:d}}),s=L(t.quantity??t.qty??1);let c=Ie(k(t.unit_price??t.unitPrice??t.price??0));if(!c||c<=0){const u=r.reduce((l,d)=>l+(d.price||0)*(d.qty||1),0);u>0&&s>0&&(c=Ie(Number((u/s).toFixed(2))))}const i=k(t.total_price??t.totalPrice??t.total??c*s),o=i>0?Ie(i):Ie(Number((c*s).toFixed(2)));return{...t,packageId:a,package_id:a,qty:s,quantity:s,unit_price:c,unitPrice:c,price:c,total_price:o,total:o,packageItems:r}}):[]}function Ee(e,t){if(!e)return;const n=kn(),a=String(e);if(!Array.isArray(t)||t.length===0){n[a]&&(delete n[a],jt(n));return}n[a]=Tn(t),jt(n)}function ci(e){if(!e)return[];const t=kn(),n=String(e),a=t[n];return Array.isArray(a)?Tn(a):[]}function Ui(){return U}function Qe(e){return U=Array.isArray(e)?e.map(St):[],U.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Ee(n,t.packages)}),U.length?console.debug("[reservationsService] setReservationsState first paymentHistory",U[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),Vt({reservations:U}),U}async function Qi(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([i,o])=>{o!=null&&o!==""&&t.set(i,String(o))});const n=t.toString(),r=(await M(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(r)?s=r:r&&typeof r=="object"&&(Array.isArray(r.items)?s=r.items:Array.isArray(r.results)?s=r.results:Array.isArray(r.data)?s=r.data:Array.isArray(r.records)&&(s=r.records));const c=s.map(It);return Qe(c)}async function Wi(e){const t=await M("/reservations/",{method:"POST",body:e}),n=It(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const a=vt(e.payment_history);a.length&&(n.paymentHistory=a)}if(Array.isArray(e?.packages)&&e.packages.length){const a=kt({packages:e.packages});n.packages=ce(n.packages,a)}{const a=Nt(n.items||[],n.packages||[]);n.items=a.items,n.packages=ce(n.packages||[],a.packages)}if(Ee(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const a=be({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=a.companyShareAmount,n.cost=a.finalTotal,n.totalAmount=a.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Qe([...U,n]),n}async function oi(e,t){const n=await M(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=It(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const s=vt(t.payment_history);s.length&&(a.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if(Array.isArray(t?.packages)&&t.packages.length){const s=kt({packages:t.packages});a.packages=ce(a.packages,s)}{const s=Nt(a.items||[],a.packages||[]);a.items=s.items,a.packages=ce(a.packages||[],s.packages)}if(Ee(a.id??a.reservationId??a.reservation_code??e,a.packages),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const s=be({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=s.companyShareAmount,a.cost=s.finalTotal,a.totalAmount=s.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const r=U.map(s=>String(s.id)===String(e)?a:s);return Qe(r),a}async function Ki(e){await M(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=U.filter(n=>String(n.id)!==String(e));Qe(t),Ee(e,null)}async function Gi(e){return oi(e,{status:"confirmed",confirmed:!0})}function It(e={}){return St({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function ui(e={}){return St(e)}function St(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let a=Array.isArray(e.items)?e.items.map(li):[],r=kt(e);const s=Array.isArray(e.technicians)?e.technicians:[],c=s.map(C=>C==null?null:String(typeof C=="object"?C.id??C.technician_id??C.technicianId??C.ID??"":C)).filter(C=>C&&C!==""),i=e.start??e.start_datetime??"",o=e.end??e.end_datetime??"";let u=k(e.total_amount??e.totalAmount??e.cost??0);const l=k(e.discount??0),d=e.discount_type??e.discountType??"percent",p=["percent","amount"].includes(d)?d:"percent",g=!!(e.apply_tax??e.applyTax??!1);let m=hi(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const f=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),h=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,_=h!=null?Number.parseFloat(A(String(h).replace("%","").trim())):NaN,I=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let N=I!=null?I===!0||I===1||I==="1"||String(I).toLowerCase()==="true":Number.isFinite(_)&&_>0,T=N&&Number.isFinite(_)?Number(_):0;const B=e.company_share_amount??e.companyShareAmount;let P=Number.isFinite(Number(B))?Number(B):NaN;g&&T<=0&&(T=An,N=!0);const E=be({items:a,technicianIds:c,discount:l,discountType:p,applyTax:g,start:i,end:o,companySharePercent:T>0?T:null});(!Number.isFinite(u)||u<=0||g)&&(u=E.finalTotal),(!Number.isFinite(P)||P<0)&&(P=E.companyShareAmount),P=Number.isFinite(P)?Number(P.toFixed(2)):0,!N&&T>0&&(N=!0);const $=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],b=di($),w=vt(b),X=t??n??e.reservation_code??e.reservationId??null;if(r.length)Ee(X,r);else{const C=ci(X);C.length&&(r=ce(r,C))}const S=Nt(a,r);a=S.items,r=ce(r,S.packages);const q=_t({totalAmount:u,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:w});m=At({manualStatus:m,paidAmount:q.paidAmount,paidPercent:q.paidPercent,totalAmount:u});const ee=m==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:i,end:o,status:yi(e.status??(f?"confirmed":"pending")),confirmed:f,location:e.location??"",notes:e.notes??"",discount:l,discountType:p,applyTax:g,paid:ee,paidStatus:m,paidAmount:q.paidAmount,paidPercent:q.paidPercent,paymentProgressType:q.paymentProgressType,paymentProgressValue:q.paymentProgressValue,paymentHistory:w,payment_history:w,totalAmount:u,cost:u,projectId:e.project_id??e.projectId??null,items:a,technicians:c,techniciansDetails:s.map(C=>typeof C=="object"?C:{id:Number(C)||C}),startDatetime:i,endDatetime:o,customerPhone:e.customer_phone??e.customerPhone??null,packages:r,companySharePercent:T,companyShareAmount:P,companyShareEnabled:N}}function li(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=L(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=k(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),r=A(String(e.barcode??e.code??e.serial??"")),s=e.description??e.desc??e.name??e.title??"",c={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:r,desc:s,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:a,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},i=En(e.type??e.item_type??e.kind??null),o=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=W(o),l=Me(e,u);if(i==="package"||u||l.length){c.type="package";const d=u||(t!=null?String(t):c.id?W(c.id):"");d&&(c.packageId=d,c.package_id=d,c.package_code=e.package_code??e.packageCode??d),c.name=s||c.package_code||d||"",c.barcode=c.barcode||A(String(e.package_code??e.packageCode??"")),c.packageItems=l;const p=Cn({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},l,n);(!Number.isFinite(c.price)||c.price<=0||c.price>p*10)&&(c.price=p),c.qtyPerPackage=l.length?l[0]?.qtyPerPackage??c.qtyPerPackage:c.qtyPerPackage,c.totalQuantity=n}return c}function Yi({reservationCode:e,customerId:t,start:n,end:a,status:r,title:s,location:c,notes:i,projectId:o,totalAmount:u,discount:l,discountType:d,applyTax:p,paidStatus:g,confirmed:m,items:f,packages:h,technicians:_,companySharePercent:I,companyShareEnabled:N,paidAmount:T,paidPercentage:B,paymentProgressType:P,paymentProgressValue:E,paymentHistory:$}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:r??"pending",title:s??null,location:c??null,notes:i??null,project_id:o||null,total_amount:u??0,discount:l??0,discount_type:d??"percent",apply_tax:p?1:0,paid_status:g??"unpaid",paid_amount:Number.isFinite(T)?k(T):0,paid_percentage:Number.isFinite(B)?Number(B.toFixed(2)):0,payment_progress_type:P??null,payment_progress_value:Number.isFinite(E)?Number(E.toFixed(2)):null,payment_history:Array.isArray($)?$.map(b=>({type:et(b?.type??b?.payment_type??b?.method??b?.paymentMethod),value:b?.value!=null?k(b.value):null,amount:b?.amount!=null?k(b.amount):b?.payment_amount!=null?k(b.payment_amount):null,percentage:b?.percentage!=null?Number(b.percentage):b?.payment_percentage!=null?Number(b.payment_percentage):null,note:b?.note??b?.notes??b?.comment??b?.payment_note??null,recorded_at:b?.recordedAt??b?.recorded_at??b?.createdAt??b?.created_at??b?.payment_date??b?.date??new Date().toISOString()})):[],payments:Array.isArray($)?$.map(b=>({type:et(b?.type??b?.payment_type??b?.method??b?.paymentMethod),value:b?.value!=null?k(b.value):null,amount:b?.amount!=null?k(b.amount):b?.payment_amount!=null?k(b.payment_amount):null,percentage:b?.percentage!=null?Number(b.percentage):b?.payment_percentage!=null?Number(b.payment_percentage):null,note:b?.note??b?.notes??b?.comment??b?.payment_note??null,recorded_at:b?.recordedAt??b?.recorded_at??b?.createdAt??b?.created_at??b?.payment_date??b?.date??new Date().toISOString()})):[],confirmed:m===void 0?null:!!m,items:pi(f),packages:mi(f,h),company_share_percent:N&&Number.isFinite(I)?Number(I):null,company_share_enabled:N?1:0,technicians:Array.isArray(_)?_.map(b=>typeof b=="object"&&b!==null?{id:b.id??b.technician_id??b.technicianId??b.ID,role:b.role??null,notes:b.notes??null}:Number.isNaN(Number(b))?String(b):Number(b)):[]}}function vt(e){const t=Pt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const a=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,r=et(a),s=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,c=s!=null?Number.parseFloat(A(String(s))):null,i=n.amount!=null?Number.parseFloat(A(String(n.amount))):n.payment_amount!=null?Number.parseFloat(A(String(n.payment_amount))):null,o=n.percentage!=null?Number.parseFloat(A(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(A(String(n.payment_percentage))):null,u=Number.isFinite(i)?i:r==="amount"&&Number.isFinite(c)?c:null,l=Number.isFinite(o)?o:r==="percent"&&Number.isFinite(c)?c:null,d=r??(u!=null?"amount":l!=null?"percent":null),p=d==="amount"?u:d==="percent"?l:Number.isFinite(c)?c:null,g=n.note??n.notes??n.comment??n.payment_note??null,m=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:p,amount:u,percentage:l,note:g,recordedAt:m}}).filter(n=>n&&n.type)}function et(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Pt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const c of t)if(Array.isArray(e[c]))return e[c];const a=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(c=>Array.isArray(c));if(Array.isArray(a))return a;const r=Object.values(e);if(r.length&&r.every(c=>c&&typeof c=="object")){const c=r.map(i=>i);if(c.every(i=>!Array.isArray(i)))return c}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(c=>c in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Pt(t)}catch{return[]}return[]}function di(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Pt(t);if(Array.isArray(n)&&n.length)return n}return[]}function pi(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const r=L(n.qty??n.quantity??1);n.packageItems.forEach(s=>{const c=s?.equipmentId??s?.equipment_id??s?.id??null;if(c==null)return;const i=L(s?.qty??s?.quantity??1),o=r*i;t.push({equipment_id:tt(c),quantity:o,unit_price:k(s?.price??s?.unit_price??0),notes:s?.notes??null})});return}const a=n.equipmentId??n.equipment_id??n.id??null;a!=null&&t.push({equipment_id:tt(a),quantity:L(n.qty??n.quantity??1),unit_price:k(n.price??n.unit_price??0),notes:n.notes??null})}),t}function tt(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function mi(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(a=>{if(!a||typeof a!="object"||a.type!=="package")return;const r=L(a.qty??a.quantity??1),s=Array.isArray(a.packageItems)?a.packageItems.map(c=>{const i=c?.equipmentId??c?.equipment_id??c?.id??null;return i==null?null:{equipment_id:tt(i),quantity:L(c?.qty??c?.quantity??c?.count??c?.units??c?.unit_qty??c?.unitQty??c?.unit_count??c?.unitCount??c?.package_quantity??c?.packageQty??1),unit_price:k(c?.price??c?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:a.packageId??a.package_id??a.barcode??null,name:a.desc??a.name??"",quantity:r,unit_price:k(a.price??a.unit_price??0),items:s})}),n}function En(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function W(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return H(t)}function Ne(e){return e==null?"":A(String(e)).trim().toLowerCase()}function qn(e={},t=1){if(!e||typeof e!="object"){const o=A(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:o,normalizedBarcode:Ne(o),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,a=L(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),r=k(e.unit_price??e.unitPrice??e.price??0),s=A(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),c=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let i;if(c!=null)i=L(c,{fallback:1,max:99});else if(t>0){const o=a/t;Number.isFinite(o)&&o>0&&Number.isInteger(o)?i=L(o,{fallback:1,max:99}):i=Math.min(a,99)}else i=Math.min(a,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:i,quantity:i,qtyPerPackage:i,totalQuantity:a,price:r,unit_price:r,barcode:s,normalizedBarcode:Ne(e.normalizedBarcode??s),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function nt(e={},t={}){const n=W(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),a=L(e.quantity??e.qty??t.qty??t.quantity??1,{fallback:1,max:9999}),r=k(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),s=A(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:s,desc:t.desc??t.description??e.name??e.desc??e.title??s,qty:a,quantity:a,price:r,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:s,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function Nt(e=[],t=[]){let n=Array.isArray(t)?[...t]:[],a=Array.isArray(e)?[...e]:[];if(!n.length){const o=fi(a);o.packages.length&&(n=ce(n,o.packages),a=o.items)}if(!n.length)return{items:a,packages:n};const r=new Map,s=new Set;n.forEach(o=>{const u=W(o.packageId??o.package_id??o.id);u&&(r.set(u,o),Array.isArray(o.packageItems)&&o.packageItems.forEach(l=>{const d=Ne(l?.barcode??l?.normalizedBarcode??"");d&&s.add(d)}))});const c=[],i=new Set;return a.forEach(o=>{const u=W(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(u&&r.has(u)){i.has(u)||(c.push(nt(r.get(u),o)),i.add(u));return}const l=Ne(o.barcode);s.has(l)||c.push(o)}),r.forEach((o,u)=>{i.has(u)||(c.push(nt(o)),i.add(u))}),{items:c,packages:n}}function fi(e=[]){const t=new Map;if(e.forEach(s=>{const c=W(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(!c)return;const i=c;t.has(i)||t.set(i,{base:s,items:[]}),t.get(i).items.push(s)}),!t.size)return{items:e,packages:[]};const n=[],a=[],r=new Set;return e.forEach(s=>{const c=W(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(c&&t.has(c)){if(r.has(c))return;const i=t.get(c),o=i.base||s,u=i.items.map(d=>qn(d,1)),l={packageId:c,package_id:c,package_code:o.package_code??o.packageCode??o.barcode??A(String(c)),name:o.package_name??o.packageName??o.desc??o.name??`Package ${c}`,quantity:L(o.package_quantity??o.packageQty??o.qty??1,{fallback:1,max:9999}),unit_price:k(o.package_price??o.packagePrice??o.price??0),packageItems:u,image:o.image??null};a.push(l),n.push(nt(l,o)),r.add(c);return}n.push(s)}),{items:n,packages:a}}function Me(e={},t=""){if(!e||typeof e!="object")return[];const n=W(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),a=[];Array.isArray(e.packageItems)&&a.push(...e.packageItems),Array.isArray(e.package_items)&&a.push(...e.package_items),Array.isArray(e.items)&&a.push(...e.items),Array.isArray(e.equipment)&&a.push(...e.equipment),Array.isArray(e.contents)&&a.push(...e.contents);let r=re({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:a,packageItems:a}),s=[];if((!Array.isArray(r)||r.length===0)&&n){const u=De(n);u&&(r=re(u),s=Array.isArray(r)?r:[])}else if(n){const u=De(n);u&&(s=re(u)||[])}if(!Array.isArray(r)||r.length===0)return[];const c=L(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),i=r.map(u=>qn(u,c));if(s.length){const u=new Map;s.forEach(l=>{if(!l)return;const d=Ne(l.barcode)||(l.equipmentId!=null?`id:${l.equipmentId}`:null)||(l.equipment_id!=null?`id:${l.equipment_id}`:null);d&&u.set(d,l)}),i.forEach(l=>{const d=l.normalizedBarcode||(l.equipmentId?`id:${l.equipmentId}`:null);if(!d||!u.has(d))return;const p=u.get(d),g=L(p.quantity??p.qty??1,{fallback:l.qtyPerPackage??1,max:99});l.qtyPerPackage=g,l.qty=g,l.quantity=g;const m=k(p.unit_price??p.unitPrice??p.price??l.price);l.price=m,l.unit_price=m,!l.desc&&p.desc&&(l.desc=p.desc),!l.image&&p.image&&(l.image=p.image)})}const o=new Map;return i.forEach(u=>{const l=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(l){if(o.has(l)){const d=o.get(l);d.qty+=u.qty,d.quantity+=u.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=u.qtyPerPackage),(!d.price||d.price===0)&&u.price&&(d.price=u.price,d.unit_price=u.unit_price),!d.desc&&u.desc&&(d.desc=u.desc),!d.image&&u.image&&(d.image=u.image);return}o.set(l,{...u})}}),Array.from(o.values())}function Cn(e={},t=[],n=1){if(Array.isArray(t)&&t.length){const r=t.reduce((s,c)=>{const i=Number.isFinite(Number(c.price))?Number(c.price):0,o=Number.isFinite(Number(c.qtyPerPackage))&&Number(c.qtyPerPackage)>0?Number(c.qtyPerPackage):Number.isFinite(Number(c.qty))&&Number(c.qty)>0?Number(c.qty):1;return s+i*o},0);if(r>0)return Number(r.toFixed(2))}const a=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(a))){const r=k(a);return n>0?Number((r/n).toFixed(2)):r}return Number.isFinite(Number(e.unit_price??e.unitPrice??e.price))?k(e.unit_price??e.unitPrice??e.price):0}function Bn(e,t){if(!e)return t;if(!t)return e;const n={...e},a=r=>{(n[r]===void 0||n[r]===null||n[r]==="")&&(n[r]=t[r])};return["name","desc","barcode","image"].forEach(a),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=gi(n.packageItems,t.packageItems),n.items=n.packageItems),n}function gi(e=[],t=[]){const n=new Map,a=r=>{r.forEach(s=>{if(!s)return;const c=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(c){if(n.has(c)){const i=n.get(c);i.qty+=s.qty??0,i.quantity+=s.quantity??0,(!Number.isFinite(i.qtyPerPackage)||i.qtyPerPackage<=0)&&Number.isFinite(s.qtyPerPackage)&&(i.qtyPerPackage=s.qtyPerPackage),(!i.price||i.price===0)&&s.price&&(i.price=s.price,i.unit_price=s.unit_price),!i.desc&&s.desc&&(i.desc=s.desc),!i.image&&s.image&&(i.image=s.image);return}n.set(c,{...s})}})};return a(e),a(t),Array.from(n.values())}function ce(e=[],t=[]){const n=[],a=new Map,r=s=>{Array.isArray(s)&&s.forEach(c=>{if(!c||typeof c!="object")return;const i=c.packageId||c.package_id||c.package_code||c.id;if(i)if(a.has(i)){const o=a.get(i);n[o]=Bn(n[o],c)}else a.set(i,n.length),n.push({...c})})};return r(e),r(t),n}function Fn(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const d=W(e),p=d?De(d):null,g=p?Me(p,d):[],m=p?k(p.price??p.unit_price??p.unitPrice??0):0,f=1,h=Number((m*f).toFixed(2));return{id:`package::${d||t}`,packageId:d||`pkg-${t}`,package_id:d||`pkg-${t}`,package_code:A(String(e))||d||`pkg-${t}`,name:p?.name??p?.package_name??p?.packageName??A(String(e))??"",desc:p?.name??A(String(e))??"",quantity:f,qty:f,unit_price:m,unitPrice:m,price:m,total:h,total_price:h,barcode:A(String(e)),packageItems:g,items:g,type:"package",image:p?.image??null}}if(typeof e!="object")return null;const n=W(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,a=L(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),r=Me(e,n),s=Cn(e,r,a),c=e.total_price??e.totalPrice??e.total??s*a,i=Number.isFinite(Number(c))?k(c):Number((s*a).toFixed(2)),o=e.package_code??e.packageCode??e.code??n,u=A(String(e.barcode??o??"")),l=e.image??e.cover??e.thumbnail??r.find(d=>d.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:o,name:e.name??e.package_name??e.packageName??e.title??e.description??o??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??o??n,quantity:a,qty:a,unit_price:s,unitPrice:s,price:s,total:i,total_price:i,barcode:u,packageItems:r,items:r,type:"package",image:l}}function kt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],a=new Map,r=(i,o=n.length)=>{const u=Fn(i,o);if(!u)return;const l=u.packageId||u.package_code||u.id||`pkg-${o}`;if(a.has(l)){const d=a.get(l);n[d]=Bn(n[d],u)}else a.set(l,n.length),n.push(u)};t.forEach(i=>{i.forEach((o,u)=>{r(o,u+n.length)})}),n.length===0&&e.package&&r(e.package,0);const s=Array.isArray(e.items)?e.items:[],c=(i={})=>!i||typeof i!="object"?!1:!!(En(i.type??i.item_type??i.kind??null)==="package"||i.packageItems&&Array.isArray(i.packageItems)&&i.packageItems.length||i.items&&Array.isArray(i.items)&&i.items.length&&i.items.every(u=>typeof u=="object")||i.packageId||i.package_id||i.package_code||i.packageCode||i.bundleId||i.bundle_id);return s.forEach((i,o)=>{c(i)&&r(i,n.length+o)}),n}function k(e){const t=z(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function L(e,{fallback:t=1,max:n=1e6}={}){const a=z(e);if(!Number.isFinite(a))return t;const r=Math.round(a);return r<=0||r>n?t:r}function yi(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return"pending"}}function hi(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function Ji(e){return e instanceof Le}export{qi as $,Di as A,Sa as B,Bi as C,An as D,Ti as E,ai as F,Be as G,H,Ni as I,ka as J,vi as K,xi as L,Ga as M,zi as N,De as O,Aa as P,Ia as Q,Ei as R,Ja as S,Fi as T,ki as U,Ka as V,Pi as W,Oa as X,xa as Y,Yi as Z,Wi as _,Qi as a,Ri as a0,Ci as a1,Li as a2,ji as a3,z as a4,F as a5,be as a6,Ki as a7,Gi as a8,ii as a9,Ua as aa,Mi as ab,bt as ac,ui as ad,wi as b,Ji as c,Ai as d,Hi as e,Si as f,Ui as g,re as h,$i as i,_t as j,At as k,ze as l,at as m,j as n,It as o,rn as p,ni as q,Qn as r,cn as s,_i as t,ne as u,Ii as v,Oi as w,Vi as x,oi as y,_n as z};
