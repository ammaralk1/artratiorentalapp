import{d as V,n as _,b as O,A as Oe,s as Jt,a as Wn,m as Kn,c as Gn,i as Yn,l as Jn,e as oe,t as g,f as Zn,h as S,j as Zt,o as Xn}from"./auth.js";const ei=V()||{};let fe=(ei.technicians||[]).map(nn);function Xt(){return fe}function ze(e){return fe=Array.isArray(e)?e.map(nn):[],Jt({technicians:fe}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),fe}async function ti(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,r])=>{r!=null&&r!==""&&t.set(o,String(r))});const n=t.toString(),i=await O(`/technicians/${n?`?${n}`:""}`),a=Array.isArray(i?.data)?i.data.map(mt):[];return ze(a)}async function ni(e){const t=await O("/technicians/",{method:"POST",body:e}),n=mt(t?.data??{});return ze([...fe,n]),n}async function en(e,t){const n=await O(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=mt(n?.data??{}),a=fe.map(o=>String(o.id)===String(e)?i:o);return ze(a),i}async function ii(e){await O(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ze(fe.filter(t=>String(t.id)!==String(e)))}function tn({name:e,phone:t,email:n,role:i,department:a,dailyWage:o,dailyTotal:r,status:s,notes:l,active:c=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:i??"",department:a??null,daily_wage:o??0,daily_total:r??null,status:s??"available",notes:l??null,active:c?1:0}}function mt(e={}){return an({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function nn(e={}){return an(e)}function an(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",i=e.phone??"",a=e.email??null,o=e.specialization??e.role??e.position??"",r=e.department??e.team??"",s=$t(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=$t(e.daily_total??e.dailyTotal??e.total??e.total_wage??s),c=zt(e.baseStatus??e.status??"available"),d=zt(e.status??e.baseStatus??"available"),u=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:i,email:a,role:o,department:r,dailyWage:s,dailyTotal:l,status:d,baseStatus:c,notes:u,active:p}}function $t(e){const t=Number.parseFloat(_(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function zt(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function Ye(e){return e instanceof Oe}Wn();Kn();Gn();document.addEventListener("DOMContentLoaded",()=>{Yn();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Jn()),e.dataset.listenerAttached="true")});function Qe(e){const t=Number(e)||0,i=oe()==="ar"?"ar-SA-u-nu-latn":"en-US",a=new Intl.NumberFormat(i,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${_(a)} SR`}function Fa(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function La(e){const t=new Date,n=e?.start?new Date(e.start):null,i=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":i&&!Number.isNaN(i.getTime())&&i<t?"completed":"ongoing"}function Ba(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}…`:""}function me(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const ai="technicianPositions:updated";let G=[],on=!1,qe=null;function ft(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function sn({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:a}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:i??null,label_en:a??null}}function oi(e){return G=Array.isArray(e)?e.map(ft).filter(t=>t.name!=="").sort((t,n)=>Ne(t).localeCompare(Ne(n),"ar",{sensitivity:"base"})):[],on=!0,Je(),se()}function Je(){try{const e={positions:se()},t=new CustomEvent(ai,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function Ne(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function se(){return G.map(e=>({...e}))}function rn(e){const t=String(e??"").trim().toLowerCase();return t&&G.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function si({forceRefresh:e=!1}={}){return on&&!e?se():(qe&&!e||(qe=O("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return oi(n)}).finally(()=>{qe=null})),qe)}async function Re({forceRefresh:e=!1}={}){try{return await si({forceRefresh:e})}catch(t){throw t instanceof Oe?t:new Oe(t?.message||g("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"))}}async function ri({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:a}){const o=sn({name:e,cost:t,clientPrice:n,labelAr:i,labelEn:a}),r=await O("/technician-positions/",{method:"POST",body:o}),s=ft(r?.data??{});return G=[...G,s],G.sort((l,c)=>Ne(l).localeCompare(Ne(c),"ar",{sensitivity:"base"})),Je(),s}async function ci(e,{name:t,cost:n,clientPrice:i,labelAr:a,labelEn:o}){if(!e)throw new Error("Position id is required");const r=sn({name:t,cost:n,clientPrice:i,labelAr:a,labelEn:o}),s=await O(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:r}),l=ft(s?.data??{});return G=G.map(c=>c.id===l.id?l:c),G.sort((c,d)=>Ne(c).localeCompare(Ne(d),"ar",{sensitivity:"base"})),Je(),l}async function li(e){if(!e)throw new Error("Position id is required");return await O(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),G=G.filter(t=>t.id!==Number(e)),Je(),se()}const at="__ART_RATIO_TECH_SUB_TAB__",cn=["technicians-management","technicians-positions"];let M=null,Rt=!1,Ve=!1,Be="",ot=!1,Z=null,ge="technicians-management";const xt=ui();xt&&(ge=xt);async function ln({showToastOnError:e=!0}={}){if(!Ve){Ve=!0,Be="",H();try{await ti(),ot=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),Be=Ye(t)?t.message:g("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&S(Be,"error")}finally{Ve=!1,H()}}}function un(){return Xt()}function je(e=""){return _(String(e)).trim().toLowerCase()}function Mt(e){return e==null?"":String(e)}function ve(e=""){return _(String(e)).replace(/[^0-9+]/g,"")}function U(e=""){const t=_(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...i]=t.split(".");return`${n}.${i.join("")}`}function Pe(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const i=e.selectionEnd;e.value=n,i!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function ui(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(at);return e&&cn.includes(e)?e:null}catch(e){return console.warn("⚠️ [technicians] Failed to read stored sub-tab",e),null}}function di(e){try{if(typeof window>"u"||!window.localStorage)return;if(!cn.includes(e)){window.localStorage.removeItem(at);return}window.localStorage.setItem(at,e)}catch(t){console.warn("⚠️ [technicians] Failed to store sub-tab",t)}}function dn(e,t=0,n=null){const i=String(e??"").trim(),a=i?rn(i):null;return a?{matchedPosition:a,dailyWage:Number.isFinite(a.cost)?a.cost:0,dailyTotal:a.clientPrice==null?null:Number.isFinite(a.clientPrice)?a.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function pn(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function st(e,t=oe()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function pi(e,t=oe()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function mn(){const{container:e,body:t}=pn();!e||!t||(t.textContent="",e.hidden=!0)}function gt(e,t={}){const{container:n,body:i}=pn();if(!n||!i)return;const a=String(e??"").trim();if(!a){mn();return}const o=dn(a,t?.dailyWage??0,t?.dailyTotal??null),r=Qe(o.dailyWage||0),s=o.dailyTotal!=null?Qe(o.dailyTotal):g("technicians.positionSummary.noClientPrice","—");o.matchedPosition?i.textContent=g("technicians.positionSummary.match","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",r).replace("{price}",s):i.textContent=g("technicians.positionSummary.custom","لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}").replace("{cost}",r).replace("{price}",s),n.hidden=!1}function xe(){const e=document.getElementById("technician-position-options");if(!e)return;const t=se(),n=oe(),i=new Set,a=[];t.forEach(o=>{const r=st(o,n).trim();r&&!i.has(r.toLowerCase())&&(a.push(`<option value="${me(r)}"></option>`),i.add(r.toLowerCase()));const s=pi(o,n).trim();s&&!i.has(s.toLowerCase())&&(a.push(`<option value="${me(s)}"></option>`),i.add(s.toLowerCase()));const l=o.name?.trim();l&&!i.has(l.toLowerCase())&&(a.push(`<option value="${me(l)}"></option>`),i.add(l.toLowerCase()))}),e.innerHTML=a.join("")}function wt(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),a=t.map(s=>s?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(s=>{if(!s)return;const c=s.getAttribute("data-tech-tab")===a;s.classList.toggle("tab-active",c),s.classList.toggle("active",c),s.setAttribute("aria-selected",c?"true":"false"),s.setAttribute("tabindex",c?"0":"-1")}),n.forEach(s=>{if(!s)return;const c=s.getAttribute("data-tech-tab-panel")===a;s.hidden=!c,s.classList.toggle("active",c)}),ge=a,di(a);const r=t.find(s=>s?.getAttribute("data-tech-tab")===a)?.closest("[data-tab-scroll]");r&&r.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),a==="technicians-positions"&&(ie(),Re().then(()=>{ie()}).catch(s=>{console.error("❌ [technicians] failed to load positions for tab switch",s),S(s?.message||g("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}))}function ht(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",i=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=g(n,i)}function yt(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=g("technicians.form.actions.cancel","إلغاء التعديل"))}function bt(){ht(M?"update":"add"),yt(!!M),H()}function mi(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,i=Array.from(new Set(e.map(o=>(o?.role||"").trim()).filter(Boolean))).sort((o,r)=>o.localeCompare(r,"ar",{sensitivity:"base"})),a=g("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${a}</option>`+i.map(o=>`<option value="${o}">${o}</option>`).join(""),n&&i.includes(n)?t.value=n:t.value="",t.value}function Ze(){const e=document.getElementById("technician-form");e&&(e.reset(),M=null,ht("add"),yt(!1),mn())}function fi(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),i=document.getElementById("technician-role"),a=document.getElementById("technician-department"),o=document.getElementById("technician-notes");!t||!n||!i||(t.value=e.name||"",n.value=ve(e.phone||""),i.value=e.role||"",a&&(a.value=e.department||""),o&&(o.value=e.notes||""),M=String(e.id),ht("update"),yt(!0),gt(i.value,e))}function gi(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),i=document.getElementById("technician-department"),a=document.getElementById("technician-notes");if(!e||!t||!n)return null;const o=e.value.trim(),r=ve(t.value.trim());t.value=r;const s=n.value.trim(),l=i?.value.trim()||"",c="available",d=a?.value.trim()||"",u=M?gn(M):null,{dailyWage:p,dailyTotal:y}=dn(s,u?.dailyWage??0,u?.dailyTotal??null);return o?r?s?!Number.isFinite(p)||p<0?(S(g("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),null):y!=null&&(!Number.isFinite(y)||y<0)?(S(g("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),null):(gt(s,{dailyWage:p,dailyTotal:y}),{name:o,phone:r,role:s,department:l,dailyWage:Number.isFinite(p)?p:0,dailyTotal:y==null?null:Number(y),status:c,baseStatus:c,notes:d}):(S(g("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(S(g("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(S(g("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function hi(e){e.preventDefault();try{await Re()}catch(i){console.error("❌ [technicians] failed to load positions before submit",i);const a=i?.message||g("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");S(a,"error");return}const t=gi();if(!t)return;const n=tn({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{M?(await en(M,n),S(g("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await ni(n),S(g("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),Ze(),H()}catch(i){console.error("❌ [technicians] handleTechnicianSubmit failed",i);const a=Ye(i)?i.message:g("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");S(a,"error")}}function yi(){Ze()}function bi(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=ve(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const i=U(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==i&&(t.wage.value=i);const a=U(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==a&&(t.total.value=a);const o=e.baseStatus||e.status||"available";t.status.value!==o&&(t.status.value=o),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),Pe(t.phone,ve),Pe(t.wage,U),Pe(t.total,U)}function _i(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),i=document.getElementById("edit-technician-role"),a=document.getElementById("edit-technician-department"),o=document.getElementById("edit-technician-wage"),r=document.getElementById("edit-technician-total"),s=document.getElementById("edit-technician-status"),l=document.getElementById("edit-technician-notes");if(!e||!t||!n||!i||!o||!r||!s)return null;const c=e.value.trim(),d=t.value.trim(),u=ve(n.value.trim());n.value=u;const p=i.value.trim(),y=a?.value.trim()||"",b=U(o.value.trim());o.value=b;const h=b===""?0:parseFloat(b),f=U(r.value.trim());r.value=f;const I=f===""?null:parseFloat(f),A=s.value||"available",C=l?.value.trim()||"";return c?d?u?p?Number.isNaN(h)||h<0?(S(g("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),o.focus(),null):I!=null&&(Number.isNaN(I)||I<0)?(S(g("technicians.toast.invalidTotal","⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية")),r.focus(),null):{id:c,name:d,phone:u,role:p,department:y,dailyWage:Number.isFinite(h)?h:0,dailyTotal:I==null?null:Number(I),status:A,baseStatus:A,notes:C}:(S(g("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),i.focus(),null):(S(g("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(S(g("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(S(g("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function Ii(){const e=_i();if(!e)return;const t=tn({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await en(e.id,t),S(g("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),H()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const i=Ye(n)?n.message:g("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");S(i,"error")}}function H(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=je(t?.value||"");if(Ve&&!ot){const c=g("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}if(Be&&!ot){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${Be}</td></tr>`;return}const i=yn(),{reservations:a=[]}=V(),o=new Date;mi(i);const r=document.getElementById("technician-role-filter"),s=je(r?.value||""),l=i.filter(c=>s&&je(c.role||"")!==s?!1:n?je([c.name,c.phone,c.role,c.department,c.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const c=g("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}e.innerHTML=l.map(c=>{const d=M&&String(M)===String(c.id),y=(hn(c.id,a,o)?"busy":c.status||c.baseStatus||"available")==="busy"?{label:g("technicians.status.busy","⛔ مشغول"),className:"technician-status-badge technician-status-badge--busy"}:{label:g("technicians.status.available","✅ متاح"),className:"technician-status-badge technician-status-badge--available"},b=g("technicians.actions.edit","✏️ تعديل"),h=g("technicians.actions.delete","🗑️ حذف"),f=Zt(),I=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${c.id}">${b}</button>`];return f&&I.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${c.id}">${h}</button>`),`
      <tr${d?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${c.id}" class="text-decoration-none">${c.name}</a></td>
        <td>${c.role||""}</td>
        <td>${c.department||"—"}</td>
        <td><span class="${y.className}"><span class="technician-status-badge__text">${y.label}</span></span></td>
        <td class="table-notes-cell">${c.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${I.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Xe(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function fn(e="add"){const{submitBtn:t,cancelBtn:n}=Xe(),i=e==="update";if(t){const a=i?"positions.form.actions.update":"positions.form.actions.submit",o=i?"💾 حفظ المنصب":"➕ إضافة منصب";t.textContent=g(a,o)}n&&(n.classList.toggle("d-none",!i),n.textContent=g("positions.form.actions.cancel","إلغاء"))}function _t(){const{form:e,idInput:t,nameArInput:n,nameEnInput:i,costInput:a,clientPriceInput:o}=Xe();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),i&&(i.value=""),a&&(a.value=""),o&&(o.value=""),Z=null,fn("add")}function Ai(e){const{idInput:t,nameArInput:n,nameEnInput:i,costInput:a,clientPriceInput:o}=Xe();!e||!a||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),i&&(i.value=e.labelEn||""),a.value=U(e.cost??0),o&&(o.value=e.clientPrice==null?"":U(e.clientPrice)),Z=e.id||null,fn("update"))}function Pi(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:i}=Xe();if(!n)return null;const a=e?.value.trim()||"",o=t?.value.trim()||"",r=o||a,s=Z?se().find(p=>String(p.id)===String(Z)):null,l=U(n.value.trim());n.value=l;const c=l===""?0:parseFloat(l),d=i?U(i.value.trim()):"";i&&(i.value=d);const u=d===""?null:parseFloat(d);return r?!Number.isFinite(c)||c<0?(S(g("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),n.focus(),null):u!=null&&(!Number.isFinite(u)||u<0)?(S(g("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),i?.focus(),null):{id:Z,name:s?.name||r,cost:Number(c.toFixed(2)),clientPrice:u==null?null:Number(u.toFixed(2)),labelAr:a||null,labelEn:o||null}:(S(g("positions.toast.invalidName","⚠️ يرجى إدخال اسم المنصب")),e&&e.focus(),null)}function Se(){const e=document.getElementById("technician-role");if(!e)return;const t=M?gn(M):null;gt(e.value,t||{})}function ie(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=se();if(t&&(t.textContent=_(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${g("positions.table.empty","لا توجد مناصب بعد.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(i=>{const a=Z&&String(Z)===String(i.id),o=Qe(i.cost||0),r=i.clientPrice==null?g("technicians.positionSummary.noClientPrice","—"):Qe(i.clientPrice),s=st(i,"ar")||"—",l=st(i,"en")||"—",c=g("positions.table.actions.edit","✏️ تعديل"),d=g("positions.table.actions.delete","🗑️ حذف");return`
      <tr${a?' class="technician-table-row-editing"':""}>
        <td>${me(s)}</td>
        <td>${me(l)}</td>
        <td>${me(o)}</td>
        <td>${me(r)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${i.id}">${c}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${i.id}">${d}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function Ni(e){e.preventDefault();const t=Pi();if(t)try{const n=!!Z;n?await ci(t.id,t):await ri(t);const i=n?g("positions.toast.updateSuccess","💾 تم حفظ بيانات المنصب"):g("positions.toast.addSuccess","✅ تم إضافة المنصب");S(i),_t(),ie(),xe(),Se()}catch(n){console.error("❌ [technicians] handlePositionSubmit failed",n);const i=n?.message||g("positions.toast.saveFailed","⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى");S(i,"error")}}function vi(){_t()}async function Si(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Re();const i=se().find(a=>String(a.id)===String(n));if(!i){S(g("positions.toast.notFound","⚠️ تعذر العثور على بيانات المنصب"),"error");return}Ai(i),ie();return}if(t.classList.contains("position-delete-btn")){if(!confirm(g("positions.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا المنصب؟")))return;await li(n),Z&&String(Z)===String(n)&&_t(),S(g("positions.toast.deleteSuccess","🗑️ تم حذف المنصب")),ie(),xe(),Se()}}catch(t){console.error("❌ [technicians] handlePositionsTableClick failed",t);const n=t?.message||g("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");S(n,"error")}}function Ci(e){const t=un().find(n=>String(n.id)===String(e));if(!t){S(g("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}fi(t),S(g("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function ki(e){if(!Zt()){Xn();return}if(confirm(g("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await ii(e),S(g("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),M&&String(M)===String(e)&&Ze(),H()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=Ye(t)?t.message:g("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");S(n,"error")}}function Da(){It(),H()}function gn(e){return un().find(t=>String(t.id)===String(e))||null}function hn(e,t=[],n){const i=Mt(e);return i?t.some(a=>{if(!a||!a.start||!a.end||!(Array.isArray(a.technicians)?a.technicians:[]).some(l=>Mt(l)===i))return!1;const r=new Date(a.start),s=new Date(a.end);return Number.isNaN(r.getTime())||Number.isNaN(s.getTime())?!1:r<=n&&n<s}):!1}function yn(){const e=V().reservations||[],t=Xt();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let i=!1;const a=t.map(o=>{if(!o)return o;const r=o.baseStatus||o.status||"available";let s=r==="busy"?"busy":r;return hn(o.id,e,n)&&(s="busy"),(s!==o.status||r!==o.baseStatus)&&(i=!0),{...o,baseStatus:r,status:s}});return i?(ze(a),a):t}function It(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{hi(p).catch(y=>{console.error("❌ [technicians] submit handler failed",y)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",yi),n.dataset.listenerAttached="true"),Pe(document.getElementById("technician-phone"),ve);const i=document.getElementById("technician-role");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{Se()}),i.dataset.listenerAttached="true");const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",p=>{const y=p.target;if(y instanceof HTMLElement){if(y.classList.contains("technician-edit-btn")){const b=y.dataset.id;Ci(b)}if(y.classList.contains("technician-delete-btn")){const b=y.dataset.id;ki(b).catch(h=>{console.error("❌ [technicians] delete handler failed",h)})}}}),a.dataset.listenerAttached="true");const o=document.getElementById("search-technician-input");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",()=>{o.value=_(o.value),H()}),o.dataset.listenerAttached="true");const r=document.getElementById("technician-role-filter");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{H()}),r.dataset.listenerAttached="true");const s=document.getElementById("save-technician-changes");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",()=>{Ii().catch(p=>{console.error("❌ [technicians] modal save failed",p)})}),s.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",p=>{Ni(p).catch(y=>{console.error("❌ [technicians] position submit failed",y)})}),l.dataset.listenerAttached="true");const c=document.getElementById("position-cancel-btn");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",vi),c.dataset.listenerAttached="true");const d=document.getElementById("positions-table");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",Si),d.dataset.listenerAttached="true"),Pe(document.getElementById("position-cost"),U),Pe(document.getElementById("position-client-price"),U);const u=document.querySelector("[data-tech-tabs]");u&&!u.dataset.listenerAttached&&(u.querySelectorAll("[data-tech-tab]").forEach(y=>{y&&y.addEventListener("click",()=>{const b=y.getAttribute("data-tech-tab");wt(b)})}),u.dataset.listenerAttached="true"),wt(ge),Re().then(()=>{xe(),ge==="technicians-positions"&&ie(),Se()}).catch(p=>{console.error("❌ [technicians] failed to load technician positions",p),S(p?.message||g("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}),Rt||(document.addEventListener("technician:prefill",p=>{const y=p.detail;y&&bi(y)}),Rt=!0),t&&Ze(),ge==="technicians-positions"&&ie()}window.addEventListener("DOMContentLoaded",()=>{It(),H(),bt(),ln()});const bn=()=>{H()};window.addEventListener("technicians:updated",bn);document.addEventListener("technicians:updated",bn);document.addEventListener("technicians:refreshRequested",()=>{It(),H(),bt(),ln({showToastOnError:!1})});document.addEventListener("language:changed",()=>{bt(),xe(),ge==="technicians-positions"&&ie(),Se()});document.addEventListener(Zn.USER_UPDATED,()=>{H()});const _n=()=>{xe(),ge==="technicians-positions"&&ie(),Se()};window.addEventListener("technicianPositions:updated",_n);document.addEventListener("technicianPositions:updated",_n);function Fe(e){return _(String(e||"")).trim().toLowerCase()}function Y(e){const t=String(e??"").trim().toLowerCase();return t||""}function In(){const{packages:e=[]}=V();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function We(e){const t=Y(e);return t&&In().find(i=>Y(i?.id??i?.packageId??i?.package_id)===t)||null}function he(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(s=>({barcode:s}))),n.forEach(s=>{if(!s)return;if(typeof s=="string"||typeof s=="number"){const p=Fe(s);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof s!="object")return;const l=Fe(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number),c=[s.equipmentId,s.equipment_id,s.itemId,s.item_id,s.id].find(p=>p!=null&&p!==""),d=[s.unit_price,s.unitPrice,s.price,s.daily_rate].find(p=>Number.isFinite(Number(p))),u=[s.quantity,s.qty,s.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:c!=null?String(c):null,barcode:s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??"",normalizedBarcode:l,qty:u!=null?Number(u):1,price:d!=null?Number(d):0,desc:s.description??s.desc??s.name??"",image:s.image??s.imageUrl??s.img??null})});const i=new Map,{equipment:a=[]}=V()||{},o=new Map,r=new Map;return(Array.isArray(a)?a:[]).forEach(s=>{if(!s||typeof s!="object")return;[s.id,s.equipment_id,s.equipmentId,s.item_id,s.itemId].map(d=>d!=null?String(d):"").filter(Boolean).forEach(d=>{o.has(d)||o.set(d,s)});const c=Fe(s.barcode);c&&!r.has(c)&&r.set(c,s)}),t.forEach(s=>{if(s.equipmentId&&o.has(s.equipmentId)){const l=o.get(s.equipmentId);if(l){if(s.desc||(s.desc=l.desc||l.description||l.name||""),s.barcode||(s.barcode=l.barcode||""),s.price==null||s.price===0){const c=l.price??l.unit_price,d=Number(c);Number.isFinite(d)&&d>=0&&d<1e6&&(s.price=d)}s.image||(s.image=l.image||l.imageUrl||l.img||null)}}else if(s.normalizedBarcode&&r.has(s.normalizedBarcode)){const l=r.get(s.normalizedBarcode);if(l){if(s.desc||(s.desc=l.desc||l.description||l.name||""),s.barcode||(s.barcode=l.barcode||""),s.price==null||s.price===0){const c=l.price??l.unit_price,d=Number(c);Number.isFinite(d)&&d>=0&&d<1e6&&(s.price=d)}s.image||(s.image=l.image||l.imageUrl||l.img||null)}}}),t.forEach(s=>{const l=s.normalizedBarcode||(s.barcode?Fe(s.barcode):""),c=l||(s.equipmentId?`id:${s.equipmentId}`:null);if(!c)return;if(!i.has(c)){i.set(c,{...s,normalizedBarcode:l});return}const d=i.get(c);d.qty+=s.qty,!d.price&&s.price&&(d.price=s.price),!d.desc&&s.desc&&(d.desc=s.desc),!d.image&&s.image&&(d.image=s.image)}),Array.from(i.values())}function Ei(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const i of t){const a=Number(i);if(Number.isFinite(a))return a}return he(e).reduce((i,a)=>i+(a.price||0)*(a.qty||1),0)}function Ti(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function qi(){return In().map(t=>{const n=Y(t?.id??t?.packageId??t?.package_id??t?.code),i=Ti(t)||n||"package",a=Ei(t);return{id:n,name:i,price:a,code:t?.package_code??t?.code??n,items:he(t),raw:t}}).filter(t=>t.id)}function Fi(e){const t=Fe(e);return t?qi().filter(n=>n.items.some(i=>i.normalizedBarcode===t)):[]}function Li(e){return he(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let Ce=[],An=[],Pn=[],Nn="single";function $a(){return Ce}function za(e){Ce=Array.isArray(e)?e:[]}function Ra(e){Ce=[...Ce,e]}function xa(e){Number.isInteger(e)&&e>=0&&(Ce=Ce.filter((t,n)=>n!==e))}function Ma(){return An}function wa(e){An=Array.isArray(e)?e:[]}function ja(){return Pn}function Ha(e){Pn=Array.isArray(e)?e:[]}function Va(e){}function Ua(){return Nn==="package"?"package":"single"}function Oa(e){Nn=e==="package"?"package":"single"}function Qa(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[i="",a=""]=n.split("T"),o=i?i.slice(0,10):"",r=a.match(/(\d{1,2}:\d{2})/);let s="";if(r){const[l="00",c="00"]=r[0].split(":");s=`${l.padStart(2,"0")}:${c.padStart(2,"0")}`}return{date:o,time:s}}function He(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function K(e){return _(String(e||"")).trim().toLowerCase()}const Bi=864e13;function te(e){if(!e&&e!==0)return null;if(e instanceof Date){const i=e.getTime();return Number.isNaN(i)?null:new Date(i)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const i=new Date(e);return Number.isNaN(i.getTime())?null:i}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const a=new Date(i);if(!Number.isNaN(a.getTime()))return a}}if(!t.includes("T")&&t.includes(" ")){const i=t.indexOf(" ");t=`${t.slice(0,i)}T${t.slice(i+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const i=new Date(`${t}Z`);if(!Number.isNaN(i.getTime()))return i}return null}function Wa(e,t,n,i=null){if(!e||!t||!n)return!1;const a=te(t),o=te(n);if(!a||!o||a>=o)return!1;const r=K(e);if(!r)return!1;const s=V()||{},l=Array.isArray(s.reservations)?s.reservations:[],c=Array.isArray(s.maintenance)?s.maintenance:[],d=Array.isArray(s.equipment)?s.equipment:[],u=Vi(d),p=Pt(i);return l.some(b=>{if(!b||Nt(b,p)||!b.start||!b.end)return!1;const h=te(b.start),f=te(b.end);return!h||!f||!(h<o&&f>a)?!1:$i(b,r)})?!0:c.some(b=>{if(!xi(b)||!wi(b,u).has(r))return!1;const{start:f,end:I}=ji(b);if(!f&&!I)return!0;const A=f??new Date(0),C=I??new Date(Bi);return A<o&&C>a})}function Di(e,t,n,i=null){const a=Y(e);if(!a||!t||!n)return!1;const o=te(t),r=te(n);if(!o||!r||o>=r)return!1;const s=V()||{},l=Array.isArray(s.reservations)?s.reservations:[],c=Pt(i);return l.some(d=>{if(!d?.start||!d?.end||Nt(d,c))return!1;const u=te(d.start),p=te(d.end);return!u||!p||!(u<r&&p>o)?!1:zi(d,a)})}function Ka(e,t,n,i=null){const a=K(e);if(!a||!t||!n)return[];const o=Fi(a);return o.length?o.filter(r=>Di(r.id,t,n,i)):[]}function vn(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(i=>{const a=e[i];Array.isArray(a)&&a.length&&t.push(a)}),t}function $i(e,t){if(!t||!e||typeof e!="object")return!1;const n=K(e?.barcode);if(n&&n===t)return!0;const i=vn(e);for(const a of i)for(const o of a)if(Ri(o).has(t))return!0;return!1}function zi(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const o of n){if(!o&&o!==0)continue;const r=Y(o);if(r&&r===t)return!0}const i=e.packages;if(Array.isArray(i))for(const o of i){const r=Y(o);if(r&&r===t)return!0}const a=vn(e);for(const o of a)for(const r of o)if(At(r).has(t))return!0;return!1}function Ri(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const o=K(e);return o&&t.add(o),t}if(typeof e!="object")return t;const n=K(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(o=>{const r=e[o];Array.isArray(r)&&r.forEach(s=>{if(s!=null){if(typeof s=="string"||typeof s=="number"){const l=K(s);l&&t.add(l);return}if(typeof s=="object"){const l=K(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);l&&t.add(l)}}})});const a=At(e);return a.size&&a.forEach(o=>{const r=We(o);if(!r)return;Li(r).forEach(l=>{const c=l.normalizedBarcode??K(l.barcode);c&&t.add(c)})}),t}function At(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(i=>{const a=Y(i);a&&t.add(a)}),e.package&&typeof e.package=="object"&&At(e.package).forEach(a=>t.add(a)),Array.isArray(e.packages)&&e.packages.forEach(i=>{const a=Y(i);a&&t.add(a)}),t}function xi(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(Hi(e))return!1;for(const n of t){const i=Mi(n);if(i){if(i==="completed"||i==="cancelled"||i==="closed")return!1;if(i==="open"||i==="in_progress")return!0}}return!0}function Mi(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="مكتمل"||t==="مغلق"?"completed":t==="cancelled"||t==="canceled"||t==="ملغي"?"cancelled":t==="in_progress"||t==="in-progress"||t==="قيد_التنفيذ"||t==="جاري_العمل"||t==="inprogress"?"in_progress":t==="open"||t==="قيد_الصيانة"||t==="قيد_الانتظار"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("تنفيذ")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function wi(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(r=>{const s=K(r);s&&n.add(s)});const a=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(a){const r=K(a.barcode??a.equipmentBarcode??a.code??a.serial??a.serialNumber??a.serial_number);r&&n.add(r)}return[e?.equipmentId,e?.equipment_id,a?.id,a?.equipmentId,a?.equipment_id].map(r=>r!=null?String(r):"").filter(Boolean).forEach(r=>{const s=t.get(r);if(!s)return;const l=K(s?.barcode??s?.equipmentBarcode??s?.code??s?.serial??s?.serialNumber??s?.serial_number);l&&n.add(l)}),n}function ji(e){const t=rt([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=rt([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function Hi(e){return!!rt([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function rt(e=[]){for(const t of e){const n=te(t);if(n)return n}return null}function Vi(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(a=>a!=null?String(a):"").filter(Boolean).forEach(a=>{t.has(a)||t.set(a,n)})}),t}function Ui(e,t,n,i=null){if(!e||!t||!n)return!1;const a=new Date(t),o=new Date(n);if(Number.isNaN(a.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:r=[]}=V(),s=String(e),l=Pt(i);return r.some(c=>{if(!c?.start||!c?.end||Nt(c,l))return!1;const d=new Date(c.start),u=new Date(c.end);return Number.isNaN(d.getTime())||Number.isNaN(u.getTime())||!(d<o&&u>a)?!1:(Array.isArray(c.technicians)?c.technicians:[]).some(b=>String(b)===s)})}function Pt(e){return Ie(e,new Set)}function Nt(e,t){if(!t||t.size===0)return!1;const n=Ie([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const i of n)if(t.has(i))return!0;return!1}function Ie(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(o=>Ie(o,t)),t;if(Array.isArray(e))return e.forEach(o=>Ie(o,t)),t;if(typeof e=="object"){const o=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let r=!1;return o.forEach(s=>{Object.prototype.hasOwnProperty.call(e,s)&&(r=!0,Ie(e[s],t))}),r||Object.values(e).forEach(s=>Ie(s,t)),t}const n=_(String(e??"")).trim();if(!n)return t;const i=[n,n.toLowerCase(),n.toUpperCase()],a=n.replace(/\D+/g,"");if(a){i.push(a);const o=Number.parseInt(a,10);Number.isNaN(o)||i.push(String(o))}return i.forEach(o=>{o&&t.add(o)}),t}const Oi=()=>g("reservations.create.summary.currency","SR");let De=[],et=[],ce=[],le=[],x="create",Sn=()=>{},Cn=()=>{};function $e(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ue(e={}){return{...e,assignmentId:e.assignmentId||$e()}}function tt(e){if(!e)return null;const t=String(e),n=De.find(a=>String(a?.id)===t);if(n)return{...n};const{technicians:i=[]}=V();return i.find(a=>String(a?.id)===t)||null}function vt(e={},t=oe()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function St(e={},t=oe()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function kn(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=et.find(o=>String(o.id).trim().toLowerCase()===n);if(i)return i;const a=rn(e);return a||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function jt(e){const t=kn(e,e?.name??""),n=oe(),i=vt(t,n)||t?.name||"",a=St(t,n);return Ue({assignmentId:$e(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:a,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Ue(e={}){const t={assignmentId:e.assignmentId||$e(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=kn(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=oe(),a=vt(n,i)||t.positionLabel,o=St(n,i);t.positionLabel=a||t.positionLabel||n?.name||"",t.positionLabelAlt=o||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=tt(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function Ct(){et=se()}function Qi(e=[]){return Array.isArray(e)?e.map(t=>{if(t&&typeof t=="object"&&(t.positionId!=null||t.position_id!=null||t.position_name!=null||t.role!=null)){const a=Ue(t);return ue(a)}if(t&&typeof t=="object"&&t.id!=null)return ue(Ue(t));if(t==null)return null;const n=tt(t),i=n?{assignmentId:$e(),positionLabel:n.role||g("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:$e(),positionLabel:g("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return ue(Ue(i))}).filter(Boolean):[]}function be(e="create"){return e==="edit"?le.map(ue):ce.map(ue)}function ae(e="create",t=[]){const n=Qi(t);e==="edit"?(le=n,ke("edit-selected-technicians-list",le,"edit"),Cn()):(ce=n,ke("selected-technicians-list",ce,"create"),Sn()),nt()}function Wi(e="create"){if(e==="edit"){const s=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),c=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",u=s?He(s,c):null,p=l?He(l,d):null;let y=null;const b=document.getElementById("edit-res-index")?.value;if(b!=null){const h=Number.parseInt(b,10);if(Number.isInteger(h)){const{reservations:f=[]}=V(),I=f?.[h];I&&(y=I.id??I.reservationId??null)}}return{start:u,end:p,ignoreReservationId:y}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=t?He(t,i):null,r=n?He(n,a):null;return{start:o,end:r,ignoreReservationId:null}}function nt(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=be(x).length;if(t){const n=g("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",_(String(t)));e.textContent=n}else e.textContent=g("technicians.picker.selectionInfo","No crew selected yet")}function Ke(e){const t=Number.isFinite(e)?e:0;return`${_(t.toFixed(2))} ${Oi()}`}function Ki(e){const t=be(x),n=new Set(t.filter(o=>o.assignmentId!==e&&o.technicianId).map(o=>o.technicianId));return(De.length?De:V().technicians||[]).map(o=>{const r=String(o.id),s=n.has(r),l=[o.name||r];o.role&&l.push(`(${o.role})`);const c=_(l.join(" "));return{id:r,label:c,disabled:s}})}function ne(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=be(x);if(!t.length){e.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${g("technicians.picker.noAssignments","لم يتم إضافة أي مناصب بعد")}</td></tr>`;return}e.innerHTML=t.map((n,i)=>{const a=_(String(i+1)),o=Ke(n.positionClientPrice||0),r=Ki(n.assignmentId),s=[`<option value="">${g("technicians.picker.noTechnicianOption","— بدون تعيين —")}</option>`,...r.map(c=>`<option value="${c.id}" ${n.technicianId===c.id?"selected":""} ${c.disabled?"disabled":""}>${c.label}${c.disabled&&n.technicianId!==c.id?` ${g("technicians.picker.optionAssigned","(مستخدم)")}`:""}</option>`)].join(""),l=n.positionLabelAlt?`<div class="text-muted small">${_(n.positionLabelAlt)}</div>`:"";return`
      <tr data-assignment-id="${n.assignmentId}">
        <td style="width: 40px;">${a}</td>
        <td>
          <div class="fw-bold">${_(n.positionLabel||g("reservations.crew.positionFallback","منصب بدون اسم"))}</div>
          ${l}
        </td>
        <td>${o}</td>
        <td>
          <select class="form-select crew-assignment-select" data-assignment-id="${n.assignmentId}">
            ${s}
          </select>
        </td>
        <td style="width: 48px;text-align:center;">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${g("technicians.picker.actions.remove","إزالة")}">✖</button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{En(n.dataset.assignmentId,x)}),n.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-assignment-select").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("change",i=>{Yi(n.dataset.assignmentId,i.target.value)}),n.dataset.listenerAttached="true")})}function ct(){const e=document.getElementById("crew-position-list");if(!e)return;Ct();const t=document.getElementById("crew-position-search"),n=_(String(t?.value||"")).trim().toLowerCase(),i=et.filter(o=>n?[o.labelAr,o.labelEn,o.name].filter(Boolean).map(s=>_(String(s)).toLowerCase()).join(" ").includes(n):!0);if(!i.length){e.innerHTML=`<div class="text-muted">${g("technicians.picker.noPositions","لا توجد مناصب مطابقة.")}</div>`;return}const a=oe();e.innerHTML=i.map(o=>{const r=vt(o,a)||o.name||"",s=St(o,a),l=Ke(o.clientPrice||0),c=s?`<div class="text-muted small">${_(s)}</div>`:"";return`
      <div class="crew-position-item d-flex justify-content-between align-items-start border rounded p-2 mb-2" data-position-id="${o.id}">
        <div>
          <div class="fw-bold">${_(r)}</div>
          ${c}
          <div class="text-muted small">${g("technicians.picker.positionCost","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",Ke(o.cost||0)).replace("{price}",l)}</div>
        </div>
        <div>
          <button type="button" class="btn btn-sm btn-outline-primary crew-position-add" data-position-id="${o.id}">
            ${g("technicians.picker.actions.addPosition","➕ إضافة")}
          </button>
        </div>
      </div>
    `}).join(""),e.querySelectorAll(".crew-position-add").forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",()=>{Gi(o.dataset.positionId)}),o.dataset.listenerAttached="true")})}function Gi(e){Ct();const t=et.find(a=>String(a.id)===String(e)),n=jt(t||{id:null,name:""}),i=be(x);i.push(n),ae(x,i),ne()}function En(e,t="create"){if(!e)return;const n=be(t).filter(i=>i.assignmentId!==e);ae(t,n),ne()}function Yi(e,t){if(!e)return;const n=be(x),i=n.find(r=>r.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ae(x,n),ne();return}if(n.find(r=>r.assignmentId!==e&&r.technicianId===t)){S(g("technicians.picker.duplicateTechnician","⚠️ لا يمكن تعيين نفس الشخص لأكثر من منصب في نفس الحجز")),ne();return}const o=tt(t);o?(i.technicianId=String(o.id),i.technicianName=o.name??null,i.technicianRole=o.role??null,i.technicianPhone=o.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ae(x,n),ne()}async function Ht(e="create"){x=e;const t=yn();Array.isArray(t)&&t.length&&(De=t);try{await Re()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}Ct(),ct(),ne(),nt();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function Ji(){return be(x).map(ue)}function Zi(){const e=Ji(),{start:t,end:n,ignoreReservationId:i}=Wi(x);if(t&&n){const o=e.filter(r=>r.technicianId&&Ui(r.technicianId,t,n,i));if(o.length>0){const r=o.map(l=>l.technicianName||l.technicianId).join(g("reservations.list.crew.separator","، ")),s=g("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",r);o.forEach(l=>{l.technicianId=null,l.technicianName=null}),ae(x,e),ne(),S(s),nt();return}}ae(x,e);const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a)?.hide?.()}function ke(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${g("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.")}</span>`;return}i.innerHTML=t.map(a=>{const o=_(a.positionLabel||g("reservations.crew.positionFallback","منصب بدون اسم")),r=a.technicianName?`${_(a.technicianName)}`:g("technicians.picker.noTechnicianOption","— بدون تعيين —"),s=Ke(Number(a.positionClientPrice)||0),l=g("reservations.crew.removeAria","إزالة");return`
      <span class="technician-chip" data-assignment-id="${a.assignmentId}">
        <span class="technician-chip-name">${o}</span>
        <small class="technician-chip-role">${r}</small>
        <small class="technician-chip-wage">💼 ${s}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${a.assignmentId}" aria-label="${l}">✖</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",()=>{En(a.dataset.assignmentId,a.dataset.context)}),a.dataset.listenerAttached="true")})}}function Xi(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Ht("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>Ht("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{ct()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",Zi),i.dataset.listenerAttached="true");const a=document.getElementById("selectTechniciansModal");a&&!a.dataset.listenerAttached&&window.bootstrap?.Modal&&(a.addEventListener("shown.bs.modal",()=>{ct(),ne(),nt()}),a.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("crew-position-search");o&&(o.value="")}),a.dataset.listenerAttached="true"),ke("selected-technicians-list",ce,"create"),ke("edit-selected-technicians-list",le,"edit")}function Ga({onDraftChange:e,onEditChange:t}={}){Sn=typeof e=="function"?e:()=>{},Cn=typeof t=="function"?t:()=>{},Xi()}function ea(){return ce.map(ue)}function ta(){return le.map(ue)}function Ya(e=[]){ae("edit",e)}function Ja(){ae("create",[])}function Za(){ae("edit",[])}function Vt(e=[]){return e.map(t=>{if(t.technicianId){const n=tt(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function Xa(e=[]){Array.isArray(e)&&e.length&&(De=e),ce=Vt(ce),le=Vt(le),ke("selected-technicians-list",ce,"create"),ke("edit-selected-technicians-list",le,"edit"),ne()}function Ut(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Tn(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=_(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),a=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const o=t.includes(","),r=t.includes(".");if(o&&r){const l=t.lastIndexOf(","),c=t.lastIndexOf(".");l>c?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(o){const l=t.split(",");l.length===2&&l[1].length===3?t=l.join(""):t=t.replace(/,/g,".")}else if(r){const l=t.split(".");if(l.length===2){const[,c]=l;if(c.length===3){const d=l.join("");/^[0-9]+$/.test(d)&&(t=d)}}else l.length>2&&(t=Ut(t))}if(t=t.replace(/,/g,""),t=Ut(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const s=Number.parseFloat(t);return Number.isFinite(s)?a?-s:s:Number.NaN}function D(e){return Tn(e)}function z(e){const t=Tn(e);if(!Number.isFinite(t))return 0;let n=t,i=0;for(;Math.abs(n)>1e5&&i<8;)n/=10,i+=1;return Number(n.toFixed(2))}function Le(e){return _(String(e??"")).trim().toLowerCase()}function qn(e=""){return _(String(e)).trim().toLowerCase()}const na=2;function ia(e){const t=D(e);return Number.isFinite(t)?t.toFixed(na):"0.00"}function Ot(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(_(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return z(i)}return 1}function aa(e={}){const t=e?.desc||e?.description||e?.name||"",n=qn(t),i=ia(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function oa(e=[]){const t=new Map;return e.forEach((n,i)=>{const a=aa(n);if(!a)return;if(!t.has(a)){const r=n?.desc||n?.description||n?.name||"",s=qn(r),l=Wt(n),c=n?.image||n?.imageUrl||n?.img||"";t.set(a,{key:a,description:r,normalizedDescription:s,unitPrice:l,image:c,items:[],itemIndices:[],barcodes:[]})}const o=t.get(a);o.items.push(n),o.itemIndices.push(i),n?.barcode&&o.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,a)=>i+Ot(a),0)})).map(n=>{const i=n.quantity||0,a=n.items.reduce((c,d)=>{const u=Wt(d),p=Ot(d);return c+u*p},0),o=z(a),r=D(n.unitPrice),s=Number.isFinite(r)?r:0,l=i>0?z(o/i):z(s);return{...n,quantity:i,count:i,totalPrice:o,unitPrice:l}})}function Qt(e={}){return(he(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??Le(n?.barcode),qty:(()=>{const i=Number.parseFloat(_(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),price:(()=>{const i=D(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})()}))}function lt(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(_(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function sa(e={},t=[],n=null){const i=e.unit_price??e.unitPrice??e.price,a=D(i);if(Number.isFinite(a)&&a>0)return z(a);const o=e.total_price??e.totalPrice??e.total,r=D(o),s=Number.parseFloat(_(String(n)).replace(/[^0-9.]/g,"")),l=Number.isFinite(s)&&s>0?s:lt(e);if(Number.isFinite(r)&&r>0&&l>0)return z(r/l);if(Array.isArray(t)&&t.length){const c=t.reduce((d,u)=>{const p=D(u.price??u.unit_price??u.unitPrice),y=Number.parseFloat(_(String(u.qty??u.quantity??1)).replace(/[^0-9.]/g,"")),b=Number.isFinite(y)&&y>0?y:1;return d+p*b},0);if(c>0&&l>0)return z(c/l)}return 0}function eo(e={}){const t=Array.isArray(e?.items)?e.items:[],n=oa(t),i=new Map,a=(u,p=0,y="packages")=>{if(!u||typeof u!="object")return;const h=Y(u?.package_code??u?.packageId??u?.package_id??u?.code??u?.id??u?.barcode??`pkg-${p}`)||`pkg-${p}`;if(!i.has(h)){i.set(h,{source:u,normalizedId:h,index:p,itemSource:y==="items"?u:null});return}const f=i.get(h);if(f.source||(f.source=u),y==="items"&&(f.itemSource=u,f.source&&typeof f.source=="object")){const I=Array.isArray(f.source.packageItems)&&f.source.packageItems.length>0,A=Array.isArray(u.packageItems)&&u.packageItems.length>0;!I&&A&&(f.source={...f.source,packageItems:u.packageItems}),!f.source.image&&u.image&&(f.source={...f.source,image:u.image})}};Array.isArray(e?.packages)&&e.packages.forEach((u,p)=>a(u,p,"packages")),t.forEach((u,p)=>{u&&typeof u=="object"&&(u.type==="package"||Array.isArray(u?.packageItems))&&a(u,p+i.size,"items")});const o=[],r=new Set,s=new Set;i.forEach(({source:u,itemSource:p=null,normalizedId:y},b)=>{const h=u||{},f=p&&typeof p=="object"?p:null;let I=Qt(h);(!Array.isArray(I)||I.length===0)&&f&&(I=Qt(f)),I.forEach(N=>{const k=N?.normalizedBarcode??Le(N?.barcode);k&&r.add(k);const j=N?.equipmentId??N?.equipment_id??null;j!=null&&s.add(String(j))});let A=lt(h);if(f){const N=lt(f);Number.isFinite(N)&&N>0&&(A=N)}(!Number.isFinite(A)||A<=0)&&(A=1);let C=sa(h,I,A);const P=[f?.price,f?.unit_price,f?.unitPrice];for(const N of P){const k=D(N);if(Number.isFinite(k)&&k>0){C=z(k);break}}C=z(C);const T=[f?.total,f?.total_price,f?.totalPrice,h?.total,h?.total_price,h?.totalPrice];let v=NaN;for(const N of T){const k=D(N);if(Number.isFinite(k)&&k>=0){v=k;break}}Number.isFinite(v)||(v=C*A),v=z(v);const B=[h?.displayCode,h?.display_code,h?.package_code,h?.packageCode,h?.code,h?.barcode,h?.packageId,h?.package_id,f?.displayCode,f?.display_code,f?.package_code,f?.packageCode,f?.code,f?.barcode,f?.packageId,f?.package_id,y,b].find(N=>N==null?!1:String(N).trim().length>0),q=B!=null?_(String(B)).trim():"";if(q){const N=Le(q);N&&r.add(N)}const $=I.map(N=>_(String(N?.barcode??N?.normalizedBarcode??""))).filter(Boolean),w=[h?.name,h?.package_name,h?.title,f?.name,f?.desc,f?.package_name,q,_(String(b))].find(N=>N!=null&&String(N).trim()!=="")||_(String(q||b)),Q=I.find(N=>N?.image)?.image??h?.image??f?.image??null;o.push({key:`package::${b}`,description:w,normalizedDescription:_(String(w)),unitPrice:C,totalPrice:v,quantity:A,count:A,image:Q,barcodes:$,barcode:q,package_code:q,packageDisplayCode:q,items:[{type:"package",packageItems:I,packageId:y,desc:w,price:C,qty:A,barcode:q}],type:"package",packageItems:I,packageId:y})});const l=new Set(Array.from(r).map(u=>Le(u)).filter(Boolean)),c=n.filter(u=>!(u.items.some(b=>b?.type==="package")&&o.length>0||u.items.every(b=>{const h=ra(b),f=h!=null?String(h):null;if(f&&s.has(f))return!0;const I=b?.barcode?Le(b.barcode):null;return!!(I&&l.has(I))})));return{groups:o.length?[...o,...c]:n,packageGroups:o,groupedItems:n,filteredGroupedItems:c,packagesMap:i}}function ra(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function Wt(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=D(n);if(Number.isFinite(i))return i}return 0}function to(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function ca(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function no(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,a=i!=null&&i!==""&&i!=="null",o=a?ca(t?.status??t?.status_label??t?.statusLabel??""):null,r=a&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:n,projectLinked:a,projectStatus:o,projectConfirmed:r,effectiveConfirmed:a?r:n}}const Fn=10;function Ln(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=D(n);if(Number.isFinite(i))return z(i)}return 0}function la(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=D(n);if(Number.isFinite(i))return z(i)}return Ln(e)}function ua(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=V();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,a)=>{const o=n.get(String(a));if(!o)return i;const r=Ln(o),s=la(o);return{costPerDay:i.costPerDay+(Number.isFinite(r)?r:0),totalPerDay:i.totalPerDay+(Number.isFinite(s)?s:0)}},{costPerDay:0,totalPerDay:0})}const da=1440*60*1e3,Ae=.01;function _e(e){if(e==null||e==="")return null;const t=_(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Kt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let a=Number.isFinite(e)?e:0;if(a<t&&(a=t),a>n&&(a=n),i!=null){const o=10**i;a=Math.round(a*o)/o}return a}function Bn(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function kt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:a=null,history:o=[]}={}){const r=Number.isFinite(Number(e))?Number(e):0,s=t==="amount"?"amount":t==="percent"?"percent":null;let l=_e(i),c=_e(a);const d=_e(n);let u=0,p=0;Array.isArray(o)&&o.length&&o.forEach(A=>{if(!A)return;const C=A.type==="amount"||A.type==="percent"?A.type:null,P=_e(A.value),T=_e(A.amount),v=_e(A.percentage);if(C==="amount"){const L=T??P;L!=null&&(u+=L,r>0&&(p+=L/r*100))}else if(C==="percent"){const L=v??P;L!=null&&(p+=L,r>0&&(u+=L/100*r))}else T!=null&&(u+=T,r>0&&(p+=T/r*100)),v!=null&&(p+=v,r>0&&(u+=v/100*r))});function y(A=[]){return!Array.isArray(A)||A.length===0?{costPerDay:0,totalPerDay:0}:A.reduce((C,P)=>{const T=D(P?.positionCost??P?.position_cost??P?.cost??P?.dailyWage??P?.daily_wage??0),v=D(P?.positionClientPrice??P?.position_client_price??P?.clientPrice??P?.dailyTotal??P?.daily_total??P?.total??0),L=Number.isFinite(T)?T:0,B=Number.isFinite(v)?v:0;return{costPerDay:C.costPerDay+L,totalPerDay:C.totalPerDay+B}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=y),s==="amount"&&d!=null?l=d:s==="percent"&&d!=null?c=d:s===null&&d!=null&&(c!=null?c=d:l=d),(l==null||l<=0)&&c!=null&&c>0&&r>0&&(l=r*(c/100)),(c==null||c<=0)&&l!=null&&l>0&&r>0&&(c=l/r*100);const b=l??0,h=c??0;l=b+u,c=h+p,l=Kt(l??0,{min:0,max:r>0?r:Number.POSITIVE_INFINITY,precision:2}),c=Kt(c??0,{min:0,max:100,precision:2});let f=s;return f||(l>0&&r>0?f="amount":c>0&&(f="percent")),{paidAmount:l,paidPercent:c,paymentProgressType:f,paymentProgressValue:f==="amount"?l:f==="percent"?c:null}}function Et({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const a=Bn(e),o=Number.isFinite(Number(i))?Number(i):0,r=Number.isFinite(Number(t))?Number(t):0,s=Number.isFinite(Number(n))?Number(n):0;if(a==="paid")return"paid";const l=o>0&&r>=o-Ae,c=s>=100-Ae*100;if(l||c)return"paid";const d=r>Ae||s>Ae;return a==="partial"||d?"partial":"unpaid"}function pa(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const a=i.getTime()-n.getTime();if(a<=0)return 1;const o=a/da;return Math.max(1,Math.ceil(o))}function Ee({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:a="percent",applyTax:o=!1,start:r=null,end:s=null,companySharePercent:l=null}={}){const c=pa(r,s),d=(e||[]).reduce((N,k)=>{const j=D(k?.qty??k?.quantity??k?.count??1),F=Number.isFinite(j)&&j>0?j:1,re=D(k?.price??k?.unit_price??k?.unitPrice),W=Number.isFinite(re)?re:0;return N+F*W},0),u=z(d*c),p=Array.isArray(n)?n:[],y=p.length?p.map(N=>N?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:b,totalPerDay:h}=p.length?calculateCrewDailyTotalsFromAssignments(p):ua(y),f=z(h*c),I=z(b*c),A=z(u+f),C=Number(i)||0;let P=a==="amount"?C:A*(C/100);(!Number.isFinite(P)||P<0)&&(P=0),P>A&&(P=A);const T=Math.max(0,A-P);let v=Number.isFinite(l)?Number(l):null;o&&(!Number.isFinite(v)||v<=0)&&(v=Fn);const L=v&&v>0?v:0,B=L>0?Math.max(0,T*(L/100)):0,q=T+B;let $=o?q*.15:0;(!Number.isFinite($)||$<0)&&($=0),$=Number($.toFixed(2));const m=q+$,w=Math.max(0,Number(m.toFixed(2))),Q=Math.max(0,Math.max(0,u+f-P)-I);return{rentalDays:c,equipmentTotal:u,crewTotal:f,crewCostTotal:I,discountAmount:P,subtotalAfterDiscount:T,taxableAmount:q,taxAmount:$,finalTotal:w,companySharePercent:L,companyShareAmount:B,netProfit:Q}}function io(e=[],t=0,n="percent",i=!1,a=[],{start:o=null,end:r=null,companySharePercent:s=null}={}){const l=p=>p&&typeof p=="object"&&(p.positionId!==void 0||p.position_id!==void 0||p.positionLabel!==void 0||p.position_name!==void 0||p.positionClientPrice!==void 0),c=Array.isArray(a)&&a.some(l)?a:[],d=c.length?c.map(p=>p?.technicianId).filter(Boolean):Array.isArray(a)?a:[];return Ee({items:e,technicianIds:d,crewAssignments:c,discount:t,discountType:n,applyTax:i,start:o,end:r,companySharePercent:s}).finalTotal}function Dn({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:a,paymentStatus:o,paidAmount:r=0,paidPercent:s=0,companySharePercent:l=null,companyShareAmount:c=null,taxAmount:d=null,netProfit:u=null,totalKey:p="reservations.summary.total"}){const y=g("reservations.create.summary.currency","SR"),b=_(String(e)),h=_(String(t)),f=_(String(n??1)),I=_(String(i)),A=Bn(o),C=A==="paid"?"مدفوع":A==="partial"?"مدفوع جزئياً":"غير مدفوع",P=g(`reservations.create.paymentStatus.${A}`,C),T=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,v=Number.isFinite(Number(s))?Math.max(0,Number(s)):0,L=T>Ae||v>Ae,B=g("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),q=_(T.toFixed(2)),$=_(v.toFixed(v%1?2:0)),m=g("reservations.summary.itemsLabel","📦 عدد المعدات"),w=g("reservations.summary.durationLabel","⏱️ عدد الأيام"),Q=g("reservations.summary.crewLabel","😎 عدد الفريق"),N=g("reservations.summary.taxLabelShort","🧾 الضريبة"),k=g("reservations.summary.paymentLabelShort","💳 حالة الدفع"),j=g(p.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),F=g("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),re=g("reservations.details.labels.netProfit","💵 صافي الربح"),W=Number.isFinite(u)?Math.max(0,Number(u)):null,de=[{label:m,value:h},{label:w,value:f},{label:Q,value:I}];if(a){let ee=g("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(d)&&d>0&&(ee=`${_(Number(d).toFixed(2))} ${y}`),de.push({label:N,value:ee})}const we=Number.isFinite(l)?Number(l):null;if(we!==null&&we>0){const ee=Number.isFinite(c)?Number(c):e*(we/100),Te=_(String(we)),On=_(Number.isFinite(ee)?ee.toFixed(2):"0"),Qn=`${Te}% (${On} ${y})`;de.push({label:F,value:Qn})}if(W!==null&&Math.abs(W-Number(e))>.009){const ee=_(W.toFixed(2));de.push({label:re,value:`${ee} ${y}`})}de.push({label:k,value:P}),L&&de.push({label:B,value:`${q} ${y} (${$}%)`});const Un=`${b} ${y}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${de.map(({label:ee,value:Te})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${ee}</span>
            ${Te?`<span class="reservation-summary-value">${Te}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${j}</span>
          <span class="reservation-summary-value">${Un}</span>
        </div>
      </div>
    </div>
  `}function ma({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:o=null,paymentProgressValue:r=null,start:s,end:l,companySharePercent:c=null,paymentHistory:d=[]}){const u=ea(),p=u.map(P=>P?.technicianId).filter(Boolean),y=u.length,b=Number.isFinite(c)?Number(c):null,h=Ee({items:e,technicianIds:p,crewAssignments:u,discount:t,discountType:n,applyTax:i,start:s,end:l,companySharePercent:b}),f=kt({totalAmount:h.finalTotal,progressType:o,progressValue:r,history:d}),I=Et({manualStatus:a,paidAmount:f.paidAmount,paidPercent:f.paidPercent,totalAmount:h.finalTotal}),A=Dn({total:h.finalTotal,itemsCount:e.length,rentalDays:h.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:I,paidAmount:f.paidAmount,paidPercent:f.paidPercent,companySharePercent:h.companySharePercent,companyShareAmount:h.companyShareAmount,taxAmount:h.taxAmount,netProfit:h.netProfit}),C={paymentStatus:I,paidAmount:f.paidAmount,paidPercent:f.paidPercent,paymentProgressType:f.paymentProgressType,paymentProgressValue:f.paymentProgressValue,total:h.finalTotal};return ma.lastResult=C,ga(A),A}function fa({items:e,discount:t,discountType:n,applyTax:i,paidStatus:a,paymentProgressType:o=null,paymentProgressValue:r=null,start:s,end:l,companySharePercent:c=null,paymentHistory:d=[]}){const u=ta(),p=u.map(P=>P?.technicianId).filter(Boolean),y=u.length,b=Number.isFinite(c)?Number(c):null,h=Ee({items:e,technicianIds:p,crewAssignments:u,discount:t,discountType:n,applyTax:i,start:s,end:l,companySharePercent:b}),f=kt({totalAmount:h.finalTotal,progressType:o,progressValue:r,history:d}),I=Et({manualStatus:a,paidAmount:f.paidAmount,paidPercent:f.paidPercent,totalAmount:h.finalTotal}),A=Dn({total:h.finalTotal,itemsCount:e.length,rentalDays:h.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:I,paidAmount:f.paidAmount,paidPercent:f.paidPercent,companySharePercent:h.companySharePercent,companyShareAmount:h.companyShareAmount,taxAmount:h.taxAmount,netProfit:h.netProfit,totalKey:"reservations.summary.totalAfterEdit"}),C={html:A,paymentStatus:I,paidAmount:f.paidAmount,paidPercent:f.paidPercent,paymentProgressType:f.paymentProgressType,paymentProgressValue:f.paymentProgressValue,total:h.finalTotal};return fa.lastResult=C,A}function ga(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Gt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Gt(n,e))}function Gt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const ha=V()||{};let J=(ha.reservations||[]).map(Ia);function pe(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const $n="__reservation_packages_cache__";function zn(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Rn(){const e=zn();if(!e)return{};try{const t=e.getItem($n);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function Yt(e){const t=zn();if(t)try{t.setItem($n,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function xn(e=[]){return Array.isArray(e)?e.map((t,n)=>Vn(t,n)).filter(Boolean).map((t,n)=>{const i=Y(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),a=Ge(t,i).map(c=>{const d=R(c.qty??c.quantity??c.count??c.units??c.unit_qty??c.unitQty??c.unit_count??c.unitCount??c.package_quantity??c.packageQty??1),u=pe(E(c.price??c.unit_price??0));return{...c,qty:d,quantity:d,price:u,unit_price:u}}),o=R(t.quantity??t.qty??1);let r=pe(E(t.unit_price??t.unitPrice??t.price??0));if(!r||r<=0){const c=a.reduce((d,u)=>d+(u.price||0)*(u.qty||1),0);c>0&&o>0&&(r=pe(Number((c/o).toFixed(2))))}const s=E(t.total_price??t.totalPrice??t.total??r*o),l=s>0?pe(s):pe(Number((r*o).toFixed(2)));return{...t,packageId:i,package_id:i,qty:o,quantity:o,unit_price:r,unitPrice:r,price:r,total_price:l,total:l,packageItems:a}}):[]}function Me(e,t){if(!e)return;const n=Rn(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],Yt(n));return}n[i]=xn(t),Yt(n)}function ya(e){if(!e)return[];const t=Rn(),n=String(e),i=t[n];return Array.isArray(i)?xn(i):[]}function ba(e,t=0){if(e==null)return null;if(typeof e!="object"){const f=e!=null?String(e):null;return{assignmentId:`crew-${t}-${f??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:f,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e.position_id??e.positionId??e.position??e.position_code??null,a=e.position_key??e.positionKey??e.position_code??e.positionId??null,o=e.position_name??e.positionName??e.role??e.position??"",r=e.position_label_ar??null,s=e.position_label_en??null,l=e.position_label_alt??s??r??"",c=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,u=pe(D(c)),p=pe(D(d)),y=e.technician_id??e.technicianId??e.id??e.userId??e.user_id??null,b=e.technician_name??e.technicianName??e.name??e.full_name??null,h=e.role??e.specialization??null;return{assignmentId:String(n),positionId:i!=null?String(i):null,positionKey:a!=null?String(a):null,positionLabel:o!=null?String(o):"",positionLabelAlt:l!=null?String(l):"",positionLabelAr:r!=null?String(r):null,positionLabelEn:s!=null?String(s):null,positionCost:Number.isFinite(u)?u:0,positionClientPrice:Number.isFinite(p)?p:0,technicianId:y!=null?String(y):null,technicianName:b!=null?String(b):null,technicianRole:h!=null?String(h):null,notes:e.notes??null}}function ao(){return J}function it(e){return J=Array.isArray(e)?e.map(qt):[],J.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Me(n,t.packages)}),J.length?console.debug("[reservationsService] setReservationsState first paymentHistory",J[0]?.paymentHistory):console.debug("[reservationsService] setReservationsState empty state"),Jt({reservations:J}),J}async function oo(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,l])=>{l!=null&&l!==""&&t.set(s,String(l))});const n=t.toString(),a=(await O(`/reservations/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(a)?o=a:a&&typeof a=="object"&&(Array.isArray(a.items)?o=a.items:Array.isArray(a.results)?o=a.results:Array.isArray(a.data)?o=a.data:Array.isArray(a.records)&&(o=a.records));const r=o.map(Tt);return it(r)}async function so(e){const t=await O("/reservations/",{method:"POST",body:e}),n=Tt(t?.data??{});if(!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const i=Ft(e.payment_history);i.length&&(n.paymentHistory=i)}if(Array.isArray(e?.packages)&&e.packages.length){const i=Dt({packages:e.packages});n.packages=ye(n.packages,i)}{const i=Bt(n.items||[],n.packages||[]);n.items=i.items,n.packages=ye(n.packages||[],i.packages)}if(Me(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const i=Ee({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=i.companyShareAmount,n.cost=i.finalTotal,n.totalAmount=i.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,it([...J,n]),n}async function _a(e,t){const n=await O(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=Tt(n?.data??{});if(console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const o=Ft(t.payment_history);o.length&&(i.paymentHistory=o,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if(Array.isArray(t?.packages)&&t.packages.length){const o=Dt({packages:t.packages});i.packages=ye(i.packages,o)}{const o=Bt(i.items||[],i.packages||[]);i.items=o.items,i.packages=ye(i.packages||[],o.packages)}if(Me(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const o=Ee({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=o.companyShareAmount,i.cost=o.finalTotal,i.totalAmount=o.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const a=J.map(o=>String(o.id)===String(e)?i:o);return it(a),i}async function ro(e){await O(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=J.filter(n=>String(n.id)!==String(e));it(t),Me(e,null)}async function co(e){return _a(e,{status:"confirmed",confirmed:!0})}function Tt(e={}){return qt({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records})}function Ia(e={}){return qt(e)}function qt(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(Aa):[],a=Dt(e);const o=Array.isArray(e.technicians)&&e.technicians.length?e.technicians:Array.isArray(e.techniciansDetails)?e.techniciansDetails:[],r=o.map((F,re)=>ba(F,re)).filter(Boolean),s=r.map((F,re)=>{const W=o?.[re];return{...W&&typeof W=="object"?{...W}:W!=null?{id:W}:{},...F}}),l=r.map(F=>F.technicianId).filter(F=>F!=null&&F!=="").map(F=>Number.isNaN(Number(F))?String(F):Number(F)),c=e.start??e.start_datetime??"",d=e.end??e.end_datetime??"";let u=E(e.total_amount??e.totalAmount??e.cost??0);const p=E(e.discount??0),y=e.discount_type??e.discountType??"percent",b=["percent","amount"].includes(y)?y:"percent",h=!!(e.apply_tax??e.applyTax??!1);let f=Ta(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const I=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),A=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,C=A!=null?Number.parseFloat(_(String(A).replace("%","").trim())):NaN,P=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let T=P!=null?P===!0||P===1||P==="1"||String(P).toLowerCase()==="true":Number.isFinite(C)&&C>0,v=T&&Number.isFinite(C)?Number(C):0;const L=e.company_share_amount??e.companyShareAmount;let B=Number.isFinite(Number(L))?Number(L):NaN;h&&v<=0&&(v=Fn,T=!0);const q=Ee({items:i,technicianIds:l,crewAssignments:r,discount:p,discountType:b,applyTax:h,start:c,end:d,companySharePercent:v>0?v:null});(!Number.isFinite(u)||u<=0||h)&&(u=q.finalTotal),(!Number.isFinite(B)||B<0)&&(B=q.companyShareAmount),B=Number.isFinite(B)?Number(B.toFixed(2)):0,!T&&v>0&&(T=!0);const $=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],m=Pa($),w=Ft(m),Q=t??n??e.reservation_code??e.reservationId??null;if(a.length)Me(Q,a);else{const F=ya(Q);F.length&&(a=ye(a,F))}const N=Bt(i,a);i=N.items,a=ye(a,N.packages);const k=kt({totalAmount:u,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:w});f=Et({manualStatus:f,paidAmount:k.paidAmount,paidPercent:k.paidPercent,totalAmount:u});const j=f==="paid";return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:c,end:d,status:Ea(e.status??(I?"confirmed":"pending")),confirmed:I,location:e.location??"",notes:e.notes??"",discount:p,discountType:b,applyTax:h,paid:j,paidStatus:f,paidAmount:k.paidAmount,paidPercent:k.paidPercent,paymentProgressType:k.paymentProgressType,paymentProgressValue:k.paymentProgressValue,paymentHistory:w,payment_history:w,totalAmount:u,cost:u,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:r,techniciansDetails:s,startDatetime:c,endDatetime:d,customerPhone:e.customer_phone??e.customerPhone??null,packages:a,companySharePercent:v,companyShareAmount:B,companyShareEnabled:T}}function Aa(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=E(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),a=_(String(e.barcode??e.code??e.serial??"")),o=e.description??e.desc??e.name??e.title??"",r={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:a,desc:o,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},s=Mn(e.type??e.item_type??e.kind??null),l=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,c=X(l),d=Ge(e,c);if(s==="package"||c||d.length){r.type="package";const u=c||(t!=null?String(t):r.id?X(r.id):"");u&&(r.packageId=u,r.package_id=u,r.package_code=e.package_code??e.packageCode??u),r.name=o||r.package_code||u||"",r.barcode=r.barcode||_(String(e.package_code??e.packageCode??"")),r.packageItems=d;const p=jn({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(r.price)||r.price<=0||r.price>p*10)&&(r.price=p),r.qtyPerPackage=d.length?d[0]?.qtyPerPackage??r.qtyPerPackage:r.qtyPerPackage,r.totalQuantity=n}return r}function lo({reservationCode:e,customerId:t,start:n,end:i,status:a,title:o,location:r,notes:s,projectId:l,totalAmount:c,discount:d,discountType:u,applyTax:p,paidStatus:y,confirmed:b,items:h,packages:f,crewAssignments:I=[],technicians:A=I,companySharePercent:C,companyShareEnabled:P,paidAmount:T,paidPercentage:v,paymentProgressType:L,paymentProgressValue:B,paymentHistory:q}){const $=Array.isArray(I)?I:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:a??"pending",title:o??null,location:r??null,notes:s??null,project_id:l||null,total_amount:c??0,discount:d??0,discount_type:u??"percent",apply_tax:p?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(T)?E(T):0,paid_percentage:Number.isFinite(v)?Number(v.toFixed(2)):0,payment_progress_type:L??null,payment_progress_value:Number.isFinite(B)?Number(B.toFixed(2)):null,payment_history:Array.isArray(q)?q.map(m=>({type:ut(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?E(m.value):null,amount:m?.amount!=null?E(m.amount):m?.payment_amount!=null?E(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],payments:Array.isArray(q)?q.map(m=>({type:ut(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?E(m.value):null,amount:m?.amount!=null?E(m.amount):m?.payment_amount!=null?E(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],confirmed:b===void 0?null:!!b,items:Na(h),packages:va(h,f),company_share_percent:P&&Number.isFinite(C)?Number(C):null,company_share_enabled:P?1:0,technicians:$.length?$.map((m,w)=>{const Q=m.technicianId??m.technician_id??m.id??null,N=m.positionId??m.position_id??m.position??m.position_code??null,k=m.positionLabel??m.position_name??m.role??null,j=E(m.positionCost??m.position_cost??m.cost??m.daily_wage??m.dailyWage??0),F=E(m.positionClientPrice??m.position_client_price??m.client_price??m.clientPrice??m.daily_total??m.dailyTotal??m.total??0);return{id:Q,technician_id:Q,role:k??m.technicianRole??null,notes:m.notes??null,position_id:N,position_key:m.positionKey??m.position_key??null,position_name:k,position_label_ar:m.positionLabelAr??m.position_label_ar??null,position_label_en:m.positionLabelEn??m.position_label_en??null,position_cost:j,position_client_price:F,client_price:F,cost:j,assignment_id:m.assignmentId??m.assignment_id??`crew-${w}`}}):Array.isArray(A)?A.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function Ft(e){const t=Lt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,a=ut(i),o=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,r=o!=null?Number.parseFloat(_(String(o))):null,s=n.amount!=null?Number.parseFloat(_(String(n.amount))):n.payment_amount!=null?Number.parseFloat(_(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(_(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(_(String(n.payment_percentage))):null,c=Number.isFinite(s)?s:a==="amount"&&Number.isFinite(r)?r:null,d=Number.isFinite(l)?l:a==="percent"&&Number.isFinite(r)?r:null,u=a??(c!=null?"amount":d!=null?"percent":null),p=u==="amount"?c:u==="percent"?d:Number.isFinite(r)?r:null,y=n.note??n.notes??n.comment??n.payment_note??null,b=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:u,value:p,amount:c,percentage:d,note:y,recordedAt:b}}).filter(n=>n&&n.type)}function ut(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Lt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const r of t)if(Array.isArray(e[r]))return e[r];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(r=>Array.isArray(r));if(Array.isArray(i))return i;const a=Object.values(e);if(a.length&&a.every(r=>r&&typeof r=="object")){const r=a.map(s=>s);if(r.every(s=>!Array.isArray(s)))return r}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(r=>r in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Lt(t)}catch{return[]}return[]}function Pa(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Lt(t);if(Array.isArray(n)&&n.length)return n}return[]}function Na(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object")return;if(n.type==="package"&&Array.isArray(n.packageItems)&&n.packageItems.length){const a=R(n.qty??n.quantity??1);n.packageItems.forEach(o=>{const r=o?.equipmentId??o?.equipment_id??o?.id??null;if(r==null)return;const s=R(o?.qty??o?.quantity??1),l=a*s;t.push({equipment_id:dt(r),quantity:l,unit_price:E(o?.price??o?.unit_price??0),notes:o?.notes??null})});return}const i=n.equipmentId??n.equipment_id??n.id??null;i!=null&&t.push({equipment_id:dt(i),quantity:R(n.qty??n.quantity??1),unit_price:E(n.price??n.unit_price??0),notes:n.notes??null})}),t}function dt(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function va(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const a=R(i.qty??i.quantity??1),o=Array.isArray(i.packageItems)?i.packageItems.map(r=>{const s=r?.equipmentId??r?.equipment_id??r?.id??null;return s==null?null:{equipment_id:dt(s),quantity:R(r?.qty??r?.quantity??r?.count??r?.units??r?.unit_qty??r?.unitQty??r?.unit_count??r?.unitCount??r?.package_quantity??r?.packageQty??1),unit_price:E(r?.price??r?.unit_price??0)}}).filter(Boolean):[];n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:a,unit_price:E(i.price??i.unit_price??0),items:o})}),n}function Mn(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function X(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return Y(t)}function pt(e){return e==null?"":_(String(e)).trim().toLowerCase()}function wn(e={},t=1){if(!e||typeof e!="object"){const l=_(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,barcode:l,normalizedBarcode:pt(l),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=E(e.unit_price??e.unitPrice??e.price??0),o=_(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),r=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let s;if(r!=null)s=R(r,{fallback:1,max:99});else if(t>0){const l=i/t;Number.isFinite(l)&&l>0&&Number.isInteger(l)?s=R(l,{fallback:1,max:99}):s=Math.min(i,99)}else s=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:s,quantity:s,qtyPerPackage:s,totalQuantity:i,price:a,unit_price:a,barcode:o,normalizedBarcode:pt(e.normalizedBarcode??o),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function Sa(e={},t={}){const n=X(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=R(e.quantity??e.qty??t.qty??t.quantity??1,{fallback:1,max:9999}),a=E(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),o=_(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:o,desc:t.desc??t.description??e.name??e.desc??e.title??o,qty:i,quantity:i,price:a,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:o,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function Bt(e=[],t=[]){const n=Ca(e),i=Array.isArray(t)?ye(t,n.packages):n.packages,a=new Map;return i.forEach(o=>{const r=X(o.packageId??o.package_id??o.id);r&&a.set(r,o)}),n.packages.forEach(o=>{const r=X(o.packageId??o.package_id??o.id);if(!r)return;const s=a.get(r);s&&((!Array.isArray(s.packageItems)||s.packageItems.length===0)&&(s.packageItems=o.packageItems),!s.name&&o.name&&(s.name=o.name),!s.image&&o.image&&(s.image=o.image))}),{items:n.items,packages:Array.from(a.values())}}function Ca(e=[]){const t=new Map;if(e.forEach(o=>{const r=X(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(!r)return;const s=r;t.has(s)||t.set(s,{base:o,items:[]}),t.get(s).items.push(o)}),!t.size)return{items:e,packages:[]};const n=[],i=[],a=new Set;return e.forEach(o=>{const r=X(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(r&&t.has(r)){if(a.has(r))return;const s=t.get(r),l=s.base||o,c=s.items.map(u=>wn(u,1)),d={packageId:r,package_id:r,package_code:l.package_code??l.packageCode??l.barcode??_(String(r)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${r}`,quantity:R(l.package_quantity??l.packageQty??l.qty??1,{fallback:1,max:9999}),unit_price:E(l.package_price??l.packagePrice??l.price??0),packageItems:c,image:l.image??null};i.push(d),n.push(Sa(d,l)),a.add(r);return}n.push(o)}),{items:n,packages:i}}function Ge(e={},t=""){if(!e||typeof e!="object")return[];const n=X(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let a=he({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),o=[];if((!Array.isArray(a)||a.length===0)&&n){const c=We(n);c&&(a=he(c),o=Array.isArray(a)?a:[])}else if(n){const c=We(n);c&&(o=he(c)||[])}if(!Array.isArray(a)||a.length===0)return[];const r=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),s=a.map(c=>wn(c,r));if(o.length){const c=new Map;o.forEach(d=>{if(!d)return;const u=pt(d.barcode)||(d.equipmentId!=null?`id:${d.equipmentId}`:null)||(d.equipment_id!=null?`id:${d.equipment_id}`:null);u&&c.set(u,d)}),s.forEach(d=>{const u=d.normalizedBarcode||(d.equipmentId?`id:${d.equipmentId}`:null);if(!u||!c.has(u))return;const p=c.get(u),y=R(p.quantity??p.qty??1,{fallback:d.qtyPerPackage??1,max:99});d.qtyPerPackage=y,d.qty=y,d.quantity=y;const b=E(p.unit_price??p.unitPrice??p.price??d.price);d.price=b,d.unit_price=b,!d.desc&&p.desc&&(d.desc=p.desc),!d.image&&p.image&&(d.image=p.image)})}const l=new Map;return s.forEach(c=>{const d=c.normalizedBarcode||(c.equipmentId?`id:${c.equipmentId}`:null);if(d){if(l.has(d)){const u=l.get(d);u.qty+=c.qty,u.quantity+=c.quantity,(!Number.isFinite(u.qtyPerPackage)||u.qtyPerPackage<=0)&&(u.qtyPerPackage=c.qtyPerPackage),(!u.price||u.price===0)&&c.price&&(u.price=c.price,u.unit_price=c.unit_price),!u.desc&&c.desc&&(u.desc=c.desc),!u.image&&c.image&&(u.image=c.image);return}l.set(d,{...c})}}),Array.from(l.values())}function jn(e={},t=[],n=1){if(Array.isArray(t)&&t.length){const a=t.reduce((o,r)=>{const s=Number.isFinite(Number(r.price))?Number(r.price):0,l=Number.isFinite(Number(r.qtyPerPackage))&&Number(r.qtyPerPackage)>0?Number(r.qtyPerPackage):Number.isFinite(Number(r.qty))&&Number(r.qty)>0?Number(r.qty):1;return o+s*l},0);if(a>0)return Number(a.toFixed(2))}const i=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(i))){const a=E(i);return n>0?Number((a/n).toFixed(2)):a}return Number.isFinite(Number(e.unit_price??e.unitPrice??e.price))?E(e.unit_price??e.unitPrice??e.price):0}function Hn(e,t){if(!e)return t;if(!t)return e;const n={...e},i=a=>{(n[a]===void 0||n[a]===null||n[a]==="")&&(n[a]=t[a])};return["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price),(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=ka(n.packageItems,t.packageItems),n.items=n.packageItems),n}function ka(e=[],t=[]){const n=new Map,i=a=>{a.forEach(o=>{if(!o)return;const r=o.normalizedBarcode||(o.equipmentId?`id:${o.equipmentId}`:null);if(r){if(n.has(r)){const s=n.get(r);s.qty+=o.qty??0,s.quantity+=o.quantity??0,(!Number.isFinite(s.qtyPerPackage)||s.qtyPerPackage<=0)&&Number.isFinite(o.qtyPerPackage)&&(s.qtyPerPackage=o.qtyPerPackage),(!s.price||s.price===0)&&o.price&&(s.price=o.price,s.unit_price=o.unit_price),!s.desc&&o.desc&&(s.desc=o.desc),!s.image&&o.image&&(s.image=o.image);return}n.set(r,{...o})}})};return i(e),i(t),Array.from(n.values())}function ye(e=[],t=[]){const n=[],i=new Map,a=o=>{Array.isArray(o)&&o.forEach(r=>{if(!r||typeof r!="object")return;const s=r.packageId||r.package_id||r.package_code||r.id;if(s)if(i.has(s)){const l=i.get(s);n[l]=Hn(n[l],r)}else i.set(s,n.length),n.push({...r})})};return a(e),a(t),n}function Vn(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const u=X(e),p=u?We(u):null,y=p?Ge(p,u):[],b=p?E(p.price??p.unit_price??p.unitPrice??0):0,h=1,f=Number((b*h).toFixed(2));return{id:`package::${u||t}`,packageId:u||`pkg-${t}`,package_id:u||`pkg-${t}`,package_code:_(String(e))||u||`pkg-${t}`,name:p?.name??p?.package_name??p?.packageName??_(String(e))??"",desc:p?.name??_(String(e))??"",quantity:h,qty:h,unit_price:b,unitPrice:b,price:b,total:f,total_price:f,barcode:_(String(e)),packageItems:y,items:y,type:"package",image:p?.image??null}}if(typeof e!="object")return null;const n=X(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=R(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),a=Ge(e,n),o=jn(e,a,i),r=e.total_price??e.totalPrice??e.total??o*i,s=Number.isFinite(Number(r))?E(r):Number((o*i).toFixed(2)),l=e.package_code??e.packageCode??e.code??n,c=_(String(e.barcode??l??"")),d=e.image??e.cover??e.thumbnail??a.find(u=>u.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:l,name:e.name??e.package_name??e.packageName??e.title??e.description??l??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??l??n,quantity:i,qty:i,unit_price:o,unitPrice:o,price:o,total:s,total_price:s,barcode:c,packageItems:a,items:a,type:"package",image:d}}function Dt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,a=(s,l=n.length)=>{const c=Vn(s,l);if(!c)return;const d=c.packageId||c.package_code||c.id||`pkg-${l}`;if(i.has(d)){const u=i.get(d);n[u]=Hn(n[u],c)}else i.set(d,n.length),n.push(c)};t.forEach(s=>{s.forEach((l,c)=>{a(l,c+n.length)})}),n.length===0&&e.package&&a(e.package,0);const o=Array.isArray(e.items)?e.items:[],r=(s={})=>!s||typeof s!="object"?!1:!!(Mn(s.type??s.item_type??s.kind??null)==="package"||s.packageItems&&Array.isArray(s.packageItems)&&s.packageItems.length||s.items&&Array.isArray(s.items)&&s.items.length&&s.items.every(c=>typeof c=="object")||s.packageId||s.package_id||s.package_code||s.packageCode||s.bundleId||s.bundle_id);return o.forEach((s,l)=>{r(s)&&a(s,n.length+l)}),n}function E(e){const t=D(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function R(e,{fallback:t=1,max:n=1e6}={}){const i=D(e);if(!Number.isFinite(i))return t;const a=Math.round(i);return a<=0||a>n?t:a}function Ea(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return"pending"}}function Ta(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function uo(e){return e instanceof Oe}export{ja as $,Wa as A,qi as B,Va as C,Fn as D,Ma as E,ea as F,ma as G,He as H,Y as I,Ra as J,Di as K,$a as L,Ka as M,oa as N,Qa as O,We as P,Ei as Q,Ti as R,wa as S,ra as T,Ua as U,xa as V,aa as W,za as X,Ui as Y,lo as Z,so as _,oo as a,Ja as a0,Ha as a1,Oa as a2,eo as a3,z as a4,D as a5,Ee as a6,qt as a7,ro as a8,co as a9,fa as aa,ta as ab,Za as ac,Ya as ad,Ia as ae,Xa as b,uo as c,La as d,no as e,Da as f,ao as g,he as h,Ga as i,kt as j,Et as k,Qe as l,mt as m,K as n,Tt as o,gn as p,pa as q,ti as r,yn as s,Fa as t,me as u,Ba as v,io as w,to as x,_a as y,qn as z};
