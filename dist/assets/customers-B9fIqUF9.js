import{e as D,h as j,t as i,k as F,n as _,b as L,A as $,j as l,o as O,s as V}from"./auth-CXJ9BVF7.js";let g=null,T=!1,v="";const q=D()||{};let S=(q.customers||[]).map(E),m=null;function N(t){if(!t||typeof t!="object")return null;let e=t.data??t.base64??t.content??"";if(typeof e=="string"&&(e=e.trim(),e.startsWith("data:"))){const n=e.indexOf(",");e=n!==-1?e.slice(n+1):e}return e?{fileName:t.fileName??t.filename??t.name??"",mimeType:t.mimeType??t.contentType??t.type??"application/octet-stream",data:e}:null}function U(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function E(t={}){if(!t||typeof t!="object")return{id:"",full_name:"",customerName:"",name:"",phone:"",email:"",address:"",company:"",notes:"",created_at:null,updated_at:null};const e=t.id??t.customerId??t.reservationId??t.customerID,n=t.full_name??t.customerName??t.name??"",o=typeof n=="string"?n.trim():String(n||"").trim(),s=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",a=N(t.document??t.attachment??t.file);return{id:e!=null?String(e):"",full_name:o,customerName:o,name:o,phone:t.phone??t.phoneNumber??"",email:t.email??"",address:t.address??"",company:t.company??t.companyName??"",notes:t.notes??"",tax_id:typeof s=="string"?s.trim():String(s||"").trim(),taxId:typeof s=="string"?s.trim():String(s||"").trim(),document:a,created_at:t.created_at??null,updated_at:t.updated_at??null}}function k(){document.dispatchEvent(new CustomEvent("customers:changed"))}function I(){return S}function x(t){S=Array.isArray(t)?t.map(E):[],V({customers:S})}function f(){return{form:document.getElementById("customer-form"),idInput:document.getElementById("customer-id"),nameInput:document.getElementById("customer-name"),phoneInput:document.getElementById("customer-phone"),emailInput:document.getElementById("customer-email"),addressInput:document.getElementById("customer-address"),companyInput:document.getElementById("customer-company"),notesInput:document.getElementById("customer-notes"),taxInput:document.getElementById("customer-tax-id"),documentInput:document.getElementById("customer-document"),documentNameLabel:document.getElementById("customer-document-name"),documentPreviewBtn:document.getElementById("customer-document-preview"),submitBtn:document.getElementById("submit-btn"),cancelBtn:document.getElementById("customer-cancel-btn")}}function h(){const{documentNameLabel:t,documentPreviewBtn:e}=f(),n=!!m?.data;if(e&&(e.disabled=!n),t){const o=i("customers.form.document.empty","لم يتم اختيار ملف بعد");if(n){const s=m.fileName?.trim()||i("customers.form.document.selected","تم إرفاق ملف.");t.textContent=s}else t.textContent=o}}function C(t="add"){const{submitBtn:e}=f();if(!e)return;const n=t==="update"?"customers.form.actions.update":"customers.form.actions.submit",o=t==="update"?"💾 حفظ التعديل":"➕ إضافة عميل";e.textContent=i(n,o)}function A(t){const{cancelBtn:e}=f();e&&(t?e.classList.remove("d-none"):e.classList.add("d-none"),e.textContent=i("customers.form.actions.cancel","إلغاء التعديل"))}function M(){const t=!!g;C(t?"update":"add"),A(t),h()}function H(){const{form:t,idInput:e,phoneInput:n}=f();t?.reset(),e&&(e.value=""),n&&(n.value=n.value.trim()),m=null,h(),g=null,C("add"),A(!1)}function w(t){const{idInput:e,nameInput:n,phoneInput:o,emailInput:s,addressInput:a,companyInput:c,notesInput:r,taxInput:u,documentInput:d}=f();!t||!n||!o||(e&&(e.value=t.id),n.value=t.full_name||"",o.value=_(t.phone||""),s&&(s.value=t.email||""),a&&(a.value=t.address||""),c&&(c.value=t.company||""),r&&(r.value=t.notes||""),u&&(u.value=t.tax_id||""),d&&(d.value=""),m=t.document?{...t.document}:null,h(),g=t.id,C("update"),A(!0))}function z(){const{idInput:t,nameInput:e,phoneInput:n,emailInput:o,addressInput:s,companyInput:a,notesInput:c,taxInput:r}=f();if(!e||!n)return null;const u=e.value.trim(),d=_(n.value.trim());if(n.value=d,!u||!d)return l(i("customers.toast.missingFields","يرجى تعبئة الاسم ورقم الهاتف"),"error"),null;const p={full_name:u,phone:d,email:o?.value.trim()||"",address:s?.value.trim()||"",company:a?.value.trim()||"",notes:c?.value.trim()||""},b=r?.value.trim()||"";return p.tax_id=b,p.taxId=b,m?.data&&(p.document=m),{payload:p,id:t?.value||g||""}}function W(t){const{documentInput:e}=f(),n=t.target?.files&&t.target.files[0];if(!n){h(),e&&(e.value="");return}const o=new FileReader;o.onload=()=>{const s=typeof o.result=="string"?o.result:"",a=s.includes(",")?s.split(",")[1]:s;m={fileName:n.name,mimeType:n.type||"application/octet-stream",data:a},h(),e&&(e.value="")},o.readAsDataURL(n)}function G(t){return t?.data?`data:${t.mimeType||"application/octet-stream"};base64,${t.data}`:""}function P(t,e=""){if(!t?.data){l(i("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const n=document.getElementById("customerDocumentModal");if(!n)return;const o=document.getElementById("customer-document-preview-container"),s=document.getElementById("customer-document-download"),a=document.getElementById("customer-document-modal-title");a&&(a.textContent=e||t.fileName||i("customers.documents.modalTitle","📎 ملف العميل"));const c=G(t);if(s&&(s.href=c,s.download=t.fileName||"customer-document"),o){const u=(t.mimeType||"").toLowerCase();u.startsWith("image/")?o.innerHTML=`<img src="${c}" alt="${U(t.fileName||"customer document")}" class="img-fluid">`:u==="application/pdf"||u.includes("pdf")?o.innerHTML=`<iframe src="${c}" title="${U(t.fileName||"customer document")}" class="customer-document-frame w-100"></iframe>`:o.innerHTML=`<p class="text-muted">${i("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل.")}</p>`}bootstrap.Modal.getOrCreateInstance(n).show()}function J(){if(!m?.data){l(i("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const{nameInput:t}=f(),n=t?.value?.trim()||""||i("customers.documents.modalTitle","📎 ملف العميل"),o=m.fileName?`${n} - ${m.fileName}`.trim():n;P(m,o)}async function R({showToastOnError:t=!0}={}){T=!0,v="",y();try{const e=await L("/customers/"),n=Array.isArray(e?.data)?e.data.map(E):[];x(n)}catch(e){v=e instanceof $?e.message:i("customers.toast.fetchFailed","تعذر تحميل قائمة العملاء"),t&&l(v,"error")}finally{T=!1,y()}}async function K(t){t.preventDefault();const e=z();if(!e)return;const{payload:n}=e,o=!!g;try{if(o){const s=g,a=await L(`/customers/?id=${encodeURIComponent(s)}`,{method:"PATCH",body:n}),c=E(a?.data),r=N(n.document),u={...c,document:c.document??r,tax_id:c.tax_id??n.tax_id??"",taxId:c.taxId??n.taxId??""},d=I().map(p=>String(p.id)===String(s)?u:p);x(d),l(i("customers.toast.updateSuccess","تم تحديث بيانات العميل بنجاح"))}else{const s=await L("/customers/",{method:"POST",body:n}),a=E(s?.data),c=N(n.document),r={...a,document:a.document??c,tax_id:a.tax_id??n.tax_id??"",taxId:a.taxId??n.taxId??""},u=[...I(),r];x(u),l(i("customers.toast.createSuccess","تمت إضافة العميل بنجاح"))}y(),H(),k()}catch(s){const a=s instanceof $?s.message:i("customers.toast.submitFailed","حدث خطأ أثناء حفظ بيانات العميل");l(a,"error")}}async function Q(t){const e=t.target;if(!(e instanceof HTMLElement))return;const n=e.closest("button");if(n instanceof HTMLElement){if(n.classList.contains("customer-delete-btn")){if(!F()){O();return}const o=n.dataset.id;if(!confirm(i("customers.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العميل؟")))return;try{await L(`/customers/?id=${encodeURIComponent(o)}`,{method:"DELETE"});const s=I().filter(a=>String(a.id)!==String(o));x(s),y(),String(g)===String(o)&&H(),l(i("customers.toast.deleteSuccess","تم حذف العميل")),k()}catch(s){const a=s instanceof $?s.message:i("customers.toast.deleteFailed","تعذر حذف العميل، يرجى المحاولة مجدداً");l(a,"error")}return}if(n.classList.contains("customer-view-file-btn")){const o=n.dataset.id,s=I().find(r=>String(r.id)===String(o));if(!s?.document){l(i("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const a=[s.full_name,s.document.fileName].filter(Boolean),c=a.length?a.join(" - "):void 0;P(s.document,c);return}if(n.classList.contains("customer-edit-btn")){const o=n.dataset.id,s=I().find(a=>String(a.id)===String(o));if(!s)return;w(s)}}}function X(t){const e=t.target.value.trim().toLowerCase(),o=I().filter(a=>{const c=a.full_name?.toLowerCase()||"",r=a.phone?.toLowerCase()||"",u=a.company?.toLowerCase()||"";return c.includes(e)||r.includes(e)||u.includes(e)}),s=e?i("customers.table.noResults","لا توجد نتائج مطابقة"):void 0;y(o,{emptyMessage:s})}function Y(){const{form:t,cancelBtn:e}=f();t&&t.addEventListener("submit",K);const{documentInput:n,documentPreviewBtn:o}=f();n&&!n.dataset.listenerAttached&&(n.addEventListener("change",W),n.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",J),o.dataset.listenerAttached="true"),e&&e.addEventListener("click",()=>{H()});const s=document.getElementById("customers-table");s&&s.addEventListener("click",Q);const a=document.getElementById("search-customer-input");a&&a.addEventListener("input",X),h()}document.addEventListener("DOMContentLoaded",()=>{Y(),y(),M(),R()});document.addEventListener("language:changed",()=>{M(),y()});document.addEventListener("customers:refreshRequested",()=>{R({showToastOnError:!1}),M()});document.addEventListener(j.USER_UPDATED,()=>{y()});function y(t,e={}){const n=Array.isArray(t),o=n?t:I(),s=document.getElementById("customers-table");if(!s)return;if(s.innerHTML="",!n){if(T){s.innerHTML=`<tr><td colspan='5'>${i("customers.table.loading","جاري التحميل...")}</td></tr>`;return}if(v){s.innerHTML=`<tr><td colspan='5' class='text-danger'>${v}</td></tr>`;return}}if(o.length===0){const d=e.emptyMessage||i("customers.table.empty","لا يوجد عملاء");s.innerHTML=`<tr><td colspan='5'>${d}</td></tr>`;return}const a=i("customers.actions.edit","✏️ تعديل"),c=i("customers.actions.delete","🗑️ حذف"),r=i("customers.actions.viewDocument","📎 عرض المستند"),u=F();o.forEach(d=>{const p=g&&String(g)===String(d.id),b=document.createElement("tr");p&&b.classList.add("customer-table-row-editing");const B=[`<button type="button" class="customer-action-btn customer-action-btn--edit customer-edit-btn" data-id="${d.id}">${a}</button>`];d.document?.data&&B.push(`<button type="button" class="customer-action-btn customer-action-btn--file customer-view-file-btn" data-id="${d.id}">${r}</button>`),u&&B.push(`<button type="button" class="customer-action-btn customer-action-btn--delete customer-delete-btn" data-id="${d.id}">${c}</button>`),b.innerHTML=`
      <td><a href="customer.html?id=${d.id}" class="text-decoration-none">${d.full_name}</a></td>
      <td>${_(d.phone)}</td>
      <td>${d.company||""}</td>
      <td class="table-notes-cell">${d.notes||"—"}</td>
      <td class="table-actions-cell">
        <div class="table-action-buttons">
          ${B.join("")}
        </div>
      </td>
    `,s.appendChild(b)})}export{y as r};
