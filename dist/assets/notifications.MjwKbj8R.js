import{r as M,a as j,c as H,g as P,j as c,b as h,t as b}from"./auth.CYxRUoWL.js";import{i as N}from"./dashboardShell.DF2kUed9.js";M({ar:{notifications:{title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",header:"ğŸ”” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",subtitle:"Ø£Ø±Ø³Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„ÙØ±ÙŠÙ‚ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª/Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.",form:{entityType:"Ø§Ù„Ù†ÙˆØ¹",entity:{reservation:"Ø­Ø¬Ø²",project:"Ù…Ø´Ø±ÙˆØ¹"},search:"Ø¨Ø­Ø«","search.placeholder":"Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"},table:{headers:{code:"Ø§Ù„ÙƒÙˆØ¯",title:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",when:"Ø§Ù„ÙˆÙ‚Øª",customer:"Ø§Ù„Ø¹Ù…ÙŠÙ„",actions:"Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"},loading:"â³ Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«â€¦",select:"Ø§Ø®ØªÙŠØ§Ø±"},channels:{email:"Ø¥ÙŠÙ…ÙŠÙ„",telegram:"ØªÙ„ÙŠØºØ±Ø§Ù…"},compose:{title:"âœ‰ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø©",recipients:"Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†",toTechnicians:"Ø§Ù„ÙÙ†ÙŠÙˆÙ† Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†ÙˆÙ†",toAdmins:"Ø§Ù„Ø¥Ø¯Ù…Ù†",subject:"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹",body:"Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©",templates:{reminder:"ğŸ“Œ ØªØ°ÙƒÙŠØ±",note:"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©"},send:"ğŸš€ Ø¥Ø±Ø³Ø§Ù„",sentOk:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"},logs:{title:"ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",subtitle:"ØªØ§Ø¨Ø¹ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ­Ø§Ù„Ø© ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©.",refresh:"ğŸ”„ ØªØ­Ø¯ÙŠØ«",clear:"ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„",prev:"Ø§Ù„Ø³Ø§Ø¨Ù‚",next:"Ø§Ù„ØªØ§Ù„ÙŠ",filters:{allEntities:"ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹",allChannels:"ÙƒÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª",allStatuses:"ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª",sent:"Ù…Ø±Ø³Ù„Ø©",failed:"ÙØ§Ø´Ù„Ø©","q.placeholder":"Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/Ø§Ù„Ù…Ø¹Ø±Ù‘Ù"},headers:{time:"Ø§Ù„ÙˆÙ‚Øª",event:"Ø§Ù„Ø­Ø¯Ø«",entity:"Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø¹Ø±Ù",recipient:"Ø§Ù„Ù…Ø³ØªÙ„Ù…",channel:"Ø§Ù„Ù‚Ù†Ø§Ø©",status:"Ø§Ù„Ø­Ø§Ù„Ø©",error:"Ø§Ù„Ø®Ø·Ø£"},empty:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.",loading:"â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"}}}});j();N();const t={};let y=null,B=null;function s(n){return document.querySelector(n)}function R(){t.entityType=s("#notif-entity-type"),t.search=s("#notif-search"),t.resultsBody=s("#notif-results-body"),t.composeSection=s("#notif-compose-section"),t.selectedSummary=s("#notif-selected-summary"),t.chEmail=s("#notif-channel-email"),t.chTelegram=s("#notif-channel-telegram"),t.toTechs=s("#notif-to-techs"),t.toAdmins=s("#notif-to-admins"),t.extraEmails=s("#notif-extra-emails"),t.extraChatIds=s("#notif-extra-chatids"),t.subject=s("#notif-subject"),t.body=s("#notif-body"),t.sendBtn=s("#notif-send-btn"),t.previewBtn=s("#notif-preview-btn"),t.previewBox=s("#notif-preview"),t.tReminder=s("#notif-template-reminder"),t.tNote=s("#notif-template-note"),t.logEntity=s("#log-filter-entity"),t.logChannel=s("#log-filter-channel"),t.logStatus=s("#log-filter-status"),t.logQ=s("#log-filter-q"),t.logRefresh=s("#log-refresh-btn"),t.logClear=s("#log-clear-btn"),t.logBody=s("#notif-logs-body"),t.logPagination=s("#log-pagination"),t.tgSearch=s("#tg-tech-search"),t.tgSearchBtn=s("#tg-tech-search-btn"),t.tgRefreshBtn=s("#tg-tech-refresh-btn"),t.tgBody=s("#tg-tech-body"),t.tgAdminGenBtn=s("#tg-admin-gen-btn"),t.tgAdminCopyBtn=s("#tg-admin-copy-btn"),t.tgAdminBody=s("#tg-admin-body"),t.tgAdminLinkBox=s("#tg-admin-link-box")}function x(n,e){const a=n.start_datetime||n.startDate||"",i=n.end_datetime||n.endDate||"";return a&&i&&a!==i?`${a} â€” ${i}`:a||i||""}function q(n,e){if(!Array.isArray(n)||n.length===0){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${b("notifications.table.loading","Ù„Ø§ Ù†ØªØ§Ø¦Ø¬")}</td></tr>`;return}t.resultsBody.innerHTML=n.map(a=>{const i=e==="reservation"?a.reservation_code||"":a.project_code||"",r=a.title||"",o=x(a),g=e==="reservation"?a.customer_name||"":a.client_name||"";return`
      <tr>
        <td>${i||"â€”"}</td>
        <td>${r||"â€”"}</td>
        <td>${o||"â€”"}</td>
        <td>${g||"â€”"}</td>
        <td><button type="button" class="btn btn-sm btn-primary" data-select-id="${a.id}" data-select-type="${e}">${b("notifications.table.select","Ø§Ø®ØªÙŠØ§Ø±")}</button></td>
      </tr>
    `}).join("")}async function L(){const n=t.entityType.value,e=(t.search.value||"").trim();try{const a=n==="reservation"?"/reservations/":"/projects/",i=new URLSearchParams;e!==""&&i.set("search",e),i.set("limit","20");const r=await h(`${a}?${i.toString()}`);q(r?.data??[],n)}catch(a){console.error(a),t.resultsBody.innerHTML='<tr><td colspan="5" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</td></tr>'}}function O(){B&&clearTimeout(B),B=setTimeout(L,350)}function G(n,e){const a=n==="reservation"?e.reservation_code||"":e.project_code||"",i=e.title||a||n,r=x(e),o=e.location||"",g=n==="reservation"?e.customer_name||"":e.client_name||"";return[a?`Ø§Ù„ÙƒÙˆØ¯: ${a}`:"",`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${i}`,r?`Ø§Ù„ÙˆÙ‚Øª: ${r}`:"",o?`Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${o}`:"",g?`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${g}`:""].filter(Boolean).join(" | ")}async function U(n,e){try{const r=(await h(`${e==="reservation"?"/reservations/":"/projects/"}?id=${encodeURIComponent(n)}`))?.data;if(!r)throw new Error("Not found");y={type:e,id:Number(r.id),summary:G(e,r)},t.selectedSummary.textContent=y.summary,t.composeSection.hidden=!1;try{setTimeout(()=>{t.composeSection?.scrollIntoView({behavior:"smooth",block:"start"}),t.body&&typeof t.body.focus=="function"&&t.body.focus()},10)}catch{}}catch(a){console.error(a),c("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯")}}async function I(){if(!y){c("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}const n={email:!!t.chEmail.checked,telegram:!!t.chTelegram.checked};if(!n.email&&!n.telegram){c("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");return}const e={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(i=>i.trim()).filter(Boolean),additional_telegram_chat_ids:(t.extraChatIds.value||"").split(",").map(i=>i.trim()).filter(Boolean)},a={subject:(t.subject.value||"ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ").trim(),text:(t.body.value||"").trim()};if(!a.text){c("Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");return}try{const r=(await h("/notifications/send.php",{method:"POST",body:{entity_type:y.type,entity_id:y.id,channels:n,recipients:e,message:a}}))?.data||{},o=r?.sent||{email:0,telegram:0},g=r?.targets||{email:0,telegram:0},d=r?.targets_detail||{email:[],telegram:[]},m=Number(o.email||0),l=Number(o.telegram||0);let u=Number(g.email||0),f=Number(g.telegram||0);!u&&Array.isArray(d.email)&&(u=d.email.length),!f&&Array.isArray(d.telegram)&&(f=d.telegram.length);const p=[],v=u>0||m>0,w=f>0||l>0;if(v){const A=m>0?`Ø¥ÙŠÙ…ÙŠÙ„: ${m}/${u}`:u>0?`Ø¥ÙŠÙ…ÙŠÙ„: ${u}`:"";A&&p.push(A)}if(w){const A=l>0?`ØªÙ„ÙŠØºØ±Ø§Ù…: ${l}/${f}`:f>0?`ØªÙ„ÙŠØºØ±Ø§Ù…: ${f}`:"";A&&p.push(A)}v&&m===0&&u>0&&r?.errors?.last_email_error&&p.push("ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯");const C=p.length?` â€” ${p.join(" | ")}`:"";c(`${b("notifications.compose.sentOk","ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­")}${C}`),k()}catch(i){console.error(i);const r=i&&i.message?String(i.message):"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";c(r)}}async function D(){if(!y){c("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");return}const n={email:!!t.chEmail.checked,telegram:!!t.chTelegram.checked};if(!n.email&&!n.telegram){c("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");return}const e={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(a=>a.trim()).filter(Boolean),additional_telegram_chat_ids:(t.extraChatIds.value||"").split(",").map(a=>a.trim()).filter(Boolean)};try{const i=(await h("/notifications/resolve.php",{method:"POST",body:{entity_type:y.type,entity_id:y.id,channels:n,recipients:e}}))?.data||{},r=Number(i?.targets?.email||0),o=Number(i?.targets?.telegram||0),g=[];r&&g.push(`Ø¥ÙŠÙ…ÙŠÙ„: ${r}`),o&&g.push(`ØªÙ„ÙŠØºØ±Ø§Ù…: ${o}`);const d=i?.targets_detail||{},m=[];Array.isArray(d.email)&&d.email.length&&m.push(`Ù…Ø«Ø§Ù„ Ø¨Ø±ÙŠØ¯: ${d.email[0].recipient}`),Array.isArray(d.telegram)&&d.telegram.length&&m.push(`Ù…Ø«Ø§Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: ${d.telegram[0].recipient}`);const l=g.join(" | ")+(m.length?` â€” ${m.join(" â€¢ ")}`:"");t.previewBox&&(t.previewBox.textContent=l||"Ù„Ø§ Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†."),c("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")}catch(a){console.error(a),c("ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")}}function Q(){t.search.addEventListener("input",O),t.entityType.addEventListener("change",()=>{t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${b("notifications.table.loading","Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«â€¦")}</td></tr>`,L()}),t.resultsBody.addEventListener("click",e=>{const a=e.target.closest("[data-select-id]");a&&U(a.getAttribute("data-select-id"),a.getAttribute("data-select-type"))}),t.tReminder.addEventListener("click",()=>{const e=`ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø­Ø¬Ø²/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:
ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ ÙˆØ§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù….`;t.body.value=e}),t.tNote.addEventListener("click",()=>{const e=`Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:
ÙŠØ±Ø¬Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.`;t.body.value=e}),t.sendBtn.addEventListener("click",I),t.tgSearchBtn&&t.tgSearchBtn.addEventListener("click",_),t.tgRefreshBtn&&t.tgRefreshBtn.addEventListener("click",_),t.tgSearch&&t.tgSearch.addEventListener("keydown",e=>{e.key==="Enter"&&_()}),t.tgBody&&t.tgBody.addEventListener("click",async e=>{const a=e.target.closest("[data-gen-id]"),i=e.target.closest("[data-copy-link]"),r=e.target.closest("[data-unlink-id]");if(a){const o=a.getAttribute("data-gen-id");await W(o);return}if(i){const o=i.getAttribute("data-copy-link");if(o)try{await navigator.clipboard.writeText(o),c("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·")}catch{c("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹")}return}if(r){const o=r.getAttribute("data-unlink-id");await K(o);return}}),t.tgAdminGenBtn&&t.tgAdminGenBtn.addEventListener("click",J),t.tgAdminCopyBtn&&t.tgAdminCopyBtn.addEventListener("click",async()=>{const e=t.tgAdminCopyBtn.getAttribute("data-link");if(e)try{await navigator.clipboard.writeText(e),c("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}catch{c("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®")}}),t.tgAdminBody&&t.tgAdminBody.addEventListener("click",async e=>{const a=e.target.closest("[data-admin-unlink]");if(!a)return;const i=a.getAttribute("data-admin-unlink");await X(i)}),t.previewBtn&&t.previewBtn.addEventListener("click",D);const n=()=>{$=1,k()};["change","input"].forEach(e=>{t.logEntity.addEventListener(e,n),t.logChannel.addEventListener(e,n),t.logStatus.addEventListener(e,n),t.logQ.addEventListener(e,()=>{B&&clearTimeout(B),B=setTimeout(()=>{$=1,k()},350)})}),t.logRefresh.addEventListener("click",k),t.logClear&&t.logClear.addEventListener("click",async()=>{if(window.confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±."))try{const a=S();await h(`/notifications/logs.php?${a.toString()}`,{method:"DELETE"}),c("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„"),$=1,k()}catch(a){console.error(a),c("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„")}}),t.logPagination&&t.logPagination.addEventListener("click",e=>{const a=e.target.closest("[data-page]");if(!a)return;const i=Number(a.getAttribute("data-page"))||1;i!==$&&($=i,k())})}let $=1;const T=20;function S(){const n=new URLSearchParams;return t.logEntity.value&&n.set("entity_type",t.logEntity.value),t.logChannel.value&&n.set("channel",t.logChannel.value),t.logStatus.value&&n.set("status",t.logStatus.value),(t.logQ.value||"").trim()&&n.set("q",t.logQ.value.trim()),n.set("limit",String(T)),n.set("page",String($)),n}function z(n){const e=Number(n?.total||0),a=Number(n?.pages||1),i=Number(n?.page||1);if(!t.logPagination)return;if(e<=T){t.logPagination.innerHTML="";return}const r=(l,u,f=!1,p=!1)=>{const v=["btn","btn-sm"];return p?v.push("btn-primary"):v.push("btn-outline"),f&&v.push("btn-disabled"),`<button type="button" class="${v.join(" ")}" data-page="${u}" ${f?"disabled":""}>${l}</button>`};let o="";o+=r(b("notifications.logs.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"),Math.max(1,i-1),i<=1);const g=7,d=(l,u)=>Array.from({length:u-l+1},(f,p)=>l+p);let m=[];if(a<=g)m=d(1,a);else{const l=Math.max(2,i-1),u=Math.min(a-1,i+1);m=[1,...d(l,u),a]}for(const l of m){if(l<1||l>a)continue;const u=l===i;o+=r(String(l),l,!1,u)}o+=r(b("notifications.logs.next","Ø§Ù„ØªØ§Ù„ÙŠ"),Math.min(a,i+1),i>=a),t.logPagination.innerHTML=o}function F(n){return{reservation_created:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø²",reservation_reminder_24h:"ØªØ°ÙƒÙŠØ± 24 Ø³Ø§Ø¹Ø©",reservation_reminder_1h:"ØªØ°ÙƒÙŠØ± Ø³Ø§Ø¹Ø©",reservation_technician_assigned:"ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ (Ø­Ø¬Ø²)",reservation_status_changed:"ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø­Ø¬Ø²",project_created:"Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹",project_technician_assigned:"ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ (Ù…Ø´Ø±ÙˆØ¹)",manual_notification:"Ø¥Ø±Ø³Ø§Ù„ ÙŠØ¯ÙˆÙŠ"}[n]||n}function V(n){if(!Array.isArray(n)||n.length===0){t.logBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted">${b("notifications.logs.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.")}</td></tr>`;return}t.logBody.innerHTML=n.map(e=>{const a=e.created_at||"â€”",i=F(e.event_type||""),r=`${e.entity_type||""} #${e.entity_id||""}`,o=e.recipient_display||`${e.recipient_type||""}: ${e.recipient_identifier||""}`,g=e.channel||"",d=e.status||"",m=(e.error||"").toString().slice(0,140);return`
      <tr>
        <td>${a}</td>
        <td>${i}</td>
        <td>${r}</td>
        <td>${o}</td>
        <td>${g}</td>
        <td>${d==="sent"?'<span class="badge bg-primary-subtle">Ù…Ø±Ø³Ù„Ø©</span>':'<span class="badge bg-danger-subtle">ÙØ§Ø´Ù„Ø©</span>'}</td>
        <td title="${m}">${m}</td>
      </tr>
    `}).join("")}async function k(){try{t.logBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted">${b("notifications.logs.loading","â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦")}</td></tr>`;const n=S(),e=await h(`/notifications/logs.php?${n.toString()}`);V(e?.data??[]),z(e?.meta||{})}catch(n){console.error(n),t.logBody.innerHTML='<tr><td colspan="7" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</td></tr>'}}(async function(){await H();const e=await P();if(!e||e.role!=="admin"){c("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·"),window.location.href="home.html";return}R(),Q(),L(),k(),_(),E()})();async function _(){if(t.tgBody)try{t.tgBody.innerHTML='<tr><td colspan="4" class="text-center text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>';const n=(t.tgSearch?.value||"").trim(),e=new URLSearchParams;n&&e.set("search",n),e.set("limit","20");const a=await h(`/technicians/?${e.toString()}`),i=Array.isArray(a?.data)?a.data:Array.isArray(a)?a:[];if(!i.length){t.tgBody.innerHTML='<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';return}t.tgBody.innerHTML=i.map(r=>{const o=r.full_name||r.name||"",g=r.phone||"",d=!!(r.telegram_chat_id||r.telegramChatId||r.has_tg_link),m=d?'<span class="badge bg-primary-subtle">Ù…Ø±ØªØ¨Ø·</span>':'<span class="badge bg-warning-subtle">ØºÙŠØ± Ù…Ø±ØªØ¨Ø·</span>',l=d?`<button type="button" class="btn btn-sm btn-outline btn-error" data-unlink-id="${r.id}">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</button>`:`<button type="button" class="btn btn-sm" data-gen-id="${r.id}">ğŸ”— ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø·</button>`;return`<tr>
        <td>${o}</td>
        <td>${g}</td>
        <td>${m}</td>
        <td>${l}</td>
      </tr>`}).join("")}catch(n){console.error(n),t.tgBody.innerHTML='<tr><td colspan="4" class="text-center text-error">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>'}}async function W(n){try{const e=await h(`/telegram/generate-link.php?technician_id=${encodeURIComponent(n)}`),a=e?.data?.link||e?.link||null;if(!a){c("âš ï¸ ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·");return}const i=t.tgBody?.querySelector(`button[data-gen-id="${n}"]`)?.closest("tr");if(i){const r=i.querySelector("td:last-child");r&&(r.innerHTML=`<button type="button" class="btn btn-sm" data-copy-link="${a}">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>`)}c("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·")}catch(e){console.error(e),c("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·")}}async function E(){if(t.tgAdminBody)try{t.tgAdminBody.innerHTML='<tr><td colspan="3" class="text-center text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>';const n=await h("/telegram/admins.php"),e=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];if(!e.length){t.tgAdminBody.innerHTML='<tr><td colspan="3" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ø¥Ø¯Ù…Ù† Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';return}t.tgAdminBody.innerHTML=e.map(a=>{const i=String(a.chat_id||""),r=a.last_used_at||"â€”";return`<tr>
        <td>${i}</td>
        <td>${r}</td>
        <td><button type="button" class="btn btn-sm btn-outline btn-error" data-admin-unlink="${i}">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</button></td>
      </tr>`}).join("")}catch(n){console.error(n),t.tgAdminBody.innerHTML='<tr><td colspan="3" class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†</td></tr>'}}async function J(){try{const n=await h("/telegram/generate-link.php?context=admin"),e=n?.data?.link||n?.link||null;if(!e){c("âš ï¸ ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†");return}t.tgAdminCopyBtn&&(t.tgAdminCopyBtn.removeAttribute("disabled"),t.tgAdminCopyBtn.setAttribute("data-link",e)),t.tgAdminLinkBox&&(t.tgAdminLinkBox.classList.remove("hidden"),t.tgAdminLinkBox.textContent=e),c("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}catch(n){console.error(n),c("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}}async function K(n){if(!(!n||!window.confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ†ÙŠØŸ")))try{await h("/telegram/unlink.php",{method:"POST",body:{target:"technician",technician_id:Number(n)}}),c("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø· Ù„Ù„ÙÙ†ÙŠ"),_()}catch(a){console.error(a),c("ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·")}}async function X(n){if(!(!n||!window.confirm(`ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù† (${n})ØŸ`)))try{await h("/telegram/unlink.php",{method:"POST",body:{target:"admin",chat_id:String(n)}}),c("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†"),E()}catch(a){console.error(a),c("ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ù…Ù†")}}
