import{n as tt,p as Y,s as E,a as rt,C as st,d as ct}from"./reservationsService.D-nlmUXN.js";import{t as I,n as A,p as H}from"./auth.CaTIBjKG.js";const g={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,lastFetchSignature:null,lastFetchAt:0,pendingFetchSignature:null,pendingFetchForce:!1,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function yt(t){g.callbacks.onRender=typeof t=="function"?t:null}function wt(t){g.callbacks.onBeforeRender=typeof t=="function"?t:null}function bt(t){g.callbacks.onAfterRender=typeof t=="function"?t:null}function St(t){g.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function Dt(t){g.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function Nt(t){g.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function L(t){if(g.loadedScripts.has(t))return g.loadedScripts.get(t);const e=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,r=new Promise((o,c)=>{const n=()=>{e&&(e.dataset.loaded="true"),o()},a=i=>c(i);if(e){if(e.dataset.loaded==="true"){o();return}e.addEventListener("load",n,{once:!0}),e.addEventListener("error",a,{once:!0});return}const u=document.createElement("script");u.src=t,u.async=!0,u.onload=()=>{u.dataset.loaded="true",o()},u.onerror=i=>c(i),document.head.appendChild(u)});return g.loadedScripts.set(t,r),r}function Mt(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(g.apexChartsReady||(g.apexChartsReady=L("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),g.apexChartsReady)}function v(t,e=1500){return new Promise((r,o)=>{const c=setTimeout(()=>r(null),Math.max(200,e));t.then(n=>{clearTimeout(c),r(n)},n=>{clearTimeout(c),r(null)})})}async function lt(){try{const t=await fetch("/vendor/html2pdf.bundle.min.js",{method:"GET",cache:"no-cache"});if(!t.ok)return!1;const e=(t.headers.get("content-type")||"").toLowerCase();if(!(e.includes("javascript")||e.includes("ecmascript")))return!1;const r=await t.text();if(!r||/<\s*!doctype\s+html/i.test(r))return!1;const o=new Blob([r],{type:"text/javascript"}),c=URL.createObjectURL(o);await L(c);try{URL.revokeObjectURL(c)}catch{}return typeof window.html2pdf<"u"}catch{return!1}}function Ct(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(g.html2PdfReady||(g.html2PdfReady=(async()=>await v(lt(),1200)&&window.html2pdf?window.html2pdf:(await v(L("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"),2e3),window.html2pdf||null))()),g.html2PdfReady)}function Tt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(g.xlsxReady||(g.xlsxReady=L("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),g.xlsxReady)}function Ft(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(g.jsZipReady||(g.jsZipReady=L("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),g.jsZipReady)}function M(t,e,r=e){const c=H()==="en"?r??e:e;return I(t,c)}function At(){g.formatters.cachedLocale=null,g.formatters.numberFormatter=null}function U(){return(H()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function et(){const t=H();if(t!==g.formatters.cachedLocale||!g.formatters.numberFormatter||!g.formatters.currencyFormatter){g.formatters.cachedLocale=t;const e=U();g.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),g.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:g.formatters.numberFormatter,currencyFormatter:g.formatters.currencyFormatter}}function Rt(t){const{numberFormatter:e}=et(),r=e.format(Math.round(t||0));return A(r)}function xt(t){const{currencyFormatter:e}=et(),r=Number.isFinite(Number(t))?Number(t):0,o=e.format(r);return`${A(o)} SR`}function $(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const r=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0");return`${r}-${o}-${c}`}function Pt(t){if(!t)return I("common.placeholder.empty","—");const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return I("common.placeholder.empty","—");const r=new Intl.DateTimeFormat(U(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return A(r.format(e))}function nt(t){return new Intl.DateTimeFormat(U(),{month:"short"}).format(t)}const it=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["مغلق","completed"],["مغلقة","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),W=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),V=1440*60*1e3,C={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map,equipmentCost:new Map};function x(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const r=t[0]||{},o=t[e-1]||{},c=`${r.id??r.reservationId??""}-${r.start??""}`,n=`${o.id??o.reservationId??""}-${o.start??""}`,a=g.formatters?.cachedLocale||"ar";return`${e}|${c}|${n}|${a}`}function P(t,e){return t.get(e)}function j(t,e,r){if(t.set(e,r),t.size>64){const o=t.keys().next().value;t.delete(o)}return r}function at(t){return A(String(t||"")).toLowerCase().trim()}function q(t){return(t||"").toString().trim()}function K(t,e){if(!t||!e)return 1;const r=new Date(t),o=new Date(e);if(Number.isNaN(r.getTime())||Number.isNaN(o.getTime()))return 1;const c=o.getTime()-r.getTime();return c<=0?1:Math.max(1,Math.ceil(c/V))}function J(t){return t?(g.techniciansIndex||(g.techniciansIndex=new Map((g.data.technicians||[]).map(e=>[String(e.id),e]))),g.techniciansIndex.get(String(t))||null):null}function B(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const r of e){if(r==null)continue;const o=Number.parseFloat(A(String(r)));if(Number.isFinite(o))return o}return 0}function G(t={}){const e=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const r of e){if(r==null)continue;const o=Number.parseFloat(A(String(r)));if(Number.isFinite(o))return o}return B(t)}function R(t){if(!t)return{rentalDays:1,equipmentTotal:0,equipmentCostTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;K(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,r=t.discountType||t.discount_type||"percent",o=String(r).toLowerCase()==="amount"?"amount":"percent",c=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",n=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,a=n!=null?Y(n):Number.NaN,i=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(a)&&a>0?a:null,m=Array.isArray(t.crewAssignments)?t.crewAssignments:[],d=m.length?m.map(y=>y?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],s=ct({items:Array.isArray(t.items)?t.items:[],technicianIds:d,crewAssignments:m,discount:e,discountType:o,applyTax:c,start:t.start,end:t.end,companySharePercent:i}),l=Number(t.cost);let f=s.finalTotal,p=s.taxAmount;if(Number.isFinite(l)&&l>0&&(f=E(l),c)){const y=f-s.taxableAmount;Number.isFinite(y)&&y>=0&&(p=E(y))}const h={rentalDays:s.rentalDays,equipmentTotal:s.equipmentTotal,equipmentCostTotal:s.equipmentCostTotal,crewTotal:s.crewTotal,crewCostTotal:s.crewCostTotal,discountAmount:s.discountAmount,subtotalAfterDiscount:s.subtotalAfterDiscount,taxableAmount:s.taxableAmount,taxAmount:p,finalTotal:f,companySharePercent:s.companySharePercent,companyShareAmount:s.companyShareAmount,netProfit:s.netProfit,companyShareEnabled:s.companySharePercent>0};return t.__financials=h,h}function O(t){return t?.projectId&&g.data.projectsMap.get(String(t.projectId))||null}function z(t=""){const e=String(t).toLowerCase().trim();return e?it.get(e)||e:""}function ut(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const r of e){const o=String(r||"").toLowerCase().trim();if(o&&W.has(o))return W.get(o)}return t?.paid===!0||t?.paid==="true"}function T(t){const e=O(t),r=rt(t,e),o=r.projectStatus||"",c=z(o),n=z(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");let a=n;r.projectLinked&&c&&a!=="cancelled"&&(a=c),a||(a=r.effectiveConfirmed?"confirmed":"pending"),a!=="cancelled"&&(st(t)||c==="completed")&&(a="completed");const u=o==="confirmed"||o==="in_progress",i=e?.confirmed===!0||e?.confirmed==="true",m=r.reservationConfirmed||n==="confirmed";let d=m;r.projectLinked&&(d=i||u||m),a==="cancelled"&&(d=!1),d&&a!=="completed"&&a!=="cancelled"&&(a="confirmed");const s=ut(t),l=t?.paidStatus??t?.paid_status??(s?"paid":"unpaid");return{statusValue:a,confirmed:d,paid:s,paidStatus:l}}function jt(t){let e=0,r=0,o=0,c=0,n=0,a=0,u=0,i=0,m=0,d=0,s=0,l=0,f=0,p=0,h=0,y=0;t.forEach(b=>{const{statusValue:w,confirmed:F,paid:S,paidStatus:_}=T(b);if(F&&(e+=1,w==="completed"&&(o+=1),w==="cancelled"&&(c+=1),r+=1,S&&w!=="cancelled"&&(n+=1),w!=="cancelled"&&_!=="paid"&&(a+=1),w!=="cancelled")){const N=R(b);u+=N.finalTotal,i+=N.companyShareAmount,m+=N.taxAmount,d+=N.crewTotal,s+=N.crewCostTotal??0,l+=N.equipmentTotal??0,f+=N.equipmentCostTotal??0,Number.isFinite(N.discountAmount)&&N.discountAmount>0&&(y+=N.discountAmount),p+=N.netProfit;const k=X(b);Number.isFinite(k)&&k>0&&(h+=k)}});const D=e?u/e:0;return{total:e,confirmed:r,completed:o,cancelled:c,activeTotal:Math.max(0,e-c),paidCount:n,unpaidCount:a,outstandingTotal:h,revenue:u,average:D,companyShareTotal:i,taxTotal:m,crewTotal:d,crewCostTotal:s,equipmentTotal:l,equipmentCostTotal:f,discountTotal:y,netProfit:p}}function ot({range:t,start:e,end:r}){const o=new Date;if(o.setHours(23,59,59,999),t==="custom"||e||r){const a=e?new Date(`${e}T00:00:00`):null,u=r?new Date(`${r}T23:59:59`):null;return{startDate:Q(a)?a:null,endDate:Q(u)?u:null}}let c=new Date(o),n=null;switch(t){case"thisWeek":{const a=new Date(o),i=(a.getDay()-6+7)%7;a.setDate(a.getDate()-i),a.setHours(0,0,0,0);const m=new Date(a);m.setDate(a.getDate()+6),m.setHours(23,59,59,999),n=a,c=m;break}case"thisMonth":{n=new Date(o.getFullYear(),o.getMonth(),1),c=new Date(o.getFullYear(),o.getMonth()+1,0),c.setHours(23,59,59,999);break}case"thisQuarter":{const a=Math.floor(o.getMonth()/3);n=new Date(o.getFullYear(),a*3,1),c=new Date(o.getFullYear(),(a+1)*3,0),c.setHours(23,59,59,999);break}case"thisYear":{n=new Date(o.getFullYear(),0,1),c=new Date(o.getFullYear(),12,0),c.setHours(23,59,59,999);break}case"all":default:n=null,c=null;break}return n&&n.setHours(0,0,0,0),{startDate:n,endDate:c}}function Q(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function kt(t,e){const{startDate:r,endDate:o}=ot(e);let c=0;const n=[];return(t||[]).forEach(a=>{if(!a)return;const u=typeof a.repairCost=="number"?a.repairCost:Number.parseFloat(A(String(a.repairCost??"")));if(!Number.isFinite(u)||u<=0)return;const i=String(a.statusRaw??a.status??"").toLowerCase();if(!(i==="closed"||i==="completed"||i==="cancelled"))return;const d=a.resolvedAt??a.resolved_at??null,s=a.reportedAt??a.reported_at??null,l=a.createdAt??a.created_at??null,f=d?new Date(d):null,p=s?new Date(s):l?new Date(l):null,h=f&&!Number.isNaN(f.getTime())?f:p&&!Number.isNaN(p.getTime())?p:null;if(h&&(r&&h<r||o&&h>o))return;const y=Math.round(u*100)/100;c+=y,n.push({id:a.id,cost:y,date:h})}),{total:c,items:n}}function Et(t,e){const r=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:r,netProfit:(t.netProfit||0)-r}}function Lt(t){const e=`trend:${x(t)}`,r=P(C.trend,e);if(r)return r;const o=new Date,c=[],n=(t||[]).map(i=>i?.start?new Date(i.start):null).filter(i=>i&&!Number.isNaN(i.getTime()));let a=6,u=new Date(o.getFullYear(),o.getMonth(),1);if(n.length){const i=new Date(Math.min(...n.map(p=>p.getTime()))),m=new Date(Math.max(...n.map(p=>p.getTime()))),d=new Date(i.getFullYear(),i.getMonth(),1);u=new Date(m.getFullYear(),m.getMonth(),1);const s=u.getFullYear()-d.getFullYear(),l=u.getMonth()-d.getMonth(),f=s*12+l;a=Math.min(12,Math.max(6,f+1))}for(let i=a-1;i>=0;i-=1){const m=new Date(u.getFullYear(),u.getMonth()-i,1),d=m.getFullYear(),s=m.getMonth(),l=t.filter(F=>{const S=F?.start?new Date(F.start):null;return S&&S.getFullYear()===d&&S.getMonth()===s}).filter(F=>T(F).statusValue!=="cancelled"),f=l.length;let p=0,h=0,y=0;l.forEach(F=>{const S=R(F);p+=S.finalTotal,h+=S.netProfit,y+=S.companyShareAmount});const D=nt(m),b=new Date(m.getFullYear(),m.getMonth(),1),w=new Date(m.getFullYear(),m.getMonth()+1,0);c.push({label:D,count:f,revenue:p,netProfit:h,companyShare:y,periodStart:b,periodEnd:w,startInput:$(b),endInput:$(w)})}try{const i=new Map;(t||[]).forEach(s=>{if(T(s).statusValue==="cancelled")return;const l=s?.start?new Date(s.start):null;if(!l||Number.isNaN(l.getTime()))return;const f=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`,p=R(s),h=i.get(f)||0;i.set(f,h+(Number(p.finalTotal)||0))});const m=c.map(s=>Number(s.revenue||0)),d=c.map((s,l)=>l<2?null:(m[l]+m[l-1]+m[l-2])/3);c.forEach((s,l)=>{const f=l>0?Number(c[l-1]?.revenue||0):null;let p=null;f!=null&&Number.isFinite(f)&&f>0&&(p=(Number(s.revenue||0)-f)/f*100);const h=s.periodStart instanceof Date?s.periodStart:null;let y=null;if(h&&!Number.isNaN(h.getTime())){const D=`${h.getFullYear()-1}-${String(h.getMonth()+1).padStart(2,"0")}`,b=i.get(D);Number.isFinite(b)&&b>0&&(y=(Number(s.revenue||0)-b)/b*100)}s.momChange=p,s.yoyChange=y,s.movingAvgRevenue=d[l]})}catch{}return j(C.trend,e,c)}function _t(t){const e=new Date,r=(t||[]).map(a=>a?.start?new Date(a.start):null).filter(a=>a&&!Number.isNaN(a.getTime()));let o=6,c=new Date(e.getFullYear(),e.getMonth(),1);if(r.length){const a=new Date(Math.min(...r.map(l=>l.getTime()))),u=new Date(Math.max(...r.map(l=>l.getTime()))),i=new Date(a.getFullYear(),a.getMonth(),1);c=new Date(u.getFullYear(),u.getMonth(),1);const m=c.getFullYear()-i.getFullYear(),d=c.getMonth()-i.getMonth(),s=m*12+d;o=Math.min(12,Math.max(6,s+1))}const n=[];for(let a=o-1;a>=0;a-=1){const u=new Date(c.getFullYear(),c.getMonth()-a,1),i=u.getFullYear(),m=u.getMonth();let d=0,s=0;(t||[]).forEach(l=>{const f=l?.start?new Date(l.start):null;if(!f||f.getFullYear()!==i||f.getMonth()!==m)return;const{statusValue:p,confirmed:h}=T(l);p==="cancelled"?s+=1:(h||p==="confirmed"||p==="completed")&&(d+=1)}),n.push({label:nt(u),confirmed:d,cancelled:s})}return n}function qt(t){const e=`status:${x(t)}`,r=P(C.status,e);if(r)return r;const o={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(d=>{const{statusValue:s,confirmed:l}=T(d);s==="completed"?o.completed+=1:s==="cancelled"?o.cancelled+=1:s==="confirmed"||l?o.confirmed+=1:o.pending+=1});const c=Math.max(1,(t||[]).length),n=o.confirmed,a=o.pending,u=o.completed,i=o.cancelled,m=[{label:M("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:n,percent:Math.round(n/c*100)||0,rawCount:n,className:"status-confirmed",filterKey:"confirmed"},{label:M("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:a,percent:Math.round(a/c*100)||0,rawCount:a,className:"status-pending",filterKey:"pending"},{label:M("reservations.reports.status.completedLabel","مغلقة","Closed"),value:u,percent:Math.round(u/c*100)||0,rawCount:u,className:"status-completed",filterKey:"completed"},{label:M("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:i,percent:Math.round(i/c*100)||0,rawCount:i,className:"status-cancelled",filterKey:"cancelled"}];return j(C.status,e,m)}function Yt(t){const e=`payment:${x(t)}`,r=P(C.payment,e);if(r)return r;const o=t.length||1;let c=0,n=0,a=0;(t||[]).forEach(i=>{const{paidStatus:m}=T(i);m==="paid"?c+=1:m==="partial"?n+=1:a+=1});const u=[{label:M("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:c,percent:Math.round(c/o*100)||0,rawCount:c,className:"status-paid",filterKey:"paid"},{label:M("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:n,percent:Math.round(n/o*100)||0,rawCount:n,className:"status-partial",filterKey:"partial"},{label:M("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/o*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}];return j(C.payment,e,u)}function It(t,e){const r=`topCustomers:${x(t)}`,o=P(C.topCustomers,r);if(o)return o;const c=new Map,n=new Map((e||[]).map(u=>[String(u.id),u]));t.forEach(u=>{const{statusValue:i}=T(u);if(i==="cancelled")return;const m=String(u?.customerId??"unknown"),d=c.get(m)||{count:0,revenue:0},s=R(u);d.count+=1,d.revenue+=s.finalTotal,c.set(m,d)});const a=Array.from(c.entries()).map(([u,i])=>({name:n.get(u)?.customerName||M("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:i.count,revenue:i.revenue})).sort((u,i)=>i.revenue-u.revenue).slice(0,5);return j(C.topCustomers,r,a)}function $t(t,e){const r=`topEquipment:${x(t)}`,o=P(C.topEquipment,r);if(o)return o;const c=new Map,n=new Map((e||[]).map(i=>[q(i?.barcode),i])),a=M("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(i=>{(i?.items||[]).forEach(m=>{const d=q(m?.barcode),s=d?n.get(d):null,l=m?.desc||m?.description||m?.name||s?.desc||s?.description||s?.name||"",f=l&&l.trim()?l:a,p=tt(f)||"unknown",h=Number(m?.qty)||1,y=Number(m?.price)||0,D=h*y,b=c.get(p)||{name:f,count:0,revenue:0};b.name=f,b.count+=h,b.revenue+=D,c.set(p,b)})});const u=Array.from(c.values()).sort((i,m)=>m.count!==i.count?m.count-i.count:m.revenue-i.revenue).slice(0,5);return j(C.topEquipment,r,u)}function Vt(t){const e=`equipmentCost:${x(t)}`,r=P(C.equipmentCost,e);if(r)return r;const o=new Map,c=M("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");(t||[]).forEach(a=>{const{statusValue:u}=T(a);if(u==="cancelled")return;const i=Math.max(1,K(a?.start,a?.end));(Array.isArray(a?.items)?a.items:[]).forEach(d=>{const s=d?.desc||d?.description||d?.name||"",l=s&&s.trim()?s:c,f=tt(l)||l,p=Number(d?.qty??d?.quantity??1)||1,h=Y(d?.price??d?.unit_price??d?.unitPrice??0),y=Y(d?.unitCost??d?.unit_cost??d?.cost??0),D=E(p*h*i),b=E(p*y*i),w=o.get(f)||{name:l,quantity:0,billable:0,cost:0,days:0};w.name=l,w.quantity+=p,w.billable+=D,w.cost+=b,w.days+=p*i,o.set(f,w)})});const n=Array.from(o.values()).map(a=>({...a,net:E(a.billable-a.cost)})).sort((a,u)=>u.cost!==a.cost?u.cost-a.cost:u.billable!==a.billable?u.billable-a.billable:(u.quantity||0)-(a.quantity||0)).slice(0,10);return j(C.equipmentCost,e,n)}function Bt(){Object.values(C).forEach(t=>t.clear())}function dt(t,e,r,o,c){const n=[],a=t?.reservationId||t?.id;a&&n.push(a),t?.notes&&n.push(t.notes);const{statusValue:u,paid:i,paidStatus:m}=T(t);u&&n.push(u);const d=t?.paymentStatus||t?.payment_status;d&&n.push(d),t?.paid!=null&&n.push(t.paid?"paid":"unpaid"),m&&n.push(m);const s=r.get(String(t?.customerId));s&&n.push(s.customerName,s.company_name||s.companyName,s.contact_person||"");const l=O(t);return l&&n.push(l.title,l.code,l.status),n.push(mt(m)),(t?.items||[]).forEach(p=>{p?.desc&&n.push(p.desc),p?.barcode&&n.push(p.barcode);const h=o.get(q(p?.barcode));h&&n.push(h.desc,h.description,h.name)}),(t?.technicians||[]).forEach(p=>{const h=c.get(String(p));h&&n.push(h.name,h.role,h.department)}),at(n.filter(Boolean).join(" ")).includes(e)}function zt(t,e,r,o,c){const{startDate:n,endDate:a}=ot(e),u=at(e.search),i=!!u,m=new Map((r||[]).map(l=>[String(l.id),l])),d=new Map((o||[]).map(l=>[q(l?.barcode),l])),s=new Map((c||[]).map(l=>[String(l.id),l]));return(t||[]).filter(l=>{if(!(l&&l.projectId!=null&&String(l.projectId).trim()!==""))return!1;const p=O(l);if(!p)return!1;const h=z(p.status??p.projectStatus??"");if(h==="cancelled"||p.cancelled===!0||p.cancelled==="true")return!1;const D=p.confirmed===!0||p.confirmed==="true"||h==="confirmed";if(!D&&!(h==="completed"&&D))return!1;const w=l?.start?new Date(l.start):null;if(!w||Number.isNaN(w.getTime()))return!1;let F=l?.end?new Date(l.end):w;if(Number.isNaN(F.getTime())&&(F=w),n&&F<n||a&&w>a)return!1;const{statusValue:S,confirmed:_,paid:N,paidStatus:k}=T(l);if(!_||e.status==="confirmed"&&!(S==="confirmed"||S==="completed"||_)||e.status==="pending"&&S!=="pending"||e.status==="completed"&&S!=="completed"||e.status==="cancelled"&&S!=="cancelled"||e.payment==="paid"&&!N||e.payment==="unpaid"&&N||e.payment==="partial"&&k!=="partial")return!1;if(e.share&&e.share!=="all"){const Z=R(l).companySharePercent>0;if(e.share==="with"&&!Z||e.share==="without"&&Z)return!1}return!(i&&!dt(l,u,m,d,s))})}function mt(t){const e=String(t??"").toLowerCase();return e==="paid"?M("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?M("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):M("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Ht(t,e){const r=new Map((e||[]).map(n=>[String(n.id),n])),o=new Map;return(t||[]).forEach(n=>{const{statusValue:a}=T(n);if(a==="cancelled")return;const u=K(n.start,n.end),i=Array.isArray(n.crewAssignments)?n.crewAssignments:[];if(i.length){i.forEach(d=>{const s=d?.technicianId!=null?String(d.technicianId):null;if(!s)return;const l=r.get(s)||J(s)||{},f=Number(d?.positionClientPrice),p=Number.isFinite(f)?f:G(l),h=Number(d?.positionCost),y=Number.isFinite(h)?h:B(l),D=p*u,b=y*u,w=o.get(s)||{id:s,name:l?.name||String(s),days:0,billable:0,cost:0};w.days+=u,w.billable+=D,w.cost+=b,o.set(s,w)});return}(Array.isArray(n.technicians)?n.technicians.map(d=>String(d)):[]).forEach(d=>{const s=r.get(d)||J(d)||{},l=G(s),f=B(s),p=l*u,h=f*u,y=o.get(d)||{id:d,name:s?.name||String(d),days:0,billable:0,cost:0};y.days+=u,y.billable+=p,y.cost+=h,o.set(d,y)})}),Array.from(o.values()).map(n=>({...n,net:n.billable-n.cost})).sort((n,a)=>a.net-n.net)}function pt(t=[]){if(!Array.isArray(t)||!t.length)return 0;let e=0;return t.forEach(r=>{const o=Number(r?.amount);Number.isFinite(o)&&o>0&&(e+=o)}),e}function X(t){const e=R(t),r=Number(e.finalTotal||0);let o=Number(t?.paidAmount);if(!Number.isFinite(o)||o<=0){const n=pt(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(n)&&n>0&&(o=n)}if((!Number.isFinite(o)||o<=0)&&Number.isFinite(Number(t?.paidPercent))){const n=Number(t.paidPercent);n>0&&n<=100&&(o=n/100*r)}return Number.isFinite(o)||(o=0),Math.max(0,Math.round((r-o)*100)/100)}function Ut(t,e,r=5){const o=new Map((e||[]).map(n=>[String(n.id),n])),c=[];return(t||[]).forEach(n=>{const{paidStatus:a,statusValue:u}=T(n);if(u==="cancelled"||a!=="unpaid"&&a!=="partial")return;const i=X(n);if(!Number.isFinite(i)||i<=0)return;const m=o.get(String(n.customerId));c.push({id:n.id||n.reservationId||"",code:n.reservationCode||n.reservationId||n.id||"",customer:m?.customerName||n.customerName||"",outstanding:i,paidStatus:a})}),c.sort((n,a)=>a.outstanding-n.outstanding).slice(0,r)}function Kt(t,{horizonDays:e=90}={}){const r=new Date,o=new Date(r.getTime()+e*V),c=new Map;return(t||[]).forEach(n=>{const{statusValue:a,paidStatus:u}=T(n);if(a==="cancelled"||u==="paid")return;const i=X(n);if(!Number.isFinite(i)||i<=0)return;const m=n?.start?new Date(n.start):null,d=n?.end?new Date(n.end):m;let s=d&&!Number.isNaN(d.getTime())?d:m;if((!s||Number.isNaN(s.getTime()))&&(s=new Date(r.getTime()+7*V)),s<r||s>o)return;const l=$(new Date(s.getFullYear(),s.getMonth(),s.getDate())),f=c.get(l)||{date:l,amount:0,count:0};f.amount+=i,f.count+=1,c.set(l,f)}),Array.from(c.values()).sort((n,a)=>n.date<a.date?-1:1)}export{Vt as A,Kt as B,Ut as C,yt as D,wt as E,bt as F,St as G,Dt as H,Nt as I,At as J,Ft as K,Tt as a,Bt as b,R as c,ot as d,Ct as e,Mt as f,Rt as g,xt as h,T as i,Pt as j,$ as k,L as l,zt as m,jt as n,kt as o,mt as p,Et as q,g as r,Lt as s,M as t,qt as u,_t as v,Yt as w,It as x,$t as y,Ht as z};
