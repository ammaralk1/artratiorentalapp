import{l as we,n as f,d as Jt,t as r,j as Kt,r as Ee,q as Ce,p as Yt,u as Ct,e as lt,y as Gt,h as y,o as Pe,f as Ie,a as Ae,m as Be,c as Le,i as De}from"./auth.js";/* empty css     *//* empty css       */import{i as qe}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{t as Qt,n as at,g as J,z as ut,A as Ne,B as Xt,C as _e,E as ft,r as ke,v as Zt,k as te,l as Pt,F as Me,e as Fe}from"./projectsService.js";/* empty css   */import{c as Re}from"./controller.js";const d={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},s={};function Ue(){d.selectedTechnicians=[],d.selectedEquipment=[],d.expenses=[]}function He(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Oe(){s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.submitBtn=s.form?.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function Ve(){const t=He();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([a,o])=>{document.querySelector(a)&&t(a,o)})}function ee(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function ze(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>we()),t.dataset.listenerAttached="true")}const xt="project",Tt="editProject",qt=3600*1e3,pt=.15,vt=6,It="projectsTab",At="projectsSubTab",Nt={create:"create-project-tab",list:"projects-list-tab"},ne={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},We={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function c(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function C(t){const e=Number(t)||0,n=Jt(),a=n==="ar"?"ar-SA":"en-US",o=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e)),i=n==="ar"?"ر.س":"SAR";return`${f(o)} ${i}`}function X(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),l=e.getHours(),u=l>=12?"PM":"AM",p=l%12||12,h=String(p).padStart(2,"0"),T=`${n}/${a}/${o} ${h}:${i} ${u}`;return f(T)}function Je(t){const e=Jt(),n=f(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function _t(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=Je(t))}function Ke(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?r(e,n):n}function Q(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function kt(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=Q(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function Mt(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),l=o.padStart(2,"0");return`${t}T${i}:${l}`}function se(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}…`}function Ye(t,e){if(!t)return"—";const n=X(t);return e?`${n} - ${X(e)}`:n}function Ft(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function bt(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function F(){if(!s.projectsTableBody)return;const t=d.filters.search,e=d.projects.filter(a=>{if(!t)return!0;const o=d.customers.find(l=>String(l.id)===String(a.clientId));return f([a.title,a.description,o?.customerName,a.clientCompany,bt(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=d.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",o=d.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",i=c(r(a,o));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,_t(0),d.visibleProjects=[],Rt([]);return}const n=[...e].sort((a,o)=>new Date(o.start||0)-new Date(a.start||0));d.visibleProjects=n,_t(n.length),s.projectsTableBody.innerHTML=n.map(a=>Ge(a)).join(""),Rt(n),K()}function Ge(t){const e=d.customers.find(P=>String(P.id)===String(t.clientId)),n=e?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),a=(t.clientCompany||e?.companyName||"").trim(),o=t.technicians?.length||0,i=(t.equipment||[]).reduce((P,E)=>P+(E.qty||0),0),{expensesTotal:l,totalWithTax:u}=ct(t),h=gt(t.id).length,v=r("projects.table.reservationsCount","{count} حجوزات").replace("{count}",f(String(h))),m=h?`<span class="badge rounded-pill project-reservations-chip">${c(v)}</span>`:"",x=`<span class="badge project-type-badge">${c(bt(t.type))}</span>`,g=t.projectCode||`PRJ-${f(String(t.id))}`,j=`<span class="project-code-badge">#${c(g)}</span>`,B=Kt()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${c(r("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${c(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${j}
            ${x}
          </div>
        </div>
        ${m}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${c(n)}</span><small class="text-muted">${c(a)}</small></div>`:c(n)}
      </td>
      <td>${mt(t.start,t.end)}</td>
      <td>${f(String(o))}</td>
      <td>${f(String(i))}</td>
      <td>${C(u)}</td>
      <td>${C(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${c(r("actions.view","عرض"))}</button>
        ${B}
      </td>
    </tr>
  `}function mt(t,e){if(!t)return"—";const n=X(t);return e?`${n} - ${X(e)}`:n}function Rt(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:d.visibleProjects.length?d.visibleProjects:d.projects).map(v=>{if(!v?.start)return null;const m=new Date(v.start);if(Number.isNaN(m.getTime()))return null;let b=v.end?new Date(v.end):new Date(m);return Number.isNaN(b.getTime())&&(b=new Date(m)),b<=m&&(b=new Date(m.getTime()+qt)),{project:v,startDate:m,endDate:b}}).filter(Boolean).sort((v,m)=>v.startDate-m.startDate);if(!n.length){const v=c(r("projects.timeline.empty",s.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${v}</div>`;return}const a=n[0].startDate.getTime(),o=Math.max(...n.map(v=>v.endDate.getTime()));let i=o-a;i<=0&&(i=qt);const l=Qe(n),u=r("projects.timeline.range","{start} → {end}"),p=r("projects.timeline.conflict","Scheduling conflict"),h=n.map(v=>{const{project:m,startDate:b,endDate:x}=v,g=x.getTime()-b.getTime();let j=(b.getTime()-a)/i*100;j=Math.max(0,Math.min(j,100));let w=g/i*100;w=Math.max(w,2.5),j+w>100&&(w=Math.max(1.5,100-j));const P=`project-timeline__item--${Bt(m)}`,E=l.has(m.id),_=(m.title||"").trim()||r("projects.fallback.untitled","Untitled project"),V=se(_,26),O=d.customers.find(G=>String(G.id)===String(m.clientId)),q=O?.customerName||r("projects.fallback.unknownClient","Unknown client"),I=(m.clientCompany||O?.companyName||"").trim(),D=bt(m.type),M=X(b.toISOString()),R=X(x.toISOString()),N=u.replace("{start}",M).replace("{end}",R),S=I?`${q} (${I})`:q,L=`${_} • ${D} • ${S} | ${N}`,nt=E?`<span class="project-timeline__item-conflict" title="${c(p)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${P}${E?" project-timeline__item--conflict":""}" style="left:${j}%;width:${w}%;" title="${c(L)}">
          <span class="project-timeline__item-label">${c(V)}</span>
          ${nt}
        </div>
      `}).join(""),T=`
    <div class="project-timeline__scale">
      <span>${c(X(new Date(a).toISOString()))}</span>
      <span>${c(X(new Date(o).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${T}
    <div class="project-timeline__track">
      ${h}
    </div>
  `}function Qe(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const o=t[n],i=t[a];o.startDate<i.endDate&&i.startDate<o.endDate&&(e.add(o.project.id),e.add(i.project.id))}return e}function K(){if(!s.focusCards)return;const t=Xe();if(!t.length){const e=c(r("projects.focus.empty",s.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));s.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function Xe(){if(!Array.isArray(d.projects)||!d.projects.length)return[];const t=d.projects.filter(Ut),e=d.projects.filter(i=>!Ut(i)&&tn(i)),n=[],a=new Set,o=(i,l)=>{!i||a.has(i.id)||n.length>=vt||(a.add(i.id),n.push(Ze(i,l)))};if(t.sort((i,l)=>Q(i)-Q(l)).forEach(i=>o(i,"today")),e.sort((i,l)=>Q(i)-Q(l)).forEach(i=>o(i,"thisWeek")),n.length<vt){const i=Date.now();[...d.projects].filter(u=>!a.has(u.id)).filter(u=>{const p=Q(u);return Number.isFinite(p)&&p>=i}).sort((u,p)=>Q(u)-Q(p)).forEach(u=>o(u,"upcoming"))}return n.length<vt&&[...d.projects].filter(l=>!a.has(l.id)).sort((l,u)=>kt(u)-kt(l)).forEach(l=>o(l,"recent")),n}function Ze(t,e){const n=d.customers.find(A=>String(A.id)===String(t.clientId)),a=n?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),o=(t.clientCompany||n?.companyName||"").trim(),i=Array.isArray(t.technicians)?t.technicians.length:0,l=gt(t.id),u=l.length,p=ae(t),{subtotal:h,applyTax:T}=ct(t),v=(t.description||"").trim(),m=v?se(v,110):r("projects.fallback.noDescription","لا يوجد وصف"),b=bt(t.type),x=t.paymentStatus==="paid"?"paid":"unpaid",g=r(`projects.paymentStatus.${x}`,x==="paid"?"Paid":"Unpaid"),j=x==="paid"?"status-paid":"status-unpaid",w=t.confirmed===!0||t.confirmed==="true",B=c(String(t.id)),P=t.projectCode||`PRJ-${f(String(t.id))}`,E=f(P),_={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},V={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},O=_[e]||_.recent,q=r(O,V[e]||V.recent),I=Bt(t),D=r(`projects.status.${I}`,ne[I]||I),M=We[I]||"bg-secondary",R=(t.title||"").trim()||r("projects.fallback.untitled","Untitled project"),N=l.reduce((A,H)=>{const W=oe(H),Se=(H.items||[]).reduce((Te,$e)=>Te+(Number($e?.qty)||1),0),xe=(H.technicians||[]).length;return{total:A.total+W,equipment:A.equipment+Se,crew:A.crew+xe}},{total:0,equipment:0,crew:0}),S=Number(N.total.toFixed(2)),L=N.equipment,nt=N.crew||i,G=T?Number(((h+S)*pt).toFixed(2)):0,U=Number((h+S+G).toFixed(2));`${c(E)}`,b&&`${c(b)}`,q&&`${c(q)}`,`${M}${c(D)}`,`${j}${c(g)}`;const z=(A,H,W)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${A?`<span class="project-focus-card__row-icon">${c(A)}</span>`:""}
        ${c(H)}
      </span>
      <span class="project-focus-card__row-value">${c(String(W))}</span>
    </div>
  `;[{icon:"👤",label:r("projects.details.client","العميل"),value:a},o?{icon:"🏢",label:r("projects.details.company","شركة العميل"),value:o}:null,{icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:b},{icon:"📅",label:r("projects.focus.summary.range","الفترة الزمنية"),value:mt(t.start,t.end)}].filter(Boolean).map(({icon:A,label:H,value:W})=>z(A,H,W)).join(""),[{icon:"💳",label:r("projectCards.stats.paymentStatus","حالة الدفع"),value:g},{icon:"💸",label:r("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:C(p)},{icon:"🧮",label:r("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:C(U)}].map(({icon:A,label:H,value:W})=>z(A,H,W)).join(""),[{icon:"🔗",label:r("projectCards.stats.reservationsShort","الحجوزات"),value:f(String(u))},{icon:"📦",label:r("projectCards.stats.equipmentCount","عدد المعدات"),value:f(String(L))},{icon:"😎",label:r("projectCards.stats.crewCount","عدد الطاقم"),value:f(String(nt))},{icon:"💵",label:r("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:C(S)}].map(({icon:A,label:H,value:W})=>z(A,H,W)).join("");const st=w?`<span class="badge bg-success-subtle text-success fw-semibold">${c(r("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-success btn-sm" data-action="confirm-project" data-id="${B}">${c(r("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`,ot=r("projects.focus.actions.highlight","🔍 عرض في القائمة"),rt=r("projects.focus.actions.view","👁️ عرض التفاصيل"),$=`<span class="badge ${M} text-white fw-semibold">${c(D)}</span>`,k=`<span class="badge ${j==="status-paid"?"bg-success-subtle text-success":"bg-warning-subtle text-warning"} fw-semibold">${c(g)}</span>`,it=[E?`<span class="badge bg-primary-subtle text-primary fw-semibold">#${c(E)}</span>`:"",q?`<span class="badge bg-base-200 text-base-content fw-semibold">${c(q)}</span>`:"",b?`<span class="badge bg-base-200 text-base-content fw-semibold">${c(b)}</span>`:""].filter(Boolean).join(" "),ye=[a?`👤 ${c(a)}`:"",o?`🏢 ${c(o)}`:"",`📅 ${c(mt(t.start,t.end))}`,`😎 ${c(r("projectCards.stats.crewCount","عدد الطاقم"))}: ${f(String(nt))}`,`🔗 ${c(r("projectCards.stats.reservationsShort","الحجوزات"))}: ${f(String(u))}`].filter(Boolean).map(A=>`<span>${A}</span>`).join(""),ve=[`💸 ${C(p)}`,`💵 ${C(S)}`,`🧮 ${C(U)}`].map(A=>`<span>${A}</span>`).join(""),he=`
    <div class="d-flex flex-wrap gap-2 mt-3">
      ${st}
      <button class="btn btn-outline-secondary btn-sm" data-action="highlight" data-id="${B}">${c(ot)}</button>
      <button class="btn btn-primary btn-sm" data-action="view" data-id="${B}">${c(rt)}</button>
    </div>
  `;return`
    <div class="project-card-grid__item">
      <div class="box h-100 project-card project-focus-card" data-project-id="${B}">
        <div class="d-flex justify-content-between align-items-start gap-2 mb-3">
          <div>
            <h5 class="mb-1">${c(R)}</h5>
            <div class="d-flex flex-wrap gap-2 small text-muted">${it}</div>
          </div>
          <div class="d-flex flex-column align-items-end gap-2">
            ${$}
            ${k}
          </div>
        </div>
        <p class="text-muted small mb-3">${c(m)}</p>
        <div class="d-flex flex-column gap-1 text-muted small">
          ${ye}
        </div>
        <div class="d-flex flex-column gap-1 text-muted small mt-3">
          ${ve}
        </div>
        ${he}
      </div>
    </div>
  `}function Ut(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function tn(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const o=a.getDay(),i=o===0?6:o-1;a.setDate(a.getDate()-i);const l=new Date(a);return l.setDate(l.getDate()+7),e>=a&&e<l}function Bt(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function ae(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function ct(t){const e=Number(t?.equipmentEstimate)||0,n=ae(t),a=e+n,o=Number(a.toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true";let l=i?Number(t?.taxAmount):0;i?(!Number.isFinite(l)||l<0)&&(l=Number((o*pt).toFixed(2))):l=0;let u=i?Number(t?.totalWithTax):o;return i?(!Number.isFinite(u)||u<=0)&&(u=Number((o+l).toFixed(2))):u=o,{equipmentEstimate:e,expensesTotal:n,subtotal:o,applyTax:i,taxAmount:l,totalWithTax:u}}function Y(){const t=d.projects.length,e=d.projects.filter(o=>{const i=o.start?new Date(o.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=d.projects.reduce((o,i)=>o+ct(i).expensesTotal,0),a=d.projects.reduce((o,i)=>o+ct(i).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=f(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=f(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=C(n)),s.projectsBudget&&(s.projectsBudget.textContent=C(a))}function gt(t){return t?d.reservations.filter(e=>String(e.projectId)===String(t)):[]}function oe(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(f(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Qt(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(f(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function en(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,o=t.status||t.state||"pending",i=r(`reservations.status.${o}`,o),l=String(o).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[l]||"project-reservation-card__badge--info",h=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",T=h?r("reservations.details.paid","مدفوع"):r("reservations.details.unpaid","غير مدفوع"),v=h?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",m=t.completed===!0||t.completed==="true",b=r("reservations.details.completed","مكتمل"),x=m?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${c(b)}</span>`:"",g=mt(t.start,t.end),j=oe(t),w=C(j),B=r("projects.details.reservations.items","{count} عناصر").replace("{count}",f(String((t.items||[]).length))),P=r("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",f(String((t.technicians||[]).length))),E=r("projects.details.reservations.view","👁️ عرض الحجز");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${c(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${c(i)}</span>
          <span class="project-reservation-card__badge ${v}">${c(T)}</span>
          ${x}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${c(g)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${c(w)}</span>
          <span>📦 ${c(B)}</span>
          <span>😎 ${c(P)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${c(E)}</button>
      </div>
    </article>
  `}function nn(t){const e=gt(t.id).map(g=>({reservation:g,index:d.reservations.findIndex(j=>j===g)})).filter(({index:g})=>Number.isInteger(g)&&g>=0).sort((g,j)=>{const w=g.reservation.start?new Date(g.reservation.start).getTime():0;return(j.reservation.start?new Date(j.reservation.start).getTime():0)-w}),n=r("projects.details.reservations.title","الحجوزات المرتبطة"),a=r("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),o=r("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=r("projects.details.reservations.count","{count} حجوزات"),l=e.length?`<span class="badge project-reservations-count">${c(i.replace("{count}",f(String(e.length))))}</span>`:"",u=e.length>0,p=c(String(t.id)),h=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&h.push("disabled",'aria-disabled="true"');const T=`<button ${h.join(" ")}>${c(a)}</button>`,v=r("projects.details.actions.edit","✏️ تعديل المشروع"),m=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${c(v)}</button>`,b=`<div class="d-flex flex-wrap gap-2">${T}${m}</div>`,x=e.length?`<div class="project-reservations-list">${e.map(({reservation:g,index:j})=>en(g,j,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${c(o)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${c(n)}</h6>
          ${l}
        </div>
        ${b}
      </div>
      ${x}
    </section>
  `}let Ht=null;function sn(t){t&&re()!==t&&Ct({[It]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function re(){return Yt()?.[It]||""}function ie(t){t&&$t()!==t&&Ct({[At]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function $t(){return Yt()?.[At]||""}function an(t){if(!t)return"";const e=t.trim();return e?Object.values(Nt).includes(e)?e:Nt[e]||"":""}function on(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=an(e);if(n)return n}}catch{}return""}function ce(t,e){!t||!s.tabPanes||!s.tabButtons||(s.tabButtons.forEach(n=>{n===e?n.classList.add("active"):n.classList.remove("active")}),s.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&sn(t))}function rn(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const o=n.dataset.tabTarget;o&&(ce(o,n),o==="projects-section"&&(d.filters.search="",s.search&&(s.search.value=""),F(),K(),Y()))}),n.dataset.tabListenerAttached="true")});const t=re(),e=t&&s.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function Lt(t,e){!t||!s.projectSubTabButtons||!s.projectSubTabPanes||(s.projectSubTabButtons.forEach(n=>{n===e?n.classList.add("active"):n.classList.remove("active")}),s.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function cn(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||(s.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(Lt(n,t),ie(n))}),t.dataset.tabListenerAttached="true")}),dn())}function dn(){const e=on()||$t();if(!e)return;const n=s.projectSubTabButtons?.[0],a=s.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===e)||n,o=a?.dataset.projectSubtabTarget;o&&(e!==$t()&&ie(o),Lt(o,a))}function ln(){return s.tabButtons?s.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Ot(t={}){if(t){if(s.tabButtons&&s.tabButtons.length){const n=s.tabButtons.find(o=>o.classList.contains("active"))?.dataset.tabTarget||"",a=t[It];if(a&&a!==n){const o=s.tabButtons.find(i=>i.dataset.tabTarget===a);o&&ce(a,o)}}if(s.projectSubTabButtons&&s.projectSubTabButtons.length&&ln()){const n=s.projectSubTabButtons.find(o=>o.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=t[At];if(a&&a!==n){const o=s.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===a);o&&Lt(a,o)}}}}function un(){Ht||(Ht=Ee(t=>{Ot(t)})),Ce().then(t=>{Ot(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function pn(){if(!Array.isArray(d.projects)||d.projects.length===0)return;let t=!1;const e=d.projects.map(n=>{if(n.projectCode)return n;const a=Gt();return t=!0,{...n,projectCode:a}});t&&(d.projects=e)}function mn(){const{customers:t,technicians:e,equipment:n}=lt();d.customers=Array.isArray(t)?t:[],d.technicians=Array.isArray(e)?e:[],d.equipment=Array.isArray(n)?n:[],d.reservations=J(),d.projects=ut(),pn()}function jt(){if(de(),s.technicianSelect){const t=s.technicianSelect.value,e=c(r("projects.form.selectTechnician","اختر عضو الطاقم"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+d.technicians.map(n=>{const a=r("projects.fallback.technicianName","عضو {id}"),o=n.name||a.replace("{id}",f(String(n.id||"")));return`<option value="${n.id}">${c(o)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=c(r("projects.form.selectEquipment","اختر المعدة"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+d.equipment.map(n=>{const a=n.desc||n.description||n.name||r("projects.fallback.unknownEquipment","معدة");return`<option value="${c(n.barcode||"")}">${c(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function tt(t){if(!s.clientCompany)return;const e=t?.companyName||t?.company||"";s.clientCompany.value=e}function de(){if(!s.client)return;fn();const t=s.client.dataset?.customerId;if(t){const e=d.customers.find(n=>String(n.id)===String(t));e?tt(e):(s.client.dataset.customerId="",tt(null))}else tt(null);document.activeElement===s.client&&wt()}function fn(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",wt(),tt(null)}),s.client.addEventListener("focus",()=>{wt()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>dt(),150)}),s.client.dataset.autocompleteAttached="true")}function dt(){s.clientSuggestions&&(s.clientSuggestions.style.display="none",s.clientSuggestions.innerHTML="")}function wt(){if(!s.client||!s.clientSuggestions)return;const t=bn(),e=at(s.client.value||""),n=e?t.filter(a=>{const o=at(a.name).includes(e),i=at(a.company||"").includes(e);return o||i}).slice(0,10):t.slice(0,10);if(!n.length){dt();return}s.clientSuggestions.innerHTML=n.map(a=>{const o=a.company?`<div class="suggestion-item__meta">${c(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${c(String(a.id))}" data-name="${c(a.name)}" data-company="${c(a.company||"")}">
          <div class="suggestion-item__primary">${c(a.name)}</div>
          ${o}
        </div>
      `}).join(""),s.clientSuggestions.style.display="block",s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",o=>{o.preventDefault();const{id:i,name:l}=o.currentTarget.dataset;s.client&&(s.client.value=l||"",s.client.dataset.customerId=i||"");const u=o.currentTarget.dataset.company||"";tt({companyName:u}),dt()})})}function bn(){return Array.isArray(d.customers)?d.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function gn(t,e=""){if(!Array.isArray(d.customers)||d.customers.length===0)return null;if(e){const o=d.customers.find(i=>String(i.id)===String(e));if(o)return o}const n=at(t||"");if(!n)return null;const a=d.customers.find(o=>at(o.customerName||o.name||"")===n);return a||d.customers.find(o=>at(o.customerName||o.name||"").includes(n))||null}async function jn(t){if(d.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(r("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await Ne(t),await Xt(),await _e(),d.projects=ut(),d.reservations=J(),F(),Y(),K(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),y(r("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=ft(n)?n.message:r("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");y(a,"error")}}async function yn(t,e){if(!t)return!1;const a=J().filter(u=>String(u.projectId)===String(t));if(!a.length)return!1;const o=e==="paid",i=o?"paid":"unpaid";let l=!1;for(const u of a){const p=u.id??u.reservationId;if(!p)continue;const h=u.paid===!0||u.paid==="paid",T=u.paidStatus||u.paymentStatus||(h?"paid":"unpaid");h===o&&T===i||(await Zt(p,{paid_status:i,paid:o}),l=!0)}return l&&(d.reservations=J()),l}async function vn(t){if(!t)return!1;const e=J(),n=d.projects.find(i=>String(i.id)===String(t))||(lt().projects||[]).find?.(i=>String(i.id)===String(t))||null,a=e.filter(i=>String(i.projectId)===String(t));if(!a.length)return!1;let o=!1;for(const i of a){const l=i.id??i.reservationId;if(!l)continue;const u=ke({...i,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await Zt(l,{confirmed:!0,status:p}),o=!0}return o&&(d.reservations=J()),o}async function Et(t,e){if(!t)return!1;const n=await yn(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let ht=!1;function hn(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",Nn),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),dt(),ee(),s.type&&(s.type.value=""),tt(null),le()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{d.filters.search=f(s.search.value||"").trim().toLowerCase(),F()}),s.search.dataset.listenerAttached="true")}function le(){Ue(),d.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),Z(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),yt()}function Sn(){s.addTechnicianBtn&&s.addTechnicianBtn.dataset.listenerAttached!=="true"&&(s.addTechnicianBtn.addEventListener("click",Pn),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&s.addEquipmentBtn.dataset.listenerAttached!=="true"&&(s.addEquipmentBtn.addEventListener("click",In),s.addEquipmentBtn.dataset.listenerAttached="true")}function xn(){St(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;d.selectedTechnicians=d.selectedTechnicians.filter(n=>n!==e),ue()}}),St(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;d.selectedEquipment=d.selectedEquipment.filter(n=>n.barcode!==e),pe()}}),St(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;d.expenses=d.expenses.filter(n=>String(n.id)!==String(e)),me(),Y()}})}function Tn(){s.addExpenseBtn&&s.addExpenseBtn.dataset.listenerAttached!=="true"&&(s.addExpenseBtn.addEventListener("click",An),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&s.expenseAmount.dataset.normalizeAttached!=="true"&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=f(e.value||"");if(e.value=a,n!=null){const o=Math.min(a.length,n);e.setSelectionRange(o,o)}}),s.expenseAmount.dataset.normalizeAttached="true")}function St(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function $n({onViewDetails:t}){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached==="true"||(s.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;t?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!Kt()){Pe();return}const a=n.dataset.id;jn(a)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function wn(){const{customers:t}=lt();d.customers=Array.isArray(t)?t:[],Z(),F(),K()}function En(){const{technicians:t}=lt();d.technicians=Array.isArray(t)?t:[],Z(),F(),K()}function Cn(t){const{reservations:e}=lt();d.reservations=Array.isArray(e)?e:[],F();const n=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),a=s.detailsBody?.dataset.projectId;n&&a&&d.projects.find(i=>String(i.id)===String(a))&&t?.(a)}function Pn(){const t=s.technicianSelect?.value;if(!t){y(r("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(d.selectedTechnicians.includes(t)){y(r("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}d.selectedTechnicians.push(t),Z(),y(r("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function In(){const t=s.equipmentSelect?.value;if(!t){y(r("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(s.equipmentQty?.value||"1",10)||1),n=d.selectedEquipment.find(a=>a.barcode===t);n?n.qty+=e:d.selectedEquipment.push({barcode:t,qty:e}),Z(),y(r("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function An(){const t=(s.expenseLabel?.value||"").trim(),e=f(s.expenseAmount?.value||"0"),n=Number(e);if(!t){y(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){y(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}d.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=f(String(e))),Z(),Y()}function Z(){ue(),pe(),me(),yt()}function ue(){s.technicianList&&Dt(s.technicianList,d.selectedTechnicians,t=>{const n=d.technicians.find(a=>String(a.id)===String(t))?.name||r("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${c(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${c(String(t))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function pe(){s.equipmentList&&Dt(s.equipmentList,d.selectedEquipment,t=>{const e=d.equipment.find(o=>String(o.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||r("projects.fallback.unknownEquipment","معدة"),a=f(String(t.qty||1));return`
      <span class="chip">
        ${c(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${c(String(t.barcode))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function me(){s.expenseList&&Dt(s.expenseList,d.expenses,t=>`
      <div class="expense-item">
        <span>${c(t.label)}</span>
        <span>${C(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${c(String(t.id))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function Dt(t,e,n){if(t){if(!e||e.length===0){const a=c(Ke(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function yt(){if(!s.submitBtn)return;const t=!!d.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";s.submitBtn.textContent=r(e,n)}function Bn(){return d.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function Vt(t){return f(String(t||"")).trim().toLowerCase()}function Ln(){if(!Array.isArray(d.selectedEquipment)||d.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((d.equipment||[]).map(a=>[Vt(a?.barcode),a])),e=[],n=[];return d.selectedEquipment.forEach(a=>{const o=Vt(a?.barcode);if(!o){e.push(a?.barcode||"");return}const i=t.get(o);if(!i||i.id==null){e.push(a?.barcode||o);return}const l=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:i.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:n,missing:e}}function Dn(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,a=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function qn(){return d.selectedEquipment.reduce((t,e)=>{const n=d.equipment.find(o=>String(o.barcode||"")===String(e.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+a*(e.qty||1)},0)}async function Nn(t){if(t.preventDefault(),ht)return;const e=s.title?.value.trim(),n=s.type?.value||"",a=s.client?.value?.trim()||"",o=s.client?.dataset?.customerId||"",i=s.startDate?.value?.trim()||"",l=s.startTime?.value?.trim()||"";if(!e||!n||!i){y(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const u=gn(a,o);if(!u){y(r("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),s.client?.focus();return}const p=String(u.id);s.client&&(s.client.dataset.customerId=p,s.client.value=u.customerName||u.name||s.client.value),tt(u);const h=s.endDate?.value?.trim()||"",T=s.endTime?.value?.trim()||"",v=zt(i,l),m=h?zt(h,T):"",b=new Date(v),x=m?new Date(m):null;if(x&&b>x){y(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}s.expenseAmount&&(s.expenseAmount.value=f(s.expenseAmount.value||""));const g=Bn(),j=qn(),w=s.taxCheckbox?.checked===!0,P=(s.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",E=j+g,_=w?Number((E*pt).toFixed(2)):0,V=Number((E+_).toFixed(2)),{items:O,missing:q}=Ln();if(q.length){y(r("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const I=!!d.editingProjectId,D=I?d.projects.find(S=>String(S.id)===String(d.editingProjectId)):null;if(I&&!D){y(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const M=u.companyName||u.company||"",R=s.description?.value.trim()||"",N=te({projectCode:D?.projectCode||(I?null:Gt()),title:e,type:n,clientId:p,clientCompany:M,description:R,start:v,end:m||null,applyTax:w,paymentStatus:P,equipmentEstimate:j,expenses:d.expenses.map(S=>({id:S.id,label:S.label,amount:S.amount})),taxAmount:_,totalWithTax:V,confirmed:D?.confirmed??!1,technicians:d.selectedTechnicians,equipment:O});ht=!0;try{let S=D?.projectId??D?.id??null;if(I){const L=await Pt(S??d.editingProjectId,N);S=L?.projectId??L?.id??S,await Et(S,P),y(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const L=await Me(N);S=L?.projectId??L?.id??null,await Et(S,P),y(r("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}d.editingProjectId=null,s.form.reset(),le(),ee(),dt(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),d.projects=ut(),d.reservations=J(),F(),Y(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(S){console.error("❌ [projects] handleSubmitProject failed",S);const L=ft(S)?S.message:r("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");y(L,"error")}finally{ht=!1}}function zt(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),l=o.padStart(2,"0");return`${t}T${i}:${l}`}function et(t){const e=d.projects.find($=>String($.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view",s.detailsBody.dataset.projectId=String(e.id);const n=d.customers.find($=>String($.id)===String(e.clientId)),a=ge(e.type),i=e.description?.trim()||r("projects.fallback.noDescription","لا يوجد وصف"),l=n?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${f(String(e.id))}`,h=f(p),T=gt(e.id),v=T.reduce(($,k)=>$+Vn(k),0),m=Number(v.toFixed(2)),b=T.length,{subtotal:x,applyTax:g,expensesTotal:j}=ct(e),w=x,B=g?Number(((w+m)*pt).toFixed(2)):0,P=Number((w+m+B).toFixed(2)),E=Bt(e),_=r(`projects.status.${E}`,ne[E]||E),O={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[E]||"status-confirmed",q=g?r("projects.details.chips.vatOn","شامل الضريبة 15٪"):r("projects.details.chips.vatOff","غير شامل الضريبة"),I=g?"status-paid":"status-unpaid",D=r("projects.details.chips.reservations","{count} حجوزات").replace("{count}",f(String(b))),M=e.paymentStatus==="paid"?"paid":"unpaid",R=r(`projects.paymentStatus.${M}`,M==="paid"?"Paid":"Unpaid"),N=M==="paid"?"status-paid":"status-unpaid",S=r("projects.focus.confirmed","✅ مشروع مؤكد"),L=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${c(S)}</span>`:"",G=[{icon:"💳",label:r("projects.details.summary.paymentStatus","حالة الدفع"),value:R},{icon:"💼",label:r("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:C(w)},{icon:"🔗",label:r("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:C(m)},{icon:"🧮",label:r("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:C(B)},{icon:"💰",label:r("projects.details.summary.overallTotal","الإجمالي الكلي"),value:C(P)}].map(({icon:$,label:k,value:it})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${$} ${c(k)}</span>
      <span class="summary-details-value">${c(it)}</span>
    </div>
  `).join(""),U=[];U.push({icon:"🆔",label:r("projects.details.labels.code","رقم المشروع"),value:`#${h}`}),U.push({icon:"👤",label:r("projects.details.client","العميل"),value:l}),u&&U.push({icon:"🏢",label:r("projects.details.company","شركة العميل"),value:u}),U.push({icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:a}),U.push({icon:"📅",label:r("projects.details.range","الفترة الزمنية"),value:Ye(e.start,e.end)});const z=U.map(({icon:$,label:k,value:it})=>`
    <div class="project-info-row">
      <span>${$} ${c(k)}</span>
      <span>${c(it)}</span>
    </div>
  `).join(""),st=[`<span class="reservation-chip ${O}">${c(_)}</span>`,`<span class="reservation-chip ${I}">${c(q)}</span>`,`<span class="reservation-chip status-info">${c(D)}</span>`,`<span class="reservation-chip ${N}">${c(R)}</span>`,L].filter(Boolean).join(""),ot=r("projects.details.expensesTotal","إجمالي المصاريف"),rt=r("projects.details.reservationsTotal","إجمالي الحجوزات");s.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${c(e.title)}</h4>
          <div class="project-details-chips">${st}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${c(r("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${z}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${c(r("projects.details.summary.title","ملخص مالي"))}</h6>
            ${G}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${c(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${c(ot)}</span>
          <strong>${C(j)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${c(rt)}</span>
          <strong>${C(m)}</strong>
        </div>
      </div>
    </section>
    ${nn(e)}
  `,Mn(e),s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function _n({onOpenProject:t}){!s.focusCards||s.focusCards.dataset.listenerAttached==="true"||(s.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:o,id:i}=n.dataset;if(o==="confirm-project"){e.preventDefault(),e.stopPropagation(),Un(i);return}o==="view"?t?.(i):o==="highlight"&&kn(i);return}const a=e.target.closest(".project-focus-card");a?.dataset.projectId&&t?.(a.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function kn(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){y(r("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function Mn(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]'),n=s.detailsBody.querySelector('[data-action="edit-project"]'),a=s.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",o=>{o.preventDefault(),Rn(t)}),n&&t&&n.addEventListener("click",o=>{o.preventDefault(),fe(t)}),a&&a.addEventListener("click",o=>{const i=o.target.closest('[data-action="view-reservation"]');if(!i)return;const l=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(l)||l<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(l):window.location.href="dashboard.html#reservations")})}function fe(t){if(!t||!s.detailsBody)return;const e=d.projects.find(i=>String(i.id)===String(t.id));if(!e)return;const n=d.customers.find(i=>String(i.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const o={expenses:Array.isArray(e.expenses)?e.expenses.map((i,l)=>({id:i?.id||`expense-${e.id}-${l}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=Hn(e,o),Fn(e,o)}function Fn(t,e={expenses:[]}){const n=s.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",b=>{b.preventDefault(),et(t.id)});const o=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),l=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),h=n.querySelector('[name="project-start-time"]'),T=n.querySelector('[name="project-end-date"]'),v=n.querySelector('[name="project-end-time"]');function m(){u&&(u.innerHTML=be(e.expenses))}m(),l&&l.addEventListener("click",b=>{b.preventDefault();const x=o?.value.trim()||"",g=f(i?.value||"0"),j=Number(g);if(!x){y(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),o?.focus();return}if(!Number.isFinite(j)||j<=0){y(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),i?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:x,amount:j}),o&&(o.value=""),i&&(i.value=""),m()}),u&&u.addEventListener("click",b=>{const x=b.target.closest('[data-action="remove-expense"]');if(!x)return;const{id:g}=x.dataset;e.expenses=e.expenses.filter(j=>String(j.id)!==String(g)),m()}),n.addEventListener("submit",async b=>{if(b.preventDefault(),n.dataset.submitting==="true")return;const x=n.querySelector('[name="project-title"]'),g=n.querySelector('[name="project-type"]'),j=n.querySelector('[name="project-description"]'),w=n.querySelector('[name="project-payment-status"]'),B=n.querySelector('[name="project-apply-tax"]'),P=x?.value.trim()||"",E=g?.value||"",_=p?.value.trim()||"",V=h?.value.trim()||"",O=j?.value.trim()||"",q=w?.value==="paid"?"paid":"unpaid",I=B?.checked===!0;if(!P||!E||!_){y(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),x?.focus();return}const D=T?.value.trim()||"",M=v?.value.trim()||"",R=Mt(_,V),N=D?Mt(D,M):"",S=new Date(R),L=N?new Date(N):null;if(L&&S>L){y(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),T?.focus();return}if(d.projects.findIndex($=>String($.id)===String(t.id))===-1){y(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const G=Number(t.equipmentEstimate)||0,U=e.expenses.reduce(($,k)=>$+(Number(k.amount)||0),0),z=G+U,st=I?Number((z*pt).toFixed(2)):0,ot=I?Number((z+st).toFixed(2)):z,rt=te({projectCode:t.projectCode,title:P,type:E,clientId:t.clientId,clientCompany:t.clientCompany,description:O,start:R,end:N||null,applyTax:I,paymentStatus:q,equipmentEstimate:G,expenses:e.expenses,taxAmount:st,totalWithTax:ot,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:Dn(t)});n.dataset.submitting="true";try{const $=await Pt(t.projectId??t.id,rt),k=$?.projectId??$?.id??t.id;await Et(k,q),d.projects=ut(),d.reservations=J(),y(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),F(),K(),Y(),et(t.id)}catch($){console.error("❌ [projects] Failed to update project from details view",$);const k=ft($)?$.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");y(k,"error")}finally{delete n.dataset.submitting}})}function Rn(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};Ct({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(o=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",o)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(o){console.warn("⚠️ [projects] Unable to encode reservation context",o)}s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function Un(t){if(!t)return;const e=d.projects.find(n=>String(n.id)===String(t));if(!e){y(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(e.confirmed===!0||e.confirmed==="true"){y(r("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await Pt(e.projectId??e.id,{confirmed:!0});const n=await vn(t);d.projects=ut(),d.reservations=J(),F(),K(),Y(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&s.detailsBody?.dataset.projectId===String(t)&&et(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),y(r("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=ft(n)?n.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");y(a,"error")}}function Hn(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=Ft(t.start||""),{date:o,time:i}=Ft(t.end||""),l=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${c(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${On(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${c(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${c(a)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${c(o)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${c(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${c(r("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${c(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${c(r("projects.paymentStatus.unpaid","قيد الانتظار"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${c(r("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${l?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${c(r("projects.form.labels.applyTax","تطبيق الضريبة 15٪"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${c(r("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${c(r("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${c(r("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${c(r("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${be(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${c(r("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${c(r("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function On(t){return["commercial","coverage","photography","social"].map(n=>{const a=ge(n),o=n===t?"selected":"";return`<option value="${c(n)}" ${o}>${c(a)}</option>`}).join("")}function be(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${c(r("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=c(r("actions.remove","إزالة"));return t.map(n=>{const a=c(n?.label||""),o=c(C(n?.amount||0)),i=c(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${o}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function ge(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function Vn(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(f(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Qt(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(f(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function je(t){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(t);if(a)return a}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const a=new URLSearchParams(e).get(t);if(a)return a}catch{}return null}function zn(){return je(xt)}function Wn(){return je(Tt)}function Jn(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[xt,Tt].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let a=e,o=!1;if(e)try{const p=new URLSearchParams(e);let h=!1;[xt,Tt].forEach(T=>{p.has(T)&&(p.delete(T),h=!0)}),h&&(a=p.toString(),o=!0)}catch{}if(!n&&!o)return;const i=window.location.pathname,l=t.toString(),u=`${i}${l?`?${l}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",u)}catch{}}function Kn(){const t=zn(),e=Wn();t&&(d.pendingProjectDetailId=t),e&&(d.pendingProjectEditId=e,d.pendingProjectDetailId||(d.pendingProjectDetailId=e)),(t||e)&&Jn()}function Yn(){if(!d.pendingProjectDetailId)return;const t=d.pendingProjectDetailId,e=String(t),n=d.projects.find(o=>[o?.id,o?.projectId,o?.project_id].some(l=>l!=null&&String(l)===e));if(!n)return;d.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??e;if(et(a),d.pendingProjectEditId!=null){const o=String(d.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(l=>l!=null&&String(l)===o)&&(d.pendingProjectEditId=null,setTimeout(()=>fe(n),0))}}function Gn(){document.addEventListener("DOMContentLoaded",()=>{un(),Kn(),Oe(),yt(),Ve(),rn(),cn(),ze(),hn(),Sn(),xn(),Tn(),$n({onViewDetails:et}),_n({onOpenProject:et}),de(),Qn()}),document.addEventListener("language:changed",Wt),document.addEventListener("language:translationsReady",Wt),document.addEventListener("customers:changed",Xn),document.addEventListener("technicians:updated",Zn),document.addEventListener("reservations:changed",()=>Cn(et)),document.addEventListener(Ie.USER_UPDATED,()=>{F()})}async function Qn(){try{await Fe({suppressError:!0}),await Xt()}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||r("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");y(e,"error")}finally{mn(),jt(),Z(),F(),Y(),K(),Yn()}}function Wt(){jt(),Z(),F(),Y(),K(),yt()}function Xn(){wn(),jt()}function Zn(){En(),jt()}Ae();Be();Le();Re();Gn();document.addEventListener("DOMContentLoaded",()=>{qe(),De()});
