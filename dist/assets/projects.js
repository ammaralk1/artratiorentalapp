import{r as wt,q as Tt,p as Ye,u as De,h as E,t as r,n as j,f as xt,a as Pt,m as Et,c as Ct,i as $t,d as Lt,k as qe,e as he}from"./auth.js";/* empty css     */import{i as Dt}from"./dashboardShell.js";import{d,r as U,a as se,u as ne,P as Ae,b as ke,f as _e,s as g,h as At,i as kt,j as Rt,k as Nt,l as Bt,m as It,n as c,o as _,p as Mt,q as Ft,t as Oe,e as Te,v as Ve,g as qt,c as _t,w as Ot,x as Vt,y as xe,z as Pe,A as Ht,B as Xe,C as Ut,D as zt,E as Wt,F as Jt,G as Kt,H as Gt,I as Yt,J as Xt,K as Qt,L as Zt,M as ea,N as be,O as ta,Q as Qe,R as aa,S as sa}from"./form.js";import"./customers.js";import{g as Re,k as Ze,D as Ee,e as na,f as ra,a as oa}from"./reservationsService.js";import{j as et,B as Ne,C as ye,h as ia,e as tt,D as at,o as ca,k as la}from"./controller.js";let He=null;function da(e){e&&st()!==e&&De({[Ae]:e}).catch(a=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",a)})}function st(){return Ye()?.[Ae]||""}function nt(e){e&&Ce()!==e&&De({[ke]:e}).catch(a=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",a)})}function Ce(){return Ye()?.[ke]||""}function ua(e){if(!e)return"";const a=e.trim();return a?Object.values(_e).includes(a)?a:_e[a]||"":""}function pa(){if(typeof window>"u")return"";try{const a=new URLSearchParams(window.location.search||"").get("subTab");if(a){const t=ua(a);if(t)return t}}catch{}return""}function rt(e,a){!e||!d.tabPanes||!d.tabButtons||(d.tabButtons.forEach(t=>{const s=t===a;t.classList.toggle("active",s),t.classList.contains("tab-button")&&t.classList.toggle("tab-active",s)}),d.tabPanes.forEach(t=>{t.dataset.tabPane===e?t.classList.remove("d-none"):t.classList.add("d-none")}),a&&da(e))}function ma(){if(!d.tabButtons||!d.tabButtons.length)return;d.tabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",s=>{s.preventDefault();const n=t.dataset.tabTarget;n&&(rt(n,t),n==="projects-section"&&(g.filters.search="",d.search&&(d.search.value=""),U(),se(),ne()))}),t.dataset.tabListenerAttached="true")});const e=st(),a=e&&d.tabButtons.find(t=>t.dataset.tabTarget===e);a&&a.click()}function Be(e,a){!e||!d.projectSubTabButtons||!d.projectSubTabPanes||(d.projectSubTabButtons.forEach(t=>{const s=t===a;t.classList.toggle("active",s),t.classList.contains("tab")&&t.classList.toggle("tab-active",s)}),d.projectSubTabPanes.forEach(t=>{t.dataset.projectSubtab===e?t.classList.remove("d-none"):t.classList.add("d-none")}))}function fa(){!d.projectSubTabButtons||!d.projectSubTabButtons.length||(d.projectSubTabButtons.forEach(e=>{e.dataset.tabListenerAttached!=="true"&&(e.addEventListener("click",a=>{a.preventDefault();const t=e.dataset.projectSubtabTarget;t&&(Be(t,e),nt(t))}),e.dataset.tabListenerAttached="true")}),ha())}function ha(){const a=pa()||Ce();if(!a)return;const t=d.projectSubTabButtons?.[0],s=d.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===a)||t,n=s?.dataset.projectSubtabTarget;n&&(a!==Ce()&&nt(n),Be(n,s))}function ba(){return d.tabButtons?d.tabButtons.find(a=>a.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Ue(e={}){if(e){if(d.tabButtons&&d.tabButtons.length){const t=d.tabButtons.find(n=>n.classList.contains("active"))?.dataset.tabTarget||"",s=e[Ae];if(s&&s!==t){const n=d.tabButtons.find(i=>i.dataset.tabTarget===s);n&&rt(s,n)}}if(d.projectSubTabButtons&&d.projectSubTabButtons.length&&ba()){const t=d.projectSubTabButtons.find(n=>n.classList.contains("active"))?.dataset.projectSubtabTarget||"",s=e[ke];if(s&&s!==t){const n=d.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===s);n&&Be(s,n)}}}}function ya(){He||(He=wt(e=>{Ue(e)})),Tt().then(e=>{Ue(e)}).catch(e=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",e)})}function O(e){const a=g.projects.find($=>String($.id)===String(e));if(!a||!d.detailsBody)return;d.detailsBody.dataset.mode="view",d.detailsBody.dataset.projectId=String(a.id);const t=g.customers.find($=>String($.id)===String(a.clientId)),s=ct(a.type),i=a.description?.trim()||r("projects.fallback.noDescription","لا يوجد وصف"),u=t?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),f=(a.clientCompany||t?.companyName||"").trim(),l=a.projectCode||`PRJ-${j(String(a.id))}`,p=j(l),m=kt(a.id),S=m.reduce(($,I)=>$+Ea(I),0),h=Number(S.toFixed(2)),v=m.length,{subtotal:y,applyTax:T,expensesTotal:M}=Rt(a),F=y,k=T?Number(((F+h)*Nt).toFixed(2)):0,z=Number((F+h+k).toFixed(2)),R=Bt(a),W=r(`projects.status.${R}`,It[R]||R),w={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[R]||"status-confirmed",q=T?r("projects.details.chips.vatOn","شامل الضريبة 15٪"):r("projects.details.chips.vatOff","غير شامل الضريبة"),A=T?"status-paid":"status-unpaid",re=r("projects.details.chips.reservations","{count} حجوزات").replace("{count}",j(String(v))),J=typeof a.paymentStatus=="string"?a.paymentStatus.toLowerCase():"",N=["paid","partial"].includes(J)?J:"unpaid",oe=r(`projects.paymentStatus.${N}`,N==="paid"?"Paid":N==="partial"?"Partial":"Unpaid"),ve=N==="paid"?"status-paid":N==="partial"?"status-partial":"status-unpaid",ie=r("projects.focus.confirmed","✅ مشروع مؤكد"),ce=a.confirmed===!0||a.confirmed==="true"?`<span class="reservation-chip status-confirmed">${c(ie)}</span>`:"",le=[{icon:"💳",label:r("projects.details.summary.paymentStatus","حالة الدفع"),value:oe},{icon:"💼",label:r("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:_(F)},{icon:"🔗",label:r("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:_(h)},{icon:"🧮",label:r("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:_(k)},{icon:"💰",label:r("projects.details.summary.overallTotal","الإجمالي الكلي"),value:_(z)}].map(({icon:$,label:I,value:Y})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${$} ${c(I)}</span>
      <span class="summary-details-value">${c(Y)}</span>
    </div>
  `).join(""),B=[];B.push({icon:"🆔",label:r("projects.details.labels.code","رقم المشروع"),value:`#${p}`}),B.push({icon:"👤",label:r("projects.details.client","العميل"),value:u}),f&&B.push({icon:"🏢",label:r("projects.details.company","شركة العميل"),value:f}),B.push({icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:s}),B.push({icon:"📅",label:r("projects.details.range","الفترة الزمنية"),value:Mt(a.start,a.end)});const de=B.map(({icon:$,label:I,value:Y})=>`
    <div class="project-info-row">
      <span>${$} ${c(I)}</span>
      <span>${c(Y)}</span>
    </div>
  `).join(""),G=[`<span class="reservation-chip ${w}">${c(W)}</span>`,`<span class="reservation-chip ${A}">${c(q)}</span>`,`<span class="reservation-chip status-info">${c(re)}</span>`,`<span class="reservation-chip ${ve}">${c(oe)}</span>`,ce].filter(Boolean).join(""),je=r("projects.details.expensesTotal","إجمالي المصاريف"),ue=r("projects.details.reservationsTotal","إجمالي الحجوزات");d.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${c(a.title)}</h4>
          <div class="project-details-chips">${G}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${a.id}">
          ${c(r("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${de}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${c(r("projects.details.summary.title","ملخص مالي"))}</h6>
            ${le}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${c(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${c(je)}</span>
          <strong>${_(M)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${c(ue)}</span>
          <strong>${_(h)}</strong>
        </div>
      </div>
    </section>
    ${Ft(a)}
  `,ja(a),d.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(d.detailsModalEl).show()}function ga({onOpenProject:e}){!d.focusCards||d.focusCards.dataset.listenerAttached==="true"||(d.focusCards.addEventListener("click",a=>{const t=a.target.closest("[data-action]");if(t){const{action:n,id:i}=t.dataset;if(n==="confirm-project"){a.preventDefault(),a.stopPropagation(),Ta(i);return}n==="view"?e?.(i):n==="highlight"&&va(i);return}const s=a.target.closest(".project-focus-card");s?.dataset.projectId&&e?.(s.dataset.projectId)}),d.focusCards.dataset.listenerAttached="true")}function va(e){if(!d.projectsTableBody)return;const a=`tr[data-project-id="${CSS.escape(String(e))}"]`,t=d.projectsTableBody.querySelector(a);if(!t){E(r("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}t.classList.add("project-row-highlight"),t.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{t.classList.remove("project-row-highlight")},2200)}function ja(e){if(!d.detailsBody)return;const a=d.detailsBody.querySelector('[data-action="create-reservation"]'),t=d.detailsBody.querySelector('[data-action="edit-project"]'),s=d.detailsBody.querySelector(".project-reservations-list");a&&e&&a.addEventListener("click",n=>{n.preventDefault(),wa(e)}),t&&e&&t.addEventListener("click",n=>{n.preventDefault(),ot(e)}),s&&s.addEventListener("click",n=>{const i=n.target.closest('[data-action="view-reservation"]');if(!i)return;const u=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(u)||u<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(u):window.location.href="dashboard.html#reservations")})}function ot(e){if(!e||!d.detailsBody)return;const a=g.projects.find(i=>String(i.id)===String(e.id));if(!a)return;const t=g.customers.find(i=>String(i.id)===String(a.clientId));t?.customerName||t?.name||a.clientName||a.customerName,a.clientCompany||t?.companyName||t?.company;const n={expenses:Array.isArray(a.expenses)?a.expenses.map((i,u)=>({id:i?.id||`expense-${a.id}-${u}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};d.detailsBody.dataset.mode="edit",d.detailsBody.innerHTML=xa(a,n),Sa(a,n)}function Sa(e,a={expenses:[]}){const t=d.detailsBody?.querySelector("#project-details-edit-form");if(!t)return;const s=t.querySelector('[data-action="cancel-edit"]');s&&s.addEventListener("click",x=>{x.preventDefault(),O(e.id)});const n=t.querySelector("#project-edit-expense-label"),i=t.querySelector("#project-edit-expense-amount"),u=t.querySelector('[data-action="add-expense"]'),f=t.querySelector("#project-edit-expense-list"),l=t.querySelector('[name="project-start-date"]'),p=t.querySelector('[name="project-start-time"]'),m=t.querySelector('[name="project-end-date"]'),S=t.querySelector('[name="project-end-time"]'),h=t.querySelector('[name="project-payment-status"]'),v=t.querySelector("#project-edit-tax"),y=t.querySelector("#project-edit-company-share"),T=t.querySelector("#project-edit-discount"),M=t.querySelector("#project-edit-discount-type"),F=t.querySelector("#project-edit-payment-progress-type"),k=t.querySelector("#project-edit-payment-progress-value");let z=!1;const R=x=>{!v||!y||z||(z=!0,x==="share"?y.checked?(v.checked||(v.checked=!0),Te(y)):v.checked&&(v.checked=!1):x==="tax"&&(v.checked?Te(y):y.checked&&(y.checked=!1)),z=!1)};function W(){f&&(f.innerHTML=it(a.expenses))}W(),T&&!T.dataset.listenerAttached&&(T.addEventListener("input",x=>{const w=x.target;w instanceof HTMLInputElement&&(w.value=j(w.value||""))}),T.dataset.listenerAttached="true"),k&&!k.dataset.listenerAttached&&(k.addEventListener("input",x=>{const w=x.target;w instanceof HTMLInputElement&&(w.value=j(w.value||""))}),k.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("change",()=>{h.dataset.userSelected="true"}),h.dataset.listenerAttached="true"),y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>R("share")),y.dataset.listenerAttached="true"),v&&!v.dataset.listenerAttached&&(v.addEventListener("change",()=>R("tax")),v.dataset.listenerAttached="true"),y?.checked&&Te(y),R(y?.checked?"share":"tax"),u&&u.addEventListener("click",x=>{x.preventDefault();const w=n?.value.trim()||"",q=j(i?.value||"0"),A=Number(q);if(!w){E(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),n?.focus();return}if(!Number.isFinite(A)||A<=0){E(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),i?.focus();return}a.expenses.push({id:`expense-${e.id}-${Date.now()}`,label:w,amount:A}),n&&(n.value=""),i&&(i.value=""),W()}),f&&f.addEventListener("click",x=>{const w=x.target.closest('[data-action="remove-expense"]');if(!w)return;const{id:q}=w.dataset;a.expenses=a.expenses.filter(A=>String(A.id)!==String(q)),W()}),t.addEventListener("submit",async x=>{if(x.preventDefault(),t.dataset.submitting==="true")return;const w=t.querySelector('[name="project-title"]'),q=t.querySelector('[name="project-type"]'),A=t.querySelector('[name="project-description"]'),re=w?.value.trim()||"",J=q?.value||"",N=l?.value.trim()||"",oe=p?.value.trim()||"",ve=A?.value.trim()||"",ie=(h?.value||"unpaid").toLowerCase(),ce=["paid","partial"].includes(ie)?ie:"unpaid",K=v?.checked===!0;if(!re||!J||!N){E(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),w?.focus();return}const le=m?.value.trim()||"",B=S?.value.trim()||"",de=Ve(N,oe),G=le?Ve(le,B):"",je=new Date(de),ue=G?new Date(G):null;if(ue&&je>ue){E(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),m?.focus();return}if(g.projects.findIndex(D=>String(D.id)===String(e.id))===-1){E(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const I=Number(e.equipmentEstimate)||0,Y=a.expenses.reduce((D,te)=>D+(Number(te.amount)||0),0),Me=M?.value==="amount"?"amount":"percent",yt=j(T?.value||"0");let X=Number.parseFloat(yt);(!Number.isFinite(X)||X<0)&&(X=0);const Q=y?.checked===!0;let Z=Q?qt(y):null;(!Number.isFinite(Z)||Z<=0)&&(Z=Q?Ee:null);const ee=_t({equipmentEstimate:I,expensesTotal:Y,discountValue:X,discountType:Me,applyTax:K,companyShareEnabled:Q,companySharePercent:Z}),gt=F?.value==="amount"?"amount":"percent",Fe=j(k?.value||""),vt=Fe?Number.parseFloat(Fe):null,H=na({totalAmount:ee.totalWithTax,progressType:gt,progressValue:vt,history:[]}),Se=h?.dataset?.userSelected==="true",jt=ra({manualStatus:Se?ce:null,paidAmount:H.paidAmount,paidPercent:H.paidPercent,totalAmount:ee.totalWithTax}),we=Se?ce:jt;!Se&&h&&(h.value=we),h?.dataset&&delete h.dataset.userSelected;const St=ia({projectCode:e.projectCode,title:re,type:J,clientId:e.clientId,clientCompany:e.clientCompany,description:ve,start:de,end:G||null,applyTax:K,paymentStatus:we,equipmentEstimate:I,expenses:a.expenses,discount:X,discountType:Me,companyShareEnabled:Q&&K,companySharePercent:Q&&K?Z:null,companyShareAmount:ee.companyShareAmount,taxAmount:ee.taxAmount,totalWithTax:ee.totalWithTax,confirmed:e.confirmed,technicians:Array.isArray(e.technicians)?e.technicians:[],equipment:Ot(e),paidAmount:H.paidAmount,paidPercentage:H.paidPercent,paymentProgressType:H.paymentProgressType,paymentProgressValue:H.paymentProgressValue});t.dataset.submitting="true";try{const D=await et(e.projectId??e.id,St),te=D?.projectId??D?.id??e.id;await Vt(te,we),g.projects=Ne(),g.reservations=Re(),E(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),U(),se(),ne(),O(e.id)}catch(D){console.error("❌ [projects] Failed to update project from details view",D);const te=ye(D)?D.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");E(te,"error")}finally{delete t.dataset.submitting}})}function wa(e){if(!e)return;const a={projectId:e.id,customerId:e.clientId||null,start:e.start||null,end:e.end||null,forceNotes:!!e.description};De({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(n=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",n)});let t="";try{t=encodeURIComponent(JSON.stringify(a))}catch(n){console.warn("⚠️ [projects] Unable to encode reservation context",n)}d.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(d.detailsModalEl)?.hide();const s=t?`?reservationProjectContext=${t}`:"";window.location.href=`dashboard.html${s}#reservations`}async function Ta(e){if(!e)return;const a=g.projects.find(t=>String(t.id)===String(e));if(!a){E(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(a.confirmed===!0||a.confirmed==="true"){E(r("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await et(a.projectId??a.id,{confirmed:!0});const t=await At(e);g.projects=Ne(),g.reservations=Re(),U(),se(),ne(),d.detailsModalEl&&d.detailsModalEl.classList.contains("show")&&d.detailsBody?.dataset.projectId===String(e)&&O(e),document.dispatchEvent(new CustomEvent("projects:changed")),t&&document.dispatchEvent(new CustomEvent("reservations:changed")),E(r("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(t){console.error("❌ [projects] confirmProject failed",t);const s=ye(t)?t.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");E(s,"error")}}function xa(e,a={clientName:"",clientCompany:"",expenses:[]}){const{date:t,time:s}=Oe(e.start||""),{date:n,time:i}=Oe(e.end||""),u=e.applyTax===!0||e.applyTax==="true",f=typeof e.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",l=["paid","partial"].includes(f)?f:"unpaid",p=e.discountType==="amount"?"amount":"percent",m=j(String(e.discount??e.discountValue??0)),S=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??e.companyShareAmountPercent??Ee,h=Number.parseFloat(j(String(S))),v=Number.isFinite(h)&&h>0?h:Ee,y=e.companyShareEnabled===!0||e.companyShareEnabled==="true"||e.company_share_enabled===!0||e.company_share_enabled==="true"||u&&Number.isFinite(h)&&h>0,T=e.paymentProgressType==="amount"?"amount":e.paymentProgressType==="percent"?"percent":e.payment_progress_type==="amount"?"amount":(e.payment_progress_type==="percent","percent"),M=j(String(e.paymentProgressValue??e.payment_progress_value??(T==="amount"?e.paidAmount??e.paid_amount:e.paidPercent??e.paid_percent)??""));return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${c(e.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${Pa(e.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${c(t)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${c(s)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${c(n)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${c(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${c(r("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${c(e.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status" id="project-edit-payment-status">
            <option value="unpaid" ${l==="unpaid"?"selected":""}>${c(r("projects.paymentStatus.unpaid","غير مدفوع"))}</option>
            <option value="partial" ${l==="partial"?"selected":""}>${c(r("projects.paymentStatus.partial","مدفوع جزئياً"))}</option>
            <option value="paid" ${l==="paid"?"selected":""}>${c(r("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
      </div>

      <div class="row g-3 align-items-start mt-3">
        <div class="col-md-4">
          <label class="form-label" for="project-edit-discount">${c(r("projects.form.labels.discount","الخصم"))}</label>
          <div class="input-group">
            <select id="project-edit-discount-type" name="project-discount-type" class="form-select">
              <option value="percent" ${p==="percent"?"selected":""}>${c(r("projects.form.discount.percent","٪ نسبة"))}</option>
              <option value="amount" ${p==="amount"?"selected":""}>${c(r("projects.form.discount.amount","💵 مبلغ"))}</option>
            </select>
            <input type="text" id="project-edit-discount" name="project-discount" class="form-control" value="${c(m)}" placeholder="0" inputmode="decimal">
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label d-block" for="project-edit-company-share">${c(r("projects.form.labels.companyShare","نسبة الشركة والضريبة"))}</label>
          <div class="d-flex flex-column gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-company-share" name="project-company-share" data-company-share="${c(String(v))}" ${y?"checked":""}>
              <label class="form-check-label" for="project-edit-company-share">${c(r("projects.form.companyShareToggle","إضافة نسبة الشركة (10٪)"))}</label>
            </div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-tax" name="project-apply-tax" ${u?"checked":""}>
              <label class="form-check-label" for="project-edit-tax">${c(r("projects.form.taxLabel","شامل الضريبة (15٪)"))}</label>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="project-edit-payment-progress-value">${c(r("projects.form.paymentProgress.label","💰 الدفعة المستلمة"))}</label>
          <div class="input-group">
            <select id="project-edit-payment-progress-type" name="project-payment-progress-type" class="form-select">
              <option value="amount" ${T==="amount"?"selected":""}>${c(r("projects.form.paymentProgress.amount","💵 مبلغ"))}</option>
              <option value="percent" ${T!=="amount"?"selected":""}>${c(r("projects.form.paymentProgress.percent","٪ نسبة"))}</option>
            </select>
            <input type="text" id="project-edit-payment-progress-value" name="project-payment-progress-value" class="form-control" value="${c(M)}" placeholder="0" inputmode="decimal">
          </div>
          <small class="text-muted" data-i18n-key="projects.form.paymentProgress.hint">${c(r("projects.form.paymentProgress.hint","أدخل المبلغ أو النسبة التي تم استلامها من قيمة المشروع"))}</small>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${c(r("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${c(r("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${c(r("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${c(r("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${it(a.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${c(r("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${c(r("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function Pa(e){return["commercial","coverage","photography","social"].map(t=>{const s=ct(t),n=t===e?"selected":"";return`<option value="${c(t)}" ${n}>${c(s)}</option>`}).join("")}function it(e=[]){if(!Array.isArray(e)||e.length===0)return`<div class="text-muted small" data-empty>${c(r("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const a=c(r("actions.remove","إزالة"));return e.map(t=>{const s=c(t?.label||""),n=c(_(t?.amount||0)),i=c(String(t?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${s}</div>
            <div class="text-muted small">${n}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${a}">✖</button>
        </div>
      `}).join("")}function ct(e){if(!e)return r("projects.form.types.unknown","نوع غير محدد");const a={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return r(a,e)}function Ea(e){if(!e)return 0;const a=Array.isArray(e.items)?e.items:[],t=e.discount??0,s=Number(j(String(t)))||0,n=e.discountType||"percent",i=Array.isArray(e.technicians)?e.technicians:[],u=Ze(a,s,n,!1,i,{start:e.start,end:e.end});if(Number.isFinite(u))return u;const f=Number(j(String(e.cost??0)));return Number.isFinite(f)?Math.round(f):0}function lt(e){if(typeof window>"u")return null;try{const s=new URLSearchParams(window.location.search||"").get(e);if(s)return s}catch{}const a=window.location.hash?window.location.hash.replace(/^#/,""):"";if(a&&a.includes(`${e}=`))try{const s=new URLSearchParams(a).get(e);if(s)return s}catch{}return null}function Ca(){return lt(xe)}function $a(){return lt(Pe)}function La(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const e=new URLSearchParams(window.location.search||""),a=window.location.hash?window.location.hash.replace(/^#/,""):"";let t=!1;[xe,Pe].forEach(l=>{e.has(l)&&(e.delete(l),t=!0)});let s=a,n=!1;if(a)try{const l=new URLSearchParams(a);let p=!1;[xe,Pe].forEach(m=>{l.has(m)&&(l.delete(m),p=!0)}),p&&(s=l.toString(),n=!0)}catch{}if(!t&&!n)return;const i=window.location.pathname,u=e.toString(),f=`${i}${u?`?${u}`:""}${s?`#${s}`:""}`;window.history.replaceState({},"",f)}catch{}}function Da(){const e=Ca(),a=$a();e&&(g.pendingProjectDetailId=e),a&&(g.pendingProjectEditId=a,g.pendingProjectDetailId||(g.pendingProjectDetailId=a)),(e||a)&&La()}function Aa(){if(!g.pendingProjectDetailId)return;const e=g.pendingProjectDetailId,a=String(e),t=g.projects.find(n=>[n?.id,n?.projectId,n?.project_id].some(u=>u!=null&&String(u)===a));if(!t)return;g.pendingProjectDetailId=null;const s=t?.id??t?.projectId??t?.project_id??a;if(O(s),g.pendingProjectEditId!=null){const n=String(g.pendingProjectEditId);[t.id,t.projectId,t.project_id].some(u=>u!=null&&String(u)===n)&&(g.pendingProjectEditId=null,setTimeout(()=>ot(t),0))}}function ka(){document.addEventListener("DOMContentLoaded",()=>{ya(),Da(),Ht(),Xe(),Ut(),ma(),fa(),zt(),Wt(),Jt(),Kt(),Gt(),Yt(),Xt({onViewDetails:O}),ga({onOpenProject:O}),Qt(),Ra()}),document.addEventListener("language:changed",ze),document.addEventListener("language:translationsReady",ze),document.addEventListener("customers:changed",Na),document.addEventListener("technicians:updated",Ba),document.addEventListener("reservations:changed",()=>Zt(O)),document.addEventListener(xt.USER_UPDATED,()=>{U()})}async function Ra(){try{await tt({suppressError:!0}),await at()}catch(e){console.error("❌ [projects] Failed to initialise projects data",e);const a=e?.message||r("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");E(a,"error")}finally{ea(),be(),ta(),Qe(),U(),ne(),se(),Aa()}}function ze(){be(),Qe(),U(),ne(),se(),Xe()}function Na(){aa(),be()}function Ba(){sa(),be()}Pt();Et();Ct();ca();ka();document.addEventListener("DOMContentLoaded",()=>{Dt(),$t()});const We=.15,pe={},Ia="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let ae=0;const b={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},o={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},me=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let C=null;const dt=["upcoming","ongoing","completed"];async function Ma({forceProjects:e=!1}={}){try{await tt({suppressError:!0}),await la({force:e})}catch(a){console.error("❌ [projectsReports] Failed to load initial data",a),ye(a)&&console.warn("Projects API error:",a.message)}ft()}async function Fa(){Oa(),pt(),await qa();try{await Ma({forceProjects:!0}),bt(),Ja(),L()}finally{mt()}document.addEventListener("language:changed",Ga),document.addEventListener("projects:changed",()=>{$e().catch(e=>{console.error("❌ [projectsReports] Failed to refresh after projects change",e)})}),document.addEventListener("reservations:changed",()=>{$e().catch(e=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",e)})}),window.addEventListener("storage",Ya)}document.addEventListener("DOMContentLoaded",Fa);async function qa(){if(C)return C;if(typeof window>"u")return null;if(window.ApexCharts)return C=window.ApexCharts,C;try{await _a(Ia),C=window.ApexCharts||null}catch(e){console.warn("ApexCharts failed to load",e),C=null}return C}function _a(e){return new Promise((a,t)=>{if(typeof document>"u"){t(new Error("Document is not available to load scripts."));return}const s=document.querySelector(`script[src="${e}"]`);if(s){if(s.dataset.loaded==="true"){a();return}s.addEventListener("load",a,{once:!0}),s.addEventListener("error",()=>t(new Error(`Failed to load script ${e}`)),{once:!0});return}const n=document.createElement("script");n.src=e,n.async=!0,n.dataset.loaded="false",n.onload=()=>{n.dataset.loaded="true",a()},n.onerror=()=>t(new Error(`Failed to load script ${e}`)),document.head.appendChild(n)})}function Oa(){o.search=document.getElementById("reports-search"),o.statusChips=document.getElementById("reports-status-chips"),o.payment=document.getElementById("reports-payment"),o.dateRange=document.getElementById("reports-date-range"),o.customRangeWrapper=document.getElementById("reports-custom-range"),o.startDate=document.getElementById("reports-start-date"),o.endDate=document.getElementById("reports-end-date"),o.refreshBtn=document.getElementById("reports-refresh"),o.kpiGrid=document.getElementById("reports-kpi-grid"),o.table=document.getElementById("reports-table"),o.tableBody=o.table?.querySelector("tbody"),o.tableMeta=document.getElementById("reports-table-meta"),o.tableEmpty=document.getElementById("reports-empty"),o.chartCards={},o.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(e=>{const a=e.dataset.chartCard;if(!a)return;o.chartCards[a]=e;const t=e.querySelector("[data-chart-loading]");t&&(o.chartLoaders[a]=t)})}function ut(e){const a=!!e;Object.entries(o.chartCards||{}).forEach(([t,s])=>{if(!s)return;s.classList.toggle("is-loading",a),s.setAttribute("aria-busy",a?"true":"false");const n=o.chartLoaders?.[t];n&&(n.hidden=!a)})}function pt(){ae+=1,ae===1&&ut(!0)}function mt(){ae=Math.max(0,ae-1),ae===0&&ut(!1)}function ft(){const{customers:e=[]}=Lt();b.customers=Array.isArray(e)?e:[],b.reservations=Re();const a=new Map(b.customers.map(s=>[String(s.id),s])),t=Ne();b.projects=Array.isArray(t)?t.map(s=>Va(s,a)):[],b.totalProjects=b.projects.length}function Va(e,a){const t=e.paymentStatus==="paid"?"paid":"unpaid",s=a.get(String(e.clientId)),n=Ha(e.id),i=n.reduce((M,F)=>M+Ua(F),0),u=za(e),f=Number(e?.equipmentEstimate)||0,l=Number((f+u).toFixed(2)),p=e?.applyTax===!0||e?.applyTax==="true",m=p?Number((l*We).toFixed(2)):0,S=p?Number(((l+i)*We).toFixed(2)):0,h=Number((l+i+S).toFixed(2)),v=Wa(e),y=e.start?new Date(e.start):null,T=e.end?new Date(e.end):null;return{raw:e,id:e.id,projectCode:e.projectCode||e.id,title:(e.title||"").trim(),clientId:e.clientId,clientName:s?.customerName||s?.name||"",clientCompany:e.clientCompany||s?.companyName||"",type:e.type||e.projectType||"",description:e.description||"",paymentStatus:t,confirmed:e.confirmed===!0||e.confirmed==="true",start:y,end:T,applyTax:p,status:v,reservationsTotal:Number(i.toFixed(2)),expensesTotal:u,subtotal:l,taxAmount:m,combinedTaxAmount:S,overallTotal:h,unpaidValue:t==="paid"?0:h,reservationsCount:n.length}}function Ha(e){return Array.isArray(b.reservations)?b.reservations.filter(a=>String(a.projectId)===String(e)):[]}function Ua(e){if(!e)return 0;const a=Array.isArray(e.items)?e.items:[],t=e.discount??0,s=Number(j(String(t)))||0,n=e.discountType||"percent",i=Array.isArray(e.technicians)?e.technicians:[],u=Ze(a,s,n,!1,i,{start:e.start,end:e.end});if(Number.isFinite(u))return u;const f=Number(j(String(e.cost??0)));return Number.isFinite(f)?Math.round(f):0}function za(e){return typeof e.expensesTotal=="number"?Number(e.expensesTotal)||0:Array.isArray(e.expenses)?e.expenses.reduce((a,t)=>a+(Number(t.amount)||0),0):0}function Wa(e){const a=new Date,t=e.start?new Date(e.start):null,s=e.end?new Date(e.end):null;return t&&!Number.isNaN(t.getTime())&&t>a?"upcoming":s&&!Number.isNaN(s.getTime())&&s<a?"completed":"ongoing"}function Ja(){if(o.search){let e;o.search.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>{b.filters.search=o.search.value.trim(),L()},180)})}o.payment&&(o.payment.value=b.filters.payment,o.payment.addEventListener("change",()=>{b.filters.payment=o.payment.value||"all",L()})),o.dateRange&&(o.dateRange.addEventListener("change",Ka),o.dateRange.value=b.filters.range),o.startDate&&o.startDate.addEventListener("change",()=>{b.filters.startDate=o.startDate.value,b.filters.range==="custom"&&L()}),o.endDate&&o.endDate.addEventListener("change",()=>{b.filters.endDate=o.endDate.value,b.filters.range==="custom"&&L()}),o.refreshBtn&&o.refreshBtn.addEventListener("click",()=>{if(b.filters.range!=="custom"){L();return}b.filters.startDate=o.startDate?.value||"",b.filters.endDate=o.endDate?.value||"",L()})}function Ka(e){const a=e.target.value;b.filters.range=a,a==="custom"?o.customRangeWrapper?.classList.add("active"):(o.customRangeWrapper?.classList.remove("active"),b.filters.startDate="",b.filters.endDate="",o.startDate&&(o.startDate.value=""),o.endDate&&(o.endDate.value=""),L())}async function $e(){pt();try{await Promise.all([at(),oa()])}catch(e){console.error("❌ [projectsReports] Data mutation refresh failed",e),ye(e)&&console.warn("Projects API error:",e.message)}finally{ft(),L(),mt()}}function Ga(){bt(),L()}function Ya(e){e.key&&!["projects","reservations","customers"].includes(e.key)||$e().catch(a=>{console.error("❌ [projectsReports] Storage sync failed",a)})}function L(){const e=Xa();Ie(),es(e),as(e),ss(e),ns(e),rs(e),os(e)}function Xa(){const{search:e,statuses:a,payment:t,range:s,startDate:n,endDate:i}=b.filters,u=ht(e),f=new Date,l=Number(s);let p=null;if(s==="custom"){p=n?new Date(n):null;const m=i?new Date(i):null;return b.projects.filter(S=>!Je(S,a)||!Ke(S,t)||!Ge(S,u)?!1:Za(S.start,p,m))}return s!=="all"&&Number.isFinite(l)&&(p=new Date,p.setDate(f.getDate()-l)),b.projects.filter(m=>!Je(m,a)||!Ke(m,t)||!Ge(m,u)?!1:s==="all"?!0:Qa(m.start,p,f))}function Je(e,a){return a.includes(e.status)}function Ke(e,a){return a==="all"?!0:e.paymentStatus===a}function Ge(e,a){return a?ht([e.title,e.projectCode,e.clientName,e.clientCompany,e.type,e.description].filter(Boolean).join(" ")).includes(a):!0}function Qa(e,a,t){return!e||!(e instanceof Date)||Number.isNaN(e.getTime())?!1:a?e>=a&&e<=t:!0}function Za(e,a,t){if(!a&&!t)return!0;if(!e||Number.isNaN(e.getTime()))return!1;const s=e.getTime();return!(a&&!Number.isNaN(a.getTime())&&s<a.getTime()||t&&!Number.isNaN(t.getTime())&&s>t.getTime())}function ht(e){return e?j(String(e)).toLowerCase().trim():""}function es(e){if(!o.kpiGrid)return;const a=e.length,t=e.reduce((u,f)=>u+f.overallTotal,0),s=e.reduce((u,f)=>u+f.unpaidValue,0),n=e.reduce((u,f)=>u+f.expensesTotal,0),i=[{icon:me.projects,label:r("projects.reports.kpi.totalProjects","Total projects"),value:Le(a),meta:r("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:me.value,label:r("projects.reports.kpi.totalValue","Total value"),value:fe(t),meta:r("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:me.outstanding,label:r("projects.reports.kpi.unpaidValue","Outstanding value"),value:fe(s),meta:r("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:me.expenses,label:r("projects.reports.kpi.expenses","Total expenses"),value:fe(n),meta:r("projects.reports.kpi.expensesMeta","Expenses for included projects")}];o.kpiGrid.innerHTML=i.map(({icon:u,label:f,value:l,meta:p})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${u}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${P(f)}</p>
        <p class="reports-kpi-value">${P(l)}</p>
        <span class="reports-kpi-meta">${P(p)}</span>
      </div>
    </div>
  `).join("")}function bt(){if(!o.statusChips)return;const e=dt.map(a=>{const t=r(`projects.status.${a}`,a);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${a}">${P(t)}</button>`}).join("");o.statusChips.innerHTML=e,o.statusChips.dataset.listenerAttached||(o.statusChips.addEventListener("click",ts),o.statusChips.dataset.listenerAttached="true"),Ie()}function ts(e){const a=e.target.closest("[data-status]");if(!a)return;const t=a.dataset.status;if(!t)return;const s=new Set(b.filters.statuses);s.has(t)?s.delete(t):s.add(t),s.size===0&&dt.forEach(n=>s.add(n)),b.filters.statuses=Array.from(s),Ie(),L()}function Ie(){if(!o.statusChips)return;const e=new Set(b.filters.statuses);o.statusChips.querySelectorAll("[data-status]").forEach(a=>{a.classList.toggle("is-active",e.has(a.dataset.status))})}function as(e){if(!C)return;const a=document.getElementById("reports-status-chart");if(!a)return;const t=["upcoming","ongoing","completed"],s=t.map(l=>e.filter(p=>p.status===l).length),n=t.map(l=>r(`projects.status.${l}`,l)),u=s.reduce((l,p)=>l+p,0)>0?s:[],f={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:n,series:u,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:l=>Number.isFinite(l)?`${Math.round(l)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:l=>V(l)}},noData:{text:r("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};ge("status",a,f)}function ss(e){if(!C)return;const a=document.getElementById("reports-timeline-chart");if(!a)return;const t=new Map,s=new Intl.DateTimeFormat(cs(),{month:"short",year:"numeric"});e.forEach(m=>{if(!m.start||Number.isNaN(m.start.getTime()))return;const S=`${m.start.getFullYear()}-${m.start.getMonth()+1}`,h=t.get(S)||{total:0,label:s.format(m.start)};h.total+=m.overallTotal,t.set(S,h)});const i=Array.from(t.keys()).sort((m,S)=>{const[h,v]=m.split("-").map(Number),[y,T]=S.split("-").map(Number);return h===y?v-T:h-y}).slice(-12),u=i.map(m=>t.get(m)?.label||m),f=i.map(m=>Math.round(t.get(m)?.total||0)),l=f.length?[{name:r("projects.reports.datasets.value","Total value"),data:f}]:[],p={chart:{type:"area",height:320,toolbar:{show:!1}},series:l,xaxis:{categories:u,labels:{rotate:-35}},yaxis:{labels:{formatter:m=>V(m)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:m=>V(m)}},noData:{text:r("projects.reports.noData","لا توجد بيانات متاحة")}};ge("timeline",a,p)}function ns(e){if(!C)return;const a=document.getElementById("reports-expense-chart");if(!a)return;const t=[...e].sort((p,m)=>m.overallTotal-p.overallTotal).slice(0,6),s=t.map(p=>p.title||p.projectCode),n=t.map(p=>Math.round(p.overallTotal)),i=t.map(p=>Math.round(p.expensesTotal)),u=s.length?[{name:r("projects.reports.datasets.value","Total value"),data:n},{name:r("projects.reports.datasets.expenses","Expenses"),data:i}]:[],l={chart:{type:"bar",height:Math.max(320,s.length*60||0),toolbar:{show:!1}},series:u,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:s,labels:{formatter:p=>V(p)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:p=>V(p)}},noData:{text:r("projects.reports.noData","لا توجد بيانات متاحة")}};ge("expenses",a,l)}function rs(e){if(!C)return;const a=document.getElementById("reports-clients-chart");if(!a)return;const t=new Map;e.forEach(l=>{const p=l.clientName||l.clientCompany||r("projects.fallback.unknownClient","Unknown client"),m=t.get(p)||0;t.set(p,m+l.overallTotal)});const s=Array.from(t.entries()).sort((l,p)=>p[1]-l[1]).slice(0,6),n=s.map(([l])=>l),i=s.map(([,l])=>Math.round(l)),u=i.length?[{name:r("projects.reports.datasets.value","Total value"),data:i}]:[],f={chart:{type:"bar",height:320,toolbar:{show:!1}},series:u,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:n,labels:{rotate:-35}},yaxis:{labels:{formatter:l=>V(l)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:l=>V(l)}},legend:{show:!1},noData:{text:r("projects.reports.noData","لا توجد بيانات متاحة")}};ge("clients",a,f)}function ge(e,a,t={}){if(!C||!a)return;if(pe[e]){try{pe[e].destroy()}catch(n){console.warn(`⚠️ [projectsReports] Failed to destroy ${e} chart`,n)}delete pe[e]}a.innerHTML="";const s={...t};Array.isArray(s.series)||(s.series=[]);try{const n=new C(a,s);pe[e]=n,n.render().catch(i=>{console.error(`❌ [projectsReports] Failed to render ${e} chart`,i)})}catch(n){console.error(`❌ [projectsReports] Failed to render ${e} chart`,n)}}function os(e){if(!o.table||!o.tableBody||!o.tableEmpty)return;if(!e.length){o.table.style.display="none",o.tableEmpty.classList.add("active"),o.tableMeta&&(o.tableMeta.textContent="");return}o.table.style.display="",o.tableEmpty.classList.remove("active");const a=e.map(t=>{const s=is(t.start,t.end),n=r(`projects.status.${t.status}`,t.status),i=r(`projects.paymentStatus.${t.paymentStatus}`,t.paymentStatus),u=t.clientCompany?`${P(t.clientName)} <small class="text-muted">${P(t.clientCompany)}</small>`:P(t.clientName||r("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${P(t.title||t.projectCode)}</span>
            <small class="text-muted">${P(`#${t.projectCode}`)}</small>
          </div>
        </td>
        <td>${u}</td>
        <td>${P(n)}</td>
        <td>${P(s)}</td>
        <td>${P(fe(t.overallTotal))}</td>
        <td>${P(i)}</td>
      </tr>
    `}).join("");if(o.tableBody.innerHTML=a,o.tableMeta){const t=r("projects.reports.table.meta","Showing {count} of {total} projects");o.tableMeta.textContent=t.replace("{count}",Le(e.length)).replace("{total}",Le(b.totalProjects))}}function is(e,a){if(!e&&!a)return"—";const t=e?qe(e.toISOString()):"—",s=a?qe(a.toISOString()):"—";return a?`${t} → ${s}`:t}function fe(e){const a=Number(e)||0,s=he()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",n=new Intl.NumberFormat(s,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(a));return`${j(n)} SR`}function Le(e){const t=he()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return j(new Intl.NumberFormat(t).format(e))}function V(e){const t=he()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return j(new Intl.NumberFormat(t,{notation:"compact",compactDisplay:"short"}).format(e))}function cs(){return he()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function P(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
