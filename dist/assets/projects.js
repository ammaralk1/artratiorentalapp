import{l as ln,n as y,e as pt,t as o,j as Se,r as dn,q as un,p as Te,u as Ct,d as at,y as we,h as w,o as pn,f as mn,a as fn,m as gn,c as hn,i as bn,k as ae}from"./auth.js";/* empty css     */import{i as yn}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{h as Wt,g as Y,a as Kt,u as Jt}from"./reservationsService.js";import{n as ut,B as mt,C as vn,D as Yt,E as ft,r as jn,h as xe,j as Gt,F as Sn,e as Ee,o as Tn,k as wn}from"./controller.js";const c={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},s={};function xn(){c.selectedTechnicians=[],c.selectedEquipment=[],c.expenses=[]}function En(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function $n(){s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.linkedReservationBtn=document.getElementById("project-linked-reservation-btn"),s.submitBtn=s.form?.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function Cn(){const t=En();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([a,r])=>{document.querySelector(a)&&t(a,r)})}function $e(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function An(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>ln()),t.dataset.listenerAttached="true")}const qt="project",Ft="editProject",re=3600*1e3,Tt=.15,Nt=6,Xt="projectsTab",Qt="projectsSubTab",oe={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},Ce={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},In={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function d(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function k(t){const e=Number(t)||0,a=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function X(t){if(!t)return"â€”";const e=new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),l=e.getHours(),u=l>=12?"PM":"AM",p=l%12||12,f=String(p).padStart(2,"0"),g=`${n}/${a}/${r} ${f}:${i} ${u}`;return y(g)}function Dn(t){const e=pt(),n=y(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} Ù…Ø´Ø±ÙˆØ¹`}function ie(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=Dn(t))}function Ln(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?o(e,n):n}function st(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function ce(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=st(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function le(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),i=a.padStart(2,"0"),l=r.padStart(2,"0");return`${t}T${i}:${l}`}function Ae(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}â€¦`}function Pn(t,e){if(!t)return"â€”";const n=X(t);return e?`${n} - ${X(e)}`:n}function de(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function At(t){if(!t)return o("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return o(e,t)}function H(){if(!s.projectsTableBody)return;const t=c.filters.search,e=c.projects.filter(a=>{if(!t)return!0;const r=c.customers.find(l=>String(l.id)===String(a.clientId));return y([a.title,a.description,r?.customerName,a.clientCompany,At(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=c.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",r=c.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",i=d(o(a,r));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,ie(0),c.visibleProjects=[],ue([]);return}const n=[...e].sort((a,r)=>new Date(r.start||0)-new Date(a.start||0));c.visibleProjects=n,ie(n.length),s.projectsTableBody.innerHTML=n.map(a=>kn(a)).join(""),ue(n),tt()}function kn(t){const e=c.customers.find(A=>String(A.id)===String(t.clientId)),n=e?.customerName||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),a=(t.clientCompany||e?.companyName||"").trim(),r=t.technicians?.length||0,i=(t.equipment||[]).reduce((A,I)=>A+(I.qty||0),0),{expensesTotal:l,totalWithTax:u}=vt(t),f=It(t.id).length,b=o("projects.table.reservationsCount","{count} Ø­Ø¬ÙˆØ²Ø§Øª").replace("{count}",y(String(f))),h=f?`<span class="badge rounded-pill project-reservations-chip">${d(b)}</span>`:"",S=`<span class="badge project-type-badge">${d(At(t.type))}</span>`,j=t.projectCode||`PRJ-${y(String(t.id))}`,T=`<span class="project-code-badge">#${d(j)}</span>`,D=Se()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${d(o("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${d(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${T}
            ${S}
          </div>
        </div>
        ${h}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${d(n)}</span><small class="text-muted">${d(a)}</small></div>`:d(n)}
      </td>
      <td>${Zt(t.start,t.end)}</td>
      <td>${y(String(r))}</td>
      <td>${y(String(i))}</td>
      <td>${k(u)}</td>
      <td>${k(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${d(o("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${D}
      </td>
    </tr>
  `}function Zt(t,e){if(!t)return"â€”";const n=X(t);return e?`${n} - ${X(e)}`:n}function ue(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:c.visibleProjects.length?c.visibleProjects:c.projects).map(b=>{if(!b?.start)return null;const h=new Date(b.start);if(Number.isNaN(h.getTime()))return null;let v=b.end?new Date(b.end):new Date(h);return Number.isNaN(v.getTime())&&(v=new Date(h)),v<=h&&(v=new Date(h.getTime()+re)),{project:b,startDate:h,endDate:v}}).filter(Boolean).sort((b,h)=>b.startDate-h.startDate);if(!n.length){const b=d(o("projects.timeline.empty",s.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${b}</div>`;return}const a=n[0].startDate.getTime(),r=Math.max(...n.map(b=>b.endDate.getTime()));let i=r-a;i<=0&&(i=re);const l=Bn(n),u=o("projects.timeline.range","{start} â†’ {end}"),p=o("projects.timeline.conflict","Scheduling conflict"),f=n.map(b=>{const{project:h,startDate:v,endDate:S}=b,j=S.getTime()-v.getTime();let T=(v.getTime()-a)/i*100;T=Math.max(0,Math.min(T,100));let E=j/i*100;E=Math.max(E,2.5),T+E>100&&(E=Math.max(1.5,100-T));const A=`project-timeline__item--${te(h)}`,I=l.has(h.id),F=(h.title||"").trim()||o("projects.fallback.untitled","Untitled project"),Q=Ae(F,26),U=c.customers.find(nt=>String(nt.id)===String(h.clientId)),z=U?.customerName||o("projects.fallback.unknownClient","Unknown client"),P=(h.clientCompany||U?.companyName||"").trim(),L=At(h.type),V=X(v.toISOString()),W=X(S.toISOString()),O=u.replace("{start}",V).replace("{end}",W),$=P?`${z} (${P})`:z,_=`${F} â€¢ ${L} â€¢ ${$} | ${O}`,N=I?`<span class="project-timeline__item-conflict" title="${d(p)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${A}${I?" project-timeline__item--conflict":""}" style="left:${T}%;width:${E}%;" title="${d(_)}">
          <span class="project-timeline__item-label">${d(Q)}</span>
          ${N}
        </div>
      `}).join(""),g=`
    <div class="project-timeline__scale">
      <span>${d(X(new Date(a).toISOString()))}</span>
      <span>${d(X(new Date(r).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${g}
    <div class="project-timeline__track">
      ${f}
    </div>
  `}function Bn(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const r=t[n],i=t[a];r.startDate<i.endDate&&i.startDate<r.endDate&&(e.add(r.project.id),e.add(i.project.id))}return e}function tt(){if(!s.focusCards)return;const t=_n();if(!t.length){const e=d(o("projects.focus.empty",s.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));s.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function _n(){if(!Array.isArray(c.projects)||!c.projects.length)return[];const t=c.projects.filter(pe),e=c.projects.filter(i=>!pe(i)&&Mn(i)),n=[],a=new Set,r=(i,l)=>{!i||a.has(i.id)||n.length>=Nt||(a.add(i.id),n.push(Nn(i,l)))};if(t.sort((i,l)=>st(i)-st(l)).forEach(i=>r(i,"today")),e.sort((i,l)=>st(i)-st(l)).forEach(i=>r(i,"thisWeek")),n.length<Nt){const i=Date.now();[...c.projects].filter(u=>!a.has(u.id)).filter(u=>{const p=st(u);return Number.isFinite(p)&&p>=i}).sort((u,p)=>st(u)-st(p)).forEach(u=>r(u,"upcoming"))}return n.length<Nt&&[...c.projects].filter(l=>!a.has(l.id)).sort((l,u)=>ce(u)-ce(l)).forEach(l=>r(l,"recent")),n}function Nn(t,e){const n=c.customers.find(B=>String(B.id)===String(t.clientId)),a=n?.customerName||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),r=(t.clientCompany||n?.companyName||"").trim(),i=Array.isArray(t.technicians)?t.technicians.length:0,l=It(t.id),u=l.length,p=Ie(t),{subtotal:f,applyTax:g}=vt(t),b=(t.description||"").trim(),h=b?Ae(b,110):o("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),v=At(t.type),S=t.paymentStatus==="paid"?"paid":"unpaid",j=o(`projects.paymentStatus.${S}`,S==="paid"?"Paid":"Unpaid"),T=S==="paid"?"status-paid":"status-unpaid",E=S==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",D=t.confirmed===!0||t.confirmed==="true",A=d(String(t.id)),I=t.projectCode||`PRJ-${y(String(t.id))}`,F=y(I),Q={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},U={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},z=Q[e]||Q.recent,P=o(z,U[e]||U.recent),L=te(t),V=o(`projects.status.${L}`,Ce[L]||L),W=In[L]||"bg-secondary",O=(t.title||"").trim()||o("projects.fallback.untitled","Untitled project"),$=[E];D&&$.push("project-focus-card--confirmed");const _=l.reduce((B,K)=>{const Z=De(K),an=(K.items||[]).reduce((on,cn)=>on+(Number(cn?.qty)||1),0),rn=(K.technicians||[]).length;return{total:B.total+Z,equipment:B.equipment+an,crew:B.crew+rn}},{total:0,equipment:0,crew:0}),N=Number(_.total.toFixed(2)),nt=_.equipment,G=_.crew||i,ot=g?Number(((f+N)*Tt).toFixed(2)):0,dt=Number((f+N+ot).toFixed(2)),gt=`<span class="project-code-badge project-focus-card__code">#${d(F)}</span>`,ht=v?`<span class="badge project-focus-card__badge bg-primary">${d(v)}</span>`:"",C=P?`<span class="project-focus-card__meta-tag">${d(P)}</span>`:"",M=`<span class="project-focus-card__status-chip ${W}">${d(V)}</span>`,bt=`<span class="reservation-chip ${T} project-focus-card__payment-chip">${d(j)}</span>`,_t=(B,K,Z)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${B?`<span class="project-focus-card__row-icon">${d(B)}</span>`:""}
        ${d(K)}
      </span>
      <span class="project-focus-card__row-value">${d(String(Z))}</span>
    </div>
  `,Qe=[{icon:"ğŸ‘¤",label:o("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:a},r?{icon:"ğŸ¢",label:o("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:r}:null,{icon:"ğŸ·ï¸",label:o("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:v},{icon:"ğŸ“…",label:o("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Zt(t.start,t.end)}].filter(Boolean).map(({icon:B,label:K,value:Z})=>_t(B,K,Z)).join(""),Ze=[{icon:"ğŸ’³",label:o("projectCards.stats.paymentStatus","Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),value:j},{icon:"ğŸ’¸",label:o("projectCards.stats.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"),value:k(p)},{icon:"ğŸ§®",label:o("projectCards.stats.totalWithTax","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),value:k(dt)}].map(({icon:B,label:K,value:Z})=>_t(B,K,Z)).join(""),tn=[{icon:"ğŸ”—",label:o("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:y(String(u))},{icon:"ğŸ“¦",label:o("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:y(String(nt))},{icon:"ğŸ˜",label:o("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:y(String(G))},{icon:"ğŸ’µ",label:o("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:k(N)}].map(({icon:B,label:K,value:Z})=>_t(B,K,Z)).join(""),en=D?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${d(o("projects.focus.confirmed","âœ… Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒØ¯"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${A}">${d(o("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`,nn=o("projects.focus.actions.highlight","ğŸ” Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),sn=o("projects.focus.actions.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„");return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${$.filter(Boolean).join(" ")}" data-project-id="${A}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${gt}
          ${ht}
          ${C}
          ${M}
          ${bt}
        </div>
        <h6 class="project-focus-card__title">${d(O)}</h6>
        <p class="project-focus-card__description">${d(h)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(o("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${Qe}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(o("projects.focus.summary.payment","Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${Ze}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(o("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${tn}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions">
          ${en}
          <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${A}">${d(nn)}</button>
          <button class="btn btn-sm btn-primary" data-action="view" data-id="${A}">${d(sn)}</button>
        </div>
      </article>
    </div>
  `}function pe(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function Mn(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const r=a.getDay(),i=r===0?6:r-1;a.setDate(a.getDate()-i);const l=new Date(a);return l.setDate(l.getDate()+7),e>=a&&e<l}function te(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function Ie(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function vt(t){const e=Number(t?.equipmentEstimate)||0,n=Ie(t),a=e+n,r=Number(a.toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true";let l=i?Number(t?.taxAmount):0;i?(!Number.isFinite(l)||l<0)&&(l=Number((r*Tt).toFixed(2))):l=0;let u=i?Number(t?.totalWithTax):r;return i?(!Number.isFinite(u)||u<=0)&&(u=Number((r+l).toFixed(2))):u=r,{equipmentEstimate:e,expensesTotal:n,subtotal:r,applyTax:i,taxAmount:l,totalWithTax:u}}function et(){const t=c.projects.length,e=c.projects.filter(r=>{const i=r.start?new Date(r.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=c.projects.reduce((r,i)=>r+vt(i).expensesTotal,0),a=c.projects.reduce((r,i)=>r+vt(i).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=y(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=y(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=k(n)),s.projectsBudget&&(s.projectsBudget.textContent=k(a))}function It(t){return t?c.reservations.filter(e=>String(e.projectId)===String(t)):[]}function De(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Wt(e,a,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Rn(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,r=t.status||t.state||"pending",i=o(`reservations.status.${r}`,r),l=String(r).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[l]||"project-reservation-card__badge--info",f=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",g=f?o("reservations.details.paid","Ù…Ø¯ÙÙˆØ¹"):o("reservations.details.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),b=f?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",h=t.completed===!0||t.completed==="true",v=o("reservations.details.completed","Ù…ÙƒØªÙ…Ù„"),S=h?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${d(v)}</span>`:"",j=Zt(t.start,t.end),T=De(t),E=k(T),D=o("projects.details.reservations.items","{count} Ø¹Ù†Ø§ØµØ±").replace("{count}",y(String((t.items||[]).length))),A=o("projects.details.reservations.crew","{count} Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù…").replace("{count}",y(String((t.technicians||[]).length))),I=o("projects.details.reservations.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${d(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${d(i)}</span>
          <span class="project-reservation-card__badge ${b}">${d(g)}</span>
          ${S}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${d(j)}</div>
        <div class="project-reservation-card__meta">
          <span>ğŸ’µ ${d(E)}</span>
          <span>ğŸ“¦ ${d(D)}</span>
          <span>ğŸ˜ ${d(A)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${d(I)}</button>
      </div>
    </article>
  `}function qn(t){const e=It(t.id).map(j=>({reservation:j,index:c.reservations.findIndex(T=>T===j)})).filter(({index:j})=>Number.isInteger(j)&&j>=0).sort((j,T)=>{const E=j.reservation.start?new Date(j.reservation.start).getTime():0;return(T.reservation.start?new Date(T.reservation.start).getTime():0)-E}),n=o("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),a=o("projects.details.reservations.create","â• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ù…Ø±ØªØ¨Ø·"),r=o("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),i=o("projects.details.reservations.count","{count} Ø­Ø¬ÙˆØ²Ø§Øª"),l=e.length?`<span class="badge project-reservations-count">${d(i.replace("{count}",y(String(e.length))))}</span>`:"",u=e.length>0,p=d(String(t.id)),f=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&f.push("disabled",'aria-disabled="true"');const g=`<button ${f.join(" ")}>${d(a)}</button>`,b=o("projects.details.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),h=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${d(b)}</button>`,v=`<div class="d-flex flex-wrap gap-2">${g}${h}</div>`,S=e.length?`<div class="project-reservations-list">${e.map(({reservation:j,index:T})=>Rn(j,T,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${d(r)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${d(n)}</h6>
          ${l}
        </div>
        ${v}
      </div>
      ${S}
    </section>
  `}let me=null;function Fn(t){t&&Le()!==t&&Ct({[Xt]:t}).catch(e=>{console.warn("âš ï¸ [projects] Failed to persist projects main tab preference",e)})}function Le(){return Te()?.[Xt]||""}function Pe(t){t&&Ot()!==t&&Ct({[Qt]:t}).catch(e=>{console.warn("âš ï¸ [projects] Failed to persist projects sub-tab preference",e)})}function Ot(){return Te()?.[Qt]||""}function On(t){if(!t)return"";const e=t.trim();return e?Object.values(oe).includes(e)?e:oe[e]||"":""}function Hn(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=On(e);if(n)return n}}catch{}return""}function ke(t,e){!t||!s.tabPanes||!s.tabButtons||(s.tabButtons.forEach(n=>{const a=n===e;n.classList.toggle("active",a),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",a)}),s.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&Fn(t))}function Un(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const r=n.dataset.tabTarget;r&&(ke(r,n),r==="projects-section"&&(c.filters.search="",s.search&&(s.search.value=""),H(),tt(),et()))}),n.dataset.tabListenerAttached="true")});const t=Le(),e=t&&s.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function ee(t,e){!t||!s.projectSubTabButtons||!s.projectSubTabPanes||(s.projectSubTabButtons.forEach(n=>{const a=n===e;n.classList.toggle("active",a),n.classList.contains("tab")&&n.classList.toggle("tab-active",a)}),s.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function zn(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||(s.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(ee(n,t),Pe(n))}),t.dataset.tabListenerAttached="true")}),Vn())}function Vn(){const e=Hn()||Ot();if(!e)return;const n=s.projectSubTabButtons?.[0],a=s.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===e)||n,r=a?.dataset.projectSubtabTarget;r&&(e!==Ot()&&Pe(r),ee(r,a))}function Wn(){return s.tabButtons?s.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function fe(t={}){if(t){if(s.tabButtons&&s.tabButtons.length){const n=s.tabButtons.find(r=>r.classList.contains("active"))?.dataset.tabTarget||"",a=t[Xt];if(a&&a!==n){const r=s.tabButtons.find(i=>i.dataset.tabTarget===a);r&&ke(a,r)}}if(s.projectSubTabButtons&&s.projectSubTabButtons.length&&Wn()){const n=s.projectSubTabButtons.find(r=>r.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=t[Qt];if(a&&a!==n){const r=s.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===a);r&&ee(a,r)}}}}function Kn(){me||(me=dn(t=>{fe(t)})),un().then(t=>{fe(t)}).catch(t=>{console.warn("âš ï¸ [projects] Failed to synchronise project preferences",t)})}function Jn(){if(!Array.isArray(c.projects)||c.projects.length===0)return;let t=!1;const e=c.projects.map(n=>{if(n.projectCode)return n;const a=we();return t=!0,{...n,projectCode:a}});t&&(c.projects=e)}function Yn(){const{customers:t,technicians:e,equipment:n}=at();c.customers=Array.isArray(t)?t:[],c.technicians=Array.isArray(e)?e:[],c.equipment=Array.isArray(n)?n:[],c.reservations=Y(),c.projects=mt(),Jn()}function Dt(){if(Be(),s.technicianSelect){const t=s.technicianSelect.value,e=d(o("projects.form.selectTechnician","Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+c.technicians.map(n=>{const a=o("projects.fallback.technicianName","Ø¹Ø¶Ùˆ {id}"),r=n.name||a.replace("{id}",y(String(n.id||"")));return`<option value="${n.id}">${d(r)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=d(o("projects.form.selectEquipment","Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø¯Ø©"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+c.equipment.map(n=>{const a=n.desc||n.description||n.name||o("projects.fallback.unknownEquipment","Ù…Ø¹Ø¯Ø©");return`<option value="${d(n.barcode||"")}">${d(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function it(t){if(!s.clientCompany)return;const e=t?.companyName||t?.company||"";s.clientCompany.value=e}function Be(){if(!s.client)return;Gn();const t=s.client.dataset?.customerId;if(t){const e=c.customers.find(n=>String(n.id)===String(t));e?it(e):(s.client.dataset.customerId="",it(null))}else it(null);document.activeElement===s.client&&Ht()}function Gn(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",Ht(),it(null)}),s.client.addEventListener("focus",()=>{Ht()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>jt(),150)}),s.client.dataset.autocompleteAttached="true")}function jt(){s.clientSuggestions&&(s.clientSuggestions.classList.remove("is-visible"),s.clientSuggestions.hidden=!0,s.clientSuggestions.innerHTML="")}function Ht(){if(!s.client||!s.clientSuggestions)return;if(!Array.isArray(c.customers)||c.customers.length===0){const a=at();Array.isArray(a?.customers)&&a.customers.length&&(c.customers=a.customers)}const t=Xn(),e=ut(s.client.value||""),n=e?t.filter(a=>{const r=ut(a.name).includes(e),i=ut(a.company||"").includes(e);return r||i}).slice(0,10):t.slice(0,10);if(!n.length){jt();return}s.clientSuggestions.innerHTML=n.map(a=>{const r=a.company?`<div class="suggestion-item__meta">${d(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${d(String(a.id))}" data-name="${d(a.name)}" data-company="${d(a.company||"")}">
          <div class="suggestion-item__primary">${d(a.name)}</div>
          ${r}
        </div>
      `}).join(""),s.clientSuggestions.hidden=!1,s.clientSuggestions.classList.add("is-visible"),s.clientSuggestions.scrollTop=0,s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",r=>{r.preventDefault();const{id:i,name:l}=r.currentTarget.dataset;s.client&&(s.client.value=l||"",s.client.dataset.customerId=i||"");const u=r.currentTarget.dataset.company||"";it({companyName:u}),jt()})})}function Xn(){return Array.isArray(c.customers)?c.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function Qn(t,e=""){if(!Array.isArray(c.customers)||c.customers.length===0)return null;if(e){const r=c.customers.find(i=>String(i.id)===String(e));if(r)return r}const n=ut(t||"");if(!n)return null;const a=c.customers.find(r=>ut(r.customerName||r.name||"")===n);return a||c.customers.find(r=>ut(r.customerName||r.name||"").includes(n))||null}async function Zn(t){if(c.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(o("projects.confirm.delete","Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ")))try{await vn(t),await Yt(),await Kt(),c.projects=mt(),c.reservations=Y(),H(),et(),tt(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),w(o("projects.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}catch(n){console.error("âŒ [projects] removeProject failed",n);const a=ft(n)?n.message:o("projects.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");w(a,"error")}}async function ts(t,e){if(!t)return!1;const a=Y().filter(u=>String(u.projectId)===String(t));if(!a.length)return!1;const r=e==="paid",i=r?"paid":"unpaid";let l=!1;for(const u of a){const p=u.id??u.reservationId;if(!p)continue;const f=u.paid===!0||u.paid==="paid",g=u.paidStatus||u.paymentStatus||(f?"paid":"unpaid");f===r&&g===i||(await Jt(p,{paid_status:i,paid:r}),l=!0)}return l&&(c.reservations=Y()),l}async function es(t){if(!t)return!1;const e=Y(),n=c.projects.find(i=>String(i.id)===String(t))||(at().projects||[]).find?.(i=>String(i.id)===String(t))||null,a=e.filter(i=>String(i.projectId)===String(t));if(!a.length)return!1;let r=!1;for(const i of a){const l=i.id??i.reservationId;if(!l)continue;const u=jn({...i,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await Jt(l,{confirmed:!0,status:p}),r=!0}return r&&(c.reservations=Y()),r}async function Ut(t,e){if(!t)return!1;const n=await ts(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let Mt=!1;const Lt="projects:create:draft",ns="projects.html#projects-section";function ss(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",ys),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),jt(),$e(),s.type&&(s.type.value=""),it(null),Fe(),_e()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{c.filters.search=y(s.search.value||"").trim().toLowerCase(),H()}),s.search.dataset.listenerAttached="true")}function _e(){xn(),c.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),rt(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),Pt(),St()}function as(){s.addTechnicianBtn&&s.addTechnicianBtn.dataset.listenerAttached!=="true"&&(s.addTechnicianBtn.addEventListener("click",us),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&s.addEquipmentBtn.dataset.listenerAttached!=="true"&&(s.addEquipmentBtn.addEventListener("click",ps),s.addEquipmentBtn.dataset.listenerAttached="true")}function rs(){Rt(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;c.selectedTechnicians=c.selectedTechnicians.filter(n=>n!==e),Ne()}}),Rt(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;c.selectedEquipment=c.selectedEquipment.filter(n=>n.barcode!==e),Me()}}),Rt(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;c.expenses=c.expenses.filter(n=>String(n.id)!==String(e)),Re(),et()}})}function os(){s.addExpenseBtn&&s.addExpenseBtn.dataset.listenerAttached!=="true"&&(s.addExpenseBtn.addEventListener("click",ms),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&s.expenseAmount.dataset.normalizeAttached!=="true"&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=y(e.value||"");if(e.value=a,n!=null){const r=Math.min(a.length,n);e.setSelectionRange(r,r)}}),s.expenseAmount.dataset.normalizeAttached="true")}function Rt(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function is({onViewDetails:t}){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached==="true"||(s.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;t?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!Se()){pn();return}const a=n.dataset.id;Zn(a)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function cs(){const{customers:t}=at();c.customers=Array.isArray(t)?t:[],rt(),H(),tt()}function ls(){const{technicians:t}=at();c.technicians=Array.isArray(t)?t:[],rt(),H(),tt()}function ds(t){const{reservations:e}=at();c.reservations=Array.isArray(e)?e:[],H();const n=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),a=s.detailsBody?.dataset.projectId;n&&a&&c.projects.find(i=>String(i.id)===String(a))&&t?.(a)}function us(){const t=s.technicianSelect?.value;if(!t){w(o("projects.toast.selectTechnician","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}if(c.selectedTechnicians.includes(t)){w(o("projects.toast.technicianAlreadyAdded","âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„"));return}c.selectedTechnicians.push(t),rt(),w(o("projects.toast.technicianAdded","âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))}function ps(){const t=s.equipmentSelect?.value;if(!t){w(o("projects.toast.selectEquipment","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø©"));return}const e=Math.max(1,parseInt(s.equipmentQty?.value||"1",10)||1),n=c.selectedEquipment.find(a=>a.barcode===t);n?n.qty+=e:c.selectedEquipment.push({barcode:t,qty:e}),rt(),w(o("projects.toast.equipmentAdded","âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹"))}function ms(){const t=(s.expenseLabel?.value||"").trim(),e=y(s.expenseAmount?.value||"0"),n=Number(e);if(!t){w(o("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"));return}if(!Number.isFinite(n)||n<0){w(o("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­"));return}c.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=y(String(e))),rt(),et()}function rt(){Ne(),Me(),Re(),Pt()}function Ne(){s.technicianList&&ne(s.technicianList,c.selectedTechnicians,t=>{const n=c.technicians.find(a=>String(a.id)===String(t))?.name||o("projects.fallback.technicianName","Ø¹Ø¶Ùˆ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return`
      <span class="chip">
        ${d(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${d(String(t))}" aria-label="${d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"))}">âœ–</button>
      </span>
    `})}function Me(){s.equipmentList&&ne(s.equipmentList,c.selectedEquipment,t=>{const e=c.equipment.find(r=>String(r.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||o("projects.fallback.unknownEquipment","Ù…Ø¹Ø¯Ø©"),a=y(String(t.qty||1));return`
      <span class="chip">
        ${d(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${d(String(t.barcode))}" aria-label="${d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"))}">âœ–</button>
      </span>
    `})}function Re(){s.expenseList&&ne(s.expenseList,c.expenses,t=>`
      <div class="expense-item">
        <span>${d(t.label)}</span>
        <span>${k(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${d(String(t.id))}" aria-label="${d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"))}">âœ–</button>
      </div>
    `)}function ne(t,e,n){if(t){if(!e||e.length===0){const a=d(Ln(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function Pt(){if(!s.submitBtn)return;const t=!!c.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹":"ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹";s.submitBtn.textContent=o(e,n)}function fs(){return c.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function ge(t){return y(String(t||"")).trim().toLowerCase()}function gs(){if(!Array.isArray(c.selectedEquipment)||c.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((c.equipment||[]).map(a=>[ge(a?.barcode),a])),e=[],n=[];return c.selectedEquipment.forEach(a=>{const r=ge(a?.barcode);if(!r){e.push(a?.barcode||"");return}const i=t.get(r);if(!i||i.id==null){e.push(a?.barcode||r);return}const l=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:i.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:n,missing:e}}function hs(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,a=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function bs(){return c.selectedEquipment.reduce((t,e)=>{const n=c.equipment.find(r=>String(r.barcode||"")===String(e.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+a*(e.qty||1)},0)}async function ys(t){if(t.preventDefault(),Mt)return;const e=s.title?.value.trim(),n=s.type?.value||"",a=s.client?.value?.trim()||"",r=s.client?.dataset?.customerId||"",i=s.startDate?.value?.trim()||"",l=s.startTime?.value?.trim()||"";if(!e||!n||!i){w(o("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"));return}const u=Qn(a,r);if(!u){w(o("projects.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„")),s.client?.focus();return}const p=String(u.id);s.client&&(s.client.dataset.customerId=p,s.client.value=u.customerName||u.name||s.client.value),it(u);const f=s.endDate?.value?.trim()||"",g=s.endTime?.value?.trim()||"",b=$t(i,l),h=f?$t(f,g):"",v=new Date(b),S=h?new Date(h):null;if(S&&v>S){w(o("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"));return}s.expenseAmount&&(s.expenseAmount.value=y(s.expenseAmount.value||""));const j=fs(),T=bs(),E=s.taxCheckbox?.checked===!0,A=(s.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",I=T+j,F=E?Number((I*Tt).toFixed(2)):0,Q=Number((I+F).toFixed(2)),{items:U,missing:z}=gs();if(z.length){w(o("projects.toast.equipmentMissing","âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),"error");return}const P=!!c.editingProjectId,L=P?c.projects.find($=>String($.id)===String(c.editingProjectId)):null;if(P&&!L){w(o("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const V=u.companyName||u.company||"",W=s.description?.value.trim()||"",O=xe({projectCode:L?.projectCode||(P?null:we()),title:e,type:n,clientId:p,clientCompany:V,description:W,start:b,end:h||null,applyTax:E,paymentStatus:A,equipmentEstimate:T,expenses:c.expenses.map($=>({id:$.id,label:$.label,amount:$.amount})),taxAmount:F,totalWithTax:Q,confirmed:L?.confirmed??!1,technicians:c.selectedTechnicians,equipment:U});Mt=!0;try{let $=L?.projectId??L?.id??null;if(P){const N=await Gt($??c.editingProjectId,O);$=N?.projectId??N?.id??$,await Ut($,A),w(o("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­"))}else{const N=await Sn(O);$=N?.projectId??N?.id??null,await Ut($,A),w(o("projects.toast.saved","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­"))}await xs($)||Fe(),c.editingProjectId=null,s.form.reset(),_e(),$e(),jt(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),c.projects=mt(),c.reservations=Y(),H(),et(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch($){console.error("âŒ [projects] handleSubmitProject failed",$);const _=ft($)?$.message:o("projects.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");w(_,"error")}finally{Mt=!1}}function $t(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),i=a.padStart(2,"0"),l=r.padStart(2,"0");return`${t}T${i}:${l}`}function kt(){if(typeof window>"u"||!window.sessionStorage)return null;const t=window.sessionStorage.getItem(Lt);if(!t)return null;try{const e=JSON.parse(t);return e&&typeof e=="object"?e:null}catch(e){return console.warn("âš ï¸ [projects] Failed to parse project form draft",e),null}}function qe(t){if(!(typeof window>"u"||!window.sessionStorage))try{window.sessionStorage.setItem(Lt,JSON.stringify(t))}catch(e){console.warn("âš ï¸ [projects] Unable to persist project form draft",e)}}function Fe(){typeof window>"u"||!window.sessionStorage||(window.sessionStorage.removeItem(Lt),St())}function vs(){const t=kt()||{};return{...t,type:s.type?.value||"",title:s.title?.value||"",client:s.client?.value||"",customerId:s.client?.dataset.customerId||"",clientCompany:s.clientCompany?.value||"",paymentStatus:s.paymentStatus?.value||"unpaid",taxChecked:s.taxCheckbox?.checked===!0,startDate:s.startDate?.value||"",startTime:s.startTime?.value||"",endDate:s.endDate?.value||"",endTime:s.endTime?.value||"",description:s.description?.value||"",expenses:Array.isArray(c.expenses)?c.expenses.map(e=>({...e})):[],technicians:Array.isArray(c.selectedTechnicians)?[...c.selectedTechnicians]:[],equipment:Array.isArray(c.selectedEquipment)?c.selectedEquipment.map(e=>({...e})):[],linkedReservationIds:Array.isArray(t.linkedReservationIds)?[...t.linkedReservationIds]:[],savedAt:Date.now()}}function js(){const t=kt();return t?(s.type&&(s.type.value=t.type||""),s.title&&(s.title.value=t.title||""),s.client&&(s.client.value=t.client||"",s.client.dataset.customerId=t.customerId||""),s.clientCompany&&(s.clientCompany.value=t.clientCompany||""),s.paymentStatus&&t.paymentStatus&&(s.paymentStatus.value=t.paymentStatus),s.taxCheckbox&&(s.taxCheckbox.checked=t.taxChecked===!0),s.startDate&&(s.startDate.value=t.startDate||""),s.startTime&&(s.startTime.value=t.startTime||""),s.endDate&&(s.endDate.value=t.endDate||""),s.endTime&&(s.endTime.value=t.endTime||""),s.description&&(s.description.value=t.description||""),c.expenses=Array.isArray(t.expenses)?t.expenses.map(e=>({...e})):[],c.selectedTechnicians=Array.isArray(t.technicians)?[...t.technicians]:[],c.selectedEquipment=Array.isArray(t.equipment)?t.equipment.map(e=>({...e})):[],St(),!0):(St(),!1)}function Ss(){!s.linkedReservationBtn||s.linkedReservationBtn.dataset.listenerAttached==="true"||(s.linkedReservationBtn.addEventListener("click",Ts),s.linkedReservationBtn.dataset.listenerAttached="true")}function Ts(t){t.preventDefault();const e=vs();if(!(e.customerId&&e.customerId!==""||e.client&&e.client.trim())){w(o("projects.form.linkedReservation.missingClient","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));return}const a=e.startDate&&e.startTime,r=e.endDate&&e.endTime;if(!a||!r){w(o("projects.form.linkedReservation.missingSchedule","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));return}qe(e);const i=ws(e);let l="";try{l=encodeURIComponent(JSON.stringify(i))}catch(p){console.warn("âš ï¸ [projects] Unable to encode reservation context",p)}Ct({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(p=>{console.warn("âš ï¸ [projects] Failed to persist dashboard preference before redirect",p)});const u=l?`?reservationProjectContext=${l}`:"";window.location.href=`dashboard.html${u}#reservations`}function ws(t){const e=$t(t.startDate,t.startTime)||null,n=$t(t.endDate,t.endTime)||null;return{fromProjectForm:!0,draftStorageKey:Lt,returnUrl:ns,start:e,end:n,customerId:t.customerId||null,customerName:t.client||"",clientCompany:t.clientCompany||"",projectTitle:t.title||"",projectType:t.type||"",description:t.description||""}}async function xs(t){if(!t)return;const e=kt(),n=Array.isArray(e?.linkedReservationIds)?e.linkedReservationIds:[];if(!n.length)return;const a=[];let r=!1;for(const l of n){const u=l!=null?String(l):"";if(u)try{await Jt(u,{project_id:t}),r=!0}catch(p){console.error("âŒ [projects] Failed to link reservation to project",u,p),a.push(u)}}if(r)try{await Kt(),c.reservations=Y(),document.dispatchEvent(new CustomEvent("reservations:changed"))}catch(l){console.warn("âš ï¸ [projects] Failed to refresh reservations after linking",l)}const i={linkedReservationIds:a,savedAt:Date.now()};return qe(i),a.length&&w(o("projects.toast.linkReservationFailed","âš ï¸ ØªØ¹Ø°Ø± Ø±Ø¨Ø· Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠÙ‹Ø§"),"error"),St(),a.length}function Es(){const t=new Map,e=a=>{if(!a)return;[a.id,a.reservationId,a.reservation_id,a.reservation_code].map(i=>i!=null?String(i):"").filter(Boolean).forEach(i=>{t.has(i)||t.set(i,a)})};Array.isArray(c.reservations)&&c.reservations.forEach(e);const n=at();return Array.isArray(n?.reservations)&&n.reservations.forEach(e),t}function St(){const t=document.getElementById("project-linked-reservation-summary");if(!t)return;const e=kt(),n=s.linkedReservationBtn,a=Array.isArray(e?.linkedReservationIds)?Array.from(new Set(e.linkedReservationIds.map(l=>String(l)).filter(Boolean))):[];if(!a.length){t.dataset.state="empty",t.innerHTML=`<p class="project-linked-reservation__summary-empty">${d(o("projects.form.linkedReservation.empty","Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ø¯."))}</p>`,n&&(n.disabled=!1,n.classList.remove("btn-disabled"),n.removeAttribute("aria-disabled"),n.title="");return}const r=Es(),i=a.map(l=>{const u=r.get(l);if(!u)return`
        <li class="project-linked-reservation__summary-item">
          <div class="project-linked-reservation__summary-item-title">#${d(y(l))}</div>
          <div class="project-linked-reservation__summary-item-meta">
            <span>${d(o("projects.form.linkedReservation.pendingItem","ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ ÙˆØ³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."))}</span>
          </div>
        </li>`;const p=u.reservation_code||u.reservationId||u.id||l,f=`#${y(String(p))}`,g=u.customerName||u.customer_name||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),b=u.start_datetime||u.start||"",h=u.end_datetime||u.end||"",v=b?X(b):"",S=h?X(h):"",j=u.status?`reservations.status.${u.status}`:null,T=j?o(j,u.status):"",E=[];if(v||S){const D=S?`${v} â†’ ${S}`:v;E.push(D)}return g&&E.push(g),T&&E.push(T),`
      <li class="project-linked-reservation__summary-item">
        <div class="project-linked-reservation__summary-item-title">${d(f)}</div>
        <div class="project-linked-reservation__summary-item-meta">
          ${E.map(D=>`<span>${d(D)}</span>`).join("")}
        </div>
      </li>`}).join("");t.dataset.state="has-linked",t.innerHTML=`<ul class="project-linked-reservation__summary-list">${i}</ul>`,n&&(n.disabled=!0,n.classList.add("btn-disabled"),n.setAttribute("aria-disabled","true"),n.title=o("projects.form.linkedReservation.buttonDisabled","ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ù…Ø±ØªØ¨Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."))}function ct(t){const e=c.projects.find(C=>String(C.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view",s.detailsBody.dataset.projectId=String(e.id);const n=c.customers.find(C=>String(C.id)===String(e.clientId)),a=Ue(e.type),i=e.description?.trim()||o("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),l=n?.customerName||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${y(String(e.id))}`,f=y(p),g=It(e.id),b=g.reduce((C,M)=>C+Bs(M),0),h=Number(b.toFixed(2)),v=g.length,{subtotal:S,applyTax:j,expensesTotal:T}=vt(e),E=S,D=j?Number(((E+h)*Tt).toFixed(2)):0,A=Number((E+h+D).toFixed(2)),I=te(e),F=o(`projects.status.${I}`,Ce[I]||I),U={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[I]||"status-confirmed",z=j?o("projects.details.chips.vatOn","Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15Ùª"):o("projects.details.chips.vatOff","ØºÙŠØ± Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),P=j?"status-paid":"status-unpaid",L=o("projects.details.chips.reservations","{count} Ø­Ø¬ÙˆØ²Ø§Øª").replace("{count}",y(String(v))),V=e.paymentStatus==="paid"?"paid":"unpaid",W=o(`projects.paymentStatus.${V}`,V==="paid"?"Paid":"Unpaid"),O=V==="paid"?"status-paid":"status-unpaid",$=o("projects.focus.confirmed","âœ… Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒØ¯"),_=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${d($)}</span>`:"",nt=[{icon:"ğŸ’³",label:o("projects.details.summary.paymentStatus","Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),value:W},{icon:"ğŸ’¼",label:o("projects.details.summary.projectSubtotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:k(E)},{icon:"ğŸ”—",label:o("projects.details.summary.reservationsTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª / Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"),value:k(h)},{icon:"ğŸ§®",label:o("projects.details.summary.combinedTax","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (15Ùª)"),value:k(D)},{icon:"ğŸ’°",label:o("projects.details.summary.overallTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"),value:k(A)}].map(({icon:C,label:M,value:bt})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${C} ${d(M)}</span>
      <span class="summary-details-value">${d(bt)}</span>
    </div>
  `).join(""),G=[];G.push({icon:"ğŸ†”",label:o("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`#${f}`}),G.push({icon:"ğŸ‘¤",label:o("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:l}),u&&G.push({icon:"ğŸ¢",label:o("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:u}),G.push({icon:"ğŸ·ï¸",label:o("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:a}),G.push({icon:"ğŸ“…",label:o("projects.details.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Pn(e.start,e.end)});const ot=G.map(({icon:C,label:M,value:bt})=>`
    <div class="project-info-row">
      <span>${C} ${d(M)}</span>
      <span>${d(bt)}</span>
    </div>
  `).join(""),dt=[`<span class="reservation-chip ${U}">${d(F)}</span>`,`<span class="reservation-chip ${P}">${d(z)}</span>`,`<span class="reservation-chip status-info">${d(L)}</span>`,`<span class="reservation-chip ${O}">${d(W)}</span>`,_].filter(Boolean).join(""),gt=o("projects.details.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"),ht=o("projects.details.reservationsTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª");s.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${d(e.title)}</h4>
          <div class="project-details-chips">${dt}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${d(o("projects.details.actions.viewReservations","ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${ot}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${d(o("projects.details.summary.title","Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ"))}</h6>
            ${nt}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${d(o("projects.details.description","ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h5>
      <p class="project-details-description">${d(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${d(o("projects.details.financialBreakdown","ØªÙØ§ØµÙŠÙ„ Ù…Ø§Ù„ÙŠØ©"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${d(gt)}</span>
          <strong>${k(T)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${d(ht)}</span>
          <strong>${k(h)}</strong>
        </div>
      </div>
    </section>
    ${qn(e)}
  `,As(e),s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function $s({onOpenProject:t}){!s.focusCards||s.focusCards.dataset.listenerAttached==="true"||(s.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:r,id:i}=n.dataset;if(r==="confirm-project"){e.preventDefault(),e.stopPropagation(),Ls(i);return}r==="view"?t?.(i):r==="highlight"&&Cs(i);return}const a=e.target.closest(".project-focus-card");a?.dataset.projectId&&t?.(a.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function Cs(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){w(o("projects.focus.toastNotFound","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function As(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]'),n=s.detailsBody.querySelector('[data-action="edit-project"]'),a=s.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",r=>{r.preventDefault(),Ds(t)}),n&&t&&n.addEventListener("click",r=>{r.preventDefault(),Oe(t)}),a&&a.addEventListener("click",r=>{const i=r.target.closest('[data-action="view-reservation"]');if(!i)return;const l=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(l)||l<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(l):window.location.href="dashboard.html#reservations")})}function Oe(t){if(!t||!s.detailsBody)return;const e=c.projects.find(i=>String(i.id)===String(t.id));if(!e)return;const n=c.customers.find(i=>String(i.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const r={expenses:Array.isArray(e.expenses)?e.expenses.map((i,l)=>({id:i?.id||`expense-${e.id}-${l}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=Ps(e,r),Is(e,r)}function Is(t,e={expenses:[]}){const n=s.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",v=>{v.preventDefault(),ct(t.id)});const r=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),l=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),f=n.querySelector('[name="project-start-time"]'),g=n.querySelector('[name="project-end-date"]'),b=n.querySelector('[name="project-end-time"]');function h(){u&&(u.innerHTML=He(e.expenses))}h(),l&&l.addEventListener("click",v=>{v.preventDefault();const S=r?.value.trim()||"",j=y(i?.value||"0"),T=Number(j);if(!S){w(o("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),r?.focus();return}if(!Number.isFinite(T)||T<=0){w(o("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),i?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:S,amount:T}),r&&(r.value=""),i&&(i.value=""),h()}),u&&u.addEventListener("click",v=>{const S=v.target.closest('[data-action="remove-expense"]');if(!S)return;const{id:j}=S.dataset;e.expenses=e.expenses.filter(T=>String(T.id)!==String(j)),h()}),n.addEventListener("submit",async v=>{if(v.preventDefault(),n.dataset.submitting==="true")return;const S=n.querySelector('[name="project-title"]'),j=n.querySelector('[name="project-type"]'),T=n.querySelector('[name="project-description"]'),E=n.querySelector('[name="project-payment-status"]'),D=n.querySelector('[name="project-apply-tax"]'),A=S?.value.trim()||"",I=j?.value||"",F=p?.value.trim()||"",Q=f?.value.trim()||"",U=T?.value.trim()||"",z=E?.value==="paid"?"paid":"unpaid",P=D?.checked===!0;if(!A||!I||!F){w(o("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")),S?.focus();return}const L=g?.value.trim()||"",V=b?.value.trim()||"",W=le(F,Q),O=L?le(L,V):"",$=new Date(W),_=O?new Date(O):null;if(_&&$>_){w(o("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©")),g?.focus();return}if(c.projects.findIndex(C=>String(C.id)===String(t.id))===-1){w(o("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const nt=Number(t.equipmentEstimate)||0,G=e.expenses.reduce((C,M)=>C+(Number(M.amount)||0),0),ot=nt+G,dt=P?Number((ot*Tt).toFixed(2)):0,gt=P?Number((ot+dt).toFixed(2)):ot,ht=xe({projectCode:t.projectCode,title:A,type:I,clientId:t.clientId,clientCompany:t.clientCompany,description:U,start:W,end:O||null,applyTax:P,paymentStatus:z,equipmentEstimate:nt,expenses:e.expenses,taxAmount:dt,totalWithTax:gt,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:hs(t)});n.dataset.submitting="true";try{const C=await Gt(t.projectId??t.id,ht),M=C?.projectId??C?.id??t.id;await Ut(M,z),c.projects=mt(),c.reservations=Y(),w(o("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),H(),tt(),et(),ct(t.id)}catch(C){console.error("âŒ [projects] Failed to update project from details view",C);const M=ft(C)?C.message:o("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");w(M,"error")}finally{delete n.dataset.submitting}})}function Ds(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};Ct({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(r=>{console.warn("âš ï¸ [projects] Failed to persist dashboard tab preference",r)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(r){console.warn("âš ï¸ [projects] Unable to encode reservation context",r)}s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function Ls(t){if(!t)return;const e=c.projects.find(n=>String(n.id)===String(t));if(!e){w(o("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}if(e.confirmed===!0||e.confirmed==="true"){w(o("projects.toast.alreadyConfirmed","â„¹ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒÙ‘Ø¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§"));return}try{await Gt(e.projectId??e.id,{confirmed:!0});const n=await es(t);c.projects=mt(),c.reservations=Y(),H(),tt(),et(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&s.detailsBody?.dataset.projectId===String(t)&&ct(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),w(o("projects.toast.confirmed","âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}catch(n){console.error("âŒ [projects] confirmProject failed",n);const a=ft(n)?n.message:o("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");w(a,"error")}}function Ps(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=de(t.start||""),{date:r,time:i}=de(t.end||""),l=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.title","Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</label>
          <input type="text" class="form-control" name="project-title" value="${d(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</label>
          <select class="form-select" name="project-type" required>
            ${ks(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.startDate","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${d(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.startTime","ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${d(a)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.endDate","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${d(r)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.endTime","ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${d(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${d(o("projects.form.labels.description","Ø§Ù„ÙˆØµÙ"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${d(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.paymentStatus","Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${d(o("projects.paymentStatus.unpaid","Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${d(o("projects.paymentStatus.paid","Ù…Ø¯ÙÙˆØ¹"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${l?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${d(o("projects.form.labels.applyTax","ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15Ùª"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${d(o("projects.form.labels.expenses","Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${d(o("projects.form.placeholders.expenseLabel","ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${d(o("projects.form.placeholders.expenseAmount","Ø§Ù„Ù…Ø¨Ù„Øº"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${d(o("projects.form.buttons.addExpense","Ø¥Ø¶Ø§ÙØ©"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${He(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${d(o("projects.form.buttons.update","ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${d(o("actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}</button>
      </div>
    </form>
  `}function ks(t){return["commercial","coverage","photography","social"].map(n=>{const a=Ue(n),r=n===t?"selected":"";return`<option value="${d(n)}" ${r}>${d(a)}</option>`}).join("")}function He(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${d(o("projects.selected.emptyExpenses","Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…ØµØ±ÙˆÙ"))}</div>`;const e=d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"));return t.map(n=>{const a=d(n?.label||""),r=d(k(n?.amount||0)),i=d(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${r}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">âœ–</button>
        </div>
      `}).join("")}function Ue(t){if(!t)return o("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return o(e,t)}function Bs(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Wt(e,a,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function ze(t){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(t);if(a)return a}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const a=new URLSearchParams(e).get(t);if(a)return a}catch{}return null}function _s(){return ze(qt)}function Ns(){return ze(Ft)}function Ms(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[qt,Ft].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let a=e,r=!1;if(e)try{const p=new URLSearchParams(e);let f=!1;[qt,Ft].forEach(g=>{p.has(g)&&(p.delete(g),f=!0)}),f&&(a=p.toString(),r=!0)}catch{}if(!n&&!r)return;const i=window.location.pathname,l=t.toString(),u=`${i}${l?`?${l}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",u)}catch{}}function Rs(){const t=_s(),e=Ns();t&&(c.pendingProjectDetailId=t),e&&(c.pendingProjectEditId=e,c.pendingProjectDetailId||(c.pendingProjectDetailId=e)),(t||e)&&Ms()}function qs(){if(!c.pendingProjectDetailId)return;const t=c.pendingProjectDetailId,e=String(t),n=c.projects.find(r=>[r?.id,r?.projectId,r?.project_id].some(l=>l!=null&&String(l)===e));if(!n)return;c.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??e;if(ct(a),c.pendingProjectEditId!=null){const r=String(c.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(l=>l!=null&&String(l)===r)&&(c.pendingProjectEditId=null,setTimeout(()=>Oe(n),0))}}function Fs(){document.addEventListener("DOMContentLoaded",()=>{Kn(),Rs(),$n(),Pt(),Cn(),Un(),zn(),An(),ss(),as(),rs(),os(),Ss(),is({onViewDetails:ct}),$s({onOpenProject:ct}),Be(),Os()}),document.addEventListener("language:changed",he),document.addEventListener("language:translationsReady",he),document.addEventListener("customers:changed",Hs),document.addEventListener("technicians:updated",Us),document.addEventListener("reservations:changed",()=>ds(ct)),document.addEventListener(mn.USER_UPDATED,()=>{H()})}async function Os(){try{await Ee({suppressError:!0}),await Yt()}catch(t){console.error("âŒ [projects] Failed to initialise projects data",t);const e=t?.message||o("projects.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§");w(e,"error")}finally{Yn(),Dt(),js(),rt(),H(),et(),tt(),qs()}}function he(){Dt(),rt(),H(),et(),tt(),Pt()}function Hs(){cs(),Dt()}function Us(){ls(),Dt()}fn();gn();hn();Tn();Fs();document.addEventListener("DOMContentLoaded",()=>{yn(),bn()});const be=.15,wt={},zs="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let yt=0;const x={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},m={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},xt=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let q=null;const Ve=["upcoming","ongoing","completed"];async function Vs({forceProjects:t=!1}={}){try{await Ee({suppressError:!0}),await wn({force:t})}catch(e){console.error("âŒ [projectsReports] Failed to load initial data",e),ft(e)&&console.warn("Projects API error:",e.message)}Ye()}async function Ws(){Ys(),Ke(),await Ks();try{await Vs({forceProjects:!0}),Xe(),ea(),J()}finally{Je()}document.addEventListener("language:changed",sa),document.addEventListener("projects:changed",()=>{zt().catch(t=>{console.error("âŒ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{zt().catch(t=>{console.error("âŒ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",aa)}document.addEventListener("DOMContentLoaded",Ws);async function Ks(){if(q)return q;if(typeof window>"u")return null;if(window.ApexCharts)return q=window.ApexCharts,q;try{await Js(zs),q=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),q=null}return q}function Js(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const a=document.querySelector(`script[src="${t}"]`);if(a){if(a.dataset.loaded==="true"){e();return}a.addEventListener("load",e,{once:!0}),a.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const r=document.createElement("script");r.src=t,r.async=!0,r.dataset.loaded="false",r.onload=()=>{r.dataset.loaded="true",e()},r.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(r)})}function Ys(){m.search=document.getElementById("reports-search"),m.statusChips=document.getElementById("reports-status-chips"),m.payment=document.getElementById("reports-payment"),m.dateRange=document.getElementById("reports-date-range"),m.customRangeWrapper=document.getElementById("reports-custom-range"),m.startDate=document.getElementById("reports-start-date"),m.endDate=document.getElementById("reports-end-date"),m.refreshBtn=document.getElementById("reports-refresh"),m.kpiGrid=document.getElementById("reports-kpi-grid"),m.table=document.getElementById("reports-table"),m.tableBody=m.table?.querySelector("tbody"),m.tableMeta=document.getElementById("reports-table-meta"),m.tableEmpty=document.getElementById("reports-empty"),m.chartCards={},m.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;m.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(m.chartLoaders[e]=n)})}function We(t){const e=!!t;Object.entries(m.chartCards||{}).forEach(([n,a])=>{if(!a)return;a.classList.toggle("is-loading",e),a.setAttribute("aria-busy",e?"true":"false");const r=m.chartLoaders?.[n];r&&(r.hidden=!e)})}function Ke(){yt+=1,yt===1&&We(!0)}function Je(){yt=Math.max(0,yt-1),yt===0&&We(!1)}function Ye(){const{customers:t=[]}=at();x.customers=Array.isArray(t)?t:[],x.reservations=Y();const e=new Map(x.customers.map(a=>[String(a.id),a])),n=mt();x.projects=Array.isArray(n)?n.map(a=>Gs(a,e)):[],x.totalProjects=x.projects.length}function Gs(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",a=e.get(String(t.clientId)),r=Xs(t.id),i=r.reduce((T,E)=>T+Qs(E),0),l=Zs(t),u=Number(t?.equipmentEstimate)||0,p=Number((u+l).toFixed(2)),f=t?.applyTax===!0||t?.applyTax==="true",g=f?Number((p*be).toFixed(2)):0,b=f?Number(((p+i)*be).toFixed(2)):0,h=Number((p+i+b).toFixed(2)),v=ta(t),S=t.start?new Date(t.start):null,j=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:a?.customerName||a?.name||"",clientCompany:t.clientCompany||a?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:S,end:j,applyTax:f,status:v,reservationsTotal:Number(i.toFixed(2)),expensesTotal:l,subtotal:p,taxAmount:g,combinedTaxAmount:b,overallTotal:h,unpaidValue:n==="paid"?0:h,reservationsCount:r.length}}function Xs(t){return Array.isArray(x.reservations)?x.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Qs(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Wt(e,a,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Zs(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function ta(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function ea(){if(m.search){let t;m.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{x.filters.search=m.search.value.trim(),J()},180)})}m.payment&&(m.payment.value=x.filters.payment,m.payment.addEventListener("change",()=>{x.filters.payment=m.payment.value||"all",J()})),m.dateRange&&(m.dateRange.addEventListener("change",na),m.dateRange.value=x.filters.range),m.startDate&&m.startDate.addEventListener("change",()=>{x.filters.startDate=m.startDate.value,x.filters.range==="custom"&&J()}),m.endDate&&m.endDate.addEventListener("change",()=>{x.filters.endDate=m.endDate.value,x.filters.range==="custom"&&J()}),m.refreshBtn&&m.refreshBtn.addEventListener("click",()=>{if(x.filters.range!=="custom"){J();return}x.filters.startDate=m.startDate?.value||"",x.filters.endDate=m.endDate?.value||"",J()})}function na(t){const e=t.target.value;x.filters.range=e,e==="custom"?m.customRangeWrapper?.classList.add("active"):(m.customRangeWrapper?.classList.remove("active"),x.filters.startDate="",x.filters.endDate="",m.startDate&&(m.startDate.value=""),m.endDate&&(m.endDate.value=""),J())}async function zt(){Ke();try{await Promise.all([Yt(),Kt()])}catch(t){console.error("âŒ [projectsReports] Data mutation refresh failed",t),ft(t)&&console.warn("Projects API error:",t.message)}finally{Ye(),J(),Je()}}function sa(){Xe(),J()}function aa(t){t.key&&!["projects","reservations","customers"].includes(t.key)||zt().catch(e=>{console.error("âŒ [projectsReports] Storage sync failed",e)})}function J(){const t=ra();se(),ca(t),da(t),ua(t),pa(t),ma(t),fa(t)}function ra(){const{search:t,statuses:e,payment:n,range:a,startDate:r,endDate:i}=x.filters,l=Ge(t),u=new Date,p=Number(a);let f=null;if(a==="custom"){f=r?new Date(r):null;const g=i?new Date(i):null;return x.projects.filter(b=>!ye(b,e)||!ve(b,n)||!je(b,l)?!1:ia(b.start,f,g))}return a!=="all"&&Number.isFinite(p)&&(f=new Date,f.setDate(u.getDate()-p)),x.projects.filter(g=>!ye(g,e)||!ve(g,n)||!je(g,l)?!1:a==="all"?!0:oa(g.start,f,u))}function ye(t,e){return e.includes(t.status)}function ve(t,e){return e==="all"?!0:t.paymentStatus===e}function je(t,e){return e?Ge([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function oa(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function ia(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const a=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&a<e.getTime()||n&&!Number.isNaN(n.getTime())&&a>n.getTime())}function Ge(t){return t?y(String(t)).toLowerCase().trim():""}function ca(t){if(!m.kpiGrid)return;const e=t.length,n=t.reduce((l,u)=>l+u.overallTotal,0),a=t.reduce((l,u)=>l+u.unpaidValue,0),r=t.reduce((l,u)=>l+u.expensesTotal,0),i=[{icon:xt.projects,label:o("projects.reports.kpi.totalProjects","Total projects"),value:Vt(e),meta:o("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:xt.value,label:o("projects.reports.kpi.totalValue","Total value"),value:Et(n),meta:o("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:xt.outstanding,label:o("projects.reports.kpi.unpaidValue","Outstanding value"),value:Et(a),meta:o("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:xt.expenses,label:o("projects.reports.kpi.expenses","Total expenses"),value:Et(r),meta:o("projects.reports.kpi.expensesMeta","Expenses for included projects")}];m.kpiGrid.innerHTML=i.map(({icon:l,label:u,value:p,meta:f})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${l}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${R(u)}</p>
        <p class="reports-kpi-value">${R(p)}</p>
        <span class="reports-kpi-meta">${R(f)}</span>
      </div>
    </div>
  `).join("")}function Xe(){if(!m.statusChips)return;const t=Ve.map(e=>{const n=o(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${R(n)}</button>`}).join("");m.statusChips.innerHTML=t,m.statusChips.dataset.listenerAttached||(m.statusChips.addEventListener("click",la),m.statusChips.dataset.listenerAttached="true"),se()}function la(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const a=new Set(x.filters.statuses);a.has(n)?a.delete(n):a.add(n),a.size===0&&Ve.forEach(r=>a.add(r)),x.filters.statuses=Array.from(a),se(),J()}function se(){if(!m.statusChips)return;const t=new Set(x.filters.statuses);m.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function da(t){if(!q)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],a=n.map(p=>t.filter(f=>f.status===p).length),r=n.map(p=>o(`projects.status.${p}`,p)),l=a.reduce((p,f)=>p+f,0)>0?a:[],u={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:r,series:l,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:p=>Number.isFinite(p)?`${Math.round(p)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:p=>lt(p)}},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};Bt("status",e,u)}function ua(t){if(!q)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,a=new Intl.DateTimeFormat(ha(),{month:"short",year:"numeric"});t.forEach(g=>{if(!g.start||Number.isNaN(g.start.getTime()))return;const b=`${g.start.getFullYear()}-${g.start.getMonth()+1}`,h=n.get(b)||{total:0,label:a.format(g.start)};h.total+=g.overallTotal,n.set(b,h)});const i=Array.from(n.keys()).sort((g,b)=>{const[h,v]=g.split("-").map(Number),[S,j]=b.split("-").map(Number);return h===S?v-j:h-S}).slice(-12),l=i.map(g=>n.get(g)?.label||g),u=i.map(g=>Math.round(n.get(g)?.total||0)),p=u.length?[{name:o("projects.reports.datasets.value","Total value"),data:u}]:[],f={chart:{type:"area",height:320,toolbar:{show:!1}},series:p,xaxis:{categories:l,labels:{rotate:-35}},yaxis:{labels:{formatter:g=>lt(g)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:g=>lt(g)}},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")}};Bt("timeline",e,f)}function pa(t){if(!q)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((f,g)=>g.overallTotal-f.overallTotal).slice(0,6),a=n.map(f=>f.title||f.projectCode),r=n.map(f=>Math.round(f.overallTotal)),i=n.map(f=>Math.round(f.expensesTotal)),l=a.length?[{name:o("projects.reports.datasets.value","Total value"),data:r},{name:o("projects.reports.datasets.expenses","Expenses"),data:i}]:[],p={chart:{type:"bar",height:Math.max(320,a.length*60||0),toolbar:{show:!1}},series:l,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:a,labels:{formatter:f=>lt(f)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:f=>lt(f)}},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")}};Bt("expenses",e,p)}function ma(t){if(!q)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(p=>{const f=p.clientName||p.clientCompany||o("projects.fallback.unknownClient","Unknown client"),g=n.get(f)||0;n.set(f,g+p.overallTotal)});const a=Array.from(n.entries()).sort((p,f)=>f[1]-p[1]).slice(0,6),r=a.map(([p])=>p),i=a.map(([,p])=>Math.round(p)),l=i.length?[{name:o("projects.reports.datasets.value","Total value"),data:i}]:[],u={chart:{type:"bar",height:320,toolbar:{show:!1}},series:l,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:r,labels:{rotate:-35}},yaxis:{labels:{formatter:p=>lt(p)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:p=>lt(p)}},legend:{show:!1},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")}};Bt("clients",e,u)}function Bt(t,e,n={}){if(!q||!e)return;if(wt[t]){try{wt[t].destroy()}catch(r){console.warn(`âš ï¸ [projectsReports] Failed to destroy ${t} chart`,r)}delete wt[t]}e.innerHTML="";const a={...n};Array.isArray(a.series)||(a.series=[]);try{const r=new q(e,a);wt[t]=r,r.render().catch(i=>{console.error(`âŒ [projectsReports] Failed to render ${t} chart`,i)})}catch(r){console.error(`âŒ [projectsReports] Failed to render ${t} chart`,r)}}function fa(t){if(!m.table||!m.tableBody||!m.tableEmpty)return;if(!t.length){m.table.style.display="none",m.tableEmpty.classList.add("active"),m.tableMeta&&(m.tableMeta.textContent="");return}m.table.style.display="",m.tableEmpty.classList.remove("active");const e=t.map(n=>{const a=ga(n.start,n.end),r=o(`projects.status.${n.status}`,n.status),i=o(`projects.paymentStatus.${n.paymentStatus}`,n.paymentStatus),l=n.clientCompany?`${R(n.clientName)} <small class="text-muted">${R(n.clientCompany)}</small>`:R(n.clientName||o("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${R(n.title||n.projectCode)}</span>
            <small class="text-muted">${R(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${l}</td>
        <td>${R(r)}</td>
        <td>${R(a)}</td>
        <td>${R(Et(n.overallTotal))}</td>
        <td>${R(i)}</td>
      </tr>
    `}).join("");if(m.tableBody.innerHTML=e,m.tableMeta){const n=o("projects.reports.table.meta","Showing {count} of {total} projects");m.tableMeta.textContent=n.replace("{count}",Vt(t.length)).replace("{total}",Vt(x.totalProjects))}}function ga(t,e){if(!t&&!e)return"â€”";const n=t?ae(t.toISOString()):"â€”",a=e?ae(e.toISOString()):"â€”";return e?`${n} â†’ ${a}`:n}function Et(t){const e=Number(t)||0,a=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function Vt(t){const n=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n).format(t))}function lt(t){const n=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function ha(){return pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function R(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
