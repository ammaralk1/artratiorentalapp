import{l as an,n as j,e as dt,t as i,j as he,r as rn,q as on,p as ye,u as Ft,d as ut,y as ve,h as x,o as cn,f as ln,a as dn,m as un,c as pn,i as mn,k as Xt}from"./auth.js";/* empty css     */import{i as fn}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{h as Ot,g as J,a as je,u as Se}from"./reservationsService.js";import{n as lt,B as pt,C as gn,D as Ht,E as mt,r as bn,h as Te,j as Ut,F as hn,e as xe,o as yn,k as vn}from"./controller.js";const d={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},s={};function jn(){d.selectedTechnicians=[],d.selectedEquipment=[],d.expenses=[]}function Sn(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Tn(){s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.submitBtn=s.form?.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function xn(){const t=Sn();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([a,r])=>{document.querySelector(a)&&t(a,r)})}function we(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function wn(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>an()),t.dataset.listenerAttached="true")}const Bt="project",Nt="editProject",Zt=3600*1e3,jt=.15,Lt=6,Vt="projectsTab",zt="projectsSubTab",te={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},$e={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},$n={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function l(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(t){const e=Number(t)||0,a=dt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${j(r)} SR`}function nt(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getFullYear()),o=String(e.getMinutes()).padStart(2,"0"),c=e.getHours(),u=c>=12?"PM":"AM",p=c%12||12,b=String(p).padStart(2,"0"),f=`${n}/${a}/${r} ${b}:${o} ${u}`;return j(f)}function En(t){const e=dt(),n=j(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function ee(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=En(t))}function Cn(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?i(e,n):n}function et(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function ne(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=et(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function se(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),o=a.padStart(2,"0"),c=r.padStart(2,"0");return`${t}T${o}:${c}`}function Ee(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}…`}function Pn(t,e){if(!t)return"—";const n=nt(t);return e?`${n} - ${nt(e)}`:n}function ae(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function wt(t){if(!t)return i("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return i(e,t)}function F(){if(!s.projectsTableBody)return;const t=d.filters.search,e=d.projects.filter(a=>{if(!t)return!0;const r=d.customers.find(c=>String(c.id)===String(a.clientId));return j([a.title,a.description,r?.customerName,a.clientCompany,wt(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=d.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",r=d.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",o=l(i(a,r));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${o}</td></tr>`,ee(0),d.visibleProjects=[],re([]);return}const n=[...e].sort((a,r)=>new Date(r.start||0)-new Date(a.start||0));d.visibleProjects=n,ee(n.length),s.projectsTableBody.innerHTML=n.map(a=>An(a)).join(""),re(n),X()}function An(t){const e=d.customers.find(P=>String(P.id)===String(t.clientId)),n=e?.customerName||i("projects.fallback.unknownClient","عميل غير معروف"),a=(t.clientCompany||e?.companyName||"").trim(),r=t.technicians?.length||0,o=(t.equipment||[]).reduce((P,A)=>P+(A.qty||0),0),{expensesTotal:c,totalWithTax:u}=yt(t),b=$t(t.id).length,h=i("projects.table.reservationsCount","{count} حجوزات").replace("{count}",j(String(b))),g=b?`<span class="badge rounded-pill project-reservations-chip">${l(h)}</span>`:"",S=`<span class="badge project-type-badge">${l(wt(t.type))}</span>`,v=t.projectCode||`PRJ-${j(String(t.id))}`,T=`<span class="project-code-badge">#${l(v)}</span>`,N=he()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${l(i("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${l(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${T}
            ${S}
          </div>
        </div>
        ${g}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${l(n)}</span><small class="text-muted">${l(a)}</small></div>`:l(n)}
      </td>
      <td>${Wt(t.start,t.end)}</td>
      <td>${j(String(r))}</td>
      <td>${j(String(o))}</td>
      <td>${B(u)}</td>
      <td>${B(c)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${l(i("actions.view","عرض"))}</button>
        ${N}
      </td>
    </tr>
  `}function Wt(t,e){if(!t)return"—";const n=nt(t);return e?`${n} - ${nt(e)}`:n}function re(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:d.visibleProjects.length?d.visibleProjects:d.projects).map(h=>{if(!h?.start)return null;const g=new Date(h.start);if(Number.isNaN(g.getTime()))return null;let y=h.end?new Date(h.end):new Date(g);return Number.isNaN(y.getTime())&&(y=new Date(g)),y<=g&&(y=new Date(g.getTime()+Zt)),{project:h,startDate:g,endDate:y}}).filter(Boolean).sort((h,g)=>h.startDate-g.startDate);if(!n.length){const h=l(i("projects.timeline.empty",s.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${h}</div>`;return}const a=n[0].startDate.getTime(),r=Math.max(...n.map(h=>h.endDate.getTime()));let o=r-a;o<=0&&(o=Zt);const c=Ln(n),u=i("projects.timeline.range","{start} → {end}"),p=i("projects.timeline.conflict","Scheduling conflict"),b=n.map(h=>{const{project:g,startDate:y,endDate:S}=h,v=S.getTime()-y.getTime();let T=(y.getTime()-a)/o*100;T=Math.max(0,Math.min(T,100));let E=v/o*100;E=Math.max(E,2.5),T+E>100&&(E=Math.max(1.5,100-T));const P=`project-timeline__item--${Kt(g)}`,A=c.has(g.id),q=(g.title||"").trim()||i("projects.fallback.untitled","Untitled project"),G=Ee(q,26),O=d.customers.find(tt=>String(tt.id)===String(g.clientId)),H=O?.customerName||i("projects.fallback.unknownClient","Unknown client"),D=(g.clientCompany||O?.companyName||"").trim(),I=wt(g.type),U=nt(y.toISOString()),V=nt(S.toISOString()),R=u.replace("{start}",U).replace("{end}",V),$=D?`${H} (${D})`:H,L=`${q} • ${I} • ${$} | ${R}`,at=A?`<span class="project-timeline__item-conflict" title="${l(p)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${P}${A?" project-timeline__item--conflict":""}" style="left:${T}%;width:${E}%;" title="${l(L)}">
          <span class="project-timeline__item-label">${l(G)}</span>
          ${at}
        </div>
      `}).join(""),f=`
    <div class="project-timeline__scale">
      <span>${l(nt(new Date(a).toISOString()))}</span>
      <span>${l(nt(new Date(r).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${f}
    <div class="project-timeline__track">
      ${b}
    </div>
  `}function Ln(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const r=t[n],o=t[a];r.startDate<o.endDate&&o.startDate<r.endDate&&(e.add(r.project.id),e.add(o.project.id))}return e}function X(){if(!s.focusCards)return;const t=In();if(!t.length){const e=l(i("projects.focus.empty",s.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));s.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function In(){if(!Array.isArray(d.projects)||!d.projects.length)return[];const t=d.projects.filter(oe),e=d.projects.filter(o=>!oe(o)&&Bn(o)),n=[],a=new Set,r=(o,c)=>{!o||a.has(o.id)||n.length>=Lt||(a.add(o.id),n.push(Dn(o,c)))};if(t.sort((o,c)=>et(o)-et(c)).forEach(o=>r(o,"today")),e.sort((o,c)=>et(o)-et(c)).forEach(o=>r(o,"thisWeek")),n.length<Lt){const o=Date.now();[...d.projects].filter(u=>!a.has(u.id)).filter(u=>{const p=et(u);return Number.isFinite(p)&&p>=o}).sort((u,p)=>et(u)-et(p)).forEach(u=>r(u,"upcoming"))}return n.length<Lt&&[...d.projects].filter(c=>!a.has(c.id)).sort((c,u)=>ne(u)-ne(c)).forEach(c=>r(c,"recent")),n}function Dn(t,e){const n=d.customers.find(k=>String(k.id)===String(t.clientId)),a=n?.customerName||i("projects.fallback.unknownClient","عميل غير معروف"),r=(t.clientCompany||n?.companyName||"").trim(),o=Array.isArray(t.technicians)?t.technicians.length:0,c=$t(t.id),u=c.length,p=Ce(t),{subtotal:b,applyTax:f}=yt(t),h=(t.description||"").trim(),g=h?Ee(h,110):i("projects.fallback.noDescription","لا يوجد وصف"),y=wt(t.type),S=t.paymentStatus==="paid"?"paid":"unpaid",v=i(`projects.paymentStatus.${S}`,S==="paid"?"Paid":"Unpaid"),T=S==="paid"?"status-paid":"status-unpaid",E=S==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",N=t.confirmed===!0||t.confirmed==="true",P=l(String(t.id)),A=t.projectCode||`PRJ-${j(String(t.id))}`,q=j(A),G={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},O={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},H=G[e]||G.recent,D=i(H,O[e]||O.recent),I=Kt(t),U=i(`projects.status.${I}`,$e[I]||I),V=$n[I]||"bg-secondary",R=(t.title||"").trim()||i("projects.fallback.untitled","Untitled project"),$=[E];N&&$.push("project-focus-card--confirmed");const L=c.reduce((k,z)=>{const Q=Pe(z),tn=(z.items||[]).reduce((nn,sn)=>nn+(Number(sn?.qty)||1),0),en=(z.technicians||[]).length;return{total:k.total+Q,equipment:k.equipment+tn,crew:k.crew+en}},{total:0,equipment:0,crew:0}),at=Number(L.total.toFixed(2)),tt=L.equipment,Y=L.crew||o,rt=f?Number(((b+at)*jt).toFixed(2)):0,ct=Number((b+at+rt).toFixed(2)),ft=`<span class="project-code-badge project-focus-card__code">#${l(q)}</span>`,gt=y?`<span class="badge project-focus-card__badge bg-primary">${l(y)}</span>`:"",C=D?`<span class="project-focus-card__meta-tag">${l(D)}</span>`:"",_=`<span class="project-focus-card__status-chip ${V}">${l(U)}</span>`,bt=`<span class="reservation-chip ${T} project-focus-card__payment-chip">${l(v)}</span>`,At=(k,z,Q)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${k?`<span class="project-focus-card__row-icon">${l(k)}</span>`:""}
        ${l(z)}
      </span>
      <span class="project-focus-card__row-value">${l(String(Q))}</span>
    </div>
  `,Ye=[{icon:"👤",label:i("projects.details.client","العميل"),value:a},r?{icon:"🏢",label:i("projects.details.company","شركة العميل"),value:r}:null,{icon:"🏷️",label:i("projects.details.type","نوع المشروع"),value:y},{icon:"📅",label:i("projects.focus.summary.range","الفترة الزمنية"),value:Wt(t.start,t.end)}].filter(Boolean).map(({icon:k,label:z,value:Q})=>At(k,z,Q)).join(""),Je=[{icon:"💳",label:i("projectCards.stats.paymentStatus","حالة الدفع"),value:v},{icon:"💸",label:i("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:B(p)},{icon:"🧮",label:i("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:B(ct)}].map(({icon:k,label:z,value:Q})=>At(k,z,Q)).join(""),Ge=[{icon:"🔗",label:i("projectCards.stats.reservationsShort","الحجوزات"),value:j(String(u))},{icon:"📦",label:i("projectCards.stats.equipmentCount","عدد المعدات"),value:j(String(tt))},{icon:"😎",label:i("projectCards.stats.crewCount","عدد الطاقم"),value:j(String(Y))},{icon:"💵",label:i("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:B(at)}].map(({icon:k,label:z,value:Q})=>At(k,z,Q)).join(""),Qe=N?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${l(i("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${P}">${l(i("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`,Xe=i("projects.focus.actions.highlight","🔍 عرض في القائمة"),Ze=i("projects.focus.actions.view","👁️ عرض التفاصيل");return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${$.filter(Boolean).join(" ")}" data-project-id="${P}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${ft}
          ${gt}
          ${C}
          ${_}
          ${bt}
        </div>
        <h6 class="project-focus-card__title">${l(R)}</h6>
        <p class="project-focus-card__description">${l(g)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${l(i("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${Ye}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${l(i("projects.focus.summary.payment","الجانب المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${Je}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${l(i("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${Ge}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions">
          ${Qe}
          <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${P}">${l(Xe)}</button>
          <button class="btn btn-sm btn-primary" data-action="view" data-id="${P}">${l(Ze)}</button>
        </div>
      </article>
    </div>
  `}function oe(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function Bn(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const r=a.getDay(),o=r===0?6:r-1;a.setDate(a.getDate()-o);const c=new Date(a);return c.setDate(c.getDate()+7),e>=a&&e<c}function Kt(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function Ce(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function yt(t){const e=Number(t?.equipmentEstimate)||0,n=Ce(t),a=e+n,r=Number(a.toFixed(2)),o=t?.applyTax===!0||t?.applyTax==="true";let c=o?Number(t?.taxAmount):0;o?(!Number.isFinite(c)||c<0)&&(c=Number((r*jt).toFixed(2))):c=0;let u=o?Number(t?.totalWithTax):r;return o?(!Number.isFinite(u)||u<=0)&&(u=Number((r+c).toFixed(2))):u=r,{equipmentEstimate:e,expensesTotal:n,subtotal:r,applyTax:o,taxAmount:c,totalWithTax:u}}function Z(){const t=d.projects.length,e=d.projects.filter(r=>{const o=r.start?new Date(r.start):null;return!o||Number.isNaN(o.getTime())?!1:o>new Date}).length,n=d.projects.reduce((r,o)=>r+yt(o).expensesTotal,0),a=d.projects.reduce((r,o)=>r+yt(o).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=j(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=j(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=B(n)),s.projectsBudget&&(s.projectsBudget.textContent=B(a))}function $t(t){return t?d.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Pe(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(j(String(n)))||0,r=t.discountType||"percent",o=Array.isArray(t.technicians)?t.technicians:[],c=Ot(e,a,r,!1,o,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(j(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Nn(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,r=t.status||t.state||"pending",o=i(`reservations.status.${r}`,r),c=String(r).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[c]||"project-reservation-card__badge--info",b=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",f=b?i("reservations.details.paid","مدفوع"):i("reservations.details.unpaid","غير مدفوع"),h=b?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",g=t.completed===!0||t.completed==="true",y=i("reservations.details.completed","مكتمل"),S=g?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${l(y)}</span>`:"",v=Wt(t.start,t.end),T=Pe(t),E=B(T),N=i("projects.details.reservations.items","{count} عناصر").replace("{count}",j(String((t.items||[]).length))),P=i("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",j(String((t.technicians||[]).length))),A=i("projects.details.reservations.view","👁️ عرض الحجز");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${l(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${l(o)}</span>
          <span class="project-reservation-card__badge ${h}">${l(f)}</span>
          ${S}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${l(v)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${l(E)}</span>
          <span>📦 ${l(N)}</span>
          <span>😎 ${l(P)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${l(A)}</button>
      </div>
    </article>
  `}function kn(t){const e=$t(t.id).map(v=>({reservation:v,index:d.reservations.findIndex(T=>T===v)})).filter(({index:v})=>Number.isInteger(v)&&v>=0).sort((v,T)=>{const E=v.reservation.start?new Date(v.reservation.start).getTime():0;return(T.reservation.start?new Date(T.reservation.start).getTime():0)-E}),n=i("projects.details.reservations.title","الحجوزات المرتبطة"),a=i("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),r=i("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),o=i("projects.details.reservations.count","{count} حجوزات"),c=e.length?`<span class="badge project-reservations-count">${l(o.replace("{count}",j(String(e.length))))}</span>`:"",u=e.length>0,p=l(String(t.id)),b=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&b.push("disabled",'aria-disabled="true"');const f=`<button ${b.join(" ")}>${l(a)}</button>`,h=i("projects.details.actions.edit","✏️ تعديل المشروع"),g=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${l(h)}</button>`,y=`<div class="d-flex flex-wrap gap-2">${f}${g}</div>`,S=e.length?`<div class="project-reservations-list">${e.map(({reservation:v,index:T})=>Nn(v,T,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${l(r)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${l(n)}</h6>
          ${c}
        </div>
        ${y}
      </div>
      ${S}
    </section>
  `}let ie=null;function _n(t){t&&Ae()!==t&&Ft({[Vt]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function Ae(){return ye()?.[Vt]||""}function Le(t){t&&kt()!==t&&Ft({[zt]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function kt(){return ye()?.[zt]||""}function Mn(t){if(!t)return"";const e=t.trim();return e?Object.values(te).includes(e)?e:te[e]||"":""}function qn(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=Mn(e);if(n)return n}}catch{}return""}function Ie(t,e){!t||!s.tabPanes||!s.tabButtons||(s.tabButtons.forEach(n=>{const a=n===e;n.classList.toggle("active",a),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",a)}),s.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&_n(t))}function Rn(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const r=n.dataset.tabTarget;r&&(Ie(r,n),r==="projects-section"&&(d.filters.search="",s.search&&(s.search.value=""),F(),X(),Z()))}),n.dataset.tabListenerAttached="true")});const t=Ae(),e=t&&s.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function Yt(t,e){!t||!s.projectSubTabButtons||!s.projectSubTabPanes||(s.projectSubTabButtons.forEach(n=>{const a=n===e;n.classList.toggle("active",a),n.classList.contains("tab")&&n.classList.toggle("tab-active",a)}),s.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function Fn(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||(s.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(Yt(n,t),Le(n))}),t.dataset.tabListenerAttached="true")}),On())}function On(){const e=qn()||kt();if(!e)return;const n=s.projectSubTabButtons?.[0],a=s.projectSubTabButtons?.find(o=>o.dataset.projectSubtabTarget===e)||n,r=a?.dataset.projectSubtabTarget;r&&(e!==kt()&&Le(r),Yt(r,a))}function Hn(){return s.tabButtons?s.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function ce(t={}){if(t){if(s.tabButtons&&s.tabButtons.length){const n=s.tabButtons.find(r=>r.classList.contains("active"))?.dataset.tabTarget||"",a=t[Vt];if(a&&a!==n){const r=s.tabButtons.find(o=>o.dataset.tabTarget===a);r&&Ie(a,r)}}if(s.projectSubTabButtons&&s.projectSubTabButtons.length&&Hn()){const n=s.projectSubTabButtons.find(r=>r.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=t[zt];if(a&&a!==n){const r=s.projectSubTabButtons.find(o=>o.dataset.projectSubtabTarget===a);r&&Yt(a,r)}}}}function Un(){ie||(ie=rn(t=>{ce(t)})),on().then(t=>{ce(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function Vn(){if(!Array.isArray(d.projects)||d.projects.length===0)return;let t=!1;const e=d.projects.map(n=>{if(n.projectCode)return n;const a=ve();return t=!0,{...n,projectCode:a}});t&&(d.projects=e)}function zn(){const{customers:t,technicians:e,equipment:n}=ut();d.customers=Array.isArray(t)?t:[],d.technicians=Array.isArray(e)?e:[],d.equipment=Array.isArray(n)?n:[],d.reservations=J(),d.projects=pt(),Vn()}function Et(){if(De(),s.technicianSelect){const t=s.technicianSelect.value,e=l(i("projects.form.selectTechnician","اختر عضو الطاقم"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+d.technicians.map(n=>{const a=i("projects.fallback.technicianName","عضو {id}"),r=n.name||a.replace("{id}",j(String(n.id||"")));return`<option value="${n.id}">${l(r)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=l(i("projects.form.selectEquipment","اختر المعدة"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+d.equipment.map(n=>{const a=n.desc||n.description||n.name||i("projects.fallback.unknownEquipment","معدة");return`<option value="${l(n.barcode||"")}">${l(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function ot(t){if(!s.clientCompany)return;const e=t?.companyName||t?.company||"";s.clientCompany.value=e}function De(){if(!s.client)return;Wn();const t=s.client.dataset?.customerId;if(t){const e=d.customers.find(n=>String(n.id)===String(t));e?ot(e):(s.client.dataset.customerId="",ot(null))}else ot(null);document.activeElement===s.client&&_t()}function Wn(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",_t(),ot(null)}),s.client.addEventListener("focus",()=>{_t()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>vt(),150)}),s.client.dataset.autocompleteAttached="true")}function vt(){s.clientSuggestions&&(s.clientSuggestions.style.display="none",s.clientSuggestions.innerHTML="")}function _t(){if(!s.client||!s.clientSuggestions)return;const t=Kn(),e=lt(s.client.value||""),n=e?t.filter(a=>{const r=lt(a.name).includes(e),o=lt(a.company||"").includes(e);return r||o}).slice(0,10):t.slice(0,10);if(!n.length){vt();return}s.clientSuggestions.innerHTML=n.map(a=>{const r=a.company?`<div class="suggestion-item__meta">${l(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${l(String(a.id))}" data-name="${l(a.name)}" data-company="${l(a.company||"")}">
          <div class="suggestion-item__primary">${l(a.name)}</div>
          ${r}
        </div>
      `}).join(""),s.clientSuggestions.style.display="block",s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",r=>{r.preventDefault();const{id:o,name:c}=r.currentTarget.dataset;s.client&&(s.client.value=c||"",s.client.dataset.customerId=o||"");const u=r.currentTarget.dataset.company||"";ot({companyName:u}),vt()})})}function Kn(){return Array.isArray(d.customers)?d.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function Yn(t,e=""){if(!Array.isArray(d.customers)||d.customers.length===0)return null;if(e){const r=d.customers.find(o=>String(o.id)===String(e));if(r)return r}const n=lt(t||"");if(!n)return null;const a=d.customers.find(r=>lt(r.customerName||r.name||"")===n);return a||d.customers.find(r=>lt(r.customerName||r.name||"").includes(n))||null}async function Jn(t){if(d.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(i("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await gn(t),await Ht(),await je(),d.projects=pt(),d.reservations=J(),F(),Z(),X(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),x(i("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=mt(n)?n.message:i("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");x(a,"error")}}async function Gn(t,e){if(!t)return!1;const a=J().filter(u=>String(u.projectId)===String(t));if(!a.length)return!1;const r=e==="paid",o=r?"paid":"unpaid";let c=!1;for(const u of a){const p=u.id??u.reservationId;if(!p)continue;const b=u.paid===!0||u.paid==="paid",f=u.paidStatus||u.paymentStatus||(b?"paid":"unpaid");b===r&&f===o||(await Se(p,{paid_status:o,paid:r}),c=!0)}return c&&(d.reservations=J()),c}async function Qn(t){if(!t)return!1;const e=J(),n=d.projects.find(o=>String(o.id)===String(t))||(ut().projects||[]).find?.(o=>String(o.id)===String(t))||null,a=e.filter(o=>String(o.projectId)===String(t));if(!a.length)return!1;let r=!1;for(const o of a){const c=o.id??o.reservationId;if(!c)continue;const u=bn({...o,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await Se(c,{confirmed:!0,status:p}),r=!0}return r&&(d.reservations=J()),r}async function Mt(t,e){if(!t)return!1;const n=await Gn(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let It=!1;function Xn(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",ms),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),vt(),we(),s.type&&(s.type.value=""),ot(null),Be()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{d.filters.search=j(s.search.value||"").trim().toLowerCase(),F()}),s.search.dataset.listenerAttached="true")}function Be(){jn(),d.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),st(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),Ct()}function Zn(){s.addTechnicianBtn&&s.addTechnicianBtn.dataset.listenerAttached!=="true"&&(s.addTechnicianBtn.addEventListener("click",os),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&s.addEquipmentBtn.dataset.listenerAttached!=="true"&&(s.addEquipmentBtn.addEventListener("click",is),s.addEquipmentBtn.dataset.listenerAttached="true")}function ts(){Dt(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;d.selectedTechnicians=d.selectedTechnicians.filter(n=>n!==e),Ne()}}),Dt(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;d.selectedEquipment=d.selectedEquipment.filter(n=>n.barcode!==e),ke()}}),Dt(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;d.expenses=d.expenses.filter(n=>String(n.id)!==String(e)),_e(),Z()}})}function es(){s.addExpenseBtn&&s.addExpenseBtn.dataset.listenerAttached!=="true"&&(s.addExpenseBtn.addEventListener("click",cs),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&s.expenseAmount.dataset.normalizeAttached!=="true"&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=j(e.value||"");if(e.value=a,n!=null){const r=Math.min(a.length,n);e.setSelectionRange(r,r)}}),s.expenseAmount.dataset.normalizeAttached="true")}function Dt(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function ns({onViewDetails:t}){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached==="true"||(s.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;t?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!he()){cn();return}const a=n.dataset.id;Jn(a)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function ss(){const{customers:t}=ut();d.customers=Array.isArray(t)?t:[],st(),F(),X()}function as(){const{technicians:t}=ut();d.technicians=Array.isArray(t)?t:[],st(),F(),X()}function rs(t){const{reservations:e}=ut();d.reservations=Array.isArray(e)?e:[],F();const n=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),a=s.detailsBody?.dataset.projectId;n&&a&&d.projects.find(o=>String(o.id)===String(a))&&t?.(a)}function os(){const t=s.technicianSelect?.value;if(!t){x(i("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(d.selectedTechnicians.includes(t)){x(i("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}d.selectedTechnicians.push(t),st(),x(i("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function is(){const t=s.equipmentSelect?.value;if(!t){x(i("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(s.equipmentQty?.value||"1",10)||1),n=d.selectedEquipment.find(a=>a.barcode===t);n?n.qty+=e:d.selectedEquipment.push({barcode:t,qty:e}),st(),x(i("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function cs(){const t=(s.expenseLabel?.value||"").trim(),e=j(s.expenseAmount?.value||"0"),n=Number(e);if(!t){x(i("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){x(i("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}d.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=j(String(e))),st(),Z()}function st(){Ne(),ke(),_e(),Ct()}function Ne(){s.technicianList&&Jt(s.technicianList,d.selectedTechnicians,t=>{const n=d.technicians.find(a=>String(a.id)===String(t))?.name||i("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${l(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${l(String(t))}" aria-label="${l(i("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function ke(){s.equipmentList&&Jt(s.equipmentList,d.selectedEquipment,t=>{const e=d.equipment.find(r=>String(r.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||i("projects.fallback.unknownEquipment","معدة"),a=j(String(t.qty||1));return`
      <span class="chip">
        ${l(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${l(String(t.barcode))}" aria-label="${l(i("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function _e(){s.expenseList&&Jt(s.expenseList,d.expenses,t=>`
      <div class="expense-item">
        <span>${l(t.label)}</span>
        <span>${B(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${l(String(t.id))}" aria-label="${l(i("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function Jt(t,e,n){if(t){if(!e||e.length===0){const a=l(Cn(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function Ct(){if(!s.submitBtn)return;const t=!!d.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";s.submitBtn.textContent=i(e,n)}function ls(){return d.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function le(t){return j(String(t||"")).trim().toLowerCase()}function ds(){if(!Array.isArray(d.selectedEquipment)||d.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((d.equipment||[]).map(a=>[le(a?.barcode),a])),e=[],n=[];return d.selectedEquipment.forEach(a=>{const r=le(a?.barcode);if(!r){e.push(a?.barcode||"");return}const o=t.get(r);if(!o||o.id==null){e.push(a?.barcode||r);return}const c=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:o.id,qty:Number.isInteger(c)&&c>0?c:1})}),{items:n,missing:e}}function us(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,a=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function ps(){return d.selectedEquipment.reduce((t,e)=>{const n=d.equipment.find(r=>String(r.barcode||"")===String(e.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+a*(e.qty||1)},0)}async function ms(t){if(t.preventDefault(),It)return;const e=s.title?.value.trim(),n=s.type?.value||"",a=s.client?.value?.trim()||"",r=s.client?.dataset?.customerId||"",o=s.startDate?.value?.trim()||"",c=s.startTime?.value?.trim()||"";if(!e||!n||!o){x(i("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const u=Yn(a,r);if(!u){x(i("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),s.client?.focus();return}const p=String(u.id);s.client&&(s.client.dataset.customerId=p,s.client.value=u.customerName||u.name||s.client.value),ot(u);const b=s.endDate?.value?.trim()||"",f=s.endTime?.value?.trim()||"",h=de(o,c),g=b?de(b,f):"",y=new Date(h),S=g?new Date(g):null;if(S&&y>S){x(i("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}s.expenseAmount&&(s.expenseAmount.value=j(s.expenseAmount.value||""));const v=ls(),T=ps(),E=s.taxCheckbox?.checked===!0,P=(s.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",A=T+v,q=E?Number((A*jt).toFixed(2)):0,G=Number((A+q).toFixed(2)),{items:O,missing:H}=ds();if(H.length){x(i("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const D=!!d.editingProjectId,I=D?d.projects.find($=>String($.id)===String(d.editingProjectId)):null;if(D&&!I){x(i("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const U=u.companyName||u.company||"",V=s.description?.value.trim()||"",R=Te({projectCode:I?.projectCode||(D?null:ve()),title:e,type:n,clientId:p,clientCompany:U,description:V,start:h,end:g||null,applyTax:E,paymentStatus:P,equipmentEstimate:T,expenses:d.expenses.map($=>({id:$.id,label:$.label,amount:$.amount})),taxAmount:q,totalWithTax:G,confirmed:I?.confirmed??!1,technicians:d.selectedTechnicians,equipment:O});It=!0;try{let $=I?.projectId??I?.id??null;if(D){const L=await Ut($??d.editingProjectId,R);$=L?.projectId??L?.id??$,await Mt($,P),x(i("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const L=await hn(R);$=L?.projectId??L?.id??null,await Mt($,P),x(i("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}d.editingProjectId=null,s.form.reset(),Be(),we(),vt(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),d.projects=pt(),d.reservations=J(),F(),Z(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch($){console.error("❌ [projects] handleSubmitProject failed",$);const L=mt($)?$.message:i("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");x(L,"error")}finally{It=!1}}function de(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),o=a.padStart(2,"0"),c=r.padStart(2,"0");return`${t}T${o}:${c}`}function it(t){const e=d.projects.find(C=>String(C.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view",s.detailsBody.dataset.projectId=String(e.id);const n=d.customers.find(C=>String(C.id)===String(e.clientId)),a=Re(e.type),o=e.description?.trim()||i("projects.fallback.noDescription","لا يوجد وصف"),c=n?.customerName||i("projects.fallback.unknownClient","عميل غير معروف"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${j(String(e.id))}`,b=j(p),f=$t(e.id),h=f.reduce((C,_)=>C+Ts(_),0),g=Number(h.toFixed(2)),y=f.length,{subtotal:S,applyTax:v,expensesTotal:T}=yt(e),E=S,N=v?Number(((E+g)*jt).toFixed(2)):0,P=Number((E+g+N).toFixed(2)),A=Kt(e),q=i(`projects.status.${A}`,$e[A]||A),O={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[A]||"status-confirmed",H=v?i("projects.details.chips.vatOn","شامل الضريبة 15٪"):i("projects.details.chips.vatOff","غير شامل الضريبة"),D=v?"status-paid":"status-unpaid",I=i("projects.details.chips.reservations","{count} حجوزات").replace("{count}",j(String(y))),U=e.paymentStatus==="paid"?"paid":"unpaid",V=i(`projects.paymentStatus.${U}`,U==="paid"?"Paid":"Unpaid"),R=U==="paid"?"status-paid":"status-unpaid",$=i("projects.focus.confirmed","✅ مشروع مؤكد"),L=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${l($)}</span>`:"",tt=[{icon:"💳",label:i("projects.details.summary.paymentStatus","حالة الدفع"),value:V},{icon:"💼",label:i("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:B(E)},{icon:"🔗",label:i("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:B(g)},{icon:"🧮",label:i("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:B(N)},{icon:"💰",label:i("projects.details.summary.overallTotal","الإجمالي الكلي"),value:B(P)}].map(({icon:C,label:_,value:bt})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${C} ${l(_)}</span>
      <span class="summary-details-value">${l(bt)}</span>
    </div>
  `).join(""),Y=[];Y.push({icon:"🆔",label:i("projects.details.labels.code","رقم المشروع"),value:`#${b}`}),Y.push({icon:"👤",label:i("projects.details.client","العميل"),value:c}),u&&Y.push({icon:"🏢",label:i("projects.details.company","شركة العميل"),value:u}),Y.push({icon:"🏷️",label:i("projects.details.type","نوع المشروع"),value:a}),Y.push({icon:"📅",label:i("projects.details.range","الفترة الزمنية"),value:Pn(e.start,e.end)});const rt=Y.map(({icon:C,label:_,value:bt})=>`
    <div class="project-info-row">
      <span>${C} ${l(_)}</span>
      <span>${l(bt)}</span>
    </div>
  `).join(""),ct=[`<span class="reservation-chip ${O}">${l(q)}</span>`,`<span class="reservation-chip ${D}">${l(H)}</span>`,`<span class="reservation-chip status-info">${l(I)}</span>`,`<span class="reservation-chip ${R}">${l(V)}</span>`,L].filter(Boolean).join(""),ft=i("projects.details.expensesTotal","إجمالي المصاريف"),gt=i("projects.details.reservationsTotal","إجمالي الحجوزات");s.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${l(e.title)}</h4>
          <div class="project-details-chips">${ct}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${l(i("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${rt}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${l(i("projects.details.summary.title","ملخص مالي"))}</h6>
            ${tt}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${l(i("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${l(o)}</p>
    </section>
    <section class="project-details-section">
      <h5>${l(i("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${l(ft)}</span>
          <strong>${B(T)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${l(gt)}</span>
          <strong>${B(g)}</strong>
        </div>
      </div>
    </section>
    ${kn(e)}
  `,bs(e),s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function fs({onOpenProject:t}){!s.focusCards||s.focusCards.dataset.listenerAttached==="true"||(s.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:r,id:o}=n.dataset;if(r==="confirm-project"){e.preventDefault(),e.stopPropagation(),vs(o);return}r==="view"?t?.(o):r==="highlight"&&gs(o);return}const a=e.target.closest(".project-focus-card");a?.dataset.projectId&&t?.(a.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function gs(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){x(i("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function bs(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]'),n=s.detailsBody.querySelector('[data-action="edit-project"]'),a=s.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",r=>{r.preventDefault(),ys(t)}),n&&t&&n.addEventListener("click",r=>{r.preventDefault(),Me(t)}),a&&a.addEventListener("click",r=>{const o=r.target.closest('[data-action="view-reservation"]');if(!o)return;const c=Number.parseInt(o.dataset.index||"-1",10);!Number.isInteger(c)||c<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(c):window.location.href="dashboard.html#reservations")})}function Me(t){if(!t||!s.detailsBody)return;const e=d.projects.find(o=>String(o.id)===String(t.id));if(!e)return;const n=d.customers.find(o=>String(o.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const r={expenses:Array.isArray(e.expenses)?e.expenses.map((o,c)=>({id:o?.id||`expense-${e.id}-${c}-${Date.now()}`,label:o?.label||"",amount:Number(o?.amount)||0})):[]};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=js(e,r),hs(e,r)}function hs(t,e={expenses:[]}){const n=s.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",y=>{y.preventDefault(),it(t.id)});const r=n.querySelector("#project-edit-expense-label"),o=n.querySelector("#project-edit-expense-amount"),c=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),b=n.querySelector('[name="project-start-time"]'),f=n.querySelector('[name="project-end-date"]'),h=n.querySelector('[name="project-end-time"]');function g(){u&&(u.innerHTML=qe(e.expenses))}g(),c&&c.addEventListener("click",y=>{y.preventDefault();const S=r?.value.trim()||"",v=j(o?.value||"0"),T=Number(v);if(!S){x(i("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),r?.focus();return}if(!Number.isFinite(T)||T<=0){x(i("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),o?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:S,amount:T}),r&&(r.value=""),o&&(o.value=""),g()}),u&&u.addEventListener("click",y=>{const S=y.target.closest('[data-action="remove-expense"]');if(!S)return;const{id:v}=S.dataset;e.expenses=e.expenses.filter(T=>String(T.id)!==String(v)),g()}),n.addEventListener("submit",async y=>{if(y.preventDefault(),n.dataset.submitting==="true")return;const S=n.querySelector('[name="project-title"]'),v=n.querySelector('[name="project-type"]'),T=n.querySelector('[name="project-description"]'),E=n.querySelector('[name="project-payment-status"]'),N=n.querySelector('[name="project-apply-tax"]'),P=S?.value.trim()||"",A=v?.value||"",q=p?.value.trim()||"",G=b?.value.trim()||"",O=T?.value.trim()||"",H=E?.value==="paid"?"paid":"unpaid",D=N?.checked===!0;if(!P||!A||!q){x(i("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),S?.focus();return}const I=f?.value.trim()||"",U=h?.value.trim()||"",V=se(q,G),R=I?se(I,U):"",$=new Date(V),L=R?new Date(R):null;if(L&&$>L){x(i("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),f?.focus();return}if(d.projects.findIndex(C=>String(C.id)===String(t.id))===-1){x(i("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const tt=Number(t.equipmentEstimate)||0,Y=e.expenses.reduce((C,_)=>C+(Number(_.amount)||0),0),rt=tt+Y,ct=D?Number((rt*jt).toFixed(2)):0,ft=D?Number((rt+ct).toFixed(2)):rt,gt=Te({projectCode:t.projectCode,title:P,type:A,clientId:t.clientId,clientCompany:t.clientCompany,description:O,start:V,end:R||null,applyTax:D,paymentStatus:H,equipmentEstimate:tt,expenses:e.expenses,taxAmount:ct,totalWithTax:ft,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:us(t)});n.dataset.submitting="true";try{const C=await Ut(t.projectId??t.id,gt),_=C?.projectId??C?.id??t.id;await Mt(_,H),d.projects=pt(),d.reservations=J(),x(i("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),F(),X(),Z(),it(t.id)}catch(C){console.error("❌ [projects] Failed to update project from details view",C);const _=mt(C)?C.message:i("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");x(_,"error")}finally{delete n.dataset.submitting}})}function ys(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};Ft({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(r=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",r)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(r){console.warn("⚠️ [projects] Unable to encode reservation context",r)}s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function vs(t){if(!t)return;const e=d.projects.find(n=>String(n.id)===String(t));if(!e){x(i("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(e.confirmed===!0||e.confirmed==="true"){x(i("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await Ut(e.projectId??e.id,{confirmed:!0});const n=await Qn(t);d.projects=pt(),d.reservations=J(),F(),X(),Z(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&s.detailsBody?.dataset.projectId===String(t)&&it(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),x(i("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=mt(n)?n.message:i("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");x(a,"error")}}function js(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=ae(t.start||""),{date:r,time:o}=ae(t.end||""),c=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${l(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${Ss(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${l(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${l(a)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${l(r)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${l(o)}">
        </div>
        <div class="col-12">
          <label class="form-label">${l(i("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${l(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${l(i("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${l(i("projects.paymentStatus.unpaid","قيد الانتظار"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${l(i("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${c?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${l(i("projects.form.labels.applyTax","تطبيق الضريبة 15٪"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${l(i("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${l(i("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${l(i("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${l(i("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${qe(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${l(i("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${l(i("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function Ss(t){return["commercial","coverage","photography","social"].map(n=>{const a=Re(n),r=n===t?"selected":"";return`<option value="${l(n)}" ${r}>${l(a)}</option>`}).join("")}function qe(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${l(i("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=l(i("actions.remove","إزالة"));return t.map(n=>{const a=l(n?.label||""),r=l(B(n?.amount||0)),o=l(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${r}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${o}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function Re(t){if(!t)return i("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return i(e,t)}function Ts(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(j(String(n)))||0,r=t.discountType||"percent",o=Array.isArray(t.technicians)?t.technicians:[],c=Ot(e,a,r,!1,o,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(j(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Fe(t){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(t);if(a)return a}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const a=new URLSearchParams(e).get(t);if(a)return a}catch{}return null}function xs(){return Fe(Bt)}function ws(){return Fe(Nt)}function $s(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[Bt,Nt].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let a=e,r=!1;if(e)try{const p=new URLSearchParams(e);let b=!1;[Bt,Nt].forEach(f=>{p.has(f)&&(p.delete(f),b=!0)}),b&&(a=p.toString(),r=!0)}catch{}if(!n&&!r)return;const o=window.location.pathname,c=t.toString(),u=`${o}${c?`?${c}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",u)}catch{}}function Es(){const t=xs(),e=ws();t&&(d.pendingProjectDetailId=t),e&&(d.pendingProjectEditId=e,d.pendingProjectDetailId||(d.pendingProjectDetailId=e)),(t||e)&&$s()}function Cs(){if(!d.pendingProjectDetailId)return;const t=d.pendingProjectDetailId,e=String(t),n=d.projects.find(r=>[r?.id,r?.projectId,r?.project_id].some(c=>c!=null&&String(c)===e));if(!n)return;d.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??e;if(it(a),d.pendingProjectEditId!=null){const r=String(d.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(c=>c!=null&&String(c)===r)&&(d.pendingProjectEditId=null,setTimeout(()=>Me(n),0))}}function Ps(){document.addEventListener("DOMContentLoaded",()=>{Un(),Es(),Tn(),Ct(),xn(),Rn(),Fn(),wn(),Xn(),Zn(),ts(),es(),ns({onViewDetails:it}),fs({onOpenProject:it}),De(),As()}),document.addEventListener("language:changed",ue),document.addEventListener("language:translationsReady",ue),document.addEventListener("customers:changed",Ls),document.addEventListener("technicians:updated",Is),document.addEventListener("reservations:changed",()=>rs(it)),document.addEventListener(ln.USER_UPDATED,()=>{F()})}async function As(){try{await xe({suppressError:!0}),await Ht()}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||i("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");x(e,"error")}finally{zn(),Et(),st(),F(),Z(),X(),Cs()}}function ue(){Et(),st(),F(),Z(),X(),Ct()}function Ls(){ss(),Et()}function Is(){as(),Et()}dn();un();pn();yn();Ps();document.addEventListener("DOMContentLoaded",()=>{fn(),mn()});const Ds="modulepreload",Bs=function(t,e){return new URL(t,e).href},pe={},Ns=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){let b=function(f){return Promise.all(f.map(h=>Promise.resolve(h).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};const c=document.getElementsByTagName("link"),u=document.querySelector("meta[property=csp-nonce]"),p=u?.nonce||u?.getAttribute("nonce");r=b(n.map(f=>{if(f=Bs(f,a),f in pe)return;pe[f]=!0;const h=f.endsWith(".css"),g=h?'[rel="stylesheet"]':"";if(a)for(let S=c.length-1;S>=0;S--){const v=c[S];if(v.href===f&&(!h||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${f}"]${g}`))return;const y=document.createElement("link");if(y.rel=h?"stylesheet":Ds,h||(y.as="script"),y.crossOrigin="",y.href=f,p&&y.setAttribute("nonce",p),document.head.appendChild(y),h)return new Promise((S,v)=>{y.addEventListener("load",S),y.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(c){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=c,window.dispatchEvent(u),!u.defaultPrevented)throw c}return r.then(c=>{for(const u of c||[])u.status==="rejected"&&o(u.reason);return e().catch(o)})},me=.15,St={};let ht=0;const w={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},m={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},Tt=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let K=null;const Oe=["upcoming","ongoing","completed"];async function ks({forceProjects:t=!1}={}){try{await xe({suppressError:!0}),await vn({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),mt(e)&&console.warn("Projects API error:",e.message)}ze()}async function _s(){qs(),Ue(),await Ms();try{await ks({forceProjects:!0}),Ke(),Vs(),W()}finally{Ve()}document.addEventListener("language:changed",Ws),document.addEventListener("projects:changed",()=>{qt().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{qt().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",Ks)}document.addEventListener("DOMContentLoaded",_s);async function Ms(){if(K)return K;try{K=(await Ns(()=>import("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"),[],import.meta.url)).default}catch(t){console.warn("Chart.js failed to load",t),K=null}return K}function qs(){m.search=document.getElementById("reports-search"),m.statusChips=document.getElementById("reports-status-chips"),m.payment=document.getElementById("reports-payment"),m.dateRange=document.getElementById("reports-date-range"),m.customRangeWrapper=document.getElementById("reports-custom-range"),m.startDate=document.getElementById("reports-start-date"),m.endDate=document.getElementById("reports-end-date"),m.refreshBtn=document.getElementById("reports-refresh"),m.kpiGrid=document.getElementById("reports-kpi-grid"),m.table=document.getElementById("reports-table"),m.tableBody=m.table?.querySelector("tbody"),m.tableMeta=document.getElementById("reports-table-meta"),m.tableEmpty=document.getElementById("reports-empty"),m.chartCards={},m.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;m.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(m.chartLoaders[e]=n)})}function He(t){const e=!!t;Object.entries(m.chartCards||{}).forEach(([n,a])=>{if(!a)return;a.classList.toggle("is-loading",e),a.setAttribute("aria-busy",e?"true":"false");const r=m.chartLoaders?.[n];r&&(r.hidden=!e)})}function Ue(){ht+=1,ht===1&&He(!0)}function Ve(){ht=Math.max(0,ht-1),ht===0&&He(!1)}function ze(){const{customers:t=[]}=ut();w.customers=Array.isArray(t)?t:[],w.reservations=J();const e=new Map(w.customers.map(a=>[String(a.id),a])),n=pt();w.projects=Array.isArray(n)?n.map(a=>Rs(a,e)):[],w.totalProjects=w.projects.length}function Rs(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",a=e.get(String(t.clientId)),r=Fs(t.id),o=r.reduce((T,E)=>T+Os(E),0),c=Hs(t),u=Number(t?.equipmentEstimate)||0,p=Number((u+c).toFixed(2)),b=t?.applyTax===!0||t?.applyTax==="true",f=b?Number((p*me).toFixed(2)):0,h=b?Number(((p+o)*me).toFixed(2)):0,g=Number((p+o+h).toFixed(2)),y=Us(t),S=t.start?new Date(t.start):null,v=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:a?.customerName||a?.name||"",clientCompany:t.clientCompany||a?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:S,end:v,applyTax:b,status:y,reservationsTotal:Number(o.toFixed(2)),expensesTotal:c,subtotal:p,taxAmount:f,combinedTaxAmount:h,overallTotal:g,unpaidValue:n==="paid"?0:g,reservationsCount:r.length}}function Fs(t){return Array.isArray(w.reservations)?w.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Os(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(j(String(n)))||0,r=t.discountType||"percent",o=Array.isArray(t.technicians)?t.technicians:[],c=Ot(e,a,r,!1,o,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(j(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Hs(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function Us(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function Vs(){if(m.search){let t;m.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{w.filters.search=m.search.value.trim(),W()},180)})}m.payment&&(m.payment.value=w.filters.payment,m.payment.addEventListener("change",()=>{w.filters.payment=m.payment.value||"all",W()})),m.dateRange&&(m.dateRange.addEventListener("change",zs),m.dateRange.value=w.filters.range),m.startDate&&m.startDate.addEventListener("change",()=>{w.filters.startDate=m.startDate.value,w.filters.range==="custom"&&W()}),m.endDate&&m.endDate.addEventListener("change",()=>{w.filters.endDate=m.endDate.value,w.filters.range==="custom"&&W()}),m.refreshBtn&&m.refreshBtn.addEventListener("click",()=>{if(w.filters.range!=="custom"){W();return}w.filters.startDate=m.startDate?.value||"",w.filters.endDate=m.endDate?.value||"",W()})}function zs(t){const e=t.target.value;w.filters.range=e,e==="custom"?m.customRangeWrapper?.classList.add("active"):(m.customRangeWrapper?.classList.remove("active"),w.filters.startDate="",w.filters.endDate="",m.startDate&&(m.startDate.value=""),m.endDate&&(m.endDate.value=""),W())}async function qt(){Ue();try{await Promise.all([Ht(),je()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),mt(t)&&console.warn("Projects API error:",t.message)}finally{ze(),W(),Ve()}}function Ws(){Ke(),W()}function Ks(t){t.key&&!["projects","reservations","customers"].includes(t.key)||qt().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function W(){const t=Ys();Gt(),Qs(t),Zs(t),ta(t),ea(t),na(t),sa(t)}function Ys(){const{search:t,statuses:e,payment:n,range:a,startDate:r,endDate:o}=w.filters,c=We(t),u=new Date,p=Number(a);let b=null;if(a==="custom"){b=r?new Date(r):null;const f=o?new Date(o):null;return w.projects.filter(h=>!fe(h,e)||!ge(h,n)||!be(h,c)?!1:Gs(h.start,b,f))}return a!=="all"&&Number.isFinite(p)&&(b=new Date,b.setDate(u.getDate()-p)),w.projects.filter(f=>!fe(f,e)||!ge(f,n)||!be(f,c)?!1:a==="all"?!0:Js(f.start,b,u))}function fe(t,e){return e.includes(t.status)}function ge(t,e){return e==="all"?!0:t.paymentStatus===e}function be(t,e){return e?We([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function Js(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function Gs(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const a=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&a<e.getTime()||n&&!Number.isNaN(n.getTime())&&a>n.getTime())}function We(t){return t?j(String(t)).toLowerCase().trim():""}function Qs(t){if(!m.kpiGrid)return;const e=t.length,n=t.reduce((c,u)=>c+u.overallTotal,0),a=t.reduce((c,u)=>c+u.unpaidValue,0),r=t.reduce((c,u)=>c+u.expensesTotal,0),o=[{icon:Tt.projects,label:i("projects.reports.kpi.totalProjects","Total projects"),value:Rt(e),meta:i("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:Tt.value,label:i("projects.reports.kpi.totalValue","Total value"),value:xt(n),meta:i("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:Tt.outstanding,label:i("projects.reports.kpi.unpaidValue","Outstanding value"),value:xt(a),meta:i("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:Tt.expenses,label:i("projects.reports.kpi.expenses","Total expenses"),value:xt(r),meta:i("projects.reports.kpi.expensesMeta","Expenses for included projects")}];m.kpiGrid.innerHTML=o.map(({icon:c,label:u,value:p,meta:b})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${c}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${M(u)}</p>
        <p class="reports-kpi-value">${M(p)}</p>
        <span class="reports-kpi-meta">${M(b)}</span>
      </div>
    </div>
  `).join("")}function Ke(){if(!m.statusChips)return;const t=Oe.map(e=>{const n=i(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${M(n)}</button>`}).join("");m.statusChips.innerHTML=t,m.statusChips.dataset.listenerAttached||(m.statusChips.addEventListener("click",Xs),m.statusChips.dataset.listenerAttached="true"),Gt()}function Xs(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const a=new Set(w.filters.statuses);a.has(n)?a.delete(n):a.add(n),a.size===0&&Oe.forEach(r=>a.add(r)),w.filters.statuses=Array.from(a),Gt(),W()}function Gt(){if(!m.statusChips)return;const t=new Set(w.filters.statuses);m.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Zs(t){if(!K)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],a=n.map(u=>t.filter(p=>p.status===u).length),o={labels:n.map(u=>i(`projects.status.${u}`,u)),datasets:[{data:a,backgroundColor:["rgba(59, 130, 246, 0.85)","rgba(250, 204, 21, 0.85)","rgba(34, 197, 94, 0.85)"],borderColor:["rgba(37, 99, 235, 1)","rgba(217, 119, 6, 1)","rgba(22, 163, 74, 1)"],borderWidth:1}]};Pt("status",e,"doughnut",o,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function ta(t){if(!K)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,a=new Intl.DateTimeFormat(ra(),{month:"short",year:"numeric"});t.forEach(f=>{if(!f.start||Number.isNaN(f.start.getTime()))return;const h=`${f.start.getFullYear()}-${f.start.getMonth()+1}`,g=n.get(h)||{total:0,label:a.format(f.start)};g.total+=f.overallTotal,n.set(h,g)});const o=Array.from(n.keys()).sort((f,h)=>{const[g,y]=f.split("-").map(Number),[S,v]=h.split("-").map(Number);return g===S?y-v:g-S}).slice(-12),c=o.map(f=>n.get(f)?.label||f),u=o.map(f=>Math.round(n.get(f)?.total||0)),p={labels:c,datasets:[{label:i("projects.reports.charts.timeline","Revenue over time"),data:u,borderColor:"rgba(76, 110, 245, 0.95)",backgroundColor:"rgba(76, 110, 245, 0.25)",fill:!0,tension:.35,pointRadius:4}]};Pt("timeline",e,"line",p,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:f=>Qt(f)}}},plugins:{legend:{display:!1}}})}function ea(t){if(!K)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((p,b)=>b.overallTotal-p.overallTotal).slice(0,6),a=n.map(p=>p.title||p.projectCode),r=n.map(p=>Math.round(p.overallTotal)),o=n.map(p=>Math.round(p.expensesTotal)),c={labels:a,datasets:[{label:i("projects.reports.datasets.value","Total value"),data:r,backgroundColor:"rgba(76, 110, 245, 0.65)"},{label:i("projects.reports.datasets.expenses","Expenses"),data:o,backgroundColor:"rgba(244, 114, 182, 0.55)"}]};Pt("expenses",e,"bar",c,{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0,ticks:{callback:p=>Qt(p)}}},plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function na(t){if(!K)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(p=>{const b=p.clientName||p.clientCompany||i("projects.fallback.unknownClient","Unknown client"),f=n.get(b)||0;n.set(b,f+p.overallTotal)});const a=Array.from(n.entries()).sort((p,b)=>b[1]-p[1]).slice(0,6),r=a.map(([p])=>p),o=a.map(([,p])=>Math.round(p)),c={labels:r,datasets:[{label:i("projects.reports.charts.clients","Top clients"),data:o,backgroundColor:"rgba(59, 130, 246, 0.75)"}]};Pt("clients",e,"bar",c,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:p=>Qt(p)}}},plugins:{legend:{display:!1}}})}function Pt(t,e,n,a,r){!K||!e||(St[t]&&(St[t].destroy(),delete St[t]),St[t]=new K(e,{type:n,data:a,options:r}))}function sa(t){if(!m.table||!m.tableBody||!m.tableEmpty)return;if(!t.length){m.table.style.display="none",m.tableEmpty.classList.add("active"),m.tableMeta&&(m.tableMeta.textContent="");return}m.table.style.display="",m.tableEmpty.classList.remove("active");const e=t.map(n=>{const a=aa(n.start,n.end),r=i(`projects.status.${n.status}`,n.status),o=i(`projects.paymentStatus.${n.paymentStatus}`,n.paymentStatus),c=n.clientCompany?`${M(n.clientName)} <small class="text-muted">${M(n.clientCompany)}</small>`:M(n.clientName||i("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${M(n.title||n.projectCode)}</span>
            <small class="text-muted">${M(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${c}</td>
        <td>${M(r)}</td>
        <td>${M(a)}</td>
        <td>${M(xt(n.overallTotal))}</td>
        <td>${M(o)}</td>
      </tr>
    `}).join("");if(m.tableBody.innerHTML=e,m.tableMeta){const n=i("projects.reports.table.meta","Showing {count} of {total} projects");m.tableMeta.textContent=n.replace("{count}",Rt(t.length)).replace("{total}",Rt(w.totalProjects))}}function aa(t,e){if(!t&&!e)return"—";const n=t?Xt(t.toISOString()):"—",a=e?Xt(e.toISOString()):"—";return e?`${n} → ${a}`:n}function xt(t){const e=Number(t)||0,a=dt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${j(r)} SR`}function Rt(t){const n=dt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return j(new Intl.NumberFormat(n).format(t))}function Qt(t){const n=dt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return j(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function ra(){return dt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function M(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
