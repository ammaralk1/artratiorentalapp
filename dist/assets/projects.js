import{l as Ie,n as f,d as Kt,t as r,j as Yt,r as Ae,q as Be,p as Gt,u as Ct,e as lt,y as Qt,h as v,o as Le,f as _e,a as De,m as qe,c as Ne,i as ke}from"./auth.js";/* empty css     *//* empty css       */import{i as Me}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{t as Xt,n as at,g as W,z as ut,A as Fe,B as Zt,C as Re,E as mt,r as Ue,v as te,k as ee,l as Pt,F as He,e as Oe}from"./projectsService.js";/* empty css   */import{c as Ve}from"./controller.js";const d={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},s={};function ze(){d.selectedTechnicians=[],d.selectedEquipment=[],d.expenses=[]}function We(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Je(){s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.submitBtn=s.form?.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function Ke(){const t=We();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([a,o])=>{document.querySelector(a)&&t(a,o)})}function ne(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function Ye(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>Ie()),t.dataset.listenerAttached="true")}const Tt="project",xt="editProject",qt=3600*1e3,pt=.15,yt=6,It="projectsTab",At="projectsSubTab",Nt={create:"create-project-tab",list:"projects-list-tab"},se={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},Ge={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function c(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(t){const e=Number(t)||0,n=Kt(),a=n==="ar"?"ar-SA":"en-US",o=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e)),i=n==="ar"?"ر.س":"SAR";return`${f(o)} ${i}`}function Q(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),l=e.getHours(),u=l>=12?"PM":"AM",p=l%12||12,h=String(p).padStart(2,"0"),x=`${n}/${a}/${o} ${h}:${i} ${u}`;return f(x)}function Qe(t){const e=Kt(),n=f(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function kt(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=Qe(t))}function Xe(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?r(e,n):n}function G(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function Mt(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=G(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function Ft(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),l=o.padStart(2,"0");return`${t}T${i}:${l}`}function ae(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}…`}function Ze(t,e){if(!t)return"—";const n=Q(t);return e?`${n} - ${Q(e)}`:n}function Rt(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function ft(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function k(){if(!s.projectsTableBody)return;const t=d.filters.search,e=d.projects.filter(a=>{if(!t)return!0;const o=d.customers.find(l=>String(l.id)===String(a.clientId));return f([a.title,a.description,o?.customerName,a.clientCompany,ft(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=d.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",o=d.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",i=c(r(a,o));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,kt(0),d.visibleProjects=[],Ut([]);return}const n=[...e].sort((a,o)=>new Date(o.start||0)-new Date(a.start||0));d.visibleProjects=n,kt(n.length),s.projectsTableBody.innerHTML=n.map(a=>tn(a)).join(""),Ut(n),J()}function tn(t){const e=d.customers.find(w=>String(w.id)===String(t.clientId)),n=e?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),a=(t.clientCompany||e?.companyName||"").trim(),o=t.technicians?.length||0,i=(t.equipment||[]).reduce((w,C)=>w+(C.qty||0),0),{expensesTotal:l,totalWithTax:u}=ct(t),h=bt(t.id).length,y=r("projects.table.reservationsCount","{count} حجوزات").replace("{count}",f(String(h))),m=h?`<span class="badge rounded-pill project-reservations-chip">${c(y)}</span>`:"",S=`<span class="badge project-type-badge">${c(ft(t.type))}</span>`,b=t.projectCode||`PRJ-${f(String(t.id))}`,g=`<span class="project-code-badge">#${c(b)}</span>`,L=Yt()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${c(r("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${c(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${g}
            ${S}
          </div>
        </div>
        ${m}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${c(n)}</span><small class="text-muted">${c(a)}</small></div>`:c(n)}
      </td>
      <td>${Bt(t.start,t.end)}</td>
      <td>${f(String(o))}</td>
      <td>${f(String(i))}</td>
      <td>${B(u)}</td>
      <td>${B(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${c(r("actions.view","عرض"))}</button>
        ${L}
      </td>
    </tr>
  `}function Bt(t,e){if(!t)return"—";const n=Q(t);return e?`${n} - ${Q(e)}`:n}function Ut(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:d.visibleProjects.length?d.visibleProjects:d.projects).map(y=>{if(!y?.start)return null;const m=new Date(y.start);if(Number.isNaN(m.getTime()))return null;let j=y.end?new Date(y.end):new Date(m);return Number.isNaN(j.getTime())&&(j=new Date(m)),j<=m&&(j=new Date(m.getTime()+qt)),{project:y,startDate:m,endDate:j}}).filter(Boolean).sort((y,m)=>y.startDate-m.startDate);if(!n.length){const y=c(r("projects.timeline.empty",s.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${y}</div>`;return}const a=n[0].startDate.getTime(),o=Math.max(...n.map(y=>y.endDate.getTime()));let i=o-a;i<=0&&(i=qt);const l=en(n),u=r("projects.timeline.range","{start} → {end}"),p=r("projects.timeline.conflict","Scheduling conflict"),h=n.map(y=>{const{project:m,startDate:j,endDate:S}=y,b=S.getTime()-j.getTime();let g=(j.getTime()-a)/i*100;g=Math.max(0,Math.min(g,100));let E=b/i*100;E=Math.max(E,2.5),g+E>100&&(E=Math.max(1.5,100-g));const w=`project-timeline__item--${Lt(m)}`,C=l.has(m.id),q=(m.title||"").trim()||r("projects.fallback.untitled","Untitled project"),V=ae(q,26),M=d.customers.find(Y=>String(Y.id)===String(m.clientId)),F=M?.customerName||r("projects.fallback.unknownClient","Unknown client"),A=(m.clientCompany||M?.companyName||"").trim(),I=ft(m.type),R=Q(j.toISOString()),U=Q(S.toISOString()),N=u.replace("{start}",R).replace("{end}",U),T=A?`${F} (${A})`:F,P=`${q} • ${I} • ${T} | ${N}`,Z=C?`<span class="project-timeline__item-conflict" title="${c(p)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${w}${C?" project-timeline__item--conflict":""}" style="left:${g}%;width:${E}%;" title="${c(P)}">
          <span class="project-timeline__item-label">${c(V)}</span>
          ${Z}
        </div>
      `}).join(""),x=`
    <div class="project-timeline__scale">
      <span>${c(Q(new Date(a).toISOString()))}</span>
      <span>${c(Q(new Date(o).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${x}
    <div class="project-timeline__track">
      ${h}
    </div>
  `}function en(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const o=t[n],i=t[a];o.startDate<i.endDate&&i.startDate<o.endDate&&(e.add(o.project.id),e.add(i.project.id))}return e}function J(){if(!s.focusCards)return;const t=nn();if(!t.length){const e=c(r("projects.focus.empty",s.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));s.focusCards.innerHTML=`<div class="col-12"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function nn(){if(!Array.isArray(d.projects)||!d.projects.length)return[];const t=d.projects.filter(Ht),e=d.projects.filter(i=>!Ht(i)&&an(i)),n=[],a=new Set,o=(i,l)=>{!i||a.has(i.id)||n.length>=yt||(a.add(i.id),n.push(sn(i,l)))};if(t.sort((i,l)=>G(i)-G(l)).forEach(i=>o(i,"today")),e.sort((i,l)=>G(i)-G(l)).forEach(i=>o(i,"thisWeek")),n.length<yt){const i=Date.now();[...d.projects].filter(u=>!a.has(u.id)).filter(u=>{const p=G(u);return Number.isFinite(p)&&p>=i}).sort((u,p)=>G(u)-G(p)).forEach(u=>o(u,"upcoming"))}return n.length<yt&&[...d.projects].filter(l=>!a.has(l.id)).sort((l,u)=>Mt(u)-Mt(l)).forEach(l=>o(l,"recent")),n}function sn(t,e){const n=d.customers.find(_=>String(_.id)===String(t.clientId)),a=n?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),o=(t.clientCompany||n?.companyName||"").trim(),i=Array.isArray(t.technicians)?t.technicians.length:0,l=bt(t.id),u=l.length,p=oe(t),{subtotal:h,applyTax:x}=ct(t),y=(t.description||"").trim(),m=y?ae(y,110):r("projects.fallback.noDescription","لا يوجد وصف"),j=ft(t.type),S=t.paymentStatus==="paid"?"paid":"unpaid",b=r(`projects.paymentStatus.${S}`,S==="paid"?"Paid":"Unpaid"),g=S==="paid"?"status-paid":"status-unpaid",E=S==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",L=t.confirmed===!0||t.confirmed==="true",w=c(String(t.id)),C=t.projectCode||`PRJ-${f(String(t.id))}`,q=f(C),V={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},M={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},F=V[e]||V.recent,A=r(F,M[e]||M.recent),I=Lt(t),R=r(`projects.status.${I}`,se[I]||I),U=Ge[I]||"bg-secondary",N=(t.title||"").trim()||r("projects.fallback.untitled","Untitled project"),T=[E];L&&T.push("project-focus-card--confirmed");const P=l.reduce((_,H)=>{const z=re(H),Ee=(H.items||[]).reduce((Ce,Pe)=>Ce+(Number(Pe?.qty)||1),0),we=(H.technicians||[]).length;return{total:_.total+z,equipment:_.equipment+Ee,crew:_.crew+we}},{total:0,equipment:0,crew:0}),Z=Number(P.total.toFixed(2)),Y=P.equipment,O=P.crew||i,tt=x?Number(((h+Z)*pt).toFixed(2)):0,st=Number((h+Z+tt).toFixed(2)),ot=`<span class="project-code-badge project-focus-card__code">#${c(q)}</span>`,rt=j?`<span class="badge project-focus-card__badge bg-primary">${c(j)}</span>`:"",$=A?`<span class="project-focus-card__meta-tag">${c(A)}</span>`:"",D=`<span class="project-focus-card__status-chip ${U}">${c(R)}</span>`,it=`<span class="reservation-chip ${g} project-focus-card__payment-chip">${c(b)}</span>`,vt=(_,H,z)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${_?`<span class="project-focus-card__row-icon">${c(_)}</span>`:""}
        ${c(H)}
      </span>
      <span class="project-focus-card__row-value">${c(String(z))}</span>
    </div>
  `,ye=[{icon:"👤",label:r("projects.details.client","العميل"),value:a},o?{icon:"🏢",label:r("projects.details.company","شركة العميل"),value:o}:null,{icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:j},{icon:"📅",label:r("projects.focus.summary.range","الفترة الزمنية"),value:Bt(t.start,t.end)}].filter(Boolean).map(({icon:_,label:H,value:z})=>vt(_,H,z)).join(""),he=[{icon:"💳",label:r("projectCards.stats.paymentStatus","حالة الدفع"),value:b},{icon:"💸",label:r("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:B(p)},{icon:"🧮",label:r("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:B(st)}].map(({icon:_,label:H,value:z})=>vt(_,H,z)).join(""),Se=[{icon:"🔗",label:r("projectCards.stats.reservationsShort","الحجوزات"),value:f(String(u))},{icon:"📦",label:r("projectCards.stats.equipmentCount","عدد المعدات"),value:f(String(Y))},{icon:"😎",label:r("projectCards.stats.crewCount","عدد الطاقم"),value:f(String(O))},{icon:"💵",label:r("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:B(Z)}].map(({icon:_,label:H,value:z})=>vt(_,H,z)).join(""),Te=L?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${c(r("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${w}">${c(r("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`,xe=r("projects.focus.actions.highlight","🔍 عرض في القائمة"),$e=r("projects.focus.actions.view","👁️ عرض التفاصيل");return`
    <div class="col-12 col-md-6 col-xl-4">
      <article class="project-focus-card ${T.filter(Boolean).join(" ")}" data-project-id="${w}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${ot}
          ${rt}
          ${$}
          ${D}
          ${it}
        </div>
        <h6 class="project-focus-card__title">${c(N)}</h6>
        <p class="project-focus-card__description">${c(m)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${c(r("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${ye}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${c(r("projects.focus.summary.payment","الجانب المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${he}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${c(r("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${Se}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions">
          ${Te}
          <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${w}">${c(xe)}</button>
          <button class="btn btn-sm btn-primary" data-action="view" data-id="${w}">${c($e)}</button>
        </div>
      </article>
    </div>
  `}function Ht(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function an(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const o=a.getDay(),i=o===0?6:o-1;a.setDate(a.getDate()-i);const l=new Date(a);return l.setDate(l.getDate()+7),e>=a&&e<l}function Lt(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function oe(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function ct(t){const e=Number(t?.equipmentEstimate)||0,n=oe(t),a=e+n,o=Number(a.toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true";let l=i?Number(t?.taxAmount):0;i?(!Number.isFinite(l)||l<0)&&(l=Number((o*pt).toFixed(2))):l=0;let u=i?Number(t?.totalWithTax):o;return i?(!Number.isFinite(u)||u<=0)&&(u=Number((o+l).toFixed(2))):u=o,{equipmentEstimate:e,expensesTotal:n,subtotal:o,applyTax:i,taxAmount:l,totalWithTax:u}}function K(){const t=d.projects.length,e=d.projects.filter(o=>{const i=o.start?new Date(o.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=d.projects.reduce((o,i)=>o+ct(i).expensesTotal,0),a=d.projects.reduce((o,i)=>o+ct(i).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=f(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=f(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=B(n)),s.projectsBudget&&(s.projectsBudget.textContent=B(a))}function bt(t){return t?d.reservations.filter(e=>String(e.projectId)===String(t)):[]}function re(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(f(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Xt(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(f(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function on(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,o=t.status||t.state||"pending",i=r(`reservations.status.${o}`,o),l=String(o).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[l]||"project-reservation-card__badge--info",h=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",x=h?r("reservations.details.paid","مدفوع"):r("reservations.details.unpaid","غير مدفوع"),y=h?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",m=t.completed===!0||t.completed==="true",j=r("reservations.details.completed","مكتمل"),S=m?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${c(j)}</span>`:"",b=Bt(t.start,t.end),g=re(t),E=B(g),L=r("projects.details.reservations.items","{count} عناصر").replace("{count}",f(String((t.items||[]).length))),w=r("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",f(String((t.technicians||[]).length))),C=r("projects.details.reservations.view","👁️ عرض الحجز");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${c(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${c(i)}</span>
          <span class="project-reservation-card__badge ${y}">${c(x)}</span>
          ${S}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${c(b)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${c(E)}</span>
          <span>📦 ${c(L)}</span>
          <span>😎 ${c(w)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${c(C)}</button>
      </div>
    </article>
  `}function rn(t){const e=bt(t.id).map(b=>({reservation:b,index:d.reservations.findIndex(g=>g===b)})).filter(({index:b})=>Number.isInteger(b)&&b>=0).sort((b,g)=>{const E=b.reservation.start?new Date(b.reservation.start).getTime():0;return(g.reservation.start?new Date(g.reservation.start).getTime():0)-E}),n=r("projects.details.reservations.title","الحجوزات المرتبطة"),a=r("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),o=r("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=r("projects.details.reservations.count","{count} حجوزات"),l=e.length?`<span class="badge project-reservations-count">${c(i.replace("{count}",f(String(e.length))))}</span>`:"",u=e.length>0,p=c(String(t.id)),h=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&h.push("disabled",'aria-disabled="true"');const x=`<button ${h.join(" ")}>${c(a)}</button>`,y=r("projects.details.actions.edit","✏️ تعديل المشروع"),m=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${c(y)}</button>`,j=`<div class="d-flex flex-wrap gap-2">${x}${m}</div>`,S=e.length?`<div class="project-reservations-list">${e.map(({reservation:b,index:g})=>on(b,g,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${c(o)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${c(n)}</h6>
          ${l}
        </div>
        ${j}
      </div>
      ${S}
    </section>
  `}let Ot=null;function cn(t){t&&ie()!==t&&Ct({[It]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function ie(){return Gt()?.[It]||""}function ce(t){t&&$t()!==t&&Ct({[At]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function $t(){return Gt()?.[At]||""}function dn(t){if(!t)return"";const e=t.trim();return e?Object.values(Nt).includes(e)?e:Nt[e]||"":""}function ln(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=dn(e);if(n)return n}}catch{}return""}function de(t,e){!t||!s.tabPanes||!s.tabButtons||(s.tabButtons.forEach(n=>{n===e?n.classList.add("active"):n.classList.remove("active")}),s.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&cn(t))}function un(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const o=n.dataset.tabTarget;o&&(de(o,n),o==="projects-section"&&(d.filters.search="",s.search&&(s.search.value=""),k(),J(),K()))}),n.dataset.tabListenerAttached="true")});const t=ie(),e=t&&s.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function _t(t,e){!t||!s.projectSubTabButtons||!s.projectSubTabPanes||(s.projectSubTabButtons.forEach(n=>{n===e?n.classList.add("active"):n.classList.remove("active")}),s.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function pn(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||(s.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(_t(n,t),ce(n))}),t.dataset.tabListenerAttached="true")}),mn())}function mn(){const e=ln()||$t();if(!e)return;const n=s.projectSubTabButtons?.[0],a=s.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===e)||n,o=a?.dataset.projectSubtabTarget;o&&(e!==$t()&&ce(o),_t(o,a))}function fn(){return s.tabButtons?s.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Vt(t={}){if(t){if(s.tabButtons&&s.tabButtons.length){const n=s.tabButtons.find(o=>o.classList.contains("active"))?.dataset.tabTarget||"",a=t[It];if(a&&a!==n){const o=s.tabButtons.find(i=>i.dataset.tabTarget===a);o&&de(a,o)}}if(s.projectSubTabButtons&&s.projectSubTabButtons.length&&fn()){const n=s.projectSubTabButtons.find(o=>o.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=t[At];if(a&&a!==n){const o=s.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===a);o&&_t(a,o)}}}}function bn(){Ot||(Ot=Ae(t=>{Vt(t)})),Be().then(t=>{Vt(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function gn(){if(!Array.isArray(d.projects)||d.projects.length===0)return;let t=!1;const e=d.projects.map(n=>{if(n.projectCode)return n;const a=Qt();return t=!0,{...n,projectCode:a}});t&&(d.projects=e)}function jn(){const{customers:t,technicians:e,equipment:n}=lt();d.customers=Array.isArray(t)?t:[],d.technicians=Array.isArray(e)?e:[],d.equipment=Array.isArray(n)?n:[],d.reservations=W(),d.projects=ut(),gn()}function gt(){if(le(),s.technicianSelect){const t=s.technicianSelect.value,e=c(r("projects.form.selectTechnician","اختر عضو الطاقم"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+d.technicians.map(n=>{const a=r("projects.fallback.technicianName","عضو {id}"),o=n.name||a.replace("{id}",f(String(n.id||"")));return`<option value="${n.id}">${c(o)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=c(r("projects.form.selectEquipment","اختر المعدة"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+d.equipment.map(n=>{const a=n.desc||n.description||n.name||r("projects.fallback.unknownEquipment","معدة");return`<option value="${c(n.barcode||"")}">${c(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function et(t){if(!s.clientCompany)return;const e=t?.companyName||t?.company||"";s.clientCompany.value=e}function le(){if(!s.client)return;vn();const t=s.client.dataset?.customerId;if(t){const e=d.customers.find(n=>String(n.id)===String(t));e?et(e):(s.client.dataset.customerId="",et(null))}else et(null);document.activeElement===s.client&&Et()}function vn(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",Et(),et(null)}),s.client.addEventListener("focus",()=>{Et()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>dt(),150)}),s.client.dataset.autocompleteAttached="true")}function dt(){s.clientSuggestions&&(s.clientSuggestions.style.display="none",s.clientSuggestions.innerHTML="")}function Et(){if(!s.client||!s.clientSuggestions)return;const t=yn(),e=at(s.client.value||""),n=e?t.filter(a=>{const o=at(a.name).includes(e),i=at(a.company||"").includes(e);return o||i}).slice(0,10):t.slice(0,10);if(!n.length){dt();return}s.clientSuggestions.innerHTML=n.map(a=>{const o=a.company?`<div class="suggestion-item__meta">${c(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${c(String(a.id))}" data-name="${c(a.name)}" data-company="${c(a.company||"")}">
          <div class="suggestion-item__primary">${c(a.name)}</div>
          ${o}
        </div>
      `}).join(""),s.clientSuggestions.style.display="block",s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",o=>{o.preventDefault();const{id:i,name:l}=o.currentTarget.dataset;s.client&&(s.client.value=l||"",s.client.dataset.customerId=i||"");const u=o.currentTarget.dataset.company||"";et({companyName:u}),dt()})})}function yn(){return Array.isArray(d.customers)?d.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function hn(t,e=""){if(!Array.isArray(d.customers)||d.customers.length===0)return null;if(e){const o=d.customers.find(i=>String(i.id)===String(e));if(o)return o}const n=at(t||"");if(!n)return null;const a=d.customers.find(o=>at(o.customerName||o.name||"")===n);return a||d.customers.find(o=>at(o.customerName||o.name||"").includes(n))||null}async function Sn(t){if(d.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(r("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await Fe(t),await Zt(),await Re(),d.projects=ut(),d.reservations=W(),k(),K(),J(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),v(r("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=mt(n)?n.message:r("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");v(a,"error")}}async function Tn(t,e){if(!t)return!1;const a=W().filter(u=>String(u.projectId)===String(t));if(!a.length)return!1;const o=e==="paid",i=o?"paid":"unpaid";let l=!1;for(const u of a){const p=u.id??u.reservationId;if(!p)continue;const h=u.paid===!0||u.paid==="paid",x=u.paidStatus||u.paymentStatus||(h?"paid":"unpaid");h===o&&x===i||(await te(p,{paid_status:i,paid:o}),l=!0)}return l&&(d.reservations=W()),l}async function xn(t){if(!t)return!1;const e=W(),n=d.projects.find(i=>String(i.id)===String(t))||(lt().projects||[]).find?.(i=>String(i.id)===String(t))||null,a=e.filter(i=>String(i.projectId)===String(t));if(!a.length)return!1;let o=!1;for(const i of a){const l=i.id??i.reservationId;if(!l)continue;const u=Ue({...i,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await te(l,{confirmed:!0,status:p}),o=!0}return o&&(d.reservations=W()),o}async function wt(t,e){if(!t)return!1;const n=await Tn(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let ht=!1;function $n(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",Fn),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),dt(),ne(),s.type&&(s.type.value=""),et(null),ue()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{d.filters.search=f(s.search.value||"").trim().toLowerCase(),k()}),s.search.dataset.listenerAttached="true")}function ue(){ze(),d.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),X(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),jt()}function En(){s.addTechnicianBtn&&s.addTechnicianBtn.dataset.listenerAttached!=="true"&&(s.addTechnicianBtn.addEventListener("click",Ln),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&s.addEquipmentBtn.dataset.listenerAttached!=="true"&&(s.addEquipmentBtn.addEventListener("click",_n),s.addEquipmentBtn.dataset.listenerAttached="true")}function wn(){St(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;d.selectedTechnicians=d.selectedTechnicians.filter(n=>n!==e),pe()}}),St(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;d.selectedEquipment=d.selectedEquipment.filter(n=>n.barcode!==e),me()}}),St(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;d.expenses=d.expenses.filter(n=>String(n.id)!==String(e)),fe(),K()}})}function Cn(){s.addExpenseBtn&&s.addExpenseBtn.dataset.listenerAttached!=="true"&&(s.addExpenseBtn.addEventListener("click",Dn),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&s.expenseAmount.dataset.normalizeAttached!=="true"&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=f(e.value||"");if(e.value=a,n!=null){const o=Math.min(a.length,n);e.setSelectionRange(o,o)}}),s.expenseAmount.dataset.normalizeAttached="true")}function St(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function Pn({onViewDetails:t}){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached==="true"||(s.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;t?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!Yt()){Le();return}const a=n.dataset.id;Sn(a)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function In(){const{customers:t}=lt();d.customers=Array.isArray(t)?t:[],X(),k(),J()}function An(){const{technicians:t}=lt();d.technicians=Array.isArray(t)?t:[],X(),k(),J()}function Bn(t){const{reservations:e}=lt();d.reservations=Array.isArray(e)?e:[],k();const n=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),a=s.detailsBody?.dataset.projectId;n&&a&&d.projects.find(i=>String(i.id)===String(a))&&t?.(a)}function Ln(){const t=s.technicianSelect?.value;if(!t){v(r("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(d.selectedTechnicians.includes(t)){v(r("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}d.selectedTechnicians.push(t),X(),v(r("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function _n(){const t=s.equipmentSelect?.value;if(!t){v(r("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(s.equipmentQty?.value||"1",10)||1),n=d.selectedEquipment.find(a=>a.barcode===t);n?n.qty+=e:d.selectedEquipment.push({barcode:t,qty:e}),X(),v(r("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function Dn(){const t=(s.expenseLabel?.value||"").trim(),e=f(s.expenseAmount?.value||"0"),n=Number(e);if(!t){v(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){v(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}d.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=f(String(e))),X(),K()}function X(){pe(),me(),fe(),jt()}function pe(){s.technicianList&&Dt(s.technicianList,d.selectedTechnicians,t=>{const n=d.technicians.find(a=>String(a.id)===String(t))?.name||r("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${c(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${c(String(t))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function me(){s.equipmentList&&Dt(s.equipmentList,d.selectedEquipment,t=>{const e=d.equipment.find(o=>String(o.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||r("projects.fallback.unknownEquipment","معدة"),a=f(String(t.qty||1));return`
      <span class="chip">
        ${c(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${c(String(t.barcode))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function fe(){s.expenseList&&Dt(s.expenseList,d.expenses,t=>`
      <div class="expense-item">
        <span>${c(t.label)}</span>
        <span>${B(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${c(String(t.id))}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function Dt(t,e,n){if(t){if(!e||e.length===0){const a=c(Xe(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function jt(){if(!s.submitBtn)return;const t=!!d.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";s.submitBtn.textContent=r(e,n)}function qn(){return d.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function zt(t){return f(String(t||"")).trim().toLowerCase()}function Nn(){if(!Array.isArray(d.selectedEquipment)||d.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((d.equipment||[]).map(a=>[zt(a?.barcode),a])),e=[],n=[];return d.selectedEquipment.forEach(a=>{const o=zt(a?.barcode);if(!o){e.push(a?.barcode||"");return}const i=t.get(o);if(!i||i.id==null){e.push(a?.barcode||o);return}const l=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:i.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:n,missing:e}}function kn(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,a=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function Mn(){return d.selectedEquipment.reduce((t,e)=>{const n=d.equipment.find(o=>String(o.barcode||"")===String(e.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+a*(e.qty||1)},0)}async function Fn(t){if(t.preventDefault(),ht)return;const e=s.title?.value.trim(),n=s.type?.value||"",a=s.client?.value?.trim()||"",o=s.client?.dataset?.customerId||"",i=s.startDate?.value?.trim()||"",l=s.startTime?.value?.trim()||"";if(!e||!n||!i){v(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const u=hn(a,o);if(!u){v(r("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),s.client?.focus();return}const p=String(u.id);s.client&&(s.client.dataset.customerId=p,s.client.value=u.customerName||u.name||s.client.value),et(u);const h=s.endDate?.value?.trim()||"",x=s.endTime?.value?.trim()||"",y=Wt(i,l),m=h?Wt(h,x):"",j=new Date(y),S=m?new Date(m):null;if(S&&j>S){v(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}s.expenseAmount&&(s.expenseAmount.value=f(s.expenseAmount.value||""));const b=qn(),g=Mn(),E=s.taxCheckbox?.checked===!0,w=(s.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",C=g+b,q=E?Number((C*pt).toFixed(2)):0,V=Number((C+q).toFixed(2)),{items:M,missing:F}=Nn();if(F.length){v(r("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const A=!!d.editingProjectId,I=A?d.projects.find(T=>String(T.id)===String(d.editingProjectId)):null;if(A&&!I){v(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const R=u.companyName||u.company||"",U=s.description?.value.trim()||"",N=ee({projectCode:I?.projectCode||(A?null:Qt()),title:e,type:n,clientId:p,clientCompany:R,description:U,start:y,end:m||null,applyTax:E,paymentStatus:w,equipmentEstimate:g,expenses:d.expenses.map(T=>({id:T.id,label:T.label,amount:T.amount})),taxAmount:q,totalWithTax:V,confirmed:I?.confirmed??!1,technicians:d.selectedTechnicians,equipment:M});ht=!0;try{let T=I?.projectId??I?.id??null;if(A){const P=await Pt(T??d.editingProjectId,N);T=P?.projectId??P?.id??T,await wt(T,w),v(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const P=await He(N);T=P?.projectId??P?.id??null,await wt(T,w),v(r("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}d.editingProjectId=null,s.form.reset(),ue(),ne(),dt(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),d.projects=ut(),d.reservations=W(),k(),K(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(T){console.error("❌ [projects] handleSubmitProject failed",T);const P=mt(T)?T.message:r("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");v(P,"error")}finally{ht=!1}}function Wt(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),l=o.padStart(2,"0");return`${t}T${i}:${l}`}function nt(t){const e=d.projects.find($=>String($.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view",s.detailsBody.dataset.projectId=String(e.id);const n=d.customers.find($=>String($.id)===String(e.clientId)),a=je(e.type),i=e.description?.trim()||r("projects.fallback.noDescription","لا يوجد وصف"),l=n?.customerName||r("projects.fallback.unknownClient","عميل غير معروف"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${f(String(e.id))}`,h=f(p),x=bt(e.id),y=x.reduce(($,D)=>$+Kn(D),0),m=Number(y.toFixed(2)),j=x.length,{subtotal:S,applyTax:b,expensesTotal:g}=ct(e),E=S,L=b?Number(((E+m)*pt).toFixed(2)):0,w=Number((E+m+L).toFixed(2)),C=Lt(e),q=r(`projects.status.${C}`,se[C]||C),M={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[C]||"status-confirmed",F=b?r("projects.details.chips.vatOn","شامل الضريبة 15٪"):r("projects.details.chips.vatOff","غير شامل الضريبة"),A=b?"status-paid":"status-unpaid",I=r("projects.details.chips.reservations","{count} حجوزات").replace("{count}",f(String(j))),R=e.paymentStatus==="paid"?"paid":"unpaid",U=r(`projects.paymentStatus.${R}`,R==="paid"?"Paid":"Unpaid"),N=R==="paid"?"status-paid":"status-unpaid",T=r("projects.focus.confirmed","✅ مشروع مؤكد"),P=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${c(T)}</span>`:"",Y=[{icon:"💳",label:r("projects.details.summary.paymentStatus","حالة الدفع"),value:U},{icon:"💼",label:r("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:B(E)},{icon:"🔗",label:r("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:B(m)},{icon:"🧮",label:r("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:B(L)},{icon:"💰",label:r("projects.details.summary.overallTotal","الإجمالي الكلي"),value:B(w)}].map(({icon:$,label:D,value:it})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${$} ${c(D)}</span>
      <span class="summary-details-value">${c(it)}</span>
    </div>
  `).join(""),O=[];O.push({icon:"🆔",label:r("projects.details.labels.code","رقم المشروع"),value:`#${h}`}),O.push({icon:"👤",label:r("projects.details.client","العميل"),value:l}),u&&O.push({icon:"🏢",label:r("projects.details.company","شركة العميل"),value:u}),O.push({icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:a}),O.push({icon:"📅",label:r("projects.details.range","الفترة الزمنية"),value:Ze(e.start,e.end)});const tt=O.map(({icon:$,label:D,value:it})=>`
    <div class="project-info-row">
      <span>${$} ${c(D)}</span>
      <span>${c(it)}</span>
    </div>
  `).join(""),st=[`<span class="reservation-chip ${M}">${c(q)}</span>`,`<span class="reservation-chip ${A}">${c(F)}</span>`,`<span class="reservation-chip status-info">${c(I)}</span>`,`<span class="reservation-chip ${N}">${c(U)}</span>`,P].filter(Boolean).join(""),ot=r("projects.details.expensesTotal","إجمالي المصاريف"),rt=r("projects.details.reservationsTotal","إجمالي الحجوزات");s.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${c(e.title)}</h4>
          <div class="project-details-chips">${st}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${c(r("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${tt}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${c(r("projects.details.summary.title","ملخص مالي"))}</h6>
            ${Y}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${c(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${c(r("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${c(ot)}</span>
          <strong>${B(g)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${c(rt)}</span>
          <strong>${B(m)}</strong>
        </div>
      </div>
    </section>
    ${rn(e)}
  `,Hn(e),s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function Rn({onOpenProject:t}){!s.focusCards||s.focusCards.dataset.listenerAttached==="true"||(s.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:o,id:i}=n.dataset;if(o==="confirm-project"){e.preventDefault(),e.stopPropagation(),zn(i);return}o==="view"?t?.(i):o==="highlight"&&Un(i);return}const a=e.target.closest(".project-focus-card");a?.dataset.projectId&&t?.(a.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function Un(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){v(r("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function Hn(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]'),n=s.detailsBody.querySelector('[data-action="edit-project"]'),a=s.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",o=>{o.preventDefault(),Vn(t)}),n&&t&&n.addEventListener("click",o=>{o.preventDefault(),be(t)}),a&&a.addEventListener("click",o=>{const i=o.target.closest('[data-action="view-reservation"]');if(!i)return;const l=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(l)||l<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(l):window.location.href="dashboard.html#reservations")})}function be(t){if(!t||!s.detailsBody)return;const e=d.projects.find(i=>String(i.id)===String(t.id));if(!e)return;const n=d.customers.find(i=>String(i.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const o={expenses:Array.isArray(e.expenses)?e.expenses.map((i,l)=>({id:i?.id||`expense-${e.id}-${l}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=Wn(e,o),On(e,o)}function On(t,e={expenses:[]}){const n=s.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",j=>{j.preventDefault(),nt(t.id)});const o=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),l=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),h=n.querySelector('[name="project-start-time"]'),x=n.querySelector('[name="project-end-date"]'),y=n.querySelector('[name="project-end-time"]');function m(){u&&(u.innerHTML=ge(e.expenses))}m(),l&&l.addEventListener("click",j=>{j.preventDefault();const S=o?.value.trim()||"",b=f(i?.value||"0"),g=Number(b);if(!S){v(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),o?.focus();return}if(!Number.isFinite(g)||g<=0){v(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),i?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:S,amount:g}),o&&(o.value=""),i&&(i.value=""),m()}),u&&u.addEventListener("click",j=>{const S=j.target.closest('[data-action="remove-expense"]');if(!S)return;const{id:b}=S.dataset;e.expenses=e.expenses.filter(g=>String(g.id)!==String(b)),m()}),n.addEventListener("submit",async j=>{if(j.preventDefault(),n.dataset.submitting==="true")return;const S=n.querySelector('[name="project-title"]'),b=n.querySelector('[name="project-type"]'),g=n.querySelector('[name="project-description"]'),E=n.querySelector('[name="project-payment-status"]'),L=n.querySelector('[name="project-apply-tax"]'),w=S?.value.trim()||"",C=b?.value||"",q=p?.value.trim()||"",V=h?.value.trim()||"",M=g?.value.trim()||"",F=E?.value==="paid"?"paid":"unpaid",A=L?.checked===!0;if(!w||!C||!q){v(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),S?.focus();return}const I=x?.value.trim()||"",R=y?.value.trim()||"",U=Ft(q,V),N=I?Ft(I,R):"",T=new Date(U),P=N?new Date(N):null;if(P&&T>P){v(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),x?.focus();return}if(d.projects.findIndex($=>String($.id)===String(t.id))===-1){v(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const Y=Number(t.equipmentEstimate)||0,O=e.expenses.reduce(($,D)=>$+(Number(D.amount)||0),0),tt=Y+O,st=A?Number((tt*pt).toFixed(2)):0,ot=A?Number((tt+st).toFixed(2)):tt,rt=ee({projectCode:t.projectCode,title:w,type:C,clientId:t.clientId,clientCompany:t.clientCompany,description:M,start:U,end:N||null,applyTax:A,paymentStatus:F,equipmentEstimate:Y,expenses:e.expenses,taxAmount:st,totalWithTax:ot,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:kn(t)});n.dataset.submitting="true";try{const $=await Pt(t.projectId??t.id,rt),D=$?.projectId??$?.id??t.id;await wt(D,F),d.projects=ut(),d.reservations=W(),v(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),k(),J(),K(),nt(t.id)}catch($){console.error("❌ [projects] Failed to update project from details view",$);const D=mt($)?$.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");v(D,"error")}finally{delete n.dataset.submitting}})}function Vn(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};Ct({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(o=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",o)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(o){console.warn("⚠️ [projects] Unable to encode reservation context",o)}s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function zn(t){if(!t)return;const e=d.projects.find(n=>String(n.id)===String(t));if(!e){v(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(e.confirmed===!0||e.confirmed==="true"){v(r("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await Pt(e.projectId??e.id,{confirmed:!0});const n=await xn(t);d.projects=ut(),d.reservations=W(),k(),J(),K(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&s.detailsBody?.dataset.projectId===String(t)&&nt(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),v(r("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=mt(n)?n.message:r("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");v(a,"error")}}function Wn(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=Rt(t.start||""),{date:o,time:i}=Rt(t.end||""),l=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${c(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${Jn(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${c(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${c(a)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${c(o)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${c(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${c(r("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${c(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(r("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${c(r("projects.paymentStatus.unpaid","قيد الانتظار"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${c(r("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${l?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${c(r("projects.form.labels.applyTax","تطبيق الضريبة 15٪"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${c(r("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${c(r("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${c(r("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${c(r("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${ge(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${c(r("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${c(r("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function Jn(t){return["commercial","coverage","photography","social"].map(n=>{const a=je(n),o=n===t?"selected":"";return`<option value="${c(n)}" ${o}>${c(a)}</option>`}).join("")}function ge(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${c(r("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=c(r("actions.remove","إزالة"));return t.map(n=>{const a=c(n?.label||""),o=c(B(n?.amount||0)),i=c(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${o}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function je(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function Kn(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(f(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=Xt(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(f(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function ve(t){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(t);if(a)return a}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const a=new URLSearchParams(e).get(t);if(a)return a}catch{}return null}function Yn(){return ve(Tt)}function Gn(){return ve(xt)}function Qn(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[Tt,xt].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let a=e,o=!1;if(e)try{const p=new URLSearchParams(e);let h=!1;[Tt,xt].forEach(x=>{p.has(x)&&(p.delete(x),h=!0)}),h&&(a=p.toString(),o=!0)}catch{}if(!n&&!o)return;const i=window.location.pathname,l=t.toString(),u=`${i}${l?`?${l}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",u)}catch{}}function Xn(){const t=Yn(),e=Gn();t&&(d.pendingProjectDetailId=t),e&&(d.pendingProjectEditId=e,d.pendingProjectDetailId||(d.pendingProjectDetailId=e)),(t||e)&&Qn()}function Zn(){if(!d.pendingProjectDetailId)return;const t=d.pendingProjectDetailId,e=String(t),n=d.projects.find(o=>[o?.id,o?.projectId,o?.project_id].some(l=>l!=null&&String(l)===e));if(!n)return;d.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??e;if(nt(a),d.pendingProjectEditId!=null){const o=String(d.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(l=>l!=null&&String(l)===o)&&(d.pendingProjectEditId=null,setTimeout(()=>be(n),0))}}function ts(){document.addEventListener("DOMContentLoaded",()=>{bn(),Xn(),Je(),jt(),Ke(),un(),pn(),Ye(),$n(),En(),wn(),Cn(),Pn({onViewDetails:nt}),Rn({onOpenProject:nt}),le(),es()}),document.addEventListener("language:changed",Jt),document.addEventListener("language:translationsReady",Jt),document.addEventListener("customers:changed",ns),document.addEventListener("technicians:updated",ss),document.addEventListener("reservations:changed",()=>Bn(nt)),document.addEventListener(_e.USER_UPDATED,()=>{k()})}async function es(){try{await Oe({suppressError:!0}),await Zt()}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||r("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");v(e,"error")}finally{jn(),gt(),X(),k(),K(),J(),Zn()}}function Jt(){gt(),X(),k(),K(),J(),jt()}function ns(){In(),gt()}function ss(){An(),gt()}De();qe();Ne();Ve();ts();document.addEventListener("DOMContentLoaded",()=>{Me(),ke()});
