import{l as cn,n as y,e as pt,t as o,j as je,r as ln,q as dn,p as Se,u as $t,d as lt,y as Te,h as T,o as un,f as pn,a as mn,m as fn,c as gn,i as hn,k as ae}from"./auth.js";/* empty css     */import{i as bn}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{h as zt,g as Y,a as Vt,u as Wt}from"./reservationsService.js";import{n as ut,B as mt,C as yn,D as Kt,E as ft,r as vn,h as we,j as Jt,F as jn,e as xe,o as Sn,k as Tn}from"./controller.js";const c={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},a={};function wn(){c.selectedTechnicians=[],c.selectedEquipment=[],c.expenses=[]}function xn(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function En(){a.form=document.getElementById("project-form"),a.title=document.getElementById("project-title"),a.type=document.getElementById("project-type"),a.client=document.getElementById("project-client"),a.clientSuggestions=document.getElementById("project-customer-suggestions"),a.clientCompany=document.getElementById("project-client-company"),a.paymentStatus=document.getElementById("project-payment-status"),a.startDate=document.getElementById("project-start-date"),a.startTime=document.getElementById("project-start-time"),a.endDate=document.getElementById("project-end-date"),a.endTime=document.getElementById("project-end-time"),a.description=document.getElementById("project-description"),a.technicianSelect=document.getElementById("project-technician-select"),a.addTechnicianBtn=document.getElementById("add-technician-btn"),a.technicianList=document.getElementById("project-technician-list"),a.equipmentSelect=document.getElementById("project-equipment-select"),a.equipmentQty=document.getElementById("project-equipment-qty"),a.addEquipmentBtn=document.getElementById("add-equipment-btn"),a.equipmentList=document.getElementById("project-equipment-list"),a.expenseLabel=document.getElementById("project-expense-label"),a.expenseAmount=document.getElementById("project-expense-amount"),a.addExpenseBtn=document.getElementById("add-expense-btn"),a.expenseList=document.getElementById("project-expense-list"),a.taxCheckbox=document.getElementById("project-tax"),a.linkedReservationBtn=document.getElementById("project-linked-reservation-btn"),a.submitBtn=a.form?.querySelector('[type="submit"]'),a.projectsTableBody=document.getElementById("project-table-body"),a.projectsCount=document.getElementById("projects-count"),a.projectsUpcoming=document.getElementById("projects-upcoming"),a.projectsExpenses=document.getElementById("projects-expenses"),a.projectsBudget=document.getElementById("projects-budget"),a.tableCount=document.getElementById("project-table-count"),a.search=document.getElementById("project-search"),a.detailsModalEl=document.getElementById("projectDetailsModal"),a.detailsBody=document.getElementById("project-details-body"),a.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),a.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),a.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),a.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),a.timeline=document.getElementById("project-timeline"),a.focusCards=document.getElementById("project-focus-cards"),a.detailsModalEl&&!a.detailsModalEl.dataset.projectListenerAttached&&(a.detailsModalEl.addEventListener("hidden.bs.modal",()=>{a.detailsBody&&(a.detailsBody.dataset.projectId="")}),a.detailsModalEl.dataset.projectListenerAttached="true")}function $n(){const t=xn();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([s,r])=>{document.querySelector(s)&&t(s,r)})}function Ee(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=a[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function Cn(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>cn()),t.dataset.listenerAttached="true")}const Mt="project",qt="editProject",se=3600*1e3,St=.15,kt=6,Yt="projectsTab",Gt="projectsSubTab",re={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},$e={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},An={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function d(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function L(t){const e=Number(t)||0,s=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(s,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function at(t){if(!t)return"â€”";const e=new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),l=e.getHours(),u=l>=12?"PM":"AM",p=l%12||12,f=String(p).padStart(2,"0"),g=`${n}/${s}/${r} ${f}:${i} ${u}`;return y(g)}function Dn(t){const e=pt(),n=y(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} Ù…Ø´Ø±ÙˆØ¹`}function oe(t){a.tableCount&&(a.tableCount.dataset.count=String(t),a.tableCount.textContent=Dn(t))}function In(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?o(e,n):n}function nt(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function ie(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=nt(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function ce(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[s="00",r="00"]=n.split(":"),i=s.padStart(2,"0"),l=r.padStart(2,"0");return`${t}T${i}:${l}`}function Ce(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}â€¦`}function Pn(t,e){if(!t)return"â€”";const n=at(t);return e?`${n} - ${at(e)}`:n}function le(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,s=""]=e.split("T");return{date:n,time:s}}function Ct(t){if(!t)return o("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return o(e,t)}function H(){if(!a.projectsTableBody)return;const t=c.filters.search,e=c.projects.filter(s=>{if(!t)return!0;const r=c.customers.find(l=>String(l.id)===String(s.clientId));return y([s.title,s.description,r?.customerName,s.clientCompany,Ct(s.type),s.id,s.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const s=c.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",r=c.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",i=d(o(s,r));a.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,oe(0),c.visibleProjects=[],de([]);return}const n=[...e].sort((s,r)=>new Date(r.start||0)-new Date(s.start||0));c.visibleProjects=n,oe(n.length),a.projectsTableBody.innerHTML=n.map(s=>Ln(s)).join(""),de(n),Z()}function Ln(t){const e=c.customers.find(A=>String(A.id)===String(t.clientId)),n=e?.customerName||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),s=(t.clientCompany||e?.companyName||"").trim(),r=t.technicians?.length||0,i=(t.equipment||[]).reduce((A,D)=>A+(D.qty||0),0),{expensesTotal:l,totalWithTax:u}=vt(t),f=At(t.id).length,b=o("projects.table.reservationsCount","{count} Ø­Ø¬ÙˆØ²Ø§Øª").replace("{count}",y(String(f))),h=f?`<span class="badge rounded-pill project-reservations-chip">${d(b)}</span>`:"",w=`<span class="badge project-type-badge">${d(Ct(t.type))}</span>`,v=t.projectCode||`PRJ-${y(String(t.id))}`,S=`<span class="project-code-badge">#${d(v)}</span>`,B=je()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${d(o("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${d(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${S}
            ${w}
          </div>
        </div>
        ${h}
      </td>
      <td>
        ${s?`<div class="d-flex flex-column"><span>${d(n)}</span><small class="text-muted">${d(s)}</small></div>`:d(n)}
      </td>
      <td>${Xt(t.start,t.end)}</td>
      <td>${y(String(r))}</td>
      <td>${y(String(i))}</td>
      <td>${L(u)}</td>
      <td>${L(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${d(o("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${B}
      </td>
    </tr>
  `}function Xt(t,e){if(!t)return"â€”";const n=at(t);return e?`${n} - ${at(e)}`:n}function de(t){if(!a.timeline)return;const n=(Array.isArray(t)?t:c.visibleProjects.length?c.visibleProjects:c.projects).map(b=>{if(!b?.start)return null;const h=new Date(b.start);if(Number.isNaN(h.getTime()))return null;let j=b.end?new Date(b.end):new Date(h);return Number.isNaN(j.getTime())&&(j=new Date(h)),j<=h&&(j=new Date(h.getTime()+se)),{project:b,startDate:h,endDate:j}}).filter(Boolean).sort((b,h)=>b.startDate-h.startDate);if(!n.length){const b=d(o("projects.timeline.empty",a.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));a.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${b}</div>`;return}const s=n[0].startDate.getTime(),r=Math.max(...n.map(b=>b.endDate.getTime()));let i=r-s;i<=0&&(i=se);const l=Bn(n),u=o("projects.timeline.range","{start} â†’ {end}"),p=o("projects.timeline.conflict","Scheduling conflict"),f=n.map(b=>{const{project:h,startDate:j,endDate:w}=b,v=w.getTime()-j.getTime();let S=(j.getTime()-s)/i*100;S=Math.max(0,Math.min(S,100));let $=v/i*100;$=Math.max($,2.5),S+$>100&&($=Math.max(1.5,100-S));const A=`project-timeline__item--${Qt(h)}`,D=l.has(h.id),F=(h.title||"").trim()||o("projects.fallback.untitled","Untitled project"),X=Ce(F,26),U=c.customers.find(et=>String(et.id)===String(h.clientId)),z=U?.customerName||o("projects.fallback.unknownClient","Unknown client"),P=(h.clientCompany||U?.companyName||"").trim(),I=Ct(h.type),V=at(j.toISOString()),W=at(w.toISOString()),O=u.replace("{start}",V).replace("{end}",W),E=P?`${z} (${P})`:z,N=`${F} â€¢ ${I} â€¢ ${E} | ${O}`,_=D?`<span class="project-timeline__item-conflict" title="${d(p)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${A}${D?" project-timeline__item--conflict":""}" style="left:${S}%;width:${$}%;" title="${d(N)}">
          <span class="project-timeline__item-label">${d(X)}</span>
          ${_}
        </div>
      `}).join(""),g=`
    <div class="project-timeline__scale">
      <span>${d(at(new Date(s).toISOString()))}</span>
      <span>${d(at(new Date(r).toISOString()))}</span>
    </div>
  `;a.timeline.innerHTML=`
    ${g}
    <div class="project-timeline__track">
      ${f}
    </div>
  `}function Bn(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let s=n+1;s<t.length;s+=1){const r=t[n],i=t[s];r.startDate<i.endDate&&i.startDate<r.endDate&&(e.add(r.project.id),e.add(i.project.id))}return e}function Z(){if(!a.focusCards)return;const t=kn();if(!t.length){const e=d(o("projects.focus.empty",a.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));a.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}a.focusCards.innerHTML=t.join("")}function kn(){if(!Array.isArray(c.projects)||!c.projects.length)return[];const t=c.projects.filter(ue),e=c.projects.filter(i=>!ue(i)&&_n(i)),n=[],s=new Set,r=(i,l)=>{!i||s.has(i.id)||n.length>=kt||(s.add(i.id),n.push(Nn(i,l)))};if(t.sort((i,l)=>nt(i)-nt(l)).forEach(i=>r(i,"today")),e.sort((i,l)=>nt(i)-nt(l)).forEach(i=>r(i,"thisWeek")),n.length<kt){const i=Date.now();[...c.projects].filter(u=>!s.has(u.id)).filter(u=>{const p=nt(u);return Number.isFinite(p)&&p>=i}).sort((u,p)=>nt(u)-nt(p)).forEach(u=>r(u,"upcoming"))}return n.length<kt&&[...c.projects].filter(l=>!s.has(l.id)).sort((l,u)=>ie(u)-ie(l)).forEach(l=>r(l,"recent")),n}function Nn(t,e){const n=c.customers.find(k=>String(k.id)===String(t.clientId)),s=n?.customerName||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),r=(t.clientCompany||n?.companyName||"").trim(),i=Array.isArray(t.technicians)?t.technicians.length:0,l=At(t.id),u=l.length,p=Ae(t),{subtotal:f,applyTax:g}=vt(t),b=(t.description||"").trim(),h=b?Ce(b,110):o("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),j=Ct(t.type),w=t.paymentStatus==="paid"?"paid":"unpaid",v=o(`projects.paymentStatus.${w}`,w==="paid"?"Paid":"Unpaid"),S=w==="paid"?"status-paid":"status-unpaid",$=w==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",B=t.confirmed===!0||t.confirmed==="true",A=d(String(t.id)),D=t.projectCode||`PRJ-${y(String(t.id))}`,F=y(D),X={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},U={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},z=X[e]||X.recent,P=o(z,U[e]||U.recent),I=Qt(t),V=o(`projects.status.${I}`,$e[I]||I),W=An[I]||"bg-secondary",O=(t.title||"").trim()||o("projects.fallback.untitled","Untitled project"),E=[$];B&&E.push("project-focus-card--confirmed");const N=l.reduce((k,K)=>{const Q=De(K),an=(K.items||[]).reduce((rn,on)=>rn+(Number(on?.qty)||1),0),sn=(K.technicians||[]).length;return{total:k.total+Q,equipment:k.equipment+an,crew:k.crew+sn}},{total:0,equipment:0,crew:0}),_=Number(N.total.toFixed(2)),et=N.equipment,G=N.crew||i,rt=g?Number(((f+_)*St).toFixed(2)):0,dt=Number((f+_+rt).toFixed(2)),gt=`<span class="project-code-badge project-focus-card__code">#${d(F)}</span>`,ht=j?`<span class="badge project-focus-card__badge bg-primary">${d(j)}</span>`:"",C=P?`<span class="project-focus-card__meta-tag">${d(P)}</span>`:"",M=`<span class="project-focus-card__status-chip ${W}">${d(V)}</span>`,bt=`<span class="reservation-chip ${S} project-focus-card__payment-chip">${d(v)}</span>`,Bt=(k,K,Q)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${k?`<span class="project-focus-card__row-icon">${d(k)}</span>`:""}
        ${d(K)}
      </span>
      <span class="project-focus-card__row-value">${d(String(Q))}</span>
    </div>
  `,Xe=[{icon:"ğŸ‘¤",label:o("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:s},r?{icon:"ğŸ¢",label:o("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:r}:null,{icon:"ğŸ·ï¸",label:o("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:j},{icon:"ğŸ“…",label:o("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Xt(t.start,t.end)}].filter(Boolean).map(({icon:k,label:K,value:Q})=>Bt(k,K,Q)).join(""),Qe=[{icon:"ğŸ’³",label:o("projectCards.stats.paymentStatus","Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),value:v},{icon:"ğŸ’¸",label:o("projectCards.stats.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"),value:L(p)},{icon:"ğŸ§®",label:o("projectCards.stats.totalWithTax","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),value:L(dt)}].map(({icon:k,label:K,value:Q})=>Bt(k,K,Q)).join(""),Ze=[{icon:"ğŸ”—",label:o("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:y(String(u))},{icon:"ğŸ“¦",label:o("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:y(String(et))},{icon:"ğŸ˜",label:o("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:y(String(G))},{icon:"ğŸ’µ",label:o("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:L(_)}].map(({icon:k,label:K,value:Q})=>Bt(k,K,Q)).join(""),tn=B?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${d(o("projects.focus.confirmed","âœ… Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒØ¯"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${A}">${d(o("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`,en=o("projects.focus.actions.highlight","ğŸ” Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),nn=o("projects.focus.actions.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„");return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${E.filter(Boolean).join(" ")}" data-project-id="${A}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${gt}
          ${ht}
          ${C}
          ${M}
          ${bt}
        </div>
        <h6 class="project-focus-card__title">${d(O)}</h6>
        <p class="project-focus-card__description">${d(h)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(o("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${Xe}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(o("projects.focus.summary.payment","Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${Qe}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(o("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${Ze}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions">
          ${tn}
          <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${A}">${d(en)}</button>
          <button class="btn btn-sm btn-primary" data-action="view" data-id="${A}">${d(nn)}</button>
        </div>
      </article>
    </div>
  `}function ue(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function _n(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,s=new Date(n);s.setHours(0,0,0,0);const r=s.getDay(),i=r===0?6:r-1;s.setDate(s.getDate()-i);const l=new Date(s);return l.setDate(l.getDate()+7),e>=s&&e<l}function Qt(t){const e=new Date,n=t.start?new Date(t.start):null,s=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":s&&!Number.isNaN(s.getTime())&&s<e?"completed":"ongoing"}function Ae(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function vt(t){const e=Number(t?.equipmentEstimate)||0,n=Ae(t),s=e+n,r=Number(s.toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true";let l=i?Number(t?.taxAmount):0;i?(!Number.isFinite(l)||l<0)&&(l=Number((r*St).toFixed(2))):l=0;let u=i?Number(t?.totalWithTax):r;return i?(!Number.isFinite(u)||u<=0)&&(u=Number((r+l).toFixed(2))):u=r,{equipmentEstimate:e,expensesTotal:n,subtotal:r,applyTax:i,taxAmount:l,totalWithTax:u}}function tt(){const t=c.projects.length,e=c.projects.filter(r=>{const i=r.start?new Date(r.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=c.projects.reduce((r,i)=>r+vt(i).expensesTotal,0),s=c.projects.reduce((r,i)=>r+vt(i).totalWithTax,0);a.projectsCount&&(a.projectsCount.textContent=y(String(t))),a.projectsUpcoming&&(a.projectsUpcoming.textContent=y(String(e))),a.projectsExpenses&&(a.projectsExpenses.textContent=L(n)),a.projectsBudget&&(a.projectsBudget.textContent=L(s))}function At(t){return t?c.reservations.filter(e=>String(e.projectId)===String(t)):[]}function De(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,s=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=zt(e,s,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Mn(t,e,n=null){if(!t)return"";const s=t.reservationId||t.id||`RES-${e+1}`,r=t.status||t.state||"pending",i=o(`reservations.status.${r}`,r),l=String(r).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[l]||"project-reservation-card__badge--info",f=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",g=f?o("reservations.details.paid","Ù…Ø¯ÙÙˆØ¹"):o("reservations.details.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),b=f?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",h=t.completed===!0||t.completed==="true",j=o("reservations.details.completed","Ù…ÙƒØªÙ…Ù„"),w=h?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${d(j)}</span>`:"",v=Xt(t.start,t.end),S=De(t),$=L(S),B=o("projects.details.reservations.items","{count} Ø¹Ù†Ø§ØµØ±").replace("{count}",y(String((t.items||[]).length))),A=o("projects.details.reservations.crew","{count} Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù…").replace("{count}",y(String((t.technicians||[]).length))),D=o("projects.details.reservations.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${d(s)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${d(i)}</span>
          <span class="project-reservation-card__badge ${b}">${d(g)}</span>
          ${w}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${d(v)}</div>
        <div class="project-reservation-card__meta">
          <span>ğŸ’µ ${d($)}</span>
          <span>ğŸ“¦ ${d(B)}</span>
          <span>ğŸ˜ ${d(A)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${d(D)}</button>
      </div>
    </article>
  `}function qn(t){const e=At(t.id).map(v=>({reservation:v,index:c.reservations.findIndex(S=>S===v)})).filter(({index:v})=>Number.isInteger(v)&&v>=0).sort((v,S)=>{const $=v.reservation.start?new Date(v.reservation.start).getTime():0;return(S.reservation.start?new Date(S.reservation.start).getTime():0)-$}),n=o("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),s=o("projects.details.reservations.create","â• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ù…Ø±ØªØ¨Ø·"),r=o("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),i=o("projects.details.reservations.count","{count} Ø­Ø¬ÙˆØ²Ø§Øª"),l=e.length?`<span class="badge project-reservations-count">${d(i.replace("{count}",y(String(e.length))))}</span>`:"",u=e.length>0,p=d(String(t.id)),f=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&f.push("disabled",'aria-disabled="true"');const g=`<button ${f.join(" ")}>${d(s)}</button>`,b=o("projects.details.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),h=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${d(b)}</button>`,j=`<div class="d-flex flex-wrap gap-2">${g}${h}</div>`,w=e.length?`<div class="project-reservations-list">${e.map(({reservation:v,index:S})=>Mn(v,S,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${d(r)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${d(n)}</h6>
          ${l}
        </div>
        ${j}
      </div>
      ${w}
    </section>
  `}let pe=null;function Rn(t){t&&Ie()!==t&&$t({[Yt]:t}).catch(e=>{console.warn("âš ï¸ [projects] Failed to persist projects main tab preference",e)})}function Ie(){return Se()?.[Yt]||""}function Pe(t){t&&Rt()!==t&&$t({[Gt]:t}).catch(e=>{console.warn("âš ï¸ [projects] Failed to persist projects sub-tab preference",e)})}function Rt(){return Se()?.[Gt]||""}function Fn(t){if(!t)return"";const e=t.trim();return e?Object.values(re).includes(e)?e:re[e]||"":""}function On(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=Fn(e);if(n)return n}}catch{}return""}function Le(t,e){!t||!a.tabPanes||!a.tabButtons||(a.tabButtons.forEach(n=>{const s=n===e;n.classList.toggle("active",s),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",s)}),a.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&Rn(t))}function Hn(){if(!a.tabButtons||!a.tabButtons.length)return;a.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",s=>{s.preventDefault();const r=n.dataset.tabTarget;r&&(Le(r,n),r==="projects-section"&&(c.filters.search="",a.search&&(a.search.value=""),H(),Z(),tt()))}),n.dataset.tabListenerAttached="true")});const t=Ie(),e=t&&a.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function Zt(t,e){!t||!a.projectSubTabButtons||!a.projectSubTabPanes||(a.projectSubTabButtons.forEach(n=>{const s=n===e;n.classList.toggle("active",s),n.classList.contains("tab")&&n.classList.toggle("tab-active",s)}),a.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function Un(){!a.projectSubTabButtons||!a.projectSubTabButtons.length||(a.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(Zt(n,t),Pe(n))}),t.dataset.tabListenerAttached="true")}),zn())}function zn(){const e=On()||Rt();if(!e)return;const n=a.projectSubTabButtons?.[0],s=a.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===e)||n,r=s?.dataset.projectSubtabTarget;r&&(e!==Rt()&&Pe(r),Zt(r,s))}function Vn(){return a.tabButtons?a.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function me(t={}){if(t){if(a.tabButtons&&a.tabButtons.length){const n=a.tabButtons.find(r=>r.classList.contains("active"))?.dataset.tabTarget||"",s=t[Yt];if(s&&s!==n){const r=a.tabButtons.find(i=>i.dataset.tabTarget===s);r&&Le(s,r)}}if(a.projectSubTabButtons&&a.projectSubTabButtons.length&&Vn()){const n=a.projectSubTabButtons.find(r=>r.classList.contains("active"))?.dataset.projectSubtabTarget||"",s=t[Gt];if(s&&s!==n){const r=a.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===s);r&&Zt(s,r)}}}}function Wn(){pe||(pe=ln(t=>{me(t)})),dn().then(t=>{me(t)}).catch(t=>{console.warn("âš ï¸ [projects] Failed to synchronise project preferences",t)})}function Kn(){if(!Array.isArray(c.projects)||c.projects.length===0)return;let t=!1;const e=c.projects.map(n=>{if(n.projectCode)return n;const s=Te();return t=!0,{...n,projectCode:s}});t&&(c.projects=e)}function Jn(){const{customers:t,technicians:e,equipment:n}=lt();c.customers=Array.isArray(t)?t:[],c.technicians=Array.isArray(e)?e:[],c.equipment=Array.isArray(n)?n:[],c.reservations=Y(),c.projects=mt(),Kn()}function Dt(){if(Be(),a.technicianSelect){const t=a.technicianSelect.value,e=d(o("projects.form.selectTechnician","Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));a.technicianSelect.innerHTML=`<option value="">${e}</option>`+c.technicians.map(n=>{const s=o("projects.fallback.technicianName","Ø¹Ø¶Ùˆ {id}"),r=n.name||s.replace("{id}",y(String(n.id||"")));return`<option value="${n.id}">${d(r)}</option>`}).join(""),t&&(a.technicianSelect.value=t)}if(a.equipmentSelect){const t=a.equipmentSelect.value,e=d(o("projects.form.selectEquipment","Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø¯Ø©"));a.equipmentSelect.innerHTML=`<option value="">${e}</option>`+c.equipment.map(n=>{const s=n.desc||n.description||n.name||o("projects.fallback.unknownEquipment","Ù…Ø¹Ø¯Ø©");return`<option value="${d(n.barcode||"")}">${d(s)}</option>`}).join(""),t&&(a.equipmentSelect.value=t)}}function ot(t){if(!a.clientCompany)return;const e=t?.companyName||t?.company||"";a.clientCompany.value=e}function Be(){if(!a.client)return;Yn();const t=a.client.dataset?.customerId;if(t){const e=c.customers.find(n=>String(n.id)===String(t));e?ot(e):(a.client.dataset.customerId="",ot(null))}else ot(null);document.activeElement===a.client&&Ft()}function Yn(){!a.client||!a.clientSuggestions||a.client.dataset.autocompleteAttached!=="true"&&(a.client.addEventListener("input",()=>{a.client.dataset.customerId="",Ft(),ot(null)}),a.client.addEventListener("focus",()=>{Ft()}),a.client.addEventListener("blur",()=>{window.setTimeout(()=>jt(),150)}),a.client.dataset.autocompleteAttached="true")}function jt(){a.clientSuggestions&&(a.clientSuggestions.classList.remove("is-visible"),a.clientSuggestions.hidden=!0,a.clientSuggestions.innerHTML="")}function Ft(){if(!a.client||!a.clientSuggestions)return;if(!Array.isArray(c.customers)||c.customers.length===0){const s=lt();Array.isArray(s?.customers)&&s.customers.length&&(c.customers=s.customers)}const t=Gn(),e=ut(a.client.value||""),n=e?t.filter(s=>{const r=ut(s.name).includes(e),i=ut(s.company||"").includes(e);return r||i}).slice(0,10):t.slice(0,10);if(!n.length){jt();return}a.clientSuggestions.innerHTML=n.map(s=>{const r=s.company?`<div class="suggestion-item__meta">${d(s.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${d(String(s.id))}" data-name="${d(s.name)}" data-company="${d(s.company||"")}">
          <div class="suggestion-item__primary">${d(s.name)}</div>
          ${r}
        </div>
      `}).join(""),a.clientSuggestions.hidden=!1,a.clientSuggestions.classList.add("is-visible"),a.clientSuggestions.scrollTop=0,a.clientSuggestions.querySelectorAll(".suggestion-item").forEach(s=>{s.addEventListener("mousedown",r=>{r.preventDefault();const{id:i,name:l}=r.currentTarget.dataset;a.client&&(a.client.value=l||"",a.client.dataset.customerId=i||"");const u=r.currentTarget.dataset.company||"";ot({companyName:u}),jt()})})}function Gn(){return Array.isArray(c.customers)?c.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function Xn(t,e=""){if(!Array.isArray(c.customers)||c.customers.length===0)return null;if(e){const r=c.customers.find(i=>String(i.id)===String(e));if(r)return r}const n=ut(t||"");if(!n)return null;const s=c.customers.find(r=>ut(r.customerName||r.name||"")===n);return s||c.customers.find(r=>ut(r.customerName||r.name||"").includes(n))||null}async function Qn(t){if(c.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(o("projects.confirm.delete","Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ")))try{await yn(t),await Kt(),await Vt(),c.projects=mt(),c.reservations=Y(),H(),tt(),Z(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),T(o("projects.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}catch(n){console.error("âŒ [projects] removeProject failed",n);const s=ft(n)?n.message:o("projects.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");T(s,"error")}}async function Zn(t,e){if(!t)return!1;const s=Y().filter(u=>String(u.projectId)===String(t));if(!s.length)return!1;const r=e==="paid",i=r?"paid":"unpaid";let l=!1;for(const u of s){const p=u.id??u.reservationId;if(!p)continue;const f=u.paid===!0||u.paid==="paid",g=u.paidStatus||u.paymentStatus||(f?"paid":"unpaid");f===r&&g===i||(await Wt(p,{paid_status:i,paid:r}),l=!0)}return l&&(c.reservations=Y()),l}async function ta(t){if(!t)return!1;const e=Y(),n=c.projects.find(i=>String(i.id)===String(t))||(lt().projects||[]).find?.(i=>String(i.id)===String(t))||null,s=e.filter(i=>String(i.projectId)===String(t));if(!s.length)return!1;let r=!1;for(const i of s){const l=i.id??i.reservationId;if(!l)continue;const u=vn({...i,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await Wt(l,{confirmed:!0,status:p}),r=!0}return r&&(c.reservations=Y()),r}async function Ot(t,e){if(!t)return!1;const n=await Zn(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let Nt=!1;const It="projects:create:draft",ea="projects.html#projects-section";function na(){a.form&&!a.form.dataset.listenerAttached&&(a.form.addEventListener("submit",ba),a.form.dataset.listenerAttached="true"),a.form&&!a.form.dataset.resetListenerAttached&&(a.form.addEventListener("reset",()=>{a.client&&(a.client.dataset.customerId=""),jt(),Ee(),a.type&&(a.type.value=""),ot(null),Re(),ke()}),a.form.dataset.resetListenerAttached="true"),a.search&&!a.search.dataset.listenerAttached&&(a.search.addEventListener("input",()=>{c.filters.search=y(a.search.value||"").trim().toLowerCase(),H()}),a.search.dataset.listenerAttached="true")}function ke(){wn(),c.editingProjectId=null,a.form&&(delete a.form.dataset.editingId,a.form.dataset.mode="create"),st(),a.expenseLabel&&(a.expenseLabel.value=""),a.expenseAmount&&(a.expenseAmount.value=""),a.taxCheckbox&&(a.taxCheckbox.checked=!1),a.paymentStatus&&(a.paymentStatus.value="unpaid"),Pt()}function aa(){a.addTechnicianBtn&&a.addTechnicianBtn.dataset.listenerAttached!=="true"&&(a.addTechnicianBtn.addEventListener("click",da),a.addTechnicianBtn.dataset.listenerAttached="true"),a.addEquipmentBtn&&a.addEquipmentBtn.dataset.listenerAttached!=="true"&&(a.addEquipmentBtn.addEventListener("click",ua),a.addEquipmentBtn.dataset.listenerAttached="true")}function sa(){_t(a.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;c.selectedTechnicians=c.selectedTechnicians.filter(n=>n!==e),Ne()}}),_t(a.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;c.selectedEquipment=c.selectedEquipment.filter(n=>n.barcode!==e),_e()}}),_t(a.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;c.expenses=c.expenses.filter(n=>String(n.id)!==String(e)),Me(),tt()}})}function ra(){a.addExpenseBtn&&a.addExpenseBtn.dataset.listenerAttached!=="true"&&(a.addExpenseBtn.addEventListener("click",pa),a.addExpenseBtn.dataset.listenerAttached="true"),a.expenseAmount&&a.expenseAmount.dataset.normalizeAttached!=="true"&&(a.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,s=y(e.value||"");if(e.value=s,n!=null){const r=Math.min(s.length,n);e.setSelectionRange(r,r)}}),a.expenseAmount.dataset.normalizeAttached="true")}function _t(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const s=n.target;s instanceof HTMLElement&&e(s)}),t.dataset.listenerAttached="true")}function oa({onViewDetails:t}){!a.projectsTableBody||a.projectsTableBody.dataset.listenerAttached==="true"||(a.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const s=n.dataset.id;t?.(s);return}if(n.matches('[data-action="delete-project"]')){if(!je()){un();return}const s=n.dataset.id;Qn(s)}}}),a.projectsTableBody.dataset.listenerAttached="true")}function ia(){const{customers:t}=lt();c.customers=Array.isArray(t)?t:[],st(),H(),Z()}function ca(){const{technicians:t}=lt();c.technicians=Array.isArray(t)?t:[],st(),H(),Z()}function la(t){const{reservations:e}=lt();c.reservations=Array.isArray(e)?e:[],H();const n=a.detailsModalEl&&a.detailsModalEl.classList.contains("show"),s=a.detailsBody?.dataset.projectId;n&&s&&c.projects.find(i=>String(i.id)===String(s))&&t?.(s)}function da(){const t=a.technicianSelect?.value;if(!t){T(o("projects.toast.selectTechnician","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}if(c.selectedTechnicians.includes(t)){T(o("projects.toast.technicianAlreadyAdded","âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„"));return}c.selectedTechnicians.push(t),st(),T(o("projects.toast.technicianAdded","âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))}function ua(){const t=a.equipmentSelect?.value;if(!t){T(o("projects.toast.selectEquipment","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø©"));return}const e=Math.max(1,parseInt(a.equipmentQty?.value||"1",10)||1),n=c.selectedEquipment.find(s=>s.barcode===t);n?n.qty+=e:c.selectedEquipment.push({barcode:t,qty:e}),st(),T(o("projects.toast.equipmentAdded","âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹"))}function pa(){const t=(a.expenseLabel?.value||"").trim(),e=y(a.expenseAmount?.value||"0"),n=Number(e);if(!t){T(o("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"));return}if(!Number.isFinite(n)||n<0){T(o("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­"));return}c.expenses.push({id:Date.now(),label:t,amount:n}),a.expenseLabel&&(a.expenseLabel.value=""),a.expenseAmount&&(a.expenseAmount.value=y(String(e))),st(),tt()}function st(){Ne(),_e(),Me(),Pt()}function Ne(){a.technicianList&&te(a.technicianList,c.selectedTechnicians,t=>{const n=c.technicians.find(s=>String(s.id)===String(t))?.name||o("projects.fallback.technicianName","Ø¹Ø¶Ùˆ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return`
      <span class="chip">
        ${d(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${d(String(t))}" aria-label="${d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"))}">âœ–</button>
      </span>
    `})}function _e(){a.equipmentList&&te(a.equipmentList,c.selectedEquipment,t=>{const e=c.equipment.find(r=>String(r.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||o("projects.fallback.unknownEquipment","Ù…Ø¹Ø¯Ø©"),s=y(String(t.qty||1));return`
      <span class="chip">
        ${d(n)} (x${s})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${d(String(t.barcode))}" aria-label="${d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"))}">âœ–</button>
      </span>
    `})}function Me(){a.expenseList&&te(a.expenseList,c.expenses,t=>`
      <div class="expense-item">
        <span>${d(t.label)}</span>
        <span>${L(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${d(String(t.id))}" aria-label="${d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"))}">âœ–</button>
      </div>
    `)}function te(t,e,n){if(t){if(!e||e.length===0){const s=d(In(t));t.innerHTML=`<span class="text-muted">${s}</span>`;return}t.innerHTML=e.map(s=>n(s)).join("")}}function Pt(){if(!a.submitBtn)return;const t=!!c.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹":"ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹";a.submitBtn.textContent=o(e,n)}function ma(){return c.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function fe(t){return y(String(t||"")).trim().toLowerCase()}function fa(){if(!Array.isArray(c.selectedEquipment)||c.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((c.equipment||[]).map(s=>[fe(s?.barcode),s])),e=[],n=[];return c.selectedEquipment.forEach(s=>{const r=fe(s?.barcode);if(!r){e.push(s?.barcode||"");return}const i=t.get(r);if(!i||i.id==null){e.push(s?.barcode||r);return}const l=Number.parseInt(String(s?.qty??0),10);n.push({equipmentId:i.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:n,missing:e}}function ga(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,s=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(s)&&s>0?s:1}:null}).filter(Boolean)}function ha(){return c.selectedEquipment.reduce((t,e)=>{const n=c.equipment.find(r=>String(r.barcode||"")===String(e.barcode)),s=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+s*(e.qty||1)},0)}async function ba(t){if(t.preventDefault(),Nt)return;const e=a.title?.value.trim(),n=a.type?.value||"",s=a.client?.value?.trim()||"",r=a.client?.dataset?.customerId||"",i=a.startDate?.value?.trim()||"",l=a.startTime?.value?.trim()||"";if(!e||!n||!i){T(o("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"));return}const u=Xn(s,r);if(!u){T(o("projects.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„")),a.client?.focus();return}const p=String(u.id);a.client&&(a.client.dataset.customerId=p,a.client.value=u.customerName||u.name||a.client.value),ot(u);const f=a.endDate?.value?.trim()||"",g=a.endTime?.value?.trim()||"",b=Et(i,l),h=f?Et(f,g):"",j=new Date(b),w=h?new Date(h):null;if(w&&j>w){T(o("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"));return}a.expenseAmount&&(a.expenseAmount.value=y(a.expenseAmount.value||""));const v=ma(),S=ha(),$=a.taxCheckbox?.checked===!0,A=(a.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",D=S+v,F=$?Number((D*St).toFixed(2)):0,X=Number((D+F).toFixed(2)),{items:U,missing:z}=fa();if(z.length){T(o("projects.toast.equipmentMissing","âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),"error");return}const P=!!c.editingProjectId,I=P?c.projects.find(E=>String(E.id)===String(c.editingProjectId)):null;if(P&&!I){T(o("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const V=u.companyName||u.company||"",W=a.description?.value.trim()||"",O=we({projectCode:I?.projectCode||(P?null:Te()),title:e,type:n,clientId:p,clientCompany:V,description:W,start:b,end:h||null,applyTax:$,paymentStatus:A,equipmentEstimate:S,expenses:c.expenses.map(E=>({id:E.id,label:E.label,amount:E.amount})),taxAmount:F,totalWithTax:X,confirmed:I?.confirmed??!1,technicians:c.selectedTechnicians,equipment:U});Nt=!0;try{let E=I?.projectId??I?.id??null;if(P){const _=await Jt(E??c.editingProjectId,O);E=_?.projectId??_?.id??E,await Ot(E,A),T(o("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­"))}else{const _=await jn(O);E=_?.projectId??_?.id??null,await Ot(E,A),T(o("projects.toast.saved","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­"))}await wa(E)||Re(),c.editingProjectId=null,a.form.reset(),ke(),Ee(),jt(),a.client&&(a.client.dataset.customerId=""),a.type&&(a.type.value=""),c.projects=mt(),c.reservations=Y(),H(),tt(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(E){console.error("âŒ [projects] handleSubmitProject failed",E);const N=ft(E)?E.message:o("projects.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");T(N,"error")}finally{Nt=!1}}function Et(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[s="00",r="00"]=n.split(":"),i=s.padStart(2,"0"),l=r.padStart(2,"0");return`${t}T${i}:${l}`}function ee(){if(typeof window>"u"||!window.sessionStorage)return null;const t=window.sessionStorage.getItem(It);if(!t)return null;try{const e=JSON.parse(t);return e&&typeof e=="object"?e:null}catch(e){return console.warn("âš ï¸ [projects] Failed to parse project form draft",e),null}}function qe(t){if(!(typeof window>"u"||!window.sessionStorage))try{window.sessionStorage.setItem(It,JSON.stringify(t))}catch(e){console.warn("âš ï¸ [projects] Unable to persist project form draft",e)}}function Re(){typeof window>"u"||!window.sessionStorage||window.sessionStorage.removeItem(It)}function ya(){const t=ee()||{};return{...t,type:a.type?.value||"",title:a.title?.value||"",client:a.client?.value||"",customerId:a.client?.dataset.customerId||"",clientCompany:a.clientCompany?.value||"",paymentStatus:a.paymentStatus?.value||"unpaid",taxChecked:a.taxCheckbox?.checked===!0,startDate:a.startDate?.value||"",startTime:a.startTime?.value||"",endDate:a.endDate?.value||"",endTime:a.endTime?.value||"",description:a.description?.value||"",expenses:Array.isArray(c.expenses)?c.expenses.map(e=>({...e})):[],technicians:Array.isArray(c.selectedTechnicians)?[...c.selectedTechnicians]:[],equipment:Array.isArray(c.selectedEquipment)?c.selectedEquipment.map(e=>({...e})):[],linkedReservationIds:Array.isArray(t.linkedReservationIds)?[...t.linkedReservationIds]:[],savedAt:Date.now()}}function va(){const t=ee();return t?(a.type&&(a.type.value=t.type||""),a.title&&(a.title.value=t.title||""),a.client&&(a.client.value=t.client||"",a.client.dataset.customerId=t.customerId||""),a.clientCompany&&(a.clientCompany.value=t.clientCompany||""),a.paymentStatus&&t.paymentStatus&&(a.paymentStatus.value=t.paymentStatus),a.taxCheckbox&&(a.taxCheckbox.checked=t.taxChecked===!0),a.startDate&&(a.startDate.value=t.startDate||""),a.startTime&&(a.startTime.value=t.startTime||""),a.endDate&&(a.endDate.value=t.endDate||""),a.endTime&&(a.endTime.value=t.endTime||""),a.description&&(a.description.value=t.description||""),c.expenses=Array.isArray(t.expenses)?t.expenses.map(e=>({...e})):[],c.selectedTechnicians=Array.isArray(t.technicians)?[...t.technicians]:[],c.selectedEquipment=Array.isArray(t.equipment)?t.equipment.map(e=>({...e})):[],!0):!1}function ja(){!a.linkedReservationBtn||a.linkedReservationBtn.dataset.listenerAttached==="true"||(a.linkedReservationBtn.addEventListener("click",Sa),a.linkedReservationBtn.dataset.listenerAttached="true")}function Sa(t){t.preventDefault();const e=ya();if(!(e.customerId&&e.customerId!==""||e.client&&e.client.trim())){T(o("projects.form.linkedReservation.missingClient","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));return}const s=e.startDate&&e.startTime,r=e.endDate&&e.endTime;if(!s||!r){T(o("projects.form.linkedReservation.missingSchedule","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));return}qe(e);const i=Ta(e);let l="";try{l=encodeURIComponent(JSON.stringify(i))}catch(p){console.warn("âš ï¸ [projects] Unable to encode reservation context",p)}$t({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(p=>{console.warn("âš ï¸ [projects] Failed to persist dashboard preference before redirect",p)});const u=l?`?reservationProjectContext=${l}`:"";window.location.href=`dashboard.html${u}#reservations`}function Ta(t){const e=Et(t.startDate,t.startTime)||null,n=Et(t.endDate,t.endTime)||null;return{fromProjectForm:!0,draftStorageKey:It,returnUrl:ea,start:e,end:n,customerId:t.customerId||null,customerName:t.client||"",clientCompany:t.clientCompany||"",projectTitle:t.title||"",projectType:t.type||"",description:t.description||""}}async function wa(t){if(!t)return;const e=ee(),n=Array.isArray(e?.linkedReservationIds)?e.linkedReservationIds:[];if(!n.length)return;const s=[];let r=!1;for(const l of n){const u=l!=null?String(l):"";if(u)try{await Wt(u,{project_id:t}),r=!0}catch(p){console.error("âŒ [projects] Failed to link reservation to project",u,p),s.push(u)}}if(r)try{await Vt(),c.reservations=Y(),document.dispatchEvent(new CustomEvent("reservations:changed"))}catch(l){console.warn("âš ï¸ [projects] Failed to refresh reservations after linking",l)}const i={linkedReservationIds:s,savedAt:Date.now()};return qe(i),s.length&&T(o("projects.toast.linkReservationFailed","âš ï¸ ØªØ¹Ø°Ø± Ø±Ø¨Ø· Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠÙ‹Ø§"),"error"),s.length}function it(t){const e=c.projects.find(C=>String(C.id)===String(t));if(!e||!a.detailsBody)return;a.detailsBody.dataset.mode="view",a.detailsBody.dataset.projectId=String(e.id);const n=c.customers.find(C=>String(C.id)===String(e.clientId)),s=He(e.type),i=e.description?.trim()||o("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),l=n?.customerName||o("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${y(String(e.id))}`,f=y(p),g=At(e.id),b=g.reduce((C,M)=>C+La(M),0),h=Number(b.toFixed(2)),j=g.length,{subtotal:w,applyTax:v,expensesTotal:S}=vt(e),$=w,B=v?Number((($+h)*St).toFixed(2)):0,A=Number(($+h+B).toFixed(2)),D=Qt(e),F=o(`projects.status.${D}`,$e[D]||D),U={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[D]||"status-confirmed",z=v?o("projects.details.chips.vatOn","Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15Ùª"):o("projects.details.chips.vatOff","ØºÙŠØ± Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),P=v?"status-paid":"status-unpaid",I=o("projects.details.chips.reservations","{count} Ø­Ø¬ÙˆØ²Ø§Øª").replace("{count}",y(String(j))),V=e.paymentStatus==="paid"?"paid":"unpaid",W=o(`projects.paymentStatus.${V}`,V==="paid"?"Paid":"Unpaid"),O=V==="paid"?"status-paid":"status-unpaid",E=o("projects.focus.confirmed","âœ… Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒØ¯"),N=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${d(E)}</span>`:"",et=[{icon:"ğŸ’³",label:o("projects.details.summary.paymentStatus","Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),value:W},{icon:"ğŸ’¼",label:o("projects.details.summary.projectSubtotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:L($)},{icon:"ğŸ”—",label:o("projects.details.summary.reservationsTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª / Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"),value:L(h)},{icon:"ğŸ§®",label:o("projects.details.summary.combinedTax","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (15Ùª)"),value:L(B)},{icon:"ğŸ’°",label:o("projects.details.summary.overallTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"),value:L(A)}].map(({icon:C,label:M,value:bt})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${C} ${d(M)}</span>
      <span class="summary-details-value">${d(bt)}</span>
    </div>
  `).join(""),G=[];G.push({icon:"ğŸ†”",label:o("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`#${f}`}),G.push({icon:"ğŸ‘¤",label:o("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:l}),u&&G.push({icon:"ğŸ¢",label:o("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:u}),G.push({icon:"ğŸ·ï¸",label:o("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:s}),G.push({icon:"ğŸ“…",label:o("projects.details.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Pn(e.start,e.end)});const rt=G.map(({icon:C,label:M,value:bt})=>`
    <div class="project-info-row">
      <span>${C} ${d(M)}</span>
      <span>${d(bt)}</span>
    </div>
  `).join(""),dt=[`<span class="reservation-chip ${U}">${d(F)}</span>`,`<span class="reservation-chip ${P}">${d(z)}</span>`,`<span class="reservation-chip status-info">${d(I)}</span>`,`<span class="reservation-chip ${O}">${d(W)}</span>`,N].filter(Boolean).join(""),gt=o("projects.details.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"),ht=o("projects.details.reservationsTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª");a.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${d(e.title)}</h4>
          <div class="project-details-chips">${dt}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${d(o("projects.details.actions.viewReservations","ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${rt}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${d(o("projects.details.summary.title","Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ"))}</h6>
            ${et}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${d(o("projects.details.description","ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h5>
      <p class="project-details-description">${d(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${d(o("projects.details.financialBreakdown","ØªÙØ§ØµÙŠÙ„ Ù…Ø§Ù„ÙŠØ©"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${d(gt)}</span>
          <strong>${L(S)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${d(ht)}</span>
          <strong>${L(h)}</strong>
        </div>
      </div>
    </section>
    ${qn(e)}
  `,$a(e),a.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a.detailsModalEl).show()}function xa({onOpenProject:t}){!a.focusCards||a.focusCards.dataset.listenerAttached==="true"||(a.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:r,id:i}=n.dataset;if(r==="confirm-project"){e.preventDefault(),e.stopPropagation(),Da(i);return}r==="view"?t?.(i):r==="highlight"&&Ea(i);return}const s=e.target.closest(".project-focus-card");s?.dataset.projectId&&t?.(s.dataset.projectId)}),a.focusCards.dataset.listenerAttached="true")}function Ea(t){if(!a.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=a.projectsTableBody.querySelector(e);if(!n){T(o("projects.focus.toastNotFound","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function $a(t){if(!a.detailsBody)return;const e=a.detailsBody.querySelector('[data-action="create-reservation"]'),n=a.detailsBody.querySelector('[data-action="edit-project"]'),s=a.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",r=>{r.preventDefault(),Aa(t)}),n&&t&&n.addEventListener("click",r=>{r.preventDefault(),Fe(t)}),s&&s.addEventListener("click",r=>{const i=r.target.closest('[data-action="view-reservation"]');if(!i)return;const l=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(l)||l<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(l):window.location.href="dashboard.html#reservations")})}function Fe(t){if(!t||!a.detailsBody)return;const e=c.projects.find(i=>String(i.id)===String(t.id));if(!e)return;const n=c.customers.find(i=>String(i.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const r={expenses:Array.isArray(e.expenses)?e.expenses.map((i,l)=>({id:i?.id||`expense-${e.id}-${l}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};a.detailsBody.dataset.mode="edit",a.detailsBody.innerHTML=Ia(e,r),Ca(e,r)}function Ca(t,e={expenses:[]}){const n=a.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const s=n.querySelector('[data-action="cancel-edit"]');s&&s.addEventListener("click",j=>{j.preventDefault(),it(t.id)});const r=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),l=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),f=n.querySelector('[name="project-start-time"]'),g=n.querySelector('[name="project-end-date"]'),b=n.querySelector('[name="project-end-time"]');function h(){u&&(u.innerHTML=Oe(e.expenses))}h(),l&&l.addEventListener("click",j=>{j.preventDefault();const w=r?.value.trim()||"",v=y(i?.value||"0"),S=Number(v);if(!w){T(o("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),r?.focus();return}if(!Number.isFinite(S)||S<=0){T(o("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),i?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:w,amount:S}),r&&(r.value=""),i&&(i.value=""),h()}),u&&u.addEventListener("click",j=>{const w=j.target.closest('[data-action="remove-expense"]');if(!w)return;const{id:v}=w.dataset;e.expenses=e.expenses.filter(S=>String(S.id)!==String(v)),h()}),n.addEventListener("submit",async j=>{if(j.preventDefault(),n.dataset.submitting==="true")return;const w=n.querySelector('[name="project-title"]'),v=n.querySelector('[name="project-type"]'),S=n.querySelector('[name="project-description"]'),$=n.querySelector('[name="project-payment-status"]'),B=n.querySelector('[name="project-apply-tax"]'),A=w?.value.trim()||"",D=v?.value||"",F=p?.value.trim()||"",X=f?.value.trim()||"",U=S?.value.trim()||"",z=$?.value==="paid"?"paid":"unpaid",P=B?.checked===!0;if(!A||!D||!F){T(o("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")),w?.focus();return}const I=g?.value.trim()||"",V=b?.value.trim()||"",W=ce(F,X),O=I?ce(I,V):"",E=new Date(W),N=O?new Date(O):null;if(N&&E>N){T(o("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©")),g?.focus();return}if(c.projects.findIndex(C=>String(C.id)===String(t.id))===-1){T(o("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const et=Number(t.equipmentEstimate)||0,G=e.expenses.reduce((C,M)=>C+(Number(M.amount)||0),0),rt=et+G,dt=P?Number((rt*St).toFixed(2)):0,gt=P?Number((rt+dt).toFixed(2)):rt,ht=we({projectCode:t.projectCode,title:A,type:D,clientId:t.clientId,clientCompany:t.clientCompany,description:U,start:W,end:O||null,applyTax:P,paymentStatus:z,equipmentEstimate:et,expenses:e.expenses,taxAmount:dt,totalWithTax:gt,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:ga(t)});n.dataset.submitting="true";try{const C=await Jt(t.projectId??t.id,ht),M=C?.projectId??C?.id??t.id;await Ot(M,z),c.projects=mt(),c.reservations=Y(),T(o("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),H(),Z(),tt(),it(t.id)}catch(C){console.error("âŒ [projects] Failed to update project from details view",C);const M=ft(C)?C.message:o("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");T(M,"error")}finally{delete n.dataset.submitting}})}function Aa(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};$t({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(r=>{console.warn("âš ï¸ [projects] Failed to persist dashboard tab preference",r)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(r){console.warn("âš ï¸ [projects] Unable to encode reservation context",r)}a.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a.detailsModalEl)?.hide();const s=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${s}#reservations`}async function Da(t){if(!t)return;const e=c.projects.find(n=>String(n.id)===String(t));if(!e){T(o("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}if(e.confirmed===!0||e.confirmed==="true"){T(o("projects.toast.alreadyConfirmed","â„¹ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒÙ‘Ø¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§"));return}try{await Jt(e.projectId??e.id,{confirmed:!0});const n=await ta(t);c.projects=mt(),c.reservations=Y(),H(),Z(),tt(),a.detailsModalEl&&a.detailsModalEl.classList.contains("show")&&a.detailsBody?.dataset.projectId===String(t)&&it(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),T(o("projects.toast.confirmed","âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}catch(n){console.error("âŒ [projects] confirmProject failed",n);const s=ft(n)?n.message:o("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");T(s,"error")}}function Ia(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:s}=le(t.start||""),{date:r,time:i}=le(t.end||""),l=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.title","Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</label>
          <input type="text" class="form-control" name="project-title" value="${d(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</label>
          <select class="form-select" name="project-type" required>
            ${Pa(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.startDate","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${d(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.startTime","ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${d(s)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.endDate","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${d(r)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.endTime","ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${d(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${d(o("projects.form.labels.description","Ø§Ù„ÙˆØµÙ"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${d(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(o("projects.form.labels.paymentStatus","Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${d(o("projects.paymentStatus.unpaid","Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${d(o("projects.paymentStatus.paid","Ù…Ø¯ÙÙˆØ¹"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${l?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${d(o("projects.form.labels.applyTax","ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15Ùª"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${d(o("projects.form.labels.expenses","Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${d(o("projects.form.placeholders.expenseLabel","ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${d(o("projects.form.placeholders.expenseAmount","Ø§Ù„Ù…Ø¨Ù„Øº"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${d(o("projects.form.buttons.addExpense","Ø¥Ø¶Ø§ÙØ©"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${Oe(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${d(o("projects.form.buttons.update","ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${d(o("actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}</button>
      </div>
    </form>
  `}function Pa(t){return["commercial","coverage","photography","social"].map(n=>{const s=He(n),r=n===t?"selected":"";return`<option value="${d(n)}" ${r}>${d(s)}</option>`}).join("")}function Oe(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${d(o("projects.selected.emptyExpenses","Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…ØµØ±ÙˆÙ"))}</div>`;const e=d(o("actions.remove","Ø¥Ø²Ø§Ù„Ø©"));return t.map(n=>{const s=d(n?.label||""),r=d(L(n?.amount||0)),i=d(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${s}</div>
            <div class="text-muted small">${r}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">âœ–</button>
        </div>
      `}).join("")}function He(t){if(!t)return o("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return o(e,t)}function La(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,s=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=zt(e,s,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Ue(t){if(typeof window>"u")return null;try{const s=new URLSearchParams(window.location.search||"").get(t);if(s)return s}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const s=new URLSearchParams(e).get(t);if(s)return s}catch{}return null}function Ba(){return Ue(Mt)}function ka(){return Ue(qt)}function Na(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[Mt,qt].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let s=e,r=!1;if(e)try{const p=new URLSearchParams(e);let f=!1;[Mt,qt].forEach(g=>{p.has(g)&&(p.delete(g),f=!0)}),f&&(s=p.toString(),r=!0)}catch{}if(!n&&!r)return;const i=window.location.pathname,l=t.toString(),u=`${i}${l?`?${l}`:""}${s?`#${s}`:""}`;window.history.replaceState({},"",u)}catch{}}function _a(){const t=Ba(),e=ka();t&&(c.pendingProjectDetailId=t),e&&(c.pendingProjectEditId=e,c.pendingProjectDetailId||(c.pendingProjectDetailId=e)),(t||e)&&Na()}function Ma(){if(!c.pendingProjectDetailId)return;const t=c.pendingProjectDetailId,e=String(t),n=c.projects.find(r=>[r?.id,r?.projectId,r?.project_id].some(l=>l!=null&&String(l)===e));if(!n)return;c.pendingProjectDetailId=null;const s=n?.id??n?.projectId??n?.project_id??e;if(it(s),c.pendingProjectEditId!=null){const r=String(c.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(l=>l!=null&&String(l)===r)&&(c.pendingProjectEditId=null,setTimeout(()=>Fe(n),0))}}function qa(){document.addEventListener("DOMContentLoaded",()=>{Wn(),_a(),En(),Pt(),$n(),Hn(),Un(),Cn(),na(),aa(),sa(),ra(),ja(),oa({onViewDetails:it}),xa({onOpenProject:it}),Be(),Ra()}),document.addEventListener("language:changed",ge),document.addEventListener("language:translationsReady",ge),document.addEventListener("customers:changed",Fa),document.addEventListener("technicians:updated",Oa),document.addEventListener("reservations:changed",()=>la(it)),document.addEventListener(pn.USER_UPDATED,()=>{H()})}async function Ra(){try{await xe({suppressError:!0}),await Kt()}catch(t){console.error("âŒ [projects] Failed to initialise projects data",t);const e=t?.message||o("projects.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§");T(e,"error")}finally{Jn(),Dt(),va(),st(),H(),tt(),Z(),Ma()}}function ge(){Dt(),st(),H(),tt(),Z(),Pt()}function Fa(){ia(),Dt()}function Oa(){ca(),Dt()}mn();fn();gn();Sn();qa();document.addEventListener("DOMContentLoaded",()=>{bn(),hn()});const he=.15,Tt={},Ha="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let yt=0;const x={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},m={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},wt=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let R=null;const ze=["upcoming","ongoing","completed"];async function Ua({forceProjects:t=!1}={}){try{await xe({suppressError:!0}),await Tn({force:t})}catch(e){console.error("âŒ [projectsReports] Failed to load initial data",e),ft(e)&&console.warn("Projects API error:",e.message)}Je()}async function za(){Ka(),We(),await Va();try{await Ua({forceProjects:!0}),Ge(),Za(),J()}finally{Ke()}document.addEventListener("language:changed",es),document.addEventListener("projects:changed",()=>{Ht().catch(t=>{console.error("âŒ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{Ht().catch(t=>{console.error("âŒ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",ns)}document.addEventListener("DOMContentLoaded",za);async function Va(){if(R)return R;if(typeof window>"u")return null;if(window.ApexCharts)return R=window.ApexCharts,R;try{await Wa(Ha),R=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),R=null}return R}function Wa(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const s=document.querySelector(`script[src="${t}"]`);if(s){if(s.dataset.loaded==="true"){e();return}s.addEventListener("load",e,{once:!0}),s.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const r=document.createElement("script");r.src=t,r.async=!0,r.dataset.loaded="false",r.onload=()=>{r.dataset.loaded="true",e()},r.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(r)})}function Ka(){m.search=document.getElementById("reports-search"),m.statusChips=document.getElementById("reports-status-chips"),m.payment=document.getElementById("reports-payment"),m.dateRange=document.getElementById("reports-date-range"),m.customRangeWrapper=document.getElementById("reports-custom-range"),m.startDate=document.getElementById("reports-start-date"),m.endDate=document.getElementById("reports-end-date"),m.refreshBtn=document.getElementById("reports-refresh"),m.kpiGrid=document.getElementById("reports-kpi-grid"),m.table=document.getElementById("reports-table"),m.tableBody=m.table?.querySelector("tbody"),m.tableMeta=document.getElementById("reports-table-meta"),m.tableEmpty=document.getElementById("reports-empty"),m.chartCards={},m.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;m.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(m.chartLoaders[e]=n)})}function Ve(t){const e=!!t;Object.entries(m.chartCards||{}).forEach(([n,s])=>{if(!s)return;s.classList.toggle("is-loading",e),s.setAttribute("aria-busy",e?"true":"false");const r=m.chartLoaders?.[n];r&&(r.hidden=!e)})}function We(){yt+=1,yt===1&&Ve(!0)}function Ke(){yt=Math.max(0,yt-1),yt===0&&Ve(!1)}function Je(){const{customers:t=[]}=lt();x.customers=Array.isArray(t)?t:[],x.reservations=Y();const e=new Map(x.customers.map(s=>[String(s.id),s])),n=mt();x.projects=Array.isArray(n)?n.map(s=>Ja(s,e)):[],x.totalProjects=x.projects.length}function Ja(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",s=e.get(String(t.clientId)),r=Ya(t.id),i=r.reduce((S,$)=>S+Ga($),0),l=Xa(t),u=Number(t?.equipmentEstimate)||0,p=Number((u+l).toFixed(2)),f=t?.applyTax===!0||t?.applyTax==="true",g=f?Number((p*he).toFixed(2)):0,b=f?Number(((p+i)*he).toFixed(2)):0,h=Number((p+i+b).toFixed(2)),j=Qa(t),w=t.start?new Date(t.start):null,v=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:s?.customerName||s?.name||"",clientCompany:t.clientCompany||s?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:w,end:v,applyTax:f,status:j,reservationsTotal:Number(i.toFixed(2)),expensesTotal:l,subtotal:p,taxAmount:g,combinedTaxAmount:b,overallTotal:h,unpaidValue:n==="paid"?0:h,reservationsCount:r.length}}function Ya(t){return Array.isArray(x.reservations)?x.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Ga(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,s=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],l=zt(e,s,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(l))return l;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Xa(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function Qa(t){const e=new Date,n=t.start?new Date(t.start):null,s=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":s&&!Number.isNaN(s.getTime())&&s<e?"completed":"ongoing"}function Za(){if(m.search){let t;m.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{x.filters.search=m.search.value.trim(),J()},180)})}m.payment&&(m.payment.value=x.filters.payment,m.payment.addEventListener("change",()=>{x.filters.payment=m.payment.value||"all",J()})),m.dateRange&&(m.dateRange.addEventListener("change",ts),m.dateRange.value=x.filters.range),m.startDate&&m.startDate.addEventListener("change",()=>{x.filters.startDate=m.startDate.value,x.filters.range==="custom"&&J()}),m.endDate&&m.endDate.addEventListener("change",()=>{x.filters.endDate=m.endDate.value,x.filters.range==="custom"&&J()}),m.refreshBtn&&m.refreshBtn.addEventListener("click",()=>{if(x.filters.range!=="custom"){J();return}x.filters.startDate=m.startDate?.value||"",x.filters.endDate=m.endDate?.value||"",J()})}function ts(t){const e=t.target.value;x.filters.range=e,e==="custom"?m.customRangeWrapper?.classList.add("active"):(m.customRangeWrapper?.classList.remove("active"),x.filters.startDate="",x.filters.endDate="",m.startDate&&(m.startDate.value=""),m.endDate&&(m.endDate.value=""),J())}async function Ht(){We();try{await Promise.all([Kt(),Vt()])}catch(t){console.error("âŒ [projectsReports] Data mutation refresh failed",t),ft(t)&&console.warn("Projects API error:",t.message)}finally{Je(),J(),Ke()}}function es(){Ge(),J()}function ns(t){t.key&&!["projects","reservations","customers"].includes(t.key)||Ht().catch(e=>{console.error("âŒ [projectsReports] Storage sync failed",e)})}function J(){const t=as();ne(),os(t),cs(t),ls(t),ds(t),us(t),ps(t)}function as(){const{search:t,statuses:e,payment:n,range:s,startDate:r,endDate:i}=x.filters,l=Ye(t),u=new Date,p=Number(s);let f=null;if(s==="custom"){f=r?new Date(r):null;const g=i?new Date(i):null;return x.projects.filter(b=>!be(b,e)||!ye(b,n)||!ve(b,l)?!1:rs(b.start,f,g))}return s!=="all"&&Number.isFinite(p)&&(f=new Date,f.setDate(u.getDate()-p)),x.projects.filter(g=>!be(g,e)||!ye(g,n)||!ve(g,l)?!1:s==="all"?!0:ss(g.start,f,u))}function be(t,e){return e.includes(t.status)}function ye(t,e){return e==="all"?!0:t.paymentStatus===e}function ve(t,e){return e?Ye([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function ss(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function rs(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const s=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&s<e.getTime()||n&&!Number.isNaN(n.getTime())&&s>n.getTime())}function Ye(t){return t?y(String(t)).toLowerCase().trim():""}function os(t){if(!m.kpiGrid)return;const e=t.length,n=t.reduce((l,u)=>l+u.overallTotal,0),s=t.reduce((l,u)=>l+u.unpaidValue,0),r=t.reduce((l,u)=>l+u.expensesTotal,0),i=[{icon:wt.projects,label:o("projects.reports.kpi.totalProjects","Total projects"),value:Ut(e),meta:o("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:wt.value,label:o("projects.reports.kpi.totalValue","Total value"),value:xt(n),meta:o("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:wt.outstanding,label:o("projects.reports.kpi.unpaidValue","Outstanding value"),value:xt(s),meta:o("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:wt.expenses,label:o("projects.reports.kpi.expenses","Total expenses"),value:xt(r),meta:o("projects.reports.kpi.expensesMeta","Expenses for included projects")}];m.kpiGrid.innerHTML=i.map(({icon:l,label:u,value:p,meta:f})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${l}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${q(u)}</p>
        <p class="reports-kpi-value">${q(p)}</p>
        <span class="reports-kpi-meta">${q(f)}</span>
      </div>
    </div>
  `).join("")}function Ge(){if(!m.statusChips)return;const t=ze.map(e=>{const n=o(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${q(n)}</button>`}).join("");m.statusChips.innerHTML=t,m.statusChips.dataset.listenerAttached||(m.statusChips.addEventListener("click",is),m.statusChips.dataset.listenerAttached="true"),ne()}function is(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const s=new Set(x.filters.statuses);s.has(n)?s.delete(n):s.add(n),s.size===0&&ze.forEach(r=>s.add(r)),x.filters.statuses=Array.from(s),ne(),J()}function ne(){if(!m.statusChips)return;const t=new Set(x.filters.statuses);m.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function cs(t){if(!R)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],s=n.map(p=>t.filter(f=>f.status===p).length),r=n.map(p=>o(`projects.status.${p}`,p)),l=s.reduce((p,f)=>p+f,0)>0?s:[],u={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:r,series:l,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:p=>Number.isFinite(p)?`${Math.round(p)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:p=>ct(p)}},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};Lt("status",e,u)}function ls(t){if(!R)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,s=new Intl.DateTimeFormat(fs(),{month:"short",year:"numeric"});t.forEach(g=>{if(!g.start||Number.isNaN(g.start.getTime()))return;const b=`${g.start.getFullYear()}-${g.start.getMonth()+1}`,h=n.get(b)||{total:0,label:s.format(g.start)};h.total+=g.overallTotal,n.set(b,h)});const i=Array.from(n.keys()).sort((g,b)=>{const[h,j]=g.split("-").map(Number),[w,v]=b.split("-").map(Number);return h===w?j-v:h-w}).slice(-12),l=i.map(g=>n.get(g)?.label||g),u=i.map(g=>Math.round(n.get(g)?.total||0)),p=u.length?[{name:o("projects.reports.datasets.value","Total value"),data:u}]:[],f={chart:{type:"area",height:320,toolbar:{show:!1}},series:p,xaxis:{categories:l,labels:{rotate:-35}},yaxis:{labels:{formatter:g=>ct(g)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:g=>ct(g)}},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")}};Lt("timeline",e,f)}function ds(t){if(!R)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((f,g)=>g.overallTotal-f.overallTotal).slice(0,6),s=n.map(f=>f.title||f.projectCode),r=n.map(f=>Math.round(f.overallTotal)),i=n.map(f=>Math.round(f.expensesTotal)),l=s.length?[{name:o("projects.reports.datasets.value","Total value"),data:r},{name:o("projects.reports.datasets.expenses","Expenses"),data:i}]:[],p={chart:{type:"bar",height:Math.max(320,s.length*60||0),toolbar:{show:!1}},series:l,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:s,labels:{formatter:f=>ct(f)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:f=>ct(f)}},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")}};Lt("expenses",e,p)}function us(t){if(!R)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(p=>{const f=p.clientName||p.clientCompany||o("projects.fallback.unknownClient","Unknown client"),g=n.get(f)||0;n.set(f,g+p.overallTotal)});const s=Array.from(n.entries()).sort((p,f)=>f[1]-p[1]).slice(0,6),r=s.map(([p])=>p),i=s.map(([,p])=>Math.round(p)),l=i.length?[{name:o("projects.reports.datasets.value","Total value"),data:i}]:[],u={chart:{type:"bar",height:320,toolbar:{show:!1}},series:l,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:r,labels:{rotate:-35}},yaxis:{labels:{formatter:p=>ct(p)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:p=>ct(p)}},legend:{show:!1},noData:{text:o("projects.reports.noData","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©")}};Lt("clients",e,u)}function Lt(t,e,n={}){if(!R||!e)return;if(Tt[t]){try{Tt[t].destroy()}catch(r){console.warn(`âš ï¸ [projectsReports] Failed to destroy ${t} chart`,r)}delete Tt[t]}e.innerHTML="";const s={...n};Array.isArray(s.series)||(s.series=[]);try{const r=new R(e,s);Tt[t]=r,r.render().catch(i=>{console.error(`âŒ [projectsReports] Failed to render ${t} chart`,i)})}catch(r){console.error(`âŒ [projectsReports] Failed to render ${t} chart`,r)}}function ps(t){if(!m.table||!m.tableBody||!m.tableEmpty)return;if(!t.length){m.table.style.display="none",m.tableEmpty.classList.add("active"),m.tableMeta&&(m.tableMeta.textContent="");return}m.table.style.display="",m.tableEmpty.classList.remove("active");const e=t.map(n=>{const s=ms(n.start,n.end),r=o(`projects.status.${n.status}`,n.status),i=o(`projects.paymentStatus.${n.paymentStatus}`,n.paymentStatus),l=n.clientCompany?`${q(n.clientName)} <small class="text-muted">${q(n.clientCompany)}</small>`:q(n.clientName||o("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${q(n.title||n.projectCode)}</span>
            <small class="text-muted">${q(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${l}</td>
        <td>${q(r)}</td>
        <td>${q(s)}</td>
        <td>${q(xt(n.overallTotal))}</td>
        <td>${q(i)}</td>
      </tr>
    `}).join("");if(m.tableBody.innerHTML=e,m.tableMeta){const n=o("projects.reports.table.meta","Showing {count} of {total} projects");m.tableMeta.textContent=n.replace("{count}",Ut(t.length)).replace("{total}",Ut(x.totalProjects))}}function ms(t,e){if(!t&&!e)return"â€”";const n=t?ae(t.toISOString()):"â€”",s=e?ae(e.toISOString()):"â€”";return e?`${n} â†’ ${s}`:n}function xt(t){const e=Number(t)||0,s=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(s,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function Ut(t){const n=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n).format(t))}function ct(t){const n=pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function fs(){return pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function q(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
