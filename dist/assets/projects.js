import{l as ln,n as y,e as st,t as i,j as Te,r as dn,q as un,p as we,u as Ct,d as rt,y as xe,h as w,o as pn,f as mn,a as fn,m as gn,c as hn,i as bn,k as re}from"./auth.js";/* empty css     */import{i as yn}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{h as Wt,g as Y,a as Kt,u as Jt}from"./reservationsService.js";import{n as pt,B as mt,C as vn,D as Yt,E as ft,r as jn,h as Ee,j as Gt,F as Sn,e as $e,o as Tn,k as wn}from"./controller.js";const l={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},a={};function xn(){l.selectedTechnicians=[],l.selectedEquipment=[],l.expenses=[]}function En(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function $n(){a.form=document.getElementById("project-form"),a.title=document.getElementById("project-title"),a.type=document.getElementById("project-type"),a.client=document.getElementById("project-client"),a.clientSuggestions=document.getElementById("project-customer-suggestions"),a.clientCompany=document.getElementById("project-client-company"),a.paymentStatus=document.getElementById("project-payment-status"),a.startDate=document.getElementById("project-start-date"),a.startTime=document.getElementById("project-start-time"),a.endDate=document.getElementById("project-end-date"),a.endTime=document.getElementById("project-end-time"),a.description=document.getElementById("project-description"),a.technicianSelect=document.getElementById("project-technician-select"),a.addTechnicianBtn=document.getElementById("add-technician-btn"),a.technicianList=document.getElementById("project-technician-list"),a.equipmentSelect=document.getElementById("project-equipment-select"),a.equipmentQty=document.getElementById("project-equipment-qty"),a.addEquipmentBtn=document.getElementById("add-equipment-btn"),a.equipmentList=document.getElementById("project-equipment-list"),a.expenseLabel=document.getElementById("project-expense-label"),a.expenseAmount=document.getElementById("project-expense-amount"),a.addExpenseBtn=document.getElementById("add-expense-btn"),a.expenseList=document.getElementById("project-expense-list"),a.taxCheckbox=document.getElementById("project-tax"),a.linkedReservationBtn=document.getElementById("project-linked-reservation-btn"),a.submitBtn=a.form?.querySelector('[type="submit"]'),a.projectsTableBody=document.getElementById("project-table-body"),a.projectsCount=document.getElementById("projects-count"),a.projectsUpcoming=document.getElementById("projects-upcoming"),a.projectsExpenses=document.getElementById("projects-expenses"),a.projectsBudget=document.getElementById("projects-budget"),a.tableCount=document.getElementById("project-table-count"),a.search=document.getElementById("project-search"),a.detailsModalEl=document.getElementById("projectDetailsModal"),a.detailsBody=document.getElementById("project-details-body"),a.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),a.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),a.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),a.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),a.timeline=document.getElementById("project-timeline"),a.focusCards=document.getElementById("project-focus-cards"),a.detailsModalEl&&!a.detailsModalEl.dataset.projectListenerAttached&&(a.detailsModalEl.addEventListener("hidden.bs.modal",()=>{a.detailsBody&&(a.detailsBody.dataset.projectId="")}),a.detailsModalEl.dataset.projectListenerAttached="true")}function Cn(){const t=En();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([s,r])=>{document.querySelector(s)&&t(s,r)})}function Ce(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=a[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function An(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>ln()),t.dataset.listenerAttached="true")}const qt="project",Ft="editProject",oe=3600*1e3,Tt=.15,_t=6,Xt="projectsTab",Qt="projectsSubTab",ie={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},Ae={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},In={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function d(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function L(t){const e=Number(t)||0,s=st()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(s,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function at(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getFullYear()),o=String(e.getMinutes()).padStart(2,"0"),c=e.getHours(),u=c>=12?"PM":"AM",p=c%12||12,f=String(p).padStart(2,"0"),g=`${n}/${s}/${r} ${f}:${o} ${u}`;return y(g)}function Dn(t){const e=st(),n=y(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function ce(t){a.tableCount&&(a.tableCount.dataset.count=String(t),a.tableCount.textContent=Dn(t))}function Ln(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?i(e,n):n}function nt(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function le(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=nt(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function de(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[s="00",r="00"]=n.split(":"),o=s.padStart(2,"0"),c=r.padStart(2,"0");return`${t}T${o}:${c}`}function Ie(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}…`}function Pn(t,e){if(!t)return"—";const n=at(t);return e?`${n} - ${at(e)}`:n}function ue(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,s=""]=e.split("T");return{date:n,time:s}}function At(t){if(!t)return i("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return i(e,t)}function H(){if(!a.projectsTableBody)return;const t=l.filters.search,e=l.projects.filter(s=>{if(!t)return!0;const r=l.customers.find(c=>String(c.id)===String(s.clientId));return y([s.title,s.description,r?.customerName,s.clientCompany,At(s.type),s.id,s.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const s=l.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",r=l.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",o=d(i(s,r));a.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${o}</td></tr>`,ce(0),l.visibleProjects=[],pe([]);return}const n=[...e].sort((s,r)=>new Date(r.start||0)-new Date(s.start||0));l.visibleProjects=n,ce(n.length),a.projectsTableBody.innerHTML=n.map(s=>kn(s)).join(""),pe(n),Z()}function kn(t){const e=l.customers.find(x=>String(x.id)===String(t.clientId)),n=e?.customerName||i("projects.fallback.unknownClient","عميل غير معروف"),s=(t.clientCompany||e?.companyName||"").trim(),r=t.technicians?.length||0,o=(t.equipment||[]).reduce((x,A)=>x+(A.qty||0),0),{expensesTotal:c,totalWithTax:u}=vt(t),f=It(t.id).length,b=i("projects.table.reservationsCount","{count} حجوزات").replace("{count}",y(String(f))),h=f?`<span class="badge rounded-pill project-reservations-chip">${d(b)}</span>`:"",T=`<span class="badge project-type-badge">${d(At(t.type))}</span>`,j=t.projectCode||`PRJ-${y(String(t.id))}`,v=`<span class="project-code-badge">#${d(j)}</span>`,P=Te()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${d(i("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${d(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${v}
            ${T}
          </div>
        </div>
        ${h}
      </td>
      <td>
        ${s?`<div class="d-flex flex-column"><span>${d(n)}</span><small class="text-muted">${d(s)}</small></div>`:d(n)}
      </td>
      <td>${Zt(t.start,t.end)}</td>
      <td>${y(String(r))}</td>
      <td>${y(String(o))}</td>
      <td>${L(u)}</td>
      <td>${L(c)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${d(i("actions.view","عرض"))}</button>
        ${P}
      </td>
    </tr>
  `}function Zt(t,e){if(!t)return"—";const n=at(t);return e?`${n} - ${at(e)}`:n}function pe(t){if(!a.timeline)return;const n=(Array.isArray(t)?t:l.visibleProjects.length?l.visibleProjects:l.projects).map(b=>{if(!b?.start)return null;const h=new Date(b.start);if(Number.isNaN(h.getTime()))return null;let S=b.end?new Date(b.end):new Date(h);return Number.isNaN(S.getTime())&&(S=new Date(h)),S<=h&&(S=new Date(h.getTime()+oe)),{project:b,startDate:h,endDate:S}}).filter(Boolean).sort((b,h)=>b.startDate-h.startDate);if(!n.length){const b=d(i("projects.timeline.empty",a.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));a.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${b}</div>`;return}const s=n[0].startDate.getTime(),r=Math.max(...n.map(b=>b.endDate.getTime()));let o=r-s;o<=0&&(o=oe);const c=Nn(n),u=i("projects.timeline.range","{start} → {end}"),p=i("projects.timeline.conflict","Scheduling conflict"),f=n.map(b=>{const{project:h,startDate:S,endDate:T}=b,j=T.getTime()-S.getTime();let v=(S.getTime()-s)/o*100;v=Math.max(0,Math.min(v,100));let C=j/o*100;C=Math.max(C,2.5),v+C>100&&(C=Math.max(1.5,100-v));const x=`project-timeline__item--${te(h)}`,A=c.has(h.id),F=(h.title||"").trim()||i("projects.fallback.untitled","Untitled project"),X=Ie(F,26),U=l.customers.find(et=>String(et.id)===String(h.clientId)),z=U?.customerName||i("projects.fallback.unknownClient","Unknown client"),k=(h.clientCompany||U?.companyName||"").trim(),D=At(h.type),V=at(S.toISOString()),W=at(T.toISOString()),O=u.replace("{start}",V).replace("{end}",W),$=k?`${z} (${k})`:z,B=`${F} • ${D} • ${$} | ${O}`,_=A?`<span class="project-timeline__item-conflict" title="${d(p)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${x}${A?" project-timeline__item--conflict":""}" style="left:${v}%;width:${C}%;" title="${d(B)}">
          <span class="project-timeline__item-label">${d(X)}</span>
          ${_}
        </div>
      `}).join(""),g=`
    <div class="project-timeline__scale">
      <span>${d(at(new Date(s).toISOString()))}</span>
      <span>${d(at(new Date(r).toISOString()))}</span>
    </div>
  `;a.timeline.innerHTML=`
    ${g}
    <div class="project-timeline__track">
      ${f}
    </div>
  `}function Nn(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let s=n+1;s<t.length;s+=1){const r=t[n],o=t[s];r.startDate<o.endDate&&o.startDate<r.endDate&&(e.add(r.project.id),e.add(o.project.id))}return e}function Z(){if(!a.focusCards)return;const t=Bn();if(!t.length){const e=d(i("projects.focus.empty",a.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));a.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}a.focusCards.innerHTML=t.join("")}function Bn(){if(!Array.isArray(l.projects)||!l.projects.length)return[];const t=l.projects.filter(me),e=l.projects.filter(o=>!me(o)&&Rn(o)),n=[],s=new Set,r=(o,c)=>{!o||s.has(o.id)||n.length>=_t||(s.add(o.id),n.push(_n(o,c)))};if(t.sort((o,c)=>nt(o)-nt(c)).forEach(o=>r(o,"today")),e.sort((o,c)=>nt(o)-nt(c)).forEach(o=>r(o,"thisWeek")),n.length<_t){const o=Date.now();[...l.projects].filter(u=>!s.has(u.id)).filter(u=>{const p=nt(u);return Number.isFinite(p)&&p>=o}).sort((u,p)=>nt(u)-nt(p)).forEach(u=>r(u,"upcoming"))}return n.length<_t&&[...l.projects].filter(c=>!s.has(c.id)).sort((c,u)=>le(u)-le(c)).forEach(c=>r(c,"recent")),n}function _n(t,e){const n=l.customers.find(N=>String(N.id)===String(t.clientId)),s=n?.customerName||i("projects.fallback.unknownClient","عميل غير معروف"),r=(t.clientCompany||n?.companyName||"").trim(),o=Array.isArray(t.technicians)?t.technicians.length:0,c=It(t.id),u=c.length,p=De(t),{subtotal:f,applyTax:g}=vt(t),b=(t.description||"").trim(),h=b?Ie(b,110):i("projects.fallback.noDescription","لا يوجد وصف"),S=At(t.type),T=t.paymentStatus==="paid"?"paid":"unpaid",j=i(`projects.paymentStatus.${T}`,T==="paid"?"Paid":"Unpaid"),v=T==="paid"?"status-paid":"status-unpaid",C=T==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",P=t.confirmed===!0||t.confirmed==="true",x=d(String(t.id)),A=t.projectCode||`PRJ-${y(String(t.id))}`,F=y(A),X={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},U={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},z=X[e]||X.recent,k=i(z,U[e]||U.recent),D=te(t),V=i(`projects.status.${D}`,Ae[D]||D),W=In[D]||"bg-secondary",O=(t.title||"").trim()||i("projects.fallback.untitled","Untitled project"),$=[C];P&&$.push("project-focus-card--confirmed");const B=c.reduce((N,K)=>{const Q=ee(K),sn=(K.items||[]).reduce((on,cn)=>on+(Number(cn?.qty)||1),0),rn=(K.technicians||[]).length;return{total:N.total+Q,equipment:N.equipment+sn,crew:N.crew+rn}},{total:0,equipment:0,crew:0}),_=Number(B.total.toFixed(2)),et=B.equipment,G=B.crew||o,it=g?Number(((f+_)*Tt).toFixed(2)):0,ut=Number((f+_+it).toFixed(2)),gt=`<span class="project-code-badge project-focus-card__code">#${d(F)}</span>`,ht=S?`<span class="badge project-focus-card__badge bg-primary">${d(S)}</span>`:"",I=k?`<span class="project-focus-card__meta-tag">${d(k)}</span>`:"",R=`<span class="project-focus-card__status-chip ${W}">${d(V)}</span>`,bt=`<span class="reservation-chip ${v} project-focus-card__payment-chip">${d(j)}</span>`,Bt=(N,K,Q)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${N?`<span class="project-focus-card__row-icon">${d(N)}</span>`:""}
        ${d(K)}
      </span>
      <span class="project-focus-card__row-value">${d(String(Q))}</span>
    </div>
  `,Qe=[{icon:"👤",label:i("projects.details.client","العميل"),value:s},r?{icon:"🏢",label:i("projects.details.company","شركة العميل"),value:r}:null,{icon:"🏷️",label:i("projects.details.type","نوع المشروع"),value:S},{icon:"📅",label:i("projects.focus.summary.range","الفترة الزمنية"),value:Zt(t.start,t.end)}].filter(Boolean).map(({icon:N,label:K,value:Q})=>Bt(N,K,Q)).join(""),Ze=[{icon:"💳",label:i("projectCards.stats.paymentStatus","حالة الدفع"),value:j},{icon:"💸",label:i("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:L(p)},{icon:"🧮",label:i("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:L(ut)}].map(({icon:N,label:K,value:Q})=>Bt(N,K,Q)).join(""),tn=[{icon:"🔗",label:i("projectCards.stats.reservationsShort","الحجوزات"),value:y(String(u))},{icon:"📦",label:i("projectCards.stats.equipmentCount","عدد المعدات"),value:y(String(et))},{icon:"😎",label:i("projectCards.stats.crewCount","عدد الطاقم"),value:y(String(G))},{icon:"💵",label:i("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:L(_)}].map(({icon:N,label:K,value:Q})=>Bt(N,K,Q)).join(""),en=P?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${d(i("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${x}">${d(i("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`,nn=i("projects.focus.actions.highlight","🔍 عرض في القائمة"),an=i("projects.focus.actions.view","👁️ عرض التفاصيل");return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${$.filter(Boolean).join(" ")}" data-project-id="${x}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${gt}
          ${ht}
          ${I}
          ${R}
          ${bt}
        </div>
        <h6 class="project-focus-card__title">${d(O)}</h6>
        <p class="project-focus-card__description">${d(h)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(i("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${Qe}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(i("projects.focus.summary.payment","الجانب المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${Ze}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(i("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${tn}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions">
          ${en}
          <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${x}">${d(nn)}</button>
          <button class="btn btn-sm btn-primary" data-action="view" data-id="${x}">${d(an)}</button>
        </div>
      </article>
    </div>
  `}function me(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function Rn(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,s=new Date(n);s.setHours(0,0,0,0);const r=s.getDay(),o=r===0?6:r-1;s.setDate(s.getDate()-o);const c=new Date(s);return c.setDate(c.getDate()+7),e>=s&&e<c}function te(t){const e=new Date,n=t.start?new Date(t.start):null,s=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":s&&!Number.isNaN(s.getTime())&&s<e?"completed":"ongoing"}function De(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function vt(t){const e=Number(t?.equipmentEstimate)||0,n=De(t),s=e+n,r=Number(s.toFixed(2)),o=t?.applyTax===!0||t?.applyTax==="true";let c=o?Number(t?.taxAmount):0;o?(!Number.isFinite(c)||c<0)&&(c=Number((r*Tt).toFixed(2))):c=0;let u=o?Number(t?.totalWithTax):r;return o?(!Number.isFinite(u)||u<=0)&&(u=Number((r+c).toFixed(2))):u=r,{equipmentEstimate:e,expensesTotal:n,subtotal:r,applyTax:o,taxAmount:c,totalWithTax:u}}function tt(){const t=l.projects.length,e=l.projects.filter(r=>{const o=r.start?new Date(r.start):null;return!o||Number.isNaN(o.getTime())?!1:o>new Date}).length,n=l.projects.reduce((r,o)=>r+vt(o).expensesTotal,0),s=l.projects.reduce((r,o)=>r+vt(o).totalWithTax,0);a.projectsCount&&(a.projectsCount.textContent=y(String(t))),a.projectsUpcoming&&(a.projectsUpcoming.textContent=y(String(e))),a.projectsExpenses&&(a.projectsExpenses.textContent=L(n)),a.projectsBudget&&(a.projectsBudget.textContent=L(s))}function It(t){return t?l.reservations.filter(e=>String(e.projectId)===String(t)):[]}function ee(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,s=Number(y(String(n)))||0,r=t.discountType||"percent",o=Array.isArray(t.technicians)?t.technicians:[],c=Wt(e,s,r,!1,o,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Mn(t,e,n=null){if(!t)return"";const s=t.reservationId||t.id||`RES-${e+1}`,r=t.status||t.state||"pending",o=i(`reservations.status.${r}`,r),c=String(r).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[c]||"project-reservation-card__badge--info",f=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",g=f?i("reservations.details.paid","مدفوع"):i("reservations.details.unpaid","غير مدفوع"),b=f?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",h=t.completed===!0||t.completed==="true",S=i("reservations.details.completed","مكتمل"),T=h?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${d(S)}</span>`:"",j=Zt(t.start,t.end),v=ee(t),C=L(v),P=i("projects.details.reservations.items","{count} عناصر").replace("{count}",y(String((t.items||[]).length))),x=i("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",y(String((t.technicians||[]).length))),A=i("projects.details.reservations.view","👁️ عرض الحجز");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${d(s)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${d(o)}</span>
          <span class="project-reservation-card__badge ${b}">${d(g)}</span>
          ${T}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${d(j)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${d(C)}</span>
          <span>📦 ${d(P)}</span>
          <span>😎 ${d(x)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${d(A)}</button>
      </div>
    </article>
  `}function qn(t){const e=It(t.id).map(j=>({reservation:j,index:l.reservations.findIndex(v=>v===j)})).filter(({index:j})=>Number.isInteger(j)&&j>=0).sort((j,v)=>{const C=j.reservation.start?new Date(j.reservation.start).getTime():0;return(v.reservation.start?new Date(v.reservation.start).getTime():0)-C}),n=i("projects.details.reservations.title","الحجوزات المرتبطة"),s=i("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),r=i("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),o=i("projects.details.reservations.count","{count} حجوزات"),c=e.length?`<span class="badge project-reservations-count">${d(o.replace("{count}",y(String(e.length))))}</span>`:"",u=e.length>0,p=d(String(t.id)),f=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&f.push("disabled",'aria-disabled="true"');const g=`<button ${f.join(" ")}>${d(s)}</button>`,b=i("projects.details.actions.edit","✏️ تعديل المشروع"),h=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${d(b)}</button>`,S=`<div class="d-flex flex-wrap gap-2">${g}${h}</div>`,T=e.length?`<div class="project-reservations-list">${e.map(({reservation:j,index:v})=>Mn(j,v,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${d(r)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${d(n)}</h6>
          ${c}
        </div>
        ${S}
      </div>
      ${T}
    </section>
  `}let fe=null;function Fn(t){t&&Le()!==t&&Ct({[Xt]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function Le(){return we()?.[Xt]||""}function Pe(t){t&&Ot()!==t&&Ct({[Qt]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function Ot(){return we()?.[Qt]||""}function On(t){if(!t)return"";const e=t.trim();return e?Object.values(ie).includes(e)?e:ie[e]||"":""}function Hn(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=On(e);if(n)return n}}catch{}return""}function ke(t,e){!t||!a.tabPanes||!a.tabButtons||(a.tabButtons.forEach(n=>{const s=n===e;n.classList.toggle("active",s),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",s)}),a.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&Fn(t))}function Un(){if(!a.tabButtons||!a.tabButtons.length)return;a.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",s=>{s.preventDefault();const r=n.dataset.tabTarget;r&&(ke(r,n),r==="projects-section"&&(l.filters.search="",a.search&&(a.search.value=""),H(),Z(),tt()))}),n.dataset.tabListenerAttached="true")});const t=Le(),e=t&&a.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function ne(t,e){!t||!a.projectSubTabButtons||!a.projectSubTabPanes||(a.projectSubTabButtons.forEach(n=>{const s=n===e;n.classList.toggle("active",s),n.classList.contains("tab")&&n.classList.toggle("tab-active",s)}),a.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function zn(){!a.projectSubTabButtons||!a.projectSubTabButtons.length||(a.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(ne(n,t),Pe(n))}),t.dataset.tabListenerAttached="true")}),Vn())}function Vn(){const e=Hn()||Ot();if(!e)return;const n=a.projectSubTabButtons?.[0],s=a.projectSubTabButtons?.find(o=>o.dataset.projectSubtabTarget===e)||n,r=s?.dataset.projectSubtabTarget;r&&(e!==Ot()&&Pe(r),ne(r,s))}function Wn(){return a.tabButtons?a.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function ge(t={}){if(t){if(a.tabButtons&&a.tabButtons.length){const n=a.tabButtons.find(r=>r.classList.contains("active"))?.dataset.tabTarget||"",s=t[Xt];if(s&&s!==n){const r=a.tabButtons.find(o=>o.dataset.tabTarget===s);r&&ke(s,r)}}if(a.projectSubTabButtons&&a.projectSubTabButtons.length&&Wn()){const n=a.projectSubTabButtons.find(r=>r.classList.contains("active"))?.dataset.projectSubtabTarget||"",s=t[Qt];if(s&&s!==n){const r=a.projectSubTabButtons.find(o=>o.dataset.projectSubtabTarget===s);r&&ne(s,r)}}}}function Kn(){fe||(fe=dn(t=>{ge(t)})),un().then(t=>{ge(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function Jn(){if(!Array.isArray(l.projects)||l.projects.length===0)return;let t=!1;const e=l.projects.map(n=>{if(n.projectCode)return n;const s=xe();return t=!0,{...n,projectCode:s}});t&&(l.projects=e)}function Yn(){const{customers:t,technicians:e,equipment:n}=rt();l.customers=Array.isArray(t)?t:[],l.technicians=Array.isArray(e)?e:[],l.equipment=Array.isArray(n)?n:[],l.reservations=Y(),l.projects=mt(),Jn()}function Dt(){if(Ne(),a.technicianSelect){const t=a.technicianSelect.value,e=d(i("projects.form.selectTechnician","اختر عضو الطاقم"));a.technicianSelect.innerHTML=`<option value="">${e}</option>`+l.technicians.map(n=>{const s=i("projects.fallback.technicianName","عضو {id}"),r=n.name||s.replace("{id}",y(String(n.id||"")));return`<option value="${n.id}">${d(r)}</option>`}).join(""),t&&(a.technicianSelect.value=t)}if(a.equipmentSelect){const t=a.equipmentSelect.value,e=d(i("projects.form.selectEquipment","اختر المعدة"));a.equipmentSelect.innerHTML=`<option value="">${e}</option>`+l.equipment.map(n=>{const s=n.desc||n.description||n.name||i("projects.fallback.unknownEquipment","معدة");return`<option value="${d(n.barcode||"")}">${d(s)}</option>`}).join(""),t&&(a.equipmentSelect.value=t)}}function ct(t){if(!a.clientCompany)return;const e=t?.companyName||t?.company||"";a.clientCompany.value=e}function Ne(){if(!a.client)return;Gn();const t=a.client.dataset?.customerId;if(t){const e=l.customers.find(n=>String(n.id)===String(t));e?ct(e):(a.client.dataset.customerId="",ct(null))}else ct(null);document.activeElement===a.client&&Ht()}function Gn(){!a.client||!a.clientSuggestions||a.client.dataset.autocompleteAttached!=="true"&&(a.client.addEventListener("input",()=>{a.client.dataset.customerId="",Ht(),ct(null)}),a.client.addEventListener("focus",()=>{Ht()}),a.client.addEventListener("blur",()=>{window.setTimeout(()=>jt(),150)}),a.client.dataset.autocompleteAttached="true")}function jt(){a.clientSuggestions&&(a.clientSuggestions.classList.remove("is-visible"),a.clientSuggestions.hidden=!0,a.clientSuggestions.innerHTML="")}function Ht(){if(!a.client||!a.clientSuggestions)return;if(!Array.isArray(l.customers)||l.customers.length===0){const s=rt();Array.isArray(s?.customers)&&s.customers.length&&(l.customers=s.customers)}const t=Xn(),e=pt(a.client.value||""),n=e?t.filter(s=>{const r=pt(s.name).includes(e),o=pt(s.company||"").includes(e);return r||o}).slice(0,10):t.slice(0,10);if(!n.length){jt();return}a.clientSuggestions.innerHTML=n.map(s=>{const r=s.company?`<div class="suggestion-item__meta">${d(s.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${d(String(s.id))}" data-name="${d(s.name)}" data-company="${d(s.company||"")}">
          <div class="suggestion-item__primary">${d(s.name)}</div>
          ${r}
        </div>
      `}).join(""),a.clientSuggestions.hidden=!1,a.clientSuggestions.classList.add("is-visible"),a.clientSuggestions.scrollTop=0,a.clientSuggestions.querySelectorAll(".suggestion-item").forEach(s=>{s.addEventListener("mousedown",r=>{r.preventDefault();const{id:o,name:c}=r.currentTarget.dataset;a.client&&(a.client.value=c||"",a.client.dataset.customerId=o||"");const u=r.currentTarget.dataset.company||"";ct({companyName:u}),jt()})})}function Xn(){return Array.isArray(l.customers)?l.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function Qn(t,e=""){if(!Array.isArray(l.customers)||l.customers.length===0)return null;if(e){const r=l.customers.find(o=>String(o.id)===String(e));if(r)return r}const n=pt(t||"");if(!n)return null;const s=l.customers.find(r=>pt(r.customerName||r.name||"")===n);return s||l.customers.find(r=>pt(r.customerName||r.name||"").includes(n))||null}async function Zn(t){if(l.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(i("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await vn(t),await Yt(),await Kt(),l.projects=mt(),l.reservations=Y(),H(),tt(),Z(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),w(i("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const s=ft(n)?n.message:i("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");w(s,"error")}}async function ta(t,e){if(!t)return!1;const s=Y().filter(u=>String(u.projectId)===String(t));if(!s.length)return!1;const r=e==="paid",o=r?"paid":"unpaid";let c=!1;for(const u of s){const p=u.id??u.reservationId;if(!p)continue;const f=u.paid===!0||u.paid==="paid",g=u.paidStatus||u.paymentStatus||(f?"paid":"unpaid");f===r&&g===o||(await Jt(p,{paid_status:o,paid:r}),c=!0)}return c&&(l.reservations=Y()),c}async function ea(t){if(!t)return!1;const e=Y(),n=l.projects.find(o=>String(o.id)===String(t))||(rt().projects||[]).find?.(o=>String(o.id)===String(t))||null,s=e.filter(o=>String(o.projectId)===String(t));if(!s.length)return!1;let r=!1;for(const o of s){const c=o.id??o.reservationId;if(!c)continue;const u=jn({...o,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await Jt(c,{confirmed:!0,status:p}),r=!0}return r&&(l.reservations=Y()),r}async function Ut(t,e){if(!t)return!1;const n=await ta(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let Rt=!1;const Lt="projects:create:draft",na="projects.html#projects-section";function aa(){a.form&&!a.form.dataset.listenerAttached&&(a.form.addEventListener("submit",ya),a.form.dataset.listenerAttached="true"),a.form&&!a.form.dataset.resetListenerAttached&&(a.form.addEventListener("reset",()=>{a.client&&(a.client.dataset.customerId=""),jt(),Ce(),a.type&&(a.type.value=""),ct(null),Fe(),Be()}),a.form.dataset.resetListenerAttached="true"),a.search&&!a.search.dataset.listenerAttached&&(a.search.addEventListener("input",()=>{l.filters.search=y(a.search.value||"").trim().toLowerCase(),H()}),a.search.dataset.listenerAttached="true")}function Be(){xn(),l.editingProjectId=null,a.form&&(delete a.form.dataset.editingId,a.form.dataset.mode="create"),ot(),a.expenseLabel&&(a.expenseLabel.value=""),a.expenseAmount&&(a.expenseAmount.value=""),a.taxCheckbox&&(a.taxCheckbox.checked=!1),a.paymentStatus&&(a.paymentStatus.value="unpaid"),Pt(),St()}function sa(){a.addTechnicianBtn&&a.addTechnicianBtn.dataset.listenerAttached!=="true"&&(a.addTechnicianBtn.addEventListener("click",ua),a.addTechnicianBtn.dataset.listenerAttached="true"),a.addEquipmentBtn&&a.addEquipmentBtn.dataset.listenerAttached!=="true"&&(a.addEquipmentBtn.addEventListener("click",pa),a.addEquipmentBtn.dataset.listenerAttached="true")}function ra(){Mt(a.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;l.selectedTechnicians=l.selectedTechnicians.filter(n=>n!==e),_e()}}),Mt(a.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;l.selectedEquipment=l.selectedEquipment.filter(n=>n.barcode!==e),Re()}}),Mt(a.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;l.expenses=l.expenses.filter(n=>String(n.id)!==String(e)),Me(),tt()}})}function oa(){a.addExpenseBtn&&a.addExpenseBtn.dataset.listenerAttached!=="true"&&(a.addExpenseBtn.addEventListener("click",ma),a.addExpenseBtn.dataset.listenerAttached="true"),a.expenseAmount&&a.expenseAmount.dataset.normalizeAttached!=="true"&&(a.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,s=y(e.value||"");if(e.value=s,n!=null){const r=Math.min(s.length,n);e.setSelectionRange(r,r)}}),a.expenseAmount.dataset.normalizeAttached="true")}function Mt(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const s=n.target;s instanceof HTMLElement&&e(s)}),t.dataset.listenerAttached="true")}function ia({onViewDetails:t}){!a.projectsTableBody||a.projectsTableBody.dataset.listenerAttached==="true"||(a.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const s=n.dataset.id;t?.(s);return}if(n.matches('[data-action="delete-project"]')){if(!Te()){pn();return}const s=n.dataset.id;Zn(s)}}}),a.projectsTableBody.dataset.listenerAttached="true")}function ca(){const{customers:t}=rt();l.customers=Array.isArray(t)?t:[],ot(),H(),Z()}function la(){const{technicians:t}=rt();l.technicians=Array.isArray(t)?t:[],ot(),H(),Z()}function da(t){const{reservations:e}=rt();l.reservations=Array.isArray(e)?e:[],H();const n=a.detailsModalEl&&a.detailsModalEl.classList.contains("show"),s=a.detailsBody?.dataset.projectId;n&&s&&l.projects.find(o=>String(o.id)===String(s))&&t?.(s)}function ua(){const t=a.technicianSelect?.value;if(!t){w(i("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(l.selectedTechnicians.includes(t)){w(i("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}l.selectedTechnicians.push(t),ot(),w(i("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function pa(){const t=a.equipmentSelect?.value;if(!t){w(i("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(a.equipmentQty?.value||"1",10)||1),n=l.selectedEquipment.find(s=>s.barcode===t);n?n.qty+=e:l.selectedEquipment.push({barcode:t,qty:e}),ot(),w(i("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function ma(){const t=(a.expenseLabel?.value||"").trim(),e=y(a.expenseAmount?.value||"0"),n=Number(e);if(!t){w(i("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){w(i("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}l.expenses.push({id:Date.now(),label:t,amount:n}),a.expenseLabel&&(a.expenseLabel.value=""),a.expenseAmount&&(a.expenseAmount.value=y(String(e))),ot(),tt()}function ot(){_e(),Re(),Me(),Pt()}function _e(){a.technicianList&&ae(a.technicianList,l.selectedTechnicians,t=>{const n=l.technicians.find(s=>String(s.id)===String(t))?.name||i("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${d(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${d(String(t))}" aria-label="${d(i("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function Re(){a.equipmentList&&ae(a.equipmentList,l.selectedEquipment,t=>{const e=l.equipment.find(r=>String(r.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||i("projects.fallback.unknownEquipment","معدة"),s=y(String(t.qty||1));return`
      <span class="chip">
        ${d(n)} (x${s})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${d(String(t.barcode))}" aria-label="${d(i("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function Me(){a.expenseList&&ae(a.expenseList,l.expenses,t=>`
      <div class="expense-item">
        <span>${d(t.label)}</span>
        <span>${L(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${d(String(t.id))}" aria-label="${d(i("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function ae(t,e,n){if(t){if(!e||e.length===0){const s=d(Ln(t));t.innerHTML=`<span class="text-muted">${s}</span>`;return}t.innerHTML=e.map(s=>n(s)).join("")}}function Pt(){if(!a.submitBtn)return;const t=!!l.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";a.submitBtn.textContent=i(e,n)}function fa(){return l.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function he(t){return y(String(t||"")).trim().toLowerCase()}function ga(){if(!Array.isArray(l.selectedEquipment)||l.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((l.equipment||[]).map(s=>[he(s?.barcode),s])),e=[],n=[];return l.selectedEquipment.forEach(s=>{const r=he(s?.barcode);if(!r){e.push(s?.barcode||"");return}const o=t.get(r);if(!o||o.id==null){e.push(s?.barcode||r);return}const c=Number.parseInt(String(s?.qty??0),10);n.push({equipmentId:o.id,qty:Number.isInteger(c)&&c>0?c:1})}),{items:n,missing:e}}function ha(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,s=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(s)&&s>0?s:1}:null}).filter(Boolean)}function ba(){return l.selectedEquipment.reduce((t,e)=>{const n=l.equipment.find(r=>String(r.barcode||"")===String(e.barcode)),s=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+s*(e.qty||1)},0)}async function ya(t){if(t.preventDefault(),Rt)return;const e=a.title?.value.trim(),n=a.type?.value||"",s=a.client?.value?.trim()||"",r=a.client?.dataset?.customerId||"",o=a.startDate?.value?.trim()||"",c=a.startTime?.value?.trim()||"";if(!e||!n||!o){w(i("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const u=Qn(s,r);if(!u){w(i("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),a.client?.focus();return}const p=String(u.id);a.client&&(a.client.dataset.customerId=p,a.client.value=u.customerName||u.name||a.client.value),ct(u);const f=a.endDate?.value?.trim()||"",g=a.endTime?.value?.trim()||"",b=$t(o,c),h=f?$t(f,g):"",S=new Date(b),T=h?new Date(h):null;if(T&&S>T){w(i("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}a.expenseAmount&&(a.expenseAmount.value=y(a.expenseAmount.value||""));const j=fa(),v=ba(),C=a.taxCheckbox?.checked===!0,x=(a.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",A=v+j,F=C?Number((A*Tt).toFixed(2)):0,X=Number((A+F).toFixed(2)),{items:U,missing:z}=ga();if(z.length){w(i("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const k=!!l.editingProjectId,D=k?l.projects.find($=>String($.id)===String(l.editingProjectId)):null;if(k&&!D){w(i("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const V=u.companyName||u.company||"",W=a.description?.value.trim()||"",O=Ee({projectCode:D?.projectCode||(k?null:xe()),title:e,type:n,clientId:p,clientCompany:V,description:W,start:b,end:h||null,applyTax:C,paymentStatus:x,equipmentEstimate:v,expenses:l.expenses.map($=>({id:$.id,label:$.label,amount:$.amount})),taxAmount:F,totalWithTax:X,confirmed:D?.confirmed??!1,technicians:l.selectedTechnicians,equipment:U});Rt=!0;try{let $=D?.projectId??D?.id??null;if(k){const _=await Gt($??l.editingProjectId,O);$=_?.projectId??_?.id??$,await Ut($,x),w(i("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const _=await Sn(O);$=_?.projectId??_?.id??null,await Ut($,x),w(i("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}await xa($)||Fe(),l.editingProjectId=null,a.form.reset(),Be(),Ce(),jt(),a.client&&(a.client.dataset.customerId=""),a.type&&(a.type.value=""),l.projects=mt(),l.reservations=Y(),H(),tt(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch($){console.error("❌ [projects] handleSubmitProject failed",$);const B=ft($)?$.message:i("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");w(B,"error")}finally{Rt=!1}}function $t(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[s="00",r="00"]=n.split(":"),o=s.padStart(2,"0"),c=r.padStart(2,"0");return`${t}T${o}:${c}`}function kt(){if(typeof window>"u"||!window.sessionStorage)return null;const t=window.sessionStorage.getItem(Lt);if(!t)return null;try{const e=JSON.parse(t);return e&&typeof e=="object"?e:null}catch(e){return console.warn("⚠️ [projects] Failed to parse project form draft",e),null}}function qe(t){if(!(typeof window>"u"||!window.sessionStorage))try{window.sessionStorage.setItem(Lt,JSON.stringify(t))}catch(e){console.warn("⚠️ [projects] Unable to persist project form draft",e)}}function Fe(){typeof window>"u"||!window.sessionStorage||(window.sessionStorage.removeItem(Lt),St())}function va(){const t=kt()||{};return{...t,type:a.type?.value||"",title:a.title?.value||"",client:a.client?.value||"",customerId:a.client?.dataset.customerId||"",clientCompany:a.clientCompany?.value||"",paymentStatus:a.paymentStatus?.value||"unpaid",taxChecked:a.taxCheckbox?.checked===!0,startDate:a.startDate?.value||"",startTime:a.startTime?.value||"",endDate:a.endDate?.value||"",endTime:a.endTime?.value||"",description:a.description?.value||"",expenses:Array.isArray(l.expenses)?l.expenses.map(e=>({...e})):[],technicians:Array.isArray(l.selectedTechnicians)?[...l.selectedTechnicians]:[],equipment:Array.isArray(l.selectedEquipment)?l.selectedEquipment.map(e=>({...e})):[],linkedReservationIds:Array.isArray(t.linkedReservationIds)?[...t.linkedReservationIds]:[],savedAt:Date.now()}}function ja(){const t=kt();return t?(a.type&&(a.type.value=t.type||""),a.title&&(a.title.value=t.title||""),a.client&&(a.client.value=t.client||"",a.client.dataset.customerId=t.customerId||""),a.clientCompany&&(a.clientCompany.value=t.clientCompany||""),a.paymentStatus&&t.paymentStatus&&(a.paymentStatus.value=t.paymentStatus),a.taxCheckbox&&(a.taxCheckbox.checked=t.taxChecked===!0),a.startDate&&(a.startDate.value=t.startDate||""),a.startTime&&(a.startTime.value=t.startTime||""),a.endDate&&(a.endDate.value=t.endDate||""),a.endTime&&(a.endTime.value=t.endTime||""),a.description&&(a.description.value=t.description||""),l.expenses=Array.isArray(t.expenses)?t.expenses.map(e=>({...e})):[],l.selectedTechnicians=Array.isArray(t.technicians)?[...t.technicians]:[],l.selectedEquipment=Array.isArray(t.equipment)?t.equipment.map(e=>({...e})):[],St(),!0):(St(),!1)}function Sa(){!a.linkedReservationBtn||a.linkedReservationBtn.dataset.listenerAttached==="true"||(a.linkedReservationBtn.addEventListener("click",Ta),a.linkedReservationBtn.dataset.listenerAttached="true")}function Ta(t){t.preventDefault();const e=va();if(!(e.customerId&&e.customerId!==""||e.client&&e.client.trim())){w(i("projects.form.linkedReservation.missingClient","⚠️ يرجى اختيار العميل قبل إنشاء الحجز"));return}const s=e.startDate&&e.startTime,r=e.endDate&&e.endTime;if(!s||!r){w(i("projects.form.linkedReservation.missingSchedule","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إنشاء الحجز"));return}qe(e);const o=wa(e);let c="";try{c=encodeURIComponent(JSON.stringify(o))}catch(p){console.warn("⚠️ [projects] Unable to encode reservation context",p)}Ct({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(p=>{console.warn("⚠️ [projects] Failed to persist dashboard preference before redirect",p)});const u=c?`?reservationProjectContext=${c}`:"";window.location.href=`dashboard.html${u}#reservations`}function wa(t){const e=$t(t.startDate,t.startTime)||null,n=$t(t.endDate,t.endTime)||null;return{fromProjectForm:!0,draftStorageKey:Lt,returnUrl:na,start:e,end:n,customerId:t.customerId||null,customerName:t.client||"",clientCompany:t.clientCompany||"",projectTitle:t.title||"",projectType:t.type||"",description:t.description||""}}async function xa(t){if(!t)return;const e=kt(),n=Array.isArray(e?.linkedReservationIds)?e.linkedReservationIds:[];if(!n.length)return;const s=[];let r=!1;for(const c of n){const u=c!=null?String(c):"";if(u)try{await Jt(u,{project_id:t}),r=!0}catch(p){console.error("❌ [projects] Failed to link reservation to project",u,p),s.push(u)}}if(r)try{await Kt(),l.reservations=Y(),document.dispatchEvent(new CustomEvent("reservations:changed"))}catch(c){console.warn("⚠️ [projects] Failed to refresh reservations after linking",c)}const o={linkedReservationIds:s,savedAt:Date.now()};return qe(o),s.length&&w(i("projects.toast.linkReservationFailed","⚠️ تعذر ربط بعض الحجوزات بالمشروع، يرجى التحقق يدويًا"),"error"),St(),s.length}function Ea(){const t=new Map,e=s=>{if(!s)return;[s.id,s.reservationId,s.reservation_id,s.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean).forEach(o=>{t.has(o)||t.set(o,s)})};Array.isArray(l.reservations)&&l.reservations.forEach(e);const n=rt();return Array.isArray(n?.reservations)&&n.reservations.forEach(e),t}function $a(t){if(!t||typeof t!="object")return"";const e=[t.name,t.full_name,t.fullName,t.technician_name,t.technicianName,t.label,t.displayName];for(const n of e)if(typeof n=="string"&&n.trim())return n.trim();return""}function Ca(t){if(!t)return[];const e=new Set;(Array.isArray(t.techniciansDetails)?t.techniciansDetails:[]).forEach(r=>{const o=$a(r);o&&e.add(o)});const s=Array.isArray(t.technicians)?t.technicians:[];if(s.length){const r=Array.isArray(l.technicians)?l.technicians:[];s.forEach(o=>{const c=r.find(p=>String(p?.id)===String(o)),u=c?.name||c?.full_name||"";u&&e.add(String(u).trim())})}return Array.from(e)}function St(){const t=document.getElementById("project-linked-reservation-summary");if(!t)return;const e=kt(),n=a.linkedReservationBtn,s=Array.isArray(e?.linkedReservationIds)?Array.from(new Set(e.linkedReservationIds.map(c=>String(c)).filter(Boolean))):[];if(!s.length){t.dataset.state="empty",t.innerHTML=`<p class="project-linked-reservation__summary-empty">${d(i("projects.form.linkedReservation.empty","لم يتم إنشاء حجوزات مرتبطة بعد."))}</p>`,n&&(n.disabled=!1,n.classList.remove("btn-disabled"),n.removeAttribute("aria-disabled"),n.title="");return}const r=Ea(),o=s.map(c=>{const u=r.get(c);if(!u)return`
        <li class="project-linked-reservation__summary-item">
          <div class="project-linked-reservation__summary-item-title">#${d(y(c))}</div>
          <div class="project-linked-reservation__summary-item-meta">
            <span>${d(i("projects.form.linkedReservation.pendingItem","تم إنشاء حجز جديد وسيتم ربطه بعد حفظ المشروع."))}</span>
          </div>
        </li>`;const p=u.reservation_code||u.reservationId||u.id||c,f=`#${y(String(p))}`,g=Array.isArray(u.items)?u.items:[],b=g.reduce((x,A)=>x+(Number(A?.qty)||0),0)||g.length||0,h=Ca(u),T=(Array.isArray(u.technicians)?u.technicians:[]).length||h.length||0,j=ee(u),v=[],C=i("projects.form.linkedReservation.meta.equipment","عدد المعدات: {count}").replace("{count}",y(String(b)));v.push(C);const P=i("projects.form.linkedReservation.meta.crew","عدد الفريق: {count}").replace("{count}",y(String(T)));if(v.push(P),h.length){const x=typeof st=="function"&&st()==="en"?", ":"، ",A=i("projects.form.linkedReservation.meta.crewNames","أسماء الفريق: {names}").replace("{names}",h.join(x));v.push(A)}if(Number.isFinite(j)){const x=i("projects.form.linkedReservation.meta.total","إجمالي الحجز: {amount}").replace("{amount}",L(j));v.push(x)}return`
      <li class="project-linked-reservation__summary-item">
        <div class="project-linked-reservation__summary-item-title">${d(f)}</div>
        <div class="project-linked-reservation__summary-item-meta">
          ${v.map(x=>`<span>${d(x)}</span>`).join("")}
        </div>
      </li>`}).join("");t.dataset.state="has-linked",t.innerHTML=`<ul class="project-linked-reservation__summary-list">${o}</ul>`,n&&(n.disabled=!0,n.classList.add("btn-disabled"),n.setAttribute("aria-disabled","true"),n.title=i("projects.form.linkedReservation.buttonDisabled","تم إنشاء حجز مرتبط لهذا المشروع. يمكنك تعديل الحجز بعد حفظ المشروع."))}function lt(t){const e=l.projects.find(I=>String(I.id)===String(t));if(!e||!a.detailsBody)return;a.detailsBody.dataset.mode="view",a.detailsBody.dataset.projectId=String(e.id);const n=l.customers.find(I=>String(I.id)===String(e.clientId)),s=Ue(e.type),o=e.description?.trim()||i("projects.fallback.noDescription","لا يوجد وصف"),c=n?.customerName||i("projects.fallback.unknownClient","عميل غير معروف"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${y(String(e.id))}`,f=y(p),g=It(e.id),b=g.reduce((I,R)=>I+_a(R),0),h=Number(b.toFixed(2)),S=g.length,{subtotal:T,applyTax:j,expensesTotal:v}=vt(e),C=T,P=j?Number(((C+h)*Tt).toFixed(2)):0,x=Number((C+h+P).toFixed(2)),A=te(e),F=i(`projects.status.${A}`,Ae[A]||A),U={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[A]||"status-confirmed",z=j?i("projects.details.chips.vatOn","شامل الضريبة 15٪"):i("projects.details.chips.vatOff","غير شامل الضريبة"),k=j?"status-paid":"status-unpaid",D=i("projects.details.chips.reservations","{count} حجوزات").replace("{count}",y(String(S))),V=e.paymentStatus==="paid"?"paid":"unpaid",W=i(`projects.paymentStatus.${V}`,V==="paid"?"Paid":"Unpaid"),O=V==="paid"?"status-paid":"status-unpaid",$=i("projects.focus.confirmed","✅ مشروع مؤكد"),B=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${d($)}</span>`:"",et=[{icon:"💳",label:i("projects.details.summary.paymentStatus","حالة الدفع"),value:W},{icon:"💼",label:i("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:L(C)},{icon:"🔗",label:i("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:L(h)},{icon:"🧮",label:i("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:L(P)},{icon:"💰",label:i("projects.details.summary.overallTotal","الإجمالي الكلي"),value:L(x)}].map(({icon:I,label:R,value:bt})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${I} ${d(R)}</span>
      <span class="summary-details-value">${d(bt)}</span>
    </div>
  `).join(""),G=[];G.push({icon:"🆔",label:i("projects.details.labels.code","رقم المشروع"),value:`#${f}`}),G.push({icon:"👤",label:i("projects.details.client","العميل"),value:c}),u&&G.push({icon:"🏢",label:i("projects.details.company","شركة العميل"),value:u}),G.push({icon:"🏷️",label:i("projects.details.type","نوع المشروع"),value:s}),G.push({icon:"📅",label:i("projects.details.range","الفترة الزمنية"),value:Pn(e.start,e.end)});const it=G.map(({icon:I,label:R,value:bt})=>`
    <div class="project-info-row">
      <span>${I} ${d(R)}</span>
      <span>${d(bt)}</span>
    </div>
  `).join(""),ut=[`<span class="reservation-chip ${U}">${d(F)}</span>`,`<span class="reservation-chip ${k}">${d(z)}</span>`,`<span class="reservation-chip status-info">${d(D)}</span>`,`<span class="reservation-chip ${O}">${d(W)}</span>`,B].filter(Boolean).join(""),gt=i("projects.details.expensesTotal","إجمالي المصاريف"),ht=i("projects.details.reservationsTotal","إجمالي الحجوزات");a.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${d(e.title)}</h4>
          <div class="project-details-chips">${ut}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${d(i("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${it}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${d(i("projects.details.summary.title","ملخص مالي"))}</h6>
            ${et}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${d(i("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${d(o)}</p>
    </section>
    <section class="project-details-section">
      <h5>${d(i("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${d(gt)}</span>
          <strong>${L(v)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${d(ht)}</span>
          <strong>${L(h)}</strong>
        </div>
      </div>
    </section>
    ${qn(e)}
  `,Da(e),a.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a.detailsModalEl).show()}function Aa({onOpenProject:t}){!a.focusCards||a.focusCards.dataset.listenerAttached==="true"||(a.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:r,id:o}=n.dataset;if(r==="confirm-project"){e.preventDefault(),e.stopPropagation(),ka(o);return}r==="view"?t?.(o):r==="highlight"&&Ia(o);return}const s=e.target.closest(".project-focus-card");s?.dataset.projectId&&t?.(s.dataset.projectId)}),a.focusCards.dataset.listenerAttached="true")}function Ia(t){if(!a.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=a.projectsTableBody.querySelector(e);if(!n){w(i("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function Da(t){if(!a.detailsBody)return;const e=a.detailsBody.querySelector('[data-action="create-reservation"]'),n=a.detailsBody.querySelector('[data-action="edit-project"]'),s=a.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",r=>{r.preventDefault(),Pa(t)}),n&&t&&n.addEventListener("click",r=>{r.preventDefault(),Oe(t)}),s&&s.addEventListener("click",r=>{const o=r.target.closest('[data-action="view-reservation"]');if(!o)return;const c=Number.parseInt(o.dataset.index||"-1",10);!Number.isInteger(c)||c<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(c):window.location.href="dashboard.html#reservations")})}function Oe(t){if(!t||!a.detailsBody)return;const e=l.projects.find(o=>String(o.id)===String(t.id));if(!e)return;const n=l.customers.find(o=>String(o.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const r={expenses:Array.isArray(e.expenses)?e.expenses.map((o,c)=>({id:o?.id||`expense-${e.id}-${c}-${Date.now()}`,label:o?.label||"",amount:Number(o?.amount)||0})):[]};a.detailsBody.dataset.mode="edit",a.detailsBody.innerHTML=Na(e,r),La(e,r)}function La(t,e={expenses:[]}){const n=a.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const s=n.querySelector('[data-action="cancel-edit"]');s&&s.addEventListener("click",S=>{S.preventDefault(),lt(t.id)});const r=n.querySelector("#project-edit-expense-label"),o=n.querySelector("#project-edit-expense-amount"),c=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),f=n.querySelector('[name="project-start-time"]'),g=n.querySelector('[name="project-end-date"]'),b=n.querySelector('[name="project-end-time"]');function h(){u&&(u.innerHTML=He(e.expenses))}h(),c&&c.addEventListener("click",S=>{S.preventDefault();const T=r?.value.trim()||"",j=y(o?.value||"0"),v=Number(j);if(!T){w(i("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),r?.focus();return}if(!Number.isFinite(v)||v<=0){w(i("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),o?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:T,amount:v}),r&&(r.value=""),o&&(o.value=""),h()}),u&&u.addEventListener("click",S=>{const T=S.target.closest('[data-action="remove-expense"]');if(!T)return;const{id:j}=T.dataset;e.expenses=e.expenses.filter(v=>String(v.id)!==String(j)),h()}),n.addEventListener("submit",async S=>{if(S.preventDefault(),n.dataset.submitting==="true")return;const T=n.querySelector('[name="project-title"]'),j=n.querySelector('[name="project-type"]'),v=n.querySelector('[name="project-description"]'),C=n.querySelector('[name="project-payment-status"]'),P=n.querySelector('[name="project-apply-tax"]'),x=T?.value.trim()||"",A=j?.value||"",F=p?.value.trim()||"",X=f?.value.trim()||"",U=v?.value.trim()||"",z=C?.value==="paid"?"paid":"unpaid",k=P?.checked===!0;if(!x||!A||!F){w(i("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),T?.focus();return}const D=g?.value.trim()||"",V=b?.value.trim()||"",W=de(F,X),O=D?de(D,V):"",$=new Date(W),B=O?new Date(O):null;if(B&&$>B){w(i("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),g?.focus();return}if(l.projects.findIndex(I=>String(I.id)===String(t.id))===-1){w(i("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const et=Number(t.equipmentEstimate)||0,G=e.expenses.reduce((I,R)=>I+(Number(R.amount)||0),0),it=et+G,ut=k?Number((it*Tt).toFixed(2)):0,gt=k?Number((it+ut).toFixed(2)):it,ht=Ee({projectCode:t.projectCode,title:x,type:A,clientId:t.clientId,clientCompany:t.clientCompany,description:U,start:W,end:O||null,applyTax:k,paymentStatus:z,equipmentEstimate:et,expenses:e.expenses,taxAmount:ut,totalWithTax:gt,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:ha(t)});n.dataset.submitting="true";try{const I=await Gt(t.projectId??t.id,ht),R=I?.projectId??I?.id??t.id;await Ut(R,z),l.projects=mt(),l.reservations=Y(),w(i("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),H(),Z(),tt(),lt(t.id)}catch(I){console.error("❌ [projects] Failed to update project from details view",I);const R=ft(I)?I.message:i("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");w(R,"error")}finally{delete n.dataset.submitting}})}function Pa(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};Ct({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(r=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",r)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(r){console.warn("⚠️ [projects] Unable to encode reservation context",r)}a.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a.detailsModalEl)?.hide();const s=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${s}#reservations`}async function ka(t){if(!t)return;const e=l.projects.find(n=>String(n.id)===String(t));if(!e){w(i("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(e.confirmed===!0||e.confirmed==="true"){w(i("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await Gt(e.projectId??e.id,{confirmed:!0});const n=await ea(t);l.projects=mt(),l.reservations=Y(),H(),Z(),tt(),a.detailsModalEl&&a.detailsModalEl.classList.contains("show")&&a.detailsBody?.dataset.projectId===String(t)&&lt(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),w(i("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const s=ft(n)?n.message:i("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");w(s,"error")}}function Na(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:s}=ue(t.start||""),{date:r,time:o}=ue(t.end||""),c=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${d(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${Ba(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${d(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${d(s)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${d(r)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${d(o)}">
        </div>
        <div class="col-12">
          <label class="form-label">${d(i("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${d(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${d(i("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${d(i("projects.paymentStatus.unpaid","قيد الانتظار"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${d(i("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${c?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${d(i("projects.form.labels.applyTax","تطبيق الضريبة 15٪"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${d(i("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${d(i("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${d(i("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${d(i("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${He(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${d(i("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${d(i("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function Ba(t){return["commercial","coverage","photography","social"].map(n=>{const s=Ue(n),r=n===t?"selected":"";return`<option value="${d(n)}" ${r}>${d(s)}</option>`}).join("")}function He(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${d(i("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=d(i("actions.remove","إزالة"));return t.map(n=>{const s=d(n?.label||""),r=d(L(n?.amount||0)),o=d(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${s}</div>
            <div class="text-muted small">${r}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${o}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function Ue(t){if(!t)return i("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return i(e,t)}function _a(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,s=Number(y(String(n)))||0,r=t.discountType||"percent",o=Array.isArray(t.technicians)?t.technicians:[],c=Wt(e,s,r,!1,o,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function ze(t){if(typeof window>"u")return null;try{const s=new URLSearchParams(window.location.search||"").get(t);if(s)return s}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const s=new URLSearchParams(e).get(t);if(s)return s}catch{}return null}function Ra(){return ze(qt)}function Ma(){return ze(Ft)}function qa(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[qt,Ft].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let s=e,r=!1;if(e)try{const p=new URLSearchParams(e);let f=!1;[qt,Ft].forEach(g=>{p.has(g)&&(p.delete(g),f=!0)}),f&&(s=p.toString(),r=!0)}catch{}if(!n&&!r)return;const o=window.location.pathname,c=t.toString(),u=`${o}${c?`?${c}`:""}${s?`#${s}`:""}`;window.history.replaceState({},"",u)}catch{}}function Fa(){const t=Ra(),e=Ma();t&&(l.pendingProjectDetailId=t),e&&(l.pendingProjectEditId=e,l.pendingProjectDetailId||(l.pendingProjectDetailId=e)),(t||e)&&qa()}function Oa(){if(!l.pendingProjectDetailId)return;const t=l.pendingProjectDetailId,e=String(t),n=l.projects.find(r=>[r?.id,r?.projectId,r?.project_id].some(c=>c!=null&&String(c)===e));if(!n)return;l.pendingProjectDetailId=null;const s=n?.id??n?.projectId??n?.project_id??e;if(lt(s),l.pendingProjectEditId!=null){const r=String(l.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(c=>c!=null&&String(c)===r)&&(l.pendingProjectEditId=null,setTimeout(()=>Oe(n),0))}}function Ha(){document.addEventListener("DOMContentLoaded",()=>{Kn(),Fa(),$n(),Pt(),Cn(),Un(),zn(),An(),aa(),sa(),ra(),oa(),Sa(),ia({onViewDetails:lt}),Aa({onOpenProject:lt}),Ne(),Ua()}),document.addEventListener("language:changed",be),document.addEventListener("language:translationsReady",be),document.addEventListener("customers:changed",za),document.addEventListener("technicians:updated",Va),document.addEventListener("reservations:changed",()=>da(lt)),document.addEventListener(mn.USER_UPDATED,()=>{H()})}async function Ua(){try{await $e({suppressError:!0}),await Yt()}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||i("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");w(e,"error")}finally{Yn(),Dt(),ja(),ot(),H(),tt(),Z(),Oa()}}function be(){Dt(),ot(),H(),tt(),Z(),Pt()}function za(){ca(),Dt()}function Va(){la(),Dt()}fn();gn();hn();Tn();Ha();document.addEventListener("DOMContentLoaded",()=>{yn(),bn()});const ye=.15,wt={},Wa="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let yt=0;const E={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},m={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},xt=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let q=null;const Ve=["upcoming","ongoing","completed"];async function Ka({forceProjects:t=!1}={}){try{await $e({suppressError:!0}),await wn({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),ft(e)&&console.warn("Projects API error:",e.message)}Ye()}async function Ja(){Xa(),Ke(),await Ya();try{await Ka({forceProjects:!0}),Xe(),as(),J()}finally{Je()}document.addEventListener("language:changed",rs),document.addEventListener("projects:changed",()=>{zt().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{zt().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",os)}document.addEventListener("DOMContentLoaded",Ja);async function Ya(){if(q)return q;if(typeof window>"u")return null;if(window.ApexCharts)return q=window.ApexCharts,q;try{await Ga(Wa),q=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),q=null}return q}function Ga(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const s=document.querySelector(`script[src="${t}"]`);if(s){if(s.dataset.loaded==="true"){e();return}s.addEventListener("load",e,{once:!0}),s.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const r=document.createElement("script");r.src=t,r.async=!0,r.dataset.loaded="false",r.onload=()=>{r.dataset.loaded="true",e()},r.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(r)})}function Xa(){m.search=document.getElementById("reports-search"),m.statusChips=document.getElementById("reports-status-chips"),m.payment=document.getElementById("reports-payment"),m.dateRange=document.getElementById("reports-date-range"),m.customRangeWrapper=document.getElementById("reports-custom-range"),m.startDate=document.getElementById("reports-start-date"),m.endDate=document.getElementById("reports-end-date"),m.refreshBtn=document.getElementById("reports-refresh"),m.kpiGrid=document.getElementById("reports-kpi-grid"),m.table=document.getElementById("reports-table"),m.tableBody=m.table?.querySelector("tbody"),m.tableMeta=document.getElementById("reports-table-meta"),m.tableEmpty=document.getElementById("reports-empty"),m.chartCards={},m.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;m.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(m.chartLoaders[e]=n)})}function We(t){const e=!!t;Object.entries(m.chartCards||{}).forEach(([n,s])=>{if(!s)return;s.classList.toggle("is-loading",e),s.setAttribute("aria-busy",e?"true":"false");const r=m.chartLoaders?.[n];r&&(r.hidden=!e)})}function Ke(){yt+=1,yt===1&&We(!0)}function Je(){yt=Math.max(0,yt-1),yt===0&&We(!1)}function Ye(){const{customers:t=[]}=rt();E.customers=Array.isArray(t)?t:[],E.reservations=Y();const e=new Map(E.customers.map(s=>[String(s.id),s])),n=mt();E.projects=Array.isArray(n)?n.map(s=>Qa(s,e)):[],E.totalProjects=E.projects.length}function Qa(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",s=e.get(String(t.clientId)),r=Za(t.id),o=r.reduce((v,C)=>v+ts(C),0),c=es(t),u=Number(t?.equipmentEstimate)||0,p=Number((u+c).toFixed(2)),f=t?.applyTax===!0||t?.applyTax==="true",g=f?Number((p*ye).toFixed(2)):0,b=f?Number(((p+o)*ye).toFixed(2)):0,h=Number((p+o+b).toFixed(2)),S=ns(t),T=t.start?new Date(t.start):null,j=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:s?.customerName||s?.name||"",clientCompany:t.clientCompany||s?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:T,end:j,applyTax:f,status:S,reservationsTotal:Number(o.toFixed(2)),expensesTotal:c,subtotal:p,taxAmount:g,combinedTaxAmount:b,overallTotal:h,unpaidValue:n==="paid"?0:h,reservationsCount:r.length}}function Za(t){return Array.isArray(E.reservations)?E.reservations.filter(e=>String(e.projectId)===String(t)):[]}function ts(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,s=Number(y(String(n)))||0,r=t.discountType||"percent",o=Array.isArray(t.technicians)?t.technicians:[],c=Wt(e,s,r,!1,o,{start:t.start,end:t.end});if(Number.isFinite(c))return c;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function es(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function ns(t){const e=new Date,n=t.start?new Date(t.start):null,s=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":s&&!Number.isNaN(s.getTime())&&s<e?"completed":"ongoing"}function as(){if(m.search){let t;m.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{E.filters.search=m.search.value.trim(),J()},180)})}m.payment&&(m.payment.value=E.filters.payment,m.payment.addEventListener("change",()=>{E.filters.payment=m.payment.value||"all",J()})),m.dateRange&&(m.dateRange.addEventListener("change",ss),m.dateRange.value=E.filters.range),m.startDate&&m.startDate.addEventListener("change",()=>{E.filters.startDate=m.startDate.value,E.filters.range==="custom"&&J()}),m.endDate&&m.endDate.addEventListener("change",()=>{E.filters.endDate=m.endDate.value,E.filters.range==="custom"&&J()}),m.refreshBtn&&m.refreshBtn.addEventListener("click",()=>{if(E.filters.range!=="custom"){J();return}E.filters.startDate=m.startDate?.value||"",E.filters.endDate=m.endDate?.value||"",J()})}function ss(t){const e=t.target.value;E.filters.range=e,e==="custom"?m.customRangeWrapper?.classList.add("active"):(m.customRangeWrapper?.classList.remove("active"),E.filters.startDate="",E.filters.endDate="",m.startDate&&(m.startDate.value=""),m.endDate&&(m.endDate.value=""),J())}async function zt(){Ke();try{await Promise.all([Yt(),Kt()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),ft(t)&&console.warn("Projects API error:",t.message)}finally{Ye(),J(),Je()}}function rs(){Xe(),J()}function os(t){t.key&&!["projects","reservations","customers"].includes(t.key)||zt().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function J(){const t=is();se(),ds(t),ps(t),ms(t),fs(t),gs(t),hs(t)}function is(){const{search:t,statuses:e,payment:n,range:s,startDate:r,endDate:o}=E.filters,c=Ge(t),u=new Date,p=Number(s);let f=null;if(s==="custom"){f=r?new Date(r):null;const g=o?new Date(o):null;return E.projects.filter(b=>!ve(b,e)||!je(b,n)||!Se(b,c)?!1:ls(b.start,f,g))}return s!=="all"&&Number.isFinite(p)&&(f=new Date,f.setDate(u.getDate()-p)),E.projects.filter(g=>!ve(g,e)||!je(g,n)||!Se(g,c)?!1:s==="all"?!0:cs(g.start,f,u))}function ve(t,e){return e.includes(t.status)}function je(t,e){return e==="all"?!0:t.paymentStatus===e}function Se(t,e){return e?Ge([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function cs(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function ls(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const s=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&s<e.getTime()||n&&!Number.isNaN(n.getTime())&&s>n.getTime())}function Ge(t){return t?y(String(t)).toLowerCase().trim():""}function ds(t){if(!m.kpiGrid)return;const e=t.length,n=t.reduce((c,u)=>c+u.overallTotal,0),s=t.reduce((c,u)=>c+u.unpaidValue,0),r=t.reduce((c,u)=>c+u.expensesTotal,0),o=[{icon:xt.projects,label:i("projects.reports.kpi.totalProjects","Total projects"),value:Vt(e),meta:i("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:xt.value,label:i("projects.reports.kpi.totalValue","Total value"),value:Et(n),meta:i("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:xt.outstanding,label:i("projects.reports.kpi.unpaidValue","Outstanding value"),value:Et(s),meta:i("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:xt.expenses,label:i("projects.reports.kpi.expenses","Total expenses"),value:Et(r),meta:i("projects.reports.kpi.expensesMeta","Expenses for included projects")}];m.kpiGrid.innerHTML=o.map(({icon:c,label:u,value:p,meta:f})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${c}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${M(u)}</p>
        <p class="reports-kpi-value">${M(p)}</p>
        <span class="reports-kpi-meta">${M(f)}</span>
      </div>
    </div>
  `).join("")}function Xe(){if(!m.statusChips)return;const t=Ve.map(e=>{const n=i(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${M(n)}</button>`}).join("");m.statusChips.innerHTML=t,m.statusChips.dataset.listenerAttached||(m.statusChips.addEventListener("click",us),m.statusChips.dataset.listenerAttached="true"),se()}function us(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const s=new Set(E.filters.statuses);s.has(n)?s.delete(n):s.add(n),s.size===0&&Ve.forEach(r=>s.add(r)),E.filters.statuses=Array.from(s),se(),J()}function se(){if(!m.statusChips)return;const t=new Set(E.filters.statuses);m.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function ps(t){if(!q)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],s=n.map(p=>t.filter(f=>f.status===p).length),r=n.map(p=>i(`projects.status.${p}`,p)),c=s.reduce((p,f)=>p+f,0)>0?s:[],u={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:r,series:c,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:p=>Number.isFinite(p)?`${Math.round(p)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:p=>dt(p)}},noData:{text:i("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};Nt("status",e,u)}function ms(t){if(!q)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,s=new Intl.DateTimeFormat(ys(),{month:"short",year:"numeric"});t.forEach(g=>{if(!g.start||Number.isNaN(g.start.getTime()))return;const b=`${g.start.getFullYear()}-${g.start.getMonth()+1}`,h=n.get(b)||{total:0,label:s.format(g.start)};h.total+=g.overallTotal,n.set(b,h)});const o=Array.from(n.keys()).sort((g,b)=>{const[h,S]=g.split("-").map(Number),[T,j]=b.split("-").map(Number);return h===T?S-j:h-T}).slice(-12),c=o.map(g=>n.get(g)?.label||g),u=o.map(g=>Math.round(n.get(g)?.total||0)),p=u.length?[{name:i("projects.reports.datasets.value","Total value"),data:u}]:[],f={chart:{type:"area",height:320,toolbar:{show:!1}},series:p,xaxis:{categories:c,labels:{rotate:-35}},yaxis:{labels:{formatter:g=>dt(g)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:g=>dt(g)}},noData:{text:i("projects.reports.noData","لا توجد بيانات متاحة")}};Nt("timeline",e,f)}function fs(t){if(!q)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((f,g)=>g.overallTotal-f.overallTotal).slice(0,6),s=n.map(f=>f.title||f.projectCode),r=n.map(f=>Math.round(f.overallTotal)),o=n.map(f=>Math.round(f.expensesTotal)),c=s.length?[{name:i("projects.reports.datasets.value","Total value"),data:r},{name:i("projects.reports.datasets.expenses","Expenses"),data:o}]:[],p={chart:{type:"bar",height:Math.max(320,s.length*60||0),toolbar:{show:!1}},series:c,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:s,labels:{formatter:f=>dt(f)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:f=>dt(f)}},noData:{text:i("projects.reports.noData","لا توجد بيانات متاحة")}};Nt("expenses",e,p)}function gs(t){if(!q)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(p=>{const f=p.clientName||p.clientCompany||i("projects.fallback.unknownClient","Unknown client"),g=n.get(f)||0;n.set(f,g+p.overallTotal)});const s=Array.from(n.entries()).sort((p,f)=>f[1]-p[1]).slice(0,6),r=s.map(([p])=>p),o=s.map(([,p])=>Math.round(p)),c=o.length?[{name:i("projects.reports.datasets.value","Total value"),data:o}]:[],u={chart:{type:"bar",height:320,toolbar:{show:!1}},series:c,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:r,labels:{rotate:-35}},yaxis:{labels:{formatter:p=>dt(p)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:p=>dt(p)}},legend:{show:!1},noData:{text:i("projects.reports.noData","لا توجد بيانات متاحة")}};Nt("clients",e,u)}function Nt(t,e,n={}){if(!q||!e)return;if(wt[t]){try{wt[t].destroy()}catch(r){console.warn(`⚠️ [projectsReports] Failed to destroy ${t} chart`,r)}delete wt[t]}e.innerHTML="";const s={...n};Array.isArray(s.series)||(s.series=[]);try{const r=new q(e,s);wt[t]=r,r.render().catch(o=>{console.error(`❌ [projectsReports] Failed to render ${t} chart`,o)})}catch(r){console.error(`❌ [projectsReports] Failed to render ${t} chart`,r)}}function hs(t){if(!m.table||!m.tableBody||!m.tableEmpty)return;if(!t.length){m.table.style.display="none",m.tableEmpty.classList.add("active"),m.tableMeta&&(m.tableMeta.textContent="");return}m.table.style.display="",m.tableEmpty.classList.remove("active");const e=t.map(n=>{const s=bs(n.start,n.end),r=i(`projects.status.${n.status}`,n.status),o=i(`projects.paymentStatus.${n.paymentStatus}`,n.paymentStatus),c=n.clientCompany?`${M(n.clientName)} <small class="text-muted">${M(n.clientCompany)}</small>`:M(n.clientName||i("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${M(n.title||n.projectCode)}</span>
            <small class="text-muted">${M(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${c}</td>
        <td>${M(r)}</td>
        <td>${M(s)}</td>
        <td>${M(Et(n.overallTotal))}</td>
        <td>${M(o)}</td>
      </tr>
    `}).join("");if(m.tableBody.innerHTML=e,m.tableMeta){const n=i("projects.reports.table.meta","Showing {count} of {total} projects");m.tableMeta.textContent=n.replace("{count}",Vt(t.length)).replace("{total}",Vt(E.totalProjects))}}function bs(t,e){if(!t&&!e)return"—";const n=t?re(t.toISOString()):"—",s=e?re(e.toISOString()):"—";return e?`${n} → ${s}`:n}function Et(t){const e=Number(t)||0,s=st()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(s,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function Vt(t){const n=st()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n).format(t))}function dt(t){const n=st()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function ys(){return st()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function M(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
