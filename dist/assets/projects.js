import{l as an,n as y,e as ut,t as o,j as be,r as sn,q as rn,p as he,u as Ht,d as pt,y as ye,h as x,o as on,f as cn,a as ln,m as dn,c as un,i as pn,k as Qt}from"./auth.js";/* empty css     */import{i as mn}from"./dashboardShell.js";import"./projects2.js";import"./customers.js";import{h as Ot,g as J,a as ve,u as je}from"./reservationsService.js";import{n as dt,B as mt,C as fn,D as Ut,E as ft,r as gn,h as Se,j as zt,F as bn,e as Te,o as hn,k as yn}from"./controller.js";const l={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},s={};function vn(){l.selectedTechnicians=[],l.selectedEquipment=[],l.expenses=[]}function jn(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Sn(){s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.submitBtn=s.form?.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function Tn(){const t=jn();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...e,...n].forEach(([a,r])=>{document.querySelector(a)&&t(a,r)})}function xe(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function xn(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>an()),t.dataset.listenerAttached="true")}const Nt="project",_t="editProject",Zt=3600*1e3,St=.15,It=6,Vt="projectsTab",Wt="projectsSubTab",te={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},we={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},wn={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function c(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(t){const e=Number(t)||0,a=ut()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function nt(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),d=e.getHours(),u=d>=12?"PM":"AM",p=d%12||12,f=String(p).padStart(2,"0"),g=`${n}/${a}/${r} ${f}:${i} ${u}`;return y(g)}function $n(t){const e=ut(),n=y(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function ee(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=$n(t))}function En(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?o(e,n):n}function et(t){if(!t?.start)return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function ne(t){if(t?.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=et(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function ae(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),i=a.padStart(2,"0"),d=r.padStart(2,"0");return`${t}T${i}:${d}`}function $e(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}…`}function Cn(t,e){if(!t)return"—";const n=nt(t);return e?`${n} - ${nt(e)}`:n}function se(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function $t(t){if(!t)return o("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return o(e,t)}function H(){if(!s.projectsTableBody)return;const t=l.filters.search,e=l.projects.filter(a=>{if(!t)return!0;const r=l.customers.find(d=>String(d.id)===String(a.clientId));return y([a.title,a.description,r?.customerName,a.clientCompany,$t(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=l.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",r=l.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",i=c(o(a,r));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,ee(0),l.visibleProjects=[],re([]);return}const n=[...e].sort((a,r)=>new Date(r.start||0)-new Date(a.start||0));l.visibleProjects=n,ee(n.length),s.projectsTableBody.innerHTML=n.map(a=>Pn(a)).join(""),re(n),Q()}function Pn(t){const e=l.customers.find(P=>String(P.id)===String(t.clientId)),n=e?.customerName||o("projects.fallback.unknownClient","عميل غير معروف"),a=(t.clientCompany||e?.companyName||"").trim(),r=t.technicians?.length||0,i=(t.equipment||[]).reduce((P,A)=>P+(A.qty||0),0),{expensesTotal:d,totalWithTax:u}=vt(t),f=Et(t.id).length,h=o("projects.table.reservationsCount","{count} حجوزات").replace("{count}",y(String(f))),b=f?`<span class="badge rounded-pill project-reservations-chip">${c(h)}</span>`:"",T=`<span class="badge project-type-badge">${c($t(t.type))}</span>`,v=t.projectCode||`PRJ-${y(String(t.id))}`,S=`<span class="project-code-badge">#${c(v)}</span>`,N=be()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${c(o("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${c(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${S}
            ${T}
          </div>
        </div>
        ${b}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${c(n)}</span><small class="text-muted">${c(a)}</small></div>`:c(n)}
      </td>
      <td>${Kt(t.start,t.end)}</td>
      <td>${y(String(r))}</td>
      <td>${y(String(i))}</td>
      <td>${B(u)}</td>
      <td>${B(d)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${c(o("actions.view","عرض"))}</button>
        ${N}
      </td>
    </tr>
  `}function Kt(t,e){if(!t)return"—";const n=nt(t);return e?`${n} - ${nt(e)}`:n}function re(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:l.visibleProjects.length?l.visibleProjects:l.projects).map(h=>{if(!h?.start)return null;const b=new Date(h.start);if(Number.isNaN(b.getTime()))return null;let j=h.end?new Date(h.end):new Date(b);return Number.isNaN(j.getTime())&&(j=new Date(b)),j<=b&&(j=new Date(b.getTime()+Zt)),{project:h,startDate:b,endDate:j}}).filter(Boolean).sort((h,b)=>h.startDate-b.startDate);if(!n.length){const h=c(o("projects.timeline.empty",s.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${h}</div>`;return}const a=n[0].startDate.getTime(),r=Math.max(...n.map(h=>h.endDate.getTime()));let i=r-a;i<=0&&(i=Zt);const d=An(n),u=o("projects.timeline.range","{start} → {end}"),p=o("projects.timeline.conflict","Scheduling conflict"),f=n.map(h=>{const{project:b,startDate:j,endDate:T}=h,v=T.getTime()-j.getTime();let S=(j.getTime()-a)/i*100;S=Math.max(0,Math.min(S,100));let E=v/i*100;E=Math.max(E,2.5),S+E>100&&(E=Math.max(1.5,100-S));const P=`project-timeline__item--${Yt(b)}`,A=d.has(b.id),F=(b.title||"").trim()||o("projects.fallback.untitled","Untitled project"),G=$e(F,26),O=l.customers.find(tt=>String(tt.id)===String(b.clientId)),U=O?.customerName||o("projects.fallback.unknownClient","Unknown client"),D=(b.clientCompany||O?.companyName||"").trim(),I=$t(b.type),z=nt(j.toISOString()),V=nt(T.toISOString()),R=u.replace("{start}",z).replace("{end}",V),$=D?`${U} (${D})`:U,L=`${F} • ${I} • ${$} | ${R}`,st=A?`<span class="project-timeline__item-conflict" title="${c(p)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${P}${A?" project-timeline__item--conflict":""}" style="left:${S}%;width:${E}%;" title="${c(L)}">
          <span class="project-timeline__item-label">${c(G)}</span>
          ${st}
        </div>
      `}).join(""),g=`
    <div class="project-timeline__scale">
      <span>${c(nt(new Date(a).toISOString()))}</span>
      <span>${c(nt(new Date(r).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${g}
    <div class="project-timeline__track">
      ${f}
    </div>
  `}function An(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const r=t[n],i=t[a];r.startDate<i.endDate&&i.startDate<r.endDate&&(e.add(r.project.id),e.add(i.project.id))}return e}function Q(){if(!s.focusCards)return;const t=Ln();if(!t.length){const e=c(o("projects.focus.empty",s.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));s.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function Ln(){if(!Array.isArray(l.projects)||!l.projects.length)return[];const t=l.projects.filter(oe),e=l.projects.filter(i=>!oe(i)&&Dn(i)),n=[],a=new Set,r=(i,d)=>{!i||a.has(i.id)||n.length>=It||(a.add(i.id),n.push(In(i,d)))};if(t.sort((i,d)=>et(i)-et(d)).forEach(i=>r(i,"today")),e.sort((i,d)=>et(i)-et(d)).forEach(i=>r(i,"thisWeek")),n.length<It){const i=Date.now();[...l.projects].filter(u=>!a.has(u.id)).filter(u=>{const p=et(u);return Number.isFinite(p)&&p>=i}).sort((u,p)=>et(u)-et(p)).forEach(u=>r(u,"upcoming"))}return n.length<It&&[...l.projects].filter(d=>!a.has(d.id)).sort((d,u)=>ne(u)-ne(d)).forEach(d=>r(d,"recent")),n}function In(t,e){const n=l.customers.find(_=>String(_.id)===String(t.clientId)),a=n?.customerName||o("projects.fallback.unknownClient","عميل غير معروف"),r=(t.clientCompany||n?.companyName||"").trim(),i=Array.isArray(t.technicians)?t.technicians.length:0,d=Et(t.id),u=d.length,p=Ee(t),{subtotal:f,applyTax:g}=vt(t),h=(t.description||"").trim(),b=h?$e(h,110):o("projects.fallback.noDescription","لا يوجد وصف"),j=$t(t.type),T=t.paymentStatus==="paid"?"paid":"unpaid",v=o(`projects.paymentStatus.${T}`,T==="paid"?"Paid":"Unpaid"),S=T==="paid"?"status-paid":"status-unpaid",E=T==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",N=t.confirmed===!0||t.confirmed==="true",P=c(String(t.id)),A=t.projectCode||`PRJ-${y(String(t.id))}`,F=y(A),G={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},O={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},U=G[e]||G.recent,D=o(U,O[e]||O.recent),I=Yt(t),z=o(`projects.status.${I}`,we[I]||I),V=wn[I]||"bg-secondary",R=(t.title||"").trim()||o("projects.fallback.untitled","Untitled project"),$=[E];N&&$.push("project-focus-card--confirmed");const L=d.reduce((_,W)=>{const X=Ce(W),Ze=(W.items||[]).reduce((en,nn)=>en+(Number(nn?.qty)||1),0),tn=(W.technicians||[]).length;return{total:_.total+X,equipment:_.equipment+Ze,crew:_.crew+tn}},{total:0,equipment:0,crew:0}),st=Number(L.total.toFixed(2)),tt=L.equipment,Y=L.crew||i,rt=g?Number(((f+st)*St).toFixed(2)):0,lt=Number((f+st+rt).toFixed(2)),gt=`<span class="project-code-badge project-focus-card__code">#${c(F)}</span>`,bt=j?`<span class="badge project-focus-card__badge bg-primary">${c(j)}</span>`:"",C=D?`<span class="project-focus-card__meta-tag">${c(D)}</span>`:"",k=`<span class="project-focus-card__status-chip ${V}">${c(z)}</span>`,ht=`<span class="reservation-chip ${S} project-focus-card__payment-chip">${c(v)}</span>`,Lt=(_,W,X)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${_?`<span class="project-focus-card__row-icon">${c(_)}</span>`:""}
        ${c(W)}
      </span>
      <span class="project-focus-card__row-value">${c(String(X))}</span>
    </div>
  `,Ke=[{icon:"👤",label:o("projects.details.client","العميل"),value:a},r?{icon:"🏢",label:o("projects.details.company","شركة العميل"),value:r}:null,{icon:"🏷️",label:o("projects.details.type","نوع المشروع"),value:j},{icon:"📅",label:o("projects.focus.summary.range","الفترة الزمنية"),value:Kt(t.start,t.end)}].filter(Boolean).map(({icon:_,label:W,value:X})=>Lt(_,W,X)).join(""),Ye=[{icon:"💳",label:o("projectCards.stats.paymentStatus","حالة الدفع"),value:v},{icon:"💸",label:o("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:B(p)},{icon:"🧮",label:o("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:B(lt)}].map(({icon:_,label:W,value:X})=>Lt(_,W,X)).join(""),Je=[{icon:"🔗",label:o("projectCards.stats.reservationsShort","الحجوزات"),value:y(String(u))},{icon:"📦",label:o("projectCards.stats.equipmentCount","عدد المعدات"),value:y(String(tt))},{icon:"😎",label:o("projectCards.stats.crewCount","عدد الطاقم"),value:y(String(Y))},{icon:"💵",label:o("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:B(st)}].map(({icon:_,label:W,value:X})=>Lt(_,W,X)).join(""),Ge=N?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${c(o("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${P}">${c(o("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`,Xe=o("projects.focus.actions.highlight","🔍 عرض في القائمة"),Qe=o("projects.focus.actions.view","👁️ عرض التفاصيل");return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${$.filter(Boolean).join(" ")}" data-project-id="${P}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${gt}
          ${bt}
          ${C}
          ${k}
          ${ht}
        </div>
        <h6 class="project-focus-card__title">${c(R)}</h6>
        <p class="project-focus-card__description">${c(b)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${c(o("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${Ke}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${c(o("projects.focus.summary.payment","الجانب المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${Ye}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${c(o("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${Je}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions">
          ${Ge}
          <button class="btn btn-sm btn-outline-secondary" data-action="highlight" data-id="${P}">${c(Xe)}</button>
          <button class="btn btn-sm btn-primary" data-action="view" data-id="${P}">${c(Qe)}</button>
        </div>
      </article>
    </div>
  `}function oe(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function Dn(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const r=a.getDay(),i=r===0?6:r-1;a.setDate(a.getDate()-i);const d=new Date(a);return d.setDate(d.getDate()+7),e>=a&&e<d}function Yt(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function Ee(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function vt(t){const e=Number(t?.equipmentEstimate)||0,n=Ee(t),a=e+n,r=Number(a.toFixed(2)),i=t?.applyTax===!0||t?.applyTax==="true";let d=i?Number(t?.taxAmount):0;i?(!Number.isFinite(d)||d<0)&&(d=Number((r*St).toFixed(2))):d=0;let u=i?Number(t?.totalWithTax):r;return i?(!Number.isFinite(u)||u<=0)&&(u=Number((r+d).toFixed(2))):u=r,{equipmentEstimate:e,expensesTotal:n,subtotal:r,applyTax:i,taxAmount:d,totalWithTax:u}}function Z(){const t=l.projects.length,e=l.projects.filter(r=>{const i=r.start?new Date(r.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=l.projects.reduce((r,i)=>r+vt(i).expensesTotal,0),a=l.projects.reduce((r,i)=>r+vt(i).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=y(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=y(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=B(n)),s.projectsBudget&&(s.projectsBudget.textContent=B(a))}function Et(t){return t?l.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Ce(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],d=Ot(e,a,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(d))return d;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Bn(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,r=t.status||t.state||"pending",i=o(`reservations.status.${r}`,r),d=String(r).toLowerCase(),p={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[d]||"project-reservation-card__badge--info",f=t.paid===!0||t.paid==="paid"||t.paidStatus==="paid",g=f?o("reservations.details.paid","مدفوع"):o("reservations.details.unpaid","غير مدفوع"),h=f?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",b=t.completed===!0||t.completed==="true",j=o("reservations.details.completed","مكتمل"),T=b?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${c(j)}</span>`:"",v=Kt(t.start,t.end),S=Ce(t),E=B(S),N=o("projects.details.reservations.items","{count} عناصر").replace("{count}",y(String((t.items||[]).length))),P=o("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",y(String((t.technicians||[]).length))),A=o("projects.details.reservations.view","👁️ عرض الحجز");return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${c(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${p}">${c(i)}</span>
          <span class="project-reservation-card__badge ${h}">${c(g)}</span>
          ${T}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${c(v)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${c(E)}</span>
          <span>📦 ${c(N)}</span>
          <span>😎 ${c(P)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        <button class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}" data-project-id="${n?n.id:""}">${c(A)}</button>
      </div>
    </article>
  `}function Nn(t){const e=Et(t.id).map(v=>({reservation:v,index:l.reservations.findIndex(S=>S===v)})).filter(({index:v})=>Number.isInteger(v)&&v>=0).sort((v,S)=>{const E=v.reservation.start?new Date(v.reservation.start).getTime():0;return(S.reservation.start?new Date(S.reservation.start).getTime():0)-E}),n=o("projects.details.reservations.title","الحجوزات المرتبطة"),a=o("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),r=o("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=o("projects.details.reservations.count","{count} حجوزات"),d=e.length?`<span class="badge project-reservations-count">${c(i.replace("{count}",y(String(e.length))))}</span>`:"",u=e.length>0,p=c(String(t.id)),f=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${p}"`];u&&f.push("disabled",'aria-disabled="true"');const g=`<button ${f.join(" ")}>${c(a)}</button>`,h=o("projects.details.actions.edit","✏️ تعديل المشروع"),b=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${p}">${c(h)}</button>`,j=`<div class="d-flex flex-wrap gap-2">${g}${b}</div>`,T=e.length?`<div class="project-reservations-list">${e.map(({reservation:v,index:S})=>Bn(v,S,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${c(r)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${c(n)}</h6>
          ${d}
        </div>
        ${j}
      </div>
      ${T}
    </section>
  `}let ie=null;function _n(t){t&&Pe()!==t&&Ht({[Vt]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function Pe(){return he()?.[Vt]||""}function Ae(t){t&&kt()!==t&&Ht({[Wt]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function kt(){return he()?.[Wt]||""}function kn(t){if(!t)return"";const e=t.trim();return e?Object.values(te).includes(e)?e:te[e]||"":""}function Mn(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=kn(e);if(n)return n}}catch{}return""}function Le(t,e){!t||!s.tabPanes||!s.tabButtons||(s.tabButtons.forEach(n=>{const a=n===e;n.classList.toggle("active",a),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",a)}),s.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&_n(t))}function qn(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const r=n.dataset.tabTarget;r&&(Le(r,n),r==="projects-section"&&(l.filters.search="",s.search&&(s.search.value=""),H(),Q(),Z()))}),n.dataset.tabListenerAttached="true")});const t=Pe(),e=t&&s.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}function Jt(t,e){!t||!s.projectSubTabButtons||!s.projectSubTabPanes||(s.projectSubTabButtons.forEach(n=>{const a=n===e;n.classList.toggle("active",a),n.classList.contains("tab")&&n.classList.toggle("tab-active",a)}),s.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}))}function Fn(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||(s.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(Jt(n,t),Ae(n))}),t.dataset.tabListenerAttached="true")}),Rn())}function Rn(){const e=Mn()||kt();if(!e)return;const n=s.projectSubTabButtons?.[0],a=s.projectSubTabButtons?.find(i=>i.dataset.projectSubtabTarget===e)||n,r=a?.dataset.projectSubtabTarget;r&&(e!==kt()&&Ae(r),Jt(r,a))}function Hn(){return s.tabButtons?s.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function ce(t={}){if(t){if(s.tabButtons&&s.tabButtons.length){const n=s.tabButtons.find(r=>r.classList.contains("active"))?.dataset.tabTarget||"",a=t[Vt];if(a&&a!==n){const r=s.tabButtons.find(i=>i.dataset.tabTarget===a);r&&Le(a,r)}}if(s.projectSubTabButtons&&s.projectSubTabButtons.length&&Hn()){const n=s.projectSubTabButtons.find(r=>r.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=t[Wt];if(a&&a!==n){const r=s.projectSubTabButtons.find(i=>i.dataset.projectSubtabTarget===a);r&&Jt(a,r)}}}}function On(){ie||(ie=sn(t=>{ce(t)})),rn().then(t=>{ce(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function Un(){if(!Array.isArray(l.projects)||l.projects.length===0)return;let t=!1;const e=l.projects.map(n=>{if(n.projectCode)return n;const a=ye();return t=!0,{...n,projectCode:a}});t&&(l.projects=e)}function zn(){const{customers:t,technicians:e,equipment:n}=pt();l.customers=Array.isArray(t)?t:[],l.technicians=Array.isArray(e)?e:[],l.equipment=Array.isArray(n)?n:[],l.reservations=J(),l.projects=mt(),Un()}function Ct(){if(Ie(),s.technicianSelect){const t=s.technicianSelect.value,e=c(o("projects.form.selectTechnician","اختر عضو الطاقم"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+l.technicians.map(n=>{const a=o("projects.fallback.technicianName","عضو {id}"),r=n.name||a.replace("{id}",y(String(n.id||"")));return`<option value="${n.id}">${c(r)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=c(o("projects.form.selectEquipment","اختر المعدة"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+l.equipment.map(n=>{const a=n.desc||n.description||n.name||o("projects.fallback.unknownEquipment","معدة");return`<option value="${c(n.barcode||"")}">${c(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function ot(t){if(!s.clientCompany)return;const e=t?.companyName||t?.company||"";s.clientCompany.value=e}function Ie(){if(!s.client)return;Vn();const t=s.client.dataset?.customerId;if(t){const e=l.customers.find(n=>String(n.id)===String(t));e?ot(e):(s.client.dataset.customerId="",ot(null))}else ot(null);document.activeElement===s.client&&Mt()}function Vn(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",Mt(),ot(null)}),s.client.addEventListener("focus",()=>{Mt()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>jt(),150)}),s.client.dataset.autocompleteAttached="true")}function jt(){s.clientSuggestions&&(s.clientSuggestions.style.display="none",s.clientSuggestions.innerHTML="")}function Mt(){if(!s.client||!s.clientSuggestions)return;const t=Wn(),e=dt(s.client.value||""),n=e?t.filter(a=>{const r=dt(a.name).includes(e),i=dt(a.company||"").includes(e);return r||i}).slice(0,10):t.slice(0,10);if(!n.length){jt();return}s.clientSuggestions.innerHTML=n.map(a=>{const r=a.company?`<div class="suggestion-item__meta">${c(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${c(String(a.id))}" data-name="${c(a.name)}" data-company="${c(a.company||"")}">
          <div class="suggestion-item__primary">${c(a.name)}</div>
          ${r}
        </div>
      `}).join(""),s.clientSuggestions.style.display="block",s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",r=>{r.preventDefault();const{id:i,name:d}=r.currentTarget.dataset;s.client&&(s.client.value=d||"",s.client.dataset.customerId=i||"");const u=r.currentTarget.dataset.company||"";ot({companyName:u}),jt()})})}function Wn(){return Array.isArray(l.customers)?l.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function Kn(t,e=""){if(!Array.isArray(l.customers)||l.customers.length===0)return null;if(e){const r=l.customers.find(i=>String(i.id)===String(e));if(r)return r}const n=dt(t||"");if(!n)return null;const a=l.customers.find(r=>dt(r.customerName||r.name||"")===n);return a||l.customers.find(r=>dt(r.customerName||r.name||"").includes(n))||null}async function Yn(t){if(l.projects.findIndex(n=>String(n.id)===String(t))!==-1&&window.confirm(o("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await fn(t),await Ut(),await ve(),l.projects=mt(),l.reservations=J(),H(),Z(),Q(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),x(o("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=ft(n)?n.message:o("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");x(a,"error")}}async function Jn(t,e){if(!t)return!1;const a=J().filter(u=>String(u.projectId)===String(t));if(!a.length)return!1;const r=e==="paid",i=r?"paid":"unpaid";let d=!1;for(const u of a){const p=u.id??u.reservationId;if(!p)continue;const f=u.paid===!0||u.paid==="paid",g=u.paidStatus||u.paymentStatus||(f?"paid":"unpaid");f===r&&g===i||(await je(p,{paid_status:i,paid:r}),d=!0)}return d&&(l.reservations=J()),d}async function Gn(t){if(!t)return!1;const e=J(),n=l.projects.find(i=>String(i.id)===String(t))||(pt().projects||[]).find?.(i=>String(i.id)===String(t))||null,a=e.filter(i=>String(i.projectId)===String(t));if(!a.length)return!1;let r=!1;for(const i of a){const d=i.id??i.reservationId;if(!d)continue;const u=gn({...i,projectId:t},n);if(u.effectiveConfirmed)continue;const p=n?.status??u.projectStatus??"confirmed";await je(d,{confirmed:!0,status:p}),r=!0}return r&&(l.reservations=J()),r}async function qt(t,e){if(!t)return!1;const n=await Jn(t,e);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let Dt=!1;function Xn(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",pa),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),jt(),xe(),s.type&&(s.type.value=""),ot(null),De()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{l.filters.search=y(s.search.value||"").trim().toLowerCase(),H()}),s.search.dataset.listenerAttached="true")}function De(){vn(),l.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),at(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),Pt()}function Qn(){s.addTechnicianBtn&&s.addTechnicianBtn.dataset.listenerAttached!=="true"&&(s.addTechnicianBtn.addEventListener("click",ra),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&s.addEquipmentBtn.dataset.listenerAttached!=="true"&&(s.addEquipmentBtn.addEventListener("click",oa),s.addEquipmentBtn.dataset.listenerAttached="true")}function Zn(){Bt(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;l.selectedTechnicians=l.selectedTechnicians.filter(n=>n!==e),Be()}}),Bt(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;l.selectedEquipment=l.selectedEquipment.filter(n=>n.barcode!==e),Ne()}}),Bt(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;l.expenses=l.expenses.filter(n=>String(n.id)!==String(e)),_e(),Z()}})}function ta(){s.addExpenseBtn&&s.addExpenseBtn.dataset.listenerAttached!=="true"&&(s.addExpenseBtn.addEventListener("click",ia),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&s.expenseAmount.dataset.normalizeAttached!=="true"&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=y(e.value||"");if(e.value=a,n!=null){const r=Math.min(a.length,n);e.setSelectionRange(r,r)}}),s.expenseAmount.dataset.normalizeAttached="true")}function Bt(t,e){!t||t.dataset.listenerAttached==="true"||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function ea({onViewDetails:t}){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached==="true"||(s.projectsTableBody.addEventListener("click",e=>{const n=e.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;t?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!be()){on();return}const a=n.dataset.id;Yn(a)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function na(){const{customers:t}=pt();l.customers=Array.isArray(t)?t:[],at(),H(),Q()}function aa(){const{technicians:t}=pt();l.technicians=Array.isArray(t)?t:[],at(),H(),Q()}function sa(t){const{reservations:e}=pt();l.reservations=Array.isArray(e)?e:[],H();const n=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),a=s.detailsBody?.dataset.projectId;n&&a&&l.projects.find(i=>String(i.id)===String(a))&&t?.(a)}function ra(){const t=s.technicianSelect?.value;if(!t){x(o("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(l.selectedTechnicians.includes(t)){x(o("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}l.selectedTechnicians.push(t),at(),x(o("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function oa(){const t=s.equipmentSelect?.value;if(!t){x(o("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(s.equipmentQty?.value||"1",10)||1),n=l.selectedEquipment.find(a=>a.barcode===t);n?n.qty+=e:l.selectedEquipment.push({barcode:t,qty:e}),at(),x(o("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function ia(){const t=(s.expenseLabel?.value||"").trim(),e=y(s.expenseAmount?.value||"0"),n=Number(e);if(!t){x(o("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){x(o("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}l.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=y(String(e))),at(),Z()}function at(){Be(),Ne(),_e(),Pt()}function Be(){s.technicianList&&Gt(s.technicianList,l.selectedTechnicians,t=>{const n=l.technicians.find(a=>String(a.id)===String(t))?.name||o("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${c(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${c(String(t))}" aria-label="${c(o("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function Ne(){s.equipmentList&&Gt(s.equipmentList,l.selectedEquipment,t=>{const e=l.equipment.find(r=>String(r.barcode||"")===String(t.barcode)),n=e?.desc||e?.description||e?.name||o("projects.fallback.unknownEquipment","معدة"),a=y(String(t.qty||1));return`
      <span class="chip">
        ${c(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${c(String(t.barcode))}" aria-label="${c(o("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function _e(){s.expenseList&&Gt(s.expenseList,l.expenses,t=>`
      <div class="expense-item">
        <span>${c(t.label)}</span>
        <span>${B(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${c(String(t.id))}" aria-label="${c(o("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function Gt(t,e,n){if(t){if(!e||e.length===0){const a=c(En(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function Pt(){if(!s.submitBtn)return;const t=!!l.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";s.submitBtn.textContent=o(e,n)}function ca(){return l.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function le(t){return y(String(t||"")).trim().toLowerCase()}function la(){if(!Array.isArray(l.selectedEquipment)||l.selectedEquipment.length===0)return{items:[],missing:[]};const t=new Map((l.equipment||[]).map(a=>[le(a?.barcode),a])),e=[],n=[];return l.selectedEquipment.forEach(a=>{const r=le(a?.barcode);if(!r){e.push(a?.barcode||"");return}const i=t.get(r);if(!i||i.id==null){e.push(a?.barcode||r);return}const d=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:i.id,qty:Number.isInteger(d)&&d>0?d:1})}),{items:n,missing:e}}function da(t){return!t||!Array.isArray(t.equipment)?[]:t.equipment.map(e=>{const n=e?.equipmentId??e?.equipment_id??e?.id??null,a=Number.parseInt(String(e?.qty??e?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function ua(){return l.selectedEquipment.reduce((t,e)=>{const n=l.equipment.find(r=>String(r.barcode||"")===String(e.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return t+a*(e.qty||1)},0)}async function pa(t){if(t.preventDefault(),Dt)return;const e=s.title?.value.trim(),n=s.type?.value||"",a=s.client?.value?.trim()||"",r=s.client?.dataset?.customerId||"",i=s.startDate?.value?.trim()||"",d=s.startTime?.value?.trim()||"";if(!e||!n||!i){x(o("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const u=Kn(a,r);if(!u){x(o("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),s.client?.focus();return}const p=String(u.id);s.client&&(s.client.dataset.customerId=p,s.client.value=u.customerName||u.name||s.client.value),ot(u);const f=s.endDate?.value?.trim()||"",g=s.endTime?.value?.trim()||"",h=de(i,d),b=f?de(f,g):"",j=new Date(h),T=b?new Date(b):null;if(T&&j>T){x(o("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}s.expenseAmount&&(s.expenseAmount.value=y(s.expenseAmount.value||""));const v=ca(),S=ua(),E=s.taxCheckbox?.checked===!0,P=(s.paymentStatus?.value||"unpaid")==="paid"?"paid":"unpaid",A=S+v,F=E?Number((A*St).toFixed(2)):0,G=Number((A+F).toFixed(2)),{items:O,missing:U}=la();if(U.length){x(o("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const D=!!l.editingProjectId,I=D?l.projects.find($=>String($.id)===String(l.editingProjectId)):null;if(D&&!I){x(o("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const z=u.companyName||u.company||"",V=s.description?.value.trim()||"",R=Se({projectCode:I?.projectCode||(D?null:ye()),title:e,type:n,clientId:p,clientCompany:z,description:V,start:h,end:b||null,applyTax:E,paymentStatus:P,equipmentEstimate:S,expenses:l.expenses.map($=>({id:$.id,label:$.label,amount:$.amount})),taxAmount:F,totalWithTax:G,confirmed:I?.confirmed??!1,technicians:l.selectedTechnicians,equipment:O});Dt=!0;try{let $=I?.projectId??I?.id??null;if(D){const L=await zt($??l.editingProjectId,R);$=L?.projectId??L?.id??$,await qt($,P),x(o("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const L=await bn(R);$=L?.projectId??L?.id??null,await qt($,P),x(o("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}l.editingProjectId=null,s.form.reset(),De(),xe(),jt(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),l.projects=mt(),l.reservations=J(),H(),Z(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch($){console.error("❌ [projects] handleSubmitProject failed",$);const L=ft($)?$.message:o("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");x(L,"error")}finally{Dt=!1}}function de(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",r="00"]=n.split(":"),i=a.padStart(2,"0"),d=r.padStart(2,"0");return`${t}T${i}:${d}`}function it(t){const e=l.projects.find(C=>String(C.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view",s.detailsBody.dataset.projectId=String(e.id);const n=l.customers.find(C=>String(C.id)===String(e.clientId)),a=qe(e.type),i=e.description?.trim()||o("projects.fallback.noDescription","لا يوجد وصف"),d=n?.customerName||o("projects.fallback.unknownClient","عميل غير معروف"),u=(e.clientCompany||n?.companyName||"").trim(),p=e.projectCode||`PRJ-${y(String(e.id))}`,f=y(p),g=Et(e.id),h=g.reduce((C,k)=>C+Sa(k),0),b=Number(h.toFixed(2)),j=g.length,{subtotal:T,applyTax:v,expensesTotal:S}=vt(e),E=T,N=v?Number(((E+b)*St).toFixed(2)):0,P=Number((E+b+N).toFixed(2)),A=Yt(e),F=o(`projects.status.${A}`,we[A]||A),O={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[A]||"status-confirmed",U=v?o("projects.details.chips.vatOn","شامل الضريبة 15٪"):o("projects.details.chips.vatOff","غير شامل الضريبة"),D=v?"status-paid":"status-unpaid",I=o("projects.details.chips.reservations","{count} حجوزات").replace("{count}",y(String(j))),z=e.paymentStatus==="paid"?"paid":"unpaid",V=o(`projects.paymentStatus.${z}`,z==="paid"?"Paid":"Unpaid"),R=z==="paid"?"status-paid":"status-unpaid",$=o("projects.focus.confirmed","✅ مشروع مؤكد"),L=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${c($)}</span>`:"",tt=[{icon:"💳",label:o("projects.details.summary.paymentStatus","حالة الدفع"),value:V},{icon:"💼",label:o("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:B(E)},{icon:"🔗",label:o("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:B(b)},{icon:"🧮",label:o("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:B(N)},{icon:"💰",label:o("projects.details.summary.overallTotal","الإجمالي الكلي"),value:B(P)}].map(({icon:C,label:k,value:ht})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${C} ${c(k)}</span>
      <span class="summary-details-value">${c(ht)}</span>
    </div>
  `).join(""),Y=[];Y.push({icon:"🆔",label:o("projects.details.labels.code","رقم المشروع"),value:`#${f}`}),Y.push({icon:"👤",label:o("projects.details.client","العميل"),value:d}),u&&Y.push({icon:"🏢",label:o("projects.details.company","شركة العميل"),value:u}),Y.push({icon:"🏷️",label:o("projects.details.type","نوع المشروع"),value:a}),Y.push({icon:"📅",label:o("projects.details.range","الفترة الزمنية"),value:Cn(e.start,e.end)});const rt=Y.map(({icon:C,label:k,value:ht})=>`
    <div class="project-info-row">
      <span>${C} ${c(k)}</span>
      <span>${c(ht)}</span>
    </div>
  `).join(""),lt=[`<span class="reservation-chip ${O}">${c(F)}</span>`,`<span class="reservation-chip ${D}">${c(U)}</span>`,`<span class="reservation-chip status-info">${c(I)}</span>`,`<span class="reservation-chip ${R}">${c(V)}</span>`,L].filter(Boolean).join(""),gt=o("projects.details.expensesTotal","إجمالي المصاريف"),bt=o("projects.details.reservationsTotal","إجمالي الحجوزات");s.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div>
          <h4 class="project-details-title">${c(e.title)}</h4>
          <div class="project-details-chips">${lt}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="open-reservation" data-project-id="${e.id}">
          ${c(o("projects.details.actions.viewReservations","📋 إدارة الحجوزات"))}
        </button>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${rt}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card">
            <h6>${c(o("projects.details.summary.title","ملخص مالي"))}</h6>
            ${tt}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${c(o("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${c(i)}</p>
    </section>
    <section class="project-details-section">
      <h5>${c(o("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${c(gt)}</span>
          <strong>${B(S)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${c(bt)}</span>
          <strong>${B(b)}</strong>
        </div>
      </div>
    </section>
    ${Nn(e)}
  `,ga(e),s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function ma({onOpenProject:t}){!s.focusCards||s.focusCards.dataset.listenerAttached==="true"||(s.focusCards.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(n){const{action:r,id:i}=n.dataset;if(r==="confirm-project"){e.preventDefault(),e.stopPropagation(),ya(i);return}r==="view"?t?.(i):r==="highlight"&&fa(i);return}const a=e.target.closest(".project-focus-card");a?.dataset.projectId&&t?.(a.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function fa(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){x(o("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function ga(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]'),n=s.detailsBody.querySelector('[data-action="edit-project"]'),a=s.detailsBody.querySelector(".project-reservations-list");e&&t&&e.addEventListener("click",r=>{r.preventDefault(),ha(t)}),n&&t&&n.addEventListener("click",r=>{r.preventDefault(),ke(t)}),a&&a.addEventListener("click",r=>{const i=r.target.closest('[data-action="view-reservation"]');if(!i)return;const d=Number.parseInt(i.dataset.index||"-1",10);!Number.isInteger(d)||d<0||(typeof window.showReservationDetails=="function"?window.showReservationDetails(d):window.location.href="dashboard.html#reservations")})}function ke(t){if(!t||!s.detailsBody)return;const e=l.projects.find(i=>String(i.id)===String(t.id));if(!e)return;const n=l.customers.find(i=>String(i.id)===String(e.clientId));n?.customerName||n?.name||e.clientName||e.customerName,e.clientCompany||n?.companyName||n?.company;const r={expenses:Array.isArray(e.expenses)?e.expenses.map((i,d)=>({id:i?.id||`expense-${e.id}-${d}-${Date.now()}`,label:i?.label||"",amount:Number(i?.amount)||0})):[]};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=va(e,r),ba(e,r)}function ba(t,e={expenses:[]}){const n=s.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",j=>{j.preventDefault(),it(t.id)});const r=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),d=n.querySelector('[data-action="add-expense"]'),u=n.querySelector("#project-edit-expense-list"),p=n.querySelector('[name="project-start-date"]'),f=n.querySelector('[name="project-start-time"]'),g=n.querySelector('[name="project-end-date"]'),h=n.querySelector('[name="project-end-time"]');function b(){u&&(u.innerHTML=Me(e.expenses))}b(),d&&d.addEventListener("click",j=>{j.preventDefault();const T=r?.value.trim()||"",v=y(i?.value||"0"),S=Number(v);if(!T){x(o("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),r?.focus();return}if(!Number.isFinite(S)||S<=0){x(o("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),i?.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:T,amount:S}),r&&(r.value=""),i&&(i.value=""),b()}),u&&u.addEventListener("click",j=>{const T=j.target.closest('[data-action="remove-expense"]');if(!T)return;const{id:v}=T.dataset;e.expenses=e.expenses.filter(S=>String(S.id)!==String(v)),b()}),n.addEventListener("submit",async j=>{if(j.preventDefault(),n.dataset.submitting==="true")return;const T=n.querySelector('[name="project-title"]'),v=n.querySelector('[name="project-type"]'),S=n.querySelector('[name="project-description"]'),E=n.querySelector('[name="project-payment-status"]'),N=n.querySelector('[name="project-apply-tax"]'),P=T?.value.trim()||"",A=v?.value||"",F=p?.value.trim()||"",G=f?.value.trim()||"",O=S?.value.trim()||"",U=E?.value==="paid"?"paid":"unpaid",D=N?.checked===!0;if(!P||!A||!F){x(o("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),T?.focus();return}const I=g?.value.trim()||"",z=h?.value.trim()||"",V=ae(F,G),R=I?ae(I,z):"",$=new Date(V),L=R?new Date(R):null;if(L&&$>L){x(o("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),g?.focus();return}if(l.projects.findIndex(C=>String(C.id)===String(t.id))===-1){x(o("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const tt=Number(t.equipmentEstimate)||0,Y=e.expenses.reduce((C,k)=>C+(Number(k.amount)||0),0),rt=tt+Y,lt=D?Number((rt*St).toFixed(2)):0,gt=D?Number((rt+lt).toFixed(2)):rt,bt=Se({projectCode:t.projectCode,title:P,type:A,clientId:t.clientId,clientCompany:t.clientCompany,description:O,start:V,end:R||null,applyTax:D,paymentStatus:U,equipmentEstimate:tt,expenses:e.expenses,taxAmount:lt,totalWithTax:gt,confirmed:t.confirmed,technicians:Array.isArray(t.technicians)?t.technicians:[],equipment:da(t)});n.dataset.submitting="true";try{const C=await zt(t.projectId??t.id,bt),k=C?.projectId??C?.id??t.id;await qt(k,U),l.projects=mt(),l.reservations=J(),x(o("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),H(),Q(),Z(),it(t.id)}catch(C){console.error("❌ [projects] Failed to update project from details view",C);const k=ft(C)?C.message:o("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");x(k,"error")}finally{delete n.dataset.submitting}})}function ha(t){if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};Ht({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(r=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",r)});let n="";try{n=encodeURIComponent(JSON.stringify(e))}catch(r){console.warn("⚠️ [projects] Unable to encode reservation context",r)}s.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function ya(t){if(!t)return;const e=l.projects.find(n=>String(n.id)===String(t));if(!e){x(o("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(e.confirmed===!0||e.confirmed==="true"){x(o("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await zt(e.projectId??e.id,{confirmed:!0});const n=await Gn(t);l.projects=mt(),l.reservations=J(),H(),Q(),Z(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&s.detailsBody?.dataset.projectId===String(t)&&it(t),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),x(o("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=ft(n)?n.message:o("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");x(a,"error")}}function va(t,e={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=se(t.start||""),{date:r,time:i}=se(t.end||""),d=t.applyTax===!0||t.applyTax==="true",u=t.paymentStatus==="paid"?"paid":"unpaid";return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control" name="project-title" value="${c(t.title||"")}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select" name="project-type" required>
            ${ja(t.type)}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.startDate","تاريخ البدء"))}</label>
          <input type="date" class="form-control" name="project-start-date" value="${c(n)}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.startTime","وقت البدء"))}</label>
          <input type="time" class="form-control" name="project-start-time" value="${c(a)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
          <input type="date" class="form-control" name="project-end-date" value="${c(r)}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.endTime","وقت الانتهاء"))}</label>
          <input type="time" class="form-control" name="project-end-time" value="${c(i)}">
        </div>
        <div class="col-12">
          <label class="form-label">${c(o("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control" name="project-description" rows="3">${c(t.description||"")}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">${c(o("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select" name="project-payment-status">
            <option value="unpaid" ${u==="unpaid"?"selected":""}>${c(o("projects.paymentStatus.unpaid","قيد الانتظار"))}</option>
            <option value="paid" ${u==="paid"?"selected":""}>${c(o("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" name="project-apply-tax" id="project-apply-tax" ${d?"checked":""}>
          <label class="form-check-label" for="project-apply-tax">${c(o("projects.form.labels.applyTax","تطبيق الضريبة 15٪"))}</label>
        </div>
      </div>

      <section class="project-edit-expenses mt-4">
        <h6>${c(o("projects.form.labels.expenses","المصاريف"))}</h6>
        <div class="project-edit-expense-form row g-2 align-items-center">
          <div class="col-md-6">
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${c(o("projects.form.placeholders.expenseLabel","وصف المصروف"))}">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control" id="project-edit-expense-amount" placeholder="${c(o("projects.form.placeholders.expenseAmount","المبلغ"))}" min="0">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" data-action="add-expense">${c(o("projects.form.buttons.addExpense","إضافة"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${Me(e.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${c(o("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${c(o("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function ja(t){return["commercial","coverage","photography","social"].map(n=>{const a=qe(n),r=n===t?"selected":"";return`<option value="${c(n)}" ${r}>${c(a)}</option>`}).join("")}function Me(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${c(o("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=c(o("actions.remove","إزالة"));return t.map(n=>{const a=c(n?.label||""),r=c(B(n?.amount||0)),i=c(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${r}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function qe(t){if(!t)return o("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return o(e,t)}function Sa(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],d=Ot(e,a,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(d))return d;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Fe(t){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(t);if(a)return a}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const a=new URLSearchParams(e).get(t);if(a)return a}catch{}return null}function Ta(){return Fe(Nt)}function xa(){return Fe(_t)}function wa(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[Nt,_t].forEach(p=>{t.has(p)&&(t.delete(p),n=!0)});let a=e,r=!1;if(e)try{const p=new URLSearchParams(e);let f=!1;[Nt,_t].forEach(g=>{p.has(g)&&(p.delete(g),f=!0)}),f&&(a=p.toString(),r=!0)}catch{}if(!n&&!r)return;const i=window.location.pathname,d=t.toString(),u=`${i}${d?`?${d}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",u)}catch{}}function $a(){const t=Ta(),e=xa();t&&(l.pendingProjectDetailId=t),e&&(l.pendingProjectEditId=e,l.pendingProjectDetailId||(l.pendingProjectDetailId=e)),(t||e)&&wa()}function Ea(){if(!l.pendingProjectDetailId)return;const t=l.pendingProjectDetailId,e=String(t),n=l.projects.find(r=>[r?.id,r?.projectId,r?.project_id].some(d=>d!=null&&String(d)===e));if(!n)return;l.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??e;if(it(a),l.pendingProjectEditId!=null){const r=String(l.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(d=>d!=null&&String(d)===r)&&(l.pendingProjectEditId=null,setTimeout(()=>ke(n),0))}}function Ca(){document.addEventListener("DOMContentLoaded",()=>{On(),$a(),Sn(),Pt(),Tn(),qn(),Fn(),xn(),Xn(),Qn(),Zn(),ta(),ea({onViewDetails:it}),ma({onOpenProject:it}),Ie(),Pa()}),document.addEventListener("language:changed",ue),document.addEventListener("language:translationsReady",ue),document.addEventListener("customers:changed",Aa),document.addEventListener("technicians:updated",La),document.addEventListener("reservations:changed",()=>sa(it)),document.addEventListener(cn.USER_UPDATED,()=>{H()})}async function Pa(){try{await Te({suppressError:!0}),await Ut()}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||o("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");x(e,"error")}finally{zn(),Ct(),at(),H(),Z(),Q(),Ea()}}function ue(){Ct(),at(),H(),Z(),Q(),Pt()}function Aa(){na(),Ct()}function La(){aa(),Ct()}ln();dn();un();hn();Ca();document.addEventListener("DOMContentLoaded",()=>{mn(),pn()});const pe=.15,Tt={},Ia="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let yt=0;const w={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},m={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},xt=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `});let q=null;const Re=["upcoming","ongoing","completed"];async function Da({forceProjects:t=!1}={}){try{await Te({suppressError:!0}),await yn({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),ft(e)&&console.warn("Projects API error:",e.message)}ze()}async function Ba(){ka(),Oe(),await Na();try{await Da({forceProjects:!0}),We(),Oa(),K()}finally{Ue()}document.addEventListener("language:changed",za),document.addEventListener("projects:changed",()=>{Ft().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})}),document.addEventListener("reservations:changed",()=>{Ft().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})}),window.addEventListener("storage",Va)}document.addEventListener("DOMContentLoaded",Ba);async function Na(){if(q)return q;if(typeof window>"u")return null;if(window.ApexCharts)return q=window.ApexCharts,q;try{await _a(Ia),q=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),q=null}return q}function _a(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const a=document.querySelector(`script[src="${t}"]`);if(a){if(a.dataset.loaded==="true"){e();return}a.addEventListener("load",e,{once:!0}),a.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const r=document.createElement("script");r.src=t,r.async=!0,r.dataset.loaded="false",r.onload=()=>{r.dataset.loaded="true",e()},r.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(r)})}function ka(){m.search=document.getElementById("reports-search"),m.statusChips=document.getElementById("reports-status-chips"),m.payment=document.getElementById("reports-payment"),m.dateRange=document.getElementById("reports-date-range"),m.customRangeWrapper=document.getElementById("reports-custom-range"),m.startDate=document.getElementById("reports-start-date"),m.endDate=document.getElementById("reports-end-date"),m.refreshBtn=document.getElementById("reports-refresh"),m.kpiGrid=document.getElementById("reports-kpi-grid"),m.table=document.getElementById("reports-table"),m.tableBody=m.table?.querySelector("tbody"),m.tableMeta=document.getElementById("reports-table-meta"),m.tableEmpty=document.getElementById("reports-empty"),m.chartCards={},m.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;m.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(m.chartLoaders[e]=n)})}function He(t){const e=!!t;Object.entries(m.chartCards||{}).forEach(([n,a])=>{if(!a)return;a.classList.toggle("is-loading",e),a.setAttribute("aria-busy",e?"true":"false");const r=m.chartLoaders?.[n];r&&(r.hidden=!e)})}function Oe(){yt+=1,yt===1&&He(!0)}function Ue(){yt=Math.max(0,yt-1),yt===0&&He(!1)}function ze(){const{customers:t=[]}=pt();w.customers=Array.isArray(t)?t:[],w.reservations=J();const e=new Map(w.customers.map(a=>[String(a.id),a])),n=mt();w.projects=Array.isArray(n)?n.map(a=>Ma(a,e)):[],w.totalProjects=w.projects.length}function Ma(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",a=e.get(String(t.clientId)),r=qa(t.id),i=r.reduce((S,E)=>S+Fa(E),0),d=Ra(t),u=Number(t?.equipmentEstimate)||0,p=Number((u+d).toFixed(2)),f=t?.applyTax===!0||t?.applyTax==="true",g=f?Number((p*pe).toFixed(2)):0,h=f?Number(((p+i)*pe).toFixed(2)):0,b=Number((p+i+h).toFixed(2)),j=Ha(t),T=t.start?new Date(t.start):null,v=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:a?.customerName||a?.name||"",clientCompany:t.clientCompany||a?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:T,end:v,applyTax:f,status:j,reservationsTotal:Number(i.toFixed(2)),expensesTotal:d,subtotal:p,taxAmount:g,combinedTaxAmount:h,overallTotal:b,unpaidValue:n==="paid"?0:b,reservationsCount:r.length}}function qa(t){return Array.isArray(w.reservations)?w.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Fa(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(y(String(n)))||0,r=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],d=Ot(e,a,r,!1,i,{start:t.start,end:t.end});if(Number.isFinite(d))return d;const u=Number(y(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function Ra(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function Ha(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function Oa(){if(m.search){let t;m.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{w.filters.search=m.search.value.trim(),K()},180)})}m.payment&&(m.payment.value=w.filters.payment,m.payment.addEventListener("change",()=>{w.filters.payment=m.payment.value||"all",K()})),m.dateRange&&(m.dateRange.addEventListener("change",Ua),m.dateRange.value=w.filters.range),m.startDate&&m.startDate.addEventListener("change",()=>{w.filters.startDate=m.startDate.value,w.filters.range==="custom"&&K()}),m.endDate&&m.endDate.addEventListener("change",()=>{w.filters.endDate=m.endDate.value,w.filters.range==="custom"&&K()}),m.refreshBtn&&m.refreshBtn.addEventListener("click",()=>{if(w.filters.range!=="custom"){K();return}w.filters.startDate=m.startDate?.value||"",w.filters.endDate=m.endDate?.value||"",K()})}function Ua(t){const e=t.target.value;w.filters.range=e,e==="custom"?m.customRangeWrapper?.classList.add("active"):(m.customRangeWrapper?.classList.remove("active"),w.filters.startDate="",w.filters.endDate="",m.startDate&&(m.startDate.value=""),m.endDate&&(m.endDate.value=""),K())}async function Ft(){Oe();try{await Promise.all([Ut(),ve()])}catch(t){console.error("❌ [projectsReports] Data mutation refresh failed",t),ft(t)&&console.warn("Projects API error:",t.message)}finally{ze(),K(),Ue()}}function za(){We(),K()}function Va(t){t.key&&!["projects","reservations","customers"].includes(t.key)||Ft().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function K(){const t=Wa();Xt(),Ja(t),Xa(t),Qa(t),Za(t),ts(t),es(t)}function Wa(){const{search:t,statuses:e,payment:n,range:a,startDate:r,endDate:i}=w.filters,d=Ve(t),u=new Date,p=Number(a);let f=null;if(a==="custom"){f=r?new Date(r):null;const g=i?new Date(i):null;return w.projects.filter(h=>!me(h,e)||!fe(h,n)||!ge(h,d)?!1:Ya(h.start,f,g))}return a!=="all"&&Number.isFinite(p)&&(f=new Date,f.setDate(u.getDate()-p)),w.projects.filter(g=>!me(g,e)||!fe(g,n)||!ge(g,d)?!1:a==="all"?!0:Ka(g.start,f,u))}function me(t,e){return e.includes(t.status)}function fe(t,e){return e==="all"?!0:t.paymentStatus===e}function ge(t,e){return e?Ve([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function Ka(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function Ya(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const a=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&a<e.getTime()||n&&!Number.isNaN(n.getTime())&&a>n.getTime())}function Ve(t){return t?y(String(t)).toLowerCase().trim():""}function Ja(t){if(!m.kpiGrid)return;const e=t.length,n=t.reduce((d,u)=>d+u.overallTotal,0),a=t.reduce((d,u)=>d+u.unpaidValue,0),r=t.reduce((d,u)=>d+u.expensesTotal,0),i=[{icon:xt.projects,label:o("projects.reports.kpi.totalProjects","Total projects"),value:Rt(e),meta:o("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:xt.value,label:o("projects.reports.kpi.totalValue","Total value"),value:wt(n),meta:o("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:xt.outstanding,label:o("projects.reports.kpi.unpaidValue","Outstanding value"),value:wt(a),meta:o("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:xt.expenses,label:o("projects.reports.kpi.expenses","Total expenses"),value:wt(r),meta:o("projects.reports.kpi.expensesMeta","Expenses for included projects")}];m.kpiGrid.innerHTML=i.map(({icon:d,label:u,value:p,meta:f})=>`
    <div class="reports-kpi-card glass-card">
      <div class="reports-kpi-icon">${d}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${M(u)}</p>
        <p class="reports-kpi-value">${M(p)}</p>
        <span class="reports-kpi-meta">${M(f)}</span>
      </div>
    </div>
  `).join("")}function We(){if(!m.statusChips)return;const t=Re.map(e=>{const n=o(`projects.status.${e}`,e);return`<button type="button" class="btn btn-outline-primary reports-status-chip" data-status="${e}">${M(n)}</button>`}).join("");m.statusChips.innerHTML=t,m.statusChips.dataset.listenerAttached||(m.statusChips.addEventListener("click",Ga),m.statusChips.dataset.listenerAttached="true"),Xt()}function Ga(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const a=new Set(w.filters.statuses);a.has(n)?a.delete(n):a.add(n),a.size===0&&Re.forEach(r=>a.add(r)),w.filters.statuses=Array.from(a),Xt(),K()}function Xt(){if(!m.statusChips)return;const t=new Set(w.filters.statuses);m.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Xa(t){if(!q)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],a=n.map(p=>t.filter(f=>f.status===p).length),r=n.map(p=>o(`projects.status.${p}`,p)),d=a.reduce((p,f)=>p+f,0)>0?a:[],u={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:r,series:d,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:p=>Number.isFinite(p)?`${Math.round(p)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:p=>ct(p)}},noData:{text:o("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};At("status",e,u)}function Qa(t){if(!q)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,a=new Intl.DateTimeFormat(as(),{month:"short",year:"numeric"});t.forEach(g=>{if(!g.start||Number.isNaN(g.start.getTime()))return;const h=`${g.start.getFullYear()}-${g.start.getMonth()+1}`,b=n.get(h)||{total:0,label:a.format(g.start)};b.total+=g.overallTotal,n.set(h,b)});const i=Array.from(n.keys()).sort((g,h)=>{const[b,j]=g.split("-").map(Number),[T,v]=h.split("-").map(Number);return b===T?j-v:b-T}).slice(-12),d=i.map(g=>n.get(g)?.label||g),u=i.map(g=>Math.round(n.get(g)?.total||0)),p=u.length?[{name:o("projects.reports.datasets.value","Total value"),data:u}]:[],f={chart:{type:"area",height:320,toolbar:{show:!1}},series:p,xaxis:{categories:d,labels:{rotate:-35}},yaxis:{labels:{formatter:g=>ct(g)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:g=>ct(g)}},noData:{text:o("projects.reports.noData","لا توجد بيانات متاحة")}};At("timeline",e,f)}function Za(t){if(!q)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((f,g)=>g.overallTotal-f.overallTotal).slice(0,6),a=n.map(f=>f.title||f.projectCode),r=n.map(f=>Math.round(f.overallTotal)),i=n.map(f=>Math.round(f.expensesTotal)),d=a.length?[{name:o("projects.reports.datasets.value","Total value"),data:r},{name:o("projects.reports.datasets.expenses","Expenses"),data:i}]:[],p={chart:{type:"bar",height:Math.max(320,a.length*60||0),toolbar:{show:!1}},series:d,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:a,labels:{formatter:f=>ct(f)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:f=>ct(f)}},noData:{text:o("projects.reports.noData","لا توجد بيانات متاحة")}};At("expenses",e,p)}function ts(t){if(!q)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(p=>{const f=p.clientName||p.clientCompany||o("projects.fallback.unknownClient","Unknown client"),g=n.get(f)||0;n.set(f,g+p.overallTotal)});const a=Array.from(n.entries()).sort((p,f)=>f[1]-p[1]).slice(0,6),r=a.map(([p])=>p),i=a.map(([,p])=>Math.round(p)),d=i.length?[{name:o("projects.reports.datasets.value","Total value"),data:i}]:[],u={chart:{type:"bar",height:320,toolbar:{show:!1}},series:d,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:r,labels:{rotate:-35}},yaxis:{labels:{formatter:p=>ct(p)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:p=>ct(p)}},legend:{show:!1},noData:{text:o("projects.reports.noData","لا توجد بيانات متاحة")}};At("clients",e,u)}function At(t,e,n={}){if(!q||!e)return;if(Tt[t]){try{Tt[t].destroy()}catch(r){console.warn(`⚠️ [projectsReports] Failed to destroy ${t} chart`,r)}delete Tt[t]}e.innerHTML="";const a={...n};Array.isArray(a.series)||(a.series=[]);try{const r=new q(e,a);Tt[t]=r,r.render().catch(i=>{console.error(`❌ [projectsReports] Failed to render ${t} chart`,i)})}catch(r){console.error(`❌ [projectsReports] Failed to render ${t} chart`,r)}}function es(t){if(!m.table||!m.tableBody||!m.tableEmpty)return;if(!t.length){m.table.style.display="none",m.tableEmpty.classList.add("active"),m.tableMeta&&(m.tableMeta.textContent="");return}m.table.style.display="",m.tableEmpty.classList.remove("active");const e=t.map(n=>{const a=ns(n.start,n.end),r=o(`projects.status.${n.status}`,n.status),i=o(`projects.paymentStatus.${n.paymentStatus}`,n.paymentStatus),d=n.clientCompany?`${M(n.clientName)} <small class="text-muted">${M(n.clientCompany)}</small>`:M(n.clientName||o("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${M(n.title||n.projectCode)}</span>
            <small class="text-muted">${M(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${d}</td>
        <td>${M(r)}</td>
        <td>${M(a)}</td>
        <td>${M(wt(n.overallTotal))}</td>
        <td>${M(i)}</td>
      </tr>
    `}).join("");if(m.tableBody.innerHTML=e,m.tableMeta){const n=o("projects.reports.table.meta","Showing {count} of {total} projects");m.tableMeta.textContent=n.replace("{count}",Rt(t.length)).replace("{total}",Rt(w.totalProjects))}}function ns(t,e){if(!t&&!e)return"—";const n=t?Qt(t.toISOString()):"—",a=e?Qt(e.toISOString()):"—";return e?`${n} → ${a}`:n}function wt(t){const e=Number(t)||0,a=ut()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${y(r)} SR`}function Rt(t){const n=ut()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n).format(t))}function ct(t){const n=ut()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return y(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function as(){return ut()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function M(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
