import{d as Y,h as Z,b as S,A as w,n as ee}from"./auth.BFR8Y3ym.js";const te=Y()||{};let m=(te.projects||[]).map(ae),g=!1;function le(){return m}function j(e){m=Array.isArray(e)?e.map(R):[],Z({projects:m});try{const r=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(r),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(r)}catch(r){console.warn("⚠️ [projectsService] Failed to dispatch projects:changed event",r)}return m}async function ne(e={}){const r=new URLSearchParams;Object.entries(e).forEach(([f,p])=>{p==null||p===""||r.set(f,String(p))});const n=r.toString(),a=(await S(`/projects/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(a)?o=a:a&&typeof a=="object"&&(Array.isArray(a.items)?o=a.items:Array.isArray(a.results)?o=a.results:Array.isArray(a.data)?o=a.data:Array.isArray(a.records)&&(o=a.records));const y=o.map(T);return j(y),g=!0,m}async function ie({force:e=!1,params:r=null}={}){if(!e&&g&&m.length>0)return m;try{return await ne(r||{})}catch(n){return console.error("❌ [projectsService] Failed to load projects from API",n),m}}async function se(e){const r=await S("/projects/",{method:"POST",body:e}),n=T(r?.data??{}),i=[...m,n];return j(i),g=!0,n}async function ue(e,r){const n=await S(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:r}),i=T(n?.data??{}),a=m.map(o=>String(o.id)===String(e)?i:o);return j(a),g=!0,i}async function ce(e){await S(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const r=m.filter(n=>String(n.id)!==String(e));j(r),g=!0}function pe({projectCode:e,title:r,type:n,clientId:i,clientCompany:a,description:o,start:y,end:f,applyTax:p,paymentStatus:d,equipmentEstimate:_=0,expenses:b=[],servicesClientPrice:N=0,taxAmount:A=0,totalWithTax:t=0,discount:c=0,discountType:F="percent",companyShareEnabled:P=!1,companySharePercent:q=null,companyShareAmount:V=0,paidAmount:D=null,paidPercentage:z=null,paymentProgressType:I=null,paymentProgressValue:x=null,confirmed:W=!1,technicians:B=[],equipment:L=[],payments:$,paymentHistory:k}={}){const G=Array.isArray(B)?B.map(l=>Number.parseInt(String(l),10)).filter(l=>Number.isInteger(l)&&l>0):[],J=Array.isArray(L)?L.map(l=>{const s=Number.parseInt(String(l.equipmentId??l.equipment_id??l.id??0),10),h=Number.parseInt(String(l.qty??l.quantity??0),10);return!Number.isInteger(s)||s<=0?null:{equipment_id:s,quantity:Number.isInteger(h)&&h>0?h:1}}).filter(Boolean):[],O=Array.isArray(b)?b.map(l=>{const s=Number.parseFloat(l?.amount??l?.value??0)||0,h=(l?.label??l?.name??"").trim();if(!h)return null;const X=Number.parseFloat(l?.salePrice??l?.sale_price??0)||0,C=(l?.note??l?.notes??"").toString().trim();return{label:h,amount:Math.round(s*100)/100,sale_price:Math.max(0,Math.round(X*100)/100),note:C||void 0,...C?{notes:C}:{}}}).filter(Boolean):[],K=O.reduce((l,s)=>l+(s?.amount??0),0),u={title:r,type:n,client_id:i?Number.parseInt(String(i),10):null,client_company:a??null,description:o??null,start_datetime:y??null,end_datetime:f||null,apply_tax:!!p,payment_status:d??"unpaid",equipment_estimate:Number.parseFloat(_)||0,expenses_total:Math.round(K*100)/100,services_client_price:Number.isFinite(Number(N))?Math.round(Number(N)*100)/100:0,tax_amount:Math.round((Number.parseFloat(A)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(t)||0)*100)/100,confirmed:!!W,technicians:G,equipment:J,expenses:O},Q=Math.max(0,Number.parseFloat(c)||0);u.discount=Q,u.discount_type=F==="amount"?"amount":"percent";const E=Number.parseFloat(q),v=!!P&&Number.isFinite(E)&&E>0;u.company_share_enabled=v,u.company_share_percent=v?E:0,u.company_share_amount=v?Math.max(0,Number.parseFloat(V)||0):0,Number.isFinite(Number(D))&&(u.paid_amount=Math.max(0,Number.parseFloat(D)||0)),Number.isFinite(Number(z))&&(u.paid_percentage=Math.max(0,Number.parseFloat(z)||0)),(I==="amount"||I==="percent")&&(u.payment_progress_type=I),x!=null&&x!==""&&(u.payment_progress_value=Number.parseFloat(x)||0),e&&(u.project_code=String(e).trim());const H=$!==void 0?$:k;if(H!==void 0){const l=U(H)||[];u.payments=l.map(s=>({type:s.type,amount:s.amount!=null?s.amount:null,percentage:s.percentage!=null?s.percentage:null,value:s.value!=null?s.value:null,note:s.note??null,recorded_at:s.recordedAt??null}))}return u.end_datetime||delete u.end_datetime,u.client_company||(u.client_company=null),u}function T(e={}){return R(e)}function ae(e={}){return R(e)}function R(e={}){const r=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],i=n.map(t=>{if(t==null)return null;if(typeof t=="object"){const c=t.id??t.technician_id??t.technicianId;return c!=null?String(c):null}return String(t)}).filter(Boolean),o=(Array.isArray(e.equipment)?e.equipment:[]).map(t=>{const c=t?.equipment_id??t?.equipmentId??t?.id??null,F=t?.quantity??t?.qty??0,P=t?.barcode??t?.code??"",q=t?.description??t?.name??"";return{equipmentId:c!=null?String(c):null,qty:Number.parseInt(String(F),10)||0,barcode:P,description:q}}),f=(Array.isArray(e.expenses)?e.expenses:[]).map((t,c)=>({id:t?.id??`expense-${r??"x"}-${c}`,label:t?.label??"",amount:Number.parseFloat(t?.amount??0)||0,salePrice:Number.parseFloat(t?.sale_price??t?.salePrice??0)||0,note:t?.note??t?.notes??""})),p=Number.parseFloat(e.company_share_percent??e.companySharePercent??0)||0,d=e.company_share_enabled??e.companyShareEnabled,_=d!=null?d===!0||d===1||String(d).toLowerCase()==="true":p>0,b=e.payment_history??e.paymentHistory??e.payments??null,N=U(b),A=(()=>{const t=e.cancelled??e.canceled??e.is_cancelled??e.isCanceled;if(t===!0||t==="true"||t===1||t==="1")return!0;if(typeof t=="string"){const c=t.toLowerCase();return c==="yes"||c==="cancelled"||c==="canceled"}return!1})();return{id:r!=null?String(r):"",projectId:r!=null?Number(r):null,status:(()=>{const t=String(e.status??e.project_status??"").toLowerCase();if(A||t==="cancelled"||t==="canceled"||t==="ملغي"||t==="ملغى")return"cancelled";if(t==="completed"||t==="مكتمل")return"completed";if(t==="ongoing"||t==="in_progress"||t==="قيد التنفيذ")return"ongoing";if(t==="upcoming"||t==="قادم")return"upcoming"})(),cancelled:A,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,servicesClientPrice:Number.parseFloat(e.services_client_price??e.servicesClientPrice??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,discount:Number.parseFloat(e.discount??e.discount_value??0)||0,discountType:e.discount_type??e.discountType??"percent",companyShareEnabled:_,companySharePercent:_?p:0,companyShareAmount:Number.parseFloat(e.company_share_amount??e.companyShareAmount??0)||0,paidAmount:Number.parseFloat(e.paid_amount??e.paidAmount??0)||0,paidPercent:Number.parseFloat(e.paid_percentage??e.paidPercent??0)||0,paymentProgressType:e.payment_progress_type??e.paymentProgressType??null,paymentProgressValue:e.payment_progress_value??e.paymentProgressValue??null,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:i,techniciansDetails:n.map(t=>typeof t=="object"?t:{id:t}),equipment:o,expenses:f,paymentHistory:N}}function de(e){return e instanceof w}function M(e){if(e==null||e==="")return null;const r=ee(String(e)).replace(/[^\d.,-]/g,"").trim();if(!r)return null;let n=r;const i=n.includes(","),a=n.includes(".");i&&(n=a?n.replace(/,/g,""):n.replace(/,/g,"."));const o=Number.parseFloat(n);return Number.isFinite(o)?o:null}function re(e){if(!e||typeof e!="object")return null;const r=e.type??e.payment_type??e.paymentType??e.kind??null;let n=typeof r=="string"?r.trim().toLowerCase():null;n==="percentage"&&(n="percent");const i=M(e.value);let a=M(e.amount),o=M(e.percentage);if(n==="amount"&&a==null&&i!=null?a=i:n==="percent"&&o==null&&i!=null&&(o=i),!n)if(a!=null&&a>=0)n="amount";else if(o!=null&&o>=0)n="percent";else if(i!=null&&i>=0)n="amount",a=i;else return null;if(n==="amount"){if(a==null||!Number.isFinite(a)||a<0)return null;a=Math.round(a*100)/100}if(n==="percent"){if(o==null||!Number.isFinite(o)||o<0)return null;o=Math.min(100,Math.round(o*100)/100)}const y=e.note??e.memo??e.description??null,f=y!=null?String(y).trim():null,p=e.recordedAt??e.recorded_at??e.date??null;let d=null;if(p){const b=new Date(p);Number.isNaN(b.getTime())||(d=b.toISOString())}d||(d=new Date().toISOString());const _=n==="amount"?a:n==="percent"?o:i;return{type:n,amount:a??null,percentage:o??null,value:_!=null?Math.round(_*100)/100:null,note:f&&f.length?f.slice(0,500):null,recordedAt:d}}function U(e){if(e!==void 0)return e===null?[]:Array.isArray(e)?e.map(r=>re(r)).filter(Boolean):[]}export{pe as buildProjectPayload,se as createProjectApi,ce as deleteProjectApi,ie as ensureProjectsLoaded,le as getProjectsState,de as isApiError,ae as mapLegacyProject,T as mapProjectFromApi,ne as refreshProjectsFromApi,j as setProjectsState,ue as updateProjectApi};
