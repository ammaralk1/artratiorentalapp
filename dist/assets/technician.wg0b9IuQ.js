const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.BeilX1mk.js","./controller.DIgP-xQd.js","./auth.BWV7S1pl.js","./auth.Bg2pD_hO.css","./details.C8V43Kjr.js","./state.BIuh49pZ.js","./reservationsService.ZvfW6kI5.js","./equipment.DqBAWFES.js","./reservationPdf.B4eyj75R.js","./view.Hcy1kvBC.js","./quotePdf.DFmk2yQn.js","./canvasColorUtils.CviLtv6S.js","./reservationsActions.C55b0-dk.js","./projectsService.CQ6WwNGq.js","./uiBridge.BLZZT8b9.js"])))=>i.map(i=>d[i]);
import{r as de,t as u,n as D,d as Qt,b as Ft,a as ue,c as me,i as he,j as O,l as fe}from"./auth.BWV7S1pl.js";import"./dashboard.CwJkPkZr.js";import{o as pe}from"./projectDetails.tADWZlpp.js";import{_ as Jt,s as ge}from"./uiBridge.BLZZT8b9.js";import{s as It,r as ye,g as Xt}from"./state.BIuh49pZ.js";import{r as Zt}from"./reservationPdf.B4eyj75R.js";import{e as te}from"./reservationsActions.C55b0-dk.js";import{ensureProjectsLoaded as be,getProjectsState as De}from"./projectsService.CQ6WwNGq.js";import{a as jt,g as St,b as ve}from"./reservationsService.ZvfW6kI5.js";import{g as Pt,b as Ee,e as we}from"./projectFocusTemplates.sno3vFqT.js";import{d as Bt,s as ut}from"./view.Hcy1kvBC.js";import{i as Ae}from"./dashboardShell.DF2kUed9.js";import"./quotePdf.DFmk2yQn.js";import"./canvasColorUtils.CviLtv6S.js";import"./equipment.DqBAWFES.js";de({ar:{"technicianDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.title":"ğŸ˜ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","technicianDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.hero.subtitle":"Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø§Ø· Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… ÙˆÙ…Ù‡Ø§Ù…Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianDetails.hero.helper":"Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù….","technicianTabs.reservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianTabs.projects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianFinancial.stats.total":"ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª","technicianFinancial.stats.paid":"ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©","technicianFinancial.stats.outstanding":"ğŸ§¾ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.stats.totalDesc":"Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…","technicianFinancial.stats.paidDesc":"ØªÙ… ØªØ³Ø¬ÙŠÙ„ {count} Ø¯ÙØ¹Ø§Øª","technicianFinancial.stats.outstandingDesc":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„","technicianFinancial.modal.title":"ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„ÙÙ†ÙŠ","technicianFinancial.modal.subtitle":"Ù†Ø¸Ø±Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianFinancial.list.title":"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","technicianFinancial.assignments.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø£Ùˆ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.","technicianFinancial.list.reservation":"Ø§Ù„Ø­Ø¬Ø² / Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","technicianFinancial.list.period":"Ø§Ù„ÙØªØ±Ø©","technicianFinancial.list.due":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","technicianFinancial.list.status":"Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹","technicianFinancial.list.outstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.list.settled":"Ù„Ø§ ÙŠÙˆØ¬Ø¯","technicianFinancial.list.reservationFallback":"Ø­Ø¬Ø² Ø±Ù‚Ù… {id}","technicianFinancial.list.projectReference":"Ù…Ø´Ø±ÙˆØ¹ #{id}","technicianFinancial.status.paid":"Ù…Ø¯ÙÙˆØ¹","technicianFinancial.status.partial":"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹","technicianFinancial.status.unpaid":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹","technicianFinancial.payouts.title":"ğŸ’¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©","technicianFinancial.payouts.helper":"Ø³Ø¬Ù‘Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªÙŠ ØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ø¶Ù…Ø§Ù† ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø¯Ø§Ø¯.","technicianFinancial.payouts.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.","technicianFinancial.payouts.form.amount":"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº","technicianFinancial.payouts.form.date":"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹","technicianFinancial.payouts.form.note":"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","technicianFinancial.payouts.form.submit":"ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmDelete":"âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmMessage":"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.","technicianFinancial.payouts.confirmCancel":"Ø¥Ù„ØºØ§Ø¡","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Ø­Ø°Ù","technicianFinancial.payouts.toast.added":"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.","technicianFinancial.payouts.toast.failed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² (Ù…Ø«Ù„ #123) Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...","technicianDetails.fields.role":"ğŸ‘” Ø§Ù„ÙˆØ¸ÙŠÙØ©:","technicianDetails.fields.department":"ğŸ§© Ø§Ù„Ù‚Ø³Ù…:","technicianDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","technicianDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","technicianDetails.fields.wage":"ğŸ’° Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:","technicianDetails.fields.total":"ğŸ’¼ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:","technicianDetails.fields.baseStatus":"âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:","technicianDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","technicianDetails.fallback.email":"â€”","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"ØºÙŠØ± Ù…Ø­Ø¯Ø¯","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","technicianDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.","technicianDetails.errors.loadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.","technicianDetails.errors.reservationsLoadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...","technicianDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicians.picker.actions.apply":"ØªÙ…","technicianProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianReservations.title":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"ğŸ˜ Crew Member Profile","technicianDetails.actions.back":"â¬…ï¸ Back","technicianDetails.actions.edit":"âœï¸ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew memberâ€™s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"ğŸ“… Technician Reservations","technicianTabs.projects":"ğŸ“ Technician Projects","technicianFinancial.stats.total":"ğŸ’¼ Total Due","technicianFinancial.stats.paid":"ğŸ’° Paid Amount","technicianFinancial.stats.outstanding":"ğŸ§¾ Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š View details","technicianFinancial.modal.title":"ğŸ“Š Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"ğŸ’¸ Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"ğŸ’° Amount","technicianFinancial.payouts.form.date":"ğŸ“… Payment date","technicianFinancial.payouts.form.note":"ğŸ“ Notes (optional)","technicianFinancial.payouts.form.submit":"ğŸ’¸ Record payout","technicianFinancial.payouts.confirmDelete":"âŒ Delete this payout?","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Delete","technicianFinancial.payouts.toast.added":"âœ… Payout logged successfully.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"âš ï¸ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Unable to determine the crew member right now.","technicianDetails.filters.search":"ğŸ” Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"ğŸ‘” Role:","technicianDetails.fields.department":"ğŸ§© Department:","technicianDetails.fields.phone":"ğŸ“ Phone:","technicianDetails.fields.email":"ğŸ“§ Email:","technicianDetails.fields.wage":"ğŸ’° Daily Rate:","technicianDetails.fields.total":"ğŸ’¼ Total Charge:","technicianDetails.fields.baseStatus":"âš™ï¸ Base Status:","technicianDetails.fields.notes":"ğŸ“ Notes:","technicianDetails.fallback.email":"â€”","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"âš ï¸ Crew member not found.","technicianDetails.errors.loadFailed":"âŒ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"âŒ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"â³ Loading crew member details...","technicianDetails.edit.modalTitle":"âœï¸ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"ğŸ“ Technician Projects","technicianReservations.title":"ğŸ“… Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let mt={},y={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},_t=!1;function Dt(t=""){return D(String(t)).replace(/[Ù¬ØŒ]/g,"").trim().toLowerCase()}function ee(t,e,n){if(!e||!n)return;const{startDate:a,endDate:i}=Zt(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?i?n._flatpickr.setDate(i,!1,"Y-m-d"):n._flatpickr.clear():n.value=i||""}function N(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function ne(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!_t){try{await Promise.all([te({suppressError:!1,force:!0}),be({force:!0}).catch(()=>{})])}catch(h){console.error("âŒ [technician-details] Failed to hydrate reservations list",h),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${u("technicianDetails.errors.reservationsLoadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.")}</p>`;return}_t=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),i=document.getElementById("technician-filter-end-date"),c=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),r=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const d=()=>{let h=D(a?.value||"").trim(),b=D(i?.value||"").trim(),F=c?.value||"";if(new Set(["","today","week","month"]).has(F)||(F="",c&&(c.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),h="",b=""),!h&&!b&&F){const{startDate:$,endDate:o}=Zt(F);h=$,b=o}return{searchTerm:Dt(n?.value||""),startDate:h,endDate:b,status:l?.value||"",quickRange:F,technicianId:t}},m=()=>{mt=d(),xt("technician-reservations",mt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=D(n.value),m()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{c&&(c.value=""),m()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{c&&(c.value=""),m()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{ee(c.value,a,i),m()}),c.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",m),l.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),c&&(c.value=""),l&&(l.value=""),m()}),r.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{xt("technician-reservations",mt)},document.__techReservationsProjectListenerAttached||(document.addEventListener("projects:changed",()=>{try{typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews()}catch{}}),document.__techReservationsProjectListenerAttached=!0),m()}function ae(t){y.currentId=t;const{container:e}=J();e&&(y.initialized||(Fe(),Ie(),ke(),document.addEventListener("projects:changed",()=>{y.currentId&&B()}),document.addEventListener("language:changed",()=>{y.currentId&&B()}),document.addEventListener("customers:changed",()=>{y.currentId&&B()}),document.addEventListener("technicians:updated",()=>{y.currentId&&B()}),y.initialized=!0),B())}function J(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function Fe(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:i,rangeSelect:c}=J();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=D(t.value),B()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{c&&(c.value=""),B()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(i,{dateFormat:"Y-m-d"}),i.addEventListener("change",()=>{c&&(c.value=""),B()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{ee(c.value,a,i),B()}),c.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{B()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:l,statusSelect:r,startInput:d,endInput:m,rangeSelect:h}=J();l&&(l.value=""),r&&(r.value=""),d&&(d._flatpickr&&d._flatpickr.clear(),d.value=""),m&&(m._flatpickr&&m._flatpickr.clear(),m.value=""),h&&(h.value=""),B()}),n.dataset.listenerAttached="true")}function Ie(){const{container:t}=J();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Te),t.dataset.projectModalListenerAttached="true")}function Se(){const{container:t}=J();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const i=e.dataset.projectId?String(e.dataset.projectId):"";i&&ce(i)}),e.dataset.technicianModalListenerAttached="true")})}function Te(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&ce(a)}function ke(){ie()}function ie(){if(y.modal?.el&&y.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");if(!t||!e){const i=document.createElement("div");i.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${u("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(i.firstElementChild)}const n=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");return!n||!a?!1:(y.modal={el:n,body:a},!0)}function B(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:i}=J();if(!t||!y.currentId)return;const c=Dt(e?.value||""),l=n?.value||"",r=a?.value||"",d=i?.value||"",m=r?new Date(`${r}T00:00:00`):null,h=d?new Date(`${d}T23:59:59`):null,{projects:b=[],customers:F=[],technicians:_=[],reservations:C=[]}=Qt(),$=new Map(F.map(s=>[String(s.id),s])),o=new Map(_.map(s=>[String(s.id),s])),f=new Map(b.map(s=>[String(s.id),s])),R=Le(C),L=String(y.currentId),T=new Map,q=(s,p=null)=>{if(!s)return;const g=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(g&&!T.has(g)){const v=p??N(s?.technicians);T.set(g,{...s,technicians:v})}};b.forEach(s=>{const p=N(s?.technicians);p.length&&p.includes(L)&&q({...s,technicians:p},p)}),C.forEach(s=>{if(!s?.projectId)return;const p=N(s.technicians);if(!p.includes(L))return;const g=String(s.projectId),v=T.get(g),I=f.get(g),{effectiveConfirmed:S}=jt(s,I??v??null);if(v){const x=N(v.technicians),at=Array.from(new Set([...x,...p]));T.set(g,{...v,technicians:at,confirmed:v.confirmed||S});return}if(I){const x=N(I?.technicians),at=Array.from(new Set([...x,...p]));q({...I,technicians:at,confirmed:jt(s,I).effectiveConfirmed},at);return}q({id:g,title:s.projectTitle||s.title||s.project_title||`#${g}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:p,clientId:s.projectClientId??s.customerId??null,confirmed:S,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},p)});const dt=Array.from(T.values());y.projectsMap=T,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:T,keys:()=>Array.from(T.keys())}});const nt=dt.filter(s=>{if(c){const p=$.get(String(s.clientId))?.customerName||"",g=[s.id,s.projectId,s.project_id,s.projectCode,s.project_code,s.reference,s.reference_code,s.code,Pt(s)];if(!Dt([s.title,s.description,p,g.filter(I=>I!=null&&I!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(c))return!1}if(l&&je(s)!==l)return!1;if(m||h){const p=s.start||s.createdAt||s.created_at||null,g=s.end||s.projectEnd||s.project_end||null,v=p?new Date(p):null,I=g?new Date(g):v;if(m&&v&&v<m||h&&I&&I>h)return!1}return!0}).sort((s,p)=>{const g=new Date(s.start||s.createdAt||0).getTime();return new Date(p.start||p.createdAt||0).getTime()-g});if(!nt.length){const s=u("technicianProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=nt.map(s=>{const p=Pt(s),g=p?R.get(p)||[]:[],v=$.get(String(s.clientId))||null;return Ee(s,{customer:v,techniciansMap:o,reservations:g})}).join(""),Se()}function Le(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const i=String(a);e.has(i)||e.set(i,[]),e.get(i).push(n)}),e}function ce(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!ie()||!y.modal?.body)return;const{projects:a=[],reservations:i=[],customers:c=[]}=Qt(),l=y.projectsMap?.get(e)||null;let r=l??Rt(a,e);if(r||(r=Rt(a,e)),!r)return;const d=String(y.currentId||"");let m=N(r.technicians);!m.length&&l&&(m=N(l.technicians),r={...l,...r}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:d,normalizedTechnicians:m}}}),r={...r,technicians:m},c.find(h=>String(h.id)===String(r.clientId)),i.filter(h=>{const b=we(h);return b&&b===e}),Bt.detailsModalEl=y.modal.el,Bt.detailsBody=y.modal.body,ut.projects=De(),ut.reservations=St(),ut.customers=c||[],pe(e);try{if(!(window.bootstrap&&window.bootstrap.Modal)&&y.modal?.el){const h=y.modal.el;h.classList.add("show"),h.style.display="block",h.removeAttribute("aria-hidden")}}catch{}}function Rt(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(c=>c!=null&&String(c)===n))||null}function je(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}async function xt(t,e){try{const n=await Jt(()=>import("./reservationsUI.BeilX1mk.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url);try{n.renderReservations?.(t,e)}catch(a){console.error("âŒ [technician-details] renderReservations failed",a)}}catch(n){console.error("âŒ [technician-details] Failed to load reservations UI module",n)}}async function Pe(t,{signal:e}={}){const n=new URLSearchParams;t&&n.set("technician_id",t);const a=n.toString(),i=await Ft(`/technician-payouts/${a?`?${a}`:""}`,{signal:e});return Array.isArray(i?.data)?i.data:[]}async function Be({technicianId:t,amount:e,note:n,paidAt:a}){return(await Ft("/technician-payouts/",{method:"POST",body:{technician_id:t,amount:e,note:n,paid_at:a}}))?.data??null}async function _e(t){return(await Ft(`/technician-payouts/?id=${encodeURIComponent(t)}`,{method:"DELETE"}))?.data??null}ue();me();Ae();const Re=new URLSearchParams(window.location.search),E=Re.get("id"),M=document.getElementById("technician-details"),Mt=document.getElementById("technician-hero-name"),xe=document.getElementById("technician-hero-status"),Nt=document.getElementById("technician-hero-role"),ht=document.getElementById("technician-hero-position"),it=document.getElementById("dashboard-greeting-technician-name"),X=document.getElementById("dashboard-greeting-technician-role"),Me=document.getElementById("dashboard-greeting-technician-status"),Ct=document.getElementById("dashboard-greeting-technician-role-badge"),$t=document.getElementById("sidebar-stat-projects"),Ut=document.getElementById("sidebar-stat-reservations"),zt=document.getElementById("sidebar-stat-equipment"),Vt=document.getElementById("sidebar-stat-technicians"),j={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},A=document.getElementById("technician-financial-modal"),ct=document.getElementById("technician-financial-open"),Ht=document.getElementById("technician-financial-modal-total"),qt=document.getElementById("technician-financial-modal-paid"),Ot=document.getElementById("technician-financial-modal-outstanding"),ft=document.getElementById("technician-financial-modal-empty"),pt=document.getElementById("technician-financial-modal-table-wrapper"),gt=document.getElementById("technician-financial-modal-rows"),Ne=Array.from(document.querySelectorAll("[data-financial-modal-close]")),W=document.getElementById("technician-payout-form"),w=document.getElementById("technician-payout-amount"),Y=document.getElementById("technician-payout-date"),Ce=document.getElementById("technician-payout-note"),H=document.getElementById("technician-payouts-list"),yt=document.getElementById("technician-payouts-empty"),G=document.getElementById("technician-payout-confirm-modal"),U=document.getElementById("technician-payout-confirm-yes"),$e=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),vt=Array.from(document.querySelectorAll("[data-technician-tab]")),Ue=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let Tt="reservations",k=null,V={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},bt=[],lt=null;he();function kt(){return document.documentElement.getAttribute("lang")||"ar"}function st(t){const e=Number(t)||0,a=kt()==="ar"?"ar-SA-u-nu-latn":"en-US";try{return new Intl.NumberFormat(a,{maximumFractionDigits:0}).format(e)}catch{return D(String(e))||"0"}}function Z({projects:t=0,reservations:e=0,equipment:n=0,technicians:a=0}={}){$t&&($t.textContent=st(t)),Ut&&(Ut.textContent=st(e)),zt&&(zt.textContent=st(n)),Vt&&(Vt.textContent=st(a))}function ze(t){if(!t||typeof t!="object")return 0;const e=[t.quantity,t.qty,t.count];for(const n of e){if(n==null||n==="")continue;const a=Number(D(String(n)));if(Number.isFinite(a))return a>0?a:0}return 1}function Ve(t,e){if(!Array.isArray(t)||!t.length)return{projects:0,reservations:0,equipment:0,technicians:e?1:0};const n=new Set,a=new Set;e&&a.add(String(e));let i=0;return t.forEach(c=>{if(!c)return;c.projectId!=null&&n.add(String(c.projectId)),N(c.technicians).forEach(r=>a.add(r)),Array.isArray(c.items)&&c.items.forEach(r=>{i+=ze(r)})}),{projects:n.size,reservations:t.length,equipment:i,technicians:a.size||(e?1:0)}}function P(t){const e=Number(t)||0,a=kt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${D(i)} SR`}catch{const c=Math.round(e);return`${D(String(c))} SR`}}function Et(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const a=kt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const c=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),r=e.getFullYear();return`${c}/${l}/${r}`}}function Q(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Wt(t={}){const e=[t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(D(String(n)));if(Number.isFinite(a))return a}return 0}function He(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="technician-payment-badge technician-payment-badge--unpaid";return e==="paid"?(n="technicianFinancial.status.paid",a="technician-payment-badge technician-payment-badge--paid"):e==="partial"&&(n="technicianFinancial.status.partial",a="technician-payment-badge technician-payment-badge--partial"),`<span class="${a}" data-i18n data-i18n-key="${n}">${u(n,n)}</span>`}function Kt(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),i=Number(n.payoutsCount??0),c=u("technicianFinancial.stats.totalDesc","Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…").replace("{count}",D(String(a))),l=u("technicianFinancial.stats.paidDesc","{count} Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©").replace("{count}",D(String(i))),r=u("technicianFinancial.stats.outstandingDesc","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}"),d=e.outstanding>0?r.replace("{amount}",P(e.outstanding)):"â€”";j.total&&(j.total.textContent=P(e.total)),j.totalDesc&&(j.totalDesc.textContent=a>0?c:"â€”"),j.paid&&(j.paid.textContent=P(e.paid)),j.paidDesc&&(j.paidDesc.textContent=i>0?l:"â€”"),j.outstanding&&(j.outstanding.textContent=P(e.outstanding)),j.outstandingDesc&&(j.outstandingDesc.textContent=d)}function wt(t){const{totals:e,breakdown:n,payouts:a}=t;if(Ht&&(Ht.textContent=P(e.total)),qt&&(qt.textContent=P(e.paid)),Ot&&(Ot.textContent=P(e.outstanding)),!(!gt||!pt||!ft)){if(!n.length)gt.innerHTML="",pt.classList.add("hidden"),ft.classList.remove("hidden");else{ft.classList.add("hidden"),pt.classList.remove("hidden");const i=n.map(c=>{const l=c.period||"â€”",r=c.outstandingAmount>0?P(c.outstandingAmount):`<span class="text-success">${u("technicianFinancial.list.settled","Ù„Ø§ ÙŠÙˆØ¬Ø¯")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${Q(c.label)}</div>
            <div class="text-xs text-base-content/60">${Q(c.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${Q(l)}</td>
          <td>${P(c.dueAmount)}</td>
          <td>${He(c.paidStatus)}</td>
          <td>${r}</td>
        </tr>
      `}).join("");gt.innerHTML=i}qe(a)}}function qe(t=[]){if(!H||!yt)return;if(!Array.isArray(t)||t.length===0){H.innerHTML="",yt.classList.remove("hidden");return}const e=t.map(n=>{const a=P(n.amount||0),i=Et(n.paidAt||n.createdAt),c=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${Q(n.note)}</p>`:"",l=u("actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${Q(i)}</span>
          </div>
          ${c}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${Q(n.id)}" data-i18n data-i18n-key="actions.delete">${l}</button>
      </li>
    `}).join("");H.innerHTML=e,yt.classList.add("hidden")}function se(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function Oe(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function We(t){const e=D(String(t??""));if(!e)return"";const i=e.replace(/[Ù¬ØŒ]/g,"").replace(/[Ù«,]/g,".").replace(/[^0-9.]/g,"").split("."),c=i[0]||"",l=i.length>1?i.slice(1).join(""):"",r=c.replace(/^0+(\d)/,"$1"),d=r.length?r:l?"0":"",m=l?l.replace(/\D/g,"").slice(0,2):"";return m?`${d}.${m}`:d}function Ke(t){if(t.preventDefault(),!E){O(u("technicianFinancial.payouts.toast.invalidTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹."));return}const e=w?.value??"",n=Number.parseFloat(D(String(e)));if(!Number.isFinite(n)||n<=0){O(u("technicianFinancial.payouts.toast.invalidAmount","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.")),w?.focus();return}const a=Ce?.value?.trim()||"",i=Oe(Y?.value||null),c=W?.querySelector('button[type="submit"]');c&&(c.disabled=!0),Be({technicianId:E,amount:Number(n.toFixed(2)),note:a,paidAt:i.toISOString()}).then(l=>{O(u("technicianFinancial.payouts.toast.added","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.")),W?.reset(),Y&&(Y.value=se(l?.paidAt||new Date)),k&&et(k)}).catch(l=>{console.error("âŒ [technician-page] Failed to create technician payout",l);const r=l?.message||u("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");O(r)}).finally(()=>{c&&(c.disabled=!1)})}function Ye(t){t&&Qe(t)}function Ge(){A&&(A.classList.remove("hidden"),A.classList.add("show"),A.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),Y&&!Y.value&&(Y.value=se(new Date)))}function Lt(){A&&(A.classList.remove("show"),A.classList.remove("modal-open"),A.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function Qe(t){G&&(lt=t||null,G.classList.remove("hidden"),G.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function At(){G&&(G.classList.remove("show","modal-open"),G.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),lt=null,U&&(U.disabled=!1))}function oe(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function Je(t){if(t.preventDefault(),!k)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...k}}))}catch(a){console.error("âš ï¸ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function re(){oe().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Je),t.dataset.listenerAttached="true")})}async function et(t){if(V={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Kt(V),wt(V),Z(),!E||!t)return;try{await te({suppressError:!0})}catch(o){console.error("âš ï¸ [technician-page] Failed to load reservations for financial summary",o)}const n=St(),a=String(E);try{const o=await Pe(a);bt=Array.isArray(o)?o:[]}catch(o){console.error("âš ï¸ [technician-page] Failed to load technician payouts from API",o),bt=[]}const i=n.filter(o=>{if(!o)return!1;const f=String(o.status||"").toLowerCase();return f==="cancelled"||f==="canceled"||f==="Ù…Ù„ØºÙŠ"||f==="Ù…Ù„ØºÙ‰"||f==="Ù…Ù„ØºÙŠØ©"?!1:(Array.isArray(o.technicians)?o.technicians.map(L=>String(L)):[]).includes(a)}),c=Ve(i,a);Z(c);const l=i.map((o,f)=>{const R=Array.isArray(o.techniciansDetails)?o.techniciansDetails.find(S=>{const x=S?.id??S?.technician_id??S?.technicianId??S?.ID;return x!=null&&String(x)===a}):null,L=Wt(R)||Wt(t),T=Math.max(1,ve(o.start,o.end)),q=Math.max(0,Math.round(L*T)),dt=u("technicianFinancial.list.reservationFallback","Ø­Ø¬Ø² Ø±Ù‚Ù… {id}").replace("{id}",D(String(o.reservationId||o.id||"?"))),nt=o.title&&o.title.trim().length?o.title.trim():dt,s=[];if(o.reservationId||o.id){const S=o.reservationId||o.id;s.push(`#${D(String(S))}`)}if(o.projectId&&s.push(u("technicianFinancial.list.projectReference","Ù…Ø´Ø±ÙˆØ¹ #{id}").replace("{id}",D(String(o.projectId)))),o.status){const S=`reservations.status.${o.status}`;s.push(u(S,o.status))}const p=Et(o.start),g=Et(o.end),v=p===g?p:`${p} â€“ ${g}`,I=(()=>{const S=o.start||o.startDatetime||o.createdAt||o.created_at,x=S?new Date(S).getTime():NaN;return Number.isNaN(x)?f:x})();return{label:nt,reference:s.join(" â€¢ ")||"â€”",period:v,dueAmount:q,paidAmount:0,outstandingAmount:q,paidStatus:"unpaid",sortKey:I,originalIndex:f}}),r=bt.map(o=>({...o,amount:Number(o.amount)||0}));let d=r.reduce((o,f)=>o+f.amount,0);const h=[...l].sort((o,f)=>o.sortKey===f.sortKey?o.originalIndex-f.originalIndex:o.sortKey-f.sortKey).map(o=>{const f={...o},R=Number(o.dueAmount)||0,L=Math.min(R,Math.max(0,Number(d.toFixed(2))));L>0&&(d=Number((d-L).toFixed(2))),f.paidAmount=Number(L.toFixed(2));const T=Math.max(0,Number((R-L).toFixed(2)));return f.outstandingAmount=T,T<=.009?(f.paidStatus="paid",f.outstandingAmount=0):L>0?f.paidStatus="partial":f.paidStatus="unpaid",f}).sort((o,f)=>o.originalIndex-f.originalIndex).map(({sortKey:o,originalIndex:f,...R})=>R),b=h.reduce((o,f)=>o+f.dueAmount,0),F=r.reduce((o,f)=>o+(Number(f.amount)||0),0),_=Math.max(0,Number((b-F).toFixed(2))),C={total:Math.max(0,Number(b.toFixed(2))),paid:Math.max(0,Number(F.toFixed(2))),outstanding:_},$={assignments:h.length,payoutsCount:r.length,outstandingAmount:_};V={totals:C,metrics:$,breakdown:h,payouts:r},Kt(V),wt(V)}function z(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const i=n==null?"":String(n).trim(),c=i.length>0;t.textContent=c?`${e} ${i}`:`${e} â€”`,a?t.classList.toggle("hidden",!c):c||t.classList.remove("hidden")}function Yt(t){const e=[xe,Me].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(r=>{r.className="technician-badge hidden",r.textContent="â€”"});return}const a=n==="busy",i=["technician-badge"];i.push(a?"technician-badge--status-busy":"technician-badge--status-available");const c=a?"technicians.status.busy":"technicians.status.available",l=a?"â›” Ù…Ø´ØºÙˆÙ„":"âœ… Ù…ØªØ§Ø­";if(e.forEach(r=>{r.className=i.join(" "),r.classList.remove("hidden"),r.setAttribute("data-i18n",""),r.setAttribute("data-i18n-key",c),r.textContent=u(c,l)}),ht)if(a){const r=Xe(E),d=r&&String(r).trim().length?r:"";z(ht,"ğŸ·ï¸",d,{hideWhenEmpty:!0})}else z(ht,"ğŸ·ï¸","",{hideWhenEmpty:!0})}function Xe(t){try{const e=St();if(!Array.isArray(e)||e.length===0)return"";const n=t!=null?String(t):null;if(!n)return"";const a=new Date,i=e.find(d=>{if(!d||!d.start&&!d.startDatetime&&!d.start_datetime)return!1;const m=N(d.technicians);if(!Array.isArray(m)||!m.includes(n))return!1;const h=d.start??d.startDatetime??d.start_datetime,b=d.end??d.endDatetime??d.end_datetime;if(!h||!b)return!1;const F=new Date(h),_=new Date(b);return Number.isNaN(F.getTime())||Number.isNaN(_.getTime())?!1:F<=a&&a<_});if(!i)return"";const l=(Array.isArray(i.crewAssignments)&&i.crewAssignments.length?i.crewAssignments:Array.isArray(i.techniciansDetails)?i.techniciansDetails:[]).find(d=>{const m=d?.id??d?.technicianId??d?.technician_id;return m!=null&&String(m)===n});return l&&(l.positionLabel??l.position_name??l.position_label??l.positionKey??l.position)||""}catch{return""}}function K(t){if(!t){z(Mt,"ğŸ˜","â€”"),z(Nt,"ğŸ¯","",{hideWhenEmpty:!0}),it&&(it.textContent="â€”"),X&&(X.textContent="â€”"),z(Ct,"ğŸ¯","",{hideWhenEmpty:!0}),Yt(null);return}if(z(Mt,"ğŸ˜",t.name||"â€”"),z(Nt,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),it&&(it.textContent=t.name||"â€”"),X){const e=t.role?t.role:"";if(e)X.textContent=`ğŸ¯ ${e}`;else{const n=u("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯");X.textContent=`ğŸ¯ ${n}`}}z(Ct,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),Yt(t.status||t.baseStatus||"available")}function tt(t){oe().forEach(e=>{e.disabled=!!t})}function rt(t){t&&(Tt=t,vt.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Ue.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&E&&ae(E),t==="reservations"&&E&&ne(E))}function Ze(){vt.length&&(vt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&rt(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&rt(n)}),t.dataset.listenerAttached="true")}),rt(Tt))}K(null);tt(!0);Ze();re();ct&&!ct.dataset.listenerAttached&&(ct.addEventListener("click",()=>{wt(V),Ge()}),ct.dataset.listenerAttached="true");Ne.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{Lt()}),t.dataset.listenerAttached="true")});W&&!W.dataset.listenerAttached&&(W.addEventListener("submit",Ke),W.dataset.listenerAttached="true");H&&!H.dataset.listenerAttached&&(H.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");Ye(n)}),H.dataset.listenerAttached="true");if(w&&!w.dataset.normalizerAttached){const t=()=>{const e=We(w.value);if(e!==w.value){const n=e.length;w.value=e,w.setSelectionRange&&w.setSelectionRange(n,n)}};w.addEventListener("input",t),w.addEventListener("blur",()=>{if(t(),w.value){const e=Number.parseFloat(w.value);Number.isFinite(e)&&(w.value=e.toFixed(2))}}),w.dataset.normalizerAttached="true"}$e.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",At),t.dataset.listenerAttached="true")});U&&!U.dataset.listenerAttached&&(U.addEventListener("click",()=>{if(!lt){At();return}U.disabled=!0,_e(lt).then(()=>{O(u("technicianFinancial.payouts.toast.removed","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.")),At(),k&&et(k)}).catch(t=>{console.error("âŒ [technician-page] Failed to remove technician payout",t);const e=t?.message||u("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");O(e),U.disabled=!1})}),U.dataset.listenerAttached="true");A&&!A.dataset.listenerAttached&&(A.addEventListener("click",t=>{t.target===A&&Lt()}),A.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&A&&A.classList.contains("modal-open")&&Lt()});ge({showReservationDetails(t){Jt(()=>import("./reservationsUI.BeilX1mk.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url).then(e=>{try{e.showReservationDetails?.(t)}catch(n){console.error("âŒ showReservationDetails failed",n)}}).catch(e=>console.error("âŒ Failed to load reservations UI module",e))}});const ot=document.getElementById("logout-btn");ot&&!ot.dataset.listenerAttached&&(ot.addEventListener("click",()=>fe()),ot.dataset.listenerAttached="true");function tn(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function en(t){const e=Number(t??0);if(!Number.isFinite(e)||e<=0)return"";const n=u("technicians.badge.perDay","/Ø§Ù„ÙŠÙˆÙ…");return`${P(e)} ${n}`}function Gt(t){const e=Number(t??0);return!Number.isFinite(e)||e<=0?"":P(e)}function le(t){if(!M)return;if(K(t),!t){M.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${u("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,tt(!0);return}const e=t.phone?D(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${u("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±")}</span>`,n=t.email?t.email:`<span data-i18n data-i18n-key="technicianDetails.fallback.email">${u("technicianDetails.fallback.email","â€”")}</span>`,a=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${u("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯")}</span>`,i=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${u("technicianDetails.fallback.department","â€”")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${u("technicianDetails.fallback.notes","â€”")}</span>`,r=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${u("reservations.create.summary.currency","SR")}</span>`,d=en(t.dailyWage)||`${tn(t.dailyWage)} ${r}`,m=Gt(t.dailyTotal),h=d,b=m||Gt(t.dailyWage)||d;console.debug("[technician] amounts",{id:t.id,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,wageValue:h,totalValue:b});const _=[{key:"technicianDetails.fields.role",value:a},{key:"technicianDetails.fields.department",value:i},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.email",value:n},{key:"technicianDetails.fields.notes",value:c}].map(({key:C,value:$})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${C}">${u(C)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${$}</p>
    </article>
  `).join("");M.innerHTML=_,re(),tt(!1),rt(Tt)}async function nn(){if(!M)return;if(!E){K(null),Z(),tt(!0),k=null,M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${u("technicianDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}M.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${u("technicianDetails.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...")}</p>`,tt(!0),K(null);let t=null,e=null;try{await ye(),It()}catch(n){e=n,console.error("âŒ [technician-details] Failed to refresh technician from API",n)}if(t=Xt(E),!t){e?M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${u("technicianDetails.errors.loadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.")}</p>`:M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${u("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,K(null),Z(),k=null;return}if(!t){M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${u("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,K(null),Z(),k=null;return}k=t,await et(t),le(t),ne(E),ae(E)}It();nn();const an=async()=>{if(!E)return;It();const t=Xt(E);t&&(k=t,await et(t),le(t))};window.addEventListener("technicians:updated",an);const cn=()=>{!E||!k||et(k)};document.addEventListener("reservations:changed",cn,{passive:!0});
