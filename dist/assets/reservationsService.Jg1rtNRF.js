import{t as P,p as he,n as b,j,d as Ce,b as ze,h as gn,A as _n}from"./auth.CS33KJXJ.js";import{r as Bt,i as yn,G as dt,s as hn,k as bn,w as He,H as zt,j as kn,p as Qe,I as ye,o as be,b as Ie,L as Re,K as Mt}from"./technicians.CVAfs_kF.js";const Nn=()=>P("reservations.create.summary.currency","SR");let Ee=[],G=[];const Ue=new Map;let re=[],le=[],Q="create",pt=()=>{},mt=()=>{};const Ke=new Map,ct=450;function An(e){const t=Ke.get(e);return t!=null&&Date.now()-t<ct}function Pn(e){Ke.set(e,Date.now()),setTimeout(()=>{const t=Ke.get(e);t!=null&&Date.now()-t>=ct&&Ke.delete(e)},ct+50)}function De(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Se(e={}){return{...e,assignmentId:e.assignmentId||De()}}function Je(e){if(!e)return null;const t=String(e),n=Ee.find(c=>String(c?.id)===t);if(n)return{...n};const{technicians:i=[]}=Ce();return i.find(c=>String(c?.id)===t)||null}function Le(e={},t=he()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function ft(e={},t=he()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function jt(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=G.find(s=>String(s.id).trim().toLowerCase()===n);if(i)return i;const c=kn(e);return c||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function St(e){const t=jt(e,e?.name??""),n=he(),i=Le(t,n)||t?.name||"",c=ft(t,n);return st({assignmentId:De(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:c,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function st(e={}){const t={assignmentId:e.assignmentId||De(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=jt(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=he(),c=Le(n,i)||t.positionLabel,s=ft(n,i);t.positionLabel=c||t.positionLabel||n?.name||"",t.positionLabelAlt=s||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost))&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice))&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=Je(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function ve({forceRefresh:e=!1}={}){e||!G.length?G=yn():G=G.map(t=>({...t})),G=G.map(t=>{const n=String(t.id);if(!Ue.has(n))return t;const i=Ue.get(n);return{...t,...i?.cost!==void 0?{cost:i.cost}:{},...i?.clientPrice!==void 0?{clientPrice:i.clientPrice}:{}}})}function In(e,{cost:t,clientPrice:n}){if(e==null)return!1;const i=String(e),c={...Ue.get(i)||{}};t!==void 0&&(c.cost=t),n!==void 0&&(c.clientPrice=n),Ue.set(i,c),G=G.map(r=>String(r.id)===i?{...r,...c}:r);const s=G.find(r=>String(r.id)===i),l=s?.name?String(s.name).toLowerCase():null,a=r=>{if(!r)return!1;if(r.positionId!=null&&String(r.positionId)===i)return!0;if(!l)return!1;const u=r.positionKey??r.position_key??r.positionName??r.position_name??r.position;return u?String(u).toLowerCase()===l:!1},o=r=>{r.forEach(u=>{a(u)&&(t!==void 0&&Number.isFinite(t)&&(u.positionCost=t),n!==void 0&&Number.isFinite(n)&&(u.positionClientPrice=n))})};return o(re),o(le),Ln(),!0}function Cn(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return Se(st(t));const n=Je(t),i=n?{assignmentId:De(),positionLabel:n.role||P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:De(),positionLabel:P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return Se(st(i))}).filter(Boolean):[]}function Ne(e="create"){return e==="edit"?le.map(Se):re.map(Se)}function pe(e="create",t=[]){try{ve()}catch{}const n=Cn(t);e==="edit"?(le=n,ke("edit-selected-technicians-list",le,"edit"),mt()):(re=n,ke("selected-technicians-list",re,"create"),pt()),we()}function Xe(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),o=document.getElementById("edit-res-end")?.value?.trim(),r=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=a?He(a,r):null,m=o?He(o,u):null;let _=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const y=Number.parseInt(g,10);if(Number.isInteger(y)){const{reservations:k=[]}=Ce(),f=k?.[y];f&&(_=f.id??f.reservationId??null)}}return{start:d,end:m,ignoreReservationId:_}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",c=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?He(t,i):null,l=n?He(n,c):null;return{start:s,end:l,ignoreReservationId:null}}function we(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=Ne(Q).length;if(t){const n=P("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",b(String(t)));e.textContent=n}else e.textContent=P("technicians.picker.selectionInfo","No crew selected yet")}function Ge(e){const t=Number.isFinite(e)?e:0;return`${b(t.toFixed(2))} ${Nn()}`}function Sn(e){const t=Ne(Q),n=new Set(t.filter(r=>r.assignmentId!==e&&r.technicianId).map(r=>r.technicianId)),i=Ee.length?Ee:Ce().technicians||[],{start:c,end:s,ignoreReservationId:l}=Xe(Q),a=!!(c&&s);return i.map(r=>{const u=String(r.id),d=n.has(u),m=a?dt(u,c,s,l):!1,_=b(r.name||r.full_name||r.fullName||r.email||u);return{id:u,label:_,disabled:d||m,conflict:m,taken:d}})}function ae(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=Ne(Q);if(!t.length){const n=P("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=P("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}ve(),e.innerHTML=t.map((n,i)=>{const c=b(String(i+1)),s=Ge(n.positionClientPrice||0),l=Sn(n.assignmentId),a=P("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),o=n.technicianId!=null?String(n.technicianId):"",r=n.technicianName?b(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,d=P("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),m=P("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),_=l.map(A=>{const C=o===A.id,x=A.disabled&&!C?`${A.label} ${A.conflict?m:d}`:A.label;return`
        <option value="${A.label}"
                data-id="${A.id}"
                data-disabled="${A.disabled?"true":"false"}"
                data-conflict="${A.conflict?"true":"false"}"
                data-taken="${A.taken?"true":"false"}"
                label="${x}"></option>
      `}).join("");let g=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!g||String(g).trim()===""){const A=n.positionId?G.find(S=>String(S.id)===String(n.positionId)):null,C=!A&&n.positionKey?G.find(S=>String(S.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(A||C){const S=A||C;g=Le(S,he())||S?.name||""}}const y=n.positionLabelAlt?`<div class="text-muted small">${b(n.positionLabelAlt)}</div>`:"",k=P("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),f=P("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${c}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${b(g||P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${y}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${f}">${s}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${a}"
              value="${o?r:""}"
              aria-label="${P("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${_}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${k}">
            ${k}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{Ot(n.dataset.assignmentId,Q)}),n.dataset.listenerAttached="true")}),vn(e)}function vn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,c=()=>{qn(n,i)};n.addEventListener("change",c),n.addEventListener("blur",c),n.dataset.listenerAttached="true"})}function qn(e,t){if(!t||An(t))return;Pn(t);const n=e.value?.trim()??"";if(!n){Ve(t,"");return}const i=e.getAttribute("list"),c=i?document.getElementById(i):null,s=c?Array.from(c.options):[],l=b(n).toLowerCase(),a=s.find(r=>b(r.value).toLowerCase()===l);if(!a){j(P("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",Ve(t,"");return}if(a.dataset.disabled==="true"){if(a.dataset.conflict==="true")try{const{start:r,end:u,ignoreReservationId:d}=Xe(Q),m=a.dataset.id||"",_=r&&u&&m?zt(String(m),r,u,d):[],g=P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),y=_&&_.length?`: ${_.join("ØŒ ")}`:"";j(`${g}${y}`,"warning",6e3)}catch{j(P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else j(P("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const o=a.dataset.id;if(!o){j(P("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",Ve(t,"");return}Ve(t,o)}function We(){const e=document.getElementById("crew-position-list");if(!e)return;ve();const t=document.getElementById("crew-position-search"),n=b(String(t?.value||"")).trim().toLowerCase(),c=Ne(Q).reduce((a,o)=>{const r=o?.positionId!=null?String(o.positionId):null;return r&&a.set(r,(a.get(r)||0)+1),a},new Map),s=G.filter(a=>n?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(r=>b(String(r)).toLowerCase()).join(" ").includes(n):!0);if(!s.length){e.innerHTML=`<div class="text-muted">${P("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const l=he();e.innerHTML=s.map(a=>{const o=Le(a,l)||a.name||"",r=ft(a,l),u=Ge(a.clientPrice||0),d=Ge(a.cost||0),m=r?`<span class="crew-position-card__subtitle">${b(r)}</span>`:"",_=P("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=P("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),y=P("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),k=c.get(String(a.id))||0,f=P("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",b(String(k)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${b(o)}">
        ${k>0?`<span class="crew-position-card__badge" aria-label="${f}">${b(String(k))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${b(o)}</h6>
            ${m}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${_}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${_}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${b(String(a.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${a.clientPrice==null?"":b(String(a.clientPrice))}" inputmode="decimal" placeholder="${b("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${a.id}">${P("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${a.id}">${P("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${a.id}">
            ${y}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${a.id}">
            ${P("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.stopPropagation(),nt(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{a.dataset.editing!=="true"&&nt(a.dataset.positionId)}),a.addEventListener("keydown",o=>{if(o.key==="Enter"||o.key===" "){if(o.preventDefault(),a.dataset.editing==="true")return;nt(a.dataset.positionId)}}),a.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const r=a.closest(".crew-position-card");if(!r)return;const u=r.querySelector(".crew-position-card__metrics"),d=r.querySelector(".crew-position-card__footer"),m=r.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),m&&(m.hidden=!1),r.dataset.editing="true";const _=r.querySelector(".crew-position-edit-cost"),g=r.querySelector(".crew-position-edit-client"),y=k=>{k.addEventListener("input",f=>{const C=b(f.target.value).replace(/[^0-9.]/g,"");if(C!==f.target.value){const S=f.target.selectionEnd||C.length;f.target.value=C,f.target.setSelectionRange(S,S)}},{once:!0})};_&&y(_),g&&y(g)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const r=a.closest(".crew-position-card"),u=a.dataset.positionId;if(!r||!u)return;const d=r.querySelector(".crew-position-edit-cost"),m=r.querySelector(".crew-position-edit-client"),_=b(d?.value||"").trim(),g=b(m?.value||"").trim(),y=_===""?null:Number.parseFloat(_),k=g===""?null:Number.parseFloat(g);if(y!=null&&(!Number.isFinite(y)||y<0)){j(P("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(k!=null&&(!Number.isFinite(k)||k<0)){j(P("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),m?.focus();return}ve();const f=G.find(S=>String(S.id)===String(u));if(!f){j(P("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}const A=y==null?Number(f.cost??0):Number(y.toFixed(2)),C=k==null?Number.isFinite(Number(f.clientPrice))?Number(f.clientPrice):0:Number(k.toFixed(2));In(u,{cost:A,clientPrice:C}),j(P("technicians.picker.toast.positionOverrideSaved","âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² ÙÙ‚Ø·")),We()}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const r=a.closest(".crew-position-card");if(!r)return;const u=r.querySelector(".crew-position-card__metrics"),d=r.querySelector(".crew-position-card__footer"),m=r.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),m&&(m.hidden=!0),delete r.dataset.editing}),a.dataset.listenerAttached="true")})}function nt(e){ve();const t=G.find(c=>String(c.id)===String(e)),n=St(t||{id:null,name:""}),i=Ne(Q);i.push(n),pe(Q,i),ae(),j(P("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Ot(e,t="create"){if(!e)return;const n=Ne(t).filter(i=>i.assignmentId!==e);pe(t,n),ae(),j(P("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function Ve(e,t){if(!e)return;const n=Ne(Q),i=n.find(r=>r.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,pe(Q,n),ae(),j(P("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(n.find(r=>r.assignmentId!==e&&r.technicianId===t)){j(P("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),ae();return}const s=Je(t),{start:l,end:a,ignoreReservationId:o}=Xe(Q);if(l&&a&&dt(String(t),l,a,o)){try{const r=zt(String(t),l,a,o),u=P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=r&&r.length?`: ${r.join("ØŒ ")}`:"";j(`${u}${d}`,"warning",6e3)}catch{j(P("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}ae();return}s?(i.technicianId=String(s.id),i.technicianName=s.name??null,i.technicianRole=s.role??null,i.technicianPhone=s.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),pe(Q,n),ae(),i.technicianName?j(P("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",b(i.technicianName)),"success"):j(P("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function vt(e="create"){Q=e,ae(),we();let t=hn();if(!Array.isArray(t)||t.length===0)try{const i=await Bt();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(Ee=t);try{await bn()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}ve(),We(),ae(),we();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function Fn(){return Ne(Q).map(Se)}function En(){const e=Fn(),{start:t,end:n,ignoreReservationId:i}=Xe(Q);if(t&&n){const s=e.filter(l=>l.technicianId&&dt(l.technicianId,t,n,i));if(s.length>0){const l=s.map(o=>o.technicianName||o.technicianId).join(P("reservations.list.crew.separator","ØŒ ")),a=P("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",l);s.forEach(o=>{o.technicianId=null,o.technicianName=null}),pe(Q,e),ae(),j(a),we();return}}pe(Q,e);const c=document.getElementById("selectTechniciansModal");c&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(c)?.hide?.(),j(P("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function ke(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${P("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}ve(),i.innerHTML=t.map(c=>{let s=c.positionLabel??c.position_label??c.position_name??c.role??c.position??"";if(!s||String(s).trim()===""){const d=c.positionId?G.find(_=>String(_.id)===String(c.positionId)):null,m=!d&&c.positionKey?G.find(_=>String(_.name).toLowerCase()===String(c.positionKey).toLowerCase()):null;s=d?Le(d,he())||d?.name||"":m&&(Le(m,he())||m?.name)||""}const l=b(s||P("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=c.technicianName?`${b(c.technicianName)}`:P("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let o=Number(c.positionClientPrice);if(!Number.isFinite(o)){const d=[c.position_client_price,c.client_price,c.customer_price,c.daily_total,c.dailyTotal,c.total];for(const m of d){const _=Number(m);if(Number.isFinite(_)){o=_;break}}}const r=Ge(Number.isFinite(o)?o:0),u=P("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${c.assignmentId}">
        <span class="technician-chip-name">${l}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${r}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${c.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(c=>{c.dataset.listenerAttached||(c.addEventListener("click",()=>{Ot(c.dataset.assignmentId,c.dataset.context)}),c.dataset.listenerAttached="true")})}}function Ln(){ae(),ke("selected-technicians-list",re,"create"),ke("edit-selected-technicians-list",le,"edit"),we(),pt(),mt()}function wn(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",l=>{const a=document.getElementById("res-customer")?.value?.trim(),o=document.getElementById("res-start")?.value?.trim(),r=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),m=!!(o&&r),_=!!(u&&d),g=!!a;if(!m||!_){l.preventDefault(),j(P("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){l.preventDefault(),j(P("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}vt("create")}),e.dataset.listenerAttached="true";const s=()=>{const l=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),o=document.getElementById("res-end")?.value?.trim(),r=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(l&&a&&o&&r&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(l=>document.getElementById(l)).filter(Boolean).forEach(l=>{["input","change"].forEach(a=>l.addEventListener(a,s))}),s()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>vt("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{We()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",En),i.dataset.listenerAttached="true");const c=document.getElementById("selectTechniciansModal");c&&!c.dataset.listenerAttached&&window.bootstrap?.Modal&&(c.addEventListener("shown.bs.modal",async()=>{if(!Ee.length&&(!Ce().technicians||Ce().technicians.length===0))try{await Bt()}catch(s){console.warn("[crew-picker] fetch on show failed",s)}We(),ae(),we()}),c.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("crew-position-search");s&&(s.value="")}),c.dataset.listenerAttached="true"),ke("selected-technicians-list",re,"create"),ke("edit-selected-technicians-list",le,"edit")}function $i({onDraftChange:e,onEditChange:t}={}){pt=typeof e=="function"?e:()=>{},mt=typeof t=="function"?t:()=>{},wn()}function Tn(){return re.map(Se)}function $n(){return le.map(Se)}function qt(){return re.map(e=>e.technicianId).filter(Boolean).map(String)}function Ft(){return le.map(e=>e.technicianId).filter(Boolean).map(String)}function Ri(e=[]){pe("create",e)}function xi(e=[]){pe("edit",e)}function Di(){pe("create",[])}function Bi(){pe("edit",[])}function Et(e=[]){return e.map(t=>{if(t.technicianId){const n=Je(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function zi(e=[]){Array.isArray(e)&&e.length&&(Ee=e),re=Et(re),le=Et(le),ke("selected-technicians-list",re,"create"),ke("edit-selected-technicians-list",le,"edit"),ae()}function Lt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Ht(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=b(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),c=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const s=t.includes(","),l=t.includes(".");if(s&&l){const o=t.lastIndexOf(","),r=t.lastIndexOf(".");o>r?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(s){const o=t.split(",");o.length===2&&o[1].length===3?t=o.join(""):t=t.replace(/,/g,".")}else if(l){const o=t.split(".");if(o.length===2){const[,r]=o;if(r.length===3){const u=o.join("");/^[0-9]+$/.test(u)&&(t=u)}}else o.length>2&&(t=Lt(t))}if(t=t.replace(/,/g,""),t=Lt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const a=Number.parseFloat(t);return Number.isFinite(a)?c?-a:a:Number.NaN}function R(e){return Ht(e)}function z(e){const t=Ht(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function xe(e){return b(String(e??"")).trim().toLowerCase()}function Vt(e=""){return b(String(e)).trim().toLowerCase()}const Rn=2;function xn(e){const t=R(e);return Number.isFinite(t)?t.toFixed(Rn):"0.00"}function it(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(b(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return z(i)}return 1}function Kt(e={}){const t=e?.desc||e?.description||e?.name||"",n=Vt(t),i=xn(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function Dn(e=[]){const t=new Map;return e.forEach((n,i)=>{const c=Kt(n);if(!c)return;if(!t.has(c)){const l=n?.desc||n?.description||n?.name||"",a=Vt(l),o=Tt(n),r=$t(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(c,{key:c,description:l,normalizedDescription:a,unitPrice:o,unitCost:r,image:u,items:[],itemIndices:[],barcodes:[]})}const s=t.get(c);s.items.push(n),s.itemIndices.push(i),n?.barcode&&s.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,c)=>i+it(c),0)})).map(n=>{const i=n.quantity||0,c=n.items.reduce((g,y)=>{const k=Tt(y),f=it(y);return g+k*f},0),s=z(c),l=R(n.unitPrice),a=Number.isFinite(l)?l:0,o=n.items.reduce((g,y)=>{const k=$t(y),f=it(y);return g+k*f},0),r=z(o),u=R(n.unitCost),d=Number.isFinite(u)?u:0,m=i>0?z(s/i):z(a),_=i>0?z(r/i):z(d);return{...n,quantity:i,count:i,totalPrice:s,unitPrice:m,totalCost:r,unitCost:_}})}function wt(e={}){return(Ie(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??xe(n?.barcode),qty:(()=>{const i=Number.parseFloat(b(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=R(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=R(n?.cost??n?.unit_cost??n?.unitCost??n?.rental_cost??n?.purchase_price);return Number.isFinite(i)?i:0})()}))}function Bn(e={},{packageQuantity:t=1}={}){const n=ye(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=n&&be(n)||e,c=Ie(i)||[],s=Number.isFinite(Number(t))&&Number(t)>0?Number(t):1;return c.map(l=>{const o=R(l?.price??l?.unit_price??l?.unitPrice),r=Number.isFinite(o)?z(o):0,u=R(l?.cost??l?.unit_cost??l?.unitCost??l?.rental_cost??l?.purchase_price),d=Number.isFinite(u)?z(u):0,m=1*s,_=z(r*m),g=z(d*m);return{equipmentId:l?.equipmentId??l?.equipment_id??null,barcode:l?.barcode??l?.normalizedBarcode??"",desc:l?.desc??l?.description??"",qtyPerPackage:1,packageQuantity:s,totalUnits:m,unitPrice:r,perDayTotal:_,unitCost:d,perDayCost:g}})}function zn(e={},{packageQuantity:t=1,days:n=1}={}){const i=Bn(e,{packageQuantity:t}),c=z(i.reduce((o,r)=>o+(Number(r.perDayTotal)||0),0)),s=z(i.reduce((o,r)=>o+(Number(r.perDayCost)||0),0)),l=z(c*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1)),a=z(s*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1));return{lines:i,perDayTotal:c,total:l,perDayCostTotal:s,costTotal:a}}function Mn(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(b(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function jn(e={},t=[],n=null){try{const r=ye(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(r){const u=be(r);if(u){const d=u.price??u.total_price??u.package_price,m=R(d);if(Number.isFinite(m)&&m>0)return z(m)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,c=R(i);if(Number.isFinite(c)&&c>0)return z(c);const s=e.total_price??e.totalPrice??e.total,l=R(s),a=Number.parseFloat(b(String(n)).replace(/[^0-9.]/g,"")),o=Number.isFinite(a)&&a>0?a:Mn(e);return Number.isFinite(l)&&l>0&&o>0?z(l/o):0}function On(e={},t={}){const{preserveOriginalOrder:n=!1}=t||{},i=Array.isArray(e?.items)?e.items:[],c=Dn(i),s=n?[]:null,l=h=>{!s||!h||s.push(h)},a=Qe(),o=new Set,r=new Map;a.forEach(h=>{const v=ye(h?.id??h?.packageId??h?.package_id??h?.code);v&&o.add(v);const p=b(String(h?.package_code??h?.code??"")).trim().toLowerCase();p&&r.set(p,v||p)});const u=(h,v=0)=>{const p=ye(h?.package_code??h?.packageId??h?.package_id??h?.code??h?.id??null),q=b(String(h?.package_code??h?.code??h?.barcode??"")).trim().toLowerCase();return p||(q&&r.has(q)?r.get(q):q||`pkg-${v}`)},d=new Map,m=new Map,_=new Map,g=(h,v=0,p="packages")=>{if(!h||typeof h!="object")return;const E=u(h,v)||`pkg-${v}`;if(!d.has(E)){d.set(E,{source:h,normalizedId:E,index:v,itemSource:p==="items"?h:null});return}const D=d.get(E);if(D.source||(D.source=h),p==="items"&&(D.itemSource=h,D.source&&typeof D.source=="object")){const I=Array.isArray(D.source.packageItems)&&D.source.packageItems.length>0,N=Array.isArray(h.packageItems)&&h.packageItems.length>0;!I&&N&&(D.source={...D.source,packageItems:h.packageItems}),!D.source.image&&h.image&&(D.source={...D.source,image:h.image})}},y=h=>{if(!h||typeof h!="object")return;const v=u(h);v&&(m.has(v)||m.set(v,h))};Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(y),Array.isArray(e?.packages)&&e.packages.forEach((h,v)=>{g(h,v,"packages"),y(h)}),i.forEach((h,v)=>{if(h&&typeof h=="object"&&(h.type==="package"||Array.isArray(h?.packageItems))){const q=u(h,v+d.size);if(g({...h,package_id:q,packageId:q,package_code:h.package_code??h.code},v+d.size,"items"),q){const E=`package::${q}`;_.has(E)||_.set(E,[]),_.get(E).push(v),l(E);return}}const p=Kt(h);l(p)});const k=[],f=new Set,A=new Set;d.forEach(({source:h,itemSource:v=null,normalizedId:p},q)=>{const E=p?be(p):null,D=h&&typeof h=="object"?h:{},I=E?{...E,...D}:D,N=v&&typeof v=="object"?v:null;let V=wt(I);(!Array.isArray(V)||V.length===0)&&N&&(V=wt(N)),V.forEach(L=>{const M=L?.normalizedBarcode??xe(L?.barcode);M&&f.add(M);const oe=L?.equipmentId??L?.equipment_id??null;oe!=null&&A.add(String(oe))});let ue=1,T=jn(I,V,ue);const $=[N?.price,N?.unit_price,N?.unitPrice];for(const L of $){const M=R(L);if(Number.isFinite(M)&&M>0){T=z(M);break}}T=z(T);const w=[I?.unit_cost,I?.unitCost,I?.cost,N?.unit_cost,N?.unitCost,N?.cost];let Y=0;for(const L of w){const M=R(L);if(Number.isFinite(M)&&M>=0){Y=z(M);break}}if((!Y||Y===0)&&m.has(q)){const L=m.get(q),M=R(L?.unit_cost??L?.unitCost??L?.cost??L?.package_cost??L?.rental_cost??L?.purchase_price??L?.internal_cost??L?.equipment_cost??L?.item_cost);Number.isFinite(M)&&M>0&&(Y=z(M))}const me=(()=>{const L=[I?.pricing_mode,I?.pricingMode,I?.pricing,N?.pricing_mode,N?.pricingMode,N?.pricing];for(const M of L){if(M==null)continue;const oe=String(M).trim().toLowerCase();if(oe==="daily"||oe==="per_day"||oe==="day")return"daily";if(oe==="fixed"||oe==="per_booking"||oe==="booking")return"fixed"}return"daily"})(),H=[N?.total,N?.total_price,N?.totalPrice,I?.total,I?.total_price,I?.totalPrice];let U=NaN;for(const L of H){const M=R(L);if(Number.isFinite(M)&&M>=0){U=M;break}}Number.isFinite(U)||(U=T*ue),U=z(U);const fe=[I?.package_code,I?.code,I?.packageCode,I?.displayCode,I?.display_code,I?.barcode,N?.package_code,N?.code,N?.packageCode,N?.displayCode,N?.display_code,N?.barcode,p,q].find(L=>L==null?!1:String(L).trim().length>0),Z=fe!=null?b(String(fe)).trim():"";if(Z){const L=xe(Z);L&&f.add(L)}const ge=V.map(L=>b(String(L?.barcode??L?.normalizedBarcode??""))).filter(Boolean),Ae=(()=>{const L=Qe(),M=K=>b(String(K??"")).trim().toLowerCase(),oe=[Z,I?.package_code,I?.code,I?.barcode,N?.package_code,N?.code,N?.barcode,p,q].filter(Boolean).map(K=>M(K)),It=L.find(K=>{const mn=ye(K?.id??K?.packageId??K?.package_id??K?.code??K?.package_code),fn=M(K?.package_code??K?.code??K?.barcode);return oe.some(tt=>tt&&(tt===mn||tt===fn))}),Pe=m.get(q),Ct=[It?Re(It):null,Re(I),I?.packageName,I?.package_title,I?.packageTitle,I?.package_label,I?.packageLabel,I?.package,I?.pkg_name,I?.name_ar,I?.nameAr,I?.name_en,I?.nameEn,I?.title_ar,I?.titleAr,I?.title_en,I?.titleEn,I?.package_name_ar,I?.packageNameAr,I?.package_name_en,I?.packageNameEn,I?.desc,Re(N),N?.packageName,N?.package_title,N?.packageTitle,N?.package_label,N?.packageLabel,N?.package,N?.pkg_name,N?.name_ar,N?.nameAr,N?.name_en,N?.nameEn,N?.title_ar,N?.titleAr,N?.title_en,N?.titleEn,N?.package_name_ar,N?.packageNameAr,N?.package_name_en,N?.packageNameEn,N?.desc,Pe?Re(Pe):null,Pe?.packageName,Pe?.package_title,Pe?.packageTitle,Pe?.package_label,Pe?.packageLabel].find(K=>K!=null&&String(K).trim()!=="");return Ct||[Z,b(String(q))].find(K=>K!=null&&String(K).trim()!=="")||b(String(Z||q))})(),ee=V.find(L=>L?.image)?.image??I?.image??N?.image??null,se=1;k.push({key:`package::${q}`,description:Ae,normalizedDescription:b(String(Ae)),unitPrice:T,unitCost:Y,totalPrice:U,pricingMode:me,quantity:ue,count:se,image:ee,barcodes:ge,barcode:Z,package_code:Z,packageDisplayCode:Z,items:[{type:"package",packageItems:V,packageId:p,desc:Ae,price:T,cost:Y,qty:se,barcode:Z}],type:"package",packageItems:V,packageId:p,itemIndices:_.get(`package::${q}`)||[]})});const C=new Set(Array.from(f).map(h=>xe(h)).filter(Boolean)),S=c.filter(h=>{if(h.items.some(E=>E?.type==="package")&&k.length>0)return!1;const p=(E={})=>[E.packageId,E.package_id,E.package_code,E.packageCode,E.bundleId,E.bundle_id].some(D=>D!=null&&D!=="");return!h.items.every(E=>{const D=Hn(E),I=D!=null?String(D):null;if(I&&A.has(I))return!0;const N=E?.barcode?xe(E.barcode):null;return!!(N&&C.has(N)||p(E))})}),x=new Set,B=[];k.forEach(h=>{const v=u({package_code:h?.package_code,packageId:h?.packageId,package_id:h?.packageId,code:h?.barcode,id:h?.packageId});!v||x.has(v)||(x.add(v),B.push(h))});const O=B.length?[...B,...S]:c;let W=O;if(s&&s.length){const h=new Set,v=new Map;O.forEach(q=>{v.has(q.key)||v.set(q.key,q)});const p=[];s.forEach(q=>{if(h.has(q))return;const E=v.get(q);E&&(p.push(E),h.add(q))}),O.forEach(q=>{h.has(q.key)||(p.push(q),h.add(q.key))}),W=p}return{groups:W,packageGroups:k,groupedItems:c,filteredGroupedItems:S,packagesMap:d}}function Hn(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function Tt(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=R(n);if(Number.isFinite(i))return i}return 0}function $t(e={}){const t=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const n of t){const i=R(n);if(Number.isFinite(i))return i}return 0}function Mi(e){const t=e?.status??e?.reservationStatus??null;if(t){const c=String(t).trim().toLowerCase();if(c==="completed"||c==="closed"||c==="Ù…ØºÙ„Ù‚"||c==="Ù…ÙƒØªÙ…Ù„"||c==="Ù…Ù†ØªÙ‡ÙŠ"||c==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const n=new Date(e.end);return Number.isNaN(n.getTime())?!1:n<new Date}function Vn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function ji(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,c=i!=null&&i!==""&&i!=="null",s=c?Vn(t?.status??t?.status_label??t?.statusLabel??""):null,l=c&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:n,projectLinked:c,projectStatus:s,projectConfirmed:l,effectiveConfirmed:c?l:n}}const Qt=10;function Ut(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=R(n);if(Number.isFinite(i))return z(i)}return 0}function Kn(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=R(n);if(Number.isFinite(i))return z(i)}return Ut(e)}function Qn(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=Ce();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,c)=>{const s=n.get(String(c));if(!s)return i;const l=Ut(s),a=Kn(s);return{costPerDay:i.costPerDay+(Number.isFinite(l)?l:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const Un=1440*60*1e3,Fe=.01;function qe(e){if(e==null||e==="")return null;const t=b(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Rt(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let c=Number.isFinite(e)?e:0;if(c<t&&(c=t),c>n&&(c=n),i!=null){const s=10**i;c=Math.round(c*s)/s}return c}function Gt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function gt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:c=null,history:s=[]}={}){const l=Number.isFinite(Number(e))?Number(e):0,a=t==="amount"?"amount":t==="percent"?"percent":null;let o=qe(i),r=qe(c);const u=qe(n);let d=0,m=0;Array.isArray(s)&&s.length&&s.forEach(f=>{if(!f)return;const A=f.type==="amount"||f.type==="percent"?f.type:null,C=qe(f.value),S=qe(f.amount),x=qe(f.percentage);if(A==="amount"){const B=S??C;B!=null&&(d+=B,l>0&&(m+=B/l*100))}else if(A==="percent"){const B=x??C;B!=null&&(m+=B,l>0&&(d+=B/100*l))}else S!=null&&(d+=S,l>0&&(m+=S/l*100)),x!=null&&(m+=x,l>0&&(d+=x/100*l))}),a==="amount"&&u!=null?o=u:a==="percent"&&u!=null?r=u:a===null&&u!=null&&(r!=null?r=u:o=u),(o==null||o<=0)&&r!=null&&r>0&&l>0&&(o=l*(r/100)),(r==null||r<=0)&&o!=null&&o>0&&l>0&&(r=o/l*100);const _=o??0,g=r??0;o=_+d,r=g+m,o=Rt(o??0,{min:0,max:l>0?l:Number.POSITIVE_INFINITY,precision:2}),r=Rt(r??0,{min:0,max:100,precision:2});let y=a;return y||(o>0&&l>0?y="amount":r>0&&(y="percent")),{paidAmount:o,paidPercent:r,paymentProgressType:y,paymentProgressValue:y==="amount"?o:y==="percent"?r:null}}function _t({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const c=Gt(e),s=Number.isFinite(Number(i))?Number(i):0,l=Number.isFinite(Number(t))?Number(t):0,a=Number.isFinite(Number(n))?Number(n):0;if(c==="paid")return"paid";const o=s>0&&l>=s-Fe,r=a>=100-Fe*100;if(o||r)return"paid";const u=l>Fe||a>Fe;return c==="partial"||u?"partial":"unpaid"}function Gn(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const c=i.getTime()-n.getTime();if(c<=0)return 1;const s=c/Un;return Math.max(1,Math.ceil(s))}function Te({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:c="percent",applyTax:s=!1,start:l=null,end:a=null,companySharePercent:o=null,groupingSource:r=null}={}){const u=Gn(l,a);let d=!1;try{if(typeof window<"u"&&window.location){const $=new URL(window.location.href),w=($.searchParams.get("noDays")||$.searchParams.get("pricing")||"").toLowerCase();d=w==="1"||w==="true"||w==="fixed"||w==="nodays"}}catch{}const m=r&&typeof r=="object"?r:{items:Array.isArray(e)?e:[]},{groups:_}=On(m),g=$=>{if(($?.type||"").toLowerCase()==="package")return!0;const w=Array.isArray($?.items)?$.items:[];if(!w.length)return!1;if(w.some(H=>H?.reservation_id!=null||H?.reservationId!=null))return!0;const ce=w.every(H=>H?.unit_price!=null||H?.unitPrice!=null),me=w.some(H=>H?.daily_rate!=null||H?.dailyRate!=null||H?.unit_rate!=null||H?.unitRate!=null||H?.price!=null);return!!(ce&&!me)};let y=0,k=0;(Array.isArray(_)?_:[]).forEach($=>{const w=Number.isFinite(Number($?.quantity))?Number($.quantity):0,Y=Number.isFinite(Number($?.unitPrice))?Number($.unitPrice):0,ce=Number.isFinite(Number($?.unitCost))?Number($.unitCost):0,me=String($?.type||"").toLowerCase()==="package",H=g($),U=d||H?1:u;if(me){const ne=Number.isFinite(Y)?Y*w*U:null,fe=Number.isFinite(ce)?ce*w*U:null,Z={package_code:$?.package_code||$?.packageDisplayCode||$?.barcode||$?.packageId||$?.key,packageItems:Array.isArray($?.packageItems)?$.packageItems:void 0},ge=zn(Z,{packageQuantity:w,days:U}),_e=Number(ge?.total),Ae=Number.isFinite(ne)?ne:Number.isFinite(_e)?_e:0,ee=Number(ge?.costTotal),se=Number(ge?.perDayCostTotal),L=Number.isFinite(ee)?ee:Number.isFinite(se)?se*U:null,M=Number.isFinite(fe)?fe:Number.isFinite(L)?L:0;y+=Ae,k+=M}else y+=w*Y*U,k+=w*ce*U});const f=z(y),A=z(k),C=Array.isArray(n)?n:[],S=C.length?C.map($=>$?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:x,totalPerDay:B}=C.length?C.reduce(($,w)=>{const Y=R(w?.positionCost??w?.position_cost??w?.cost??w?.dailyWage??w?.daily_wage??0),ce=R(w?.positionClientPrice??w?.position_client_price??w?.clientPrice??w?.dailyTotal??w?.daily_total??w?.total??0),me=Number.isFinite(Y)?Y:0,H=Number.isFinite(ce)?ce:0;return{costPerDay:$.costPerDay+me,totalPerDay:$.totalPerDay+H}},{costPerDay:0,totalPerDay:0}):Qn(S),O=z(B*u),W=z(x*u),h=z(f+O),v=Number(i)||0;let p=c==="amount"?v:h*(v/100);(!Number.isFinite(p)||p<0)&&(p=0),p>h&&(p=h);const q=Math.max(0,h-p),E=Number.isFinite(o)&&Number(o)>0?Number(o):0,D=E>0?Math.max(0,q*(E/100)):0,I=q+D;let N=s?I*.15:0;(!Number.isFinite(N)||N<0)&&(N=0),N=Number(N.toFixed(2));const V=I+N,ue=Math.max(0,Number(V.toFixed(2))),T=Math.max(0,Math.max(0,f+O-p)-W-A);return{rentalDays:u,equipmentTotal:f,equipmentCostTotal:A,crewTotal:O,crewCostTotal:W,discountAmount:p,subtotalAfterDiscount:q,taxableAmount:I,taxAmount:N,finalTotal:ue,companySharePercent:E,companyShareAmount:D,netProfit:T}}function Oi(e=[],t=0,n="percent",i=!1,c=[],{start:s=null,end:l=null,companySharePercent:a=null}={}){const o=_=>_&&typeof _=="object"&&(_.positionId!==void 0||_.position_id!==void 0||_.positionLabel!==void 0||_.position_name!==void 0||_.positionClientPrice!==void 0),r=Array.isArray(c)&&c.some(o)?c:[],u=r.length?r.map(_=>_?.technicianId).filter(Boolean):Array.isArray(c)?c:[];return Te({items:e,technicianIds:u,crewAssignments:r,discount:t,discountType:n,applyTax:i,start:s,end:l,companySharePercent:a??Qt}).finalTotal}function Wt({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:c,paymentStatus:s,paidAmount:l=0,paidPercent:a=0,companySharePercent:o=null,companyShareAmount:r=null,taxAmount:u=null,netProfit:d=null,totalKey:m="reservations.summary.total",equipmentTotal:_=null,crewTotal:g=null,equipmentCostTotal:y=null}){const k=P("reservations.create.summary.currency","SR"),f=b(String(e)),A=b(String(t)),C=b(String(n??1)),S=b(String(i)),x=Gt(s),B=x==="paid"?"Ù…Ø¯ÙÙˆØ¹":x==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",O=P(`reservations.create.paymentStatus.${x}`,B),W=Number.isFinite(Number(l))?Math.max(0,Number(l)):0,h=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,v=W>Fe||h>Fe,p=P("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),q=b(W.toFixed(2)),E=b(h.toFixed(h%1?2:0)),D=P("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),I=P("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),N=P("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),V=P("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ue=P("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),T=P("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),$=P("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),w=P("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),ce=P(m==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",P("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),me=P("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),H=P("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),U=Number.isFinite(d)?Math.max(0,Number(d)):null,ne=[{label:D,value:A},{label:I,value:C},{label:N,value:S}],fe=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;fe!=null&&ne.push({label:V,value:`${b(fe.toFixed(2))} ${k}`});const Z=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;Z!=null&&ne.push({label:ue,value:`${b(Z.toFixed(2))} ${k}`});const ge=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(ge!=null&&ne.push({label:T,value:`${b(ge.toFixed(2))} ${k}`}),c){let ee=P("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(ee=`${b(Number(u).toFixed(2))} ${k}`),ne.push({label:$,value:ee})}const _e=Number.isFinite(o)?Number(o):null;if(_e!==null&&_e>0){const ee=Number.isFinite(r)?Number(r):e*(_e/100),se=b(String(_e)),L=b(Number.isFinite(ee)?ee.toFixed(2):"0"),M=`${se}% (${L} ${k})`;ne.push({label:me,value:M})}if(U!==null&&Math.abs(U-Number(e))>.009){const ee=b(U.toFixed(2));ne.push({label:H,value:`${ee} ${k}`})}ne.push({label:w,value:O}),v&&ne.push({label:p,value:`${q} ${k} (${E}%)`});const Ae=`${f} ${k}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${ne.map(({label:ee,value:se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${ee}</span>
            ${se?`<span class="reservation-summary-value">${se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${ce}</span>
          <span class="reservation-summary-value">${Ae}</span>
        </div>
      </div>
    </div>
  `}function Wn({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:c,paymentProgressType:s=null,paymentProgressValue:l=null,start:a,end:o,companySharePercent:r=null,paymentHistory:u=[]}){const d=Tn(),m=typeof qt=="function"?qt()??[]:[],_=Array.isArray(m)?m.map(String):[],g=d.length?d.map(B=>B?.technicianId).filter(Boolean).map(String):_,y=d.length||g.length,k=Number.isFinite(r)?Number(r):null,f=Te({items:e,technicianIds:g,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:a,end:o,companySharePercent:k}),A=gt({totalAmount:f.finalTotal,progressType:s,progressValue:l,history:u}),C=_t({manualStatus:c,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:f.finalTotal}),S=Wt({total:f.finalTotal,itemsCount:e.length,rentalDays:f.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,taxAmount:f.taxAmount,netProfit:f.netProfit,equipmentTotal:f.equipmentTotal,crewTotal:f.crewTotal,equipmentCostTotal:f.equipmentCostTotal}),x={paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:f.finalTotal};return Wn.lastResult=x,Jn(S),S}function Yn({items:e,discount:t,discountType:n,applyTax:i,paidStatus:c,paymentProgressType:s=null,paymentProgressValue:l=null,start:a,end:o,companySharePercent:r=null,paymentHistory:u=[]}){const d=$n(),m=typeof Ft=="function"?Ft()??[]:[],_=Array.isArray(m)?m.map(String):[],g=d.length?d.map(B=>B?.technicianId).filter(Boolean).map(String):_,y=d.length||g.length,k=Number.isFinite(r)?Number(r):null,f=Te({items:e,technicianIds:g,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:a,end:o,companySharePercent:k}),A=gt({totalAmount:f.finalTotal,progressType:s,progressValue:l,history:u}),C=_t({manualStatus:c,paidAmount:A.paidAmount,paidPercent:A.paidPercent,totalAmount:f.finalTotal}),S=Wt({total:f.finalTotal,itemsCount:e.length,rentalDays:f.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,taxAmount:f.taxAmount,netProfit:f.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:f.equipmentTotal,crewTotal:f.crewTotal,equipmentCostTotal:f.equipmentCostTotal}),x={html:S,paymentStatus:C,paidAmount:A.paidAmount,paidPercent:A.paidPercent,paymentProgressType:A.paymentProgressType,paymentProgressValue:A.paymentProgressValue,total:f.finalTotal};return Yn.lastResult=x,S}function Jn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,xt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,xt(n,e))}function xt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Xn=Ce()||{};let X=(Xn.reservations||[]).map(on);function ie(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const Yt="__reservation_packages_cache__",Jt="__reservation_item_cost_cache__";function Xt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Zt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function en(){const e=Xt();if(!e)return{};try{const t=e.getItem(Yt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function Dt(e){const t=Xt();if(t)try{t.setItem(Yt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function yt(){const e=Zt();if(!e)return{};try{const t=e.getItem(Jt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation item cost cache",t),{}}}function ot(e){const t=Zt();if(t)try{t.setItem(Jt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation item cost cache",n)}}function Zn(e,t=0){if(!e||typeof e!="object")return null;const n=e.equipment_id??e.equipmentId??e.id??null,i=b(String(e.barcode??e.code??"")).trim(),c=ie(F(e.cost??e.unit_cost)),s=ie(F(e.price??e.unit_price)),l=Number.isFinite(c),a=Number.isFinite(s);return!l&&!a?null:{key:n!=null?`id:${n}`:i?`bc:${i}`:`idx:${t}`,equipmentId:n,barcode:i,cost:l?c:null,price:a?s:null}}function ei(e,t){if(!e)return;const n=Array.isArray(t)?t.map((s,l)=>Zn(s,l)).filter(Boolean):[],i=yt(),c=String(e);if(!n.length){i[c]&&(delete i[c],ot(i));return}i[c]=n,ot(i)}function ti(e=[]){const t=yt(),n=new Set;e.forEach(c=>{const s=c?.id??c?.reservationId??c?.reservation_code??null;s&&n.add(String(s))});let i=!1;Object.keys(t).forEach(c=>{n.has(c)||(delete t[c],i=!0)}),i&&ot(t)}function ni(e){if(!e)return[];const t=yt(),n=String(e),i=t[n];return Array.isArray(i)?i:[]}function ii(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=Qe();if(!Array.isArray(t)||t.length===0)return[];const n=new Map;e.forEach(c=>{if(!c||typeof c!="object")return;const s=c.equipmentId??c.equipment_id??c.id??null;if(s==null)return;const l=String(s),a=(()=>{const o=[c.qty,c.quantity,c.count,1];for(const r of o){const u=Number(r);if(Number.isFinite(u)&&u>0)return u}return 1})();n.set(l,(n.get(l)||0)+a)});const i=[];return t.forEach((c,s)=>{const l=Ie(c)||[],a=new Map;let o=!0;if(l.forEach(g=>{const y=g?.equipmentId??g?.equipment_id??null,k=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(y==null){o=!1;return}const f=String(y);a.set(f,(a.get(f)||0)+k)}),!o||a.size===0)return;let r=1/0;for(const[g,y]of a.entries()){const k=n.get(g)||0,f=Math.floor(k/y);if(f<=0){r=0;break}f<r&&(r=f)}if(!Number.isFinite(r)||r<=0)return;for(const[g,y]of a.entries()){const k=n.get(g)||0;n.set(g,Math.max(0,k-r*y))}const u=ye(c?.id??c?.packageId??c?.package_id??c?.code),d=Array.from(a.entries()).map(([g,y])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:y,unit_price:0})),m=(c?.package_code??c?.code??u)||`pkg-${s}`,_=Re(c)||u||`package-${s}`;i.push({package_code:m,name:_,quantity:r,unit_price:Mt(c)||0,items:d})}),i}function ai(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,c=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",s=Number.isFinite(Number(t.positionClientPrice)),l=Number.isFinite(Number(t.positionCost));return i||c||s||l})}function ci(e){return[]}function tn(e=[]){return Array.isArray(e)?e.map((t,n)=>pn(t,n)).filter(Boolean).map((t,n)=>{const i=ye(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),c=Ye(t,i).map(r=>{const u=J(r.qty??r.quantity??r.count??r.units??r.unit_qty??r.unitQty??r.unit_count??r.unitCount??r.package_quantity??r.packageQty??1),d=ie(F(r.price??r.unit_price??0));return{...r,qty:u,quantity:u,price:d,unit_price:d}}),s=J(t.quantity??t.qty??1);let l=ie(F(t.unit_price??t.unitPrice??t.price??0));if(!l||l<=0){const r=c.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);r>0&&s>0&&(l=ie(Number((r/s).toFixed(2))))}const a=F(t.total_price??t.totalPrice??t.total??l*s),o=a>0?ie(a):ie(Number((l*s).toFixed(2)));return{...t,packageId:i,package_id:i,qty:s,quantity:s,unit_price:l,unitPrice:l,price:l,total_price:o,total:o,packageItems:c}}):[]}function Me(e,t){if(!e)return;const n=en(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],Dt(n));return}n[i]=tn(t),Dt(n)}function si(e){if(!e)return[];const t=en(),n=String(e),i=t[n];return Array.isArray(i)?tn(i):[]}function ht(e,t=0){if(e==null)return null;if(typeof e!="object"){const C=e!=null?String(e):null;return{assignmentId:`crew-${t}-${C??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:C,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,c=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,s=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let l=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";l||(l=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,o=e.position_label_en??null,r=e.position_label_alt??o??a??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,m=ie(R(u)),_=ie(R(d)),g=e&&typeof e.technician=="object"?e.technician:null,y=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,k=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,f=e.role??g?.role??e.specialization??null,A=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(n),positionId:c!=null?String(c):null,positionKey:s!=null?String(s):null,positionLabel:l!=null?String(l):"",positionLabelAlt:r!=null?String(r):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:o!=null?String(o):null,positionCost:Number.isFinite(m)?m:0,positionClientPrice:Number.isFinite(_)?_:0,technicianId:y!=null?String(y):null,technicianName:k!=null?String(k):null,technicianRole:f!=null?String(f):null,technicianPhone:A!=null?String(A):null,notes:e.notes??null}}function oi(){return X}function $e(e){X=Array.isArray(e)?e.map(Ze):[],X.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Me(n,t.packages),ei(n,t.items);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];ai(i)}),ti(X),gn({reservations:X});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return X}async function ri(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,o])=>{o!=null&&o!==""&&t.set(a,String(o))});const n=t.toString(),c=(await ze(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(c)?s=c:c&&typeof c=="object"&&(Array.isArray(c.items)?s=c.items:Array.isArray(c.results)?s=c.results:Array.isArray(c.data)?s=c.data:Array.isArray(c.records)&&(s=c.records));const l=s.map(je).map(an);return $e(l)}async function li(e){try{Array.isArray(e?.packages)&&console.debug("[reservationsService] createReservationApi payload.packages",e.packages)}catch{}const n=(await ze("/reservations/",{method:"POST",body:e,timeout:9e4}))?.data??{};(!Array.isArray(n.packages)||n.packages.length===0)&&Array.isArray(e?.packages)&&e.packages.length&&(n.packages=e.packages);const i=sn(je(n),e?.packages),c=Array.isArray(e?.items)?e.items:null;if(c&&(Array.isArray(i.items)&&i.items.length?i.items=nn(i.items,c):i.items=c.map(et)),!Number.isFinite(i.companySharePercent)&&e?.company_share_percent!=null&&(i.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const s=kt(e.payment_history);s.length&&(i.paymentHistory=s)}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const s=e.technicians.map((l,a)=>ht(l,a)).filter(Boolean);s.length&&(i.crewAssignments=s,i.techniciansDetails=s.map((l,a)=>{const o=e.technicians[a];return typeof o=="object"?{...o,...l}:l}))}if(Array.isArray(e?.packages)&&e.packages.length){const s=Oe({packages:e.packages});i.packages=de(i.packages,s)}{const s=At(i.items||[],i.packages||[]);i.items=s.items,i.packages=de(i.packages||[],s.packages)}if(Me(i.id??i.reservationId??i.reservation_code,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const s=Te({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=s.companyShareAmount,i.cost=s.finalTotal,i.totalAmount=s.finalTotal}return i.companyShareEnabled=e?.company_share_enabled?!0:i.companySharePercent>0,$e([...X,i]),i}async function bt(e,t){try{Array.isArray(t?.packages)&&console.debug("[reservationsService] updateReservationApi payload.packages",t.packages)}catch{}const i=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t})??{},c=i&&typeof i=="object"&&i.data&&typeof i.data=="object"&&!Array.isArray(i.data)?i.data:i,s=Array.isArray(c.packages)&&c.packages.length>0,l=Array.isArray(t?.packages)&&t.packages.length?t.packages:null;!s&&l&&(c.packages=l);const a=sn(je(c),s?null:l),o=Array.isArray(t?.items)?t.items:null;if(o&&(Array.isArray(a.items)&&a.items.length?a.items=nn(a.items,o):a.items=o.map(et)),console.debug("[reservationsService] updateReservationApi mapped history",a.paymentHistory),!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(a.paymentHistory)||a.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const u=kt(t.payment_history);u.length&&(a.paymentHistory=u,console.debug("[reservationsService] updateReservationApi applied fallback history",a.paymentHistory))}if((!Array.isArray(a.crewAssignments)||a.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const u=t.technicians.map((d,m)=>ht(d,m)).filter(Boolean);u.length&&(a.crewAssignments=u,a.techniciansDetails=u.map((d,m)=>{const _=t.technicians[m];return typeof _=="object"?{..._,...d}:d}))}if(!s&&Array.isArray(t?.packages))if(t.packages.length){const u=Oe({packages:t.packages});a.packages=de(a.packages,u)}else a.packages=[];{const u=At(a.items||[],a.packages||[]);a.items=u.items,a.packages=de(a.packages||[],u.packages)}if(Me(a.id??a.reservationId??a.reservation_code??e,a.packages),a.companySharePercent>0&&(!Number.isFinite(a.companyShareAmount)||a.companyShareAmount<=0)){const u=Te({items:a.items||[],technicianIds:a.technicians||[],discount:a.discount,discountType:a.discountType,applyTax:a.applyTax,start:a.start,end:a.end,companySharePercent:a.companySharePercent});a.companyShareAmount=u.companyShareAmount,a.cost=u.finalTotal,a.totalAmount=u.finalTotal}a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const r=X.map(u=>String(u.id)===String(e)?a:u);return $e(r),a}function nn(e,t){if(!Array.isArray(e)||!Array.isArray(t))return e;const n=new Map;return t.forEach((i,c)=>{if(!i||typeof i!="object")return;const s=i.equipment_id??i.equipmentId??i.id??null,l=b(String(i.barcode??"")).trim(),a=s!=null?`id:${s}`:l?`bc:${l}`:`idx:${c}`,o=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,r=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;n.set(a,{cost:o,price:r})}),e.map((i,c)=>{const s=i.equipmentId??i.equipment_id??i.id??null,l=b(String(i.barcode??"")).trim(),a=[s!=null?`id:${s}`:null,l?`bc:${l}`:null,`idx:${c}`].filter(Boolean);let o=null;for(const u of a)if(n.has(u)){o=n.get(u);break}if(!o)return i;const r={...i};return Number.isFinite(o.cost)&&(r.cost=o.cost,r.unit_cost=o.cost),Number.isFinite(o.price)&&(r.price=o.price,r.unit_price=o.price),r})}function an(e){try{return ui(e)}catch(t){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",t),e}}function ui(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(l=>l!=null?String(l):"").filter(Boolean);if(!t.length)return e;const n=X.find(l=>{if(!l)return!1;const a=l.id!=null?String(l.id):"",o=l.reservationId!=null?String(l.reservationId):"",r=l.reservation_code!=null?String(l.reservation_code):"";return a&&t.includes(a)||o&&t.includes(o)||r&&t.includes(r)});if(!n||!Array.isArray(n.items))return e;const i=new Map;n.items.forEach((l,a)=>{const o=l?.equipmentId??l?.equipment_id??l?.id??null,r=b(String(l?.barcode??"")).trim(),u=o!=null?`id:${o}`:r?`bc:${r}`:`idx:${a}`;i.set(u,l)});const c=e.items.map((l,a)=>{const o=l?.equipmentId??l?.equipment_id??l?.id??null,r=b(String(l?.barcode??"")).trim(),u=[o!=null?`id:${o}`:null,r?`bc:${r}`:null,`idx:${a}`].filter(Boolean);let d=null;for(const y of u)if(i.has(y)){d=i.get(y);break}if(!d)return l;const m={...l},_=Number(d.cost),g=Number(d.price);return Number.isFinite(_)&&_>0&&(m.cost=_,m.unit_cost=_),Number.isFinite(g)&&g>0&&(m.price=g,m.unit_price=g),m}),s={...e,items:c};return di(s)}function di(e){if(!e||typeof e!="object")return e;const t=Array.isArray(e.packages)&&e.packages.length,n=Array.isArray(e.packagesRaw)&&e.packagesRaw.length;if(!t&&!n)return e;const i=[e.id,e.reservationId,e.reservation_id,e.reservationCode,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!i.length)return e;const c=X.find(o=>{if(!o)return!1;const r=o.id!=null?String(o.id):"",u=o.reservationId!=null?String(o.reservationId):"",d=o.reservation_code!=null?String(o.reservation_code):"";return r&&i.includes(r)||u&&i.includes(u)||d&&i.includes(d)});if(!c)return e;const s=[].concat(Array.isArray(c.packages)?c.packages:[]).concat(Array.isArray(c.packagesRaw)?c.packagesRaw:[]),l=new Map;if(s.forEach(o=>{if(!o||typeof o!="object")return;const r=rt(o);if(!r)return;const u=R(o.unit_cost??o.unitCost??o.cost??o.package_cost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);!Number.isFinite(u)||u<=0||l.has(r)||l.set(r,u)}),!l.size)return e;const a=o=>{if(!o||typeof o!="object")return;const r=R(o.unit_cost??o.unitCost??o.cost??o.package_cost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);if(Number.isFinite(r)&&r>0)return;const u=rt(o);if(!u||!l.has(u))return;const d=ie(l.get(u));if(o.unit_cost=d,o.unitCost=d,o.cost=d,typeof o.total_cost!="number"||!Number.isFinite(o.total_cost)||o.total_cost===0){const m=Number.isFinite(Number(o.quantity))?Number(o.quantity):1;o.total_cost=Number((d*m).toFixed(2))}Number.isFinite(R(o.rental_cost))||(o.rental_cost=d),Number.isFinite(R(o.purchase_price))||(o.purchase_price=d),Number.isFinite(R(o.internal_cost))||(o.internal_cost=d),Number.isFinite(R(o.equipment_cost))||(o.equipment_cost=d),Number.isFinite(R(o.item_cost))||(o.item_cost=d)};return Array.isArray(e.packages)&&e.packages.forEach(a),Array.isArray(e.packagesRaw)&&e.packagesRaw.forEach(a),e}function rt(e={}){const t=te(e?.packageId??e?.package_id??e?.id??e?.code??null);if(t)return t;const n=b(String(e?.package_code??e?.code??e?.barcode??"")).trim().toLowerCase();return n||null}function cn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=new Map;return e.forEach((n,i)=>{if(!n||typeof n!="object")return;const c=rt(n)??`pkg-${i}`,s=t.get(c);if(!s){t.set(c,n);return}const l=R(s.unit_cost??s.unitCost??s.cost??s.package_cost??s.rental_cost??s.purchase_price??s.internal_cost??s.equipment_cost??s.item_cost),a=R(n.unit_cost??n.unitCost??n.cost??n.package_cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost);Number.isFinite(a)&&(!Number.isFinite(l)||a>=l)?t.set(c,{...s,...n,unit_cost:a}):t.set(c,{...n,...s})}),Array.from(t.values())}function pi(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(s=>s!=null?String(s):"").filter(Boolean);if(!t.length)return e;let n=[];for(const s of t)if(n=ni(s),n.length)break;if(!n.length)return e;const i=new Map;n.forEach((s,l)=>{if(!s||typeof s!="object")return;const a=s.equipmentId??s.equipment_id??null,o=b(String(s.barcode??"")).trim(),r=a!=null?`id:${a}`:o?`bc:${o}`:`idx:${l}`;i.set(r,s)});const c=e.items.map((s,l)=>{const a=s?.equipmentId??s?.equipment_id??s?.id??null,o=b(String(s?.barcode??"")).trim(),r=[a!=null?`id:${a}`:null,o?`bc:${o}`:null,`idx:${l}`].filter(Boolean);let u=null;for(const A of r)if(i.has(A)){u=i.get(A);break}if(!u)return s;const d={...s},m=ie(F(u.cost??u.unit_cost)),_=ie(F(u.price??u.unit_price)),g=Number.isFinite(m),y=Number.isFinite(_),k=Number(s.cost),f=Number(s.price);return g&&(!Number.isFinite(k)||k<=0)&&(d.cost=m,d.unit_cost=m),y&&(!Number.isFinite(f)||f<=0)&&(d.price=_,d.unit_price=_),d});return{...e,items:c}}async function mi(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=X.filter(n=>String(n.id)!==String(e));$e(t),Me(e,null)}async function fi(e){return bt(e,{status:"confirmed",confirmed:!0})}async function gi(e,t=null){const n={status:"completed",confirmed:!0};return typeof t=="string"&&(n.notes=t),bt(e,n)}function je(e={}){const t=Ze({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,packages:e.packages,reservation_packages:e.reservation_packages,reservationPackages:e.reservationPackages,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});if(Array.isArray(e.packages))try{t.packagesRaw=e.packages.map(i=>({...i}));const n=Oe({packages:e.packages});n.length&&(t.packages=de(n,t.packages||[]))}catch{t.packagesRaw=Array.isArray(t.packagesRaw)?t.packagesRaw:[]}else t.packagesRaw=Array.isArray(t.packagesRaw)?t.packagesRaw:[];return t.packages=cn(t.packages),t.packages,pi(an(t))}function sn(e,t){if(!e||!Array.isArray(t)||t.length===0)return e;try{const n=Oe({packages:t});n.length&&(e.packages=de(n,e.packages||[]))}catch(n){console.warn("[reservationsService] Failed to normalize payload packages",n)}try{e.packagesRaw=t.map(n=>({...n}))}catch{e.packagesRaw=t}return e.packages=cn(e.packages),e}function on(e={}){return Ze(e)}function Ze(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(et):[];const c=Array.isArray(e.packagesRaw)?e.packagesRaw.map(T=>({...T})):Array.isArray(e.packages)?e.packages.map(T=>({...T})):[];let s=Oe(e);const l=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let a=l.map((T,$)=>ht(T,$)).filter(Boolean),o=a.map((T,$)=>{const w=l?.[$];return{...w&&typeof w=="object"?{...w}:w!=null?{id:w}:{},...T}});const r=a.map(T=>T.technicianId).filter(T=>T!=null&&T!=="").map(T=>Number.isNaN(Number(T))?String(T):Number(T)),u=e.start??e.start_datetime??"",d=e.end??e.end_datetime??"";let m=F(e.total_amount??e.totalAmount??e.cost??0);const _=F(e.discount??0),g=e.discount_type??e.discountType??"percent",y=["percent","amount"].includes(g)?g:"percent",k=!!(e.apply_tax??e.applyTax??!1);let f=Ii(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const A=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),C=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,S=C!=null?Number.parseFloat(b(String(C).replace("%","").trim())):NaN,x=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let B=x!=null?x===!0||x===1||x==="1"||String(x).toLowerCase()==="true":Number.isFinite(S)&&S>0,O=B&&Number.isFinite(S)?Number(S):0;const W=e.company_share_amount??e.companyShareAmount;let h=Number.isFinite(Number(W))?Number(W):NaN;k&&O<=0&&(O=Qt,B=!0);const v=Te({items:i,technicianIds:r,crewAssignments:a,discount:_,discountType:y,applyTax:k,start:u,end:d,companySharePercent:O>0?O:null});(!Number.isFinite(m)||m<=0||k)&&(m=v.finalTotal),(!Number.isFinite(h)||h<0)&&(h=v.companyShareAmount),h=Number.isFinite(h)?Number(h.toFixed(2)):0,!B&&O>0&&(B=!0);const p=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],q=yi(p),E=kt(q),D=t??n??e.reservation_code??e.reservationId??null;if(s.length)Me(D,s);else{const T=si(D);T.length&&(s=de(s,T))}if(!s.length&&Array.isArray(i)&&i.length)try{const T=ii(i);Array.isArray(T)&&T.length&&(s=de(s,T))}catch(T){console.warn("[reservationsService] inference of packages from items failed",T)}const I=At(i,s);i=I.items,s=de(s,I.packages);const N=gt({totalAmount:m,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:E});f=_t({manualStatus:f,paidAmount:N.paidAmount,paidPercent:N.paidPercent,totalAmount:m});const V=f==="paid",ue=Pi(e.status??(A?"confirmed":"pending"));return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:u,end:d,status:ue,completed:ue==="completed",confirmed:A,location:e.location??"",notes:e.notes??"",discount:_,discountType:y,applyTax:k,paid:V,paidStatus:f,paidAmount:N.paidAmount,paidPercent:N.paidPercent,paymentProgressType:N.paymentProgressType,paymentProgressValue:N.paymentProgressValue,paymentHistory:E,payment_history:E,totalAmount:m,cost:m,projectId:e.project_id??e.projectId??null,items:i,technicians:r,crewAssignments:a,techniciansDetails:o,startDatetime:u,endDatetime:d,customerPhone:e.customer_phone??e.customerPhone??null,packages:s,packagesRaw:c,companySharePercent:O,companyShareAmount:h,companyShareEnabled:B}}function et(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=J(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=F(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),c=F(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),s=b(String(e.barcode??e.code??e.serial??"")),l=e.description??e.desc??e.name??e.title??"",a={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:s,desc:l,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,cost:c,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},o=ln(e.type??e.item_type??e.kind??null),r=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=te(r),d=Ye(e,u);if(o==="package"||u||d.length){a.type="package";const m=u||(t!=null?String(t):a.id?te(a.id):"");m&&(a.packageId=m,a.package_id=m,a.package_code=e.package_code??e.packageCode??m),a.name=l||a.package_code||m||"",a.barcode=a.barcode||b(String(e.package_code??e.packageCode??"")),a.packageItems=d;const _=dn({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(a.price)||a.price<=0||a.price>_*10)&&(a.price=_),a.qtyPerPackage=d.length?d[0]?.qtyPerPackage??a.qtyPerPackage:a.qtyPerPackage,a.totalQuantity=n}return a}function _i({reservationCode:e,customerId:t,start:n,end:i,status:c,title:s,location:l,notes:a,projectId:o,totalAmount:r,discount:u,discountType:d,applyTax:m,paidStatus:_,confirmed:g,items:y,packages:k,crewAssignments:f=[],technicians:A=f,companySharePercent:C,companyShareEnabled:S,paidAmount:x,paidPercentage:B,paymentProgressType:O,paymentProgressValue:W,paymentHistory:h}){const v=Array.isArray(f)?f:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:c??"pending",title:s??null,location:l??null,notes:a??null,project_id:o||null,total_amount:r??0,discount:u??0,discount_type:d??"percent",apply_tax:m?1:0,paid_status:_??"unpaid",paid_amount:Number.isFinite(x)?F(x):0,paid_percentage:Number.isFinite(B)?Number(B.toFixed(2)):0,payment_progress_type:O??null,payment_progress_value:Number.isFinite(W)?Number(W.toFixed(2)):null,payment_history:Array.isArray(h)?h.map(p=>({type:lt(p?.type??p?.payment_type??p?.method??p?.paymentMethod),value:p?.value!=null?F(p.value):null,amount:p?.amount!=null?F(p.amount):p?.payment_amount!=null?F(p.payment_amount):null,percentage:p?.percentage!=null?Number(p.percentage):p?.payment_percentage!=null?Number(p.payment_percentage):null,note:p?.note??p?.notes??p?.comment??p?.payment_note??null,recorded_at:p?.recordedAt??p?.recorded_at??p?.createdAt??p?.created_at??p?.payment_date??p?.date??new Date().toISOString()})):[],payments:Array.isArray(h)?h.map(p=>({type:lt(p?.type??p?.payment_type??p?.method??p?.paymentMethod),value:p?.value!=null?F(p.value):null,amount:p?.amount!=null?F(p.amount):p?.payment_amount!=null?F(p.payment_amount):null,percentage:p?.percentage!=null?Number(p.percentage):p?.payment_percentage!=null?Number(p.payment_percentage):null,note:p?.note??p?.notes??p?.comment??p?.payment_note??null,recorded_at:p?.recordedAt??p?.recorded_at??p?.createdAt??p?.created_at??p?.payment_date??p?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:hi(y),packages:bi(y,k),company_share_percent:S&&Number.isFinite(C)?Number(C):null,company_share_enabled:S?1:0,technicians:v.length?v.map((p,q)=>{const E=p.technicianId??p.technician_id??p.id??null,D=p.positionId??p.position_id??p.position??p.position_code??null,I=p.positionLabel??p.position_name??p.role??null,N=F(p.positionCost??p.position_cost??p.cost??p.daily_wage??p.dailyWage??0),V=F(p.positionClientPrice??p.position_client_price??p.client_price??p.clientPrice??p.daily_total??p.dailyTotal??p.total??0);return{id:E,technician_id:E,role:I??p.technicianRole??null,notes:p.notes??null,position_id:D,position_key:p.positionKey??p.position_key??null,position_name:I,position_label_ar:p.positionLabelAr??p.position_label_ar??null,position_label_en:p.positionLabelEn??p.position_label_en??null,position_cost:N,position_client_price:V,client_price:V,cost:N,assignment_id:p.assignmentId??p.assignment_id??`crew-${q}`}}):Array.isArray(A)?A.map(p=>typeof p=="object"&&p!==null?{id:p.id??p.technician_id??p.technicianId??p.ID,role:p.role??null,notes:p.notes??null}:Number.isNaN(Number(p))?String(p):Number(p)):[]}}function kt(e){const t=Nt(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,c=lt(i),s=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,l=s!=null?Number.parseFloat(b(String(s))):null,a=n.amount!=null?Number.parseFloat(b(String(n.amount))):n.payment_amount!=null?Number.parseFloat(b(String(n.payment_amount))):null,o=n.percentage!=null?Number.parseFloat(b(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(b(String(n.payment_percentage))):null,r=Number.isFinite(a)?a:c==="amount"&&Number.isFinite(l)?l:null,u=Number.isFinite(o)?o:c==="percent"&&Number.isFinite(l)?l:null,d=c??(r!=null?"amount":u!=null?"percent":null),m=d==="amount"?r:d==="percent"?u:Number.isFinite(l)?l:null,_=n.note??n.notes??n.comment??n.payment_note??null,g=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:m,amount:r,percentage:u,note:_,recordedAt:g}}).filter(n=>n&&n.type)}function lt(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function Nt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const l of t)if(Array.isArray(e[l]))return e[l];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(l=>Array.isArray(l));if(Array.isArray(i))return i;const c=Object.values(e);if(c.length&&c.every(l=>l&&typeof l=="object")){const l=c.map(a=>a);if(l.every(a=>!Array.isArray(a)))return l}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(l=>l in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return Nt(t)}catch{return[]}return[]}function yi(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=Nt(t);if(Array.isArray(n)&&n.length)return n}return[]}function hi(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object"||n.type==="package")return;const i=Array.isArray(n.packageItems)?n.packageItems:[],c=n.equipmentId??n.equipment_id??n.id??null;if(c==null)return;const s=(()=>{const l=F(n.cost??n.unit_cost??n.rental_cost??n.internal_cost??n.purchase_price??n.equipment_cost??0);if(Number.isFinite(l)&&l>0)return l;if(i.length){const a=i.reduce((o,r)=>{const u=F(r.cost??r.unit_cost??r.unitCost??r.rental_cost??r.internal_cost??r.purchase_price??r.equipment_cost??r.item_cost??0),d=J(r.qty??r.quantity??r.qtyPerPackage??r.unit_qty??1);return o+u*d},0);if(a>0)return Number(a.toFixed(2))}return l})();t.push({equipment_id:rn(c),quantity:J(n.qty??n.quantity??1),unit_price:F(n.price??n.unit_price??0),unit_cost:s,cost:s,total_cost:Number.isFinite(s)?Number((s*J(n.qty??n.quantity??1)).toFixed(2)):0,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,notes:n.notes??null})}),t}function rn(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function bi(e,t){const n=Array.isArray(t)?t.map(c=>c&&typeof c=="object"?{...c}:c):[],i=new Map;return n.forEach((c,s)=>{if(!c||typeof c!="object")return;const l=Be(c);l&&i.set(l,s)}),Array.isArray(e)&&e.forEach(c=>{if(!c||typeof c!="object"||c.type!=="package")return;const s=te(c.packageId??c.package_id??c.package_code??c.packageCode??c.bundleId??c.bundle_id??c.id??null),l=s?be(s):null,a=J(c.package_qty??c.packageQty??c.qty??c.quantity??l?.package_qty??1),o=Ie(l||{})||[],r=Array.isArray(c.packageItems)&&c.packageItems.length?c.packageItems:o,u=Array.isArray(r)?r.map(f=>{const A=f?.equipmentId??f?.equipment_id??f?.id??null;return A==null?null:{equipment_id:rn(A),quantity:J(f?.qty??f?.quantity??f?.count??f?.units??f?.unit_qty??f?.unitQty??f?.unit_count??f?.unitCount??f?.package_quantity??f?.packageQty??1),unit_price:F(f?.price??f?.unit_price??0),unit_cost:0,cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0}}).filter(Boolean):[],d=[c.package_cost,c.packageCost,c.unit_cost,c.unitCost,c.cost,c.rental_cost,c.internal_cost,c.purchase_price,c.equipment_cost,c.item_cost];let m=0;for(const f of d){const A=F(f);if(Number.isFinite(A)&&A>=0){m=A;break}}const _=c.package_code??c.packageCode??c.barcode??c.code??c.packageId??c.package_id??null,g={packageId:s||null,package_id:s||null,package_code:_,name:c.desc??c.name??"",quantity:a,unit_price:F(c.price??c.unit_price??0),unit_cost:m,package_cost:m,packageCost:m,cost:m,total_cost:Number.isFinite(m)?Number((m*a).toFixed(2)):0,rental_cost:m,purchase_price:m,internal_cost:m,equipment_cost:m,item_cost:m,items:u},y=Be(g);if(y&&i.has(y)){const f=i.get(y),A=Pt(n[f]&&typeof n[f]=="object"?n[f]:{},g);n[f]=A,i.set(y,f);return}const k=n.length;n.push(g),y&&i.set(y,k)}),n}function ln(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function te(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return ye(t)}function Be(e,t=null){if(!e||typeof e!="object")return null;const n=[e.package_code,e.packageCode,e.code,e.barcode];for(const c of n){const s=te(c??"");if(s)return t&&t.has(s)&&t.get(s)||s}const i=[e.packageId,e.package_id,e.id];for(const c of i){const s=te(c??"");if(s)return s}return null}function ut(e){return e==null?"":b(String(e)).trim().toLowerCase()}function un(e={},t=1){if(!e||typeof e!="object"){const r=b(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:r,normalizedBarcode:ut(r),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=J(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),c=F(e.unit_price??e.unitPrice??e.price??0),s=F(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),l=b(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),a=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let o;if(a!=null)o=J(a,{fallback:1,max:99});else if(t>0){const r=i/t;Number.isFinite(r)&&r>0&&Number.isInteger(r)?o=J(r,{fallback:1,max:99}):o=Math.min(i,99)}else o=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:o,quantity:o,qtyPerPackage:o,totalQuantity:i,price:c,unit_price:c,cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,barcode:l,normalizedBarcode:ut(e.normalizedBarcode??l),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function ki(e={},t={}){const n=te(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=J(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),c=F(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),s=[e.package_cost,e.packageCost,e.unit_cost,e.unitCost,e.cost,e.rental_cost,e.internal_cost,e.purchase_price,e.equipment_cost,e.item_cost,t.package_cost,t.packageCost,t.unit_cost,t.unitCost,t.cost,t.rental_cost,t.internal_cost,t.purchase_price,t.equipment_cost,t.item_cost];let l=0;for(const o of s){const r=F(o);if(Number.isFinite(r)&&r>=0){l=r;break}}const a=b(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:a,desc:t.desc??t.description??e.name??e.desc??e.title??a,qty:i,quantity:i,price:c,cost:l,unit_cost:l,package_cost:l,packageCost:l,rental_cost:l,purchase_price:l,internal_cost:l,equipment_cost:l,item_cost:l,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:a,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function At(e=[],t=[]){const n=Ni(e),i=Array.isArray(t)?de(t,n.packages):n.packages,c=new Map;return i.forEach(s=>{const l=Be(s);l&&c.set(l,s)}),n.packages.forEach(s=>{const l=Be(s);if(!l)return;const a=c.get(l);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=s.packageItems),!a.name&&s.name&&(a.name=s.name),!a.image&&s.image&&(a.image=s.image))}),{items:n.items,packages:Array.from(c.values())}}function Ni(e=[]){const t=new Map;if(e.forEach(s=>{const l=te(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(!l)return;const a=l;t.has(a)||t.set(a,{base:s,items:[]});const o=t.get(a);if(s.type==="package"){o.base=s;return}o.base||(o.base=s),o.items.push(s)}),!t.size)return{items:e,packages:[]};const n=[],i=[],c=new Set;return e.forEach(s=>{const l=te(s.packageId??s.package_id??s.packageCode??s.package_code??s.bundleId??s.bundle_id??null);if(l&&t.has(l)){if(c.has(l))return;const a=t.get(l),o=a.base||s,r=a.items.map(_=>un(_,1)),u=[o.package_cost,o.packageCost,o.unit_cost,o.unitCost,o.cost,o.rental_cost,o.internal_cost,o.purchase_price,o.equipment_cost,o.item_cost];let d=0;for(const _ of u){const g=F(_);if(Number.isFinite(g)&&g>=0){d=g;break}}const m={packageId:l,package_id:l,package_code:o.package_code??o.packageCode??o.barcode??b(String(l)),name:o.package_name??o.packageName??o.desc??o.name??`Package ${l}`,quantity:J(o.package_quantity??o.packageQty??1,{fallback:1,max:9999}),unit_price:F(o.package_price??o.packagePrice??o.price??0),unit_cost:d,unitCost:d,cost:d,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,packageItems:r,image:o.image??null};i.push(m),n.push(ki(m,o)),c.add(l);return}n.push(s)}),{items:n,packages:i}}function Ye(e={},t=""){if(!e||typeof e!="object")return[];const n=te(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let c=Ie({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),s=[];if((!Array.isArray(c)||c.length===0)&&n){const r=be(n);r&&(c=Ie(r),s=Array.isArray(c)?c:[])}else if(n){const r=be(n);r&&(s=Ie(r)||[])}if(!Array.isArray(c)||c.length===0)return[];const l=J(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=c.map(r=>un(r,l));if(s.length){const r=new Map;s.forEach(u=>{if(!u)return;const d=ut(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&r.set(d,u)}),a.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!r.has(d))return;const m=r.get(d),_=J(m.quantity??m.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=_,u.qty=_,u.quantity=_;const g=F(m.unit_price??m.unitPrice??m.price??u.price);u.price=g,u.unit_price=g,!u.desc&&m.desc&&(u.desc=m.desc),!u.image&&m.image&&(u.image=m.image)})}const o=new Map;return a.forEach(r=>{const u=r.normalizedBarcode||(r.equipmentId?`id:${r.equipmentId}`:null);if(u){if(o.has(u)){const d=o.get(u);d.qty+=r.qty,d.quantity+=r.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=r.qtyPerPackage),(!d.price||d.price===0)&&r.price&&(d.price=r.price,d.unit_price=r.unit_price),!d.desc&&r.desc&&(d.desc=r.desc),!d.image&&r.image&&(d.image=r.image);return}o.set(u,{...r})}}),Array.from(o.values())}function dn(e={},t=[],n=1){try{const s=te(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(s){const l=be(s);if(l){const a=Mt(l);if(Number.isFinite(Number(a))&&Number(a)>0)return Number(a)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return F(i);const c=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(c))){const s=F(c);return n>0?Number((s/n).toFixed(2)):s}return 0}function Pt(e,t){if(!e)return t;if(!t)return e;const n={...e},i=l=>{(n[l]===void 0||n[l]===null||n[l]==="")&&(n[l]=t[l])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price);const c=F(n.unit_cost??n.unitCost??n.cost??n.package_cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost),s=F(t.unit_cost??t.unitCost??t.cost??t.package_cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost);if((!Number.isFinite(c)||c===0)&&Number.isFinite(s)){const l=s;n.unit_cost=l,n.unitCost=l,n.cost=l,n.total_cost=Number.isFinite(t.total_cost)?t.total_cost:n.total_cost,Number.isFinite(n.rental_cost)||(n.rental_cost=l),Number.isFinite(n.purchase_price)||(n.purchase_price=l),Number.isFinite(n.internal_cost)||(n.internal_cost=l),Number.isFinite(n.equipment_cost)||(n.equipment_cost=l),Number.isFinite(n.item_cost)||(n.item_cost=l)}return(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=Ai(n.packageItems,t.packageItems),n.items=n.packageItems),n}function Ai(e=[],t=[]){const n=new Map,i=c=>{c.forEach(s=>{if(!s)return;const l=s.normalizedBarcode||(s.equipmentId?`id:${s.equipmentId}`:null);if(l){if(n.has(l)){const a=n.get(l);a.qty+=s.qty??0,a.quantity+=s.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(s.qtyPerPackage)&&(a.qtyPerPackage=s.qtyPerPackage),(!a.price||a.price===0)&&s.price&&(a.price=s.price,a.unit_price=s.unit_price);const o=F(a.cost??a.unit_cost??a.unitCost??a.rental_cost??a.purchase_price??a.internal_cost??a.equipment_cost??a.item_cost),r=F(s.cost??s.unit_cost??s.unitCost??s.rental_cost??s.purchase_price??s.internal_cost??s.equipment_cost??s.item_cost);if((!Number.isFinite(o)||o===0)&&Number.isFinite(r)){const u=r;a.cost=u,a.unit_cost=u,a.unitCost=u,Number.isFinite(a.rental_cost)||(a.rental_cost=u),Number.isFinite(a.purchase_price)||(a.purchase_price=u),Number.isFinite(a.internal_cost)||(a.internal_cost=u),Number.isFinite(a.equipment_cost)||(a.equipment_cost=u),Number.isFinite(a.item_cost)||(a.item_cost=u)}!a.desc&&s.desc&&(a.desc=s.desc),!a.image&&s.image&&(a.image=s.image);return}n.set(l,{...s})}})};return i(e),i(t),Array.from(n.values())}function de(e=[],t=[]){const n=[],i=new Map,c=Qe(),s=new Map;c.forEach(o=>{const r=te(o?.id??o?.packageId??o?.package_id??o?.code??""),u=String(o?.package_code??o?.code??"").trim().toLowerCase();u&&s.set(u,r||u)});const l=o=>Be(o,s),a=o=>{Array.isArray(o)&&o.forEach(r=>{if(!r||typeof r!="object")return;const u=l(r);if(u)if(i.has(u)){const d=i.get(u);n[d]=Pt(n[d],r)}else i.set(u,n.length),n.push({...r})})};return a(e),a(t),n}function pn(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const g=te(e),y=g?be(g):null,k=y?Ye(y,g):[],f=y?F(y.price??y.unit_price??y.unitPrice??0):0,C=(()=>{const O=[y?.package_cost,y?.packageCost,y?.unit_cost,y?.unitCost,y?.cost,y?.rental_cost,y?.internal_cost,y?.purchase_price,y?.equipment_cost,y?.item_cost];for(const W of O){const h=F(W);if(Number.isFinite(h)&&h>=0)return h}return 0})(),S=1,x=Number((f*S).toFixed(2)),B=Number((C*S).toFixed(2));return{id:`package::${g||t}`,packageId:g||`pkg-${t}`,package_id:g||`pkg-${t}`,package_code:b(String(e))||g||`pkg-${t}`,name:y?.name??y?.package_name??y?.packageName??b(String(e))??"",desc:y?.name??b(String(e))??"",quantity:S,qty:S,unit_price:f,unitPrice:f,price:f,unit_cost:C,unitCost:C,cost:C,total_cost:B,rental_cost:C,purchase_price:C,internal_cost:C,equipment_cost:C,item_cost:C,total:x,total_price:x,barcode:b(String(e)),packageItems:k,items:k,type:"package",image:y?.image??null}}if(typeof e!="object")return null;const n=te(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=J(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),c=Ye(e,n),s=dn(e,c,i),a=(()=>{const g=[e.package_cost,e.packageCost,e.unit_cost,e.unitCost,e.cost,e.rental_cost,e.internal_cost,e.purchase_price,e.equipment_cost,e.item_cost];for(const y of g){const k=F(y);if(Number.isFinite(k)&&k>=0)return k}return 0})(),o=e.total_price??e.totalPrice??e.total??s*i,r=Number.isFinite(Number(o))?F(o):Number((s*i).toFixed(2)),u=Number.isFinite(a)?Number((a*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??n,m=b(String(e.barcode??d??"")),_=e.image??e.cover??e.thumbnail??c.find(g=>g.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??n,quantity:i,qty:i,unit_price:s,unitPrice:s,price:s,unit_cost:a,unitCost:a,package_cost:a,packageCost:a,cost:a,total_cost:u,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,total:r,total_price:r,barcode:m,packageItems:c,items:c,type:"package",image:_}}function Oe(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,c=(a,o=n.length)=>{const r=pn(a,o);if(!r)return;const u=r.packageId||r.package_code||r.id||`pkg-${o}`;if(i.has(u)){const d=i.get(u);n[d]=Pt(n[d],r)}else i.set(u,n.length),n.push(r)};t.forEach(a=>{a.forEach((o,r)=>{c(o,r+n.length)})}),n.length===0&&e.package&&c(e.package,0);const s=Array.isArray(e.items)?e.items:[],l=(a={})=>!a||typeof a!="object"?!1:!!(ln(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(r=>typeof r=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return s.forEach((a,o)=>{l(a)&&c(a,n.length+o)}),n}function F(e){const t=R(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}try{typeof window<"u"&&!window.__dumpReservationPackages&&(window.__dumpReservationPackages=e=>{const t=X.find(n=>{const i=[n?.id,n?.reservationId,n?.reservation_id,n?.reservationCode,n?.reservation_code].map(s=>s!=null?String(s):null),c=e!=null?String(e):null;return c&&i.includes(c)});return t?(`${e}`,t.packages,t):(console.warn("[reservations] __dumpReservationPackages: reservation not found",e),null)})}catch{}function J(e,{fallback:t=1,max:n=1e6}={}){const i=R(e);if(!Number.isFinite(i))return t;const c=Math.round(i);return c<=0||c>n?t:c}function Pi(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function Ii(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function Ci(e){return e instanceof _n}const Si=(e={})=>{const t=R(e.unit_cost??e.unitCost??e.cost??e.package_cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??e.item_cost);return Number.isFinite(t)&&t>0};function at(e={}){return e.id??e.reservationId??e.reservation_id??e.reservationCode??e.reservation_code??null}function vi(e={}){const t=e?.packages;return!Array.isArray(t)||t.length===0?!0:t.some(n=>!Si(n))}async function qi(e){if(!e)return null;const n=(await ze(`/reservations/?id=${encodeURIComponent(e)}`))?.data;if(!n||Array.isArray(n))return null;const i=je(n),c=at(i),s=X.some(l=>at(l)===c)?X.map(l=>at(l)===c?i:l):[...X,i];return $e(s),i}const Hi=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:_i,closeReservationApi:gi,confirmReservationApi:fi,createReservationApi:li,deleteReservationApi:mi,fetchReservationWithDetails:qi,getCachedReservationCrew:ci,getReservationsState:oi,isApiError:Ci,mapLegacyReservation:on,mapReservationFromApi:je,mapReservationItem:et,refreshReservationsFromApi:ri,reservationPackagesNeedHydration:vi,setReservationsState:$e,toInternalReservation:Ze,updateReservationApi:bt},Symbol.toStringTag,{value:"Module"}));export{Ci as A,Di as B,qt as C,Qt as D,Ze as E,vi as F,qi as G,Yn as H,ci as I,xi as J,$n as K,Bi as L,on as M,zn as N,fi as O,gi as P,Hi as Q,ji as a,Gn as b,gt as c,Te as d,_t as e,mi as f,oi as g,Oi as h,Mi as i,$i as j,zi as k,On as l,je as m,Vt as n,Tn as o,R as p,Wn as q,ri as r,z as s,Ri as t,bt as u,Dn as v,Kt as w,Hn as x,_i as y,li as z};
