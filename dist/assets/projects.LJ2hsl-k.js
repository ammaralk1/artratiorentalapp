import{l as X,n as g,a as he,A as Rt,s as Ma,b as Gi,m as Ji,c as Qi,i as Xi,d as Va,g as re,t as c,e as za,f as j,u as It,h as Bn,j as Zi,r as es,k as Ha,o as Ut,p as ts,q as ns,v as Oa}from"./maintenance.BnsilVv3.js";import{a as Fn,b as Lt,d as oe,e as as,f as Ua,j as is,k as kn,u as Dn,l as ss,m as rs,w as os}from"./reservations.DRN0EUrN.js";const cs=X()||{};let Ve=(cs.technicians||[]).map(Vn);function qn(){return Ve}function rt(e){return Ve=Array.isArray(e)?e.map(Vn):[],Ma({technicians:Ve}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),Ve}async function Wt(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,d])=>{d!=null&&d!==""&&t.set(r,String(d))});const n=t.toString(),a=await he(`/technicians/${n?`?${n}`:""}`),i=a?.data??a;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const l=s.map(Kt);return rt(l)}async function Wa(e){const t=await he("/technicians/",{method:"POST",body:e}),n=Kt(t?.data??{});return rt([...Ve,n]),n}async function Rn(e,t){const n=await he(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Kt(n?.data??{}),i=Ve.map(s=>String(s.id)===String(e)?a:s);return rt(i),a}async function Ka(e){await he(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),rt(Ve.filter(t=>String(t.id)!==String(e)))}function Mn({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,dailyTotal:l,status:r,notes:d,active:u=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,daily_total:l??null,status:r??"available",notes:d??null,active:u?1:0}}function Kt(e={}){return Ya({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function Vn(e={}){return Ya(e)}function Ya(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",l=e.department??e.team??"",r=ca(e.daily_wage??e.dailyWage??e.wage??e.rate??0),d=ca(e.daily_total??e.dailyTotal??e.total??e.total_wage??r),u=la(e.baseStatus??e.status??"available"),f=la(e.status??e.baseStatus??"available"),m=e.notes??"",p=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:l,dailyWage:r,dailyTotal:d,status:f,baseStatus:u,notes:m,active:p}}function ca(e){const t=Number.parseFloat(g(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function la(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function Nt(e){return e instanceof Rt}const zo=Object.freeze(Object.defineProperty({__proto__:null,buildTechnicianPayload:Mn,createTechnicianApi:Wa,deleteTechnicianApi:Ka,getTechniciansState:qn,isApiError:Nt,mapLegacyTechnician:Vn,mapTechnicianFromApi:Kt,refreshTechniciansFromApi:Wt,setTechniciansState:rt,updateTechnicianApi:Rn},Symbol.toStringTag,{value:"Module"}));Gi();Ji();Qi();document.addEventListener("DOMContentLoaded",()=>{Xi();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Va()),e.dataset.listenerAttached="true")});function Mt(e){const t=Number(e)||0,a=re()==="ar"?"ar-SA-u-nu-latn":"en-US",i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${g(i)} SR`}function Ho(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function Oo(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function Uo(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}…`:""}function Me(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const ls="technicianPositions:updated";let Se=[],Ga=!1,ft=null;function zn(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function Ja({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:i}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:i??null}}function ds(e){return Se=Array.isArray(e)?e.map(zn).filter(t=>t.name!=="").sort((t,n)=>Ze(t).localeCompare(Ze(n),"ar",{sensitivity:"base"})):[],Ga=!0,Yt(),Ce()}function Yt(){try{const e={positions:Ce()},t=new CustomEvent(ls,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function Ze(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function Ce(){return Se.map(e=>({...e}))}function Qa(e){const t=String(e??"").trim().toLowerCase();return t&&Se.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function us({forceRefresh:e=!1}={}){return Ga&&!e?Ce():(ft&&!e||(ft=he("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return ds(n)}).finally(()=>{ft=null})),ft)}async function Et({forceRefresh:e=!1}={}){try{return await us({forceRefresh:e})}catch(t){throw t instanceof Rt?t:new Rt(t?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"))}}async function ps({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:i}){const s=Ja({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:i}),l=await he("/technician-positions/",{method:"POST",body:s}),r=zn(l?.data??{});return Se=[...Se,r],Se.sort((d,u)=>Ze(d).localeCompare(Ze(u),"ar",{sensitivity:"base"})),Yt(),r}async function ms(e,{name:t,cost:n,clientPrice:a,labelAr:i,labelEn:s}){if(!e)throw new Error("Position id is required");const l=Ja({name:t,cost:n,clientPrice:a,labelAr:i,labelEn:s}),r=await he(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:l}),d=zn(r?.data??{});return Se=Se.map(u=>u.id===d.id?d:u),Se.sort((u,f)=>Ze(u).localeCompare(Ze(f),"ar",{sensitivity:"base"})),Yt(),d}async function fs(e){if(!e)throw new Error("Position id is required");return await he(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Se=Se.filter(t=>t.id!==Number(e)),Yt(),Ce()}const Pn="__ART_RATIO_TECH_SUB_TAB__",Xa=["technicians-management","technicians-positions"];let le=null,da=!1,Dt=!1,bt="",An=!1,Te=null,ze="technicians-management";const ua=ys();ua&&(ze=ua);async function Za({showToastOnError:e=!0}={}){if(!Dt){Dt=!0,bt="",pe();try{await Wt(),An=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),bt=Nt(t)?t.message:c("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&j(bt,"error")}finally{Dt=!1,pe()}}}function ei(){return qn()}function Bt(e=""){return g(String(e)).trim().toLowerCase()}function pa(e){return e==null?"":String(e)}function et(e=""){return g(String(e)).replace(/[^0-9+]/g,"")}function fe(e=""){const t=g(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function Xe(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function ys(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(Pn);return e&&Xa.includes(e)?e:null}catch(e){return console.warn("⚠️ [technicians] Failed to read stored sub-tab",e),null}}function hs(e){try{if(typeof window>"u"||!window.localStorage)return;if(!Xa.includes(e)){window.localStorage.removeItem(Pn);return}window.localStorage.setItem(Pn,e)}catch(t){console.warn("⚠️ [technicians] Failed to store sub-tab",t)}}function ti(e,t=0,n=null){const a=String(e??"").trim(),i=a?Qa(a):null;return i?{matchedPosition:i,dailyWage:Number.isFinite(i.cost)?i.cost:0,dailyTotal:i.clientPrice==null?null:Number.isFinite(i.clientPrice)?i.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function ni(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function Tn(e,t=re()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function bs(e,t=re()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function ai(){const{container:e,body:t}=ni();!e||!t||(t.textContent="",e.hidden=!0)}function Hn(e,t={}){const{container:n,body:a}=ni();if(!n||!a)return;const i=String(e??"").trim();if(!i){ai();return}const s=ti(i,t?.dailyWage??0,t?.dailyTotal??null),l=Mt(s.dailyWage||0),r=s.dailyTotal!=null?Mt(s.dailyTotal):c("technicians.positionSummary.noClientPrice","—");s.matchedPosition?a.textContent=c("technicians.positionSummary.match","التكلفة: {cost} · سعر العميل: {price}").replace("{cost}",l).replace("{price}",r):a.textContent=c("technicians.positionSummary.custom","لا يوجد منصب مطابق. يمكنك إضافته من تبويب المناصب. سيتم حفظ التكلفة الحالية: {cost} · سعر العميل: {price}").replace("{cost}",l).replace("{price}",r),n.hidden=!1}function _t(){const e=document.getElementById("technician-position-options");if(!e)return;const t=Ce(),n=re(),a=new Set,i=[];t.forEach(s=>{const l=Tn(s,n).trim();l&&!a.has(l.toLowerCase())&&(i.push(`<option value="${Me(l)}"></option>`),a.add(l.toLowerCase()));const r=bs(s,n).trim();r&&!a.has(r.toLowerCase())&&(i.push(`<option value="${Me(r)}"></option>`),a.add(r.toLowerCase()));const d=s.name?.trim();d&&!a.has(d.toLowerCase())&&(i.push(`<option value="${Me(d)}"></option>`),a.add(d.toLowerCase()))}),e.innerHTML=i.join("")}function ma(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),i=t.map(r=>r?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(r=>{if(!r)return;const u=r.getAttribute("data-tech-tab")===i;r.classList.toggle("tab-active",u),r.classList.toggle("active",u),r.setAttribute("aria-selected",u?"true":"false"),r.setAttribute("tabindex",u?"0":"-1")}),n.forEach(r=>{if(!r)return;const u=r.getAttribute("data-tech-tab-panel")===i;r.hidden=!u,r.classList.toggle("active",u)}),ze=i,hs(i);const l=t.find(r=>r?.getAttribute("data-tech-tab")===i)?.closest("[data-tab-scroll]");l&&l.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),i==="technicians-positions"&&(we(),Et().then(()=>{we()}).catch(r=>{console.error("❌ [technicians] failed to load positions for tab switch",r),j(r?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}))}function On(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=c(n,a)}function Un(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=c("technicians.form.actions.cancel","إلغاء التعديل"))}function Wn(){On(le?"update":"add"),Un(!!le),pe()}function gs(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,l)=>s.localeCompare(l,"ar",{sensitivity:"base"})),i=c("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function Gt(){const e=document.getElementById("technician-form");e&&(e.reset(),le=null,On("add"),Un(!1),ai())}function vs(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-notes");!t||!n||!a||(t.value=e.name||"",n.value=et(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s&&(s.value=e.notes||""),le=String(e.id),On("update"),Un(!0),Hn(a.value,e))}function Ss(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-notes");if(!e||!t||!n)return null;const s=e.value.trim(),l=et(t.value.trim());t.value=l;const r=n.value.trim(),d=a?.value.trim()||"",u="available",f=i?.value.trim()||"",m=le?si(le):null,{dailyWage:p,dailyTotal:h}=ti(r,m?.dailyWage??0,m?.dailyTotal??null);return s?l?r?!Number.isFinite(p)||p<0?(j(c("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),null):h!=null&&(!Number.isFinite(h)||h<0)?(j(c("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),null):(Hn(r,{dailyWage:p,dailyTotal:h}),{name:s,phone:l,role:r,department:d,dailyWage:Number.isFinite(p)?p:0,dailyTotal:h==null?null:Number(h),status:u,baseStatus:u,notes:f}):(j(c("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(j(c("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(j(c("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function js(e){e.preventDefault();try{await Et()}catch(a){console.error("❌ [technicians] failed to load positions before submit",a);const i=a?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");j(i,"error");return}const t=Ss();if(!t)return;const n=Mn({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{le?(await Rn(le,n),j(c("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await Wa(n),j(c("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),Gt(),pe()}catch(a){console.error("❌ [technicians] handleTechnicianSubmit failed",a);const i=Nt(a)?a.message:c("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");j(i,"error")}}function Ps(){Gt()}function As(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=et(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=fe(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=fe(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==i&&(t.total.value=i);const s=e.baseStatus||e.status||"available";t.status.value!==s&&(t.status.value=s),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),Xe(t.phone,et),Xe(t.wage,fe),Xe(t.total,fe)}function Ts(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),l=document.getElementById("edit-technician-total"),r=document.getElementById("edit-technician-status"),d=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!l||!r)return null;const u=e.value.trim(),f=t.value.trim(),m=et(n.value.trim());n.value=m;const p=a.value.trim(),h=i?.value.trim()||"",v=fe(s.value.trim());s.value=v;const P=v===""?0:parseFloat(v),S=fe(l.value.trim());l.value=S;const A=S===""?null:parseFloat(S),T=r.value||"available",E=d?.value.trim()||"";return u?f?m?p?Number.isNaN(P)||P<0?(j(c("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),s.focus(),null):A!=null&&(Number.isNaN(A)||A<0)?(j(c("technicians.toast.invalidTotal","⚠️ أدخل قيمة صحيحة للتكلفة الإجمالية")),l.focus(),null):{id:u,name:f,phone:m,role:p,department:h,dailyWage:Number.isFinite(P)?P:0,dailyTotal:A==null?null:Number(A),status:T,baseStatus:T,notes:E}:(j(c("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),a.focus(),null):(j(c("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(j(c("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(j(c("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function Is(){const e=Ts();if(!e)return;const t=Mn({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await Rn(e.id,t),j(c("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),pe()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const a=Nt(n)?n.message:c("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");j(a,"error")}}function pe(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Bt(t?.value||"");if(Dt&&!An){const u=c("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='6'>${u}</td></tr>`;return}if(bt&&!An){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${bt}</td></tr>`;return}const a=Yn(),{reservations:i=[]}=X(),s=new Date;gs(a);const l=document.getElementById("technician-role-filter"),r=Bt(l?.value||""),d=a.filter(u=>r&&Bt(u.role||"")!==r?!1:n?Bt([u.name,u.phone,u.role,u.department,u.notes].filter(Boolean).join(" ")).includes(n):!0);if(d.length===0){const u=c("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='6'>${u}</td></tr>`;return}e.innerHTML=d.map(u=>{const f=le&&String(le)===String(u.id),h=(ri(u.id,i,s)?"busy":u.status||u.baseStatus||"available")==="busy"?{label:c("technicians.status.busy","⛔ مشغول"),className:"technician-status-badge technician-status-badge--busy"}:{label:c("technicians.status.available","✅ متاح"),className:"technician-status-badge technician-status-badge--available"},v=c("technicians.actions.edit","✏️ تعديل"),P=c("technicians.actions.delete","🗑️ حذف"),S=It(),A=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${u.id}">${v}</button>`];return S&&A.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${u.id}">${P}</button>`),`
      <tr${f?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${u.id}" class="text-decoration-none">${u.name}</a></td>
        <td>${u.role||""}</td>
        <td>${u.department||"—"}</td>
        <td><span class="${h.className}"><span class="technician-status-badge__text">${h.label}</span></span></td>
        <td class="table-notes-cell">${u.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${A.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Jt(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function ii(e="add"){const{submitBtn:t,cancelBtn:n}=Jt(),a=e==="update";if(t){const i=a?"positions.form.actions.update":"positions.form.actions.submit",s=a?"💾 حفظ المنصب":"➕ إضافة منصب";t.textContent=c(i,s)}n&&(n.classList.toggle("d-none",!a),n.textContent=c("positions.form.actions.cancel","إلغاء"))}function Kn(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:i,clientPriceInput:s}=Jt();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),i&&(i.value=""),s&&(s.value=""),Te=null,ii("add")}function Ns(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:i,clientPriceInput:s}=Jt();!e||!i||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),i.value=fe(e.cost??0),s&&(s.value=e.clientPrice==null?"":fe(e.clientPrice)),Te=e.id||null,ii("update"))}function Es(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=Jt();if(!n)return null;const i=e?.value.trim()||"",s=t?.value.trim()||"",l=s||i,r=Te?Ce().find(p=>String(p.id)===String(Te)):null,d=fe(n.value.trim());n.value=d;const u=d===""?0:parseFloat(d),f=a?fe(a.value.trim()):"";a&&(a.value=f);const m=f===""?null:parseFloat(f);return l?!Number.isFinite(u)||u<0?(j(c("positions.toast.invalidCost","⚠️ أدخل قيمة صحيحة للتكلفة")),n.focus(),null):m!=null&&(!Number.isFinite(m)||m<0)?(j(c("positions.toast.invalidClientPrice","⚠️ أدخل قيمة صحيحة لسعر العميل")),a?.focus(),null):{id:Te,name:r?.name||l,cost:Number(u.toFixed(2)),clientPrice:m==null?null:Number(m.toFixed(2)),labelAr:i||null,labelEn:s||null}:(j(c("positions.toast.invalidName","⚠️ يرجى إدخال اسم المنصب")),e&&e.focus(),null)}function tt(){const e=document.getElementById("technician-role");if(!e)return;const t=le?si(le):null;Hn(e.value,t||{})}function we(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=Ce();if(t&&(t.textContent=g(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${c("positions.table.empty","لا توجد مناصب بعد.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const i=Te&&String(Te)===String(a.id),s=Mt(a.cost||0),l=a.clientPrice==null?c("technicians.positionSummary.noClientPrice","—"):Mt(a.clientPrice),r=Tn(a,"ar")||"—",d=Tn(a,"en")||"—",u=c("positions.table.actions.edit","✏️ تعديل"),f=c("positions.table.actions.delete","🗑️ حذف");return`
      <tr${i?' class="technician-table-row-editing"':""}>
        <td>${Me(r)}</td>
        <td>${Me(d)}</td>
        <td>${Me(s)}</td>
        <td>${Me(l)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${u}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${f}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function _s(e){e.preventDefault();const t=Es();if(t)try{const n=!!Te;n?await ms(t.id,t):await ps(t);const a=n?c("positions.toast.updateSuccess","💾 تم حفظ بيانات المنصب"):c("positions.toast.addSuccess","✅ تم إضافة المنصب");j(a),Kn(),we(),_t(),tt()}catch(n){console.error("❌ [technicians] handlePositionSubmit failed",n);const a=n?.message||c("positions.toast.saveFailed","⚠️ تعذر حفظ بيانات المنصب، حاول مرة أخرى");j(a,"error")}}function ws(){Kn()}async function xs(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await Et();const a=Ce().find(i=>String(i.id)===String(n));if(!a){j(c("positions.toast.notFound","⚠️ تعذر العثور على بيانات المنصب"),"error");return}Ns(a),we();return}if(t.classList.contains("position-delete-btn")){if(!confirm(c("positions.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا المنصب؟")))return;await fs(n),Te&&String(Te)===String(n)&&Kn(),j(c("positions.toast.deleteSuccess","🗑️ تم حذف المنصب")),we(),_t(),tt()}}catch(t){console.error("❌ [technicians] handlePositionsTableClick failed",t);const n=t?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى");j(n,"error")}}function Cs(e){const t=ei().find(n=>String(n.id)===String(e));if(!t){j(c("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}vs(t),j(c("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function $s(e){if(!It()){Bn();return}if(confirm(c("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await Ka(e),j(c("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),le&&String(le)===String(e)&&Gt(),pe()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=Nt(t)?t.message:c("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");j(n,"error")}}function Wo(){Gn(),pe()}function si(e){return ei().find(t=>String(t.id)===String(e))||null}function ri(e,t=[],n){const a=pa(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(d=>pa(d)===a))return!1;const l=new Date(i.start),r=new Date(i.end);return Number.isNaN(l.getTime())||Number.isNaN(r.getTime())?!1:l<=n&&n<r}):!1}function Yn(){const e=X().reservations||[],t=qn();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const l=s.baseStatus||s.status||"available";let r=l==="busy"?"busy":l;return ri(s.id,e,n)&&(r="busy"),(r!==s.status||l!==s.baseStatus)&&(a=!0),{...s,baseStatus:l,status:r}});return a?(rt(i),i):t}function Gn(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",p=>{js(p).catch(h=>{console.error("❌ [technicians] submit handler failed",h)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ps),n.dataset.listenerAttached="true"),Xe(document.getElementById("technician-phone"),et);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{tt()}),a.dataset.listenerAttached="true");const i=document.getElementById("technicians-table");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",p=>{const h=p.target;if(h instanceof HTMLElement){if(h.classList.contains("technician-edit-btn")){const v=h.dataset.id;Cs(v)}if(h.classList.contains("technician-delete-btn")){const v=h.dataset.id;$s(v).catch(P=>{console.error("❌ [technicians] delete handler failed",P)})}}}),i.dataset.listenerAttached="true");const s=document.getElementById("search-technician-input");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=g(s.value),pe()}),s.dataset.listenerAttached="true");const l=document.getElementById("technician-role-filter");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{pe()}),l.dataset.listenerAttached="true");const r=document.getElementById("save-technician-changes");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{Is().catch(p=>{console.error("❌ [technicians] modal save failed",p)})}),r.dataset.listenerAttached="true");const d=document.getElementById("position-form");d&&!d.dataset.listenerAttached&&(d.addEventListener("submit",p=>{_s(p).catch(h=>{console.error("❌ [technicians] position submit failed",h)})}),d.dataset.listenerAttached="true");const u=document.getElementById("position-cancel-btn");u&&!u.dataset.listenerAttached&&(u.addEventListener("click",ws),u.dataset.listenerAttached="true");const f=document.getElementById("positions-table");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",xs),f.dataset.listenerAttached="true"),Xe(document.getElementById("position-cost"),fe),Xe(document.getElementById("position-client-price"),fe);const m=document.querySelector("[data-tech-tabs]");m&&!m.dataset.listenerAttached&&(m.querySelectorAll("[data-tech-tab]").forEach(h=>{h&&h.addEventListener("click",()=>{const v=h.getAttribute("data-tech-tab");ma(v)})}),m.dataset.listenerAttached="true"),ma(ze),Et().then(()=>{_t(),ze==="technicians-positions"&&we(),tt()}).catch(p=>{console.error("❌ [technicians] failed to load technician positions",p),j(p?.message||c("positions.toast.fetchFailed","⚠️ تعذر تحميل المناصب، حاول مرة أخرى"),"error")}),da||(document.addEventListener("technician:prefill",p=>{const h=p.detail;h&&As(h)}),da=!0),t&&Gt(),ze==="technicians-positions"&&we()}window.addEventListener("DOMContentLoaded",()=>{Gn(),pe(),Wn(),Za()});const oi=()=>{pe()};window.addEventListener("technicians:updated",oi);document.addEventListener("technicians:updated",oi);document.addEventListener("technicians:refreshRequested",()=>{Gn(),pe(),Wn(),Za({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Wn(),_t(),ze==="technicians-positions"&&we(),tt()});document.addEventListener(za.USER_UPDATED,()=>{pe()});const ci=()=>{_t(),ze==="technicians-positions"&&we(),tt()};window.addEventListener("technicianPositions:updated",ci);document.addEventListener("technicianPositions:updated",ci);function yt(e){return g(String(e||"")).trim().toLowerCase()}function Vt(e){const t=String(e??"").trim().toLowerCase();return t||""}function li(){const{packages:e=[]}=X();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function Ko(e){const t=Vt(e);return t&&li().find(a=>Vt(a?.id??a?.packageId??a?.package_id)===t)||null}function Qt(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.equipment)&&n.push(...e.equipment),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(r=>({barcode:r}))),n.forEach(r=>{if(!r)return;if(typeof r=="string"||typeof r=="number"){const p=yt(r);if(!p)return;t.push({equipmentId:null,barcode:p,normalizedBarcode:p,qty:1,price:0,desc:""});return}if(typeof r!="object")return;const d=yt(r.barcode??r.equipmentBarcode??r.code??r.serial??r.serialNumber??r.serial_number),u=[r.equipmentId,r.equipment_id,r.itemId,r.item_id,r.id].find(p=>p!=null&&p!==""),f=[r.unit_price,r.unitPrice,r.price,r.daily_rate].find(p=>Number.isFinite(Number(p))),m=[r.quantity,r.qty,r.count].find(p=>Number.isFinite(Number(p))&&Number(p)>0);t.push({equipmentId:u!=null?String(u):null,barcode:r.barcode??r.equipmentBarcode??r.code??r.serial??r.serialNumber??"",normalizedBarcode:d,qty:m!=null?Number(m):1,price:f!=null?Number(f):0,desc:r.description??r.desc??r.name??"",image:r.image??r.imageUrl??r.img??null})});const a=new Map,{equipment:i=[]}=X()||{},s=new Map,l=new Map;return(Array.isArray(i)?i:[]).forEach(r=>{if(!r||typeof r!="object")return;[r.id,r.equipment_id,r.equipmentId,r.item_id,r.itemId].map(f=>f!=null?String(f):"").filter(Boolean).forEach(f=>{s.has(f)||s.set(f,r)});const u=yt(r.barcode);u&&!l.has(u)&&l.set(u,r)}),t.forEach(r=>{if(r.equipmentId&&s.has(r.equipmentId)){const d=s.get(r.equipmentId);if(d){if(r.desc||(r.desc=d.desc||d.description||d.name||""),r.barcode||(r.barcode=d.barcode||""),r.price==null||r.price===0){const u=d.price??d.unit_price,f=Number(u);Number.isFinite(f)&&f>=0&&f<1e6&&(r.price=f)}r.image||(r.image=d.image||d.imageUrl||d.img||null)}}else if(r.normalizedBarcode&&l.has(r.normalizedBarcode)){const d=l.get(r.normalizedBarcode);if(d){if(r.desc||(r.desc=d.desc||d.description||d.name||""),r.barcode||(r.barcode=d.barcode||""),r.price==null||r.price===0){const u=d.price??d.unit_price,f=Number(u);Number.isFinite(f)&&f>=0&&f<1e6&&(r.price=f)}r.image||(r.image=d.image||d.imageUrl||d.img||null)}}}),t.forEach(r=>{const d=r.normalizedBarcode||(r.barcode?yt(r.barcode):""),u=d||(r.equipmentId?`id:${r.equipmentId}`:null);if(!u)return;if(!a.has(u)){a.set(u,{...r,normalizedBarcode:d});return}const f=a.get(u);f.qty+=r.qty,!f.price&&r.price&&(f.price=r.price),!f.desc&&r.desc&&(f.desc=r.desc),!f.image&&r.image&&(f.image=r.image)}),Array.from(a.values())}function Ls(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const a of t){const i=Number(a);if(Number.isFinite(i))return i}return Qt(e).reduce((a,i)=>a+(i.price||0)*(i.qty||1),0)}function Bs(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Fs(){return li().map(t=>{const n=Vt(t?.id??t?.packageId??t?.package_id??t?.code),a=Bs(t)||n||"package",i=Ls(t);return{id:n,name:a,price:i,code:t?.package_code??t?.code??n,items:Qt(t),raw:t}}).filter(t=>t.id)}function Yo(e){const t=yt(e);return t?Fs().filter(n=>n.items.some(a=>a.normalizedBarcode===t)):[]}function Go(e){return Qt(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}const ks=()=>c("reservations.create.summary.currency","SR");let nt=[],Ae=[],Ee=[],_e=[],ae="create",di=()=>{},ui=()=>{};const qt=new Map,In=450;function Ds(e){const t=qt.get(e);return t!=null&&Date.now()-t<In}function qs(e){qt.set(e,Date.now()),setTimeout(()=>{const t=qt.get(e);t!=null&&Date.now()-t>=In&&qt.delete(e)},In+50)}function St(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function We(e={}){return{...e,assignmentId:e.assignmentId||St()}}function Xt(e){if(!e)return null;const t=String(e),n=nt.find(i=>String(i?.id)===t);if(n)return{...n};const{technicians:a=[]}=X();return a.find(i=>String(i?.id)===t)||null}function at(e={},t=re()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function Jn(e={},t=re()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function pi(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const a=Ae.find(s=>String(s.id).trim().toLowerCase()===n);if(a)return a;const i=Qa(e);return i||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function fa(e){const t=pi(e,e?.name??""),n=re(),a=at(t,n)||t?.name||"",i=Jn(t,n);return Nn({assignmentId:St(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:a,positionLabelAlt:i,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Nn(e={}){const t={assignmentId:e.assignmentId||St(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=pi(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const a=re(),i=at(n,a)||t.positionLabel,s=Jn(n,a);t.positionLabel=i||t.positionLabel||n?.name||"",t.positionLabelAlt=s||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const a=Xt(t.technicianId);a?(t.technicianId=String(a.id),t.technicianName=a.name??t.technicianName??null,t.technicianRole=a.role??t.technicianRole??null,t.technicianPhone=a.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function ot(){Ae=Ce()}function Rs(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return We(Nn(t));const n=Xt(t),a=n?{assignmentId:St(),positionLabel:n.role||c("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:St(),positionLabel:c("reservations.crew.positionFallback","منصب بدون اسم"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return We(Nn(a))}).filter(Boolean):[]}function ke(e="create"){return e==="edit"?_e.map(We):Ee.map(We)}function xe(e="create",t=[]){try{ot()}catch{}const n=Rs(t);e==="edit"?(_e=n,it("edit-selected-technicians-list",_e,"edit"),ui()):(Ee=n,it("selected-technicians-list",Ee,"create"),di()),jt()}function Qn(e="create"){if(e==="edit"){const r=document.getElementById("edit-res-start")?.value?.trim(),d=document.getElementById("edit-res-end")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",f=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",m=r?Lt(r,u):null,p=d?Lt(d,f):null;let h=null;const v=document.getElementById("edit-res-index")?.value;if(v!=null){const P=Number.parseInt(v,10);if(Number.isInteger(P)){const{reservations:S=[]}=X(),A=S?.[P];A&&(h=A.id??A.reservationId??null)}}return{start:m,end:p,ignoreReservationId:h}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?Lt(t,a):null,l=n?Lt(n,i):null;return{start:s,end:l,ignoreReservationId:null}}function jt(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=ke(ae).length;if(t){const n=c("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",g(String(t)));e.textContent=n}else e.textContent=c("technicians.picker.selectionInfo","No crew selected yet")}function zt(e){const t=Number.isFinite(e)?e:0;return`${g(t.toFixed(2))} ${ks()}`}function Ms(e){const t=ke(ae),n=new Set(t.filter(u=>u.assignmentId!==e&&u.technicianId).map(u=>u.technicianId)),a=nt.length?nt:X().technicians||[],{start:i,end:s,ignoreReservationId:l}=Qn(ae),r=!!(i&&s);return a.map(u=>{const f=String(u.id),m=n.has(f),p=r?Fn(f,i,s,l):!1,h=g(u.name||u.full_name||u.fullName||u.email||f);return{id:f,label:h,disabled:m||p,conflict:p,taken:m}})}function ve(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=ke(ae);if(!t.length){const n=c("technicians.picker.noAssignments","لم يتم إضافة أي مناصب بعد"),a=c("technicians.picker.assignments.hint","استخدم قائمة المناصب على اليسار لإضافة طاقم العمل.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">🧑‍🤝‍🧑</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${a}</p>
          </div>
        </td>
      </tr>
    `;return}ot(),e.innerHTML=t.map((n,a)=>{const i=g(String(a+1)),s=zt(n.positionClientPrice||0),l=Ms(n.assignmentId),r=c("technicians.picker.noTechnicianOption","— بدون تعيين —"),d=n.technicianId!=null?String(n.technicianId):"",u=n.technicianName?g(n.technicianName):"",f=`crew-assignment-options-${n.assignmentId}`,m=c("technicians.picker.optionAssigned","(مستخدم)"),p=c("technicians.picker.optionConflicting","(متعارض)"),h=l.map(T=>{const E=d===T.id,B=T.disabled&&!E?`${T.label} ${T.conflict?p:m}`:T.label;return`
        <option value="${T.label}"
                data-id="${T.id}"
                data-disabled="${T.disabled?"true":"false"}"
                data-conflict="${T.conflict?"true":"false"}"
                data-taken="${T.taken?"true":"false"}"
                label="${B}"></option>
      `}).join("");let v=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!v||String(v).trim()===""){const T=n.positionId?Ae.find(I=>String(I.id)===String(n.positionId)):null,E=!T&&n.positionKey?Ae.find(I=>String(I.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(T||E){const I=T||E;v=at(I,re())||I?.name||""}}const P=n.positionLabelAlt?`<div class="text-muted small">${g(n.positionLabelAlt)}</div>`:"",S=c("technicians.picker.actions.remove","إزالة"),A=c("technicians.picker.assignments.price","سعر العميل");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${i}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${g(v||c("reservations.crew.positionFallback","منصب بدون اسم"))}</div>
            ${P}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${A}">${s}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${f}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${r}"
              value="${d?u:""}"
              aria-label="${c("technicians.picker.assignments.member","عضو الطاقم")}"
              autocomplete="off"
            />
            <datalist id="${f}">
              ${h}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${S}">
            ${S}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{mi(n.dataset.assignmentId,ae)}),n.dataset.listenerAttached="true")}),Vs(e)}function Vs(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const a=n.dataset.assignmentId,i=()=>{zs(n,a)};n.addEventListener("change",i),n.addEventListener("blur",i),n.dataset.listenerAttached="true"})}function zs(e,t){if(!t||Ds(t))return;qs(t);const n=e.value?.trim()??"";if(!n){Ft(t,"");return}const a=e.getAttribute("list"),i=a?document.getElementById(a):null,s=i?Array.from(i.options):[],l=g(n).toLowerCase(),r=s.find(u=>g(u.value).toLowerCase()===l);if(!r){j(c("technicians.picker.toast.autocompleteNoMatch","⚠️ لم يتم العثور على فني مطابق، الرجاء اختيار من القائمة")),e.value="",Ft(t,"");return}if(r.dataset.disabled==="true"){r.dataset.conflict==="true"?j(c("technicians.picker.optionConflict","⚠️ هذا العضو لديه تعارض في التاريخ/الوقت المحدد")):j(c("technicians.picker.optionTaken","⚠️ لا يمكن اختيار هذا العضو لأنه مرتبط بمنصب آخر")),e.value="";return}const d=r.dataset.id;if(!d){j(c("technicians.picker.toast.autocompleteNoMatch","⚠️ لم يتم العثور على فني مطابق، الرجاء اختيار من القائمة")),e.value="",Ft(t,"");return}Ft(t,d)}function En(){const e=document.getElementById("crew-position-list");if(!e)return;ot();const t=document.getElementById("crew-position-search"),n=g(String(t?.value||"")).trim().toLowerCase(),i=ke(ae).reduce((r,d)=>{const u=d?.positionId!=null?String(d.positionId):null;return u&&r.set(u,(r.get(u)||0)+1),r},new Map),s=Ae.filter(r=>n?[r.labelAr,r.labelEn,r.name].filter(Boolean).map(u=>g(String(u)).toLowerCase()).join(" ").includes(n):!0);if(!s.length){e.innerHTML=`<div class="text-muted">${c("technicians.picker.noPositions","لا توجد مناصب مطابقة.")}</div>`;return}const l=re();e.innerHTML=s.map(r=>{const d=at(r,l)||r.name||"",u=Jn(r,l),f=zt(r.clientPrice||0),m=zt(r.cost||0),p=u?`<span class="crew-position-card__subtitle">${g(u)}</span>`:"",h=c("technicians.picker.positionCostLabel","التكلفة"),v=c("technicians.picker.positionClientPriceLabel","سعر العميل"),P=c("technicians.picker.actions.addPosition","إضافة المنصب"),S=i.get(String(r.id))||0,A=c("technicians.picker.positionCountBadge","مضاف ×{count}").replace("{count}",g(String(S)));return`
      <article class="crew-position-card" data-position-id="${r.id}" tabindex="0" role="button" aria-label="${g(d)}">
        ${S>0?`<span class="crew-position-card__badge" aria-label="${A}">${g(String(S))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">🎯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${g(d)}</h6>
            ${p}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${h}</span>
            <span class="crew-position-card__metric-value">${m}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${v}</span>
            <span class="crew-position-card__metric-value">${f}</span>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary crew-position-add-btn" data-position-id="${r.id}">
            ${P}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(r=>{r.dataset.listenerAttached||(r.addEventListener("click",d=>{d.stopPropagation(),bn(r.dataset.positionId)}),r.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(r=>{r.dataset.cardListenerAttached||(r.addEventListener("click",()=>{bn(r.dataset.positionId)}),r.addEventListener("keydown",d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),bn(r.dataset.positionId))}),r.dataset.cardListenerAttached="true")})}function bn(e){ot();const t=Ae.find(i=>String(i.id)===String(e)),n=fa(t||{id:null,name:""}),a=ke(ae);a.push(n),xe(ae,a),ve(),j(c("technicians.picker.toast.positionAdded","✅ تم إضافة المنصب إلى القائمة"),"success")}function mi(e,t="create"){if(!e)return;const n=ke(t).filter(a=>a.assignmentId!==e);xe(t,n),ve(),j(c("technicians.picker.toast.positionRemoved","🗑️ تم حذف المنصب من القائمة"))}function Ft(e,t){if(!e)return;const n=ke(ae),a=n.find(u=>u.assignmentId===e);if(!a)return;if(!t){a.technicianId=null,a.technicianName=null,a.technicianRole=null,xe(ae,n),ve(),j(c("technicians.picker.toast.assignmentCleared","ℹ️ تمت إزالة التعيين من هذا المنصب"));return}if(n.find(u=>u.assignmentId!==e&&u.technicianId===t)){j(c("technicians.picker.duplicateTechnician","⚠️ لا يمكن تعيين نفس الشخص لأكثر من منصب في نفس الحجز")),ve();return}const s=Xt(t),{start:l,end:r,ignoreReservationId:d}=Qn(ae);if(l&&r&&Fn(String(t),l,r,d)){j(c("technicians.picker.optionConflict","⚠️ هذا العضو لديه تعارض في التاريخ/الوقت المحدد")),ve();return}s?(a.technicianId=String(s.id),a.technicianName=s.name??null,a.technicianRole=s.role??null,a.technicianPhone=s.phone??null):(a.technicianId=String(t),a.technicianName=null,a.technicianRole=null,a.technicianPhone=null),xe(ae,n),ve(),a.technicianName?j(c("technicians.picker.toast.assignmentApplied","✅ تم تعيين {name} على هذا المنصب").replace("{name}",g(a.technicianName)),"success"):j(c("technicians.picker.toast.assignmentIdApplied","✅ تم تعيين العضو المحدد على هذا المنصب"),"success")}async function ya(e="create"){ae=e,ve(),jt();let t=Yn();if(!Array.isArray(t)||t.length===0)try{const a=await Wt();t=Array.isArray(a)?a:[]}catch(a){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",a)}Array.isArray(t)&&(nt=t);try{await Et()}catch(a){console.warn("[reservations/crew] failed to load positions",a)}ot(),En(),ve(),jt();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function Hs(){return ke(ae).map(We)}function Os(){const e=Hs(),{start:t,end:n,ignoreReservationId:a}=Qn(ae);if(t&&n){const s=e.filter(l=>l.technicianId&&Fn(l.technicianId,t,n,a));if(s.length>0){const l=s.map(d=>d.technicianName||d.technicianId).join(c("reservations.list.crew.separator","، ")),r=c("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",l);s.forEach(d=>{d.technicianId=null,d.technicianName=null}),xe(ae,e),ve(),j(r),jt();return}}xe(ae,e);const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.(),j(c("technicians.picker.toast.selectionApplied","✅ تم حفظ الطاقم بنجاح"),"success")}function it(e,t=[],n="create"){const a=document.getElementById(e);if(a){if(!t.length){a.innerHTML=`<span class="text-muted">${c("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.")}</span>`;return}ot(),a.innerHTML=t.map(i=>{let s=i.positionLabel??i.position_label??i.position_name??i.role??i.position??"";if(!s||String(s).trim()===""){const m=i.positionId?Ae.find(h=>String(h.id)===String(i.positionId)):null,p=!m&&i.positionKey?Ae.find(h=>String(h.name).toLowerCase()===String(i.positionKey).toLowerCase()):null;s=m?at(m,re())||m?.name||"":p&&(at(p,re())||p?.name)||""}const l=g(s||c("reservations.crew.positionFallback","منصب بدون اسم")),r=i.technicianName?`${g(i.technicianName)}`:c("technicians.picker.noTechnicianOption","— بدون تعيين —");let d=Number(i.positionClientPrice);if(!Number.isFinite(d)||d<=0){const m=[i.position_client_price,i.client_price,i.customer_price,i.daily_total,i.dailyTotal,i.total];for(const p of m){const h=Number(p);if(Number.isFinite(h)&&h>0){d=h;break}}}if((!Number.isFinite(d)||d<=0)&&(i.positionId||i.positionKey)){const m=i.positionId?Ae.find(v=>String(v.id)===String(i.positionId)):null,p=!m&&i.positionKey?Ae.find(v=>String(v.name).toLowerCase()===String(i.positionKey).toLowerCase()):null,h=m||p||null;h&&Number.isFinite(Number(h.clientPrice))&&(d=Number(h.clientPrice))}const u=zt(Number.isFinite(d)&&d>0?d:0),f=c("reservations.crew.removeAria","إزالة");return`
      <span class="technician-chip" data-assignment-id="${i.assignmentId}">
        <span class="technician-chip-name">${l}</span>
        <small class="technician-chip-role">${r}</small>
        <small class="technician-chip-wage">💼 ${u}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${i.assignmentId}" aria-label="${f}">✖</button>
      </span>
    `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>{mi(i.dataset.assignmentId,i.dataset.context)}),i.dataset.listenerAttached="true")})}}function Us(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",l=>{const r=document.getElementById("res-customer")?.value?.trim(),d=document.getElementById("res-start")?.value?.trim(),u=document.getElementById("res-end")?.value?.trim(),f=document.getElementById("res-start-time")?.value?.trim(),m=document.getElementById("res-end-time")?.value?.trim(),p=!!(d&&u),h=!!(f&&m),v=!!r;if(!p||!h){l.preventDefault(),j(c("technicians.picker.requireDates","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية أولاً"),"warning");return}if(!v){l.preventDefault(),j(c("technicians.picker.requireCustomer","⚠️ يرجى اختيار العميل أولاً"),"warning");return}ya("create")}),e.dataset.listenerAttached="true";const s=()=>{const l=document.getElementById("res-customer")?.value?.trim(),r=document.getElementById("res-start")?.value?.trim(),d=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),f=document.getElementById("res-end-time")?.value?.trim(),m=!!(l&&r&&d&&u&&f);e.setAttribute("aria-disabled",String(!m)),e.dataset.ready=m?"true":"false",e.classList.toggle("is-disabled",!m)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(l=>document.getElementById(l)).filter(Boolean).forEach(l=>{["input","change"].forEach(r=>l.addEventListener(r,s))}),s()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>ya("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{En()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Os),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",async()=>{if(!nt.length&&(!X().technicians||X().technicians.length===0))try{await Wt()}catch(s){console.warn("[crew-picker] fetch on show failed",s)}En(),ve(),jt()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("crew-position-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),it("selected-technicians-list",Ee,"create"),it("edit-selected-technicians-list",_e,"edit")}function Jo({onDraftChange:e,onEditChange:t}={}){di=typeof e=="function"?e:()=>{},ui=typeof t=="function"?t:()=>{},Us()}function Ws(){return Ee.map(We)}function Ks(){return _e.map(We)}function ha(){return Ee.map(e=>e.technicianId).filter(Boolean).map(String)}function ba(){return _e.map(e=>e.technicianId).filter(Boolean).map(String)}function Qo(e=[]){xe("edit",e)}function Xo(){xe("create",[])}function Zo(){xe("edit",[])}function ga(e=[]){return e.map(t=>{if(t.technicianId){const n=Xt(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function ec(e=[]){Array.isArray(e)&&e.length&&(nt=e),Ee=ga(Ee),_e=ga(_e),it("selected-technicians-list",Ee,"create"),it("edit-selected-technicians-list",_e,"edit"),ve()}function va(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),a=t.join("");return n?`${a}.${n}`:a}function fi(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=g(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),a=t.indexOf("-"),i=a!==-1&&(n===-1||a<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const s=t.includes(","),l=t.includes(".");if(s&&l){const d=t.lastIndexOf(","),u=t.lastIndexOf(".");d>u?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(s){const d=t.split(",");d.length===2&&d[1].length===3?t=d.join(""):t=t.replace(/,/g,".")}else if(l){const d=t.split(".");if(d.length===2){const[,u]=d;if(u.length===3){const f=d.join("");/^[0-9]+$/.test(f)&&(t=f)}}else d.length>2&&(t=va(t))}if(t=t.replace(/,/g,""),t=va(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const r=Number.parseFloat(t);return Number.isFinite(r)?i?-r:r:Number.NaN}function ie(e){return fi(e)}function se(e){const t=fi(e);if(!Number.isFinite(t))return 0;let n=t,a=0;for(;Math.abs(n)>1e5&&a<8;)n/=10,a+=1;return Number(n.toFixed(2))}function ht(e){return g(String(e??"")).trim().toLowerCase()}function Fe(e=""){return g(String(e)).trim().toLowerCase()}const Ys=2;function Gs(e){const t=ie(e);return Number.isFinite(t)?t.toFixed(Ys):"0.00"}function Sa(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const a=Number.parseFloat(g(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(a)&&a>0)return se(a)}return 1}function Js(e={}){const t=e?.desc||e?.description||e?.name||"",n=Fe(t),a=Gs(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${a}`}function Qs(e=[]){const t=new Map;return e.forEach((n,a)=>{const i=Js(n);if(!i)return;if(!t.has(i)){const l=n?.desc||n?.description||n?.name||"",r=Fe(l),d=Pa(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(i,{key:i,description:l,normalizedDescription:r,unitPrice:d,image:u,items:[],itemIndices:[],barcodes:[]})}const s=t.get(i);s.items.push(n),s.itemIndices.push(a),n?.barcode&&s.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((a,i)=>a+Sa(i),0)})).map(n=>{const a=n.quantity||0,i=n.items.reduce((u,f)=>{const m=Pa(f),p=Sa(f);return u+m*p},0),s=se(i),l=ie(n.unitPrice),r=Number.isFinite(l)?l:0,d=a>0?se(s/a):se(r);return{...n,quantity:a,count:a,totalPrice:s,unitPrice:d}})}function ja(e={}){return(Qt(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??ht(n?.barcode),qty:(()=>{const a=Number.parseFloat(g(String(n?.qty??n?.quantity??1)));return Number.isFinite(a)&&a>0?a:1})(),price:(()=>{const a=ie(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(a)?a:0})()}))}function _n(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(g(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function Xs(e={},t=[],n=null){const a=e.unit_price??e.unitPrice??e.price,i=ie(a);if(Number.isFinite(i)&&i>0)return se(i);const s=e.total_price??e.totalPrice??e.total,l=ie(s),r=Number.parseFloat(g(String(n)).replace(/[^0-9.]/g,"")),d=Number.isFinite(r)&&r>0?r:_n(e);if(Number.isFinite(l)&&l>0&&d>0)return se(l/d);if(Array.isArray(t)&&t.length){const u=t.reduce((f,m)=>{const p=ie(m.price??m.unit_price??m.unitPrice),h=Number.parseFloat(g(String(m.qty??m.quantity??1)).replace(/[^0-9.]/g,"")),v=Number.isFinite(h)&&h>0?h:1;return f+p*v},0);if(u>0&&d>0)return se(u/d)}return 0}function tc(e={}){const t=Array.isArray(e?.items)?e.items:[],n=Qs(t),a=new Map,i=(m,p=0,h="packages")=>{if(!m||typeof m!="object")return;const P=Vt(m?.package_code??m?.packageId??m?.package_id??m?.code??m?.id??m?.barcode??`pkg-${p}`)||`pkg-${p}`;if(!a.has(P)){a.set(P,{source:m,normalizedId:P,index:p,itemSource:h==="items"?m:null});return}const S=a.get(P);if(S.source||(S.source=m),h==="items"&&(S.itemSource=m,S.source&&typeof S.source=="object")){const A=Array.isArray(S.source.packageItems)&&S.source.packageItems.length>0,T=Array.isArray(m.packageItems)&&m.packageItems.length>0;!A&&T&&(S.source={...S.source,packageItems:m.packageItems}),!S.source.image&&m.image&&(S.source={...S.source,image:m.image})}};Array.isArray(e?.packages)&&e.packages.forEach((m,p)=>i(m,p,"packages")),t.forEach((m,p)=>{m&&typeof m=="object"&&(m.type==="package"||Array.isArray(m?.packageItems))&&i(m,p+a.size,"items")});const s=[],l=new Set,r=new Set;a.forEach(({source:m,itemSource:p=null,normalizedId:h},v)=>{const P=m||{},S=p&&typeof p=="object"?p:null;let A=ja(P);(!Array.isArray(A)||A.length===0)&&S&&(A=ja(S)),A.forEach(x=>{const $=x?.normalizedBarcode??ht(x?.barcode);$&&l.add($);const F=x?.equipmentId??x?.equipment_id??null;F!=null&&r.add(String(F))});let T=_n(P);if(S){const x=_n(S);Number.isFinite(x)&&x>0&&(T=x)}(!Number.isFinite(T)||T<=0)&&(T=1);let E=Xs(P,A,T);const I=[S?.price,S?.unit_price,S?.unitPrice];for(const x of I){const $=ie(x);if(Number.isFinite($)&&$>0){E=se($);break}}E=se(E);const B=[S?.total,S?.total_price,S?.totalPrice,P?.total,P?.total_price,P?.totalPrice];let L=NaN;for(const x of B){const $=ie(x);if(Number.isFinite($)&&$>=0){L=$;break}}Number.isFinite(L)||(L=E*T),L=se(L);const q=[P?.displayCode,P?.display_code,P?.package_code,P?.packageCode,P?.code,P?.barcode,P?.packageId,P?.package_id,S?.displayCode,S?.display_code,S?.package_code,S?.packageCode,S?.code,S?.barcode,S?.packageId,S?.package_id,h,v].find(x=>x==null?!1:String(x).trim().length>0),M=q!=null?g(String(q)).trim():"";if(M){const x=ht(M);x&&l.add(x)}const H=A.map(x=>g(String(x?.barcode??x?.normalizedBarcode??""))).filter(Boolean),V=[P?.name,P?.package_name,P?.title,S?.name,S?.desc,S?.package_name,M,g(String(v))].find(x=>x!=null&&String(x).trim()!=="")||g(String(M||v)),W=A.find(x=>x?.image)?.image??P?.image??S?.image??null;s.push({key:`package::${v}`,description:V,normalizedDescription:g(String(V)),unitPrice:E,totalPrice:L,quantity:T,count:T,image:W,barcodes:H,barcode:M,package_code:M,packageDisplayCode:M,items:[{type:"package",packageItems:A,packageId:h,desc:V,price:E,qty:T,barcode:M}],type:"package",packageItems:A,packageId:h})});const d=new Set(Array.from(l).map(m=>ht(m)).filter(Boolean)),u=n.filter(m=>!(m.items.some(v=>v?.type==="package")&&s.length>0||m.items.every(v=>{const P=Zs(v),S=P!=null?String(P):null;if(S&&r.has(S))return!0;const A=v?.barcode?ht(v.barcode):null;return!!(A&&d.has(A))})));return{groups:s.length?[...s,...u]:n,packageGroups:s,groupedItems:n,filteredGroupedItems:u,packagesMap:a}}function Zs(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function Pa(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const a=ie(n);if(Number.isFinite(a))return a}return 0}function nc(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function er(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function yi(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,i=a!=null&&a!==""&&a!=="null",s=i?er(t?.status??t?.status_label??t?.statusLabel??""):null,l=i&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:n,projectLinked:i,projectStatus:s,projectConfirmed:l,effectiveConfirmed:i?l:n}}const ye=10;function hi(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=ie(n);if(Number.isFinite(a))return se(a)}return 0}function tr(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const a=ie(n);if(Number.isFinite(a))return se(a)}return hi(e)}function nr(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=X();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));if(!s)return a;const l=hi(s),r=tr(s);return{costPerDay:a.costPerDay+(Number.isFinite(l)?l:0),totalPerDay:a.totalPerDay+(Number.isFinite(r)?r:0)}},{costPerDay:0,totalPerDay:0})}const ar=1440*60*1e3,Qe=.01;function Je(e){if(e==null||e==="")return null;const t=g(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Aa(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:a=2}={}){let i=Number.isFinite(e)?e:0;if(i<t&&(i=t),i>n&&(i=n),a!=null){const s=10**a;i=Math.round(i*s)/s}return i}function bi(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"partial_paid":case"مدفوع جزئياً":return"partial";default:return"unpaid"}}function He({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:a=null,paidPercent:i=null,history:s=[]}={}){const l=Number.isFinite(Number(e))?Number(e):0,r=t==="amount"?"amount":t==="percent"?"percent":null;let d=Je(a),u=Je(i);const f=Je(n);let m=0,p=0;Array.isArray(s)&&s.length&&s.forEach(T=>{if(!T)return;const E=T.type==="amount"||T.type==="percent"?T.type:null,I=Je(T.value),B=Je(T.amount),L=Je(T.percentage);if(E==="amount"){const D=B??I;D!=null&&(m+=D,l>0&&(p+=D/l*100))}else if(E==="percent"){const D=L??I;D!=null&&(p+=D,l>0&&(m+=D/100*l))}else B!=null&&(m+=B,l>0&&(p+=B/l*100)),L!=null&&(p+=L,l>0&&(m+=L/100*l))});function h(T=[]){return!Array.isArray(T)||T.length===0?{costPerDay:0,totalPerDay:0}:T.reduce((E,I)=>{const B=ie(I?.positionCost??I?.position_cost??I?.cost??I?.dailyWage??I?.daily_wage??0),L=ie(I?.positionClientPrice??I?.position_client_price??I?.clientPrice??I?.dailyTotal??I?.daily_total??I?.total??0),D=Number.isFinite(B)?B:0,q=Number.isFinite(L)?L:0;return{costPerDay:E.costPerDay+D,totalPerDay:E.totalPerDay+q}},{costPerDay:0,totalPerDay:0})}typeof globalThis<"u"&&!globalThis.calculateCrewDailyTotalsFromAssignments&&(globalThis.calculateCrewDailyTotalsFromAssignments=h),r==="amount"&&f!=null?d=f:r==="percent"&&f!=null?u=f:r===null&&f!=null&&(u!=null?u=f:d=f),(d==null||d<=0)&&u!=null&&u>0&&l>0&&(d=l*(u/100)),(u==null||u<=0)&&d!=null&&d>0&&l>0&&(u=d/l*100);const v=d??0,P=u??0;d=v+m,u=P+p,d=Aa(d??0,{min:0,max:l>0?l:Number.POSITIVE_INFINITY,precision:2}),u=Aa(u??0,{min:0,max:100,precision:2});let S=r;return S||(d>0&&l>0?S="amount":u>0&&(S="percent")),{paidAmount:d,paidPercent:u,paymentProgressType:S,paymentProgressValue:S==="amount"?d:S==="percent"?u:null}}function st({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:a=0}={}){const i=bi(e),s=Number.isFinite(Number(a))?Number(a):0,l=Number.isFinite(Number(t))?Number(t):0,r=Number.isFinite(Number(n))?Number(n):0;if(i==="paid")return"paid";const d=s>0&&l>=s-Qe,u=r>=100-Qe*100;if(d||u)return"paid";const f=l>Qe||r>Qe;return i==="partial"||f?"partial":"unpaid"}function ir(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/ar;return Math.max(1,Math.ceil(s))}function Xn({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:a=0,discountType:i="percent",applyTax:s=!1,start:l=null,end:r=null,companySharePercent:d=null}={}){const u=ir(l,r),f=(e||[]).reduce((x,$)=>{const F=ie($?.qty??$?.quantity??$?.count??1),U=Number.isFinite(F)&&F>0?F:1,J=ie($?.price??$?.unit_price??$?.unitPrice),C=Number.isFinite(J)?J:0;return x+U*C},0),m=se(f*u),p=Array.isArray(n)?n:[],h=p.length?p.map(x=>x?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:v,totalPerDay:P}=p.length?p.reduce((x,$)=>{const F=ie($?.positionCost??$?.position_cost??$?.cost??$?.dailyWage??$?.daily_wage??0),U=ie($?.positionClientPrice??$?.position_client_price??$?.clientPrice??$?.dailyTotal??$?.daily_total??$?.total??0),J=Number.isFinite(F)?F:0,C=Number.isFinite(U)?U:0;return{costPerDay:x.costPerDay+J,totalPerDay:x.totalPerDay+C}},{costPerDay:0,totalPerDay:0}):nr(h),S=se(P*u),A=se(v*u),T=se(m+S),E=Number(a)||0;let I=i==="amount"?E:T*(E/100);(!Number.isFinite(I)||I<0)&&(I=0),I>T&&(I=T);const B=Math.max(0,T-I);let L=Number.isFinite(d)?Number(d):null;s&&(!Number.isFinite(L)||L<=0)&&(L=ye);const D=L&&L>0?L:0,q=D>0?Math.max(0,B*(D/100)):0,M=B+q;let H=s?M*.15:0;(!Number.isFinite(H)||H<0)&&(H=0),H=Number(H.toFixed(2));const ee=M+H,V=Math.max(0,Number(ee.toFixed(2))),W=Math.max(0,Math.max(0,m+S-I)-A);return{rentalDays:u,equipmentTotal:m,crewTotal:S,crewCostTotal:A,discountAmount:I,subtotalAfterDiscount:B,taxableAmount:M,taxAmount:H,finalTotal:V,companySharePercent:D,companyShareAmount:q,netProfit:W}}function gi(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:l=null,companySharePercent:r=null}={}){const d=p=>p&&typeof p=="object"&&(p.positionId!==void 0||p.position_id!==void 0||p.positionLabel!==void 0||p.position_name!==void 0||p.positionClientPrice!==void 0),u=Array.isArray(i)&&i.some(d)?i:[],f=u.length?u.map(p=>p?.technicianId).filter(Boolean):Array.isArray(i)?i:[];return Xn({items:e,technicianIds:f,crewAssignments:u,discount:t,discountType:n,applyTax:a,start:s,end:l,companySharePercent:r}).finalTotal}function vi({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paymentStatus:s,paidAmount:l=0,paidPercent:r=0,companySharePercent:d=null,companyShareAmount:u=null,taxAmount:f=null,netProfit:m=null,totalKey:p="reservations.summary.total",equipmentTotal:h=null,crewTotal:v=null}){const P=c("reservations.create.summary.currency","SR"),S=g(String(e)),A=g(String(t)),T=g(String(n??1)),E=g(String(a)),I=bi(s),B=I==="paid"?"مدفوع":I==="partial"?"مدفوع جزئياً":"غير مدفوع",L=c(`reservations.create.paymentStatus.${I}`,B),D=Number.isFinite(Number(l))?Math.max(0,Number(l)):0,q=Number.isFinite(Number(r))?Math.max(0,Number(r)):0,M=D>Qe||q>Qe,H=c("reservations.summary.paymentProgressLabel","💰 الدفعة المستلمة"),ee=g(D.toFixed(2)),V=g(q.toFixed(q%1?2:0)),W=c("reservations.summary.itemsLabel","📦 عدد المعدات"),x=c("reservations.summary.durationLabel","⏱️ عدد الأيام"),$=c("reservations.summary.crewLabel","😎 عدد الفريق"),F=c("reservations.details.labels.itemsTotal","💼 إجمالي المعدات"),U=c("reservations.details.labels.crewTotal","😎 إجمالي الفريق"),J=c("reservations.summary.taxLabelShort","🧾 الضريبة"),C=c("reservations.summary.paymentLabelShort","💳 حالة الدفع"),_=c(p.replace(".total",".totalLabel"),"💰 التكلفة الإجمالية"),N=c("reservations.summary.companyShareLabel","🏦 نسبة الشركة"),w=c("reservations.details.labels.netProfit","💵 صافي الربح"),R=Number.isFinite(m)?Math.max(0,Number(m)):null,K=[{label:W,value:A},{label:x,value:T},{label:$,value:E}],k=Number.isFinite(Number(h))?Math.max(0,Number(h)):null;k!=null&&K.push({label:F,value:`${g(k.toFixed(2))} ${P}`});const Y=Number.isFinite(Number(v))?Math.max(0,Number(v)):null;if(Y!=null&&K.push({label:U,value:`${g(Y.toFixed(2))} ${P}`}),i){let O=c("reservations.summary.taxIncludedValue","شامل 15%");Number.isFinite(f)&&f>0&&(O=`${g(Number(f).toFixed(2))} ${P}`),K.push({label:J,value:O})}const z=Number.isFinite(d)?Number(d):null;if(z!==null&&z>0){const O=Number.isFinite(u)?Number(u):e*(z/100),te=g(String(z)),qe=g(Number.isFinite(O)?O.toFixed(2):"0"),Q=`${te}% (${qe} ${P})`;K.push({label:N,value:Q})}if(R!==null&&Math.abs(R-Number(e))>.009){const O=g(R.toFixed(2));K.push({label:w,value:`${O} ${P}`})}K.push({label:C,value:L}),M&&K.push({label:H,value:`${ee} ${P} (${V}%)`});const de=`${S} ${P}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${K.map(({label:O,value:te})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${O}</span>
            ${te?`<span class="reservation-summary-value">${te}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${_}</span>
          <span class="reservation-summary-value">${de}</span>
        </div>
      </div>
    </div>
  `}function sr({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,paymentProgressType:s=null,paymentProgressValue:l=null,start:r,end:d,companySharePercent:u=null,paymentHistory:f=[]}){const m=Ws(),p=typeof ha=="function"?ha()??[]:[],h=Array.isArray(p)?p.map(String):[],v=m.length?m.map(L=>L?.technicianId).filter(Boolean).map(String):h,P=m.length||v.length,S=Number.isFinite(u)?Number(u):null,A=Xn({items:e,technicianIds:v,crewAssignments:m,discount:t,discountType:n,applyTax:a,start:r,end:d,companySharePercent:S}),T=He({totalAmount:A.finalTotal,progressType:s,progressValue:l,history:f}),E=st({manualStatus:i,paidAmount:T.paidAmount,paidPercent:T.paidPercent,totalAmount:A.finalTotal}),I=vi({total:A.finalTotal,itemsCount:e.length,rentalDays:A.rentalDays,techniciansCount:P,applyTax:a,paymentStatus:E,paidAmount:T.paidAmount,paidPercent:T.paidPercent,companySharePercent:A.companySharePercent,companyShareAmount:A.companyShareAmount,taxAmount:A.taxAmount,netProfit:A.netProfit,equipmentTotal:A.equipmentTotal,crewTotal:A.crewTotal}),B={paymentStatus:E,paidAmount:T.paidAmount,paidPercent:T.paidPercent,paymentProgressType:T.paymentProgressType,paymentProgressValue:T.paymentProgressValue,total:A.finalTotal};return sr.lastResult=B,or(I),I}function rr({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,paymentProgressType:s=null,paymentProgressValue:l=null,start:r,end:d,companySharePercent:u=null,paymentHistory:f=[]}){const m=Ks(),p=typeof ba=="function"?ba()??[]:[],h=Array.isArray(p)?p.map(String):[],v=m.length?m.map(L=>L?.technicianId).filter(Boolean).map(String):h,P=m.length||v.length,S=Number.isFinite(u)?Number(u):null,A=Xn({items:e,technicianIds:v,crewAssignments:m,discount:t,discountType:n,applyTax:a,start:r,end:d,companySharePercent:S}),T=He({totalAmount:A.finalTotal,progressType:s,progressValue:l,history:f}),E=st({manualStatus:i,paidAmount:T.paidAmount,paidPercent:T.paidPercent,totalAmount:A.finalTotal}),I=vi({total:A.finalTotal,itemsCount:e.length,rentalDays:A.rentalDays,techniciansCount:P,applyTax:a,paymentStatus:E,paidAmount:T.paidAmount,paidPercent:T.paidPercent,companySharePercent:A.companySharePercent,companyShareAmount:A.companyShareAmount,taxAmount:A.taxAmount,netProfit:A.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:A.equipmentTotal,crewTotal:A.crewTotal}),B={html:I,paymentStatus:E,paidAmount:T.paidAmount,paidPercent:T.paidPercent,paymentProgressType:T.paymentProgressType,paymentProgressValue:T.paymentProgressValue,total:A.finalTotal};return rr.lastResult=B,I}function or(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Ta(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Ta(n,e))}function Ta(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const wn="project",xn="editProject",Ia=3600*1e3,Zt=.15,gn=6,Zn="projectsTab",ea="projectsSubTab",Na={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab"},Si={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},cr={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function ji(){const e=()=>{Zi(),es(),Yn()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(e,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(e);return}}e()}let Ea=!1,_a=null;function lr(e){if(!e||typeof e!="object")return"";const t=Object.entries(e).filter(([n,a])=>a!=null).map(([n,a])=>[n,String(a)]);return t.length===0?"":JSON.stringify(t.sort(([n],[a])=>n.localeCompare(a)))}async function dr(e={}){const{suppressError:t=!0,params:n=null,force:a=!1}=e??{},i=lr(n);if(!a&&Ea&&oe().length>0&&i===_a)return oe();try{const s=await kn(n||{});return Ea=!0,_a=i,s}catch(s){if(console.error("❌ [reservationsActions] Failed to load reservations from API",s),!t)throw s;return oe()}}async function ac(e,{onAfterChange:t}={}){if(!It())return Bn(),!1;const a=oe()[e];if(!a)return j(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const i=a.id||a.reservationId;if(!i)return j(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;try{return await as(i),ji(),t?.({type:"deleted",reservation:a}),j(c("reservations.toast.deleted","🗑️ تم حذف الحجز")),!0}catch(s){console.error("❌ [reservationsActions] deleteReservation failed",s);const l=Ua(s)?s.message:c("reservations.toast.deleteFailed","تعذر حذف الحجز، حاول مرة أخرى");return j(l,"error"),!1}}async function ic(e,{onAfterChange:t}={}){const a=oe()[e];if(!a)return j(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const i=a.id||a.reservationId;if(!i)return j(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const{projectLinked:s}=yi(a);if(s)return j(c("reservations.toast.confirmBlockedByProject","⚠️ حالة هذا الحجز تتحكم بها حالة المشروع المرتبط ولا يمكن تأكيده من هنا"),"info"),!1;try{const l=await is(i);return ji(),t?.({type:"confirmed",reservation:l}),j(c("reservations.toast.confirmed","✅ تم تأكيد الحجز")),!0}catch(l){console.error("❌ [reservationsActions] confirmReservation failed",l);const r=Ua(l)?l.message:c("reservations.toast.confirmFailed","تعذر تأكيد الحجز، حاول مرة أخرى");return j(r,"error"),!1}}const ur=X()||{};let je=(ur.projects||[]).map(Ti),wt=!1;function ct(){return je}function xt(e){je=Array.isArray(e)?e.map(na):[],Ma({projects:je});try{const t=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(t),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(t)}catch(t){console.warn("⚠️ [projectsService] Failed to dispatch projects:changed event",t)}return je}async function en(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,d])=>{d==null||d===""||t.set(r,String(d))});const n=t.toString(),i=(await he(`/projects/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const l=s.map(nn);return xt(l),wt=!0,je}async function pr({force:e=!1,params:t=null}={}){if(!e&&wt&&je.length>0)return je;try{return await en(t||{})}catch(n){return console.error("❌ [projectsService] Failed to load projects from API",n),je}}async function Pi(e){const t=await he("/projects/",{method:"POST",body:e}),n=nn(t?.data??{}),a=[...je,n];return xt(a),wt=!0,n}async function tn(e,t){const n=await he(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=nn(n?.data??{}),i=je.map(s=>String(s.id)===String(e)?a:s);return xt(i),wt=!0,a}async function Ai(e){await he(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=je.filter(n=>String(n.id)!==String(e));xt(t),wt=!0}function ta({projectCode:e,title:t,type:n,clientId:a,clientCompany:i,description:s,start:l,end:r,applyTax:d,paymentStatus:u,equipmentEstimate:f=0,expenses:m=[],taxAmount:p=0,totalWithTax:h=0,discount:v=0,discountType:P="percent",companyShareEnabled:S=!1,companySharePercent:A=null,companyShareAmount:T=0,paidAmount:E=null,paidPercentage:I=null,paymentProgressType:B=null,paymentProgressValue:L=null,confirmed:D=!1,technicians:q=[],equipment:M=[],payments:H,paymentHistory:ee}={}){const V=Array.isArray(q)?q.map(N=>Number.parseInt(String(N),10)).filter(N=>Number.isInteger(N)&&N>0):[],W=Array.isArray(M)?M.map(N=>{const w=Number.parseInt(String(N.equipmentId??N.equipment_id??N.id??0),10),R=Number.parseInt(String(N.qty??N.quantity??0),10);return!Number.isInteger(w)||w<=0?null:{equipment_id:w,quantity:Number.isInteger(R)&&R>0?R:1}}).filter(Boolean):[],x=Array.isArray(m)?m.map(N=>{const w=Number.parseFloat(N?.amount??N?.value??0)||0,R=(N?.label??N?.name??"").trim();return R?{label:R,amount:Math.round(w*100)/100}:null}).filter(Boolean):[],$=x.reduce((N,w)=>N+(w?.amount??0),0),F={title:t,type:n,client_id:a?Number.parseInt(String(a),10):null,client_company:i??null,description:s??null,start_datetime:l??null,end_datetime:r||null,apply_tax:!!d,payment_status:u??"unpaid",equipment_estimate:Number.parseFloat(f)||0,expenses_total:Math.round($*100)/100,tax_amount:Math.round((Number.parseFloat(p)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(h)||0)*100)/100,confirmed:!!D,technicians:V,equipment:W,expenses:x},U=Math.max(0,Number.parseFloat(v)||0);F.discount=U,F.discount_type=P==="amount"?"amount":"percent";const J=Number.parseFloat(A),C=!!S&&Number.isFinite(J)&&J>0;F.company_share_enabled=C,F.company_share_percent=C?J:0,F.company_share_amount=C?Math.max(0,Number.parseFloat(T)||0):0,Number.isFinite(Number(E))&&(F.paid_amount=Math.max(0,Number.parseFloat(E)||0)),Number.isFinite(Number(I))&&(F.paid_percentage=Math.max(0,Number.parseFloat(I)||0)),(B==="amount"||B==="percent")&&(F.payment_progress_type=B),L!=null&&L!==""&&(F.payment_progress_value=Number.parseFloat(L)||0),e&&(F.project_code=String(e).trim());const _=H!==void 0?H:ee;if(_!==void 0){const N=Ii(_)||[];F.payments=N.map(w=>({type:w.type,amount:w.amount!=null?w.amount:null,percentage:w.percentage!=null?w.percentage:null,value:w.value!=null?w.value:null,note:w.note??null,recorded_at:w.recordedAt??null}))}return F.end_datetime||delete F.end_datetime,F.client_company||(F.client_company=null),F}function nn(e={}){return na(e)}function Ti(e={}){return na(e)}function na(e={}){const t=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],a=n.map(h=>{if(h==null)return null;if(typeof h=="object"){const v=h.id??h.technician_id??h.technicianId;return v!=null?String(v):null}return String(h)}).filter(Boolean),s=(Array.isArray(e.equipment)?e.equipment:[]).map(h=>{const v=h?.equipment_id??h?.equipmentId??h?.id??null,P=h?.quantity??h?.qty??0,S=h?.barcode??h?.code??"",A=h?.description??h?.name??"";return{equipmentId:v!=null?String(v):null,qty:Number.parseInt(String(P),10)||0,barcode:S,description:A}}),r=(Array.isArray(e.expenses)?e.expenses:[]).map((h,v)=>({id:h?.id??`expense-${t??"x"}-${v}`,label:h?.label??"",amount:Number.parseFloat(h?.amount??0)||0})),d=Number.parseFloat(e.company_share_percent??e.companySharePercent??0)||0,u=e.company_share_enabled??e.companyShareEnabled,f=u!=null?u===!0||u===1||String(u).toLowerCase()==="true":d>0,m=e.payment_history??e.paymentHistory??e.payments??null,p=Ii(m);return{id:t!=null?String(t):"",projectId:t!=null?Number(t):null,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,discount:Number.parseFloat(e.discount??e.discount_value??0)||0,discountType:e.discount_type??e.discountType??"percent",companyShareEnabled:f,companySharePercent:f?d:0,companyShareAmount:Number.parseFloat(e.company_share_amount??e.companyShareAmount??0)||0,paidAmount:Number.parseFloat(e.paid_amount??e.paidAmount??0)||0,paidPercent:Number.parseFloat(e.paid_percentage??e.paidPercent??0)||0,paymentProgressType:e.payment_progress_type??e.paymentProgressType??null,paymentProgressValue:e.payment_progress_value??e.paymentProgressValue??null,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:n.map(h=>typeof h=="object"?h:{id:h}),equipment:s,expenses:r,paymentHistory:p}}function Ct(e){return e instanceof Rt}function vn(e){if(e==null||e==="")return null;const t=g(String(e)).replace(/[^\d.,-]/g,"").trim();if(!t)return null;let n=t;const a=n.includes(","),i=n.includes(".");a&&(n=i?n.replace(/,/g,""):n.replace(/,/g,"."));const s=Number.parseFloat(n);return Number.isFinite(s)?s:null}function mr(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??e.kind??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n==="percentage"&&(n="percent");const a=vn(e.value);let i=vn(e.amount),s=vn(e.percentage);if(n==="amount"&&i==null&&a!=null?i=a:n==="percent"&&s==null&&a!=null&&(s=a),!n)if(i!=null&&i>=0)n="amount";else if(s!=null&&s>=0)n="percent";else if(a!=null&&a>=0)n="amount",i=a;else return null;if(n==="amount"){if(i==null||!Number.isFinite(i)||i<0)return null;i=Math.round(i*100)/100}if(n==="percent"){if(s==null||!Number.isFinite(s)||s<0)return null;s=Math.min(100,Math.round(s*100)/100)}const l=e.note??e.memo??e.description??null,r=l!=null?String(l).trim():null,d=e.recordedAt??e.recorded_at??e.date??null;let u=null;if(d){const m=new Date(d);Number.isNaN(m.getTime())||(u=m.toISOString())}u||(u=new Date().toISOString());const f=n==="amount"?i:n==="percent"?s:a;return{type:n,amount:i??null,percentage:s??null,value:f!=null?Math.round(f*100)/100:null,note:r&&r.length?r.slice(0,500):null,recordedAt:u}}function Ii(e){if(e!==void 0)return e===null?[]:Array.isArray(e)?e.map(t=>mr(t)).filter(Boolean):[]}const sc=Object.freeze(Object.defineProperty({__proto__:null,buildProjectPayload:ta,createProjectApi:Pi,deleteProjectApi:Ai,ensureProjectsLoaded:pr,getProjectsState:ct,isApiError:Ct,mapLegacyProject:Ti,mapProjectFromApi:nn,refreshProjectsFromApi:en,setProjectsState:xt,updateProjectApi:tn},Symbol.toStringTag,{value:"Module"})),b={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null},o={};function fr(){b.selectedTechnicians=[],b.selectedEquipment=[],b.expenses=[]}function y(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function G(e){const t=Number(e)||0,a=re()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${g(i)} SR`}function Ne(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getFullYear()),s=String(t.getMinutes()).padStart(2,"0"),l=t.getHours(),r=l>=12?"PM":"AM",d=l%12||12,u=String(d).padStart(2,"0"),f=`${n}/${a}/${i} ${u}:${s} ${r}`;return g(f)}function yr(e){const t=re(),n=g(String(e));return t==="en"?`${n} ${e===1?"project":"projects"}`:`${n} مشروع`}function wa(e){o.tableCount&&(o.tableCount.dataset.count=String(e),o.tableCount.textContent=yr(e))}function hr(e){if(!e)return"";const t=e.dataset.emptyKey,n=e.dataset.empty||"";return t?c(t,n):n}function br(){if(!Array.isArray(b.projects)||b.projects.length===0)return;let e=!1;const t=b.projects.map(n=>{if(n.projectCode)return n;const a=Ha();return e=!0,{...n,projectCode:a}});e&&(b.projects=t)}function gr(){const{customers:e,technicians:t,equipment:n}=X();b.customers=Array.isArray(e)?e:[],b.technicians=Array.isArray(t)?t:[],b.equipment=Array.isArray(n)?n:[],b.reservations=oe(),b.projects=ct(),br()}function an(){if(Ni(),o.technicianSelect){const e=o.technicianSelect.value,t=y(c("projects.form.selectTechnician","اختر عضو الطاقم"));o.technicianSelect.innerHTML=`<option value="">${t}</option>`+b.technicians.map(n=>{const a=c("projects.fallback.technicianName","عضو {id}"),i=n.name||a.replace("{id}",g(String(n.id||"")));return`<option value="${n.id}">${y(i)}</option>`}).join(""),e&&(o.technicianSelect.value=e)}if(o.equipmentSelect){const e=o.equipmentSelect.value,t=y(c("projects.form.selectEquipment","اختر المعدة"));o.equipmentSelect.innerHTML=`<option value="">${t}</option>`+b.equipment.map(n=>{const a=n.desc||n.description||n.name||c("projects.fallback.unknownEquipment","معدة");return`<option value="${y(n.barcode||"")}">${y(a)}</option>`}).join(""),e&&(o.equipmentSelect.value=e)}}function Oe(e){if(!o.clientCompany)return;const t=e?.companyName||e?.company||"";o.clientCompany.value=t}function Ni(){if(!o.client)return;vr();const e=o.client.dataset?.customerId;if(e){const t=b.customers.find(n=>String(n.id)===String(e));t?Oe(t):(o.client.dataset.customerId="",Oe(null))}else Oe(null);document.activeElement===o.client&&Cn()}function vr(){!o.client||!o.clientSuggestions||o.client.dataset.autocompleteAttached!=="true"&&(o.client.addEventListener("input",()=>{o.client.dataset.customerId="",Cn(),Oe(null)}),o.client.addEventListener("focus",()=>{Cn()}),o.client.addEventListener("blur",()=>{window.setTimeout(()=>Pt(),150)}),o.client.dataset.autocompleteAttached="true")}function Pt(){o.clientSuggestions&&(o.clientSuggestions.classList.remove("is-visible"),o.clientSuggestions.hidden=!0,o.clientSuggestions.innerHTML="")}function Cn(){if(!o.client||!o.clientSuggestions)return;if(!Array.isArray(b.customers)||b.customers.length===0){const a=X();Array.isArray(a?.customers)&&a.customers.length&&(b.customers=a.customers)}const e=Sr(),t=Fe(o.client.value||""),n=t?e.filter(a=>{const i=Fe(a.name).includes(t),s=Fe(a.company||"").includes(t);return i||s}).slice(0,10):e.slice(0,10);if(!n.length){Pt();return}o.clientSuggestions.innerHTML=n.map(a=>{const i=a.company?`<div class="suggestion-item__meta">${y(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${y(String(a.id))}" data-name="${y(a.name)}" data-company="${y(a.company||"")}">
          <div class="suggestion-item__primary">${y(a.name)}</div>
          ${i}
        </div>
      `}).join(""),o.clientSuggestions.hidden=!1,o.clientSuggestions.classList.add("is-visible"),o.clientSuggestions.scrollTop=0,o.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",i=>{i.preventDefault();const{id:s,name:l}=i.currentTarget.dataset;o.client&&(o.client.value=l||"",o.client.dataset.customerId=s||"");const r=i.currentTarget.dataset.company||"";Oe({companyName:r}),Pt()})})}function Sr(){return Array.isArray(b.customers)?b.customers.map(e=>{const t=(e.customerName||e.name||"").trim();return t?{id:e.id,name:t,company:(e.companyName||e.company||"").trim()}:null}).filter(Boolean):[]}function jr(e,t=""){if(!Array.isArray(b.customers)||b.customers.length===0)return null;if(t){const i=b.customers.find(s=>String(s.id)===String(t));if(i)return i}const n=Fe(e||"");if(!n)return null;const a=b.customers.find(i=>Fe(i.customerName||i.name||"")===n);return a||b.customers.find(i=>Fe(i.customerName||i.name||"").includes(n))||null}function Pr(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function Ar(){o.form=document.getElementById("project-form"),o.title=document.getElementById("project-title"),o.type=document.getElementById("project-type"),o.client=document.getElementById("project-client"),o.clientSuggestions=document.getElementById("project-customer-suggestions"),o.clientCompany=document.getElementById("project-client-company"),o.paymentStatus=document.getElementById("project-payment-status"),o.startDate=document.getElementById("project-start-date"),o.startTime=document.getElementById("project-start-time"),o.endDate=document.getElementById("project-end-date"),o.endTime=document.getElementById("project-end-time"),o.description=document.getElementById("project-description"),o.technicianSelect=document.getElementById("project-technician-select"),o.addTechnicianBtn=document.getElementById("add-technician-btn"),o.technicianList=document.getElementById("project-technician-list"),o.equipmentSelect=document.getElementById("project-equipment-select"),o.equipmentQty=document.getElementById("project-equipment-qty"),o.addEquipmentBtn=document.getElementById("add-equipment-btn"),o.equipmentList=document.getElementById("project-equipment-list"),o.expenseLabel=document.getElementById("project-expense-label"),o.expenseAmount=document.getElementById("project-expense-amount"),o.addExpenseBtn=document.getElementById("add-expense-btn"),o.expenseList=document.getElementById("project-expense-list"),o.discountType=document.getElementById("project-discount-type"),o.discountValue=document.getElementById("project-discount"),o.companyShare=document.getElementById("project-company-share"),o.paymentProgressType=document.getElementById("project-payment-progress-type"),o.paymentProgressValue=document.getElementById("project-payment-progress-value"),o.taxCheckbox=document.getElementById("project-tax"),o.linkedReservationBtn=document.getElementById("project-linked-reservation-btn"),o.submitBtn=o.form?.querySelector('[type="submit"]'),o.projectsTableBody=document.getElementById("project-table-body"),o.projectsCount=document.getElementById("projects-count"),o.projectsUpcoming=document.getElementById("projects-upcoming"),o.projectsExpenses=document.getElementById("projects-expenses"),o.projectsBudget=document.getElementById("projects-budget"),o.tableCount=document.getElementById("project-table-count"),o.search=document.getElementById("project-search"),o.detailsModalEl=document.getElementById("projectDetailsModal"),o.detailsBody=document.getElementById("project-details-body"),o.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),o.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),o.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),o.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),o.timeline=document.getElementById("project-timeline"),o.focusCards=document.getElementById("project-focus-cards"),o.detailsModalEl&&!o.detailsModalEl.dataset.projectListenerAttached&&(o.detailsModalEl.addEventListener("hidden.bs.modal",()=>{o.detailsBody&&(o.detailsBody.dataset.projectId="")}),o.detailsModalEl.dataset.projectListenerAttached="true")}function Tr(){const e=Pr();if(!e)return;const t=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,minuteIncrement:5,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"}]];[...t,...n].forEach(([a,i])=>{document.querySelector(a)&&e(a,i)})}function Ei(){["startDate","startTime","endDate","endTime"].forEach(e=>{const t=o[e];t&&(t._flatpickr?t._flatpickr.clear():t.value="")})}function Ir(){const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>Va()),e.dataset.listenerAttached="true")}function Be(e){if(!e?.start)return Number.NaN;const t=new Date(e.start).getTime();return Number.isFinite(t)?t:Number.NaN}function xa(e){if(e?.createdAt){const n=new Date(e.createdAt).getTime();if(Number.isFinite(n))return n}const t=Be(e);return Number.isFinite(t)?t:Number.NEGATIVE_INFINITY}function Ca(e,t){if(!e)return"";const n=t&&/\d{1,2}:\d{2}/.test(t)?t:"00:00",[a="00",i="00"]=n.split(":"),s=a.padStart(2,"0"),l=i.padStart(2,"0");return`${e}T${s}:${l}`}function _i(e,t){const n=String(e||"");return n.length<=t?n:`${n.slice(0,Math.max(0,t-1))}…`}function $a(e){if(!e||typeof e!="string")return{date:"",time:""};let t=e.trim();if(!t)return{date:"",time:""};if(t.includes(" ")&&(t=t.replace(" ","T")),!t.includes("T"))return{date:t,time:""};const[n,a=""]=t.split("T");return{date:n,time:a}}function sn(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function be(){if(!o.projectsTableBody)return;const e=b.filters.search,t=b.projects.filter(a=>{if(!e)return!0;const i=b.customers.find(l=>String(l.id)===String(a.clientId));return g([a.title,a.description,i?.customerName,a.clientCompany,sn(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(e)});if(!t.length){const a=b.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",i=b.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",s=y(c(a,i));o.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${s}</td></tr>`,wa(0),b.visibleProjects=[],La([]);return}const n=[...t].sort((a,i)=>new Date(i.start||0)-new Date(a.start||0));b.visibleProjects=n,wa(n.length),o.projectsTableBody.innerHTML=n.map(a=>Nr(a)).join(""),La(n),$e()}function Nr(e){const t=b.customers.find(E=>String(E.id)===String(e.clientId)),n=t?.customerName||c("projects.fallback.unknownClient","عميل غير معروف"),a=(e.clientCompany||t?.companyName||"").trim(),i=e.technicians?.length||0,s=(e.equipment||[]).reduce((E,I)=>E+(I.qty||0),0),{expensesTotal:l,totalWithTax:r}=At(e),u=rn(e.id).length,m=c("projects.table.reservationsCount","{count} حجوزات").replace("{count}",g(String(u))),p=u?`<span class="badge rounded-pill project-reservations-chip">${y(m)}</span>`:"",v=`<span class="badge project-type-badge">${y(sn(e.type))}</span>`,P=e.projectCode||`PRJ-${g(String(e.id))}`,S=`<span class="project-code-badge">#${y(P)}</span>`,T=It()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${e.id}">${y(c("actions.delete","حذف"))}</button>`:"";return`
    <tr data-project-id="${e.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${y(e.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${S}
            ${v}
          </div>
        </div>
        ${p}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${y(n)}</span><small class="text-muted">${y(a)}</small></div>`:y(n)}
      </td>
      <td>${aa(e.start,e.end)}</td>
      <td>${g(String(i))}</td>
      <td>${g(String(s))}</td>
      <td>${G(r)}</td>
      <td>${G(l)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${e.id}">${y(c("actions.view","عرض"))}</button>
        ${T}
      </td>
    </tr>
  `}function aa(e,t){if(!e)return"—";const n=Ne(e);return t?`${n} - ${Ne(t)}`:n}function La(e){if(!o.timeline)return;const n=(Array.isArray(e)?e:b.visibleProjects.length?b.visibleProjects:b.projects).map(m=>{if(!m?.start)return null;const p=new Date(m.start);if(Number.isNaN(p.getTime()))return null;let h=m.end?new Date(m.end):new Date(p);return Number.isNaN(h.getTime())&&(h=new Date(p)),h<=p&&(h=new Date(p.getTime()+Ia)),{project:m,startDate:p,endDate:h}}).filter(Boolean).sort((m,p)=>m.startDate-p.startDate);if(!n.length){const m=y(c("projects.timeline.empty",o.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));o.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${m}</div>`;return}const a=n[0].startDate.getTime(),i=Math.max(...n.map(m=>m.endDate.getTime()));let s=i-a;s<=0&&(s=Ia);const l=Er(n),r=c("projects.timeline.range","{start} → {end}"),d=c("projects.timeline.conflict","Scheduling conflict"),u=n.map(m=>{const{project:p,startDate:h,endDate:v}=m,P=v.getTime()-h.getTime();let S=(h.getTime()-a)/s*100;S=Math.max(0,Math.min(S,100));let A=P/s*100;A=Math.max(A,2.5),S+A>100&&(A=Math.max(1.5,100-S));const E=`project-timeline__item--${ia(p)}`,I=l.has(p.id),B=(p.title||"").trim()||c("projects.fallback.untitled","Untitled project"),L=_i(B,26),D=b.customers.find(U=>String(U.id)===String(p.clientId)),q=D?.customerName||c("projects.fallback.unknownClient","Unknown client"),M=(p.clientCompany||D?.companyName||"").trim(),H=sn(p.type),ee=Ne(h.toISOString()),V=Ne(v.toISOString()),W=r.replace("{start}",ee).replace("{end}",V),x=M?`${q} (${M})`:q,$=`${B} • ${H} • ${x} | ${W}`,F=I?`<span class="project-timeline__item-conflict" title="${y(d)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${E}${I?" project-timeline__item--conflict":""}" style="left:${S}%;width:${A}%;" title="${y($)}">
          <span class="project-timeline__item-label">${y(L)}</span>
          ${F}
        </div>
      `}).join(""),f=`
    <div class="project-timeline__scale">
      <span>${y(Ne(new Date(a).toISOString()))}</span>
      <span>${y(Ne(new Date(i).toISOString()))}</span>
    </div>
  `;o.timeline.innerHTML=`
    ${f}
    <div class="project-timeline__track">
      ${u}
    </div>
  `}function Er(e){const t=new Set;for(let n=0;n<e.length;n+=1)for(let a=n+1;a<e.length;a+=1){const i=e[n],s=e[a];i.startDate<s.endDate&&s.startDate<i.endDate&&(t.add(i.project.id),t.add(s.project.id))}return t}function $e(){if(!o.focusCards)return;const e=_r();if(!e.length){const t=y(c("projects.focus.empty",o.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));o.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${t}</div></div>`;return}o.focusCards.innerHTML=e.join("")}function _r(){if(!Array.isArray(b.projects)||!b.projects.length)return[];const e=b.projects.filter(Ba),t=b.projects.filter(s=>!Ba(s)&&xr(s)),n=[],a=new Set,i=(s,l)=>{!s||a.has(s.id)||n.length>=gn||(a.add(s.id),n.push(wr(s,l)))};if(e.sort((s,l)=>Be(s)-Be(l)).forEach(s=>i(s,"today")),t.sort((s,l)=>Be(s)-Be(l)).forEach(s=>i(s,"thisWeek")),n.length<gn){const s=Date.now();[...b.projects].filter(r=>!a.has(r.id)).filter(r=>{const d=Be(r);return Number.isFinite(d)&&d>=s}).sort((r,d)=>Be(r)-Be(d)).forEach(r=>i(r,"upcoming"))}return n.length<gn&&[...b.projects].filter(l=>!a.has(l.id)).sort((l,r)=>xa(r)-xa(l)).forEach(l=>i(l,"recent")),n}function wr(e,t){const n=b.customers.find(Q=>String(Q.id)===String(e.clientId)),a=n?.customerName||c("projects.fallback.unknownClient","عميل غير معروف"),i=(e.clientCompany||n?.companyName||"").trim(),s=Array.isArray(e.technicians)?e.technicians.length:0,l=rn(e.id),r=l.length,d=wi(e),{subtotal:u,applyTax:f}=At(e),m=(e.description||"").trim(),p=m?_i(m,110):c("projects.fallback.noDescription","لا يوجد وصف"),h=sn(e.type),v=typeof e.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",P=["paid","partial"].includes(v)?v:"unpaid",S=c(`projects.paymentStatus.${P}`,P==="paid"?"Paid":P==="partial"?"Partially Paid":"Unpaid"),A=P==="paid"?"status-paid":P==="partial"?"status-partial":"status-unpaid",T=P==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",E=e.confirmed===!0||e.confirmed==="true",I=y(String(e.id)),B=e.projectCode||`PRJ-${g(String(e.id))}`,L=g(B),D={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},q={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},M=D[t]||D.recent,H=c(M,q[t]||q.recent),ee=ia(e),V=c(`projects.status.${ee}`,Si[ee]||ee),W=cr[ee]||"bg-secondary",x=(e.title||"").trim()||c("projects.fallback.untitled","Untitled project"),$=[T];E&&$.push("project-focus-card--confirmed");const F=l.reduce((Q,ne)=>{const me=sa(ne),Ke=(ne.items||[]).reduce((dt,ut)=>dt+(Number(ut?.qty)||1),0),lt=(ne.technicians||[]).length;return{total:Q.total+me,equipment:Q.equipment+Ke,crew:Q.crew+lt}},{total:0,equipment:0,crew:0}),U=Number(F.total.toFixed(2)),J=F.equipment,C=F.crew||s,_=f?Number(((u+U)*Zt).toFixed(2)):0,N=Number((u+U+_).toFixed(2)),w=`<span class="project-code-badge project-focus-card__code">#${y(L)}</span>`,R=h?`<span class="badge project-focus-card__badge bg-primary">${y(h)}</span>`:"",K=H?`<span class="project-focus-card__meta-tag">${y(H)}</span>`:"",k=`<span class="project-focus-card__status-chip ${W}">${y(V)}</span>`,Y=`<span class="reservation-chip ${A} project-focus-card__payment-chip">${y(S)}</span>`,z=(Q,ne,me)=>`
    <div class="project-focus-card__row">
      <span class="project-focus-card__row-label">
        ${Q?`<span class="project-focus-card__row-icon">${y(Q)}</span>`:""}
        ${y(ne)}
      </span>
      <span class="project-focus-card__row-value">${y(String(me))}</span>
    </div>
  `,de=[{icon:"👤",label:c("projects.details.client","العميل"),value:a},i?{icon:"🏢",label:c("projects.details.company","شركة العميل"),value:i}:null,{icon:"🏷️",label:c("projects.details.type","نوع المشروع"),value:h},{icon:"📅",label:c("projects.focus.summary.range","الفترة الزمنية"),value:aa(e.start,e.end)}].filter(Boolean).map(({icon:Q,label:ne,value:me})=>z(Q,ne,me)).join(""),O=[{icon:"💳",label:c("projectCards.stats.paymentStatus","حالة الدفع"),value:S},{icon:"💸",label:c("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:G(d)},{icon:"🧮",label:c("projectCards.stats.totalWithTax","الإجمالي مع الضريبة"),value:G(N)}].map(({icon:Q,label:ne,value:me})=>z(Q,ne,me)).join(""),te=[{icon:"🔗",label:c("projectCards.stats.reservationsShort","الحجوزات"),value:g(String(r))},{icon:"📦",label:c("projectCards.stats.equipmentCount","عدد المعدات"),value:g(String(J))},{icon:"😎",label:c("projectCards.stats.crewCount","عدد الطاقم"),value:g(String(C))},{icon:"💵",label:c("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:G(U)}].map(({icon:Q,label:ne,value:me})=>z(Q,ne,me)).join(""),qe=E?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${y(c("projects.focus.confirmed","✅ مشروع مؤكد"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${I}">${y(c("projects.focus.actions.confirm","✔️ تأكيد المشروع"))}</button>`;return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${$.filter(Boolean).join(" ")}" data-project-id="${I}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${w}
          ${R}
          ${K}
          ${k}
          ${Y}
        </div>
        <h6 class="project-focus-card__title">${y(x)}</h6>
        <p class="project-focus-card__description">${y(p)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${y(c("projects.focus.summary.project","ملخص المشروع"))}</span>
            <div class="project-focus-card__section-box">
              ${de}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${y(c("projects.focus.summary.payment","الجانب المالي"))}</span>
            <div class="project-focus-card__section-box">
              ${O}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${y(c("projects.focus.summary.reservations","الحجوزات المرتبطة"))}</span>
            <div class="project-focus-card__section-box">
              ${te}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${qe}
        </div>
      </article>
    </div>
  `}function Ba(e){if(!e?.start)return!1;const t=new Date(e.start);if(Number.isNaN(t.getTime()))return!1;const n=new Date;return t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()}function xr(e){if(!e?.start)return!1;const t=new Date(e.start);if(Number.isNaN(t.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const i=a.getDay(),s=i===0?6:i-1;a.setDate(a.getDate()-s);const l=new Date(a);return l.setDate(l.getDate()+7),t>=a&&t<l}function ia(e){const t=new Date,n=e.start?new Date(e.start):null,a=e.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function wi(e){return typeof e.expensesTotal=="number"?e.expensesTotal:Array.isArray(e.expenses)?e.expenses.reduce((t,n)=>t+(Number(n.amount)||0),0):0}function At(e){const t=Number(e?.equipmentEstimate)||0,n=wi(e),a=t+n,i=e?.applyTax===!0||e?.applyTax==="true",s=Number.parseFloat(e?.discount??e?.discountValue??0)||0;let r=(e?.discountType==="amount"?"amount":"percent")==="amount"?s:a*(s/100);(!Number.isFinite(r)||r<0)&&(r=0),r>a&&(r=a);const d=Math.max(0,a-r),u=e?.companyShareEnabled===!0||e?.companyShareEnabled==="true"||e?.company_share_enabled===!0||e?.company_share_enabled==="true",f=Number.parseFloat(e?.companySharePercent??e?.company_share_percent??e?.companyShare??e?.company_share??0)||0,m=u&&i&&f>0?f:0,p=m>0?Number((d*(m/100)).toFixed(2)):0,h=d+p;let v=i?h*Zt:0;(!Number.isFinite(v)||v<0)&&(v=0),v=Number(v.toFixed(2));let P=i?Number(e?.totalWithTax):h;return i?(!Number.isFinite(P)||P<=0)&&(P=Number((h+v).toFixed(2))):P=h,{equipmentEstimate:t,expensesTotal:n,baseSubtotal:a,discountAmount:r,subtotalAfterDiscount:d,companyShareAmount:p,subtotal:h,applyTax:i,taxAmount:v,totalWithTax:P}}function Le(){const e=b.projects.length,t=b.projects.filter(i=>{const s=i.start?new Date(i.start):null;return!s||Number.isNaN(s.getTime())?!1:s>new Date}).length,n=b.projects.reduce((i,s)=>i+At(s).expensesTotal,0),a=b.projects.reduce((i,s)=>i+At(s).totalWithTax,0);o.projectsCount&&(o.projectsCount.textContent=g(String(e))),o.projectsUpcoming&&(o.projectsUpcoming.textContent=g(String(t))),o.projectsExpenses&&(o.projectsExpenses.textContent=G(n)),o.projectsBudget&&(o.projectsBudget.textContent=G(a))}function rn(e){return e?b.reservations.filter(t=>String(t.projectId)===String(e)):[]}function sa(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(g(String(n)))||0,i=e.discountType||"percent",s=Array.isArray(e.crewAssignments)?e.crewAssignments:[],l=s.length?s:Array.isArray(e.technicians)?e.technicians:[],r=gi(t,a,i,!1,l,{start:e.start,end:e.end});if(Number.isFinite(r))return r;const d=Number(g(String(e.cost??0)));return Number.isFinite(d)?Math.round(d):0}function Cr(e,t,n=null){if(!e)return"";const a=e.reservationId||e.id||`RES-${t+1}`,i=e.status||e.state||"pending",s=c(`reservations.status.${i}`,i),l=String(i).toLowerCase(),d={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[l]||"project-reservation-card__badge--info",u=e.paid===!0||e.paid==="paid"||e.paidStatus==="paid",f=u?c("reservations.details.paid","مدفوع"):c("reservations.details.unpaid","غير مدفوع"),m=u?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",p=e.completed===!0||e.completed==="true",h=c("reservations.details.completed","مكتمل"),v=p?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${y(h)}</span>`:"",P=aa(e.start,e.end),S=sa(e),A=G(S),T=c("projects.details.reservations.items","{count} عناصر").replace("{count}",g(String((e.items||[]).length))),E=c("projects.details.reservations.crew","{count} من الطاقم").replace("{count}",g(String((e.technicians||[]).length)));return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${t}" data-reservation-index="${t}" data-project-id="${n?n.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${y(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${d}">${y(s)}</span>
          <span class="project-reservation-card__badge ${m}">${y(f)}</span>
          ${v}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${y(P)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${y(A)}</span>
          <span>📦 ${y(T)}</span>
          <span>😎 ${y(E)}</span>
        </div>
      </div>
    </article>
  `}function $r(e){const t=rn(e.id).map(s=>({reservation:s,index:b.reservations.findIndex(l=>l===s)})).filter(({index:s})=>Number.isInteger(s)&&s>=0).sort((s,l)=>{const r=s.reservation.start?new Date(s.reservation.start).getTime():0;return(l.reservation.start?new Date(l.reservation.start).getTime():0)-r}),n=c("projects.details.reservations.title","الحجوزات المرتبطة"),a=c("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=t.length?`<div class="project-reservations-list">${t.map(({reservation:s,index:l})=>Cr(s,l,e)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${y(a)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${y(n)}</h6>
      </div>
      ${i}
    </section>
  `}async function xi(e){if(b.projects.findIndex(n=>String(n.id)===String(e))!==-1&&window.confirm(c("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))try{await Ai(e),await en(),await kn(),b.projects=ct(),b.reservations=oe(),be(),Le(),$e(),document.dispatchEvent(new CustomEvent("projects:changed")),document.dispatchEvent(new CustomEvent("reservations:changed")),j(c("projects.toast.deleted","🗑️ تم حذف المشروع"))}catch(n){console.error("❌ [projects] removeProject failed",n);const a=Ct(n)?n.message:c("projects.toast.deleteFailed","تعذر حذف المشروع، حاول مرة أخرى");j(a,"error")}}async function Lr(e,t){if(!e)return!1;const a=oe().filter(d=>String(d.projectId)===String(e));if(!a.length)return!1;const i=typeof t=="string"?t.toLowerCase():"unpaid",s=i==="paid",l=s?"paid":i==="partial"?"partial":"unpaid";let r=!1;for(const d of a){const u=d.id??d.reservationId;if(!u)continue;const f=d.paid===!0||d.paid==="paid",m=d.paidStatus||d.paymentStatus||(f?"paid":"unpaid");f===s&&m===l||(await Dn(u,{paid_status:l,paid:s}),r=!0)}return r&&(b.reservations=oe()),r}async function Br(e){if(!e)return!1;const t=oe(),n=b.projects.find(s=>String(s.id)===String(e))||(X().projects||[]).find?.(s=>String(s.id)===String(e))||null,a=t.filter(s=>String(s.projectId)===String(e));if(!a.length)return!1;let i=!1;for(const s of a){const l=s.id??s.reservationId;if(!l)continue;const r=yi({...s,projectId:e},n);if(r.effectiveConfirmed)continue;const d=n?.status??r.projectStatus??"confirmed";await Dn(l,{confirmed:!0,status:d}),i=!0}return i&&(b.reservations=oe()),i}async function $n(e,t){if(!e)return!1;const n=await Lr(e,t);return n&&document.dispatchEvent(new CustomEvent("reservations:changed")),n}let Sn=!1;const on="projects:create:draft",Fr="projects.html#projects-section";let kt=!1;function Ci(e){return e?e instanceof HTMLElement?e:typeof e=="string"?document.getElementById(e):null:null}function kr(e=o.companyShare){const t=Ci(e);if(!t||t.checked!==!0)return null;const n=t.dataset.companyShare??t.value??ye,a=g(String(n).replace("%","").trim()),i=Number.parseFloat(a);return!Number.isFinite(i)||i<=0?ye:i}function gt(e=o.companyShare,t=ye){const n=Ci(e);if(!n)return;const a=n.dataset.companyShare??n.value??t,i=g(String(a).replace("%","").trim());let s=Number.parseFloat(i);(!Number.isFinite(s)||s<=0)&&(s=t),n.dataset.companyShare=String(s),n.checked=!0}function vt(e){const t=o.taxCheckbox,n=o.companyShare;if(!t||!n||kt)return;kt=!0;const a=()=>{j(c("projects.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"))};if(e==="share")if(n.checked){if(t.disabled){n.checked=!1,a(),kt=!1;return}t.checked||(t.checked=!0),gt(n)}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?gt(n):n.checked&&(n.checked=!1));kt=!1}function $i({equipmentEstimate:e=0,expensesTotal:t=0,discountValue:n=0,discountType:a="percent",applyTax:i=!1,companyShareEnabled:s=!1,companySharePercent:l=null}={}){const r=Number(e)+Number(t),d=Number.isFinite(Number(n))?Number(n):0;let u=0;a==="amount"?u=d:u=r*(d/100),(!Number.isFinite(u)||u<0)&&(u=0),u>r&&(u=r);const f=Math.max(0,r-u),m=s&&i&&Number.isFinite(Number(l))&&Number(l)>0?Number(l):0,p=m>0?Number((f*(m/100)).toFixed(2)):0,h=f+p;let v=i?h*Zt:0;(!Number.isFinite(v)||v<0)&&(v=0),v=Number(v.toFixed(2));const P=Number((h+v).toFixed(2));return{baseSubtotal:r,discountAmount:u,subtotalAfterDiscount:f,companyShareAmount:p,taxableAmount:h,taxAmount:v,totalWithTax:P}}function Dr(){o.form&&!o.form.dataset.listenerAttached&&(o.form.addEventListener("submit",Zr),o.form.dataset.listenerAttached="true"),o.form&&!o.form.dataset.resetListenerAttached&&(o.form.addEventListener("reset",()=>{o.client&&(o.client.dataset.customerId=""),Pt(),Ei(),o.type&&(o.type.value=""),Oe(null),qi(),Li()}),o.form.dataset.resetListenerAttached="true"),Mr(),o.search&&!o.search.dataset.listenerAttached&&(o.search.addEventListener("input",()=>{b.filters.search=g(o.search.value||"").trim().toLowerCase(),be()}),o.search.dataset.listenerAttached="true")}function Li(){fr(),b.editingProjectId=null,o.form&&(delete o.form.dataset.editingId,o.form.dataset.mode="create"),De(),o.expenseLabel&&(o.expenseLabel.value=""),o.expenseAmount&&(o.expenseAmount.value=""),o.taxCheckbox&&(o.taxCheckbox.checked=!1),o.discountType&&(o.discountType.value="percent"),o.discountValue&&(o.discountValue.value=""),o.companyShare&&(o.companyShare.checked=!1,o.companyShare.dataset.companyShare=String(ye)),o.paymentStatus&&(o.paymentStatus.value="unpaid"),o.paymentStatus?.dataset&&delete o.paymentStatus.dataset.userSelected,o.paymentProgressType&&(o.paymentProgressType.value="percent"),o.paymentProgressValue&&(o.paymentProgressValue.value=""),cn(),Tt(),vt("tax")}function qr(){o.addTechnicianBtn&&o.addTechnicianBtn.dataset.listenerAttached!=="true"&&(o.addTechnicianBtn.addEventListener("click",Wr),o.addTechnicianBtn.dataset.listenerAttached="true"),o.addEquipmentBtn&&o.addEquipmentBtn.dataset.listenerAttached!=="true"&&(o.addEquipmentBtn.addEventListener("click",Kr),o.addEquipmentBtn.dataset.listenerAttached="true")}function Rr(){jn(o.technicianList,e=>{if(e.matches('[data-action="remove-technician"]')){const t=e.dataset.id;b.selectedTechnicians=b.selectedTechnicians.filter(n=>n!==t),Bi()}}),jn(o.equipmentList,e=>{if(e.matches('[data-action="remove-equipment"]')){const t=e.dataset.id;b.selectedEquipment=b.selectedEquipment.filter(n=>n.barcode!==t),Fi()}}),jn(o.expenseList,e=>{if(e.matches('[data-action="remove-expense"]')){const t=e.dataset.id;b.expenses=b.expenses.filter(n=>String(n.id)!==String(t)),ki(),Le()}})}function Mr(){o.discountValue&&o.discountValue.dataset.listenerAttached!=="true"&&(o.discountValue.addEventListener("input",e=>{const t=e.target;t instanceof HTMLInputElement&&(t.value=g(t.value||""))}),o.discountValue.dataset.listenerAttached="true"),o.companyShare&&o.companyShare.dataset.listenerAttached!=="true"&&(o.companyShare.addEventListener("change",()=>{vt("share")}),o.companyShare.dataset.listenerAttached="true"),o.taxCheckbox&&o.taxCheckbox.dataset.projectListenerAttached!=="true"&&(o.taxCheckbox.addEventListener("change",()=>{vt("tax")}),o.taxCheckbox.dataset.projectListenerAttached="true"),o.paymentStatus&&o.paymentStatus.dataset.billingListenerAttached!=="true"&&(o.paymentStatus.addEventListener("change",()=>{o.paymentStatus.dataset.userSelected="true"}),o.paymentStatus.dataset.billingListenerAttached="true"),o.paymentProgressValue&&o.paymentProgressValue.dataset.listenerAttached!=="true"&&(o.paymentProgressValue.addEventListener("input",e=>{const t=e.target;t instanceof HTMLInputElement&&(t.value=g(t.value||""))}),o.paymentProgressValue.dataset.listenerAttached="true"),vt(o.companyShare?.checked?"share":"tax")}function Vr(){o.addExpenseBtn&&o.addExpenseBtn.dataset.listenerAttached!=="true"&&(o.addExpenseBtn.addEventListener("click",Yr),o.addExpenseBtn.dataset.listenerAttached="true"),o.expenseAmount&&o.expenseAmount.dataset.normalizeAttached!=="true"&&(o.expenseAmount.addEventListener("input",e=>{const t=e.target;if(!(t instanceof HTMLInputElement))return;const n=t.selectionStart,a=g(t.value||"");if(t.value=a,n!=null){const i=Math.min(a.length,n);t.setSelectionRange(i,i)}}),o.expenseAmount.dataset.normalizeAttached="true")}function jn(e,t){!e||e.dataset.listenerAttached==="true"||(e.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&t(a)}),e.dataset.listenerAttached="true")}function zr({onViewDetails:e}){!o.projectsTableBody||o.projectsTableBody.dataset.listenerAttached==="true"||(o.projectsTableBody.addEventListener("click",t=>{const n=t.target;if(n instanceof HTMLElement){if(n.matches('[data-action="view-details"]')){const a=n.dataset.id;e?.(a);return}if(n.matches('[data-action="delete-project"]')){if(!It()){Bn();return}const a=n.dataset.id;xi(a)}}}),o.projectsTableBody.dataset.listenerAttached="true")}function Hr(){const{customers:e}=X();b.customers=Array.isArray(e)?e:[],De(),be(),$e()}function Or(){const{technicians:e}=X();b.technicians=Array.isArray(e)?e:[],De(),be(),$e()}function Ur(e){const{reservations:t}=X();b.reservations=Array.isArray(t)?t:[],be();const n=o.detailsModalEl&&o.detailsModalEl.classList.contains("show"),a=o.detailsBody?.dataset.projectId;n&&a&&b.projects.find(s=>String(s.id)===String(a))&&e?.(a)}function Wr(){const e=o.technicianSelect?.value;if(!e){j(c("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(b.selectedTechnicians.includes(e)){j(c("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}b.selectedTechnicians.push(e),De(),j(c("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function Kr(){const e=o.equipmentSelect?.value;if(!e){j(c("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const t=Math.max(1,parseInt(o.equipmentQty?.value||"1",10)||1),n=b.selectedEquipment.find(a=>a.barcode===e);n?n.qty+=t:b.selectedEquipment.push({barcode:e,qty:t}),De(),j(c("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function Yr(){const e=(o.expenseLabel?.value||"").trim(),t=g(o.expenseAmount?.value||"0"),n=Number(t);if(!e){j(c("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){j(c("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}b.expenses.push({id:Date.now(),label:e,amount:n}),o.expenseLabel&&(o.expenseLabel.value=""),o.expenseAmount&&(o.expenseAmount.value=g(String(t))),De(),Le()}function De(){Bi(),Fi(),ki(),cn()}function Bi(){o.technicianList&&ra(o.technicianList,b.selectedTechnicians,e=>{const n=b.technicians.find(a=>String(a.id)===String(e))?.name||c("projects.fallback.technicianName","عضو بدون اسم");return`
      <span class="chip">
        ${y(n)}
        <button type="button" class="chip__remove" data-action="remove-technician" data-id="${y(String(e))}" aria-label="${y(c("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function Fi(){o.equipmentList&&ra(o.equipmentList,b.selectedEquipment,e=>{const t=b.equipment.find(i=>String(i.barcode||"")===String(e.barcode)),n=t?.desc||t?.description||t?.name||c("projects.fallback.unknownEquipment","معدة"),a=g(String(e.qty||1));return`
      <span class="chip">
        ${y(n)} (x${a})
        <button type="button" class="chip__remove" data-action="remove-equipment" data-id="${y(String(e.barcode))}" aria-label="${y(c("actions.remove","إزالة"))}">✖</button>
      </span>
    `})}function ki(){o.expenseList&&ra(o.expenseList,b.expenses,e=>`
      <div class="expense-item">
        <span>${y(e.label)}</span>
        <span>${G(e.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${y(String(e.id))}" aria-label="${y(c("actions.remove","إزالة"))}">✖</button>
      </div>
    `)}function ra(e,t,n){if(e){if(!t||t.length===0){const a=y(hr(e));e.innerHTML=`<span class="text-muted">${a}</span>`;return}e.innerHTML=t.map(a=>n(a)).join("")}}function cn(){if(!o.submitBtn)return;const e=!!b.editingProjectId,t=e?"projects.form.buttons.update":"projects.form.buttons.save",n=e?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";o.submitBtn.textContent=c(t,n)}function Gr(){return b.expenses.reduce((e,t)=>e+(Number(t.amount)||0),0)}function Fa(e){return g(String(e||"")).trim().toLowerCase()}function Jr(){if(!Array.isArray(b.selectedEquipment)||b.selectedEquipment.length===0)return{items:[],missing:[]};const e=new Map((b.equipment||[]).map(a=>[Fa(a?.barcode),a])),t=[],n=[];return b.selectedEquipment.forEach(a=>{const i=Fa(a?.barcode);if(!i){t.push(a?.barcode||"");return}const s=e.get(i);if(!s||s.id==null){t.push(a?.barcode||i);return}const l=Number.parseInt(String(a?.qty??0),10);n.push({equipmentId:s.id,qty:Number.isInteger(l)&&l>0?l:1})}),{items:n,missing:t}}function Qr(e){return!e||!Array.isArray(e.equipment)?[]:e.equipment.map(t=>{const n=t?.equipmentId??t?.equipment_id??t?.id??null,a=Number.parseInt(String(t?.qty??t?.quantity??0),10);return n?{equipmentId:n,qty:Number.isInteger(a)&&a>0?a:1}:null}).filter(Boolean)}function Xr(){return b.selectedEquipment.reduce((e,t)=>{const n=b.equipment.find(i=>String(i.barcode||"")===String(t.barcode)),a=Number(n?.price||n?.daily_rate||n?.dailyRate||0);return e+a*(t.qty||1)},0)}async function Zr(e){if(e.preventDefault(),Sn)return;const t=o.title?.value.trim(),n=o.type?.value||"",a=o.client?.value?.trim()||"",i=o.client?.dataset?.customerId||"",s=o.startDate?.value?.trim()||"",l=o.startTime?.value?.trim()||"";if(!t||!n||!s){j(c("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const r=jr(a,i);if(!r){j(c("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),o.client?.focus();return}const d=String(r.id);o.client&&(o.client.dataset.customerId=d,o.client.value=r.customerName||r.name||o.client.value),Oe(r);const u=o.endDate?.value?.trim()||"",f=o.endTime?.value?.trim()||"",m=Ht(s,l),p=u?Ht(u,f):"",h=new Date(m),v=p?new Date(p):null;if(v&&h>v){j(c("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}o.expenseAmount&&(o.expenseAmount.value=g(o.expenseAmount.value||""));const P=Gr(),S=Xr(),A=o.taxCheckbox?.checked===!0,T=o.discountType?.value==="amount"?"amount":"percent",E=g(o.discountValue?.value||"0");let I=Number.parseFloat(E);(!Number.isFinite(I)||I<0)&&(I=0);const B=o.companyShare,L=B?.checked===!0;let D=L?Number.parseFloat(g(String(B.dataset.companyShare??B.value??ye))):null;(!Number.isFinite(D)||D<=0)&&(D=L?ye:null);const q=$i({equipmentEstimate:S,expensesTotal:P,discountValue:I,discountType:T,applyTax:A,companyShareEnabled:L,companySharePercent:D}),M=o.paymentProgressType?.value==="amount"?"amount":"percent",H=g(o.paymentProgressValue?.value||""),ee=H?Number.parseFloat(H):null,V=He({totalAmount:q.totalWithTax,progressType:M,progressValue:ee,history:[]}),W=o.paymentStatus?.dataset?.userSelected==="true",x=(o.paymentStatus?.value||"unpaid").toLowerCase(),$=["paid","partial"].includes(x)?x:"unpaid",F=st({manualStatus:W?$:null,paidAmount:V.paidAmount,paidPercent:V.paidPercent,totalAmount:q.totalWithTax}),U=W?$:F;!W&&o.paymentStatus&&(o.paymentStatus.value=U),o.paymentStatus?.dataset&&delete o.paymentStatus.dataset.userSelected;const{items:J,missing:C}=Jr();if(C.length){j(c("projects.toast.equipmentMissing","⚠️ بعض المعدات المحددة غير موجودة في النظام، يرجى تحديث قائمة المعدات"),"error");return}const _=!!b.editingProjectId,N=_?b.projects.find(k=>String(k.id)===String(b.editingProjectId)):null;if(_&&!N){j(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const w=r.companyName||r.company||"",R=o.description?.value.trim()||"",K=ta({projectCode:N?.projectCode||(_?null:Ha()),title:t,type:n,clientId:d,clientCompany:w,description:R,start:m,end:p||null,applyTax:A,paymentStatus:U,equipmentEstimate:S,expenses:b.expenses.map(k=>({id:k.id,label:k.label,amount:k.amount})),discount:I,discountType:T,companyShareEnabled:L&&A,companySharePercent:L&&A?D:null,companyShareAmount:q.companyShareAmount,taxAmount:q.taxAmount,totalWithTax:q.totalWithTax,confirmed:N?.confirmed??!1,technicians:b.selectedTechnicians,equipment:J,paidAmount:V.paidAmount,paidPercentage:V.paidPercent,paymentProgressType:V.paymentProgressType,paymentProgressValue:V.paymentProgressValue});Sn=!0;try{let k=N?.projectId??N?.id??null;if(_){const z=await tn(k??b.editingProjectId,K);k=z?.projectId??z?.id??k,await $n(k,U),j(c("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const z=await Pi(K);k=z?.projectId??z?.id??null,await $n(k,U),j(c("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}await so(k)||qi(),b.editingProjectId=null,o.form.reset(),Li(),Ei(),Pt(),o.client&&(o.client.dataset.customerId=""),o.type&&(o.type.value=""),b.projects=ct(),b.reservations=oe(),be(),Le(),document.dispatchEvent(new CustomEvent("projects:changed"))}catch(k){console.error("❌ [projects] handleSubmitProject failed",k);const Y=Ct(k)?k.message:c("projects.toast.saveFailed","تعذر حفظ المشروع، حاول مرة أخرى");j(Y,"error")}finally{Sn=!1}}function Ht(e,t){if(!e)return"";const n=t&&/\d{1,2}:\d{2}/.test(t)?t:"00:00",[a="00",i="00"]=n.split(":"),s=a.padStart(2,"0"),l=i.padStart(2,"0");return`${e}T${s}:${l}`}function ln(){if(typeof window>"u"||!window.sessionStorage)return null;const e=window.sessionStorage.getItem(on);if(!e)return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch(t){return console.warn("⚠️ [projects] Failed to parse project form draft",t),null}}function Di(e){if(!(typeof window>"u"||!window.sessionStorage))try{window.sessionStorage.setItem(on,JSON.stringify(e))}catch(t){console.warn("⚠️ [projects] Unable to persist project form draft",t)}}function qi(){typeof window>"u"||!window.sessionStorage||(window.sessionStorage.removeItem(on),Tt())}function eo(){const e=ln()||{};return{...e,type:o.type?.value||"",title:o.title?.value||"",client:o.client?.value||"",customerId:o.client?.dataset.customerId||"",clientCompany:o.clientCompany?.value||"",paymentStatus:o.paymentStatus?.value||"unpaid",taxChecked:o.taxCheckbox?.checked===!0,discountType:o.discountType?.value||"percent",discountValue:o.discountValue?.value||"",companyShareEnabled:o.companyShare?.checked===!0,companySharePercent:o.companyShare?.dataset.companyShare||o.companyShare?.value||String(ye),paymentProgressType:o.paymentProgressType?.value||"percent",paymentProgressValue:o.paymentProgressValue?.value||"",startDate:o.startDate?.value||"",startTime:o.startTime?.value||"",endDate:o.endDate?.value||"",endTime:o.endTime?.value||"",description:o.description?.value||"",expenses:Array.isArray(b.expenses)?b.expenses.map(t=>({...t})):[],technicians:Array.isArray(b.selectedTechnicians)?[...b.selectedTechnicians]:[],equipment:Array.isArray(b.selectedEquipment)?b.selectedEquipment.map(t=>({...t})):[],linkedReservationIds:Array.isArray(e.linkedReservationIds)?[...e.linkedReservationIds]:[],savedAt:Date.now()}}function to(){const e=ln();return e?(o.type&&(o.type.value=e.type||""),o.title&&(o.title.value=e.title||""),o.client&&(o.client.value=e.client||"",o.client.dataset.customerId=e.customerId||""),o.clientCompany&&(o.clientCompany.value=e.clientCompany||""),o.paymentStatus&&e.paymentStatus&&(o.paymentStatus.value=e.paymentStatus),o.taxCheckbox&&(o.taxCheckbox.checked=e.taxChecked===!0),o.discountType&&e.discountType&&(o.discountType.value=e.discountType),o.discountValue&&(o.discountValue.value=e.discountValue||""),o.companyShare&&(e.companySharePercent?o.companyShare.dataset.companyShare=String(e.companySharePercent):o.companyShare.dataset.companyShare=String(ye),o.companyShare.checked=e.companyShareEnabled===!0),o.paymentProgressType&&e.paymentProgressType&&(o.paymentProgressType.value=e.paymentProgressType),o.paymentProgressValue&&(o.paymentProgressValue.value=e.paymentProgressValue||""),o.startDate&&(o.startDate.value=e.startDate||""),o.startTime&&(o.startTime.value=e.startTime||""),o.endDate&&(o.endDate.value=e.endDate||""),o.endTime&&(o.endTime.value=e.endTime||""),o.description&&(o.description.value=e.description||""),b.expenses=Array.isArray(e.expenses)?e.expenses.map(t=>({...t})):[],b.selectedTechnicians=Array.isArray(e.technicians)?[...e.technicians]:[],b.selectedEquipment=Array.isArray(e.equipment)?e.equipment.map(t=>({...t})):[],vt("tax"),Tt(),!0):(Tt(),!1)}function no(){!o.linkedReservationBtn||o.linkedReservationBtn.dataset.listenerAttached==="true"||(o.linkedReservationBtn.addEventListener("click",ao),o.linkedReservationBtn.dataset.listenerAttached="true")}function ao(e){e.preventDefault();const t=eo();if(!(t.customerId&&t.customerId!==""||t.client&&t.client.trim())){j(c("projects.form.linkedReservation.missingClient","⚠️ يرجى اختيار العميل قبل إنشاء الحجز"));return}const a=t.startDate&&t.startTime,i=t.endDate&&t.endTime;if(!a||!i){j(c("projects.form.linkedReservation.missingSchedule","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إنشاء الحجز"));return}Di(t);const s=io(t);let l="";try{l=encodeURIComponent(JSON.stringify(s))}catch(d){console.warn("⚠️ [projects] Unable to encode reservation context",d)}Ut({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(d=>{console.warn("⚠️ [projects] Failed to persist dashboard preference before redirect",d)});const r=l?`?reservationProjectContext=${l}`:"";window.location.href=`dashboard.html${r}#reservations`}function io(e){const t=Ht(e.startDate,e.startTime)||null,n=Ht(e.endDate,e.endTime)||null;return{fromProjectForm:!0,draftStorageKey:on,returnUrl:Fr,start:t,end:n,customerId:e.customerId||null,customerName:e.client||"",clientCompany:e.clientCompany||"",projectTitle:e.title||"",projectType:e.type||"",description:e.description||""}}async function so(e){if(!e)return;const t=ln(),n=Array.isArray(t?.linkedReservationIds)?t.linkedReservationIds:[];if(!n.length)return;const a=[];let i=!1;for(const l of n){const r=l!=null?String(l):"";if(r)try{await Dn(r,{project_id:e}),i=!0}catch(d){console.error("❌ [projects] Failed to link reservation to project",r,d),a.push(r)}}if(i)try{await kn(),b.reservations=oe(),document.dispatchEvent(new CustomEvent("reservations:changed"))}catch(l){console.warn("⚠️ [projects] Failed to refresh reservations after linking",l)}const s={linkedReservationIds:a,savedAt:Date.now()};return Di(s),a.length&&j(c("projects.toast.linkReservationFailed","⚠️ تعذر ربط بعض الحجوزات بالمشروع، يرجى التحقق يدويًا"),"error"),Tt(),a.length}function ro(){const e=new Map,t=a=>{if(!a)return;[a.id,a.reservationId,a.reservation_id,a.reservation_code].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{e.has(s)||e.set(s,a)})};Array.isArray(b.reservations)&&b.reservations.forEach(t);const n=X();return Array.isArray(n?.reservations)&&n.reservations.forEach(t),e}function oo(e){if(!e||typeof e!="object")return"";const t=[e.name,e.full_name,e.fullName,e.technician_name,e.technicianName,e.label,e.displayName];for(const n of t)if(typeof n=="string"&&n.trim())return n.trim();return""}function co(e){if(!e)return[];const t=new Set;(Array.isArray(e.techniciansDetails)?e.techniciansDetails:[]).forEach(i=>{const s=oo(i);s&&t.add(s)});const a=Array.isArray(e.technicians)?e.technicians:[];if(a.length){const i=Array.isArray(b.technicians)?b.technicians:[];a.forEach(s=>{const l=i.find(d=>String(d?.id)===String(s)),r=l?.name||l?.full_name||"";r&&t.add(String(r).trim())})}return Array.from(t)}function Tt(){const e=document.getElementById("project-linked-reservation-summary");if(!e)return;const t=ln(),n=o.linkedReservationBtn,a=Array.isArray(t?.linkedReservationIds)?Array.from(new Set(t.linkedReservationIds.map(l=>String(l)).filter(Boolean))):[];if(!a.length){e.dataset.state="empty",e.innerHTML=`<p class="project-linked-reservation__summary-empty">${y(c("projects.form.linkedReservation.empty","لم يتم إنشاء حجوزات مرتبطة بعد."))}</p>`,n&&(n.disabled=!1,n.classList.remove("btn-disabled"),n.removeAttribute("aria-disabled"),n.title="");return}const i=ro(),s=a.map(l=>{const r=i.get(l);if(!r)return`
        <li class="project-linked-reservation__summary-item">
          <div class="project-linked-reservation__summary-item-title">#${y(g(l))}</div>
          <div class="project-linked-reservation__summary-item-meta">
            <span>${y(c("projects.form.linkedReservation.pendingItem","تم إنشاء حجز جديد وسيتم ربطه بعد حفظ المشروع."))}</span>
          </div>
        </li>`;const d=r.reservation_code||r.reservationId||r.id||l,u=`#${g(String(d))}`,f=Array.isArray(r.items)?r.items:[],m=f.reduce((E,I)=>E+(Number(I?.qty)||0),0)||f.length||0,p=co(r),v=(Array.isArray(r.technicians)?r.technicians:[]).length||p.length||0,P=sa(r),S=[],A=c("projects.form.linkedReservation.meta.equipment","عدد المعدات: {count}").replace("{count}",g(String(m)));S.push(A);const T=c("projects.form.linkedReservation.meta.crew","عدد الفريق: {count}").replace("{count}",g(String(v)));if(S.push(T),p.length){const E=typeof re=="function"&&re()==="en"?", ":"، ",I=c("projects.form.linkedReservation.meta.crewNames","أسماء الفريق: {names}").replace("{names}",p.join(E));S.push(I)}if(Number.isFinite(P)){const E=c("projects.form.linkedReservation.meta.total","إجمالي الحجز: {amount}").replace("{amount}",G(P));S.push(E)}return`
      <li class="project-linked-reservation__summary-item">
        <div class="project-linked-reservation__summary-item-title">${y(u)}</div>
        <div class="project-linked-reservation__summary-item-meta">
          ${S.map(E=>`<span>${y(E)}</span>`).join("")}
        </div>
      </li>`}).join("");e.dataset.state="has-linked",e.innerHTML=`<ul class="project-linked-reservation__summary-list">${s}</ul>`,n&&(n.disabled=!0,n.classList.add("btn-disabled"),n.setAttribute("aria-disabled","true"),n.title=c("projects.form.linkedReservation.buttonDisabled","تم إنشاء حجز مرتبط لهذا المشروع. يمكنك تعديل الحجز بعد حفظ المشروع."))}let ka=null;function lo(e){e&&Ri()!==e&&Ut({[Zn]:e}).catch(t=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",t)})}function Ri(){return Oa()?.[Zn]||""}function Mi(e){e&&Ln()!==e&&Ut({[ea]:e}).catch(t=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",t)})}function Ln(){return Oa()?.[ea]||""}function uo(e){if(!e)return"";const t=e.trim();return t?Object.values(Na).includes(t)?t:Na[t]||"":""}function po(){if(typeof window>"u")return"";try{const t=new URLSearchParams(window.location.search||"").get("subTab");if(t){const n=uo(t);if(n)return n}}catch{}return""}function Vi(e,t){!e||!o.tabPanes||!o.tabButtons||(o.tabButtons.forEach(n=>{const a=n===t;n.classList.toggle("active",a),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",a)}),o.tabPanes.forEach(n=>{n.dataset.tabPane===e?n.classList.remove("d-none"):n.classList.add("d-none")}),t&&lo(e))}function mo(){if(!o.tabButtons||!o.tabButtons.length)return;o.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",a=>{a.preventDefault();const i=n.dataset.tabTarget;i&&(Vi(i,n),i==="projects-section"&&(b.filters.search="",o.search&&(o.search.value=""),be(),$e(),Le()))}),n.dataset.tabListenerAttached="true")});const e=Ri(),t=e&&o.tabButtons.find(n=>n.dataset.tabTarget===e);t&&t.click()}function oa(e,t){!e||!o.projectSubTabButtons||!o.projectSubTabPanes||(o.projectSubTabButtons.forEach(n=>{const a=n===t;n.classList.toggle("active",a),n.classList.contains("tab")&&n.classList.toggle("tab-active",a)}),o.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===e?n.classList.remove("d-none"):n.classList.add("d-none")}))}function fo(){!o.projectSubTabButtons||!o.projectSubTabButtons.length||(o.projectSubTabButtons.forEach(e=>{e.dataset.tabListenerAttached!=="true"&&(e.addEventListener("click",t=>{t.preventDefault();const n=e.dataset.projectSubtabTarget;n&&(oa(n,e),Mi(n))}),e.dataset.tabListenerAttached="true")}),yo())}function yo(){const t=po()||Ln();if(!t)return;const n=o.projectSubTabButtons?.[0],a=o.projectSubTabButtons?.find(s=>s.dataset.projectSubtabTarget===t)||n,i=a?.dataset.projectSubtabTarget;i&&(t!==Ln()&&Mi(i),oa(i,a))}function ho(){return o.tabButtons?o.tabButtons.find(t=>t.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Da(e={}){if(e){if(o.tabButtons&&o.tabButtons.length){const n=o.tabButtons.find(i=>i.classList.contains("active"))?.dataset.tabTarget||"",a=e[Zn];if(a&&a!==n){const i=o.tabButtons.find(s=>s.dataset.tabTarget===a);i&&Vi(a,i)}}if(o.projectSubTabButtons&&o.projectSubTabButtons.length&&ho()){const n=o.projectSubTabButtons.find(i=>i.classList.contains("active"))?.dataset.projectSubtabTarget||"",a=e[ea];if(a&&a!==n){const i=o.projectSubTabButtons.find(s=>s.dataset.projectSubtabTarget===a);i&&oa(a,i)}}}}function bo(){ka||(ka=ts(e=>{Da(e)})),ns().then(e=>{Da(e)}).catch(e=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",e)})}function Ue(e){const t=b.projects.find(ce=>String(ce.id)===String(e));if(!t||!o.detailsBody)return;o.detailsBody.dataset.mode="view",o.detailsBody.dataset.projectId=String(t.id);const a=(b.customers.length?b.customers:X().customers||[]).find(ce=>String(ce.id)===String(t.clientId)),i=Ui(t.type),l=t.description?.trim()||c("projects.fallback.noDescription","لا يوجد وصف"),r=a?.customerName||c("projects.fallback.unknownClient","عميل غير معروف"),d=a?.phone??a?.customerPhone??t.clientPhone??t.customerPhone??"",u=d?g(String(d).trim()):c("projects.details.client.noPhone","لا يوجد رقم متاح"),f=a?.email??t.clientEmail??t.customerEmail??"",m=f?String(f).trim():c("projects.details.client.noEmail","لا يوجد بريد متاح"),p=(t.clientCompany||a?.companyName||"").trim(),h=t.projectCode||`PRJ-${g(String(t.id))}`,v=g(h),P=rn(t.id),S=P.reduce((ce,Pe)=>ce+Co(Pe),0),A=Number(S.toFixed(2)),T=P.length,{subtotal:E,applyTax:I,expensesTotal:B}=At(t),L=E,D=I?Number(((L+A)*Zt).toFixed(2)):0,q=Number((L+A+D).toFixed(2)),M=ia(t),H=c(`projects.status.${M}`,Si[M]||M),V={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[M]||"status-confirmed",W=I?c("projects.details.chips.vatOn","شامل الضريبة 15٪"):c("projects.details.chips.vatOff","غير شامل الضريبة"),x=I?"status-paid":"status-unpaid",$=c("projects.details.chips.reservations","{count} حجوزات").replace("{count}",g(String(T))),F=typeof t.paymentStatus=="string"?t.paymentStatus.toLowerCase():"",U=_o(t),J=U.length>0,C=J?0:Number(t.paidAmount)||0,_=J?0:Number(t.paidPercent)||0,N=He({totalAmount:q,paidAmount:C,paidPercent:_,history:U}),w=st({manualStatus:F||"unpaid",paidAmount:N.paidAmount,paidPercent:N.paidPercent,totalAmount:q}),R=c(`projects.paymentStatus.${w}`,w==="paid"?"Paid":w==="partial"?"Partial":"Unpaid"),K=w==="paid"?"status-paid":w==="partial"?"status-partial":"status-unpaid",k=Number.isFinite(Number(N.paidAmount))?Number(N.paidAmount):0,Y=Number.isFinite(Number(N.paidPercent))?Number(N.paidPercent):0,z=Math.max(0,Number((q-k).toFixed(2))),de=G(k),O=`${g(Y.toFixed(2))}%`,te=G(z),qe=No(U),Q=c("projects.focus.confirmed","✅ مشروع مؤكد"),ne=t.confirmed===!0||t.confirmed==="true"?`<span class="reservation-chip status-confirmed">${y(Q)}</span>`:"",Ke=[{icon:"💼",label:c("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:G(L)},{icon:"🔗",label:c("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:G(A)},{icon:"🧮",label:c("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:G(D)},{icon:"💰",label:c("projects.details.summary.overallTotal","الإجمالي الكلي"),value:G(q)},{icon:"💳",label:c("projects.details.summary.paidAmount","إجمالي المدفوع"),value:de},{icon:"📊",label:c("projects.details.summary.paidPercent","نسبة المدفوع"),value:O},{icon:"💸",label:c("projects.details.summary.remainingAmount","المتبقي للدفع"),value:te}].map(({icon:ce,label:Pe,value:Ie})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${ce} ${y(Pe)}</span>
      <span class="summary-details-value">${y(Ie)}</span>
    </div>
  `).join(""),lt=c("projects.details.labels.code","رقم المشروع"),dt=`
    <div class="project-details-code-badge" title="${y(lt)}">
      <span class="project-details-code-badge__label">
        <span class="project-details-code-badge__icon" aria-hidden="true">🗂️</span>
        ${y(lt)}
      </span>
      <span class="project-details-code-badge__value">${y(v)}</span>
    </div>
  `,ut=[{icon:"👤",label:c("projects.details.client","العميل"),value:r},{icon:"📞",label:c("projects.details.labels.clientPhone","رقم العميل"),value:u},{icon:"✉️",label:c("projects.details.labels.clientEmail","البريد الإلكتروني"),value:m},p?{icon:"🏢",label:c("projects.details.company","شركة العميل"),value:p}:null,{icon:"🏷️",label:c("projects.details.type","نوع المشروع"),value:i},qa("start",t.start),qa("end",t.end)].filter(Boolean),dn=c("projects.details.overview.heading","معلومات المشروع"),un=`
    <div class="project-details-outline">
      <h6 class="project-details-outline__title">${y(dn)}</h6>
      <ul class="project-details-outline__list">
        ${ut.map(({icon:ce,label:Pe,value:Ie,meta:ue})=>`
          <li>
            <span class="project-details-outline__label">${y(ce)} ${y(Pe)}</span>
            <span class="project-details-outline__value-group">
              <span class="project-details-outline__value">${y(Ie)}</span>
              ${ue?`<span class="project-details-outline__meta">${y(ue)}</span>`:""}
            </span>
          </li>
        `).join("")}
      </ul>
    </div>
  `,pt=[`<span class="reservation-chip ${V}">${y(H)}</span>`,`<span class="reservation-chip ${x}">${y(W)}</span>`,`<span class="reservation-chip status-info">${y($)}</span>`,`<span class="reservation-chip ${K}">${y(R)}</span>`,ne].filter(Boolean).join(""),$t=c("projects.details.expensesTotal","إجمالي المصاريف"),pn=c("projects.details.reservationsTotal","إجمالي الحجوزات");o.detailsBody.innerHTML=`
    <section class="project-details-primary">
      <header class="project-details-header">
        <div class="project-details-header__info">
          <div class="project-details-chips">${pt}</div>
        </div>
        <div class="project-details-header__code">
          ${dt}
          <h4 class="project-details-title">${y(t.title)}</h4>
        </div>
      </header>
      <div class="project-summary">
        <div class="project-summary-left">
          ${un}
        </div>
        <div class="project-summary-right">
          <div class="project-summary-card project-details-outline">
            <h6>${y(c("projects.details.summary.title","ملخص مالي"))}</h6>
            ${Ke}
          </div>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${y(c("projects.details.description","وصف المشروع"))}</h5>
      <p class="project-details-description">${y(l)}</p>
    </section>
    <section class="project-details-section">
      <h5>${y(c("projects.details.financialBreakdown","تفاصيل مالية"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${y($t)}</span>
          <strong>${G(B)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${y(pn)}</span>
          <strong>${G(A)}</strong>
        </div>
      </div>
    </section>
    <section class="project-details-section">
      <h5>${y(c("reservations.paymentHistory.title","سجل الدفعات"))}</h5>
      <div class="project-details-grid">
        <div class="project-details-grid-item">
          <span>${y(c("projects.details.paymentOverview.total","الإجمالي الكلي"))}</span>
          <strong>${y(G(q))}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${y(c("projects.details.paymentOverview.paid","المدفوع"))}</span>
          <strong>${y(de)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${y(c("projects.details.paymentOverview.percent","نسبة المدفوع"))}</span>
          <strong>${y(O)}</strong>
        </div>
        <div class="project-details-grid-item">
          <span>${y(c("projects.details.paymentOverview.remaining","المتبقي"))}</span>
          <strong>${y(te)}</strong>
        </div>
      </div>
      <div class="reservation-payment-history-modal mt-3">
        ${qe}
      </div>
    </section>
    ${$r(t)}
    <div class="project-details-footer">
      <button type="button" class="modal-action-btn modal-action-btn--primary" data-action="create-reservation">
        ${y(c("projects.details.reservations.create","➕ إنشاء حجز مرتبط"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--ghost" data-action="edit-project">
        ${y(c("projects.details.actions.edit","✏️ تعديل المشروع"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--danger" data-action="delete-project">
        ${y(c("projects.details.actions.delete","🗑️ حذف المشروع"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--ghost" id="project-details-export-btn">
        ${y(c("projects.details.actions.exportPdf","👁️ معاينة PDF"))}
      </button>
      <button type="button" class="modal-action-btn modal-action-btn--ghost" data-bs-dismiss="modal">
        ${y(c("actions.close","إغلاق"))}
      </button>
    </div>
  `,So(t);const Z=o.detailsBody.querySelector("#project-details-export-btn");Z&&Z.addEventListener("click",async ce=>{if(ce.preventDefault(),Z.blur(),!Z.disabled){Z.disabled=!0;try{await ss({project:t})}catch(Pe){console.error("❌ [projects/details] export project PDF failed",Pe),j(c("projects.details.exportFailed","⚠️ تعذر تصدير المشروع إلى PDF"),"error")}finally{Z.disabled=!1}}}),o.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(o.detailsModalEl).show()}function go({onOpenProject:e}){!o.focusCards||o.focusCards.dataset.listenerAttached==="true"||(o.focusCards.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(n){const{action:i,id:s}=n.dataset;if(i==="confirm-project"){t.preventDefault(),t.stopPropagation(),Ao(s);return}i==="view"?e?.(s):i==="highlight"&&vo(s);return}const a=t.target.closest(".project-focus-card");a?.dataset.projectId&&e?.(a.dataset.projectId)}),o.focusCards.dataset.listenerAttached="true")}function vo(e){if(!o.projectsTableBody)return;const t=`tr[data-project-id="${CSS.escape(String(e))}"]`,n=o.projectsTableBody.querySelector(t);if(!n){j(c("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function So(e){if(!o.detailsBody)return;const t=o.detailsBody.querySelector('[data-action="create-reservation"]'),n=o.detailsBody.querySelector('[data-action="edit-project"]'),a=o.detailsBody.querySelector('[data-action="delete-project"]'),i=o.detailsBody.querySelector(".project-reservations-list");if(t&&e&&t.addEventListener("click",s=>{s.preventDefault(),Po(e)}),n&&e&&n.addEventListener("click",s=>{s.preventDefault(),zi(e)}),a&&e&&a.addEventListener("click",async s=>{s.preventDefault();const l=s.currentTarget;l.disabled=!0;try{await xi(e.id),!b.projects.some(d=>String(d.id)===String(e.id))&&o.detailsModalEl&&window.bootstrap?.Modal.getInstance(o.detailsModalEl)?.hide()}finally{b.projects.some(d=>String(d.id)===String(e.id))&&(l.disabled=!1)}}),i){const s=async l=>{if(!Number.isInteger(l)||l<0)return!1;const r=rs("showReservationDetails");if(typeof r=="function")return r(l),!0;try{const d=await os("showReservationDetails");if(typeof d=="function")return d(l),!0}catch(d){console.warn("⚠️ [projects/projectDetails] Unable to resolve reservation UI handler",d)}return!1};i.addEventListener("click",async l=>{const r=l.target.closest('[data-action="view-reservation"]');if(!r)return;const d=r.dataset.index||r.dataset.reservationIndex,u=Number.parseInt(d||"-1",10);if(!Number.isInteger(u)||u<0)return;await s(u)||(window.location.href="dashboard.html#reservations")}),i.addEventListener("keydown",l=>{if(!["Enter"," "].includes(l.key))return;const r=l.target.closest('[data-action="view-reservation"]');r&&(l.preventDefault(),r.click())})}}function zi(e){if(!e||!o.detailsBody)return;const t=b.projects.find(f=>String(f.id)===String(e.id));if(!t)return;const n=b.customers.find(f=>String(f.id)===String(t.clientId));n?.customerName||n?.name||t.clientName||t.customerName,t.clientCompany||n?.companyName||n?.company;const a=Array.isArray(t.expenses)?t.expenses.map((f,m)=>({id:f?.id||`expense-${t.id}-${m}-${Date.now()}`,label:f?.label||"",amount:Number(f?.amount)||0})):[];let i=Array.isArray(t.paymentHistory)?t.paymentHistory.map((f,m)=>({type:f?.type==="percent"?"percent":"amount",amount:Number.isFinite(Number(f?.amount))?Number(f.amount):null,percentage:Number.isFinite(Number(f?.percentage))?Number(f.percentage):null,value:Number.isFinite(Number(f?.value))?Number(f.value):null,note:f?.note??null,recordedAt:f?.recordedAt??f?.recorded_at??new Date().toISOString(),key:`payment-${t.id}-${m}`})):[],s=i.reduce((f,m)=>f+(Number(m?.amount)||0),0),l=i.reduce((f,m)=>f+(Number(m?.percentage)||0),0),r=Number.isFinite(Number(t.paidAmount))?Number(t.paidAmount):0,d=Number.isFinite(Number(t.paidPercent))?Number(t.paidPercent):0;if(!i.length&&(r>0||d>0)){const f=t.updatedAt??t.createdAt??new Date().toISOString();d>0?i=[{type:"percent",amount:Number.isFinite(r)&&r>0?r:null,percentage:d,value:d,note:null,recordedAt:f,key:`legacy-payment-${t.id}-percent`}]:r>0&&(i=[{type:"amount",amount:r,percentage:null,value:r,note:null,recordedAt:f,key:`legacy-payment-${t.id}-amount`}]),s=i.reduce((m,p)=>m+(Number(p?.amount)||0),0),l=i.reduce((m,p)=>m+(Number(p?.percentage)||0),0),r=0,d=0}s>0&&Math.abs(r-s)<.01&&(r=0),l>0&&Math.abs(d-l)<.01&&(d=0);const u={expenses:a,payments:i,basePaidAmount:r,basePaidPercent:d};o.detailsBody.dataset.mode="edit",o.detailsBody.innerHTML=To(t,u),jo(t,u)}function jo(e,t={expenses:[]}){const n=o.detailsBody?.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",C=>{C.preventDefault(),Ue(e.id)});const i=n.querySelector("#project-edit-expense-label"),s=n.querySelector("#project-edit-expense-amount"),l=n.querySelector('[data-action="add-expense"]'),r=n.querySelector("#project-edit-expense-list"),d=n.querySelector('[name="project-start-date"]'),u=n.querySelector('[name="project-start-time"]'),f=n.querySelector('[name="project-end-date"]'),m=n.querySelector('[name="project-end-time"]'),p=n.querySelector('[name="project-payment-status"]'),h=n.querySelector("#project-edit-tax"),v=n.querySelector("#project-edit-company-share"),P=n.querySelector("#project-edit-discount"),S=n.querySelector("#project-edit-discount-type"),A=n.querySelector("#project-edit-payment-progress-type"),T=n.querySelector("#project-edit-payment-progress-value"),E=n.querySelector("#project-edit-payment-add"),I=n.querySelector("#project-edit-payment-history"),B=n.querySelector("#project-edit-payment-summary"),L=c("reservations.create.summary.currency","SR");let D=!1;const q=()=>(Array.isArray(t.payments)||(t.payments=[]),t.payments),M=()=>{const C=Number(e.equipmentEstimate)||0,_=Array.isArray(t.expenses)?t.expenses.reduce((de,O)=>de+(Number(O.amount)||0),0):0,N=S?.value==="amount"?"amount":"percent",w=g(P?.value||"0");let R=Number.parseFloat(w);(!Number.isFinite(R)||R<0)&&(R=0);const K=h?.checked===!0,k=v?.checked===!0;let Y=k?kr(v):null;(!Number.isFinite(Y)||Y<=0)&&(Y=k?ye:null);const z=$i({equipmentEstimate:C,expensesTotal:_,discountValue:R,discountType:N,applyTax:K,companyShareEnabled:k,companySharePercent:Y});return{equipmentEstimate:C,expensesTotal:_,discountValue:R,discountTypeValue:N,applyTax:K,companyShareEnabled:k,companySharePercent:Y,finance:z}},H=()=>{const C=M(),_=q(),N=He({totalAmount:C.finance.totalWithTax,paidAmount:t.basePaidAmount||0,paidPercent:t.basePaidPercent||0,history:_});return{...C,payments:_,progress:N}},ee=()=>{I&&(I.innerHTML=Eo(q()))},V=()=>{if(!B)return;const{finance:C,progress:_}=H(),N=Number.isFinite(Number(C.totalWithTax))?Number(C.totalWithTax):0,w=Number.isFinite(Number(_.paidAmount))?Number(_.paidAmount):0,R=Number.isFinite(Number(_.paidPercent))?Number(_.paidPercent):0,K=Math.max(0,Math.round((N-w)*100)/100),k=[{label:c("projects.form.paymentSummary.total","الإجمالي الكلي"),value:G(N)},{label:c("projects.form.paymentSummary.paidAmount","إجمالي المدفوع"),value:G(w)},{label:c("projects.form.paymentSummary.paidPercent","نسبة الدفعات"),value:`${g(R.toFixed(2))}%`},{label:c("projects.form.paymentSummary.remaining","المتبقي"),value:G(K)}];B.innerHTML=k.map(({label:Y,value:z})=>`
        <div class="project-details-grid-item">
          <span>${y(Y)}</span>
          <strong>${y(z)}</strong>
        </div>
      `).join("")},W=(C="auto")=>{if(!p)return;const _=p.dataset?.userSelected==="true";if(C==="auto"&&_)return;const{finance:N,progress:w}=H(),R=st({manualStatus:_?p.value:e.paymentStatus||"unpaid",paidAmount:w.paidAmount,paidPercent:w.paidPercent,totalAmount:N.totalWithTax});_||(p.value=R)},x=()=>{ee(),V(),W("auto")},$=1e-4,F=()=>{const C=A?.value==="amount"?"amount":"percent",_=g(T?.value||"").replace("%","").trim();let N=Number.parseFloat(_);if(!Number.isFinite(N)||N<=0){j(c("projects.toast.paymentInvalid","⚠️ يرجى إدخال قيمة دفعة صحيحة")),T?.focus();return}const w=H(),R=Number.isFinite(Number(w.finance.totalWithTax))?Number(w.finance.totalWithTax):0;if(R<=0){j(c("projects.toast.paymentTotalMissing","⚠️ يرجى التأكد من إدخال البيانات المالية للمشروع قبل تسجيل الدفعة"));return}const K=Number(w.progress.paidAmount)||0,k=Number(w.progress.paidPercent)||0;let Y=null,z=null;if(C==="percent"){const O=Math.max(0,100-k);if(O<=$){j(c("projects.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة المشروع، لا يمكن إضافة دفعة جديدة"));return}if(N>O){N=O;const te=g(N.toFixed(2));j(c("projects.toast.paymentCappedPercent","ℹ️ تم ضبط الدفعة إلى {value}% لاستكمال 100%").replace("{value}",te))}z=Math.round(N*100)/100,R>0&&(Y=Math.round(z/100*R*100)/100)}else{const O=Math.max(0,R-K);if(O<=$){j(c("projects.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة المشروع، لا يمكن إضافة دفعة جديدة"));return}if(N>O){N=O;const te=`${g(N.toFixed(2))} ${L}`;j(c("projects.toast.paymentCappedAmount","ℹ️ تم ضبط الدفعة إلى {amount} لاستكمال المبلغ المتبقي").replace("{amount}",te))}Y=Math.round(N*100)/100,R>0&&(z=Math.round(Y/R*100*100)/100)}const de={type:C,amount:Y??null,percentage:z??null,value:C==="amount"?Y:z,note:null,recordedAt:new Date().toISOString()};t.payments=[...q(),de],T&&(T.value=""),A&&(A.value="percent"),x(),j(c("projects.toast.paymentAdded","✅ تم تسجيل الدفعة"))},U=C=>{!h||!v||D||(D=!0,C==="share"?v.checked?(h.checked||(h.checked=!0),gt(v)):h.checked&&(h.checked=!1):C==="tax"&&(h.checked?gt(v):v.checked&&(v.checked=!1)),D=!1)};function J(){r&&(r.innerHTML=Hi(t.expenses))}J(),x(),P&&!P.dataset.listenerAttached&&(P.addEventListener("input",C=>{const _=C.target;_ instanceof HTMLInputElement&&(_.value=g(_.value||""),V(),W("auto"))}),P.dataset.listenerAttached="true"),S&&!S.dataset.listenerAttached&&(S.addEventListener("change",()=>{V(),W("auto")}),S.dataset.listenerAttached="true"),T&&!T.dataset.listenerAttached&&(T.addEventListener("input",C=>{const _=C.target;_ instanceof HTMLInputElement&&(_.value=g(_.value||""))}),T.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("change",()=>{p.dataset.userSelected="true"}),p.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("input",C=>{const _=C.target;_ instanceof HTMLInputElement&&(_.value=g(_.value||""))}),s.dataset.listenerAttached="true"),v&&!v.dataset.listenerAttached&&(v.addEventListener("change",()=>{U("share"),V(),W("auto")}),v.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("change",()=>{U("tax"),V(),W("auto")}),h.dataset.listenerAttached="true"),v?.checked&&gt(v),U(v?.checked?"share":"tax"),V(),W("auto"),l&&l.addEventListener("click",C=>{C.preventDefault();const _=i?.value.trim()||"",N=g(s?.value||"0"),w=Number(N);if(!_){j(c("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),i?.focus();return}if(!Number.isFinite(w)||w<=0){j(c("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),s?.focus();return}t.expenses.push({id:`expense-${e.id}-${Date.now()}`,label:_,amount:w}),i&&(i.value=""),s&&(s.value=""),J(),V(),W("auto")}),r&&r.addEventListener("click",C=>{const _=C.target.closest('[data-action="remove-expense"]');if(!_)return;const{id:N}=_.dataset;t.expenses=t.expenses.filter(w=>String(w.id)!==String(N)),J(),V(),W("auto")}),E&&!E.dataset.listenerAttached&&(E.addEventListener("click",C=>{C.preventDefault(),F()}),E.dataset.listenerAttached="true"),I&&!I.dataset.listenerAttached&&(I.addEventListener("click",C=>{const _=C.target.closest('[data-action="remove-payment"]');if(!_)return;const N=Number.parseInt(_.dataset.index||"-1",10);if(!Number.isInteger(N)||N<0)return;const w=q();if(N>=w.length)return;const R=w.filter((K,k)=>k!==N);t.payments=R,x(),j(c("projects.toast.paymentRemoved","🗑️ تم حذف الدفعة"))}),I.dataset.listenerAttached="true"),n.addEventListener("submit",async C=>{if(C.preventDefault(),n.dataset.submitting==="true")return;const _=n.querySelector('[name="project-title"]'),N=n.querySelector('[name="project-type"]'),w=n.querySelector('[name="project-description"]'),R=_?.value.trim()||"",K=N?.value||"",k=d?.value.trim()||"",Y=u?.value.trim()||"",z=w?.value.trim()||"",de=(p?.value||"unpaid").toLowerCase(),O=["paid","partial"].includes(de)?de:"unpaid";if(!R||!K||!k){j(c("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),_?.focus();return}const te=f?.value.trim()||"",qe=m?.value.trim()||"",Q=Ca(k,Y),ne=te?Ca(te,qe):"",me=new Date(Q),Ke=ne?new Date(ne):null;if(Ke&&me>Ke){j(c("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),f?.focus();return}if(b.projects.findIndex(ge=>String(ge.id)===String(e.id))===-1){j(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const dt=M(),{equipmentEstimate:ut,discountValue:dn,discountTypeValue:un,applyTax:pt,companyShareEnabled:$t,companySharePercent:pn,finance:Z}=dt,ce=A?.value==="amount"?"amount":"percent",Pe=g(T?.value||"");let Ie=Pe?Number.parseFloat(Pe):null,ue=[...q()];if(Number.isFinite(Ie)&&Ie>0&&Number.isFinite(Number(Z.totalWithTax))){const ge=He({totalAmount:Z.totalWithTax,paidAmount:t.basePaidAmount||0,paidPercent:t.basePaidPercent||0,history:ue}),Ge=new Date().toISOString();if(ce==="percent"){const mt=Math.max(0,100-(ge.paidPercent||0));if(mt>$){const yn=Math.min(Ie,mt),Re=Math.round(yn*100)/100,hn=Z.totalWithTax>0?Math.round(Re/100*Z.totalWithTax*100)/100:null;ue=[...ue,{type:"percent",amount:hn,percentage:Re,value:Re,note:null,recordedAt:Ge}]}}else{const mt=Math.max(0,Z.totalWithTax-(ge.paidAmount||0));if(mt>$){const yn=Math.min(Ie,mt),Re=Math.round(yn*100)/100,hn=Z.totalWithTax>0?Math.round(Re/Z.totalWithTax*100*100)/100:null;ue=[...ue,{type:"amount",amount:Re,percentage:hn,value:Re,note:null,recordedAt:Ge}]}}ue!==t.payments&&(t.payments=ue,x()),T&&(T.value=""),A&&(A.value="percent"),Ie=null}const Ye=He({totalAmount:Z.totalWithTax,paidAmount:t.basePaidAmount||0,paidPercent:t.basePaidPercent||0,history:ue}),mn=p?.dataset?.userSelected==="true",Ki=st({manualStatus:mn?O:e.paymentStatus||O,paidAmount:Ye.paidAmount,paidPercent:Ye.paidPercent,totalAmount:Z.totalWithTax}),fn=mn?O:Ki;!mn&&p&&(p.value=fn),p?.dataset&&delete p.dataset.userSelected,t.payments=ue;const Yi=ta({projectCode:e.projectCode,title:R,type:K,clientId:e.clientId,clientCompany:e.clientCompany,description:z,start:Q,end:ne||null,applyTax:pt,paymentStatus:fn,equipmentEstimate:ut,expenses:t.expenses,discount:dn,discountType:un,companyShareEnabled:$t&&pt,companySharePercent:$t&&pt?pn:null,companyShareAmount:Z.companyShareAmount,taxAmount:Z.taxAmount,totalWithTax:Z.totalWithTax,confirmed:e.confirmed,technicians:Array.isArray(e.technicians)?e.technicians:[],equipment:Qr(e),paidAmount:Ye.paidAmount,paidPercentage:Ye.paidPercent,paymentProgressType:Ye.paymentProgressType,paymentProgressValue:Ye.paymentProgressValue,payments:ue});n.dataset.submitting="true";try{const ge=await tn(e.projectId??e.id,Yi),Ge=ge?.projectId??ge?.id??e.id;await $n(Ge,fn),b.projects=ct(),b.reservations=oe(),j(c("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),be(),$e(),Le(),Ue(e.id)}catch(ge){console.error("❌ [projects] Failed to update project from details view",ge);const Ge=Ct(ge)?ge.message:c("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");j(Ge,"error")}finally{delete n.dataset.submitting}})}function Po(e){if(!e)return;const t={projectId:e.id,customerId:e.clientId||null,start:e.start||null,end:e.end||null,forceNotes:!!e.description};Ut({dashboardTab:"reservations-tab",dashboardSubTab:"create-tab"}).catch(i=>{console.warn("⚠️ [projects] Failed to persist dashboard tab preference",i)});let n="";try{n=encodeURIComponent(JSON.stringify(t))}catch(i){console.warn("⚠️ [projects] Unable to encode reservation context",i)}o.detailsModalEl&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(o.detailsModalEl)?.hide();const a=n?`?reservationProjectContext=${n}`:"";window.location.href=`dashboard.html${a}#reservations`}async function Ao(e){if(!e)return;const t=b.projects.find(n=>String(n.id)===String(e));if(!t){j(c("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}if(t.confirmed===!0||t.confirmed==="true"){j(c("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}try{await tn(t.projectId??t.id,{confirmed:!0});const n=await Br(e);b.projects=ct(),b.reservations=oe(),be(),$e(),Le(),o.detailsModalEl&&o.detailsModalEl.classList.contains("show")&&o.detailsBody?.dataset.projectId===String(e)&&Ue(e),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed")),j(c("projects.toast.confirmed","✅ تم تأكيد المشروع"))}catch(n){console.error("❌ [projects] confirmProject failed",n);const a=Ct(n)?n.message:c("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");j(a,"error")}}function To(e,t={clientName:"",clientCompany:"",expenses:[]}){const{date:n,time:a}=$a(e.start||""),{date:i,time:s}=$a(e.end||""),l=e.applyTax===!0||e.applyTax==="true",r=typeof e.paymentStatus=="string"?e.paymentStatus.toLowerCase():"",d=["paid","partial"].includes(r)?r:"unpaid",u=e.discountType==="amount"?"amount":"percent",f=g(String(e.discount??e.discountValue??0)),m=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??e.companyShareAmountPercent??ye,p=Number.parseFloat(g(String(m))),h=Number.isFinite(p)&&p>0?p:ye,v=e.companyShareEnabled===!0||e.companyShareEnabled==="true"||e.company_share_enabled===!0||e.company_share_enabled==="true"||l&&Number.isFinite(p)&&p>0;return`
    <form id="project-details-edit-form" class="project-edit-form">
      <div class="row g-3">
        <div class="col-12 col-xl-8">
          <label class="form-label">${y(c("projects.form.labels.title","عنوان المشروع"))}</label>
          <input type="text" class="form-control project-edit-input-wide" name="project-title" value="${y(e.title||"")}" required>
        </div>
        <div class="col-12 col-sm-6 col-xl-4 d-flex flex-column">
          <label class="form-label">${y(c("projects.form.labels.type","نوع المشروع"))}</label>
          <select class="form-select project-edit-select-lg" name="project-type" required>
            ${Io(e.type)}
          </select>
        </div>
        <div class="col-12">
          <div class="project-edit-inline-group project-edit-inline-group--dates">
            <div class="project-edit-inline-field">
              <label class="form-label">${y(c("projects.form.labels.startDate","تاريخ البدء"))}</label>
              <input type="date" class="form-control" name="project-start-date" value="${y(n)}" required>
            </div>
            <div class="project-edit-inline-field">
              <label class="form-label">${y(c("projects.form.labels.endDate","تاريخ الانتهاء"))}</label>
              <input type="date" class="form-control" name="project-end-date" value="${y(i)}">
            </div>
          </div>
          <div class="project-edit-inline-group project-edit-inline-group--times mt-2">
            <div class="project-edit-inline-field">
              <label class="form-label">${y(c("projects.form.labels.startTime","وقت البدء"))}</label>
              <input type="time" class="form-control" name="project-start-time" value="${y(a)}">
            </div>
            <div class="project-edit-inline-field">
              <label class="form-label">${y(c("projects.form.labels.endTime","وقت الانتهاء"))}</label>
              <input type="time" class="form-control" name="project-end-time" value="${y(s)}">
            </div>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">${y(c("projects.form.labels.description","الوصف"))}</label>
          <textarea class="form-control project-edit-textarea" name="project-description" rows="5">${y(e.description||"")}</textarea>
        </div>
        <div class="col-12 col-md-4 col-xl-3">
          <label class="form-label">${y(c("projects.form.labels.paymentStatus","حالة الدفع"))}</label>
          <select class="form-select project-edit-select-xs" name="project-payment-status" id="project-edit-payment-status">
            <option value="unpaid" ${d==="unpaid"?"selected":""}>${y(c("projects.paymentStatus.unpaid","غير مدفوع"))}</option>
            <option value="partial" ${d==="partial"?"selected":""}>${y(c("projects.paymentStatus.partial","مدفوع جزئياً"))}</option>
            <option value="paid" ${d==="paid"?"selected":""}>${y(c("projects.paymentStatus.paid","مدفوع"))}</option>
          </select>
        </div>
      </div>

      <div class="row g-3 align-items-start mt-1">
        <div class="col-sm-6 col-lg-4 col-xl-3">
          <label class="form-label" for="project-edit-discount">${y(c("projects.form.labels.discount","الخصم"))}</label>
          <div class="input-group project-edit-input-group">
            <select id="project-edit-discount-type" name="project-discount-type" class="form-select project-edit-select-xs">
              <option value="percent" ${u==="percent"?"selected":""}>${y(c("projects.form.discount.percent","٪ نسبة"))}</option>
              <option value="amount" ${u==="amount"?"selected":""}>${y(c("projects.form.discount.amount","💵 مبلغ"))}</option>
            </select>
            <input type="text" id="project-edit-discount" name="project-discount" class="form-control project-edit-input-xs" value="${y(f)}" placeholder="0" inputmode="decimal">
          </div>
        </div>
        <div class="col-sm-6 col-lg-4 col-xl-3">
          <label class="form-label d-block" for="project-edit-company-share">${y(c("projects.form.labels.companyShare","نسبة الشركة والضريبة"))}</label>
          <div class="d-flex flex-column gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-company-share" name="project-company-share" data-company-share="${y(String(h))}" ${v?"checked":""}>
              <label class="form-check-label" for="project-edit-company-share">${y(c("projects.form.companyShareToggle","إضافة نسبة الشركة (10٪)"))}</label>
            </div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-tax" name="project-apply-tax" ${l?"checked":""}>
              <label class="form-check-label" for="project-edit-tax">${y(c("projects.form.taxLabel","شامل الضريبة (15٪)"))}</label>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-4 col-xl-3">
          <label class="form-label" for="project-edit-payment-progress-value">${y(c("projects.form.paymentProgress.label","💰 الدفعة المستلمة"))}</label>
          <div class="input-group project-edit-input-group">
            <select id="project-edit-payment-progress-type" name="project-payment-progress-type" class="form-select project-edit-select-xs">
              <option value="amount" >${y(c("projects.form.paymentProgress.amount","💵 مبلغ"))}</option>
              <option value="percent" selected>${y(c("projects.form.paymentProgress.percent","٪ نسبة"))}</option>
            </select>
            <input type="text" id="project-edit-payment-progress-value" name="project-payment-progress-value" class="form-control project-edit-input-xs" value="${y("")}" placeholder="0" inputmode="decimal">
          </div>
          <button type="button" class="modal-action-btn modal-action-btn--ghost project-edit-add-btn mt-2" id="project-edit-payment-add">${y(c("reservations.paymentHistory.actions.add","➕ إضافة دفعة"))}</button>
        </div>
      </div>

      <section class="project-edit-payment-history mt-4">
        <div id="project-edit-payment-summary" class="project-details-grid mb-3"></div>
        <div class="reservation-payment-history-block">
          <div class="reservation-payment-history__header">
            <h6 class="reservation-payment-history__title">${y(c("reservations.paymentHistory.title","سجل الدفعات"))}</h6>
          </div>
          <div id="project-edit-payment-history" class="reservation-payment-history"></div>
        </div>
      </section>

      <section class="project-edit-expenses mt-4">
        <h6 class="mb-2">${y(c("projects.form.labels.expenses","متطلبات المشروع"))}</h6>
        <div class="project-edit-expense-form">
          <div class="project-edit-expense-label-col">
            <input type="text" class="form-control project-edit-input-wide" id="project-edit-expense-label" placeholder="${y(c("projects.form.placeholders.expenseLabel","وصف المتطلب"))}">
          </div>
          <div class="project-edit-expense-amount-col">
            <input type="text" class="form-control project-edit-input-xs" id="project-edit-expense-amount" placeholder="${y(c("projects.form.placeholders.expenseAmount","المبلغ"))}" inputmode="decimal">
          </div>
          <div class="project-edit-expense-action-col">
            <button type="button" class="modal-action-btn modal-action-btn--warning project-edit-add-btn" data-action="add-expense">${y(c("projects.form.buttons.addExpense","➕ إضافة مصروف"))}</button>
          </div>
        </div>
        <div id="project-edit-expense-list" class="project-edit-expense-list mt-3">
          ${Hi(t.expenses)}
        </div>
      </section>

      <div class="project-edit-actions mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">${y(c("projects.form.buttons.update","تحديث المشروع"))}</button>
        <button type="button" class="btn btn-outline-secondary" data-action="cancel-edit">${y(c("actions.cancel","إلغاء"))}</button>
      </div>
    </form>
  `}function Io(e){return["commercial","coverage","photography","social"].map(n=>{const a=Ui(n),i=n===e?"selected":"";return`<option value="${y(n)}" ${i}>${y(a)}</option>`}).join("")}function Hi(e=[]){if(!Array.isArray(e)||e.length===0)return`<div class="text-muted small" data-empty>${y(c("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const t=y(c("actions.remove","إزالة"));return e.map(n=>{const a=y(n?.label||""),i=y(G(n?.amount||0)),s=y(String(n?.id||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${i}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${s}" aria-label="${t}">✖</button>
        </div>
      `}).join("")}function No(e=[]){return!Array.isArray(e)||e.length===0?`<div class="reservation-payment-history-empty">${y(c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة"))}</div>`:`<ul class="reservation-payment-history-list">${e.map(t=>{const n=t?.type==="percent"?c("reservations.paymentHistory.type.percent","دفعة نسبة"):t?.type==="amount"?c("reservations.paymentHistory.type.amount","دفعة مالية"):c("reservations.paymentHistory.type.unknown","دفعة"),a=Number.isFinite(Number(t?.amount))&&Number(t.amount)>0?y(G(Number(t.amount))):"—",i=Number.isFinite(Number(t?.percentage))&&Number(t.percentage)>0?`${g(Number(t.percentage).toFixed(2))}%`:"—",s=t?.recordedAt?g(Ne(t.recordedAt)):"—",l=t?.note?`<div class="payment-history-note">${y(g(t.note))}</div>`:"";return`
      <li>
        <div class="payment-history-entry">
          <span class="payment-history-entry__type">${y(n)}</span>
          <span class="payment-history-entry__amount">${a}</span>
          <span class="payment-history-entry__percent">${i}</span>
          <span class="payment-history-entry__date">${s}</span>
        </div>
        ${l}
      </li>
    `}).join("")}</ul>`}function Eo(e=[]){if(!Array.isArray(e)||e.length===0)return`<div class="reservation-payment-history__empty">${y(c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة"))}</div>`;const t=e.map((n,a)=>{const i=n?.type==="percent"?c("reservations.paymentHistory.type.percent","دفعة نسبة"):c("reservations.paymentHistory.type.amount","دفعة مالية"),s=Number.isFinite(Number(n?.amount))&&Number(n.amount)>0?y(G(Number(n.amount))):"—",l=Number.isFinite(Number(n?.percentage))&&Number(n.percentage)>0?`${g(Number(n.percentage).toFixed(2))}%`:"—",r=n?.recordedAt?g(Ne(n.recordedAt)):"—",d=n?.note?y(g(n.note)):"",u=y(c("reservations.paymentHistory.actions.delete","حذف الدفعة"));return`
      <tr>
        <td>${y(i)}</td>
        <td>${s}</td>
        <td>${l}</td>
        <td>${r}</td>
        <td>${d}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${a}" aria-label="${u}">🗑️</button>
        </td>
      </tr>
    `}).join("");return`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${y(c("reservations.paymentHistory.headers.method","نوع الدفعة"))}</th>
            <th>${y(c("reservations.paymentHistory.headers.amount","المبلغ"))}</th>
            <th>${y(c("reservations.paymentHistory.headers.percent","النسبة"))}</th>
            <th>${y(c("reservations.paymentHistory.headers.date","التاريخ"))}</th>
            <th>${y(c("reservations.paymentHistory.headers.note","ملاحظات"))}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${t}</tbody>
      </table>
    </div>
  `}function _o(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(wo).filter(Boolean);if(n.length>0)return n;const a=Ot(e.paidPercent??e.paid_percent),i=Ot(e.paidAmount??e.paid_amount),s=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,l=Oi(s);return a!=null&&a>0?[{type:"percent",amount:i!=null&&i>0?i:null,percentage:a,value:a,note:null,recordedAt:l}]:i!=null&&i>0?[{type:"amount",amount:i,percentage:null,value:i,note:null,recordedAt:l}]:[]}function wo(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.toLowerCase().trim():null;n!=="percent"&&(n="amount");const a=Ot(e.amount??(n==="amount"?e.value:null)),i=Ot(e.percentage??(n==="percent"?e.value:null)),s=n==="percent"?i??null:a??null,l=e.note??e.memo??null,r=Oi(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&i==null?null:{type:n,amount:a??null,percentage:i??null,value:s,note:l&&String(l).trim().length?String(l).trim():null,recordedAt:r}}function Ot(e){if(e==null||e==="")return null;const t=g(String(e)).replace(/%/g,"").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function Oi(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function qa(e,t){if(!t)return null;const{date:n,time:a}=xo(Ne(t)),i=e==="start",s=i?"⏱️":"⌛",l=i?c("projects.details.labels.start","بداية الحجز"):c("projects.details.labels.end","نهاية الحجز");return{icon:s,label:l,value:n,meta:a}}function xo(e){if(!e||e==="—")return{date:"—",time:""};const t=e.split(" ").filter(Boolean),n=t.shift()||"—",a=t.join(" ");return{date:n,time:a}}function Ui(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function Co(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(g(String(n)))||0,i=e.discountType||"percent",s=Array.isArray(e.crewAssignments)?e.crewAssignments:[],l=s.length?s:Array.isArray(e.technicians)?e.technicians:[],r=gi(t,a,i,!1,l,{start:e.start,end:e.end});if(Number.isFinite(r))return r;const d=Number(g(String(e.cost??0)));return Number.isFinite(d)?Math.round(d):0}function Wi(e){if(typeof window>"u")return null;try{const a=new URLSearchParams(window.location.search||"").get(e);if(a)return a}catch{}const t=window.location.hash?window.location.hash.replace(/^#/,""):"";if(t&&t.includes(`${e}=`))try{const a=new URLSearchParams(t).get(e);if(a)return a}catch{}return null}function $o(){return Wi(wn)}function Lo(){return Wi(xn)}function Bo(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const e=new URLSearchParams(window.location.search||""),t=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[wn,xn].forEach(d=>{e.has(d)&&(e.delete(d),n=!0)});let a=t,i=!1;if(t)try{const d=new URLSearchParams(t);let u=!1;[wn,xn].forEach(f=>{d.has(f)&&(d.delete(f),u=!0)}),u&&(a=d.toString(),i=!0)}catch{}if(!n&&!i)return;const s=window.location.pathname,l=e.toString(),r=`${s}${l?`?${l}`:""}${a?`#${a}`:""}`;window.history.replaceState({},"",r)}catch{}}function Fo(){const e=$o(),t=Lo();e&&(b.pendingProjectDetailId=e),t&&(b.pendingProjectEditId=t,b.pendingProjectDetailId||(b.pendingProjectDetailId=t)),(e||t)&&Bo()}function ko(){if(!b.pendingProjectDetailId)return;const e=b.pendingProjectDetailId,t=String(e),n=b.projects.find(i=>[i?.id,i?.projectId,i?.project_id].some(l=>l!=null&&String(l)===t));if(!n)return;b.pendingProjectDetailId=null;const a=n?.id??n?.projectId??n?.project_id??t;if(Ue(a),b.pendingProjectEditId!=null){const i=String(b.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(l=>l!=null&&String(l)===i)&&(b.pendingProjectEditId=null,setTimeout(()=>zi(n),0))}}function rc(){document.addEventListener("DOMContentLoaded",()=>{bo(),Fo(),Ar(),cn(),Tr(),mo(),fo(),Ir(),Dr(),qr(),Rr(),Vr(),no(),zr({onViewDetails:Ue}),go({onOpenProject:Ue}),Ni(),Do()}),document.addEventListener("language:changed",Ra),document.addEventListener("language:translationsReady",Ra),document.addEventListener("customers:changed",qo),document.addEventListener("technicians:updated",Ro),document.addEventListener("reservations:changed",()=>Ur(Ue)),document.addEventListener(za.USER_UPDATED,()=>{be()})}async function Do(){try{await dr({suppressError:!0}),await en()}catch(e){console.error("❌ [projects] Failed to initialise projects data",e);const t=e?.message||c("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");j(t,"error")}finally{gr(),an(),to(),De(),be(),Le(),$e(),ko()}}function Ra(){an(),De(),be(),Le(),$e(),cn()}function qo(){Hr(),an()}function Ro(){Or(),an()}export{Ho as $,Ce as A,Qa as B,ir as C,ye as D,Et as E,rr as F,Ks as G,Zo as H,Qo as I,pr as J,ec as K,ac as L,ic as M,Jo as N,dr as O,Zt as P,Wt as Q,Oo as R,Wo as S,gt as T,kr as U,$i as V,ta as W,tn as X,Mt as Y,nn as Z,si as _,Go as a,Me as a0,Uo as a1,rc as a2,Ct as a3,en as a4,ct as a5,zo as a6,sc as a7,Vt as b,Xn as c,Yo as d,He as e,Ko as f,st as g,Qt as h,nc as i,Fs as j,Ws as k,sr as l,Kt as m,Fe as n,Qs as o,ie as p,Ls as q,yi as r,se as s,Bs as t,Zs as u,Js as v,gi as w,Yn as x,Xo as y,tc as z};
