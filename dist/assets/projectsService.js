import{e as D,n as E,h as Bt,t as l,b as N,j as g,k as J,o as me,s as pe,A as Ce}from"./auth.js";const Ve="select.form-select:not([data-no-enhance]):not([multiple])",k=new WeakMap;let Ue=null,bt=!1,w=null;function _a(e=document){e&&(e.querySelectorAll(Ve).forEach(t=>qe(t)),!Ue&&e===document&&(Ue=new MutationObserver(t=>{for(const n of t)n.addedNodes?.forEach(a=>{a instanceof Element&&(a.matches?.(Ve)&&qe(a),a.querySelectorAll?.(Ve).forEach(i=>qe(i)))})}),Ue.observe(document.body,{childList:!0,subtree:!0})),bt||(bt=!0,document.addEventListener("pointerdown",un,{capture:!0})))}function Se(e){if(!(e instanceof HTMLSelectElement))return;if(!e.dataset.enhancedSelect){qe(e);return}const t=e.closest(".enhanced-select");t&&(Ye(t),_e(t),We(t))}function qe(e){if(!(e instanceof HTMLSelectElement))return;if(e.dataset.enhancedSelect){Se(e);return}if(e.multiple||e.size>1)return;const t=document.createElement("div");t.className="enhanced-select";const n=e.parentNode;n&&n.insertBefore(t,e),t.appendChild(e),e.dataset.enhancedSelect="true",e.classList.add("enhanced-select__native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const a=document.createElement("button");a.type="button",a.className="enhanced-select__trigger",a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const i=document.createElement("ul");i.className="enhanced-select__menu",i.setAttribute("role","listbox"),i.setAttribute("tabindex","-1"),t.append(a,i);const s={select:e,trigger:a,menu:i,observer:null,refreshRaf:null};k.set(t,s),a.addEventListener("click",()=>on(t)),a.addEventListener("keydown",r=>ln(r,t)),i.addEventListener("click",r=>mn(r,t)),i.addEventListener("keydown",r=>dn(r,t)),e.addEventListener("change",()=>{_e(t),xt(t)}),s.observer=new MutationObserver(r=>{let o=!1,c=!1;for(const u of r)u.type==="attributes"&&u.attributeName==="disabled"&&(c=!0),u.type==="childList"&&(o=!0);c&&We(t),o&&cn(s,t)}),s.observer.observe(e,{attributes:!0,attributeFilter:["disabled"],childList:!0}),Ye(t),_e(t),We(t)}function cn(e,t){e&&(e.refreshRaf||(e.refreshRaf=requestAnimationFrame(()=>{e.refreshRaf=null,Ye(t),_e(t)})))}function Ye(e){const t=k.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const i=Array.from(n.options||[]),s=document.createDocumentFragment();i.forEach(r=>{const o=document.createElement("li");o.className="enhanced-select__option",o.textContent=r.textContent??r.value??"",o.dataset.value=r.value??"",o.setAttribute("role","option"),o.setAttribute("tabindex","-1"),r.disabled&&(o.setAttribute("aria-disabled","true"),o.classList.add("is-disabled")),r.selected&&(o.setAttribute("aria-selected","true"),o.dataset.selected="true",o.setAttribute("tabindex","0")),s.appendChild(o)}),a.innerHTML="",a.appendChild(s),xt(e)}function _e(e){const t=k.get(e);if(!t)return;const{select:n,trigger:a}=t;if(!n||!a)return;const i=n.selectedOptions?.[0]??n.options?.[n.selectedIndex],s=i?.textContent?.trim()||i?.value||"";a.textContent=s}function xt(e){const t=k.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const i=n.value;a.querySelectorAll(".enhanced-select__option").forEach(r=>{const o=r.dataset.value===i;r.toggleAttribute("aria-selected",o),r.dataset.selected=o?"true":"",r.setAttribute("tabindex",o?"0":"-1")})}function We(e){const t=k.get(e);if(!t)return;const{select:n,trigger:a}=t,i=!!n?.disabled;e.classList.toggle("enhanced-select--disabled",i),a.disabled=i}function on(e){k.get(e)&&(e.getAttribute("data-open")==="true"?ie(e):Ct(e))}function Ct(e){const t=k.get(e);if(!t)return;w&&w!==e&&ie(w,{focusTrigger:!1}),e.setAttribute("data-open","true"),t.trigger.setAttribute("aria-expanded","true"),w=e;const n=t.menu.querySelector('.enhanced-select__option[aria-selected="true"]')??t.menu.querySelector(".enhanced-select__option:not([aria-disabled='true'])");n?n.focus():t.menu.focus()}function ie(e,{focusTrigger:t=!0}={}){const n=k.get(e);n&&(e.setAttribute("data-open","false"),n.trigger.setAttribute("aria-expanded","false"),t&&n.trigger.focus({preventScroll:!0}),w===e&&(w=null))}function un(e){if(!w)return;const t=e.target;t instanceof Node&&(w.contains(t)||ie(w,{focusTrigger:!1}))}function ln(e,t){const n=e.key;n==="ArrowDown"||n==="ArrowUp"||n===" "||n==="Enter"?(e.preventDefault(),Ct(t)):n==="Escape"&&ie(t)}function dn(e,t){const n=e.key,a=k.get(t);if(!a)return;const i=Array.from(a.menu.querySelectorAll(".enhanced-select__option:not([aria-disabled='true'])"));if(!i.length)return;const s=i.findIndex(r=>r===document.activeElement);if(n==="ArrowDown"||n==="ArrowUp"){e.preventDefault();const o=(s+(n==="ArrowDown"?1:-1)+i.length)%i.length;i[o].focus()}else if(n==="Home")e.preventDefault(),i[0].focus();else if(n==="End")e.preventDefault(),i[i.length-1].focus();else if(n==="Enter"||n===" "){e.preventDefault();const r=document.activeElement;r&&r.classList.contains("enhanced-select__option")&&$t(r,t)}else n==="Escape"&&(e.preventDefault(),ie(t))}function mn(e,t){const n=e.target?.closest?.(".enhanced-select__option");n&&$t(n,t)}function $t(e,t){const n=k.get(t);if(!n||e.getAttribute("aria-disabled")==="true")return;const{select:a}=n,i=e.dataset.value??"";a.value!==i&&(a.value=i,a.dispatchEvent(new Event("change",{bubbles:!0}))),ie(t)}const pn=D()||{};let O=(pn.equipment||[]).map(gn),Ke=!1,ue="",U=null,Q=null,Y=null,$e=!1;function fn(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function yn(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function gn(e={}){return Ge({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function Fe(e={}){return Ge(e)}function Ge(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",i=e.subcategory??e.sub??"",s=De(e.quantity??e.qty??0),r=Pe(e.unit_price??e.price??0),o=E(String(e.barcode??"").trim()),c=C(e.status??e.state??e.status_label??e.statusLabel??"available"),u=e.image_url??e.imageUrl??e.image??"",m=e.name??e.item_name??n;return{id:hn(t)?String(t):"",category:a,sub:i,desc:n,name:m,qty:s,price:r,barcode:o,status:c,image:u,imageUrl:u,created_at:e.created_at??null,updated_at:e.updated_at??null}}function hn(e){return e!=null&&e!==""}function De(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function Pe(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function R(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function C(e){switch(String(e??"").trim().toLowerCase()){case"available":case"ŸÖÿ™ÿßÿ≠":case"ŸÖÿ™ŸàŸÅÿ±":return"available";case"reserved":case"ŸÖÿ≠ÿ¨Ÿàÿ≤":return"reserved";case"maintenance":case"ÿµŸäÿßŸÜÿ©":return"maintenance";case"retired":case"ŸÖÿ™ŸàŸÇŸÅ":case"ÿÆÿßÿ±ÿ¨ ÿßŸÑÿÆÿØŸÖÿ©":return"retired";default:return"available"}}function bn(e){return C(e)}function x(){return O}function G(e){O=Array.isArray(e)?e.map(Ge):[],pe({equipment:O}),yn()}function vt(e){return String(e??"").trim().toLowerCase()}function V(e){if(!e)return"";const t=e.desc||e.description||e.name||"";let n=vt(t);return n||(n=vt(e.category||"")),n||(n=E(String(e.barcode||"")).trim().toLowerCase()),n}function Me(e){const t=V(e);return t?x().filter(n=>V(n)===t):[]}function ke(e){const t=document.getElementById("equipment-details-cover");if(!t)return;const n=je(e);if(n){const a=R(e.desc||e.description||e.name||"");t.innerHTML=`<img src="${R(n)}" alt="${a}">`,t.classList.add("has-image")}else t.innerHTML='<span class="equipment-details-header__placeholder" aria-hidden="true">üì¶</span>',t.classList.remove("has-image")}function Je(){return{category:document.getElementById("edit-equipment-category"),subcategory:document.getElementById("edit-equipment-subcategory"),description:document.getElementById("edit-equipment-description"),quantity:document.getElementById("edit-equipment-quantity"),price:document.getElementById("edit-equipment-price"),image:document.getElementById("edit-equipment-image"),barcode:document.getElementById("edit-equipment-barcode"),status:document.getElementById("edit-equipment-status")}}function Ie(){const e=Je();return{category:e.category?.value??"",subcategory:e.subcategory?.value??"",description:e.description?.value??"",quantity:e.quantity?.value??"",price:e.price?.value??"",image:e.image?.value??"",barcode:e.barcode?.value??"",status:e.status?.value??""}}function Ze(e={}){const t=Je();t.category&&(t.category.value=e.category??""),t.subcategory&&(t.subcategory.value=e.subcategory??""),t.description&&(t.description.value=e.description??""),t.quantity&&(t.quantity.value=e.quantity!=null?E(String(e.quantity)):""),t.price&&(t.price.value=e.price!=null?E(String(e.price)):""),t.image&&(t.image.value=e.image??""),t.barcode&&(t.barcode.value=e.barcode??""),t.status&&(t.status.value=e.status??"")}function Z(e){$e=e;const t=Je(),n=document.getElementById("equipment-edit-cancel"),a=document.getElementById("save-equipment-changes");if([t.category,t.subcategory,t.description,t.quantity,t.price,t.image].forEach(s=>{s&&(e?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"))}),n&&(n.hidden=!e,n.disabled=!e),a){a.disabled=!1;const s=e?"equipment.modal.actions.save":"equipment.modal.actions.edit",r=e?"üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™":"‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ";a.textContent=l(s,r),a.dataset.mode=e?"save":"view"}if(e){const s=t.description||t.category||t.subcategory;s&&setTimeout(()=>{s.focus(),typeof s.select=="function"&&s.select()},0)}}async function Ia(e){if(!J()){me();return}if(!e)return;try{await Sn()}catch(n){console.error("‚ùå [equipment.js] Unable to load XLSX",n),alert(l("equipment.toast.xlsxMissing","‚ö†Ô∏è ŸÖŸÉÿ™ÿ®ÿ© Excel (XLSX) ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),i=XLSX.read(a,{type:"array"}),s=i.Sheets[i.SheetNames[0]],r=XLSX.utils.sheet_to_json(s,{defval:""});if(!Array.isArray(r)||r.length===0){g(l("equipment.toast.uploadEmpty","‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ"));return}const o=[];let c=0;if(r.forEach(u=>{const m=u.ÿßŸÑŸÇÿ≥ŸÖ??u.category??"",d=u["ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸàŸä"]??u.subcategory??"",y=u.ÿßŸÑŸàÿµŸÅ??u.description??u.name??"",f=u.ÿßŸÑŸÉŸÖŸäÿ©??u.quantity??0,b=u.ÿßŸÑÿ≥ÿπÿ±??u.price??0,p=u.ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ??u.barcode??"",h=u.ÿßŸÑÿ≠ÿßŸÑÿ©??u.status??"ŸÖÿ™ÿßÿ≠",v=u.ÿßŸÑÿµŸàÿ±ÿ©??u.image_url??u.image??"",I=E(String(p||"")).trim();if(!y||!I){c+=1;return}o.push(et({category:m,subcategory:d,description:y,quantity:f,unit_price:b,barcode:I,status:h,image_url:v}))}),!o.length){g(l("equipment.toast.uploadEmpty","‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ"));return}try{const u=await N("/equipment/?bulk=1",{method:"POST",body:o}),m=Array.isArray(u?.data)?u.data.map(Fe):[];if(m.length){const f=[...x(),...m];G(f)}await Re({showToastOnError:!1}),F();const d=u?.meta?.count??m.length,y=[];d&&y.push(`${d} ‚úîÔ∏è`),c&&y.push(`${c} ‚ö†Ô∏è`),g(l("equipment.toast.uploadSuccess","‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖÿπÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠")+(y.length?` (${y.join(" / ")})`:""))}catch(u){const m=se(u,"equipment.toast.uploadFailed","‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ ÿßŸÑÿ•ŸÉÿ≥ŸÑ");g(m,"error")}}catch(a){console.error("‚ùå [equipment.js] Failed to process Excel file",a),g(l("equipment.toast.uploadFailed","‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ ÿßŸÑÿ•ŸÉÿ≥ŸÑ"),"error")}},t.onerror=function(){console.error("‚ùå [equipment.js] FileReader error",t.error),g(l("equipment.toast.uploadFailed","‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ ÿßŸÑÿ•ŸÉÿ≥ŸÑ"),"error")},t.readAsArrayBuffer(e)}const vn="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let oe=null;function Sn(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):oe||(oe=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",i,{once:!0}),n.addEventListener("error",s,{once:!0});return}const a=document.createElement("script");a.src=vn,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",i,{once:!0}),a.addEventListener("error",s,{once:!0}),document.head.appendChild(a);function i(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function s(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("‚ö†Ô∏è [equipment.js] ensureXLSXLoaded failed",e),oe=null,e}),oe)}function et({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:i=0,barcode:s="",status:r="ŸÖÿ™ÿßÿ≠",image_url:o=""}){const c=E(String(s||"")).trim(),u=bn(r);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:De(a),unit_price:Pe(i),barcode:c,status:u,image_url:o?.trim()||null}}async function qn(){if(!J()){me();return}if(confirm(l("equipment.toast.clearConfirm","‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿßŸÑŸÖÿπÿØÿßÿ™ÿü")))try{const t=(await N("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await Re({showToastOnError:!1}),g(l("equipment.toast.clearSuccess","üóëÔ∏è ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿπÿØÿßÿ™")+(t?` (${t})`:""))}catch(e){const t=se(e,"equipment.toast.clearFailed","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿ®ÿπÿ∂ ÿßŸÑŸÖÿπÿØÿßÿ™");g(t,"error")}}function je(e){return e.image||e.imageUrl||e.img||""}function Ft(e){const t=C(e),n={available:{label:l("equipment.form.options.available","‚úÖ ŸÖÿ™ÿßÿ≠"),className:"equipment-status-badge equipment-status-badge--available"},reserved:{label:l("equipment.form.options.booked","üìå ŸÖÿ≠ÿ¨Ÿàÿ≤"),className:"equipment-status-badge equipment-status-badge--reserved"},maintenance:{label:l("equipment.form.options.maintenance","üõ†Ô∏è ÿµŸäÿßŸÜÿ©"),className:"equipment-status-badge equipment-status-badge--maintenance"},retired:{label:l("equipment.form.options.retired","üì¶ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿÆÿØŸÖÿ©"),className:"equipment-status-badge equipment-status-badge--retired"}},{label:a,className:i}=n[t]||{label:e||"-",className:"equipment-status-badge equipment-status-badge--default"};return`<span class="${i}">${a}</span>`}function Ae(){const e=document.getElementById("equipment-variants-section"),t=document.getElementById("equipment-variants-table-body"),n=document.getElementById("equipment-variants-count");if(e&&(e.hidden=!0),t){const a=l("equipment.modal.variants.empty","ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇÿ∑ÿπ ŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ£ÿÆÿ±Ÿâ.");t.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${R(a)}</td></tr>`}n&&(n.textContent="0")}function Dt(e){const t=document.getElementById("equipment-variants-section"),n=document.getElementById("equipment-variants-table-body"),a=document.getElementById("equipment-variants-count");if(!t||!n||!e)return;const s=U?.groupKey||V(e);if(!s){Ae();return}const r=x().filter(d=>V(d)===s).sort((d,y)=>{const f=String(d.barcode||"").trim(),b=String(y.barcode||"").trim();return!f&&!b?0:f?b?f.localeCompare(b,"ar",{numeric:!0,sensitivity:"base"}):-1:1});if(!r.length){Ae();return}t.hidden=!1,a&&(a.textContent=String(r.length));const o=l("equipment.modal.variants.current","ÿßŸÑÿ≠ÿßŸÑŸä"),c=l("equipment.form.labels.quantity","ÿßŸÑŸÉŸÖŸäÿ©"),u=x(),m=r.map(d=>{const y=d.id&&e.id?String(d.id)===String(e.id):String(d.barcode||"")===String(e.barcode||""),f=y?"equipment-variants-table__row--current":"",b=R(String(d.barcode||"-")),p=y?`<span class="equipment-variants-current-badge">${R(o)}</span>`:"",h=E(String(Number.isFinite(Number(d.qty))?Number(d.qty):0)),v=u.indexOf(d),I=R(l("equipment.item.actions.edit","‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ")),q=R(l("equipment.item.actions.delete","üóëÔ∏è ÿ≠ÿ∞ŸÅ")),A=v>=0?`<div class="equipment-variant-actions">
            <button type="button" class="btn btn-sm btn-primary equipment-variant-action" data-variant-action="edit" data-variant-index="${v}">${I}</button>
            <button type="button" class="btn btn-sm btn-error equipment-variant-action equipment-variant-action--danger" data-variant-action="delete" data-variant-index="${v}">${q}</button>
          </div>`:"";return`
        <tr class="${f}">
          <td>
            ${b}
            ${p}
          </td>
          <td>${Ft(d.status)}</td>
          <td>
            <span class="equipment-variants-qty" title="${R(c)}">${h}</span>
          </td>
          <td>${A}</td>
        </tr>
      `}).join("");n.innerHTML=m}function En({item:e,index:t}){const n=je(e),a=l("equipment.item.actions.delete","üóëÔ∏è ÿ≠ÿ∞ŸÅ"),i=l("equipment.item.imageAlt","ÿµŸàÿ±ÿ©"),s=l("equipment.item.currency","ÿ±ŸäÿßŸÑ"),r=J(),o={description:l("equipment.card.labels.description","ÿßŸÑŸàÿµŸÅ"),status:l("equipment.card.labels.status","ÿßŸÑÿ≠ÿßŸÑÿ©"),alias:l("equipment.card.labels.alias","ÿßŸÑÿßÿ≥ŸÖ"),quantity:l("equipment.card.labels.quantity","ÿßŸÑŸÉŸÖŸäÿ©"),price:l("equipment.card.labels.price","ÿßŸÑÿ≥ÿπÿ±"),category:l("equipment.card.labels.category","ÿßŸÑŸÇÿ≥ŸÖ"),subcategory:l("equipment.card.labels.subcategory","ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸàŸä"),barcode:l("equipment.card.labels.barcode","ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ")},c=Number.isFinite(Number(e.qty))?Number(e.qty):0,u=Number.isFinite(Number(e.price))?Number(e.price):0,m=c.toLocaleString("en-US"),d=u.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),y=e.desc||e.name||"‚Äî",f=e.name&&e.name!==e.desc?e.name:"",p=`
    <div class="equipment-card__info-row equipment-card__info-row--center">
      ${[{label:o.quantity,value:m},{label:o.price,value:`${d} ${s}`}].map(({label:L,value:P})=>`
            <span class="equipment-card__info-item equipment-card__info-item--stacked">
              <span class="equipment-card__detail-label">${L}</span>
              <span class="equipment-card__detail-value">${P}</span>
            </span>
          `).join("")}
    </div>`,h=[e.category?{label:o.category,value:e.category}:null,e.sub?{label:o.subcategory,value:e.sub}:null].filter(Boolean),v=h.length?`<div class="equipment-card__categories">${h.map(({label:L,value:P})=>`
            <div class="equipment-card__category">
              <span class="equipment-card__detail-label">${L}</span>
              <span class="equipment-card__detail-value">${P}</span>
            </div>
          `).join("")}</div>`:"",I=f?`<div class="equipment-card__alias">
        <span class="equipment-card__detail-label">${o.alias}</span>
        <span class="equipment-card__detail-value">${f}</span>
      </div>`:"",A=`
    <div class="equipment-card__details">
      ${`
    <div class="equipment-card__description">
      <span class="equipment-card__label">${o.description}</span>
      <h3 class="equipment-card__title">${y}</h3>
    </div>
  `}
      ${p}
    </div>
  `,S=[];r&&S.push(`<button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--delete" data-equipment-action="delete" data-equipment-index="${t}">${a}</button>`);const _=S.length?`<div class="equipment-card__actions equipment-card__actions--center">${S.join(`
`)}</div>`:"",T=R(y);return`
    <article
      class="equipment-card"
      data-equipment-index="${t}"
      data-equipment-card="true"
      role="listitem"
      tabindex="0"
      aria-label="${T}"
    >
      <div class="equipment-card__header">
        <div class="equipment-card__status-block">
          <span class="equipment-card__label equipment-card__label--status">${o.status}</span>
          ${Ft(e.status)}
        </div>
        <div class="equipment-card__media-wrapper">
          <div class="equipment-card__media" aria-hidden="true">
            ${n?`<img src="${n}" alt="${i}" loading="lazy">`:'<div class="equipment-card__placeholder">üì¶</div>'}
          </div>
          ${A}
        </div>
      </div>
      <div class="equipment-card__body">
        ${v}
        ${I}
      </div>
      ${_}
    </article>
  `}function _n(e){const t=[...new Set(e.map(r=>r.category).filter(Boolean))],n=[...new Set(e.map(r=>r.sub).filter(Boolean))],a=document.getElementById("filter-category"),i=document.getElementById("filter-sub");if(a){const r=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(o=>{const c=document.createElement("option");c.value=o,c.textContent=o,a.appendChild(c)}),t.includes(r)&&(a.value=r),Se(a)}if(i){const r=i.value;for(;i.options.length>1;)i.remove(1);n.forEach(o=>{const c=document.createElement("option");c.value=o,c.textContent=o,i.appendChild(c)}),n.includes(r)&&(i.value=r),Se(i)}const s=document.getElementById("filter-status");s&&Se(s)}function Pt(){const e=D();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return O=t||[],O;const i=new Date;let s=!1;const r=new Set((a||[]).filter(c=>c?.status==="open").map(c=>E(String(c?.equipmentBarcode??"")).trim().toLowerCase())),o=t.map(c=>{if(!c)return c;const u=C(c.status),m=E(String(c.barcode??"")).trim().toLowerCase(),d=m&&r.has(m);let y=d?"maintenance":u;if(!d&&m)for(const f of n||[]){if(!In(f,i))continue;if(f.items?.some(p=>E(String(p?.barcode??"")).trim().toLowerCase()===m)){y="reserved";break}}return y!==u?(s=!0,{...c,status:y}):{...c,status:u}});return s?G(o):(O=o,pe({equipment:O})),O}function In(e,t){if(!e?.start||!e?.end)return!1;const n=new Date(e.start),a=new Date(e.end);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?!1:n<=t&&t<a}function Xe(e,{tone:t="",icon:n="üì¶"}={}){const a=["equipment-empty-state"];return t&&a.push(`equipment-empty-state--${t}`),`
    <div class="${a.join(" ")}">
      <div class="equipment-empty-state__icon" aria-hidden="true">${n}</div>
      <p class="equipment-empty-state__text">${e}</p>
    </div>
  `}function F(){const e=document.getElementById("equipment-list");if(!e)return;const t=Pt(),n=Array.isArray(t)?t:x(),a=new Map;n.forEach(p=>{if(!p)return;const h=V(p);h&&(a.has(h)||a.set(h,[]),a.get(h).push(p))});const i=Array.from(a.values()).map(p=>{const h=p[0],v=p.reduce((S,_)=>S+(Number.isFinite(Number(_.qty))?Number(_.qty):0),0),I=["maintenance","reserved","available","retired"],q=p.map(S=>C(S.status)).sort((S,_)=>I.indexOf(S)-I.indexOf(_))[0]||"available";return{item:{...h,qty:v,status:q,variants:p,groupKey:V(h)},index:n.indexOf(h)}}),s=document.getElementById("search-equipment")?.value||"",r=E(s).toLowerCase().trim(),o=document.getElementById("filter-category")?.value||"",c=document.getElementById("filter-sub")?.value||"",u=document.getElementById("filter-status")?.value||"",m=u?C(u):"";if(Ke&&!n.length){e.innerHTML=Xe(l("equipment.list.loading","‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿπÿØÿßÿ™..."),{icon:"‚è≥"});return}if(ue&&!n.length){e.innerHTML=Xe(ue,{tone:"error",icon:"‚ö†Ô∏è"});return}const d=i.filter(({item:p})=>{const h=E(String(p.barcode??"")).toLowerCase().trim(),v=Array.isArray(p.variants)?p.variants.map(_=>E(String(_.barcode??"")).toLowerCase().trim()).filter(Boolean):[],I=!r||p.name&&p.name.toLowerCase().includes(r)||p.desc&&p.desc.toLowerCase().includes(r)||h&&h.includes(r)||v.some(_=>_.includes(r))||p.category&&p.category.toLowerCase().includes(r)||p.sub&&p.sub.toLowerCase().includes(r),q=!o||p.category===o,A=!c||p.sub===c,S=!m||C(p.status)===m;return I&&q&&A&&S}),y=r?l("equipment.list.emptyFiltered","‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿØÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ©."):l("equipment.list.empty","ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿØÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ© ÿ®ÿπÿØ."),f=d;e.innerHTML=f.length?f.map(En).join(""):Xe(y);const b=document.getElementById("equipment-list-count");if(b){const p=l("equipment.list.countSuffix","ÿπŸÜÿµÿ±"),h=E(String(f.length)),v=f.length?`${h} ${p}`:`0 ${p}`;b.textContent=v}_n(n)}async function Re({showToastOnError:e=!0}={}){Ke=!0,ue="",F();try{const t=await N("/equipment/?all=1"),n=Array.isArray(t?.data)?t.data.map(Fe):[];G(n)}catch(t){ue=se(t,"equipment.toast.fetchFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿπÿØÿßÿ™"),e&&g(ue,"error")}finally{Ke=!1,F()}}function se(e,t,n){if(e instanceof Ce){const a=e.payload?.errors;if(a&&typeof a=="object"){const i=Object.values(a)[0];if(Array.isArray(i))return i[0];if(typeof i=="string")return i}if(e.message)return e.message}return l(t,n)}async function An(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",i=E(a).trim(),s=Pe(t.querySelector("#new-equipment-price")?.value||"0"),r=De(t.querySelector("#new-equipment-qty")?.value||"1"),o=t.querySelector("#new-equipment-image")?.value?.trim()||"",c=t.querySelector("#new-equipment-category")?.value?.trim()||"",u=t.querySelector("#new-equipment-sub")?.value?.trim()||"",m=t.querySelector("#new-equipment-status")?.value||"ŸÖÿ™ÿßÿ≠";if(!n||!i){g(l("equipment.toast.missingFields","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿµŸÅ ŸàÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ"));return}const d=et({category:c,subcategory:u,description:n,quantity:r,unit_price:s,barcode:i,status:m,image_url:o});try{const y=await N("/equipment/",{method:"POST",body:d}),f=Fe(y?.data),b=[...x(),f];G(b),F(),t.reset();const p=t.querySelector("#new-equipment-status");p&&(p.value="ŸÖÿ™ÿßÿ≠"),g(l("equipment.toast.addSuccess","‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿπÿØÿ©"))}catch(y){const f=se(y,"equipment.toast.addFailed","ÿ™ÿπÿ∞ÿ± ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿπÿØÿ©");g(f,"error")}}async function Mt(e){if(!J()){me();return}const t=x(),n=t[e];if(n&&confirm(l("equipment.toast.deleteConfirm","‚ùå ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπÿØÿ©ÿü")))try{n.id&&await N(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),G(a),F(),g(l("equipment.toast.deleteSuccess","üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿπÿØÿ©"))}catch(a){const i=se(a,"equipment.toast.deleteFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿπÿØÿ©ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ¨ÿØÿØÿßŸã");g(i,"error")}}async function Nn(e,t){const n=x(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const s=[...n];s[e]={...s[e],...t},G(s),F();return}const i=et({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image});try{const s=await N(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:i}),r=Fe(s?.data),o=[...n];o[e]=r,G(o),F(),g(l("equipment.toast.updateSuccess","‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠"))}catch(s){const r=se(s,"equipment.toast.updateFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπÿØÿ©");throw g(r,"error"),s}}function he(){F()}function tt(e){const n=x()[e];if(!n)return;Q=e;const a=Me(n),i=a[0]||n,s=a.reduce((c,u)=>c+(Number.isFinite(Number(u.qty))?Number(u.qty):0),0),r=["maintenance","reserved","available","retired"],o=a.map(c=>C(c.status)).sort((c,u)=>r.indexOf(c)-r.indexOf(u))[0]||C(i.status);document.getElementById("edit-equipment-index").value=e,Ze({category:i.category||"",subcategory:i.sub||"",description:i.desc||i.description||"",quantity:String(s||i.qty||0),price:i.price!=null?String(i.price):"0",image:je(i)||"",barcode:i.barcode||"",status:i.status||o}),Z(!1),Y=Ie(),ke(i),Dt(i),U={groupKey:V(i),barcode:String(i.barcode||""),id:i.id||null},fn(document.getElementById("editEquipmentModal"))?.show()}function Ln(e){const t=e.target.closest('[data-equipment-action="delete"]');if(t){e.preventDefault(),e.stopPropagation();const a=Number(t.dataset.equipmentIndex);Number.isNaN(a)||Mt(a).catch(i=>{console.error("‚ùå [equipment.js] deleteEquipment",i)});return}const n=e.target.closest('[data-equipment-card="true"]');if(n){const a=Number(n.dataset.equipmentIndex);Number.isNaN(a)||tt(a)}}function Tn(e){if(e.defaultPrevented||e.target.closest("[data-equipment-action]"))return;const t=e.target.closest('[data-equipment-card="true"]');if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const n=Number(t.dataset.equipmentIndex);Number.isNaN(n)||tt(n)}}function Bn(e){const t=e.target.closest('[data-variant-action="delete"]');if(t){const a=Number(t.dataset.variantIndex);Number.isNaN(a)||Mt(a).catch(i=>{console.error("‚ùå [equipment.js] deleteEquipment",i)});return}const n=e.target.closest('[data-variant-action="edit"]');if(n){const a=Number(n.dataset.variantIndex);Number.isNaN(a)||tt(a)}}function kt(){if(!U||!document.getElementById("editEquipmentModal")?.classList.contains("show"))return;const n=x(),a=U.id?n.find(c=>String(c.id)===String(U.id)):null,i=U.groupKey,s=i?n.find(c=>V(c)===i):null,r=a||s;if(!r){Ae();return}const o=n.findIndex(c=>c===r);if(o>=0){const c=document.getElementById("edit-equipment-index");c&&(c.value=String(o)),Q=o}if(Dt(r),!$e){const c=Me(r),u=c[0]||r,m=c.reduce((f,b)=>f+(Number.isFinite(Number(b.qty))?Number(b.qty):0),0),d=["maintenance","reserved","available","retired"],y=c.map(f=>C(f.status)).sort((f,b)=>d.indexOf(f)-d.indexOf(b))[0]||C(u.status);Ze({category:u.category||"",subcategory:u.sub||"",description:u.desc||u.description||"",quantity:String(m||u.qty||0),price:u.price!=null?String(u.price):"0",image:je(u)||"",barcode:u.barcode||"",status:u.status||y}),Y=Ie()}ke(primary)}function xn(){document.getElementById("search-equipment")?.addEventListener("input",he),document.getElementById("filter-category")?.addEventListener("change",he),document.getElementById("filter-sub")?.addEventListener("change",he),document.getElementById("filter-status")?.addEventListener("change",he),document.getElementById("add-equipment-form")?.addEventListener("submit",An);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",a=>{a.preventDefault(),qn().catch(i=>{console.error("‚ùå [equipment.js] clearEquipment",i)})}),e.dataset.listenerAttached="true");const t=document.getElementById("equipment-list");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",Ln),t.addEventListener("keydown",Tn),t.dataset.listenerAttached="true");const n=document.getElementById("equipment-variants-table-body");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Bn),n.dataset.listenerAttached="true")}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{if(!$e){Y=Ie(),Z(!0);return}const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){g(l("equipment.toast.updateFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπÿØÿ©"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:De(document.getElementById("edit-equipment-quantity").value)||1,price:Pe(document.getElementById("edit-equipment-price").value)||0,barcode:E(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value};try{await Nn(t,n),Y=Ie(),Z(!1),kt()}catch(a){console.error("‚ùå [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{xn(),F(),Re();const e=document.getElementById("equipment-edit-cancel");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{if(Y&&Ze(Y),Q!=null){const a=x()[Q];if(a){const s=Me(a)[0]||a;ke(s)}}Z(!1)}),e.dataset.listenerAttached="true");const t=document.getElementById("save-equipment-changes");t&&!t.dataset.listenerAttached&&(t.dataset.listenerAttached="true",t.dataset.mode||(t.dataset.mode="view"))});document.addEventListener("language:changed",()=>{if(F(),Z($e),Q!=null){const t=x()[Q];if(t){const a=Me(t)[0]||t;ke(a)}}});document.addEventListener("equipment:refreshRequested",()=>{Re({showToastOnError:!1})});document.addEventListener(Bt.USER_UPDATED,()=>{F()});document.addEventListener("equipment:changed",()=>{kt()});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editEquipmentModal");e&&!e.dataset.variantsListenerAttached&&(e.addEventListener("hidden.bs.modal",()=>{U=null,Ae(),Q=null,Y=null,Z(!1)}),e.dataset.variantsListenerAttached="true")});let ee=[],jt=[],Rt=[];function Aa(){return ee}function Na(e){ee=Array.isArray(e)?e:[]}function La(e){ee=[...ee,e]}function Ta(e){Number.isInteger(e)&&e>=0&&(ee=ee.filter((t,n)=>n!==e))}function Ba(){return jt}function xa(e){jt=Array.isArray(e)?e:[]}function Ca(){return Rt}function $a(e){Rt=Array.isArray(e)?e:[]}function Fa(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),s=a?a.slice(0,10):"",r=i.match(/(\d{1,2}:\d{2})/);let o="";if(r){const[c="00",u="00"]=r[0].split(":");o=`${c.padStart(2,"0")}:${u.padStart(2,"0")}`}return{date:s,time:o}}function be(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function St(e){return E(String(e||"")).trim().toLowerCase()}function Da(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:r=[]}=D(),o=St(e);return r.some(c=>{if(!c||!c.items||c.items.length===0||a&&(String(c.id)===String(a)||String(c.reservationId)===String(a))||!c.start||!c.end)return!1;const u=new Date(c.start),m=new Date(c.end);return Number.isNaN(u.getTime())||Number.isNaN(m.getTime())||!(u<s&&m>i)?!1:c.items.some(y=>St(y?.barcode)===o)})}function Cn(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:r=[]}=D(),o=String(e);return r.some(c=>{if(!c?.start||!c?.end||a&&(String(c.id)===String(a)||String(c.reservationId)===String(a)))return!1;const u=new Date(c.start),m=new Date(c.end);return Number.isNaN(u.getTime())||Number.isNaN(m.getTime())||!(u<s&&m>i)?!1:(Array.isArray(c.technicians)?c.technicians:[]).some(f=>String(f)===o)})}const $n=D()||{};let X=($n.technicians||[]).map(Ot);function wt(){return X}function fe(e){return X=Array.isArray(e)?e.map(Ot):[],pe({technicians:X}),typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("technicians:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),X}async function Fn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,r])=>{r!=null&&r!==""&&t.set(s,String(r))});const n=t.toString(),a=await N(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(nt):[];return fe(i)}async function Dn(e){const t=await N("/technicians/",{method:"POST",body:e}),n=nt(t?.data??{});return fe([...X,n]),n}async function zt(e,t){const n=await N(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=nt(n?.data??{}),i=X.map(s=>String(s.id)===String(e)?a:s);return fe(i),a}async function Pn(e){await N(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),fe(X.filter(t=>String(t.id)!==String(e)))}function Ht({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,status:r,notes:o,active:c=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,status:r??"available",notes:o??null,active:c?1:0}}function nt(e={}){return Vt({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,status:e.status,notes:e.notes,active:e.active})}function Ot(e={}){return Vt(e)}function Vt(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",r=e.department??e.team??"",o=Mn(e.daily_wage??e.dailyWage??e.wage??e.rate??0),c=qt(e.baseStatus??e.status??"available"),u=qt(e.status??e.baseStatus??"available"),m=e.notes??"",d=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:r,dailyWage:o,status:u,baseStatus:c,notes:m,active:d}}function Mn(e){const t=Number.parseFloat(E(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function qt(e){switch(String(e??"").trim().toLowerCase()){case"available":case"ŸÖÿ™ÿßÿ≠":return"available";case"busy":case"ŸÖÿ¥ÿ∫ŸàŸÑ":case"ŸÇŸäÿØ ÿßŸÑÿπŸÖŸÑ":return"busy";case"leave":case"ÿ•ÿ¨ÿßÿ≤ÿ©":case"ÿÆÿßÿ±ÿ¨ ÿßŸÑÿÆÿØŸÖÿ©":return"leave";case"inactive":case"ŸÖÿ™ŸàŸÇŸÅ":return"inactive";default:return"available"}}function we(e){return e instanceof Ce}let M=null,Et=!1,Ee=!1,le="",Qe=!1;async function Ut({showToastOnError:e=!0}={}){if(!Ee){Ee=!0,le="",B();try{await Fn(),Qe=!0}catch(t){console.error("‚ùå [technicians] loadTechniciansFromApi failed",t),le=we(t)?t.message:l("technicians.toast.fetchFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©"),e&&g(le,"error")}finally{Ee=!1,B()}}}function Xt(){return wt()}function ve(e=""){return E(String(e)).trim().toLowerCase()}function _t(e){return e==null?"":String(e)}function te(e=""){return E(String(e)).replace(/[^0-9+]/g,"")}function ne(e=""){const t=E(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function Ne(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function at(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ":"‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ∂Ÿà ÿ∑ÿßŸÇŸÖ";t.textContent=l(n,a)}function it(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=l("technicians.form.actions.cancel","ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑ"))}function st(){at(M?"update":"add"),it(!!M),B()}function kn(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,r)=>s.localeCompare(r,"ar",{sensitivity:"base"})),i=l("technicians.search.filters.allRoles","üëî ŸÉŸÑ ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function ze(){const e=document.getElementById("technician-form");e&&(e.reset(),M=null,at("add"),it(!1))}function jn(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-wage"),r=document.getElementById("technician-notes");!t||!n||!a||!s||(t.value=e.name||"",n.value=te(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s.value=ne(e.dailyWage!=null?e.dailyWage:""),r&&(r.value=e.notes||""),M=String(e.id),at("update"),it(!0))}function Rn(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-wage"),s=document.getElementById("technician-notes");if(!e||!t||!n||!i)return null;const r=e.value.trim(),o=te(t.value.trim());t.value=o;const c=n.value.trim(),u=a?.value.trim()||"",m=ne(i.value.trim());i.value=m;const d=m===""?0:parseFloat(m),y="available",f=s?.value.trim()||"";return r?o?c?Number.isNaN(d)||d<0?(g(l("technicians.toast.invalidWage","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ£ÿ¨ÿ± ÿßŸÑŸäŸàŸÖŸä")),i.focus(),null):{name:r,phone:o,role:c,department:u,dailyWage:Number.isFinite(d)?d:0,status:y,baseStatus:y,notes:f}:(g(l("technicians.toast.missingRole","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ∏ŸäŸÅÿ©")),n.focus(),null):(g(l("technicians.toast.missingPhone","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ")),t.focus(),null):(g(l("technicians.toast.missingName","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),e.focus(),null)}async function wn(e){e.preventDefault();const t=Rn();if(!t)return;const n=Ht({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,status:t.status,notes:t.notes,active:!0});try{M?(await zt(M,n),g(l("technicians.toast.updateSuccess","üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"))):(await Dn(n),g(l("technicians.toast.addSuccess","‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"))),ze(),B()}catch(a){console.error("‚ùå [technicians] handleTechnicianSubmit failed",a);const i=we(a)?a.message:l("technicians.toast.saveFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");g(i,"error")}}function zn(){ze()}function Hn(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=te(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=ne(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=e.baseStatus||e.status||"available";t.status.value!==i&&(t.status.value=i),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),Ne(t.phone,te),Ne(t.wage,ne)}function On(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),r=document.getElementById("edit-technician-status"),o=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!r)return null;const c=e.value.trim(),u=t.value.trim(),m=te(n.value.trim());n.value=m;const d=a.value.trim(),y=i?.value.trim()||"",f=ne(s.value.trim());s.value=f;const b=f===""?0:parseFloat(f),p=r.value||"available",h=o?.value.trim()||"";return c?u?m?d?Number.isNaN(b)||b<0?(g(l("technicians.toast.invalidWage","‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ£ÿ¨ÿ± ÿßŸÑŸäŸàŸÖŸä")),s.focus(),null):{id:c,name:u,phone:m,role:d,department:y,dailyWage:Number.isFinite(b)?b:0,status:p,baseStatus:p,notes:h}:(g(l("technicians.toast.missingRole","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ∏ŸäŸÅÿ©")),a.focus(),null):(g(l("technicians.toast.missingPhone","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ")),n.focus(),null):(g(l("technicians.toast.missingName","‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),t.focus(),null):(g(l("technicians.toast.unidentified","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®")),null)}async function Vn(){const e=On();if(!e)return;const t=Ht({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,status:e.status,notes:e.notes,active:!0});try{await zt(e.id,t),g(l("technicians.toast.updateSuccess","üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),B()}catch(n){console.error("‚ùå [technicians] handleTechnicianModalSave failed",n);const a=we(n)?n.message:l("technicians.toast.updateFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ");g(a,"error")}}function B(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=ve(t?.value||"");if(Ee&&!Qe){const u=l("technicians.table.loading","ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...");e.innerHTML=`<tr><td colspan='6'>${u}</td></tr>`;return}if(le&&!Qe){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${le}</td></tr>`;return}const a=rt(),{reservations:i=[]}=D(),s=new Date;kn(a);const r=document.getElementById("technician-role-filter"),o=ve(r?.value||""),c=a.filter(u=>o&&ve(u.role||"")!==o?!1:n?ve([u.name,u.phone,u.role,u.department,u.notes].filter(Boolean).join(" ")).includes(n):!0);if(c.length===0){const u=l("technicians.table.empty","ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿπÿ∂ÿßÿ° ŸÅŸä ÿßŸÑÿ∑ÿßŸÇŸÖ ÿ®ÿπÿØ.");e.innerHTML=`<tr><td colspan='6'>${u}</td></tr>`;return}e.innerHTML=c.map(u=>{const m=M&&String(M)===String(u.id),f=(Wt(u.id,i,s)?"busy":u.status||u.baseStatus||"available")==="busy"?{label:l("technicians.status.busy","‚õî ŸÖÿ¥ÿ∫ŸàŸÑ"),className:"technician-status-badge technician-status-badge--busy"}:{label:l("technicians.status.available","‚úÖ ŸÖÿ™ÿßÿ≠"),className:"technician-status-badge technician-status-badge--available"},b=l("technicians.actions.edit","‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ"),p=l("technicians.actions.delete","üóëÔ∏è ÿ≠ÿ∞ŸÅ"),h=J(),v=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${u.id}">${b}</button>`];return h&&v.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${u.id}">${p}</button>`),`
      <tr${m?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${u.id}" class="text-decoration-none">${u.name}</a></td>
        <td>${u.role||""}</td>
        <td>${u.department||"‚Äî"}</td>
        <td><span class="${f.className}"><span class="technician-status-badge__text">${f.label}</span></span></td>
        <td class="table-notes-cell">${u.notes||"‚Äî"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${v.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Un(e){const t=Xt().find(n=>String(n.id)===String(e));if(!t){g(l("technicians.toast.dataNotFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ"));return}jn(t),g(l("technicians.toast.editReady","‚úèÔ∏è ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ ÿßŸÑÿ¢ŸÜ ÿ´ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ"))}async function Xn(e){if(!J()){me();return}if(confirm(l("technicians.toast.deleteConfirm","‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿπÿ∂Ÿàÿü")))try{await Pn(e),g(l("technicians.toast.deleteSuccess","üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ")),M&&String(M)===String(e)&&ze(),B()}catch(t){console.error("‚ùå [technicians] handleDeleteClick failed",t);const n=we(t)?t.message:l("technicians.toast.deleteFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");g(n,"error")}}function Pa(){ct(),B()}function Ma(e){return Xt().find(t=>String(t.id)===String(e))||null}function Wt(e,t=[],n){const a=_t(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(c=>_t(c)===a))return!1;const r=new Date(i.start),o=new Date(i.end);return Number.isNaN(r.getTime())||Number.isNaN(o.getTime())?!1:r<=n&&n<o}):!1}function rt(){const e=D().reservations||[],t=wt();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const r=s.baseStatus||s.status||"available";let o=r==="busy"?"busy":r;return Wt(s.id,e,n)&&(o="busy"),(o!==s.status||r!==s.baseStatus)&&(a=!0),{...s,baseStatus:r,status:o}});return a?(fe(i),i):t}function ct(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",o=>{wn(o).catch(c=>{console.error("‚ùå [technicians] submit handler failed",c)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",zn),n.dataset.listenerAttached="true"),Ne(document.getElementById("technician-phone"),te),Ne(document.getElementById("technician-wage"),ne);const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",o=>{const c=o.target;if(c instanceof HTMLElement){if(c.classList.contains("technician-edit-btn")){const u=c.dataset.id;Un(u)}if(c.classList.contains("technician-delete-btn")){const u=c.dataset.id;Xn(u).catch(m=>{console.error("‚ùå [technicians] delete handler failed",m)})}}}),a.dataset.listenerAttached="true");const i=document.getElementById("search-technician-input");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{i.value=E(i.value),B()}),i.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{B()}),s.dataset.listenerAttached="true");const r=document.getElementById("save-technician-changes");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{Vn().catch(o=>{console.error("‚ùå [technicians] modal save failed",o)})}),r.dataset.listenerAttached="true"),Et||(document.addEventListener("technician:prefill",o=>{const c=o.detail;c&&Hn(c)}),Et=!0),t&&ze()}window.addEventListener("DOMContentLoaded",()=>{ct(),B(),st(),Ut()});const Kt=()=>{B()};window.addEventListener("technicians:updated",Kt);document.addEventListener("technicians:updated",Kt);document.addEventListener("technicians:refreshRequested",()=>{ct(),B(),st(),Ut({showToastOnError:!1})});document.addEventListener("language:changed",()=>{st()});document.addEventListener(Bt.USER_UPDATED,()=>{B()});let W=[],z=[],H=[],Le="create",ot=()=>{},ut=()=>{};function Wn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=E(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function Qt(e={}){const t=Wn(e);if(!Number.isFinite(t)||t<=0)return"‚Äî";const n=l("technicians.table.wageSuffix","ÿ±ŸäÿßŸÑ");return`${E(String(t))} ${n}`}function It(e=""){return E(String(e)).trim().toLowerCase()}function Yt(e){return!W||!W.length?null:W.find(t=>String(t?.id)===String(e))||null}function Kn(e,t="create"){t==="edit"?mt(H.filter(n=>String(n)!==String(e))):dt(z.filter(n=>String(n)!==String(e)))}function Te(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=l("reservations.crew.none","ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿπÿ∂Ÿà ŸÖŸÜ ÿßŸÑÿ∑ÿßŸÇŸÖ.");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const s=Yt(i)||{},r=l("reservations.crew.fallbackName","ÿπÿ∂Ÿà ÿßŸÑÿ∑ÿßŸÇŸÖ {id}").replace("{id}",i),o=s.name||r,c=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",u=Qt(s),m=u!=="‚Äî"?`<small class="technician-chip-wage">üí∞ ${u}</small>`:"",d=l("reservations.crew.removeAria","ÿ•ÿ≤ÿßŸÑÿ©");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${o}</span>
          ${c}
          ${m}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${d}">‚úñ</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>Kn(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function Gt(){return Le==="edit"?H:z}function Be(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=It(t?.value||""),a=new Set(Gt().map(String)),s=(W||[]).filter(r=>n?It([r.name,r.phone,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const r=l("reservations.crew.searchEmpty","ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${r}</td></tr>`;return}e.innerHTML=s.map(r=>{const o=Qt(r);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${r.id}" ${a.has(String(r.id))?"checked":""}>
        </td>
        <td>${r.name||"-"}</td>
        <td>${r.role||"‚Äî"}</td>
        <td>${r.department||"‚Äî"}</td>
        <td>${o}</td>
      </tr>
    `}).join("")}function Qn(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function Yn(e="create"){if(e==="edit"){const o=document.getElementById("edit-res-start")?.value?.trim(),c=document.getElementById("edit-res-end")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",m=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=o?be(o,u):null,y=c?be(c,m):null;let f=null;const b=document.getElementById("edit-res-index")?.value;if(b!=null){const p=Number.parseInt(b,10);if(Number.isInteger(p)){const{reservations:h=[]}=D(),v=h?.[p];v&&(f=v.id??v.reservationId??null)}}return{start:d,end:y,ignoreReservationId:f}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?be(t,a):null,r=n?be(n,i):null;return{start:s,end:r,ignoreReservationId:null}}function ae(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=Gt().length;if(t){const n=l("reservations.crew.selectedCount","ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± {count} ÿπÿ∂Ÿà").replace("{count}",E(String(t)));e.textContent=n}else e.textContent=l("reservations.crew.noneShort","ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿπÿ∂Ÿà ÿ®ÿπÿØ")}function Gn(){const e=Qn().map(String),{start:t,end:n,ignoreReservationId:a}=Yn(Le);if(t&&n){const s=e.filter(r=>Cn(r,t,n,a));if(s.length>0){const r=s.map(c=>Yt(c)?.name||c).join(l("reservations.list.crew.separator","ÿå ")),o=l("reservations.toast.technicianSelectionConflict","‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± {names} ŸÑÿ£ŸÜŸáŸÖ ŸÖÿ±ÿ™ÿ®ÿ∑ŸàŸÜ ÿ®ÿ≠ÿ¨ÿ≤ ÿ¢ÿÆÿ± ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©").replace("{names}",r);s.forEach(c=>{const u=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(c))}"]`);u&&(u.checked=!1)}),g(o),ae();return}}Le==="edit"?mt(e):dt(e),ae();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function At(e="create"){Le=e;const t=rt();Array.isArray(t)&&t.length&&(W=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),Be(),ae();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function Jn(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>At("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>At("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Be(),ae()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",Gn),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{ae(),Be()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),lt()}function lt(){Te("selected-technicians-list",z,"create"),Te("edit-selected-technicians-list",H,"edit")}function ka({onDraftChange:e,onEditChange:t}={}){ot=typeof e=="function"?e:()=>{},ut=typeof t=="function"?t:()=>{},lt(),Jn()}function Zn(e=[]){W=Array.isArray(e)?e:[]}function ea(){return[...z]}function ta(){return[...H]}function dt(e=[]){z=Array.isArray(e)?e.map(String):[],Te("selected-technicians-list",z,"create"),ot()}function mt(e=[]){H=Array.isArray(e)?e.map(String):[],Te("edit-selected-technicians-list",H,"edit"),ut()}function ja(){dt([])}function Ra(){mt([])}function wa(e=[]){Zn(e);const t=new Set(W.map(o=>String(o.id))),n=z.filter(o=>t.has(String(o))),a=H.filter(o=>t.has(String(o))),i=n.length!==z.length,s=a.length!==H.length;z=n,H=a,lt(),i&&ot(),s&&ut();const r=document.getElementById("selectTechniciansModal");r&&r.classList.contains("show")&&(Be(),ae())}const Jt=10;function na(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function aa(e=[]){if(!Array.isArray(e)||e.length===0)return 0;const{technicians:t=[]}=D();if(!Array.isArray(t)||t.length===0)return 0;const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));return s?a+na(s):a},0)}const ia=1440*60*1e3;function sa(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/ia;return Math.max(1,Math.ceil(s))}function pt({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:i=!1,start:s=null,end:r=null,companySharePercent:o=null}={}){const c=sa(s,r),m=(e||[]).reduce((L,P)=>L+(Number(P?.qty)||1)*(Number(P?.price)||0),0)*c,y=aa(t)*c,f=m+y,b=Number(n)||0;let p=a==="amount"?b:f*(b/100);(!Number.isFinite(p)||p<0)&&(p=0),p>f&&(p=f);const h=Math.max(0,f-p);let v=i?h*.15:0;(!Number.isFinite(v)||v<0)&&(v=0);const I=h+v,q=Math.max(0,Math.round(I));let A=Number.isFinite(o)?Number(o):null;i&&(!Number.isFinite(A)||A<=0)&&(A=Jt);const S=A&&A>0?A:0,_=S>0?Math.max(0,q*(S/100)):0,T=Math.max(0,q-v-_);return{rentalDays:c,equipmentTotal:m,crewTotal:y,discountAmount:p,taxableAmount:h,taxAmount:v,finalTotal:q,companySharePercent:S,companyShareAmount:_,netProfit:T}}function za(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:r=null}={}){return pt({items:e,technicianIds:i,discount:t,discountType:n,applyTax:a,start:s,end:r}).finalTotal}function Zt({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paidStatus:s,companySharePercent:r=null,companyShareAmount:o=null,taxAmount:c=null,netProfit:u=null,totalKey:m="reservations.summary.total"}){const d=l("reservations.create.summary.currency","ÿ±ŸäÿßŸÑ"),y=E(String(e)),f=E(String(t)),b=E(String(n??1)),p=E(String(a)),h=s==="paid"?l("reservations.create.paymentStatus.paid","ŸÖÿØŸÅŸàÿπ"):l("reservations.create.paymentStatus.unpaid","ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ"),v=l("reservations.summary.itemsLabel","üì¶ ÿπÿØÿØ ÿßŸÑŸÖÿπÿØÿßÿ™"),I=l("reservations.summary.durationLabel","‚è±Ô∏è ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ"),q=l("reservations.summary.crewLabel","üòé ÿπÿØÿØ ÿßŸÑŸÅÿ±ŸäŸÇ"),A=l("reservations.summary.taxLabelShort","üßæ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©"),S=l("reservations.summary.paymentLabelShort","üí≥ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ"),_=l(m.replace(".total",".totalLabel"),"üí∞ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©"),T=l("reservations.summary.companyShareLabel","üè¶ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ¥ÿ±ŸÉÿ©"),L=l("reservations.details.labels.netProfit","üíµ ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠"),P=Number.isFinite(u)?Math.max(0,Number(u)):null,re=[{label:v,value:f},{label:I,value:b},{label:q,value:p}];if(i){let j=l("reservations.summary.taxIncludedValue","ÿ¥ÿßŸÖŸÑ 15%");Number.isFinite(c)&&c>0&&(j=`${E(Number(c).toFixed(2))} ${d}`),re.push({label:A,value:j})}const ge=Number.isFinite(r)?Number(r):null;if(ge!==null&&ge>0){const j=Number.isFinite(o)?Number(o):e*(ge/100),ce=E(String(ge)),sn=E(Number.isFinite(j)?j.toFixed(2):"0"),rn=`${ce}% (${sn} ${d})`;re.push({label:T,value:rn})}if(P!==null&&Math.abs(P-Number(e))>.009){const j=E(P.toFixed(2));re.push({label:L,value:`${j} ${d}`})}re.push({label:S,value:h});const an=`${y} ${d}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${re.map(({label:j,value:ce})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${j}</span>
            ${ce?`<span class="reservation-summary-value">${ce}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${_}</span>
          <span class="reservation-summary-value">${an}</span>
        </div>
      </div>
    </div>
  `}function Ha({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:r,companySharePercent:o=null}){const c=ea(),u=c.length,m=Number.isFinite(o)?Number(o):null,d=pt({items:e,technicianIds:c,discount:t,discountType:n,applyTax:a,start:s,end:r,companySharePercent:m}),y=Zt({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:u,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit});ra(y)}function Oa({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:r,companySharePercent:o=null}){const c=ta(),u=c.length,m=Number.isFinite(o)?Number(o):null,d=pt({items:e,technicianIds:c,discount:t,discountType:n,applyTax:a,start:s,end:r,companySharePercent:m});return Zt({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:u,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit,totalKey:"reservations.summary.totalAfterEdit"})}function ra(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Nt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Nt(n,e))}function Nt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}function Va(e=""){return E(String(e)).trim().toLowerCase()}function Ua(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function ca(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"ŸÖÿ§ŸÉÿØ":return"confirmed";case"in_progress":case"in-progress":case"ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞":case"ÿ¨ÿßÿ±Ÿä":return"in_progress";case"completed":case"ŸÖŸÉÿ™ŸÖŸÑ":return"completed";case"cancelled":case"ŸÖŸÑÿ∫Ÿä":return"cancelled";case"pending":case"draft":case"ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±":case"ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ÿ£ŸÉŸäÿØ":case"ŸÖÿπŸÑŸÇ":default:return"pending"}}function oa(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,i=a!=null&&a!==""&&a!=="null",s=i?ca(t?.status??t?.status_label??t?.statusLabel??""):null,r=i&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:n,projectLinked:i,projectStatus:s,projectConfirmed:r,effectiveConfirmed:i?r:n}}const ua=D()||{};let K=(ua.reservations||[]).map(fa);function de(){return K}function He(e){return K=Array.isArray(e)?e.map(yt):[],pe({reservations:K}),K}async function la(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,c])=>{c!=null&&c!==""&&t.set(o,String(c))});const n=t.toString(),i=(await N(`/reservations/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const r=s.map(ft);return He(r)}async function Xa(e){const t=await N("/reservations/",{method:"POST",body:e}),n=ft(t?.data??{});return!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),n.companySharePercent>0&&!Number.isFinite(n.companyShareAmount)&&Number.isFinite(n.cost)&&(n.companyShareAmount=Math.max(0,n.cost*(n.companySharePercent/100))),n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,He([...K,n]),n}async function da(e,t){const n=await N(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=ft(n?.data??{});!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),a.companySharePercent>0&&!Number.isFinite(a.companyShareAmount)&&Number.isFinite(a.cost)&&(a.companyShareAmount=Math.max(0,a.cost*(a.companySharePercent/100))),a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const i=K.map(s=>String(s.id)===String(e)?a:s);return He(i),a}async function ma(e){await N(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=K.filter(n=>String(n.id)!==String(e));He(t)}async function pa(e){return da(e,{status:"confirmed",confirmed:!0})}function ft(e={}){return yt({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount})}function fa(e={}){return yt(e)}function yt(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(ya):[],i=Array.isArray(e.technicians)?e.technicians:[],s=i.map(S=>S==null?null:String(typeof S=="object"?S.id??S.technician_id??S.technicianId??S.ID??"":S)).filter(S=>S&&S!==""),r=e.start??e.start_datetime??"",o=e.end??e.end_datetime??"",c=xe(e.total_amount??e.totalAmount??e.cost??0),u=xe(e.discount??0),m=e.discount_type??e.discountType??"percent",d=!!(e.apply_tax??e.applyTax??!1),y=ha(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid",f=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),b=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,p=b!=null?Number.parseFloat(E(String(b).replace("%","").trim())):NaN,h=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let v=h!=null?h===!0||h===1||h==="1"||String(h).toLowerCase()==="true":Number.isFinite(p)&&p>0,I=v&&Number.isFinite(p)?Number(p):0;const q=e.company_share_amount??e.companyShareAmount;let A=Number.isFinite(Number(q))?Number(q):I>0?Math.max(0,c*(I/100)):0;return d&&I<=0&&(I=Jt,A=Math.max(0,c*(I/100)),v=!0),!v&&I>0&&(v=!0),{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:o,status:ga(e.status??(f?"confirmed":"pending")),confirmed:f,location:e.location??"",notes:e.notes??"",discount:u,discountType:["percent","amount"].includes(m)?m:"percent",applyTax:d,paid:y==="paid",paidStatus:y,totalAmount:c,cost:c,projectId:e.project_id??e.projectId??null,items:a,technicians:s,techniciansDetails:i.map(S=>typeof S=="object"?S:{id:Number(S)||S}),startDatetime:r,endDatetime:o,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:I,companyShareAmount:A,companyShareEnabled:v}}function ya(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=en(e.quantity??e.qty??1),a=xe(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:E(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function Wa({reservationCode:e,customerId:t,start:n,end:a,status:i,title:s,location:r,notes:o,projectId:c,totalAmount:u,discount:m,discountType:d,applyTax:y,paidStatus:f,confirmed:b,items:p,technicians:h,companySharePercent:v,companyShareEnabled:I}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:s??null,location:r??null,notes:o??null,project_id:c||null,total_amount:u??0,discount:m??0,discount_type:d??"percent",apply_tax:y?1:0,paid_status:f??"unpaid",confirmed:b===void 0?null:!!b,items:Array.isArray(p)?p.map(q=>({equipment_id:q.equipmentId??q.equipment_id??q.id,quantity:en(q.qty??q.quantity??1),unit_price:xe(q.price??q.unit_price??0),notes:q.notes??null})):[],company_share_percent:I&&Number.isFinite(v)?Number(v):null,company_share_enabled:I?1:0,technicians:Array.isArray(h)?h.map(q=>typeof q=="object"&&q!==null?{id:q.id??q.technician_id??q.technicianId??q.ID,role:q.role??null,notes:q.notes??null}:Number.isNaN(Number(q))?String(q):Number(q)):[]}}function xe(e){const t=Number(E(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function en(e){const t=Number.parseInt(E(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function ga(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"ŸÖÿπŸÑŸÇ":case"ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±":return"pending";case"confirmed":case"ŸÖÿ§ŸÉÿØ":return"confirmed";case"in_progress":case"in-progress":case"ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞":case"ÿ¨ÿßÿ±Ÿä":return"in_progress";case"completed":case"ŸÖŸÉÿ™ŸÖŸÑ":return"completed";case"cancelled":case"ŸÖŸÑÿ∫Ÿä":return"cancelled";default:return"pending"}}function ha(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"ŸÖÿØŸÅŸàÿπ":return"paid";case"partial":case"ŸÖÿØŸÅŸàÿπ ÿ¨ÿ≤ÿ¶ŸäÿßŸã":case"partial_paid":return"partial";case"unpaid":case"ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ":case"not_paid":default:return"unpaid"}}function tn(e){return e instanceof Ce}function nn(){const e=()=>{Pt(),rt()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(e,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(e);return}}e()}let Lt=!1,Tt=null;function ba(e){if(!e||typeof e!="object")return"";const t=Object.entries(e).filter(([n,a])=>a!=null).map(([n,a])=>[n,String(a)]);return t.length===0?"":JSON.stringify(t.sort(([n],[a])=>n.localeCompare(a)))}async function Ka(e={}){const{suppressError:t=!0,params:n=null,force:a=!1}=e??{},i=ba(n);if(!a&&Lt&&de().length>0&&i===Tt)return de();try{const s=await la(n||{});return Lt=!0,Tt=i,s}catch(s){if(console.error("‚ùå [reservationsActions] Failed to load reservations from API",s),!t)throw s;return de()}}async function Qa(e,{onAfterChange:t}={}){if(!J())return me(),!1;const a=de()[e];if(!a)return g(l("reservations.toast.notFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤")),!1;const i=a.id||a.reservationId;if(!i)return g(l("reservations.toast.notFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤")),!1;try{return await ma(i),nn(),t?.({type:"deleted",reservation:a}),g(l("reservations.toast.deleted","üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ¨ÿ≤")),!0}catch(s){console.error("‚ùå [reservationsActions] deleteReservation failed",s);const r=tn(s)?s.message:l("reservations.toast.deleteFailed","ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ¨ÿ≤ÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");return g(r,"error"),!1}}async function Ya(e,{onAfterChange:t}={}){const a=de()[e];if(!a)return g(l("reservations.toast.notFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤")),!1;const i=a.id||a.reservationId;if(!i)return g(l("reservations.toast.notFound","‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤")),!1;const{projectLinked:s}=oa(a);if(s)return g(l("reservations.toast.confirmBlockedByProject","‚ö†Ô∏è ÿ≠ÿßŸÑÿ© Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ¨ÿ≤ ÿ™ÿ™ÿ≠ŸÉŸÖ ÿ®Ÿáÿß ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ£ŸÉŸäÿØŸá ŸÖŸÜ ŸáŸÜÿß"),"info"),!1;try{const r=await pa(i);return nn(),t?.({type:"confirmed",reservation:r}),g(l("reservations.toast.confirmed","‚úÖ ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ¨ÿ≤")),!0}catch(r){console.error("‚ùå [reservationsActions] confirmReservation failed",r);const o=tn(r)?r.message:l("reservations.toast.confirmFailed","ÿ™ÿπÿ∞ÿ± ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ¨ÿ≤ÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");return g(o,"error"),!1}}const va=D()||{};let $=(va.projects||[]).map(qa),ye=!1;function Ga(){return $}function Oe(e){return $=Array.isArray(e)?e.map(ht):[],pe({projects:$}),$}async function Sa(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,c])=>{c==null||c===""||t.set(o,String(c))});const n=t.toString(),i=(await N(`/projects/${n?`?${n}`:""}`))?.data;let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(Array.isArray(i.items)?s=i.items:Array.isArray(i.results)?s=i.results:Array.isArray(i.data)?s=i.data:Array.isArray(i.records)&&(s=i.records));const r=s.map(gt);return Oe(r),ye=!0,$}async function Ja({force:e=!1,params:t=null}={}){if(!e&&ye&&$.length>0)return $;try{return await Sa(t||{})}catch(n){return console.error("‚ùå [projectsService] Failed to load projects from API",n),$}}async function Za(e){const t=await N("/projects/",{method:"POST",body:e}),n=gt(t?.data??{}),a=[...$,n];return Oe(a),ye=!0,n}async function ei(e,t){const n=await N(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=gt(n?.data??{}),i=$.map(s=>String(s.id)===String(e)?a:s);return Oe(i),ye=!0,a}async function ti(e){await N(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=$.filter(n=>String(n.id)!==String(e));Oe(t),ye=!0}function ni({projectCode:e,title:t,type:n,clientId:a,clientCompany:i,description:s,start:r,end:o,applyTax:c,paymentStatus:u,equipmentEstimate:m=0,expenses:d=[],taxAmount:y=0,totalWithTax:f=0,confirmed:b=!1,technicians:p=[],equipment:h=[]}={}){const v=Array.isArray(p)?p.map(_=>Number.parseInt(String(_),10)).filter(_=>Number.isInteger(_)&&_>0):[],I=Array.isArray(h)?h.map(_=>{const T=Number.parseInt(String(_.equipmentId??_.equipment_id??_.id??0),10),L=Number.parseInt(String(_.qty??_.quantity??0),10);return!Number.isInteger(T)||T<=0?null:{equipment_id:T,quantity:Number.isInteger(L)&&L>0?L:1}}).filter(Boolean):[],q=Array.isArray(d)?d.map(_=>{const T=Number.parseFloat(_?.amount??_?.value??0)||0,L=(_?.label??_?.name??"").trim();return L?{label:L,amount:Math.round(T*100)/100}:null}).filter(Boolean):[],A=q.reduce((_,T)=>_+(T?.amount??0),0),S={title:t,type:n,client_id:a?Number.parseInt(String(a),10):null,client_company:i??null,description:s??null,start_datetime:r??null,end_datetime:o||null,apply_tax:!!c,payment_status:u??"unpaid",equipment_estimate:Number.parseFloat(m)||0,expenses_total:Math.round(A*100)/100,tax_amount:Math.round((Number.parseFloat(y)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(f)||0)*100)/100,confirmed:!!b,technicians:v,equipment:I,expenses:q};return e&&(S.project_code=String(e).trim()),S.end_datetime||delete S.end_datetime,S.client_company||(S.client_company=null),S}function gt(e={}){return ht(e)}function qa(e={}){return ht(e)}function ht(e={}){const t=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],a=n.map(c=>{if(c==null)return null;if(typeof c=="object"){const u=c.id??c.technician_id??c.technicianId;return u!=null?String(u):null}return String(c)}).filter(Boolean),s=(Array.isArray(e.equipment)?e.equipment:[]).map(c=>{const u=c?.equipment_id??c?.equipmentId??c?.id??null,m=c?.quantity??c?.qty??0,d=c?.barcode??c?.code??"",y=c?.description??c?.name??"";return{equipmentId:u!=null?String(u):null,qty:Number.parseInt(String(m),10)||0,barcode:d,description:y}}),o=(Array.isArray(e.expenses)?e.expenses:[]).map((c,u)=>({id:c?.id??`expense-${t??"x"}-${u}`,label:c?.label??"",amount:Number.parseFloat(c?.amount??0)||0}));return{id:t!=null?String(t):"",projectId:t!=null?Number(t):null,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:n.map(c=>typeof c=="object"?c:{id:c}),equipment:s,expenses:o}}function ai(e){return e instanceof Ce}export{ta as $,Ga as A,ti as B,Sa as C,Jt as D,la as E,ai as F,Za as G,St as H,Ba as I,Ha as J,be as K,Fa as L,xa as M,Ta as N,Aa as O,Da as P,La as Q,ea as R,Cn as S,Wa as T,Xa as U,Pt as V,Ca as W,ja as X,Na as Y,$a as Z,mt as _,nt as a,Ra as a0,Oa as a1,Qa as a2,Ya as a3,ft as b,sa as c,Ua as d,Ka as e,Re as f,de as g,F as h,tn as i,Pa as j,_a as k,ni as l,fa as m,ei as n,gt as o,Ma as p,Fn as q,oa as r,rt as s,za as t,Ia as u,da as v,Ja as w,ka as x,wa as y,Va as z};
