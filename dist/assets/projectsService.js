import{d as _e,n as E,f as tt,t as d,b as j,h as g,j as J,o as ce,s as Ae,A as De}from"./auth.js";import{a as nt,g as W,M as at,i as we,N as rt,s as it}from"./reservationsService.js";const qe="select.form-select:not([data-no-enhance]):not([multiple])",T=new WeakMap;let ve=null,$e=!1,M=null;function Vt(e=document){e&&(e.querySelectorAll(qe).forEach(t=>ae(t)),!ve&&e===document&&(ve=new MutationObserver(t=>{for(const n of t)n.addedNodes?.forEach(a=>{a instanceof Element&&(a.matches?.(qe)&&ae(a),a.querySelectorAll?.(qe).forEach(r=>ae(r)))})}),ve.observe(document.body,{childList:!0,subtree:!0})),$e||($e=!0,document.addEventListener("pointerdown",ct,{capture:!0})))}function ne(e){if(!(e instanceof HTMLSelectElement))return;if(!e.dataset.enhancedSelect){ae(e);return}const t=e.closest(".enhanced-select");t&&(Ie(t),re(t),Ee(t))}function ae(e){if(!(e instanceof HTMLSelectElement))return;if(e.dataset.enhancedSelect){ne(e);return}if(e.multiple||e.size>1)return;const t=document.createElement("div");t.className="enhanced-select";const n=e.parentNode;n&&n.insertBefore(t,e),t.appendChild(e),e.dataset.enhancedSelect="true",e.classList.add("enhanced-select__native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const a=document.createElement("button");a.type="button",a.className="enhanced-select__trigger",a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const r=document.createElement("ul");r.className="enhanced-select__menu",r.setAttribute("role","listbox"),r.setAttribute("tabindex","-1"),t.append(a,r);const o={select:e,trigger:a,menu:r,observer:null,refreshRaf:null};T.set(t,o),a.addEventListener("click",()=>ot(t)),a.addEventListener("keydown",i=>ut(i,t)),r.addEventListener("click",i=>lt(i,t)),r.addEventListener("keydown",i=>dt(i,t)),e.addEventListener("change",()=>{re(t),ke(t)}),o.observer=new MutationObserver(i=>{let u=!1,s=!1;for(const c of i)c.type==="attributes"&&c.attributeName==="disabled"&&(s=!0),c.type==="childList"&&(u=!0);s&&Ee(t),u&&st(o,t)}),o.observer.observe(e,{attributes:!0,attributeFilter:["disabled"],childList:!0}),Ie(t),re(t),Ee(t)}function st(e,t){e&&(e.refreshRaf||(e.refreshRaf=requestAnimationFrame(()=>{e.refreshRaf=null,Ie(t),re(t)})))}function Ie(e){const t=T.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const r=Array.from(n.options||[]),o=document.createDocumentFragment();r.forEach(i=>{const u=document.createElement("li");u.className="enhanced-select__option",u.textContent=i.textContent??i.value??"",u.dataset.value=i.value??"",u.setAttribute("role","option"),u.setAttribute("tabindex","-1"),i.disabled&&(u.setAttribute("aria-disabled","true"),u.classList.add("is-disabled")),i.selected&&(u.setAttribute("aria-selected","true"),u.dataset.selected="true",u.setAttribute("tabindex","0")),o.appendChild(u)}),a.innerHTML="",a.appendChild(o),ke(e)}function re(e){const t=T.get(e);if(!t)return;const{select:n,trigger:a}=t;if(!n||!a)return;const r=n.selectedOptions?.[0]??n.options?.[n.selectedIndex],o=r?.textContent?.trim()||r?.value||"";a.textContent=o}function ke(e){const t=T.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const r=n.value;a.querySelectorAll(".enhanced-select__option").forEach(i=>{const u=i.dataset.value===r;i.toggleAttribute("aria-selected",u),i.dataset.selected=u?"true":"",i.setAttribute("tabindex",u?"0":"-1")})}function Ee(e){const t=T.get(e);if(!t)return;const{select:n,trigger:a}=t,r=!!n?.disabled;e.classList.toggle("enhanced-select--disabled",r),a.disabled=r}function ot(e){T.get(e)&&(e.getAttribute("data-open")==="true"?V(e):Oe(e))}function Oe(e){const t=T.get(e);if(!t)return;M&&M!==e&&V(M,{focusTrigger:!1}),e.setAttribute("data-open","true"),t.trigger.setAttribute("aria-expanded","true"),M=e;const n=t.menu.querySelector('.enhanced-select__option[aria-selected="true"]')??t.menu.querySelector(".enhanced-select__option:not([aria-disabled='true'])");n?n.focus():t.menu.focus()}function V(e,{focusTrigger:t=!0}={}){const n=T.get(e);n&&(e.setAttribute("data-open","false"),n.trigger.setAttribute("aria-expanded","false"),t&&n.trigger.focus({preventScroll:!0}),M===e&&(M=null))}function ct(e){if(!M)return;const t=e.target;t instanceof Node&&(M.contains(t)||V(M,{focusTrigger:!1}))}function ut(e,t){const n=e.key;n==="ArrowDown"||n==="ArrowUp"||n===" "||n==="Enter"?(e.preventDefault(),Oe(t)):n==="Escape"&&V(t)}function dt(e,t){const n=e.key,a=T.get(t);if(!a)return;const r=Array.from(a.menu.querySelectorAll(".enhanced-select__option:not([aria-disabled='true'])"));if(!r.length)return;const o=r.findIndex(i=>i===document.activeElement);if(n==="ArrowDown"||n==="ArrowUp"){e.preventDefault();const u=(o+(n==="ArrowDown"?1:-1)+r.length)%r.length;r[u].focus()}else if(n==="Home")e.preventDefault(),r[0].focus();else if(n==="End")e.preventDefault(),r[r.length-1].focus();else if(n==="Enter"||n===" "){e.preventDefault();const i=document.activeElement;i&&i.classList.contains("enhanced-select__option")&&Ue(i,t)}else n==="Escape"&&(e.preventDefault(),V(t))}function lt(e,t){const n=e.target?.closest?.(".enhanced-select__option");n&&Ue(n,t)}function Ue(e,t){const n=T.get(t);if(!n||e.getAttribute("aria-disabled")==="true")return;const{select:a}=n,r=e.dataset.value??"";a.value!==r&&(a.value=r,a.dispatchEvent(new Event("change",{bubbles:!0}))),V(t)}const mt=_e()||{};let P=(mt.equipment||[]).map(yt),Se=!1,G="",D=null,w=null,k=null,ue=!1;function pt(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function ft(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function yt(e={}){return Ne({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function de(e={}){return Ne(e)}function Ne(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",r=e.subcategory??e.sub??"",o=Y(e.quantity??e.qty??0),i=le(e.unit_price??e.price??0),u=E(String(e.barcode??"").trim()),s=N(e.status??e.state??e.status_label??e.statusLabel??"available"),c=e.image_url??e.imageUrl??e.image??"",f=e.name??e.item_name??n;return{id:gt(t)?String(t):"",category:a,sub:r,desc:n,name:f,qty:o,price:i,barcode:u,status:s,image:c,imageUrl:c,created_at:e.created_at??null,updated_at:e.updated_at??null}}function gt(e){return e!=null&&e!==""}function Y(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function le(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function bt(e){!e||e.dataset.englishDigitsAttached||(e.addEventListener("input",()=>{const{selectionStart:t,selectionEnd:n,value:a}=e,r=E(a);if(r!==a&&(e.value=r,t!=null&&n!=null)){const o=r.length-a.length,i=t+o,u=n+o;e.setSelectionRange(i,u)}}),e.dataset.englishDigitsAttached="true")}function je(e){if(!e)return"";const t=E(String(e.barcode??"")).trim();if(t)return t;if(Array.isArray(e.variants))for(const n of e.variants){const a=E(String(n?.barcode??"")).trim();if(a)return a}return""}function qt(e,t){const n=je(e),a=je(t);if(!n&&!a)return 0;if(!n)return 1;if(!a)return-1;const r=/^[0-9]+$/,o=r.test(n),i=r.test(a);if(o&&i){if(n.length!==a.length)return n.length-a.length;const c=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(c!==0)return c}else{if(o!==i)return o?-1:1;{const c=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(c!==0)return c}}const u=ie(e?.desc||e?.description||e?.name||""),s=ie(t?.desc||t?.description||t?.name||"");return u.localeCompare(s,"ar",{sensitivity:"base"})}function I(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function N(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":case"Ù…ØªÙˆÙØ±":return"available";case"reserved":case"Ù…Ø­Ø¬ÙˆØ²":return"reserved";case"maintenance":case"ØµÙŠØ§Ù†Ø©":return"maintenance";case"retired":case"Ù…ØªÙˆÙ‚Ù":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"retired";default:return"available"}}function vt(e){return N(e)}function x(){return P}function O(e){P=Array.isArray(e)?e.map(Ne):[],Ae({equipment:P}),ft()}function ie(e){return String(e??"").trim().toLowerCase()}function R(e){if(!e)return"";const t=e.desc||e.description||e.name||"";let n=ie(t);return n||(n=ie(e.category||"")),n||(n=E(String(e.barcode||"")).trim().toLowerCase()),n}function me(e){const t=R(e);return t?x().filter(n=>R(n)===t):[]}function pe(e){const t=document.getElementById("equipment-details-cover");if(!t)return;const n=fe(e);if(n){const a=I(e.desc||e.description||e.name||"");t.innerHTML=`<img src="${I(n)}" alt="${a}">`,t.classList.add("has-image")}else t.innerHTML='<span class="equipment-details-header__placeholder" aria-hidden="true">ğŸ“¦</span>',t.classList.remove("has-image")}function Le(){return{category:document.getElementById("edit-equipment-category"),subcategory:document.getElementById("edit-equipment-subcategory"),description:document.getElementById("edit-equipment-description"),quantity:document.getElementById("edit-equipment-quantity"),price:document.getElementById("edit-equipment-price"),image:document.getElementById("edit-equipment-image"),barcode:document.getElementById("edit-equipment-barcode"),status:document.getElementById("edit-equipment-status")}}function se(){const e=Le();return{category:e.category?.value??"",subcategory:e.subcategory?.value??"",description:e.description?.value??"",quantity:e.quantity?.value??"",price:e.price?.value??"",image:e.image?.value??"",barcode:e.barcode?.value??"",status:e.status?.value??""}}function xe(e={}){const t=Le();t.category&&(t.category.value=e.category??""),t.subcategory&&(t.subcategory.value=e.subcategory??""),t.description&&(t.description.value=e.description??""),t.quantity&&(t.quantity.value=e.quantity!=null?E(String(e.quantity)):""),t.price&&(t.price.value=e.price!=null?E(String(e.price)):""),t.image&&(t.image.value=e.image??""),t.barcode&&(t.barcode.value=e.barcode??""),t.status&&(t.status.value=e.status??"")}function X(e){ue=e;const t=Le(),n=document.getElementById("equipment-edit-cancel"),a=document.getElementById("save-equipment-changes"),r=document.getElementById("edit-equipment-form");if(r&&r.classList.toggle("equipment-details-form--editing",e),[t.category,t.subcategory,t.description,t.quantity,t.price,t.image].forEach(i=>{i&&(e?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"))}),n&&(n.hidden=!e,n.disabled=!e),a){a.disabled=!1;const i=e?"equipment.modal.actions.save":"equipment.modal.actions.edit",u=e?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"âœï¸ ØªØ¹Ø¯ÙŠÙ„";a.textContent=d(i,u),a.dataset.mode=e?"save":"view"}if(e){const i=t.description||t.category||t.subcategory;i&&setTimeout(()=>{i.focus(),typeof i.select=="function"&&i.select()},0)}}async function zt(e){if(!J()){ce();return}if(!e)return;try{await Et()}catch(n){console.error("âŒ [equipment.js] Unable to load XLSX",n),alert(d("equipment.toast.xlsxMissing","âš ï¸ Ù…ÙƒØªØ¨Ø© Excel (XLSX) ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),r=XLSX.read(a,{type:"array"}),o=r.Sheets[r.SheetNames[0]],i=XLSX.utils.sheet_to_json(o,{defval:""});if(!Array.isArray(i)||i.length===0){g(d("equipment.toast.uploadEmpty","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"));return}const u=[];let s=0;if(i.forEach(c=>{const f=c.Ø§Ù„Ù‚Ø³Ù…??c.category??"",m=c["Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"]??c.subcategory??"",y=c.Ø§Ù„ÙˆØµÙ??c.description??c.name??"",p=c.Ø§Ù„ÙƒÙ…ÙŠØ©??c.quantity??0,v=c.Ø§Ù„Ø³Ø¹Ø±??c.price??0,l=c.Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯??c.barcode??"",b=c.Ø§Ù„Ø­Ø§Ù„Ø©??c.status??"Ù…ØªØ§Ø­",S=c.Ø§Ù„ØµÙˆØ±Ø©??c.image_url??c.image??"",A=E(String(l||"")).trim();if(!y||!A){s+=1;return}u.push(Be({category:f,subcategory:m,description:y,quantity:p,unit_price:v,barcode:A,status:b,image_url:S}))}),!u.length){g(d("equipment.toast.uploadEmpty","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"));return}try{const c=await j("/equipment/?bulk=1",{method:"POST",body:u}),f=Array.isArray(c?.data)?c.data.map(de):[];if(f.length){const p=[...x(),...f];O(p)}await ye({showToastOnError:!1}),F();const m=c?.meta?.count??f.length,y=[];m&&y.push(`${m} âœ”ï¸`),s&&y.push(`${s} âš ï¸`),g(d("equipment.toast.uploadSuccess","âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")+(y.length?` (${y.join(" / ")})`:""))}catch(c){const f=z(c,"equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„");g(f,"error")}}catch(a){console.error("âŒ [equipment.js] Failed to process Excel file",a),g(d("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")}},t.onerror=function(){console.error("âŒ [equipment.js] FileReader error",t.error),g(d("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")},t.readAsArrayBuffer(e)}const ht="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let K=null;function Et(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):K||(K=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",r,{once:!0}),n.addEventListener("error",o,{once:!0});return}const a=document.createElement("script");a.src=ht,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",r,{once:!0}),a.addEventListener("error",o,{once:!0}),document.head.appendChild(a);function r(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function o(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("âš ï¸ [equipment.js] ensureXLSXLoaded failed",e),K=null,e}),K)}function Be({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:r=0,barcode:o="",status:i="Ù…ØªØ§Ø­",image_url:u=""}){const s=E(String(o||"")).trim(),c=vt(i);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:Y(a),unit_price:le(r),barcode:s,status:c,image_url:u?.trim()||null}}async function St(){if(!J()){ce();return}if(confirm(d("equipment.toast.clearConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§ØªØŸ")))try{const t=(await j("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await ye({showToastOnError:!1}),g(d("equipment.toast.clearSuccess","ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")+(t?` (${t})`:""))}catch(e){const t=z(e,"equipment.toast.clearFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");g(t,"error")}}function fe(e){return e.image||e.imageUrl||e.img||""}function _t(e){const t=N(e),n={available:{label:d("equipment.form.options.available","âœ… Ù…ØªØ§Ø­"),className:"equipment-status-badge equipment-status-badge--available"},reserved:{label:d("equipment.form.options.booked","ğŸ“Œ Ù…Ø­Ø¬ÙˆØ²"),className:"equipment-status-badge equipment-status-badge--reserved"},maintenance:{label:d("equipment.form.options.maintenance","ğŸ› ï¸ ØµÙŠØ§Ù†Ø©"),className:"equipment-status-badge equipment-status-badge--maintenance"},retired:{label:d("equipment.form.options.retired","ğŸ“¦ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©"),className:"equipment-status-badge equipment-status-badge--retired"}},{label:a,className:r}=n[t]||{label:e||"-",className:"equipment-status-badge equipment-status-badge--default"};return`<span class="${r}">${a}</span>`}function oe(){const e=document.getElementById("equipment-variants-section"),t=document.getElementById("equipment-variants-table-body"),n=document.getElementById("equipment-variants-count");if(e&&(e.hidden=!0),t){const a=d("equipment.modal.variants.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ Ù…Ø±ØªØ¨Ø·Ø© Ø£Ø®Ø±Ù‰.");t.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${I(a)}</td></tr>`}n&&(n.textContent="0")}function He(e){const t=document.getElementById("equipment-variants-section"),n=document.getElementById("equipment-variants-table-body"),a=document.getElementById("equipment-variants-count");if(!t||!n||!e)return;const o=D?.groupKey||R(e);if(!o){oe();return}const i=x().filter(m=>R(m)===o).sort((m,y)=>{const p=String(m.barcode||"").trim(),v=String(y.barcode||"").trim();return!p&&!v?0:p?v?p.localeCompare(v,"ar",{numeric:!0,sensitivity:"base"}):-1:1});if(!i.length){oe();return}t.hidden=!1,a&&(a.textContent=String(i.length));const u=d("equipment.modal.variants.current","Ø§Ù„Ø­Ø§Ù„ÙŠ"),s=d("equipment.form.labels.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),c=x(),f=i.map(m=>{const y=m.id&&e.id?String(m.id)===String(e.id):String(m.barcode||"")===String(e.barcode||""),p=y?"equipment-variants-table__row--current":"",v=I(String(m.barcode||"-")),l=y?`<span class="equipment-variants-current-badge">${I(u)}</span>`:"",b=E(String(Number.isFinite(Number(m.qty))?Number(m.qty):0)),S=c.indexOf(m),A=I(d("equipment.item.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù")),B=S>=0?`<div class="table-action-buttons equipment-variant-actions">
            <button type="button" class="btn btn-sm btn-error equipment-variant-action equipment-variant-action--danger" data-variant-action="delete" data-variant-index="${S}">${A}</button>
          </div>`:"";return`
        <tr class="${p}">
          <td>
            ${v}
            ${l}
          </td>
          <td>${_t(m.status)}</td>
          <td>
            <span class="equipment-variants-qty" title="${I(s)}">${b}</span>
          </td>
          <td class="table-actions-cell">${B}</td>
        </tr>
      `}).join("");n.innerHTML=f}function At({item:e,index:t}){const n=fe(e),a=d("equipment.item.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),r=d("equipment.item.imageAlt","ØµÙˆØ±Ø©"),o=d("equipment.item.currency","SR"),i=J(),u={description:d("equipment.card.labels.description","Ø§Ù„ÙˆØµÙ"),status:d("equipment.card.labels.status","Ø§Ù„Ø­Ø§Ù„Ø©"),alias:d("equipment.card.labels.alias","Ø§Ù„Ø§Ø³Ù…"),quantity:d("equipment.card.labels.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),price:d("equipment.card.labels.price","Ø§Ù„Ø³Ø¹Ø±"),category:d("equipment.card.labels.category","Ø§Ù„Ù‚Ø³Ù…"),subcategory:d("equipment.card.labels.subcategory","Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"),barcode:d("equipment.card.labels.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),available:d("equipment.card.labels.available","Ù…ØªØ§Ø­")},s=Number.isFinite(Number(e.qty))?Number(e.qty):0,c=Number.isFinite(Number(e.price))?Number(e.price):0,f=s.toLocaleString("en-US"),m=c.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),y=Number.isFinite(Number(e.reservedQty))?Number(e.reservedQty):0,p=Number.isFinite(Number(e.maintenanceQty))?Number(e.maintenanceQty):0,v=Number.isFinite(Number(e.availableQty))?Number(e.availableQty):Math.max(s-y-p,0),l=v.toLocaleString("en-US"),b=d("equipment.card.labels.availableOfTotal","Ù…Ù† Ø£ØµÙ„"),S=N(e.status);let A=`${I(u.available)}: ${I(l)} ${I(b)} ${I(f)}`,B="available";if(v===0){const U={reserved:{text:s===1?d("equipment.card.availability.reservedSingle","Ù…Ø¤Ø¬Ø±Ø©"):d("equipment.card.availability.reserved","Ù…Ø¤Ø¬Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"),modifier:"reserved"},maintenance:{text:d("equipment.card.availability.maintenance","ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©"),modifier:"maintenance"},retired:{text:d("equipment.card.availability.retired","ØºÙŠØ± Ù…ØªØ§Ø­Ø©"),modifier:"retired"},default:{text:d("equipment.card.availability.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"),modifier:"unavailable"}},H=U[S]||U.default;A=I(H.text),B=H.modifier}const $=`<span class="equipment-card__availability equipment-card__availability--${B}">${A}</span>`,L="",q=e.desc||e.name||"â€”",h=e.name&&e.name!==e.desc?e.name:"",ee=`
    <div class="equipment-card__info-row equipment-card__info-row--center">
      ${[{label:u.quantity,value:f},{label:u.price,value:`${m} ${o}`}].map(({label:U,value:H})=>`
            <span class="equipment-card__info-item equipment-card__info-item--stacked">
              <span class="equipment-card__detail-label">${U}</span>
              <span class="equipment-card__detail-value">${H}</span>
            </span>
          `).join("")}
    </div>`,Q=[e.category?{label:u.category,value:e.category}:null,e.sub?{label:u.subcategory,value:e.sub}:null].filter(Boolean),Ge=Q.length?`<div class="equipment-card__categories">${Q.map(({label:U,value:H})=>`
            <div class="equipment-card__category">
              <span class="equipment-card__detail-label">${U}</span>
              <span class="equipment-card__detail-value">${H}</span>
            </div>
          `).join("")}</div>`:"",Je=h?`<div class="equipment-card__alias">
        <span class="equipment-card__detail-label">${u.alias}</span>
        <span class="equipment-card__detail-value">${h}</span>
      </div>`:"",Ye=`
    <div class="equipment-card__details">
      ${`
    <div class="equipment-card__description">
      <span class="equipment-card__label">${u.description}</span>
      <h3 class="equipment-card__title">${q}</h3>
    </div>
  `}
      ${ee}
    </div>
  `,be=[];i&&be.push(`<button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--delete" data-equipment-action="delete" data-equipment-index="${t}">${a}</button>`);const Ze=be.length?`<div class="equipment-card__actions equipment-card__actions--center">${be.join(`
`)}</div>`:"",et=I(q);return`
    <article
      class="equipment-card"
      data-equipment-index="${t}"
      data-equipment-card="true"
      role="listitem"
      tabindex="0"
      aria-label="${et}"
    >
      <div class="equipment-card__header">
      <div class="equipment-card__status-block">
        ${L}
        ${$}
      </div>
        <div class="equipment-card__media-wrapper">
          <div class="equipment-card__media" aria-hidden="true">
            ${n?`<img src="${n}" alt="${r}" loading="lazy">`:'<div class="equipment-card__placeholder">ğŸ“¦</div>'}
          </div>
          ${Ye}
        </div>
      </div>
      <div class="equipment-card__body">
        ${Ge}
        ${Je}
      </div>
      ${Ze}
    </article>
  `}function It(e){const t=[...new Set(e.map(i=>i.category).filter(Boolean))],n=[...new Set(e.map(i=>i.sub).filter(Boolean))],a=document.getElementById("filter-category"),r=document.getElementById("filter-sub");if(a){const i=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(u=>{const s=document.createElement("option");s.value=u,s.textContent=u,a.appendChild(s)}),t.includes(i)&&(a.value=i),ne(a)}if(r){const i=r.value;for(;r.options.length>1;)r.remove(1);n.forEach(u=>{const s=document.createElement("option");s.value=u,s.textContent=u,r.appendChild(s)}),n.includes(i)&&(r.value=i),ne(r)}const o=document.getElementById("filter-status");o&&ne(o)}function Xe(){const e=_e();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return P=t||[],P;const r=new Date;let o=!1;const i=new Set((a||[]).filter(s=>s?.status==="open").map(s=>E(String(s?.equipmentBarcode??"")).trim().toLowerCase())),u=t.map(s=>{if(!s)return s;const c=N(s.status),f=E(String(s.barcode??"")).trim().toLowerCase(),m=f&&i.has(f);let y=m?"maintenance":c;if(!m&&f)for(const p of n||[]){if(!Nt(p,r))continue;if(p.items?.some(l=>E(String(l?.barcode??"")).trim().toLowerCase()===f)){y="reserved";break}}return y!==c?(o=!0,{...s,status:y}):{...s,status:c}});return o?O(u):(P=u,Ae({equipment:P})),P}function Nt(e,t){if(!e?.start||!e?.end)return!1;const n=new Date(e.start),a=new Date(e.end);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?!1:n<=t&&t<a}function he(e,{tone:t="",icon:n="ğŸ“¦"}={}){const a=["equipment-empty-state"];return t&&a.push(`equipment-empty-state--${t}`),`
    <div class="${a.join(" ")}">
      <div class="equipment-empty-state__icon" aria-hidden="true">${n}</div>
      <p class="equipment-empty-state__text">${e}</p>
    </div>
  `}function F(){const e=document.getElementById("equipment-list");if(!e)return;const t=Xe(),n=Array.isArray(t)?t:x(),a=new Map;n.forEach(l=>{if(!l)return;const b=R(l);b&&(a.has(b)||a.set(b,[]),a.get(b).push(l))});const r=Array.from(a.values()).map(l=>{const b=l[0],S=l.reduce((h,_)=>h+(Number.isFinite(Number(_.qty))?Number(_.qty):0),0),A=["maintenance","reserved","available","retired"],B=l.map(h=>N(h.status)).sort((h,_)=>A.indexOf(h)-A.indexOf(_))[0]||"available",$=l.reduce((h,_)=>{const ee=Y(_?.qty??0)||0,Q=N(_?.status);return Q==="reserved"?h.reserved+=ee:Q==="maintenance"&&(h.maintenance+=ee),h},{reserved:0,maintenance:0}),L=Math.max(S-$.reserved-$.maintenance,0);return{item:{...b,qty:S,status:B,variants:l,groupKey:R(b),reservedQty:$.reserved,maintenanceQty:$.maintenance,availableQty:L},index:n.indexOf(b)}});r.sort((l,b)=>qt(l.item,b.item));const o=document.getElementById("search-equipment")?.value||"",i=E(o).toLowerCase().trim(),u=document.getElementById("filter-category")?.value||"",s=document.getElementById("filter-sub")?.value||"",c=document.getElementById("filter-status")?.value||"",f=c?N(c):"";if(Se&&!n.length){e.innerHTML=he(d("equipment.list.loading","â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª..."),{icon:"â³"});return}if(G&&!n.length){e.innerHTML=he(G,{tone:"error",icon:"âš ï¸"});return}const m=r.filter(({item:l})=>{const b=E(String(l.barcode??"")).toLowerCase().trim(),S=Array.isArray(l.variants)?l.variants.map(q=>E(String(q.barcode??"")).toLowerCase().trim()).filter(Boolean):[],A=!i||l.name&&l.name.toLowerCase().includes(i)||l.desc&&l.desc.toLowerCase().includes(i)||b&&b.includes(i)||S.some(q=>q.includes(i))||l.category&&l.category.toLowerCase().includes(i)||l.sub&&l.sub.toLowerCase().includes(i),B=!u||l.category===u,$=!s||l.sub===s,L=!f||N(l.status)===f;return A&&B&&$&&L}),y=i?d("equipment.list.emptyFiltered","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©."):d("equipment.list.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯."),p=m;e.innerHTML=p.length?p.map(At).join(""):he(y);const v=document.getElementById("equipment-list-count");if(v){const l=d("equipment.list.countSuffix","Ø¹Ù†ØµØ±"),b=E(String(p.length)),S=p.length?`${b} ${l}`:`0 ${l}`;v.textContent=S}It(n)}async function ye({showToastOnError:e=!0}={}){Se=!0,G="",F();try{const t=await j("/equipment/?all=1"),n=Array.isArray(t?.data)?t.data.map(de):[];O(n)}catch(t){G=z(t,"equipment.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),e&&g(G,"error")}finally{Se=!1,F()}}function z(e,t,n){if(e instanceof De){const a=e.payload?.errors;if(a&&typeof a=="object"){const r=Object.values(a)[0];if(Array.isArray(r))return r[0];if(typeof r=="string")return r}if(e.message)return e.message}return d(t,n)}async function Lt(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",r=E(a).trim(),o=le(t.querySelector("#new-equipment-price")?.value||"0"),i=Y(t.querySelector("#new-equipment-qty")?.value||"1"),u=t.querySelector("#new-equipment-image")?.value?.trim()||"",s=t.querySelector("#new-equipment-category")?.value?.trim()||"",c=t.querySelector("#new-equipment-sub")?.value?.trim()||"",f=t.querySelector("#new-equipment-status")?.value||"Ù…ØªØ§Ø­";if(!n||!r){g(d("equipment.toast.missingFields","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"));return}const m=Be({category:s,subcategory:c,description:n,quantity:i,unit_price:o,barcode:r,status:f,image_url:u});try{const y=await j("/equipment/",{method:"POST",body:m}),p=de(y?.data),v=[...x(),p];O(v),F(),t.reset();const l=t.querySelector("#new-equipment-status");l&&(l.value="Ù…ØªØ§Ø­"),g(d("equipment.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø©"))}catch(y){const p=z(y,"equipment.toast.addFailed","ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø©");g(p,"error")}}async function Ve(e){if(!J()){ce();return}const t=x(),n=t[e];if(n&&confirm(d("equipment.toast.deleteConfirm","âŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø©ØŸ")))try{n.id&&await j(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),O(a),F(),g(d("equipment.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø¯Ø©"))}catch(a){const r=z(a,"equipment.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹");g(r,"error")}}async function xt(e,t){const n=x(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const o=[...n];o[e]={...o[e],...t},O(o),F();return}const r=Be({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image});try{const o=await j(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:r}),i=de(o?.data),u=[...n];u[e]=i,O(u),F(),g(d("equipment.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­"))}catch(o){const i=z(o,"equipment.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©");throw g(i,"error"),o}}function te(){F()}function ze(e){const n=x()[e];if(!n)return;w=e;const a=me(n),r=a[0]||n,o=a.reduce((s,c)=>s+(Number.isFinite(Number(c.qty))?Number(c.qty):0),0),i=["maintenance","reserved","available","retired"],u=a.map(s=>N(s.status)).sort((s,c)=>i.indexOf(s)-i.indexOf(c))[0]||N(r.status);document.getElementById("edit-equipment-index").value=e,xe({category:r.category||"",subcategory:r.sub||"",description:r.desc||r.description||"",quantity:String(o||r.qty||0),price:r.price!=null?String(r.price):"0",image:fe(r)||"",barcode:r.barcode||"",status:r.status||u}),X(!1),k=se(),pe(r),He(r),D={groupKey:R(r),barcode:String(r.barcode||""),id:r.id||null},pt(document.getElementById("editEquipmentModal"))?.show()}function Bt(e){const t=e.target.closest('[data-equipment-action="delete"]');if(t){e.preventDefault(),e.stopPropagation();const a=Number(t.dataset.equipmentIndex);Number.isNaN(a)||Ve(a).catch(r=>{console.error("âŒ [equipment.js] deleteEquipment",r)});return}const n=e.target.closest('[data-equipment-card="true"]');if(n){const a=Number(n.dataset.equipmentIndex);Number.isNaN(a)||ze(a)}}function Ct(e){if(e.defaultPrevented||e.target.closest("[data-equipment-action]"))return;const t=e.target.closest('[data-equipment-card="true"]');if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const n=Number(t.dataset.equipmentIndex);Number.isNaN(n)||ze(n)}}function Ft(e){const t=e.target.closest('[data-variant-action="delete"]');if(t){const n=Number(t.dataset.variantIndex);Number.isNaN(n)||Ve(n).catch(a=>{console.error("âŒ [equipment.js] deleteEquipment",a)});return}}function Qe(){if(!D||!document.getElementById("editEquipmentModal")?.classList.contains("show"))return;const n=x(),a=D.id?n.find(s=>String(s.id)===String(D.id)):null,r=D.groupKey,o=r?n.find(s=>R(s)===r):null,i=a||o;if(!i){oe();return}const u=n.findIndex(s=>s===i);if(u>=0){const s=document.getElementById("edit-equipment-index");s&&(s.value=String(u)),w=u}if(He(i),!ue){const s=me(i),c=s[0]||i,f=s.reduce((p,v)=>p+(Number.isFinite(Number(v.qty))?Number(v.qty):0),0),m=["maintenance","reserved","available","retired"],y=s.map(p=>N(p.status)).sort((p,v)=>m.indexOf(p)-m.indexOf(v))[0]||N(c.status);xe({category:c.category||"",subcategory:c.sub||"",description:c.desc||c.description||"",quantity:String(f||c.qty||0),price:c.price!=null?String(c.price):"0",image:fe(c)||"",barcode:c.barcode||"",status:c.status||y}),k=se()}pe(primary)}function $t(){document.getElementById("search-equipment")?.addEventListener("input",te),document.getElementById("filter-category")?.addEventListener("change",te),document.getElementById("filter-sub")?.addEventListener("change",te),document.getElementById("filter-status")?.addEventListener("change",te),document.getElementById("add-equipment-form")?.addEventListener("submit",Lt);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",a=>{a.preventDefault(),St().catch(r=>{console.error("âŒ [equipment.js] clearEquipment",r)})}),e.dataset.listenerAttached="true");const t=document.getElementById("equipment-list");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",Bt),t.addEventListener("keydown",Ct),t.dataset.listenerAttached="true");const n=document.getElementById("equipment-variants-table-body");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ft),n.dataset.listenerAttached="true"),["edit-equipment-quantity","edit-equipment-price","edit-equipment-barcode"].forEach(a=>{const r=document.getElementById(a);bt(r)})}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{if(!ue){k=se(),X(!0);return}const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){g(d("equipment.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:Y(document.getElementById("edit-equipment-quantity").value)||1,price:le(document.getElementById("edit-equipment-price").value)||0,barcode:E(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value};try{await xt(t,n),k=se(),X(!1),Qe()}catch(a){console.error("âŒ [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{$t(),F(),ye();const e=document.getElementById("equipment-edit-cancel");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{if(k&&xe(k),w!=null){const a=x()[w];if(a){const o=me(a)[0]||a;pe(o)}}X(!1)}),e.dataset.listenerAttached="true");const t=document.getElementById("save-equipment-changes");t&&!t.dataset.listenerAttached&&(t.dataset.listenerAttached="true",t.dataset.mode||(t.dataset.mode="view"))});document.addEventListener("language:changed",()=>{if(F(),X(ue),w!=null){const t=x()[w];if(t){const a=me(t)[0]||t;pe(a)}}});document.addEventListener("equipment:refreshRequested",()=>{ye({showToastOnError:!1})});document.addEventListener(tt.USER_UPDATED,()=>{F()});document.addEventListener("equipment:changed",()=>{Qe()});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editEquipmentModal");e&&!e.dataset.variantsListenerAttached&&(e.addEventListener("hidden.bs.modal",()=>{D=null,oe(),w=null,k=null,X(!1)}),e.dataset.variantsListenerAttached="true")});function Ke(e=""){return E(String(e)).trim().toLowerCase()}const jt=2;function Tt(e){const t=Number(e);return Number.isFinite(t)?t.toFixed(jt):"0.00"}function Te(e={}){const t=Number(e?.qty);return Number.isFinite(t)&&t>0?t:1}function Mt(e={}){const t=e?.desc||e?.description||e?.name||"",n=Ke(t),a=Tt(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${a}`}function Qt(e=[]){const t=new Map;return e.forEach((n,a)=>{const r=Mt(n);if(!r)return;if(!t.has(r)){const i=n?.desc||n?.description||n?.name||"",u=Ke(i),s=Me(n),c=n?.image||n?.imageUrl||n?.img||"";t.set(r,{key:r,description:i,normalizedDescription:u,unitPrice:s,image:c,items:[],itemIndices:[],barcodes:[]})}const o=t.get(r);o.items.push(n),o.itemIndices.push(a),n?.barcode&&o.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((a,r)=>a+Te(r),0)})).map(n=>{const a=n.quantity||0,r=n.items.reduce((i,u)=>{const s=Me(u),c=Te(u);return i+s*c},0),o=a>0?r/a:n.unitPrice;return{...n,quantity:a,count:a,totalPrice:r,unitPrice:o}})}function Kt(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function Me(e={}){const t=e?.price??e?.unit_price??e?.unitPrice??0,n=Number(t);return Number.isFinite(n)?n:0}function Wt(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Pt(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Rt(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,r=a!=null&&a!==""&&a!=="null",o=r?Pt(t?.status??t?.status_label??t?.statusLabel??""):null,i=r&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:n,projectLinked:r,projectStatus:o,projectConfirmed:i,effectiveConfirmed:r?i:n}}function We(){const e=()=>{Xe(),it()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(e,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(e);return}}e()}let Pe=!1,Re=null;function Dt(e){if(!e||typeof e!="object")return"";const t=Object.entries(e).filter(([n,a])=>a!=null).map(([n,a])=>[n,String(a)]);return t.length===0?"":JSON.stringify(t.sort(([n],[a])=>n.localeCompare(a)))}async function Gt(e={}){const{suppressError:t=!0,params:n=null,force:a=!1}=e??{},r=Dt(n);if(!a&&Pe&&W().length>0&&r===Re)return W();try{const o=await nt(n||{});return Pe=!0,Re=r,o}catch(o){if(console.error("âŒ [reservationsActions] Failed to load reservations from API",o),!t)throw o;return W()}}async function Jt(e,{onAfterChange:t}={}){if(!J())return ce(),!1;const a=W()[e];if(!a)return g(d("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const r=a.id||a.reservationId;if(!r)return g(d("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;try{return await at(r),We(),t?.({type:"deleted",reservation:a}),g(d("reservations.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²")),!0}catch(o){console.error("âŒ [reservationsActions] deleteReservation failed",o);const i=we(o)?o.message:d("reservations.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return g(i,"error"),!1}}async function Yt(e,{onAfterChange:t}={}){const a=W()[e];if(!a)return g(d("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const r=a.id||a.reservationId;if(!r)return g(d("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const{projectLinked:o}=Rt(a);if(o)return g(d("reservations.toast.confirmBlockedByProject","âš ï¸ Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² ØªØªØ­ÙƒÙ… Ø¨Ù‡Ø§ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø· ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ£ÙƒÙŠØ¯Ù‡ Ù…Ù† Ù‡Ù†Ø§"),"info"),!1;try{const i=await rt(r);return We(),t?.({type:"confirmed",reservation:i}),g(d("reservations.toast.confirmed","âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²")),!0}catch(i){console.error("âŒ [reservationsActions] confirmReservation failed",i);const u=we(i)?i.message:d("reservations.toast.confirmFailed","ØªØ¹Ø°Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return g(u,"error"),!1}}const wt=_e()||{};let C=(wt.projects||[]).map(Ot),Z=!1;function Zt(){return C}function ge(e){C=Array.isArray(e)?e.map(Fe):[],Ae({projects:C});try{const t=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(t),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(t)}catch(t){console.warn("âš ï¸ [projectsService] Failed to dispatch projects:changed event",t)}return C}async function kt(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([u,s])=>{s==null||s===""||t.set(u,String(s))});const n=t.toString(),r=(await j(`/projects/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(r)?o=r:r&&typeof r=="object"&&(Array.isArray(r.items)?o=r.items:Array.isArray(r.results)?o=r.results:Array.isArray(r.data)?o=r.data:Array.isArray(r.records)&&(o=r.records));const i=o.map(Ce);return ge(i),Z=!0,C}async function en({force:e=!1,params:t=null}={}){if(!e&&Z&&C.length>0)return C;try{return await kt(t||{})}catch(n){return console.error("âŒ [projectsService] Failed to load projects from API",n),C}}async function tn(e){const t=await j("/projects/",{method:"POST",body:e}),n=Ce(t?.data??{}),a=[...C,n];return ge(a),Z=!0,n}async function nn(e,t){const n=await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Ce(n?.data??{}),r=C.map(o=>String(o.id)===String(e)?a:o);return ge(r),Z=!0,a}async function an(e){await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=C.filter(n=>String(n.id)!==String(e));ge(t),Z=!0}function rn({projectCode:e,title:t,type:n,clientId:a,clientCompany:r,description:o,start:i,end:u,applyTax:s,paymentStatus:c,equipmentEstimate:f=0,expenses:m=[],taxAmount:y=0,totalWithTax:p=0,confirmed:v=!1,technicians:l=[],equipment:b=[]}={}){const S=Array.isArray(l)?l.map(q=>Number.parseInt(String(q),10)).filter(q=>Number.isInteger(q)&&q>0):[],A=Array.isArray(b)?b.map(q=>{const h=Number.parseInt(String(q.equipmentId??q.equipment_id??q.id??0),10),_=Number.parseInt(String(q.qty??q.quantity??0),10);return!Number.isInteger(h)||h<=0?null:{equipment_id:h,quantity:Number.isInteger(_)&&_>0?_:1}}).filter(Boolean):[],B=Array.isArray(m)?m.map(q=>{const h=Number.parseFloat(q?.amount??q?.value??0)||0,_=(q?.label??q?.name??"").trim();return _?{label:_,amount:Math.round(h*100)/100}:null}).filter(Boolean):[],$=B.reduce((q,h)=>q+(h?.amount??0),0),L={title:t,type:n,client_id:a?Number.parseInt(String(a),10):null,client_company:r??null,description:o??null,start_datetime:i??null,end_datetime:u||null,apply_tax:!!s,payment_status:c??"unpaid",equipment_estimate:Number.parseFloat(f)||0,expenses_total:Math.round($*100)/100,tax_amount:Math.round((Number.parseFloat(y)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(p)||0)*100)/100,confirmed:!!v,technicians:S,equipment:A,expenses:B};return e&&(L.project_code=String(e).trim()),L.end_datetime||delete L.end_datetime,L.client_company||(L.client_company=null),L}function Ce(e={}){return Fe(e)}function Ot(e={}){return Fe(e)}function Fe(e={}){const t=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],a=n.map(s=>{if(s==null)return null;if(typeof s=="object"){const c=s.id??s.technician_id??s.technicianId;return c!=null?String(c):null}return String(s)}).filter(Boolean),o=(Array.isArray(e.equipment)?e.equipment:[]).map(s=>{const c=s?.equipment_id??s?.equipmentId??s?.id??null,f=s?.quantity??s?.qty??0,m=s?.barcode??s?.code??"",y=s?.description??s?.name??"";return{equipmentId:c!=null?String(c):null,qty:Number.parseInt(String(f),10)||0,barcode:m,description:y}}),u=(Array.isArray(e.expenses)?e.expenses:[]).map((s,c)=>({id:s?.id??`expense-${t??"x"}-${c}`,label:s?.label??"",amount:Number.parseFloat(s?.amount??0)||0}));return{id:t!=null?String(t):"",projectId:t!=null?Number(t):null,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:n.map(s=>typeof s=="object"?s:{id:s}),equipment:o,expenses:u}}function sn(e){return e instanceof De}export{ye as a,F as b,Vt as c,rn as d,Gt as e,nn as f,en as g,Zt as h,Wt as i,an as j,kt as k,sn as l,Ce as m,Ke as n,tn as o,Qt as p,Kt as q,Rt as r,Xe as s,Mt as t,zt as u,Jt as v,Yt as w};
