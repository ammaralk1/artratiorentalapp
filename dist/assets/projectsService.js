import{d as V,n as q,f as Dt,t as l,b as L,h as A,j as ue,o as Ae,s as Ne,A as ze}from"./auth.js";import{s as ft}from"./technicians.js";const ke="select.form-select:not([data-no-enhance]):not([multiple])",k=new WeakMap;let je=null,it=!1,j=null;function wn(e=document){e&&(e.querySelectorAll(ke).forEach(t=>ye(t)),!je&&e===document&&(je=new MutationObserver(t=>{for(const n of t)n.addedNodes?.forEach(a=>{a instanceof Element&&(a.matches?.(ke)&&ye(a),a.querySelectorAll?.(ke).forEach(i=>ye(i)))})}),je.observe(document.body,{childList:!0,subtree:!0})),it||(it=!0,document.addEventListener("pointerdown",jt,{capture:!0})))}function fe(e){if(!(e instanceof HTMLSelectElement))return;if(!e.dataset.enhancedSelect){ye(e);return}const t=e.closest(".enhanced-select");t&&(Ve(t),ge(t),Oe(t))}function ye(e){if(!(e instanceof HTMLSelectElement))return;if(e.dataset.enhancedSelect){fe(e);return}if(e.multiple||e.size>1)return;const t=document.createElement("div");t.className="enhanced-select";const n=e.parentNode;n&&n.insertBefore(t,e),t.appendChild(e),e.dataset.enhancedSelect="true",e.classList.add("enhanced-select__native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const a=document.createElement("button");a.type="button",a.className="enhanced-select__trigger",a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const i=document.createElement("ul");i.className="enhanced-select__menu",i.setAttribute("role","listbox"),i.setAttribute("tabindex","-1"),t.append(a,i);const o={select:e,trigger:a,menu:i,observer:null,refreshRaf:null};k.set(t,o),a.addEventListener("click",()=>kt(t)),a.addEventListener("keydown",r=>Rt(r,t)),i.addEventListener("click",r=>Ht(r,t)),i.addEventListener("keydown",r=>Ot(r,t)),e.addEventListener("change",()=>{ge(t),yt(t)}),o.observer=new MutationObserver(r=>{let c=!1,s=!1;for(const u of r)u.type==="attributes"&&u.attributeName==="disabled"&&(s=!0),u.type==="childList"&&(c=!0);s&&Oe(t),c&&Mt(o,t)}),o.observer.observe(e,{attributes:!0,attributeFilter:["disabled"],childList:!0}),Ve(t),ge(t),Oe(t)}function Mt(e,t){e&&(e.refreshRaf||(e.refreshRaf=requestAnimationFrame(()=>{e.refreshRaf=null,Ve(t),ge(t)})))}function Ve(e){const t=k.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const i=Array.from(n.options||[]),o=document.createDocumentFragment();i.forEach(r=>{const c=document.createElement("li");c.className="enhanced-select__option",c.textContent=r.textContent??r.value??"",c.dataset.value=r.value??"",c.setAttribute("role","option"),c.setAttribute("tabindex","-1"),r.disabled&&(c.setAttribute("aria-disabled","true"),c.classList.add("is-disabled")),r.selected&&(c.setAttribute("aria-selected","true"),c.dataset.selected="true",c.setAttribute("tabindex","0")),o.appendChild(c)}),a.innerHTML="",a.appendChild(o),yt(e)}function ge(e){const t=k.get(e);if(!t)return;const{select:n,trigger:a}=t;if(!n||!a)return;const i=n.selectedOptions?.[0]??n.options?.[n.selectedIndex],o=i?.textContent?.trim()||i?.value||"";a.textContent=o}function yt(e){const t=k.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const i=n.value;a.querySelectorAll(".enhanced-select__option").forEach(r=>{const c=r.dataset.value===i;r.toggleAttribute("aria-selected",c),r.dataset.selected=c?"true":"",r.setAttribute("tabindex",c?"0":"-1")})}function Oe(e){const t=k.get(e);if(!t)return;const{select:n,trigger:a}=t,i=!!n?.disabled;e.classList.toggle("enhanced-select--disabled",i),a.disabled=i}function kt(e){k.get(e)&&(e.getAttribute("data-open")==="true"?ae(e):gt(e))}function gt(e){const t=k.get(e);if(!t)return;j&&j!==e&&ae(j,{focusTrigger:!1}),e.setAttribute("data-open","true"),t.trigger.setAttribute("aria-expanded","true"),j=e;const n=t.menu.querySelector('.enhanced-select__option[aria-selected="true"]')??t.menu.querySelector(".enhanced-select__option:not([aria-disabled='true'])");n?n.focus():t.menu.focus()}function ae(e,{focusTrigger:t=!0}={}){const n=k.get(e);n&&(e.setAttribute("data-open","false"),n.trigger.setAttribute("aria-expanded","false"),t&&n.trigger.focus({preventScroll:!0}),j===e&&(j=null))}function jt(e){if(!j)return;const t=e.target;t instanceof Node&&(j.contains(t)||ae(j,{focusTrigger:!1}))}function Rt(e,t){const n=e.key;n==="ArrowDown"||n==="ArrowUp"||n===" "||n==="Enter"?(e.preventDefault(),gt(t)):n==="Escape"&&ae(t)}function Ot(e,t){const n=e.key,a=k.get(t);if(!a)return;const i=Array.from(a.menu.querySelectorAll(".enhanced-select__option:not([aria-disabled='true'])"));if(!i.length)return;const o=i.findIndex(r=>r===document.activeElement);if(n==="ArrowDown"||n==="ArrowUp"){e.preventDefault();const c=(o+(n==="ArrowDown"?1:-1)+i.length)%i.length;i[c].focus()}else if(n==="Home")e.preventDefault(),i[0].focus();else if(n==="End")e.preventDefault(),i[i.length-1].focus();else if(n==="Enter"||n===" "){e.preventDefault();const r=document.activeElement;r&&r.classList.contains("enhanced-select__option")&&bt(r,t)}else n==="Escape"&&(e.preventDefault(),ae(t))}function Ht(e,t){const n=e.target?.closest?.(".enhanced-select__option");n&&bt(n,t)}function bt(e,t){const n=k.get(t);if(!n||e.getAttribute("aria-disabled")==="true")return;const{select:a}=n,i=e.dataset.value??"";a.value!==i&&(a.value=i,a.dispatchEvent(new Event("change",{bubbles:!0}))),ae(t)}const zt=V()||{};let H=(zt.equipment||[]).map(wt),He=!1,oe="",w=null,K=null,W=null,Ie=!1;function Vt(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function Ut(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function wt(e={}){return Ue({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function xe(e={}){return Ue(e)}function Ue(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",i=e.subcategory??e.sub??"",o=le(e.quantity??e.qty??0),r=Le(e.unit_price??e.price??0),c=q(String(e.barcode??"").trim()),s=C(e.status??e.state??e.status_label??e.statusLabel??"available"),u=e.image_url??e.imageUrl??e.image??"",p=e.name??e.item_name??n;return{id:Xt(t)?String(t):"",category:a,sub:i,desc:n,name:p,qty:o,price:r,barcode:c,status:s,image:u,imageUrl:u,created_at:e.created_at??null,updated_at:e.updated_at??null}}function Xt(e){return e!=null&&e!==""}function le(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function Le(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function Qt(e){!e||e.dataset.englishDigitsAttached||(e.addEventListener("input",()=>{const{selectionStart:t,selectionEnd:n,value:a}=e,i=q(a);if(i!==a&&(e.value=i,t!=null&&n!=null)){const o=i.length-a.length,r=t+o,c=n+o;e.setSelectionRange(r,c)}}),e.dataset.englishDigitsAttached="true")}function rt(e){if(!e)return"";const t=q(String(e.barcode??"")).trim();if(t)return t;if(Array.isArray(e.variants))for(const n of e.variants){const a=q(String(n?.barcode??"")).trim();if(a)return a}return""}function Kt(e,t){const n=rt(e),a=rt(t);if(!n&&!a)return 0;if(!n)return 1;if(!a)return-1;const i=/^[0-9]+$/,o=i.test(n),r=i.test(a);if(o&&r){if(n.length!==a.length)return n.length-a.length;const u=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(u!==0)return u}else{if(o!==r)return o?-1:1;{const u=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(u!==0)return u}}const c=be(e?.desc||e?.description||e?.name||""),s=be(t?.desc||t?.description||t?.name||"");return c.localeCompare(s,"ar",{sensitivity:"base"})}function T(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function C(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":case"Ù…ØªÙˆÙØ±":return"available";case"reserved":case"Ù…Ø­Ø¬ÙˆØ²":return"reserved";case"maintenance":case"ØµÙŠØ§Ù†Ø©":return"maintenance";case"retired":case"Ù…ØªÙˆÙ‚Ù":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"retired";default:return"available"}}function Wt(e){return C(e)}function B(){return H}function G(e){H=Array.isArray(e)?e.map(Ue):[],Ne({equipment:H}),Ut()}function be(e){return String(e??"").trim().toLowerCase()}function z(e){if(!e)return"";const t=e.desc||e.description||e.name||"";let n=be(t);return n||(n=be(e.category||"")),n||(n=q(String(e.barcode||"")).trim().toLowerCase()),n}function Te(e){const t=z(e);return t?B().filter(n=>z(n)===t):[]}function Ce(e){const t=document.getElementById("equipment-details-cover");if(!t)return;const n=Be(e);if(n){const a=T(e.desc||e.description||e.name||"");t.innerHTML=`<img src="${T(n)}" alt="${a}">`,t.classList.add("has-image")}else t.innerHTML='<span class="equipment-details-header__placeholder" aria-hidden="true">ğŸ“¦</span>',t.classList.remove("has-image")}function we(){return{category:document.getElementById("edit-equipment-category"),subcategory:document.getElementById("edit-equipment-subcategory"),description:document.getElementById("edit-equipment-description"),quantity:document.getElementById("edit-equipment-quantity"),price:document.getElementById("edit-equipment-price"),image:document.getElementById("edit-equipment-image"),barcode:document.getElementById("edit-equipment-barcode"),status:document.getElementById("edit-equipment-status")}}function he(){const e=we();return{category:e.category?.value??"",subcategory:e.subcategory?.value??"",description:e.description?.value??"",quantity:e.quantity?.value??"",price:e.price?.value??"",image:e.image?.value??"",barcode:e.barcode?.value??"",status:e.status?.value??""}}function Xe(e={}){const t=we();t.category&&(t.category.value=e.category??""),t.subcategory&&(t.subcategory.value=e.subcategory??""),t.description&&(t.description.value=e.description??""),t.quantity&&(t.quantity.value=e.quantity!=null?q(String(e.quantity)):""),t.price&&(t.price.value=e.price!=null?q(String(e.price)):""),t.image&&(t.image.value=e.image??""),t.barcode&&(t.barcode.value=e.barcode??""),t.status&&(t.status.value=e.status??"")}function ee(e){Ie=e;const t=we(),n=document.getElementById("equipment-edit-cancel"),a=document.getElementById("save-equipment-changes"),i=document.getElementById("edit-equipment-form");if(i&&i.classList.toggle("equipment-details-form--editing",e),[t.category,t.subcategory,t.description,t.quantity,t.price,t.image].forEach(r=>{r&&(e?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"))}),n&&(n.hidden=!e,n.disabled=!e),a){a.disabled=!1;const r=e?"equipment.modal.actions.save":"equipment.modal.actions.edit",c=e?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"âœï¸ ØªØ¹Ø¯ÙŠÙ„";a.textContent=l(r,c),a.dataset.mode=e?"save":"view"}if(e){const r=t.description||t.category||t.subcategory;r&&setTimeout(()=>{r.focus(),typeof r.select=="function"&&r.select()},0)}}async function Xn(e){if(!ue()){Ae();return}if(!e)return;try{await Yt()}catch(n){console.error("âŒ [equipment.js] Unable to load XLSX",n),alert(l("equipment.toast.xlsxMissing","âš ï¸ Ù…ÙƒØªØ¨Ø© Excel (XLSX) ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),i=XLSX.read(a,{type:"array"}),o=i.Sheets[i.SheetNames[0]],r=XLSX.utils.sheet_to_json(o,{defval:""});if(!Array.isArray(r)||r.length===0){A(l("equipment.toast.uploadEmpty","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"));return}const c=[];let s=0;if(r.forEach(u=>{const p=u.Ø§Ù„Ù‚Ø³Ù…??u.category??"",d=u["Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"]??u.subcategory??"",y=u.Ø§Ù„ÙˆØµÙ??u.description??u.name??"",f=u.Ø§Ù„ÙƒÙ…ÙŠØ©??u.quantity??0,h=u.Ø§Ù„Ø³Ø¹Ø±??u.price??0,m=u.Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯??u.barcode??"",g=u.Ø§Ù„Ø­Ø§Ù„Ø©??u.status??"Ù…ØªØ§Ø­",v=u.Ø§Ù„ØµÙˆØ±Ø©??u.image_url??u.image??"",_=q(String(m||"")).trim();if(!y||!_){s+=1;return}c.push(Qe({category:p,subcategory:d,description:y,quantity:f,unit_price:h,barcode:_,status:g,image_url:v}))}),!c.length){A(l("equipment.toast.uploadEmpty","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù"));return}try{const u=await L("/equipment/?bulk=1",{method:"POST",body:c}),p=Array.isArray(u?.data)?u.data.map(xe):[];if(p.length){const f=[...B(),...p];G(f)}await $e({showToastOnError:!1}),D();const d=u?.meta?.count??p.length,y=[];d&&y.push(`${d} âœ”ï¸`),s&&y.push(`${s} âš ï¸`),A(l("equipment.toast.uploadSuccess","âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")+(y.length?` (${y.join(" / ")})`:""))}catch(u){const p=ie(u,"equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„");A(p,"error")}}catch(a){console.error("âŒ [equipment.js] Failed to process Excel file",a),A(l("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")}},t.onerror=function(){console.error("âŒ [equipment.js] FileReader error",t.error),A(l("equipment.toast.uploadFailed","âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„"),"error")},t.readAsArrayBuffer(e)}const Gt="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let se=null;function Yt(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):se||(se=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",i,{once:!0}),n.addEventListener("error",o,{once:!0});return}const a=document.createElement("script");a.src=Gt,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",i,{once:!0}),a.addEventListener("error",o,{once:!0}),document.head.appendChild(a);function i(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function o(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("âš ï¸ [equipment.js] ensureXLSXLoaded failed",e),se=null,e}),se)}function Qe({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:i=0,barcode:o="",status:r="Ù…ØªØ§Ø­",image_url:c=""}){const s=q(String(o||"")).trim(),u=Wt(r);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:le(a),unit_price:Le(i),barcode:s,status:u,image_url:c?.trim()||null}}async function Jt(){if(!ue()){Ae();return}if(confirm(l("equipment.toast.clearConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§ØªØŸ")))try{const t=(await L("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await $e({showToastOnError:!1}),A(l("equipment.toast.clearSuccess","ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")+(t?` (${t})`:""))}catch(e){const t=ie(e,"equipment.toast.clearFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");A(t,"error")}}function Be(e){return e.image||e.imageUrl||e.img||""}function Zt(e){const t=C(e),n={available:{label:l("equipment.form.options.available","âœ… Ù…ØªØ§Ø­"),className:"equipment-status-badge equipment-status-badge--available"},reserved:{label:l("equipment.form.options.booked","ğŸ“Œ Ù…Ø­Ø¬ÙˆØ²"),className:"equipment-status-badge equipment-status-badge--reserved"},maintenance:{label:l("equipment.form.options.maintenance","ğŸ› ï¸ ØµÙŠØ§Ù†Ø©"),className:"equipment-status-badge equipment-status-badge--maintenance"},retired:{label:l("equipment.form.options.retired","ğŸ“¦ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©"),className:"equipment-status-badge equipment-status-badge--retired"}},{label:a,className:i}=n[t]||{label:e||"-",className:"equipment-status-badge equipment-status-badge--default"};return`<span class="${i}">${a}</span>`}function ve(){const e=document.getElementById("equipment-variants-section"),t=document.getElementById("equipment-variants-table-body"),n=document.getElementById("equipment-variants-count");if(e&&(e.hidden=!0),t){const a=l("equipment.modal.variants.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ Ù…Ø±ØªØ¨Ø·Ø© Ø£Ø®Ø±Ù‰.");t.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${T(a)}</td></tr>`}n&&(n.textContent="0")}function ht(e){const t=document.getElementById("equipment-variants-section"),n=document.getElementById("equipment-variants-table-body"),a=document.getElementById("equipment-variants-count");if(!t||!n||!e)return;const o=w?.groupKey||z(e);if(!o){ve();return}const r=B().filter(d=>z(d)===o).sort((d,y)=>{const f=String(d.barcode||"").trim(),h=String(y.barcode||"").trim();return!f&&!h?0:f?h?f.localeCompare(h,"ar",{numeric:!0,sensitivity:"base"}):-1:1});if(!r.length){ve();return}t.hidden=!1,a&&(a.textContent=String(r.length));const c=l("equipment.modal.variants.current","Ø§Ù„Ø­Ø§Ù„ÙŠ"),s=l("equipment.form.labels.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),u=B(),p=r.map(d=>{const y=d.id&&e.id?String(d.id)===String(e.id):String(d.barcode||"")===String(e.barcode||""),f=y?"equipment-variants-table__row--current":"",h=T(String(d.barcode||"-")),m=y?`<span class="equipment-variants-current-badge">${T(c)}</span>`:"",g=q(String(Number.isFinite(Number(d.qty))?Number(d.qty):0)),v=u.indexOf(d),_=T(l("equipment.item.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù")),b=v>=0?`<div class="table-action-buttons equipment-variant-actions">
            <button type="button" class="btn btn-sm btn-error equipment-variant-action equipment-variant-action--danger" data-variant-action="delete" data-variant-index="${v}">${_}</button>
          </div>`:"";return`
        <tr class="${f}">
          <td>
            ${h}
            ${m}
          </td>
          <td>${Zt(d.status)}</td>
          <td>
            <span class="equipment-variants-qty" title="${T(s)}">${g}</span>
          </td>
          <td class="table-actions-cell">${b}</td>
        </tr>
      `}).join("");n.innerHTML=p}function en({item:e,index:t}){const n=Be(e),a=l("equipment.item.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),i=l("equipment.item.imageAlt","ØµÙˆØ±Ø©"),o=l("equipment.item.currency","SR"),r=ue(),c={description:l("equipment.card.labels.description","Ø§Ù„ÙˆØµÙ"),status:l("equipment.card.labels.status","Ø§Ù„Ø­Ø§Ù„Ø©"),alias:l("equipment.card.labels.alias","Ø§Ù„Ø§Ø³Ù…"),quantity:l("equipment.card.labels.quantity","Ø§Ù„ÙƒÙ…ÙŠØ©"),price:l("equipment.card.labels.price","Ø§Ù„Ø³Ø¹Ø±"),category:l("equipment.card.labels.category","Ø§Ù„Ù‚Ø³Ù…"),subcategory:l("equipment.card.labels.subcategory","Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"),barcode:l("equipment.card.labels.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),available:l("equipment.card.labels.available","Ù…ØªØ§Ø­")},s=Number.isFinite(Number(e.qty))?Number(e.qty):0,u=Number.isFinite(Number(e.price))?Number(e.price):0,p=s.toLocaleString("en-US"),d=u.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),y=Number.isFinite(Number(e.reservedQty))?Number(e.reservedQty):0,f=Number.isFinite(Number(e.maintenanceQty))?Number(e.maintenanceQty):0,h=Number.isFinite(Number(e.availableQty))?Number(e.availableQty):Math.max(s-y-f,0),m=h.toLocaleString("en-US"),g=l("equipment.card.labels.availableOfTotal","Ù…Ù† Ø£ØµÙ„"),v=C(e.status);let _=`${T(c.available)}: ${T(m)} ${T(g)} ${T(p)}`,b="available";if(h===0){const J={reserved:{text:s===1?l("equipment.card.availability.reservedSingle","Ù…Ø¤Ø¬Ø±Ø©"):l("equipment.card.availability.reserved","Ù…Ø¤Ø¬Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"),modifier:"reserved"},maintenance:{text:l("equipment.card.availability.maintenance","ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©"),modifier:"maintenance"},retired:{text:l("equipment.card.availability.retired","ØºÙŠØ± Ù…ØªØ§Ø­Ø©"),modifier:"retired"},default:{text:l("equipment.card.availability.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"),modifier:"unavailable"}},Z=J[v]||J.default;_=T(Z.text),b=Z.modifier}const I=`<span class="equipment-card__availability equipment-card__availability--${b}">${_}</span>`,S="",E=e.desc||e.name||"â€”",N=e.name&&e.name!==e.desc?e.name:"",$=`
    <div class="equipment-card__info-row equipment-card__info-row--center">
      ${[{label:c.quantity,value:p},{label:c.price,value:`${d} ${o}`}].map(({label:J,value:Z})=>`
            <span class="equipment-card__info-item equipment-card__info-item--stacked">
              <span class="equipment-card__detail-label">${J}</span>
              <span class="equipment-card__detail-value">${Z}</span>
            </span>
          `).join("")}
    </div>`,F=[e.category?{label:c.category,value:e.category}:null,e.sub?{label:c.subcategory,value:e.sub}:null].filter(Boolean),Y=F.length?`<div class="equipment-card__categories">${F.map(({label:J,value:Z})=>`
            <div class="equipment-card__category">
              <span class="equipment-card__detail-label">${J}</span>
              <span class="equipment-card__detail-value">${Z}</span>
            </div>
          `).join("")}</div>`:"",De=N?`<div class="equipment-card__alias">
        <span class="equipment-card__detail-label">${c.alias}</span>
        <span class="equipment-card__detail-value">${N}</span>
      </div>`:"",U=`
    <div class="equipment-card__details">
      ${`
    <div class="equipment-card__description">
      <span class="equipment-card__label">${c.description}</span>
      <h3 class="equipment-card__title">${E}</h3>
    </div>
  `}
      ${$}
    </div>
  `,re=[];r&&re.push(`<button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--delete" data-equipment-action="delete" data-equipment-index="${t}">${a}</button>`);const Me=re.length?`<div class="equipment-card__actions equipment-card__actions--center">${re.join(`
`)}</div>`:"",Pt=T(E);return`
    <article
      class="equipment-card"
      data-equipment-index="${t}"
      data-equipment-card="true"
      role="listitem"
      tabindex="0"
      aria-label="${Pt}"
    >
      <div class="equipment-card__header">
      <div class="equipment-card__status-block">
        ${S}
        ${I}
      </div>
        <div class="equipment-card__media-wrapper">
          <div class="equipment-card__media" aria-hidden="true">
            ${n?`<img src="${n}" alt="${i}" loading="lazy">`:'<div class="equipment-card__placeholder">ğŸ“¦</div>'}
          </div>
          ${U}
        </div>
      </div>
      <div class="equipment-card__body">
        ${Y}
        ${De}
      </div>
      ${Me}
    </article>
  `}function tn(e){const t=[...new Set(e.map(r=>r.category).filter(Boolean))],n=[...new Set(e.map(r=>r.sub).filter(Boolean))],a=document.getElementById("filter-category"),i=document.getElementById("filter-sub");if(a){const r=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(c=>{const s=document.createElement("option");s.value=c,s.textContent=c,a.appendChild(s)}),t.includes(r)&&(a.value=r),fe(a)}if(i){const r=i.value;for(;i.options.length>1;)i.remove(1);n.forEach(c=>{const s=document.createElement("option");s.value=c,s.textContent=c,i.appendChild(s)}),n.includes(r)&&(i.value=r),fe(i)}const o=document.getElementById("filter-status");o&&fe(o)}function vt(){const e=V();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return H=t||[],H;const i=new Date;let o=!1;const r=new Set((a||[]).filter(s=>s?.status==="open").map(s=>q(String(s?.equipmentBarcode??"")).trim().toLowerCase())),c=t.map(s=>{if(!s)return s;const u=C(s.status),p=q(String(s.barcode??"")).trim().toLowerCase(),d=p&&r.has(p);let y=d?"maintenance":u;if(!d&&p)for(const f of n||[]){if(!nn(f,i))continue;if(f.items?.some(m=>q(String(m?.barcode??"")).trim().toLowerCase()===p)){y="reserved";break}}return y!==u?(o=!0,{...s,status:y}):{...s,status:u}});return o?G(c):(H=c,Ne({equipment:H})),H}function nn(e,t){if(!e?.start||!e?.end)return!1;const n=new Date(e.start),a=new Date(e.end);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?!1:n<=t&&t<a}function Re(e,{tone:t="",icon:n="ğŸ“¦"}={}){const a=["equipment-empty-state"];return t&&a.push(`equipment-empty-state--${t}`),`
    <div class="${a.join(" ")}">
      <div class="equipment-empty-state__icon" aria-hidden="true">${n}</div>
      <p class="equipment-empty-state__text">${e}</p>
    </div>
  `}function D(){const e=document.getElementById("equipment-list");if(!e)return;const t=vt(),n=Array.isArray(t)?t:B(),a=new Map;n.forEach(m=>{if(!m)return;const g=z(m);g&&(a.has(g)||a.set(g,[]),a.get(g).push(m))});const i=Array.from(a.values()).map(m=>{const g=m[0],v=m.reduce((N,x)=>N+(Number.isFinite(Number(x.qty))?Number(x.qty):0),0),_=["maintenance","reserved","available","retired"],b=m.map(N=>C(N.status)).sort((N,x)=>_.indexOf(N)-_.indexOf(x))[0]||"available",I=m.reduce((N,x)=>{const $=le(x?.qty??0)||0,F=C(x?.status);return F==="reserved"?N.reserved+=$:F==="maintenance"&&(N.maintenance+=$),N},{reserved:0,maintenance:0}),S=Math.max(v-I.reserved-I.maintenance,0);return{item:{...g,qty:v,status:b,variants:m,groupKey:z(g),reservedQty:I.reserved,maintenanceQty:I.maintenance,availableQty:S},index:n.indexOf(g)}});i.sort((m,g)=>Kt(m.item,g.item));const o=document.getElementById("search-equipment")?.value||"",r=q(o).toLowerCase().trim(),c=document.getElementById("filter-category")?.value||"",s=document.getElementById("filter-sub")?.value||"",u=document.getElementById("filter-status")?.value||"",p=u?C(u):"";if(He&&!n.length){e.innerHTML=Re(l("equipment.list.loading","â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª..."),{icon:"â³"});return}if(oe&&!n.length){e.innerHTML=Re(oe,{tone:"error",icon:"âš ï¸"});return}const d=i.filter(({item:m})=>{const g=q(String(m.barcode??"")).toLowerCase().trim(),v=Array.isArray(m.variants)?m.variants.map(E=>q(String(E.barcode??"")).toLowerCase().trim()).filter(Boolean):[],_=!r||m.name&&m.name.toLowerCase().includes(r)||m.desc&&m.desc.toLowerCase().includes(r)||g&&g.includes(r)||v.some(E=>E.includes(r))||m.category&&m.category.toLowerCase().includes(r)||m.sub&&m.sub.toLowerCase().includes(r),b=!c||m.category===c,I=!s||m.sub===s,S=!p||C(m.status)===p;return _&&b&&I&&S}),y=r?l("equipment.list.emptyFiltered","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©."):l("equipment.list.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯."),f=d;e.innerHTML=f.length?f.map(en).join(""):Re(y);const h=document.getElementById("equipment-list-count");if(h){const m=l("equipment.list.countSuffix","Ø¹Ù†ØµØ±"),g=q(String(f.length)),v=f.length?`${g} ${m}`:`0 ${m}`;h.textContent=v}tn(n)}async function $e({showToastOnError:e=!0}={}){He=!0,oe="",D();try{const t=await L("/equipment/?all=1"),n=Array.isArray(t?.data)?t.data.map(xe):[];G(n)}catch(t){oe=ie(t,"equipment.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),e&&A(oe,"error")}finally{He=!1,D()}}function ie(e,t,n){if(e instanceof ze){const a=e.payload?.errors;if(a&&typeof a=="object"){const i=Object.values(a)[0];if(Array.isArray(i))return i[0];if(typeof i=="string")return i}if(e.message)return e.message}return l(t,n)}async function an(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",i=q(a).trim(),o=Le(t.querySelector("#new-equipment-price")?.value||"0"),r=le(t.querySelector("#new-equipment-qty")?.value||"1"),c=t.querySelector("#new-equipment-image")?.value?.trim()||"",s=t.querySelector("#new-equipment-category")?.value?.trim()||"",u=t.querySelector("#new-equipment-sub")?.value?.trim()||"",p=t.querySelector("#new-equipment-status")?.value||"Ù…ØªØ§Ø­";if(!n||!i){A(l("equipment.toast.missingFields","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"));return}const d=Qe({category:s,subcategory:u,description:n,quantity:r,unit_price:o,barcode:i,status:p,image_url:c});try{const y=await L("/equipment/",{method:"POST",body:d}),f=xe(y?.data),h=[...B(),f];G(h),D(),t.reset();const m=t.querySelector("#new-equipment-status");m&&(m.value="Ù…ØªØ§Ø­"),A(l("equipment.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø©"))}catch(y){const f=ie(y,"equipment.toast.addFailed","ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø©");A(f,"error")}}async function qt(e){if(!ue()){Ae();return}const t=B(),n=t[e];if(n&&confirm(l("equipment.toast.deleteConfirm","âŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø©ØŸ")))try{n.id&&await L(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),G(a),D(),A(l("equipment.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø¯Ø©"))}catch(a){const i=ie(a,"equipment.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹");A(i,"error")}}async function rn(e,t){const n=B(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const o=[...n];o[e]={...o[e],...t},G(o),D();return}const i=Qe({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image});try{const o=await L(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:i}),r=xe(o?.data),c=[...n];c[e]=r,G(c),D(),A(l("equipment.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­"))}catch(o){const r=ie(o,"equipment.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©");throw A(r,"error"),o}}function me(){D()}function St(e){const n=B()[e];if(!n)return;K=e;const a=Te(n),i=a[0]||n,o=a.reduce((s,u)=>s+(Number.isFinite(Number(u.qty))?Number(u.qty):0),0),r=["maintenance","reserved","available","retired"],c=a.map(s=>C(s.status)).sort((s,u)=>r.indexOf(s)-r.indexOf(u))[0]||C(i.status);document.getElementById("edit-equipment-index").value=e,Xe({category:i.category||"",subcategory:i.sub||"",description:i.desc||i.description||"",quantity:String(o||i.qty||0),price:i.price!=null?String(i.price):"0",image:Be(i)||"",barcode:i.barcode||"",status:i.status||c}),ee(!1),W=he(),Ce(i),ht(i),w={groupKey:z(i),barcode:String(i.barcode||""),id:i.id||null},Vt(document.getElementById("editEquipmentModal"))?.show()}function sn(e){const t=e.target.closest('[data-equipment-action="delete"]');if(t){e.preventDefault(),e.stopPropagation();const a=Number(t.dataset.equipmentIndex);Number.isNaN(a)||qt(a).catch(i=>{console.error("âŒ [equipment.js] deleteEquipment",i)});return}const n=e.target.closest('[data-equipment-card="true"]');if(n){const a=Number(n.dataset.equipmentIndex);Number.isNaN(a)||St(a)}}function on(e){if(e.defaultPrevented||e.target.closest("[data-equipment-action]"))return;const t=e.target.closest('[data-equipment-card="true"]');if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const n=Number(t.dataset.equipmentIndex);Number.isNaN(n)||St(n)}}function cn(e){const t=e.target.closest('[data-variant-action="delete"]');if(t){const n=Number(t.dataset.variantIndex);Number.isNaN(n)||qt(n).catch(a=>{console.error("âŒ [equipment.js] deleteEquipment",a)});return}}function Et(){if(!w||!document.getElementById("editEquipmentModal")?.classList.contains("show"))return;const n=B(),a=w.id?n.find(s=>String(s.id)===String(w.id)):null,i=w.groupKey,o=i?n.find(s=>z(s)===i):null,r=a||o;if(!r){ve();return}const c=n.findIndex(s=>s===r);if(c>=0){const s=document.getElementById("edit-equipment-index");s&&(s.value=String(c)),K=c}if(ht(r),!Ie){const s=Te(r),u=s[0]||r,p=s.reduce((f,h)=>f+(Number.isFinite(Number(h.qty))?Number(h.qty):0),0),d=["maintenance","reserved","available","retired"],y=s.map(f=>C(f.status)).sort((f,h)=>d.indexOf(f)-d.indexOf(h))[0]||C(u.status);Xe({category:u.category||"",subcategory:u.sub||"",description:u.desc||u.description||"",quantity:String(p||u.qty||0),price:u.price!=null?String(u.price):"0",image:Be(u)||"",barcode:u.barcode||"",status:u.status||y}),W=he()}Ce(primary)}function un(){document.getElementById("search-equipment")?.addEventListener("input",me),document.getElementById("filter-category")?.addEventListener("change",me),document.getElementById("filter-sub")?.addEventListener("change",me),document.getElementById("filter-status")?.addEventListener("change",me),document.getElementById("add-equipment-form")?.addEventListener("submit",an);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",a=>{a.preventDefault(),Jt().catch(i=>{console.error("âŒ [equipment.js] clearEquipment",i)})}),e.dataset.listenerAttached="true");const t=document.getElementById("equipment-list");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",sn),t.addEventListener("keydown",on),t.dataset.listenerAttached="true");const n=document.getElementById("equipment-variants-table-body");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",cn),n.dataset.listenerAttached="true"),["edit-equipment-quantity","edit-equipment-price","edit-equipment-barcode"].forEach(a=>{const i=document.getElementById(a);Qt(i)})}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{if(!Ie){W=he(),ee(!0);return}const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){A(l("equipment.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:le(document.getElementById("edit-equipment-quantity").value)||1,price:Le(document.getElementById("edit-equipment-price").value)||0,barcode:q(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value};try{await rn(t,n),W=he(),ee(!1),Et()}catch(a){console.error("âŒ [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{un(),D(),$e();const e=document.getElementById("equipment-edit-cancel");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{if(W&&Xe(W),K!=null){const a=B()[K];if(a){const o=Te(a)[0]||a;Ce(o)}}ee(!1)}),e.dataset.listenerAttached="true");const t=document.getElementById("save-equipment-changes");t&&!t.dataset.listenerAttached&&(t.dataset.listenerAttached="true",t.dataset.mode||(t.dataset.mode="view"))});document.addEventListener("language:changed",()=>{if(D(),ee(Ie),K!=null){const t=B()[K];if(t){const a=Te(t)[0]||t;Ce(a)}}});document.addEventListener("equipment:refreshRequested",()=>{$e({showToastOnError:!1})});document.addEventListener(Dt.USER_UPDATED,()=>{D()});document.addEventListener("equipment:changed",()=>{Et()});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editEquipmentModal");e&&!e.dataset.variantsListenerAttached&&(e.addEventListener("hidden.bs.modal",()=>{w=null,ve(),K=null,W=null,ee(!1)}),e.dataset.variantsListenerAttached="true")});let te=[],_t=[],At=[];function Qn(){return te}function Kn(e){te=Array.isArray(e)?e:[]}function Wn(e){te=[...te,e]}function Gn(e){Number.isInteger(e)&&e>=0&&(te=te.filter((t,n)=>n!==e))}function Yn(){return _t}function Jn(e){_t=Array.isArray(e)?e:[]}function Zn(){return At}function ea(e){At=Array.isArray(e)?e:[]}function ta(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),o=a?a.slice(0,10):"",r=i.match(/(\d{1,2}:\d{2})/);let c="";if(r){const[s="00",u="00"]=r[0].split(":");c=`${s.padStart(2,"0")}:${u.padStart(2,"0")}`}return{date:o,time:c}}function pe(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function st(e){return q(String(e||"")).trim().toLowerCase()}function na(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),o=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:r=[]}=V(),c=st(e);return r.some(s=>{if(!s||!s.items||s.items.length===0||a&&(String(s.id)===String(a)||String(s.reservationId)===String(a))||!s.start||!s.end)return!1;const u=new Date(s.start),p=new Date(s.end);return Number.isNaN(u.getTime())||Number.isNaN(p.getTime())||!(u<o&&p>i)?!1:s.items.some(y=>st(y?.barcode)===c)})}function ln(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),o=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:r=[]}=V(),c=String(e);return r.some(s=>{if(!s?.start||!s?.end||a&&(String(s.id)===String(a)||String(s.reservationId)===String(a)))return!1;const u=new Date(s.start),p=new Date(s.end);return Number.isNaN(u.getTime())||Number.isNaN(p.getTime())||!(u<o&&p>i)?!1:(Array.isArray(s.technicians)?s.technicians:[]).some(f=>String(f)===c)})}let X=[],R=[],O=[],qe="create",Ke=()=>{},We=()=>{};function dn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=q(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function Nt(e={}){const t=dn(e);if(!Number.isFinite(t)||t<=0)return"â€”";const n=l("technicians.table.wageSuffix","SR");return`${q(String(t))} ${n}`}function ot(e=""){return q(String(e)).trim().toLowerCase()}function It(e){return!X||!X.length?null:X.find(t=>String(t?.id)===String(e))||null}function mn(e,t="create"){t==="edit"?Je(O.filter(n=>String(n)!==String(e))):Ye(R.filter(n=>String(n)!==String(e)))}function Se(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=l("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const o=It(i)||{},r=l("reservations.crew.fallbackName","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… {id}").replace("{id}",i),c=o.name||r,s=o.role?`<small class="technician-chip-role">${o.role}</small>`:"",u=Nt(o),p=u!=="â€”"?`<small class="technician-chip-wage">ğŸ’° ${u}</small>`:"",d=l("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${c}</span>
          ${s}
          ${p}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${d}">âœ–</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>mn(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function xt(){return qe==="edit"?O:R}function Ee(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=ot(t?.value||""),a=new Set(xt().map(String)),o=(X||[]).filter(r=>n?ot([r.name,r.phone,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(o.length===0){const r=l("reservations.crew.searchEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${r}</td></tr>`;return}e.innerHTML=o.map(r=>{const c=Nt(r);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${r.id}" ${a.has(String(r.id))?"checked":""}>
        </td>
        <td>${r.name||"-"}</td>
        <td>${r.role||"â€”"}</td>
        <td>${r.department||"â€”"}</td>
        <td>${c}</td>
      </tr>
    `}).join("")}function pn(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function fn(e="create"){if(e==="edit"){const c=document.getElementById("edit-res-start")?.value?.trim(),s=document.getElementById("edit-res-end")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=c?pe(c,u):null,y=s?pe(s,p):null;let f=null;const h=document.getElementById("edit-res-index")?.value;if(h!=null){const m=Number.parseInt(h,10);if(Number.isInteger(m)){const{reservations:g=[]}=V(),v=g?.[m];v&&(f=v.id??v.reservationId??null)}}return{start:d,end:y,ignoreReservationId:f}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=t?pe(t,a):null,r=n?pe(n,i):null;return{start:o,end:r,ignoreReservationId:null}}function ne(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=xt().length;if(t){const n=l("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",q(String(t)));e.textContent=n}else e.textContent=l("technicians.picker.selectionInfo","No crew selected yet")}function yn(){const e=pn().map(String),{start:t,end:n,ignoreReservationId:a}=fn(qe);if(t&&n){const o=e.filter(r=>ln(r,t,n,a));if(o.length>0){const r=o.map(s=>It(s)?.name||s).join(l("reservations.list.crew.separator","ØŒ ")),c=l("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",r);o.forEach(s=>{const u=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(s))}"]`);u&&(u.checked=!1)}),A(c),ne();return}}qe==="edit"?Je(e):Ye(e),ne();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function ct(e="create"){qe=e;const t=ft();Array.isArray(t)&&t.length&&(X=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),Ee(),ne();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function gn(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>ct("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>ct("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Ee(),ne()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",yn),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{ne(),Ee()}),i.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("technician-picker-search");o&&(o.value="")}),i.dataset.listenerAttached="true"),Ge()}function Ge(){Se("selected-technicians-list",R,"create"),Se("edit-selected-technicians-list",O,"edit")}function aa({onDraftChange:e,onEditChange:t}={}){Ke=typeof e=="function"?e:()=>{},We=typeof t=="function"?t:()=>{},Ge(),gn()}function bn(e=[]){X=Array.isArray(e)?e:[]}function hn(){return[...R]}function vn(){return[...O]}function Ye(e=[]){R=Array.isArray(e)?e.map(String):[],Se("selected-technicians-list",R,"create"),Ke()}function Je(e=[]){O=Array.isArray(e)?e.map(String):[],Se("edit-selected-technicians-list",O,"edit"),We()}function ia(){Ye([])}function ra(){Je([])}function sa(e=[]){bn(e);const t=new Set(X.map(c=>String(c.id))),n=R.filter(c=>t.has(String(c))),a=O.filter(c=>t.has(String(c))),i=n.length!==R.length,o=a.length!==O.length;R=n,O=a,Ge(),i&&Ke(),o&&We();const r=document.getElementById("selectTechniciansModal");r&&r.classList.contains("show")&&(Ee(),ne())}const Lt=10;function qn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function Sn(e=[]){if(!Array.isArray(e)||e.length===0)return 0;const{technicians:t=[]}=V();if(!Array.isArray(t)||t.length===0)return 0;const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const o=n.get(String(i));return o?a+qn(o):a},0)}const En=1440*60*1e3;function _n(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const o=i/En;return Math.max(1,Math.ceil(o))}function Ze({items:e=[],technicianIds:t=[],discount:n=0,discountType:a="percent",applyTax:i=!1,start:o=null,end:r=null,companySharePercent:c=null}={}){const s=_n(o,r),p=(e||[]).reduce((x,$)=>x+(Number($?.qty)||1)*(Number($?.price)||0),0)*s,y=Sn(t)*s,f=p+y,h=Number(n)||0;let m=a==="amount"?h:f*(h/100);(!Number.isFinite(m)||m<0)&&(m=0),m>f&&(m=f);const g=Math.max(0,f-m);let v=i?g*.15:0;(!Number.isFinite(v)||v<0)&&(v=0);const _=g+v,b=Math.max(0,Math.round(_));let I=Number.isFinite(c)?Number(c):null;i&&(!Number.isFinite(I)||I<=0)&&(I=Lt);const S=I&&I>0?I:0,E=S>0?Math.max(0,b*(S/100)):0,N=Math.max(0,b-v-E);return{rentalDays:s,equipmentTotal:p,crewTotal:y,discountAmount:m,taxableAmount:g,taxAmount:v,finalTotal:b,companySharePercent:S,companyShareAmount:E,netProfit:N}}function oa(e=[],t=0,n="percent",a=!1,i=[],{start:o=null,end:r=null}={}){return Ze({items:e,technicianIds:i,discount:t,discountType:n,applyTax:a,start:o,end:r}).finalTotal}function Tt({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paidStatus:o,companySharePercent:r=null,companyShareAmount:c=null,taxAmount:s=null,netProfit:u=null,totalKey:p="reservations.summary.total"}){const d=l("reservations.create.summary.currency","SR"),y=q(String(e)),f=q(String(t)),h=q(String(n??1)),m=q(String(a)),g=o==="paid"?l("reservations.create.paymentStatus.paid","Ù…Ø¯ÙÙˆØ¹"):l("reservations.create.paymentStatus.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),v=l("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),_=l("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),b=l("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),I=l("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),S=l("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),E=l(p.replace(".total",".totalLabel"),"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©"),N=l("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),x=l("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),$=Number.isFinite(u)?Math.max(0,Number(u)):null,F=[{label:v,value:f},{label:_,value:h},{label:b,value:m}];if(i){let M=l("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(s)&&s>0&&(M=`${q(Number(s).toFixed(2))} ${d}`),F.push({label:I,value:M})}const Y=Number.isFinite(r)?Number(r):null;if(Y!==null&&Y>0){const M=Number.isFinite(c)?Number(c):e*(Y/100),U=q(String(Y)),re=q(Number.isFinite(M)?M.toFixed(2):"0"),Me=`${U}% (${re} ${d})`;F.push({label:N,value:Me})}if($!==null&&Math.abs($-Number(e))>.009){const M=q($.toFixed(2));F.push({label:x,value:`${M} ${d}`})}F.push({label:S,value:g});const De=`${y} ${d}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${F.map(({label:M,value:U})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${M}</span>
            ${U?`<span class="reservation-summary-value">${U}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${E}</span>
          <span class="reservation-summary-value">${De}</span>
        </div>
      </div>
    </div>
  `}function ca({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:o,end:r,companySharePercent:c=null}){const s=hn(),u=s.length,p=Number.isFinite(c)?Number(c):null,d=Ze({items:e,technicianIds:s,discount:t,discountType:n,applyTax:a,start:o,end:r,companySharePercent:p}),y=Tt({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:u,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit});An(y)}function ua({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:o,end:r,companySharePercent:c=null}){const s=vn(),u=s.length,p=Number.isFinite(c)?Number(c):null,d=Ze({items:e,technicianIds:s,discount:t,discountType:n,applyTax:a,start:o,end:r,companySharePercent:p});return Tt({total:d.finalTotal,itemsCount:e.length,rentalDays:d.rentalDays,techniciansCount:u,applyTax:a,paidStatus:i,companySharePercent:d.companySharePercent,companyShareAmount:d.companyShareAmount,taxAmount:d.taxAmount,netProfit:d.netProfit,totalKey:"reservations.summary.totalAfterEdit"})}function An(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,ut(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,ut(n,e))}function ut(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}function Ct(e=""){return q(String(e)).trim().toLowerCase()}const Nn=2;function In(e){const t=Number(e);return Number.isFinite(t)?t.toFixed(Nn):"0.00"}function lt(e={}){const t=Number(e?.qty);return Number.isFinite(t)&&t>0?t:1}function xn(e={}){const t=e?.desc||e?.description||e?.name||"",n=Ct(t),a=In(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${a}`}function la(e=[]){const t=new Map;return e.forEach((n,a)=>{const i=xn(n);if(!i)return;if(!t.has(i)){const r=n?.desc||n?.description||n?.name||"",c=Ct(r),s=dt(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(i,{key:i,description:r,normalizedDescription:c,unitPrice:s,image:u,items:[],itemIndices:[],barcodes:[]})}const o=t.get(i);o.items.push(n),o.itemIndices.push(a),n?.barcode&&o.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((a,i)=>a+lt(i),0)})).map(n=>{const a=n.quantity||0,i=n.items.reduce((r,c)=>{const s=dt(c),u=lt(c);return r+s*u},0),o=a>0?i/a:n.unitPrice;return{...n,quantity:a,count:a,totalPrice:i,unitPrice:o}})}function da(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function dt(e={}){const t=e?.price??e?.unit_price??e?.unitPrice??0,n=Number(t);return Number.isFinite(n)?n:0}function ma(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Ln(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Tn(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,i=a!=null&&a!==""&&a!=="null",o=i?Ln(t?.status??t?.status_label??t?.statusLabel??""):null,r=i&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:n,projectLinked:i,projectStatus:o,projectConfirmed:r,effectiveConfirmed:i?r:n}}const Cn=V()||{};let Q=(Cn.reservations||[]).map(Dn);function ce(){return Q}function Fe(e){return Q=Array.isArray(e)?e.map(tt):[],Ne({reservations:Q}),Q}async function Bn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([c,s])=>{s!=null&&s!==""&&t.set(c,String(s))});const n=t.toString(),i=(await L(`/reservations/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(i)?o=i:i&&typeof i=="object"&&(Array.isArray(i.items)?o=i.items:Array.isArray(i.results)?o=i.results:Array.isArray(i.data)?o=i.data:Array.isArray(i.records)&&(o=i.records));const r=o.map(et);return Fe(r)}async function pa(e){const t=await L("/reservations/",{method:"POST",body:e}),n=et(t?.data??{});return!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),n.companySharePercent>0&&!Number.isFinite(n.companyShareAmount)&&Number.isFinite(n.cost)&&(n.companyShareAmount=Math.max(0,n.cost*(n.companySharePercent/100))),n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Fe([...Q,n]),n}async function $n(e,t){const n=await L(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=et(n?.data??{});!Number.isFinite(a.companySharePercent)&&t?.company_share_percent!=null&&(a.companySharePercent=Number(t.company_share_percent)||0),a.companySharePercent>0&&!Number.isFinite(a.companyShareAmount)&&Number.isFinite(a.cost)&&(a.companyShareAmount=Math.max(0,a.cost*(a.companySharePercent/100))),a.companyShareEnabled=t?.company_share_enabled?!0:a.companySharePercent>0;const i=Q.map(o=>String(o.id)===String(e)?a:o);return Fe(i),a}async function Fn(e){await L(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=Q.filter(n=>String(n.id)!==String(e));Fe(t)}async function Pn(e){return $n(e,{status:"confirmed",confirmed:!0})}function et(e={}){return tt({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount})}function Dn(e={}){return tt(e)}function tt(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(Mn):[],i=Array.isArray(e.technicians)?e.technicians:[],o=i.map(S=>S==null?null:String(typeof S=="object"?S.id??S.technician_id??S.technicianId??S.ID??"":S)).filter(S=>S&&S!==""),r=e.start??e.start_datetime??"",c=e.end??e.end_datetime??"",s=_e(e.total_amount??e.totalAmount??e.cost??0),u=_e(e.discount??0),p=e.discount_type??e.discountType??"percent",d=!!(e.apply_tax??e.applyTax??!1),y=jn(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid",f=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),h=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,m=h!=null?Number.parseFloat(q(String(h).replace("%","").trim())):NaN,g=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let v=g!=null?g===!0||g===1||g==="1"||String(g).toLowerCase()==="true":Number.isFinite(m)&&m>0,_=v&&Number.isFinite(m)?Number(m):0;const b=e.company_share_amount??e.companyShareAmount;let I=Number.isFinite(Number(b))?Number(b):_>0?Math.max(0,s*(_/100)):0;return d&&_<=0&&(_=Lt,I=Math.max(0,s*(_/100)),v=!0),!v&&_>0&&(v=!0),{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:c,status:kn(e.status??(f?"confirmed":"pending")),confirmed:f,location:e.location??"",notes:e.notes??"",discount:u,discountType:["percent","amount"].includes(p)?p:"percent",applyTax:d,paid:y==="paid",paidStatus:y,totalAmount:s,cost:s,projectId:e.project_id??e.projectId??null,items:a,technicians:o,techniciansDetails:i.map(S=>typeof S=="object"?S:{id:Number(S)||S}),startDatetime:r,endDatetime:c,customerPhone:e.customer_phone??e.customerPhone??null,companySharePercent:_,companyShareAmount:I,companyShareEnabled:v}}function Mn(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=Bt(e.quantity??e.qty??1),a=_e(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:q(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function fa({reservationCode:e,customerId:t,start:n,end:a,status:i,title:o,location:r,notes:c,projectId:s,totalAmount:u,discount:p,discountType:d,applyTax:y,paidStatus:f,confirmed:h,items:m,technicians:g,companySharePercent:v,companyShareEnabled:_}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:o??null,location:r??null,notes:c??null,project_id:s||null,total_amount:u??0,discount:p??0,discount_type:d??"percent",apply_tax:y?1:0,paid_status:f??"unpaid",confirmed:h===void 0?null:!!h,items:Array.isArray(m)?m.map(b=>({equipment_id:b.equipmentId??b.equipment_id??b.id,quantity:Bt(b.qty??b.quantity??1),unit_price:_e(b.price??b.unit_price??0),notes:b.notes??null})):[],company_share_percent:_&&Number.isFinite(v)?Number(v):null,company_share_enabled:_?1:0,technicians:Array.isArray(g)?g.map(b=>typeof b=="object"&&b!==null?{id:b.id??b.technician_id??b.technicianId??b.ID,role:b.role??null,notes:b.notes??null}:Number.isNaN(Number(b))?String(b):Number(b)):[]}}function _e(e){const t=Number(q(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Bt(e){const t=Number.parseInt(q(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function kn(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return"pending"}}function jn(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function $t(e){return e instanceof ze}function Ft(){const e=()=>{vt(),ft()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(e,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(e);return}}e()}let mt=!1,pt=null;function Rn(e){if(!e||typeof e!="object")return"";const t=Object.entries(e).filter(([n,a])=>a!=null).map(([n,a])=>[n,String(a)]);return t.length===0?"":JSON.stringify(t.sort(([n],[a])=>n.localeCompare(a)))}async function ya(e={}){const{suppressError:t=!0,params:n=null,force:a=!1}=e??{},i=Rn(n);if(!a&&mt&&ce().length>0&&i===pt)return ce();try{const o=await Bn(n||{});return mt=!0,pt=i,o}catch(o){if(console.error("âŒ [reservationsActions] Failed to load reservations from API",o),!t)throw o;return ce()}}async function ga(e,{onAfterChange:t}={}){if(!ue())return Ae(),!1;const a=ce()[e];if(!a)return A(l("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const i=a.id||a.reservationId;if(!i)return A(l("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;try{return await Fn(i),Ft(),t?.({type:"deleted",reservation:a}),A(l("reservations.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²")),!0}catch(o){console.error("âŒ [reservationsActions] deleteReservation failed",o);const r=$t(o)?o.message:l("reservations.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return A(r,"error"),!1}}async function ba(e,{onAfterChange:t}={}){const a=ce()[e];if(!a)return A(l("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const i=a.id||a.reservationId;if(!i)return A(l("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;const{projectLinked:o}=Tn(a);if(o)return A(l("reservations.toast.confirmBlockedByProject","âš ï¸ Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² ØªØªØ­ÙƒÙ… Ø¨Ù‡Ø§ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø· ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ£ÙƒÙŠØ¯Ù‡ Ù…Ù† Ù‡Ù†Ø§"),"info"),!1;try{const r=await Pn(i);return Ft(),t?.({type:"confirmed",reservation:r}),A(l("reservations.toast.confirmed","âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²")),!0}catch(r){console.error("âŒ [reservationsActions] confirmReservation failed",r);const c=$t(r)?r.message:l("reservations.toast.confirmFailed","ØªØ¹Ø°Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return A(c,"error"),!1}}const On=V()||{};let P=(On.projects||[]).map(zn),de=!1;function ha(){return P}function Pe(e){return P=Array.isArray(e)?e.map(at):[],Ne({projects:P}),P}async function Hn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([c,s])=>{s==null||s===""||t.set(c,String(s))});const n=t.toString(),i=(await L(`/projects/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(i)?o=i:i&&typeof i=="object"&&(Array.isArray(i.items)?o=i.items:Array.isArray(i.results)?o=i.results:Array.isArray(i.data)?o=i.data:Array.isArray(i.records)&&(o=i.records));const r=o.map(nt);return Pe(r),de=!0,P}async function va({force:e=!1,params:t=null}={}){if(!e&&de&&P.length>0)return P;try{return await Hn(t||{})}catch(n){return console.error("âŒ [projectsService] Failed to load projects from API",n),P}}async function qa(e){const t=await L("/projects/",{method:"POST",body:e}),n=nt(t?.data??{}),a=[...P,n];return Pe(a),de=!0,n}async function Sa(e,t){const n=await L(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=nt(n?.data??{}),i=P.map(o=>String(o.id)===String(e)?a:o);return Pe(i),de=!0,a}async function Ea(e){await L(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=P.filter(n=>String(n.id)!==String(e));Pe(t),de=!0}function _a({projectCode:e,title:t,type:n,clientId:a,clientCompany:i,description:o,start:r,end:c,applyTax:s,paymentStatus:u,equipmentEstimate:p=0,expenses:d=[],taxAmount:y=0,totalWithTax:f=0,confirmed:h=!1,technicians:m=[],equipment:g=[]}={}){const v=Array.isArray(m)?m.map(E=>Number.parseInt(String(E),10)).filter(E=>Number.isInteger(E)&&E>0):[],_=Array.isArray(g)?g.map(E=>{const N=Number.parseInt(String(E.equipmentId??E.equipment_id??E.id??0),10),x=Number.parseInt(String(E.qty??E.quantity??0),10);return!Number.isInteger(N)||N<=0?null:{equipment_id:N,quantity:Number.isInteger(x)&&x>0?x:1}}).filter(Boolean):[],b=Array.isArray(d)?d.map(E=>{const N=Number.parseFloat(E?.amount??E?.value??0)||0,x=(E?.label??E?.name??"").trim();return x?{label:x,amount:Math.round(N*100)/100}:null}).filter(Boolean):[],I=b.reduce((E,N)=>E+(N?.amount??0),0),S={title:t,type:n,client_id:a?Number.parseInt(String(a),10):null,client_company:i??null,description:o??null,start_datetime:r??null,end_datetime:c||null,apply_tax:!!s,payment_status:u??"unpaid",equipment_estimate:Number.parseFloat(p)||0,expenses_total:Math.round(I*100)/100,tax_amount:Math.round((Number.parseFloat(y)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(f)||0)*100)/100,confirmed:!!h,technicians:v,equipment:_,expenses:b};return e&&(S.project_code=String(e).trim()),S.end_datetime||delete S.end_datetime,S.client_company||(S.client_company=null),S}function nt(e={}){return at(e)}function zn(e={}){return at(e)}function at(e={}){const t=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],a=n.map(s=>{if(s==null)return null;if(typeof s=="object"){const u=s.id??s.technician_id??s.technicianId;return u!=null?String(u):null}return String(s)}).filter(Boolean),o=(Array.isArray(e.equipment)?e.equipment:[]).map(s=>{const u=s?.equipment_id??s?.equipmentId??s?.id??null,p=s?.quantity??s?.qty??0,d=s?.barcode??s?.code??"",y=s?.description??s?.name??"";return{equipmentId:u!=null?String(u):null,qty:Number.parseInt(String(p),10)||0,barcode:d,description:y}}),c=(Array.isArray(e.expenses)?e.expenses:[]).map((s,u)=>({id:s?.id??`expense-${t??"x"}-${u}`,label:s?.label??"",amount:Number.parseFloat(s?.amount??0)||0}));return{id:t!=null?String(t):"",projectId:t!=null?Number(t):null,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:n.map(s=>typeof s=="object"?s:{id:s}),equipment:o,expenses:c}}function Aa(e){return e instanceof ze}export{ra as $,qa as A,st as B,Yn as C,Lt as D,ca as E,pe as F,ta as G,Jn as H,vt as I,Qn as J,la as K,da as L,na as M,Wn as N,Gn as O,xn as P,hn as Q,ln as R,fa as S,pa as T,Zn as U,ia as V,Kn as W,ea as X,ua as Y,Je as Z,vn as _,et as a,ga as a0,ba as a1,ma as b,$e as c,D as d,ya as e,wn as f,ce as g,_a as h,$t as i,Sa as j,nt as k,_n as l,Dn as m,Ct as n,oa as o,$n as p,va as q,Tn as r,aa as s,sa as t,Xn as u,ha as v,Ea as w,Hn as x,Bn as y,Aa as z};
