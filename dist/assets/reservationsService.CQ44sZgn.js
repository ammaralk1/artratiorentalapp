import{t as k,p as le,n as b,j as z,d as me,b as ze,h as Xt,A as Zt}from"./auth.BLFzWQsL.js";import{r as kt,i as en,D as Ze,s as tn,k as nn,P as an,u as $e,E as It,j as on,O as et,G as fe,H as _e,b as Pe,I as Ct,J as cn}from"./state.DZCwr8Fl.js";const sn=()=>k("reservations.create.summary.currency","SR");let Ae=[],X=[],ce=[],se=[],H="create",St=()=>{},vt=()=>{};const xe=new Map,Ue=450;function rn(e){const n=xe.get(e);return n!=null&&Date.now()-n<Ue}function ln(e){xe.set(e,Date.now()),setTimeout(()=>{const n=xe.get(e);n!=null&&Date.now()-n>=Ue&&xe.delete(e)},Ue+50)}function qe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ge(e={}){return{...e,assignmentId:e.assignmentId||qe()}}function Me(e){if(!e)return null;const n=String(e),t=Ae.find(c=>String(c?.id)===n);if(t)return{...t};const{technicians:i=[]}=me();return i.find(c=>String(c?.id)===n)||null}function ke(e={},n=le()){return e?n==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function tt(e={},n=le()){return e?n==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function qt(e,n=""){if(!e)return null;if(typeof e=="object")return e;const t=String(e).trim().toLowerCase();if(!t)return null;const i=X.find(o=>String(o.id).trim().toLowerCase()===t);if(i)return i;const c=on(e);return c||{id:null,name:n||t,labelAr:n||t,labelEn:n||t,cost:0,clientPrice:0}}function dt(e){const n=qt(e,e?.name??""),t=le(),i=ke(n,t)||n?.name||"",c=tt(n,t);return Ge({assignmentId:qe(),positionId:n?.id??null,positionKey:n?.name??null,positionLabel:i,positionLabelAlt:c,positionCost:Number.isFinite(n?.cost)?Number(n.cost):0,positionClientPrice:Number.isFinite(n?.clientPrice)?Number(n.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Ge(e={}){const n={assignmentId:e.assignmentId||qe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},t=qt(n.positionId??n.positionKey??n.positionLabel,n.positionLabel);if(t){n.positionId=t.id??n.positionId;const i=le(),c=ke(t,i)||n.positionLabel,o=tt(t,i);n.positionLabel=c||n.positionLabel||t?.name||"",n.positionLabelAlt=o||n.positionLabelAlt||"",(n.positionCost==null||!Number.isFinite(n.positionCost)||n.positionCost===0)&&(n.positionCost=Number.isFinite(t?.cost)?Number(t.cost):n.positionCost),(n.positionClientPrice==null||!Number.isFinite(n.positionClientPrice)||n.positionClientPrice===0)&&(n.positionClientPrice=Number.isFinite(t?.clientPrice)?Number(t.clientPrice):n.positionClientPrice)}if(n.technicianId!=null){const i=Me(n.technicianId);i?(n.technicianId=String(i.id),n.technicianName=i.name??n.technicianName??null,n.technicianRole=i.role??n.technicianRole??null,n.technicianPhone=i.phone??null):(n.technicianId=String(n.technicianId),n.technicianName=n.technicianName??null)}else n.technicianId=null,n.technicianName=null,n.technicianPhone=null;return n.positionCost=Number.isFinite(n.positionCost)?Number(n.positionCost):0,n.positionClientPrice=Number.isFinite(n.positionClientPrice)?Number(n.positionClientPrice):0,n}function ye(){X=en()}function un(e=[]){return Array.isArray(e)?e.map(n=>{if(n==null)return null;if(n&&typeof n=="object")return ge(Ge(n));const t=Me(n),i=t?{assignmentId:qe(),positionLabel:t.role||k("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(t.dailyWage)?Number(t.dailyWage):0,positionClientPrice:Number.isFinite(t.dailyTotal)?Number(t.dailyTotal):0,technicianId:t.id,technicianName:t.name,technicianRole:t.role}:{assignmentId:qe(),positionLabel:k("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:n!=null?String(n):null,technicianName:null};return ge(Ge(i))}).filter(Boolean):[]}function ue(e="create"){return e==="edit"?se.map(ge):ce.map(ge)}function ne(e="create",n=[]){try{ye()}catch{}const t=un(n);e==="edit"?(se=t,Ie("edit-selected-technicians-list",se,"edit"),vt()):(ce=t,Ie("selected-technicians-list",ce,"create"),St()),Fe()}function je(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),r=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=a?$e(a,r):null,f=l?$e(l,u):null;let y=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const _=Number.parseInt(g,10);if(Number.isInteger(_)){const{reservations:N=[]}=me(),p=N?.[_];p&&(y=p.id??p.reservationId??null)}}return{start:d,end:f,ignoreReservationId:y}}const n=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",c=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=n?$e(n,i):null,s=t?$e(t,c):null;return{start:o,end:s,ignoreReservationId:null}}function Fe(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const n=ue(H).length;if(n){const t=k("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",b(String(n)));e.textContent=t}else e.textContent=k("technicians.picker.selectionInfo","No crew selected yet")}function De(e){const n=Number.isFinite(e)?e:0;return`${b(n.toFixed(2))} ${sn()}`}function dn(e){const n=ue(H),t=new Set(n.filter(r=>r.assignmentId!==e&&r.technicianId).map(r=>r.technicianId)),i=Ae.length?Ae:me().technicians||[],{start:c,end:o,ignoreReservationId:s}=je(H),a=!!(c&&o);return i.map(r=>{const u=String(r.id),d=t.has(u),f=a?Ze(u,c,o,s):!1,y=b(r.name||r.full_name||r.fullName||r.email||u);return{id:u,label:y,disabled:d||f,conflict:f,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const n=ue(H);if(!n.length){const t=k("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=k("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${t}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}ye(),e.innerHTML=n.map((t,i)=>{const c=b(String(i+1)),o=De(t.positionClientPrice||0),s=dn(t.assignmentId),a=k("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),l=t.technicianId!=null?String(t.technicianId):"",r=t.technicianName?b(t.technicianName):"",u=`crew-assignment-options-${t.assignmentId}`,d=k("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),f=k("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),y=s.map(h=>{const P=l===h.id,S=h.disabled&&!P?`${h.label} ${h.conflict?f:d}`:h.label;return`
        <option value="${h.label}"
                data-id="${h.id}"
                data-disabled="${h.disabled?"true":"false"}"
                data-conflict="${h.conflict?"true":"false"}"
                data-taken="${h.taken?"true":"false"}"
                label="${S}"></option>
      `}).join("");let g=t.positionLabel??t.position_label??t.position_name??t.role??t.position??"";if(!g||String(g).trim()===""){const h=t.positionId?X.find(I=>String(I.id)===String(t.positionId)):null,P=!h&&t.positionKey?X.find(I=>String(I.name).toLowerCase()===String(t.positionKey).toLowerCase()):null;if(h||P){const I=h||P;g=ke(I,le())||I?.name||""}}const _=t.positionLabelAlt?`<div class="text-muted small">${b(t.positionLabelAlt)}</div>`:"",N=k("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),p=k("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${t.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${c}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${b(g||k("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${_}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${o}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${t.assignmentId}"
              placeholder="${a}"
              value="${l?r:""}"
              aria-label="${k("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${y}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${t.assignmentId}" aria-label="${N}">
            ${N}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Ft(t.dataset.assignmentId,H)}),t.dataset.listenerAttached="true")}),pn(e)}function pn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(t=>{if(t.dataset.listenerAttached)return;const i=t.dataset.assignmentId,c=()=>{mn(t,i)};t.addEventListener("change",c),t.addEventListener("blur",c),t.dataset.listenerAttached="true"})}function mn(e,n){if(!n||rn(n))return;ln(n);const t=e.value?.trim()??"";if(!t){we(n,"");return}const i=e.getAttribute("list"),c=i?document.getElementById(i):null,o=c?Array.from(c.options):[],s=b(t).toLowerCase(),a=o.find(r=>b(r.value).toLowerCase()===s);if(!a){z(k("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}if(a.dataset.disabled==="true"){if(a.dataset.conflict==="true")try{const{start:r,end:u,ignoreReservationId:d}=je(H),f=a.dataset.id||"",y=r&&u&&f?It(String(f),r,u,d):[],g=k("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),_=y&&y.length?`: ${y.join("ØŒ ")}`:"";z(`${g}${_}`,"warning",6e3)}catch{z(k("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else z(k("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const l=a.dataset.id;if(!l){z(k("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(n,"");return}we(n,l)}function Re(){const e=document.getElementById("crew-position-list");if(!e)return;ye();const n=document.getElementById("crew-position-search"),t=b(String(n?.value||"")).trim().toLowerCase(),c=ue(H).reduce((a,l)=>{const r=l?.positionId!=null?String(l.positionId):null;return r&&a.set(r,(a.get(r)||0)+1),a},new Map),o=X.filter(a=>t?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(r=>b(String(r)).toLowerCase()).join(" ").includes(t):!0);if(!o.length){e.innerHTML=`<div class="text-muted">${k("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const s=le();e.innerHTML=o.map(a=>{const l=ke(a,s)||a.name||"",r=tt(a,s),u=De(a.clientPrice||0),d=De(a.cost||0),f=r?`<span class="crew-position-card__subtitle">${b(r)}</span>`:"",y=k("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=k("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),_=k("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),N=c.get(String(a.id))||0,p=k("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",b(String(N)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${b(l)}">
        ${N>0?`<span class="crew-position-card__badge" aria-label="${p}">${b(String(N))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${b(l)}</h6>
            ${f}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${y}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${y}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${b(String(a.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${a.clientPrice==null?"":b(String(a.clientPrice))}" inputmode="decimal" placeholder="${b("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${a.id}">${k("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${a.id}">${k("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${a.id}">
            ${_}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${a.id}">
            ${k("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.stopPropagation(),Ke(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{a.dataset.editing!=="true"&&Ke(a.dataset.positionId)}),a.addEventListener("keydown",l=>{if(l.key==="Enter"||l.key===" "){if(l.preventDefault(),a.dataset.editing==="true")return;Ke(a.dataset.positionId)}}),a.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const r=a.closest(".crew-position-card");if(!r)return;const u=r.querySelector(".crew-position-card__metrics"),d=r.querySelector(".crew-position-card__footer"),f=r.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),f&&(f.hidden=!1),r.dataset.editing="true";const y=r.querySelector(".crew-position-edit-cost"),g=r.querySelector(".crew-position-edit-client"),_=N=>{N.addEventListener("input",p=>{const P=b(p.target.value).replace(/[^0-9.]/g,"");if(P!==p.target.value){const I=p.target.selectionEnd||P.length;p.target.value=P,p.target.setSelectionRange(I,I)}},{once:!0})};y&&_(y),g&&_(g)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();const r=a.closest(".crew-position-card"),u=a.dataset.positionId;if(!(!r||!u))try{const d=r.querySelector(".crew-position-edit-cost"),f=r.querySelector(".crew-position-edit-client"),y=b(d?.value||"").trim(),g=b(f?.value||"").trim(),_=y===""?0:Number.parseFloat(y),N=g===""?null:Number.parseFloat(g);if(!Number.isFinite(_)||_<0){z(k("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(N!=null&&(!Number.isFinite(N)||N<0)){z(k("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),f?.focus();return}ye();const p=X.find(h=>String(h.id)===String(u));if(!p){z(k("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await an(u,{name:p.name,cost:Number(_.toFixed(2)),clientPrice:N==null?null:Number(N.toFixed(2)),labelAr:p.labelAr,labelEn:p.labelEn}),z(k("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),Re(),Y()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const f=d?.message||k("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");z(f,"error")}}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const r=a.closest(".crew-position-card");if(!r)return;const u=r.querySelector(".crew-position-card__metrics"),d=r.querySelector(".crew-position-card__footer"),f=r.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),f&&(f.hidden=!0),delete r.dataset.editing}),a.dataset.listenerAttached="true")})}function Ke(e){ye();const n=X.find(c=>String(c.id)===String(e)),t=dt(n||{id:null,name:""}),i=ue(H);i.push(t),ne(H,i),Y(),z(k("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function Ft(e,n="create"){if(!e)return;const t=ue(n).filter(i=>i.assignmentId!==e);ne(n,t),Y(),z(k("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function we(e,n){if(!e)return;const t=ue(H),i=t.find(r=>r.assignmentId===e);if(!i)return;if(!n){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ne(H,t),Y(),z(k("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(t.find(r=>r.assignmentId!==e&&r.technicianId===n)){z(k("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),Y();return}const o=Me(n),{start:s,end:a,ignoreReservationId:l}=je(H);if(s&&a&&Ze(String(n),s,a,l)){try{const r=It(String(n),s,a,l),u=k("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=r&&r.length?`: ${r.join("ØŒ ")}`:"";z(`${u}${d}`,"warning",6e3)}catch{z(k("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}Y();return}o?(i.technicianId=String(o.id),i.technicianName=o.name??null,i.technicianRole=o.role??null,i.technicianPhone=o.phone??null):(i.technicianId=String(n),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ne(H,t),Y(),i.technicianName?z(k("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",b(i.technicianName)),"success"):z(k("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function pt(e="create"){H=e,Y(),Fe();let n=tn();if(!Array.isArray(n)||n.length===0)try{const i=await kt();n=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(n)&&(Ae=n);try{await nn()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}ye(),Re(),Y(),Fe();const t=document.getElementById("selectTechniciansModal");t&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(t).show()}function fn(){return ue(H).map(ge)}function _n(){const e=fn(),{start:n,end:t,ignoreReservationId:i}=je(H);if(n&&t){const o=e.filter(s=>s.technicianId&&Ze(s.technicianId,n,t,i));if(o.length>0){const s=o.map(l=>l.technicianName||l.technicianId).join(k("reservations.list.crew.separator","ØŒ ")),a=k("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",s);o.forEach(l=>{l.technicianId=null,l.technicianName=null}),ne(H,e),Y(),z(a),Fe();return}}ne(H,e);const c=document.getElementById("selectTechniciansModal");c&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(c)?.hide?.(),z(k("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function Ie(e,n=[],t="create"){const i=document.getElementById(e);if(i){if(!n.length){i.innerHTML=`<span class="text-muted">${k("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}ye(),i.innerHTML=n.map(c=>{let o=c.positionLabel??c.position_label??c.position_name??c.role??c.position??"";if(!o||String(o).trim()===""){const d=c.positionId?X.find(y=>String(y.id)===String(c.positionId)):null,f=!d&&c.positionKey?X.find(y=>String(y.name).toLowerCase()===String(c.positionKey).toLowerCase()):null;o=d?ke(d,le())||d?.name||"":f&&(ke(f,le())||f?.name)||""}const s=b(o||k("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=c.technicianName?`${b(c.technicianName)}`:k("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let l=Number(c.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[c.position_client_price,c.client_price,c.customer_price,c.daily_total,c.dailyTotal,c.total];for(const f of d){const y=Number(f);if(Number.isFinite(y)&&y>0){l=y;break}}}if((!Number.isFinite(l)||l<=0)&&(c.positionId||c.positionKey)){const d=c.positionId?X.find(g=>String(g.id)===String(c.positionId)):null,f=!d&&c.positionKey?X.find(g=>String(g.name).toLowerCase()===String(c.positionKey).toLowerCase()):null,y=d||f||null;y&&Number.isFinite(Number(y.clientPrice))&&(l=Number(y.clientPrice))}const r=De(Number.isFinite(l)&&l>0?l:0),u=k("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${c.assignmentId}">
        <span class="technician-chip-name">${s}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${r}</small>
        <button type="button" class="technician-chip-remove" data-context="${t}" data-assignment-id="${c.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(c=>{c.dataset.listenerAttached||(c.addEventListener("click",()=>{Ft(c.dataset.assignmentId,c.dataset.context)}),c.dataset.listenerAttached="true")})}}function gn(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",s=>{const a=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),r=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),f=!!(l&&r),y=!!(u&&d),g=!!a;if(!f||!y){s.preventDefault(),z(k("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){s.preventDefault(),z(k("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}pt("create")}),e.dataset.listenerAttached="true";const o=()=>{const s=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),r=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(s&&a&&l&&r&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(s=>document.getElementById(s)).filter(Boolean).forEach(s=>{["input","change"].forEach(a=>s.addEventListener(a,o))}),o()}const n=document.getElementById("open-edit-technician-picker");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>pt("edit")),n.dataset.listenerAttached="true");const t=document.getElementById("crew-position-search");t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{Re()}),t.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",_n),i.dataset.listenerAttached="true");const c=document.getElementById("selectTechniciansModal");c&&!c.dataset.listenerAttached&&window.bootstrap?.Modal&&(c.addEventListener("shown.bs.modal",async()=>{if(!Ae.length&&(!me().technicians||me().technicians.length===0))try{await kt()}catch(o){console.warn("[crew-picker] fetch on show failed",o)}Re(),Y(),Fe()}),c.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("crew-position-search");o&&(o.value="")}),c.dataset.listenerAttached="true"),Ie("selected-technicians-list",ce,"create"),Ie("edit-selected-technicians-list",se,"edit")}function pi({onDraftChange:e,onEditChange:n}={}){St=typeof e=="function"?e:()=>{},vt=typeof n=="function"?n:()=>{},gn()}function yn(){return ce.map(ge)}function hn(){return se.map(ge)}function mt(){return ce.map(e=>e.technicianId).filter(Boolean).map(String)}function ft(){return se.map(e=>e.technicianId).filter(Boolean).map(String)}function mi(e=[]){ne("create",e)}function fi(e=[]){ne("edit",e)}function _i(){ne("create",[])}function gi(){ne("edit",[])}function _t(e=[]){return e.map(n=>{if(n.technicianId){const t=Me(n.technicianId);if(t)return n.technicianId=String(t.id),n.technicianName=t.name??n.technicianName??null,n.technicianRole=t.role??n.technicianRole??null,n.technicianPhone=t.phone??null,n;n.technicianId=null,n.technicianName=null,n.technicianRole=null,n.technicianPhone=null}return n})}function yi(e=[]){Array.isArray(e)&&e.length&&(Ae=e),ce=_t(ce),se=_t(se),Ie("selected-technicians-list",ce,"create"),Ie("edit-selected-technicians-list",se,"edit"),Y()}function gt(e){const n=e.split(".");if(n.length<=2)return e;const t=n.pop(),i=n.join("");return t?`${i}.${t}`:i}function Lt(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let n=b(String(e)).trim();if(!n)return Number.NaN;const t=n.search(/[0-9]/),i=n.indexOf("-"),c=i!==-1&&(t===-1||i<t);if(n=n.replace(/[-+]/g,""),n=n.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),n=n.replace(/[^0-9.,]/g,""),!n)return Number.NaN;const o=n.includes(","),s=n.includes(".");if(o&&s){const l=n.lastIndexOf(","),r=n.lastIndexOf(".");l>r?(n=n.replace(/\./g,""),n=n.replace(/,/g,".")):n=n.replace(/,/g,"")}else if(o){const l=n.split(",");l.length===2&&l[1].length===3?n=l.join(""):n=n.replace(/,/g,".")}else if(s){const l=n.split(".");if(l.length===2){const[,r]=l;if(r.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(n=u)}}else l.length>2&&(n=gt(n))}if(n=n.replace(/,/g,""),n=gt(n),!/^[0-9]*\.?[0-9]*$/.test(n)||!n||n===".")return Number.NaN;const a=Number.parseFloat(n);return Number.isFinite(a)?c?-a:a:Number.NaN}function D(e){return Lt(e)}function $(e){const n=Lt(e);if(!Number.isFinite(n))return 0;let t=n,i=0;for(;Math.abs(t)>1e5&&i<8;)t/=10,i+=1;return Number(t.toFixed(2))}function ve(e){return b(String(e??"")).trim().toLowerCase()}function Et(e=""){return b(String(e)).trim().toLowerCase()}const bn=2;function Nn(e){const n=D(e);return Number.isFinite(n)?n.toFixed(bn):"0.00"}function Qe(e={}){const n=[e?.qty,e?.quantity,e?.count,e?.units];for(const t of n){const i=Number.parseFloat(b(String(t??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return $(i)}return 1}function Pn(e={}){const n=e?.desc||e?.description||e?.name||"",t=Et(n),i=Nn(e?.price??e?.unitPrice??e?.unit_price??0);return`${t}::${i}`}function An(e=[]){const n=new Map;return e.forEach((t,i)=>{const c=Pn(t);if(!c)return;if(!n.has(c)){const s=t?.desc||t?.description||t?.name||"",a=Et(s),l=ht(t),r=bt(t),u=t?.image||t?.imageUrl||t?.img||"";n.set(c,{key:c,description:s,normalizedDescription:a,unitPrice:l,unitCost:r,image:u,items:[],itemIndices:[],barcodes:[]})}const o=n.get(c);o.items.push(t),o.itemIndices.push(i),t?.barcode&&o.barcodes.push(String(t.barcode))}),Array.from(n.values()).map(t=>({...t,quantity:t.items.reduce((i,c)=>i+Qe(c),0)})).map(t=>{const i=t.quantity||0,c=t.items.reduce((g,_)=>{const N=ht(_),p=Qe(_);return g+N*p},0),o=$(c),s=D(t.unitPrice),a=Number.isFinite(s)?s:0,l=t.items.reduce((g,_)=>{const N=bt(_),p=Qe(_);return g+N*p},0),r=$(l),u=D(t.unitCost),d=Number.isFinite(u)?u:0,f=i>0?$(o/i):$(a),y=i>0?$(r/i):$(d);return{...t,quantity:i,count:i,totalPrice:o,unitPrice:f,totalCost:r,unitCost:y}})}function yt(e={}){return(Pe(e)||[]).map(t=>({...t,normalizedBarcode:t?.normalizedBarcode??ve(t?.barcode),qty:(()=>{const i=Number.parseFloat(b(String(t?.qty??t?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=D(t?.price??t?.unit_price??t?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=D(t?.cost??t?.unit_cost??t?.unitCost??t?.rental_cost??t?.purchase_price);return Number.isFinite(i)?i:0})()}))}function kn(e={},{packageQuantity:n=1}={}){const t=fe(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=t&&_e(t)||e,c=Pe(i)||[],o=Number.isFinite(Number(n))&&Number(n)>0?Number(n):1;return c.map(s=>{const l=D(s?.price??s?.unit_price??s?.unitPrice),r=Number.isFinite(l)?$(l):0,u=D(s?.cost??s?.unit_cost??s?.unitCost??s?.rental_cost??s?.purchase_price),d=Number.isFinite(u)?$(u):0,f=1*o,y=$(r*f),g=$(d*f);return{equipmentId:s?.equipmentId??s?.equipment_id??null,barcode:s?.barcode??s?.normalizedBarcode??"",desc:s?.desc??s?.description??"",qtyPerPackage:1,packageQuantity:o,totalUnits:f,unitPrice:r,perDayTotal:y,unitCost:d,perDayCost:g}})}function In(e={},{packageQuantity:n=1,days:t=1}={}){const i=kn(e,{packageQuantity:n}),c=$(i.reduce((l,r)=>l+(Number(r.perDayTotal)||0),0)),o=$(i.reduce((l,r)=>l+(Number(r.perDayCost)||0),0)),s=$(c*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1)),a=$(o*(Number.isFinite(Number(t))&&Number(t)>0?Number(t):1));return{lines:i,perDayTotal:c,total:s,perDayCostTotal:o,costTotal:a}}function Cn(e={}){const n=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,t=Number.parseFloat(b(String(n)).replace(/[^0-9.]/g,""));return Number.isFinite(t)&&t>0?t:1}function Sn(e={},n=[],t=null){try{const r=fe(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(r){const u=_e(r);if(u){const d=u.price??u.total_price??u.package_price,f=D(d);if(Number.isFinite(f)&&f>0)return $(f)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,c=D(i);if(Number.isFinite(c)&&c>0)return $(c);const o=e.total_price??e.totalPrice??e.total,s=D(o),a=Number.parseFloat(b(String(t)).replace(/[^0-9.]/g,"")),l=Number.isFinite(a)&&a>0?a:Cn(e);return Number.isFinite(s)&&s>0&&l>0?$(s/l):0}function vn(e={}){const n=Array.isArray(e?.items)?e.items:[],t=An(n),i=et(),c=new Set,o=new Map;i.forEach(p=>{const h=fe(p?.id??p?.packageId??p?.package_id??p?.code);h&&c.add(h);const P=b(String(p?.package_code??p?.code??"")).trim().toLowerCase();P&&o.set(P,h||P)});const s=(p,h=0)=>{const P=fe(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),I=b(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return P||(I&&o.has(I)?o.get(I):I||`pkg-${h}`)},a=new Map,l=(p,h=0,P="packages")=>{if(!p||typeof p!="object")return;const S=s(p,h)||`pkg-${h}`;if(!a.has(S)){a.set(S,{source:p,normalizedId:S,index:h,itemSource:P==="items"?p:null});return}const A=a.get(S);if(A.source||(A.source=p),P==="items"&&(A.itemSource=p,A.source&&typeof A.source=="object")){const q=Array.isArray(A.source.packageItems)&&A.source.packageItems.length>0,L=Array.isArray(p.packageItems)&&p.packageItems.length>0;!q&&L&&(A.source={...A.source,packageItems:p.packageItems}),!A.source.image&&p.image&&(A.source={...A.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,h)=>l(p,h,"packages")),n.forEach((p,h)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const P=s(p,h+a.size);l({...p,package_id:P,packageId:P,package_code:p.package_code??p.code},h+a.size,"items")}});const r=[],u=new Set,d=new Set;a.forEach(({source:p,itemSource:h=null,normalizedId:P},I)=>{const A=(P?_e(P):null)||p||{},q=h&&typeof h=="object"?h:null;let L=yt(A);(!Array.isArray(L)||L.length===0)&&q&&(L=yt(q)),L.forEach(F=>{const T=F?.normalizedBarcode??ve(F?.barcode);T&&u.add(T);const B=F?.equipmentId??F?.equipment_id??null;B!=null&&d.add(String(B))});let R=1,w=Sn(A,L,R);const m=[q?.price,q?.unit_price,q?.unitPrice];for(const F of m){const T=D(F);if(Number.isFinite(T)&&T>0){w=$(T);break}}w=$(w);const U=[A?.unit_cost,A?.unitCost,A?.cost,q?.unit_cost,q?.unitCost,q?.cost];let V=0;for(const F of U){const T=D(F);if(Number.isFinite(T)&&T>=0){V=$(T);break}}if(!V&&Array.isArray(L)&&L.length){const F=L.reduce((T,B)=>{const de=D(B?.cost),he=Number.isFinite(Number(B?.qtyPerPackage))&&Number(B.qtyPerPackage)>0?Number(B.qtyPerPackage):1;return T+(Number.isFinite(de)?de:0)*he},0);V=$(F)}const O=(()=>{const F=[A?.pricing_mode,A?.pricingMode,A?.pricing,q?.pricing_mode,q?.pricingMode,q?.pricing];for(const T of F){if(T==null)continue;const B=String(T).trim().toLowerCase();if(B==="daily"||B==="per_day"||B==="day")return"daily";if(B==="fixed"||B==="per_booking"||B==="booking")return"fixed"}return"daily"})(),K=[q?.total,q?.total_price,q?.totalPrice,A?.total,A?.total_price,A?.totalPrice];let Q=NaN;for(const F of K){const T=D(F);if(Number.isFinite(T)&&T>=0){Q=T;break}}Number.isFinite(Q)||(Q=w*R),Q=$(Q);const ee=[A?.package_code,A?.code,A?.packageCode,A?.displayCode,A?.display_code,A?.barcode,q?.package_code,q?.code,q?.packageCode,q?.displayCode,q?.display_code,q?.barcode,P,I].find(F=>F==null?!1:String(F).trim().length>0),v=ee!=null?b(String(ee)).trim():"";if(v){const F=ve(v);F&&u.add(F)}const E=L.map(F=>b(String(F?.barcode??F?.normalizedBarcode??""))).filter(Boolean),G=[A?.name,A?.package_name,A?.title,q?.name,q?.desc,q?.package_name,v,b(String(I))].find(F=>F!=null&&String(F).trim()!=="")||b(String(v||I)),ae=L.find(F=>F?.image)?.image??A?.image??q?.image??null,j=1;r.push({key:`package::${I}`,description:G,normalizedDescription:b(String(G)),unitPrice:w,unitCost:V,totalPrice:Q,pricingMode:O,quantity:R,count:j,image:ae,barcodes:E,barcode:v,package_code:v,packageDisplayCode:v,items:[{type:"package",packageItems:L,packageId:P,desc:G,price:w,cost:V,qty:j,barcode:v}],type:"package",packageItems:L,packageId:P})});const f=new Set(Array.from(u).map(p=>ve(p)).filter(Boolean)),y=t.filter(p=>{if(p.items.some(S=>S?.type==="package")&&r.length>0)return!1;const P=(S={})=>[S.packageId,S.package_id,S.package_code,S.packageCode,S.bundleId,S.bundle_id].some(A=>A!=null&&A!=="");return!p.items.every(S=>{const A=qn(S),q=A!=null?String(A):null;if(q&&d.has(q))return!0;const L=S?.barcode?ve(S.barcode):null;return!!(L&&f.has(L)||P(S))})}),g=new Set,_=[];return r.forEach(p=>{const h=s({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!h||g.has(h)||(g.add(h),_.push(p))}),{groups:_.length?[..._,...y]:t,packageGroups:r,groupedItems:t,filteredGroupedItems:y,packagesMap:a}}function qn(e={}){const n=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const t of n)if(!(t==null||t===""))return String(t);return null}function ht(e={}){const n=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function bt(e={}){const n=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const t of n){const i=D(t);if(Number.isFinite(i))return i}return 0}function hi(e){const n=e?.status??e?.reservationStatus??null;if(n){const c=String(n).trim().toLowerCase();if(c==="completed"||c==="closed"||c==="Ù…ØºÙ„Ù‚"||c==="Ù…ÙƒØªÙ…Ù„"||c==="Ù…Ù†ØªÙ‡ÙŠ"||c==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function Fn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function bi(e={},n=null){const t=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,c=i!=null&&i!==""&&i!=="null",o=c?Fn(n?.status??n?.status_label??n?.statusLabel??""):null,s=c&&(n?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:t,projectLinked:c,projectStatus:o,projectConfirmed:s,effectiveConfirmed:c?s:t}}const Tt=10;function $t(e={}){const n=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const t of n){const i=D(t);if(Number.isFinite(i))return $(i)}return 0}function Ln(e={}){const n=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const t of n){if(t==null||t==="")continue;const i=D(t);if(Number.isFinite(i))return $(i)}return $t(e)}function En(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:n=[]}=me();if(!Array.isArray(n)||n.length===0)return{costPerDay:0,totalPerDay:0};const t=new Map(n.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,c)=>{const o=t.get(String(c));if(!o)return i;const s=$t(o),a=Ln(o);return{costPerDay:i.costPerDay+(Number.isFinite(s)?s:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const Tn=1440*60*1e3,Ne=.01;function be(e){if(e==null||e==="")return null;const n=b(String(e)).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return Number.isFinite(t)?t:null}function Nt(e,{min:n=0,max:t=Number.POSITIVE_INFINITY,precision:i=2}={}){let c=Number.isFinite(e)?e:0;if(c<n&&(c=n),c>t&&(c=t),i!=null){const o=10**i;c=Math.round(c*o)/o}return c}function wt(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function nt({totalAmount:e=0,progressType:n=null,progressValue:t=null,paidAmount:i=null,paidPercent:c=null,history:o=[]}={}){const s=Number.isFinite(Number(e))?Number(e):0,a=n==="amount"?"amount":n==="percent"?"percent":null;let l=be(i),r=be(c);const u=be(t);let d=0,f=0;Array.isArray(o)&&o.length&&o.forEach(p=>{if(!p)return;const h=p.type==="amount"||p.type==="percent"?p.type:null,P=be(p.value),I=be(p.amount),S=be(p.percentage);if(h==="amount"){const A=I??P;A!=null&&(d+=A,s>0&&(f+=A/s*100))}else if(h==="percent"){const A=S??P;A!=null&&(f+=A,s>0&&(d+=A/100*s))}else I!=null&&(d+=I,s>0&&(f+=I/s*100)),S!=null&&(f+=S,s>0&&(d+=S/100*s))}),a==="amount"&&u!=null?l=u:a==="percent"&&u!=null?r=u:a===null&&u!=null&&(r!=null?r=u:l=u),(l==null||l<=0)&&r!=null&&r>0&&s>0&&(l=s*(r/100)),(r==null||r<=0)&&l!=null&&l>0&&s>0&&(r=l/s*100);const y=l??0,g=r??0;l=y+d,r=g+f,l=Nt(l??0,{min:0,max:s>0?s:Number.POSITIVE_INFINITY,precision:2}),r=Nt(r??0,{min:0,max:100,precision:2});let _=a;return _||(l>0&&s>0?_="amount":r>0&&(_="percent")),{paidAmount:l,paidPercent:r,paymentProgressType:_,paymentProgressValue:_==="amount"?l:_==="percent"?r:null}}function it({manualStatus:e="unpaid",paidAmount:n=0,paidPercent:t=0,totalAmount:i=0}={}){const c=wt(e),o=Number.isFinite(Number(i))?Number(i):0,s=Number.isFinite(Number(n))?Number(n):0,a=Number.isFinite(Number(t))?Number(t):0;if(c==="paid")return"paid";const l=o>0&&s>=o-Ne,r=a>=100-Ne*100;if(l||r)return"paid";const u=s>Ne||a>Ne;return c==="partial"||u?"partial":"unpaid"}function $n(e,n){if(!e||!n)return 1;const t=new Date(e),i=new Date(n);if(Number.isNaN(t.getTime())||Number.isNaN(i.getTime()))return 1;const c=i.getTime()-t.getTime();if(c<=0)return 1;const o=c/Tn;return Math.max(1,Math.ceil(o))}function Ce({items:e=[],technicianIds:n=[],crewAssignments:t=[],discount:i=0,discountType:c="percent",applyTax:o=!1,start:s=null,end:a=null,companySharePercent:l=null,groupingSource:r=null}={}){const u=$n(s,a);let d=!1;try{if(typeof window<"u"&&window.location){const v=new URL(window.location.href),E=(v.searchParams.get("noDays")||v.searchParams.get("pricing")||"").toLowerCase();d=E==="1"||E==="true"||E==="fixed"||E==="nodays"}}catch{}const f=r&&typeof r=="object"?r:{items:Array.isArray(e)?e:[]},{groups:y}=vn(f),g=v=>{if((v?.type||"").toLowerCase()==="package")return!0;const E=Array.isArray(v?.items)?v.items:[];if(!E.length)return!1;if(E.some(j=>j?.reservation_id!=null||j?.reservationId!=null))return!0;const G=E.every(j=>j?.unit_price!=null||j?.unitPrice!=null),ae=E.some(j=>j?.daily_rate!=null||j?.dailyRate!=null||j?.unit_rate!=null||j?.unitRate!=null||j?.price!=null);return!!(G&&!ae)};let _=0,N=0;(Array.isArray(y)?y:[]).forEach(v=>{const E=Number.isFinite(Number(v?.quantity))?Number(v.quantity):0,ie=Number.isFinite(Number(v?.unitPrice))?Number(v.unitPrice):0,G=Number.isFinite(Number(v?.unitCost))?Number(v.unitCost):0,ae=String(v?.type||"").toLowerCase()==="package",j=g(v),F=d||j?1:u;if(ae){const T={package_code:v?.package_code||v?.packageDisplayCode||v?.barcode||v?.packageId||v?.key,packageItems:Array.isArray(v?.packageItems)?v.packageItems:void 0},B=In(T,{packageQuantity:E,days:F}),de=Number.isFinite(Number(B.total))?Number(B.total):E*(Number.isFinite(ie)?ie:0)*F,he=(()=>{const pe=Number(B?.costTotal);if(Number.isFinite(pe))return pe;const Te=Number(B?.perDayCostTotal);return Number.isFinite(Te)?Te*F:E*(Number.isFinite(G)?G:0)*F})();_+=de,N+=he}else _+=E*ie*F,N+=E*G*F});const p=$(_),h=$(N),P=Array.isArray(t)?t:[],I=P.length?P.map(v=>v?.technicianId).filter(Boolean):Array.isArray(n)?n:[],{costPerDay:S,totalPerDay:A}=P.length?P.reduce((v,E)=>{const ie=D(E?.positionCost??E?.position_cost??E?.cost??E?.dailyWage??E?.daily_wage??0),G=D(E?.positionClientPrice??E?.position_client_price??E?.clientPrice??E?.dailyTotal??E?.daily_total??E?.total??0),ae=Number.isFinite(ie)?ie:0,j=Number.isFinite(G)?G:0;return{costPerDay:v.costPerDay+ae,totalPerDay:v.totalPerDay+j}},{costPerDay:0,totalPerDay:0}):En(I),q=$(A*u),L=$(S*u),R=$(p+q),w=Number(i)||0;let m=c==="amount"?w:R*(w/100);(!Number.isFinite(m)||m<0)&&(m=0),m>R&&(m=R);const U=Math.max(0,R-m),V=Number.isFinite(l)&&Number(l)>0?Number(l):0,Z=V>0?Math.max(0,U*(V/100)):0,O=U+Z;let K=o?O*.15:0;(!Number.isFinite(K)||K<0)&&(K=0),K=Number(K.toFixed(2));const Q=O+K,x=Math.max(0,Number(Q.toFixed(2))),ee=Math.max(0,Math.max(0,p+q-m)-L-h);return{rentalDays:u,equipmentTotal:p,equipmentCostTotal:h,crewTotal:q,crewCostTotal:L,discountAmount:m,subtotalAfterDiscount:U,taxableAmount:O,taxAmount:K,finalTotal:x,companySharePercent:V,companyShareAmount:Z,netProfit:ee}}function Ni(e=[],n=0,t="percent",i=!1,c=[],{start:o=null,end:s=null,companySharePercent:a=null}={}){const l=y=>y&&typeof y=="object"&&(y.positionId!==void 0||y.position_id!==void 0||y.positionLabel!==void 0||y.position_name!==void 0||y.positionClientPrice!==void 0),r=Array.isArray(c)&&c.some(l)?c:[],u=r.length?r.map(y=>y?.technicianId).filter(Boolean):Array.isArray(c)?c:[];return Ce({items:e,technicianIds:u,crewAssignments:r,discount:n,discountType:t,applyTax:i,start:o,end:s,companySharePercent:a??Tt}).finalTotal}function xt({total:e,itemsCount:n,rentalDays:t,techniciansCount:i,applyTax:c,paymentStatus:o,paidAmount:s=0,paidPercent:a=0,companySharePercent:l=null,companyShareAmount:r=null,taxAmount:u=null,netProfit:d=null,totalKey:f="reservations.summary.total",equipmentTotal:y=null,crewTotal:g=null,equipmentCostTotal:_=null}){const N=k("reservations.create.summary.currency","SR"),p=b(String(e)),h=b(String(n)),P=b(String(t??1)),I=b(String(i)),S=wt(o),A=S==="paid"?"Ù…Ø¯ÙÙˆØ¹":S==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",q=k(`reservations.create.paymentStatus.${S}`,A),L=Number.isFinite(Number(s))?Math.max(0,Number(s)):0,R=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,w=L>Ne||R>Ne,m=k("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),U=b(L.toFixed(2)),V=b(R.toFixed(R%1?2:0)),Z=k("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),O=k("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),K=k("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),Q=k("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),x=k("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),ee=k("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),v=k("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),E=k("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),G=k(f==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",k("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),ae=k("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),j=k("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),F=Number.isFinite(d)?Math.max(0,Number(d)):null,T=[{label:Z,value:h},{label:O,value:P},{label:K,value:I}],B=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;B!=null&&T.push({label:Q,value:`${b(B.toFixed(2))} ${N}`});const de=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;de!=null&&T.push({label:x,value:`${b(de.toFixed(2))} ${N}`});const he=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(he!=null&&T.push({label:ee,value:`${b(he.toFixed(2))} ${N}`}),c){let oe=k("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(oe=`${b(Number(u).toFixed(2))} ${N}`),T.push({label:v,value:oe})}const pe=Number.isFinite(l)?Number(l):null;if(pe!==null&&pe>0){const oe=Number.isFinite(r)?Number(r):e*(pe/100),Se=b(String(pe)),Yt=b(Number.isFinite(oe)?oe.toFixed(2):"0"),Jt=`${Se}% (${Yt} ${N})`;T.push({label:ae,value:Jt})}if(F!==null&&Math.abs(F-Number(e))>.009){const oe=b(F.toFixed(2));T.push({label:j,value:`${oe} ${N}`})}T.push({label:E,value:q}),w&&T.push({label:m,value:`${U} ${N} (${V}%)`});const Te=`${p} ${N}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${T.map(({label:oe,value:Se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${oe}</span>
            ${Se?`<span class="reservation-summary-value">${Se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${G}</span>
          <span class="reservation-summary-value">${Te}</span>
        </div>
      </div>
    </div>
  `}function wn({selectedItems:e,discount:n,discountType:t,applyTax:i,paidStatus:c,paymentProgressType:o=null,paymentProgressValue:s=null,start:a,end:l,companySharePercent:r=null,paymentHistory:u=[]}){const d=yn(),f=typeof mt=="function"?mt()??[]:[],y=Array.isArray(f)?f.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):y,_=d.length||g.length,N=Number.isFinite(r)?Number(r):null,p=Ce({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:a,end:l,companySharePercent:N}),h=nt({totalAmount:p.finalTotal,progressType:o,progressValue:s,history:u}),P=it({manualStatus:c,paidAmount:h.paidAmount,paidPercent:h.paidPercent,totalAmount:p.finalTotal}),I=xt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,paymentProgressType:h.paymentProgressType,paymentProgressValue:h.paymentProgressValue,total:p.finalTotal};return wn.lastResult=S,Dn(I),I}function xn({items:e,discount:n,discountType:t,applyTax:i,paidStatus:c,paymentProgressType:o=null,paymentProgressValue:s=null,start:a,end:l,companySharePercent:r=null,paymentHistory:u=[]}){const d=hn(),f=typeof ft=="function"?ft()??[]:[],y=Array.isArray(f)?f.map(String):[],g=d.length?d.map(A=>A?.technicianId).filter(Boolean).map(String):y,_=d.length||g.length,N=Number.isFinite(r)?Number(r):null,p=Ce({items:e,technicianIds:g,crewAssignments:d,discount:n,discountType:t,applyTax:i,start:a,end:l,companySharePercent:N}),h=nt({totalAmount:p.finalTotal,progressType:o,progressValue:s,history:u}),P=it({manualStatus:c,paidAmount:h.paidAmount,paidPercent:h.paidPercent,totalAmount:p.finalTotal}),I=xt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:_,applyTax:i,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),S={html:I,paymentStatus:P,paidAmount:h.paidAmount,paidPercent:h.paidPercent,paymentProgressType:h.paymentProgressType,paymentProgressValue:h.paymentProgressValue,total:p.finalTotal};return xn.lastResult=S,I}function Dn(e){const n=document.getElementById("reservation-preview");n&&(n.innerHTML=e,Pt(n,e));const t=document.getElementById("reservation-preview-bottom");t&&(t.innerHTML=e,Pt(t,e))}function Pt(e,n){const t=typeof n=="string"&&n.trim().length>0;e.classList.toggle("reservation-summary-host",t)}const Rn=me()||{};let te=(Rn.reservations||[]).map(Ot);function J(e){let n=Number(e);if(!Number.isFinite(n))return 0;let t=0;for(;Math.abs(n)>1e5&&t<8;)n/=10,t+=1;return Number(n.toFixed(2))}const Dt="__reservation_packages_cache__",Rt="__reservation_item_cost_cache__";function Bt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function zt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Mt(){const e=Bt();if(!e)return{};try{const n=e.getItem(Dt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation packages cache",n),{}}}function At(e){const n=Bt();if(n)try{n.setItem(Dt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation packages cache",t)}}function at(){const e=zt();if(!e)return{};try{const n=e.getItem(Rt);if(!n)return{};const t=JSON.parse(n);return t&&typeof t=="object"?t:{}}catch(n){return console.warn("[reservationsService] Failed to read reservation item cost cache",n),{}}}function We(e){const n=zt();if(n)try{n.setItem(Rt,JSON.stringify(e))}catch(t){console.warn("[reservationsService] Failed to persist reservation item cost cache",t)}}function Bn(e,n=0){if(!e||typeof e!="object")return null;const t=e.equipment_id??e.equipmentId??e.id??null,i=b(String(e.barcode??e.code??"")).trim(),c=J(C(e.cost??e.unit_cost)),o=J(C(e.price??e.unit_price)),s=Number.isFinite(c),a=Number.isFinite(o);return!s&&!a?null:{key:t!=null?`id:${t}`:i?`bc:${i}`:`idx:${n}`,equipmentId:t,barcode:i,cost:s?c:null,price:a?o:null}}function zn(e,n){if(!e)return;const t=Array.isArray(n)?n.map((o,s)=>Bn(o,s)).filter(Boolean):[],i=at(),c=String(e);if(!t.length){i[c]&&(delete i[c],We(i));return}i[c]=t,We(i)}function Mn(e=[]){const n=at(),t=new Set;e.forEach(c=>{const o=c?.id??c?.reservationId??c?.reservation_code??null;o&&t.add(String(o))});let i=!1;Object.keys(n).forEach(c=>{t.has(c)||(delete n[c],i=!0)}),i&&We(n)}function jn(e){if(!e)return[];const n=at(),t=String(e),i=n[t];return Array.isArray(i)?i:[]}function Hn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const n=et();if(!Array.isArray(n)||n.length===0)return[];const t=new Map;e.forEach(c=>{if(!c||typeof c!="object")return;const o=c.equipmentId??c.equipment_id??c.id??null;if(o==null)return;const s=String(o),a=(()=>{const l=[c.qty,c.quantity,c.count,1];for(const r of l){const u=Number(r);if(Number.isFinite(u)&&u>0)return u}return 1})();t.set(s,(t.get(s)||0)+a)});const i=[];return n.forEach((c,o)=>{const s=Pe(c)||[],a=new Map;let l=!0;if(s.forEach(g=>{const _=g?.equipmentId??g?.equipment_id??null,N=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(_==null){l=!1;return}const p=String(_);a.set(p,(a.get(p)||0)+N)}),!l||a.size===0)return;let r=1/0;for(const[g,_]of a.entries()){const N=t.get(g)||0,p=Math.floor(N/_);if(p<=0){r=0;break}p<r&&(r=p)}if(!Number.isFinite(r)||r<=0)return;for(const[g,_]of a.entries()){const N=t.get(g)||0;t.set(g,Math.max(0,N-r*_))}const u=fe(c?.id??c?.packageId??c?.package_id??c?.code),d=Array.from(a.entries()).map(([g,_])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:_,unit_price:0})),f=(c?.package_code??c?.code??u)||`pkg-${o}`,y=cn(c)||u||`package-${o}`;i.push({package_code:f,name:y,quantity:r,unit_price:Ct(c)||0,items:d})}),i}function Vn(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(n=>{const i=(n.positionLabel??"").trim().length>0,c=n.positionId!=null||n.positionKey!=null&&String(n.positionKey).trim()!=="",o=Number.isFinite(Number(n.positionClientPrice))&&Number(n.positionClientPrice)>0,s=Number.isFinite(Number(n.positionCost))&&Number(n.positionCost)>0;return i||c||o||s})}function On(e){return[]}function jt(e=[]){return Array.isArray(e)?e.map((n,t)=>Wt(n,t)).filter(Boolean).map((n,t)=>{const i=fe(n.packageId??n.package_id??n.package_code??n.code??n.id??`pkg-${t}`),c=Be(n,i).map(r=>{const u=M(r.qty??r.quantity??r.count??r.units??r.unit_qty??r.unitQty??r.unit_count??r.unitCount??r.package_quantity??r.packageQty??1),d=J(C(r.price??r.unit_price??0));return{...r,qty:u,quantity:u,price:d,unit_price:d}}),o=M(n.quantity??n.qty??1);let s=J(C(n.unit_price??n.unitPrice??n.price??0));if(!s||s<=0){const r=c.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);r>0&&o>0&&(s=J(Number((r/o).toFixed(2))))}const a=C(n.total_price??n.totalPrice??n.total??s*o),l=a>0?J(a):J(Number((s*o).toFixed(2)));return{...n,packageId:i,package_id:i,qty:o,quantity:o,unit_price:s,unitPrice:s,price:s,total_price:l,total:l,packageItems:c}}):[]}function Le(e,n){if(!e)return;const t=Mt(),i=String(e);if(!Array.isArray(n)||n.length===0){t[i]&&(delete t[i],At(t));return}t[i]=jt(n),At(t)}function Kn(e){if(!e)return[];const n=Mt(),t=String(e),i=n[t];return Array.isArray(i)?jt(i):[]}function ot(e,n=0){if(e==null)return null;if(typeof e!="object"){const P=e!=null?String(e):null;return{assignmentId:`crew-${n}-${P??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:P,technicianName:null,technicianRole:null,notes:null}}const t=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${n}`,i=e&&typeof e.position=="object"?e.position:null,c=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,o=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let s=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";s||(s=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,l=e.position_label_en??null,r=e.position_label_alt??l??a??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,f=J(D(u)),y=J(D(d)),g=e&&typeof e.technician=="object"?e.technician:null,_=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,N=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,p=e.role??g?.role??e.specialization??null,h=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(t),positionId:c!=null?String(c):null,positionKey:o!=null?String(o):null,positionLabel:s!=null?String(s):"",positionLabelAlt:r!=null?String(r):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(f)?f:0,positionClientPrice:Number.isFinite(y)?y:0,technicianId:_!=null?String(_):null,technicianName:N!=null?String(N):null,technicianRole:p!=null?String(p):null,technicianPhone:h!=null?String(h):null,notes:e.notes??null}}function Qn(){return te}function Ee(e){te=Array.isArray(e)?e.map(Ve):[],te.forEach(n=>{if(!n)return;const t=n.id??n.reservationId??n.reservationCode;Le(t,n.packages),zn(t,n.items);const i=n.crewAssignments&&n.crewAssignments.length?n.crewAssignments:n.techniciansDetails||[];Vn(i)}),Mn(te),Xt({reservations:te});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return te}async function Un(e={}){const n=new URLSearchParams;Object.entries(e).forEach(([a,l])=>{l!=null&&l!==""&&n.set(a,String(l))});const t=n.toString(),c=(await ze(`/reservations/${t?`?${t}`:""}`))?.data;let o=[];Array.isArray(c)?o=c:c&&typeof c=="object"&&(Array.isArray(c.items)?o=c.items:Array.isArray(c.results)?o=c.results:Array.isArray(c.data)?o=c.data:Array.isArray(c.records)&&(o=c.records));const s=o.map(He).map(Vt);return Ee(s)}async function Gn(e){const n=await ze("/reservations/",{method:"POST",body:e}),t=He(n?.data??{}),i=Array.isArray(e?.items)?e.items:null;if(i&&(Array.isArray(t.items)&&t.items.length?t.items=Ht(t.items,i):t.items=i.map(Oe)),!Number.isFinite(t.companySharePercent)&&e?.company_share_percent!=null&&(t.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(t.paymentHistory)||t.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const c=st(e.payment_history);c.length&&(t.paymentHistory=c)}if((!Array.isArray(t.crewAssignments)||t.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const c=e.technicians.map((o,s)=>ot(o,s)).filter(Boolean);c.length&&(t.crewAssignments=c,t.techniciansDetails=c.map((o,s)=>{const a=e.technicians[s];return typeof a=="object"?{...a,...o}:o}))}if(Array.isArray(e?.packages)&&e.packages.length){const c=ut({packages:e.packages});t.packages=re(t.packages,c)}{const c=lt(t.items||[],t.packages||[]);t.items=c.items,t.packages=re(t.packages||[],c.packages)}if(Le(t.id??t.reservationId??t.reservation_code,t.packages),t.companySharePercent>0&&(!Number.isFinite(t.companyShareAmount)||t.companyShareAmount<=0)){const c=Ce({items:t.items||[],technicianIds:t.technicians||[],discount:t.discount,discountType:t.discountType,applyTax:t.applyTax,start:t.start,end:t.end,companySharePercent:t.companySharePercent});t.companyShareAmount=c.companyShareAmount,t.cost=c.finalTotal,t.totalAmount=c.finalTotal}return t.companyShareEnabled=e?.company_share_enabled?!0:t.companySharePercent>0,Ee([...te,t]),t}async function ct(e,n){const t=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:n}),i=He(t?.data??{}),c=Array.isArray(n?.items)?n.items:null;if(c&&(Array.isArray(i.items)&&i.items.length?i.items=Ht(i.items,c):i.items=c.map(Oe)),console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&n?.company_share_percent!=null&&(i.companySharePercent=Number(n.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(n?.payment_history)){const s=st(n.payment_history);s.length&&(i.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(n?.technicians)&&n.technicians.length){const s=n.technicians.map((a,l)=>ot(a,l)).filter(Boolean);s.length&&(i.crewAssignments=s,i.techniciansDetails=s.map((a,l)=>{const r=n.technicians[l];return typeof r=="object"?{...r,...a}:a}))}if(Array.isArray(n?.packages))if(n.packages.length){const s=ut({packages:n.packages});i.packages=re(i.packages,s)}else i.packages=[];{const s=lt(i.items||[],i.packages||[]);i.items=s.items,i.packages=re(i.packages||[],s.packages)}if(Le(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const s=Ce({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=s.companyShareAmount,i.cost=s.finalTotal,i.totalAmount=s.finalTotal}i.companyShareEnabled=n?.company_share_enabled?!0:i.companySharePercent>0;const o=te.map(s=>String(s.id)===String(e)?i:s);return Ee(o),i}function Ht(e,n){if(!Array.isArray(e)||!Array.isArray(n))return e;const t=new Map;return n.forEach((i,c)=>{if(!i||typeof i!="object")return;const o=i.equipment_id??i.equipmentId??i.id??null,s=b(String(i.barcode??"")).trim(),a=o!=null?`id:${o}`:s?`bc:${s}`:`idx:${c}`,l=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,r=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;t.set(a,{cost:l,price:r})}),e.map((i,c)=>{const o=i.equipmentId??i.equipment_id??i.id??null,s=b(String(i.barcode??"")).trim(),a=[o!=null?`id:${o}`:null,s?`bc:${s}`:null,`idx:${c}`].filter(Boolean);let l=null;for(const u of a)if(t.has(u)){l=t.get(u);break}if(!l)return i;const r={...i};return Number.isFinite(l.cost)&&(r.cost=l.cost,r.unit_cost=l.cost),Number.isFinite(l.price)&&(r.price=l.price,r.unit_price=l.price),r})}function Vt(e){try{return Wn(e)}catch(n){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",n),e}}function Wn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!n.length)return e;const t=te.find(o=>{if(!o)return!1;const s=o.id!=null?String(o.id):"",a=o.reservationId!=null?String(o.reservationId):"",l=o.reservation_code!=null?String(o.reservation_code):"";return s&&n.includes(s)||a&&n.includes(a)||l&&n.includes(l)});if(!t||!Array.isArray(t.items))return e;const i=new Map;t.items.forEach((o,s)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=b(String(o?.barcode??"")).trim(),r=a!=null?`id:${a}`:l?`bc:${l}`:`idx:${s}`;i.set(r,o)});const c=e.items.map((o,s)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=b(String(o?.barcode??"")).trim(),r=[a!=null?`id:${a}`:null,l?`bc:${l}`:null,`idx:${s}`].filter(Boolean);let u=null;for(const g of r)if(i.has(g)){u=i.get(g);break}if(!u)return o;const d={...o},f=Number(u.cost),y=Number(u.price);return Number.isFinite(f)&&f>0&&(d.cost=f,d.unit_cost=f),Number.isFinite(y)&&y>0&&(d.price=y,d.unit_price=y),d});return{...e,items:c}}function Yn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const n=[e.id,e.reservationId,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!n.length)return e;let t=[];for(const o of n)if(t=jn(o),t.length)break;if(!t.length)return e;const i=new Map;t.forEach((o,s)=>{if(!o||typeof o!="object")return;const a=o.equipmentId??o.equipment_id??null,l=b(String(o.barcode??"")).trim(),r=a!=null?`id:${a}`:l?`bc:${l}`:`idx:${s}`;i.set(r,o)});const c=e.items.map((o,s)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=b(String(o?.barcode??"")).trim(),r=[a!=null?`id:${a}`:null,l?`bc:${l}`:null,`idx:${s}`].filter(Boolean);let u=null;for(const h of r)if(i.has(h)){u=i.get(h);break}if(!u)return o;const d={...o},f=J(C(u.cost??u.unit_cost)),y=J(C(u.price??u.unit_price)),g=Number.isFinite(f),_=Number.isFinite(y),N=Number(o.cost),p=Number(o.price);return g&&(!Number.isFinite(N)||N<=0)&&(d.cost=f,d.unit_cost=f),_&&(!Number.isFinite(p)||p<=0)&&(d.price=y,d.unit_price=y),d});return{...e,items:c}}async function Jn(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const n=te.filter(t=>String(t.id)!==String(e));Ee(n),Le(e,null)}async function Xn(e){return ct(e,{status:"confirmed",confirmed:!0})}async function Zn(e,n=null){const t={status:"completed",confirmed:!0};return typeof n=="string"&&(t.notes=n),ct(e,t)}function He(e={}){const n=Ve({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});return Yn(Vt(n))}function Ot(e={}){return Ve(e)}function Ve(e={}){const n=e.id??e.reservation_id??e.reservationId??null,t=e.reservation_code??e.reservationCode??e.reservationId??(n!=null?`RSV-${n}`:null);let i=Array.isArray(e.items)?e.items.map(Oe):[],c=ut(e);const o=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let s=o.map((x,ee)=>ot(x,ee)).filter(Boolean),a=s.map((x,ee)=>{const v=o?.[ee];return{...v&&typeof v=="object"?{...v}:v!=null?{id:v}:{},...x}});const l=s.map(x=>x.technicianId).filter(x=>x!=null&&x!=="").map(x=>Number.isNaN(Number(x))?String(x):Number(x)),r=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=C(e.total_amount??e.totalAmount??e.cost??0);const f=C(e.discount??0),y=e.discount_type??e.discountType??"percent",g=["percent","amount"].includes(y)?y:"percent",_=!!(e.apply_tax??e.applyTax??!1);let N=ri(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),h=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,P=h!=null?Number.parseFloat(b(String(h).replace("%","").trim())):NaN,I=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let S=I!=null?I===!0||I===1||I==="1"||String(I).toLowerCase()==="true":Number.isFinite(P)&&P>0,A=S&&Number.isFinite(P)?Number(P):0;const q=e.company_share_amount??e.companyShareAmount;let L=Number.isFinite(Number(q))?Number(q):NaN;_&&A<=0&&(A=Tt,S=!0);const R=Ce({items:i,technicianIds:l,crewAssignments:s,discount:f,discountType:g,applyTax:_,start:r,end:u,companySharePercent:A>0?A:null});(!Number.isFinite(d)||d<=0||_)&&(d=R.finalTotal),(!Number.isFinite(L)||L<0)&&(L=R.companyShareAmount),L=Number.isFinite(L)?Number(L.toFixed(2)):0,!S&&A>0&&(S=!0);const w=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],m=ti(w),U=st(m),V=n??t??e.reservation_code??e.reservationId??null;if(c.length)Le(V,c);else{const x=Kn(V);x.length&&(c=re(c,x))}if(!c.length&&Array.isArray(i)&&i.length)try{const x=Hn(i);Array.isArray(x)&&x.length&&(c=re(c,x))}catch(x){console.warn("[reservationsService] inference of packages from items failed",x)}const Z=lt(i,c);i=Z.items,c=re(c,Z.packages);const O=nt({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:U});N=it({manualStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,totalAmount:d});const K=N==="paid",Q=si(e.status??(p?"confirmed":"pending"));return{id:n!=null?String(n):"",reservationId:t??(n!=null?String(n):""),reservationCode:t??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:u,status:Q,completed:Q==="completed",confirmed:p,location:e.location??"",notes:e.notes??"",discount:f,discountType:g,applyTax:_,paid:K,paidStatus:N,paidAmount:O.paidAmount,paidPercent:O.paidPercent,paymentProgressType:O.paymentProgressType,paymentProgressValue:O.paymentProgressValue,paymentHistory:U,payment_history:U,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:s,techniciansDetails:a,startDatetime:r,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:c,companySharePercent:A,companyShareAmount:L,companyShareEnabled:S}}function Oe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const n=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,t=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=C(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),c=C(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),o=b(String(e.barcode??e.code??e.serial??"")),s=e.description??e.desc??e.name??e.title??"",a={id:e.id!=null?String(e.id):n!=null?String(n):"",equipmentId:n,barcode:o,desc:s,qty:t,quantity:t,qtyPerPackage:null,totalQuantity:t,price:i,cost:c,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},l=Kt(e.type??e.item_type??e.kind??null),r=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=W(r),d=Be(e,u);if(l==="package"||u||d.length){a.type="package";const f=u||(n!=null?String(n):a.id?W(a.id):"");f&&(a.packageId=f,a.package_id=f,a.package_code=e.package_code??e.packageCode??f),a.name=s||a.package_code||f||"",a.barcode=a.barcode||b(String(e.package_code??e.packageCode??"")),a.packageItems=d;const y=Ut({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,t);(!Number.isFinite(a.price)||a.price<=0||a.price>y*10)&&(a.price=y),a.qtyPerPackage=d.length?d[0]?.qtyPerPackage??a.qtyPerPackage:a.qtyPerPackage,a.totalQuantity=t}return a}function ei({reservationCode:e,customerId:n,start:t,end:i,status:c,title:o,location:s,notes:a,projectId:l,totalAmount:r,discount:u,discountType:d,applyTax:f,paidStatus:y,confirmed:g,items:_,packages:N,crewAssignments:p=[],technicians:h=p,companySharePercent:P,companyShareEnabled:I,paidAmount:S,paidPercentage:A,paymentProgressType:q,paymentProgressValue:L,paymentHistory:R}){const w=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:n,start_datetime:t,end_datetime:i,status:c??"pending",title:o??null,location:s??null,notes:a??null,project_id:l||null,total_amount:r??0,discount:u??0,discount_type:d??"percent",apply_tax:f?1:0,paid_status:y??"unpaid",paid_amount:Number.isFinite(S)?C(S):0,paid_percentage:Number.isFinite(A)?Number(A.toFixed(2)):0,payment_progress_type:q??null,payment_progress_value:Number.isFinite(L)?Number(L.toFixed(2)):null,payment_history:Array.isArray(R)?R.map(m=>({type:Ye(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?C(m.value):null,amount:m?.amount!=null?C(m.amount):m?.payment_amount!=null?C(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],payments:Array.isArray(R)?R.map(m=>({type:Ye(m?.type??m?.payment_type??m?.method??m?.paymentMethod),value:m?.value!=null?C(m.value):null,amount:m?.amount!=null?C(m.amount):m?.payment_amount!=null?C(m.payment_amount):null,percentage:m?.percentage!=null?Number(m.percentage):m?.payment_percentage!=null?Number(m.payment_percentage):null,note:m?.note??m?.notes??m?.comment??m?.payment_note??null,recorded_at:m?.recordedAt??m?.recorded_at??m?.createdAt??m?.created_at??m?.payment_date??m?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:ni(_),packages:ii(_,N),company_share_percent:I&&Number.isFinite(P)?Number(P):null,company_share_enabled:I?1:0,technicians:w.length?w.map((m,U)=>{const V=m.technicianId??m.technician_id??m.id??null,Z=m.positionId??m.position_id??m.position??m.position_code??null,O=m.positionLabel??m.position_name??m.role??null,K=C(m.positionCost??m.position_cost??m.cost??m.daily_wage??m.dailyWage??0),Q=C(m.positionClientPrice??m.position_client_price??m.client_price??m.clientPrice??m.daily_total??m.dailyTotal??m.total??0);return{id:V,technician_id:V,role:O??m.technicianRole??null,notes:m.notes??null,position_id:Z,position_key:m.positionKey??m.position_key??null,position_name:O,position_label_ar:m.positionLabelAr??m.position_label_ar??null,position_label_en:m.positionLabelEn??m.position_label_en??null,position_cost:K,position_client_price:Q,client_price:Q,cost:K,assignment_id:m.assignmentId??m.assignment_id??`crew-${U}`}}):Array.isArray(h)?h.map(m=>typeof m=="object"&&m!==null?{id:m.id??m.technician_id??m.technicianId??m.ID,role:m.role??null,notes:m.notes??null}:Number.isNaN(Number(m))?String(m):Number(m)):[]}}function st(e){const n=rt(e);return!Array.isArray(n)||n.length===0?[]:n.map(t=>{if(!t||typeof t!="object")return null;const i=t.type??t.payment_type??t.paymentType??t.method??t.paymentMethod??t.kind??null,c=Ye(i),o=t.value??t.payment_value??t.paymentValue??t.amount??t.payment_amount??t.percentage??t.payment_percentage??null,s=o!=null?Number.parseFloat(b(String(o))):null,a=t.amount!=null?Number.parseFloat(b(String(t.amount))):t.payment_amount!=null?Number.parseFloat(b(String(t.payment_amount))):null,l=t.percentage!=null?Number.parseFloat(b(String(t.percentage))):t.payment_percentage!=null?Number.parseFloat(b(String(t.payment_percentage))):null,r=Number.isFinite(a)?a:c==="amount"&&Number.isFinite(s)?s:null,u=Number.isFinite(l)?l:c==="percent"&&Number.isFinite(s)?s:null,d=c??(r!=null?"amount":u!=null?"percent":null),f=d==="amount"?r:d==="percent"?u:Number.isFinite(s)?s:null,y=t.note??t.notes??t.comment??t.payment_note??null,g=t.recordedAt??t.recorded_at??t.payment_date??t.date??t.createdAt??t.created_at??null;return{type:d,value:f,amount:r,percentage:u,note:y,recordedAt:g}}).filter(t=>t&&t.type)}function Ye(e){if(!e)return null;const n=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(n)?"amount":["percent","percentage","ratio"].includes(n)?"percent":null}function rt(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const n=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const s of n)if(Array.isArray(e[s]))return e[s];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(s=>Array.isArray(s));if(Array.isArray(i))return i;const c=Object.values(e);if(c.length&&c.every(s=>s&&typeof s=="object")){const s=c.map(a=>a);if(s.every(a=>!Array.isArray(a)))return s}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(s=>s in e))return[e]}if(typeof e=="string")try{const n=JSON.parse(e);return rt(n)}catch{return[]}return[]}function ti(e=[]){if(!Array.isArray(e))return[];for(const n of e){const t=rt(n);if(Array.isArray(t)&&t.length)return t}return[]}function ni(e){if(!Array.isArray(e)||e.length===0)return[];const n=[];return e.forEach(t=>{if(!t||typeof t!="object")return;if(t.type==="package"&&Array.isArray(t.packageItems)&&t.packageItems.length){const o=M(t.qty??t.quantity??1);t.packageItems.forEach(s=>{const a=s?.equipmentId??s?.equipment_id??s?.id??null;if(a==null)return;const l=M(s?.qty??s?.quantity??1),r=o*l,u=C(s?.cost??s?.unit_cost??s?.rental_cost??s?.internal_cost??s?.purchase_price??s?.equipment_cost??0);n.push({equipment_id:Je(a),quantity:r,unit_price:C(s?.price??s?.unit_price??0),unit_cost:u,cost:u,total_cost:Number.isFinite(u)?Number((u*r).toFixed(2)):0,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u,notes:s?.notes??null})});return}const i=t.equipmentId??t.equipment_id??t.id??null;if(i==null)return;const c=(()=>{const o=C(t.cost??t.unit_cost??t.rental_cost??t.internal_cost??t.purchase_price??t.equipment_cost??0);if(Number.isFinite(o)&&o>0)return o;if(packageItems.length){const s=packageItems.reduce((a,l)=>{const r=C(l.cost??l.unit_cost??l.unitCost??l.rental_cost??l.internal_cost??l.purchase_price??l.equipment_cost??l.item_cost??0),u=M(l.qty??l.quantity??l.qtyPerPackage??l.unit_qty??1);return a+r*u},0);if(s>0)return Number(s.toFixed(2))}return o})();n.push({equipment_id:Je(i),quantity:M(t.qty??t.quantity??1),unit_price:C(t.price??t.unit_price??0),unit_cost:c,cost:c,total_cost:Number.isFinite(c)?Number((c*M(t.qty??t.quantity??1)).toFixed(2)):0,rental_cost:c,purchase_price:c,internal_cost:c,equipment_cost:c,item_cost:c,notes:t.notes??null})}),n}function Je(e){const n=Number(e);return Number.isFinite(n)&&n>=0?n:String(e)}function ii(e,n){const t=Array.isArray(n)?n.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const c=M(i.qty??i.quantity??1),o=Array.isArray(i.packageItems)?i.packageItems.map(a=>{const l=a?.equipmentId??a?.equipment_id??a?.id??null;if(l==null)return null;const r=C(a?.cost??a?.unit_cost??a?.rental_cost??a?.internal_cost??a?.purchase_price??a?.equipment_cost??0);return{equipment_id:Je(l),quantity:M(a?.qty??a?.quantity??a?.count??a?.units??a?.unit_qty??a?.unitQty??a?.unit_count??a?.unitCount??a?.package_quantity??a?.packageQty??1),unit_price:C(a?.price??a?.unit_price??0),unit_cost:r,cost:r,rental_cost:r,purchase_price:r,internal_cost:r,equipment_cost:r,item_cost:r}}).filter(Boolean):[],s=C(i.cost??i.unit_cost??i.rental_cost??i.internal_cost??i.purchase_price??i.equipment_cost??0);t.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:c,unit_price:C(i.price??i.unit_price??0),unit_cost:s,cost:s,total_cost:Number.isFinite(s)?Number((s*c).toFixed(2)):0,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,items:o})}),t}function Kt(e){if(e==null)return"";const n=String(e).trim().toLowerCase();return n==="package"||n==="bundle"||n==="pack"?"package":n}function W(e){if(e==null)return"";const n=String(e).replace(/^package::/i,"");return fe(n)}function Xe(e){return e==null?"":b(String(e)).trim().toLowerCase()}function Qt(e={},n=1){if(!e||typeof e!="object"){const r=b(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:r,normalizedBarcode:Xe(r),desc:"",image:null}}const t=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),c=C(e.unit_price??e.unitPrice??e.price??0),o=C(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),s=b(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),a=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let l;if(a!=null)l=M(a,{fallback:1,max:99});else if(n>0){const r=i/n;Number.isFinite(r)&&r>0&&Number.isInteger(r)?l=M(r,{fallback:1,max:99}):l=Math.min(i,99)}else l=Math.min(i,99);return{equipmentId:t!=null?String(t):null,equipment_id:t,qty:l,quantity:l,qtyPerPackage:l,totalQuantity:i,price:c,unit_price:c,cost:o,unit_cost:o,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,barcode:s,normalizedBarcode:Xe(e.normalizedBarcode??s),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function ai(e={},n={}){const t=W(e.packageId??e.package_id??e.id??n.packageId??n.package_id??n.id??""),i=M(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),c=C(e.unit_price??e.unitPrice??e.price??n.price??n.unit_price??n.unitPrice??0);let o=C(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??n.unit_cost??n.unitCost??n.cost??0);if((!Number.isFinite(o)||o===0)&&Array.isArray(e.packageItems)&&e.packageItems.length){const a=e.packageItems.reduce((l,r)=>{const u=C(r.cost??r.unit_cost??r.unitCost??r.rental_cost??r.purchase_price??r.internal_cost??r.equipment_cost??r.item_cost??0),d=M(r.qty??r.quantity??r.qtyPerPackage??1);return l+u*d},0);a>0&&(o=Number(a.toFixed(2)))}const s=b(String(e.package_code??e.packageCode??e.barcode??n.package_code??n.packageCode??n.barcode??""));return{id:n.id??(e.id!=null?String(e.id):t?`package::${t}`:""),equipmentId:null,barcode:s,desc:n.desc??n.description??e.name??e.desc??e.title??s,qty:i,quantity:i,price:c,cost:o,unit_cost:o,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,notes:n.notes??null,image:e.image??n.image??null,type:"package",packageId:t,package_id:t,package_code:s,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(n.packageItems)?n.packageItems:[]}}function lt(e=[],n=[]){const t=oi(e),i=Array.isArray(n)?re(n,t.packages):t.packages,c=new Map;return i.forEach(o=>{const s=W(o.packageId??o.package_id??o.id);s&&c.set(s,o)}),t.packages.forEach(o=>{const s=W(o.packageId??o.package_id??o.id);if(!s)return;const a=c.get(s);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=o.packageItems),!a.name&&o.name&&(a.name=o.name),!a.image&&o.image&&(a.image=o.image))}),{items:t.items,packages:Array.from(c.values())}}function oi(e=[]){const n=new Map;if(e.forEach(o=>{const s=W(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(!s)return;const a=s;n.has(a)||n.set(a,{base:o,items:[]}),n.get(a).items.push(o)}),!n.size)return{items:e,packages:[]};const t=[],i=[],c=new Set;return e.forEach(o=>{const s=W(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(s&&n.has(s)){if(c.has(s))return;const a=n.get(s),l=a.base||o,r=a.items.map(f=>Qt(f,1)),u=(()=>{const f=C(l.unit_cost??l.unitCost??l.cost??l.rental_cost??l.internal_cost??l.purchase_price??l.equipment_cost??l.item_cost??0);if(Number.isFinite(f)&&f>0)return f;if(r.length){const y=r.reduce((g,_)=>{const N=C(_.cost??_.unit_cost??_.unitCost??_.rental_cost??_.internal_cost??_.purchase_price??_.equipment_cost??_.item_cost??0),p=M(_.qty??_.quantity??_.qtyPerPackage??1);return g+N*p},0);if(y>0)return Number(y.toFixed(2))}return f})(),d={packageId:s,package_id:s,package_code:l.package_code??l.packageCode??l.barcode??b(String(s)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${s}`,quantity:M(l.package_quantity??l.packageQty??1,{fallback:1,max:9999}),unit_price:C(l.package_price??l.packagePrice??l.price??0),unit_cost:u,unitCost:u,cost:u,rental_cost:u,purchase_price:u,internal_cost:u,equipment_cost:u,item_cost:u,packageItems:r,image:l.image??null};i.push(d),t.push(ai(d,l)),c.add(s);return}t.push(o)}),{items:t,packages:i}}function Be(e={},n=""){if(!e||typeof e!="object")return[];const t=W(n||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let c=Pe({...e,id:e.id??t??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??t,items:i,packageItems:i}),o=[];if((!Array.isArray(c)||c.length===0)&&t){const r=_e(t);r&&(c=Pe(r),o=Array.isArray(c)?c:[])}else if(t){const r=_e(t);r&&(o=Pe(r)||[])}if(!Array.isArray(c)||c.length===0)return[];const s=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=c.map(r=>Qt(r,s));if(o.length){const r=new Map;o.forEach(u=>{if(!u)return;const d=Xe(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&r.set(d,u)}),a.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!r.has(d))return;const f=r.get(d),y=M(f.quantity??f.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=y,u.qty=y,u.quantity=y;const g=C(f.unit_price??f.unitPrice??f.price??u.price);u.price=g,u.unit_price=g,!u.desc&&f.desc&&(u.desc=f.desc),!u.image&&f.image&&(u.image=f.image)})}const l=new Map;return a.forEach(r=>{const u=r.normalizedBarcode||(r.equipmentId?`id:${r.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=r.qty,d.quantity+=r.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=r.qtyPerPackage),(!d.price||d.price===0)&&r.price&&(d.price=r.price,d.unit_price=r.unit_price),!d.desc&&r.desc&&(d.desc=r.desc),!d.image&&r.image&&(d.image=r.image);return}l.set(u,{...r})}}),Array.from(l.values())}function Ut(e={},n=[],t=1){try{const o=W(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(o){const s=_e(o);if(s){const a=Ct(s);if(Number.isFinite(Number(a))&&Number(a)>0)return Number(a)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return C(i);const c=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(c))){const o=C(c);return t>0?Number((o/t).toFixed(2)):o}return 0}function Gt(e,n){if(!e)return n;if(!n)return e;const t={...e},i=s=>{(t[s]===void 0||t[s]===null||t[s]==="")&&(t[s]=n[s])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(t.unit_price))||t.unit_price===0)&&Number.isFinite(Number(n.unit_price))&&(t.unit_price=n.unit_price,t.unitPrice=n.unitPrice,t.price=n.price);const c=C(t.unit_cost??t.unitCost??t.cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost),o=C(n.unit_cost??n.unitCost??n.cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost);if((!Number.isFinite(c)||c===0)&&Number.isFinite(o)){const s=o;t.unit_cost=s,t.unitCost=s,t.cost=s,t.total_cost=Number.isFinite(n.total_cost)?n.total_cost:t.total_cost,Number.isFinite(t.rental_cost)||(t.rental_cost=s),Number.isFinite(t.purchase_price)||(t.purchase_price=s),Number.isFinite(t.internal_cost)||(t.internal_cost=s),Number.isFinite(t.equipment_cost)||(t.equipment_cost=s),Number.isFinite(t.item_cost)||(t.item_cost=s)}return(!Number.isFinite(Number(t.total_price))||t.total_price===0)&&Number.isFinite(Number(n.total_price))&&(t.total_price=n.total_price,t.total=n.total),!Array.isArray(t.packageItems)||t.packageItems.length===0?(t.packageItems=Array.isArray(n.packageItems)?n.packageItems:[],t.items=t.packageItems):Array.isArray(n.packageItems)&&n.packageItems.length&&(t.packageItems=ci(t.packageItems,n.packageItems),t.items=t.packageItems),t}function ci(e=[],n=[]){const t=new Map,i=c=>{c.forEach(o=>{if(!o)return;const s=o.normalizedBarcode||(o.equipmentId?`id:${o.equipmentId}`:null);if(s){if(t.has(s)){const a=t.get(s);a.qty+=o.qty??0,a.quantity+=o.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(o.qtyPerPackage)&&(a.qtyPerPackage=o.qtyPerPackage),(!a.price||a.price===0)&&o.price&&(a.price=o.price,a.unit_price=o.unit_price);const l=C(a.cost??a.unit_cost??a.unitCost??a.rental_cost??a.purchase_price??a.internal_cost??a.equipment_cost??a.item_cost),r=C(o.cost??o.unit_cost??o.unitCost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);if((!Number.isFinite(l)||l===0)&&Number.isFinite(r)){const u=r;a.cost=u,a.unit_cost=u,a.unitCost=u,Number.isFinite(a.rental_cost)||(a.rental_cost=u),Number.isFinite(a.purchase_price)||(a.purchase_price=u),Number.isFinite(a.internal_cost)||(a.internal_cost=u),Number.isFinite(a.equipment_cost)||(a.equipment_cost=u),Number.isFinite(a.item_cost)||(a.item_cost=u)}!a.desc&&o.desc&&(a.desc=o.desc),!a.image&&o.image&&(a.image=o.image);return}t.set(s,{...o})}})};return i(e),i(n),Array.from(t.values())}function re(e=[],n=[]){const t=[],i=new Map,c=et(),o=new Map;c.forEach(l=>{const r=W(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&o.set(u,r||u)});const s=l=>{const r=W(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?b(u):"";return r||(d&&o.has(d)?o.get(d):d||null)},a=l=>{Array.isArray(l)&&l.forEach(r=>{if(!r||typeof r!="object")return;const u=s(r);if(u)if(i.has(u)){const d=i.get(u);t[d]=Gt(t[d],r)}else i.set(u,t.length),t.push({...r})})};return a(e),a(n),t}function Wt(e,n=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const g=W(e),_=g?_e(g):null,N=_?Be(_,g):[],p=_?C(_.price??_.unit_price??_.unitPrice??0):0,P=(()=>{const q=_?.unit_cost??_?.unitCost??_?.cost??_?.rental_cost??_?.internal_cost??_?.purchase_price??_?.equipment_cost??_?.item_cost;if(Number.isFinite(Number(q)))return C(q);if(Array.isArray(N)&&N.length){const L=N.reduce((R,w)=>{const m=C(w.cost??w.unit_cost??w.unitCost??w.rental_cost??w.internal_cost??w.purchase_price??w.equipment_cost??w.item_cost??0),U=M(w.qty??w.quantity??w.qtyPerPackage??1);return R+m*U},0);if(L>0)return Number(L.toFixed(2))}return 0})(),I=1,S=Number((p*I).toFixed(2)),A=Number((P*I).toFixed(2));return{id:`package::${g||n}`,packageId:g||`pkg-${n}`,package_id:g||`pkg-${n}`,package_code:b(String(e))||g||`pkg-${n}`,name:_?.name??_?.package_name??_?.packageName??b(String(e))??"",desc:_?.name??b(String(e))??"",quantity:I,qty:I,unit_price:p,unitPrice:p,price:p,unit_cost:P,unitCost:P,cost:P,total_cost:A,rental_cost:P,purchase_price:P,internal_cost:P,equipment_cost:P,item_cost:P,total:S,total_price:S,barcode:b(String(e)),packageItems:N,items:N,type:"package",image:_?.image??null}}if(typeof e!="object")return null;const t=W(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${n}`,i=M(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),c=Be(e,t),o=Ut(e,c,i),a=(()=>{const g=e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost;if(Number.isFinite(Number(g)))return C(g);if(Array.isArray(c)&&c.length){const _=c.reduce((N,p)=>{const h=C(p.cost??p.unit_cost??p.unitCost??p.rental_cost??p.internal_cost??p.purchase_price??p.equipment_cost??p.item_cost??0),P=M(p.qtyPerPackage??p.qty??p.quantity??p.count??1);return N+h*P},0);if(_>0)return Number(_.toFixed(2))}return 0})(),l=e.total_price??e.totalPrice??e.total??o*i,r=Number.isFinite(Number(l))?C(l):Number((o*i).toFixed(2)),u=Number.isFinite(a)?Number((a*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??t,f=b(String(e.barcode??d??"")),y=e.image??e.cover??e.thumbnail??c.find(g=>g.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,packageId:t,package_id:t,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??t,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??t,quantity:i,qty:i,unit_price:o,unitPrice:o,price:o,unit_cost:a,unitCost:a,cost:a,total_cost:u,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,total:r,total_price:r,barcode:f,packageItems:c,items:c,type:"package",image:y}}function ut(e={}){const n=[];Array.isArray(e.packages)&&n.push(e.packages),Array.isArray(e.reservation_packages)&&n.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&n.push(e.reservationPackages),Array.isArray(e.package_details)&&n.push(e.package_details),Array.isArray(e.packageDetails)&&n.push(e.packageDetails),Array.isArray(e.package_list)&&n.push(e.package_list),Array.isArray(e.packageList)&&n.push(e.packageList);const t=[],i=new Map,c=(a,l=t.length)=>{const r=Wt(a,l);if(!r)return;const u=r.packageId||r.package_code||r.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);t[d]=Gt(t[d],r)}else i.set(u,t.length),t.push(r)};n.forEach(a=>{a.forEach((l,r)=>{c(l,r+t.length)})}),t.length===0&&e.package&&c(e.package,0);const o=Array.isArray(e.items)?e.items:[],s=(a={})=>!a||typeof a!="object"?!1:!!(Kt(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(r=>typeof r=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return o.forEach((a,l)=>{s(a)&&c(a,t.length+l)}),t}function C(e){const n=D(e);return Number.isFinite(n)?Number(n.toFixed(2)):0}function M(e,{fallback:n=1,max:t=1e6}={}){const i=D(e);if(!Number.isFinite(i))return n;const c=Math.round(i);return c<=0||c>t?n:c}function si(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function ri(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function li(e){return e instanceof Zt}const Pi=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:ei,closeReservationApi:Zn,confirmReservationApi:Xn,createReservationApi:Gn,deleteReservationApi:Jn,getCachedReservationCrew:On,getReservationsState:Qn,isApiError:li,mapLegacyReservation:Ot,mapReservationFromApi:He,mapReservationItem:Oe,refreshReservationsFromApi:Un,setReservationsState:Ee,toInternalReservation:Ve,updateReservationApi:ct},Symbol.toStringTag,{value:"Module"}));export{Ve as A,xn as B,vn as C,Tt as D,D as E,$ as F,On as G,fi as H,hn as I,gi as J,Ot as K,In as L,Xn as M,Zn as N,Pi as O,bi as a,$n as b,nt as c,Ce as d,it as e,Jn as f,Qn as g,Ni as h,pi as i,yi as j,yn as k,wn as l,He as m,Et as n,An as o,qn as p,Pn as q,Un as r,mi as s,ei as t,ct as u,Gn as v,li as w,_i as x,mt as y,hi as z};
