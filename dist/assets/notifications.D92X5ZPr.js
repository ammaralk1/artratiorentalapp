import{r as v,a as $,c as _,g as E,j as r,t as c,b as p}from"./auth.CeMPBUkN.js";import{i as L}from"./dashboardShell.DF2kUed9.js";v({ar:{notifications:{title:"إدارة التنبيهات",header:"🔔 إدارة التنبيهات",subtitle:"أرسل تنبيهات للفريق بخصوص الحجوزات/المشاريع، وحدد القنوات والمستلمين.",form:{entityType:"النوع",entity:{reservation:"حجز",project:"مشروع"},search:"بحث","search.placeholder":"ابحث بالكود أو العنوان"},table:{headers:{code:"الكود",title:"العنوان",when:"الوقت",customer:"العميل",actions:"الإجراءات"},loading:"⏳ اكتب للبحث…",select:"اختيار"},channels:{email:"إيميل",whatsapp:"واتساب"},compose:{title:"✉️ إنشاء رسالة",recipients:"المستلمون",toTechnicians:"الفنيون المعيّنون",toAdmins:"الإدمن",subject:"الموضوع",body:"نص الرسالة",templates:{reminder:"📌 تذكير",note:"📝 ملاحظة إدارية"},send:"🚀 إرسال",sentOk:"تم إرسال الرسالة بنجاح"},logs:{title:"📜 سجل التنبيهات",subtitle:"تابع آخر عمليات الإرسال وحالة كل رسالة.",refresh:"🔄 تحديث",filters:{allEntities:"كل الأنواع",allChannels:"كل القنوات",allStatuses:"كل الحالات",sent:"مرسلة",failed:"فاشلة","q.placeholder":"بحث بالبريد/الرقم"},headers:{time:"الوقت",event:"الحدث",entity:"النوع/المعرف",recipient:"المستلم",channel:"القناة",status:"الحالة",error:"الخطأ"},empty:"لا توجد سجلات حالياً.",loading:"⏳ جارٍ التحميل…"}}}});$();L();const t={};let h=null,u=null;function a(n){return document.querySelector(n)}function T(){t.entityType=a("#notif-entity-type"),t.search=a("#notif-search"),t.resultsBody=a("#notif-results-body"),t.composeSection=a("#notif-compose-section"),t.selectedSummary=a("#notif-selected-summary"),t.chEmail=a("#notif-channel-email"),t.chWhatsapp=a("#notif-channel-whatsapp"),t.toTechs=a("#notif-to-techs"),t.toAdmins=a("#notif-to-admins"),t.extraEmails=a("#notif-extra-emails"),t.extraPhones=a("#notif-extra-phones"),t.subject=a("#notif-subject"),t.body=a("#notif-body"),t.sendBtn=a("#notif-send-btn"),t.tReminder=a("#notif-template-reminder"),t.tNote=a("#notif-template-note"),t.logEntity=a("#log-filter-entity"),t.logChannel=a("#log-filter-channel"),t.logStatus=a("#log-filter-status"),t.logQ=a("#log-filter-q"),t.logRefresh=a("#log-refresh-btn"),t.logBody=a("#notif-logs-body")}function y(n,e){const s=n.start_datetime||n.startDate||"",o=n.end_datetime||n.endDate||"";return s&&o&&s!==o?`${s} — ${o}`:s||o||""}function x(n,e){if(!Array.isArray(n)||n.length===0){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${c("notifications.table.loading","لا نتائج")}</td></tr>`;return}t.resultsBody.innerHTML=n.map(s=>{const o=e==="reservation"?s.reservation_code||"":s.project_code||"",i=s.title||"",l=y(s),d=e==="reservation"?s.customer_name||"":s.client_name||"";return`
      <tr>
        <td>${o||"—"}</td>
        <td>${i||"—"}</td>
        <td>${l||"—"}</td>
        <td>${d||"—"}</td>
        <td><button type="button" class="btn btn-sm btn-primary" data-select-id="${s.id}" data-select-type="${e}">${c("notifications.table.select","اختيار")}</button></td>
      </tr>
    `}).join("")}async function g(){const n=t.entityType.value,e=(t.search.value||"").trim();if(e===""){t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${c("notifications.table.loading","اكتب للبحث…")}</td></tr>`;return}try{const o=await p(`${n==="reservation"?"/reservations/":"/projects/"}?search=${encodeURIComponent(e)}&limit=10`);x(o?.data??[],n)}catch(s){console.error(s),t.resultsBody.innerHTML='<tr><td colspan="5" class="text-center text-error">فشل البحث</td></tr>'}}function S(){u&&clearTimeout(u),u=setTimeout(g,350)}function B(n,e){const s=n==="reservation"?e.reservation_code||"":e.project_code||"",o=e.title||s||n,i=y(e),l=e.location||"",d=n==="reservation"?e.customer_name||"":e.client_name||"";return[s?`الكود: ${s}`:"",`العنوان: ${o}`,i?`الوقت: ${i}`:"",l?`الموقع: ${l}`:"",d?`العميل: ${d}`:""].filter(Boolean).join(" | ")}async function j(n,e){try{const i=(await p(`${e==="reservation"?"/reservations/":"/projects/"}?id=${encodeURIComponent(n)}`))?.data;if(!i)throw new Error("Not found");h={type:e,id:Number(i.id),summary:B(e,i)},t.selectedSummary.textContent=h.summary,t.composeSection.hidden=!1}catch(s){console.error(s),r("⚠️ تعذر تحميل العنصر المحدد")}}async function k(){if(!h){r("اختر عنصراً أولاً");return}const n={email:!!t.chEmail.checked,whatsapp:!!t.chWhatsapp.checked};if(!n.email&&!n.whatsapp){r("اختر قناة إرسال واحدة على الأقل");return}const e={technicians:!!t.toTechs.checked,admins:!!t.toAdmins.checked,additional_emails:(t.extraEmails.value||"").split(",").map(o=>o.trim()).filter(Boolean),additional_phones:(t.extraPhones.value||"").split(",").map(o=>o.trim()).filter(Boolean)},s={subject:(t.subject.value||"تنبيه إداري").trim(),text:(t.body.value||"").trim()};if(!s.text){r("اكتب نص الرسالة");return}try{const o=await p("/notifications/send.php",{method:"POST",body:{entity_type:h.type,entity_id:h.id,channels:n,recipients:e,message:s}});r(c("notifications.compose.sentOk","تم إرسال الرسالة بنجاح"))}catch(o){console.error(o),r("فشل الإرسال")}}function A(){t.search.addEventListener("input",S),t.entityType.addEventListener("change",()=>{t.resultsBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${c("notifications.table.loading","اكتب للبحث…")}</td></tr>`,t.search.value&&g()}),t.resultsBody.addEventListener("click",e=>{const s=e.target.closest("[data-select-id]");s&&j(s.getAttribute("data-select-id"),s.getAttribute("data-select-type"))}),t.tReminder.addEventListener("click",()=>{const e=`تذكير بالحجز/المشروع:
يرجى الاطلاع واتخاذ اللازم.`;t.body.value=e}),t.tNote.addEventListener("click",()=>{const e=`ملاحظة إدارية:
يرجى متابعة الإجراء المطلوب.`;t.body.value=e}),t.sendBtn.addEventListener("click",k);const n=()=>{m()};["change","input"].forEach(e=>{t.logEntity.addEventListener(e,n),t.logChannel.addEventListener(e,n),t.logStatus.addEventListener(e,n),t.logQ.addEventListener(e,()=>{u&&clearTimeout(u),u=setTimeout(m,350)})}),t.logRefresh.addEventListener("click",m)}function M(n){return{reservation_created:"إنشاء حجز",reservation_reminder_24h:"تذكير 24 ساعة",reservation_reminder_1h:"تذكير ساعة",reservation_technician_assigned:"تعيين فني (حجز)",reservation_status_changed:"تغيير حالة حجز",project_created:"إنشاء مشروع",project_technician_assigned:"تعيين فني (مشروع)",manual_notification:"إرسال يدوي"}[n]||n}function C(n){if(!Array.isArray(n)||n.length===0){t.logBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted">${c("notifications.logs.empty","لا توجد سجلات حالياً.")}</td></tr>`;return}t.logBody.innerHTML=n.map(e=>{const s=e.created_at||"—",o=M(e.event_type||""),i=`${e.entity_type||""} #${e.entity_id||""}`,l=`${e.recipient_type||""}: ${e.recipient_identifier||""}`,d=e.channel||"",b=e.status||"",f=(e.error||"").toString().slice(0,140);return`
      <tr>
        <td>${s}</td>
        <td>${o}</td>
        <td>${i}</td>
        <td>${l}</td>
        <td>${d}</td>
        <td>${b==="sent"?'<span class="badge bg-primary-subtle">مرسلة</span>':'<span class="badge bg-danger-subtle">فاشلة</span>'}</td>
        <td title="${f}">${f}</td>
      </tr>
    `}).join("")}async function m(){try{t.logBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted">${c("notifications.logs.loading","⏳ جارٍ التحميل…")}</td></tr>`;const n=new URLSearchParams;t.logEntity.value&&n.set("entity_type",t.logEntity.value),t.logChannel.value&&n.set("channel",t.logChannel.value),t.logStatus.value&&n.set("status",t.logStatus.value),(t.logQ.value||"").trim()&&n.set("q",t.logQ.value.trim()),n.set("limit","50");const e=await p(`/notifications/logs.php?${n.toString()}`);C(e?.data??[])}catch(n){console.error(n),t.logBody.innerHTML='<tr><td colspan="7" class="text-center text-error">فشل تحميل السجل</td></tr>'}}(async function(){await _();const e=await E();if(!e||e.role!=="admin"){r("هذه الصفحة للمسؤولين فقط"),window.location.href="home.html";return}T(),A(),m()})();
