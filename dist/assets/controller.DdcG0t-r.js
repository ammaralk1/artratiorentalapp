import{d as Se,n as I,t as c,j as P,z as Or,v as it,b as zr,h as Vr,B as is,w as Kr,x as Ur,u as Qr}from"./auth.jaInK7-y.js";import{g as dt,r as Nt,f as na,a as Gr,i as os,b as Ta}from"./details.PyLODzTX.js";import{o as cs,p as Na,n as Qe,q as aa,D as vt,s as qt,t as Jt,e as sa,c as ra,d as ia,v as ls,w as Wr,x as ds,y as Jr,i as us,a as Lt,z as St,A as $t,b as oa,f as ms,h as Bt,g as vn,r as ps,B as Nn,C as Ln,E as Xr,F as Yr,G as Zr,u as ei,H as ti,l as ni}from"./reservationsService.DicslPc5.js";import{h as ca,i as fs,j as ai,k as at,n as re,l as Qt,o as ys,p as la,q as ot,u as Sn,v as rn,w as si,x as bs,s as jt,y as hs,z as wt,A as gs,B as ri,b as da,C as ua,D as ii,E as oi,F as vs,G as ci,H as li,I as La,J as Ba,K as Ss,L as ws}from"./state.COpo9is6.js";import{s as ma,E as Es,a as di,c as ui,b as mi,r as pi}from"./equipment.Cu3x-Yxa.js";import{c as fi,g as yi}from"./constants.BoeVnxZu.js";import{q as bi}from"./quotePdf.C2lQPEPC.js";import{s as qs,a as Is,e as As,p as hi}from"./canvasColorUtils.CviLtv6S.js";import{d as gi,c as vi}from"./reservationsActions.BMkZbDAH.js";import{ensureProjectsLoaded as Si}from"./projectsService.BEq88fko.js";import{s as wi}from"./uiBridge.Dv6JMAlF.js";const Ei="__DEBUG_CREW__";function qi(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Ei);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function Da(e,t){if(qi())try{console.log(`🪵 [crew-debug:create] ${e}`,t)}catch{}}const ks="projects:create:draft",Ps="projects.html#projects-section";let Bn=null,xs=[],Dn=new Map,Fn=new Map,on=new Map,jn=!1,Zt=null,Fa=!1,$s=[];function Ii(e){if(!e)return null;let t=$s.find(a=>a.id===e)||null;if(t)return t;const n=ua(e);return n?(t={id:e,name:oi(n)||e,price:ii(n),items:da(n),raw:n},t):null}function cn(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ln(e){return I(String(e||"")).trim().toLowerCase()}function Ai(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=I(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function js(e){const t=I(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Cs(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function _s(e){if(!e)return null;const t=I(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Ts(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=I(String(t))}}function Et(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","⚠️ هذه المعدة قيد الصيانة ولا يمكن إضافتها حالياً");case"reserved":return c("reservations.toast.equipmentReserved","⚠️ هذه المعدة محجوزة حالياً ولا يمكن إضافتها");case"retired":return c("reservations.toast.equipmentRetired","⚠️ هذه المعدة خارج الخدمة حالياً");default:return c("reservations.toast.equipmentUnavailable","⚠️ هذه المعدة غير متاحة حالياً")}}function pa(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function It(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function Ue(){const{input:e,hidden:t}=It();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function ht(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const r=document.querySelector(`label[for="${e.id}"]`);r&&n.add(r)}const s=r=>{t()&&P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error")};n.forEach(r=>{!r||r.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{r.addEventListener(i,s,{capture:!0})}),r.dataset.linkedGuardAttached="true")})}function Ns(e,t,{allowPartial:n=!1}={}){const a=Qe(t);if(!a)return null;const s=e.get(a);if(s)return s;if(!n)return null;const r=[];return e.forEach((i,o)=>{o.includes(a)&&r.push(i)}),r.length===1?r[0]:null}function Rn(e,t={}){return Ns(Dn,e,t)}function Mn(e,t={}){return Ns(Fn,e,t)}function Ge(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Ls(e){xs=Array.isArray(e)?[...e]:[]}function fa(){return xs}function ya(e){return e&&fa().find(t=>String(t.id)===String(e))||null}function Ra(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","مشروع بدون اسم")}function Ct(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??vt,a=I(String(n).replace("%","").trim()),s=parseFloat(a);return Number.isFinite(s)?s:vt}function Ye(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??vt,a=I(String(n).replace("%","").trim()),s=parseFloat(a);(!Number.isFinite(s)||s<=0)&&(s=vt),t.dataset.companyShare=String(s),t.checked=!0}function Hn(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(jn){ye();return}jn=!0;const a=()=>{jn=!1,ye()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(vt)),t.disabled){n.checked=!1,P(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة")),a();return}t.checked||(t.checked=!0),Ye()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Ye():n.checked&&(n.checked=!1));a()}function ki(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function Ma(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const s=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${s}`}return""}function Ha(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function st({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:s}=pa();if(!n||!a||!s)return;const r=ca()||[],i=c("reservations.create.placeholders.client","اختر عميلًا (اختياري)"),o=c("customers.fallback.unnamed","عميل بدون اسم");n.setAttribute("placeholder",i);const d=new Set;Dn=new Map;const u=r.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:Ha(m)||o})).filter(m=>{if(!m.label)return!1;const f=Qe(m.label);return!f||d.has(f)?!1:(d.add(f),Dn.set(f,m),!0)}).sort((m,f)=>m.label.localeCompare(f.label,void 0,{sensitivity:"base"}));s.innerHTML=u.map(m=>`<option value="${cn(m.label)}"></option>`).join("");const l=t?"":n.value,y=e?String(e):a.value?String(a.value):"",p=y?r.find(m=>String(m.id)===y):null;if(p){const m=Ha(p)||o;a.value=String(p.id),n.value=m,n.dataset.selectedId=String(p.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":l}function _t({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:s,list:r}=It();if(!a||!s||!r)return;const i=Array.isArray(t)?t:fa()||[],o=c("reservations.create.placeholders.project","اختر مشروعاً (اختياري)");a.setAttribute("placeholder",o);const d=[...i].filter(h=>h&&h.id!=null).sort((h,v)=>String(v.createdAt||v.start||"").localeCompare(String(h.createdAt||h.start||""))),u=n?"":a.value,l=c("projects.fallback.untitled","مشروع بدون اسم"),y=new Set;Fn=new Map;const p=d.map(h=>{const v=Ra(h)||l;return{id:String(h.id),label:v}}).filter(h=>{if(!h.label)return!1;const v=Qe(h.label);return!v||y.has(v)?!1:(y.add(v),Fn.set(v,h),!0)});r.innerHTML=p.map(h=>`<option value="${cn(h.label)}"></option>`).join("");const m=e?String(e):s.value?String(s.value):"",f=m?d.find(h=>String(h.id)===m):null;if(f){const h=Ra(f)||l;s.value=String(f.id),a.value=h,a.dataset.selectedId=String(f.id)}else s.value="",a.dataset.selectedId="",a.value=n?"":u}function dn(e,t,n){const{date:a,time:s}=hs(n),r=document.getElementById(e),i=document.getElementById(t);if(r){if(a)if(r._flatpickr){const o=r._flatpickr.config?.dateFormat||"Y-m-d";r._flatpickr.setDate(a,!1,o)}else r.value=a;else r._flatpickr?r._flatpickr.clear():r.value="";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(s)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(s,!1,o)}else i.value=s;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function Bs(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||_t({selectedValue:a});const r=(ca()||[]).find(l=>String(l.id)===String(e.clientId)),i=r?.id!=null?String(r.id):"";st(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=Ma(e,"start"),d=Ma(e,"end");o&&dn("res-start","res-start-time",o),d&&dn("res-end","res-end-time",d);const u=document.getElementById("res-notes");u&&e.description&&(t||!u.value)&&(u.value=e.description),ye(),ut()}function Ds({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:Se(),s=Array.isArray(a)?a:[];Ls(s);const r=t!=null?String(t):n.value?String(n.value):"";_t({selectedValue:r,projectsList:s}),ut(),ye()}function ut(){const{input:e,hidden:t}=It(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),s=document.getElementById("res-payment-status"),r=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),u=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),y=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(ht(n,Ue),a&&ht(a,Ue)),s&&ht(s,Ue),r&&ht(r,Ue),i&&ht(i,Ue),o&&ht(o,Ue),d&&ht(d,Ue),y)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=u),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=u),s&&(s.value="unpaid",Ge(s,"unpaid"),s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=u),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=u),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=u),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=u),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=u);else{if(n){const p=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",p&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}Hn("tax"),ye()}function ba(){const{input:e,hidden:t}=It();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Mn(s,{allowPartial:a}):null;if(r){t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id);const i=ya(r.id);i?Bs(i,{skipProjectSelectUpdate:!0}):(ut(),ye())}else t.value="",e.dataset.selectedId="",ut(),ye()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Mn(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function ha(){const{input:e,hidden:t}=pa();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?Rn(s,{allowPartial:a}):null;r?(t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id)):(t.value="",e.dataset.selectedId=""),ye()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?Rn(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="")}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Pi(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){zt({clearValue:!0});return}let n=null;try{const u=decodeURIComponent(t);n=JSON.parse(u)}catch(u){console.warn("⚠️ [reservations/createForm] Failed to decode project context",u)}e.delete("reservationProjectContext");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,s),zt({clearValue:!1}),!n)return;n.fromProjectForm&&(Zt={draftStorageKey:n.draftStorageKey||ks,returnUrl:n.returnUrl||Ps});const r=document.getElementById("res-project");if(n.projectId){r&&(_t({selectedValue:String(n.projectId)}),ut());const u=ya(n.projectId);u?Bs(u,{forceNotes:!!n.forceNotes}):ye(),zt()}else{r&&_t({selectedValue:""});const u=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","سيتم الربط بعد حفظ المشروع الحالي");Oi(c("reservations.create.project.pendingTooltip","سيتم تفعيل اختيار المشروع بعد حفظ المشروع الحالي"),u)}n.start&&dn("res-start","res-start-time",n.start),n.end&&dn("res-end","res-end-time",n.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(n.customerId){const l=(ca()||[]).find(y=>String(y.id)===String(n.customerId));l?.id!=null&&(st({selectedValue:String(l.id)}),o&&(o.value=String(l.id)),i&&(i.value=l.customerName||l.name||i.value))}else n.customerName&&i?(st({selectedValue:""}),i.value=n.customerName,i.dataset.selectedId="",o&&(o.value="")):st({selectedValue:""});const d=document.getElementById("res-notes");d&&n.description&&!d.value&&(d.value=n.description),ye()}function At(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Qt(e,n),end:Qt(t,a)}}function Fs(e){const t=ln(e);if(t){const o=on.get(t);if(o)return o}const{description:n,barcode:a}=js(e);if(a){const o=na(a);if(o)return o}const s=Qe(n||e);if(!s)return null;let r=ys();if(!r?.length){const o=Se();r=Array.isArray(o?.equipment)?o.equipment:[],r.length&&vs(r)}const i=r.find(o=>Qe(o?.desc||o?.description||"")===s);return i||r.find(o=>Qe(o?.desc||o?.description||"").includes(s))||null}function Rs(e,t="equipment-description-options"){const n=ln(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(d=>ln(d.value)===n)||on.has(n))return!0;const{description:s}=js(e);if(!s)return!1;const r=Qe(s);return r?(ys()||[]).some(o=>Qe(o?.desc||o?.description||"")===r):!1}const xi={available:0,reserved:1,maintenance:2,retired:3};function $i(e){return xi[e]??5}function Oa(e){switch(e){case"available":return c("reservations.equipment.status.available","متاح");case"reserved":return c("reservations.equipment.status.reserved","محجوز");case"maintenance":return c("reservations.equipment.status.maintenance","صيانة");case"retired":return c("reservations.equipment.status.retired","خارج الخدمة");default:return c("reservations.equipment.status.unknown","الحالة غير معروفة")}}function ji(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(s=>s!=="available")||e.bestStatus;if(n==="available")return`${t} — ${Oa(n)}`;const a=c("reservations.equipment.status.unavailable","غير متاح");return`${t} — ${a} (${Oa(n)})`}function mt(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=ma(),a=Se(),s=Array.isArray(n)&&n.length?n:a?.equipment||[],r=Array.isArray(s)?s:[];vs(r);const i=new Map;r.forEach(u=>{const l=Ai(u),y=ln(l);if(!y||!l)return;const p=dt(u),m=$i(p),f=i.get(y);if(!f){i.set(y,{normalized:y,value:l,bestItem:u,bestStatus:p,bestPriority:m,statuses:new Set([p])});return}f.statuses.add(p),m<f.bestPriority&&(f.bestItem=u,f.bestStatus=p,f.bestPriority=m,f.value=l)}),on=new Map;const d=Array.from(i.values()).sort((u,l)=>u.value.localeCompare(l.value,"ar",{sensitivity:"base"})).map(u=>{on.set(u.normalized,u.bestItem);const l=ji(u),y=cn(u.value);if(l===u.value)return`<option value="${y}"></option>`;const p=cn(l);return`<option value="${y}" label="${p}"></option>`}).join("");e&&(e.innerHTML=d),t&&(t.innerHTML=d)}function Ms(e,t,n={}){const{silent:a=!1}=n,s=re(e);if(!s)return{success:!1,message:null};const{start:r,end:i}=At();if(!r||!i){const f=c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات");return a||P(f),{success:!1,message:f}}const o=at();if(ga(o).has(s)){const f=c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز");return a||P(f),{success:!1,message:f}}const u=la(s,r,i);if(u.length){const f=u.map(v=>v.name).join(", "),h=c("reservations.toast.equipmentBlockedByPackage",`⚠️ لا يمكن إضافة هذه المعدة لأنها جزء من حزمة محجوزة: ${f}`);return a||P(h),{success:!1,message:h}}if(ot(s,r,i)){const f=c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية");return a||P(f),{success:!1,message:f}}const l=na(s);if(!l){const f=c("reservations.toast.barcodeNotFound","❌ الباركود غير موجود");return a||P(f),{success:!1,message:f}}const y=dt(l);if(y==="maintenance"||y==="retired"){const f=Et(y);return a||P(f),{success:!1,message:f}}const p=qt(l);if(!p){const f=c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف");return a||P(f),{success:!1,message:f}}Sn({id:p,equipmentId:p,barcode:s,desc:l.desc,qty:1,price:l.price,image:Nt(l)}),t&&(t.value=""),ct(),ye();const m=c("reservations.toast.equipmentAdded","✅ تم إضافة المعدة بنجاح");return a||P(m),{success:!0,message:m,barcode:s}}function On(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Fs(t);if(!n){P(c("reservations.toast.equipmentNameNotFound","❌ لم يتم العثور على معدة بالاسم المدخل"));return}const a=Gr(n.barcode),s=dt(a||n);if(s==="maintenance"||s==="retired"){P(Et(s));return}const r=re(n.barcode);if(!r){P(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const i=qt(n);if(!i){P(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const o={id:i,equipmentId:i,barcode:r,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,image:Nt(n)},{start:d,end:u}=At();if(!d||!u){P(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const l=at();if(ga(l).has(r)){P(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const p=la(r,d,u);if(p.length){const m=p.map(f=>f.name).join(", ");P(c("reservations.toast.equipmentBlockedByPackage",`⚠️ لا يمكن إضافة هذه المعدة لأنها جزء من حزمة محجوزة: ${m}`));return}if(ot(r,d,u)){P(c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية"));return}Sn(o),ct(),ye(),P(c("reservations.toast.equipmentAdded","✅ تم إضافة المعدة بنجاح")),e.value=""}function Ci(){mt();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),On(e))});const t=()=>{Rs(e.value,"equipment-description-options")&&On(e)};e.addEventListener("focus",()=>{if(mt(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function za(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function ga(e=at()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=re(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(s=>{const r=re(s?.normalizedBarcode??s?.barcode);r&&t.add(r)})}),t}function _i(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=At();if(!t||!n){P(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}di({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):P(c("reservations.toast.equipmentTabUnavailable","⚠️ تعذر فتح تبويب المعدات حالياً"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(Es.change,t=>{za(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),za(e,mi()))}function Ti(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],s=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=a.length?a:t.barcode?[t.barcode]:[];if(!r.length)return;let i=0,o=null;const d=[],u=new Set;r.forEach(y=>{const p=re(y);p&&!u.has(p)&&(u.add(p),d.push(p))});const l=Math.min(s,d.length);for(let y=0;y<l;y+=1){const p=d[y],m=Ms(p,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const p=c("reservations.toast.equipmentAddedBulk","✅ تم إضافة {count} معدة إلى الحجز").replace("{count}",I(String(i)));P(p)}else o&&P(o)}function Hs(){_i(),!(Fa||typeof document>"u")&&(document.addEventListener(Es.requestAdd,Ti),Fa=!0)}function Xt(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),s=document.getElementById("reservation-package-hint"),r=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:s,packageAddButton:r}}function zn(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:s}=Xt();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const r=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=t==="package";r&&(r.disabled=o),i&&(i.disabled=o),s&&(s.disabled=t!=="package"||s.options.length===0),ci(t),t==="package"&&wn()}function wn(){const{packageSelect:e,packageHint:t}=Xt();if(!e)return;const n=fs();$s=n,ai(n.map(o=>o.raw??o));const a=c("reservations.create.summary.currency","SR"),s=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","اختر الحزمة")}</option>`,r=n.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,u=I(d.toFixed(2)),l=`${o.name} — ${u} ${a}`;return`<option value="${o.id}">${l}</option>`}).join("");e.innerHTML=`${s}${r}`,e.selectedIndex=0;const i=n.length>0;e.disabled=!i,t&&(i?(t.textContent=c("reservations.create.packages.hint","سيتم إضافة الحزمة مباشرة بمجرد اختيارها."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","لا توجد حزم معرفة حالياً. يمكنك إضافتها لاحقاً من لوحة التحكم."),t.dataset.state="empty")),Vs()}function Ni(e,t){const n=e?.name||c("reservations.create.packages.genericName","الحزمة"),a=c("reservations.toast.packageItemsConflict",`⚠️ لا يمكن إضافة ${n} لأن العناصر التالية غير متاحة:`),s=t.map(({item:r,blockingPackages:i})=>{const o=r?.desc||I(String(r?.barcode??r?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","عنصر بدون اسم");if(Array.isArray(i)&&i.length){const d=i.map(u=>u.name).join(", ");return`• ${o} (${c("reservations.create.packages.blockedByPackage","محجوز ضمن الحزم")}: ${d})`}return`• ${o} (${c("reservations.create.packages.blockedDirect","محجوز في الفترة المختارة")})`});return[a,...s].join(`
`)}function Os(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:s=null}={}){const r=wt(e);if(!r)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")};const i=Ii(r);if(!i)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","⚠️ تعذر العثور على بيانات الحزمة المحددة")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات")};if(t.some(m=>m?.type==="package"&&wt(m.packageId)===r))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","⚠️ هذه الحزمة مضافة بالفعل إلى الحجز")};if(ri(r,n,a,s)){const m=i.name||r;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`⚠️ الحزمة ${m} محجوزة بالفعل في الفترة المختارة`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:da(i.raw??{}),d=ga(t),u=[],l=new Set;if(o.forEach(m=>{const f=re(m?.normalizedBarcode??m?.barcode);if(f){if(l.has(f)){u.push({item:m,type:"internal"});return}l.add(f),d.has(f)&&u.push({item:m,type:"external"})}}),u.length){const m=u.map(({item:h})=>h?.desc||h?.description||h?.name||h?.barcode||h?.normalizedBarcode||c("equipment.packages.items.unknown","معدة بدون اسم")).map(h=>I(String(h))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:u.some(h=>h.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","⚠️ لا يمكن إضافة الحزمة لأن العناصر التالية موجودة مسبقاً في الحجز: {items}").replace("{items}",m):c("reservations.toast.packageDuplicateEquipmentInternal","⚠️ بيانات الحزمة تحتوي على عناصر مكررة: {items}").replace("{items}",m),duplicates:u}}const y=[];return o.forEach(m=>{const f=re(m?.normalizedBarcode??m?.barcode);if(f&&ot(f,n,a,s)){const h=la(f,n,a,s);y.push({item:m,blockingPackages:h})}}),y.length?{success:!1,reason:"item_conflict",message:Ni(i,y),conflicts:y}:{success:!0,package:{id:`package::${r}`,packageId:r,type:"package",desc:i.name||`Package ${r}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,barcode:i.code||i.raw?.package_code||`pkg-${r}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:re(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function zs(e,{silent:t=!1}={}){const n=wt(e);if(!n)return t||P(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),{success:!1,reason:"invalid"};const{start:a,end:s}=At(),r=at(),i=Os(n,{existingItems:r,start:a,end:s});if(!i.success){if(!t){const d={invalid:c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً"),not_found:c("reservations.toast.packageNotFound","⚠️ تعذر العثور على بيانات الحزمة المحددة"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"),duplicate:c("reservations.toast.packageDuplicate","⚠️ هذه الحزمة مضافة بالفعل إلى الحجز")}[i.reason]||c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً");P(i.message||d)}return i}return Sn(i.package),ct(),ye(),t||P(c("reservations.toast.packageAdded","✅ تم إضافة الحزمة بنجاح")),{success:!0,package:i.package}}function Vs(){const{packageSelect:e}=Xt();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;zs(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Li(){const{packageAddButton:e,packageSelect:t}=Xt();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){P(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً"));return}zs(n)}),e.dataset.listenerAttached="true")}function Ks(){const{modeRadios:e}=Xt();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",s=>{s.target.checked&&zn(s.target.value)}),a.dataset.listenerAttached="true")}),Li(),Vs();const t=rn(),n=e.find(a=>a.value===t);n&&(n.checked=!0),zn(t)}function ct(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=at(),a=c("reservations.create.equipment.noneAdded","لا توجد معدات مضافة"),s=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","صورة"),i=c("reservations.equipment.actions.increase","زيادة الكمية"),o=c("reservations.equipment.actions.decrease","تقليل الكمية"),d=c("reservations.equipment.actions.remove","إزالة البند");if(n.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${a}</td></tr>`;return}const u=aa(n);t.innerHTML=u.map(l=>{const y=l.items[0]||{},p=Nt(y)||l.image,m=p?`<img src="${p}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',f=I(String(l.count)),h=Number.isFinite(Number(l.unitPrice))?Number(l.unitPrice):0,v=Number.isFinite(Number(l.totalPrice))?Number(l.totalPrice):h*l.count,j=`${I(h.toFixed(2))} ${s}`,g=`${I(v.toFixed(2))} ${s}`,C=l.items.some(A=>A?.type==="package"),k=l.barcodes.map(A=>I(String(A||""))).filter(Boolean),H=k.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
            <ul class="reservation-barcode-list">
              ${k.map(A=>`<li>${A}</li>`).join("")}
            </ul>
          </details>`:"";let S="";if(C){const A=new Map;if(l.items.forEach(L=>{Array.isArray(L?.packageItems)&&L.packageItems.forEach(T=>{if(!T)return;const W=re(T.barcode||T.desc||Math.random()),$=A.get(W);if($){$.qty+=Number.isFinite(Number(T.qty))?Number(T.qty):1;return}A.set(W,{desc:T.desc||T.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:Number.isFinite(Number(T.qty))?Number(T.qty):1,barcode:T.barcode??T.normalizedBarcode??""})})}),A.size){const L=Array.from(A.values()).map(T=>{const W=I(String(T.qty)),$=T.desc||I(String(T.barcode||"")),B=T.barcode?` <span class="reservation-package-items__barcode">(${I(String(T.barcode))})</span>`:"";return`<li>${$}${B} × ${W}</li>`}).join("");S=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
              <ul class="reservation-package-items__list">
                ${L}
              </ul>
            </details>
          `}}return`
        <tr data-group-key="${l.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${l.description||"-"}</div>
                ${C?`${S||""}${H||""}`:H}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${l.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${l.key}" aria-label="${o}" ${C?"disabled":""}>−</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${l.key}" aria-label="${i}" ${C?"disabled":""}>+</button>
            </div>
          </td>
          <td>${j}</td>
          <td>${g}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${l.key}" aria-label="${d}">🗑️</button>
          </td>
        </tr>
      `}).join("")}function Bi(e){const t=at(),a=aa(t).find(r=>r.key===e);if(!a)return;const s=a.itemIndices[a.itemIndices.length-1];s!=null&&(si(s),ct(),ye())}function Di(e){const t=at(),n=t.filter(a=>Jt(a)!==e);n.length!==t.length&&(gs(n),ct(),ye())}function Fi(e){const t=at(),a=aa(t).find(y=>y.key===e);if(!a)return;const{start:s,end:r}=At();if(!s||!r){P(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const i=new Set(t.map(y=>re(y.barcode))),{equipment:o=[]}=Se(),d=(o||[]).find(y=>{const p=re(y?.barcode);return!p||i.has(p)||Jt({desc:y?.desc||y?.description||y?.name||"",price:Number(y?.price)||0})!==e||!os(y)?!1:!ot(p,s,r)});if(!d){P(c("reservations.toast.noAdditionalUnits","⚠️ لا توجد وحدات إضافية متاحة حالياً"));return}const u=re(d.barcode),l=qt(d);if(!l){P(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}Sn({id:l,equipmentId:l,barcode:u,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,image:Nt(d)}),ct(),ye()}function ye(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(I(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",s=e?"percent":a,r=document.getElementById("res-tax"),i=e?!1:r?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:u,end:l}=At();i&&Ye();const y=Ct(),p=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),f=Cs(p),h=_s(m);cs(),Na({selectedItems:at(),discount:n,discountType:s,applyTax:i,paidStatus:d,paymentProgressType:f,paymentProgressValue:h,start:u,end:l,companySharePercent:y,paymentHistory:[]});const v=Na.lastResult;v?(Ts(m,v.paymentProgressValue),o&&(o.value=v.paymentStatus,Ge(o,v.paymentStatus))):Ge(o,d)}function Ri(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=I(o.target.value),ye()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",ye),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(Ue()){n.checked=!1,P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}Hn("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(Ue()){a.checked=!1,P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}Hn("share")}),a.dataset.listenerAttached="true");const s=document.getElementById("res-payment-status");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{if(Ue()){s.value="unpaid",Ge(s,"unpaid"),P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}Ge(s),ye()}),s.dataset.listenerAttached="true");const r=document.getElementById("res-payment-progress-type");r&&!r.dataset.listenerAttached?(r.dataset.userSelected!=="true"&&(r.value="percent"),r.addEventListener("change",o=>{if(Ue()){r.value="percent",P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}r.dataset.userSelected="true",ye()}),r.dataset.listenerAttached="true"):r&&r.dataset.userSelected!=="true"&&!r.value&&(r.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if(Ue()){i.value="",P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}o.target.value=I(o.target.value),ye()}),i.dataset.listenerAttached="true"),ye()}function Mi(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;let n=!1;const a=()=>{const s=e.value?.trim();if(!s){ye();return}const r=t.dataset.syncedWithStart;(!t.value?.trim()||r!=="false")&&(n=!0,t.value=s,t.dataset.syncedWithStart="true",t.dataset.syncedValue=s,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),ye()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{n||(t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false")}),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Va(){const{input:e,hidden:t}=pa(),{input:n,hidden:a}=It(),{customers:s}=Se();let r=t?.value?String(t.value):"";if(!r&&e?.value){const O=Rn(e.value,{allowPartial:!0});O&&(r=String(O.id),t&&(t.value=r),e.value=O.label,e.dataset.selectedId=r)}const i=s.find(O=>String(O.id)===r);if(!i){P(c("reservations.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&n?.value){const O=Mn(n.value,{allowPartial:!0});O&&(d=String(O.id),a&&(a.value=d),n.value=O.label,n.dataset.selectedId=d)}const u=document.getElementById("res-start").value,l=document.getElementById("res-end").value,y=document.getElementById("res-start-time")?.value||"00:00",p=document.getElementById("res-end-time")?.value||"00:00";if(!u||!l){P(c("reservations.toast.requireDates","⚠️ يرجى تحديد تاريخ البداية والنهاية"));return}const m=`${u}T${y}`,f=`${l}T${p}`,h=new Date(m),v=new Date(f);if(Number.isNaN(h.getTime())||Number.isNaN(v.getTime())||h>=v){P(c("reservations.toast.invalidDateRange","⚠️ تأكد من أن تاريخ ووقت البداية يسبق تاريخ ووقت النهاية"));return}const j=cs();j.map(O=>O.technicianId).filter(Boolean);const g=at();if(g.length===0&&j.length===0){P(c("reservations.toast.noItems","⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل"));return}const C=document.getElementById("res-notes")?.value||"",k=parseFloat(I(document.getElementById("res-discount")?.value))||0,H=document.getElementById("res-discount-type")?.value||"percent",S=document.getElementById("res-payment-status"),A=S?.value||"unpaid",L=document.getElementById("res-payment-progress-type"),T=document.getElementById("res-payment-progress-value"),W=Cs(L),$=_s(T),B=d?ya(d):null,V=ki(B);if(d&&!B){P(c("reservations.toast.projectNotFound","⚠️ لم يتم العثور على المشروع المحدد. حاول تحديث الصفحة."));return}for(const O of g){const ie=dt(O.barcode);if(ie==="maintenance"||ie==="retired"){P(Et(ie));return}}for(const O of g){const ie=re(O.barcode);if(ot(ie,m,f)){P(c("reservations.toast.cannotCreateEquipmentConflict","⚠️ لا يمكن إتمام الحجز، إحدى المعدات محجوزة في نفس الفترة الزمنية"));return}}for(const O of j)if(O?.technicianId&&bs(O.technicianId,m,f)){P(c("reservations.toast.cannotCreateCrewConflict","⚠️ لا يمكن إتمام الحجز، أحد أعضاء الطاقم مرتبط بحجز آخر في نفس الفترة"));return}const _=document.getElementById("res-tax"),N=document.getElementById("res-company-share"),D=!!d;D?(_&&(_.checked=!1,_.disabled=!0,_.classList.add("disabled"),_.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تعديل الضريبة من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),N&&(N.checked=!1,N.disabled=!0,N.classList.add("disabled"),N.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تعديل نسبة الشركة من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),S&&(S.value="unpaid",S.disabled=!0,Ge(S,"unpaid"),S.title=c("reservations.toast.linkedProjectDisabled","لا يمكن تغيير حالة الدفع من شاشة الحجز المرتبط. عدّل المشروع بدلًا من ذلك.")),L&&(L.disabled=!0,L.classList.add("disabled")),T&&(T.value="",T.disabled=!0,T.classList.add("disabled"))):(_&&(_.disabled=!1,_.classList.remove("disabled"),_.title=""),N&&(N.disabled=!1,N.classList.remove("disabled"),N.title=""),S&&(S.disabled=!1,S.title=""),L&&(L.disabled=!1,L.classList.remove("disabled")),T&&(T.disabled=!1,T.classList.remove("disabled")));const J=D?!1:_?.checked||!1,Q=!!N?.checked;if(!D&&Q!==J){P(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"));return}let F=Q?Ct():null;Q&&(!Number.isFinite(F)||F<=0)&&(Ye(),F=Ct());const X=Q&&J&&Number.isFinite(F)&&F>0;J&&Ye();const R=sa(g,k,H,J,j,{start:m,end:f,companySharePercent:X?F:0}),ce=Or(),te=ra({totalAmount:R,progressType:W,progressValue:$,history:[]});T&&Ts(T,te.paymentProgressValue);const be=[];te.paymentProgressValue!=null&&te.paymentProgressValue>0&&be.push({type:te.paymentProgressType||W,value:te.paymentProgressValue,amount:te.paidAmount,percentage:te.paidPercent,recordedAt:new Date().toISOString()});const he=ia({manualStatus:A,paidAmount:te.paidAmount,paidPercent:te.paidPercent,totalAmount:R});S&&(S.value=he,Ge(S,he));const qe=typeof B?.paymentStatus=="string"?B.paymentStatus.toLowerCase():null,je=qe&&["paid","partial","unpaid"].includes(qe)?qe:"unpaid",Le=ls({reservationCode:ce,customerId:o,start:m,end:f,status:V?"confirmed":"pending",title:null,location:null,notes:C,projectId:d||null,totalAmount:R,discount:D?0:k,discountType:D?"percent":H,applyTax:J,paidStatus:D?je:he,confirmed:V,items:g.map(O=>({...O,equipmentId:O.equipmentId??O.id})),crewAssignments:j,companySharePercent:D||!X?null:F,companyShareEnabled:D?!1:X,paidAmount:D?0:te.paidAmount,paidPercentage:D?0:te.paidPercent,paymentProgressType:D?null:te.paymentProgressType,paymentProgressValue:D?null:te.paymentProgressValue,paymentHistory:D?[]:be});try{Da("about to submit",{crewAssignments:j,techniciansPayload:Le?.technicians,payload:Le});const O=await Wr(Le);Da("server response",{reservation:O?.id??O?.reservationId??O?.reservation_code,technicians:O?.technicians,crewAssignments:O?.crewAssignments,techniciansDetails:O?.techniciansDetails}),ma(),mt(),jt(),zi(),P(c("reservations.toast.created","✅ تم إنشاء الحجز"));try{const ie=document.getElementById("sub-tab-trigger-my-reservations-tab");ie&&typeof ie.click=="function"&&setTimeout(()=>ie.click(),0)}catch{}typeof Bn=="function"&&Bn({type:"created",reservation:O}),Hi(O)}catch(O){console.error("❌ [reservations/createForm] Failed to create reservation",O);const ie=ds(O)?O.message:c("reservations.toast.createFailed","تعذر إنشاء الحجز، حاول مرة أخرى");P(ie,"error"),D&&(P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ التعديلات من شاشة المشروع."),"error"),zt({clearValue:!1}))}}function Hi(e){if(!Zt)return;const{draftStorageKey:t=ks,returnUrl:n=Ps}=Zt,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const s=window.sessionStorage.getItem(t),r=s?JSON.parse(s)||{}:{},i=Array.isArray(r.linkedReservationIds)?r.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),r.linkedReservationIds=i,window.sessionStorage.setItem(t,JSON.stringify(r))}catch(s){console.warn("⚠️ [reservations] Unable to persist linked reservation draft state",s)}Zt=null,n&&(window.location.href=n)}function zt({clearValue:e=!1}={}){const{input:t,hidden:n}=It();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,ut())}function Oi(e,t=""){const{input:n,hidden:a}=It();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),ut())}function zi(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),st({selectedValue:"",resetInput:!0}),document.getElementById("res-start").value="",document.getElementById("res-start-time").value="",document.getElementById("res-end").value="",document.getElementById("res-end-time").value="",document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),zt({clearValue:!1}),_t({selectedValue:"",resetInput:!0});const s=document.getElementById("equipment-description");s&&(s.value="");const r=document.getElementById("res-payment-status");r&&(r.value="unpaid",Ge(r,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),Jr(),gs([]),ui("form-reset"),ct(),ut(),ye()}function Vi(){const e=document.getElementById("reservation-items");!e||e.dataset.listenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s}=n.dataset;if(a==="decrease-group"&&s){Bi(s);return}if(a==="increase-group"&&s){Fi(s);return}if(a==="remove-group"&&s){Di(s);return}}),e.dataset.listenerAttached="true")}function Ki(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(rn()!=="single")return;const s=e.value;s?.trim()&&(clearTimeout(t),t=null,Ms(s,e))};e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||rn()!=="single")return;const{start:r,end:i}=At();!r||!i||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function Ui(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async n=>{n.preventDefault(),await Va()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async n=>{n.preventDefault(),await Va()}),t.dataset.listenerAttached="true")}function Uc({onAfterSubmit:e}={}){Bn=typeof e=="function"?e:null;const{customers:t,projects:n}=Se();li(t||[]),st(),ha(),Ls(n||[]),Ds({projectsList:n}),ba(),mt(),wn(),Ci(),Hs(),Ks(),Mi(),Ri(),Vi(),Ki(),Ui(),Pi(),ye(),ct()}function Us(){mt(),wn(),Ds(),st(),ha(),ba(),Hs(),Ks(),ct(),ye()}if(typeof document<"u"){const e=()=>{st(),_t({projectsList:fa()}),ha(),ba(),ye()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{mt()}),document.addEventListener("packages:changed",()=>{wn(),rn()==="package"&&zn("package")})}typeof window<"u"&&(window.getCompanySharePercent=Ct);function Yt(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function Qi(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],s=Number.parseInt(a,10);return Number.isFinite(s)?s:null}function Gi(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=Qi(n);if(a!==null)return a}return null}function Ka(e,t=0){const n=Gi(e);if(n!=null)return n;const a=Yt(e.createdAt??e.created_at);if(a!=null)return a;const s=Yt(e.updatedAt??e.updated_at);if(s!=null)return s;const r=Yt(e.start);if(r!=null)return r;const i=Yt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(t)?t:0}function Wi({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:s}){const r=e.map((g,C)=>({reservation:g,index:C})),i=t.searchTerm||"",o=t.searchReservationId||"",d=t.searchCustomerName||"",u=t.searchProjectId||"",l=t.startDate||"",y=t.endDate||"",p=t.status||"",m=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,f=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,h=l?new Date(`${l}T00:00:00`):null,v=y?new Date(`${y}T23:59:59`):null,j=r.filter(({reservation:g})=>{const C=n.get(String(g.customerId)),k=s?.get?.(String(g.projectId)),H=g.start?new Date(g.start):null,S=us(g),{effectiveConfirmed:A}=Lt(g,k);if(m!=null&&String(g.customerId)!==String(m)||f!=null&&!(Array.isArray(g.technicians)?g.technicians.map(B=>String(B)):[]).includes(String(f))||p==="confirmed"&&!A||p==="pending"&&A||p==="completed"&&!S)return!1;if(p==="cancelled"){const $=String(g?.status||g?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes($))return!1}if(h&&H&&H<h||v&&H&&H>v)return!1;if(o){const $=[g.reservationId,g.id,g.reservation_id,g.reservationCode,g.reservation_code,g.code,g.reference,g.referenceNumber,g.reference_number],B=Qe($.filter(_=>_!=null&&_!=="").map(String).join(" ")).replace(/\s+/g,""),V=o.replace(/\s+/g,"");if(!B.includes(V))return!1}if(d&&!Qe(C?.customerName||"").includes(d))return!1;if(u){const $=[g.projectId,g.project_id,g.projectID,k?.id,k?.projectCode,k?.project_code],B=Qe($.filter(_=>_!=null&&_!=="").map(String).join(" ")).replace(/\s+/g,""),V=u.replace(/\s+/g,"");if(!B.includes(V))return!1}if(!i)return!0;const L=g.items?.map?.($=>`${$.barcode} ${$.desc}`).join(" ")||"",T=(g.technicians||[]).map($=>a.get(String($))?.name).filter(Boolean).join(" ");return Qe([g.reservationId,C?.customerName,g.notes,L,T,k?.title].filter(Boolean).join(" ")).includes(i)});return j.sort((g,C)=>{const k=Ka(g.reservation,g.index),H=Ka(C.reservation,C.index);return k!==H?H-k:C.index-g.index}),j}function Ji({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const s=c("reservations.create.summary.currency","SR"),r=c("reservations.list.taxIncludedShort","(شامل الضريبة)"),i=c("reservations.list.unknownCustomer","غير معروف"),o=c("reservations.list.noNotes","لا توجد ملاحظات"),d=c("reservations.list.itemsCountShort","{count} عنصر"),u=c("reservations.list.crew.separator","، "),l=c("reservations.list.status.confirmed","✅ مؤكد"),y=c("reservations.list.status.pending","⏳ غير مؤكد"),p=c("reservations.list.status.completed","📁 منتهي"),m=c("reservations.list.payment.paid","💳 مدفوع"),f=c("reservations.list.payment.unpaid","💳 غير مدفوع"),h=c("reservations.list.payment.partial","💳 مدفوع جزئياً"),v=c("reservations.list.actions.confirm","✔️ تأكيد"),j=c("reservations.list.project.unlinked","غير مرتبط بمشروع"),g=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),C={client:c("reservations.list.labels.client","👤 العميل"),project:c("reservations.list.labels.project","📁 المشروع"),start:c("reservations.list.labels.start","🗓️ بداية الحجز"),end:c("reservations.list.labels.end","🗓️ نهاية الحجز"),cost:c("reservations.list.labels.cost","💵 الإجمالي النهائي"),equipment:c("reservations.list.labels.equipment","📦 المعدات"),crew:c("reservations.list.labels.crew","😎 الفريق")};return e.map(({reservation:k,index:H})=>{const S=t.get(String(k.customerId)),A=k.projectId?a?.get?.(String(k.projectId)):null,L=us(k),T=typeof A?.paymentStatus=="string"?A.paymentStatus.toLowerCase():null,W=k.paidStatus??k.paid_status??(k.paid===!0||k.paid==="paid"?"paid":"unpaid"),$=T&&["paid","partial","unpaid"].includes(T)?T:W,B=$==="paid",V=$==="partial",{effectiveConfirmed:_,projectLinked:N}=Lt(k,A),D=_?"status-confirmed":"status-pending",J=B?"status-paid":V?"status-partial":"status-unpaid";let Q=`<span class="reservation-chip status-chip ${D}">${_?l:y}</span>`;const F=B?m:V?h:f;let X=`<span class="reservation-chip status-chip ${J}">${F}</span>`,R=B?" tile-paid":V?" tile-partial":" tile-unpaid";L&&(R+=" tile-completed");let ce="";L&&(Q=`<span class="reservation-chip status-chip status-completed">${p}</span>`,X=`<span class="reservation-chip status-chip status-completed">${F}</span>`,ce=` data-completed-label="${c("reservations.list.ribbon.completed","منتهي").replace(/"/g,"&quot;")}"`);let te=!N&&!_?`<button class="tile-confirm" data-reservation-index="${H}" data-action="confirm">${v}</button>`:"";{const M=String(k?.status||k?.reservationStatus||"").toLowerCase();(M==="cancelled"||M==="canceled")&&(Q=`<span class="reservation-chip status-chip status-cancelled">${c("reservations.list.status.cancelled","❌ ملغي")}</span>`,R=" tile-cancelled",ce="",typeof te<"u"&&(te=""))}const be=te?`<div class="tile-actions">${te}</div>`:"",he=k.items?.length||0,qe=Array.isArray(k.crewAssignments)?k.crewAssignments:[],je=(k.technicians||[]).map(M=>n.get(String(M))).filter(Boolean),Le=qe.length?qe.map(M=>{const w=M.positionLabel??M.position_name??M.role??c("reservations.crew.positionFallback","منصب بدون اسم"),z=M.technicianName??n.get(String(M.technicianId??""))?.name??null;return z?`${I(w)} (${I(z)})`:I(w)}):je.map(M=>M.name),O=Le.length?Le.join(u):"—",ie=I(String(k.reservationId??"")),Be=k.start?I(it(k.start)):"-",De=k.end?I(it(k.end)):"-",Oe=I(String(k.cost??0)),Fe=I(String(he)),ge=k.notes?I(k.notes):o,Ae=d.replace("{count}",Fe),Ce=k.applyTax?`<small>${r}</small>`:"";let Te=j;return k.projectId&&(Te=A?.title?I(A.title):g),`
      <div class="${te?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${R}"${ce} data-reservation-index="${H}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${ie}</div>
          <div class="tile-badges">
            ${Q}
            ${X}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${C.client}</span>
            <span class="tile-value">${S?.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${C.project}</span>
            <span class="tile-value">${Te}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${C.start}</span>
            <span class="tile-value tile-inline">${Be}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${C.end}</span>
            <span class="tile-value tile-inline">${De}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${C.cost}</span>
            <span class="tile-value">${Oe} ${s} ${Ce}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${C.equipment}</span>
            <span class="tile-value">${Ae}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${C.crew}</span>
            <span class="tile-value">${Le.length?O:"—"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">📝 ${ge}</span>
          </div>
        </div>
        ${be}
      </div>
    `}).join("")}const Xi=""+new URL("Tajawal-400.ttf",import.meta.url).href,Yi=""+new URL("Tajawal-500.ttf",import.meta.url).href,Ua=""+new URL("Tajawal-700.ttf",import.meta.url).href,Qs="reservations.quote.sequence",Qa={reservation:"reservations.quote.togglePrefs.v1",project:"projects.quote.togglePrefs.v1"},Gs="https://help.artratio.sa/guide/quote-preview",_e={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",commercialRegistry:"4030485240",beneficiaryName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",bankName:"مصرف الراجحي",accountNumber:"٣٥٨٠٠٠٠١٠٠٠٦٠٨٦٠٦٥٧٠٦",iban:"SA1680000358608016065706",approvalNote:"الموافقة على هذا العرض تعتبر موافقة على جميع الشروط والأحكام."},Zi=["يوم العمل هو 12 ساعة، ويتم احتساب نصف يوم إضافي بعد 20 ساعة، ثم يوم كامل بعد ذلك.","يمنع استخدام المعدات في أنشطة غير قانونية.","يتحمل المستأجر مسؤولية أي تلف أو فقدان.","يجب إعادة المعدات في حالتها الأصلية.","يتم فرض رسوم على الإلغاء إذا لم يتم الإبلاغ قبل 24 ساعة."],He=[...Zi],eo=["يتم دفع 50% من قيمة المشروع عند الموافقة على عرض السعر، ويتم استكمال الـ 50% المتبقية قبل التسليم النهائي.","يحصل العميل على حقوق استخدام النسخة النهائية في أي مكان يراه مناسباً، بينما تحتفظ الشركة بالمواد الخام ولا تستخدمها إلا بعد موافقة العميل ما لم يُتفق على غير ذلك.","يتم الاتفاق على جدول زمني للتنفيذ، وأي تعديلات إضافية خارج النطاق المتفق عليه تخضع لرسوم إضافية.","العميل مسؤول عن توفير التصاريح اللازمة للتصوير في المواقع المحددة، وأي تأخير ناتج عن ذلك قد يؤثر على مواعيد التسليم.","تُحفَظ المواد النهائية للمشروع لمدة 12 شهراً في أرشيف الشركة، ويمكن للعميل طلب نسخ إضافية خلال تلك الفترة.","يتحمّل العميل مسؤولية توفير بيئة عمل آمنة للفريق الفني والمعدات في موقع التصوير، ويضمن اتخاذ كافة الاحتياطات اللازمة للحفاظ على سلامتهم."];function Vn(e){return e?e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0):[...He]}function to(){const e=document.getElementById("reservation-terms");if(e&&e.value.trim().length>0){const a=Vn(e.value);if(a.length)return a}const t=document.getElementById("edit-res-terms");if(t&&t.value.trim().length>0){const a=Vn(t.value);if(a.length)return a}const n=He.join(`
`);return e&&e.value.trim().length===0&&(e.value=n),t&&t.value.trim().length===0&&(t.value=n),[...He]}const no=[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"بيانات العميل",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"تفاصيل الحجز",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"بيانات المشروع",defaultSelected:!0},{id:"financialSummary",labelKey:"reservations.quote.sections.financial",fallback:"الملخص المالي",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"قائمة المعدات",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"طاقم العمل",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"ملاحظات الحجز",defaultSelected:!0}],En=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>b(I(String(t+1)))},{id:"code",labelKey:"reservations.details.table.headers.code",fallback:"الكود",render:e=>{if(e?.isPackage){const t=e?.packageCodeResolved||e?.barcode||"";return b(t||"-")}return b(e?.barcode||"-")}},{id:"description",labelKey:"reservations.details.table.headers.description",fallback:"الوصف",render:e=>{const t=String(e?.desc||e?.description||"-");return`<div class="quote-cell quote-cell--desc">${b(t)}</div>`}},{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:e=>b(I(String(e?.qty||1)))},{id:"unitPrice",labelKey:null,fallback:"لكل يوم",render:e=>b(I(Number(e?.unitPriceValue||0).toFixed(2)))},{id:"price",labelKey:null,fallback:"المجموع",render:e=>b(I(Number(e?.price||0).toFixed(2)))}],qn=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>b(I(String(t+1)))},{id:"position",labelKey:"reservations.details.crew.position",fallback:"المنصب",render:e=>b(I(e?.positionLabel??e?.position_name??e?.role??c("reservations.crew.positionFallback","منصب بدون اسم")))},{id:"unitPrice",labelKey:null,fallback:"لكل يوم",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return b(`${I(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}},{id:"price",labelKey:null,fallback:"المجموع",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return b(`${I(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}}],Kn={customerInfo:[{id:"customerName",labelKey:"reservations.details.labels.customer",fallback:"العميل"},{id:"customerCompany",labelKey:"reservations.details.labels.company",fallback:"الشركة"},{id:"customerPhone",labelKey:"reservations.details.labels.phone",fallback:"الهاتف"},{id:"customerEmail",labelKey:"reservations.details.labels.email",fallback:"البريد"}],reservationInfo:[{id:"reservationId",labelKey:"reservations.details.labels.reservationId",fallback:"رقم الحجز"},{id:"reservationStart",labelKey:"reservations.details.labels.start",fallback:"بداية الحجز"},{id:"reservationEnd",labelKey:"reservations.details.labels.end",fallback:"نهاية الحجز"},{id:"reservationDuration",labelKey:"reservations.details.labels.duration",fallback:"عدد الأيام"}],projectInfo:[{id:"projectTitle",labelKey:"reservations.details.labels.project",fallback:"المشروع"},{id:"projectCode",labelKey:"reservations.details.labels.code",fallback:"الرمز"}],financialSummary:[{id:"discountAmount",labelKey:"reservations.details.labels.discount",fallback:"الخصم"},{id:"taxAmount",labelKey:"reservations.details.labels.tax",fallback:"الضريبة"},{id:"finalTotal",labelKey:"reservations.details.labels.total",fallback:"الإجمالي النهائي"}],payment:[{id:"beneficiary",labelKey:"reservations.quote.labels.beneficiary",fallback:"اسم المستفيد"},{id:"bank",labelKey:"reservations.quote.labels.bank",fallback:"اسم البنك"},{id:"account",labelKey:"reservations.quote.labels.account",fallback:"رقم الحساب"},{id:"iban",labelKey:"reservations.quote.labels.iban",fallback:"رقم الآيبان"}],items:[...En.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"إجمالي المعدات"}],crew:[...qn.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"groupByPosition",labelKey:null,fallback:"تجميع حسب المنصب",default:!1},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"إجمالي الفريق"}]},Ws=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>b(I(String(t+1)))},{id:"label",labelKey:null,fallback:"البند",render:e=>b(e?.label||"-")},{id:"amount",labelKey:null,fallback:"المبلغ",render:e=>b(e?.displayAmount||"—")},{id:"note",labelKey:null,fallback:"ملاحظات",render:e=>b(e?.note||"-")}],ao=[{id:"customerInfo",labelKey:"projects.quote.sections.customer",fallback:"بيانات العميل",defaultSelected:!0},{id:"projectInfo",labelKey:"projects.quote.sections.project",fallback:"بيانات المشروع",defaultSelected:!0},{id:"projectExpenses",labelKey:"projects.quote.sections.expenses",fallback:"الخدمات الإنتاجية",defaultSelected:!0},{id:"projectCrew",labelKey:"projects.quote.sections.crew",fallback:"طاقم العمل",defaultSelected:!0},{id:"financialSummary",labelKey:"projects.quote.sections.financial",fallback:"الملخص المالي",defaultSelected:!0},{id:"projectEquipment",labelKey:"projects.quote.sections.equipment",fallback:"المعدات",defaultSelected:!0},{id:"projectNotes",labelKey:"projects.quote.sections.notes",fallback:"ملاحظات المشروع",defaultSelected:!0}],so={customerInfo:Kn.customerInfo,projectInfo:[{id:"projectTitle",labelKey:"projects.details.overview.heading",fallback:"معلومات المشروع"},{id:"projectCode",labelKey:"projects.details.labels.code",fallback:"رقم المشروع"},{id:"projectType",labelKey:"projects.details.type",fallback:"نوع المشروع"},{id:"projectStart",labelKey:"projects.details.start",fallback:"بداية المشروع"},{id:"projectEnd",labelKey:"projects.details.end",fallback:"نهاية المشروع"},{id:"projectDuration",labelKey:"projects.details.duration",fallback:"مدة المشروع"},{id:"projectStatus",labelKey:"projects.details.status",fallback:"حالة المشروع"}],financialSummary:[{id:"reservationsTotal",labelKey:"projects.details.reservationsTotal",fallback:"إجمالي الحجوزات"},{id:"discountAmount",labelKey:"projects.details.summary.discount",fallback:"الخصم"},{id:"taxAmount",labelKey:"projects.details.summary.combinedTax",fallback:"الضريبة"},{id:"overallTotal",labelKey:"projects.details.summary.overallTotal",fallback:"الإجمالي الكلي"}],payment:Kn.payment,projectExpenses:[...Ws.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"expensesSubtotal",labelKey:"projects.details.expensesTotal",fallback:"إجمالي الخدمات الإنتاجية"}],projectCrew:[...qn.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية"},{id:"days",labelKey:null,fallback:"الأيام"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"إجمالي الفريق"}],projectEquipment:[...En.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:null,fallback:"الأيام"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"إجمالي المعدات"}],projectNotes:[]},Cn=new Map;function In(e="reservation"){if(Cn.has(e))return Cn.get(e);const t=e==="project"?ao:no,n=e==="project"?so:Kn,a=new Set(t.map(({id:i})=>i)),s=Object.fromEntries(Object.entries(n).map(([i,o=[]])=>[i,new Set(o.map(d=>d.id))])),r={sectionDefs:t,fieldDefs:n,sectionIdSet:a,fieldIdMap:s};return Cn.set(e,r),r}function An(e="reservation"){return In(e).sectionDefs}function Js(e="reservation"){return In(e).fieldDefs}function Xs(e="reservation"){return In(e).sectionIdSet}function Ys(e="reservation"){return In(e).fieldIdMap}function Zs(e){switch(e){case"export":return c("reservations.quote.status.exporting","جاري تجهيز ملف PDF...");case"render":default:return c("reservations.quote.status.rendering","جاري تحديث المعاينة...")}}const ro="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",io="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",oo="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",er=bi.trim(),tr=`
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 400; font-display: swap; src: url(${JSON.stringify(Xi)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 500; font-display: swap; src: url(${JSON.stringify(Yi)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 600; font-display: swap; src: url(${JSON.stringify(Ua)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 700; font-display: swap; src: url(${JSON.stringify(Ua)}) format('truetype'); }
`,nr=/^data:image\/svg\+xml/i,co=/\.svg($|[?#])/i,Ot=512,Un="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/B8AAusB9YwpClgAAAAASUVORK5CYII=",ar=96,sr=25.4,Qn=210,en=297,tn=Math.round(Qn/sr*ar),nn=Math.round(en/sr*ar);function Pe(e){const t=Number(e),n=Number.isFinite(t)?t:0;try{const a=Math.abs(n%1)>1e-9;return I(n.toLocaleString("en-US",{minimumFractionDigits:a?2:0,maximumFractionDigits:2}))}catch{return Number.isInteger(n)?I(String(n)):I(n.toFixed(2))}}let un=!1,mn=null;function rr(){un||(mn=async function(){try{if(!q||!K?.modal?.classList.contains("show")||(q.context||"reservation")!=="reservation")return;const n=q.reservation;if(!n)return;const a=[n.id,n.reservationId,n.reservation_id,n.reservationCode,n.reservation_code].map(l=>l==null?"":String(l)).filter(l=>l.length>0);if(!a.length)return;const s=vn(),r=(Array.isArray(s)?s:[]).find(l=>[l?.id,l?.reservationId,l?.reservation_id,l?.reservationCode,l?.reservation_code].map(p=>p==null?"":String(p)).filter(p=>p.length>0).some(p=>a.includes(p)));if(!r)return;const i=Aa(r),{totalsDisplay:o,totals:d,rentalDays:u}=vr(r,i,q.project);q.reservation=r,q.crewAssignments=i,q.totals=d,q.totalsDisplay=o,q.rentalDays=u,Pr(),pt()}catch(t){console.warn("[reservationPdf] live update failed",t)}},document.addEventListener("reservations:changed",mn),un=!0)}function ir(){if(un){try{document.removeEventListener("reservations:changed",mn)}catch{}mn=null,un=!1}}const or=2,cr=/safari/i,lo=/(iphone|ipad|ipod)/i,Ga=/(iphone|ipad|ipod)/i,uo=/(crios|fxios|edgios|opios)/i,pn="[reservations/pdf]";let K=null,q=null,tt=1,Rt=null,Mt=null,lt=null,kt=null,Vt=!1;function gt(e="render",{message:t,actionLabel:n,onAction:a,showSpinner:s=e!=="error"}={}){if(!K?.statusIndicator||!K?.statusText)return;K.statusKind=e;const r=t||Zs(e);K.statusText.textContent=r,K.statusSpinner&&(K.statusSpinner.hidden=!s),K.statusAction&&(K.statusAction.hidden=!0,K.statusAction.onclick=null,n&&typeof a=="function"&&(K.statusAction.textContent=n,K.statusAction.hidden=!1,K.statusAction.onclick=i=>{i.preventDefault(),a()})),K.statusIndicator.hidden=!1,requestAnimationFrame(()=>{K.statusIndicator.classList.add("is-visible")})}function Pt(e){try{return String(e||"").toLowerCase().normalize("NFKD").replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,"").replace(/\s+/g," ").trim()}catch{return String(e||"").trim().toLowerCase()}}function Kt(e){!K?.statusIndicator||!K?.statusText||(K.statusKind=null,K.statusIndicator.classList.remove("is-visible"),setTimeout(()=>{K?.statusIndicator&&(K.statusIndicator.hidden=!0,K.statusAction&&(K.statusAction.hidden=!0,K.statusAction.onclick=null),K.statusSpinner&&(K.statusSpinner.hidden=!1))},220))}function Gn(){return!!window?.bootstrap?.Modal}function mo(e){if(e&&!e.classList.contains("show")){e.classList.add("show"),e.style.display="block",e.removeAttribute("aria-hidden"),e.setAttribute("aria-modal","true"),e.getAttribute("role")||e.setAttribute("role","dialog"),document.body.classList.add("modal-open"),lt||(lt=document.createElement("div"),lt.className="modal-backdrop fade show",lt.dataset.quotePdfFallbackBackdrop="true",document.body.appendChild(lt)),kt||(kt=t=>{t.key==="Escape"&&Wn(e)},document.addEventListener("keydown",kt));try{e.focus({preventScroll:!0})}catch{}}}function Wn(e){if(!(!e||!e.classList.contains("show"))){try{const t=e.ownerDocument?.activeElement;if(t&&e.contains(t)){try{t.blur()}catch{}try{e.ownerDocument?.body?.focus({preventScroll:!0})}catch{}}}catch{}e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal"),document.body.classList.remove("modal-open"),lt&&(lt.remove(),lt=null),kt&&(document.removeEventListener("keydown",kt),kt=null);try{ir()}catch{}}}function po(e){if(e){if(Gn()){const t=window.bootstrap.Modal.getOrCreateInstance(e);try{const n=()=>{try{const a=document.activeElement;if(a&&e.contains(a)){try{a.blur()}catch{}try{document.body?.focus({preventScroll:!0})}catch{}}}catch{}try{ir()}catch{}try{e.removeEventListener("hidden.bs.modal",n)}catch{}};e.addEventListener("hidden.bs.modal",n,{once:!0}),e.addEventListener("hide.bs.modal",()=>{try{const a=document.activeElement;if(a&&e.contains(a))try{a.blur()}catch{}}catch{}})}catch{}t.show();return}mo(e)}}function fo(){if(Vt)return;Vt=!0;const e=c("reservations.quote.toast.viewGuide","📘 عرض دليل الحل السريع"),t=c("reservations.quote.toast.retry","إعادة المحاولة"),n=c("reservations.quote.toast.assetsFailed","⚠️ تعذر تحميل بعض الصور ضمن عرض سعر."),a=!!K?.modal?.classList.contains("show"),s=()=>{K?.modal?.classList.contains("show")&&(gt("render"),Vt=!1,pt())};is({message:n,duration:9e3,actionLabel:a?t:void 0,onAction:a?s:void 0,linkLabel:e,linkHref:Gs}),a&&gt("error",{message:n,actionLabel:t,onAction:s,showSpinner:!1})}function kn(e="reservation"){const t={},n=Js(e);return Object.entries(n).forEach(([a,s=[]])=>{t[a]=new Set(s.filter(r=>r?.default!==!1).map(r=>r.id))}),t}function va(e={}){const t={};return Object.entries(e).forEach(([n,a])=>{t[n]=new Set(Array.from(a||[]))}),t}function yo(e={},t){if(t)return e[t]||(e[t]=new Set),e[t]}function Sa(e={},t,n){const a=e?.[t];return a?a instanceof Set?a.has(n):Array.isArray(a)?a.includes(n):!!a?.[n]:!0}function wa(e="reservation"){return Object.fromEntries(An(e).map(({id:t})=>[t,!1]))}function Ea(e,t){return e.sectionExpansions||(e.sectionExpansions=wa(e.context||"reservation")),t&&typeof e.sectionExpansions[t]!="boolean"&&(e.sectionExpansions[t]=!1),e.sectionExpansions}function bo(e,t){return Ea(e,t)?.[t]!==!1}function qa(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches}function ho(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||navigator.platform||"";return lo.test(e)}function go(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=cr.test(e),n=e.includes("Chrome")||e.includes("CriOS")||e.includes("Chromium"),a=e.includes("Edg");return t&&!n&&!a}function lr(){return ho()&&go()}function Pn(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=navigator.platform||"",n=Number.isFinite(navigator.maxTouchPoints)?navigator.maxTouchPoints:0,a=Ga.test(e)||Ga.test(t),s=/Macintosh/i.test(e)&&n>1;return cr.test(e)&&!uo.test(e)&&(a||s)}function _n(e,...t){try{console.log(`${pn} ${e}`,...t)}catch{}}function rt(e,...t){try{console.warn(`${pn} ${e}`,...t)}catch{}}function vo(e,t,...n){try{t?console.error(`${pn} ${e}`,t,...n):console.error(`${pn} ${e}`,...n)}catch{}}function ke(e,{blockType:t="section",extraAttributes:n=""}={}){if(!e)return"";const a=n?` ${n.trim()}`:"";return e.replace(/^(<\w+)/,`$1 data-quote-block data-block-type="${t}"${a}`)}function So(e,t="لا توجد بيانات للعرض."){const n=b(c(e,t));return ke(`<section class="quote-section quote-placeholder">${n}</section>`,{blockType:"placeholder"})}function fn(e,t){return Array.isArray(e)&&e.length?e:[So(t)]}const wo=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;function dr(e=""){return wo.test(e)}function Eo(){const e=window.CanvasRenderingContext2D?.prototype;if(!e||e.__artRatioDirectionPatched)return;const t=n=>{const a=e[n];typeof a=="function"&&(e[n]=function(r,...i){if(typeof r!="string"||!dr(r))return a.call(this,r,...i);let o,d=!1;try{"direction"in this&&(o=this.direction,o!=="rtl"&&(this.direction="rtl"),d=!0)}catch{}try{if(!d){const u=this.canvas;u&&u.style?.direction!=="rtl"&&(u.__artRatioOriginalDirection=u.style.direction,u.style.direction="rtl")}return a.call(this,r,...i)}finally{if(d&&o!==void 0&&o!=="rtl")try{this.direction=o}catch{}else if(!d){const u=this.canvas;u&&u.__artRatioOriginalDirection!==void 0&&(u.style.direction=u.__artRatioOriginalDirection,delete u.__artRatioOriginalDirection)}}})};t("fillText"),t("strokeText"),e.__artRatioDirectionPatched=!0}function Wa(e,t=Ot){if(typeof e!="string"&&typeof e!="number")return t;const n=parseFloat(String(e).replace(/[^0-9.+-]/g,""));return Number.isFinite(n)&&n>0?n:t}function qo(e){if(!e)return{width:Ot,height:Ot};const t=e.getAttribute?.("width"),n=e.getAttribute?.("height");let a=t?Wa(t,0):0,s=n?Wa(n,0):0;if(a>0&&s>0)return{width:a,height:s};const r=e.getAttribute?.("viewBox");if(r){const i=r.trim().split(/[\s,]+/).map(o=>parseFloat(o||"0"));if(i.length>=4){const[,,o,d]=i;a=a||(Number.isFinite(o)&&o>0?o:0),s=s||(Number.isFinite(d)&&d>0?d:0)}}return{width:a||Ot,height:s||Ot}}function ur(e=""){return typeof e!="string"?!1:nr.test(e)||co.test(e)}function Io(e=""){const t=e.indexOf(",");if(t===-1)return"";const n=e.slice(0,t),a=e.slice(t+1);try{return/;base64/i.test(n)?typeof atob=="function"?atob(a):"":decodeURIComponent(a)}catch(s){return console.warn("[reservations/pdf] failed to decode SVG data URI",s),""}}function Ao(e,{crossOrigin:t}={}){return new Promise((n,a)=>{const s=new Image;t&&(s.crossOrigin=t),s.onload=()=>n(s),s.onerror=r=>{const i=r?.message||`Unable to load image from ${e}`;a(new Error(i))},s.src=e})}async function mr(e,t={}){if(!e)return null;const n=document,a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a);try{const r=await Ao(s),i=n.createElement("canvas"),o=Math.max(t.width||r.naturalWidth||r.width||0,1),d=Math.max(t.height||r.naturalHeight||r.height||o,1);i.width=o,i.height=d;const u=i.getContext("2d");return u.clearRect(0,0,o,d),u.drawImage(r,0,0,o,d),i.toDataURL("image/png")}catch(r){return console.warn("[reservations/pdf] failed to rasterize SVG content",r),null}finally{URL.revokeObjectURL(s)}}async function ko(e){if(!e)return null;if(nr.test(e))return Io(e);try{const t=await fetch(e,{mode:"cors",credentials:"omit",cache:"default"});return t.ok?await t.text():(console.warn("[reservations/pdf] failed to fetch SVG image",e,t.status),null)}catch(t){return console.warn("[reservations/pdf] error fetching SVG image",e,t),null}}async function Po(e){if(!e)return!1;const t=e.getAttribute?.("src")||"";if(!ur(t))return!1;const n=await ko(t);if(!n)return e.dataset.svgRasterization="failed",e.setAttribute("src",Un),!1;const a=await mr(n);return a?(e.dataset.svgOriginalSrc=t,e.setAttribute("src",a),e.setAttribute("data-rasterized","true"),!0):(e.dataset.svgRasterization="failed",e.setAttribute("src",Un),!1)}async function xo(e){if(!e||e.tagName?.toLowerCase()!=="svg")return!1;const n=new XMLSerializer().serializeToString(e),a=qo(e),s=await mr(n,a),i=(e.ownerDocument||document).createElement("img");i.setAttribute("src",s||Un),i.setAttribute("alt",e.getAttribute("aria-label")||e.getAttribute("title")||""),i.setAttribute("data-svg-replaced","true"),e.hasAttribute("class")&&i.setAttribute("class",e.getAttribute("class")),e.hasAttribute("style")&&i.setAttribute("style",e.getAttribute("style"));const o=e.getAttribute("width"),d=e.getAttribute("height");return o&&i.setAttribute("width",o),d&&i.setAttribute("height",d),e.parentNode?.replaceChild(i,e),!!s}async function pr(e){if(!e)return;const t=Array.from(e.querySelectorAll?.("img")||[]),n=Array.from(e.querySelectorAll?.("svg")||[]),a=[];t.forEach(s=>{ur(s.getAttribute?.("src"))&&a.push(Po(s))}),n.forEach(s=>{a.push(xo(s))}),a.length&&await Promise.allSettled(a)}function $o(e,{pixelRatio:t=1}={}){if(!e)return null;const n=e.ownerDocument||document,s=(n.defaultView||window).getComputedStyle?.(e);if(!s)return null;const r=(F,X=0)=>{const R=parseFloat(F);return Number.isFinite(R)?R:X},i=r(s.paddingTop),o=r(s.paddingBottom),d=r(s.paddingRight),u=r(s.paddingLeft),l=r(s.borderRadius),y=r(s.fontSize,14),p=(()=>{const F=s.lineHeight;if(!F||F==="normal")return y*1.6;const X=r(F,y*1.6);return X>0?X:y*1.6})(),m=Math.max(e.clientWidth||0,e.scrollWidth||0,r(s.width,0));if(m<=0)return null;const f=Math.max(1,m-u-d),h=e.textContent||"",v=h.split(/\r?\n/),j=n.createElement("canvas"),g=j.getContext("2d");if(!g)return null;const C=s.fontStyle||"normal",k=s.fontVariant||"normal",H=s.fontWeight||"400",S=s.fontFamily||"sans-serif",A=s.fontStretch||"normal",L=F=>F.join(" "),T=[],W=F=>g.measureText(F).width;g.font=`${C} ${k} ${H} ${A} ${y}px ${S}`,v.forEach(F=>{const X=F.trim();if(X.length===0){T.push("");return}const R=X.split(/\s+/);let ce=[];R.forEach((te,be)=>{const he=te.trim();if(!he)return;const qe=L(ce.concat(he));if(W(qe)<=f||ce.length===0){ce.push(he);return}T.push(L(ce)),ce=[he]}),ce.length&&T.push(L(ce))}),T.length||T.push("");const $=i+o+T.length*p,B=Math.ceil(Math.max(1,m)*t),V=Math.ceil(Math.max(1,$)*t);j.width=B,j.height=V,j.style.width=`${Math.max(1,m)}px`,j.style.height=`${Math.max(1,$)}px`,g.scale(t,t);const _=s.backgroundColor&&s.backgroundColor!=="rgba(0, 0, 0, 0)"?s.backgroundColor:"#ffffff";if(l>0){g.save(),g.beginPath();const F=Math.max(1,m),X=Math.max(1,$),R=Math.min(l,F/2,X/2);g.moveTo(R,0),g.lineTo(F-R,0),g.quadraticCurveTo(F,0,F,R),g.lineTo(F,X-R),g.quadraticCurveTo(F,X,F-R,X),g.lineTo(R,X),g.quadraticCurveTo(0,X,0,X-R),g.lineTo(0,R),g.quadraticCurveTo(0,0,R,0),g.closePath(),g.clip()}if(g.fillStyle=_,g.fillRect(0,0,Math.max(1,m),Math.max(1,$)),g.font=`${C} ${k} ${H} ${A} ${y}px ${S}`,g.fillStyle=s.color||"#000000",g.textBaseline="top",g.textAlign="right","direction"in g)try{g.direction="rtl"}catch{}const N=Math.max(0,m-d);let D=i;T.forEach(F=>{const X=F.length?F:" ";g.fillText(X,N,D,f),D+=p});const J=n.createElement("img");let Q;try{Q=j.toDataURL("image/png")}catch(F){return rt("note canvas toDataURL failed",F),null}return J.src=Q,J.alt=h,J.style.width=`${Math.max(1,m)}px`,J.style.height=`${Math.max(1,$)}px`,J.style.display="block",J.setAttribute("data-quote-note-image","true"),{image:J,canvas:j,totalHeight:$,width:m}}function jo(e,{pixelRatio:t=1}={}){if(!e||!Pn())return;Array.from(e.querySelectorAll?.(".quote-notes")||[]).forEach(a=>{if(!a||a.dataset.quoteNoteRasterized==="true"||!dr(a.textContent||""))return;let s;try{s=$o(a,{pixelRatio:t})}catch(r){rt("failed to rasterize note content",r),s=null}s&&(a.dataset.quoteNoteRasterized="true",a.innerHTML="",a.appendChild(s.image))})}function Jn(e,t="export",{toastMessage:n,suppressToast:a=!1}={}){vo(`${t} failed`,e);const s=!!(e&&e.__artRatioPdfNotified);if(!a&&!s){const r=c("reservations.quote.errors.exportFailed","⚠️ تعذر إنشاء ملف PDF، يرجى المحاولة مرة أخرى."),i=n||r,o=c("reservations.quote.toast.viewGuide","📘 عرض دليل الحل السريع"),d=c("reservations.quote.toast.retry","إعادة المحاولة"),u=["exportQuoteAsPdf","renderQuotePreview","layoutQuoteDocument","pageCapture"].includes(t),l=()=>{t==="exportQuoteAsPdf"?(gt("export"),xr()):(gt("render"),Vt=!1,pt())};if(is({message:i,duration:9e3,actionLabel:u?d:void 0,onAction:u?l:void 0,linkLabel:o,linkHref:Gs}),K?.modal?.classList.contains("show")&&gt("error",{message:i,actionLabel:u?d:void 0,onAction:u?l:void 0,showSpinner:!1}),e&&typeof e=="object")try{Object.defineProperty(e,"__artRatioPdfNotified",{value:!0,writable:!1,enumerable:!1,configurable:!0})}catch{}}}function Xn({container:e,safariWindowRef:t,mobileWindowRef:n}={}){try{n&&!n.closed&&n.close()}catch(a){rt("failed to close mobile window",a)}try{t&&!t.closed&&t.close()}catch(a){rt("failed to close safari window",a)}e&&e.parentNode&&e.parentNode.removeChild(e)}function Ia(e){return new Promise((t,n)=>{const a=document.querySelector(`script[src="${e}"]`);if(a){a.addEventListener("load",()=>t()),a.addEventListener("error",r=>n(r)),a.readyState==="complete"&&t();return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>t(),s.onerror=r=>n(r),document.head.appendChild(s)})}function Ja(){const e=[window.jspdf?.jsPDF,typeof window.jspdf=="function"?window.jspdf:null,window.jsPDF?.jsPDF,typeof window.jsPDF=="function"?window.jsPDF:null].filter(t=>typeof t=="function");return e.length?e[0]:null}function Xa(){return typeof window.html2canvas=="function"?window.html2canvas:null}async function Co(){const e=Xa();return e||(Mt||(Mt=Ia(io).catch(t=>{throw Mt=null,t}).then(()=>{const t=Xa();if(!t)throw Mt=null,new Error("تعذر تحميل مكتبة html2canvas المطلوبة.");return t})),Mt)}async function _o(){const e=Ja();return e||(Rt||(Rt=Ia(oo).catch(t=>{throw Rt=null,t}).then(()=>{const t=Ja();if(!t)throw Rt=null,new Error("تعذر تحميل مكتبة jsPDF المطلوبة.");return t})),Rt)}async function To(){if(window.html2pdf||await Ia(ro),window.html2pdf&&!window.html2pdf.__artRatioConfigured){const e=window.html2pdf.defaultOptions||window.html2pdf.defaultOpt||{},t={...e.html2canvas||{}};t.useCORS=!0,t.allowTaint=!1,t.logging=!0;const n={unit:"mm",format:"a4",orientation:"portrait",compress:!0,...e.jsPDF||{}},a={image:{type:"jpeg",quality:.95,...e.image||{}},margin:e.margin??[0,0,0,0],filename:e.filename||"document.pdf",html2canvas:t,jsPDF:n};window.html2pdf.defaultOptions=a,window.html2pdf.defaultOpt=a,window.html2pdf.__artRatioConfigured=!0}hi(),Eo()}function b(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function No(e="reservation"){return e==="project"?"QP":"Q"}function Lo(e,t="reservation"){const n=Number(e),a=No(t);return!Number.isFinite(n)||n<=0?`${a}-0001`:`${a}-${String(n).padStart(4,"0")}`}function Bo(){const e=window.localStorage?.getItem?.(Qs),t=parseInt(e??"",10);return Number.isFinite(t)&&t>0?t:0}function fr(e="reservation"){const n=Bo()+1;return{sequence:n,quoteNumber:Lo(n,e)}}function Do(e){try{const t=Number(e);if(!Number.isFinite(t)||t<=0)return;window.localStorage?.setItem?.(Qs,String(t))}catch(t){console.warn("⚠️ [reservations/pdf] failed to persist quote sequence",t)}}function yr(e="reservation"){return Qa[e]||Qa.reservation}function Fo(e="reservation"){try{const t=yr(e),n=window.localStorage?.getItem?.(t);if(!n)return null;const a=JSON.parse(n);return a&&typeof a=="object"?a:null}catch(t){return console.warn("⚠️ [reservations/pdf] failed to read toggle preferences",t),null}}function Ro(e,t="reservation"){try{const n=yr(t);if(!e){window.localStorage?.removeItem?.(n);return}window.localStorage?.setItem?.(n,JSON.stringify(e))}catch(n){console.warn("⚠️ [reservations/pdf] failed to persist toggle preferences",n)}}function Mo(e){if(!e)return{ids:null,emptyExplicitly:!1};if(e instanceof Set)return{ids:Array.from(e),emptyExplicitly:e.size===0};if(Array.isArray(e))return{ids:e.slice(),emptyExplicitly:e.length===0};if(typeof e=="object"){const t=Object.entries(e).filter(([,n])=>!!n);return{ids:t.map(([n])=>n),emptyExplicitly:t.length===0}}return{ids:null,emptyExplicitly:!1}}function Ho(e,t="reservation"){if(!e)return null;const n=Xs(t),a=Ys(t),s=Array.from(e.sections instanceof Set?e.sections:new Set(e.sections||[])).filter(o=>n.has(o)),r={},i=e.fields||{};return Object.entries(a).forEach(([o,d])=>{const u=i[o];if(u==null)return;const{ids:l,emptyExplicitly:y}=Mo(u);if(!l&&!y)return;const p=Array.isArray(l)?l.filter(m=>d.has(m)):[];(p.length>0||y)&&(r[o]=p)}),{version:1,sections:s,fields:r}}function br(e){if(!e)return;const t=e.context||"reservation",n=Ho(e,t);n&&Ro(n,t)}function hr(e){if(!e)return;const t=e.context||"reservation",n=Fo(t);if(!n)return;const a=Xs(t),s=Array.isArray(n.sections)?n.sections.filter(r=>a.has(r)):[];if(s.length&&(e.sections=new Set(s)),n.fields&&typeof n.fields=="object"){const r=va(e.fields||kn(t)),i=Ys(t);Object.entries(n.fields).forEach(([o,d])=>{const u=i[o];if(!u)return;const l=Array.isArray(d)?d.filter(y=>u.has(y)):[];r[o]=new Set(l)}),e.fields=r}}function gr(e=new Date){try{return e.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return e.toISOString().slice(0,10)}}function Aa(e){const t=jt()||[],{technicians:n=[]}=Se(),a=[].concat(Array.isArray(t)?t:[]).concat(Array.isArray(n)?n:[]),s=new Map;return a.forEach(i=>{if(!i||i.id==null)return;const o=String(i.id),d=s.get(o)||{};s.set(o,{...d,...i})}),(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(i=>({technicianId:i}))).map((i,o)=>{const d=i?.technicianId!=null?s.get(String(i.technicianId)):null;let u=i.positionLabel??i.position_name??i.position_label??i.role??i.position??d?.role??c("reservations.crew.positionFallback","منصب بدون اسم");(!u||u.trim()==="")&&(u=i.positionLabelAr??i.position_label_ar??i.positionLabelEn??i.position_label_en??i.position_name_ar??i.position_name_en??d?.role??c("reservations.crew.positionFallback","منصب بدون اسم"));try{const p=typeof La=="function"?La()||[]:[];let m=null;if(i?.positionId!=null&&(m=p.find(f=>String(f?.id)===String(i.positionId))||null),!m){const f=i.positionKey??i.position_key??i.positionName??i.position_name??i.position??"";if(f&&(m=typeof Ba=="function"&&Ba(f)||null,!m&&p.length)){const h=String(f).trim().toLowerCase();m=p.find(v=>[v.name,v.labelAr,v.labelEn].filter(Boolean).map(j=>String(j).toLowerCase()).includes(h))||null}}if(m){const f=m.labelAr||m.labelEn||m.name||"";f&&f.trim()&&(u=f)}}catch{}const l=St($t(i.positionCost??i.position_cost??i.cost??i.daily_wage??i.dailyWage??d?.dailyWage??d?.wage??0)),y=St($t(i.positionClientPrice??i.position_client_price??i.client_price??i.clientPrice??i.daily_total??i.dailyTotal??i.total??d?.dailyTotal??d?.total??d?.total_wage??0));return{assignmentId:i.assignmentId??i.assignment_id??`crew-${o}`,positionId:i.positionId??i.position_id??null,positionLabel:u,positionLabelAlt:i.positionLabelAlt??i.position_label_alt??"",positionCost:l,positionClientPrice:y,technicianId:i.technicianId!=null?String(i.technicianId):d?.id!=null?String(d.id):null,technicianName:i.technicianName??i.technician_name??d?.name??null,technicianRole:i.technicianRole??d?.role??null}})}function vr(e,t,n){const{projectLinked:a}=Lt(e,n);oa(e.start,e.end);const s=e.discount??e.discountValue??0,r=Number(I(String(s)))||0,i=e.discountType??e.discount_type??"percent",o=String(i).toLowerCase()==="amount"?"amount":"percent",d=a?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),u=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,l=u!=null?$t(u):Number.NaN,p=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied)===!0&&Number.isFinite(l)&&l>0?l:null,m=Array.isArray(t)?t.map(k=>k?.technicianId).filter(Boolean):[],f=ms({items:Array.isArray(e.items)?e.items:[],technicianIds:m,crewAssignments:Array.isArray(t)?t:[],discount:r,discountType:o,applyTax:d,start:e.start,end:e.end,companySharePercent:p,groupingSource:e}),h=$t(e.cost??e.total??e.finalTotal),v=Number.isFinite(h),j=a?f.finalTotal:v?St(h):f.finalTotal,g={equipmentTotal:f.equipmentTotal,crewTotal:f.crewTotal,crewCostTotal:f.crewCostTotal,discountAmount:f.discountAmount,subtotalAfterDiscount:f.subtotalAfterDiscount,taxableAmount:f.taxableAmount,taxAmount:f.taxAmount,finalTotal:j,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,netProfit:f.netProfit},C={equipmentTotal:Pe(f.equipmentTotal),crewTotal:Pe(f.crewTotal),discountAmount:Pe(f.discountAmount),subtotalAfterDiscount:Pe(f.subtotalAfterDiscount),taxableAmount:Pe(f.taxableAmount),taxAmount:Pe(f.taxAmount),finalTotal:Pe(j),companySharePercent:I((Number.isFinite(f.companySharePercent)?f.companySharePercent:0).toFixed(2)),companyShareAmount:Pe(f.companyShareAmount),netProfit:I(f.netProfit.toFixed(2))};return{totals:g,totalsDisplay:C,rentalDays:f.rentalDays}}function Tt(e){if(e==null||e==="")return null;const t=Number.parseFloat(I(String(e)));return Number.isFinite(t)?t:null}function Sr(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function Oo(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n!=="percent"&&(n="amount");const a=Tt(e.amount??(n==="amount"?e.value:null)),s=Tt(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,i=e.note??e.memo??null,o=Sr(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:i,recordedAt:o}}function zo(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(Oo).filter(Boolean);if(n.length>0)return n;const a=Tt(e.paidPercent??e.paid_percent),s=Tt(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,i=Sr(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:i}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:i}]:[]}function Vo(e){if(!e)return c("projects.form.types.unknown","نوع غير محدد");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function Ko(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function Uo(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function Qo(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(I(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],i=r.length?r:Array.isArray(e.technicians)?e.technicians:[],o=sa(t,a,s,!1,i,{start:e.start,end:e.end,companySharePercent:0});if(Number.isFinite(o))return o;const d=Number(I(String(e.cost??0)));return Number.isFinite(d)?Math.round(d):0}function Go(e,t){if(!e)return"—";const n=it(e);return t?`${n} - ${it(t)}`:n}function fe(e,t="SR",n=2){const a=Number(e);return`${Pe(a)} ${t}`}function Ya(e,t=2){if(!Number.isFinite(Number(e)))return"0%";const n=Number.isInteger(t)?t:2;return`${I(Number(e).toFixed(n))}%`}function Wo(e){if(!e?.start)return null;if(!e?.end)return 1;const t=oa(e.start,e.end);return Number.isFinite(t)?t:1}function Jo(e){return Number.isFinite(e)?e<=1?"يوم واحد":`${I(String(Math.round(e)))} أيام`:"غير محدد"}function Za(e){const t=c("reservations.create.summary.currency","SR"),n=Se()||{},a=Array.isArray(n.customers)?n.customers:[],s=Array.isArray(n.projects)?n.projects:[],r=Array.isArray(n.technicians)?n.technicians:[];let i=[];try{const x=vn?.()||[];i=Array.isArray(x)&&x.length?x:n.reservations||[]}catch{i=n.reservations||[]}const o=e?.id!=null?s.find(x=>String(x.id)===String(e.id))||e:e||null,d={projectStatusLabel:c("projects.status.ongoing","قيد التنفيذ"),paymentStatusLabel:c("projects.paymentStatus.unpaid","غير مدفوع")};if(!o)return{project:null,customer:null,clientInfo:{name:"-",company:"-",phone:"-",email:"-"},projectInfo:{title:"-",code:"-",typeLabel:"-",startDisplay:"-",endDisplay:"-",durationLabel:"-",statusLabel:d.projectStatusLabel},expenses:[],equipment:[],reservations:[],totals:{equipmentEstimate:0,expensesTotal:0,baseSubtotal:0,discountAmount:0,subtotalAfterDiscount:0,companyShareAmount:0,subtotal:0,applyTax:!1,taxAmount:0,totalWithTax:0},totalsDisplay:{projectSubtotal:fe(0,t),expensesTotal:fe(0,t),reservationsTotal:fe(0,t),discountAmount:fe(0,t),taxAmount:fe(0,t),overallTotal:fe(0,t),paidAmount:fe(0,t),remainingAmount:fe(0,t)},projectTotals:{combinedTaxAmount:0,overallTotal:0,reservationsTotal:0,paidAmount:0,paidPercent:0,remainingAmount:0,paymentStatus:"unpaid"},paymentSummary:{status:"unpaid",statusLabel:d.paymentStatusLabel,paidAmount:0,paidPercent:0,remainingAmount:0,paidAmountDisplay:fe(0,t),remainingAmountDisplay:fe(0,t),paidPercentDisplay:Ya(0)},notes:"",currencyLabel:t,projectStatus:"ongoing",projectStatusLabel:d.projectStatusLabel,projectDurationDays:null,projectDurationLabel:"غير محدد",paymentHistory:[]};const u=o.clientId??o.customerId??o.client_id??o.customer_id??null,l=u!=null&&a.find(x=>String(x.id)===String(u))||null,y=l?.customerName??l?.name??o.clientName??o.customerName??c("projects.fallback.unknownClient","عميل غير معروف"),p=(o.clientCompany||l?.companyName||l?.company||"").trim(),m=l?.phone??l?.customerPhone??o.clientPhone??o.customerPhone??"",f=m?I(String(m).trim()):c("projects.details.client.noPhone","لا يوجد رقم متاح"),h=l?.email??o.clientEmail??o.customerEmail??"",v=h?String(h).trim():c("projects.details.client.noEmail","لا يوجد بريد متاح"),j=o.projectCode||`PRJ-${I(String(o.id??""))}`,g=I(String(j)),C=(o.title||"").trim()||c("projects.fallback.untitled","مشروع بدون عنوان"),k=Vo(o.type),H=o.start?it(o.start):"—",S=o.end?it(o.end):"—",A=Wo(o),L=A!=null?Jo(A):"غير محدد",T=Ko(o),W={upcoming:"قادم",ongoing:"قيد التنفيذ",completed:"مكتمل"},$=c(`projects.status.${T}`,W[T]||T),B=o.id!=null?String(o.id):null,V=B?i.filter(x=>{const pe=x?.projectId??x?.project_id??null;return pe!=null&&String(pe)===B}):[];V.map(x=>{const pe=x.reservationId||x.id||"",U=x.status||x.state||"pending",we=String(U).toLowerCase(),ve=c(`reservations.status.${we}`,we),$e=Qo(x),E=x.start?new Date(x.start).getTime():0;return{reservationId:I(String(pe||"-")),status:we,statusLabel:ve,total:$e,totalLabel:fe($e,t),dateRange:Go(x.start,x.end),startTimestamp:Number.isNaN(E)?0:E}}).sort((x,pe)=>pe.startTimestamp-x.startTimestamp).map(({startTimestamp:x,...pe})=>pe);let _=0,N=0;try{V.forEach(x=>{const pe=ms({items:Array.isArray(x.items)?x.items:[],technicianIds:Array.isArray(x.technicians)?x.technicians:[],crewAssignments:Array.isArray(x.crewAssignments)?x.crewAssignments:[],discount:Number(x.discount??0)||0,discountType:x.discountType||"percent",applyTax:!1,start:x.start,end:x.end,groupingSource:x,companySharePercent:0});_+=Number(pe.equipmentTotal||0),N+=Number(pe.crewTotal||0)})}catch{}const D=Uo(o),J=Number(_+N+D),Q=[];try{V.forEach(x=>{const{groups:pe}=Bt(x);pe.forEach(U=>{const we=Number(U?.count??U?.quantity??1)||1,ve=Number(U?.unitPrice);let $e=Number.isFinite(ve)?ve:0;if(!$e||$e<=0){const ee=Number(U?.totalPrice);Number.isFinite(ee)&&we>0&&($e=Number((ee/we).toFixed(2)))}Number.isFinite($e)||($e=0);const E=U?.type==="package"||Array.isArray(U?.items)&&U.items.some(ee=>ee?.type==="package"),Z=Array.isArray(U?.barcodes)&&U.barcodes.length?U.barcodes[0]:Array.isArray(U?.items)&&U.items.length?U.items[0]?.barcode:null;let ne=U?.packageDisplayCode??U?.package_code??U?.code??U?.packageCode??(Array.isArray(U?.items)&&U.items.length?U.items[0]?.package_code??U.items[0]?.code??U.items[0]?.packageCode:null);const Ee=ee=>{const ue=(ee==null?"":String(ee)).trim();return!!(!ue||/^pkg-/i.test(ue)||/^\d+$/.test(ue)&&ue.length<=4)};if(!ne||Ee(ne)){const ee=U?.packageId??U?.package_id??(Array.isArray(U?.items)&&U.items.length?U.items[0]?.packageId??U.items[0]?.package_id:null);if(ee)try{const ue=ua(ee);ue&&ue.package_code&&(ne=ue.package_code)}catch{}}if(!ne||Ee(ne))try{const ee=Pt(U?.description||"");if(ee){const ue=Ss();let le=ue.find(oe=>Pt(oe?.name||oe?.title||oe?.label||"")===ee);le||(le=ue.find(oe=>{const de=Pt(oe?.name||oe?.title||oe?.label||"");return de.includes(ee)||ee.includes(de)})),le&&le.package_code&&(ne=le.package_code)}}catch{}const Re=E?ne??Z??"":U?.barcode??Z??"",Je=Re!=null?String(Re):"",Ne=Number.isFinite(Number(U?.totalPrice))?Number(U.totalPrice):Number(($e*we).toFixed(2));Q.push({...U,isPackage:E,desc:U?.description,barcode:Je,packageCodeResolved:ne||"",qty:we,price:$e,totalPrice:St(Ne),unitPriceValue:$e})})})}catch{}const F=new Map;V.forEach(x=>{const pe=Array.isArray(x.items)?x.items:[],U=oa(x.start,x.end),we=x.reservationId||x.id||"";pe.forEach((ve,$e)=>{if(!ve)return;const E=ve.barcode||ve.code||ve.id||ve.desc||ve.description||`item-${$e}`,Z=String(E||`item-${$e}`),ne=F.get(Z)||{description:ve.desc||ve.description||ve.name||ve.barcode||`#${I(String($e+1))}`,totalQuantity:0,reservationsCount:0,reservationIds:new Set,totalCost:0},Ee=Number(ve.qty)||1,Re=Number(ve.price)||0;ne.totalQuantity+=Ee,ne.reservationIds.add(String(we));const Je=Re*Ee*Math.max(1,U);Number.isFinite(Je)&&(ne.totalCost+=Je),F.set(Z,ne)})});const X=Array.from(F.values()).map(x=>({description:x.description,totalQuantity:x.totalQuantity,reservationsCount:x.reservationIds.size,displayCost:fe(x.totalCost,t)})),R=new Map((r||[]).filter(Boolean).map(x=>[String(x.id),x])),ce=new Map,te=x=>{if(!x)return;let pe=null;typeof x=="object"?pe=x.id??x.technicianId??x.technician_id??x.userId??x.user_id??null:(typeof x=="string"||typeof x=="number")&&(pe=x);const U=pe!=null?String(pe):null,we=U&&R.has(U)?R.get(U):typeof x=="object"?x:null,ve=we?.name||we?.full_name||we?.fullName||we?.displayName||(typeof x=="string"?x:null),$e=we?.role||we?.title||null,E=we?.phone||we?.mobile||we?.contact||null;if(!ve&&!U)return;const Z=U||ve;ce.has(Z)||ce.set(Z,{id:U,name:ve||"-",role:$e||null,phone:E||null})};Array.isArray(o?.technicians)&&o.technicians.forEach(x=>te(x)),V.forEach(x=>{(Array.isArray(x.crewAssignments)&&x.crewAssignments.length?x.crewAssignments:Array.isArray(x.technicians)?x.technicians.map(U=>({technicianId:U})):[]).forEach(U=>te(U))});const be=Array.from(ce.values()),he=Array.isArray(o.expenses)?o.expenses.map(x=>{const pe=Number(x?.amount)||0;return{label:x?.label||x?.name||"-",amount:pe,displayAmount:fe(pe,t),note:x?.note||x?.description||""}}):[],qe=o?.applyTax===!0||o?.applyTax==="true",je=Number.parseFloat(o?.discount??o?.discountValue??0)||0;let O=(o?.discountType==="amount"?"amount":"percent")==="amount"?je:J*(je/100);(!Number.isFinite(O)||O<0)&&(O=0),O>J&&(O=J);const ie=Math.max(0,J-O),Be=o?.companyShareEnabled===!0||o?.company_share_enabled===!0||o?.companyShareApplied===!0||o?.company_share_applied===!0,De=Number.parseFloat(o?.companySharePercent??o?.company_share_percent??o?.companyShare??o?.company_share??0)||0,Oe=Be&&De>0?De:0,Fe=Oe>0?Number((ie*(Oe/100)).toFixed(2)):0,ge=Number((ie+Fe).toFixed(2)),Ae=qe?Number((ge*fi).toFixed(2)):0,Ce=Number((ge+Ae).toFixed(2)),Te=zo(o),ze=Tt(o.paidAmount??o.paid_amount)||0,M=Tt(o.paidPercent??o.paid_percent)||0,w=ra({totalAmount:Ce,paidAmount:ze,paidPercent:M,history:Te}),z=typeof o.paymentStatus=="string"?o.paymentStatus.toLowerCase():"",G=ia({manualStatus:z,paidAmount:w.paidAmount,paidPercent:w.paidPercent,totalAmount:Ce}),se={paid:"مدفوع",partial:"مدفوع جزئياً",unpaid:"غير مدفوع"},ae=c(`projects.paymentStatus.${G}`,se[G]||G),Y=Number(w.paidAmount||0),me=Number(w.paidPercent||0),xe=Math.max(0,Number((Ce-Y).toFixed(2))),Ze={projectSubtotal:fe(ge,t),expensesTotal:fe(D,t),reservationsTotal:fe(ge,t),discountAmount:fe(O,t),taxAmount:fe(Ae,t),overallTotal:fe(Ce,t),paidAmount:fe(Y,t),remainingAmount:fe(xe,t)},Ve={status:G,statusLabel:ae,paidAmount:Y,paidPercent:me,remainingAmount:xe,paidAmountDisplay:fe(Y,t),remainingAmountDisplay:fe(xe,t),paidPercentDisplay:Ya(me)},Ft=(o.description||"").trim();return{project:o,customer:l,clientInfo:{name:y,company:p||"—",phone:f,email:v},projectInfo:{title:C,code:g,typeLabel:k,startDisplay:H,endDisplay:S,durationLabel:L,statusLabel:$},expenses:he,equipment:X,crew:be,equipmentItems:Q,crewAssignments:V.flatMap(x=>Aa(x)),totals:{equipmentEstimate:_,expensesTotal:D,baseSubtotal:J,discountAmount:O,subtotalAfterDiscount:ie,companyShareAmount:Fe,subtotal:ge,applyTax:qe,taxAmount:Ae,totalWithTax:Ce},totalsDisplay:Ze,projectTotals:{combinedTaxAmount:Ae,overallTotal:Ce,reservationsTotal:ge,paidAmount:Y,paidPercent:me,remainingAmount:xe,paymentStatus:G},paymentSummary:Ve,notes:Ft,currencyLabel:t,projectStatus:T,projectStatusLabel:$,projectDurationDays:A,projectDurationLabel:L,paymentHistory:Te}}function Xo({project:e,clientInfo:t={},projectInfo:n={},projectCrew:a=[],projectExpenses:s=[],projectEquipment:r=[],totalsDisplay:i={},projectTotals:o={},paymentSummary:d={},currencyLabel:u="SR",sections:l,fieldSelections:y={},quoteNumber:p,quoteDate:m,terms:f=He}){const h=va(y),v=(w,z)=>Sa(h,w,z),j=w=>l?.has?.(w),g=`<div class="quote-placeholder">${b(c("reservations.quote.placeholder.noFields","لم يتم اختيار أي معلومات للعرض في هذا القسم."))}</div>`,C=(w,z)=>`<div class="info-plain__item">
      <span class="info-plain__label">${b(w)}</span>
      <span class="info-plain__separator">:</span>
      <span class="info-plain__value">${b(z)}</span>
    </div>`,k=(w,z,{variant:G="inline"}={})=>G==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${b(w)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${b(z)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${b(w)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${b(z)}</span>
    </span>`,H=(w,z)=>`<div class="payment-row">
      <span class="payment-row__label">${b(w)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${b(z)}</span>
    </div>`,S=[];v("customerInfo","customerName")&&S.push(C(c("projects.details.client","العميل"),t.name||"-")),v("customerInfo","customerCompany")&&S.push(C(c("projects.details.company","شركة العميل"),t.company||"—")),v("customerInfo","customerPhone")&&S.push(C(c("projects.details.labels.clientPhone","رقم العميل"),t.phone||"-")),v("customerInfo","customerEmail")&&S.push(C(c("projects.details.labels.clientEmail","البريد الإلكتروني"),t.email||"-"));const A=j("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${b(c("projects.quote.sections.customer","بيانات العميل"))}</h3>
        ${S.length?`<div class="info-plain">${S.join("")}</div>`:g}
      </section>`:"",L=[];v("projectInfo","projectType")&&L.push(C(c("projects.details.type","نوع المشروع"),n.typeLabel||"-")),v("projectInfo","projectTitle")&&L.push(C(c("projects.details.projectTitle","اسم المشروع"),n.title||"-")),v("projectInfo","projectCode")&&L.push(C(c("projects.details.labels.code","رقم المشروع"),n.code||"-")),v("projectInfo","projectStart")&&L.push(C(c("projects.details.start","بداية المشروع"),n.startDisplay||"-")),v("projectInfo","projectEnd")&&L.push(C(c("projects.details.end","نهاية المشروع"),n.endDisplay||"-")),v("projectInfo","projectDuration")&&L.push(C(c("projects.details.duration","مدة المشروع"),n.durationLabel||"-")),v("projectInfo","projectStatus")&&L.push(C(c("projects.details.status","حالة المشروع"),n.statusLabel||"-"));const T=j("projectInfo")?`<section class="quote-section quote-section--plain quote-section--project">
        <h3 class="quote-section__title">${b(c("projects.quote.sections.project","بيانات المشروع"))}</h3>
        ${L.length?`<div class="info-plain">${L.join("")}</div>`:g}
      </section>`:"",W=qn.filter(w=>v("projectCrew",w.id)),$=Array.isArray(q?.crewAssignments)?q.crewAssignments:[],B=w=>{const z=w&&w.positionId!=null?`id:${String(w.positionId)}`:(()=>{const ae=(w?.positionLabel||w?.position_name||w?.position||"").trim().toLowerCase();return ae?`label:${ae}`:""})(),G=Number.isFinite(Number(w?.positionClientPrice))?Number(w.positionClientPrice):0,se=G>0?`|p:${G.toFixed(2)}`:"";return`${z}${se}`};(()=>{const w=new Map;return $.forEach(z=>{const G=B(z);G&&w.set(G,(w.get(G)||0)+1)}),w})();const V=(()=>{const w=[];if(W.forEach(Y=>{Y.id==="position"?(w.push({...Y,render:me=>{const xe=me?.positionLabel??me?.position_name??me?.role??c("reservations.crew.positionFallback","منصب بدون اسم");return b(I(String(xe)))}}),v("projectCrew","quantity")&&w.push({id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:me=>b(I(String(Math.max(1,Number(me?.__count||1)))))})):Y.id==="price"?w.push({...Y,render:me=>{const xe=Number.isFinite(Number(me?.positionClientPrice))?Number(me.positionClientPrice):0,Ze=Math.max(1,Number(me?.__count||1)),Ve=Math.max(1,Number(q?.rentalDays||1)),Ft=xe*Ze*Ve;return b(`${Pe(Ft)} ${c("reservations.create.summary.currency","SR")}`)}}):Y.id==="unitPrice"?w.push({...Y,render:me=>{const xe=Number.isFinite(Number(me?.positionClientPrice))?Number(me.positionClientPrice):0;return b(`${Pe(xe)} ${c("reservations.create.summary.currency","SR")}`)}}):w.push(Y)}),v("projectCrew","days")){const Y=Math.max(1,Number(q?.rentalDays||1)),me=w.findIndex(Ze=>Ze.id==="price"),xe=Math.max(0,me);w.splice(xe,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>b(I(String(Y)))})}const z=new Map(w.map(Y=>[Y.id,Y])),G=new Set,se=[],ae=Y=>{const me=z.get(Y);me&&!G.has(Y)&&(se.push(me),G.add(Y))};return ae("rowNumber"),ae("position"),ae("unitPrice"),ae("quantity"),ae("days"),ae("price"),w.forEach(Y=>{G.has(Y.id)||(se.push(Y),G.add(Y.id))}),se})(),_=(()=>{const w=new Map;return $.forEach(z=>{const G=B(z);if(!G)return;const se=w.get(G);se?se.__count+=1:w.set(G,{...z,__count:1})}),Array.from(w.values())})(),N=(()=>{try{const w=Math.max(1,Number(q?.rentalDays||1)),z=(_||[]).reduce((G,se)=>{const ae=Number.isFinite(Number(se?.positionClientPrice))?Number(se.positionClientPrice):0,Y=Math.max(1,Number(se?.__count||1));return G+ae*Y*w},0);return Pe(z)}catch{return"0.00"}})(),D=j("projectCrew")?V.length?`<section class="quote-section quote-section--table">
            <h3>${b(c("projects.quote.sections.crew","طاقم العمل"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${V.map(w=>`<th>${b(w.labelKey?c(w.labelKey,w.fallback):w.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${_.length?_.map((w,z)=>`<tr>${V.map(G=>`<td><div class="quote-cell">${G.render(w,z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(V.length,1)}" class="empty">${b(c("projects.details.crew.empty","لا يوجد طاقم فني مرتبط."))}</td></tr>`}
              </tbody>
            </table>
            ${v("projectCrew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${b(c("reservations.details.labels.crewTotal","إجمالي الفريق"))}</span>
                  <span class="quote-table-subtotal__value">${b(`${N} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${b(c("projects.quote.sections.crew","طاقم العمل"))}</h3>
            ${g}
          </section>`:"",J=[];v("financialSummary","discountAmount")&&J.push(k(c("reservations.details.labels.discount","قيمة الخصم"),i.discountAmount||fe(0,u)));const Q=c("projects.details.summary.preTaxTotal","الإجمالي قبل الضريبة");v("financialSummary","reservationsTotal")&&J.push(k(Q,i.reservationsTotal||fe(0,u))),v("financialSummary","taxAmount")&&J.push(k(c("projects.details.summary.combinedTax","قيمة الضريبة"),i.taxAmount||fe(0,u)));const F=[];v("financialSummary","overallTotal")&&F.push(k(c("projects.details.summary.overallTotal","الإجمالي الكلي"),i.overallTotal||fe(0,u),{variant:"final"}));const X=j("financialSummary")?!J.length&&!F.length?`<section class="quote-section quote-section--financial">${g}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${b(c("projects.quote.sections.financial","الملخص المالي"))}</h3>
            ${J.length?`<div class="totals-inline">${J.join("")}</div>`:""}
            ${F.length?`<div class="totals-final">${F.join("")}</div>`:""}
          </div>
        </section>`:"",R=Ws.filter(w=>v("projectExpenses",w.id)),ce=j("projectExpenses")?R.length?`<section class="quote-section quote-section--table">
            <h3>${b(c("projects.quote.sections.expenses","الخدمات الإنتاجية"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${R.map(w=>`<th>${b(w.labelKey?c(w.labelKey,w.fallback):w.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${s.length?s.map((w,z)=>`<tr>${R.map(G=>`<td><div class="quote-cell">${G.render(w,z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(R.length,1)}" class="empty">${b(c("projects.details.expenses.empty","لا توجد متطلبات مسجلة."))}</td></tr>`}
              </tbody>
            </table>
            ${v("projectExpenses","expensesSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${b(c("projects.details.expensesTotal","إجمالي الخدمات الإنتاجية"))}</span>
                  <span class="quote-table-subtotal__value">${b(i.expensesTotal||fe(0,u))}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${b(c("projects.quote.sections.expenses","الخدمات الإنتاجية"))}</h3>
            ${g}
          </section>`:"",te=En.filter(w=>v("projectEquipment",w.id)),be=(()=>{let w=[];if(te.forEach(ae=>{ae.id==="price"?w.push({...ae,render:Y=>{const me=Number.isFinite(Number(Y?.unitPriceValue))?Number(Y.unitPriceValue):0,xe=Number.isFinite(Number(Y?.qty))?Math.max(1,Number(Y.qty)):1,Ze=Math.max(1,Number(q?.rentalDays||1)),Ve=me*xe*Ze;return b(`${Pe(Ve)} ${c("reservations.create.summary.currency","SR")}`)}}):ae.id==="unitPrice"?w.push({...ae,render:Y=>{const me=Number.isFinite(Number(Y?.unitPriceValue))?Number(Y.unitPriceValue):0;return b(`${Pe(me)} ${c("reservations.create.summary.currency","SR")}`)}}):w.push(ae)}),v("projectEquipment","days")){const ae=Math.max(1,Number(q?.rentalDays||1)),Y=w.findIndex(xe=>xe.id==="price"),me=Math.max(0,Y);w.splice(me,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>b(I(String(ae)))})}const z=new Map(w.map(ae=>[ae.id,ae])),G=w.filter(ae=>!["unitPrice","quantity","days","price"].includes(ae.id)),se=["unitPrice","quantity","days","price"].map(ae=>z.get(ae)).filter(Boolean);return w=[...G,...se],w})(),he=Array.isArray(q?.equipmentItems)?q.equipmentItems:[],qe=(()=>{try{const w=Math.max(1,Number(q?.rentalDays||1)),z=(he||[]).reduce((G,se)=>{const ae=Number.isFinite(Number(se?.unitPriceValue))?Number(se.unitPriceValue):0,Y=Number.isFinite(Number(se?.qty))?Math.max(1,Number(se.qty)):1;return G+ae*Y*w},0);return Pe(z)}catch{return"0.00"}})(),je=j("projectEquipment")?be.length?`<section class="quote-section quote-section--table">
            <h3>${b(c("projects.quote.sections.equipment","المعدات"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${be.map(w=>`<th>${b(w.labelKey?c(w.labelKey,w.fallback):w.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${he.length?he.map((w,z)=>`<tr>${be.map(G=>`<td><div class="quote-cell">${G.render(w,z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(be.length,1)}" class="empty">${b(c("projects.details.equipment.empty","لا توجد معدات مرتبطة حالياً."))}</td></tr>`}
              </tbody>
            </table>
            ${v("projectEquipment","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${b(c("reservations.details.labels.equipmentTotal","إجمالي المعدات"))}</span>
                  <span class="quote-table-subtotal__value">${b(`${qe} ${u}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${b(c("projects.quote.sections.equipment","المعدات"))}</h3>
            ${g}
          </section>`:"",Le=(e?.description||"").trim()||"",O=j("projectNotes")?`<section class="quote-section">
        <h3>${b(c("projects.quote.sections.notes","ملاحظات المشروع"))}</h3>
        <div class="quote-notes">${b(Le||c("projects.fallback.noDescription","لا يوجد وصف للمشروع."))}</div>
      </section>`:"",ie=[];v("payment","beneficiary")&&ie.push(H(c("reservations.quote.labels.beneficiary","اسم المستفيد"),_e.beneficiaryName)),v("payment","bank")&&ie.push(H(c("reservations.quote.labels.bank","اسم البنك"),_e.bankName)),v("payment","account")&&ie.push(H(c("reservations.quote.labels.account","رقم الحساب"),I(_e.accountNumber))),v("payment","iban")&&ie.push(H(c("reservations.quote.labels.iban","رقم الآيبان"),I(_e.iban)));const Be=`<section class="quote-section">
      <div class="payment-block">
        <h3>${b(c("reservations.quote.sections.payment","بيانات الدفع"))}</h3>
        <div class="payment-rows">${ie.length?ie.join(""):g}</div>
      </div>
      <p class="quote-approval-note">${b(_e.approvalNote)}</p>
    </section>`,De=Array.isArray(f)&&f.length?f:He,Oe=`<footer class="quote-footer">
        <h4>${b(c("reservations.quote.labels.terms","الشروط العامة"))}</h4>
        <ul>${De.map(w=>`<li>${b(w)}</li>`).join("")}</ul>
      </footer>`,Fe=[],ge=[];if(T&&ge.push({key:"project",html:T}),A&&ge.push({key:"customer",html:A}),ge.length>1){const w=ge.find(se=>se.key==="project"),z=ge.find(se=>se.key==="customer"),G=[];w?.html&&G.push(w.html),z?.html&&G.push(z.html),Fe.push(ke(`<div class="quote-section-row quote-section-row--primary">${G.join("")}</div>`,{blockType:"group"}))}else ge.length===1&&Fe.push(ke(ge[0].html));const Ae=[];D&&Ae.push(ke(D,{blockType:"table",extraAttributes:'data-table-id="project-crew"'})),ce&&Ae.push(ke(ce,{blockType:"table",extraAttributes:'data-table-id="project-expenses"'})),je&&Ae.push(ke(je,{blockType:"table",extraAttributes:'data-table-id="project-equipment"'}));const Ce=[];X&&Ce.push(ke(X,{blockType:"summary"})),O&&Ce.push(ke(O));const Te=[ke(Be,{blockType:"payment"}),ke(Oe,{blockType:"footer"})],ze=[...fn(Fe,"projects.quote.placeholder.primary"),...Ae,...fn(Ce,"projects.quote.placeholder.summary"),...Te],M=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${b(_e.logoUrl)}" alt="${b(_e.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${b(c("projects.quote.title","عرض سعر"))}</h1>
        <p class="quote-company-name">${b(_e.companyName)}</p>
        <p class="quote-company-cr">${b(c("reservations.quote.labels.cr","السجل التجاري"))}: ${b(_e.commercialRegistry)}</p>
        <p class="quote-company-license">ترخيص إعلامي: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${b(c("reservations.details.labels.reservationId","رقم العرض"))}</span>
          <strong>${b(p)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${b(c("projects.quote.labels.date","التاريخ"))}</span>
          <strong>${b(m)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
        <style>${tr}${er}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${M}
          ${ze.join("")}
        </div>
      </div>
    </div>
  `}function wr(e){if(e?.context==="project")return Xo(e);const{reservation:t,customer:n,project:a,crewAssignments:s,totals:r,totalsDisplay:i,rentalDays:o,currencyLabel:d,sections:u,fieldSelections:l={},quoteNumber:y,quoteDate:p,terms:m=He}=e,f=I(String(t?.reservationId??t?.id??"")),h=t.start?I(it(t.start)):"-",v=t.end?I(it(t.end)):"-",j=n?.customerName||n?.full_name||n?.name||"-",g=n?.phone||"-",C=n?.email||"-",k=n?.company||n?.company_name||"-",H=I(g),S=a?.title||a?.name||c("reservations.details.project.none","غير مرتبط بمشروع"),A=a?.code||a?.projectCode||"",L=I(String(o)),T=t?.notes||"",W=Array.isArray(m)&&m.length?m:He,$=va(l),B=(E,Z)=>Sa($,E,Z),V=E=>u?.has?.(E),_=`<div class="quote-placeholder">${b(c("reservations.quote.placeholder.noFields","لم يتم اختيار أي معلومات للعرض في هذا القسم."))}</div>`,N=(E,Z)=>`<div class="info-plain__item">${b(E)} <span class="info-plain__slash">/</span> <strong class="info-plain__value">${b(Z)}</strong></div>`,D=(E,Z,{variant:ne="inline"}={})=>ne==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${b(E)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${b(Z)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${b(E)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${b(Z)}</span>
    </span>`,J=(E,Z)=>`<div class="payment-row">
      <span class="payment-row__label">${b(E)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${b(Z)}</span>
    </div>`,Q=[];B("customerInfo","customerName")&&Q.push(N(c("reservations.details.labels.customer","العميل"),j)),B("customerInfo","customerCompany")&&Q.push(N(c("reservations.details.labels.company","الشركة"),k)),B("customerInfo","customerPhone")&&Q.push(N(c("reservations.details.labels.phone","الهاتف"),H)),B("customerInfo","customerEmail")&&Q.push(N(c("reservations.details.labels.email","البريد"),C));const F=V("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        <h3 class="quote-section__title">${b(c("reservations.quote.sections.customer","بيانات العميل"))}</h3>
        ${Q.length?`<div class="info-plain">${Q.join("")}</div>`:_}
      </section>`:"",X=[];B("reservationInfo","reservationId")&&X.push(N(c("reservations.details.labels.reservationId","رقم الحجز"),f||"-")),B("reservationInfo","reservationStart")&&X.push(N(c("reservations.details.labels.start","بداية الحجز"),h)),B("reservationInfo","reservationEnd")&&X.push(N(c("reservations.details.labels.end","نهاية الحجز"),v)),B("reservationInfo","reservationDuration")&&X.push(N(c("reservations.details.labels.duration","عدد الأيام"),L));const R=V("reservationInfo")?`<section class="quote-section quote-section--plain quote-section--reservation">
        <h3 class="quote-section__title">${b(c("reservations.quote.sections.reservation","تفاصيل الحجز"))}</h3>
        ${X.length?`<div class="info-plain">${X.join("")}</div>`:_}
      </section>`:"",ce=[];B("projectInfo","projectTitle")&&ce.push(N(c("reservations.details.labels.project","المشروع"),S)),B("projectInfo","projectCode")&&ce.push(N(c("reservations.details.labels.code","الرمز"),A||"-"));const te=V("projectInfo")?`<section class="quote-section quote-section--plain">
        <h3 class="quote-section__title">${b(c("reservations.quote.sections.project","بيانات المشروع"))}</h3>
        ${ce.length?`<div class="info-plain">${ce.join("")}</div>`:_}
      </section>`:"",be=[];be.push(D(c("reservations.details.labels.discount","قيمة الخصم"),`${i.discountAmount} ${d}`)),be.push(D(c("reservations.details.labels.subtotalBeforeTax","الإجمالي قبل الضريبة"),`${i.taxableAmount} ${d}`)),be.push(D(c("reservations.details.labels.tax","قيمة الضريبة"),`${i.taxAmount} ${d}`));const he=B("financialSummary","finalTotal"),qe=[];he&&qe.push(D(c("reservations.details.labels.total","الإجمالي النهائي"),`${i.finalTotal} ${d}`,{variant:"final"}));const je=qe.length?`<div class="totals-final">${qe.join("")}</div>`:"",Le=V("financialSummary")?!be.length&&!he?`<section class="quote-section quote-section--financial">${_}</section>`:`<section class="quote-section quote-section--financial">
          <div class="totals-block">
            <h3>${b(c("reservations.details.labels.summary","الملخص المالي"))}</h3>
            ${be.length?`<div class="totals-inline">${be.join("")}</div>`:""}
            ${je}
          </div>
        </section>`:"",{groups:O}=Bt(t),ie=O.map(E=>{const Z=Number(E?.count??E?.quantity??1)||1,ne=Number(E?.unitPrice);let Ee=Number.isFinite(ne)?ne:0;if(!Ee||Ee<=0){const de=Number(E?.totalPrice);Number.isFinite(de)&&Z>0&&(Ee=Number((de/Z).toFixed(2)))}Number.isFinite(Ee)||(Ee=0);const Re=E?.type==="package"||Array.isArray(E?.items)&&E.items.some(de=>de?.type==="package"),Je=Array.isArray(E?.barcodes)&&E.barcodes.length?E.barcodes[0]:Array.isArray(E?.items)&&E.items.length?E.items[0]?.barcode:null;let Ne=E?.packageDisplayCode??E?.package_code??E?.code??E?.packageCode??(Array.isArray(E?.items)&&E.items.length?E.items[0]?.package_code??E.items[0]?.code??E.items[0]?.packageCode:null);const ee=de=>{const Ie=(de==null?"":String(de)).trim();return!!(!Ie||/^pkg-/i.test(Ie)||/^\d+$/.test(Ie)&&Ie.length<=4)};if(!Ne||ee(Ne)){const de=E?.packageId??E?.package_id??(Array.isArray(E?.items)&&E.items.length?E.items[0]?.packageId??E.items[0]?.package_id:null);if(de)try{const Ie=ua(de);Ie&&Ie.package_code&&(Ne=Ie.package_code)}catch{}}if(!Ne||ee(Ne))try{const de=Pt(E?.description||"");if(de){const Ie=Ss();let Ke=Ie.find(Xe=>Pt(Xe?.name||Xe?.title||Xe?.label||"")===de);Ke||(Ke=Ie.find(Xe=>{const _a=Pt(Xe?.name||Xe?.title||Xe?.label||"");return _a.includes(de)||de.includes(_a)})),Ke&&Ke.package_code&&(Ne=Ke.package_code)}}catch{}const ue=Re?Ne??Je??"":E?.barcode??Je??"",le=ue!=null?String(ue):"";let oe=Number.isFinite(Number(E?.totalPrice))?Number(E.totalPrice):Number((Ee*Z).toFixed(2));return oe=St(oe),{...E,isPackage:Re,desc:E?.description,barcode:le,packageCodeResolved:Ne||"",qty:Z,price:oe,totalPrice:oe,unitPriceValue:Ee}}),Be=En.filter(E=>B("items",E.id)),De=(()=>{let E=[];Be.forEach(ee=>{ee.id==="price"?E.push({...ee,render:ue=>{const le=Number.isFinite(Number(ue?.unitPriceValue))?Number(ue.unitPriceValue):0,oe=Number.isFinite(Number(ue?.qty))?Math.max(1,Number(ue.qty)):1,de=Math.max(1,Number(q?.rentalDays||1)),Ie=le*oe*de;return b(`${Pe(Ie)} ${c("reservations.create.summary.currency","SR")}`)}}):ee.id==="unitPrice"?E.push({...ee,render:ue=>{const le=Number.isFinite(Number(ue?.unitPriceValue))?Number(ue.unitPriceValue):0;return b(`${Pe(le)} ${c("reservations.create.summary.currency","SR")}`)}}):E.push(ee)});const Z=Math.max(1,Number(q?.rentalDays||1)),ne=E.findIndex(ee=>ee.id==="price"),Ee=Math.max(0,ne);E.splice(Ee,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>b(I(String(Z)))});const Re=new Map(E.map(ee=>[ee.id,ee])),Je=E.filter(ee=>!["unitPrice","quantity","days","price"].includes(ee.id)),Ne=["unitPrice","quantity","days","price"].map(ee=>Re.get(ee)).filter(Boolean);return E=[...Je,...Ne],E})(),Oe=De.length>0,Fe=Oe?De.map(E=>`<th>${b(E.labelKey?c(E.labelKey,E.fallback):E.fallback)}</th>`).join(""):"",Ae=ie.length>0?ie.map((E,Z)=>`<tr>${De.map(ne=>`<td><div class="quote-cell">${ne.render(E,Z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(De.length,1)}" class="empty">${b(c("reservations.details.noItems","📦 لا توجد معدات ضمن هذا الحجز حالياً."))}</td></tr>`,Ce=V("items")?Oe?`<section class="quote-section quote-section--table">
            <h3>${b(c("reservations.details.items.title","المعدات"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${Fe}</tr>
              </thead>
              <tbody>${Ae}</tbody>
            </table>
            ${B("items","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${b(c("reservations.details.labels.equipmentTotal","إجمالي المعدات"))}</span>
                  <span class="quote-table-subtotal__value">${b(`${i.equipmentTotal} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${b(c("reservations.details.items.title","المعدات"))}</h3>
            ${_}
          </section>`:"",Te=qn.filter(E=>B("crew",E.id)),ze=B("crew","groupByPosition"),M=Te.length>0,w=Array.isArray(s)?s:[],z=E=>{const Z=E&&E.positionId!=null?`id:${String(E.positionId)}`:(()=>{const Re=(E?.positionLabel||E?.position_name||E?.position||"").trim().toLowerCase();return Re?`label:${Re}`:""})(),ne=Number.isFinite(Number(E?.positionClientPrice))?Number(E.positionClientPrice):0,Ee=ne>0?`|p:${ne.toFixed(2)}`:"";return`${Z}${Ee}`},G=(()=>{const E=new Map;return w.forEach(Z=>{const ne=z(Z);ne&&E.set(ne,(E.get(ne)||0)+1)}),E})(),se=(()=>{let E=[],Z=null;Te.forEach(le=>{le.id==="position"?(E.push({...le,render:oe=>{const de=oe?.positionLabel??oe?.position_name??oe?.role??c("reservations.crew.positionFallback","منصب بدون اسم");if(ze)return b(I(String(de)));const Ie=z(oe),Ke=Ie&&G.get(Ie)||0,Xe=Ke>1?` × ${I(String(Ke))}`:"";return b(I(String(de))+Xe)}}),Z={id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"الكمية",render:oe=>{const de=Number(oe?.__count||1);return b(I(String(Math.max(1,de))))}}):le.id==="price"?ze?E.push({...le,render:oe=>{const de=Number.isFinite(Number(oe?.positionClientPrice))?Number(oe.positionClientPrice):0,Ie=Math.max(1,Number(oe?.__count||1)),Ke=Math.max(1,Number(q?.rentalDays||1)),Xe=de*Ie*Ke;return b(`${Pe(Xe)} ${c("reservations.create.summary.currency","SR")}`)}}):E.push({...le,render:oe=>{const de=Number.isFinite(Number(oe?.positionClientPrice))?Number(oe.positionClientPrice):0,Ie=Math.max(1,Number(q?.rentalDays||1)),Ke=de*Ie;return b(`${Pe(Ke)} ${c("reservations.create.summary.currency","SR")}`)}}):le.id==="unitPrice"?E.push({...le,render:oe=>{const de=Number.isFinite(Number(oe?.positionClientPrice))?Number(oe.positionClientPrice):0;return b(`${Pe(de)} ${c("reservations.create.summary.currency","SR")}`)}}):E.push(le)}),Z&&E.push(Z);const ne=Math.max(1,Number(q?.rentalDays||1)),Ee=E.findIndex(le=>le.id==="price"),Re=Math.max(0,Ee);E.splice(Re,0,{id:"days",labelKey:null,fallback:"الأيام",render:()=>b(I(String(ne)))});const Je=new Map(E.map(le=>[le.id,le])),Ne=new Set,ee=[],ue=le=>{const oe=Je.get(le);oe&&!Ne.has(le)&&(ee.push(oe),Ne.add(le))};return ue("rowNumber"),ue("position"),ue("unitPrice"),ue("quantity"),ue("days"),ue("price"),E.forEach(le=>{Ne.has(le.id)||(ee.push(le),Ne.add(le.id))}),E=ee,E})(),ae=M?se.map(E=>`<th>${b(E.labelKey?c(E.labelKey,E.fallback):E.fallback)}</th>`).join(""):"",Y=ze?(()=>{const E=new Map;return w.forEach(Z=>{const ne=z(Z);if(!ne)return;const Ee=E.get(ne);Ee?Ee.__count+=1:E.set(ne,{...Z,__count:1})}),Array.from(E.values())})():w,me=Y.length?Y.map((E,Z)=>`<tr>${se.map(ne=>`<td><div class="quote-cell">${ne.render(E,Z)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(se.length,1)}" class="empty">${b(c("reservations.details.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز."))}</td></tr>`,xe=V("crew")?M?`<section class="quote-section quote-section--table">
            <h3>${b(c("reservations.details.technicians.title","طاقم العمل"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${ae}</tr>
              </thead>
              <tbody>${me}</tbody>
            </table>
            ${B("crew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${b(c("reservations.details.labels.crewTotal","إجمالي الفريق"))}</span>
                  <span class="quote-table-subtotal__value">${b(`${i.crewTotal} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${b(c("reservations.details.technicians.title","طاقم العمل"))}</h3>
            ${_}
          </section>`:"",Ze=V("notes")?`<section class="quote-section">
        <h3>${b(c("reservations.details.labels.notes","ملاحظات الحجز"))}</h3>
        <div class="quote-notes">${b(T||c("reservations.quote.emptyNotes","لا توجد ملاحظات إضافية."))}</div>
      </section>`:"",Ve=[];B("payment","beneficiary")&&Ve.push(J(c("reservations.quote.labels.beneficiary","اسم المستفيد"),_e.beneficiaryName)),B("payment","bank")&&Ve.push(J(c("reservations.quote.labels.bank","اسم البنك"),_e.bankName)),B("payment","account")&&Ve.push(J(c("reservations.quote.labels.account","رقم الحساب"),I(_e.accountNumber))),B("payment","iban")&&Ve.push(J(c("reservations.quote.labels.iban","رقم الآيبان"),I(_e.iban)));const Ft=`<section class="quote-section">
      <div class="payment-block">
        <h3>${b(c("reservations.quote.sections.payment","بيانات الدفع"))}</h3>
        <div class="payment-rows">${Ve.length?Ve.join(""):_}</div>
      </div>
      <p class="quote-approval-note">${b(_e.approvalNote)}</p>
    </section>`,Ca=`<footer class="quote-footer">
        <h4>${b(c("reservations.quote.labels.terms","الشروط العامة"))}</h4>
        <ul>${W.map(E=>`<li>${b(E)}</li>`).join("")}</ul>
      </footer>`,x=[];F&&R?x.push(ke(`<div class="quote-section-row">${F}${R}</div>`,{blockType:"group"})):(R&&x.push(ke(R)),F&&x.push(ke(F))),te&&x.push(ke(te));const pe=[];Ce&&pe.push(ke(Ce,{blockType:"table",extraAttributes:'data-table-id="items"'})),xe&&pe.push(ke(xe,{blockType:"table",extraAttributes:'data-table-id="crew"'}));const U=[];Le&&U.push(ke(Le,{blockType:"summary"})),Ze&&U.push(ke(Ze));const we=[ke(Ft,{blockType:"payment"}),ke(Ca,{blockType:"footer"})],ve=[...fn(x,"reservations.quote.placeholder.page1"),...pe,...fn(U,"reservations.quote.placeholder.page2"),...we],$e=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${b(_e.logoUrl)}" alt="${b(_e.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${b(c("reservations.quote.title","عرض سعر"))}</h1>
        <p class="quote-company-name">${b(_e.companyName)}</p>
        <p class="quote-company-cr">${b(c("reservations.quote.labels.cr","السجل التجاري"))}: ${b(_e.commercialRegistry)}</p>
        <p class="quote-company-license">ترخيص إعلامي: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>رقم العرض</span>
          <strong>${b(y)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>التاريخ</span>
          <strong>${b(p)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl">
      <style>${tr}${er}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${$e}
          ${ve.join("")}
        </div>
      </div>
    </div>
  `}async function Er(){try{const e=Se();if((Array.isArray(e?.packages)?e.packages:[]).length>0)return;const n=await zr("/packages/?all=1"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];a.length&&(Vr({packages:a}),document.dispatchEvent?.(new CustomEvent("packages:changed",{detail:{packages:a}})))}catch{}}function Yo(e){return e?e.complete?e.naturalHeight===0?Promise.reject(new Error(`image failed to load: ${e.src||"unknown"}`)):Promise.resolve():new Promise((t,n)=>{const a=()=>{r(),t()},s=()=>{r(),n(new Error(`image failed to load: ${e.src||"unknown"}`))},r=()=>{e.removeEventListener("load",a),e.removeEventListener("error",s)};e.addEventListener("load",a,{once:!0}),e.addEventListener("error",s,{once:!0})}):Promise.resolve()}async function Gt(e){if(!e)return;const t=e.ownerDocument||document,n=t.defaultView||window,a=Array.from(e.querySelectorAll?.("img")||[]),s=t.fonts?.ready?t.fonts.ready:Promise.resolve(),r=a.map(o=>Yo(o)),i=[s,...r].map(o=>o.catch(d=>(rt("asset load failed",d),fo(),null)));await Promise.all(i),await new Promise(o=>n.requestAnimationFrame(()=>o()))}async function yn(e,{context:t="preview"}={}){if(!e)return;const n=t==="preview",a=e.ownerDocument||document;e.setAttribute("data-quote-render-context",t);const s=e.querySelector("[data-quote-pages]"),r=e.querySelector("[data-quote-source]"),i=r?.querySelector("[data-quote-header-template]");if(!s||!r||!i)return;s.style.display="block",s.style.margin="0",s.style.padding="0",s.style.gap="0px",s.style.rowGap="0px",s.style.columnGap="0px",s.style.alignItems="stretch",s.style.justifyContent="flex-start",await pr(r),await Gt(r),s.innerHTML="";const o=Array.from(r.querySelectorAll(":scope > [data-quote-block]"));let d=null,u=null;const l=S=>{S.style.margin="0 auto",S.style.breakInside="avoid",S.style.pageBreakInside="avoid",S.style.pageBreakAfter="auto",S.style.breakAfter="auto"},y=()=>{const S=a.createElement("div"),A=s.childElementCount===0;if(S.className="quote-page",S.dataset.pageIndex=String(s.childElementCount),A){S.classList.add("quote-page--primary");const T=i.cloneNode(!0);T.removeAttribute("data-quote-header-template"),S.appendChild(T)}else S.classList.add("quote-page--continuation");const L=a.createElement("main");L.className="quote-body",S.appendChild(L),s.appendChild(S),l(S),d=S,u=L},p=()=>{(!d||!u||!u.isConnected)&&y()},m=()=>{if(!d||!u||u.childElementCount>0)return;const S=d;d=null,u=null,S.parentNode&&S.parentNode.removeChild(S)},f=()=>{d=null,u=null},h=()=>d?d.scrollHeight-d.clientHeight>or:!1,v=(S,{allowOverflow:A=!1}={})=>(p(),u.appendChild(S),h()&&!A?(u.removeChild(S),m(),!1):!0),j=S=>{const A=S.cloneNode(!0);A.removeAttribute?.("data-quote-block"),A.removeAttribute?.("data-block-type"),A.removeAttribute?.("data-table-id"),!v(A)&&(f(),!v(A)&&v(A,{allowOverflow:!0}))},g=S=>{const A=S.querySelector("table");if(!A){j(S);return}const L=S.querySelector("h3"),T=A.querySelector("thead"),W=Array.from(A.querySelectorAll("tbody tr"));if(!W.length){j(S);return}let $=null,B=0;const V=(N=!1)=>{const D=S.cloneNode(!1);D.removeAttribute("data-quote-block"),D.removeAttribute("data-block-type"),D.removeAttribute("data-table-id"),D.classList.add("quote-section--table-fragment"),N&&D.classList.add("quote-section--table-fragment--continued");const J=L?L.cloneNode(!0):null;J&&D.appendChild(J);const Q=A.cloneNode(!1);Q.classList.add("quote-table--fragment"),T&&Q.appendChild(T.cloneNode(!0));const F=a.createElement("tbody");return Q.appendChild(F),D.appendChild(Q),{section:D,body:F}},_=(N=!1)=>$||($=V(N),v($.section)||(f(),v($.section)||v($.section,{allowOverflow:!0})),$);W.forEach(N=>{_(B>0);const D=N.cloneNode(!0);if($.body.appendChild(D),h()&&($.body.removeChild(D),$.body.childElementCount||(u.removeChild($.section),$=null,m()),f(),$=null,_(B>0),$.body.appendChild(D),h())){$.section.classList.add("quote-section--table-fragment--overflow"),B+=1;return}B+=1}),$=null;try{const N=S.querySelector(":scope > .quote-table-subtotal");N&&j(N)}catch{}};if(!o.length)return;o.forEach(S=>{S.getAttribute("data-block-type")==="table"?g(S):j(S)});const C=Array.from(s.children),k=[];if(C.forEach((S,A)=>{const L=S.querySelector(".quote-body");if(A!==0&&(!L||L.childElementCount===0)){S.remove();return}k.push(S)}),!n){const S=a.defaultView||window,A=Math.min(3,Math.max(1,S.devicePixelRatio||1)),L=Pn()?Math.min(2,A):A;k.forEach(T=>jo(T,{pixelRatio:L}))}k.forEach((S,A)=>{const L=A===0;S.style.pageBreakAfter="auto",S.style.breakAfter="auto",S.style.pageBreakBefore=L?"auto":"always",S.style.breakBefore=L?"auto":"page",n?S.style.boxShadow="":S.style.boxShadow="none"});const H=k[k.length-1]||null;d=H,u=H?.querySelector(".quote-body")||null,await Gt(s),n&&(s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="flex-start",s.style.rowGap="18px",s.style.columnGap="0px",s.style.gap="18px")}function qr(e=0){return e<=0?new Promise(t=>requestAnimationFrame(()=>t())):new Promise(t=>setTimeout(t,e))}function Ir(e){return e?Array.from(e.querySelectorAll(".quote-page")).some(n=>n.scrollHeight-n.clientHeight>or):!1}function ka(e,t="#000000"){if(!e)return;e.querySelectorAll('[style*="color"], [class*="text"], h1, h2, h3, h4, h5, h6, p, span, th, td, li, strong, em, label, dt, dd, caption, div').forEach(a=>{a instanceof HTMLElement&&a.style.setProperty("color",t,"important")})}async function Zo(e,{filename:t,safariWindowRef:n=null,mobileWindowRef:a=null}){if(!e)return;const s=Array.from(e.querySelectorAll(".quote-page"));if(!s.length)throw new Error("لا توجد صفحات لتصديرها.");const[r,i]=await Promise.all([_o(),Co()]),o=e.ownerDocument||document,d=o?.defaultView?.getComputedStyle?.(e)?.direction,l=[e.getAttribute?.("dir"),e.style?.direction,d,o?.documentElement?.getAttribute?.("dir")].some(S=>typeof S=="string"&&S.toLowerCase().startsWith("rtl")),y=typeof window<"u"&&window.devicePixelRatio||1,p=qa(),m=lr(),f=Pn();let h;f?h=1.5:m?h=Math.min(1.7,Math.max(1.2,y*1.1)):p?h=Math.min(1.8,Math.max(1.25,y*1.2)):h=Math.min(2,Math.max(1.6,y*1.4));const v=f||m?.9:p?.92:.95,j=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),g={scale:h,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!l,removeContainer:!1,logging:!0};let C=0;const k=c("reservations.quote.errors.browserLimit","تعذر إتمام عملية التحويل بسبب قيود المتصفح، يرجى إعادة المحاولة أو تقليل حجم المحتوى.");try{for(let S=0;S<s.length;S+=1){const A=s[S];await pr(A),await Gt(A);const L=A.ownerDocument||document,T=L.createElement("div");Object.assign(T.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const W=A.cloneNode(!0);W.style.width=`${tn}px`,W.style.maxWidth=`${tn}px`,W.style.minWidth=`${tn}px`,W.style.height=`${nn}px`,W.style.maxHeight=`${nn}px`,W.style.minHeight=`${nn}px`,W.style.position="relative",W.style.background="#ffffff",ka(W),T.appendChild(W),L.body.appendChild(T);let $;try{await Gt(W),$=await i(W,{...g,scale:h,backgroundColor:"#ffffff",scrollX:0,scrollY:0})}catch(F){throw Jn(F,"pageCapture",{toastMessage:k}),F}finally{T.parentNode?.removeChild(T)}if(!$)continue;const B=$.width||1,_=($.height||1)/B;let N=Qn,D=N*_,J=0;if(D>en){const F=en/D;D=en,N=N*F,J=Math.max(0,(Qn-N)/2)}const Q=$.toDataURL("image/jpeg",v);C>0&&j.addPage(),j.addImage(Q,"JPEG",J,0,N,D,`page-${C+1}`,"FAST"),C+=1,await new Promise(F=>window.requestAnimationFrame(F))}}catch(S){throw Xn({safariWindowRef:n,mobileWindowRef:a}),S}if(C===0)throw Xn({safariWindowRef:n,mobileWindowRef:a}),new Error("PDF generation produced no pages.");if(m||f){const S=j.output("blob");if(f){const A=URL.createObjectURL(S);Kt();try{window.location.assign(A)}catch(L){rt("mobile safari blob navigation failed",L)}finally{setTimeout(()=>URL.revokeObjectURL(A),6e4)}}else{const A=URL.createObjectURL(S),L=()=>m&&n&&!n.closed?n:a&&!a.closed?a:null,T=($,B)=>{if(Kt(),!$){window.location.assign(B);return}try{$.location.replace(B),$.focus?.()}catch(V){rt("direct blob navigation failed",V);try{$.document.open(),$.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${b(c("reservations.quote.actions.export","تنزيل PDF"))}</title><style>html,body{margin:0;height:100%;background:#0f172a;color:#f8fafc;font-family:'Tajawal',sans-serif;} iframe{border:none;width:100%;height:100%;display:block;}</style></head><body><iframe src="${B}" title="PDF preview"></iframe></body></html>`),$.document.close()}catch(_){rt("iframe blob delivery failed",_),window.location.assign(B)}}},W=L();T(W,A),setTimeout(()=>URL.revokeObjectURL(A),6e4)}}else{Kt();const S=j.output("bloburl"),A=document.createElement("a");A.href=S,A.download=t,A.rel="noopener",A.style.display="none",document.body.appendChild(A),A.click(),setTimeout(()=>{URL.revokeObjectURL(S),A.remove()},2e3)}}function pt(){if(!q||!K)return;const{previewFrame:e}=K;if(!e)return;const t=q.context||"reservation",n=wr({context:t,reservation:q.reservation,customer:q.customer,project:q.project,crewAssignments:q.crewAssignments,totals:q.totals,totalsDisplay:q.totalsDisplay,rentalDays:q.rentalDays,currencyLabel:q.currencyLabel,sections:q.sections,fieldSelections:q.fields,quoteNumber:q.quoteNumber,quoteDate:q.quoteDateLabel,terms:q.terms,projectCrew:q.projectCrew,projectExpenses:q.projectExpenses,projectEquipment:q.projectEquipment,projectInfo:q.projectInfo,clientInfo:q.clientInfo,paymentSummary:q.paymentSummary,projectTotals:q.projectTotals});gt("render"),e.srcdoc=`<!DOCTYPE html>${n}`,e.addEventListener("load",async()=>{try{const a=e.contentDocument,s=a?.defaultView||window,r=a?.documentElement||a;r&&(qs(r),Is(r,s),As(r,s));const i=a?.getElementById("quotation-pdf-root");try{i&&(await yn(i,{context:"preview"}),await qr(120),Ir(i)&&await yn(i,{context:"preview"}),ka(i))}catch(m){console.error("[reservations/pdf] failed to layout preview document",m)}const o=Array.from(a?.querySelectorAll?.(".quote-page")||[]),d=a?.querySelector(".quote-preview-pages"),u=tn;let l=18;if(d&&a?.defaultView){const m=a.defaultView.getComputedStyle(d),f=parseFloat(m.rowGap||m.gap||`${l}`);Number.isFinite(f)&&f>=0&&(l=f)}const y=nn,p=o.length?o.length*y+Math.max(0,(o.length-1)*l):y;if(e.dataset.baseWidth=String(u),e.dataset.baseHeight=String(p),e.style.width=`${u}px`,e.style.minWidth=`${u}px`,e.style.height=`${p}px`,e.style.minHeight=`${p}px`,K?.previewFrameWrapper&&!K?.userAdjustedZoom){const m=K.previewFrameWrapper.clientWidth-24;m>0&&m<u?tt=Math.max(m/u,.3):tt=1}kr(tt)}finally{Kt()}},{once:!0})}function ec(e){if(!q)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(t.checked?q.sections.add(n):q.sections.delete(n),br(q),Ar(),pt())}function tc(e){if(!q)return;const t=e.currentTarget,n=t?.dataset?.sectionId,a=t?.dataset?.fieldId;if(!n||!a)return;const s=q.context||"reservation",r=q.fields||(q.fields=kn(s)),i=yo(r,n);t.checked?i.add(a):i.delete(a),br(q),pt()}function nc(e){if(!q)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(Ea(q,n),q.sectionExpansions[n]=t.open)}function Ar(){if(!K?.toggles||!q)return;const{toggles:e}=K,t=q.fields||{},n=q.context||"reservation";Ea(q);const a=An(n),s=Js(n),r=a.map(({id:i,labelKey:o,fallback:d})=>{const u=c(o,d),l=q.sections.has(i),y=s[i]||[],p=bo(q,i),m=y.length?`<div class="quote-toggle-sublist">
          ${y.map(f=>{const h=Sa(t,i,f.id),v=l?"":"disabled",j=f.labelKey?c(f.labelKey,f.fallback):f.fallback;return`
              <label class="quote-toggle quote-toggle--field">
                <input type="checkbox" data-field-toggle data-section-id="${i}" data-field-id="${f.id}" ${h?"checked":""} ${v}>
                <span>${b(j)}</span>
              </label>
            `}).join("")}
        </div>`:"";return`
      <details class="quote-toggle-group" data-section-group data-section-id="${i}" ${p?"open":""}>
        <summary class="quote-toggle-summary">
          <label class="quote-toggle quote-toggle--section">
            <input type="checkbox" data-section-toggle data-section-id="${i}" ${l?"checked":""}>
            <span>${b(u)}</span>
          </label>
          ${y.length?'<span class="quote-toggle-caret" aria-hidden="true"></span>':""}
        </summary>
        ${m}
      </details>
    `}).join("");e.innerHTML=r,e.querySelectorAll("input[data-section-toggle]").forEach(i=>{i.addEventListener("change",ec)}),e.querySelectorAll("input[data-field-toggle]").forEach(i=>{i.addEventListener("change",tc)}),e.querySelectorAll("details[data-section-group]").forEach(i=>{i.addEventListener("toggle",nc)})}function ac(){if(K?.modal)return K;const e=document.createElement("div");e.id="reservationQuoteModal",e.className="modal fade quote-preview-modal",e.tabIndex=-1,e.setAttribute("aria-labelledby","reservationQuoteModalLabel"),e.setAttribute("aria-hidden","true"),e.style.display="none",e.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationQuoteModalLabel">${b(c("reservations.quote.previewTitle","معاينة عرض سعر"))}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="quote-preview-layout">
            <aside class="quote-preview-sidebar">
              <h6>${b(c("reservations.quote.toggleHeading","حدد المعلومات المراد تصديرها"))}</h6>
              <div class="quote-toggle-list" data-quote-toggles></div>
              <div class="quote-meta-info" data-quote-meta></div>
              <div class="quote-terms-editor" data-quote-terms-editor>
                <label class="quote-terms-editor__label" for="quote-terms-input">${b(c("reservations.quote.termsEditor.title","الشروط العامة (قابلة للتعديل)"))}</label>
                <textarea id="quote-terms-input" class="quote-terms-editor__textarea" rows="6" data-quote-terms-input placeholder="${b(c("reservations.quote.termsEditor.placeholder","اكتب كل شرط في سطر مستقل"))}"></textarea>
                <button type="button" class="quote-terms-reset" data-quote-terms-reset>${b(c("reservations.quote.termsEditor.reset","استعادة الشروط الافتراضية"))}</button>
              </div>
            </aside>
            <section class="quote-preview-panel">
              <div class="quote-preview" data-quote-preview></div>
            </section>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">${b(c("reservations.quote.actions.close","إغلاق"))}</button>
          <button type="button" class="btn btn-primary" data-quote-download>
            ${b(c("reservations.quote.actions.export","📄 تنزيل PDF"))}
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector("[data-quote-toggles]"),n=e.querySelector("[data-quote-preview]"),a=e.querySelector("[data-quote-meta]"),s=e.querySelector("[data-quote-terms-input]"),r=e.querySelector("[data-quote-terms-reset]"),i=e.querySelector("[data-quote-download]"),o=e.querySelector(".modal-header"),d=o?.querySelector(".btn-close"),u=Array.from(e.querySelectorAll('[data-bs-dismiss="modal"]')),l=document.createElement("div");l.className="quote-preview-header-actions",o&&o.insertBefore(l,d||null);const y=document.createElement("iframe");y.className="quote-preview-frame",y.setAttribute("title",c("reservations.quote.previewTitle","معاينة عرض سعر")),y.setAttribute("loading","lazy"),y.setAttribute("frameborder","0");const p=document.createElement("div");p.className="quote-preview-zoom-controls",p.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-zoom-out title="${b(c("reservations.quote.zoom.out","تصغير"))}">−</button>
    <span class="quote-preview-zoom-value" data-zoom-value>100%</span>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-in title="${b(c("reservations.quote.zoom.in","تكبير"))}">+</button>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-reset title="${b(c("reservations.quote.zoom.reset","إعادة الضبط"))}">1:1</button>
  `;const m=document.createElement("div");m.className="quote-preview-frame-wrapper",m.appendChild(y),n.innerHTML="";const f=document.createElement("div");f.className="quote-preview-scroll",f.appendChild(m),n.appendChild(f);const h=document.createElement("div");h.className="quote-preview-status",h.setAttribute("role","status"),h.setAttribute("aria-live","polite"),h.hidden=!0,h.innerHTML=`
    <span class="quote-preview-spinner" data-quote-status-spinner aria-hidden="true"></span>
    <span data-quote-status-text>${b(Zs("render"))}</span>
    <button type="button" class="quote-preview-status-action" data-quote-status-action hidden></button>
  `,n.appendChild(h),l.appendChild(p),i?.addEventListener("click",async()=>{if(q){i.disabled=!0;try{await xr()}finally{i.disabled=!1}}});const v=()=>{Gn()||Wn(e)};u.forEach(k=>{k?.addEventListener("click",v)}),d&&!u.includes(d)&&d.addEventListener("click",v),e.addEventListener("click",k=>{Gn()||k.target===e&&Wn(e)}),K={modal:e,toggles:t,preview:n,previewScroll:f,previewFrameWrapper:m,zoomControls:p,zoomValue:p.querySelector("[data-zoom-value]"),previewFrame:y,meta:a,downloadBtn:i,statusIndicator:h,statusText:h.querySelector("[data-quote-status-text]"),statusSpinner:h.querySelector("[data-quote-status-spinner]"),statusAction:h.querySelector("[data-quote-status-action]"),termsInput:s,termsReset:r,statusKind:null,userAdjustedZoom:!1};const j=p.querySelector("[data-zoom-out]"),g=p.querySelector("[data-zoom-in]"),C=p.querySelector("[data-zoom-reset]");return j?.addEventListener("click",()=>es(-.1)),g?.addEventListener("click",()=>es(.1)),C?.addEventListener("click",()=>bn(1,{markManual:!0})),s&&s.addEventListener("input",sc),r&&r.addEventListener("click",rc),bn(tt),K}function bn(e,{silent:t=!1,markManual:n=!1}={}){tt=Math.min(Math.max(e,.25),2.2),n&&K&&(K.userAdjustedZoom=!0),kr(tt),!t&&K?.zoomValue&&(K.zoomValue.textContent=`${Math.round(tt*100)}%`)}function es(e){bn(tt+e,{markManual:!0})}function kr(e){if(!K?.previewFrame||!K.previewFrameWrapper)return;const t=K.previewFrame,n=K.previewFrameWrapper,a=Number(t.dataset.baseWidth)||794,s=Number(t.dataset.baseHeight)||t.contentDocument?.body?.scrollHeight||1123;t.style.transform=`scale(${e})`,t.style.transformOrigin="top center",qa()?(n.style.width="100%",n.style.maxWidth="100%",n.style.minWidth="0"):(n.style.width=`${a}px`,n.style.maxWidth=`${a}px`,n.style.minWidth=`${a}px`),n.style.minHeight=`${s}px`,n.style.height=`${s}px`}function Pr(){if(!K?.meta||!q)return;const{meta:e}=K;e.innerHTML=`
    <div class="quote-meta-card">
      <div><span>${b(c("reservations.quote.labels.number","رقم عرض سعر"))}</span><strong>${b(q.quoteNumber)}</strong></div>
      <div><span>${b(c("reservations.quote.labels.dateGregorian","التاريخ الميلادي"))}</span><strong>${b(q.quoteDateLabel)}</strong></div>
    </div>
  `}function Pa(){if(!K?.termsInput)return;const e=(q?.terms&&q.terms.length?q.terms:He).join(`
`);K.termsInput.value!==e&&(K.termsInput.value=e)}function sc(e){if(!q)return;const t=Vn(e?.target?.value??"");if(t.length){q.terms=t;const n=document.getElementById("reservation-terms");n&&(n.value=e.target.value);const a=document.getElementById("edit-res-terms");a&&(a.value=e.target.value)}else{q.terms=[...He],Pa();const n=He.join(`
`),a=document.getElementById("reservation-terms");a&&(a.value=n);const s=document.getElementById("edit-res-terms");s&&(s.value=n)}pt()}function rc(e){if(e?.preventDefault?.(),!q)return;q.terms=[...He];const t=document.getElementById("reservation-terms");t&&(t.value=He.join(`
`));const n=document.getElementById("edit-res-terms");n&&(n.value=He.join(`
`)),Pa(),pt()}async function xr(){if(!q)return;gt("export");const t=!qa()&&lr(),n=Pn(),a=null,s=!n&&t?window.open("","_blank"):null;(d=>{if(d)try{d.document.open(),d.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${b(c("reservations.quote.status.exporting","جاري تجهيز ملف PDF..."))}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${b(c("reservations.quote.status.exporting","جاري تجهيز ملف PDF..."))}</h1><p>${b(c("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار..."))}</p></div></body></html>`),d.document.close()}catch(u){rt("failed to prime download window",u)}})(s);let i=null;const o=c("reservations.quote.errors.browserLimit","تعذر إتمام عملية التحويل بسبب قيود المتصفح، يرجى إعادة المحاولة أو تقليل حجم المحتوى.");try{await To(),_n("html2pdf ensured");const d=q.context||"reservation",u=wr({context:d,reservation:q.reservation,customer:q.customer,project:q.project,crewAssignments:q.crewAssignments,totals:q.totals,totalsDisplay:q.totalsDisplay,rentalDays:q.rentalDays,currencyLabel:q.currencyLabel,sections:q.sections,fieldSelections:q.fields,quoteNumber:q.quoteNumber,quoteDate:q.quoteDateLabel,terms:q.terms,projectCrew:q.projectCrew,projectExpenses:q.projectExpenses,projectEquipment:q.projectEquipment,projectInfo:q.projectInfo,clientInfo:q.clientInfo,paymentSummary:q.paymentSummary,projectTotals:q.projectTotals});i=document.createElement("div"),i.innerHTML=u,Object.assign(i.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(i),qs(i),Is(i),As(i),_n("export container prepared");const l=i.firstElementChild;if(l){l.setAttribute("dir","rtl"),l.style.direction="rtl",l.style.textAlign="right",l.setAttribute("data-theme","light"),l.classList.remove("dark","dark-mode"),l.style.margin="0",l.style.padding="0",l.style.width="210mm",l.style.maxWidth="210mm",l.style.marginLeft="auto",l.style.marginRight="auto",l.scrollTop=0,l.scrollLeft=0;try{await yn(l,{context:"export"}),await qr(120),Ir(l)&&await yn(l,{context:"export"}),await Gt(l),ka(l),_n("layout complete for export document")}catch(p){Jn(p,"layoutQuoteDocument",{suppressToast:!0})}}const y=`quotation-${q.quoteNumber}.pdf`;await Zo(l,{filename:y,safariWindowRef:s,mobileWindowRef:a}),q.sequenceCommitted||(Do(q.quoteSequence),q.sequenceCommitted=!0)}catch(d){Xn({container:i,safariWindowRef:s,mobileWindowRef:a}),i=null,Jn(d,"exportQuoteAsPdf",{toastMessage:o})}finally{i&&i.parentNode&&i.parentNode.removeChild(i),Kt()}}function $r(){const e=ac();e?.modal&&(Vt=!1,tt=1,K&&(K.userAdjustedZoom=!1),bn(tt,{silent:!0}),Ar(),Pr(),Pa(),pt(),po(e.modal))}async function ic({reservation:e,customer:t,project:n}){if(!e){P(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز"));return}await Er();const a=Aa(e),{totalsDisplay:s,totals:r,rentalDays:i}=vr(e,a,n),o=c("reservations.create.summary.currency","SR"),{sequence:d,quoteNumber:u}=fr("reservation"),l=new Date,y=to();q={context:"reservation",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:i,currencyLabel:o,projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(An("reservation").filter(p=>p.defaultSelected).map(p=>p.id)),sectionExpansions:wa("reservation"),fields:kn("reservation"),terms:y,quoteSequence:d,quoteNumber:u,quoteDate:l,quoteDateLabel:gr(l),sequenceCommitted:!1},hr(q),$r();try{rr()}catch{}}async function Qc({project:e}){if(!e){P(c("projects.toast.notFound","⚠️ تعذر العثور على بيانات المشروع"));return}await Er();let t=Za(e);const{project:n}=t;if(!n){P(c("projects.toast.notFound","⚠️ تعذر العثور على بيانات المشروع"));return}try{(!Array.isArray(t.equipmentItems)||t.equipmentItems.length===0)&&n?.id!=null&&(await ps({project_id:n.id}),t=Za(n))}catch(o){console.warn("[reservationPdf] refreshReservationsForProject failed, proceeding with snapshot/state",o)}const{sequence:a,quoteNumber:s}=fr("project"),r=new Date,i=[...eo];q={context:"project",reservation:null,customer:t.customer,project:n,technicians:t.crew||[],clientInfo:t.clientInfo,projectInfo:t.projectInfo,projectCrew:t.crew,projectExpenses:t.expenses,projectEquipment:t.equipment,equipmentItems:t.equipmentItems||[],crewAssignments:t.crewAssignments||[],totals:t.totals,projectTotals:t.projectTotals,totalsDisplay:t.totalsDisplay,rentalDays:t.projectDurationDays,currencyLabel:t.currencyLabel,sections:new Set(An("project").filter(o=>o.defaultSelected).map(o=>o.id)),sectionExpansions:wa("project"),fields:kn("project"),terms:i,quoteSequence:a,quoteNumber:s,quoteDate:r,quoteDateLabel:gr(r),sequenceCommitted:!1,paymentSummary:t.paymentSummary,projectNotes:t.notes,paymentHistory:t.paymentHistory},hr(q),$r();try{rr()}catch{}}function oc({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a}={}){const s=jt(),{reservations:r=[],customers:i=[],technicians:o=[],projects:d=[]}=Se(),u=r.map(g=>{const C=Nn(g);return{...C,id:g.id??C.id,reservationId:g.reservationId??g.reservation_id??C.reservationId,reservationCode:g.reservationCode??g.reservation_code??C.reservationCode}}),l=u,y=Array.isArray(s)?s:o||[],p=new Map((d||[]).map(g=>[String(g.id),g])),m=document.getElementById(e);if(!m){console.warn("⚠️ [reservations/renderers] container not found",e);return}if(!l||l.length===0){m.innerHTML=`<p>${c("reservations.list.empty","⚠️ لا توجد حجوزات بعد.")}</p>`;return}const f=t||yi(),h=new Map(i.map(g=>[String(g.id),g])),v=new Map(y.map(g=>[String(g.id),g])),j=Wi({reservations:u,filters:f,customersMap:h,techniciansMap:v,projectsMap:p});if(j.length===0){m.innerHTML=`<p>${c("reservations.list.noResults","🔍 لا توجد حجوزات مطابقة للبحث.")}</p>`;return}m.innerHTML=`<div class="reservations-grid">${Ji({entries:j,customersMap:h,techniciansMap:v,projectsMap:p})}</div>`,m.querySelectorAll('[data-action="details"]').forEach(g=>{const C=Number(g.dataset.reservationIndex);Number.isNaN(C)||g.addEventListener("click",()=>{typeof n=="function"&&n(C)})}),m.querySelectorAll('button[data-action="confirm"]').forEach(g=>{const C=Number(g.dataset.reservationIndex);Number.isNaN(C)||g.addEventListener("click",k=>{k.stopPropagation(),typeof a=="function"&&a(C,k)})})}function cc(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:s=[],customers:r=[],projects:i=[]}=Se(),o=s.map(h=>{const v=Nn(h);return{...v,id:h.id??v.id,reservationId:h.reservationId??h.reservation_id??v.reservationId,reservationCode:h.reservationCode??h.reservation_code??v.reservationCode}}),d=s[e];if(!d)return P(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const u=o[e]??Nn(d),l=r.find(h=>String(h.id)===String(d.customerId)),y=d.projectId?i.find(h=>String(h.id)===String(d.projectId)):null,p=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),f=()=>{const h=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},v=document.getElementById("reservation-details-edit-btn");v&&(v.onclick=()=>{h(),typeof t=="function"&&t(e,{reservation:d,customer:l,getEditContext:a})});const j=document.getElementById("reservation-details-delete-btn");j&&(j.onclick=()=>{h(),typeof n=="function"&&n(e,{reservation:d,customer:l})});const g=p?.querySelector('[data-action="open-project"]');g&&y&&g.addEventListener("click",()=>{h();const k=y?.id!=null?String(y.id):"",H=k?`projects.html?project=${encodeURIComponent(k)}`:"projects.html";window.location.href=H});const C=document.getElementById("reservation-details-export-btn");C&&(C.onclick=async k=>{k?.preventDefault?.(),k?.stopPropagation?.(),C.blur();try{await ic({reservation:d,customer:l,project:y})}catch(H){console.error("❌ [reservations] export to PDF failed",H),P(c("reservations.details.actions.exportFailed","⚠️ تعذر تصدير الحجز إلى PDF"),"error")}});try{const k=p?.querySelector("[data-tech-slider]");if(k){const H=k.querySelector("[data-slider-track]"),S=k.querySelector("[data-slider-prev]"),A=k.querySelector("[data-slider-next]");if(H&&(S||A)){const L=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",T=()=>{const B=H.querySelector(".reservation-technician-card"),V=B&&B.getBoundingClientRect().width||220,_=12,N=Math.max(1,Math.floor(H.clientWidth/(V+_)));return Math.max(V+_,Math.floor(N*(V+_)*.9))},W=()=>{const B=Math.max(0,H.scrollWidth-H.clientWidth-2),V=H.scrollLeft<=1,_=H.scrollLeft>=B;S&&(S.disabled=V),A&&(A.disabled=_)},$=B=>{const V=T()*B,_=L?-V:V;H.scrollBy({left:_,behavior:"smooth"})};S?.addEventListener("click",()=>$(-1)),A?.addEventListener("click",()=>$(1)),H.addEventListener("scroll",W,{passive:!0}),window.addEventListener("resize",W,{passive:!0}),setTimeout(W,0)}}}catch{}};if(p){const h=jt()||[];p.innerHTML=Ta(u,l,h,e,y),f(),ws().then(()=>{const v=jt()||[];p.innerHTML=Ta(u,l,v,e,y),f()}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function Dt(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Qt(e,n),end:Qt(t,a)}}function hn(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function xa(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function jr(){const{container:e,select:t,hint:n,addButton:a}=xa();if(!t)return;const s=t.value,r=fs(),i=c("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","اختر الحزمة")}</option>`,d=r.map(l=>{const y=Number.isFinite(Number(l.price))?Number(l.price):0,p=I(y.toFixed(2)),m=`${l.name} — ${p} ${i}`;return`<option value="${hn(l.id)}">${hn(m)}</option>`}).join("");t.innerHTML=`${o}${d}`;const u=r.length>0;t.disabled=!u,a&&(a.disabled=!u),e&&(e.hidden=!u,e.setAttribute("aria-hidden",u?"false":"true")),n&&(u?(n.textContent=c("reservations.create.packages.hint","حدد الحزمة ثم اضغط على الزر لإضافتها للحجز."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","لا توجد حزم معرفة حالياً. يمكنك إضافتها لاحقاً من لوحة التحكم."),n.dataset.state="empty")),u&&s&&r.some(l=>l.id===s)?t.value=s:t.selectedIndex=0}function lc(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||P(c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),{success:!1,reason:"invalid"};const{index:a,items:s=[]}=yt(),{start:r,end:i}=Dt(),{reservations:o=[]}=Se(),d=a!=null&&o[a]||null,u=d?.id??d?.reservationId??null,l=Os(n,{existingItems:s,start:r,end:i,ignoreReservationId:u});if(!l.success)return t||P(l.message||c("reservations.toast.packageInvalid","⚠️ يرجى اختيار حزمة صالحة أولاً")),l;const y=[...s,l.package];return bt(a,y),ft(y),We(),t||P(c("reservations.toast.packageAdded","✅ تم إضافة الحزمة بنجاح")),l}function ts(){const{select:e}=xa();if(!e)return;const t=e.value||"";lc(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function dc(){const{addButton:e,select:t}=xa();e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{ts()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),ts())}),t.dataset.listenerAttached="true"),jr()}function ft(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","لا توجد معدات"),a=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","صورة"),r=c("reservations.equipment.actions.increase","زيادة الكمية"),i=c("reservations.equipment.actions.decrease","تقليل الكمية"),o=c("reservations.equipment.actions.remove","إزالة البند");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-center">${n}</td></tr>`,as(t);return}const{groups:d}=Bt({items:e});t.innerHTML=d.map(u=>{const l=u.items[0]||{},y=Nt(l)||u.image,p=y?`<img src="${y}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',m=String(u?.type||"").toLowerCase()==="package"||u.items.some($=>$?.type==="package"),f=I(String(u.count)),h=$t(u.unitPrice),v=Number.isFinite(h)?St(h):0,j=$t(u.totalPrice),g=Number.isFinite(j)?j:v*(Number.isFinite(u.count)?u.count:1),C=St(g),k=`${I(v.toFixed(2))} ${a}`,H=`${I(C.toFixed(2))} ${a}`,S=u.barcodes.map($=>I(String($||""))).filter(Boolean),A=S.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
            <ul class="reservation-barcode-list">
              ${S.map($=>`<li>${$}</li>`).join("")}
            </ul>
          </details>`:"";let L="";if(m){const $=new Map,B=_=>{const N=Number.parseFloat(I(String(_??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(N)||N<=0||N>99?1:Math.round(N)},V=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&V.push(...u.packageItems),u.items.forEach(_=>{Array.isArray(_?.packageItems)&&V.push(..._.packageItems)}),V.forEach(_=>{if(!_)return;const N=re(_.barcode||_.normalizedBarcode||_.desc||Math.random());if(!N)return;const D=$.get(N),J=B(_.qtyPerPackage??_.perPackageQty??_.quantityPerPackage??_.qty??_.quantity??1),Q=Math.max(1,Math.min(J,99));if(D){D.qty=Q;return}$.set(N,{desc:_.desc||_.barcode||c("reservations.create.packages.unnamedItem","عنصر بدون اسم"),qty:Q,barcode:_.barcode??_.normalizedBarcode??""})}),$.size){const _=Array.from($.values()).map(N=>{const D=I(String(N.qty>0?Math.min(N.qty,99):1)),J=hn(N.desc||""),Q=N.barcode?` <span class="reservation-package-items__barcode">(${hn(I(String(N.barcode)))})</span>`:"";return`<li>${J}${Q} × ${D}</li>`}).join("");L=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","عرض محتويات الحزمة")}</summary>
              <ul class="reservation-package-items__list">
                ${_}
              </ul>
            </details>
          `}}const T=m?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",W=m?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${p}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${m?`${L||""}${A||""}`:A}
              </div>
            </div>
          </td>
          <td>
            <div class="${T}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${i}"${W}>−</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${r}"${W}>+</button>
            </div>
          </td>
          <td>${k}</td>
          <td>${H}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${o}">🗑️</button>
          </td>
        </tr>
      `}).join(""),as(t)}function uc(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","💵 دفعة مالية");case"percent":return c("reservations.paymentHistory.type.percent","٪ دفعة نسبة");default:return c("reservations.paymentHistory.type.unknown","دفعة")}}function xn(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let t=$n();const n=document.getElementById("edit-res-project")?.value||"";if(n)try{const i=(Se()?.projects||[]).find(d=>String(d.id)===String(n)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(t=o)}catch{}if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","لا توجد دفعات مسجلة")}</div>`,ns();return}const a=c("reservations.create.summary.currency","SR"),s=t.map((r,i)=>{const o=Number.isFinite(Number(r?.amount))&&Number(r.amount)>0?`${I(Number(r.amount).toFixed(2))} ${a}`:"—",d=Number.isFinite(Number(r?.percentage))&&Number(r.percentage)>0?`${I(Number(r.percentage).toFixed(2))}%`:"—",u=r?.recordedAt?I(it(r.recordedAt)):"—",l=uc(r?.type),y=r?.note?I(r.note):"";return`
      <tr>
        <td>${l}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${u}</td>
        <td>${y}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${c("reservations.paymentHistory.actions.delete","حذف الدفعة")}">🗑️</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","نوع الدفعة")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","المبلغ")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","النسبة")}</th>
            <th>${c("reservations.paymentHistory.headers.date","التاريخ")}</th>
            <th>${c("reservations.paymentHistory.headers.note","ملاحظات")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${s}</tbody>
      </table>
    </div>
  `,ns()}function mc(){if(Wt()){P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=Tr(e);let a=Nr(t);if(!Number.isFinite(a)||a<=0){P(c("reservations.toast.paymentInvalid","⚠️ يرجى إدخال قيمة دفعة صحيحة"));return}const s=Ln.lastResult,r=Number(s?.total)||0,i=Number(s?.paidPercent)||0,o=Number(s?.paidAmount)||0,d=c("reservations.create.summary.currency","SR");let u=null,l=null;if(n==="percent"){const p=Math.max(0,100-i);if(p<=1e-4){P(c("reservations.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة"));return}const m=Math.min(a,p);if(m!==a){const f=I(m.toFixed(2));P(c("reservations.toast.paymentCappedPercent","ℹ️ تم ضبط الدفعة إلى {value}% لاستكمال 100%").replace("{value}",f)),a=m}l=Number(a.toFixed(2)),r>0&&(u=a/100*r)}else{const p=Math.max(0,r-o);if(p<=1e-4){P(c("reservations.toast.paymentNoRemainingBalance","⚠️ تم تسجيل كامل قيمة الحجز، لا يمكن إضافة دفعة جديدة"));return}const m=Math.min(a,p);if(m!==a){const f=`${I(m.toFixed(2))} ${d}`;P(c("reservations.toast.paymentCappedAmount","ℹ️ تم ضبط الدفعة إلى {amount} لاستكمال المبلغ المتبقي").replace("{amount}",f)),a=m}u=Number(a.toFixed(2)),r>0&&(l=u/r*100)}u!=null&&(u=Number(u.toFixed(2))),l!=null&&(l=Number(l.toFixed(2)));const y={type:n,value:a,amount:u,percentage:l,recordedAt:new Date().toISOString()};Ic(y),$a($n()),xn(),We(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),P(c("reservations.toast.paymentAdded","✅ تم تسجيل الدفعة"))}function ns(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(Wt()){n.preventDefault(),P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}mc()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(Wt()){n.preventDefault(),P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error");return}const s=Number(a.dataset.index);Number.isNaN(s)||(Ac(s),$a($n()),xn(),We(),P(c("reservations.toast.paymentRemoved","🗑️ تم حذف الدفعة")))}),t.dataset.listenerAttached="true")}function pc(e){const{index:t,items:n}=yt(),{groups:a}=Bt({items:n}),s=a.find(o=>o.key===e);if(!s||s.items.some(o=>o?.type==="package"))return;let r=-1;for(let o=n.length-1;o>=0;o-=1){const d=n[o];if(Jt(d)===e&&d?.type!=="package"){r=o;break}}if(r<0)return;const i=n.filter((o,d)=>d!==r);bt(t,i),ft(i),We()}function fc(e){const{index:t,items:n}=yt(),{groups:a}=Bt({items:n}),s=a.find(o=>o.key===e);if(!s)return;let r=n.filter(o=>Jt(o)!==e);if(s.items.some(o=>o&&o.type==="package")){const o=wt(s.packageId??s.items.find(y=>y?.type==="package")?.packageId??""),d=re(s.package_code??s.packageDisplayCode??s.barcode??"");r=r.filter(y=>{if(!y||typeof y!="object"||y.type!=="package")return!0;const p=wt(y.packageId??y.package_id??y.id??""),m=re(y.barcode??y.package_code??"");return!(o&&p===o||d&&m&&m===d)});const u=new Set,l=new Set;s.items.forEach(y=>{(Array.isArray(y?.packageItems)?y.packageItems:[]).forEach(m=>{const f=re(m?.barcode||m?.normalizedBarcode||"");f&&u.add(f);const h=m?.equipmentId??m?.equipment_id??null;h!=null&&l.add(String(h))})}),(u.size||l.size)&&(r=r.filter(y=>{const p=re(y?.barcode||""),m=y?.equipmentId??y?.id??null;return!(p&&u.has(p)||m!=null&&l.has(String(m)))}))}r.length!==n.length&&(bt(t,r),ft(r),We())}function yc(e){const{index:t,items:n}=yt(),{groups:a}=Bt({items:n}),s=a.find(v=>v.key===e);if(!s||s.items.some(v=>v?.type==="package"))return;const{start:r,end:i}=Dt();if(!r||!i){P(c("reservations.toast.requireOverallDates","⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات"));return}const{reservations:o=[]}=Se(),d=t!=null&&o[t]||null,u=d?.id??d?.reservationId??null,l=new Set(n.map(v=>re(v.barcode))),{equipment:y=[]}=Se(),p=(y||[]).find(v=>{const j=re(v?.barcode);return!j||l.has(j)||Jt({desc:v?.desc||v?.description||v?.name||"",price:Number(v?.price)||0})!==e||!os(v)?!1:!ot(j,r,i,u)});if(!p){P(c("reservations.toast.noAdditionalUnits","⚠️ لا توجد وحدات إضافية متاحة حالياً"));return}const m=re(p.barcode),f=qt(p);if(!f){P(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const h=[...n,{id:f,equipmentId:f,barcode:m,desc:p.desc||p.description||p.name||s.description||"",qty:1,price:Number.isFinite(Number(p.price))?Number(p.price):s.unitPrice,image:Nt(p)}];bt(t,h),ft(h),We()}function as(e){!e||e.dataset.groupListenerAttached||(e.addEventListener("click",t=>{const n=t.target.closest("button[data-action]");if(!n)return;const{action:a,groupKey:s,itemIndex:r}=n.dataset;if(a==="decrease-edit-group"&&s){pc(s);return}if(a==="increase-edit-group"&&s){yc(s);return}if(a==="remove-edit-group"&&s){fc(s);return}if(a==="remove-edit-item"){const i=Number(r);Number.isNaN(i)||gc(i)}}),e.dataset.groupListenerAttached="true")}function Wt(){return!!document.getElementById("edit-res-project")?.value}function bc(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{Wt()&&(P(c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(s=>a.addEventListener(s,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function hc(e){const t=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),s=document.getElementById("edit-res-paid"),r=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([n,a,s,r,i,o,d].forEach(bc),e){if(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),s){const u=document.getElementById("edit-res-project")?.value||"";let l="unpaid";if(u)try{const p=(Se()?.projects||[]).find(f=>String(f.id)===String(u)),m=typeof p?.paymentStatus=="string"?p.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(l=m)}catch{}s.value=l,s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t,s.dataset&&delete s.dataset.userSelected}r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),d&&(d.dataset.linkedDisabled="true")}else n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function We(){const e=document.getElementById("edit-res-summary");if(!e)return;xn();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),Ge(a),We()}),a.dataset.listenerAttached="true");const s=I(t?.value||"0");t&&(t.value=s);const r=parseFloat(s)||0,i=n?.value||"percent",o=Wt();hc(o);const d=document.getElementById("edit-res-tax"),u=o?!1:d?.checked||!1,l=!o&&a?.dataset?.userSelected==="true";let y="unpaid";if(o){const C=document.getElementById("edit-res-project")?.value||"";if(C)try{const H=(Se()?.projects||[]).find(A=>String(A.id)===String(C)),S=typeof H?.paymentStatus=="string"?H.paymentStatus.toLowerCase():null;S&&["paid","partial","unpaid"].includes(S)&&(y=S)}catch{}}else y=l&&a?.value||"unpaid";let p=null;!o&&u&&(Ye("edit-res-company-share"),p=Ct("edit-res-company-share"),(!Number.isFinite(p)||p<=0)&&(Ye("edit-res-company-share"),p=Ct("edit-res-company-share")));const{items:m=[],payments:f=[]}=yt(),{start:h,end:v}=Dt(),j=Ln({items:m,discount:r,discountType:i,applyTax:u,paidStatus:y,start:h,end:v,companySharePercent:p,paymentHistory:f});e.innerHTML=j;const g=Ln.lastResult;if(g&&a){const C=g.paymentStatus;l?Ge(a,a.value):(a.value!==C&&(a.value=C),a.dataset&&delete a.dataset.userSelected,Ge(a,C))}else a&&Ge(a,a.value)}function gc(e){if(e==null)return;const{index:t,items:n}=yt();if(!Array.isArray(n))return;const a=n.filter((s,r)=>r!==e);bt(t,a),ft(a),We()}function vc(e){const t=e?.value??"",n=re(t);if(!n)return;const a=na(n);if(!a){P(c("reservations.toast.barcodeNotInCatalog","❌ الباركود غير موجود ضمن المعدات"));return}const s=dt(a);if(s==="maintenance"||s==="retired"){P(Et(s));return}const r=re(n),{index:i,items:o=[]}=yt();if(o.findIndex(v=>re(v.barcode)===r)>-1){P(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const{start:u,end:l}=Dt();if(!u||!l){P(c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"));return}const{reservations:y=[]}=Se(),p=i!=null&&y[i]||null,m=p?.id??p?.reservationId??null;if(ot(r,u,l,m)){P(c("reservations.toast.equipmentTimeConflictSimple","⚠️ هذه المعدة محجوزة في نفس الفترة الزمنية"));return}const f=qt(a);if(!f){P(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const h=[...o,{id:f,equipmentId:f,barcode:r,desc:a.desc,qty:1,price:a.price,image:a.image||a.imageUrl||a.img||null}];bt(i,h),e&&(e.value=""),ft(h),We()}function gn(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Fs(t),a=re(n?.barcode||t);if(!n||!a){P(c("reservations.toast.equipmentNameNotFound","❌ لم يتم العثور على معدة بالاسم المدخل"));return}const s=dt(n);if(s==="maintenance"||s==="retired"){P(Et(s));return}const{start:r,end:i}=Dt();if(!r||!i){P(c("reservations.toast.requireOverallDates","⚠️ يرجى تحديد تواريخ الحجز قبل إضافة المعدات"));return}const{index:o,items:d=[]}=yt();if(d.some(h=>re(h.barcode)===a)){P(c("reservations.toast.equipmentDuplicate","⚠️ هذه المعدة موجودة بالفعل في الحجز"));return}const{reservations:l=[]}=Se(),y=o!=null&&l[o]||null,p=y?.id??y?.reservationId??null;if(ot(a,r,i,p)){P(c("reservations.toast.equipmentTimeConflictSimple","⚠️ هذه المعدة محجوزة في نفس الفترة الزمنية"));return}const m=qt(n);if(!m){P(c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف"));return}const f=[...d,{id:m,equipmentId:m,barcode:a,desc:n.desc,qty:1,price:n.price,image:n.image||n.imageUrl||n.img||null}];bt(o,f),ft(f),We(),e.value=""}function Cr(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),gn(e))});const t=()=>{Rs(e.value,"edit-res-equipment-description-options")&&gn(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{We()});const e=()=>{dc()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{jr()})}typeof window<"u"&&(window.getEditReservationDateRange=Dt,window.renderEditPaymentHistory=xn);function Sc(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){On(e);return}gn(e)}}function Gc(){mt(),Cr()}function wc(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let xt=null,et=[],nt=[],Yn=null,Me={},Tn=!1;const Ec="__DEBUG_CREW__";function qc(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Ec);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function ss(e,t){if(qc())try{console.log(`🪵 [crew-debug:edit] ${e}`,t)}catch{}}function Ut(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),s=document.getElementById("edit-res-confirmed-wrapper"),r=!!e;if(n&&(n.value=r?"true":"false"),a){const i=a.dataset.confirmLabel||"✅ تم التأكيد",o=a.dataset.pendingLabel||"⏳ بانتظار التأكيد";a.innerHTML=r?i:o,a.dataset.state=r?"confirmed":"pending",a.classList.toggle("btn-success",r&&!t),a.classList.toggle("btn-outline-secondary",!r||t),a.disabled=t,a.setAttribute("aria-pressed",r?"true":"false")}s&&s.classList.toggle("is-disabled",t)}function an(){return document.getElementById("edit-res-confirmed")?.value==="true"}function yt(){return{index:xt,items:et,payments:nt}}function bt(e,t,n=nt){xt=typeof e=="number"?e:null,et=Array.isArray(t)?[...t]:[],nt=Array.isArray(n)?[...n]:[]}function _r(){xt=null,et=[],ti(),nt=[]}function $n(){return[...nt]}function $a(e){nt=Array.isArray(e)?[...e]:[]}function Ic(e){e&&(nt=[...nt,e])}function Ac(e){!Number.isInteger(e)||e<0||(nt=nt.filter((t,n)=>n!==e))}function sn(e,t=1){const n=Number.parseFloat(I(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function Zn(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(I(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function kc(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?re(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:sn(e.qty??e.quantity??e.count??1),price:Zn(e.price??e.unit_price??e.unitPrice??0),image:e.image??e.image_url??e.imageUrl??null}}function Pc(e,t=0){if(!e||typeof e!="object")return null;const n=wt(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=1,r=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:da(e)).map(p=>kc(p)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=Zn(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const p=Zn(i,0);p>0&&a>0&&(o=Number((p/a).toFixed(2)))}const d=e.package_code??e.packageCode??e.barcode??null,l=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,d,n].find(p=>p!=null&&String(p).trim()!=="")||`Package ${n}`,y=e.image??e.cover??e.thumbnail??r.find(p=>p?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:I(String(l)),name:I(String(l)),qty:a,price:o,barcode:d,packageItems:r,image:y}}function xc(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const s=e.get(a);if(s==null)return;const r=s-n;e.set(a,r>0?r:0)})}function $c(e={},t=[]){const n=Array.isArray(t)?t.map(o=>({...o})):[],a=Array.isArray(e?.packages)?e.packages:[];if(!a.length)return n;const s=a.map((o,d)=>Pc(o,d)).filter(Boolean);if(!s.length)return n;const r=new Map;s.forEach(o=>{const d=sn(o.qty??o.quantity??1);if(o.barcode){const u=re(o.barcode);if(u){const l=`package::${u}`;r.set(l,(r.get(l)??0)+d)}}(o.packageItems||[]).forEach(u=>{if(!u)return;const l=d*sn(u.qty??u.quantity??1),y=u.equipmentId??null,p=u.normalizedBarcode||(u.barcode?re(u.barcode):null);if(y!=null){const m=`equipment::${String(y)}`;r.set(m,(r.get(m)??0)+l)}if(p){const m=`barcode::${p}`;r.set(m,(r.get(m)??0)+l)}})});const i=[];return n.forEach(o=>{if(!o||typeof o!="object"){i.push(o);return}if(o.type==="package"){const v=wt(o.packageId??o.package_id??o.id??"");s.some(g=>g.packageId===v)||i.push({...o});return}const d=sn(o.qty??o.quantity??1),u=qt(o),l=o.barcode?re(o.barcode):null,y=[];u!=null&&y.push(`equipment::${String(u)}`),l&&y.push(`barcode::${l}`);const p=y.map(v=>r.get(v)??0).filter(v=>v>0);if(!p.length){i.push({...o});return}const m=Math.min(...p);if(m<=0){i.push({...o});return}const f=Math.min(m,d);if(xc(r,y,f),f>=d)return;const h=d-f;i.push({...o,qty:h,quantity:h})}),[...i,...s.map(o=>({...o}))]}function jc(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Tr(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Nr(e){if(!e)return null;const t=I(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function Cc(e,t){if(e){e.value="";return}}function Ht(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Lr(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(I(String(e.value??""))),a=Number.parseFloat(I(String(e.amount??""))),s=Number.parseFloat(I(String(e.percentage??""))),r=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,i=Number.isFinite(s)?s:t==="percent"&&Number.isFinite(n)?n:null,o=t??(Number.isFinite(r)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?r??null:o==="percent"?i??null:Number.isFinite(n)?n:null,u=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(r)?r:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:u}}function _c(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","اختر مشروعاً (اختياري)"),s=c("reservations.edit.project.missing","⚠️ المشروع غير متوفر (تم حذفه)"),r=t?.projectId?String(t.projectId):"",i=Array.isArray(e)?[...e].sort((d,u)=>String(u.createdAt||u.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${Ht(a)}</option>`];i.forEach(d=>{o.push(`<option value="${Ht(d.id)}">${Ht(d.title||a)}</option>`)}),r&&!i.some(d=>String(d.id)===r)&&o.push(`<option value="${Ht(r)}">${Ht(s)}</option>`),n.innerHTML=o.join(""),r?n.value=r:n.value=""}function Br(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),s=document.getElementById("edit-res-discount-type"),r=c("reservations.toast.linkedProjectDisabled","لا يمكن تمكين هذا الإجراء؛ يرجى تنفيذ هذه التعديلات من شاشة المشروع.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=r),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=r),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=r),s&&(s.value="percent",s.disabled=!0,s.classList.add("disabled","reservation-input-disabled"),s.title=r);else{if(t){const d=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",d&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("disabled","reservation-input-disabled"),s.title="")}ea("tax");const o=Me?.updateEditReservationSummary;typeof o=="function"&&o()}function ea(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const r=Me?.updateEditReservationSummary;typeof r=="function"&&r()};if(Tn){a();return}Tn=!0;const s=()=>{Tn=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(vt)),t.disabled){n.checked=!1,P(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة")),s();return}t.checked||(t.checked=!0),Ye("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?Ye("edit-res-company-share"):n.checked&&(n.checked=!1));s()}async function rs(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:s,updateEditReservationSummary:r,ensureModal:i}={}){const{customers:o,projects:d}=Se(),l=vn()?.[e];if(!l){P(c("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز"));return}Me={...Me,reservation:l,projects:d||[]},t?.(),_c(d||[],l);const y=l.projectId&&d?.find?.(R=>String(R.id)===String(l.projectId))||null,{effectiveConfirmed:p,projectLinked:m}=Lt(l,y),f=l.items?l.items.map(R=>({...R,equipmentId:R.equipmentId??R.equipment_id??R.id,barcode:re(R?.barcode)})):[],h=$c(l,f),j=(Array.isArray(l.paymentHistory)?l.paymentHistory:Array.isArray(l.payment_history)?l.payment_history:[]).map(R=>Lr(R)).filter(Boolean);bt(e,h,j);const g=c("reservations.list.unknownCustomer","غير معروف"),C=o?.find?.(R=>String(R.id)===String(l.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const k=document.getElementById("edit-res-id");k&&(k.value=l.reservationId||l.id);const H=document.getElementById("edit-res-customer");H&&(H.value=C?.customerName||g);const S=typeof a=="function"?a(l.start):{date:"",time:""},A=typeof a=="function"?a(l.end):{date:"",time:""};n?.("edit-res-start",S.date),n?.("edit-res-start-time",S.time),n?.("edit-res-end",A.date),n?.("edit-res-end-time",A.time);const L=document.getElementById("edit-res-notes");L&&(L.value=l.notes||"");const T=document.getElementById("edit-res-discount");if(T){const R=m?0:l.discount??0;T.value=I(R)}const W=document.getElementById("edit-res-discount-type");W&&(W.value=m?"percent":l.discountType||"percent");const $=l.projectId?!1:!!l.applyTax,B=document.getElementById("edit-res-tax");B&&(B.checked=$);const V=document.getElementById("edit-res-company-share");if(V){const R=l.companySharePercent??l.company_share_percent??l.companyShare??l.company_share??null,ce=R!=null?Number.parseFloat(I(String(R).replace("%","").trim())):NaN,te=l.companyShareEnabled??l.company_share_enabled??l.companyShareApplied??l.company_share_applied??null,be=te!=null?te===!0||te===1||te==="1"||String(te).toLowerCase()==="true":Number.isFinite(ce)&&ce>0,he=be&&Number.isFinite(ce)&&ce>0?ce:vt,qe=$||be;V.checked=qe,V.dataset.companyShare=String(he)}Ut(p,{disable:m});const _=document.getElementById("edit-res-paid"),N=l.paidStatus??(l.paid===!0||l.paid==="paid"?"paid":"unpaid");_&&(_.value=N,_.dataset&&delete _.dataset.userSelected);const D=document.getElementById("edit-res-payment-progress-type"),J=document.getElementById("edit-res-payment-progress-value");D?.dataset?.userSelected&&delete D.dataset.userSelected,D&&(D.value="percent"),Cc(J);const Q=document.getElementById("edit-res-cancelled");if(Q){const R=String(l?.status||l?.reservationStatus||"").toLowerCase();Q.checked=["cancelled","canceled"].includes(R),Q.checked&&Ut(p,{disable:!0})}let F=Array.isArray(l.crewAssignments)&&l.crewAssignments.length?l.crewAssignments:Array.isArray(l.techniciansDetails)&&l.techniciansDetails.length?l.techniciansDetails:(l.technicians||[]).map(R=>String(R));if(!Array.isArray(F)||F.length===0){const R=Xr(l.id??l.reservationId??l.reservation_code??null);Array.isArray(R)&&R.length&&(F=R)}try{await ws()}catch(R){console.warn("[reservationsEdit] positions load failed (non-fatal)",R)}if(Yr(F),s?.(h),typeof window<"u"){const R=window?.renderEditPaymentHistory;typeof R=="function"&&R()}Br(),r?.();const X=document.getElementById("editReservationModal");Yn=jc(X,i),Yn?.show?.()}async function Tc({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:s,renderReservations:r,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(xt===null){console.warn("⚠️ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),u=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",l=document.getElementById("edit-res-end")?.value?.trim(),y=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",p=document.getElementById("edit-res-notes")?.value||"",m=I(document.getElementById("edit-res-discount")?.value||"0");let f=parseFloat(m)||0,h=document.getElementById("edit-res-discount-type")?.value||"percent";const v=an(),j=document.getElementById("edit-res-paid"),g=j?.dataset?.userSelected==="true",C=g&&j?.value||"unpaid",k=document.getElementById("edit-res-payment-progress-type"),H=document.getElementById("edit-res-payment-progress-value"),S=Tr(k),A=Nr(H),L=document.getElementById("edit-res-project")?.value||"",W=document.getElementById("edit-res-cancelled")?.checked===!0,$=Zr();$.map(M=>M?.technicianId).filter(Boolean);const B=document.getElementById("edit-res-company-share"),V=document.getElementById("edit-res-tax");if(!d||!l){P(c("reservations.toast.requireDates","⚠️ يرجى تحديد تاريخ البداية والنهاية"));return}const _=typeof e=="function"?e:(M,w)=>`${M}T${w||"00:00"}`,N=_(d,u),D=_(l,y);if(N&&D&&new Date(N)>new Date(D)){P(c("reservations.toast.invalidDateOrder","⚠️ تاريخ البداية لا يمكن أن يكون بعد تاريخ النهاية"));return}const Q=vn()?.[xt];if(!Q){P(c("reservations.toast.reservationMissing","⚠️ تعذر العثور على الحجز المطلوب"));return}if(!Array.isArray(et)||et.length===0&&$.length===0){P(c("reservations.toast.updateNoItems","⚠️ يجب إضافة معدة أو عضو واحد من الطاقم الفني على الأقل للحجز"));return}const F=typeof t=="function"?t:()=>!1,X=Q.id??Q.reservationId;for(const M of et){if(M?.type==="package"&&Array.isArray(M.packageItems)){for(const z of M.packageItems){const G=z?.barcode??z?.normalizedBarcode??"";if(!G)continue;const se=dt(G);if(se==="reserved"){const ae=re(G);if(!F(ae,N,D,X))continue}if(se!=="available"){P(Et(se));return}}continue}const w=dt(M.barcode);if(w==="reserved"){const z=re(M.barcode);if(!F(z,N,D,X))continue}if(w!=="available"){P(Et(w));return}}for(const M of et){if(M?.type==="package"&&Array.isArray(M.packageItems)){for(const z of M.packageItems){const G=re(z?.barcode??z?.normalizedBarcode??"");if(G&&F(G,N,D,X)){const se=z?.desc||z?.barcode||c("reservations.create.packages.unnamedItem","معدة بدون اسم"),ae=`${c("reservations.toast.updateEquipmentConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات")} (${I(String(se))})`;P(ae);return}}continue}const w=re(M.barcode);if(F(w,N,D,X)){P(c("reservations.toast.updateEquipmentConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في أحد المعدات"));return}}const R=typeof n=="function"?n:()=>!1;for(const M of et){if(M?.type!=="package")continue;const w=M.packageId??M.package_id??null;if(w&&R(w,N,D,X)){const z=M.desc||M.packageName||c("reservations.create.packages.genericName","الحزمة");P(c("reservations.toast.packageTimeConflict",`⚠️ الحزمة ${I(String(z))} محجوزة بالفعل في الفترة المختارة`));return}}const ce=typeof a=="function"?a:()=>!1;for(const M of $)if(M?.technicianId&&ce(M.technicianId,N,D,X)){P(c("reservations.toast.updateCrewConflict","⚠️ لا يمكن حفظ التعديلات بسبب تعارض في جدول أحد أعضاء الطاقم"));return}const te=Array.isArray(Me.projects)&&Me.projects.length?Me.projects:Se().projects||[],be=L&&te.find(M=>String(M.id)===String(L))||null,he={...Q,projectId:L?String(L):null,confirmed:v},{effectiveConfirmed:qe,projectLinked:je,projectStatus:Le}=Lt(he,be);let O=!!B?.checked,ie=!!V?.checked;if(je&&(O&&(B.checked=!1,O=!1),ie=!1),!je&&O!==ie){P(c("reservations.toast.companyShareRequiresTax","⚠️ لا يمكن تفعيل نسبة الشركة بدون تفعيل الضريبة"));return}ie&&(Ye("edit-res-company-share"),O=!!B?.checked);let Be=O?getCompanySharePercent("edit-res-company-share"):null;O&&(!Number.isFinite(Be)||Be<=0)&&(Ye("edit-res-company-share"),Be=getCompanySharePercent("edit-res-company-share"));const De=O&&ie&&Number.isFinite(Be)&&Be>0,Oe=je?!1:ie;je&&(f=0,h="percent");const Fe=sa(et,f,h,Oe,$,{start:N,end:D,companySharePercent:De?Be:0});let ge=$n();if(Number.isFinite(A)&&A>0){const M=Fe;let w=null,z=null;S==="amount"?(w=A,M>0&&(z=A/M*100)):(z=A,M>0&&(w=A/100*M));const G=Lr({type:S,value:A,amount:w,percentage:z,recordedAt:new Date().toISOString()});G&&(ge=[...ge,G],$a(ge)),H&&(H.value="")}const Ae=ra({totalAmount:Fe,history:ge}),Ce=ia({manualStatus:C,paidAmount:Ae.paidAmount,paidPercent:Ae.paidPercent,totalAmount:Fe});j&&!g&&(j.value=Ce,j.dataset&&delete j.dataset.userSelected);let Te=Q.status??"pending";je?Te=be?.status??Le??Te:W?Te="cancelled":["completed","cancelled"].includes(String(Te).toLowerCase())||(Te=v?"confirmed":"pending");const ze=ls({reservationCode:Q.reservationCode??Q.reservationId??null,customerId:Q.customerId,start:N,end:D,status:Te,title:Q.title??null,location:Q.location??null,notes:p,projectId:L?String(L):null,totalAmount:Fe,discount:f,discountType:h,applyTax:Oe,paidStatus:Ce,confirmed:qe,items:et.map(M=>({...M,equipmentId:M.equipmentId??M.id})),crewAssignments:$,companySharePercent:De?Be:null,companyShareEnabled:De,paidAmount:Ae.paidAmount,paidPercentage:Ae.paidPercent,paymentProgressType:Ae.paymentProgressType,paymentProgressValue:Ae.paymentProgressValue,paymentHistory:ge});try{ss("about to submit",{editingIndex:xt,crewAssignments:$,techniciansPayload:ze?.technicians,payload:ze});const M=await ei(Q.id||Q.reservationId,ze);ss("server response",{reservation:M?.id??M?.reservationId??M?.reservation_code,technicians:M?.technicians,crewAssignments:M?.crewAssignments,techniciansDetails:M?.techniciansDetails}),await ps(),ma(),jt(),pi(),P(c("reservations.toast.updated","✅ تم حفظ التعديلات على الحجز")),s?.(),_r(),o?.({type:"updated",reservation:M}),r?.(),i?.(),Yn?.hide?.()}catch(M){console.error("❌ [reservationsEdit] Failed to update reservation",M);const w=ds(M)?M.message:c("reservations.toast.updateFailed","تعذر تحديث بيانات الحجز");P(w,"error")}}function Wc(e={}){Me={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:s}=Me,r=document.getElementById("edit-res-discount");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=I(r.value),t?.()}),r.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>t?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{ea("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{ea("share")}),d.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-type");u&&!u.dataset.listenerAttached&&(u.addEventListener("change",()=>{u.dataset.userSelected="true",t?.()}),u.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-value");l&&!l.dataset.listenerAttached&&(l.addEventListener("input",()=>{l.value=I(l.value)}),l.dataset.listenerAttached="true"),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const y=document.getElementById("edit-res-project");y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>{Br();const j=Array.isArray(Me.projects)&&Me.projects.length?Me.projects:Se().projects||[],g=y.value&&j.find(A=>String(A.id)===String(y.value))||null,k={...Me?.reservation??{},projectId:y.value||null,confirmed:an()},{effectiveConfirmed:H,projectLinked:S}=Lt(k,g);Ut(H,{disable:S}),t?.()}),y.dataset.listenerAttached="true");const p=document.getElementById("edit-res-confirmed-btn");p&&!p.dataset.listenerAttached&&(p.addEventListener("click",()=>{if(p.disabled)return;const j=!an();Ut(j),t?.()}),p.dataset.listenerAttached="true");const m=document.getElementById("edit-res-cancelled");m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&Ut(an(),{disable:m.checked}),t?.()}),m.dataset.listenerAttached="true");const f=document.getElementById("save-reservation-changes");f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{Tc(Me).catch(j=>{console.error("❌ [reservationsEdit] saveReservationChanges failed",j)})}),f.dataset.listenerAttached="true");const h=document.getElementById("edit-res-equipment-barcode");if(h&&!h.dataset.listenerAttached){let j=null;const g=()=>{h.value?.trim()&&(clearTimeout(j),j=null,n?.(h))};h.addEventListener("keydown",k=>{k.key==="Enter"&&(k.preventDefault(),g())});const C=()=>{if(clearTimeout(j),!h.value?.trim())return;const{start:k,end:H}=getEditReservationDateRange();!k||!H||(j=setTimeout(()=>{g()},150))};h.addEventListener("input",C),h.addEventListener("change",g),h.dataset.listenerAttached="true"}Cr?.();const v=document.getElementById("editReservationModal");v&&!v.dataset.cleanupAttached&&(v.addEventListener("hidden.bs.modal",()=>{_r(),t?.(),s?.([])}),v.dataset.cleanupAttached="true")}function Jc(){return Si().catch(e=>{console.warn("⚠️ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=Se()||{};ni(e||[]),Us()})}function ja(e=null){Us(),Dr(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function Nc(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function ta(){return{populateEquipmentDescriptionLists:mt,setFlatpickrValue:wc,splitDateTime:hs,renderEditItems:ft,updateEditReservationSummary:We,addEquipmentByDescription:Sc,addEquipmentToEditingReservation:vc,addEquipmentToEditingByDescription:gn,combineDateTime:Qt,hasEquipmentConflict:ot,hasTechnicianConflict:bs,renderReservations:Dr,handleReservationsMutation:ja,ensureModal:Nc}}function Dr(e="reservations-list",t=null){oc({containerId:e,filters:t,onShowDetails:Fr,onConfirmReservation:Mr})}function Fr(e){return cc(e,{getEditContext:ta,onEdit:(t,{reservation:n})=>{Hr(t,n)},onDelete:Rr})}function Rr(e){return Kr()?window.confirm(c("reservations.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا الحجز؟"))?gi(e,{onAfterChange:ja}):!1:(Ur(),!1)}function Mr(e){return vi(e,{onAfterChange:ja})}function Hr(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("⚠️ [reservations/controller] Unable to clear pending edit id (inline form)",r)}rs(e,ta());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("⚠️ [reservations/controller] Unable to clear pending edit id (modal)",r)}rs(e,ta());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const r=t.id??t.reservationId;n.set("reservationEditId",String(r));try{localStorage.setItem("pendingReservationEditId",String(r)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("⚠️ [reservations/controller] Unable to persist pending edit id",i)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(r){console.warn("⚠️ [reservations/controller] Unable to persist pending edit index",r)}}Qr({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(r=>{console.warn("⚠️ [reservations/controller] Failed to persist tab preference",r)});const a=n.toString(),s=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=s}function Xc(){wi({showReservationDetails:Fr,deleteReservation:Rr,confirmReservation:Mr,openReservationEditor:Hr})}export{Gc as a,Dr as b,Us as c,ye as d,Qc as e,Fr as f,ta as g,ja as h,Uc as i,Rr as j,Mr as k,Jc as l,wc as m,Hr as o,Xc as r,Wc as s,We as u};
