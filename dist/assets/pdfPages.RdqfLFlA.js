import{t as a,r as D,f as W,c as H,p as z,a as O,b as y,d as M,e as L}from"./calculations.Bqm4O-PR.js";import{e as X}from"./reports.CpRsq4Zx.js";import{s as U,c as G,d as V,q as J}from"./controller.CwK47G-r.js";import{n as F}from"./auth.BcQOd76e.js";import"./reservationsService.BtJ4Aekt.js";import"./dashboard.CGqznES5.js";/* empty css              */import"./dashboardShell.deT9qe6E.js";import"./customers.Bfn9j-AP.js";import"./maintenanceService.Cf3sMnbW.js";const $=96,j=25.4,q=210,P=297,E=Math.round(q/j*$),R=Math.round(P/j*$),Y=/safari/i,B=/(iphone|ipad|ipod)/i,K=/(crios|fxios|edgios|opios)/i;function Q(){try{const o=navigator.userAgent||"";return B.test(o)&&Y.test(o)&&!K.test(o)}catch{return!1}}function Z(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function tt(o="preview"){const e=document.createElement("div");e.id="quotation-pdf-root",e.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),e.setAttribute("data-quote-render-context",o);const m=document.createElement("style");m.textContent=String(J).trim(),e.appendChild(m);const p=document.createElement("div");p.className="quote-preview-pages",p.setAttribute("data-quote-pages",""),e.appendChild(p);const t=document.createElement("style");return t.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
  `,e.appendChild(t),e}function T({primary:o=!1}={}){const e=document.createElement("div");return e.className="quote-page",o&&e.classList.add("quote-page--primary"),e}function et(o){const e=document.createElement("div");e.className="rpt-header";const m=document.createElement("h1");m.textContent=a("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const p=document.createElement("p");p.className="rpt-subtitle",p.textContent=`${L(new Date)} • ${a("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,e.appendChild(m),e.appendChild(p);const t=document.createElement("div");t.className="rpt-kpis";const r=(l,n)=>{const s=document.createElement("div");return s.className="rpt-kpi",s.innerHTML=`<div class="label">${l}</div><div class="value">${n}</div>`,s};return t.appendChild(r(a("reservations.reports.kpi.total.label","الحجوزات","Reservations"),M(o.total||0))),t.appendChild(r(a("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),y(o.revenue||0))),t.appendChild(r(a("reservations.reports.kpi.net.label","صافي الربح","Net profit"),y(o.netProfit||0))),t.appendChild(r(a("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),y(o.companyShareTotal||0))),t.appendChild(r(a("reservations.reports.kpi.tax.label","الضريبة","Tax"),y(o.taxTotal||0))),t.appendChild(r(a("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),y(o.maintenanceExpense||0))),e.appendChild(t),e}function ot(){try{const o=D?.data||{},e=D?.lastSnapshot?.filtered||o.reservations||[],m=new Map((o.customers||[]).map(n=>[String(n.id),n])),p=[...e].sort((n,s)=>new Date(s?.start||0)-new Date(n?.start||0)),t={code:a("reservations.reports.results.headers.id","الحجز","Reservation"),customer:a("reservations.reports.results.headers.customer","العميل","Customer"),date:a("reservations.reports.results.headers.date","التاريخ","Date"),status:a("reservations.reports.results.headers.status","الحالة","Status"),payment:a("reservations.reports.results.headers.payment","الدفع","Payment"),total:a("reservations.reports.results.headers.total","الإجمالي","Total"),share:a("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:a("reservations.reports.results.headers.net","صافي الربح","Net profit")},r=[t.code,t.customer,t.date,t.status,t.payment,t.total,t.share,t.net],l=p.map(n=>{const s=n?.reservationId||n?.id||"—",w=F(String(s)),i=m.get(String(n?.customerId))?.customerName||a("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),g=W(n?.start),h=H(n),d=(()=>{switch(h.statusValue){case"completed":return String(a("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(a("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(a("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return F(String(h.statusValue||"—"))}})(),c=z(h.paidStatus),u=O(n),f=y(u.finalTotal),b=u.companySharePercent>0?`${M(u.companySharePercent)}% (${y(u.companyShareAmount)})`:a("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),S=y(u.netProfit);return{[t.code]:w,[t.customer]:i,[t.date]:g,[t.status]:d,[t.payment]:c,[t.total]:f,[t.share]:b,[t.net]:S}});return{headers:r,rows:l}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function N(o){const e=document.createElement("table");e.className="rpt-table";const m=document.createElement("thead"),p=document.createElement("tr");o.forEach(r=>{const l=document.createElement("th");l.textContent=r,p.appendChild(l)}),m.appendChild(p);const t=document.createElement("tbody");return e.appendChild(m),e.appendChild(t),{table:e,tbody:t}}function nt(o,e,m,p){const t=o.querySelector("[data-quote-pages]"),r=T({primary:!0});t.appendChild(r);const l=et(p);r.appendChild(l);let{table:n,tbody:s}=N(m);r.appendChild(n);const w=18,x=28,i=[];for(let d=0;d<e.length;d+=x)i.push(e.slice(d,d+x));if(i.length){const d=i[0];if(d.length>w){const c=d.splice(w);i.length>1?i[1]=c.concat(i[1]):i.push(c)}}const g=(d,c)=>{const u=document.createElement("tr");m.forEach(f=>{const b=document.createElement("td");b.textContent=c[f]!=null?String(c[f]):"",u.appendChild(b)}),d.appendChild(u)};(i.shift()||e).forEach(d=>g(s,d)),i.forEach(d=>{const c=T({primary:!1});t.appendChild(c);const u=N(m);c.appendChild(u.table),d.forEach(f=>g(u.tbody,f))})}function rt(o=[],{context:e="preview"}={}){const p=(D.lastSnapshot||{}).metrics||{};let t,r=o&&o.length?o:null;if(r)t=Object.keys(r[0]||{});else{const s=ot();t=s.headers,r=s.rows}const l=tt(e),n=document.createElement("div");n.style.position="fixed",n.style.left="-10000px",n.style.top="0",n.style.width=`${E}px`,n.style.zIndex="-1",document.body.appendChild(n),n.appendChild(l);try{U(l),G(l),V(l)}catch{}return nt(l,r||[],t,p),l.parentElement?.removeChild(l),n.parentElement?.removeChild(n),l}async function gt(o=[],{action:e="save"}={}){const m=rt(o,{context:"export"}),p=document.createElement("div");Object.assign(p.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),p.appendChild(m),document.body.appendChild(p);try{const r=Q()&&!Z()?window.open("","_blank"):null;if(r)try{r.document.open(),r.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${a("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${a("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${a("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),r.document.close()}catch{}await X();const l=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,n=window.html2canvas;if(typeof l=="function"&&typeof n=="function"){const s=new l({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),x={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},i=Array.from(m.querySelectorAll(".quote-page"));let g=0;for(let h=0;h<i.length;h+=1){const d=i[h],c=d.ownerDocument||document,u=c.createElement("div");Object.assign(u.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const f=d.cloneNode(!0);f.style.width=`${E}px`,f.style.maxWidth=`${E}px`,f.style.minWidth=`${E}px`,f.style.height=`${R}px`,f.style.maxHeight=`${R}px`,f.style.minHeight=`${R}px`,f.style.position="relative",f.style.background="#ffffff",u.appendChild(f),c.body.appendChild(u);let b;try{b=await n(f,{...x,scrollX:0,scrollY:0})}finally{u.parentNode?.removeChild(u)}if(!b)continue;const S=b.width||1,A=(b.height||1)/S;let v=q,C=v*A,_=0;if(C>P){const k=P/C;C=P,v=v*k,_=Math.max(0,(q-v)/2)}const I=b.toDataURL("image/jpeg",.95);g>0&&s.addPage(),s.addImage(I,"JPEG",_,0,v,C,`page-${g+1}`,"FAST"),g+=1,await new Promise(k=>requestAnimationFrame(k))}if(g===0)throw new Error("PDF generation produced no pages");if(e==="print"){const h=s.output("bloburl");if(r)try{r.location.href=h}catch{}else await new Promise(d=>{const c=document.createElement("iframe");Object.assign(c.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),c.onload=()=>{try{c.contentWindow?.focus(),c.contentWindow?.print()}catch{}setTimeout(()=>{c.remove(),d()},700)},c.src=h,document.body.appendChild(c)})}else s.save("reservations-report.pdf")}else{const s=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(m).toPdf();if(e==="print"){const w=await s.get("pdf").then(x=>x.output("bloburl"));await new Promise(x=>{const i=document.createElement("iframe");Object.assign(i.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),i.onload=()=>{try{i.contentWindow?.focus(),i.contentWindow?.print()}catch{}setTimeout(()=>{i.remove(),x()},700)},i.src=w,document.body.appendChild(i)})}else await s.save("reservations-report.pdf")}}finally{p.remove()}}export{rt as buildReportsPdfPages,gt as exportReportsPdf};
