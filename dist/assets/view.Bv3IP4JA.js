import{n as v,t as l,p as _t,v as Zt}from"./auth.B4XUmSYg.js";import{n as te,f as ee,c as ne,d as se,e as ae,A as Tt,a as re}from"./reservationsService.DnZIJFFB.js";function St(t){const e=new Date;if(e.setHours(0,0,0,0),t==="today")return{startDate:q(e),endDate:q(e)};if(t==="week"){const n=new Date(e),a=n.getDay(),i=a===0?6:a-1;n.setDate(n.getDate()-i);const s=new Date(n);return s.setDate(n.getDate()+6),{startDate:q(n),endDate:q(s)}}if(t==="month"){const n=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);return{startDate:q(n),endDate:q(a)}}return t==="upcoming"?{startDate:q(e),endDate:""}:{startDate:"",endDate:""}}function $e(){const t=document.getElementById("search-reservation"),e=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date"),a=document.getElementById("reservation-date-range"),i=document.getElementById("reservation-status-filter");let s=v(e?.value||"").trim(),r=v(n?.value||"").trim(),c=a?.value||"";if(new Set(["","today","week","month"]).has(c)||(c="",a&&(a.value=""),Q(e),Q(n),s="",r=""),!s&&!r&&c){const g=St(c);s=g.startDate,r=g.endDate}return{searchTerm:te(t?.value||""),startDate:s,endDate:r,status:i?.value||"",quickRange:c}}function je(t){const e=()=>{typeof t=="function"&&t()},n=document.getElementById("search-reservation");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=v(n.value),e()}),n.dataset.listenerAttached="true");const a=document.getElementById("filter-start-date");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{const o=document.getElementById("reservation-date-range");o&&(o.value=""),e()}),a.dataset.listenerAttached="true");const i=document.getElementById("filter-end-date");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{const o=document.getElementById("reservation-date-range");o&&(o.value=""),e()}),i.dataset.listenerAttached="true");const s=document.getElementById("reservation-date-range");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{ie(s.value),e()}),s.dataset.listenerAttached="true");const r=document.getElementById("reservation-status-filter");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",e),r.dataset.listenerAttached="true");const c=document.getElementById("clear-filters");c&&!c.dataset.listenerAttached&&(c.addEventListener("click",()=>{n&&(n.value=""),Q(a),Q(i),s&&(s.value=""),r&&(r.value=""),e()}),c.dataset.listenerAttached="true")}function ie(t){const e=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date");if(!e||!n)return;const{startDate:a,endDate:i}=St(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a,n._flatpickr?i?n._flatpickr.setDate(i,!1,"Y-m-d"):n._flatpickr.clear():n.value=i}function q(t){if(!t)return"";const e=t.getTimezoneOffset()*6e4;return new Date(t.getTime()-e).toISOString().split("T")[0]}function Q(t){t&&(t._flatpickr&&t._flatpickr.clear(),t.value="")}const u={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],servicesClientPriceTotal:0,filters:{search:""},visibleProjects:[],editingProjectId:null,pendingProjectDetailId:null,pendingProjectEditId:null,pendingLinkedToast:!1},b={};function Ne(){u.selectedTechnicians=[],u.selectedEquipment=[],u.expenses=[],u.servicesClientPriceTotal=0}const Ce="project",we="editProject",X=3600*1e3,$t=.15,K=6,De="projectsTab",Ae="projectsSubTab",xe={create:"create-project-tab",list:"projects-list-tab",reports:"projects-reports-tab",expenses:"projects-expenses-tab",templates:"projects-templates-tab"},ce={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed",cancelled:"Cancelled",conflict:"Conflict"};function d(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function F(t){const e=Number(t)||0,a=_t()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${v(i)} SR`}function k(t){if(!t)return"â€”";const e=new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getFullYear()),s=String(e.getMinutes()).padStart(2,"0"),r=e.getHours(),c=r>=12?"PM":"AM",o=r%12||12,g=String(o).padStart(2,"0"),T=`${n}/${a}/${i} ${g}:${s} ${c}`;return v(T)}function oe(t){const e=_t(),n=v(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} Ù…Ø´Ø±ÙˆØ¹`}function bt(t){b.tableCount&&(b.tableCount.dataset.count=String(t),b.tableCount.textContent=oe(t))}function Pe(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?l(e,n):n}function jt(t){if(!t)return"";if(t instanceof Date)return t.toISOString();let e=String(t).trim();return e?(e.includes(" ")&&!e.includes("T")&&(e=e.replace(" ","T")),e):""}function D(t){if(!t?.start)return Number.NaN;const e=jt(t.start),n=new Date(e).getTime();return Number.isFinite(n)?n:Number.NaN}function I(t){if(t?.createdAt){const n=jt(t.createdAt),a=new Date(n).getTime();if(Number.isFinite(a))return a}const e=D(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function Ee(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",i="00"]=n.split(":"),s=a.padStart(2,"0"),r=i.padStart(2,"0");return`${t}T${s}:${r}`}function Nt(t,e){const n=String(t||"");return n.length<=e?n:`${n.slice(0,Math.max(0,e-1))}â€¦`}function Ie(t){if(!t||typeof t!="string")return{date:"",time:""};let e=t.trim();if(!e)return{date:"",time:""};if(e.includes(" ")&&(e=e.replace(" ","T")),!e.includes("T"))return{date:e,time:""};const[n,a=""]=e.split("T");return{date:n,time:a}}function Z(t){if(!t)return l("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return l(e,t)}function ke(){if(!b.projectsTableBody)return;const t=u.filters.search,e=u.projects.filter(a=>{if(!t)return!0;const i=u.customers.find(r=>String(r.id)===String(a.clientId));return v([a.title,a.description,i?.customerName,a.clientCompany,Z(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=u.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",i=u.projects.length===0?"Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©.",s=d(l(a,i));b.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${s}</td></tr>`,bt(0),u.visibleProjects=[],vt([]);return}const n=[...e].sort((a,i)=>{const s=I(a),r=I(i);if(Number.isFinite(s)&&Number.isFinite(r)&&s!==r)return r-s;const c=D(a),o=D(i);return Number.isFinite(c)&&Number.isFinite(o)?o-c:0});u.visibleProjects=n,bt(n.length),b.projectsTableBody.innerHTML=n.map(a=>le(a)).join(""),vt(n),pe()}function le(t){const e=u.customers.find(x=>String(x.id)===String(t.clientId)),n=e?.customerName||l("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),a=(t.clientCompany||e?.companyName||"").trim(),i=t.technicians?.length||0,s=(t.equipment||[]).reduce((x,P)=>x+(P.qty||0),0),{expensesTotal:r,totalWithTax:c}=V(t),g=ot(t.id).length,m=l("projects.table.reservationsCount","{count} Ø­Ø¬ÙˆØ²Ø§Øª").replace("{count}",v(String(g))),p=g?`<span class="badge rounded-pill project-reservations-chip">${d(m)}</span>`:"",j=`<span class="badge project-type-badge">${d(Z(t.type))}</span>`,_=t.projectCode||`PRJ-${v(String(t.id))}`,S=`<span class="project-code-badge">#${d(_)}</span>`,O=Zt()?`<button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${d(l("actions.delete","Ø­Ø°Ù"))}</button>`:"";return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${d(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${S}
            ${j}
          </div>
        </div>
        ${p}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${d(n)}</span><small class="text-muted">${d(a)}</small></div>`:d(n)}
      </td>
      <td>${de(t.start,t.end)}</td>
      <td>${v(String(i))}</td>
      <td>${v(String(s))}</td>
      <td>${F(c)}</td>
      <td>${F(r)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${d(l("actions.view","Ø¹Ø±Ø¶"))}</button>
        ${O}
      </td>
    </tr>
  `}function de(t,e){if(!t)return"â€”";const n=k(t),a=e?k(e):"",i=o=>{const g=String(o).split(" ").filter(Boolean),T=g.shift()||"",m=g.join(" ");return{date:T,time:m}},s=i(n),r=a?i(a):{date:"",time:""};if(r.date&&s.date===r.date){const o=s.time&&r.time?`Ù…Ù† ${s.time} Ø¥Ù„Ù‰ ${r.time}`:"";return`
      <div class="date-range">
        <div class="date-line">${s.date}</div>
        ${o?`<div class="time-line">${o}</div>`:""}
      </div>
    `}const c=s.time&&r.time?`Ù…Ù† ${s.time} Ø¥Ù„Ù‰ ${r.time}`:"";return`
    <div class="date-range">
      <div class="date-line">${s.date}</div>
      ${r.date?`<div class="date-line">${r.date}</div>`:""}
      ${c?`<div class="time-line">${c}</div>`:""}
    </div>
  `}function ue(t,e){if(!t)return{dateHtml:"â€”",timeText:""};const n=k(t),a=e?k(e):"",i=g=>{const T=String(g).split(" ").filter(Boolean),m=T.shift()||"",p=T.join(" ");return{date:m,time:p}},s=i(n),r=a?i(a):{date:"",time:""};let c="",o="";return r.date&&s.date===r.date?(c=`<div class="date-range"><div class="date-line">${s.date}</div></div>`,o=`Ù…Ù† ${s.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${r.time||"â€”:â€”"}`):(c=`<div class="date-range"><div class="date-line">${s.date}</div>`+(r.date?`<div class="date-line">${r.date}</div>`:"")+"</div>",o=`Ù…Ù† ${s.time||"â€”:â€”"} Ø¥Ù„Ù‰ ${r.time||"â€”:â€”"}`),{dateHtml:c,timeText:o}}function vt(t){if(!b.timeline)return;const n=(Array.isArray(t)?t:u.visibleProjects.length?u.visibleProjects:u.projects).map(m=>{if(!m?.start)return null;const p=new Date(m.start);if(Number.isNaN(p.getTime()))return null;let h=m.end?new Date(m.end):new Date(p);return Number.isNaN(h.getTime())&&(h=new Date(p)),h<=p&&(h=new Date(p.getTime()+X)),{project:m,startDate:p,endDate:h}}).filter(Boolean).sort((m,p)=>m.startDate-p.startDate);if(!n.length){const m=d(l("projects.timeline.empty",b.timeline.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ØµØ§Ù„Ø­Ø©."));b.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${m}</div>`;return}const a=n[0].startDate.getTime(),i=Math.max(...n.map(m=>m.endDate.getTime()));let s=i-a;s<=0&&(s=X);const r=me(n),c=l("projects.timeline.range","{start} â†’ {end}"),o=l("projects.timeline.conflict","Scheduling conflict"),g=n.map(m=>{const{project:p,startDate:h,endDate:j}=m,_=j.getTime()-h.getTime();let S=(h.getTime()-a)/s*100;S=Math.max(0,Math.min(S,100));let A=_/s*100;A=Math.max(A,2.5),S+A>100&&(A=Math.max(1.5,100-S));const x=`project-timeline__item--${Ct(p)}`,P=r.has(p.id),H=(p.title||"").trim()||l("projects.fallback.untitled","Untitled project"),Y=Nt(H,26),M=u.customers.find(B=>String(B.id)===String(p.clientId)),L=M?.customerName||l("projects.fallback.unknownClient","Unknown client"),z=(p.clientCompany||M?.companyName||"").trim(),tt=Z(p.type),E=k(h.toISOString()),lt=k(j.toISOString()),w=c.replace("{start}",E).replace("{end}",lt),et=z?`${L} (${z})`:L,nt=`${H} â€¢ ${tt} â€¢ ${et} | ${w}`,J=P?`<span class="project-timeline__item-conflict" title="${d(o)}">âš ï¸</span>`:"";return`
        <div class="project-timeline__item ${x}${P?" project-timeline__item--conflict":""}" style="left:${S}%;width:${A}%;" title="${d(nt)}">
          <span class="project-timeline__item-label">${d(Y)}</span>
          ${J}
        </div>
      `}).join(""),T=`
    <div class="project-timeline__scale">
      <span>${d(k(new Date(a).toISOString()))}</span>
      <span>${d(k(new Date(i).toISOString()))}</span>
    </div>
  `;b.timeline.innerHTML=`
    ${T}
    <div class="project-timeline__track">
      ${g}
    </div>
  `}function me(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const i=t[n],s=t[a];i.startDate<s.endDate&&s.startDate<i.endDate&&(e.add(i.project.id),e.add(s.project.id))}return e}function pe(){if(!b.focusCards)return;const t=fe();if(!t.length){const e=d(l("projects.focus.empty",b.focusCards.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙŠÙˆÙ… Ø£Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹."));b.focusCards.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}b.focusCards.innerHTML=t.join("")}function fe(){if(!Array.isArray(u.projects)||!u.projects.length)return[];const t=u.projects.filter(ht),e=u.projects.filter(s=>!ht(s)&&ye(s)),n=[],a=new Set,i=(s,r)=>{!s||a.has(s.id)||n.length>=K||(a.add(s.id),n.push(ge(s,r)))};if(t.sort((s,r)=>D(s)-D(r)).forEach(s=>i(s,"today")),e.sort((s,r)=>D(s)-D(r)).forEach(s=>i(s,"thisWeek")),n.length<K){const s=Date.now();[...u.projects].filter(c=>!a.has(c.id)).filter(c=>{const o=D(c);return Number.isFinite(o)&&o>=s}).sort((c,o)=>D(c)-D(o)).forEach(c=>i(c,"upcoming"))}return n.length<K&&[...u.projects].filter(r=>!a.has(r.id)).filter(r=>!Number.isFinite(D(r))).sort((r,c)=>I(c)-I(r)).forEach(r=>i(r,"recent")),n.length===0&&[...u.projects].sort((r,c)=>I(c)-I(r)).slice(0,K).forEach(r=>i(r,"recent")),n.length<K&&[...u.projects].filter(r=>!a.has(r.id)).sort((r,c)=>I(c)-I(r)).forEach(r=>i(r,"recent")),n}function ge(t,e){const n=u.customers.find(y=>String(y.id)===String(t.clientId)),a=n?.customerName||l("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");(t.clientCompany||n?.companyName||"").trim();const i=Array.isArray(t.technicians)?t.technicians.length:0,s=ot(t.id),r=s.length;wt(t);const c=Number(t?.servicesClientPrice??0),{applyTax:o}=V(t),g=(t.description||"").trim(),T=g?Nt(g,110):l("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"),m=Z(t.type),p=V(t),h=Number(p?.totalWithTax||0),j=ne({totalAmount:h,paidAmount:t.paidAmount,paidPercent:t.paidPercent,history:t.paymentHistory||t.payments||[]}),_=se({manualStatus:t.paymentStatus||"unpaid",paidAmount:j.paidAmount,paidPercent:j.paidPercent,totalAmount:h}),S=l(`projects.paymentStatus.${_}`,_==="paid"?"Paid":_==="partial"?"Partially Paid":"Unpaid"),A=_==="paid"?"status-paid":_==="partial"?"status-partial":"status-unpaid",O=_==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",x=t.confirmed===!0||t.confirmed==="true",P=d(String(t.id)),H=t.projectCode||`PRJ-${v(String(t.id))}`,Y=v(H),M={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},L={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},z=M[e]||M.recent;l(z,L[e]||L.recent);const tt=Ct(t),E=t?.cancelled===!0||t?.status==="cancelled"||t?.status==="canceled"?"cancelled":tt;l(`projects.status.${E}`,ce[E]||E);const w=(()=>{try{const y=t.start?new Date(t.start):null,f=t.end?new Date(t.end):y?new Date(y.getTime()+X):null;return!y||!f||Number.isNaN(y.getTime())||Number.isNaN(f.getTime())?!1:u.projects.some($=>{if(!$||String($.id)===String(t.id))return!1;const N=$.start?new Date($.start):null,C=$.end?new Date($.end):N?new Date(N.getTime()+X):null;if(!N||!C||Number.isNaN(N.getTime())||Number.isNaN(C.getTime()))return!1;const U=Math.max(y.getTime(),N.getTime()),rt=Math.min(f.getTime(),C.getTime());return U<rt})}catch{return!1}})()&&(E==="upcoming"||E==="ongoing")?"conflict":E,et=w==="upcoming"?"timeline-status-badge timeline-status-badge--upcoming":w==="ongoing"?"timeline-status-badge timeline-status-badge--ongoing":w==="completed"?"timeline-status-badge timeline-status-badge--completed":w==="cancelled"?"timeline-status-badge timeline-status-badge--cancelled":"timeline-status-badge timeline-status-badge--conflict",nt=(t.title||"").trim()||l("projects.fallback.untitled","Untitled project"),J=w==="cancelled"?[]:[O];w==="cancelled"?J.push("project-focus-card--cancelled"):x&&J.push("project-focus-card--confirmed");const B=s.reduce((y,f)=>{const $=Array.isArray(f.items)?f.items:[],N=Array.isArray(f.crewAssignments)?f.crewAssignments:[],C=N.length?N:Array.isArray(f.technicians)?f.technicians:[],U=ae({items:$,technicianIds:Array.isArray(C)&&!C.length?C:[],crewAssignments:Array.isArray(C)&&C.length&&typeof C[0]=="object"?C:[],discount:f.discount??0,discountType:f.discountType||"percent",applyTax:!1,start:f.start,end:f.end,companySharePercent:null}),rt=Dt(f),Vt=(()=>{try{const{groups:gt}=Tt(f);return(gt||[]).reduce((it,R)=>{if(String(R?.type||"").toLowerCase()==="package"){const Qt=Array.isArray(R?.packageItems)?R.packageItems:[],Xt=new Set(Qt.map(ct=>(ct?.normalizedBarcode||ct?.barcode||ct?.equipmentId||"").toString()));return it+Xt.size}const yt=Number.isFinite(Number(R?.count))?Number(R.count):Number.isFinite(Number(R?.quantity))?Number(R.quantity):1;return it+(yt>0?yt:1)},0)}catch{return(Array.isArray(f?.items)?f.items:[]).length||0}})(),Gt=(f.technicians||[]).length;return{netTotal:y.netTotal+rt,equipmentMoney:y.equipmentMoney+Number(U.equipmentTotal||0),crewMoney:y.crewMoney+Number(U.crewTotal||0),equipmentCount:y.equipmentCount+Vt,crewCount:y.crewCount+Gt}},{netTotal:0,equipmentMoney:0,crewMoney:0,equipmentCount:0,crewCount:0}),At=Number(B.netTotal.toFixed(2)),xt=B.equipmentCount,Pt=B.crewCount||i,Et=Number(c||0),G=Number((B.equipmentMoney+B.crewMoney+Et).toFixed(2)),dt=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let W=(t?.discountType==="amount"?"amount":"percent")==="amount"?dt:G*(dt/100);(!Number.isFinite(W)||W<0)&&(W=0),W>G&&(W=G);const st=Math.max(0,G-W),It=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",ut=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,mt=It&&o&&ut>0?ut:0,pt=Number((st*(mt/100)).toFixed(2)),kt=o?Number(((st+pt)*$t).toFixed(2)):0,Ft=Number((st+pt+kt).toFixed(2)),Mt=`<span class="project-code-badge project-focus-card__code">#${d(Y)}</span>`,Lt="",Bt="",Rt=l(`projects.status.${w}`,w),qt=`<span class="${et}">${d(Rt)}</span>`,Ot=`<span class="reservation-chip ${A} project-focus-card__payment-chip">${d(S)}</span>`,at=(y,f,$)=>{const N=String($||""),U=N.trim().startsWith("<");return`
      <div class="project-focus-card__row">
        <span class="project-focus-card__row-label">
          ${y?`<span class="project-focus-card__row-icon">${d(y)}</span>`:""}
          ${d(f)}
        </span>
        <span class="project-focus-card__row-value">${U?N:d(N)}</span>
      </div>
    `},{dateHtml:Ht,timeText:ft}=ue(t.start,t.end),zt=[{icon:"ğŸ‘¤",label:l("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),value:a},{icon:"ğŸ·ï¸",label:l("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),value:`<span class="project-type-chip project-type-chip--${t.type||"default"}">${d(m)}</span>`},{icon:"ğŸ“…",label:l("projects.focus.summary.range","Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),value:Ht},ft?{icon:"â°",label:l("projects.focus.summary.time","Ø§Ù„ÙˆÙ‚Øª"),value:ft}:null].filter(Boolean).map(({icon:y,label:f,value:$})=>at(y,f,$)).join(""),Wt=mt>0&&o?` ${l("projects.details.chips.vatOn","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)")}`:"",Ut=`${l("projects.details.summary.finalTotal","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")}${Wt}`,Yt=[{icon:"ğŸ’¼",label:l("projectCards.stats.servicesClientPrice","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"),value:F(c)},{icon:"ğŸ’µ",label:Ut,value:F(Ft)}].map(({icon:y,label:f,value:$})=>at(y,f,$)).join(""),Jt=[{icon:"ğŸ”—",label:l("projectCards.stats.reservationsShort","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:v(String(r))},{icon:"ğŸ“¦",label:l("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),value:v(String(xt))},{icon:"ğŸ˜",label:l("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),value:v(String(Pt))},{icon:"ğŸ’µ",label:l("projectCards.stats.reservationValue","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),value:F(At)}].map(({icon:y,label:f,value:$})=>at(y,f,$)).join(""),Kt=w==="cancelled"?`<span class="reservation-chip status-cancelled project-focus-card__confirm-indicator">${d(l("projects.focus.cancelled","Ù…Ø´Ø±ÙˆØ¹ Ù…Ù„ØºÙŠ"))}</span>`:x?`<span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${d(l("projects.focus.confirmed","âœ… Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¤ÙƒØ¯"))}</span>`:`<button class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${P}">${d(l("projects.focus.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</button>`;return`
    <div class="project-card-grid__item">
      <article class="project-focus-card ${J.filter(Boolean).join(" ")}" data-project-id="${P}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${Mt}
          ${Lt}
          ${Bt}
          ${qt}
          ${Ot}
        </div>
        <h6 class="project-focus-card__title">${d(nt)}</h6>
        <p class="project-focus-card__description">${d(T)}</p>
        <div class="project-focus-card__sections">
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(l("projects.focus.summary.project","Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
            <div class="project-focus-card__section-box">
              ${zt}
            </div>
          </div>
          <!-- Show reservations above the financial summary -->
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(l("projects.focus.summary.reservations","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"))}</span>
            <div class="project-focus-card__section-box">
              ${Jt}
            </div>
          </div>
          <div class="project-focus-card__section">
            <span class="project-focus-card__section-title">${d(l("projects.focus.summary.payment","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</span>
            <div class="project-focus-card__section-box">
              ${Yt}
            </div>
          </div>
        </div>
        <div class="project-focus-card__actions project-focus-card__actions--single">
          ${Kt}
        </div>
      </article>
    </div>
  `}function ht(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function ye(t){if(!t?.start)return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const i=a.getDay(),s=i===0?6:i-1;a.setDate(a.getDate()-s);const r=new Date(a);return r.setDate(r.getDate()+7),e>=a&&e<r}function Ct(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function wt(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function V(t){const e=Number(t?.equipmentEstimate)||0,n=wt(t),a=e+n,i=t?.applyTax===!0||t?.applyTax==="true",s=Number.parseFloat(t?.discount??t?.discountValue??0)||0;let c=(t?.discountType==="amount"?"amount":"percent")==="amount"?s:a*(s/100);(!Number.isFinite(c)||c<0)&&(c=0),c>a&&(c=a);const o=Math.max(0,a-c),g=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true"||t?.company_share_enabled===!0||t?.company_share_enabled==="true",T=Number.parseFloat(t?.companySharePercent??t?.company_share_percent??t?.companyShare??t?.company_share??0)||0,m=i||g&&T>0,p=g&&m&&T>0?T:0,h=p>0?Number((o*(p/100)).toFixed(2)):0,j=o+h;let _=m?j*$t:0;(!Number.isFinite(_)||_<0)&&(_=0),_=Number(_.toFixed(2));let S=m?Number(t?.totalWithTax):j;return m?(!Number.isFinite(S)||S<=0)&&(S=Number((j+_).toFixed(2))):S=j,{equipmentEstimate:e,expensesTotal:n,baseSubtotal:a,discountAmount:c,subtotalAfterDiscount:o,companyShareAmount:h,subtotal:j,applyTax:m,taxAmount:_,totalWithTax:S}}function Fe(){const t=u.projects.length,e=u.projects.filter(i=>{const s=i.start?new Date(i.start):null;return!s||Number.isNaN(s.getTime())?!1:s>new Date}).length,n=u.projects.reduce((i,s)=>i+V(s).expensesTotal,0),a=u.projects.reduce((i,s)=>i+V(s).totalWithTax,0);b.projectsCount&&(b.projectsCount.textContent=v(String(t))),b.projectsUpcoming&&(b.projectsUpcoming.textContent=v(String(e))),b.projectsExpenses&&(b.projectsExpenses.textContent=F(n)),b.projectsBudget&&(b.projectsBudget.textContent=F(a))}function ot(t){return t?u.reservations.filter(e=>{const n=e?.projectId??e?.project_id??null;return n!=null&&String(n)===String(t)}):[]}function Dt(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(v(String(n)))||0,i=t.discountType||"percent",s=Array.isArray(t.crewAssignments)?t.crewAssignments:[],r=s.length?s:Array.isArray(t.technicians)?t.technicians:[],c=ee(e,a,i,!1,r,{start:t.start,end:t.end,companySharePercent:0});if(Number.isFinite(c))return c;const o=Number(v(String(t.cost??0)));return Number.isFinite(o)?Math.round(o):0}function be(t){try{const{groups:e}=Tt(t);return(e||[]).reduce((n,a)=>{if(String(a?.type||"").toLowerCase()==="package"){const r=Array.isArray(a?.packageItems)?a.packageItems:[],c=new Set(r.map(o=>(o?.normalizedBarcode||o?.barcode||o?.equipmentId||"").toString()));return n+c.size}const s=Number.isFinite(Number(a?.count))?Number(a.count):Number.isFinite(Number(a?.quantity))?Number(a.quantity):1;return n+(s>0?s:1)},0)}catch{return(Array.isArray(t?.items)?t.items:[]).length||0}}function ve(t,e,n=null){if(!t)return"";const a=t.reservationId||t.id||`RES-${e+1}`,i=t.status||t.state||"pending",s=String(i).toLowerCase(),{effectiveConfirmed:r}=re(t,n),c=r?"confirmed":s,o=l(`reservations.list.status.${c}`,c==="confirmed"?"âœ… Ù…Ø¤ÙƒØ¯":c==="pending"?"â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯":c),T={confirmed:"project-reservation-card__badge--confirmed",pending:"project-reservation-card__badge--pending",completed:"project-reservation-card__badge--completed",in_progress:"project-reservation-card__badge--info",ongoing:"project-reservation-card__badge--info"}[c]||"project-reservation-card__badge--info",m=typeof n?.paymentStatus=="string"?n.paymentStatus.toLowerCase():null,p=m&&["paid","partial","unpaid"].includes(m)?m:String(t.paidStatus||t.paymentStatus||(t.paid?"paid":"unpaid")).toLowerCase(),h=p==="paid"?"paid":p==="partial"?"partial":"unpaid",j=h==="paid"?l("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"):h==="partial"?l("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"):l("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),_=h==="paid"?"project-reservation-card__badge--paid":h==="partial"?"project-reservation-card__badge--partial":"project-reservation-card__badge--unpaid",S=t.completed===!0||t.completed==="true",A=l("reservations.details.completed","Ù…ÙƒØªÙ…Ù„"),O=S?`<span class="project-reservation-card__badge project-reservation-card__badge--completed">${d(A)}</span>`:"",x=Dt(t),P=F(x),H=be(t),Y=(t.technicians||[]).length,M=l("projectCards.stats.crewCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…"),L=l("projectCards.stats.equipmentCount","Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),z=l("projectCards.stats.reservationTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ø²");return`
    <article class="project-reservation-card" data-action="view-reservation" data-index="${e}" data-reservation-index="${e}" data-project-id="${n?n.id:""}" role="button" tabindex="0">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${d(a)}</span>
        <div class="project-reservation-card__badges">
          <span class="project-reservation-card__badge ${T}">${d(o)}</span>
          <span class="project-reservation-card__badge ${_}">${d(j)}</span>
          ${O}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__meta project-reservation-card__meta--vertical">
          <span>ğŸ˜ ${d(M)}: ${v(String(Y))}</span>
          <span>ğŸ“¦ ${d(L)}: ${v(String(H))}</span>
          <span>ğŸ’µ ${d(z)}: ${d(P)}</span>
        </div>
      </div>
    </article>
  `}function Me(t){const e=ot(t.id).map(s=>{const r=s?.id??s?.reservationId??s?.reservation_code??s?.reservation_id,c=u.reservations.findIndex(o=>{const g=o?.id??o?.reservationId??o?.reservation_code??o?.reservation_id;return r!=null&&g!=null&&String(g)===String(r)});return{reservation:s,index:c}}).filter(({index:s})=>Number.isInteger(s)&&s>=0).sort((s,r)=>{const c=s.reservation.start?new Date(s.reservation.start).getTime():0;return(r.reservation.start?new Date(r.reservation.start).getTime():0)-c}),n=l("projects.details.reservations.title","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"),a=l("projects.details.reservations.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯."),i=e.length?`<div class="project-reservations-list">${e.map(({reservation:s,index:r})=>ve(s,r,t)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${d(a)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex align-items-center gap-2 flex-wrap">
        <h6 class="mb-0">${d(n)}</h6>
      </div>
      ${i}
    </section>
  `}export{De as P,ke as a,pe as b,Ae as c,b as d,xe as e,V as f,ot as g,$t as h,Ct as i,ce as j,d as k,F as l,Me as m,k as n,Ie as o,Ee as p,Ce as q,St as r,u as s,we as t,Fe as u,Ne as v,Pe as w,Dt as x,je as y,$e as z};
