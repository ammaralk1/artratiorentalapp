const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.T12cFdpG.js","./controller.Ye9ctTM1.js","./auth.CBLJBoUs.js","./auth.Dm3gY4mf.css","./reservationsActions.o3a_wJw8.js","./reservationsService.ChFctUBH.js","./technicians.CyB3jWyP.js","./uiBridge.CXgb5c0H.js","./quotePdf.WC1ebubv.js","./canvasColorUtils.CviLtv6S.js","./projectsService.DBmi5eI4.js"])))=>i.map(i=>d[i]);
import{r as de,t as d,n as D,d as Tt,b as ut,a as ue,c as me,i as he,j as W,l as pe}from"./auth.CBLJBoUs.js";import"./dashboard.D730k4YA.js";import{g as _t,b as fe,e as ge}from"./projectFocusTemplates.9gAsQ8xg.js";import{o as ye,m as be}from"./modals.CNWukemL.js";import{s as Lt,r as Qt,g as Jt}from"./technicians.CyB3jWyP.js";import{_ as ve,b as De}from"./uiBridge.CXgb5c0H.js";import{r as Xt,a as Ee,s as Ae,g as Ie}from"./controller.Ye9ctTM1.js";import{e as Zt,d as Mt,s as pt}from"./reservationsActions.o3a_wJw8.js";import{ensureProjectsLoaded as we,getProjectsState as Fe,refreshProjectsFromApi as Se}from"./projectsService.DBmi5eI4.js";import{a as Rt,g as mt,r as Te,b as Le}from"./reservationsService.ChFctUBH.js";import{i as ke}from"./dashboardShell.DF2kUed9.js";import{initDashboardMetrics as je}from"./dashboardMetrics.3WRcG4fX.js";import"./quotePdf.WC1ebubv.js";import"./canvasColorUtils.CviLtv6S.js";de({ar:{"technicianDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.title":"ğŸ˜ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","technicianDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.hero.subtitle":"Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø§Ø· Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… ÙˆÙ…Ù‡Ø§Ù…Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianDetails.hero.helper":"Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù….","technicianTabs.reservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianTabs.projects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianFinancial.stats.total":"ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª","technicianFinancial.stats.paid":"ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©","technicianFinancial.stats.outstanding":"ğŸ§¾ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.stats.totalDesc":"Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…","technicianFinancial.stats.paidDesc":"ØªÙ… ØªØ³Ø¬ÙŠÙ„ {count} Ø¯ÙØ¹Ø§Øª","technicianFinancial.stats.outstandingDesc":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„","technicianFinancial.modal.title":"ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„ÙÙ†ÙŠ","technicianFinancial.modal.subtitle":"Ù†Ø¸Ø±Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianFinancial.list.title":"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","technicianFinancial.assignments.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø£Ùˆ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.","technicianFinancial.list.reservation":"Ø§Ù„Ø­Ø¬Ø² / Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","technicianFinancial.list.period":"Ø§Ù„ÙØªØ±Ø©","technicianFinancial.list.due":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","technicianFinancial.list.status":"Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹","technicianFinancial.list.outstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.list.settled":"Ù„Ø§ ÙŠÙˆØ¬Ø¯","technicianFinancial.list.reservationFallback":"Ø­Ø¬Ø² Ø±Ù‚Ù… {id}","technicianFinancial.list.projectReference":"Ù…Ø´Ø±ÙˆØ¹ #{id}","technicianFinancial.status.paid":"Ù…Ø¯ÙÙˆØ¹","technicianFinancial.status.partial":"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹","technicianFinancial.status.unpaid":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹","technicianFinancial.payouts.title":"ğŸ’¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©","technicianFinancial.payouts.helper":"Ø³Ø¬Ù‘Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªÙŠ ØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ø¶Ù…Ø§Ù† ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø¯Ø§Ø¯.","technicianFinancial.payouts.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.","technicianFinancial.payouts.form.amount":"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº","technicianFinancial.payouts.form.date":"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹","technicianFinancial.payouts.form.note":"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","technicianFinancial.payouts.form.notePlaceholder":"Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© Ø³Ø±ÙŠØ¹Ø© Ø£Ùˆ Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„","technicianFinancial.payouts.form.submit":"ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmDelete":"âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmMessage":"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.","technicianFinancial.payouts.confirmCancel":"Ø¥Ù„ØºØ§Ø¡","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Ø­Ø°Ù","technicianFinancial.payouts.toast.added":"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.","technicianFinancial.payouts.toast.failed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² (Ù…Ø«Ù„ #123) Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...","technicianDetails.fields.role":"ğŸ‘” Ø§Ù„ÙˆØ¸ÙŠÙØ©:","technicianDetails.fields.department":"ğŸ§© Ø§Ù„Ù‚Ø³Ù…:","technicianDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","technicianDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","technicianDetails.fields.wage":"ğŸ’° Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:","technicianDetails.fields.total":"ğŸ’¼ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:","technicianDetails.fields.baseStatus":"âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:","technicianDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","technicianDetails.fallback.email":"â€”","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"ØºÙŠØ± Ù…Ø­Ø¯Ø¯","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","technicianDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.","technicianDetails.errors.loadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.","technicianDetails.errors.reservationsLoadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...","technicianDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicians.picker.actions.apply":"ØªÙ…","technicianProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianReservations.title":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"ğŸ˜ Crew Member Profile","technicianDetails.actions.back":"â¬…ï¸ Back","technicianDetails.actions.edit":"âœï¸ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew memberâ€™s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"ğŸ“… Technician Reservations","technicianTabs.projects":"ğŸ“ Technician Projects","technicianFinancial.stats.total":"ğŸ’¼ Total Due","technicianFinancial.stats.paid":"ğŸ’° Paid Amount","technicianFinancial.stats.outstanding":"ğŸ§¾ Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š View details","technicianFinancial.modal.title":"ğŸ“Š Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"ğŸ’¸ Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"ğŸ’° Amount","technicianFinancial.payouts.form.date":"ğŸ“… Payment date","technicianFinancial.payouts.form.note":"ğŸ“ Notes (optional)","technicianFinancial.payouts.form.submit":"ğŸ’¸ Record payout","technicianFinancial.payouts.confirmDelete":"âŒ Delete this payout?","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Delete","technicianFinancial.payouts.toast.added":"âœ… Payout logged successfully.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"âš ï¸ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Unable to determine the crew member right now.","technicianDetails.filters.search":"ğŸ” Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"ğŸ‘” Role:","technicianDetails.fields.department":"ğŸ§© Department:","technicianDetails.fields.phone":"ğŸ“ Phone:","technicianDetails.fields.email":"ğŸ“§ Email:","technicianDetails.fields.wage":"ğŸ’° Daily Rate:","technicianDetails.fields.total":"ğŸ’¼ Total Charge:","technicianDetails.fields.baseStatus":"âš™ï¸ Base Status:","technicianDetails.fields.notes":"ğŸ“ Notes:","technicianDetails.fallback.email":"â€”","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"âš ï¸ Crew member not found.","technicianDetails.errors.loadFailed":"âŒ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"âŒ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"â³ Loading crew member details...","technicianDetails.edit.modalTitle":"âœï¸ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"ğŸ“ Technician Projects","technicianReservations.title":"ğŸ“… Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let ft={},b={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},Nt=!1;function At(t=""){return D(String(t)).replace(/[Ù¬ØŒ]/g,"").trim().toLowerCase()}function te(t,e,n){if(!e||!n)return;const{startDate:a,endDate:i}=Xt(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?i?n._flatpickr.setDate(i,!1,"Y-m-d"):n._flatpickr.clear():n.value=i||""}function U(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function ee(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!Nt){try{await Promise.all([Zt({suppressError:!1,force:!0}),we({force:!0}).catch(()=>{})])}catch(h){console.error("âŒ [technician-details] Failed to hydrate reservations list",h),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${d("technicianDetails.errors.reservationsLoadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.")}</p>`;return}Nt=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),i=document.getElementById("technician-filter-end-date"),c=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),r=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const u=()=>{let h=D(a?.value||"").trim(),v=D(i?.value||"").trim(),w=c?.value||"";if(new Set(["","today","week","month"]).has(w)||(w="",c&&(c.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),h="",v=""),!h&&!v&&w){const{startDate:$,endDate:o}=Xt(w);h=$,v=o}return{searchTerm:At(n?.value||""),startDate:h,endDate:v,status:l?.value||"",quickRange:w,technicianId:t}},m=()=>{ft=u(),Ct("technician-reservations",ft)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=D(n.value),m()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{c&&(c.value=""),m()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{c&&(c.value=""),m()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{te(c.value,a,i),m()}),c.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",m),l.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),c&&(c.value=""),l&&(l.value=""),m()}),r.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{Ct("technician-reservations",ft)},document.__techReservationsProjectListenerAttached||(document.addEventListener("projects:changed",()=>{try{typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews()}catch{}}),document.__techReservationsProjectListenerAttached=!0),m()}function ne(t){b.currentId=t;const{container:e}=X();e&&(b.initialized||(Pe(),Be(),Re(),document.addEventListener("projects:changed",()=>{b.currentId&&P()}),document.addEventListener("language:changed",()=>{b.currentId&&P()}),document.addEventListener("customers:changed",()=>{b.currentId&&P()}),document.addEventListener("technicians:updated",()=>{b.currentId&&P()}),b.initialized=!0),P())}function X(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function Pe(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:i,rangeSelect:c}=X();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=D(t.value),P()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{c&&(c.value=""),P()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(i,{dateFormat:"Y-m-d"}),i.addEventListener("change",()=>{c&&(c.value=""),P()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{te(c.value,a,i),P()}),c.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{P()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:l,statusSelect:r,startInput:u,endInput:m,rangeSelect:h}=X();l&&(l.value=""),r&&(r.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),m&&(m._flatpickr&&m._flatpickr.clear(),m.value=""),h&&(h.value=""),P()}),n.dataset.listenerAttached="true")}function Be(){const{container:t}=X();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Me),t.dataset.projectModalListenerAttached="true")}function _e(){const{container:t}=X();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const i=e.dataset.projectId?String(e.dataset.projectId):"";i&&ie(i)}),e.dataset.technicianModalListenerAttached="true")})}function Me(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&ie(a)}function Re(){ae()}function ae(){if(b.modal?.el&&b.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");if(!t||!e){const i=document.createElement("div");i.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${d("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(i.firstElementChild)}const n=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");return!n||!a?!1:(b.modal={el:n,body:a},!0)}function P(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:i}=X();if(!t||!b.currentId)return;const c=At(e?.value||""),l=n?.value||"",r=a?.value||"",u=i?.value||"",m=r?new Date(`${r}T00:00:00`):null,h=u?new Date(`${u}T23:59:59`):null,{projects:v=[],customers:w=[],technicians:B=[],reservations:C=[]}=Tt(),$=new Map(w.map(s=>[String(s.id),s])),o=new Map(B.map(s=>[String(s.id),s])),p=new Map(v.map(s=>[String(s.id),s])),M=Ne(C),_=String(b.currentId),T=new Map,O=(s,f=null)=>{if(!s)return;const g=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(g&&!T.has(g)){const E=f??U(s?.technicians);T.set(g,{...s,technicians:E})}};v.forEach(s=>{const f=U(s?.technicians);f.length&&f.includes(_)&&O({...s,technicians:f},f)}),C.forEach(s=>{if(!s?.projectId)return;const f=U(s.technicians);if(!f.includes(_))return;const g=String(s.projectId),E=T.get(g),F=p.get(g),{effectiveConfirmed:S}=Rt(s,F??E??null);if(E){const R=U(E.technicians),at=Array.from(new Set([...R,...f]));T.set(g,{...E,technicians:at,confirmed:E.confirmed||S});return}if(F){const R=U(F?.technicians),at=Array.from(new Set([...R,...f]));O({...F,technicians:at,confirmed:Rt(s,F).effectiveConfirmed},at);return}O({id:g,title:s.projectTitle||s.title||s.project_title||`#${g}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:f,clientId:s.projectClientId??s.customerId??null,confirmed:S,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},f)});const ht=Array.from(T.values());b.projectsMap=T,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:T,keys:()=>Array.from(T.keys())}});const nt=ht.filter(s=>{if(c){const f=$.get(String(s.clientId))?.customerName||"",g=[s.id,s.projectId,s.project_id,s.projectCode,s.project_code,s.reference,s.reference_code,s.code,_t(s)];if(!At([s.title,s.description,f,g.filter(F=>F!=null&&F!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(c))return!1}if(l&&xe(s)!==l)return!1;if(m||h){const f=s.start||s.createdAt||s.created_at||null,g=s.end||s.projectEnd||s.project_end||null,E=f?new Date(f):null,F=g?new Date(g):E;if(m&&E&&E<m||h&&F&&F>h)return!1}return!0}).sort((s,f)=>{const g=new Date(s.start||s.createdAt||0).getTime();return new Date(f.start||f.createdAt||0).getTime()-g});if(!nt.length){const s=d("technicianProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=nt.map(s=>{const f=_t(s),g=f?M.get(f)||[]:[],E=$.get(String(s.clientId))||null;return fe(s,{customer:E,techniciansMap:o,reservations:g})}).join(""),_e()}function Ne(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const i=String(a);e.has(i)||e.set(i,[]),e.get(i).push(n)}),e}function ie(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!ae()||!b.modal?.body)return;const{projects:a=[],reservations:i=[],customers:c=[]}=Tt(),l=b.projectsMap?.get(e)||null;let r=l??xt(a,e);if(r||(r=xt(a,e)),!r)return;const u=String(b.currentId||"");let m=U(r.technicians);!m.length&&l&&(m=U(l.technicians),r={...l,...r}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:u,normalizedTechnicians:m}}}),r={...r,technicians:m},c.find(h=>String(h.id)===String(r.clientId)),i.filter(h=>{const v=ge(h);return v&&v===e}),Mt.detailsModalEl=b.modal.el,Mt.detailsBody=b.modal.body,pt.projects=Fe(),pt.reservations=mt(),pt.customers=c||[],ye(e);try{if(!(window.bootstrap&&window.bootstrap.Modal)&&b.modal?.el){const h=b.modal.el;h.classList.add("show"),h.style.display="block",h.removeAttribute("aria-hidden")}}catch{}}function xt(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(c=>c!=null&&String(c)===n))||null}function xe(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}async function Ct(t,e){try{const n=await ve(()=>import("./reservationsUI.T12cFdpG.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url);try{n.renderReservations?.(t,e)}catch(a){console.error("âŒ [technician-details] renderReservations failed",a)}}catch(n){console.error("âŒ [technician-details] Failed to load reservations UI module",n)}}async function Ce(t,{signal:e}={}){const n=new URLSearchParams;t&&n.set("technician_id",t);const a=n.toString(),i=await ut(`/technician-payouts/${a?`?${a}`:""}`,{signal:e});return Array.isArray(i?.data)?i.data:[]}async function $e({technicianId:t,amount:e,note:n,paidAt:a}){return(await ut("/technician-payouts/",{method:"POST",body:{technician_id:t,amount:e,note:n,paid_at:a}}))?.data??null}async function qe(t){return(await ut(`/technician-payouts/?id=${encodeURIComponent(t)}`,{method:"DELETE"}))?.data??null}be();ue();me();ke();Ee();const $t=()=>{try{Ae(Ie())}catch(t){console.warn("âš ï¸ [technicianPage] Failed to initialize reservation edit modal",t)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$t,{once:!0}):$t();const ze=new URLSearchParams(window.location.search),y=ze.get("id"),N=document.getElementById("technician-details"),qt=document.getElementById("technician-hero-name"),Ue=document.getElementById("technician-hero-status"),zt=document.getElementById("technician-hero-role"),gt=document.getElementById("technician-hero-position"),it=document.getElementById("dashboard-greeting-technician-name"),Z=document.getElementById("dashboard-greeting-technician-role"),He=document.getElementById("dashboard-greeting-technician-status"),Ut=document.getElementById("dashboard-greeting-technician-role-badge"),Ve=document.getElementById("sidebar-stat-projects"),Oe=document.getElementById("sidebar-stat-reservations"),We=document.getElementById("sidebar-stat-equipment"),Ke=document.getElementById("sidebar-stat-technicians"),k={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},I=document.getElementById("technician-financial-modal"),ct=document.getElementById("technician-financial-open"),Ht=document.getElementById("technician-financial-modal-total"),Vt=document.getElementById("technician-financial-modal-paid"),Ot=document.getElementById("technician-financial-modal-outstanding"),yt=document.getElementById("technician-financial-modal-empty"),bt=document.getElementById("technician-financial-modal-table-wrapper"),vt=document.getElementById("technician-financial-modal-rows"),Ye=Array.from(document.querySelectorAll("[data-financial-modal-close]")),K=document.getElementById("technician-payout-form"),A=document.getElementById("technician-payout-amount"),G=document.getElementById("technician-payout-date"),Ge=document.getElementById("technician-payout-note"),V=document.getElementById("technician-payouts-list"),Dt=document.getElementById("technician-payouts-empty"),Q=document.getElementById("technician-payout-confirm-modal"),q=document.getElementById("technician-payout-confirm-yes"),Qe=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),It=Array.from(document.querySelectorAll("[data-technician-tab]")),Je=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let kt="reservations",L=null,H={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Et=[],dt=null;he();function jt(){return document.documentElement.getAttribute("lang")||"ar"}function st(t){const e=Number(t)||0,a=jt()==="ar"?"ar-SA-u-nu-latn":"en-US";try{return new Intl.NumberFormat(a,{maximumFractionDigits:0}).format(e)}catch{return D(String(e))||"0"}}function Xe(t){if(!t||typeof t!="object")return null;const e=n=>{const a=Number.parseInt(String(n??"0"),10);return Number.isFinite(a)?a:0};return{projects:e(t?.projects?.total),reservations:e(t?.reservations?.total),equipment:e(t?.equipment?.total),technicians:e(t?.technicians?.total)}}function Ze(){const t=Tt();return{projects:Array.isArray(t.projects)?t.projects.length:0,reservations:Array.isArray(t.reservations)?t.reservations.length:0,equipment:Array.isArray(t.equipment)?t.equipment.length:0,technicians:Array.isArray(t.technicians)?t.technicians.length:0}}function rt(t,e,n){let a=document.getElementById(t);if(a)return a;let i=document.getElementById("dashboard-sidebar");i||(i=document.createElement("aside"),i.id="dashboard-sidebar",i.className="sidebar-shell sidebar-drawer",(document.body||document.documentElement).prepend(i));let c=i.querySelector(".sidebar-panel--stats");c||(c=document.createElement("div"),c.className="sidebar-panel sidebar-panel--stats",c.innerHTML=`
      <h3 class="sidebar-heading">${d?.("dashboard.sidebar.statsHeading","Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…")}</h3>
      <div class="sidebar-stats" role="list"></div>
    `,i.prepend(c));let l=c.querySelector(".sidebar-stats");l||(l=document.createElement("div"),l.className="sidebar-stats",l.setAttribute("role","list"),c.appendChild(l));const r=document.createElement("div");r.className="sidebar-stats-row",r.setAttribute("role","listitem");const u=d?.(e,n)??n??"";return r.innerHTML=`<span>${u}</span><span id="${t}" class="badge-soft">0</span>`,l.appendChild(r),a=r.querySelector(`#${t}`),a}function x(t={}){const e=Ze(),n={projects:t.projects??e.projects,reservations:t.reservations??e.reservations,equipment:t.equipment??e.equipment,technicians:t.technicians??e.technicians},a={projects:Ve||rt("sidebar-stat-projects","dashboard.metrics.projects.label","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹"),reservations:Oe||rt("sidebar-stat-reservations","dashboard.metrics.reservations.label","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),equipment:We||rt("sidebar-stat-equipment","dashboard.metrics.equipment.label","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),technicians:Ke||rt("sidebar-stat-technicians","dashboard.metrics.technicians.label","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„")};a.projects&&(a.projects.textContent=st(n.projects)),a.reservations&&(a.reservations.textContent=st(n.reservations)),a.equipment&&(a.equipment.textContent=st(n.equipment)),a.technicians&&(a.technicians.textContent=st(n.technicians));try{window.__TECHNICIAN_STATS__={...n}}catch{}}function tn(){if(!y)return[];const t=mt(),e=String(y);return Array.isArray(t)?t.filter(n=>{if(!n)return!1;const a=String(n.status||"").toLowerCase();return a==="cancelled"||a==="canceled"||a==="Ù…Ù„ØºÙŠ"||a==="Ù…Ù„ØºÙ‰"||a==="Ù…Ù„ØºÙŠØ©"?!1:(Array.isArray(n.technicians)?n.technicians.map(c=>String(c)):[]).includes(e)}):[]}function en(){const t=tn(),e=ce(t,y?String(y):null);return x(e),e}function nn(t){if(!t||typeof t!="object")return 0;const e=[t.quantity,t.qty,t.count];for(const n of e){if(n==null||n==="")continue;const a=Number(D(String(n)));if(Number.isFinite(a))return a>0?a:0}return 1}function Pt(t){if(!t)return[];const e=new Set,n=a=>{U(a).forEach(i=>e.add(i))};return n(t.technicians),n(t.crewAssignments),n(t.techniciansDetails),Array.from(e)}function ce(t,e){if(!Array.isArray(t)||!t.length)return{projects:0,reservations:0,equipment:0,technicians:e?1:0};const n=new Set,a=new Set;e&&a.add(String(e));let i=0;return t.forEach(c=>{if(!c)return;c.projectId!=null&&n.add(String(c.projectId)),Pt(c).forEach(r=>a.add(r)),Array.isArray(c.items)&&c.items.forEach(r=>{i+=nn(r)})}),{projects:n.size,reservations:t.length,equipment:i,technicians:a.size||(e?1:0)}}async function an(){try{const t=await ut("/summary/"),e=Xe(t?.data??null);if(e){x(e);return}}catch{}try{await Promise.allSettled([Se(),Te(),Qt(),De({showToastOnError:!1})])}catch{}x()}function j(t){const e=Number(t)||0,a=jt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${D(i)} SR`}catch{const c=Math.round(e);return`${D(String(c))} SR`}}function wt(t){if(!t)return d("common.placeholder.empty","â€”");const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return d("common.placeholder.empty","â€”");const a=jt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const c=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),r=e.getFullYear();return`${c}/${l}/${r}`}}function J(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Wt(t={}){const e=[t.positionCost,t.position_cost,t.cost,t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(D(String(n)));if(Number.isFinite(a))return a}return 0}function cn(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="technician-payment-badge technician-payment-badge--unpaid";return e==="paid"?(n="technicianFinancial.status.paid",a="technician-payment-badge technician-payment-badge--paid"):e==="partial"&&(n="technicianFinancial.status.partial",a="technician-payment-badge technician-payment-badge--partial"),`<span class="${a}" data-i18n data-i18n-key="${n}">${d(n,n)}</span>`}function Kt(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),i=Number(n.payoutsCount??0),c=d("technicianFinancial.stats.totalDesc","Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…").replace("{count}",D(String(a))),l=d("technicianFinancial.stats.paidDesc","{count} Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©").replace("{count}",D(String(i))),r=d("technicianFinancial.stats.outstandingDesc","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}"),u=e.outstanding>0?r.replace("{amount}",j(e.outstanding)):d("common.placeholder.empty","â€”");k.total&&(k.total.textContent=j(e.total)),k.totalDesc&&(k.totalDesc.textContent=a>0?c:d("common.placeholder.empty","â€”")),k.paid&&(k.paid.textContent=j(e.paid)),k.paidDesc&&(k.paidDesc.textContent=i>0?l:d("common.placeholder.empty","â€”")),k.outstanding&&(k.outstanding.textContent=j(e.outstanding)),k.outstandingDesc&&(k.outstandingDesc.textContent=u)}function Ft(t){const{totals:e,breakdown:n,payouts:a}=t;if(Ht&&(Ht.textContent=j(e.total)),Vt&&(Vt.textContent=j(e.paid)),Ot&&(Ot.textContent=j(e.outstanding)),!(!vt||!bt||!yt)){if(!n.length)vt.innerHTML="",bt.classList.add("hidden"),yt.classList.remove("hidden");else{yt.classList.add("hidden"),bt.classList.remove("hidden");const i=n.map(c=>{const l=c.period||"â€”",r=c.outstandingAmount>0?j(c.outstandingAmount):`<span class="text-success">${d("technicianFinancial.list.settled","Ù„Ø§ ÙŠÙˆØ¬Ø¯")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${J(c.label)}</div>
            <div class="text-xs text-base-content/60">${J(c.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${J(l)}</td>
          <td>${j(c.dueAmount)}</td>
          <td>${cn(c.paidStatus)}</td>
          <td>${r}</td>
        </tr>
      `}).join("");vt.innerHTML=i}sn(a)}}function sn(t=[]){if(!V||!Dt)return;if(!Array.isArray(t)||t.length===0){V.innerHTML="",Dt.classList.remove("hidden");return}const e=t.map(n=>{const a=j(n.amount||0),i=wt(n.paidAt||n.createdAt),c=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${J(n.note)}</p>`:"",l=d("actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${J(i)}</span>
          </div>
          ${c}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${J(n.id)}" data-i18n data-i18n-key="actions.delete">${l}</button>
      </li>
    `}).join("");V.innerHTML=e,Dt.classList.add("hidden")}function se(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function rn(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function on(t){const e=D(String(t??""));if(!e)return"";const i=e.replace(/[Ù¬ØŒ]/g,"").replace(/[Ù«,]/g,".").replace(/[^0-9.]/g,"").split("."),c=i[0]||"",l=i.length>1?i.slice(1).join(""):"",r=c.replace(/^0+(\d)/,"$1"),u=r.length?r:l?"0":"",m=l?l.replace(/\D/g,"").slice(0,2):"";return m?`${u}.${m}`:u}function ln(t){if(t.preventDefault(),!y){W(d("technicianFinancial.payouts.toast.invalidTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹."));return}const e=A?.value??"",n=Number.parseFloat(D(String(e)));if(!Number.isFinite(n)||n<=0){W(d("technicianFinancial.payouts.toast.invalidAmount","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.")),A?.focus();return}const a=Ge?.value?.trim()||"",i=rn(G?.value||null),c=K?.querySelector('button[type="submit"]');c&&(c.disabled=!0),$e({technicianId:y,amount:Number(n.toFixed(2)),note:a,paidAt:i.toISOString()}).then(l=>{W(d("technicianFinancial.payouts.toast.added","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.")),K?.reset(),G&&(G.value=se(l?.paidAt||new Date)),L&&et(L)}).catch(l=>{console.error("âŒ [technician-page] Failed to create technician payout",l);const r=l?.message||d("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");W(r)}).finally(()=>{c&&(c.disabled=!1)})}function dn(t){t&&mn(t)}function un(){I&&(I.classList.remove("hidden"),I.classList.add("show"),I.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),G&&!G.value&&(G.value=se(new Date)))}function Bt(){I&&(I.classList.remove("show"),I.classList.remove("modal-open"),I.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function mn(t){Q&&(dt=t||null,Q.classList.remove("hidden"),Q.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function St(){Q&&(Q.classList.remove("show","modal-open"),Q.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),dt=null,q&&(q.disabled=!1))}function re(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function hn(t){if(t.preventDefault(),!L)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...L}}))}catch(a){console.error("âš ï¸ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function oe(){re().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",hn),t.dataset.listenerAttached="true")})}async function et(t){if(H={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Kt(H),Ft(H),x(),!y||!t)return;try{await Zt({suppressError:!0})}catch(o){console.error("âš ï¸ [technician-page] Failed to load reservations for financial summary",o)}const n=mt(),a=String(y);try{const o=await Ce(a);Et=Array.isArray(o)?o:[]}catch(o){console.error("âš ï¸ [technician-page] Failed to load technician payouts from API",o),Et=[]}const i=n.filter(o=>{if(!o)return!1;const p=String(o.status||"").toLowerCase();return p==="cancelled"||p==="canceled"||p==="Ù…Ù„ØºÙŠ"||p==="Ù…Ù„ØºÙ‰"||p==="Ù…Ù„ØºÙŠØ©"?!1:Pt(o).includes(a)}),c=ce(i,a);x(c);const l=i.map((o,p)=>{const M=Array.isArray(o.techniciansDetails)?o.techniciansDetails.find(S=>{const R=S?.id??S?.technician_id??S?.technicianId??S?.ID;return R!=null&&String(R)===a}):null,_=Wt(M)||Wt(t),T=Math.max(1,Le(o.start,o.end)),O=Math.max(0,Math.round(_*T)),ht=d("technicianFinancial.list.reservationFallback","Ø­Ø¬Ø² Ø±Ù‚Ù… {id}").replace("{id}",D(String(o.reservationId||o.id||"?"))),nt=o.title&&o.title.trim().length?o.title.trim():ht,s=[];if(o.reservationId||o.id){const S=o.reservationId||o.id;s.push(`#${D(String(S))}`)}if(o.projectId&&s.push(d("technicianFinancial.list.projectReference","Ù…Ø´Ø±ÙˆØ¹ #{id}").replace("{id}",D(String(o.projectId)))),o.status){const S=`reservations.status.${o.status}`;s.push(d(S,o.status))}const f=wt(o.start),g=wt(o.end),E=f===g?f:`${f} â€“ ${g}`,F=(()=>{const S=o.start||o.startDatetime||o.createdAt||o.created_at,R=S?new Date(S).getTime():NaN;return Number.isNaN(R)?p:R})();return{label:nt,reference:s.join(" â€¢ ")||"â€”",period:E,dueAmount:O,paidAmount:0,outstandingAmount:O,paidStatus:"unpaid",sortKey:F,originalIndex:p}}),r=Et.map(o=>({...o,amount:Number(o.amount)||0}));let u=r.reduce((o,p)=>o+p.amount,0);const h=[...l].sort((o,p)=>o.sortKey===p.sortKey?o.originalIndex-p.originalIndex:o.sortKey-p.sortKey).map(o=>{const p={...o},M=Number(o.dueAmount)||0,_=Math.min(M,Math.max(0,Number(u.toFixed(2))));_>0&&(u=Number((u-_).toFixed(2))),p.paidAmount=Number(_.toFixed(2));const T=Math.max(0,Number((M-_).toFixed(2)));return p.outstandingAmount=T,T<=.009?(p.paidStatus="paid",p.outstandingAmount=0):_>0?p.paidStatus="partial":p.paidStatus="unpaid",p}).sort((o,p)=>o.originalIndex-p.originalIndex).map(({sortKey:o,originalIndex:p,...M})=>M),v=h.reduce((o,p)=>o+p.dueAmount,0),w=r.reduce((o,p)=>o+(Number(p.amount)||0),0),B=Math.max(0,Number((v-w).toFixed(2))),C={total:Math.max(0,Number(v.toFixed(2))),paid:Math.max(0,Number(w.toFixed(2))),outstanding:B},$={assignments:h.length,payoutsCount:r.length,outstandingAmount:B};H={totals:C,metrics:$,breakdown:h,payouts:r},Kt(H),Ft(H)}function z(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const i=n==null?"":String(n).trim(),c=i.length>0;t.textContent=c?`${e} ${i}`:`${e} ${d("common.placeholder.empty","â€”")}`,a?t.classList.toggle("hidden",!c):c||t.classList.remove("hidden")}function Yt(t){const e=[Ue,He].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(r=>{r.className="technician-badge hidden",r.textContent=d("common.placeholder.empty","â€”")});return}const a=n==="busy",i=["technician-badge"];i.push(a?"technician-badge--status-busy":"technician-badge--status-available");const c=a?"technicians.status.busy":"technicians.status.available",l=a?"â›” Ù…Ø´ØºÙˆÙ„":"âœ… Ù…ØªØ§Ø­";if(e.forEach(r=>{r.className=i.join(" "),r.classList.remove("hidden"),r.setAttribute("data-i18n",""),r.setAttribute("data-i18n-key",c),r.textContent=d(c,l)}),gt)if(a){const r=pn(y),u=r&&String(r).trim().length?r:"";z(gt,"ğŸ·ï¸",u,{hideWhenEmpty:!0})}else z(gt,"ğŸ·ï¸","",{hideWhenEmpty:!0})}function pn(t){try{const e=mt();if(!Array.isArray(e)||e.length===0)return"";const n=t!=null?String(t):null;if(!n)return"";const a=new Date,i=e.find(u=>{if(!u||!u.start&&!u.startDatetime&&!u.start_datetime)return!1;const m=Pt(u);if(!Array.isArray(m)||!m.includes(n))return!1;const h=u.start??u.startDatetime??u.start_datetime,v=u.end??u.endDatetime??u.end_datetime;if(!h||!v)return!1;const w=new Date(h),B=new Date(v);return Number.isNaN(w.getTime())||Number.isNaN(B.getTime())?!1:w<=a&&a<B});if(!i)return"";const l=(Array.isArray(i.crewAssignments)&&i.crewAssignments.length?i.crewAssignments:Array.isArray(i.techniciansDetails)?i.techniciansDetails:[]).find(u=>{const m=u?.id??u?.technicianId??u?.technician_id;return m!=null&&String(m)===n});return l&&(l.positionLabel??l.position_name??l.position_label??l.positionKey??l.position)||""}catch{return""}}function Y(t){if(!t){z(qt,"ğŸ˜",d("common.placeholder.empty","â€”")),z(zt,"ğŸ¯","",{hideWhenEmpty:!0}),it&&(it.textContent=d("common.placeholder.empty","â€”")),Z&&(Z.textContent=d("common.placeholder.empty","â€”")),z(Ut,"ğŸ¯","",{hideWhenEmpty:!0}),Yt(null);return}if(z(qt,"ğŸ˜",t.name||d("common.placeholder.empty","â€”")),z(zt,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),it&&(it.textContent=t.name||d("common.placeholder.empty","â€”")),Z){const e=t.role?t.role:"";if(e)Z.textContent=`ğŸ¯ ${e}`;else{const n=d("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯");Z.textContent=`ğŸ¯ ${n}`}}z(Ut,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),Yt(t.status||t.baseStatus||"available")}function tt(t){re().forEach(e=>{e.disabled=!!t})}function lt(t){t&&(kt=t,It.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Je.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&y&&ne(y),t==="reservations"&&y&&ee(y))}function fn(){It.length&&(It.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&lt(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&lt(n)}),t.dataset.listenerAttached="true")}),lt(kt))}Y(null);tt(!0);fn();oe();ct&&!ct.dataset.listenerAttached&&(ct.addEventListener("click",()=>{Ft(H),un()}),ct.dataset.listenerAttached="true");Ye.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{Bt()}),t.dataset.listenerAttached="true")});K&&!K.dataset.listenerAttached&&(K.addEventListener("submit",ln),K.dataset.listenerAttached="true");V&&!V.dataset.listenerAttached&&(V.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");dn(n)}),V.dataset.listenerAttached="true");if(A&&!A.dataset.normalizerAttached){const t=()=>{const e=on(A.value);if(e!==A.value){const n=e.length;A.value=e,A.setSelectionRange&&A.setSelectionRange(n,n)}};A.addEventListener("input",t),A.addEventListener("blur",()=>{if(t(),A.value){const e=Number.parseFloat(A.value);Number.isFinite(e)&&(A.value=e.toFixed(2))}}),A.dataset.normalizerAttached="true"}Qe.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",St),t.dataset.listenerAttached="true")});q&&!q.dataset.listenerAttached&&(q.addEventListener("click",()=>{if(!dt){St();return}q.disabled=!0,qe(dt).then(()=>{W(d("technicianFinancial.payouts.toast.removed","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.")),St(),L&&et(L)}).catch(t=>{console.error("âŒ [technician-page] Failed to remove technician payout",t);const e=t?.message||d("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");W(e),q.disabled=!1})}),q.dataset.listenerAttached="true");I&&!I.dataset.listenerAttached&&(I.addEventListener("click",t=>{t.target===I&&Bt()}),I.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&I&&I.classList.contains("modal-open")&&Bt()});const ot=document.getElementById("logout-btn");ot&&!ot.dataset.listenerAttached&&(ot.addEventListener("click",()=>pe()),ot.dataset.listenerAttached="true");function gn(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function yn(t){const e=Number(t??0);if(!Number.isFinite(e)||e<=0)return"";const n=d("technicians.badge.perDay","/Ø§Ù„ÙŠÙˆÙ…");return`${j(e)} ${n}`}function Gt(t){const e=Number(t??0);return!Number.isFinite(e)||e<=0?"":j(e)}function le(t){if(!N)return;if(Y(t),!t){N.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,tt(!0);return}const e=t.phone?D(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${d("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±")}</span>`,n=t.email?t.email:`<span data-i18n data-i18n-key="technicianDetails.fallback.email">${d("technicianDetails.fallback.email","â€”")}</span>`,a=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${d("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯")}</span>`,i=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${d("technicianDetails.fallback.department","â€”")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${d("technicianDetails.fallback.notes","â€”")}</span>`,r=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${d("reservations.create.summary.currency","SR")}</span>`,u=yn(t.dailyWage)||`${gn(t.dailyWage)} ${r}`,m=Gt(t.dailyTotal),h=u,v=m||Gt(t.dailyWage)||u;console.debug("[technician] amounts",{id:t.id,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,wageValue:h,totalValue:v});const B=[{key:"technicianDetails.fields.role",value:a},{key:"technicianDetails.fields.department",value:i},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.email",value:n},{key:"technicianDetails.fields.notes",value:c}].map(({key:C,value:$})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${C}">${d(C)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${$}</p>
    </article>
  `).join("");N.innerHTML=B,oe(),tt(!1),lt(kt)}async function bn(){if(!N)return;if(!y){Y(null),x(),tt(!0),L=null,N.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${d("technicianDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}N.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${d("technicianDetails.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...")}</p>`,tt(!0),Y(null);let t=null,e=null;try{await Qt(),Lt()}catch(n){e=n,console.error("âŒ [technician-details] Failed to refresh technician from API",n)}if(t=Jt(y),!t){e?N.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${d("technicianDetails.errors.loadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.")}</p>`:N.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,Y(null),x(),L=null;return}if(!t){N.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,Y(null),x(),L=null;return}L=t,await et(t),le(t),ee(y),ne(y)}Lt();bn();["projects:changed","reservations:changed","equipment:changed","technicians:changed"].forEach(t=>{document.addEventListener(t,()=>{y?en():x()},{passive:!0})});je();an();const vn=async()=>{if(!y)return;Lt();const t=Jt(y);t&&(L=t,await et(t),le(t))};window.addEventListener("technicians:updated",vn);const Dn=()=>{!y||!L||et(L)};document.addEventListener("reservations:changed",Dn,{passive:!0});
