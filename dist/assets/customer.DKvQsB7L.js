const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.0KqAwGV6.js","./controller.CXOLJ_E5.js","./auth.3yXlKH4-.js","./auth.BRpROm3j.css","./details.CGTw6atl.js","./state.Dzk_x-65.js","./reservationsService.2yZn26uw.js","./uiBridge.BDSJ7fDF.js","./reservationPdf.D98AU2Lq.js","./view.Bs6LAw1l.js","./quotePdf.kDBbUcue.js","./canvasColorUtils.CviLtv6S.js","./reservationsActions.C5_aXSHl.js","./projectsService.CrQttqwa.js"])))=>i.map(i=>d[i]);
import{n as _,d as Y,t as d,a as pe,c as ye,i as he,m as ge,l as ve,b as st,A as Ee,j as gt,h as Tt}from"./auth.3yXlKH4-.js";import"./dashboard.BI-ZQVki.js";import{o as be}from"./projectDetails.D7liAI8h.js";import{g as Ae,b as Ie,r as De,a as wt,P as Se}from"./projectFocusTemplates.r68iEoof.js";import{_ as ae,s as xe,b as _e}from"./uiBridge.BDSJ7fDF.js";import{r as Lt}from"./reservationPdf.D98AU2Lq.js";import{d as ke,r as je,f as At,m as Be}from"./state.Dzk_x-65.js";import{getProjectsState as se,refreshProjectsFromApi as Ne,mapProjectFromApi as Te}from"./projectsService.CrQttqwa.js";import{g as re,r as Le,c as zt,m as Ce}from"./reservationsService.2yZn26uw.js";import{d as Ut,s as It}from"./view.Bs6LAw1l.js";import{i as Pe}from"./dashboardShell.DF2kUed9.js";import{initDashboardMetrics as Re}from"./dashboardMetrics.BAk2T7-Z.js";import"./quotePdf.kDBbUcue.js";import"./canvasColorUtils.CviLtv6S.js";let Dt={},k={initialized:!1,currentId:null,modal:{el:null,body:null}};function _t(t=""){return _(String(t)).trim().toLowerCase()}function ie(t,e,n){if(!e||!n)return;const{startDate:a,endDate:r}=Lt(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?r?n._flatpickr.setDate(r,!1,"Y-m-d"):n._flatpickr.clear():n.value=r||""}function qt(t,{endOfDay:e=!1}={}){if(!t)return null;const n=String(t).trim();if(!n)return null;const a=n.includes("T")?n:`${n}T00:00:00`,r=new Date(a);return Number.isNaN(r.getTime())?null:(e?r.setHours(23,59,59,999):r.setHours(0,0,0,0),r)}function St(t){const e=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const n of e){if(!n)continue;const a=new Date(n);if(!Number.isNaN(a.getTime()))return a.setHours(0,0,0,0),a}return null}function vt(t){if(!document.getElementById("customer-reservations"))return;const n=document.getElementById("customer-search-reservation"),a=document.getElementById("customer-filter-start-date"),r=document.getElementById("customer-filter-end-date"),i=document.getElementById("customer-reservation-date-range"),c=document.getElementById("customer-reservation-status-filter"),f=document.getElementById("customer-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),r&&window.flatpickr(r,{dateFormat:"Y-m-d"}));const m=()=>{let h=_(a?.value||"").trim(),v=_(r?.value||"").trim(),p=i?.value||"";if(new Set(["","today","week","month"]).has(p)||(p="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r._flatpickr&&r._flatpickr.clear(),r.value=""),h="",v=""),!h&&!v&&p){const{startDate:I,endDate:N}=Lt(p);h=I,v=N}return{searchTerm:_t(n?.value||""),startDate:h,endDate:v,status:c?.value||"",quickRange:p,customerId:t}},l=()=>{Dt=m(),Ht("customer-reservations",Dt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=_(n.value),l()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{i&&(i.value=""),l()}),a.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{i&&(i.value=""),l()}),r.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ie(i.value,a,r),l()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",l),c.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r._flatpickr&&r._flatpickr.clear(),r.value=""),i&&(i.value=""),c&&(c.value=""),l()}),f.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{Ht("customer-reservations",Dt)},l()}function rt(t){k.currentId=t;const{container:e}=Z();e&&(k.initialized||(Fe(),Me(),we(),document.addEventListener("projects:changed",()=>{k.currentId&&P()}),document.addEventListener("language:changed",()=>{k.currentId&&P()}),document.addEventListener("technicians:updated",()=>{k.currentId&&P()}),k.initialized=!0),P())}function Z(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Fe(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:r,rangeSelect:i}=Z();window.flatpickr&&(a&&!a.dataset.datepickerAttached&&(window.flatpickr(a,{dateFormat:"Y-m-d"}),a.dataset.datepickerAttached="true"),r&&!r.dataset.datepickerAttached&&(window.flatpickr(r,{dateFormat:"Y-m-d"}),r.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=_(t.value),P()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{P()}),e.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.value=_(a.value),i&&(i.value=""),P()}),a.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{r.value=_(r.value),i&&(i.value=""),P()}),r.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{ie(i.value,a,r),P()}),i.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:c,statusSelect:f,startInput:m,endInput:l,rangeSelect:h}=Z();c&&(c.value=""),f&&(f.value=""),h&&(h.value=""),m&&(m._flatpickr&&m._flatpickr.clear(),m.value=""),l&&(l._flatpickr&&l._flatpickr.clear(),l.value=""),P()}),n.dataset.listenerAttached="true")}function Me(){const{container:t}=Z();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",$e),t.dataset.projectModalListenerAttached="true")}function $e(t){const e=t.target.closest(".project-focus-card");if(!e)return;const n=e.dataset.projectId?String(e.dataset.projectId):"";n&&ce(n)}function we(){oe()}function oe(){if(k.modal?.el&&k.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");if(!t||!e){const r=document.createElement("div");r.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${d("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(r.firstElementChild)}const n=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");return!n||!a?!1:(k.modal={el:n,body:a},!0)}function P(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:r,rangeSelect:i}=Z();if(!t||!k.currentId)return;const c=_t(e?.value||""),f=n?.value||"";let m=_(a?.value||"").trim(),l=_(r?.value||"").trim(),h=i?.value||"";if(new Set(["","today","week","month"]).has(h)||(h="",i&&(i.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r._flatpickr&&r._flatpickr.clear(),r.value=""),m="",l=""),!m&&!l&&h){const{startDate:y,endDate:A}=Lt(h);m=y,l=A}const p=qt(m),E=qt(l,{endOfDay:!0}),{projects:I=[],technicians:N=[],reservations:D=[],customers:j=[]}=Y(),T=new Map(N.map(y=>[String(y.id),y])),b=ze(D),S=j.find(y=>String(y.id)===String(k.currentId))||null,q=I.filter(y=>String(y.clientId)===String(k.currentId)).filter(y=>{if(c){const A=[y.id,y.projectId,y.project_id,y.projectCode,y.project_code].map(H=>H==null?"":_(String(H)));if(!_t([y.title,y.description,y.notes,...A].filter(Boolean).join(" ")).includes(c))return!1}if(f&&ke(y)!==f)return!1;if(p||E){const A=St(y);if(!A||p&&A<p||E&&A>E)return!1}return!0}).sort((y,A)=>{const L=St(y)?.getTime()||0;return(St(A)?.getTime()||0)-L});if(!q.length){const y=d("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${y}</div></div>`;return}t.innerHTML=q.map(y=>{const A=Ae(y),L=A?b.get(A)||[]:[];return Ie(y,{customer:S,techniciansMap:T,reservations:L})}).join(""),t.querySelectorAll(".project-focus-card").forEach(y=>{y.dataset.customerModalListenerAttached!=="true"&&(y.addEventListener("click",A=>{const L=y.dataset.projectId?String(y.dataset.projectId):"";if(L){try{console.debug("[customer] project card click",L)}catch{}ce(L)}}),y.dataset.customerModalListenerAttached="true")})}function ze(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const r=String(a);e.has(r)||e.set(r,[]),e.get(r).push(n)}),e}function ce(t){const e=String(t||"").trim();if(!e||!oe())return;const{projects:n=[],reservations:a=[],customers:r=[]}=Y(),i=k.modal;Ut.detailsModalEl=i.el,Ut.detailsBody=i.body;const c=se(),f=re(),m=Array.isArray(c)?c.some(l=>String(l?.id)===e):!1;It.projects=Array.isArray(c)&&c.length&&m?c:n||[],It.reservations=Array.isArray(f)&&f.length?f:a||[],It.customers=r||[],be(e);try{if(!(window.bootstrap&&window.bootstrap.Modal)&&k.modal?.el){const l=k.modal.el;l.classList.add("show"),l.style.display="block",l.removeAttribute("aria-hidden")}}catch{}}async function Ht(t,e){try{const n=await ae(()=>import("./reservationsUI.0KqAwGV6.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]),import.meta.url);try{n.renderReservations?.(t,e)}catch(a){console.error("âŒ [customer-details] renderReservations failed",a)}}catch(n){console.error("âŒ [customer-details] Failed to load reservations UI module",n)}}pe();ye();he();Pe();ge();const it=document.getElementById("logout-btn");it&&!it.dataset.listenerAttached&&(it.addEventListener("click",()=>ve()),it.dataset.listenerAttached="true");xe({showReservationDetails(t){ae(()=>import("./reservationsUI.0KqAwGV6.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]),import.meta.url).then(e=>{try{e.showReservationDetails?.(t)}catch(n){console.error("âŒ showReservationDetails failed",n)}}).catch(e=>console.error("âŒ Failed to load reservations UI module",e))}});const Ue=new URLSearchParams(window.location.search),x=Ue.get("id"),V=document.getElementById("customer-details"),Vt=document.getElementById("customer-hero-name"),qe=document.getElementById("customer-hero-phone"),He=document.getElementById("customer-hero-company"),Ve=document.getElementById("customer-hero-email"),Oe=document.getElementById("customer-hero-tax"),Ot=document.getElementById("customer-hero-summary"),Yt=document.getElementById("dashboard-greeting-customer-name"),Wt=document.getElementById("dashboard-greeting-customer-company"),ot=document.getElementById("customer-stat-projects"),ct=document.getElementById("customer-stat-projects-desc"),lt=document.getElementById("customer-stat-payment"),dt=document.getElementById("customer-stat-payment-desc"),ut=document.getElementById("customer-stat-upcoming"),mt=document.getElementById("customer-stat-upcoming-desc"),G=document.getElementById("customer-stat-activity"),ft=document.getElementById("customer-stat-activity-desc"),pt=document.getElementById("customer-stat-compliance"),J=document.getElementById("customer-stat-compliance-desc"),Kt=document.getElementById("sidebar-stat-projects"),Qt=document.getElementById("sidebar-stat-reservations"),Gt=document.getElementById("sidebar-stat-equipment"),Jt=document.getElementById("sidebar-stat-technicians"),Ct=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),kt=Array.from(document.querySelectorAll("[data-customer-tab]")),Ye=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),z=document.getElementById("edit-document-file"),K=document.getElementById("edit-document-preview"),Xt=document.getElementById("edit-document-file-name"),tt=document.getElementById("edit-document-url"),et=document.getElementById("edit-document-name");let B=null,R="idle",M=null;Ct.forEach(t=>{t.disabled=!0});let u=null,X=!1,$="",Pt="reservations",nt=null,at=null;function C(t=""){const e=document.createElement("div");return e.textContent=t==null?"":String(t),e.innerHTML}function We(t=""){const e=C(t).replace(/\r/g,""),n=`
`;return e.includes(n)?e.split(n).join("<br>"):e}function Ke(t=null){M=t&&typeof t=="object"?{...t}:null,B=null,R="idle",z&&(z.value=""),W()}function W(){if(!Xt||!K)return;const t=R==="uploading",e=!!B?.dataUrl;let n=d("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?n=d("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):R==="error"?n=d("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):e?n=B?.fileName||d("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):M&&(M.fileName||M.url)&&(n=M.fileName||M.url),Xt.textContent=n;const a=e||!!M?.url;K.disabled=t||!a}function Qe(){if(!z)return;const[t]=z.files||[];if(!t){R="idle",B=null,W();return}R="uploading",W();const e=new FileReader;e.onload=()=>{if(typeof e.result!="string"){R="error",B=null,W();return}B={dataUrl:e.result,fileName:t.name,mimeType:t.type,size:t.size},tt&&(tt.value=e.result),et&&(et.value=t.name),R="success",W()},e.onerror=()=>{R="error",B=null,W()},e.readAsDataURL(t)}z&&!z.dataset.listenerAttached&&(z.addEventListener("change",Qe),z.dataset.listenerAttached="true");K&&!K.dataset.listenerAttached&&(K.addEventListener("click",()=>{if(R==="uploading")return;const t=B?.dataUrl||M?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),K.dataset.listenerAttached="true");function yt(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const r=n==null?"":String(n).trim(),i=r.length>0,c=i?r:d("common.placeholder.empty","â€”");t.textContent=`${e} ${c}`,a?t.classList.toggle("hidden",!i):t.classList.remove("hidden")}function jt(t){const e=d("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),n=d("common.placeholder.empty","â€”"),a=t?.customerName||n,r=t?.phone?_(t.phone):"",i=t?.companyName||"",c=t?.email||"",f=t?.tax_id??t?.taxId??"";if(Vt&&(Vt.textContent=a),Ot&&(Ot.textContent=a!==n?a:e),yt(qe,"ğŸ“",r,{hideWhenEmpty:!1}),yt(He,"ğŸ¢",i,{hideWhenEmpty:!0}),yt(Ve,"ğŸ“§",c,{hideWhenEmpty:!0}),yt(Oe,"ğŸ§¾",f,{hideWhenEmpty:!0}),Yt&&(Yt.textContent=a),Wt){const m=[];i&&m.push(i),r&&m.push(`ğŸ“ ${r}`);const l=typeof f=="string"?f.trim():String(f||"").trim();l&&m.push(`ğŸ§¾ ${l}`),Wt.textContent=m.length?m.join(" â€¢ "):"â€”"}}function Ge(t){if(t?.preventDefault?.(),!u)return;fn();const e=document.getElementById("editCustomerModal"),n=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!n)return;(n.getInstance(e)||new n(e)).show()}function Je(){Ct.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Ge),t.dataset.listenerAttached="true")})}function Bt(t){Ct.forEach(e=>{e&&(e.disabled=!!t)})}Je();function Nt(t){t&&(Pt=t,kt.forEach(e=>{const n=e?.getAttribute("data-customer-tab")===t;e&&(e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n)))}),Ye.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&x&&u&&rt(x))}function Xe(){kt.length&&(kt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-customer-tab");e&&Nt(e)}),t.dataset.listenerAttached="true")}),Nt(Pt))}Xe();function le(t={}){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(b=>b&&typeof b=="object"),n=b=>{for(const S of b)if(typeof S=="string"&&S.trim()!=="")return S.trim();return""},a=b=>{for(const S of b){if(typeof S=="number"&&Number.isFinite(S))return Math.max(0,Math.trunc(S));if(typeof S=="string"&&S.trim()!==""&&/^\d+$/.test(S.trim()))return Math.max(0,parseInt(S.trim(),10))}return null},r=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],i=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],c=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],f=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],m=[t.document_size,t.documentSize,t.size,e?.size,e?.length],l=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],h=n(r),v=n(c),p=n(f)||"application/octet-stream",E=n(i),I=n(l),N=a(m);if(!h&&!I)return null;let D=h,j=I;if(!D&&j&&j.startsWith("data:")){const b=j.indexOf(",");b!==-1&&(D=j,j=j.slice(b+1))}!D&&j&&(D=`${j.startsWith("data:")?"":`data:${p};base64,`}${j}`);const T={url:D,fileName:v,mimeType:p,path:E,data:j||null,size:N};return T.url&&/sirv\.com/i.test(T.url)&&(T.source="sirv"),T}function Ze(){return document.documentElement.getAttribute("lang")||"ar"}function F(t){const e=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(e)}catch{return String(e)}}function Zt(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const a=Ze()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),f=e.getFullYear();return`${i}/${c}/${f}`}}function te(t){if(!t)return"";const e=t.trim().split(/\s+/),n=e.pop()||"";return`<span class="currency-amount">${e.join(" ")}</span> <span class="currency-unit currency-unit--sm">${n}</span>`}function ee(t,e){const n=d("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),a=d("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${n}</span>
      ${te(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${a}</span>
      ${te(e)}
    </div>
  `}const ne={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},tn={reservation:"Reservation",project:"Project",customer:"Client record"};function xt(t=[]){let e=null;return t.forEach(n=>{if(!n)return;const a=n instanceof Date?n:new Date(n);Number.isNaN(a.getTime())||(!e||a>e)&&(e=a)}),e}function en(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function nn(t){if(!t||typeof t!="object")return null;const e=n=>{const a=Number.parseInt(String(n??"0"),10);return Number.isFinite(a)?a:0};return{projects:e(t?.projects?.total),reservations:e(t?.reservations?.total),equipment:e(t?.equipment?.total),technicians:e(t?.technicians?.total)}}function an(){const t=Y();return{projects:Array.isArray(t.projects)?t.projects.length:0,reservations:Array.isArray(t.reservations)?t.reservations.length:0,equipment:Array.isArray(t.equipment)?t.equipment.length:0,technicians:Array.isArray(t.technicians)?t.technicians.length:0}}function O(t={}){const e=an(),n={projects:t.projects??e.projects,reservations:t.reservations??e.reservations,equipment:t.equipment??e.equipment,technicians:t.technicians??e.technicians};Kt&&(Kt.textContent=F(n.projects)),Qt&&(Qt.textContent=F(n.reservations)),Gt&&(Gt.textContent=F(n.equipment)),Jt&&(Jt.textContent=F(n.technicians));try{window.__CUSTOMER_STATS__={...n}}catch{}}function U(){if(!u||!x){const s=At(0);if(ot&&(ot.textContent="0"),ct&&(ct.textContent=d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),lt&&(lt.innerHTML=ee(s,s)),dt){const o=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),g=d("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");dt.textContent=`${o} â€¢ ${g}`}ut&&(ut.textContent="0"),mt&&(mt.textContent=d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),G&&(G.textContent="â€”"),ft&&(ft.textContent=d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),pt&&(pt.textContent="0%"),J&&(J.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),O();return}const t=Array.isArray(nt)?nt:re(),n=(Array.isArray(t)?t:[]).filter(s=>s?[s.customerId,s.customer_id,s.customer?.id].some(g=>g!=null&&String(g)===String(x)):!1),a=n.length,r=Date.now(),i=n.filter(s=>{const o=s?.start??s?.startDatetime??s?.start_datetime??s?.start_date;if(!o)return!1;const g=new Date(o);return Number.isNaN(g.getTime())?!1:g.getTime()>=r}),c=i.map(s=>s?.start??s?.startDatetime??s?.start_datetime).map(s=>new Date(s)).filter(s=>!Number.isNaN(s.getTime())).sort((s,o)=>s-o)[0]||null,f=Array.isArray(at)?at:se(),l=(Array.isArray(f)?f:[]).filter(s=>s?[s.clientId,s.client_id,s.customer_id].some(g=>g!=null&&String(g)===String(x)):!1),h=l.length,v=n.filter(s=>{const o=String(s?.status||s?.reservationStatus||"").toLowerCase();return!(o==="cancelled"||o==="canceled"||o==="Ù…Ù„ØºÙŠ"||o==="Ù…Ù„ØºÙ‰"||o==="Ù…Ù„ØºÙŠØ©")}),p=new Map;v.forEach(s=>{const o=s?.projectId??s?.project_id??null;if(o==null)return;const g=String(o);p.has(g)||p.set(g,[]),p.get(g).push(s)});let E=0,I=0,N=0,D=0;l.forEach(s=>{const o=De(s)||{},g=s?.id??s?.projectId??s?.project_id??null,Q=(g!=null?p.get(String(g))||[]:[]).reduce((fe,$t)=>fe+(Number($t?.totalAmount)||wt($t)||0),0),ue=o.applyTax?Number(((Number(o.subtotal||0)+Q)*Se).toFixed(2)):0,Rt=Number((Number(o.subtotal||0)+Q+ue).toFixed(2)),me=zt({totalAmount:Rt,paidAmount:Number(s?.paidAmount)||null,paidPercent:Number(s?.paidPercent)||null}),Ft=Math.max(0,Number(me.paidAmount||0)),Mt=Math.max(0,Number((Rt-Ft).toFixed(2)));E+=Ft,I+=Mt,D+=1,Mt<=.5&&(N+=1)}),v.filter(s=>s?.projectId==null&&s?.project_id==null).forEach(s=>{const o=Number(s?.totalAmount)||wt(s)||0,g=zt({totalAmount:o,paidAmount:Number(s?.paidAmount)||null,paidPercent:Number(s?.paidPercent)||null,progressType:s?.paymentProgressType??null,progressValue:s?.paymentProgressValue??null,history:Array.isArray(s?.paymentHistory)?s.paymentHistory:[]}),bt=Math.max(0,Number(g.paidAmount||0)),Q=Math.max(0,Number((o-bt).toFixed(2)));E+=bt,I+=Q,D+=1,Q<=.5&&(N+=1)});const T=D>0?Math.round(N/D*100):0,b=[];if(n.forEach(s=>{const o=xt([s?.updatedAt,s?.updated_at,s?.end,s?.endDatetime,s?.end_datetime,s?.start,s?.startDatetime,s?.start_datetime,s?.createdAt,s?.created_at]);o&&b.push({date:o,type:"reservation"})}),l.forEach(s=>{const o=xt([s?.updatedAt,s?.updated_at,s?.end,s?.end_datetime,s?.start,s?.start_datetime,s?.createdAt,s?.created_at]);o&&b.push({date:o,type:"project"})}),!b.length){const s=xt([u?.updated_at,u?.updatedAt,u?.created_at,u?.createdAt]);s&&b.push({date:s,type:"customer"})}const S=b.reduce((s,o)=>s?o.date>s.date?o:s:o,null),Et=S?.date??null,q=S?.type??null,y=n.reduce((s,o)=>Array.isArray(o?.items)?s+o.items.length:s,0),A=new Set;n.forEach(s=>{Array.isArray(s?.technicians)&&s.technicians.forEach(o=>{const g=o!=null?String(o):"";g&&A.add(g)}),Array.isArray(s?.techniciansDetails)&&s.techniciansDetails.forEach(o=>{const g=o?.id??o?.technician_id??o?.technicianId;g!=null&&A.add(String(g))})}),O(),ot&&(ot.textContent=F(h)),ct&&(ct.textContent=h>0?d("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const L=At(E),H=At(I);if(lt&&(lt.innerHTML=ee(L,H)),dt){const s=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),o=I>0?d("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",H):d("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");dt.textContent=`${s} â€¢ ${o}`}if(ut&&(ut.textContent=F(i.length)),mt&&(mt.textContent=i.length>0&&c?d("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",Zt(c)):d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),G)if(q){const s=d(`customerDetails.stats.activityType.${q}`,tn[q]||q);G.textContent=s}else G.textContent="â€”";if(ft&&(ft.textContent=Et?d("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",Zt(Et)):d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),pt&&(pt.textContent=`${F(T)}%`),J)if(D>0){const s=T>=90?"excellent":T>=70?"good":T>=40?"average":"poor",o=s?d(`customerDetails.stats.complianceLabel.${s}`,ne[s]||ne.poor):"",g=d("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",F(N)).replace("{total}",F(D));J.textContent=o?`${o} â€¢ ${g}`:g}else J.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");O({projects:h,reservations:a,equipment:y,technicians:A.size})}function sn(t){const{customers:e}=Y();if(!Array.isArray(e))return null;const n=e.find(c=>String(c.id)===String(t));if(!n)return null;const a=n.tax_id??n.taxId??"",r=typeof a=="string"?a.trim():String(a||"").trim(),i=n.document??le(n);return{...n,tax_id:r,taxId:r,document:i}}function rn(t={}){if(!t||typeof t!="object")return null;const e=t.id??t.customerId??t.customer_id??null,n=t.full_name??t.customerName??t.name??"",a=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",r=typeof a=="string"?a.trim():String(a||"").trim(),i=le(t);return e==null?null:{id:String(e),customerName:n,full_name:n,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:r,taxId:r,document:i,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function on(t){if(!t)return;const e=Y(),n=Array.isArray(e.customers)?[...e.customers]:[],a=n.findIndex(r=>String(r.id)===String(t.id));a>=0?n[a]={...n[a],...t}:n.push(t),Tt({customers:n})}async function cn(){const{technicians:t}=Y();if(!(Array.isArray(t)&&t.length>0))try{const e=await st("/technicians/"),n=Array.isArray(e?.data)?e.data.map(Be):[];n.length>0&&Tt({technicians:n})}catch(e){console.warn("âš ï¸ Failed to load technicians list",e)}}async function ln(t){if(t)try{const e=new URLSearchParams({customer_id:String(t),limit:"200"}),n=await st(`/reservations/?${e.toString()}`);nt=Array.isArray(n?.data)?n.data.map(Ce):[]}catch(e){console.warn("âš ï¸ Failed to load customer reservations",e)}}async function dn(t){if(t)try{const e=new URLSearchParams({client_id:String(t),limit:"200"}),n=await st(`/projects/?${e.toString()}`);at=Array.isArray(n?.data)?n.data.map(Te):[]}catch(e){console.warn("âš ï¸ Failed to load customer projects",e)}}async function un(t,{showSpinner:e=!1}={}){if(t){nt=null,at=null,e?(X=!0,$="",w()):(X=!0,$="");try{const n=await st(`/customers/?id=${encodeURIComponent(t)}`),a=n?.data??n,r=rn(a);if(!r)throw new Error("Invalid customer payload received from server");u=r,on(r),X=!1,$="",w(),await cn();const[i,c]=await Promise.all([ln(r.id),dn(r.id)]);vt(r.id),rt(r.id);try{const f=Array.isArray(i)?i:nt||[],m=Array.isArray(c)?c:at||[],l=f.reduce((v,p)=>Array.isArray(p?.items)?v+p.items.length:v,0),h=new Set;f.forEach(v=>{Array.isArray(v?.technicians)&&v.technicians.forEach(p=>{p!=null&&h.add(String(p))}),Array.isArray(v?.techniciansDetails)&&v.techniciansDetails.forEach(p=>{const E=p?.id??p?.technician_id??p?.technicianId;E!=null&&h.add(String(E))})}),O({projects:m.length,reservations:f.length,equipment:l,technicians:h.size})}catch{}U()}catch(n){if(X=!1,n instanceof Ee&&n.status===404){u=null,$="",w();return}console.error("âš ï¸ Failed to load customer details",n);const a=d("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");u?($="",gt(a),w()):($=`${a}${n?.message?` (${n.message})`:""}`,w())}}}async function mn(){try{const t=await st("/summary/"),e=nn(t?.data??null);if(e){O(e);return}}catch{}try{await Promise.allSettled([Ne(),Le(),je(),_e({showToastOnError:!1})])}catch{}O()}function w(){if(!V)return;if(Nt(Pt),!u){if(jt(null),Bt(!0),U(),X){V.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if($){V.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${C($)}</div>
        </div>
      `;return}const n=d("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");V.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${C(n)}</div>
      </div>
    `;return}jt(u),Bt(!1);const e=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:u.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:u.phone?_(u.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:u.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:u.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:u.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:u.tax_id??u.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:u.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:u.document??null,type:"document"}].map(n=>{const a=d(n.key,n.fallback);if(n.type==="document"){const m=n.value;let l='<span class="text-base-content/50">â€”</span>';if(m&&typeof m=="object"){const h=m.fileName?.trim()||m.path?.trim()||m.url||"";if(m.url){const v=C(h||d("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),p=en(m.url),E=C(d("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));l=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${v}</span><a class="btn btn-outline btn-sm" href="${p}" target="_blank" rel="noopener noreferrer">${E}</a></div>`}else h&&(l=`<span class="text-base-content break-all">${C(h)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${n.key}">${C(a)}</span>
          <div class="mt-2">${l}</div>
        </article>
      `}const i=(n.value==null?"":String(n.value)).trim(),c=i.length>0?i:"â€”",f=n.multiline?We(c):C(c);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${n.key}">${C(a)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${f}</p>
      </article>
    `}).join("");V.innerHTML=e,U()}function fn(){document.getElementById("edit-id").value=u?.id||"",document.getElementById("edit-name").value=u?.customerName||"",document.getElementById("edit-phone").value=_(u?.phone||""),document.getElementById("edit-company").value=u?.companyName||"",document.getElementById("edit-email").value=u?.email||"",document.getElementById("edit-address").value=u?.address||"",document.getElementById("edit-tax-id").value=_(u?.tax_id??u?.taxId??"");const t=u?.document??null;tt&&(tt.value=t?.url||""),et&&(et.value=t?.fileName||""),Ke(t),document.getElementById("edit-notes").value=u?.notes||""}const ht=document.getElementById("save-edit-btn");ht&&!ht.dataset.listenerAttached&&(ht.addEventListener("click",()=>{if(!u)return;const t=document.getElementById("edit-id").value,e=document.getElementById("edit-name").value.trim(),n=_(document.getElementById("edit-phone").value.trim()),a=document.getElementById("edit-company").value.trim(),r=document.getElementById("edit-email").value.trim(),i=document.getElementById("edit-address").value.trim(),c=_(document.getElementById("edit-tax-id").value.trim()),f=(tt?.value||"").trim(),m=(et?.value||"").trim(),l=document.getElementById("edit-notes").value.trim();if(!e||!n){gt(d("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const h=Y(),v=Array.isArray(h.customers)?h.customers:[],p=v.findIndex(D=>String(D.id)===String(t));if(p===-1){gt(d("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const E=v[p]?.document??null;let I=E;B?.dataUrl?I={...E||{},url:B.dataUrl,fileName:m||B.fileName||E?.fileName||"",mimeType:B.mimeType||E?.mimeType,size:B.size??E?.size}:f?I={...E||{},url:f,fileName:m||E?.fileName||""}:m&&E?I={...E,fileName:m}:!f&&!m&&(I=E),v[p]={...v[p],customerName:e,phone:n,companyName:a,email:r,address:i,notes:l,tax_id:c,taxId:c,document:I},Tt({customers:v}),u=v[p],w(),vt(x),rt(x),U(),document.dispatchEvent(new CustomEvent("customers:changed")),gt(d("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),ht.dataset.listenerAttached="true");async function pn(){if(V){if(!x){jt(null),Bt(!0),U(),V.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${d("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}u=sn(x),u&&(w(),vt(x),rt(x),U()),await un(x,{showSpinner:!u})}}pn();const de=()=>{!x||!u||U()};document.addEventListener("reservations:changed",de);document.addEventListener("projects:changed",de);document.addEventListener("language:changed",()=>{w(),x&&u&&(vt(x),rt(x),U())});["projects:changed","reservations:changed","equipment:changed","technicians:changed"].forEach(t=>{document.addEventListener(t,()=>O(),{passive:!0})});Re();mn();
