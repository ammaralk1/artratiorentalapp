(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const be="/backend/api";class b extends Error{constructor(t,{status:n,payload:r}={}){super(t),this.name="ApiError",this.status=n??null,this.payload=r??null}}function ye(){const t=(typeof window<"u"?window.APP_API_BASE:null)||be;return String(t).replace(/\/$/,"")}async function R(e,{method:t="GET",headers:n={},body:r,signal:a,credentials:o="include"}={}){const i=e.startsWith("/")?e:`/${e}`,l=`${ye()}${i}`,u={Accept:"application/json",...n},s={method:t,headers:u,signal:a,credentials:o};r!==void 0&&(r instanceof FormData?(delete u["Content-Type"],s.body=r):typeof r=="string"?(u["Content-Type"]=u["Content-Type"]||"application/json",s.body=r):(u["Content-Type"]=u["Content-Type"]||"application/json",s.body=JSON.stringify(r)));const c=await fetch(l,s),C=c.headers.get("content-type")||"";let d=null;if(C.includes("application/json"))try{d=await c.json()}catch{throw new b("Failed to parse server response as JSON",{status:c.status})}else{const h=await c.text();d=h?{raw:h}:null}if(!c.ok){const h=d?.error||`Request failed with status ${c.status}`;throw new b(h,{status:c.status,payload:d})}if(d&&typeof d=="object"&&d.ok===!1){const h=d.error||"API returned an error response";throw new b(h,{status:c.status,payload:d})}return d}const m=Object.freeze({language:"ar",theme:"light",dashboardTab:null,dashboardSubTab:null,projectsTab:null,projectsSubTab:null});let g=null,k=null;const z=new Set,re="__ART_RATIO_SKIP_PREF_FETCH__",ae="__ART_RATIO_PREFERENCES__";function oe(){try{return typeof window>"u"?!1:!!window[re]}catch{return!1}}function Te(){try{typeof window<"u"&&delete window[re]}catch{}}function w(e={}){const t=e.language==="en"?"en":"ar",n=e.theme==="dark"?"dark":"light",r=typeof e.dashboardTab=="string"?x(e.dashboardTab):null,a=typeof e.dashboardSubTab=="string"?x(e.dashboardSubTab):null,o=typeof e.projectsTab=="string"?x(e.projectsTab):null,i=typeof e.projectsSubTab=="string"?x(e.projectsSubTab):null;return{language:t,theme:n,dashboardTab:r,dashboardSubTab:a,projectsTab:o,projectsSubTab:i}}function x(e){const t=String(e||"").trim();return t&&/^[a-z0-9\-]+$/i.test(t)?t:null}function Ae(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(ae);if(!e)return null;const t=JSON.parse(e);return w(t)}catch(e){return console.warn("⚠️ [preferencesService] Failed to read cached preferences",e),null}}function Ee(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.setItem(ae,JSON.stringify(e))}catch(t){console.warn("⚠️ [preferencesService] Failed to persist preferences",t)}}const J=Ae();J&&(g=J);function Se(){const e=f();z.forEach(t=>{try{t(e)}catch(n){console.error("⚠️ [preferencesService] listener failed",n)}})}function E(e){const n={...g?{...g}:{...m},...e};g=w(n),Ee(g),Se()}function f(){return g?{...g}:null}function se(e){if(typeof e!="function")return()=>{};if(z.add(e),g)try{e(f())}catch(t){console.error("⚠️ [preferencesService] listener failed",t)}return()=>{z.delete(e)}}function ie({refresh:e=!1}={}){return oe()?Promise.resolve({...m}):!e&&g?Promise.resolve(f()):(k||(k=R("/preferences/").then(t=>{const n=t?.data??m;return E(n),f()}).catch(t=>t instanceof b&&t.status===401?(g=null,m):(console.warn("⚠️ [preferencesService] Failed to load preferences",t),E(m),m)).finally(()=>{k=null})),k)}function we(e=null){if(!e){const t=f();return w(t||m)}return w(e)}async function G(e={}){if(oe())return{...m,...e};e.language!==void 0&&e.language,e.theme!==void 0&&e.theme,e.dashboardTab!==void 0&&e.dashboardTab,e.dashboardSubTab!==void 0&&e.dashboardSubTab,e.projectsTab!==void 0&&e.projectsTab,e.projectsSubTab!==void 0&&e.projectsSubTab;const t=we(),n={...t,...e},r=w(n),a={},o={};["language","theme","dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"].forEach(s=>{if(e[s]===void 0)return;const c=r[s],C=t[s];c!==C&&(a[s]=c,(s==="language"||s==="theme")&&(o[s]=c))});const l=Object.keys(a).length>0,u=Object.keys(o).length>0;if(!u&&!l)return f();if(!u&&l)return E(r),f();try{const s=await R("/preferences/",{method:"PATCH",body:o});return E(s?.data??m),l&&E({...f(),...a}),f()}catch(s){if(s instanceof b&&s.status===422)return console.warn("⚠️ [preferencesService] Server rejected preference update (no changes)."),E(r),f();throw s}}const _="ar",_e="ar",Le="language-loading",Y="language-ready",ce=["Placeholder","Title","AriaLabel","AriaDescription","Value"],P={ar:Object.create(null),en:Object.create(null)};let T=_,I=!1,q=null;function j(e){return e==="en"?"en":"ar"}function Ce(){if(!q){const e=f();if(e?.language){const t=j(e.language);v(t,{persist:!1,dispatch:!1})}q=ie().then(t=>{const n=j(t?.language??_);return v(n,{persist:!1}),I=!0,n}).catch(t=>(console.warn("⚠️ تعذر تحميل تفضيل اللغة من الخادم",t),v(_,{persist:!1}),I=!0,_))}return q}function ve(e){if(e.dataset.i18nCached==="true")return;e.dataset.i18nHtml==="true"?e.dataset.arHtml===void 0&&(e.dataset.arHtml=e.innerHTML):e.dataset.ar===void 0&&(e.dataset.ar=e.textContent),ce.forEach(n=>{const r=n.charAt(0).toLowerCase()+n.slice(1),a=e.getAttribute(r);a!=null&&e.dataset[`ar${n}`]===void 0&&(e.dataset[`ar${n}`]=a)}),e.dataset.i18nCached="true"}function W(e,t){if(!t)return;const n=P[e]??(P[e]=Object.create(null));Object.entries(t).forEach(([r,a])=>{typeof r=="string"&&(n[r]=a)})}function X(e,t){if(!t)return;const n=P[e];return n?n[t]:void 0}function Pe(e,t){ve(e);const n=e.dataset.i18nHtml==="true",r=e.dataset.i18nKey,a=X(t,r);a!==void 0?n?e.innerHTML=a:e.textContent=a:t==="en"?n?e.dataset.enHtml!==void 0&&(e.innerHTML=e.dataset.enHtml):e.dataset.en!==void 0&&(e.textContent=e.dataset.en):n?e.innerHTML=e.dataset.arHtml??e.innerHTML:e.textContent=e.dataset.ar??e.textContent,ce.forEach(o=>{const i=o.charAt(0).toLowerCase()+o.slice(1),l=e.dataset[`i18n${o}Key`],u=X(t,l);if(u!==void 0){e.setAttribute(i,u);return}const s=t==="en"?`en${o}`:`ar${o}`,c=e.dataset[s];c!==void 0&&e.setAttribute(i,c)})}function ue(e){document.querySelectorAll("[data-i18n]").forEach(n=>Pe(n,e))}function je(e){const t=document.documentElement,n=document.body,r=e===_e?"rtl":"ltr";t.setAttribute("lang",e),t.setAttribute("dir",r),n&&(n.setAttribute("dir",r),n.dataset.lang=e)}function De(){const e=document.documentElement;e&&(e.classList.contains(Y)||(e.classList.remove(Le),e.classList.add(Y)))}function le(e){document.querySelectorAll(".language-toggle-btn").forEach(t=>{const n=t.dataset.labelAr||"🇸🇦 العربية",r=t.dataset.labelEn||"🇬🇧 English";t.textContent=e==="en"?n:r,t.setAttribute("aria-pressed",e==="en"?"true":"false")})}function v(e,{persist:t=!1,dispatch:n=!0}={}){const r=j(e);T===r&&I&&!t||(T=r,I=!0,je(r),ue(r),le(r),De(),n&&document.dispatchEvent(new CustomEvent("language:changed",{detail:{language:r}})),t&&G({language:r}).catch(a=>{console.warn("⚠️ تعذر حفظ تفضيل اللغة في الخادم",a)}))}function Re(){ke(T==="ar"?"en":"ar")}function Ne(){document.querySelectorAll(".language-toggle-btn").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Re()}),t.dataset.listenerAttached="true")}),le(T)}function nt(e={}){W("ar",e.ar),W("en",e.en);const t=B();ue(t),document.dispatchEvent(new CustomEvent("language:translationsReady",{detail:{language:t}}))}function y(e,t=""){if(!e)return t;const n=T||_,r=P[n];if(r&&r[e]!==void 0)return r[e];const o=P[n==="en"?"ar":"en"];return o&&o[e]!==void 0?o[e]:t}function ke(e){const t=j(e);v(t,{persist:!0})}function B(){return T}function Q(){Ce().catch(()=>_),Ne()}se(e=>{e&&e.language&&j(e.language)!==T&&v(e.language,{persist:!1})});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Q,{once:!0}):Q();const S="dark-mode",O=new WeakSet,Z="theme-loading",de="art-ratio:session-theme";let ee=!1;function fe(){return Array.from(document.querySelectorAll("[data-theme-toggle], .theme-toggle-btn"))}function he(e){return e==="dark"?"dark":"light"}function xe(e){try{window.sessionStorage?.setItem(de,he(e))}catch{}}function Oe(){try{const e=window.sessionStorage?.getItem(de);return e==="dark"?"dark":e==="light"?"light":null}catch{return null}}function Ie(){document.documentElement.classList.remove(Z);const e=document.body;e&&e.classList.remove(Z)}function F(e,{persist:t=!0}={}){const n=he(e),r=document.documentElement,a=document.body;n==="dark"?(r.classList.add(S,"dark"),a&&a.classList.add(S,"dark")):(r.classList.remove(S,"dark"),a&&a.classList.remove(S,"dark")),r.setAttribute("data-theme",n==="dark"?"dark":"light"),xe(n),$(n);try{document.dispatchEvent(new CustomEvent("theme:changed",{detail:{theme:n}}))}catch(o){console.warn("⚠️ [theme.js] Failed to dispatch theme change event",o)}t&&G({theme:n}).catch(o=>{console.warn("⚠️ تعذر حفظ تفضيل السمة في الخادم",o)})}function N(){const e=document.body;return e&&e.classList.contains(S)||document.documentElement.classList.contains(S)?"dark":"light"}function U(){const e=N()==="dark"?"light":"dark";F(e,{persist:!0})}function Fe(e,t){if(!e)return;const n=t==="dark",r=y("theme.toggle.toLight","☀️ الوضع العادي"),a=y("theme.toggle.toDark","🌙 الوضع الليلي"),o=y("theme.toggle.ariaLight","الوضع العادي مفعل"),i=y("theme.toggle.ariaDark","الوضع الليلي مفعل"),l=y("theme.toggle.titleLight","التبديل إلى الوضع العادي"),u=y("theme.toggle.titleDark","التبديل إلى الوضع الليلي");if(e.matches("[data-theme-toggle]")){const s=e.matches("input")?e:e.querySelector('input[type="checkbox"]'),c=n?r:a,C=n?o:i,d=n?l:u;s&&(s.checked=n,s.setAttribute("aria-label",c),s.setAttribute("aria-checked",String(n))),e.setAttribute("title",d),e.setAttribute("aria-label",C),e.setAttribute("data-theme-state",n?"dark":"light");const h=e.querySelector("[data-theme-label]");h&&(h.textContent=c)}else e.textContent=n?r:a,e.setAttribute("aria-pressed",String(n)),e.setAttribute("title",n?l:u),e.setAttribute("aria-label",n?o:i)}function $(e){fe().forEach(t=>Fe(t,e)),Ie()}function qe(){const e=fe();$(N()),e.forEach(t=>{if(!(!t||O.has(t))){if(t.matches("[data-theme-toggle]")){const n=t.matches("input")?t:t.querySelector('input[type="checkbox"]'),r=()=>{U()};n&&!O.has(n)?(n.addEventListener("change",r),O.add(n)):n||t.addEventListener("click",a=>{a.preventDefault(),U()})}else t.getAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",n=>{n.preventDefault(),U()});O.add(t)}})}function rt({skipRemote:e=!1}={}){const t=f(),a=(t?.theme==="dark"?"dark":t?.theme==="light"?"light":null)||Oe()||Ue();F(a,{persist:!1}),Me({skipRemote:e})}function Ue(){try{if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return"dark"}catch{}return"light"}function Me({skipRemote:e=!1}={}){ee||(ee=!0,!e&&ie().then(t=>{const n=t?.theme==="dark"?"dark":t?.theme==="light"?"light":null;n&&F(n,{persist:!1})}).catch(t=>{console.warn("⚠️ تعذر تحميل تفضيل السمة من الخادم",t)}))}document.addEventListener("language:changed",()=>{$(N()),qe()});se(e=>{const t=e?.theme==="dark"?"dark":e?.theme==="light"?"light":null;t&&t!==N()&&F(t,{persist:!1})});function K(){const e=typeof window<"u"?window:globalThis;return e.__APP_DATA_STORE__||(e.__APP_DATA_STORE__={customers:[],reservations:[],equipment:[],technicians:[],maintenance:[],projects:[]}),e.__APP_DATA_STORE__}function A(e,t,n){n!=null&&(e[t]=Array.isArray(n)?[...n]:n)}function He(){const e=K();return{customers:[...e.customers],reservations:[...e.reservations],equipment:[...e.equipment],technicians:[...e.technicians],maintenance:[...e.maintenance],projects:[...e.projects]}}function at({customers:e,reservations:t,equipment:n,technicians:r,maintenance:a,projects:o}){const i=K();A(i,"customers",e),A(i,"reservations",t),A(i,"equipment",n),A(i,"technicians",r),A(i,"maintenance",a),A(i,"projects",o)}let M=!1;function ot(e=null){if(M)return;const t=e||(typeof window<"u"?window.__LEGACY_DATA__:null);if(!t||typeof t!="object"){M=!0;return}const n=K();if(["customers","reservations","equipment","technicians","maintenance","projects"].forEach(a=>{const o=t[a];Array.isArray(o)&&o.length>0&&(n[a]=[...o])}),M=!0,!e&&typeof window<"u")try{delete window.__LEGACY_DATA__}catch{}}function V(e,t=3e3){let n=document.getElementById("toast-container");n||(n=document.createElement("div"),n.id="toast-container",n.style.position="fixed",n.style.top="20px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.zIndex="9999",document.body.appendChild(n));const r=document.createElement("div");r.className="toast-message",r.textContent=e,r.style.background="#333",r.style.color="#fff",r.style.padding="10px 20px",r.style.marginTop="10px",r.style.borderRadius="6px",r.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",r.style.opacity="0",r.style.transition="opacity 0.3s ease",n.appendChild(r),setTimeout(()=>r.style.opacity="1",10),setTimeout(()=>{r.style.opacity="0",setTimeout(()=>r.remove(),300)},t)}const te="RSV",ne="PRJ",ze=4,L=(()=>{try{const e=typeof globalThis<"u"?globalThis:window;return e.__APP_SEQUENCE_STATE__=e.__APP_SEQUENCE_STATE__||{reservation:0,project:0},e.__APP_SEQUENCE_STATE__}catch{return{reservation:0,project:0}}})();function Be(){return Number.isFinite(L.reservation)?L.reservation:0}function Ge(e){L.reservation=Math.max(0,Number.parseInt(e,10)||0)}function $e(){return Number.isFinite(L.project)?L.project:0}function Ke(e){L.project=Math.max(0,Number.parseInt(e,10)||0)}function ge(){try{const e=He();return{reservations:Array.isArray(e?.reservations)?e.reservations:[],projects:Array.isArray(e?.projects)?e.projects:[]}}catch(e){return console.warn("⚠️ [utils] Failed to load data snapshot for code generation",e),{reservations:[],projects:[]}}}function Ve(e,t){if(e==null)return 0;if(typeof e=="number")return Number.isFinite(e)?Math.max(0,Math.trunc(e)):0;const n=String(e).trim();if(!n)return 0;const r=`${t.toUpperCase()}-`,a=n.toUpperCase();let o=n;a.startsWith(r)&&(o=n.slice(r.length));const i=o.match(/(\d+)$/);if(i){const u=Number.parseInt(i[1],10);return Number.isFinite(u)?Math.max(0,u):0}const l=Number.parseInt(n,10);return Number.isFinite(l)?Math.max(0,l):0}function Je(e){return Array.isArray(e)?e:[e]}function me(e,t,n){return!Array.isArray(e)||e.length===0?0:e.reduce((r,a)=>{const o=n(a),l=Je(o).reduce((u,s)=>{const c=Ve(s,t);return c>u?c:u},0);return l>r?l:r},0)}function pe(e,t){const n=Math.max(0,Number.parseInt(t,10)||0);return`${e}-${String(n).padStart(ze,"0")}`}function st(){const{reservations:e}=ge(),t=me(e,te,r=>[r?.reservationCode,r?.reservation_code,r?.reservationId,r?.reservation_id,r?.id]),n=Math.max(t,Be())+1;return Ge(n),pe(te,n)}function it(){const{projects:e}=ge(),t=me(e,ne,r=>[r?.projectCode,r?.project_code,r?.code,r?.id]),n=Math.max(t,$e())+1;return Ke(n),pe(ne,n)}function ct(e,t={}){if(!e)return"-";const n=new Date(e);if(Number.isNaN(n.getTime()))return"-";const r=document?.documentElement?.getAttribute("lang")||(typeof B=="function"?B():null)||"ar",o=String(r).toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory":"en-US",l=new Intl.DateTimeFormat(o,{dateStyle:"short",timeStyle:"short",hour12:!0,calendar:"gregory",...t}).formatToParts(n),u=n.getHours()>=12?"PM":"AM",s=l.map(c=>c.type==="dayPeriod"?u:c.value).join("").replace(/\u200f/g,"");return Ye(s)}function Ye(e){if(e==null)return"";e=String(e);const t=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"],n=["0","1","2","3","4","5","6","7","8","9"];return e.split("").map(r=>{const a=t.indexOf(r);return a>-1?n[a]:r}).join("")}const We="❌ بيانات الدخول غير صحيحة";let p=null;const Xe={USER_UPDATED:"auth:user-updated"};function Qe(e){if(typeof document>"u")return;const t=document.documentElement;t&&(e?t.dataset.userRole=e:delete t.dataset.userRole)}function Ze(){typeof document>"u"||document.dispatchEvent(new CustomEvent(Xe.USER_UPDATED,{detail:p?{...p}:null}))}function D(e){if(e&&typeof e=="object"){const t=typeof e.role=="string"?e.role.trim().toLowerCase():null;p={id:Number.isFinite(e.id)?Number(e.id):null,username:String(e.username||""),loginAt:e.loginAt??null,role:t}}else p=null;Qe(p?.role||""),Ze()}function H(e=We){V(e);const t=document.getElementById("login-error");t&&(t.innerText=e)}async function ut(e,t){const n=(e||"").trim(),r=t||"";if(!n||!r){H();return}try{const a=await R("/auth/",{method:"POST",body:{username:n,password:r}});D(a?.data??null);try{await G({theme:N()})}catch(o){console.warn("⚠️ تعذر حفظ تفضيل السمة بعد تسجيل الدخول",o)}Te(),window.location.href="home.html"}catch(a){console.error("❌ فشل تسجيل الدخول",a),D(null),a instanceof b&&a.message?H(a.message):H()}}async function lt(){try{await R("/auth/",{method:"DELETE"})}catch(e){console.warn("⚠️ فشل تسجيل الخروج من الخادم",e)}finally{D(null),V("🚪 تم تسجيل الخروج"),window.location.href="login.html"}}async function et({refresh:e=!1}={}){if(!e&&p)return p;try{const t=await R("/auth/");return D(t?.data??null),p}catch(t){throw t instanceof b&&t.status===401&&D(null),t}}function dt({redirect:e=!0}={}){return et({refresh:!0}).then(t=>(!t&&e&&(window.location.href="login.html"),t)).catch(t=>t instanceof b&&t.status===401?(e&&(window.location.href="login.html"),null):(console.error("❌ خطأ أثناء التحقق من الجلسة",t),e&&(window.location.href="login.html"),null))}function tt(){return p?.role||null}function ft(){return tt()==="admin"}function ht(){V(y("auth.permissions.denied","⚠️ ليس لديك صلاحية لتنفيذ هذا الإجراء"),"error")}export{b as A,rt as a,R as b,dt as c,B as d,He as e,ct as f,et as g,Xe as h,qe as i,V as j,ft as k,lt as l,ot as m,Ye as n,ht as o,ie as p,se as q,f as r,at as s,y as t,G as u,ut as v,nt as w,it as x,st as y};
