import{t as l,r as I,f as J,c as B,p as K,a as Q,b as C,d as W,e as Z}from"./calculations.Cuzjzmo7.js";import{e as tt}from"./reports.CHrSXW0w.js";import{s as et,c as ot,d as at,q as rt}from"./controller.CKj9uBP3.js";import{n as j}from"./auth.DEm-O4iH.js";import"./reservationsService.DHFcI6wO.js";import"./dashboard.DdUhm64b.js";/* empty css              */import"./dashboardShell.BJ8UOETr.js";import"./customers.DDv-F3VN.js";import"./maintenanceService.-sdg2Aq9.js";const N=96,D=25.4,q=210,_=297,R=Math.round(q/D*N),F=Math.round(_/D*N),k=N/D,nt=/safari/i,st=/(iphone|ipad|ipod)/i,it=/(crios|fxios|edgios|opios)/i;function pt(){try{const o=navigator.userAgent||"";return st.test(o)&&nt.test(o)&&!it.test(o)}catch{return!1}}function lt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function ct(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const a=document.createElement("style");a.textContent=String(rt).trim(),t.appendChild(a);const s=document.createElement("div");s.className="quote-preview-pages",s.setAttribute("data-quote-pages",""),t.appendChild(s);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تقليل الحافة العلوية قليلاً في حالة التصدير فقط لمطابقة المعاينة */
    #quotation-pdf-root[data-quote-render-context="export"] .quote-page { padding: 4mm 12mm 10mm; }
  `,t.appendChild(e),t}function z(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),a=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(a)?Math.max(90,Math.min(100,a))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function H({rightMm:o,topMm:t,scale:a}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((a||1)*1e3)/10))}catch{}}function dt(o){try{const t=z(),a=document.createElement("div");a.setAttribute("data-rpt-controls",""),Object.assign(a.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const s="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";a.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${s}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${s}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(a,e);const n=()=>{const i=Number(a.querySelector("[data-rpt-right]").value),m=Number(a.querySelector("[data-rpt-top]").value),y=Number(a.querySelector("[data-rpt-scale]").value),p=Math.max(.9,Math.min(1,y/100));H({rightMm:i,topMm:m,scale:p});const x=i*k,g=m*k;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${x}px, ${g}px) scale(${p})`})};a.querySelector("[data-rpt-apply]").addEventListener("click",n),a.querySelector("[data-rpt-reset]").addEventListener("click",()=>{a.querySelector("[data-rpt-right]").value=0,a.querySelector("[data-rpt-top]").value=0,a.querySelector("[data-rpt-scale]").value=100,H({rightMm:0,topMm:0,scale:1});const i=o.querySelector("[data-quote-pages]");Object.assign(i.style,{transform:"none"})});const c=t.rightMm*k,r=t.topMm*k;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${c}px, ${r}px) scale(${t.scale})`})}catch{}}function O({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function mt(o){const t=document.createElement("div");t.className="rpt-header";const a=document.createElement("h1");a.textContent=l("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const s=document.createElement("p");s.className="rpt-subtitle",s.textContent=`${Z(new Date)} • ${l("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(a),t.appendChild(s);const e=document.createElement("div");e.className="rpt-kpis";const n=(c,r)=>{const i=document.createElement("div");return i.className="rpt-kpi",i.innerHTML=`<div class="label">${c}</div><div class="value">${r}</div>`,i};return e.appendChild(n(l("reservations.reports.kpi.total.label","الحجوزات","Reservations"),W(o.total||0))),e.appendChild(n(l("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),C(o.revenue||0))),e.appendChild(n(l("reservations.reports.kpi.net.label","صافي الربح","Net profit"),C(o.netProfit||0))),e.appendChild(n(l("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),C(o.companyShareTotal||0))),e.appendChild(n(l("reservations.reports.kpi.tax.label","الضريبة","Tax"),C(o.taxTotal||0))),e.appendChild(n(l("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),C(o.maintenanceExpense||0))),t.appendChild(e),t}function ut(){try{const o=I?.data||{},t=I?.lastSnapshot?.filtered||o.reservations||[],a=new Map((o.customers||[]).map(r=>[String(r.id),r])),s=[...t].sort((r,i)=>new Date(i?.start||0)-new Date(r?.start||0)),e={code:l("reservations.reports.results.headers.id","الحجز","Reservation"),customer:l("reservations.reports.results.headers.customer","العميل","Customer"),date:l("reservations.reports.results.headers.date","التاريخ","Date"),status:l("reservations.reports.results.headers.status","الحالة","Status"),payment:l("reservations.reports.results.headers.payment","الدفع","Payment"),total:l("reservations.reports.results.headers.total","الإجمالي","Total"),share:l("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:l("reservations.reports.results.headers.net","صافي الربح","Net profit")},n=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],c=s.map(r=>{const i=r?.reservationId||r?.id||"—",m=j(String(i)),p=a.get(String(r?.customerId))?.customerName||l("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),x=J(r?.start),g=B(r),d=(()=>{switch(g.statusValue){case"completed":return String(l("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(l("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(l("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return j(String(g.statusValue||"—"))}})(),b=K(g.paidStatus),f=Q(r),u=C(f.finalTotal),v=f.companySharePercent>0?`${W(f.companySharePercent)}% (${C(f.companyShareAmount)})`:l("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),h=C(f.netProfit);return{[e.code]:m,[e.customer]:p,[e.date]:x,[e.status]:d,[e.payment]:b,[e.total]:u,[e.share]:v,[e.net]:h}});return{headers:n,rows:c}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function L(o){const t=document.createElement("table");t.className="rpt-table";const a=document.createElement("thead"),s=document.createElement("tr");o.forEach(n=>{const c=document.createElement("th");c.textContent=n,s.appendChild(c)}),a.appendChild(s);const e=document.createElement("tbody");return t.appendChild(a),t.appendChild(e),{table:t,tbody:e}}function ft(o,t,a,s){const e=o.querySelector("[data-quote-pages]"),n=O({primary:!0});e.appendChild(n);const c=mt(s);n.appendChild(c);let{table:r,tbody:i}=L(a);n.appendChild(r);const m=18,y=28,p=[];for(let d=0;d<t.length;d+=y)p.push(t.slice(d,d+y));if(p.length){const d=p[0];if(d.length>m){const b=d.splice(m);p.length>1?p[1]=b.concat(p[1]):p.push(b)}}const x=(d,b)=>{const f=document.createElement("tr");a.forEach(u=>{const v=document.createElement("td");v.textContent=b[u]!=null?String(b[u]):"",f.appendChild(v)}),d.appendChild(f)};(p.shift()||t).forEach(d=>x(i,d)),p.forEach(d=>{const b=O({primary:!1});e.appendChild(b);const f=L(a);b.appendChild(f.table),d.forEach(u=>x(f.tbody,u))})}function ht(o=[],{context:t="preview"}={}){const s=(I.lastSnapshot||{}).metrics||{};let e,n=o&&o.length?o:null;if(n)e=Object.keys(n[0]||{});else{const i=ut();e=i.headers,n=i.rows}const c=ct(t),r=document.createElement("div");r.style.position="fixed",r.style.left="-10000px",r.style.top="0",r.style.width=`${R}px`,r.style.zIndex="-1",document.body.appendChild(r),r.appendChild(c);try{et(c),ot(c),at(c)}catch{}return ft(c,n||[],e,s),c.parentElement?.removeChild(c),r.parentElement?.removeChild(r),t==="preview"&&dt(c),c}async function kt(o=[],{action:t="save"}={}){const a=ht(o,{context:"export"}),s=document.createElement("div");Object.assign(s.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),s.appendChild(a),document.body.appendChild(s);try{const n=pt()&&!lt()?window.open("","_blank"):null;if(n)try{n.document.open(),n.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${l("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${l("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${l("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),n.document.close()}catch{}await tt();const c=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,r=window.html2canvas;if(typeof c=="function"&&typeof r=="function"){const i=z(),m=new c({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),p={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},x=Array.from(a.querySelectorAll(".quote-page"));let g=0;const d=6,b=-10,f=.985;for(let u=0;u<x.length;u+=1){const v=x[u],h=v.ownerDocument||document,S=h.createElement("div");Object.assign(S.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const w=v.cloneNode(!0);w.style.width=`${R}px`,w.style.maxWidth=`${R}px`,w.style.minWidth=`${R}px`,w.style.height=`${F}px`,w.style.maxHeight=`${F}px`,w.style.minHeight=`${F}px`,w.style.position="relative",w.style.background="#ffffff",S.appendChild(w),h.body.appendChild(S);let E;try{E=await r(w,{...p,scrollX:0,scrollY:0})}finally{S.parentNode?.removeChild(S)}if(!E)continue;const X=E.width||1,U=(E.height||1)/X;let P=q,M=P*U,T=0;if(M>_){const $=_/M;M=_,P=P*$,T=Math.max(0,(q-P)/2)}const A=Math.max(.9,Math.min(1,i.scale||1));P*=A,M*=A,T=Math.max(0,(q-P)/2);const G=E.toDataURL("image/jpeg",.95);g>0&&m.addPage();const Y=Math.max(0,T+(i.rightMm||0)),V=i.topMm||0;m.addImage(G,"JPEG",Y,V,P,M,`page-${g+1}`,"FAST"),g+=1,await new Promise($=>requestAnimationFrame($))}if(g===0)throw new Error("PDF generation produced no pages");if(t==="print"){const u=m.output("bloburl");if(n)try{n.location.href=u}catch{}else await new Promise(v=>{const h=document.createElement("iframe");Object.assign(h.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),h.onload=()=>{try{h.contentWindow?.focus(),h.contentWindow?.print()}catch{}setTimeout(()=>{h.remove(),v()},700)},h.src=u,document.body.appendChild(h)})}else m.save("reservations-report.pdf")}else{const i=window.html2pdf().set({margin:10,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(a).toPdf();if(t==="print"){const m=await i.get("pdf").then(y=>y.output("bloburl"));await new Promise(y=>{const p=document.createElement("iframe");Object.assign(p.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),p.onload=()=>{try{p.contentWindow?.focus(),p.contentWindow?.print()}catch{}setTimeout(()=>{p.remove(),y()},700)},p.src=m,document.body.appendChild(p)})}else await i.save("reservations-report.pdf")}}finally{s.remove()}}export{ht as buildReportsPdfPages,kt as exportReportsPdf};
