import{r as je,n as I,l as J,t as d,s as _,e as Te,h as Ne,i as Pe,m as Le,j as Ce,a as Bt,b as Be,d as ft}from"./auth.UdF5b_hJ.js";import{i as _e}from"./dashboardShell.tMq52fMf.js";import{e as Ft,g as Re,c as we}from"./form.BGqbgmmi.js";import{f as ee,g as Qt,h as Fe,w as Me,i as $e,u as qe,j as He,k as Ue,m as Ve}from"./controller.Cno9hIsC.js";import{d as ze,g as Oe,o as Ut,q as We,D as Et,f as Mt,v as Ye,w as Ke}from"./reservationsService.CzhS3hVo.js";import{g as Ct,b as Qe,a as Je,c as Xe,d as ae,s as Ge,e as Ze,r as ta,f as ne,P as ea}from"./projectFocusTemplates.mEaidCbc.js";je({ar:{"customerDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.title":"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.hero.subtitle":"ğŸ‘‹ Ù‡Ø°Ù‡ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.fields.taxId":"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:","customerDetails.fields.document":"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.reservations":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.stats.upcoming":"Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.projects":"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerDetails.stats.projectsEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.stats.lastActivity":"Ø¢Ø®Ø± Ù†Ø´Ø§Ø·","customerDetails.stats.lastActivityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.reservationsDesc":"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ","customerDetails.stats.upcomingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.nextReservation":"Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}","customerDetails.stats.projectsDesc":"Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.payment":"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentBreakdown":"Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentPaid":"Ø§Ù„Ù…Ø¯ÙÙˆØ¹","customerDetails.stats.paymentOutstandingLabel":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.totalValue":"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: {amount}","customerDetails.stats.totalValueEmpty":"Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ù…Ø¨Ø§Ù„Øº Ø¨Ø¹Ø¯.","customerDetails.stats.paymentOutstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}","customerDetails.stats.paymentAllSet":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.paymentOutstandingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.activityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.activityOn":"Ø¨ØªØ§Ø±ÙŠØ® {date}","customerDetails.stats.activityType.reservation":"Ø­Ø¬Ø²","customerDetails.stats.activityType.project":"Ù…Ø´Ø±ÙˆØ¹","customerDetails.stats.activityType.customer":"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.complianceEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©","customerDetails.stats.complianceProjects":"Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}","customerDetails.stats.complianceLabel.excellent":"Ø§Ù„ØªØ²Ø§Ù… Ù…Ù…ØªØ§Ø²","customerDetails.stats.complianceLabel.good":"Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯","customerDetails.stats.complianceLabel.average":"ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©","customerDetails.stats.complianceLabel.poor":"ØªØ£Ø®ÙŠØ± Ù…ØªÙƒØ±Ø±","customerDetails.document.open":"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯","customerDetails.document.defaultName":"Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·","customerDetails.primaryNav.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.primaryNav.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerTabs.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.customerReservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerTabs.customerProjects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","customerDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²...","customerDetails.fields.name":"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:","customerDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","customerDetails.fields.company":"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:","customerDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","customerDetails.fields.address":"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:","customerDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","customerDetails.toast.missingRequired":"âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†","customerDetails.toast.notFound":"âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","customerDetails.toast.updateSuccess":"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...","customerDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.loadFailed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","customerDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"ğŸ‘¤ Client Profile","customerDetails.hero.subtitle":"ğŸ‘‹ Here is a quick look at this client","customerDetails.fields.taxId":"ğŸ§¾ Tax Number:","customerDetails.fields.document":"ğŸ“ Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"ğŸ“… Booking Management","customerDetails.primaryNav.projects":"ğŸ“ Project Management","customerTabs.reservations":"ğŸ“… Booking Management","customerTabs.projects":"ğŸ“ Project Management","customerTabs.customerReservations":"ğŸ“… Client Reservations","customerTabs.customerProjects":"ğŸ“ Client Projects","customerDetails.actions.back":"â¬…ï¸ Back","customerDetails.actions.edit":"âœï¸ Edit Client","customerDetails.filters.search":"ğŸ” Search by client or reservation ID...","customerDetails.fields.name":"ğŸ‘¤ Name:","customerDetails.fields.phone":"ğŸ“ Phone:","customerDetails.fields.company":"ğŸ¢ Company:","customerDetails.fields.email":"ğŸ“§ Email:","customerDetails.fields.address":"ğŸ“ Address:","customerDetails.fields.notes":"ğŸ“ Notes:","customerDetails.toast.missingRequired":"âš ï¸ Name and phone are required","customerDetails.toast.notFound":"âš ï¸ Client not found","customerDetails.toast.updateSuccess":"âœ… Client information updated","customerDetails.status.loading":"â³ Loading client information...","customerDetails.errors.notFound":"âš ï¸ This client could not be found.","customerDetails.errors.loadFailed":"âš ï¸ Failed to load client information.","customerDetails.errors.missingId":"âš ï¸ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"âœï¸ Edit Client","customerProjects.title":"ğŸ“ Client Projects","customerProjects.empty":"No projects are linked to this client."}});let $t={},j={initialized:!1,currentId:null,modal:{el:null,body:null}};function Vt(t=""){return I(String(t)).trim().toLowerCase()}function De(t,e,a){if(!e||!a)return;const{startDate:n,endDate:s}=Qt(t);e._flatpickr?n?e._flatpickr.setDate(n,!1,"Y-m-d"):e._flatpickr.clear():e.value=n||"",a._flatpickr?s?a._flatpickr.setDate(s,!1,"Y-m-d"):a._flatpickr.clear():a.value=s||""}function se(t,{endOfDay:e=!1}={}){if(!t)return null;const a=String(t).trim();if(!a)return null;const n=a.includes("T")?a:`${a}T00:00:00`,s=new Date(n);return Number.isNaN(s.getTime())?null:(e?s.setHours(23,59,59,999):s.setHours(0,0,0,0),s)}function qt(t){const e=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const a of e){if(!a)continue;const n=new Date(a);if(!Number.isNaN(n.getTime()))return n.setHours(0,0,0,0),n}return null}function _t(t){if(!document.getElementById("customer-reservations"))return;const a=document.getElementById("customer-search-reservation"),n=document.getElementById("customer-filter-start-date"),s=document.getElementById("customer-filter-end-date"),i=document.getElementById("customer-reservation-date-range"),o=document.getElementById("customer-reservation-status-filter"),h=document.getElementById("customer-clear-filters");window.flatpickr&&(n&&window.flatpickr(n,{dateFormat:"Y-m-d"}),s&&window.flatpickr(s,{dateFormat:"Y-m-d"}));const u=()=>{let l=I(n?.value||"").trim(),y=I(s?.value||"").trim(),m=i?.value||"";if(new Set(["","today","week","month"]).has(m)||(m="",i&&(i.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),l="",y=""),!l&&!y&&m){const{startDate:A,endDate:C}=Qt(m);l=A,y=C}return{searchTerm:Vt(a?.value||""),startDate:l,endDate:y,status:o?.value||"",quickRange:m,customerId:t}},p=()=>{$t=u(),ee("customer-reservations",$t)};a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{a.value=I(a.value),p()}),a.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{i&&(i.value=""),p()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{i&&(i.value=""),p()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{De(i.value,n,s),p()}),i.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",p),o.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("click",()=>{a&&(a.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i.value=""),o&&(o.value=""),p()}),h.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{ee("customer-reservations",$t)},p()}function yt(t){j.currentId=t;const{container:e}=ut();e&&(j.initialized||(aa(),na(),ra(),document.addEventListener("projects:changed",()=>{j.currentId&&w()}),document.addEventListener("language:changed",()=>{j.currentId&&w()}),document.addEventListener("technicians:updated",()=>{j.currentId&&w()}),j.initialized=!0),w())}function ut(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function aa(){const{searchInput:t,statusSelect:e,clearBtn:a,startInput:n,endInput:s,rangeSelect:i}=ut();window.flatpickr&&(n&&!n.dataset.datepickerAttached&&(window.flatpickr(n,{dateFormat:"Y-m-d"}),n.dataset.datepickerAttached="true"),s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=I(t.value),w()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{w()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{n.value=I(n.value),i&&(i.value=""),w()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=I(s.value),i&&(i.value=""),w()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{De(i.value,n,s),w()}),i.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{const{searchInput:o,statusSelect:h,startInput:u,endInput:p,rangeSelect:l}=ut();o&&(o.value=""),h&&(h.value=""),l&&(l.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),p&&(p._flatpickr&&p._flatpickr.clear(),p.value=""),w()}),a.dataset.listenerAttached="true")}function na(){const{container:t}=ut();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",sa),t.dataset.projectModalListenerAttached="true")}function sa(t){const e=t.target.closest(".project-focus-card");if(!e||t.target.closest("[data-ignore-project-modal]"))return;const n=e.dataset.projectId?String(e.dataset.projectId):"";n&&zt(n)}function ra(){Jt()}function Jt(){if(j.modal?.el&&j.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(j.modal={el:t,body:e},!0)}function w(){const{container:t,searchInput:e,statusSelect:a,startInput:n,endInput:s,rangeSelect:i}=ut();if(!t||!j.currentId)return;const o=Vt(e?.value||""),h=a?.value||"";let u=I(n?.value||"").trim(),p=I(s?.value||"").trim(),l=i?.value||"";if(new Set(["","today","week","month"]).has(l)||(l="",i&&(i.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),u="",p=""),!u&&!p&&l){const{startDate:g,endDate:S}=Qt(l);u=g,p=S}const m=se(u),E=se(p,{endOfDay:!0}),{projects:A=[],technicians:C=[],reservations:N=[],customers:b=[]}=J(),P=new Map(C.map(g=>[String(g.id),g])),T=ia(N),k=b.find(g=>String(g.id)===String(j.currentId))||null,v=A.filter(g=>String(g.clientId)===String(j.currentId)).filter(g=>{if(o){const S=[g.id,g.projectId,g.project_id,g.projectCode,g.project_code].map(r=>r==null?"":I(String(r)));if(!Vt([g.title,g.description,g.notes,...S].filter(Boolean).join(" ")).includes(o))return!1}if(h&&ze(g)!==h)return!1;if(m||E){const S=qt(g);if(!S||m&&S<m||E&&S>E)return!1}return!0}).sort((g,S)=>{const F=qt(g)?.getTime()||0;return(qt(S)?.getTime()||0)-F});if(!v.length){const g=d("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${g}</div></div>`;return}t.innerHTML=v.map(g=>{const S=Ct(g),F=S?T.get(S)||[]:[];return Qe(g,{customer:k,techniciansMap:P,reservations:F})}).join("")}function ia(t=[]){const e=new Map;return t.forEach(a=>{const n=a?.projectId??a?.project_id??a?.projectID;if(n==null)return;const s=String(n);e.has(s)||e.set(s,[]),e.get(s).push(a)}),e}function zt(t){const e=String(t||"").trim();if(!e||!Jt())return;const a=j.modal;if(!a?.body)return;a.body.dataset.mode="view";const{projects:n=[],reservations:s=[],customers:i=[]}=J(),o=ua(n,e);if(!o||j.currentId&&o.clientId!=null&&String(o.clientId)!==String(j.currentId))return;const h=i.find(l=>String(l.id)===String(o.clientId))||null,u=s.filter(l=>{const y=ma(l);return y&&y===e}),p=Je(o,{customer:h,reservations:u});a.body.innerHTML=p,oa(o),ca(a.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(a.el).show():(a.el.classList.add("show"),a.el.style.display="block")}function oa(t){if(!t||!j.modal?.body)return;const e=j.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",a=>{a.preventDefault(),la(t)})}function ca(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');if(!e.length)return;async function a(n){if(!Number.isInteger(n)||n<0)return!1;const s=Fe("showReservationDetails");if(typeof s=="function")return s(n),!0;try{const i=await Me("showReservationDetails");if(typeof i=="function")return i(n),!0}catch(i){console.warn("âš ï¸ [customerDetails] Unable to resolve reservation UI handler",i)}return!1}e.forEach(n=>{n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation();const i=Oe();let o=Number.parseInt(n.dataset.index||"",10);if(!Number.isInteger(o)||o<0){const u=n.dataset.reservationId;u&&(o=i.findIndex(l=>[l?.id,l?.reservationId,l?.reservation_id].some(m=>m!=null&&String(m)===u)))}await a(o)||_(d("projects.details.reservations.viewUnavailable","ØªØ¹Ø°Ø± ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"))}),n.dataset.listenerAttached="true")})}function la(t){if(!t||!Jt())return;const e=j.modal;if(!e?.body)return;const{customers:a=[]}=J(),n=a.find(o=>String(o.id)===String(t.clientId))||null,s=n?.customerName||t.clientName||t.customerName||"",i=t.clientCompany||n?.companyName||n?.company||"";e.body.dataset.mode="edit",e.body.innerHTML=Xe(t,{clientName:s,clientCompany:i}),da(t,{clientName:s,clientCompany:i})}function da(t,{clientName:e="",clientCompany:a=""}={}){if(!t||!j.modal?.body)return;const n=j.modal.body,s=n.querySelector("#customer-project-edit-form")||n.querySelector("#project-details-edit-form");if(!s)return;const i=s.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",x=>{x.preventDefault();const v=Ct(t);v&&zt(v)});const o=s.querySelector("#project-edit-expense-label"),h=s.querySelector("#project-edit-expense-amount"),u=s.querySelector('[data-action="add-expense"]'),p=s.querySelector("#project-edit-expense-list");s.querySelector('[name="project-start-date"]'),s.querySelector('[name="project-start-time"]'),s.querySelector('[name="project-end-date"]'),s.querySelector('[name="project-end-time"]');const l=s.querySelector("#project-edit-payment-status"),y=s.querySelector("#project-edit-tax"),m=s.querySelector("#project-edit-company-share"),E=s.querySelector("#project-edit-discount-type"),A=s.querySelector("#project-edit-discount"),C=s.querySelector("#project-edit-payment-progress-type"),N=s.querySelector("#project-edit-payment-progress-value"),b={expenses:Array.isArray(t?.expenses)?t.expenses.map(x=>({...x})):[]};let P=!1;const T=x=>{!y||!m||P||(P=!0,x==="share"?m.checked?(y.checked||(y.checked=!0),Ft(m,Et)):y.checked&&(y.checked=!1):x==="tax"&&(y.checked?Ft(m,Et):m.checked&&(m.checked=!1)),P=!1)},k=()=>{p&&(p.innerHTML=Ze(b.expenses))};k(),u&&!u.dataset.listenerAttached&&(u.addEventListener("click",x=>{x.preventDefault();const v=o?.value.trim()||"",g=I(h?.value||"0"),S=Number(g);if(!v){_(d("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),o?.focus();return}if(!Number.isFinite(S)||S<=0){_(d("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),h?.focus();return}b.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:v,amount:S}),o&&(o.value=""),h&&(h.value=""),k()}),u.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("click",x=>{const v=x.target.closest('[data-action="remove-expense"]');if(!v)return;const{id:g}=v.dataset;b.expenses=b.expenses.filter(S=>String(S.id)!==String(g)),k()}),p.dataset.listenerAttached="true"),A&&!A.dataset.listenerAttached&&(A.addEventListener("input",x=>{const v=x.target;v instanceof HTMLInputElement&&(v.value=I(v.value||""))}),A.dataset.listenerAttached="true"),N&&!N.dataset.listenerAttached&&(N.addEventListener("input",x=>{const v=x.target;v instanceof HTMLInputElement&&(v.value=I(v.value||""))}),N.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{l.dataset.userSelected="true"}),l.dataset.listenerAttached="true"),m&&!m.dataset.listenerAttached&&(m.addEventListener("change",()=>T("share")),m.dataset.listenerAttached="true"),y&&!y.dataset.listenerAttached&&(y.addEventListener("change",()=>T("tax")),y.dataset.listenerAttached="true"),m?.checked&&Ft(m,Et),T(m?.checked?"share":"tax"),s.addEventListener("submit",async x=>{if(x.preventDefault(),s.dataset.submitting==="true")return;const v=new FormData(s),g=(v.get("project-title")||"").toString().trim(),S=(v.get("project-type")||"").toString().trim(),F=(v.get("project-start-date")||"").toString().trim(),r=(v.get("project-start-time")||"").toString().trim(),c=(v.get("project-end-date")||"").toString().trim(),D=(v.get("project-end-time")||"").toString().trim(),nt=(v.get("project-description")||"").toString().trim(),V=(v.get("project-payment-status")||"unpaid").toString().toLowerCase(),gt=["paid","partial"].includes(V)?V:"unpaid",z=y?.checked===!0;if(!g||!S||!F){_(d("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"));return}const ht=ae(F,r),Z=c?ae(c,D):"";if(Z){const M=new Date(ht),q=new Date(Z);if(!Number.isNaN(M.getTime())&&!Number.isNaN(q.getTime())&&M>q){_(d("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"));return}}const X=Ct(t);if(!X){_(d("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const vt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,Dt=b.expenses.reduce((M,q)=>M+(Number(q.amount)||0),0),Zt=E?.value==="amount"?"amount":"percent",Se=I(A?.value||"0");let st=Number.parseFloat(Se);(!Number.isFinite(st)||st<0)&&(st=0);const rt=m?.checked===!0;let it=rt?Re(m):null;(!Number.isFinite(it)||it<=0)&&(it=rt&&z?Et:null);const ot=we({equipmentEstimate:vt,expensesTotal:Dt,discountValue:st,discountType:Zt,applyTax:z,companyShareEnabled:rt,companySharePercent:it}),Ae=C?.value==="amount"?"amount":"percent",te=I(N?.value||""),xe=te?Number.parseFloat(te):null,tt=Ut({totalAmount:ot.totalWithTax,progressType:Ae,progressValue:xe,history:[]}),Rt=l?.dataset?.userSelected==="true",Ie=We({manualStatus:Rt?gt:null,paidAmount:tt.paidAmount,paidPercent:tt.paidPercent,totalAmount:ot.totalWithTax}),wt=Rt?gt:Ie;!Rt&&l&&(l.value=wt),l?.dataset&&delete l.dataset.userSelected;const ke=$e({projectCode:t.projectCode,title:g,type:S,clientId:t.clientId,clientCompany:a,description:nt,start:ht,end:Z||null,applyTax:z,paymentStatus:wt,equipmentEstimate:vt,expenses:b.expenses,discount:st,discountType:Zt,companyShareEnabled:rt&&z,companySharePercent:rt&&z?it:null,companyShareAmount:ot.companyShareAmount,taxAmount:ot.taxAmount,totalWithTax:ot.totalWithTax,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[],paidAmount:tt.paidAmount,paidPercentage:tt.paidPercent,paymentProgressType:tt.paymentProgressType,paymentProgressValue:tt.paymentProgressValue}),R=s.querySelector('button[type="submit"]');R&&(R.disabled=!0,R.dataset.originalText=R.textContent||"",R.textContent=d("projects.details.edit.saving","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...")),s.dataset.submitting="true";try{const M=await qe(X,ke);await Ge(X,wt),document.dispatchEvent(new CustomEvent("projects:changed")),_(d("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),w();const q=Ct(M)||X;q&&zt(q)}catch(M){console.error("âŒ [customerDetails] Failed to update project from customer modal",M);const q=typeof M?.message=="string"?M.message:d("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");_(q,"error")}finally{delete s.dataset.submitting,R&&(R.disabled=!1,R.dataset.originalText&&(R.textContent=R.dataset.originalText,delete R.dataset.originalText))}})}function ua(t=[],e){const a=String(e);return t.find(n=>[n?.id,n?.projectId,n?.project_id].some(i=>i!=null&&String(i)===a))||null}function ma(t){if(!t)return null;const e=t.projectId??t.project_id??t.projectID??null;return e!=null?String(e):null}Te();Ne();Pe();_e();Le();const bt=document.getElementById("logout-btn");bt&&!bt.dataset.listenerAttached&&(bt.addEventListener("click",()=>Ce()),bt.dataset.listenerAttached="true");He({showReservationDetails:Ue});const pa=new URLSearchParams(window.location.search),L=pa.get("id"),G=document.getElementById("customer-details"),re=document.getElementById("customer-hero-name"),fa=document.getElementById("customer-hero-phone"),ya=document.getElementById("customer-hero-company"),ga=document.getElementById("customer-hero-email"),ha=document.getElementById("customer-hero-tax"),ie=document.getElementById("customer-hero-summary"),oe=document.getElementById("dashboard-greeting-customer-name"),ce=document.getElementById("dashboard-greeting-customer-company"),St=document.getElementById("customer-stat-projects"),At=document.getElementById("customer-stat-projects-desc"),xt=document.getElementById("customer-stat-payment"),It=document.getElementById("customer-stat-payment-desc"),kt=document.getElementById("customer-stat-upcoming"),jt=document.getElementById("customer-stat-upcoming-desc"),ct=document.getElementById("customer-stat-activity"),Tt=document.getElementById("customer-stat-activity-desc"),Nt=document.getElementById("customer-stat-compliance"),lt=document.getElementById("customer-stat-compliance-desc"),le=document.getElementById("sidebar-stat-projects"),de=document.getElementById("sidebar-stat-reservations"),ue=document.getElementById("sidebar-stat-equipment"),me=document.getElementById("sidebar-stat-technicians"),Xt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),Ot=Array.from(document.querySelectorAll("[data-customer-tab]")),va=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),K=document.getElementById("edit-document-file"),at=document.getElementById("edit-document-preview"),pe=document.getElementById("edit-document-file-name"),mt=document.getElementById("edit-document-url"),pt=document.getElementById("edit-document-name");let B=null,H="idle",O=null;Xt.forEach(t=>{t.disabled=!0});let f=null,dt=!1,W="",Gt="reservations";function $(t=""){const e=document.createElement("div");return e.textContent=t==null?"":String(t),e.innerHTML}function Da(t=""){const e=$(t).replace(/\r/g,""),a=`
`;return e.includes(a)?e.split(a).join("<br>"):e}function Ea(t=null){O=t&&typeof t=="object"?{...t}:null,B=null,H="idle",K&&(K.value=""),et()}function et(){if(!pe||!at)return;const t=H==="uploading",e=!!B?.dataUrl;let a=d("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?a=d("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):H==="error"?a=d("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):e?a=B?.fileName||d("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):O&&(O.fileName||O.url)&&(a=O.fileName||O.url),pe.textContent=a;const n=e||!!O?.url;at.disabled=t||!n}function ba(){if(!K)return;const[t]=K.files||[];if(!t){H="idle",B=null,et();return}H="uploading",et();const e=new FileReader;e.onload=()=>{if(typeof e.result!="string"){H="error",B=null,et();return}B={dataUrl:e.result,fileName:t.name,mimeType:t.type,size:t.size},mt&&(mt.value=e.result),pt&&(pt.value=t.name),H="success",et()},e.onerror=()=>{H="error",B=null,et()},e.readAsDataURL(t)}K&&!K.dataset.listenerAttached&&(K.addEventListener("change",ba),K.dataset.listenerAttached="true");at&&!at.dataset.listenerAttached&&(at.addEventListener("click",()=>{if(H==="uploading")return;const t=B?.dataUrl||O?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),at.dataset.listenerAttached="true");function Pt(t,e,a,{hideWhenEmpty:n=!1}={}){if(!t)return;const s=a==null?"":String(a).trim(),i=s.length>0,o=i?s:"â€”";t.textContent=`${e} ${o}`,n?t.classList.toggle("hidden",!i):t.classList.remove("hidden")}function Wt(t){const e=d("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),a=t?.customerName||"â€”",n=t?.phone?I(t.phone):"",s=t?.companyName||"",i=t?.email||"",o=t?.tax_id??t?.taxId??"";if(re&&(re.textContent=a),ie&&(ie.textContent=a!=="â€”"?a:e),Pt(fa,"ğŸ“",n,{hideWhenEmpty:!1}),Pt(ya,"ğŸ¢",s,{hideWhenEmpty:!0}),Pt(ga,"ğŸ“§",i,{hideWhenEmpty:!0}),Pt(ha,"ğŸ§¾",o,{hideWhenEmpty:!0}),oe&&(oe.textContent=a),ce){const h=[];s&&h.push(s),n&&h.push(`ğŸ“ ${n}`);const u=typeof o=="string"?o.trim():String(o||"").trim();u&&h.push(`ğŸ§¾ ${u}`),ce.textContent=h.length?h.join(" â€¢ "):"â€”"}}function Sa(t){if(t?.preventDefault?.(),!f)return;Ra();const e=document.getElementById("editCustomerModal"),a=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!a)return;(a.getInstance(e)||new a(e)).show()}function Aa(){Xt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Sa),t.dataset.listenerAttached="true")})}function Yt(t){Xt.forEach(e=>{e&&(e.disabled=!!t)})}Aa();function Kt(t){t&&(Gt=t,Ot.forEach(e=>{const a=e?.getAttribute("data-customer-tab")===t;e&&(e.classList.toggle("tab-active",a),e.classList.toggle("active",a),e.setAttribute("aria-selected",String(a)))}),va.forEach((e,a)=>{e&&e.classList.toggle("hidden",a!==t)}),t==="projects"&&L&&f&&yt(L))}function xa(){Ot.length&&(Ot.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-customer-tab");e&&Kt(e)}),t.dataset.listenerAttached="true")}),Kt(Gt))}xa();function Ee(t={}){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(T=>T&&typeof T=="object"),a=T=>{for(const k of T)if(typeof k=="string"&&k.trim()!=="")return k.trim();return""},n=T=>{for(const k of T){if(typeof k=="number"&&Number.isFinite(k))return Math.max(0,Math.trunc(k));if(typeof k=="string"&&k.trim()!==""&&/^\d+$/.test(k.trim()))return Math.max(0,parseInt(k.trim(),10))}return null},s=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],i=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],o=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],h=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],u=[t.document_size,t.documentSize,t.size,e?.size,e?.length],p=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],l=a(s),y=a(o),m=a(h)||"application/octet-stream",E=a(i),A=a(p),C=n(u);if(!l&&!A)return null;let N=l,b=A;if(!N&&b&&b.startsWith("data:")){const T=b.indexOf(",");T!==-1&&(N=b,b=b.slice(T+1))}!N&&b&&(N=`${b.startsWith("data:")?"":`data:${m};base64,`}${b}`);const P={url:N,fileName:y,mimeType:m,path:E,data:b||null,size:C};return P.url&&/sirv\.com/i.test(P.url)&&(P.source="sirv"),P}function Ia(){return document.documentElement.getAttribute("lang")||"ar"}function U(t){const e=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(e)}catch{return String(e)}}function fe(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=Ia()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(n,{dateStyle:"medium"}).format(e)}catch{const i=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),h=e.getFullYear();return`${i}/${o}/${h}`}}function ye(t){if(!t)return"";const e=t.trim().split(/\s+/),a=e.pop()||"";return`<span class="currency-amount">${e.join(" ")}</span> <span class="currency-unit currency-unit--sm">${a}</span>`}function ge(t,e){const a=d("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),n=d("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${a}</span>
      ${ye(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${n}</span>
      ${ye(e)}
    </div>
  `}const he={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},ka={reservation:"Reservation",project:"Project",customer:"Client record"};function Ht(t=[]){let e=null;return t.forEach(a=>{if(!a)return;const n=a instanceof Date?a:new Date(a);Number.isNaN(n.getTime())||(!e||n>e)&&(e=n)}),e}function ja(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function ve({projects:t=0,reservations:e=0,equipment:a=0,technicians:n=0}={}){le&&(le.textContent=U(t)),de&&(de.textContent=U(e)),ue&&(ue.textContent=U(a)),me&&(me.textContent=U(n))}function Q(){if(!f||!L){const r=Mt(0);if(St&&(St.textContent="0"),At&&(At.textContent=d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),xt&&(xt.innerHTML=ge(r,r)),It){const c=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),D=d("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");It.textContent=`${c} â€¢ ${D}`}kt&&(kt.textContent="0"),jt&&(jt.textContent=d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),ct&&(ct.textContent="â€”"),Tt&&(Tt.textContent=d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Nt&&(Nt.textContent="0%"),lt&&(lt.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),ve({projects:0,reservations:0,equipment:0,technicians:0});return}const t=J(),a=(Array.isArray(t.reservations)?t.reservations:[]).filter(r=>r?[r.customerId,r.customer_id,r.customer?.id].some(D=>D!=null&&String(D)===String(L)):!1),n=a.length,s=Date.now(),i=a.filter(r=>{const c=r?.start??r?.startDatetime??r?.start_datetime??r?.start_date;if(!c)return!1;const D=new Date(c);return Number.isNaN(D.getTime())?!1:D.getTime()>=s}),o=i.map(r=>r?.start??r?.startDatetime??r?.start_datetime).map(r=>new Date(r)).filter(r=>!Number.isNaN(r.getTime())).sort((r,c)=>r-c)[0]||null,u=(Array.isArray(t.projects)?t.projects:[]).filter(r=>r?[r.clientId,r.client_id,r.customer_id].some(D=>D!=null&&String(D)===String(L)):!1),p=u.length,l=a.filter(r=>{const c=String(r?.status||r?.reservationStatus||"").toLowerCase();return!(c==="cancelled"||c==="canceled"||c==="Ù…Ù„ØºÙŠ"||c==="Ù…Ù„ØºÙ‰"||c==="Ù…Ù„ØºÙŠØ©")}),y=new Map;l.forEach(r=>{const c=r?.projectId??r?.project_id??null;if(c==null)return;const D=String(c);y.has(D)||y.set(D,[]),y.get(D).push(r)});let m=0,E=0,A=0,C=0;u.forEach(r=>{const c=ta(r)||{},D=r?.id??r?.projectId??r?.project_id??null,V=(D!=null?y.get(String(D))||[]:[]).reduce((vt,Dt)=>vt+(Number(Dt?.totalAmount)||ne(Dt)||0),0),gt=c.applyTax?Number(((Number(c.subtotal||0)+V)*ea).toFixed(2)):0,z=Number((Number(c.subtotal||0)+V+gt).toFixed(2)),ht=Ut({totalAmount:z,paidAmount:Number(r?.paidAmount)||null,paidPercent:Number(r?.paidPercent)||null}),Z=Math.max(0,Number(ht.paidAmount||0)),X=Math.max(0,Number((z-Z).toFixed(2)));m+=Z,E+=X,C+=1,X<=.5&&(A+=1)}),l.filter(r=>r?.projectId==null&&r?.project_id==null).forEach(r=>{const c=Number(r?.totalAmount)||ne(r)||0,D=Ut({totalAmount:c,paidAmount:Number(r?.paidAmount)||null,paidPercent:Number(r?.paidPercent)||null,progressType:r?.paymentProgressType??null,progressValue:r?.paymentProgressValue??null,history:Array.isArray(r?.paymentHistory)?r.paymentHistory:[]}),nt=Math.max(0,Number(D.paidAmount||0)),V=Math.max(0,Number((c-nt).toFixed(2)));m+=nt,E+=V,C+=1,V<=.5&&(A+=1)});const b=C>0?Math.round(A/C*100):0,P=[];if(a.forEach(r=>{const c=Ht([r?.updatedAt,r?.updated_at,r?.end,r?.endDatetime,r?.end_datetime,r?.start,r?.startDatetime,r?.start_datetime,r?.createdAt,r?.created_at]);c&&P.push({date:c,type:"reservation"})}),u.forEach(r=>{const c=Ht([r?.updatedAt,r?.updated_at,r?.end,r?.end_datetime,r?.start,r?.start_datetime,r?.createdAt,r?.created_at]);c&&P.push({date:c,type:"project"})}),!P.length){const r=Ht([f?.updated_at,f?.updatedAt,f?.created_at,f?.createdAt]);r&&P.push({date:r,type:"customer"})}const T=P.reduce((r,c)=>r?c.date>r.date?c:r:c,null),k=T?.date??null,x=T?.type??null,v=a.reduce((r,c)=>Array.isArray(c?.items)?r+c.items.length:r,0),g=new Set;a.forEach(r=>{Array.isArray(r?.technicians)&&r.technicians.forEach(c=>{const D=c!=null?String(c):"";D&&g.add(D)}),Array.isArray(r?.techniciansDetails)&&r.techniciansDetails.forEach(c=>{const D=c?.id??c?.technician_id??c?.technicianId;D!=null&&g.add(String(D))})}),St&&(St.textContent=U(p)),At&&(At.textContent=p>0?d("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):d("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const S=Mt(m),F=Mt(E);if(xt&&(xt.innerHTML=ge(S,F)),It){const r=d("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),c=E>0?d("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",F):d("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");It.textContent=`${r} â€¢ ${c}`}if(kt&&(kt.textContent=U(i.length)),jt&&(jt.textContent=i.length>0&&o?d("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",fe(o)):d("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),ct)if(x){const r=d(`customerDetails.stats.activityType.${x}`,ka[x]||x);ct.textContent=r}else ct.textContent="â€”";if(Tt&&(Tt.textContent=k?d("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",fe(k)):d("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Nt&&(Nt.textContent=`${U(b)}%`),lt)if(C>0){const r=b>=90?"excellent":b>=70?"good":b>=40?"average":"poor",c=r?d(`customerDetails.stats.complianceLabel.${r}`,he[r]||he.poor):"",D=d("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",U(A)).replace("{total}",U(C));lt.textContent=c?`${c} â€¢ ${D}`:D}else lt.textContent=d("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");ve({projects:p,reservations:n,equipment:v,technicians:g.size})}function Ta(t){const{customers:e}=J();if(!Array.isArray(e))return null;const a=e.find(o=>String(o.id)===String(t));if(!a)return null;const n=a.tax_id??a.taxId??"",s=typeof n=="string"?n.trim():String(n||"").trim(),i=a.document??Ee(a);return{...a,tax_id:s,taxId:s,document:i}}function Na(t={}){if(!t||typeof t!="object")return null;const e=t.id??t.customerId??t.customer_id??null,a=t.full_name??t.customerName??t.name??"",n=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",s=typeof n=="string"?n.trim():String(n||"").trim(),i=Ee(t);return e==null?null:{id:String(e),customerName:a,full_name:a,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:s,taxId:s,document:i,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Pa(t){if(!t)return;const e=J(),a=Array.isArray(e.customers)?[...e.customers]:[],n=a.findIndex(s=>String(s.id)===String(t.id));n>=0?a[n]={...a[n],...t}:a.push(t),ft({customers:a})}async function La(){const{technicians:t}=J();if(!(Array.isArray(t)&&t.length>0))try{const e=await Bt("/technicians/"),a=Array.isArray(e?.data)?e.data.map(Ye):[];a.length>0&&ft({technicians:a})}catch(e){console.warn("âš ï¸ Failed to load technicians list",e)}}async function Ca(t){if(t)try{const e=new URLSearchParams({customer_id:String(t),limit:"200"}),a=await Bt(`/reservations/?${e.toString()}`),n=Array.isArray(a?.data)?a.data.map(Ke):[];ft({reservations:n})}catch(e){console.warn("âš ï¸ Failed to load customer reservations",e)}}async function Ba(t){if(t)try{const e=new URLSearchParams({client_id:String(t),limit:"200"}),a=await Bt(`/projects/?${e.toString()}`),n=Array.isArray(a?.data)?a.data.map(Ve):[];ft({projects:n})}catch(e){console.warn("âš ï¸ Failed to load customer projects",e)}}async function _a(t,{showSpinner:e=!1}={}){if(t){e?(dt=!0,W="",Y()):(dt=!0,W="");try{const a=await Bt(`/customers/?id=${encodeURIComponent(t)}`),n=a?.data??a,s=Na(n);if(!s)throw new Error("Invalid customer payload received from server");f=s,Pa(s),dt=!1,W="",Y(),await La(),await Promise.all([Ca(s.id),Ba(s.id)]),_t(s.id),yt(s.id),Q()}catch(a){if(dt=!1,a instanceof Be&&a.status===404){f=null,W="",Y();return}console.error("âš ï¸ Failed to load customer details",a);const n=d("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");f?(W="",_(n),Y()):(W=`${n}${a?.message?` (${a.message})`:""}`,Y())}}}function Y(){if(!G)return;if(Kt(Gt),!f){if(Wt(null),Yt(!0),Q(),dt){G.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(W){G.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${$(W)}</div>
        </div>
      `;return}const a=d("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");G.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${$(a)}</div>
      </div>
    `;return}Wt(f),Yt(!1);const e=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:f.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:f.phone?I(f.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:f.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:f.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:f.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:f.tax_id??f.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:f.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:f.document??null,type:"document"}].map(a=>{const n=d(a.key,a.fallback);if(a.type==="document"){const u=a.value;let p='<span class="text-base-content/50">â€”</span>';if(u&&typeof u=="object"){const l=u.fileName?.trim()||u.path?.trim()||u.url||"";if(u.url){const y=$(l||d("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),m=ja(u.url),E=$(d("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));p=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${y}</span><a class="btn btn-outline btn-sm" href="${m}" target="_blank" rel="noopener noreferrer">${E}</a></div>`}else l&&(p=`<span class="text-base-content break-all">${$(l)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${$(n)}</span>
          <div class="mt-2">${p}</div>
        </article>
      `}const i=(a.value==null?"":String(a.value)).trim(),o=i.length>0?i:"â€”",h=a.multiline?Da(o):$(o);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${$(n)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${h}</p>
      </article>
    `}).join("");G.innerHTML=e,Q()}function Ra(){document.getElementById("edit-id").value=f?.id||"",document.getElementById("edit-name").value=f?.customerName||"",document.getElementById("edit-phone").value=I(f?.phone||""),document.getElementById("edit-company").value=f?.companyName||"",document.getElementById("edit-email").value=f?.email||"",document.getElementById("edit-address").value=f?.address||"",document.getElementById("edit-tax-id").value=I(f?.tax_id??f?.taxId??"");const t=f?.document??null;mt&&(mt.value=t?.url||""),pt&&(pt.value=t?.fileName||""),Ea(t),document.getElementById("edit-notes").value=f?.notes||""}const Lt=document.getElementById("save-edit-btn");Lt&&!Lt.dataset.listenerAttached&&(Lt.addEventListener("click",()=>{if(!f)return;const t=document.getElementById("edit-id").value,e=document.getElementById("edit-name").value.trim(),a=I(document.getElementById("edit-phone").value.trim()),n=document.getElementById("edit-company").value.trim(),s=document.getElementById("edit-email").value.trim(),i=document.getElementById("edit-address").value.trim(),o=I(document.getElementById("edit-tax-id").value.trim()),h=(mt?.value||"").trim(),u=(pt?.value||"").trim(),p=document.getElementById("edit-notes").value.trim();if(!e||!a){_(d("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const l=J(),y=Array.isArray(l.customers)?l.customers:[],m=y.findIndex(N=>String(N.id)===String(t));if(m===-1){_(d("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const E=y[m]?.document??null;let A=E;B?.dataUrl?A={...E||{},url:B.dataUrl,fileName:u||B.fileName||E?.fileName||"",mimeType:B.mimeType||E?.mimeType,size:B.size??E?.size}:h?A={...E||{},url:h,fileName:u||E?.fileName||""}:u&&E?A={...E,fileName:u}:!h&&!u&&(A=E),y[m]={...y[m],customerName:e,phone:a,companyName:n,email:s,address:i,notes:p,tax_id:o,taxId:o,document:A},ft({customers:y}),f=y[m],Y(),_t(L),yt(L),Q(),document.dispatchEvent(new CustomEvent("customers:changed")),_(d("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),Lt.dataset.listenerAttached="true");async function wa(){if(G){if(!L){Wt(null),Yt(!0),Q(),G.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${d("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}f=Ta(L),f&&(Y(),_t(L),yt(L),Q()),await _a(L,{showSpinner:!f})}}wa();const be=()=>{!L||!f||Q()};document.addEventListener("reservations:changed",be);document.addEventListener("projects:changed",be);document.addEventListener("language:changed",()=>{Y(),L&&f&&(_t(L),yt(L),Q())});
