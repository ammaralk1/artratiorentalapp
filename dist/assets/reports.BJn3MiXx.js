import{t as we,n as k,g as Y,l as xe,a as P,b as De}from"./auth.CqiyQgTP.js";import{w as Se,n as re,o as Ce,v as ke,r as Te,i as Ae,x as Ee,y as Le,z as J}from"./reservationsService.BnVKG4Ze.js";import{mapMaintenanceFromApi as se}from"./maintenanceService.Dj0CyoRy.js";import{C as Pe,D as Re,E as Me,F as Ne}from"./controller.CyXIruvw.js";const n={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function Ie(e){n.callbacks.onRender=typeof e=="function"?e:null}function Fe(e){n.callbacks.onBeforeRender=typeof e=="function"?e:null}function $e(e){n.callbacks.onAfterRender=typeof e=="function"?e:null}function Be(e){n.callbacks.onTrendDrilldown=typeof e=="function"?e:null}function je(e){n.callbacks.onStatusDrilldown=typeof e=="function"?e:null}function _e(e){n.callbacks.onPaymentDrilldown=typeof e=="function"?e:null}function d(e,t,a=t){const c=Y()==="en"?a??t:t;return we(e,c)}function V(){n.formatters.cachedLocale=null,n.formatters.numberFormatter=null}function K(){return(Y()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function oe(){const e=Y();if(e!==n.formatters.cachedLocale||!n.formatters.numberFormatter||!n.formatters.currencyFormatter){n.formatters.cachedLocale=e;const t=K();n.formatters.numberFormatter=new Intl.NumberFormat(t,{maximumFractionDigits:0}),n.formatters.currencyFormatter=new Intl.NumberFormat(t,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:n.formatters.numberFormatter,currencyFormatter:n.formatters.currencyFormatter}}function w(e){const{numberFormatter:t}=oe(),a=t.format(Math.round(e||0));return k(a)}function D(e){const{currencyFormatter:t}=oe(),a=Number.isFinite(Number(e))?Number(e):0,r=t.format(a);return`${k(r)} SR`}function H(e){const t=e instanceof Date?e:new Date(e);if(!(t instanceof Date)||Number.isNaN(t.getTime()))return"";const a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0");return`${a}-${r}-${c}`}function He(e){if(!e)return"â€”";const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"â€”";const a=new Intl.DateTimeFormat(K(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return k(a.format(t))}function qe(e){return new Intl.DateTimeFormat(K(),{month:"short"}).format(e)}function ce(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ie(e={}){const t=String(e?.barcode??"").trim(),a=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:a,description:a,name:e?.name??a,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function le(e={}){const t=e?.title??e?.name??"",a=e?.project_code??e?.projectCode??"",r=e?.status??"",c=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:a,status:r,confirmed:c}}function ze(){let e;try{e=xe()}catch(u){return console.warn("âš ï¸ [reports] Failed to access cached data",u),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:a=[],equipment:r=[],technicians:c=[],projects:s=[],maintenance:o=[]}=e;return t.length||a.length||r.length||c.length||s.length?(n.data.reservations=Array.isArray(t)?t.map(Se):[],n.data.customers=Array.isArray(a)?a.map(ce):[],n.data.equipment=Array.isArray(r)?r.map(ie):[],n.data.technicians=Array.isArray(c)?c.map(re):[],n.data.projects=Array.isArray(s)?s.map(le):[],n.data.projectsMap=new Map(n.data.projects.map(u=>[u.id,u])),n.data.maintenance=Array.isArray(o)?o.map(se):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(u=>[String(u.id),u])),!0):!1}async function ue({silent:e=!1}={}){if(!n.loading){n.loading=!0,n.errorMessage="",e||n.callbacks.onBeforeRender?.();try{const[t,a,r,c,s,o]=await Promise.all([P("/reservations/?limit=500"),P("/customers/?limit=500"),P("/equipment/?limit=500"),P("/technicians/?limit=500"),P("/projects/?limit=500"),P("/maintenance/?limit=500")]);n.data.reservations=Array.isArray(t?.data)?t.data.map(i=>Ce(i)):[],n.data.customers=Array.isArray(a?.data)?a.data.map(ce):[],n.data.equipment=Array.isArray(r?.data)?r.data.map(ie):[],n.data.technicians=Array.isArray(c?.data)?c.data.map(re):[],n.data.projects=Array.isArray(s?.data)?s.data.map(le):[],n.data.projectsMap=new Map(n.data.projects.map(i=>[i.id,i])),n.data.maintenance=Array.isArray(o?.data)?o.data.map(se):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(i=>[String(i.id),i]))}catch(t){console.error("âŒ [reports] Failed to load reports data",t),n.errorMessage=t instanceof De?t.message:d("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!n.data.projectsMap||!(n.data.projectsMap instanceof Map))&&(n.data.projectsMap=new Map)}finally{n.loading=!1,e||n.callbacks.onAfterRender?.()}}}const Ye=new Map([["confirmed","confirmed"],["Ù…Ø¤ÙƒØ¯","confirmed"],["Ù…Ø¤ÙƒØ¯Ø©","confirmed"],["approved","confirmed"],["pending","pending"],["Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","pending"],["ØºÙŠØ± Ù…Ø¤ÙƒØ¯","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["Ù…Ù†ØªÙ‡ÙŠ","completed"],["Ù…Ù†ØªÙ‡ÙŠØ©","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["Ù…Ù„ØºÙŠ","cancelled"]]),ee=new Map([["paid",!0],["Ù…Ø¯ÙÙˆØ¹",!0],["Ù…Ø¯ÙÙˆØ¹Ø©",!0],["ØªÙ… Ø§Ù„Ø¯ÙØ¹",!0],["completed",!0],["unpaid",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",!1],["pending",!1],["Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",!1]]),Oe=1440*60*1e3;function de(e){return k(String(e||"")).toLowerCase().trim()}function q(e){return(e||"").toString().trim()}function Ve(e,t){if(!e||!t)return 1;const a=new Date(e),r=new Date(t);if(Number.isNaN(a.getTime())||Number.isNaN(r.getTime()))return 1;const c=r.getTime()-a.getTime();return c<=0?1:Math.max(1,Math.ceil(c/Oe))}function F(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;Ve(e.start,e.end);const t=Number(e.discount??e.discountValue??0)||0,a=e.discountType||e.discount_type||"percent",r=String(a).toLowerCase()==="amount"?"amount":"percent",c=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1",s=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,o=s!=null?Ee(s):Number.NaN,u=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null)===!0&&Number.isFinite(o)&&o>0?o:null,p=Array.isArray(e.crewAssignments)?e.crewAssignments:[],f=p.length?p.map(v=>v?.technicianId).filter(Boolean):Array.isArray(e.technicians)?e.technicians:[],l=Le({items:Array.isArray(e.items)?e.items:[],technicianIds:f,crewAssignments:p,discount:t,discountType:r,applyTax:c,start:e.start,end:e.end,companySharePercent:u}),h=Number(e.cost);let m=l.finalTotal,y=l.taxAmount;if(Number.isFinite(h)&&h>0&&(m=J(h),c)){const v=m-l.taxableAmount;Number.isFinite(v)&&v>=0&&(y=J(v))}const b={rentalDays:l.rentalDays,equipmentTotal:l.equipmentTotal,crewTotal:l.crewTotal,crewCostTotal:l.crewCostTotal,discountAmount:l.discountAmount,subtotalAfterDiscount:l.subtotalAfterDiscount,taxableAmount:l.taxableAmount,taxAmount:y,finalTotal:m,companySharePercent:l.companySharePercent,companyShareAmount:l.companyShareAmount,netProfit:l.netProfit,companyShareEnabled:l.companySharePercent>0};return e.__financials=b,b}function pe(e){return e?.projectId&&n.data.projectsMap.get(String(e.projectId))||null}function te(e=""){const t=String(e).toLowerCase().trim();return t?Ye.get(t)||t:""}function Ue(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const a of t){const r=String(a||"").toLowerCase().trim();if(r&&ee.has(r))return ee.get(r)}return e?.paid===!0||e?.paid==="true"}function N(e){const t=pe(e),a=Te(e,t),r=te(a.projectStatus);let c=te(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");a.projectLinked&&r&&(c=r),(!c||c==="cancelled")&&(c=a.effectiveConfirmed?"confirmed":"pending"),(Ae(e)||r==="completed")&&(c="completed");const s=a.effectiveConfirmed||c==="confirmed"||c==="completed";s&&c!=="completed"&&(c="confirmed");const o=Ue(e),i=e?.paidStatus??e?.paid_status??(o?"paid":"unpaid");return{statusValue:c,confirmed:s,paid:o,paidStatus:i}}function Xe(e){const t=e.length;let a=0,r=0,c=0,s=0,o=0,i=0,u=0,p=0,f=0;e.forEach(h=>{const{statusValue:m,confirmed:y,paid:b}=N(h);m==="completed"&&(r+=1),y&&(a+=1),b&&(c+=1);const v=F(h);s+=v.finalTotal,o+=v.companyShareAmount,i+=v.taxAmount,u+=v.crewTotal,p+=v.crewCostTotal??0,f+=v.netProfit});const l=t?s/t:0;return{total:t,confirmed:a,completed:r,paidCount:c,revenue:s,average:l,companyShareTotal:o,taxTotal:i,crewTotal:u,crewCostTotal:p,netProfit:f}}function me({range:e,start:t,end:a}){const r=new Date;if(r.setHours(23,59,59,999),e==="custom"){const o=t?new Date(`${t}T00:00:00`):null,i=a?new Date(`${a}T23:59:59`):null;return{startDate:ne(o)?o:null,endDate:ne(i)?i:null}}let c=new Date(r),s=null;switch(e){case"last30":{s=new Date(r),s.setDate(s.getDate()-29);break}case"thisWeek":{const o=new Date(r),u=(o.getDay()-6+7)%7;o.setDate(o.getDate()-u),o.setHours(0,0,0,0);const p=new Date(o);p.setDate(o.getDate()+6),p.setHours(23,59,59,999),s=o,c=p;break}case"thisMonth":{s=new Date(r.getFullYear(),r.getMonth(),1),c=new Date(r.getFullYear(),r.getMonth()+1,0),c.setHours(23,59,59,999);break}case"thisQuarter":{const o=Math.floor(r.getMonth()/3);s=new Date(r.getFullYear(),o*3,1),c=new Date(r.getFullYear(),(o+1)*3,0),c.setHours(23,59,59,999);break}case"thisYear":{s=new Date(r.getFullYear(),0,1),c=new Date(r.getFullYear(),12,0),c.setHours(23,59,59,999);break}case"all":default:s=null,c=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:c}}function ne(e){return e instanceof Date&&!Number.isNaN(e.getTime())}function We(e,t){const{startDate:a,endDate:r}=me(t);let c=0;const s=[];return(e||[]).forEach(o=>{if(!o)return;const i=typeof o.repairCost=="number"?o.repairCost:Number.parseFloat(k(String(o.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const u=String(o.statusRaw??o.status??"").toLowerCase();if(!(u==="closed"||u==="completed"||u==="cancelled"))return;const f=o.resolvedAt??o.resolved_at??null,l=o.reportedAt??o.reported_at??null,h=o.createdAt??o.created_at??null,m=f?new Date(f):null,y=l?new Date(l):h?new Date(h):null,b=m&&!Number.isNaN(m.getTime())?m:y&&!Number.isNaN(y.getTime())?y:null;if(b&&(a&&b<a||r&&b>r))return;const v=Math.round(i*100)/100;c+=v,s.push({id:o.id,cost:v,date:b})}),{total:c,items:s}}function Ke(e,t){const a=Number.isFinite(t)?t:0;return{...e,maintenanceExpense:a,netProfit:(e.netProfit||0)-a}}function Ge(e){const t=new Date,a=[];for(let r=5;r>=0;r-=1){const c=new Date(t.getFullYear(),t.getMonth()-r,1),s=c.getFullYear(),o=c.getMonth(),i=e.filter(b=>{const v=b?.start?new Date(b.start):null;return v&&v.getFullYear()===s&&v.getMonth()===o}),u=i.length;let p=0,f=0,l=0;i.forEach(b=>{const v=F(b);p+=v.finalTotal,f+=v.netProfit,l+=v.companyShareAmount});const h=qe(c),m=new Date(c.getFullYear(),c.getMonth(),1),y=new Date(c.getFullYear(),c.getMonth()+1,0);a.push({label:h,count:u,revenue:p,netProfit:f,companyShare:l,periodStart:m,periodEnd:y,startInput:H(m),endInput:H(y)})}return a}function Qe(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(o=>{const{statusValue:i,confirmed:u}=N(o);i==="completed"?t.completed+=1:i==="confirmed"||u?t.confirmed+=1:t.pending+=1});const a=Math.max(1,(e||[]).length),r=t.confirmed,c=t.pending,s=t.completed;return[{label:d("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-confirmed",filterKey:"confirmed"},{label:d("reservations.reports.status.pendingLabel","Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","Pending confirmation"),value:c,percent:Math.round(c/a*100)||0,rawCount:c,className:"status-pending",filterKey:"pending"},{label:d("reservations.reports.status.completedLabel","Ù…Ù†ØªÙ‡ÙŠØ©","Completed"),value:s,percent:Math.round(s/a*100)||0,rawCount:s,className:"status-completed",filterKey:"completed"}]}function Ze(e){const t=e.length||1,a=e.filter(c=>N(c).paid).length,r=e.length-a;return[{label:d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-paid",filterKey:"paid"},{label:d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid"),value:r,percent:Math.round(r/t*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}]}function Je(e,t){const a=new Map,r=new Map((t||[]).map(c=>[String(c.id),c]));return e.forEach(c=>{const s=String(c?.customerId??"unknown"),o=a.get(s)||{count:0,revenue:0},i=F(c);o.count+=1,o.revenue+=i.finalTotal,a.set(s,o)}),Array.from(a.entries()).map(([c,s])=>({name:r.get(c)?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),count:s.count,revenue:s.revenue})).sort((c,s)=>s.revenue-c.revenue).slice(0,5)}function et(e,t){const a=new Map,r=new Map((t||[]).map(s=>[q(s?.barcode),s])),c=d("reservations.reports.topEquipment.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…","Unnamed equipment");return e.forEach(s=>{(s?.items||[]).forEach(o=>{const i=q(o?.barcode),u=i?r.get(i):null,p=o?.desc||o?.description||o?.name||u?.desc||u?.description||u?.name||"",f=p&&p.trim()?p:c,l=ke(f)||"unknown",h=Number(o?.qty)||1,m=Number(o?.price)||0,y=h*m,b=a.get(l)||{name:f,count:0,revenue:0};b.name=f,b.count+=h,b.revenue+=y,a.set(l,b)})}),Array.from(a.values()).sort((s,o)=>o.count!==s.count?o.count-s.count:o.revenue-s.revenue).slice(0,5)}function tt(e,t,a,r,c){const s=[],o=e?.reservationId||e?.id;o&&s.push(o),e?.notes&&s.push(e.notes);const{statusValue:i,paidStatus:u}=N(e);i&&s.push(i);const p=e?.paymentStatus||e?.payment_status;p&&s.push(p),e?.paid!=null&&s.push(e.paid?"paid":"unpaid"),u&&s.push(u);const f=a.get(String(e?.customerId));f&&s.push(f.customerName,f.company_name||f.companyName,f.contact_person||"");const l=pe(e);return l&&s.push(l.title,l.code,l.status),s.push(fe(u)),(e?.items||[]).forEach(m=>{m?.desc&&s.push(m.desc),m?.barcode&&s.push(m.barcode);const y=r.get(q(m?.barcode));y&&s.push(y.desc,y.description,y.name)}),(e?.technicians||[]).forEach(m=>{const y=c.get(String(m));y&&s.push(y.name,y.role,y.department)}),de(s.filter(Boolean).join(" ")).includes(t)}function nt(e,t,a,r,c){const{startDate:s,endDate:o}=me(t),i=de(t.search),u=!!i,p=new Map((a||[]).map(h=>[String(h.id),h])),f=new Map((r||[]).map(h=>[q(h?.barcode),h])),l=new Map((c||[]).map(h=>[String(h.id),h]));return(e||[]).filter(h=>{const m=h?.start?new Date(h.start):null;if(!m||Number.isNaN(m.getTime())||s&&m<s||o&&m>o)return!1;const{statusValue:y,confirmed:b,paid:v}=N(h);if(t.status==="confirmed"&&!(y==="confirmed"||y==="completed"||b)||t.status==="pending"&&y!=="pending"||t.status==="completed"&&y!=="completed"||t.payment==="paid"&&!v||t.payment==="unpaid"&&v)return!1;if(t.share&&t.share!=="all"){const E=F(h).companySharePercent>0;if(t.share==="with"&&!E||t.share==="without"&&E)return!1}return!(u&&!tt(h,i,p,f,l))})}function fe(e){const t=String(e??"").toLowerCase();return t==="paid"?d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"):t==="partial"?d("reservations.reports.payment.partialLabel","Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹","Partially paid"):d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid")}function G(e){if(n.loadedScripts.has(e))return n.loadedScripts.get(e);const t=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,a=new Promise((r,c)=>{const s=()=>{t&&(t.dataset.loaded="true"),r()},o=u=>c(u);if(t){if(t.dataset.loaded==="true"){r();return}t.addEventListener("load",s,{once:!0}),t.addEventListener("error",o,{once:!0});return}const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>{i.dataset.loaded="true",r()},i.onerror=u=>c(u),document.head.appendChild(i)});return n.loadedScripts.set(e,a),a}function Q(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(n.apexChartsReady||(n.apexChartsReady=G("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),n.apexChartsReady)}function at(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(n.html2PdfReady||(n.html2PdfReady=G("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),n.html2PdfReady)}function rt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(n.xlsxReady||(n.xlsxReady=G("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),n.xlsxReady)}function z(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function A(e,t){const a=document.getElementById(e);if(a){if(!t||t.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}a.innerHTML=t.map(r=>{const c=Math.min(Math.max(r.percent??0,0),100),s=d("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",w(r.rawCount??r.value??0)),o=r.className?`reports-progress-fill ${r.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${r.label}</span>
            <span class="reports-progress-value">${w(r.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${o}" style="width: ${c}%;"></div>
          </div>
          <div class="reports-progress-meta">${s}</div>
        </div>
      `}).join("")}}async function st(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const a=Array.isArray(e)?e:[];if(n.lastTrendData=a,!a.length){n.charts.trend&&(n.charts.trend.destroy(),n.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const r=await Q();if(!r){t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const c=a.map(m=>m.label),s=a.map(m=>Math.round(m.count||0)),o=a.map(m=>Number(m.revenue||0)),i=a.map(m=>Number(m.netProfit||0)),u=s.reduce((m,y)=>m+(Number.isFinite(y)?y:0),0),p=o.reduce((m,y)=>m+(Number.isFinite(y)?y:0),0),f=i.reduce((m,y)=>m+(Number.isFinite(y)?y:0),0);if(u===0&&p===0&&f===0){n.charts.trend&&(n.charts.trend.destroy(),n.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const l=[{name:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:s},{name:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:o},{name:d("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:i,yAxisIndex:1}],h={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(m,y,b)=>{if(b?.dataPointIndex!=null){const v=n.lastTrendData[b.dataPointIndex];n.callbacks.onTrendDrilldown?.(v,b.dataPointIndex)}}}},theme:{mode:z()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:c,labels:{style:{colors:z()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:m=>w(m)},title:{text:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:m=>D(m)},title:{text:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(m,{seriesIndex:y})=>y===0?w(m):D(m)}}};n.charts.trend?(n.charts.trend.updateOptions({...h},!0,!0),n.charts.trend.updateSeries(l,!0)):(t.innerHTML="",n.charts.trend=new r(t,{...h,series:l}),n.charts.trend.render())}catch(r){console.error("âš ï¸ [reports] Failed to render trend chart",r),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ot(e){const t=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!t)return;const r=Array.isArray(e)?e:[];n.lastStatusData=r;const c=r.map(o=>Math.max(0,o.value||0)),s=c.reduce((o,i)=>o+i,0);if(!r.length||s===0){n.charts.status&&(n.charts.status.destroy(),n.charts.status=null),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await Q();if(!o){A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const i=r.map(p=>p.label),u={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,f,l)=>{if(l?.dataPointIndex!=null){const h=n.lastStatusData[l.dataPointIndex];h?.filterKey&&n.callbacks.onStatusDrilldown?.(h,l.dataPointIndex)}}}},theme:{mode:z()},labels:i,series:c,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:d("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>w(c.reduce((p,f)=>p+f,0))}}}}},tooltip:{y:{formatter:(p,f)=>{const l=n.lastStatusData?.[f?.seriesIndex||0],h=l?`${w(l.percent)}%`:`${w(p)}%`;return`${w(l?l.rawCount??l.value??0:p)} / ${h}`}}}};n.charts.status?(n.charts.status.updateOptions({...u},!0,!0),n.charts.status.updateSeries(c,!0)):(t.innerHTML="",n.charts.status=new o(t,{...u,series:c}),n.charts.status.render()),A(a,r)}catch(o){console.error("âš ï¸ [reports] Failed to render status chart",o),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ct(e){const t=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!t)return;const r=Array.isArray(e)?e:[];n.lastPaymentData=r;const c=r.map(o=>Math.max(0,o.value||0)),s=c.reduce((o,i)=>o+i,0);if(!r.length||s===0){n.charts.payment&&(n.charts.payment.destroy(),n.charts.payment=null),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await Q();if(!o){A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const i=r.map(p=>p.label),u={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,f,l)=>{if(l?.dataPointIndex!=null){const h=n.lastPaymentData[l.dataPointIndex];h?.filterKey&&n.callbacks.onPaymentDrilldown?.(h,l.dataPointIndex)}}}},theme:{mode:z()},labels:i,series:c,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},tooltip:{y:{formatter:(p,f)=>{const l=n.lastPaymentData?.[f?.seriesIndex||0],h=l?`${w(l.percent)}%`:`${w(p)}%`;return`${w(l?l.rawCount??l.value??0:p)} / ${h}`}}}};n.charts.payment?(n.charts.payment.updateOptions({...u},!0,!0),n.charts.payment.updateSeries(c,!0)):(t.innerHTML="",n.charts.payment=new o(t,{...u,series:c}),n.charts.payment.render()),A(a,r)}catch(o){console.error("âš ï¸ [reports] Failed to render payment chart",o),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}function it(e){const t=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),r=document.getElementById("reports-kpi-revenue"),c=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-revenue-breakdown"),o=document.getElementById("reports-kpi-confirmed"),i=document.getElementById("reports-kpi-confirmed-meta"),u=document.getElementById("reports-kpi-paid"),p=document.getElementById("reports-kpi-paid-meta"),f=e.total||0,l=e.revenue||0,h=e.confirmed||0,m=e.paidCount||0,y=e.average||0,b=e.companyShareTotal||0,v=e.taxTotal||0,I=e.crewTotal||0,E=e.crewCostTotal||0,$=e.netProfit||0,B=e.maintenanceExpense||0,ye=f?Math.round(h/f*100):0,ge=f?Math.round(m/f*100):0;if(t&&(t.textContent=w(f)),a){const S=d("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",w(e.completed||0));a.textContent=S}if(r&&(r.textContent=D(l)),c)if(f===0)c.textContent=d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const S=d("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");c.textContent=S.replace("{net}",D($)).replace("{share}",D(b)).replace("{average}",D(y))}if(s)if(l>0){const S=[{label:d("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:D(l)},{label:d("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:D(b)},{label:d("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:D(v)},{label:d("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:D(I)},{label:d("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:D(E)}];B>0&&S.push({label:d("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${D(B)}`}),S.push({label:d("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:D($)}),s.innerHTML=S.map(({label:be,value:ve})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${be}</span>
            <span class="reports-kpi-detail-value">${ve}</span>
          </div>
        `).join(""),s.classList.remove("hidden")}else s.innerHTML="",s.classList.add("hidden");if(o&&(o.textContent=`${ye}%`),i){const S=d("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",w(h));i.textContent=S}if(u&&(u.textContent=`${ge}%`),p){const S=d("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",w(m));p.textContent=S}}function C(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function O(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function lt(e,t,a){const r=document.getElementById("reports-reservations-body");if(!r)return[];if(!e||e.length===0)return r.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const c=new Map((t||[]).map(i=>[String(i.id),i]));new Map((a||[]).map(i=>[String(i.id),i]));const s={code:d("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:d("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:d("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:d("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:d("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:d("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:d("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:d("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},o=[...e].sort((i,u)=>new Date(u.start||0)-new Date(i.start||0)).slice(0,20).map(i=>{const u=ut(i,c),p={[s.code]:u.code.text,[s.customer]:u.customer.text,[s.date]:u.date.text,[s.status]:u.status.text,[s.payment]:u.payment.text,[s.total]:u.total.text,[s.share]:u.share.text,[s.net]:u.net.text};return{formatted:u,exportRow:p}});return r.innerHTML=o.map(({formatted:i})=>`
      <tr data-drilldown="reservation" data-search="${O(i.code.text)}">
        <td data-report-column="code">${i.code.html}</td>
        <td data-report-column="customer">${i.customer.html}</td>
        <td data-report-column="date">${i.date.html}</td>
        <td data-report-column="status">${i.status.html}</td>
        <td data-report-column="payment">${i.payment.html}</td>
        <td data-report-column="total">${i.total.html}</td>
        <td data-report-column="share">${i.share.html}</td>
        <td data-report-column="net">${i.net.html}</td>
      </tr>
    `).join(""),o.map(({exportRow:i})=>i)}function ut(e,t,a){const r=e?.reservationId||e?.id||"â€”",c=k(String(r)),o=t.get(String(e?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),i=N(e),u=dt(i.statusValue),p=pt(i.statusValue,u),f=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],l=mt(i.paidStatus,f),h=f.length;let m=l.html;if(h>0){const B=d("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",w(h));m=`<div class="reports-payment-cell">${l.html}<small class="reports-payment-subtext">${C(B)}</small></div>`}const y=He(e?.start),b=F(e),v=D(b.finalTotal),I=b.companySharePercent>0?`${w(b.companySharePercent)}% (${D(b.companyShareAmount)})`:d("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),E=D(b.netProfit),$=C(o);return{code:{html:C(c),text:c},customer:{html:$,text:o},date:{html:C(y),text:y},status:p,payment:{html:m,text:l.text},total:{html:C(v),text:v},share:{html:C(I),text:I},net:{html:C(E),text:E}}}function dt(e){switch(e){case"completed":return j(d("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return j(d("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return j(d("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return k(e||"â€”")}}function pt(e,t){const a=j(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${C(a)}</span>`,text:a}}function mt(e,t=[]){const a=fe(e),r=String(e??"").toLowerCase(),c=r==="paid"?"paid":r==="partial"?"partial":"unpaid";let s="";const o=d("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(t)&&t.length&&(s=t.map(p=>{const f=p?.recordedAt?H(p.recordedAt):"â€”",l=Number.isFinite(Number(p?.amount))&&Number(p.amount)>0?`${k(Number(p.amount).toFixed(2))} ${o}`:"",h=Number.isFinite(Number(p?.percentage))&&Number(p.percentage)>0?`${k(Number(p.percentage).toFixed(2))}%`:"",m=[f];return l&&m.push(l),h&&m.push(h),m.filter(Boolean).join(" â€¢ ")}).join(`
`));const i=s?` title="${O(s)}"`:"";return{html:`<span class="reservation-chip status-${c}"${i}>${C(a)}</span>`,text:a}}function j(e){return k(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function Z(e){const t=H(new Date).replace(/-/g,"");return`${d("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${t}.${e}`}function ft(e,t,a){const r=new Blob([e],{type:a}),c=URL.createObjectURL(r),s=document.createElement("a");s.href=c,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(c),4e3)}function U(e){if(!e||!e.length)return;const t=Object.keys(e[0]),a=[t.join(",")];e.forEach(c=>{const s=t.map(o=>`"${String(c[o]??"").replace(/"/g,'""')}"`);a.push(s.join(","))});const r=`\uFEFF${a.join(`\r
`)}\r
`;ft(r,Z("csv"),"text/csv;charset=utf-8;")}async function ht(e){try{const t=await rt();if(!t){U(e);return}const a=t.utils.json_to_sheet(e),r=t.utils.book_new(),c=d("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");t.utils.book_append_sheet(r,a,c),t.writeFile(r,Z("xlsx"))}catch(t){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",t),U(e)}}async function yt(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await at();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const a=Z("pdf");Pe();const r=[];Re(e,window,r),Me(e,window,r);try{await t().set({margin:10,filename:a,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(c){console.error("âš ï¸ [reports] export failed",c)}finally{Ne(r)}}async function gt(e,t){switch(e){case"pdf":await yt();break;case"excel":await ht(t);break;case"csv":default:U(t);break}}function bt(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${O(a.name)}">
        <td>${C(a.name)}</td>
        <td>${w(a.count)}</td>
        <td>${D(a.revenue)}</td>
      </tr>
    `).join("")}}function vt(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${O(a.name)}">
        <td>${C(a.name)}</td>
        <td>${w(a.count)}</td>
        <td>${D(a.revenue)}</td>
      </tr>
    `).join("")}}const T=n.filters;function wt(e){if(n.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(a=>{const r=a.dataset.columnToggle;r&&(a.checked=n.columnPreferences[r]!==!1,a.addEventListener("change",()=>{n.columnPreferences[r]=a.checked,e()}))}),n.columnControlsBound=!0,e())}function he(){Object.entries(n.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(a=>{a.classList.toggle("hidden",!t)})})}function xt(e){if(n.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(a=>{a.addEventListener("click",async()=>{const{export:r=""}=a.dataset;if(r){a.disabled=!0;try{await e(r)}catch(c){console.error("âš ï¸ [reports] export failed",c)}finally{a.disabled=!1}}})}),n.exportHandlersBound=!0)}function Dt(e,t){n.searchDebounceTimer&&(clearTimeout(n.searchDebounceTimer),n.searchDebounceTimer=null),n.searchDebounceTimer=setTimeout(()=>{T.search=e||"",t()},220)}function St(e,t){e&&(T.range="custom",T.start=e.startInput||null,T.end=e.endInput||null,t())}function Ct(e,t){e&&(T.status=T.status===e?"all":e,t())}function kt(e,t){e&&(T.payment=T.payment===e?"all":e,t())}function Tt(e,t){e&&(T.search=e,t())}const g=n.filters;function ae(){V(),x(),setTimeout(()=>{V(),x(),_()},0),setTimeout(()=>{V(),x(),_()},60),_()}function M(){g.range==="custom"&&x()}function _(e,t){if(!window.flatpickr)return;e&&(n.startDateInputRef=e),t&&(n.endDateInputRef=t);const a=n.startDateInputRef,r=n.endDateInputRef;if(!a&&!r)return;const c=At(),s=o=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...o};return c&&(i.locale=c),i};if(n.startDatePicker&&(n.startDatePicker.destroy(),n.startDatePicker=null),n.endDatePicker&&(n.endDatePicker.destroy(),n.endDatePicker=null),a&&(n.startDatePicker=window.flatpickr(a,s({onChange(o,i){g.start=i||null,n.endDatePicker&&(o?.length?n.endDatePicker.set("minDate",o[0]):n.endDatePicker.set("minDate",null)),M()},onValueUpdate(o,i){g.start=i||null,M()}}))),r&&(n.endDatePicker=window.flatpickr(r,s({onChange(o,i){g.end=i||null,n.startDatePicker&&(o?.length?n.startDatePicker.set("maxDate",o[0]):n.startDatePicker.set("maxDate",null)),M()},onValueUpdate(o,i){g.end=i||null,M()}}))),n.startDatePicker&&a){n.startDatePicker.setDate(a.value,!1);const o=n.endDatePicker?.selectedDates?.[0]||n.endDateInputRef?.value;o&&n.startDatePicker.set("maxDate",o)}if(n.endDatePicker&&r){n.endDatePicker.setDate(r.value,!1);const o=n.startDatePicker?.selectedDates?.[0]||n.startDateInputRef?.value;o&&n.endDatePicker.set("minDate",o)}}function At(){return(Y()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function X(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function L(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),r=document.getElementById("reports-share-filter"),c=document.getElementById("reports-search"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");e&&e.value!==g.range&&(e.value=g.range),t&&t.value!==g.status&&(t.value=g.status),a&&a.value!==g.payment&&(a.value=g.payment),r&&r.value!==g.share&&(r.value=g.share),c&&c.value!==g.search&&(c.value=g.search||""),s&&s.value!==(g.start||"")&&(s.value=g.start||""),o&&o.value!==(g.end||"")&&(o.value=g.end||""),X(i,g.range==="custom")}function W({active:e,icon:t,title:a,subtitle:r}){const c=document.getElementById("reports-empty-state");if(!c)return;const s=c.querySelector(".reports-empty-icon"),o=c.querySelector("h4"),i=c.querySelector("p");n.emptyDefaults.icon===null&&s&&(n.emptyDefaults.icon=s.textContent),n.emptyDefaults.title===null&&o&&(n.emptyDefaults.title=o.textContent),n.emptyDefaults.subtitle===null&&i&&(n.emptyDefaults.subtitle=i.textContent),c.classList.toggle("active",!!e),c.classList.toggle("hidden",!e),!(!s||!o||!i)&&(e?(s.textContent=t!==void 0?t:n.emptyDefaults.icon??s.textContent,o.textContent=a!==void 0?a:n.emptyDefaults.title??o.textContent,i.textContent=r!==void 0?r:n.emptyDefaults.subtitle??i.textContent):(s.textContent=n.emptyDefaults.icon??s.textContent,o.textContent=n.emptyDefaults.title??o.textContent,i.textContent=n.emptyDefaults.subtitle??i.textContent))}function Et(e){W({active:!!e})}function Lt(){if(n.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),r=c=>{const s=c.target?.closest("[data-drilldown]");if(!s)return;const o=s.dataset.search||"";Tt(o,()=>{L(),x()})};e?.addEventListener("click",r),t?.addEventListener("click",r),a?.addEventListener("click",r),n.drilldownBound=!0}function R(){ue({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function x(){if(L(),n.loading){W({active:!0,icon:"â³",title:d("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:d("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(n.errorMessage){W({active:!0,icon:"âš ï¸",title:n.errorMessage,subtitle:d("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:e,customers:t,equipment:a,technicians:r,maintenance:c}=n.data,s=nt(e,g,t,a,r),o=Xe(s),i=We(c,g),u=Ke(o,i.total),p=Ge(s),f=Qe(s),l=Ze(s),h=Je(s,t),m=et(s,a);it(u),st(p),ot(f),ct(l),bt(h),vt(m);const y=lt(s,t,r);he(),Et(s.length===0),n.lastSnapshot.filtered=s,n.lastSnapshot.metrics=u,n.lastSnapshot.trend=p,n.lastSnapshot.statusBreakdown=f,n.lastSnapshot.paymentBreakdown=l,n.lastSnapshot.tableRows=y,n.lastSnapshot.maintenance=i}function It(){if(n.initialized)return;n.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),r=document.getElementById("reports-share-filter"),c=document.getElementById("reports-start"),s=document.getElementById("reports-end"),o=document.getElementById("reports-refresh"),i=document.getElementById("reports-custom-range"),u=document.getElementById("reports-search");if(!e)return;L(),ze()&&x(),e.addEventListener("change",()=>{g.range=e.value,X(i,g.range==="custom"),g.range!=="custom"&&(g.start=null,g.end=null),x()}),t?.addEventListener("change",()=>{g.status=t.value,x()}),a?.addEventListener("change",()=>{g.payment=a.value,x()}),r?.addEventListener("change",()=>{g.share=r.value,x()}),u?.addEventListener("input",()=>{const f=u.value||"";Dt(f,()=>{L(),x()})}),c?.addEventListener("change",()=>{g.start=c.value||null,M()}),s?.addEventListener("change",()=>{g.end=s.value||null,M()}),o?.addEventListener("click",()=>{g.range==="custom"&&(g.start=c?.value||null,g.end=s?.value||null),x()}),_(c,s),X(i,g.range==="custom"),n.languageListenerAttached||(document.addEventListener("language:changed",ae),document.addEventListener("language:translationsReady",ae),n.languageListenerAttached=!0),n.dataListenersAttached||(document.addEventListener("reservations:changed",R),document.addEventListener("customers:changed",R),document.addEventListener("equipment:changed",R),document.addEventListener("projects:changed",R),document.addEventListener("technicians:updated",R),window.addEventListener("maintenance:updated",R),n.dataListenersAttached=!0),wt(he),xt(async f=>{const l=n.lastSnapshot.tableRows||[];if(!l.length){console.warn("[reports] No reservation data to export");return}await gt(f,l)}),Lt(),n.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>x(),0)}),n.themeListenerAttached=!0),Ie(x),Fe(()=>{x()}),$e(()=>{x()}),Be(f=>{St(f,()=>{L(),x()})}),je(f=>{Ct(f?.filterKey,()=>{L(),x()})}),_e(f=>{kt(f?.filterKey,()=>{L(),x()})}),ue().catch(f=>{console.error("âŒ [reports] Failed to initialise reports data",f)})}export{It as initReports,x as renderReports};
