import{t as l,e as nt,r as z,j as at,i as rt,p as st,c as it,h as I,g as G,k as ct}from"./calculations.BWHtFzv-.js";import{q as lt}from"./quotePdf.C5ONEDR8.js";import{s as pt,a as dt,e as mt}from"./canvasColorUtils.CviLtv6S.js";import{n as B}from"./auth.Bt1KphMA.js";import"./reservationsService.CU7qTLqY.js";import"./state.CY6GwEtX.js";const U=96,X=25.4,J=210,ut=297,N=Math.round(J/X*U),A=Math.round(ut/X*U),j=U/X,ht=/safari/i,ft=/(iphone|ipad|ipod)/i,gt=/(crios|fxios|edgios|opios)/i;function Y(){try{const o=navigator.userAgent||"";return ft.test(o)&&ht.test(o)&&!gt.test(o)}catch{return!1}}function yt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function bt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const n=document.createElement("style");n.textContent=String(lt).trim(),t.appendChild(n);const p=document.createElement("div");p.className="quote-preview-pages",p.setAttribute("data-quote-pages",""),t.appendChild(p);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; table-layout:fixed; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    .rpt-table th, .rpt-table td { vertical-align: top !important; line-height: 1.35; }
    .rpt-table th > *, .rpt-table td > * { vertical-align: top !important; }
    /* Right-justify for RTL, align content to top without manual nudge */
    .rpt-table .quote-cell { display:flex; align-items:flex-start; justify-content:flex-end; width:100%; min-height:30px; text-align:right; line-height:1.3; position:relative; top: 0; transform: none; padding-top: 2px; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function K(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),n=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(n)?Math.max(90,Math.min(100,n))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function V({rightMm:o,topMm:t,scale:n}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((n||1)*1e3)/10))}catch{}}function xt(o){try{const t=K(),n=document.createElement("div");n.setAttribute("data-rpt-controls",""),Object.assign(n.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const p="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";n.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${p}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${p}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${p}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(n,e);const w=()=>{const g=Number(n.querySelector("[data-rpt-right]").value),u=Number(n.querySelector("[data-rpt-top]").value),s=Number(n.querySelector("[data-rpt-scale]").value),f=Math.max(.9,Math.min(1,s/100));V({rightMm:g,topMm:u,scale:f});const d=g*j,a=u*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${d}px, ${a}px) scale(${f})`})};n.querySelector("[data-rpt-apply]").addEventListener("click",w),n.querySelector("[data-rpt-reset]").addEventListener("click",()=>{n.querySelector("[data-rpt-right]").value=0,n.querySelector("[data-rpt-top]").value=0,n.querySelector("[data-rpt-scale]").value=100,V({rightMm:0,topMm:0,scale:1});const g=o.querySelector("[data-quote-pages]");Object.assign(g.style,{transform:"none"})});const c=t.rightMm*j,r=t.topMm*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${c}px, ${r}px) scale(${t.scale})`})}catch{}}function wt({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function vt(o){const t=document.createElement("div");t.className="rpt-header";const n=document.createElement("h1");n.textContent=l("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const p=document.createElement("p");p.className="rpt-subtitle",p.textContent=`${ct(new Date)} • ${l("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(n),t.appendChild(p);const e=document.createElement("div");e.className="rpt-kpis";const w=(c,r)=>{const g=document.createElement("div");return g.className="rpt-kpi",g.innerHTML=`<div class="label">${c}</div><div class="value">${r}</div>`,g};return e.appendChild(w(l("reservations.reports.kpi.total.label","الحجوزات","Reservations"),G(o.total||0))),e.appendChild(w(l("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),I(o.revenue||0))),e.appendChild(w(l("reservations.reports.kpi.net.label","صافي الربح","Net profit"),I(o.netProfit||0))),e.appendChild(w(l("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),I(o.companyShareTotal||0))),e.appendChild(w(l("reservations.reports.kpi.tax.label","الضريبة","Tax"),I(o.taxTotal||0))),e.appendChild(w(l("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),I(o.maintenanceExpense||0))),t.appendChild(e),t}function Ct(){try{const o=z?.data||{},t=z?.lastSnapshot?.filtered||o.reservations||[],n=new Map((o.customers||[]).map(r=>[String(r.id),r])),p=[...t].sort((r,g)=>new Date(g?.start||0)-new Date(r?.start||0)),e={code:l("reservations.reports.results.headers.id","الحجز","Reservation"),customer:l("reservations.reports.results.headers.customer","العميل","Customer"),date:l("reservations.reports.results.headers.date","التاريخ","Date"),status:l("reservations.reports.results.headers.status","الحالة","Status"),payment:l("reservations.reports.results.headers.payment","الدفع","Payment"),total:l("reservations.reports.results.headers.total","الإجمالي","Total"),share:l("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:l("reservations.reports.results.headers.net","صافي الربح","Net profit")},w=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],c=p.map(r=>{const g=r?.reservationId||r?.id||l("common.placeholder.empty","—","—"),u=B(String(g)),f=n.get(String(r?.customerId))?.customerName||l("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),d=at(r?.start),a=rt(r),S=(()=>{switch(a.statusValue){case"completed":return String(l("reservations.list.status.completed","مغلق","Closed")).replace(/^\W+/,"");case"confirmed":return String(l("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(l("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return B(String(a.statusValue||l("common.placeholder.empty","—","—")))}})(),k=st(a.paidStatus),P=it(r),F=I(P.finalTotal),O=P.companySharePercent>0?`${G(P.companySharePercent)}% (${I(P.companyShareAmount)})`:l("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),h=I(P.netProfit);return{[e.code]:u,[e.customer]:f,[e.date]:d,[e.status]:S,[e.payment]:k,[e.total]:F,[e.share]:O,[e.net]:h}});return{headers:w,rows:c}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function Pt(o){const t=document.createElement("table");t.className="rpt-table";const n=document.createElement("thead"),p=document.createElement("tr");o.forEach(w=>{const c=document.createElement("th");c.textContent=w,p.appendChild(c)}),n.appendChild(p);const e=document.createElement("tbody");return t.appendChild(n),t.appendChild(e),{table:t,tbody:e}}function Mt(o,t,n,p){const e=o.querySelector("[data-quote-pages]"),w=s=>{const f=wt({primary:!!s});if(!s)try{f.classList.add("quote-page--continuation")}catch{}if(e.appendChild(f),s){const a=vt(p);f.appendChild(a)}const d=Pt(n);return f.appendChild(d.table),{page:f,table:d.table,tbody:d.tbody}},c=(s,f)=>{const d=document.createElement("tr");return n.forEach(a=>{const S=document.createElement("td"),k=document.createElement("div");k.className="quote-cell",k.textContent=f[a]!=null?String(f[a]):"",S.appendChild(k),d.appendChild(S)}),s.appendChild(d),d},r=(s,f)=>{try{const d=s.getBoundingClientRect(),a=f.lastElementChild;if(!a)return!0;const S=a.getBoundingClientRect(),k=parseFloat(getComputedStyle(s).paddingBottom||"0")||0,P=d.bottom-k-1;return S.bottom<=P}catch{return!0}};let{page:g,tbody:u}=w(!0);for(let s=0;s<t.length;s+=1){const f=c(u,t[s]);r(g,u)||(f.remove(),{page:g,tbody:u}=w(!1),c(u,t[s]))}}async function Et(o=[],{context:t="preview"}={}){const p=(z.lastSnapshot||{}).metrics||{};let e,w=o&&o.length?o:null;if(w)e=Object.keys(w[0]||{});else{const g=Ct();e=g.headers,w=g.rows}const c=bt(t),r=document.createElement("div");r.style.position="fixed",r.style.left="0",r.style.top="0",r.style.width=`${N}px`,r.style.zIndex="-1",r.style.visibility="hidden",document.body.appendChild(r),r.appendChild(c);try{document?.fonts?.ready&&await document.fonts.ready}catch{}try{pt(c),dt(c),mt(c)}catch{}return Mt(c,w||[],e,p),c.parentElement?.removeChild(c),r.parentElement?.removeChild(r),t==="preview"&&xt(c),c}async function Nt(o=[],{action:t="save"}={}){const n=await Et(o,{context:"export"}),p=document.createElement("div");Object.assign(p.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),p.appendChild(n),document.body.appendChild(p);try{if(t==="print"){if(Y()){const a=window.open("","_blank");if(!a)throw new Error("Popup blocked");const S=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${l("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{a.document.open(),a.document.write(S),a.document.close()}catch{}const k=n.cloneNode(!0);try{a.document.body.appendChild(k)}catch{}try{a.document?.fonts?.ready&&await a.document.fonts.ready}catch{}await new Promise(P=>setTimeout(P,60));try{a.focus(),a.print()}catch{}return}const u=document.createElement("iframe");Object.assign(u.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0",opacity:"0",pointerEvents:"none"}),document.body.appendChild(u);const s=u.contentWindow?.document,f=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${l("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{s.open(),s.write(f),s.close()}catch{}const d=n.cloneNode(!0);try{s.body.appendChild(d)}catch{}try{s.fonts?.ready&&await s.fonts.ready}catch{}await new Promise(a=>setTimeout(a,60));try{u.contentWindow?.focus(),u.contentWindow?.print()}catch{}setTimeout(()=>{try{u.remove()}catch{}},1500);return}const c=Y()&&!yt()?window.open("","_blank"):null;if(c)try{c.document.open(),c.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${l("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${l("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${l("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),c.document.close()}catch{}await nt();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const r=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,g=window.html2canvas;if(typeof r=="function"&&typeof g=="function"){const u=K(),s=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),d={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},a=Array.from(n.querySelectorAll(".quote-page"));let S=0;const k=(h,m=250)=>{try{const i=h.getContext("2d"),{width:b,height:v}=h,y=new Uint8ClampedArray(b*4),C=x=>{const R=i.getImageData(0,x,b,1).data||y;let _=0;for(let E=0;E<b;E+=1){const T=E*4,q=R[T],$=R[T+1],D=R[T+2];if((q<m||$<m||D<m)&&(_+=1,_>Math.max(2,Math.ceil(b*.003))))return!1}return!0};let M=0;for(let x=0;x<v;x+=2)if(!C(x)){M=x;break}return M}catch{return 0}},P=(h,m=245)=>{try{const i=h.getContext("2d"),{width:b,height:v}=h,y=Math.floor(b*.55),C=Math.max(10,b-y),M=Math.max(3,Math.ceil(C*.015));for(let x=0;x<v;x+=2){const R=i.getImageData(y,x,C,1).data;let _=0;for(let E=0;E<C;E+=1){const T=E*4,q=R[T],$=R[T+1],D=R[T+2];if((q<m||$<m||D<m)&&(_+=1,_>=M))return x}}return 0}catch{return 0}},F=(h,m=250)=>{try{const i=h.getContext("2d"),{width:b,height:v}=h,y=M=>{const x=i.getImageData(0,M,b,1).data;let R=0;for(let _=0;_<b;_+=1){const E=_*4,T=x[E],q=x[E+1],$=x[E+2];if((T<m||q<m||$<m)&&(R+=1,R>Math.max(2,Math.ceil(b*.003))))return!1}return!0};let C=0;for(let M=v-1;M>=0;M-=2)if(!y(M)){C=v-1-M;break}return C}catch{return 0}},O=(h,m,i)=>{try{const{width:b,height:v}=h,y=Math.max(0,Math.min(v-1,Math.round(m))),C=Math.max(0,Math.min(v-y,Math.round(i))),M=Math.max(1,v-y-C);if(y===0&&C===0)return h;const x=document.createElement("canvas");return x.width=b,x.height=M,x.getContext("2d").drawImage(h,0,-y),x}catch{return h}};for(let h=0;h<a.length;h+=1){const m=a[h],i=m.ownerDocument||document,b=i.createElement("div");Object.assign(b.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const v=i.createElement("div");v.id="quotation-pdf-root",v.setAttribute("data-quote-render-context","export"),v.style.width=`${N}px`,v.style.maxWidth=`${N}px`,v.style.minWidth=`${N}px`,v.style.background="#ffffff";const y=m.cloneNode(!0);y.style.width=`${N}px`,y.style.maxWidth=`${N}px`,y.style.minWidth=`${N}px`,y.style.height=`${A}px`,y.style.maxHeight=`${A}px`,y.style.minHeight=`${A}px`,y.style.position="relative",y.style.background="#ffffff",y.style.overflow="hidden",v.appendChild(y),b.appendChild(v),i.body.appendChild(b);let C;try{C=await g(y,{...d,scrollX:0,scrollY:0,windowWidth:N,windowHeight:A})}finally{b.parentNode?.removeChild(b)}if(!C)continue;const M=k(C,246),x=P(C,244),R=Math.max(M,x),_=F(C,246),E=O(C,R,_),T=Math.max(.9,Math.min(1,u.scale||1)),q=J*T,$=E.height/E.width*q;let D=Number(u.rightMm)||0;const Q=m.classList.contains("quote-page--primary")?6:12;let L=0;try{const W=m.querySelector(".rpt-header")||m.firstElementChild;if(W){const et=W.getBoundingClientRect(),ot=m.getBoundingClientRect();L=Math.max(0,et.top-ot.top)}}catch{L=0}const Z=L/j;let H=(Number(u.topMm)||0)+Q-Z;H<-80&&(H=-80);const tt=E.toDataURL("image/jpeg",.95);S>0&&s.addPage(),s.addImage(tt,"JPEG",D,H,q,$,`page-${S+1}`,"FAST"),S+=1,await new Promise(W=>requestAnimationFrame(W))}if(S===0)throw new Error("PDF generation produced no pages");if(t==="print"){const h=s.output("bloburl");if(c)try{c.location.href=h}catch{}else await new Promise(m=>{const i=document.createElement("iframe");Object.assign(i.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),i.onload=()=>{try{i.contentWindow?.focus(),i.contentWindow?.print()}catch{}setTimeout(()=>{i.remove(),m()},700)},i.src=h,document.body.appendChild(i)})}else try{const h=s.output("blob"),m=URL.createObjectURL(h),i=document.createElement("a");i.href=m,i.download="reservations-report.pdf",i.rel="noopener",i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{try{URL.revokeObjectURL(m),i.remove()}catch{}},1500)}catch{s.save("reservations-report.pdf")}}else{const u=window.html2pdf().set({margin:0,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(n).toPdf();if(t==="print"){const s=await u.get("pdf").then(f=>f.output("bloburl"));await new Promise(f=>{const d=document.createElement("iframe");Object.assign(d.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),d.onload=()=>{try{d.contentWindow?.focus(),d.contentWindow?.print()}catch{}setTimeout(()=>{d.remove(),f()},700)},d.src=s,document.body.appendChild(d)})}else await u.save("reservations-report.pdf")}}finally{p.remove()}}export{Et as buildReportsPdfPages,Nt as exportReportsPdf};
