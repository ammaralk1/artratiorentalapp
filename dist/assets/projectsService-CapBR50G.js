import{e as _,n as b,j as p,t as l,h as Ke,b as I,s as Z,A as me,k as z,o as ee}from"./auth-BJNkeD3K.js";const bt=_()||{};let F=(bt.equipment||[]).map(Et),Se=!1,Y="";function Ye(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function vt(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function Et(e={}){return qe({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function pe(e={}){return qe(e)}function qe(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",i=e.subcategory??e.sub??"",s=fe(e.quantity??e.qty??0),r=ge(e.unit_price??e.price??0),u=b(String(e.barcode??"").trim()),c=P(e.status??e.state??e.status_label??e.statusLabel??"available"),o=e.image_url??e.imageUrl??e.image??"",d=e.name??e.item_name??n;return{id:St(t)?String(t):"",category:a,sub:i,desc:n,name:d,qty:s,price:r,barcode:u,status:c,image:o,imageUrl:o,created_at:e.created_at??null,updated_at:e.updated_at??null}}function St(e){return e!=null&&e!==""}function fe(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function ge(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function P(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":case"متوفر":return"available";case"reserved":case"محجوز":return"reserved";case"maintenance":case"صيانة":return"maintenance";case"retired":case"متوقف":case"خارج الخدمة":return"retired";default:return"available"}}function It(e){switch(P(e)){case"available":return"متاح";case"reserved":return"محجوز";case"maintenance":return"صيانة";case"retired":return"متوقف";default:return"متاح"}}function qt(e){return P(e)}function W(){return F}function k(e){F=Array.isArray(e)?e.map(qe):[],Z({equipment:F}),vt()}async function Ln(e){if(!z()){ee();return}if(!e)return;try{await Tt()}catch(n){console.error("❌ [equipment.js] Unable to load XLSX",n),alert(l("equipment.toast.xlsxMissing","⚠️ مكتبة Excel (XLSX) غير محملة."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),i=XLSX.read(a,{type:"array"}),s=i.Sheets[i.SheetNames[0]],r=XLSX.utils.sheet_to_json(s,{defval:""});if(!Array.isArray(r)||r.length===0){p(l("equipment.toast.uploadEmpty","⚠️ لم يتم العثور على بيانات في الملف"));return}const u=[];let c=0;if(r.forEach(o=>{const d=o.القسم??o.category??"",f=o["القسم الثانوي"]??o.subcategory??"",g=o.الوصف??o.description??o.name??"",y=o.الكمية??o.quantity??0,m=o.السعر??o.price??0,v=o.الباركود??o.barcode??"",E=o.الحالة??o.status??"متاح",h=o.الصورة??o.image_url??o.image??"",q=b(String(v||"")).trim();if(!g||!q){c+=1;return}u.push(Ae({category:d,subcategory:f,description:g,quantity:y,unit_price:m,barcode:q,status:E,image_url:h}))}),!u.length){p(l("equipment.toast.uploadEmpty","⚠️ لم يتم العثور على بيانات في الملف"));return}try{const o=await I("/equipment/?bulk=1",{method:"POST",body:u}),d=Array.isArray(o?.data)?o.data.map(pe):[];if(d.length){const y=[...W(),...d];k(y)}await ye({showToastOnError:!1}),B();const f=o?.meta?.count??d.length,g=[];f&&g.push(`${f} ✔️`),c&&g.push(`${c} ⚠️`),p(l("equipment.toast.uploadSuccess","✅ تم رفع المعدات بنجاح")+(g.length?` (${g.join(" / ")})`:""))}catch(o){const d=O(o,"equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل");p(d,"error")}}catch(a){console.error("❌ [equipment.js] Failed to process Excel file",a),p(l("equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل"),"error")}},t.onerror=function(){console.error("❌ [equipment.js] FileReader error",t.error),p(l("equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل"),"error")},t.readAsArrayBuffer(e)}const At="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let K=null;function Tt(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):K||(K=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",i,{once:!0}),n.addEventListener("error",s,{once:!0});return}const a=document.createElement("script");a.src=At,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",i,{once:!0}),a.addEventListener("error",s,{once:!0}),document.head.appendChild(a);function i(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function s(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("⚠️ [equipment.js] ensureXLSXLoaded failed",e),K=null,e}),K)}function Ae({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:i=0,barcode:s="",status:r="متاح",image_url:u=""}){const c=b(String(s||"")).trim(),o=qt(r);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:fe(a),unit_price:ge(i),barcode:c,status:o,image_url:u?.trim()||null}}async function Bt(){if(!z()){ee();return}if(confirm(l("equipment.toast.clearConfirm","⚠️ هل أنت متأكد من حذف كل المعدات؟")))try{const t=(await I("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await ye({showToastOnError:!1}),p(l("equipment.toast.clearSuccess","🗑️ تم مسح جميع المعدات")+(t?` (${t})`:""))}catch(e){const t=O(e,"equipment.toast.clearFailed","⚠️ تعذر حذف بعض المعدات");p(t,"error")}}function Ge(e){return e.image||e.imageUrl||e.img||""}function _t(e){const t=P(e);return t==="available"?`<span class="badge bg-success">${l("equipment.form.options.available","✅ متاح")}</span>`:t==="reserved"?`<span class="badge bg-warning text-dark">${l("equipment.form.options.booked","📌 محجوز")}</span>`:t==="maintenance"?`<span class="badge bg-danger">${l("equipment.form.options.maintenance","🛠️ صيانة")}</span>`:t==="retired"?`<span class="badge bg-secondary">${l("equipment.form.options.retired","📦 خارج الخدمة")}</span>`:`<span class="badge bg-secondary">${e||"-"}</span>`}function Nt({item:e,index:t}){const n=Ge(e),a=l("equipment.item.actions.edit","✏️ تعديل"),i=l("equipment.item.actions.delete","🗑️ حذف"),s=l("equipment.item.imageAlt","صورة"),r=l("equipment.item.currency","ريال"),u=z(),c=[`<button type="button" class="btn btn-sm btn-warning" data-equipment-action="edit" data-equipment-index="${t}">${a}</button>`];return u&&c.push(`<button type="button" class="btn btn-sm btn-danger" data-equipment-action="delete" data-equipment-index="${t}">${i}</button>`),`
    <div class="border-bottom py-3 d-flex align-items-center" data-equipment-index="${t}">
      <div class="equipment-image me-3">
        ${n?`<img src="${n}" alt="${s}" class="img-fluid rounded">`:'<div class="no-image d-flex align-items-center justify-content-center bg-light rounded">📦</div>'}
      </div>

      <div class="flex-grow-1">
        <div><strong>🏷️ ${e.desc||e.name||"-"}</strong></div>
        <div class="text-muted">${e.category||"-"} - ${e.sub||"-"}</div>

        <div class="mt-1">
          📦 <strong>${e.qty||0}</strong> | 💵 <strong>${e.price||0}</strong> ${r} | 🔖 ${e.barcode||"-"}
        </div>

        <div class="mt-1">⚙️ ${_t(e.status)}</div>
      </div>

      <div class="ms-3 d-flex flex-column gap-2">
        ${c.join("")}
      </div>
    </div>
  `}function Lt(e){const t=[...new Set(e.map(s=>s.category).filter(Boolean))],n=[...new Set(e.map(s=>s.sub).filter(Boolean))],a=document.getElementById("filter-category"),i=document.getElementById("filter-sub");if(a){const s=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(r=>{const u=document.createElement("option");u.value=r,u.textContent=r,a.appendChild(u)}),t.includes(s)&&(a.value=s)}if(i){const s=i.value;for(;i.options.length>1;)i.remove(1);n.forEach(r=>{const u=document.createElement("option");u.value=r,u.textContent=r,i.appendChild(u)}),n.includes(s)&&(i.value=s)}}function Qe(){const e=_();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return F=t||[],F;const i=new Date;let s=!1;const r=new Set((a||[]).filter(c=>c?.status==="open").map(c=>b(String(c?.equipmentBarcode??"")).trim().toLowerCase())),u=t.map(c=>{if(!c)return c;const o=P(c.status),d=b(String(c.barcode??"")).trim().toLowerCase(),f=d&&r.has(d);let g=f?"maintenance":o;if(!f&&d)for(const y of n||[]){if(!Ct(y,i))continue;if(y.items?.some(v=>b(String(v?.barcode??"")).trim().toLowerCase()===d)){g="reserved";break}}return g!==o?(s=!0,{...c,status:g}):{...c,status:o}});return s?k(u):(F=u,Z({equipment:F})),F}function Ct(e,t){if(!e?.start||!e?.end)return!1;const n=new Date(e.start),a=new Date(e.end);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?!1:n<=t&&t<a}function B(){const e=document.getElementById("equipment-list");if(!e)return;const t=Qe(),n=Array.isArray(t)?t:W(),a=n.map((m,v)=>({item:m,index:v})),i=document.getElementById("search-equipment")?.value||"",s=b(i).toLowerCase().trim(),r=document.getElementById("filter-category")?.value||"",u=document.getElementById("filter-sub")?.value||"",c=document.getElementById("filter-status")?.value||"",o=c?P(c):"";if(Se&&!n.length){e.innerHTML=`<em>${l("equipment.table.loading","جاري التحميل...")}</em>`;return}if(Y&&!n.length){e.innerHTML=`<em class="text-danger">${Y}</em>`;return}const f=a.filter(({item:m})=>{const v=b(String(m.barcode??"")).toLowerCase().trim(),E=!s||m.name&&m.name.toLowerCase().includes(s)||m.desc&&m.desc.toLowerCase().includes(s)||v&&v.includes(s)||m.category&&m.category.toLowerCase().includes(s)||m.sub&&m.sub.toLowerCase().includes(s),h=!r||m.category===r,q=!u||m.sub===u,N=!o||P(m.status)===o;return E&&h&&q&&N}).sort((m,v)=>{const E=b(String(m.item.barcode??"")).trim().toLowerCase(),h=b(String(v.item.barcode??"")).trim().toLowerCase(),q=Number.parseInt(E,10),N=Number.parseInt(h,10),J=Number.isFinite(q),L=Number.isFinite(N);return J&&L&&q!==N?q-N:E.localeCompare(h,"ar",{numeric:!0,sensitivity:"base"})}),g=s?l("equipment.list.emptyFiltered","⚠️ لا توجد معدات مطابقة."):l("equipment.table.empty","لا يوجد معدات");e.innerHTML=f.length?f.map(Nt).join(""):`<em>${g}</em>`;const y=document.getElementById("equipment-list-count");if(y){const m=l("equipment.list.countSuffix","عنصر"),v=b(String(f.length)),E=f.length?`${v} ${m}`:`0 ${m}`;y.textContent=E}Lt(n)}async function ye({showToastOnError:e=!0}={}){Se=!0,Y="",B();try{const t=await I("/equipment/?all=1"),n=Array.isArray(t?.data)?t.data.map(pe):[];k(n)}catch(t){Y=O(t,"equipment.toast.fetchFailed","تعذر تحميل قائمة المعدات"),e&&p(Y,"error")}finally{Se=!1,B()}}function O(e,t,n){if(e instanceof me){const a=e.payload?.errors;if(a&&typeof a=="object"){const i=Object.values(a)[0];if(Array.isArray(i))return i[0];if(typeof i=="string")return i}if(e.message)return e.message}return l(t,n)}async function $t(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",i=b(a).trim(),s=ge(t.querySelector("#new-equipment-price")?.value||"0"),r=fe(t.querySelector("#new-equipment-qty")?.value||"1"),u=t.querySelector("#new-equipment-image")?.value?.trim()||"",c=t.querySelector("#new-equipment-category")?.value?.trim()||"",o=t.querySelector("#new-equipment-sub")?.value?.trim()||"",d=t.querySelector("#new-equipment-status")?.value||"متاح";if(!n||!i){p(l("equipment.toast.missingFields","⚠️ يرجى إدخال الوصف والباركود"));return}const f=Ae({category:c,subcategory:o,description:n,quantity:r,unit_price:s,barcode:i,status:d,image_url:u});try{const g=await I("/equipment/",{method:"POST",body:f}),y=pe(g?.data),m=[...W(),y];k(m),B(),t.reset();const v=t.querySelector("#new-equipment-status");v&&(v.value="متاح"),p(l("equipment.toast.addSuccess","✅ تم إضافة المعدة"))}catch(g){const y=O(g,"equipment.toast.addFailed","تعذر إضافة المعدة");p(y,"error")}}async function xt(e){if(!z()){ee();return}const t=W(),n=t[e];if(n&&confirm(l("equipment.toast.deleteConfirm","❌ هل أنت متأكد من حذف هذه المعدة؟")))try{n.id&&await I(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),k(a),B(),p(l("equipment.toast.deleteSuccess","🗑️ تم حذف المعدة"))}catch(a){const i=O(a,"equipment.toast.deleteFailed","تعذر حذف المعدة، يرجى المحاولة مجدداً");p(i,"error")}}async function Ft(e,t){const n=W(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const s=[...n];s[e]={...s[e],...t},k(s),B();return}const i=Ae({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image});try{const s=await I(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:i}),r=pe(s?.data),u=[...n];u[e]=r,k(u),B(),p(l("equipment.toast.updateSuccess","✅ تم تحديث بيانات المعدة بنجاح"))}catch(s){const r=O(s,"equipment.toast.updateFailed","تعذر تحديث بيانات المعدة");throw p(r,"error"),s}}function ae(){B()}function jt(e){const t=W()[e];t&&(document.getElementById("edit-equipment-index").value=e,document.getElementById("edit-equipment-category").value=t.category||"",document.getElementById("edit-equipment-subcategory").value=t.sub||"",document.getElementById("edit-equipment-description").value=t.desc||"",document.getElementById("edit-equipment-quantity").value=t.qty||1,document.getElementById("edit-equipment-price").value=t.price||0,document.getElementById("edit-equipment-barcode").value=t.barcode||"",document.getElementById("edit-equipment-status").value=It(t.status),document.getElementById("edit-equipment-image").value=Ge(t)||"",Ye(document.getElementById("editEquipmentModal"))?.show())}function Dt(e){const t=e.target.closest("[data-equipment-action]");if(!t)return;e.preventDefault();const n=t.dataset.equipmentAction,a=Number(t.dataset.equipmentIndex);if(!Number.isNaN(a)){if(n==="edit"){jt(a);return}n==="delete"&&xt(a).catch(i=>{console.error("❌ [equipment.js] deleteEquipment",i)})}}function Rt(){document.getElementById("search-equipment")?.addEventListener("input",ae),document.getElementById("filter-category")?.addEventListener("change",ae),document.getElementById("filter-sub")?.addEventListener("change",ae),document.getElementById("filter-status")?.addEventListener("change",ae),document.getElementById("add-equipment-form")?.addEventListener("submit",$t);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{n.preventDefault(),Bt().catch(a=>{console.error("❌ [equipment.js] clearEquipment",a)})}),e.dataset.listenerAttached="true");const t=document.getElementById("equipment-list");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",Dt),t.dataset.listenerAttached="true")}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){p(l("equipment.toast.updateFailed","تعذر تحديث بيانات المعدة"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:fe(document.getElementById("edit-equipment-quantity").value)||1,price:ge(document.getElementById("edit-equipment-price").value)||0,barcode:b(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value};try{await Ft(t,n),Ye(document.getElementById("editEquipmentModal"))?.hide()}catch(a){console.error("❌ [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{Rt(),B(),ye()});document.addEventListener("language:changed",()=>{B()});document.addEventListener("equipment:refreshRequested",()=>{ye({showToastOnError:!1})});document.addEventListener(Ke.USER_UPDATED,()=>{B()});let H=[],Ze=[],et=[];function Cn(){return H}function $n(e){H=Array.isArray(e)?e:[]}function xn(e){H=[...H,e]}function Fn(e){Number.isInteger(e)&&e>=0&&(H=H.filter((t,n)=>n!==e))}function jn(){return Ze}function Dn(e){Ze=Array.isArray(e)?e:[]}function Rn(){return et}function Mn(e){et=Array.isArray(e)?e:[]}function Pn(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",i=""]=n.split("T"),s=a?a.slice(0,10):"",r=i.match(/(\d{1,2}:\d{2})/);let u="";if(r){const[c="00",o="00"]=r[0].split(":");u=`${c.padStart(2,"0")}:${o.padStart(2,"0")}`}return{date:s,time:u}}function ie(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function ze(e){return b(String(e||"")).trim().toLowerCase()}function kn(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:r=[]}=_(),u=ze(e);return r.some(c=>{if(!c||!c.items||c.items.length===0||a&&(String(c.id)===String(a)||String(c.reservationId)===String(a))||!c.start||!c.end)return!1;const o=new Date(c.start),d=new Date(c.end);return Number.isNaN(o.getTime())||Number.isNaN(d.getTime())||!(o<s&&d>i)?!1:c.items.some(g=>ze(g?.barcode)===u)})}function Mt(e,t,n,a=null){if(!e||!t||!n)return!1;const i=new Date(t),s=new Date(n);if(Number.isNaN(i.getTime())||Number.isNaN(s.getTime()))return!1;const{reservations:r=[]}=_(),u=String(e);return r.some(c=>{if(!c?.start||!c?.end||a&&(String(c.id)===String(a)||String(c.reservationId)===String(a)))return!1;const o=new Date(c.start),d=new Date(c.end);return Number.isNaN(o.getTime())||Number.isNaN(d.getTime())||!(o<s&&d>i)?!1:(Array.isArray(c.technicians)?c.technicians:[]).some(y=>String(y)===u)})}const Pt=_()||{};let D=(Pt.technicians||[]).map(it);function tt(){return D}function te(e){return D=Array.isArray(e)?e.map(it):[],Z({technicians:D}),typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("technicians:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),D}async function kt(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,r])=>{r!=null&&r!==""&&t.set(s,String(r))});const n=t.toString(),a=await I(`/technicians/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(Te):[];return te(i)}async function wt(e){const t=await I("/technicians/",{method:"POST",body:e}),n=Te(t?.data??{});return te([...D,n]),n}async function nt(e,t){const n=await I(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Te(n?.data??{}),i=D.map(s=>String(s.id)===String(e)?a:s);return te(i),a}async function zt(e){await I(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),te(D.filter(t=>String(t.id)!==String(e)))}function at({name:e,phone:t,email:n,role:a,department:i,dailyWage:s,status:r,notes:u,active:c=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:i??null,daily_wage:s??0,status:r??"available",notes:u??null,active:c?1:0}}function Te(e={}){return st({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,status:e.status,notes:e.notes,active:e.active})}function it(e={}){return st(e)}function st(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",i=e.email??null,s=e.specialization??e.role??e.position??"",r=e.department??e.team??"",u=Ut(e.daily_wage??e.dailyWage??e.wage??e.rate??0),c=Ue(e.baseStatus??e.status??"available"),o=Ue(e.status??e.baseStatus??"available"),d=e.notes??"",f=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:i,role:s,department:r,dailyWage:u,status:o,baseStatus:c,notes:d,active:f}}function Ut(e){const t=Number.parseFloat(b(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function Ue(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":return"available";case"busy":case"مشغول":case"قيد العمل":return"busy";case"leave":case"إجازة":case"خارج الخدمة":return"leave";case"inactive":case"متوقف":return"inactive";default:return"available"}}function he(e){return e instanceof me}let C=null,He=!1,re=!1,G="",Ie=!1;async function rt({showToastOnError:e=!0}={}){if(!re){re=!0,G="",A();try{await kt(),Ie=!0}catch(t){console.error("❌ [technicians] loadTechniciansFromApi failed",t),G=he(t)?t.message:l("technicians.toast.fetchFailed","تعذر تحميل قائمة الطاقم، حاول تحديث الصفحة"),e&&p(G,"error")}finally{re=!1,A()}}}function ct(){return tt()}function se(e=""){return b(String(e)).trim().toLowerCase()}function Ve(e){return e==null?"":String(e)}function w(e=""){return b(String(e)).replace(/[^0-9+]/g,"")}function V(e=""){const t=b(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function ce(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function Be(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"💾 حفظ التعديل":"➕ إضافة عضو طاقم";t.textContent=l(n,a)}function _e(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=l("technicians.form.actions.cancel","إلغاء التعديل"))}function Ne(){Be(C?"update":"add"),_e(!!C),A()}function Ht(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(s=>(s?.role||"").trim()).filter(Boolean))).sort((s,r)=>s.localeCompare(r,"ar",{sensitivity:"base"})),i=l("technicians.search.filters.allRoles","👔 كل الوظائف");return t.innerHTML=`<option value="">${i}</option>`+a.map(s=>`<option value="${s}">${s}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function be(){const e=document.getElementById("technician-form");if(!e)return;e.reset();const t=document.getElementById("technician-status");t&&(t.value="available"),C=null,Be("add"),_e(!1)}function Vt(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-role"),i=document.getElementById("technician-department"),s=document.getElementById("technician-wage"),r=document.getElementById("technician-status"),u=document.getElementById("technician-notes");!t||!n||!a||!s||!r||(t.value=e.name||"",n.value=w(e.phone||""),a.value=e.role||"",i&&(i.value=e.department||""),s.value=V(e.dailyWage!=null?e.dailyWage:""),r.value=e.baseStatus||e.status||"available",u&&(u.value=e.notes||""),C=String(e.id),Be("update"),_e(!0))}function Xt(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-role"),a=document.getElementById("technician-department"),i=document.getElementById("technician-wage"),s=document.getElementById("technician-status"),r=document.getElementById("technician-notes");if(!e||!t||!n||!i||!s)return null;const u=e.value.trim(),c=w(t.value.trim());t.value=c;const o=n.value.trim(),d=a?.value.trim()||"",f=V(i.value.trim());i.value=f;const g=f===""?0:parseFloat(f),y=s.value||"available",m=r?.value.trim()||"";return u?c?o?Number.isNaN(g)||g<0?(p(l("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),i.focus(),null):{name:u,phone:c,role:o,department:d,dailyWage:Number.isFinite(g)?g:0,status:y,baseStatus:y,notes:m}:(p(l("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),n.focus(),null):(p(l("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),t.focus(),null):(p(l("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),e.focus(),null)}async function Wt(e){e.preventDefault();const t=Xt();if(!t)return;const n=at({name:t.name,phone:t.phone,role:t.role,department:t.department,dailyWage:t.dailyWage,status:t.status,notes:t.notes,active:!0});try{C?(await nt(C,n),p(l("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"))):(await wt(n),p(l("technicians.toast.addSuccess","✅ تم إضافة عضو الطاقم"))),be(),A()}catch(a){console.error("❌ [technicians] handleTechnicianSubmit failed",a);const i=he(a)?a.message:l("technicians.toast.saveFailed","تعذر حفظ بيانات عضو الطاقم، حاول مرة أخرى");p(i,"error")}}function Ot(){be()}function Jt(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=w(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=V(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const i=e.baseStatus||e.status||"available";t.status.value!==i&&(t.status.value=i),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),ce(t.phone,w),ce(t.wage,V)}function Kt(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-role"),i=document.getElementById("edit-technician-department"),s=document.getElementById("edit-technician-wage"),r=document.getElementById("edit-technician-status"),u=document.getElementById("edit-technician-notes");if(!e||!t||!n||!a||!s||!r)return null;const c=e.value.trim(),o=t.value.trim(),d=w(n.value.trim());n.value=d;const f=a.value.trim(),g=i?.value.trim()||"",y=V(s.value.trim());s.value=y;const m=y===""?0:parseFloat(y),v=r.value||"available",E=u?.value.trim()||"";return c?o?d?f?Number.isNaN(m)||m<0?(p(l("technicians.toast.invalidWage","⚠️ أدخل قيمة صحيحة للأجر اليومي")),s.focus(),null):{id:c,name:o,phone:d,role:f,department:g,dailyWage:Number.isFinite(m)?m:0,status:v,baseStatus:v,notes:E}:(p(l("technicians.toast.missingRole","⚠️ يرجى إدخال الوظيفة")),a.focus(),null):(p(l("technicians.toast.missingPhone","⚠️ يرجى إدخال رقم التواصل")),n.focus(),null):(p(l("technicians.toast.missingName","⚠️ يرجى إدخال اسم عضو الطاقم")),t.focus(),null):(p(l("technicians.toast.unidentified","⚠️ تعذر تحديد عضو الطاقم المطلوب")),null)}async function Yt(){const e=Kt();if(!e)return;const t=at({name:e.name,phone:e.phone,role:e.role,department:e.department,dailyWage:e.dailyWage,status:e.status,notes:e.notes,active:!0});try{await nt(e.id,t),p(l("technicians.toast.updateSuccess","💾 تم حفظ بيانات عضو الطاقم"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),A()}catch(n){console.error("❌ [technicians] handleTechnicianModalSave failed",n);const a=he(n)?n.message:l("technicians.toast.updateFailed","تعذر حفظ بيانات عضو الطاقم");p(a,"error")}}function A(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=se(t?.value||"");if(re&&!Ie){const o=l("technicians.table.loading","جاري التحميل...");e.innerHTML=`<tr><td colspan='8' class='text-center text-muted'>${o}</td></tr>`;return}if(G&&!Ie){e.innerHTML=`<tr><td colspan='8' class='text-center text-danger'>${G}</td></tr>`;return}const a=Le(),{reservations:i=[]}=_(),s=new Date;Ht(a);const r=document.getElementById("technician-role-filter"),u=se(r?.value||""),c=a.filter(o=>u&&se(o.role||"")!==u?!1:n?se([o.name,o.phone,o.role,o.department,o.notes].filter(Boolean).join(" ")).includes(n):!0);if(c.length===0){const o=l("technicians.table.empty","لا يوجد أعضاء في الطاقم بعد.");e.innerHTML=`<tr><td colspan='8' class='text-center'>${o}</td></tr>`;return}e.innerHTML=c.map(o=>{const d=C&&String(C)===String(o.id),y=(ot(o.id,i,s)?"busy":o.status||o.baseStatus||"available")==="busy"?{label:l("technicians.status.busy","⛔ مشغول"),className:"badge bg-danger"}:{label:l("technicians.status.available","✅ متاح"),className:"badge bg-success"},m=Number(o.dailyWage),E=(Number.isFinite(m)?m:0).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),h=w(o.phone||""),q=l("technicians.table.wageSuffix","ريال"),N=l("technicians.actions.edit","✏️ تعديل"),J=l("technicians.actions.delete","🗑️ حذف"),L=z(),S=[`<button class="btn btn-sm btn-warning technician-edit-btn" data-id="${o.id}">${N}</button>`];return L&&S.push(`<button class="btn btn-sm btn-danger technician-delete-btn" data-id="${o.id}">${J}</button>`),`
      <tr${d?' class="table-info"':""}>
        <td><a href="technician.html?id=${o.id}" class="text-decoration-none">${o.name}</a></td>
        <td>${h}</td>
        <td>${o.role||""}</td>
        <td>${o.department||"—"}</td>
        <td>${E} ${q}</td>
        <td><span class="${y.className}">${y.label}</span></td>
        <td class="table-notes-cell">${o.notes||"—"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${S.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function Gt(e){const t=ct().find(n=>String(n.id)===String(e));if(!t){p(l("technicians.toast.dataNotFound","⚠️ تعذر العثور على بيانات عضو الطاقم"));return}Vt(t),p(l("technicians.toast.editReady","✏️ يمكنك تعديل بيانات عضو الطاقم الآن ثم الضغط على حفظ التعديل"))}async function Qt(e){if(!z()){ee();return}if(confirm(l("technicians.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العضو؟")))try{await zt(e),p(l("technicians.toast.deleteSuccess","🗑️ تم حذف عضو الطاقم")),C&&String(C)===String(e)&&be(),A()}catch(t){console.error("❌ [technicians] handleDeleteClick failed",t);const n=he(t)?t.message:l("technicians.toast.deleteFailed","تعذر حذف عضو الطاقم، حاول مرة أخرى");p(n,"error")}}function wn(){Ce(),A()}function zn(e){return ct().find(t=>String(t.id)===String(e))||null}function ot(e,t=[],n){const a=Ve(e);return a?t.some(i=>{if(!i||!i.start||!i.end||!(Array.isArray(i.technicians)?i.technicians:[]).some(c=>Ve(c)===a))return!1;const r=new Date(i.start),u=new Date(i.end);return Number.isNaN(r.getTime())||Number.isNaN(u.getTime())?!1:r<=n&&n<u}):!1}function Le(){const e=_().reservations||[],t=tt();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const i=t.map(s=>{if(!s)return s;const r=s.baseStatus||s.status||"available";let u=r==="busy"?"busy":r;return ot(s.id,e,n)&&(u="busy"),(u!==s.status||r!==s.baseStatus)&&(a=!0),{...s,baseStatus:r,status:u}});return a?(te(i),i):t}function Ce(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",u=>{Wt(u).catch(c=>{console.error("❌ [technicians] submit handler failed",c)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ot),n.dataset.listenerAttached="true"),ce(document.getElementById("technician-phone"),w),ce(document.getElementById("technician-wage"),V);const a=document.getElementById("technicians-table");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",u=>{const c=u.target;if(c instanceof HTMLElement){if(c.classList.contains("technician-edit-btn")){const o=c.dataset.id;Gt(o)}if(c.classList.contains("technician-delete-btn")){const o=c.dataset.id;Qt(o).catch(d=>{console.error("❌ [technicians] delete handler failed",d)})}}}),a.dataset.listenerAttached="true");const i=document.getElementById("search-technician-input");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",()=>{i.value=b(i.value),A()}),i.dataset.listenerAttached="true");const s=document.getElementById("technician-role-filter");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{A()}),s.dataset.listenerAttached="true");const r=document.getElementById("save-technician-changes");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{Yt().catch(u=>{console.error("❌ [technicians] modal save failed",u)})}),r.dataset.listenerAttached="true"),He||(document.addEventListener("technician:prefill",u=>{const c=u.detail;c&&Jt(c)}),He=!0),t&&be()}window.addEventListener("DOMContentLoaded",()=>{Ce(),A(),Ne(),rt()});const ut=()=>{A()};window.addEventListener("technicians:updated",ut);document.addEventListener("technicians:updated",ut);document.addEventListener("technicians:refreshRequested",()=>{Ce(),A(),Ne(),rt({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Ne()});document.addEventListener(Ke.USER_UPDATED,()=>{A()});let R=[],$=[],x=[],oe="create",$e=()=>{},xe=()=>{};function Zt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null||n==="")continue;const a=b(String(n)),i=Number.parseFloat(a);if(Number.isFinite(i))return i}return 0}function lt(e={}){const t=Zt(e);if(!Number.isFinite(t)||t<=0)return"—";const n=l("technicians.table.wageSuffix","ريال");return`${b(String(t))} ${n}`}function Xe(e=""){return b(String(e)).trim().toLowerCase()}function dt(e){return!R||!R.length?null:R.find(t=>String(t?.id)===String(e))||null}function en(e,t="create"){t==="edit"?De(x.filter(n=>String(n)!==String(e))):je($.filter(n=>String(n)!==String(e)))}function ue(e,t=[],n){const a=document.getElementById(e);if(a){if(!t||t.length===0){const i=l("reservations.crew.none","لم يتم اختيار أي عضو من الطاقم.");a.innerHTML=`<span class="text-muted">${i}</span>`;return}a.innerHTML=t.map(i=>{const s=dt(i)||{},r=l("reservations.crew.fallbackName","عضو الطاقم {id}").replace("{id}",i),u=s.name||r,c=s.role?`<small class="technician-chip-role">${s.role}</small>`:"",o=lt(s),d=o!=="—"?`<small class="technician-chip-wage">💰 ${o}</small>`:"",f=l("reservations.crew.removeAria","إزالة");return`
        <span class="technician-chip" data-id="${i}">
          <span class="technician-chip-name">${u}</span>
          ${c}
          ${d}
          <button type="button" class="technician-chip-remove" data-context="${n}" data-id="${i}" aria-label="${f}">✖</button>
        </span>
      `}).join(""),a.querySelectorAll(".technician-chip-remove").forEach(i=>{i.dataset.listenerAttached||(i.addEventListener("click",()=>en(i.dataset.id,i.dataset.context)),i.dataset.listenerAttached="true")})}}function mt(){return oe==="edit"?x:$}function le(){const e=document.querySelector("#technician-picker-table tbody");if(!e)return;const t=document.getElementById("technician-picker-search"),n=Xe(t?.value||""),a=new Set(mt().map(String)),s=(R||[]).filter(r=>n?Xe([r.name,r.phone,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(s.length===0){const r=l("reservations.crew.searchEmpty","لا يوجد نتائج مطابقة.");e.innerHTML=`<tr><td colspan="5" class="text-center text-muted">${r}</td></tr>`;return}e.innerHTML=s.map(r=>{const u=lt(r);return`
      <tr>
        <td style="width:40px;">
          <input class="form-check-input technician-picker-checkbox" type="checkbox" value="${r.id}" ${a.has(String(r.id))?"checked":""}>
        </td>
        <td>${r.name||"-"}</td>
        <td>${r.role||"—"}</td>
        <td>${r.department||"—"}</td>
        <td>${u}</td>
      </tr>
    `}).join("")}function tn(){return Array.from(document.querySelectorAll(".technician-picker-checkbox:checked")).map(e=>e.value).filter(Boolean)}function nn(e="create"){if(e==="edit"){const u=document.getElementById("edit-res-start")?.value?.trim(),c=document.getElementById("edit-res-end")?.value?.trim(),o=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",d=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",f=u?ie(u,o):null,g=c?ie(c,d):null;let y=null;const m=document.getElementById("edit-res-index")?.value;if(m!=null){const v=Number.parseInt(m,10);if(Number.isInteger(v)){const{reservations:E=[]}=_(),h=E?.[v];h&&(y=h.id??h.reservationId??null)}}return{start:f,end:g,ignoreReservationId:y}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),a=document.getElementById("res-start-time")?.value?.trim()||"00:00",i=document.getElementById("res-end-time")?.value?.trim()||"00:00",s=t?ie(t,a):null,r=n?ie(n,i):null;return{start:s,end:r,ignoreReservationId:null}}function X(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=mt().length;if(t){const n=l("reservations.crew.selectedCount","تم اختيار {count} عضو").replace("{count}",b(String(t)));e.textContent=n}else e.textContent=l("reservations.crew.noneShort","لم يتم اختيار أي عضو بعد")}function an(){const e=tn().map(String),{start:t,end:n,ignoreReservationId:a}=nn(oe);if(t&&n){const s=e.filter(r=>Mt(r,t,n,a));if(s.length>0){const r=s.map(c=>dt(c)?.name||c).join(l("reservations.list.crew.separator","، ")),u=l("reservations.toast.technicianSelectionConflict","⚠️ لا يمكن اختيار {names} لأنهم مرتبطون بحجز آخر في نفس الفترة الزمنية").replace("{names}",r);s.forEach(c=>{const o=document.querySelector(`.technician-picker-checkbox[value="${CSS.escape(String(c))}"]`);o&&(o.checked=!1)}),p(u),X();return}}oe==="edit"?De(e):je(e),X();const i=document.getElementById("selectTechniciansModal");i&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(i)?.hide?.()}function We(e="create"){oe=e;const t=Le();Array.isArray(t)&&t.length&&(R=t);const n=document.getElementById("technician-picker-search");n&&(n.value=""),le(),X();const a=document.getElementById("selectTechniciansModal");a&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(a).show()}function sn(){const e=document.getElementById("open-technician-picker");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>We("create")),e.dataset.listenerAttached="true");const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>We("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("technician-picker-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{le(),X()}),n.dataset.listenerAttached="true");const a=document.getElementById("apply-technician-selection");a&&!a.dataset.listenerAttached&&(a.addEventListener("click",an),a.dataset.listenerAttached="true");const i=document.getElementById("selectTechniciansModal");i&&!i.dataset.listenerAttached&&window.bootstrap?.Modal&&(i.addEventListener("shown.bs.modal",()=>{X(),le()}),i.addEventListener("hidden.bs.modal",()=>{const s=document.getElementById("technician-picker-search");s&&(s.value="")}),i.dataset.listenerAttached="true"),Fe()}function Fe(){ue("selected-technicians-list",$,"create"),ue("edit-selected-technicians-list",x,"edit")}function Un({onDraftChange:e,onEditChange:t}={}){$e=typeof e=="function"?e:()=>{},xe=typeof t=="function"?t:()=>{},Fe(),sn()}function rn(e=[]){R=Array.isArray(e)?e:[]}function cn(){return[...$]}function on(){return[...x]}function je(e=[]){$=Array.isArray(e)?e.map(String):[],ue("selected-technicians-list",$,"create"),$e()}function De(e=[]){x=Array.isArray(e)?e.map(String):[],ue("edit-selected-technicians-list",x,"edit"),xe()}function Hn(){je([])}function Vn(){De([])}function Xn(e=[]){rn(e);const t=new Set(R.map(u=>String(u.id))),n=$.filter(u=>t.has(String(u))),a=x.filter(u=>t.has(String(u))),i=n.length!==$.length,s=a.length!==x.length;$=n,x=a,Fe(),i&&$e(),s&&xe();const r=document.getElementById("selectTechniciansModal");r&&r.classList.contains("show")&&(le(),X())}function un(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const a=Number(n);if(Number.isFinite(a))return a}return 0}function ln(e=[]){if(!Array.isArray(e)||e.length===0)return 0;const{technicians:t=[]}=_();if(!Array.isArray(t)||t.length===0)return 0;const n=new Map(t.filter(a=>a&&(a.id!=null||a.ID!=null)).map(a=>[String(a.id??a.ID),a]));return e.reduce((a,i)=>{const s=n.get(String(i));return s?a+un(s):a},0)}const dn=1440*60*1e3;function Re(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const i=a.getTime()-n.getTime();if(i<=0)return 1;const s=i/dn;return Math.max(1,Math.ceil(s))}function pt(e=[],t=0,n="percent",a=!1,i=[],{start:s=null,end:r=null}={}){const u=Re(s,r),c=e.reduce((f,g)=>f+(g.qty||1)*(g.price||0),0)*u,o=ln(i);let d=c+o*u;return t&&(n==="percent"?d-=d*(t/100):n==="amount"&&(d-=t)),a&&(d+=d*.15),Math.max(0,Math.round(d))}function ft({total:e,itemsCount:t,rentalDays:n,techniciansCount:a,applyTax:i,paidStatus:s,totalKey:r="reservations.summary.total"}){const u=l("reservations.create.summary.currency","ريال"),c=b(String(e)),o=b(String(t)),d=b(String(n??1)),f=b(String(a)),g=i?l("reservations.summary.taxIncluded","شامل الضريبة 15%"):l("reservations.summary.taxExcluded","غير شامل الضريبة"),y=s==="paid"?l("reservations.create.paymentStatus.paid","مدفوع"):l("reservations.create.paymentStatus.unpaid","غير مدفوع"),m=l(r,"💰 التكلفة الإجمالية: <strong>{total} {currency}</strong>").replace("{total}",c).replace("{currency}",u),v=l("reservations.summary.itemsCount","📦 عدد المعدات: {count}").replace("{count}",o),E=l("reservations.summary.duration","⏱️ عدد الأيام: {count}").replace("{count}",d),h=l("reservations.summary.crewCount","😎 عدد الفريق: {count}").replace("{count}",f),q=l("reservations.summary.paymentLabel","💳 حالة الدفع: {status}").replace("{status}",y);return`
    <div class="alert alert-info">
      ${m}<br>
      ${v}<br>
      ${E}<br>
      ${h}<br>
      ${g}<br>
      ${q}
    </div>
  `}function Wn({selectedItems:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:r}){const u=cn(),c=u.length,o=Re(s,r),d=pt(e,t,n,a,u,{start:s,end:r}),f=ft({total:d,itemsCount:e.length,rentalDays:o,techniciansCount:c,applyTax:a,paidStatus:i});mn(f)}function On({items:e,discount:t,discountType:n,applyTax:a,paidStatus:i,start:s,end:r}){const u=on(),c=u.length,o=Re(s,r),d=pt(e,t,n,a,u,{start:s,end:r});return ft({total:d,itemsCount:e.length,rentalDays:o,techniciansCount:c,applyTax:a,paidStatus:i,totalKey:"reservations.summary.totalAfterEdit"})}function mn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e);const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e)}function Jn(e=""){return b(String(e)).trim().toLowerCase()}function Kn(e){if(!e?.end)return!1;const t=new Date(e.end);return Number.isNaN(t.getTime())?!1:t<new Date}function pn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";case"pending":case"draft":case"قيد الانتظار":case"بانتظار التأكيد":case"معلق":default:return"pending"}}function fn(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",a=e?.projectId??e?.project_id??null,i=a!=null&&a!==""&&a!=="null",s=i?pn(t?.status??t?.status_label??t?.statusLabel??""):null,r=i&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(s));return{reservationConfirmed:n,projectLinked:i,projectStatus:s,projectConfirmed:r,effectiveConfirmed:i?r:n}}const gn=_()||{};let M=(gn.reservations||[]).map(En);function Q(){return M}function ve(e){return M=Array.isArray(e)?e.map(Pe):[],Z({reservations:M}),M}async function yn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,r])=>{r!=null&&r!==""&&t.set(s,String(r))});const n=t.toString(),a=await I(`/reservations/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(Me):[];return ve(i)}async function Yn(e){const t=await I("/reservations/",{method:"POST",body:e}),n=Me(t?.data??{});return ve([...M,n]),n}async function hn(e,t){const n=await I(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Me(n?.data??{}),i=M.map(s=>String(s.id)===String(e)?a:s);return ve(i),a}async function bn(e){await I(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=M.filter(n=>String(n.id)!==String(e));ve(t)}async function vn(e){return hn(e,{status:"confirmed",confirmed:!0})}function Me(e={}){return Pe({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,technicians:e.technicians})}function En(e={}){return Pe(e)}function Pe(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null),a=Array.isArray(e.items)?e.items.map(Sn):[],i=Array.isArray(e.technicians)?e.technicians:[],s=i.map(m=>m==null?null:String(typeof m=="object"?m.id??m.technician_id??m.technicianId??m.ID??"":m)).filter(m=>m&&m!==""),r=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"",c=de(e.total_amount??e.totalAmount??e.cost??0),o=de(e.discount??0),d=e.discount_type??e.discountType??"percent",f=!!(e.apply_tax??e.applyTax??!1),g=qn(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid",y=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase());return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:u,status:In(e.status??(y?"confirmed":"pending")),confirmed:y,location:e.location??"",notes:e.notes??"",discount:o,discountType:["percent","amount"].includes(d)?d:"percent",applyTax:f,paid:g==="paid",paidStatus:g,totalAmount:c,cost:c,projectId:e.project_id??e.projectId??null,items:a,technicians:s,techniciansDetails:i.map(m=>typeof m=="object"?m:{id:Number(m)||m}),startDatetime:r,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null}}function Sn(e={}){const t=e.equipment_id??e.equipmentId??e.id??e.item_id??null,n=gt(e.quantity??e.qty??1),a=de(e.unit_price??e.price??0);return{id:t!=null?String(t):"",equipmentId:t,barcode:b(String(e.barcode??e.code??"")),desc:e.description??e.desc??e.name??"",qty:n,price:a,notes:e.notes??null,image:e.image??e.image_url??null}}function Gn({reservationCode:e,customerId:t,start:n,end:a,status:i,title:s,location:r,notes:u,projectId:c,totalAmount:o,discount:d,discountType:f,applyTax:g,paidStatus:y,confirmed:m,items:v,technicians:E}){return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:a,status:i??"pending",title:s??null,location:r??null,notes:u??null,project_id:c||null,total_amount:o??0,discount:d??0,discount_type:f??"percent",apply_tax:g?1:0,paid_status:y??"unpaid",confirmed:m===void 0?null:!!m,items:Array.isArray(v)?v.map(h=>({equipment_id:h.equipmentId??h.equipment_id??h.id,quantity:gt(h.qty??h.quantity??1),unit_price:de(h.price??h.unit_price??0),notes:h.notes??null})):[],technicians:Array.isArray(E)?E.map(h=>typeof h=="object"&&h!==null?{id:h.id??h.technician_id??h.technicianId??h.ID,role:h.role??null,notes:h.notes??null}:Number.isNaN(Number(h))?String(h):Number(h)):[]}}function de(e){const t=Number(b(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function gt(e){const t=Number.parseInt(b(String(e??"1")),10);return!Number.isFinite(t)||t<=0?1:t}function In(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"معلق":case"قيد الانتظار":return"pending";case"confirmed":case"مؤكد":return"confirmed";case"in_progress":case"in-progress":case"قيد التنفيذ":case"جاري":return"in_progress";case"completed":case"مكتمل":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return"pending"}}function qn(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"مدفوع":return"paid";case"partial":case"مدفوع جزئياً":case"partial_paid":return"partial";case"unpaid":case"غير مدفوع":case"not_paid":default:return"unpaid"}}function yt(e){return e instanceof me}function ht(){const e=()=>{Qe(),Le()};if(typeof window<"u"){if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(e,{timeout:200});return}if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(e);return}}e()}let Oe=!1,Je=null;function An(e){if(!e||typeof e!="object")return"";const t=Object.entries(e).filter(([n,a])=>a!=null).map(([n,a])=>[n,String(a)]);return t.length===0?"":JSON.stringify(t.sort(([n],[a])=>n.localeCompare(a)))}async function Qn(e={}){const{suppressError:t=!0,params:n=null,force:a=!1}=e??{},i=An(n);if(!a&&Oe&&Q().length>0&&i===Je)return Q();try{const s=await yn(n||{});return Oe=!0,Je=i,s}catch(s){if(console.error("❌ [reservationsActions] Failed to load reservations from API",s),!t)throw s;return Q()}}async function Zn(e,{onAfterChange:t}={}){if(!z())return ee(),!1;const a=Q()[e];if(!a)return p(l("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const i=a.id||a.reservationId;if(!i)return p(l("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;try{return await bn(i),ht(),t?.({type:"deleted",reservation:a}),p(l("reservations.toast.deleted","🗑️ تم حذف الحجز")),!0}catch(s){console.error("❌ [reservationsActions] deleteReservation failed",s);const r=yt(s)?s.message:l("reservations.toast.deleteFailed","تعذر حذف الحجز، حاول مرة أخرى");return p(r,"error"),!1}}async function ea(e,{onAfterChange:t}={}){const a=Q()[e];if(!a)return p(l("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const i=a.id||a.reservationId;if(!i)return p(l("reservations.toast.notFound","⚠️ تعذر العثور على بيانات الحجز")),!1;const{projectLinked:s}=fn(a);if(s)return p(l("reservations.toast.confirmBlockedByProject","⚠️ حالة هذا الحجز تتحكم بها حالة المشروع المرتبط ولا يمكن تأكيده من هنا"),"info"),!1;try{const r=await vn(i);return ht(),t?.({type:"confirmed",reservation:r}),p(l("reservations.toast.confirmed","✅ تم تأكيد الحجز")),!0}catch(r){console.error("❌ [reservationsActions] confirmReservation failed",r);const u=yt(r)?r.message:l("reservations.toast.confirmFailed","تعذر تأكيد الحجز، حاول مرة أخرى");return p(u,"error"),!1}}const Tn=_()||{};let T=(Tn.projects||[]).map(_n),ne=!1;function ta(){return T}function Ee(e){return T=Array.isArray(e)?e.map(we):[],Z({projects:T}),T}async function Bn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,r])=>{r==null||r===""||t.set(s,String(r))});const n=t.toString(),a=await I(`/projects/${n?`?${n}`:""}`),i=Array.isArray(a?.data)?a.data.map(ke):[];return Ee(i),ne=!0,T}async function na({force:e=!1,params:t=null}={}){if(!e&&ne&&T.length>0)return T;try{return await Bn(t||{})}catch(n){return console.error("❌ [projectsService] Failed to load projects from API",n),T}}async function aa(e){const t=await I("/projects/",{method:"POST",body:e}),n=ke(t?.data??{}),a=[...T,n];return Ee(a),ne=!0,n}async function ia(e,t){const n=await I(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=ke(n?.data??{}),i=T.map(s=>String(s.id)===String(e)?a:s);return Ee(i),ne=!0,a}async function sa(e){await I(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=T.filter(n=>String(n.id)!==String(e));Ee(t),ne=!0}function ra({projectCode:e,title:t,type:n,clientId:a,clientCompany:i,description:s,start:r,end:u,applyTax:c,paymentStatus:o,equipmentEstimate:d=0,expenses:f=[],taxAmount:g=0,totalWithTax:y=0,confirmed:m=!1,technicians:v=[],equipment:E=[]}={}){const h=Array.isArray(v)?v.map(S=>Number.parseInt(String(S),10)).filter(S=>Number.isInteger(S)&&S>0):[],q=Array.isArray(E)?E.map(S=>{const j=Number.parseInt(String(S.equipmentId??S.equipment_id??S.id??0),10),U=Number.parseInt(String(S.qty??S.quantity??0),10);return!Number.isInteger(j)||j<=0?null:{equipment_id:j,quantity:Number.isInteger(U)&&U>0?U:1}}).filter(Boolean):[],N=Array.isArray(f)?f.map(S=>{const j=Number.parseFloat(S?.amount??S?.value??0)||0,U=(S?.label??S?.name??"").trim();return U?{label:U,amount:Math.round(j*100)/100}:null}).filter(Boolean):[],J=N.reduce((S,j)=>S+(j?.amount??0),0),L={title:t,type:n,client_id:a?Number.parseInt(String(a),10):null,client_company:i??null,description:s??null,start_datetime:r??null,end_datetime:u||null,apply_tax:!!c,payment_status:o??"unpaid",equipment_estimate:Number.parseFloat(d)||0,expenses_total:Math.round(J*100)/100,tax_amount:Math.round((Number.parseFloat(g)||0)*100)/100,total_with_tax:Math.round((Number.parseFloat(y)||0)*100)/100,confirmed:!!m,technicians:h,equipment:q,expenses:N};return e&&(L.project_code=String(e).trim()),L.end_datetime||delete L.end_datetime,L.client_company||(L.client_company=null),L}function ke(e={}){return we(e)}function _n(e={}){return we(e)}function we(e={}){const t=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],a=n.map(c=>{if(c==null)return null;if(typeof c=="object"){const o=c.id??c.technician_id??c.technicianId;return o!=null?String(o):null}return String(c)}).filter(Boolean),s=(Array.isArray(e.equipment)?e.equipment:[]).map(c=>{const o=c?.equipment_id??c?.equipmentId??c?.id??null,d=c?.quantity??c?.qty??0,f=c?.barcode??c?.code??"",g=c?.description??c?.name??"";return{equipmentId:o!=null?String(o):null,qty:Number.parseInt(String(d),10)||0,barcode:f,description:g}}),u=(Array.isArray(e.expenses)?e.expenses:[]).map((c,o)=>({id:c?.id??`expense-${t??"x"}-${o}`,label:c?.label??"",amount:Number.parseFloat(c?.amount??0)||0}));return{id:t!=null?String(t):"",projectId:t!=null?Number(t):null,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:Number.parseFloat(e.equipment_estimate??e.equipmentEstimate??0)||0,expensesTotal:Number.parseFloat(e.expenses_total??e.expensesTotal??0)||0,taxAmount:Number.parseFloat(e.tax_amount??e.taxAmount??0)||0,totalWithTax:Number.parseFloat(e.total_with_tax??e.totalWithTax??0)||0,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:n.map(c=>typeof c=="object"?c:{id:c}),equipment:s,expenses:u}}function ca(e){return e instanceof me}export{On as $,sa as A,Bn as B,yn as C,ca as D,aa as E,ze as F,jn as G,Dn as H,Fn as I,Cn as J,kn as K,xn as L,Wn as M,ie as N,cn as O,Mt as P,Gn as Q,Yn as R,Qe as S,Pn as T,Rn as U,Hn as V,$n as W,Mn as X,De as Y,on as Z,Vn as _,Te as a,Zn as a0,ea as a1,Me as b,Re as c,Kn as d,Qn as e,ye as f,Q as g,B as h,yt as i,wn as j,ra as k,ia as l,En as m,ke as n,zn as o,kt as p,pt as q,fn as r,Le as s,hn as t,Ln as u,na as v,Un as w,Xn as x,Jn as y,ta as z};
