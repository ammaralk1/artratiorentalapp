import{t as I,p as de,n as h,j as R,d as pe,b as ze,h as Xt,A as Zt}from"./auth.BLFzWQsL.js";import{r as It,i as en,D as Xe,s as tn,k as nn,P as an,u as $e,E as Pt,j as on,O as Ze,G as ye,H as me,b as _e,I as At,J as cn}from"./state.BK2rhNHf.js";const sn=()=>I("reservations.create.summary.currency","SR");let Ie=[],te=[],se=[],re=[],M="create",Ct=()=>{},St=()=>{};const De=new Map,Ue=450;function rn(e){const t=De.get(e);return t!=null&&Date.now()-t<Ue}function ln(e){De.set(e,Date.now()),setTimeout(()=>{const t=De.get(e);t!=null&&Date.now()-t>=Ue&&De.delete(e)},Ue+50)}function qe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`crew-assignment-${Date.now()}-${Math.random().toString(16).slice(2)}`}function be(e={}){return{...e,assignmentId:e.assignmentId||qe()}}function Me(e){if(!e)return null;const t=String(e),n=Ie.find(c=>String(c?.id)===t);if(n)return{...n};const{technicians:i=[]}=pe();return i.find(c=>String(c?.id)===t)||null}function Pe(e={},t=de()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function et(e={},t=de()){return e?t==="ar"?e.labelEn||e.name||"":e.labelAr||e.name||"":""}function vt(e,t=""){if(!e)return null;if(typeof e=="object")return e;const n=String(e).trim().toLowerCase();if(!n)return null;const i=te.find(o=>String(o.id).trim().toLowerCase()===n);if(i)return i;const c=on(e);return c||{id:null,name:t||n,labelAr:t||n,labelEn:t||n,cost:0,clientPrice:0}}function ut(e){const t=vt(e,e?.name??""),n=de(),i=Pe(t,n)||t?.name||"",c=et(t,n);return Ge({assignmentId:qe(),positionId:t?.id??null,positionKey:t?.name??null,positionLabel:i,positionLabelAlt:c,positionCost:Number.isFinite(t?.cost)?Number(t.cost):0,positionClientPrice:Number.isFinite(t?.clientPrice)?Number(t.clientPrice):0,technicianId:null,technicianName:null,technicianRole:null})}function Ge(e={}){const t={assignmentId:e.assignmentId||qe(),positionId:e.positionId??e.position_id??null,positionKey:e.positionKey??e.position_name??e.positionName??e.position??null,positionLabel:e.positionLabel??e.position_label??e.position_name??e.role??e.position??"",positionLabelAlt:e.positionLabelAlt??e.position_label_alt??"",positionCost:Number.isFinite(Number(e.positionCost))?Number(e.positionCost):Number.isFinite(Number(e.position_cost))?Number(e.position_cost):0,positionClientPrice:Number.isFinite(Number(e.positionClientPrice))?Number(e.positionClientPrice):Number.isFinite(Number(e.position_client_price))?Number(e.position_client_price):0,technicianId:e.technicianId??e.technician_id??e.id??e.userId??null,technicianName:e.technicianName??e.technician_name??e.name??null,technicianRole:e.technicianRole??e.role??null},n=vt(t.positionId??t.positionKey??t.positionLabel,t.positionLabel);if(n){t.positionId=n.id??t.positionId;const i=de(),c=Pe(n,i)||t.positionLabel,o=et(n,i);t.positionLabel=c||t.positionLabel||n?.name||"",t.positionLabelAlt=o||t.positionLabelAlt||"",(t.positionCost==null||!Number.isFinite(t.positionCost)||t.positionCost===0)&&(t.positionCost=Number.isFinite(n?.cost)?Number(n.cost):t.positionCost),(t.positionClientPrice==null||!Number.isFinite(t.positionClientPrice)||t.positionClientPrice===0)&&(t.positionClientPrice=Number.isFinite(n?.clientPrice)?Number(n.clientPrice):t.positionClientPrice)}if(t.technicianId!=null){const i=Me(t.technicianId);i?(t.technicianId=String(i.id),t.technicianName=i.name??t.technicianName??null,t.technicianRole=i.role??t.technicianRole??null,t.technicianPhone=i.phone??null):(t.technicianId=String(t.technicianId),t.technicianName=t.technicianName??null)}else t.technicianId=null,t.technicianName=null,t.technicianPhone=null;return t.positionCost=Number.isFinite(t.positionCost)?Number(t.positionCost):0,t.positionClientPrice=Number.isFinite(t.positionClientPrice)?Number(t.positionClientPrice):0,t}function he(){te=en()}function un(e=[]){return Array.isArray(e)?e.map(t=>{if(t==null)return null;if(t&&typeof t=="object")return be(Ge(t));const n=Me(t),i=n?{assignmentId:qe(),positionLabel:n.role||I("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:Number.isFinite(n.dailyWage)?Number(n.dailyWage):0,positionClientPrice:Number.isFinite(n.dailyTotal)?Number(n.dailyTotal):0,technicianId:n.id,technicianName:n.name,technicianRole:n.role}:{assignmentId:qe(),positionLabel:I("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),positionCost:0,positionClientPrice:0,technicianId:t!=null?String(t):null,technicianName:null};return be(Ge(i))}).filter(Boolean):[]}function fe(e="create"){return e==="edit"?re.map(be):se.map(be)}function ae(e="create",t=[]){try{he()}catch{}const n=un(t);e==="edit"?(re=n,Ae("edit-selected-technicians-list",re,"edit"),St()):(se=n,Ae("selected-technicians-list",se,"create"),Ct()),Fe()}function je(e="create"){if(e==="edit"){const a=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-end")?.value?.trim(),r=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",d=a?$e(a,r):null,m=l?$e(l,u):null;let _=null;const g=document.getElementById("edit-res-index")?.value;if(g!=null){const y=Number.parseInt(g,10);if(Number.isInteger(y)){const{reservations:k=[]}=pe(),p=k?.[y];p&&(_=p.id??p.reservationId??null)}}return{start:d,end:m,ignoreReservationId:_}}const t=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),i=document.getElementById("res-start-time")?.value?.trim()||"00:00",c=document.getElementById("res-end-time")?.value?.trim()||"00:00",o=t?$e(t,i):null,s=n?$e(n,c):null;return{start:o,end:s,ignoreReservationId:null}}function Fe(){const e=document.getElementById("technician-picker-selection-info");if(!e)return;const t=fe(M).length;if(t){const n=I("technicians.picker.selectedCount","Selected {count} member(s)").replace("{count}",h(String(t)));e.textContent=n}else e.textContent=I("technicians.picker.selectionInfo","No crew selected yet")}function xe(e){const t=Number.isFinite(e)?e:0;return`${h(t.toFixed(2))} ${sn()}`}function dn(e){const t=fe(M),n=new Set(t.filter(r=>r.assignmentId!==e&&r.technicianId).map(r=>r.technicianId)),i=Ie.length?Ie:pe().technicians||[],{start:c,end:o,ignoreReservationId:s}=je(M),a=!!(c&&o);return i.map(r=>{const u=String(r.id),d=n.has(u),m=a?Xe(u,c,o,s):!1,_=h(r.name||r.full_name||r.fullName||r.email||u);return{id:u,label:_,disabled:d||m,conflict:m,taken:d}})}function Y(){const e=document.querySelector("#crew-assignment-table tbody");if(!e)return;const t=fe(M);if(!t.length){const n=I("technicians.picker.noAssignments","Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯"),i=I("technicians.picker.assignments.hint","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ØµØ¨ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„.");e.innerHTML=`
      <tr class="crew-assignment-empty-row">
        <td colspan="5">
          <div class="crew-assignment-empty">
            <span class="crew-assignment-empty-icon" aria-hidden="true">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <p class="crew-assignment-empty-text">${n}</p>
            <p class="crew-assignment-empty-hint text-muted">${i}</p>
          </div>
        </td>
      </tr>
    `;return}he(),e.innerHTML=t.map((n,i)=>{const c=h(String(i+1)),o=xe(n.positionClientPrice||0),s=dn(n.assignmentId),a=I("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”"),l=n.technicianId!=null?String(n.technicianId):"",r=n.technicianName?h(n.technicianName):"",u=`crew-assignment-options-${n.assignmentId}`,d=I("technicians.picker.optionAssigned","(Ù…Ø³ØªØ®Ø¯Ù…)"),m=I("technicians.picker.optionConflicting","(Ù…ØªØ¹Ø§Ø±Ø¶)"),_=s.map(b=>{const N=l===b.id,A=b.disabled&&!N?`${b.label} ${b.conflict?m:d}`:b.label;return`
        <option value="${b.label}"
                data-id="${b.id}"
                data-disabled="${b.disabled?"true":"false"}"
                data-conflict="${b.conflict?"true":"false"}"
                data-taken="${b.taken?"true":"false"}"
                label="${A}"></option>
      `}).join("");let g=n.positionLabel??n.position_label??n.position_name??n.role??n.position??"";if(!g||String(g).trim()===""){const b=n.positionId?te.find(P=>String(P.id)===String(n.positionId)):null,N=!b&&n.positionKey?te.find(P=>String(P.name).toLowerCase()===String(n.positionKey).toLowerCase()):null;if(b||N){const P=b||N;g=Pe(P,de())||P?.name||""}}const y=n.positionLabelAlt?`<div class="text-muted small">${h(n.positionLabelAlt)}</div>`:"",k=I("technicians.picker.actions.remove","Ø¥Ø²Ø§Ù„Ø©"),p=I("technicians.picker.assignments.price","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„");return`
      <tr data-assignment-id="${n.assignmentId}" class="crew-assignment-row">
        <td class="crew-assignment-cell-index">
          <span class="crew-assignment-index-badge">${c}</span>
        </td>
        <td class="crew-assignment-cell-position">
          <div class="crew-assignment-position-card">
            <div class="crew-assignment-position">${h(g||I("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"))}</div>
            ${y}
          </div>
        </td>
        <td class="crew-assignment-cell-price">
          <div class="crew-assignment-price-chip" aria-label="${p}">${o}</div>
        </td>
        <td class="crew-assignment-cell-member">
          <div class="crew-assignment-autocomplete-wrapper">
            <input
              type="text"
              class="form-control crew-assignment-autocomplete"
              list="${u}"
              data-assignment-id="${n.assignmentId}"
              placeholder="${a}"
              value="${l?r:""}"
              aria-label="${I("technicians.picker.assignments.member","Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")}"
              autocomplete="off"
            />
            <datalist id="${u}">
              ${_}
            </datalist>
          </div>
        </td>
        <td class="crew-assignment-cell-actions">
          <button type="button" class="btn btn-sm btn-outline-danger crew-assignment-remove" data-assignment-id="${n.assignmentId}" aria-label="${k}">
            ${k}
          </button>
        </td>
      </tr>
    `}).join(""),e.querySelectorAll(".crew-assignment-remove").forEach(n=>{n.dataset.listenerAttached||(n.addEventListener("click",()=>{qt(n.dataset.assignmentId,M)}),n.dataset.listenerAttached="true")}),pn(e)}function pn(e){e.querySelectorAll(".crew-assignment-autocomplete").forEach(n=>{if(n.dataset.listenerAttached)return;const i=n.dataset.assignmentId,c=()=>{mn(n,i)};n.addEventListener("change",c),n.addEventListener("blur",c),n.dataset.listenerAttached="true"})}function mn(e,t){if(!t||rn(t))return;ln(t);const n=e.value?.trim()??"";if(!n){we(t,"");return}const i=e.getAttribute("list"),c=i?document.getElementById(i):null,o=c?Array.from(c.options):[],s=h(n).toLowerCase(),a=o.find(r=>h(r.value).toLowerCase()===s);if(!a){R(I("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(t,"");return}if(a.dataset.disabled==="true"){if(a.dataset.conflict==="true")try{const{start:r,end:u,ignoreReservationId:d}=je(M),m=a.dataset.id||"",_=r&&u&&m?Pt(String(m),r,u,d):[],g=I("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),y=_&&_.length?`: ${_.join("ØŒ ")}`:"";R(`${g}${y}`,"warning",6e3)}catch{R(I("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}else R(I("technicians.picker.optionTaken","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø£Ù†Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù†ØµØ¨ Ø¢Ø®Ø±"));e.value="";return}const l=a.dataset.id;if(!l){R(I("technicians.picker.toast.autocompleteNoMatch","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†ÙŠ Ù…Ø·Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")),e.value="",we(t,"");return}we(t,l)}function Re(){const e=document.getElementById("crew-position-list");if(!e)return;he();const t=document.getElementById("crew-position-search"),n=h(String(t?.value||"")).trim().toLowerCase(),c=fe(M).reduce((a,l)=>{const r=l?.positionId!=null?String(l.positionId):null;return r&&a.set(r,(a.get(r)||0)+1),a},new Map),o=te.filter(a=>n?[a.labelAr,a.labelEn,a.name].filter(Boolean).map(r=>h(String(r)).toLowerCase()).join(" ").includes(n):!0);if(!o.length){e.innerHTML=`<div class="text-muted">${I("technicians.picker.noPositions","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©.")}</div>`;return}const s=de();e.innerHTML=o.map(a=>{const l=Pe(a,s)||a.name||"",r=et(a,s),u=xe(a.clientPrice||0),d=xe(a.cost||0),m=r?`<span class="crew-position-card__subtitle">${h(r)}</span>`:"",_=I("technicians.picker.positionCostLabel","Ø§Ù„ØªÙƒÙ„ÙØ©"),g=I("technicians.picker.positionClientPriceLabel","Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„"),y=I("technicians.picker.actions.addPosition","Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨"),k=c.get(String(a.id))||0,p=I("technicians.picker.positionCountBadge","Ù…Ø¶Ø§Ù Ã—{count}").replace("{count}",h(String(k)));return`
      <article class="crew-position-card" data-position-id="${a.id}" tabindex="0" role="button" aria-label="${h(l)}">
        ${k>0?`<span class="crew-position-card__badge" aria-label="${p}">${h(String(k))}</span>`:""}
        <header class="crew-position-card__header">
          <span class="crew-position-card__icon" aria-hidden="true">ğŸ¯</span>
          <div class="crew-position-card__titles">
            <h6 class="crew-position-card__title">${h(l)}</h6>
            ${m}
          </div>
        </header>
        <div class="crew-position-card__metrics">
          <div class="crew-position-card__metric">
            <span class="crew-position-card__metric-label">${_}</span>
            <span class="crew-position-card__metric-value">${d}</span>
          </div>
          <div class="crew-position-card__metric crew-position-card__metric--accent">
            <span class="crew-position-card__metric-label">${g}</span>
            <span class="crew-position-card__metric-value">${u}</span>
          </div>
        </div>
        <div class="crew-position-card__edit" hidden>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">${_}</label>
              <input type="text" class="form-control crew-position-edit-cost" value="${h(String(a.cost??0))}" inputmode="decimal">
            </div>
            <div class="col-6">
              <label class="form-label">${g}</label>
              <input type="text" class="form-control crew-position-edit-client" value="${a.clientPrice==null?"":h(String(a.clientPrice))}" inputmode="decimal" placeholder="${h("")}"/>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-primary btn-sm crew-position-save-btn" data-position-id="${a.id}">${I("positions.form.actions.update","ğŸ’¾ Ø­ÙØ¸")}</button>
            <button type="button" class="btn btn-outline btn-sm crew-position-cancel-btn" data-position-id="${a.id}">${I("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡")}</button>
          </div>
        </div>
        <footer class="crew-position-card__footer">
          <button type="button" class="btn btn-primary btn-sm crew-position-add-btn" data-position-id="${a.id}">
            ${y}
          </button>
          <button type="button" class="btn btn-outline btn-sm crew-position-edit-btn ms-2" data-position-id="${a.id}">
            ${I("technicians.picker.actions.editPosition","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")}
          </button>
        </footer>
      </article>
    `}).join(""),e.querySelectorAll(".crew-position-add-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.stopPropagation(),Ke(a.dataset.positionId)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-card").forEach(a=>{a.dataset.cardListenerAttached||(a.addEventListener("click",()=>{a.dataset.editing!=="true"&&Ke(a.dataset.positionId)}),a.addEventListener("keydown",l=>{if(l.key==="Enter"||l.key===" "){if(l.preventDefault(),a.dataset.editing==="true")return;Ke(a.dataset.positionId)}}),a.dataset.cardListenerAttached="true")}),e.querySelectorAll(".crew-position-edit-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const r=a.closest(".crew-position-card");if(!r)return;const u=r.querySelector(".crew-position-card__metrics"),d=r.querySelector(".crew-position-card__footer"),m=r.querySelector(".crew-position-card__edit");u&&u.classList.add("d-none"),d&&d.classList.add("d-none"),m&&(m.hidden=!1),r.dataset.editing="true";const _=r.querySelector(".crew-position-edit-cost"),g=r.querySelector(".crew-position-edit-client"),y=k=>{k.addEventListener("input",p=>{const N=h(p.target.value).replace(/[^0-9.]/g,"");if(N!==p.target.value){const P=p.target.selectionEnd||N.length;p.target.value=N,p.target.setSelectionRange(P,P)}},{once:!0})};_&&y(_),g&&y(g)}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-save-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();const r=a.closest(".crew-position-card"),u=a.dataset.positionId;if(!(!r||!u))try{const d=r.querySelector(".crew-position-edit-cost"),m=r.querySelector(".crew-position-edit-client"),_=h(d?.value||"").trim(),g=h(m?.value||"").trim(),y=_===""?0:Number.parseFloat(_),k=g===""?null:Number.parseFloat(g);if(!Number.isFinite(y)||y<0){R(I("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),d?.focus();return}if(k!=null&&(!Number.isFinite(k)||k<0)){R(I("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),m?.focus();return}he();const p=te.find(b=>String(b.id)===String(u));if(!p){R(I("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}await an(u,{name:p.name,cost:Number(y.toFixed(2)),clientPrice:k==null?null:Number(k.toFixed(2)),labelAr:p.labelAr,labelEn:p.labelEn}),R(I("positions.toast.saveSuccess","âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨")),Re(),Y()}catch(d){console.error("âŒ [crew-picker] update position failed",d);const m=d?.message||I("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");R(m,"error")}}),a.dataset.listenerAttached="true")}),e.querySelectorAll(".crew-position-cancel-btn").forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const r=a.closest(".crew-position-card");if(!r)return;const u=r.querySelector(".crew-position-card__metrics"),d=r.querySelector(".crew-position-card__footer"),m=r.querySelector(".crew-position-card__edit");u&&u.classList.remove("d-none"),d&&d.classList.remove("d-none"),m&&(m.hidden=!0),delete r.dataset.editing}),a.dataset.listenerAttached="true")})}function Ke(e){he();const t=te.find(c=>String(c.id)===String(e)),n=ut(t||{id:null,name:""}),i=fe(M);i.push(n),ae(M,i),Y(),R(I("technicians.picker.toast.positionAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),"success")}function qt(e,t="create"){if(!e)return;const n=fe(t).filter(i=>i.assignmentId!==e);ae(t,n),Y(),R(I("technicians.picker.toast.positionRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"))}function we(e,t){if(!e)return;const n=fe(M),i=n.find(r=>r.assignmentId===e);if(!i)return;if(!t){i.technicianId=null,i.technicianName=null,i.technicianRole=null,ae(M,n),Y(),R(I("technicians.picker.toast.assignmentCleared","â„¹ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"));return}if(n.find(r=>r.assignmentId!==e&&r.technicianId===t)){R(I("technicians.picker.duplicateTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ù„Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ø²")),Y();return}const o=Me(t),{start:s,end:a,ignoreReservationId:l}=je(M);if(s&&a&&Xe(String(t),s,a,l)){try{const r=Pt(String(t),s,a,l),u=I("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),d=r&&r.length?`: ${r.join("ØŒ ")}`:"";R(`${u}${d}`,"warning",6e3)}catch{R(I("technicians.picker.optionConflict","âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¯ÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯"),"warning",-1)}Y();return}o?(i.technicianId=String(o.id),i.technicianName=o.name??null,i.technicianRole=o.role??null,i.technicianPhone=o.phone??null):(i.technicianId=String(t),i.technicianName=null,i.technicianRole=null,i.technicianPhone=null),ae(M,n),Y(),i.technicianName?R(I("technicians.picker.toast.assignmentApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {name} Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨").replace("{name}",h(i.technicianName)),"success"):R(I("technicians.picker.toast.assignmentIdApplied","âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨"),"success")}async function dt(e="create"){M=e,Y(),Fe();let t=tn();if(!Array.isArray(t)||t.length===0)try{const i=await It();t=Array.isArray(i)?i:[]}catch(i){console.warn("[reservations/crew] technicians fetch failed, falling back to stored list",i)}Array.isArray(t)&&(Ie=t);try{await nn()}catch(i){console.warn("[reservations/crew] failed to load positions",i)}he(),Re(),Y(),Fe();const n=document.getElementById("selectTechniciansModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(n).show()}function fn(){return fe(M).map(be)}function gn(){const e=fn(),{start:t,end:n,ignoreReservationId:i}=je(M);if(t&&n){const o=e.filter(s=>s.technicianId&&Xe(s.technicianId,t,n,i));if(o.length>0){const s=o.map(l=>l.technicianName||l.technicianId).join(I("reservations.list.crew.separator","ØŒ ")),a=I("reservations.toast.technicianSelectionConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± {names} Ù„Ø£Ù†Ù‡Ù… Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©").replace("{names}",s);o.forEach(l=>{l.technicianId=null,l.technicianName=null}),ae(M,e),Y(),R(a),Fe();return}}ae(M,e);const c=document.getElementById("selectTechniciansModal");c&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(c)?.hide?.(),R(I("technicians.picker.toast.selectionApplied","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­"),"success")}function Ae(e,t=[],n="create"){const i=document.getElementById(e);if(i){if(!t.length){i.innerHTML=`<span class="text-muted">${I("reservations.crew.none","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù….")}</span>`;return}he(),i.innerHTML=t.map(c=>{let o=c.positionLabel??c.position_label??c.position_name??c.role??c.position??"";if(!o||String(o).trim()===""){const d=c.positionId?te.find(_=>String(_.id)===String(c.positionId)):null,m=!d&&c.positionKey?te.find(_=>String(_.name).toLowerCase()===String(c.positionKey).toLowerCase()):null;o=d?Pe(d,de())||d?.name||"":m&&(Pe(m,de())||m?.name)||""}const s=h(o||I("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")),a=c.technicianName?`${h(c.technicianName)}`:I("technicians.picker.noTechnicianOption","â€” Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† â€”");let l=Number(c.positionClientPrice);if(!Number.isFinite(l)||l<=0){const d=[c.position_client_price,c.client_price,c.customer_price,c.daily_total,c.dailyTotal,c.total];for(const m of d){const _=Number(m);if(Number.isFinite(_)&&_>0){l=_;break}}}if((!Number.isFinite(l)||l<=0)&&(c.positionId||c.positionKey)){const d=c.positionId?te.find(g=>String(g.id)===String(c.positionId)):null,m=!d&&c.positionKey?te.find(g=>String(g.name).toLowerCase()===String(c.positionKey).toLowerCase()):null,_=d||m||null;_&&Number.isFinite(Number(_.clientPrice))&&(l=Number(_.clientPrice))}const r=xe(Number.isFinite(l)&&l>0?l:0),u=I("reservations.crew.removeAria","Ø¥Ø²Ø§Ù„Ø©");return`
      <span class="technician-chip" data-assignment-id="${c.assignmentId}">
        <span class="technician-chip-name">${s}</span>
        <small class="technician-chip-role">${a}</small>
        <small class="technician-chip-wage">ğŸ’¼ ${r}</small>
        <button type="button" class="technician-chip-remove" data-context="${n}" data-assignment-id="${c.assignmentId}" aria-label="${u}">âœ–</button>
      </span>
    `}).join(""),i.querySelectorAll(".technician-chip-remove").forEach(c=>{c.dataset.listenerAttached||(c.addEventListener("click",()=>{qt(c.dataset.assignmentId,c.dataset.context)}),c.dataset.listenerAttached="true")})}}function _n(){const e=document.getElementById("open-technician-picker");if(e&&!e.dataset.listenerAttached){e.addEventListener("click",s=>{const a=document.getElementById("res-customer")?.value?.trim(),l=document.getElementById("res-start")?.value?.trim(),r=document.getElementById("res-end")?.value?.trim(),u=document.getElementById("res-start-time")?.value?.trim(),d=document.getElementById("res-end-time")?.value?.trim(),m=!!(l&&r),_=!!(u&&d),g=!!a;if(!m||!_){s.preventDefault(),R(I("technicians.picker.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}if(!g){s.preventDefault(),R(I("technicians.picker.requireCustomer","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"),"warning");return}dt("create")}),e.dataset.listenerAttached="true";const o=()=>{const s=document.getElementById("res-customer")?.value?.trim(),a=document.getElementById("res-start")?.value?.trim(),l=document.getElementById("res-end")?.value?.trim(),r=document.getElementById("res-start-time")?.value?.trim(),u=document.getElementById("res-end-time")?.value?.trim(),d=!!(s&&a&&l&&r&&u);e.setAttribute("aria-disabled",String(!d)),e.dataset.ready=d?"true":"false",e.classList.toggle("is-disabled",!d)};["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(s=>document.getElementById(s)).filter(Boolean).forEach(s=>{["input","change"].forEach(a=>s.addEventListener(a,o))}),o()}const t=document.getElementById("open-edit-technician-picker");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>dt("edit")),t.dataset.listenerAttached="true");const n=document.getElementById("crew-position-search");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{Re()}),n.dataset.listenerAttached="true");const i=document.getElementById("apply-technician-selection");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",gn),i.dataset.listenerAttached="true");const c=document.getElementById("selectTechniciansModal");c&&!c.dataset.listenerAttached&&window.bootstrap?.Modal&&(c.addEventListener("shown.bs.modal",async()=>{if(!Ie.length&&(!pe().technicians||pe().technicians.length===0))try{await It()}catch(o){console.warn("[crew-picker] fetch on show failed",o)}Re(),Y(),Fe()}),c.addEventListener("hidden.bs.modal",()=>{const o=document.getElementById("crew-position-search");o&&(o.value="")}),c.dataset.listenerAttached="true"),Ae("selected-technicians-list",se,"create"),Ae("edit-selected-technicians-list",re,"edit")}function mi({onDraftChange:e,onEditChange:t}={}){Ct=typeof e=="function"?e:()=>{},St=typeof t=="function"?t:()=>{},_n()}function yn(){return se.map(be)}function bn(){return re.map(be)}function pt(){return se.map(e=>e.technicianId).filter(Boolean).map(String)}function mt(){return re.map(e=>e.technicianId).filter(Boolean).map(String)}function fi(e=[]){ae("create",e)}function gi(e=[]){ae("edit",e)}function _i(){ae("create",[])}function yi(){ae("edit",[])}function ft(e=[]){return e.map(t=>{if(t.technicianId){const n=Me(t.technicianId);if(n)return t.technicianId=String(n.id),t.technicianName=n.name??t.technicianName??null,t.technicianRole=n.role??t.technicianRole??null,t.technicianPhone=n.phone??null,t;t.technicianId=null,t.technicianName=null,t.technicianRole=null,t.technicianPhone=null}return t})}function bi(e=[]){Array.isArray(e)&&e.length&&(Ie=e),se=ft(se),re=ft(re),Ae("selected-technicians-list",se,"create"),Ae("edit-selected-technicians-list",re,"edit"),Y()}function gt(e){const t=e.split(".");if(t.length<=2)return e;const n=t.pop(),i=t.join("");return n?`${i}.${n}`:i}function Ft(e){if(e==null||e==="")return Number.NaN;if(typeof e=="number")return Number.isFinite(e)?e:Number.NaN;if(typeof e=="boolean")return e?1:0;let t=h(String(e)).trim();if(!t)return Number.NaN;const n=t.search(/[0-9]/),i=t.indexOf("-"),c=i!==-1&&(n===-1||i<n);if(t=t.replace(/[-+]/g,""),t=t.replace(/\s+/g,"").replace(/\u066B/g,".").replace(/[\u066C\u060C\u061B]/g,","),t=t.replace(/[^0-9.,]/g,""),!t)return Number.NaN;const o=t.includes(","),s=t.includes(".");if(o&&s){const l=t.lastIndexOf(","),r=t.lastIndexOf(".");l>r?(t=t.replace(/\./g,""),t=t.replace(/,/g,".")):t=t.replace(/,/g,"")}else if(o){const l=t.split(",");l.length===2&&l[1].length===3?t=l.join(""):t=t.replace(/,/g,".")}else if(s){const l=t.split(".");if(l.length===2){const[,r]=l;if(r.length===3){const u=l.join("");/^[0-9]+$/.test(u)&&(t=u)}}else l.length>2&&(t=gt(t))}if(t=t.replace(/,/g,""),t=gt(t),!/^[0-9]*\.?[0-9]*$/.test(t)||!t||t===".")return Number.NaN;const a=Number.parseFloat(t);return Number.isFinite(a)?c?-a:a:Number.NaN}function x(e){return Ft(e)}function w(e){const t=Ft(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function ve(e){return h(String(e??"")).trim().toLowerCase()}function Lt(e=""){return h(String(e)).trim().toLowerCase()}const hn=2;function Nn(e){const t=x(e);return Number.isFinite(t)?t.toFixed(hn):"0.00"}function Qe(e={}){const t=[e?.qty,e?.quantity,e?.count,e?.units];for(const n of t){const i=Number.parseFloat(h(String(n??"")).replace(/[^0-9.]/g,""));if(Number.isFinite(i)&&i>0)return w(i)}return 1}function kn(e={}){const t=e?.desc||e?.description||e?.name||"",n=Lt(t),i=Nn(e?.price??e?.unitPrice??e?.unit_price??0);return`${n}::${i}`}function In(e=[]){const t=new Map;return e.forEach((n,i)=>{const c=kn(n);if(!c)return;if(!t.has(c)){const s=n?.desc||n?.description||n?.name||"",a=Lt(s),l=yt(n),r=bt(n),u=n?.image||n?.imageUrl||n?.img||"";t.set(c,{key:c,description:s,normalizedDescription:a,unitPrice:l,unitCost:r,image:u,items:[],itemIndices:[],barcodes:[]})}const o=t.get(c);o.items.push(n),o.itemIndices.push(i),n?.barcode&&o.barcodes.push(String(n.barcode))}),Array.from(t.values()).map(n=>({...n,quantity:n.items.reduce((i,c)=>i+Qe(c),0)})).map(n=>{const i=n.quantity||0,c=n.items.reduce((g,y)=>{const k=yt(y),p=Qe(y);return g+k*p},0),o=w(c),s=x(n.unitPrice),a=Number.isFinite(s)?s:0,l=n.items.reduce((g,y)=>{const k=bt(y),p=Qe(y);return g+k*p},0),r=w(l),u=x(n.unitCost),d=Number.isFinite(u)?u:0,m=i>0?w(o/i):w(a),_=i>0?w(r/i):w(d);return{...n,quantity:i,count:i,totalPrice:o,unitPrice:m,totalCost:r,unitCost:_}})}function _t(e={}){return(_e(e)||[]).map(n=>({...n,normalizedBarcode:n?.normalizedBarcode??ve(n?.barcode),qty:(()=>{const i=Number.parseFloat(h(String(n?.qty??n?.quantity??1)));return Number.isFinite(i)&&i>0?i:1})(),qtyPerPackage:1,price:(()=>{const i=x(n?.price??n?.unit_price??n?.unitPrice);return Number.isFinite(i)?i:0})(),cost:(()=>{const i=x(n?.cost??n?.unit_cost??n?.unitCost??n?.rental_cost??n?.purchase_price);return Number.isFinite(i)?i:0})()}))}function Pn(e={},{packageQuantity:t=1}={}){const n=ye(e?.package_code??e?.packageCode??e?.code??e?.id??e?.packageId??e?.package_id),i=n&&me(n)||e,c=_e(i)||[],o=Number.isFinite(Number(t))&&Number(t)>0?Number(t):1;return c.map(s=>{const l=x(s?.price??s?.unit_price??s?.unitPrice),r=Number.isFinite(l)?w(l):0,u=x(s?.cost??s?.unit_cost??s?.unitCost??s?.rental_cost??s?.purchase_price),d=Number.isFinite(u)?w(u):0,m=1*o,_=w(r*m),g=w(d*m);return{equipmentId:s?.equipmentId??s?.equipment_id??null,barcode:s?.barcode??s?.normalizedBarcode??"",desc:s?.desc??s?.description??"",qtyPerPackage:1,packageQuantity:o,totalUnits:m,unitPrice:r,perDayTotal:_,unitCost:d,perDayCost:g}})}function An(e={},{packageQuantity:t=1,days:n=1}={}){const i=Pn(e,{packageQuantity:t}),c=w(i.reduce((l,r)=>l+(Number(r.perDayTotal)||0),0)),o=w(i.reduce((l,r)=>l+(Number(r.perDayCost)||0),0)),s=w(c*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1)),a=w(o*(Number.isFinite(Number(n))&&Number(n)>0?Number(n):1));return{lines:i,perDayTotal:c,total:s,perDayCostTotal:o,costTotal:a}}function Cn(e={}){const t=e.quantity??e.qty??e.count??e.package_quantity??e.packageQty??1,n=Number.parseFloat(h(String(t)).replace(/[^0-9.]/g,""));return Number.isFinite(n)&&n>0?n:1}function Sn(e={},t=[],n=null){try{const r=ye(e?.id??e?.packageId??e?.package_id??e?.package_code??e?.code);if(r){const u=me(r);if(u){const d=u.price??u.total_price??u.package_price,m=x(d);if(Number.isFinite(m)&&m>0)return w(m)}}}catch{}const i=e.unit_price??e.unitPrice??e.price,c=x(i);if(Number.isFinite(c)&&c>0)return w(c);const o=e.total_price??e.totalPrice??e.total,s=x(o),a=Number.parseFloat(h(String(n)).replace(/[^0-9.]/g,"")),l=Number.isFinite(a)&&a>0?a:Cn(e);return Number.isFinite(s)&&s>0&&l>0?w(s/l):0}function vn(e={}){const t=Array.isArray(e?.items)?e.items:[],n=In(t),i=Ze(),c=new Set,o=new Map;i.forEach(p=>{const b=ye(p?.id??p?.packageId??p?.package_id??p?.code);b&&c.add(b);const N=h(String(p?.package_code??p?.code??"")).trim().toLowerCase();N&&o.set(N,b||N)});const s=(p,b=0)=>{const N=ye(p?.package_code??p?.packageId??p?.package_id??p?.code??p?.id??null),P=h(String(p?.package_code??p?.code??p?.barcode??"")).trim().toLowerCase();return N||(P&&o.has(P)?o.get(P):P||`pkg-${b}`)},a=new Map,l=(p,b=0,N="packages")=>{if(!p||typeof p!="object")return;const A=s(p,b)||`pkg-${b}`;if(!a.has(A)){a.set(A,{source:p,normalizedId:A,index:b,itemSource:N==="items"?p:null});return}const C=a.get(A);if(C.source||(C.source=p),N==="items"&&(C.itemSource=p,C.source&&typeof C.source=="object")){const F=Array.isArray(C.source.packageItems)&&C.source.packageItems.length>0,S=Array.isArray(p.packageItems)&&p.packageItems.length>0;!F&&S&&(C.source={...C.source,packageItems:p.packageItems}),!C.source.image&&p.image&&(C.source={...C.source,image:p.image})}};Array.isArray(e?.packages)&&e.packages.forEach((p,b)=>l(p,b,"packages")),t.forEach((p,b)=>{if(p&&typeof p=="object"&&(p.type==="package"||Array.isArray(p?.packageItems))){const N=s(p,b+a.size);l({...p,package_id:N,packageId:N,package_code:p.package_code??p.code},b+a.size,"items")}});const r=[],u=new Set,d=new Set;a.forEach(({source:p,itemSource:b=null,normalizedId:N},P)=>{const A=N?me(N):null,C=p&&typeof p=="object"?p:{},F=A?{...A,...C}:C,S=b&&typeof b=="object"?b:null;let T=_t(F);(!Array.isArray(T)||T.length===0)&&S&&(T=_t(S)),T.forEach(q=>{const D=q?.normalizedBarcode??ve(q?.barcode);D&&u.add(D);const z=q?.equipmentId??q?.equipment_id??null;z!=null&&d.add(String(z))});let Q=1,f=Sn(F,T,Q);const U=[S?.price,S?.unit_price,S?.unitPrice];for(const q of U){const D=x(q);if(Number.isFinite(D)&&D>0){f=w(D);break}}f=w(f);const G=[F?.unit_cost,F?.unitCost,F?.cost,S?.unit_cost,S?.unitCost,S?.cost];let O=0;for(const q of G){const D=x(q);if(Number.isFinite(D)&&D>=0){O=w(D);break}}if(!O&&Array.isArray(T)&&T.length){const q=T.reduce((D,z)=>{const ge=x(z?.cost),oe=Number.isFinite(Number(z?.qtyPerPackage))&&Number(z.qtyPerPackage)>0?Number(z.qtyPerPackage):1;return D+(Number.isFinite(ge)?ge:0)*oe},0);O=w(q)}const V=(()=>{const q=[F?.pricing_mode,F?.pricingMode,F?.pricing,S?.pricing_mode,S?.pricingMode,S?.pricing];for(const D of q){if(D==null)continue;const z=String(D).trim().toLowerCase();if(z==="daily"||z==="per_day"||z==="day")return"daily";if(z==="fixed"||z==="per_booking"||z==="booking")return"fixed"}return"daily"})(),J=[S?.total,S?.total_price,S?.totalPrice,F?.total,F?.total_price,F?.totalPrice];let $=NaN;for(const q of J){const D=x(q);if(Number.isFinite(D)&&D>=0){$=D;break}}Number.isFinite($)||($=f*Q),$=w($);const L=[F?.package_code,F?.code,F?.packageCode,F?.displayCode,F?.display_code,F?.barcode,S?.package_code,S?.code,S?.packageCode,S?.displayCode,S?.display_code,S?.barcode,N,P].find(q=>q==null?!1:String(q).trim().length>0),E=L!=null?h(String(L)).trim():"";if(E){const q=ve(E);q&&u.add(q)}const ne=T.map(q=>h(String(q?.barcode??q?.normalizedBarcode??""))).filter(Boolean),Z=[F?.name,F?.package_name,F?.title,S?.name,S?.desc,S?.package_name,E,h(String(P))].find(q=>q!=null&&String(q).trim()!=="")||h(String(E||P)),B=T.find(q=>q?.image)?.image??F?.image??S?.image??null,W=1;r.push({key:`package::${P}`,description:Z,normalizedDescription:h(String(Z)),unitPrice:f,unitCost:O,totalPrice:$,pricingMode:V,quantity:Q,count:W,image:B,barcodes:ne,barcode:E,package_code:E,packageDisplayCode:E,items:[{type:"package",packageItems:T,packageId:N,desc:Z,price:f,cost:O,qty:W,barcode:E}],type:"package",packageItems:T,packageId:N})});const m=new Set(Array.from(u).map(p=>ve(p)).filter(Boolean)),_=n.filter(p=>{if(p.items.some(A=>A?.type==="package")&&r.length>0)return!1;const N=(A={})=>[A.packageId,A.package_id,A.package_code,A.packageCode,A.bundleId,A.bundle_id].some(C=>C!=null&&C!=="");return!p.items.every(A=>{const C=qn(A),F=C!=null?String(C):null;if(F&&d.has(F))return!0;const S=A?.barcode?ve(A.barcode):null;return!!(S&&m.has(S)||N(A))})}),g=new Set,y=[];return r.forEach(p=>{const b=s({package_code:p?.package_code,packageId:p?.packageId,package_id:p?.packageId,code:p?.barcode,id:p?.packageId});!b||g.has(b)||(g.add(b),y.push(p))}),{groups:y.length?[...y,..._]:n,packageGroups:r,groupedItems:n,filteredGroupedItems:_,packagesMap:a}}function qn(e={}){const t=[e?.id,e?.equipment_id,e?.equipmentId,e?.item_id,e?.itemId];for(const n of t)if(!(n==null||n===""))return String(n);return null}function yt(e={}){const t=[e?.price,e?.unit_price,e?.unitPrice,e?.unit_rate,e?.unitRate];for(const n of t){const i=x(n);if(Number.isFinite(i))return i}return 0}function bt(e={}){const t=[e?.cost,e?.unit_cost,e?.unitCost,e?.rental_cost,e?.rentalCost,e?.purchase_price,e?.purchasePrice];for(const n of t){const i=x(n);if(Number.isFinite(i))return i}return 0}function hi(e){const t=e?.status??e?.reservationStatus??null;if(t){const c=String(t).trim().toLowerCase();if(c==="completed"||c==="closed"||c==="Ù…ØºÙ„Ù‚"||c==="Ù…ÙƒØªÙ…Ù„"||c==="Ù…Ù†ØªÙ‡ÙŠ"||c==="Ù…Ù†ØªÙ‡ÙŠØ©")return!0}if(!e?.end)return!1;const n=new Date(e.end);return Number.isNaN(n.getTime())?!1:n<new Date}function Fn(e=""){switch(String(e??"").trim().toLowerCase()){case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";case"pending":case"draft":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":case"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":case"Ù…Ø¹Ù„Ù‚":default:return"pending"}}function Ni(e={},t=null){const n=e?.confirmed===!0||e?.confirmed==="true",i=e?.projectId??e?.project_id??null,c=i!=null&&i!==""&&i!=="null",o=c?Fn(t?.status??t?.status_label??t?.statusLabel??""):null,s=c&&(t?.confirmed===!0||["confirmed","in_progress","completed"].includes(o));return{reservationConfirmed:n,projectLinked:c,projectStatus:o,projectConfirmed:s,effectiveConfirmed:c?s:n}}const Et=10;function Tt(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){const i=x(n);if(Number.isFinite(i))return w(i)}return 0}function Ln(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage,e.totalRatePerDay];for(const n of t){if(n==null||n==="")continue;const i=x(n);if(Number.isFinite(i))return w(i)}return Tt(e)}function En(e=[]){if(!Array.isArray(e)||e.length===0)return{costPerDay:0,totalPerDay:0};const{technicians:t=[]}=pe();if(!Array.isArray(t)||t.length===0)return{costPerDay:0,totalPerDay:0};const n=new Map(t.filter(i=>i&&(i.id!=null||i.ID!=null)).map(i=>[String(i.id??i.ID),i]));return e.reduce((i,c)=>{const o=n.get(String(c));if(!o)return i;const s=Tt(o),a=Ln(o);return{costPerDay:i.costPerDay+(Number.isFinite(s)?s:0),totalPerDay:i.totalPerDay+(Number.isFinite(a)?a:0)}},{costPerDay:0,totalPerDay:0})}const Tn=1440*60*1e3,ke=.01;function Ne(e){if(e==null||e==="")return null;const t=h(String(e)).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return Number.isFinite(n)?n:null}function ht(e,{min:t=0,max:n=Number.POSITIVE_INFINITY,precision:i=2}={}){let c=Number.isFinite(e)?e:0;if(c<t&&(c=t),c>n&&(c=n),i!=null){const o=10**i;c=Math.round(c*o)/o}return c}function $t(e){if(e==null)return"unpaid";switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"partial_paid":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":return"partial";default:return"unpaid"}}function tt({totalAmount:e=0,progressType:t=null,progressValue:n=null,paidAmount:i=null,paidPercent:c=null,history:o=[]}={}){const s=Number.isFinite(Number(e))?Number(e):0,a=t==="amount"?"amount":t==="percent"?"percent":null;let l=Ne(i),r=Ne(c);const u=Ne(n);let d=0,m=0;Array.isArray(o)&&o.length&&o.forEach(p=>{if(!p)return;const b=p.type==="amount"||p.type==="percent"?p.type:null,N=Ne(p.value),P=Ne(p.amount),A=Ne(p.percentage);if(b==="amount"){const C=P??N;C!=null&&(d+=C,s>0&&(m+=C/s*100))}else if(b==="percent"){const C=A??N;C!=null&&(m+=C,s>0&&(d+=C/100*s))}else P!=null&&(d+=P,s>0&&(m+=P/s*100)),A!=null&&(m+=A,s>0&&(d+=A/100*s))}),a==="amount"&&u!=null?l=u:a==="percent"&&u!=null?r=u:a===null&&u!=null&&(r!=null?r=u:l=u),(l==null||l<=0)&&r!=null&&r>0&&s>0&&(l=s*(r/100)),(r==null||r<=0)&&l!=null&&l>0&&s>0&&(r=l/s*100);const _=l??0,g=r??0;l=_+d,r=g+m,l=ht(l??0,{min:0,max:s>0?s:Number.POSITIVE_INFINITY,precision:2}),r=ht(r??0,{min:0,max:100,precision:2});let y=a;return y||(l>0&&s>0?y="amount":r>0&&(y="percent")),{paidAmount:l,paidPercent:r,paymentProgressType:y,paymentProgressValue:y==="amount"?l:y==="percent"?r:null}}function nt({manualStatus:e="unpaid",paidAmount:t=0,paidPercent:n=0,totalAmount:i=0}={}){const c=$t(e),o=Number.isFinite(Number(i))?Number(i):0,s=Number.isFinite(Number(t))?Number(t):0,a=Number.isFinite(Number(n))?Number(n):0;if(c==="paid")return"paid";const l=o>0&&s>=o-ke,r=a>=100-ke*100;if(l||r)return"paid";const u=s>ke||a>ke;return c==="partial"||u?"partial":"unpaid"}function $n(e,t){if(!e||!t)return 1;const n=new Date(e),i=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(i.getTime()))return 1;const c=i.getTime()-n.getTime();if(c<=0)return 1;const o=c/Tn;return Math.max(1,Math.ceil(o))}function Ce({items:e=[],technicianIds:t=[],crewAssignments:n=[],discount:i=0,discountType:c="percent",applyTax:o=!1,start:s=null,end:a=null,companySharePercent:l=null,groupingSource:r=null}={}){const u=$n(s,a);let d=!1;try{if(typeof window<"u"&&window.location){const L=new URL(window.location.href),E=(L.searchParams.get("noDays")||L.searchParams.get("pricing")||"").toLowerCase();d=E==="1"||E==="true"||E==="fixed"||E==="nodays"}}catch{}const m=r&&typeof r=="object"?r:{items:Array.isArray(e)?e:[]},{groups:_}=vn(m),g=L=>{if((L?.type||"").toLowerCase()==="package")return!0;const E=Array.isArray(L?.items)?L.items:[];if(!E.length)return!1;if(E.some(B=>B?.reservation_id!=null||B?.reservationId!=null))return!0;const X=E.every(B=>B?.unit_price!=null||B?.unitPrice!=null),Z=E.some(B=>B?.daily_rate!=null||B?.dailyRate!=null||B?.unit_rate!=null||B?.unitRate!=null||B?.price!=null);return!!(X&&!Z)};let y=0,k=0;(Array.isArray(_)?_:[]).forEach(L=>{const E=Number.isFinite(Number(L?.quantity))?Number(L.quantity):0,ne=Number.isFinite(Number(L?.unitPrice))?Number(L.unitPrice):0,X=Number.isFinite(Number(L?.unitCost))?Number(L.unitCost):0,Z=String(L?.type||"").toLowerCase()==="package",B=g(L),W=d||B?1:u;if(Z){const q={package_code:L?.package_code||L?.packageDisplayCode||L?.barcode||L?.packageId||L?.key,packageItems:Array.isArray(L?.packageItems)?L.packageItems:void 0},D=An(q,{packageQuantity:E,days:W}),z=Number.isFinite(Number(D.total))?Number(D.total):E*(Number.isFinite(ne)?ne:0)*W,ge=(()=>{const oe=Number(D?.costTotal);if(Number.isFinite(oe))return oe;const Te=Number(D?.perDayCostTotal);return Number.isFinite(Te)?Te*W:E*(Number.isFinite(X)?X:0)*W})();y+=z,k+=ge}else y+=E*ne*W,k+=E*X*W});const p=w(y),b=w(k),N=Array.isArray(n)?n:[],P=N.length?N.map(L=>L?.technicianId).filter(Boolean):Array.isArray(t)?t:[],{costPerDay:A,totalPerDay:C}=N.length?N.reduce((L,E)=>{const ne=x(E?.positionCost??E?.position_cost??E?.cost??E?.dailyWage??E?.daily_wage??0),X=x(E?.positionClientPrice??E?.position_client_price??E?.clientPrice??E?.dailyTotal??E?.daily_total??E?.total??0),Z=Number.isFinite(ne)?ne:0,B=Number.isFinite(X)?X:0;return{costPerDay:L.costPerDay+Z,totalPerDay:L.totalPerDay+B}},{costPerDay:0,totalPerDay:0}):En(P),F=w(C*u),S=w(A*u),T=w(p+F),Q=Number(i)||0;let f=c==="amount"?Q:T*(Q/100);(!Number.isFinite(f)||f<0)&&(f=0),f>T&&(f=T);const U=Math.max(0,T-f),G=Number.isFinite(l)&&Number(l)>0?Number(l):0,O=G>0?Math.max(0,U*(G/100)):0,j=U+O;let V=o?j*.15:0;(!Number.isFinite(V)||V<0)&&(V=0),V=Number(V.toFixed(2));const J=j+V,$=Math.max(0,Number(J.toFixed(2))),le=Math.max(0,Math.max(0,p+F-f)-S-b);return{rentalDays:u,equipmentTotal:p,equipmentCostTotal:b,crewTotal:F,crewCostTotal:S,discountAmount:f,subtotalAfterDiscount:U,taxableAmount:j,taxAmount:V,finalTotal:$,companySharePercent:G,companyShareAmount:O,netProfit:le}}function ki(e=[],t=0,n="percent",i=!1,c=[],{start:o=null,end:s=null,companySharePercent:a=null}={}){const l=_=>_&&typeof _=="object"&&(_.positionId!==void 0||_.position_id!==void 0||_.positionLabel!==void 0||_.position_name!==void 0||_.positionClientPrice!==void 0),r=Array.isArray(c)&&c.some(l)?c:[],u=r.length?r.map(_=>_?.technicianId).filter(Boolean):Array.isArray(c)?c:[];return Ce({items:e,technicianIds:u,crewAssignments:r,discount:t,discountType:n,applyTax:i,start:o,end:s,companySharePercent:a??Et}).finalTotal}function wt({total:e,itemsCount:t,rentalDays:n,techniciansCount:i,applyTax:c,paymentStatus:o,paidAmount:s=0,paidPercent:a=0,companySharePercent:l=null,companyShareAmount:r=null,taxAmount:u=null,netProfit:d=null,totalKey:m="reservations.summary.total",equipmentTotal:_=null,crewTotal:g=null,equipmentCostTotal:y=null}){const k=I("reservations.create.summary.currency","SR"),p=h(String(e)),b=h(String(t)),N=h(String(n??1)),P=h(String(i)),A=$t(o),C=A==="paid"?"Ù…Ø¯ÙÙˆØ¹":A==="partial"?"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",F=I(`reservations.create.paymentStatus.${A}`,C),S=Number.isFinite(Number(s))?Math.max(0,Number(s)):0,T=Number.isFinite(Number(a))?Math.max(0,Number(a)):0,Q=S>ke||T>ke,f=I("reservations.summary.paymentProgressLabel","ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"),U=h(S.toFixed(2)),G=h(T.toFixed(T%1?2:0)),O=I("reservations.summary.itemsLabel","ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),j=I("reservations.summary.durationLabel","â±ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),V=I("reservations.summary.crewLabel","ğŸ˜ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚"),J=I("reservations.details.labels.itemsTotal","ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),$=I("reservations.details.labels.equipmentCost","ğŸ’¸ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),le=I("reservations.details.labels.crewTotal","ğŸ˜ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"),L=I("reservations.summary.taxLabelShort","ğŸ§¾ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),E=I("reservations.summary.paymentLabelShort","ğŸ’³ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹"),X=I(m==="reservations.summary.totalAfterEdit"?"reservations.summary.totalLabelAfterEdit":"reservations.summary.totalLabel",I("reservations.summary.totalLabel","ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),Z=I("reservations.summary.companyShareLabel","ğŸ¦ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©"),B=I("reservations.details.labels.netProfit","ğŸ’µ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"),W=Number.isFinite(d)?Math.max(0,Number(d)):null,q=[{label:O,value:b},{label:j,value:N},{label:V,value:P}],D=Number.isFinite(Number(_))?Math.max(0,Number(_)):null;D!=null&&q.push({label:J,value:`${h(D.toFixed(2))} ${k}`});const z=Number.isFinite(Number(y))?Math.max(0,Number(y)):null;z!=null&&q.push({label:$,value:`${h(z.toFixed(2))} ${k}`});const ge=Number.isFinite(Number(g))?Math.max(0,Number(g)):null;if(ge!=null&&q.push({label:le,value:`${h(ge.toFixed(2))} ${k}`}),c){let ce=I("reservations.summary.taxIncludedValue","Ø´Ø§Ù…Ù„ 15%");Number.isFinite(u)&&u>0&&(ce=`${h(Number(u).toFixed(2))} ${k}`),q.push({label:L,value:ce})}const oe=Number.isFinite(l)?Number(l):null;if(oe!==null&&oe>0){const ce=Number.isFinite(r)?Number(r):e*(oe/100),Se=h(String(oe)),Yt=h(Number.isFinite(ce)?ce.toFixed(2):"0"),Jt=`${Se}% (${Yt} ${k})`;q.push({label:Z,value:Jt})}if(W!==null&&Math.abs(W-Number(e))>.009){const ce=h(W.toFixed(2));q.push({label:B,value:`${ce} ${k}`})}q.push({label:E,value:F}),Q&&q.push({label:f,value:`${U} ${k} (${G}%)`});const Te=`${p} ${k}`;return`
    <div class="reservation-summary-container">
      <div class="reservation-summary-box">
        ${q.map(({label:ce,value:Se})=>`
          <div class="reservation-summary-line">
            <span class="reservation-summary-label">${ce}</span>
            ${Se?`<span class="reservation-summary-value">${Se}</span>`:""}
          </div>
        `).join("")}
        <div class="reservation-summary-line reservation-summary-total">
          <span class="reservation-summary-label">${X}</span>
          <span class="reservation-summary-value">${Te}</span>
        </div>
      </div>
    </div>
  `}function wn({selectedItems:e,discount:t,discountType:n,applyTax:i,paidStatus:c,paymentProgressType:o=null,paymentProgressValue:s=null,start:a,end:l,companySharePercent:r=null,paymentHistory:u=[]}){const d=yn(),m=typeof pt=="function"?pt()??[]:[],_=Array.isArray(m)?m.map(String):[],g=d.length?d.map(C=>C?.technicianId).filter(Boolean).map(String):_,y=d.length||g.length,k=Number.isFinite(r)?Number(r):null,p=Ce({items:e,technicianIds:g,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:a,end:l,companySharePercent:k}),b=tt({totalAmount:p.finalTotal,progressType:o,progressValue:s,history:u}),N=nt({manualStatus:c,paidAmount:b.paidAmount,paidPercent:b.paidPercent,totalAmount:p.finalTotal}),P=wt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:N,paidAmount:b.paidAmount,paidPercent:b.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),A={paymentStatus:N,paidAmount:b.paidAmount,paidPercent:b.paidPercent,paymentProgressType:b.paymentProgressType,paymentProgressValue:b.paymentProgressValue,total:p.finalTotal};return wn.lastResult=A,xn(P),P}function Dn({items:e,discount:t,discountType:n,applyTax:i,paidStatus:c,paymentProgressType:o=null,paymentProgressValue:s=null,start:a,end:l,companySharePercent:r=null,paymentHistory:u=[]}){const d=bn(),m=typeof mt=="function"?mt()??[]:[],_=Array.isArray(m)?m.map(String):[],g=d.length?d.map(C=>C?.technicianId).filter(Boolean).map(String):_,y=d.length||g.length,k=Number.isFinite(r)?Number(r):null,p=Ce({items:e,technicianIds:g,crewAssignments:d,discount:t,discountType:n,applyTax:i,start:a,end:l,companySharePercent:k}),b=tt({totalAmount:p.finalTotal,progressType:o,progressValue:s,history:u}),N=nt({manualStatus:c,paidAmount:b.paidAmount,paidPercent:b.paidPercent,totalAmount:p.finalTotal}),P=wt({total:p.finalTotal,itemsCount:e.length,rentalDays:p.rentalDays,techniciansCount:y,applyTax:i,paymentStatus:N,paidAmount:b.paidAmount,paidPercent:b.paidPercent,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,taxAmount:p.taxAmount,netProfit:p.netProfit,totalKey:"reservations.summary.totalAfterEdit",equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,equipmentCostTotal:p.equipmentCostTotal}),A={html:P,paymentStatus:N,paidAmount:b.paidAmount,paidPercent:b.paidPercent,paymentProgressType:b.paymentProgressType,paymentProgressValue:b.paymentProgressValue,total:p.finalTotal};return Dn.lastResult=A,P}function xn(e){const t=document.getElementById("reservation-preview");t&&(t.innerHTML=e,Nt(t,e));const n=document.getElementById("reservation-preview-bottom");n&&(n.innerHTML=e,Nt(n,e))}function Nt(e,t){const n=typeof t=="string"&&t.trim().length>0;e.classList.toggle("reservation-summary-host",n)}const Rn=pe()||{};let ie=(Rn.reservations||[]).map(Ht);function ee(e){let t=Number(e);if(!Number.isFinite(t))return 0;let n=0;for(;Math.abs(t)>1e5&&n<8;)t/=10,n+=1;return Number(t.toFixed(2))}const Dt="__reservation_packages_cache__",xt="__reservation_item_cost_cache__";function Rt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Bt(){return typeof window>"u"||!window.localStorage?null:window.localStorage}function zt(){const e=Rt();if(!e)return{};try{const t=e.getItem(Dt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation packages cache",t),{}}}function kt(e){const t=Rt();if(t)try{t.setItem(Dt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation packages cache",n)}}function it(){const e=Bt();if(!e)return{};try{const t=e.getItem(xt);if(!t)return{};const n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("[reservationsService] Failed to read reservation item cost cache",t),{}}}function We(e){const t=Bt();if(t)try{t.setItem(xt,JSON.stringify(e))}catch(n){console.warn("[reservationsService] Failed to persist reservation item cost cache",n)}}function Bn(e,t=0){if(!e||typeof e!="object")return null;const n=e.equipment_id??e.equipmentId??e.id??null,i=h(String(e.barcode??e.code??"")).trim(),c=ee(v(e.cost??e.unit_cost)),o=ee(v(e.price??e.unit_price)),s=Number.isFinite(c),a=Number.isFinite(o);return!s&&!a?null:{key:n!=null?`id:${n}`:i?`bc:${i}`:`idx:${t}`,equipmentId:n,barcode:i,cost:s?c:null,price:a?o:null}}function zn(e,t){if(!e)return;const n=Array.isArray(t)?t.map((o,s)=>Bn(o,s)).filter(Boolean):[],i=it(),c=String(e);if(!n.length){i[c]&&(delete i[c],We(i));return}i[c]=n,We(i)}function Mn(e=[]){const t=it(),n=new Set;e.forEach(c=>{const o=c?.id??c?.reservationId??c?.reservation_code??null;o&&n.add(String(o))});let i=!1;Object.keys(t).forEach(c=>{n.has(c)||(delete t[c],i=!0)}),i&&We(t)}function jn(e){if(!e)return[];const t=it(),n=String(e),i=t[n];return Array.isArray(i)?i:[]}function Vn(e=[]){if(!Array.isArray(e)||e.length===0)return[];const t=Ze();if(!Array.isArray(t)||t.length===0)return[];const n=new Map;e.forEach(c=>{if(!c||typeof c!="object")return;const o=c.equipmentId??c.equipment_id??c.id??null;if(o==null)return;const s=String(o),a=(()=>{const l=[c.qty,c.quantity,c.count,1];for(const r of l){const u=Number(r);if(Number.isFinite(u)&&u>0)return u}return 1})();n.set(s,(n.get(s)||0)+a)});const i=[];return t.forEach((c,o)=>{const s=_e(c)||[],a=new Map;let l=!0;if(s.forEach(g=>{const y=g?.equipmentId??g?.equipment_id??null,k=Number.isFinite(Number(g?.qty))&&Number(g.qty)>0?Number(g.qty):1;if(y==null){l=!1;return}const p=String(y);a.set(p,(a.get(p)||0)+k)}),!l||a.size===0)return;let r=1/0;for(const[g,y]of a.entries()){const k=n.get(g)||0,p=Math.floor(k/y);if(p<=0){r=0;break}p<r&&(r=p)}if(!Number.isFinite(r)||r<=0)return;for(const[g,y]of a.entries()){const k=n.get(g)||0;n.set(g,Math.max(0,k-r*y))}const u=ye(c?.id??c?.packageId??c?.package_id??c?.code),d=Array.from(a.entries()).map(([g,y])=>({equipment_id:/^\d+$/.test(g)?Number(g):g,quantity:y,unit_price:0})),m=(c?.package_code??c?.code??u)||`pkg-${o}`,_=cn(c)||u||`package-${o}`;i.push({package_code:m,name:_,quantity:r,unit_price:At(c)||0,items:d})}),i}function Hn(e=[]){return!Array.isArray(e)||e.length===0?!1:e.some(t=>{const i=(t.positionLabel??"").trim().length>0,c=t.positionId!=null||t.positionKey!=null&&String(t.positionKey).trim()!=="",o=Number.isFinite(Number(t.positionClientPrice))&&Number(t.positionClientPrice)>0,s=Number.isFinite(Number(t.positionCost))&&Number(t.positionCost)>0;return i||c||o||s})}function On(e){return[]}function Mt(e=[]){return Array.isArray(e)?e.map((t,n)=>Wt(t,n)).filter(Boolean).map((t,n)=>{const i=ye(t.packageId??t.package_id??t.package_code??t.code??t.id??`pkg-${n}`),c=Be(t,i).map(r=>{const u=H(r.qty??r.quantity??r.count??r.units??r.unit_qty??r.unitQty??r.unit_count??r.unitCount??r.package_quantity??r.packageQty??1),d=ee(v(r.price??r.unit_price??0));return{...r,qty:u,quantity:u,price:d,unit_price:d}}),o=H(t.quantity??t.qty??1);let s=ee(v(t.unit_price??t.unitPrice??t.price??0));if(!s||s<=0){const r=c.reduce((u,d)=>u+(d.price||0)*(d.qty||1),0);r>0&&o>0&&(s=ee(Number((r/o).toFixed(2))))}const a=v(t.total_price??t.totalPrice??t.total??s*o),l=a>0?ee(a):ee(Number((s*o).toFixed(2)));return{...t,packageId:i,package_id:i,qty:o,quantity:o,unit_price:s,unitPrice:s,price:s,total_price:l,total:l,packageItems:c}}):[]}function Le(e,t){if(!e)return;const n=zt(),i=String(e);if(!Array.isArray(t)||t.length===0){n[i]&&(delete n[i],kt(n));return}n[i]=Mt(t),kt(n)}function Kn(e){if(!e)return[];const t=zt(),n=String(e),i=t[n];return Array.isArray(i)?Mt(i):[]}function at(e,t=0){if(e==null)return null;if(typeof e!="object"){const N=e!=null?String(e):null;return{assignmentId:`crew-${t}-${N??"unassigned"}`,positionId:null,positionKey:null,positionLabel:"",positionLabelAlt:"",positionLabelAr:null,positionLabelEn:null,positionCost:0,positionClientPrice:0,technicianId:N,technicianName:null,technicianRole:null,notes:null}}const n=e.assignment_id??e.assignmentId??e.id??e.technician_id??e.technicianId??`crew-${t}`,i=e&&typeof e.position=="object"?e.position:null,c=e.position_id??e.positionId??e.position??e.position_code??i?.id??i?.code??null,o=e.position_key??e.positionKey??e.position_code??e.positionId??i?.name??i?.key??null;let s=e.position_name??e.positionName??e.position_label??e.position_title??i?.label_ar??i?.label_en??i?.name??e.role??e.position??"";s||(s=e.position_label_ar??e.position_title_ar??e.position_name_ar??e.position_label_en??e.position_title_en??e.position_name_en??"");const a=e.position_label_ar??null,l=e.position_label_en??null,r=e.position_label_alt??l??a??"",u=e.position_cost??e.positionCost??e.cost??e.daily_wage??e.dailyWage??i?.cost??i?.daily_wage??i?.dailyWage??e.internal_cost??null,d=e.position_client_price??e.positionClientPrice??e.client_price??e.customer_price??e.position_price??i?.client_price??i?.clientPrice??e.clientPrice??e.daily_total??e.dailyTotal??e.total??e.price??null,m=ee(x(u)),_=ee(x(d)),g=e&&typeof e.technician=="object"?e.technician:null,y=e.technician_id??e.technicianId??e.id??g?.id??e.userId??e.user_id??null,k=e.technician_name??e.technicianName??e.name??g?.name??e.full_name??null,p=e.role??g?.role??e.specialization??null,b=e.technician_phone??g?.phone??e.phone??null;return{assignmentId:String(n),positionId:c!=null?String(c):null,positionKey:o!=null?String(o):null,positionLabel:s!=null?String(s):"",positionLabelAlt:r!=null?String(r):"",positionLabelAr:a!=null?String(a):null,positionLabelEn:l!=null?String(l):null,positionCost:Number.isFinite(m)?m:0,positionClientPrice:Number.isFinite(_)?_:0,technicianId:y!=null?String(y):null,technicianName:k!=null?String(k):null,technicianRole:p!=null?String(p):null,technicianPhone:b!=null?String(b):null,notes:e.notes??null}}function Qn(){return ie}function Ee(e){ie=Array.isArray(e)?e.map(He):[],ie.forEach(t=>{if(!t)return;const n=t.id??t.reservationId??t.reservationCode;Le(n,t.packages),zn(n,t.items);const i=t.crewAssignments&&t.crewAssignments.length?t.crewAssignments:t.techniciansDetails||[];Hn(i)}),Mn(ie),Xt({reservations:ie});try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("reservations:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("reservations:updated"))}catch{}return ie}async function Un(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([a,l])=>{l!=null&&l!==""&&t.set(a,String(l))});const n=t.toString(),c=(await ze(`/reservations/${n?`?${n}`:""}`))?.data;let o=[];Array.isArray(c)?o=c:c&&typeof c=="object"&&(Array.isArray(c.items)?o=c.items:Array.isArray(c.results)?o=c.results:Array.isArray(c.data)?o=c.data:Array.isArray(c.records)&&(o=c.records));const s=o.map(Ve).map(Vt);return Ee(s)}async function Gn(e){try{Array.isArray(e?.packages)&&console.debug("[reservationsService] createReservationApi payload.packages",e.packages)}catch{}const t=await ze("/reservations/",{method:"POST",body:e}),n=Ve(t?.data??{}),i=Array.isArray(e?.items)?e.items:null;if(i&&(Array.isArray(n.items)&&n.items.length?n.items=jt(n.items,i):n.items=i.map(Oe)),!Number.isFinite(n.companySharePercent)&&e?.company_share_percent!=null&&(n.companySharePercent=Number(e.company_share_percent)||0),(!Array.isArray(n.paymentHistory)||n.paymentHistory.length===0)&&Array.isArray(e?.payment_history)){const c=ct(e.payment_history);c.length&&(n.paymentHistory=c)}if((!Array.isArray(n.crewAssignments)||n.crewAssignments.length===0)&&Array.isArray(e?.technicians)&&e.technicians.length){const c=e.technicians.map((o,s)=>at(o,s)).filter(Boolean);c.length&&(n.crewAssignments=c,n.techniciansDetails=c.map((o,s)=>{const a=e.technicians[s];return typeof a=="object"?{...a,...o}:o}))}if(Array.isArray(e?.packages)&&e.packages.length){const c=lt({packages:e.packages});n.packages=ue(n.packages,c)}{const c=rt(n.items||[],n.packages||[]);n.items=c.items,n.packages=ue(n.packages||[],c.packages)}if(Le(n.id??n.reservationId??n.reservation_code,n.packages),n.companySharePercent>0&&(!Number.isFinite(n.companyShareAmount)||n.companyShareAmount<=0)){const c=Ce({items:n.items||[],technicianIds:n.technicians||[],discount:n.discount,discountType:n.discountType,applyTax:n.applyTax,start:n.start,end:n.end,companySharePercent:n.companySharePercent});n.companyShareAmount=c.companyShareAmount,n.cost=c.finalTotal,n.totalAmount=c.finalTotal}return n.companyShareEnabled=e?.company_share_enabled?!0:n.companySharePercent>0,Ee([...ie,n]),n}async function ot(e,t){try{Array.isArray(t?.packages)&&console.debug("[reservationsService] updateReservationApi payload.packages",t.packages)}catch{}const n=await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),i=Ve(n?.data??{}),c=Array.isArray(t?.items)?t.items:null;if(c&&(Array.isArray(i.items)&&i.items.length?i.items=jt(i.items,c):i.items=c.map(Oe)),console.debug("[reservationsService] updateReservationApi mapped history",i.paymentHistory),!Number.isFinite(i.companySharePercent)&&t?.company_share_percent!=null&&(i.companySharePercent=Number(t.company_share_percent)||0),(!Array.isArray(i.paymentHistory)||i.paymentHistory.length===0)&&Array.isArray(t?.payment_history)){const s=ct(t.payment_history);s.length&&(i.paymentHistory=s,console.debug("[reservationsService] updateReservationApi applied fallback history",i.paymentHistory))}if((!Array.isArray(i.crewAssignments)||i.crewAssignments.length===0)&&Array.isArray(t?.technicians)&&t.technicians.length){const s=t.technicians.map((a,l)=>at(a,l)).filter(Boolean);s.length&&(i.crewAssignments=s,i.techniciansDetails=s.map((a,l)=>{const r=t.technicians[l];return typeof r=="object"?{...r,...a}:a}))}if(Array.isArray(t?.packages))if(t.packages.length){const s=lt({packages:t.packages});i.packages=ue(i.packages,s)}else i.packages=[];{const s=rt(i.items||[],i.packages||[]);i.items=s.items,i.packages=ue(i.packages||[],s.packages)}if(Le(i.id??i.reservationId??i.reservation_code??e,i.packages),i.companySharePercent>0&&(!Number.isFinite(i.companyShareAmount)||i.companyShareAmount<=0)){const s=Ce({items:i.items||[],technicianIds:i.technicians||[],discount:i.discount,discountType:i.discountType,applyTax:i.applyTax,start:i.start,end:i.end,companySharePercent:i.companySharePercent});i.companyShareAmount=s.companyShareAmount,i.cost=s.finalTotal,i.totalAmount=s.finalTotal}i.companyShareEnabled=t?.company_share_enabled?!0:i.companySharePercent>0;const o=ie.map(s=>String(s.id)===String(e)?i:s);return Ee(o),i}function jt(e,t){if(!Array.isArray(e)||!Array.isArray(t))return e;const n=new Map;return t.forEach((i,c)=>{if(!i||typeof i!="object")return;const o=i.equipment_id??i.equipmentId??i.id??null,s=h(String(i.barcode??"")).trim(),a=o!=null?`id:${o}`:s?`bc:${s}`:`idx:${c}`,l=Number.isFinite(Number(i.unit_cost))?Number(i.unit_cost):Number.isFinite(Number(i.cost))?Number(i.cost):null,r=Number.isFinite(Number(i.unit_price))?Number(i.unit_price):Number.isFinite(Number(i.price))?Number(i.price):null;n.set(a,{cost:l,price:r})}),e.map((i,c)=>{const o=i.equipmentId??i.equipment_id??i.id??null,s=h(String(i.barcode??"")).trim(),a=[o!=null?`id:${o}`:null,s?`bc:${s}`:null,`idx:${c}`].filter(Boolean);let l=null;for(const u of a)if(n.has(u)){l=n.get(u);break}if(!l)return i;const r={...i};return Number.isFinite(l.cost)&&(r.cost=l.cost,r.unit_cost=l.cost),Number.isFinite(l.price)&&(r.price=l.price,r.unit_price=l.price),r})}function Vt(e){try{return Wn(e)}catch(t){return console.warn("[reservationsService] mergeItemCostsFromExisting failed",t),e}}function Wn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!t.length)return e;const n=ie.find(o=>{if(!o)return!1;const s=o.id!=null?String(o.id):"",a=o.reservationId!=null?String(o.reservationId):"",l=o.reservation_code!=null?String(o.reservation_code):"";return s&&t.includes(s)||a&&t.includes(a)||l&&t.includes(l)});if(!n||!Array.isArray(n.items))return e;const i=new Map;n.items.forEach((o,s)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=h(String(o?.barcode??"")).trim(),r=a!=null?`id:${a}`:l?`bc:${l}`:`idx:${s}`;i.set(r,o)});const c=e.items.map((o,s)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=h(String(o?.barcode??"")).trim(),r=[a!=null?`id:${a}`:null,l?`bc:${l}`:null,`idx:${s}`].filter(Boolean);let u=null;for(const g of r)if(i.has(g)){u=i.get(g);break}if(!u)return o;const d={...o},m=Number(u.cost),_=Number(u.price);return Number.isFinite(m)&&m>0&&(d.cost=m,d.unit_cost=m),Number.isFinite(_)&&_>0&&(d.price=_,d.unit_price=_),d});return{...e,items:c}}function Yn(e){if(!e||typeof e!="object"||!Array.isArray(e.items)||e.items.length===0)return e;const t=[e.id,e.reservationId,e.reservation_code].map(o=>o!=null?String(o):"").filter(Boolean);if(!t.length)return e;let n=[];for(const o of t)if(n=jn(o),n.length)break;if(!n.length)return e;const i=new Map;n.forEach((o,s)=>{if(!o||typeof o!="object")return;const a=o.equipmentId??o.equipment_id??null,l=h(String(o.barcode??"")).trim(),r=a!=null?`id:${a}`:l?`bc:${l}`:`idx:${s}`;i.set(r,o)});const c=e.items.map((o,s)=>{const a=o?.equipmentId??o?.equipment_id??o?.id??null,l=h(String(o?.barcode??"")).trim(),r=[a!=null?`id:${a}`:null,l?`bc:${l}`:null,`idx:${s}`].filter(Boolean);let u=null;for(const b of r)if(i.has(b)){u=i.get(b);break}if(!u)return o;const d={...o},m=ee(v(u.cost??u.unit_cost)),_=ee(v(u.price??u.unit_price)),g=Number.isFinite(m),y=Number.isFinite(_),k=Number(o.cost),p=Number(o.price);return g&&(!Number.isFinite(k)||k<=0)&&(d.cost=m,d.unit_cost=m),y&&(!Number.isFinite(p)||p<=0)&&(d.price=_,d.unit_price=_),d});return{...e,items:c}}async function Jn(e){await ze(`/reservations/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const t=ie.filter(n=>String(n.id)!==String(e));Ee(t),Le(e,null)}async function Xn(e){return ot(e,{status:"confirmed",confirmed:!0})}async function Zn(e,t=null){const n={status:"completed",confirmed:!0};return typeof t=="string"&&(n.notes=t),ot(e,n)}function Ve(e={}){const t=He({id:e.id,reservationId:e.reservation_code??e.reservationId,reservation_code:e.reservation_code,customer_id:e.customer_id,customerId:e.customer_id,customer_name:e.customer_name,customerName:e.customer_name,title:e.title,start:e.start_datetime,end:e.end_datetime,start_datetime:e.start_datetime,end_datetime:e.end_datetime,status:e.status,confirmed:e.confirmed,location:e.location,notes:e.notes,total_amount:e.total_amount,project_id:e.project_id,discount:e.discount,discount_type:e.discount_type,apply_tax:e.apply_tax,paid_status:e.paid_status,items:e.items,packages:e.packages,reservation_packages:e.reservation_packages,reservationPackages:e.reservationPackages,technicians:e.technicians,company_share_percent:e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare,company_share_enabled:e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied,company_share_amount:e.company_share_amount??e.companyShareAmount,payment_history:e.payment_history??e.paymentHistory??e.payments??e.paymentLogs??e.payment_records,paymentHistory:e.paymentHistory??e.payment_history??e.payments??e.paymentLogs??e.payment_records});return Yn(Vt(t))}function Ht(e={}){return He(e)}function He(e={}){const t=e.id??e.reservation_id??e.reservationId??null,n=e.reservation_code??e.reservationCode??e.reservationId??(t!=null?`RSV-${t}`:null);let i=Array.isArray(e.items)?e.items.map(Oe):[],c=lt(e);const o=Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:Array.isArray(e.technicians)?e.technicians:[];let s=o.map(($,le)=>at($,le)).filter(Boolean),a=s.map(($,le)=>{const L=o?.[le];return{...L&&typeof L=="object"?{...L}:L!=null?{id:L}:{},...$}});const l=s.map($=>$.technicianId).filter($=>$!=null&&$!=="").map($=>Number.isNaN(Number($))?String($):Number($)),r=e.start??e.start_datetime??"",u=e.end??e.end_datetime??"";let d=v(e.total_amount??e.totalAmount??e.cost??0);const m=v(e.discount??0),_=e.discount_type??e.discountType??"percent",g=["percent","amount"].includes(_)?_:"percent",y=!!(e.apply_tax??e.applyTax??!1);let k=li(e.paid_status??e.paidStatus??(e.paid===!0||e.paid==="paid"?"paid":"unpaid"))??"unpaid";const p=e.confirmed!=null?!!e.confirmed:["confirmed","in_progress","completed"].includes(String(e.status??"").toLowerCase()),b=e.company_share_percent??e.companySharePercent??e.company_share??e.companyShare??null,N=b!=null?Number.parseFloat(h(String(b).replace("%","").trim())):NaN,P=e.company_share_enabled??e.companyShareEnabled??e.company_share_applied??e.companyShareApplied??null;let A=P!=null?P===!0||P===1||P==="1"||String(P).toLowerCase()==="true":Number.isFinite(N)&&N>0,C=A&&Number.isFinite(N)?Number(N):0;const F=e.company_share_amount??e.companyShareAmount;let S=Number.isFinite(Number(F))?Number(F):NaN;y&&C<=0&&(C=Et,A=!0);const T=Ce({items:i,technicianIds:l,crewAssignments:s,discount:m,discountType:g,applyTax:y,start:r,end:u,companySharePercent:C>0?C:null});(!Number.isFinite(d)||d<=0||y)&&(d=T.finalTotal),(!Number.isFinite(S)||S<0)&&(S=T.companyShareAmount),S=Number.isFinite(S)?Number(S.toFixed(2)):0,!A&&C>0&&(A=!0);const Q=[e.payment_history,e.paymentHistory,e.payments,e.payment_records,e.paymentRecords,e.payment_logs,e.paymentLogs,e.paymenthistory,e.paymentHistoryList,e.payment],f=ti(Q),U=ct(f),G=t??n??e.reservation_code??e.reservationId??null;if(c.length)Le(G,c);else{const $=Kn(G);$.length&&(c=ue(c,$))}if(!c.length&&Array.isArray(i)&&i.length)try{const $=Vn(i);Array.isArray($)&&$.length&&(c=ue(c,$))}catch($){console.warn("[reservationsService] inference of packages from items failed",$)}const O=rt(i,c);i=O.items,c=ue(c,O.packages);const j=tt({totalAmount:d,progressType:e.payment_progress_type??e.paymentProgressType??null,progressValue:e.payment_progress_value??e.paymentProgressValue??null,paidAmount:e.paid_amount??e.paidAmount??null,paidPercent:e.paid_percentage??e.paidPercentage??null,history:U});k=nt({manualStatus:k,paidAmount:j.paidAmount,paidPercent:j.paidPercent,totalAmount:d});const V=k==="paid",J=ri(e.status??(p?"confirmed":"pending"));return{id:t!=null?String(t):"",reservationId:n??(t!=null?String(t):""),reservationCode:n??null,customerId:e.customer_id??e.customerId??e.customer?.id??null,customerName:e.customer_name??e.customerName??e.customer?.full_name??e.customer?.customerName??"",title:e.title??e.name??"",start:r,end:u,status:J,completed:J==="completed",confirmed:p,location:e.location??"",notes:e.notes??"",discount:m,discountType:g,applyTax:y,paid:V,paidStatus:k,paidAmount:j.paidAmount,paidPercent:j.paidPercent,paymentProgressType:j.paymentProgressType,paymentProgressValue:j.paymentProgressValue,paymentHistory:U,payment_history:U,totalAmount:d,cost:d,projectId:e.project_id??e.projectId??null,items:i,technicians:l,crewAssignments:s,techniciansDetails:a,startDatetime:r,endDatetime:u,customerPhone:e.customer_phone??e.customerPhone??null,packages:c,companySharePercent:C,companyShareAmount:S,companyShareEnabled:A}}function Oe(e={}){if(!e||typeof e!="object")return{id:"",equipmentId:null,barcode:"",desc:"",qty:1,price:0,cost:0,notes:null,image:null};const t=e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=H(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),i=v(e.unit_price??e.unitPrice??e.price??e.total_price??e.total??0),c=v(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??0),o=h(String(e.barcode??e.code??e.serial??"")),s=e.description??e.desc??e.name??e.title??"",a={id:e.id!=null?String(e.id):t!=null?String(t):"",equipmentId:t,barcode:o,desc:s,qty:n,quantity:n,qtyPerPackage:null,totalQuantity:n,price:i,cost:c,notes:e.notes??null,image:e.image??e.image_url??e.imageUrl??null},l=Kt(e.type??e.item_type??e.kind??null),r=e.packageId??e.package_id??e.package_code??e.packageCode??e.bundleId??null,u=K(r),d=Be(e,u);if(l==="package"||u||d.length){a.type="package";const m=u||(t!=null?String(t):a.id?K(a.id):"");m&&(a.packageId=m,a.package_id=m,a.package_code=e.package_code??e.packageCode??m),a.name=s||a.package_code||m||"",a.barcode=a.barcode||h(String(e.package_code??e.packageCode??"")),a.packageItems=d;const _=Ut({...e,unit_price:e.unit_price??e.unitPrice??e.price,total_price:e.total_price??e.totalPrice??e.total},d,n);(!Number.isFinite(a.price)||a.price<=0||a.price>_*10)&&(a.price=_),a.qtyPerPackage=d.length?d[0]?.qtyPerPackage??a.qtyPerPackage:a.qtyPerPackage,a.totalQuantity=n}return a}function ei({reservationCode:e,customerId:t,start:n,end:i,status:c,title:o,location:s,notes:a,projectId:l,totalAmount:r,discount:u,discountType:d,applyTax:m,paidStatus:_,confirmed:g,items:y,packages:k,crewAssignments:p=[],technicians:b=p,companySharePercent:N,companyShareEnabled:P,paidAmount:A,paidPercentage:C,paymentProgressType:F,paymentProgressValue:S,paymentHistory:T}){const Q=Array.isArray(p)?p:[];return{reservation_code:e??null,customer_id:t,start_datetime:n,end_datetime:i,status:c??"pending",title:o??null,location:s??null,notes:a??null,project_id:l||null,total_amount:r??0,discount:u??0,discount_type:d??"percent",apply_tax:m?1:0,paid_status:_??"unpaid",paid_amount:Number.isFinite(A)?v(A):0,paid_percentage:Number.isFinite(C)?Number(C.toFixed(2)):0,payment_progress_type:F??null,payment_progress_value:Number.isFinite(S)?Number(S.toFixed(2)):null,payment_history:Array.isArray(T)?T.map(f=>({type:Ye(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?v(f.value):null,amount:f?.amount!=null?v(f.amount):f?.payment_amount!=null?v(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],payments:Array.isArray(T)?T.map(f=>({type:Ye(f?.type??f?.payment_type??f?.method??f?.paymentMethod),value:f?.value!=null?v(f.value):null,amount:f?.amount!=null?v(f.amount):f?.payment_amount!=null?v(f.payment_amount):null,percentage:f?.percentage!=null?Number(f.percentage):f?.payment_percentage!=null?Number(f.payment_percentage):null,note:f?.note??f?.notes??f?.comment??f?.payment_note??null,recorded_at:f?.recordedAt??f?.recorded_at??f?.createdAt??f?.created_at??f?.payment_date??f?.date??new Date().toISOString()})):[],confirmed:g===void 0?null:!!g,items:ni(y),packages:ii(y,k),company_share_percent:P&&Number.isFinite(N)?Number(N):null,company_share_enabled:P?1:0,technicians:Q.length?Q.map((f,U)=>{const G=f.technicianId??f.technician_id??f.id??null,O=f.positionId??f.position_id??f.position??f.position_code??null,j=f.positionLabel??f.position_name??f.role??null,V=v(f.positionCost??f.position_cost??f.cost??f.daily_wage??f.dailyWage??0),J=v(f.positionClientPrice??f.position_client_price??f.client_price??f.clientPrice??f.daily_total??f.dailyTotal??f.total??0);return{id:G,technician_id:G,role:j??f.technicianRole??null,notes:f.notes??null,position_id:O,position_key:f.positionKey??f.position_key??null,position_name:j,position_label_ar:f.positionLabelAr??f.position_label_ar??null,position_label_en:f.positionLabelEn??f.position_label_en??null,position_cost:V,position_client_price:J,client_price:J,cost:V,assignment_id:f.assignmentId??f.assignment_id??`crew-${U}`}}):Array.isArray(b)?b.map(f=>typeof f=="object"&&f!==null?{id:f.id??f.technician_id??f.technicianId??f.ID,role:f.role??null,notes:f.notes??null}:Number.isNaN(Number(f))?String(f):Number(f)):[]}}function ct(e){const t=st(e);return!Array.isArray(t)||t.length===0?[]:t.map(n=>{if(!n||typeof n!="object")return null;const i=n.type??n.payment_type??n.paymentType??n.method??n.paymentMethod??n.kind??null,c=Ye(i),o=n.value??n.payment_value??n.paymentValue??n.amount??n.payment_amount??n.percentage??n.payment_percentage??null,s=o!=null?Number.parseFloat(h(String(o))):null,a=n.amount!=null?Number.parseFloat(h(String(n.amount))):n.payment_amount!=null?Number.parseFloat(h(String(n.payment_amount))):null,l=n.percentage!=null?Number.parseFloat(h(String(n.percentage))):n.payment_percentage!=null?Number.parseFloat(h(String(n.payment_percentage))):null,r=Number.isFinite(a)?a:c==="amount"&&Number.isFinite(s)?s:null,u=Number.isFinite(l)?l:c==="percent"&&Number.isFinite(s)?s:null,d=c??(r!=null?"amount":u!=null?"percent":null),m=d==="amount"?r:d==="percent"?u:Number.isFinite(s)?s:null,_=n.note??n.notes??n.comment??n.payment_note??null,g=n.recordedAt??n.recorded_at??n.payment_date??n.date??n.createdAt??n.created_at??null;return{type:d,value:m,amount:r,percentage:u,note:_,recordedAt:g}}).filter(n=>n&&n.type)}function Ye(e){if(!e)return null;const t=String(e).trim().toLowerCase();return["amount","fixed","cash","value","money","sar","riyals"].includes(t)?"amount":["percent","percentage","ratio"].includes(t)?"percent":null}function st(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){const t=["data","items","records","history","list","entries","payment_history","paymentHistory","payment_records","paymentRecords","payments","payment"];for(const s of t)if(Array.isArray(e[s]))return e[s];const i=[e.data,e.items,e.records,e.history,e.list,e.entries,e.payment_history,e.paymentHistory,e.payment_records,e.paymentRecords,e.payments,e.payment].find(s=>Array.isArray(s));if(Array.isArray(i))return i;const c=Object.values(e);if(c.length&&c.every(s=>s&&typeof s=="object")){const s=c.map(a=>a);if(s.every(a=>!Array.isArray(a)))return s}if(["amount","payment_amount","value","payment_value","percentage","payment_percentage","type","payment_type","method","paymentMethod"].some(s=>s in e))return[e]}if(typeof e=="string")try{const t=JSON.parse(e);return st(t)}catch{return[]}return[]}function ti(e=[]){if(!Array.isArray(e))return[];for(const t of e){const n=st(t);if(Array.isArray(n)&&n.length)return n}return[]}function ni(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];return e.forEach(n=>{if(!n||typeof n!="object"||n.type==="package")return;const i=Array.isArray(n.packageItems)?n.packageItems:[],c=n.equipmentId??n.equipment_id??n.id??null;if(c==null)return;const o=(()=>{const s=v(n.cost??n.unit_cost??n.rental_cost??n.internal_cost??n.purchase_price??n.equipment_cost??0);if(Number.isFinite(s)&&s>0)return s;if(i.length){const a=i.reduce((l,r)=>{const u=v(r.cost??r.unit_cost??r.unitCost??r.rental_cost??r.internal_cost??r.purchase_price??r.equipment_cost??r.item_cost??0),d=H(r.qty??r.quantity??r.qtyPerPackage??r.unit_qty??1);return l+u*d},0);if(a>0)return Number(a.toFixed(2))}return s})();t.push({equipment_id:Ot(c),quantity:H(n.qty??n.quantity??1),unit_price:v(n.price??n.unit_price??0),unit_cost:o,cost:o,total_cost:Number.isFinite(o)?Number((o*H(n.qty??n.quantity??1)).toFixed(2)):0,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,notes:n.notes??null})}),t}function Ot(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:String(e)}function ii(e,t){const n=Array.isArray(t)?t.slice():[];return Array.isArray(e)&&e.forEach(i=>{if(!i||typeof i!="object"||i.type!=="package")return;const c=K(i.packageId??i.package_id??i.package_code??i.packageCode??i.bundleId??i.bundle_id??i.id??null),o=c?me(c):null,s=H(i.package_qty??i.packageQty??i.qty??i.quantity??o?.package_qty??1),a=_e(o||{})||[],l=Array.isArray(i.packageItems)&&i.packageItems.length?i.packageItems:a,r=Array.isArray(l)?l.map(m=>{const _=m?.equipmentId??m?.equipment_id??m?.id??null;if(_==null)return null;let g=v(m?.cost??m?.unit_cost??m?.unitCost??m?.rental_cost??m?.internal_cost??m?.purchase_price??m?.equipment_cost??m?.item_cost??0);if((!Number.isFinite(g)||g===0)&&_!=null){const y=si(_);Number.isFinite(y)&&y>0&&(g=y)}return{equipment_id:Ot(_),quantity:H(m?.qty??m?.quantity??m?.count??m?.units??m?.unit_qty??m?.unitQty??m?.unit_count??m?.unitCount??m?.package_quantity??m?.packageQty??1),unit_price:v(m?.price??m?.unit_price??0),unit_cost:g,cost:g,rental_cost:g,purchase_price:g,internal_cost:g,equipment_cost:g,item_cost:g}}).filter(Boolean):[],u=[i.package_cost,i.packageCost,i.unit_cost,i.unitCost,i.cost,i.rental_cost,i.internal_cost,i.purchase_price,i.equipment_cost,i.item_cost];let d=0;for(const m of u){const _=v(m);if(Number.isFinite(_)&&_>=0){d=_;break}}n.push({package_code:i.packageId??i.package_id??i.barcode??null,name:i.desc??i.name??"",quantity:s,unit_price:v(i.price??i.unit_price??0),unit_cost:d,cost:d,total_cost:Number.isFinite(d)?Number((d*s).toFixed(2)):0,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,items:r})}),n}function Kt(e){if(e==null)return"";const t=String(e).trim().toLowerCase();return t==="package"||t==="bundle"||t==="pack"?"package":t}function K(e){if(e==null)return"";const t=String(e).replace(/^package::/i,"");return ye(t)}function Je(e){return e==null?"":h(String(e)).trim().toLowerCase()}function Qt(e={},t=1){if(!e||typeof e!="object"){const r=h(String(e??""));return{equipmentId:null,equipment_id:null,qty:1,quantity:1,qtyPerPackage:1,price:0,unit_price:0,cost:0,unit_cost:0,rental_cost:0,purchase_price:0,internal_cost:0,equipment_cost:0,item_cost:0,barcode:r,normalizedBarcode:Je(r),desc:"",image:null}}const n=e.equipmentId??e.equipment_id??e.id??e.item_id??e.itemId??null,i=H(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),c=v(e.unit_price??e.unitPrice??e.price??0),o=v(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.internal_cost??e.purchase_price??e.equipment_cost??e.item_cost??0),s=h(String(e.barcode??e.normalizedBarcode??e.code??e.serial??"")),a=e.qtyPerPackage??e.qty_per_package??e.perPackageQty??e.per_package_qty??null;let l;if(a!=null)l=H(a,{fallback:1,max:99});else if(t>0){const r=i/t;Number.isFinite(r)&&r>0&&Number.isInteger(r)?l=H(r,{fallback:1,max:99}):l=Math.min(i,99)}else l=Math.min(i,99);return{equipmentId:n!=null?String(n):null,equipment_id:n,qty:l,quantity:l,qtyPerPackage:l,totalQuantity:i,price:c,unit_price:c,cost:o,unit_cost:o,rental_cost:o,purchase_price:o,internal_cost:o,equipment_cost:o,item_cost:o,barcode:s,normalizedBarcode:Je(e.normalizedBarcode??s),desc:e.desc??e.description??e.name??"",image:e.image??e.image_url??e.imageUrl??null}}function ai(e={},t={}){const n=K(e.packageId??e.package_id??e.id??t.packageId??t.package_id??t.id??""),i=H(e.quantity??e.qty??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),c=v(e.unit_price??e.unitPrice??e.price??t.price??t.unit_price??t.unitPrice??0),o=[e.package_cost,e.packageCost,e.unit_cost,e.unitCost,e.cost,e.rental_cost,e.internal_cost,e.purchase_price,e.equipment_cost,e.item_cost,t.package_cost,t.packageCost,t.unit_cost,t.unitCost,t.cost,t.rental_cost,t.internal_cost,t.purchase_price,t.equipment_cost,t.item_cost];let s=0;for(const l of o){const r=v(l);if(Number.isFinite(r)&&r>=0){s=r;break}}const a=h(String(e.package_code??e.packageCode??e.barcode??t.package_code??t.packageCode??t.barcode??""));return{id:t.id??(e.id!=null?String(e.id):n?`package::${n}`:""),equipmentId:null,barcode:a,desc:t.desc??t.description??e.name??e.desc??e.title??a,qty:i,quantity:i,price:c,cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s,item_cost:s,notes:t.notes??null,image:e.image??t.image??null,type:"package",packageId:n,package_id:n,package_code:a,packageItems:Array.isArray(e.packageItems)?e.packageItems:Array.isArray(t.packageItems)?t.packageItems:[]}}function rt(e=[],t=[]){const n=oi(e),i=Array.isArray(t)?ue(t,n.packages):n.packages,c=new Map;return i.forEach(o=>{const s=K(o.packageId??o.package_id??o.id);s&&c.set(s,o)}),n.packages.forEach(o=>{const s=K(o.packageId??o.package_id??o.id);if(!s)return;const a=c.get(s);a&&((!Array.isArray(a.packageItems)||a.packageItems.length===0)&&(a.packageItems=o.packageItems),!a.name&&o.name&&(a.name=o.name),!a.image&&o.image&&(a.image=o.image))}),{items:n.items,packages:Array.from(c.values())}}function oi(e=[]){const t=new Map;if(e.forEach(o=>{const s=K(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(!s)return;const a=s;t.has(a)||t.set(a,{base:o,items:[]});const l=t.get(a);if(o.type==="package"){l.base=o;return}l.base||(l.base=o),l.items.push(o)}),!t.size)return{items:e,packages:[]};const n=[],i=[],c=new Set;return e.forEach(o=>{const s=K(o.packageId??o.package_id??o.packageCode??o.package_code??o.bundleId??o.bundle_id??null);if(s&&t.has(s)){if(c.has(s))return;const a=t.get(s),l=a.base||o,r=a.items.map(_=>Qt(_,1)),u=[l.package_cost,l.packageCost,l.unit_cost,l.unitCost,l.cost,l.rental_cost,l.internal_cost,l.purchase_price,l.equipment_cost,l.item_cost];let d=0;for(const _ of u){const g=v(_);if(Number.isFinite(g)&&g>=0){d=g;break}}const m={packageId:s,package_id:s,package_code:l.package_code??l.packageCode??l.barcode??h(String(s)),name:l.package_name??l.packageName??l.desc??l.name??`Package ${s}`,quantity:H(l.package_quantity??l.packageQty??1,{fallback:1,max:9999}),unit_price:v(l.package_price??l.packagePrice??l.price??0),unit_cost:d,unitCost:d,cost:d,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,item_cost:d,packageItems:r,image:l.image??null};i.push(m),n.push(ai(m,l)),c.add(s);return}n.push(o)}),{items:n,packages:i}}function Be(e={},t=""){if(!e||typeof e!="object")return[];const n=K(t||e.packageId||e.package_id||e.package_code||e.packageCode||e.bundleId||e.bundle_id||e.id),i=[];Array.isArray(e.packageItems)&&i.push(...e.packageItems),Array.isArray(e.package_items)&&i.push(...e.package_items),Array.isArray(e.items)&&i.push(...e.items),Array.isArray(e.equipment)&&i.push(...e.equipment),Array.isArray(e.contents)&&i.push(...e.contents);let c=_e({...e,id:e.id??n??e.package_code??e.packageCode??e.code??null,package_code:e.package_code??e.packageCode??e.code??e.id??n,items:i,packageItems:i}),o=[];if((!Array.isArray(c)||c.length===0)&&n){const r=me(n);r&&(c=_e(r),o=Array.isArray(c)?c:[])}else if(n){const r=me(n);r&&(o=_e(r)||[])}if(!Array.isArray(c)||c.length===0)return[];const s=H(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1,{fallback:1,max:9999}),a=c.map(r=>Qt(r,s));if(o.length){const r=new Map;o.forEach(u=>{if(!u)return;const d=Je(u.barcode)||(u.equipmentId!=null?`id:${u.equipmentId}`:null)||(u.equipment_id!=null?`id:${u.equipment_id}`:null);d&&r.set(d,u)}),a.forEach(u=>{const d=u.normalizedBarcode||(u.equipmentId?`id:${u.equipmentId}`:null);if(!d||!r.has(d))return;const m=r.get(d),_=H(m.quantity??m.qty??1,{fallback:u.qtyPerPackage??1,max:99});u.qtyPerPackage=_,u.qty=_,u.quantity=_;const g=v(m.unit_price??m.unitPrice??m.price??u.price);u.price=g,u.unit_price=g,!u.desc&&m.desc&&(u.desc=m.desc),!u.image&&m.image&&(u.image=m.image)})}const l=new Map;return a.forEach(r=>{const u=r.normalizedBarcode||(r.equipmentId?`id:${r.equipmentId}`:null);if(u){if(l.has(u)){const d=l.get(u);d.qty+=r.qty,d.quantity+=r.quantity,(!Number.isFinite(d.qtyPerPackage)||d.qtyPerPackage<=0)&&(d.qtyPerPackage=r.qtyPerPackage),(!d.price||d.price===0)&&r.price&&(d.price=r.price,d.unit_price=r.unit_price),!d.desc&&r.desc&&(d.desc=r.desc),!d.image&&r.image&&(d.image=r.image);return}l.set(u,{...r})}}),Array.from(l.values())}function Ut(e={},t=[],n=1){try{const o=K(e.packageId??e.package_id??e.id??e.package_code??e.packageCode);if(o){const s=me(o);if(s){const a=At(s);if(Number.isFinite(Number(a))&&Number(a)>0)return Number(a)}}}catch{}const i=e.package_price??e.packagePrice??e.unit_price??e.unitPrice??e.price;if(Number.isFinite(Number(i))&&Number(i)>0)return v(i);const c=e.total_price??e.totalPrice??e.total??e.amount??null;if(Number.isFinite(Number(c))){const o=v(c);return n>0?Number((o/n).toFixed(2)):o}return 0}function Gt(e,t){if(!e)return t;if(!t)return e;const n={...e},i=s=>{(n[s]===void 0||n[s]===null||n[s]==="")&&(n[s]=t[s])};["name","desc","barcode","image"].forEach(i),(!Number.isFinite(Number(n.unit_price))||n.unit_price===0)&&Number.isFinite(Number(t.unit_price))&&(n.unit_price=t.unit_price,n.unitPrice=t.unitPrice,n.price=t.price);const c=v(n.unit_cost??n.unitCost??n.cost??n.package_cost??n.rental_cost??n.purchase_price??n.internal_cost??n.equipment_cost??n.item_cost),o=v(t.unit_cost??t.unitCost??t.cost??t.package_cost??t.rental_cost??t.purchase_price??t.internal_cost??t.equipment_cost??t.item_cost);if((!Number.isFinite(c)||c===0)&&Number.isFinite(o)){const s=o;n.unit_cost=s,n.unitCost=s,n.cost=s,n.total_cost=Number.isFinite(t.total_cost)?t.total_cost:n.total_cost,Number.isFinite(n.rental_cost)||(n.rental_cost=s),Number.isFinite(n.purchase_price)||(n.purchase_price=s),Number.isFinite(n.internal_cost)||(n.internal_cost=s),Number.isFinite(n.equipment_cost)||(n.equipment_cost=s),Number.isFinite(n.item_cost)||(n.item_cost=s)}return(!Number.isFinite(Number(n.total_price))||n.total_price===0)&&Number.isFinite(Number(t.total_price))&&(n.total_price=t.total_price,n.total=t.total),!Array.isArray(n.packageItems)||n.packageItems.length===0?(n.packageItems=Array.isArray(t.packageItems)?t.packageItems:[],n.items=n.packageItems):Array.isArray(t.packageItems)&&t.packageItems.length&&(n.packageItems=ci(n.packageItems,t.packageItems),n.items=n.packageItems),n}function ci(e=[],t=[]){const n=new Map,i=c=>{c.forEach(o=>{if(!o)return;const s=o.normalizedBarcode||(o.equipmentId?`id:${o.equipmentId}`:null);if(s){if(n.has(s)){const a=n.get(s);a.qty+=o.qty??0,a.quantity+=o.quantity??0,(!Number.isFinite(a.qtyPerPackage)||a.qtyPerPackage<=0)&&Number.isFinite(o.qtyPerPackage)&&(a.qtyPerPackage=o.qtyPerPackage),(!a.price||a.price===0)&&o.price&&(a.price=o.price,a.unit_price=o.unit_price);const l=v(a.cost??a.unit_cost??a.unitCost??a.rental_cost??a.purchase_price??a.internal_cost??a.equipment_cost??a.item_cost),r=v(o.cost??o.unit_cost??o.unitCost??o.rental_cost??o.purchase_price??o.internal_cost??o.equipment_cost??o.item_cost);if((!Number.isFinite(l)||l===0)&&Number.isFinite(r)){const u=r;a.cost=u,a.unit_cost=u,a.unitCost=u,Number.isFinite(a.rental_cost)||(a.rental_cost=u),Number.isFinite(a.purchase_price)||(a.purchase_price=u),Number.isFinite(a.internal_cost)||(a.internal_cost=u),Number.isFinite(a.equipment_cost)||(a.equipment_cost=u),Number.isFinite(a.item_cost)||(a.item_cost=u)}!a.desc&&o.desc&&(a.desc=o.desc),!a.image&&o.image&&(a.image=o.image);return}n.set(s,{...o})}})};return i(e),i(t),Array.from(n.values())}function ue(e=[],t=[]){const n=[],i=new Map,c=Ze(),o=new Map;c.forEach(l=>{const r=K(l?.id??l?.packageId??l?.package_id??l?.code??""),u=String(l?.package_code??l?.code??"").trim().toLowerCase();u&&o.set(u,r||u)});const s=l=>{const r=K(l?.packageId??l?.package_id??l?.id??null),u=String(l?.package_code??l?.code??l?.barcode??"").trim().toLowerCase(),d=u?h(u):"";return r||(d&&o.has(d)?o.get(d):d||null)},a=l=>{Array.isArray(l)&&l.forEach(r=>{if(!r||typeof r!="object")return;const u=s(r);if(u)if(i.has(u)){const d=i.get(u);n[d]=Gt(n[d],r)}else i.set(u,n.length),n.push({...r})})};return a(e),a(t),n}function si(e){if(e==null)return 0;const t=pe()||{},i=(Array.isArray(t.equipment)?t.equipment:[]).find(o=>[o.id,o.equipment_id,o.equipmentId,o.item_id,o.itemId].some(a=>String(a)===String(e)));if(!i)return 0;const c=v(i.cost??i.unit_cost??i.unitCost??i.rental_cost??i.purchase_price??i.internal_cost??i.equipment_cost??i.item_cost??0);return Number.isFinite(c)&&c>0?c:0}function Wt(e,t=0){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number"){const g=K(e),y=g?me(g):null,k=y?Be(y,g):[],p=y?v(y.price??y.unit_price??y.unitPrice??0):0,N=(()=>{const F=[y?.package_cost,y?.packageCost,y?.unit_cost,y?.unitCost,y?.cost,y?.rental_cost,y?.internal_cost,y?.purchase_price,y?.equipment_cost,y?.item_cost];for(const S of F){const T=v(S);if(Number.isFinite(T)&&T>=0)return T}return 0})(),P=1,A=Number((p*P).toFixed(2)),C=Number((N*P).toFixed(2));return{id:`package::${g||t}`,packageId:g||`pkg-${t}`,package_id:g||`pkg-${t}`,package_code:h(String(e))||g||`pkg-${t}`,name:y?.name??y?.package_name??y?.packageName??h(String(e))??"",desc:y?.name??h(String(e))??"",quantity:P,qty:P,unit_price:p,unitPrice:p,price:p,unit_cost:N,unitCost:N,cost:N,total_cost:C,rental_cost:N,purchase_price:N,internal_cost:N,equipment_cost:N,item_cost:N,total:A,total_price:A,barcode:h(String(e)),packageItems:k,items:k,type:"package",image:y?.image??null}}if(typeof e!="object")return null;const n=K(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.slug??e.id)||`pkg-${t}`,i=H(e.quantity??e.qty??e.count??e.units??e.unit_qty??e.unitQty??e.unit_count??e.unitCount??e.package_quantity??e.packageQty??1),c=Be(e,n),o=Ut(e,c,i),a=(()=>{const g=[e.package_cost,e.packageCost,e.unit_cost,e.unitCost,e.cost,e.rental_cost,e.internal_cost,e.purchase_price,e.equipment_cost,e.item_cost];for(const y of g){const k=v(y);if(Number.isFinite(k)&&k>=0)return k}return 0})(),l=e.total_price??e.totalPrice??e.total??o*i,r=Number.isFinite(Number(l))?v(l):Number((o*i).toFixed(2)),u=Number.isFinite(a)?Number((a*i).toFixed(2)):0,d=e.package_code??e.packageCode??e.code??n,m=h(String(e.barcode??d??"")),_=e.image??e.cover??e.thumbnail??c.find(g=>g.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,packageId:n,package_id:n,package_code:d,name:e.name??e.package_name??e.packageName??e.title??e.description??d??n,desc:e.name??e.package_name??e.packageName??e.title??e.description??d??n,quantity:i,qty:i,unit_price:o,unitPrice:o,price:o,unit_cost:a,unitCost:a,cost:a,total_cost:u,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a,item_cost:a,total:r,total_price:r,barcode:m,packageItems:c,items:c,type:"package",image:_}}function lt(e={}){const t=[];Array.isArray(e.packages)&&t.push(e.packages),Array.isArray(e.reservation_packages)&&t.push(e.reservation_packages),Array.isArray(e.reservationPackages)&&t.push(e.reservationPackages),Array.isArray(e.package_details)&&t.push(e.package_details),Array.isArray(e.packageDetails)&&t.push(e.packageDetails),Array.isArray(e.package_list)&&t.push(e.package_list),Array.isArray(e.packageList)&&t.push(e.packageList);const n=[],i=new Map,c=(a,l=n.length)=>{const r=Wt(a,l);if(!r)return;const u=r.packageId||r.package_code||r.id||`pkg-${l}`;if(i.has(u)){const d=i.get(u);n[d]=Gt(n[d],r)}else i.set(u,n.length),n.push(r)};t.forEach(a=>{a.forEach((l,r)=>{c(l,r+n.length)})}),n.length===0&&e.package&&c(e.package,0);const o=Array.isArray(e.items)?e.items:[],s=(a={})=>!a||typeof a!="object"?!1:!!(Kt(a.type??a.item_type??a.kind??null)==="package"||a.packageItems&&Array.isArray(a.packageItems)&&a.packageItems.length||a.items&&Array.isArray(a.items)&&a.items.length&&a.items.every(r=>typeof r=="object")||a.packageId||a.package_id||a.package_code||a.packageCode||a.bundleId||a.bundle_id);return o.forEach((a,l)=>{s(a)&&c(a,n.length+l)}),n}function v(e){const t=x(e);return Number.isFinite(t)?Number(t.toFixed(2)):0}function H(e,{fallback:t=1,max:n=1e6}={}){const i=x(e);if(!Number.isFinite(i))return t;const c=Math.round(i);return c<=0||c>n?t:c}function ri(e){switch(String(e??"").trim().toLowerCase()){case"pending":case"Ù…Ø¹Ù„Ù‚":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"pending";case"confirmed":case"Ù…Ø¤ÙƒØ¯":return"confirmed";case"in_progress":case"in-progress":case"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":case"Ø¬Ø§Ø±ÙŠ":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":case"Ù…Ù„ØºÙŠØ©":case"Ù…Ù„ØºÙ‰":case"canceled":return"cancelled";default:return"pending"}}function li(e){if(e==null)return null;switch(String(e).trim().toLowerCase()){case"paid":case"Ù…Ø¯ÙÙˆØ¹":return"paid";case"partial":case"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹":case"partial_paid":return"partial";case"unpaid":case"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹":case"not_paid":default:return"unpaid"}}function ui(e){return e instanceof Zt}const Ii=Object.freeze(Object.defineProperty({__proto__:null,buildReservationPayload:ei,closeReservationApi:Zn,confirmReservationApi:Xn,createReservationApi:Gn,deleteReservationApi:Jn,getCachedReservationCrew:On,getReservationsState:Qn,isApiError:ui,mapLegacyReservation:Ht,mapReservationFromApi:Ve,mapReservationItem:Oe,refreshReservationsFromApi:Un,setReservationsState:Ee,toInternalReservation:He,updateReservationApi:ot},Symbol.toStringTag,{value:"Module"}));export{He as A,Dn as B,vn as C,Et as D,x as E,w as F,On as G,gi as H,bn as I,yi as J,Ht as K,An as L,Xn as M,Zn as N,Ii as O,Ni as a,$n as b,tt as c,Ce as d,nt as e,Jn as f,Qn as g,ki as h,mi as i,bi as j,yn as k,wn as l,Ve as m,Lt as n,In as o,qn as p,kn as q,Un as r,fi as s,ei as t,ot as u,Gn as v,ui as w,_i as x,pt as y,hi as z};
