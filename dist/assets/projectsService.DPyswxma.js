import{d as ee,h as te,b as j,A as ne,n as k}from"./auth.DMxYhRbd.js";const re=ee()||{};let d=(re.projects||[]).map(ce),S=!1;function l(e){if(e==null||e==="")return 0;const r=k(String(e)).replace(/[^\d.+-]/g,""),t=Number.parseFloat(r);return Number.isFinite(t)?t:0}function ue(){return d}function P(e){d=Array.isArray(e)?e.map(z):[],te({projects:d});try{const r=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(r),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(r)}catch(r){console.warn("⚠️ [projectsService] Failed to dispatch projects:changed event",r)}return d}async function oe(e={}){const r=new URLSearchParams;Object.entries(e).forEach(([_,m])=>{m==null||m===""||r.set(_,String(m))});const t=r.toString(),o=(await j(`/projects/${t?`?${t}`:""}`))?.data;let i=[];Array.isArray(o)?i=o:o&&typeof o=="object"&&(Array.isArray(o.items)?i=o.items:Array.isArray(o.results)?i=o.results:Array.isArray(o.data)?i=o.data:Array.isArray(o.records)&&(i=o.records));const y=i.map($);return P(y),S=!0,d}async function pe({force:e=!1,params:r=null}={}){if(!e&&S&&d.length>0)return d;try{return await oe(r||{})}catch(t){return console.error("❌ [projectsService] Failed to load projects from API",t),d}}async function de(e){const r=await j("/projects/",{method:"POST",body:e}),t=$(r?.data??{}),a=[...d,t];return P(a),S=!0,t}async function V(e,r){const t=await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:r}),a=$(t?.data??{}),o=d.map(i=>String(i.id)===String(e)?a:i);return P(o),S=!0,a}function ie(e="",r=""){const t=String(e||"").trim(),a=String(r||"").trim();if(!a)return t;const i=`ملاحظة إغلاق: ${a}`;return t?`${t}
${i}`:i}function ae(e=""){const r=String(e||"");if(!r.trim())return"";const t=["ملاحظة إغلاق","Close note"];let a=-1;for(const i of t){const y=r.lastIndexOf(i);y>a&&(a=y)}return a===-1?r:r.slice(0,a).replace(/\n$/,"")}async function me(e,r=""){const t=d.find(o=>String(o.id)===String(e)),a=ie(t?.description||"",r||"");return V(e,{status:"completed",confirmed:!0,description:a})}async function fe(e){const r=d.find(a=>String(a.id)===String(e)),t=ae(r?.description||"");return V(e,{status:"ongoing",confirmed:!0,description:t})}async function ye(e){await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const r=d.filter(t=>String(t.id)!==String(e));P(r),S=!0}function _e({projectCode:e,title:r,type:t,clientId:a,clientCompany:o,description:i,start:y,end:_,applyTax:m,paymentStatus:f,equipmentEstimate:g=0,expenses:h=[],servicesClientPrice:q=0,taxAmount:b=0,totalWithTax:n=0,discount:p=0,discountType:x="percent",companyShareEnabled:I=!1,companySharePercent:N=null,companyShareAmount:G=0,paidAmount:C=null,paidPercentage:E=null,paymentProgressType:v=null,paymentProgressValue:F=null,confirmed:J=!1,technicians:B=[],equipment:L=[],payments:O,paymentHistory:K}={}){const Q=Array.isArray(B)?B.map(c=>Number.parseInt(String(c),10)).filter(c=>Number.isInteger(c)&&c>0):[],X=Array.isArray(L)?L.map(c=>{const s=Number.parseInt(String(c.equipmentId??c.equipment_id??c.id??0),10),A=Number.parseInt(String(c.qty??c.quantity??0),10);return!Number.isInteger(s)||s<=0?null:{equipment_id:s,quantity:Number.isInteger(A)&&A>0?A:1}}).filter(Boolean):[],H=Array.isArray(h)?h.map(c=>{const s=l(c?.amount??c?.value??0),A=(c?.label??c?.name??"").trim();if(!A)return null;const w=l(c?.salePrice??c?.sale_price??0),R=(c?.note??c?.notes??"").toString().trim();return{label:A,amount:Math.round(s*100)/100,sale_price:Math.max(0,Math.round(w*100)/100),note:R||void 0,...R?{notes:R}:{}}}).filter(Boolean):[],Y=H.reduce((c,s)=>c+(s?.amount??0),0),u={title:r,type:t,client_id:a?Number.parseInt(String(a),10):null,client_company:o??null,description:i??null,start_datetime:y??null,end_datetime:_||null,apply_tax:!!m,payment_status:f??"unpaid",equipment_estimate:l(g),expenses_total:Math.round(Y*100)/100,services_client_price:Math.round(l(q)*100)/100,tax_amount:Math.round(l(b)*100)/100,total_with_tax:Math.round(l(n)*100)/100,confirmed:!!J,technicians:Q,equipment:X,expenses:H},Z=Math.max(0,Number.parseFloat(p)||0);u.discount=Z,u.discount_type=x==="amount"?"amount":"percent";const T=l(N),M=!!I&&Number.isFinite(T)&&T>0;u.company_share_enabled=M,u.company_share_percent=M?T:0,u.company_share_amount=M?Math.max(0,l(G)):0,C!=null&&C!==""&&(u.paid_amount=Math.max(0,l(C))),E!=null&&E!==""&&(u.paid_percentage=Math.max(0,l(E))),(v==="amount"||v==="percent")&&(u.payment_progress_type=v),F!=null&&F!==""&&(u.payment_progress_value=l(F)),e&&(u.project_code=String(e).trim());const U=O!==void 0?O:K;if(U!==void 0){const c=W(U)||[];u.payments=c.map(s=>({type:s.type,amount:s.amount!=null?s.amount:null,percentage:s.percentage!=null?s.percentage:null,value:s.value!=null?s.value:null,note:s.note??null,recorded_at:s.recordedAt??null}))}return u.end_datetime||delete u.end_datetime,u.client_company||(u.client_company=null),u}function $(e={}){return z(e)}function ce(e={}){return z(e)}function z(e={}){const r=e.id??e.projectId??e.project_id??null,t=Array.isArray(e.technicians)?e.technicians:[],a=t.map(n=>{if(n==null)return null;if(typeof n=="object"){const p=n.id??n.technician_id??n.technicianId;return p!=null?String(p):null}return String(n)}).filter(Boolean),i=(Array.isArray(e.equipment)?e.equipment:[]).map(n=>{const p=n?.equipment_id??n?.equipmentId??n?.id??null,x=n?.quantity??n?.qty??0,I=n?.barcode??n?.code??"",N=n?.description??n?.name??"";return{equipmentId:p!=null?String(p):null,qty:Number.parseInt(String(x),10)||0,barcode:I,description:N}}),_=(Array.isArray(e.expenses)?e.expenses:[]).map((n,p)=>({id:n?.id??`expense-${r??"x"}-${p}`,label:n?.label??"",amount:l(n?.amount??0),salePrice:l(n?.sale_price??n?.salePrice??0),note:n?.note??n?.notes??""})),m=l(e.company_share_percent??e.companySharePercent??0),f=e.company_share_enabled??e.companyShareEnabled,g=f!=null?f===!0||f===1||String(f).toLowerCase()==="true":m>0,h=e.payment_history??e.paymentHistory??e.payments??null,q=W(h),b=(()=>{const n=e.cancelled??e.canceled??e.is_cancelled??e.isCanceled;if(n===!0||n==="true"||n===1||n==="1")return!0;if(typeof n=="string"){const p=n.toLowerCase();return p==="yes"||p==="cancelled"||p==="canceled"}return!1})();return{id:r!=null?String(r):"",projectId:r!=null?Number(r):null,status:(()=>{const n=String(e.status??e.project_status??"").toLowerCase();if(b||n==="cancelled"||n==="canceled"||n==="ملغي"||n==="ملغى")return"cancelled";if(n==="completed"||n==="مكتمل")return"completed";if(n==="ongoing"||n==="in_progress"||n==="قيد التنفيذ")return"ongoing";if(n==="upcoming"||n==="قادم")return"upcoming"})(),cancelled:b,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:l(e.equipment_estimate??e.equipmentEstimate??0),expensesTotal:l(e.expenses_total??e.expensesTotal??0),servicesClientPrice:l(e.services_client_price??e.servicesClientPrice??0),taxAmount:l(e.tax_amount??e.taxAmount??0),totalWithTax:l(e.total_with_tax??e.totalWithTax??0),discount:l(e.discount??e.discount_value??0),discountType:e.discount_type??e.discountType??"percent",companyShareEnabled:g,companySharePercent:g?m:0,companyShareAmount:l(e.company_share_amount??e.companyShareAmount??0),paidAmount:l(e.paid_amount??e.paidAmount??0),paidPercent:l(e.paid_percentage??e.paidPercent??0),paymentProgressType:e.payment_progress_type??e.paymentProgressType??null,paymentProgressValue:e.payment_progress_value??e.paymentProgressValue??null,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:a,techniciansDetails:t.map(n=>typeof n=="object"?n:{id:n}),equipment:i,expenses:_,paymentHistory:q}}function ge(e){return e instanceof ne}function D(e){if(e==null||e==="")return null;const r=k(String(e)).replace(/[^\d.,-]/g,"").trim();if(!r)return null;let t=r;const a=t.includes(","),o=t.includes(".");a&&(t=o?t.replace(/,/g,""):t.replace(/,/g,"."));const i=Number.parseFloat(t);return Number.isFinite(i)?i:null}function le(e){if(!e||typeof e!="object")return null;const r=e.type??e.payment_type??e.paymentType??e.kind??null;let t=typeof r=="string"?r.trim().toLowerCase():null;t==="percentage"&&(t="percent");const a=D(e.value);let o=D(e.amount),i=D(e.percentage);if(t==="amount"&&o==null&&a!=null?o=a:t==="percent"&&i==null&&a!=null&&(i=a),!t)if(o!=null&&o>=0)t="amount";else if(i!=null&&i>=0)t="percent";else if(a!=null&&a>=0)t="amount",o=a;else return null;if(t==="amount"){if(o==null||!Number.isFinite(o)||o<0)return null;o=Math.round(o*100)/100}if(t==="percent"){if(i==null||!Number.isFinite(i)||i<0)return null;i=Math.min(100,Math.round(i*100)/100)}const y=e.note??e.memo??e.description??null,_=y!=null?String(y).trim():null,m=e.recordedAt??e.recorded_at??e.date??null;let f=null;if(m){const h=new Date(m);Number.isNaN(h.getTime())||(f=h.toISOString())}f||(f=new Date().toISOString());const g=t==="amount"?o:t==="percent"?i:a;return{type:t,amount:o??null,percentage:i??null,value:g!=null?Math.round(g*100)/100:null,note:_&&_.length?_.slice(0,500):null,recordedAt:f}}function W(e){if(e!==void 0)return e===null?[]:Array.isArray(e)?e.map(r=>le(r)).filter(Boolean):[]}export{_e as buildProjectPayload,me as closeProjectApi,de as createProjectApi,ye as deleteProjectApi,pe as ensureProjectsLoaded,ue as getProjectsState,ge as isApiError,ce as mapLegacyProject,$ as mapProjectFromApi,oe as refreshProjectsFromApi,fe as reopenProjectApi,P as setProjectsState,V as updateProjectApi};
