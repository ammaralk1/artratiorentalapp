import{n as J,r as X,i as Z,p as v,b as tt,m as $}from"./reservationsService.JrjTF74k.js";import{t as et,n as F,g as L}from"./auth.F9sgKPc9.js";const y={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function ut(t){y.callbacks.onRender=typeof t=="function"?t:null}function it(t){y.callbacks.onBeforeRender=typeof t=="function"?t:null}function mt(t){y.callbacks.onAfterRender=typeof t=="function"?t:null}function dt(t){y.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function pt(t){y.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function ft(t){y.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function D(t,n,s=n){const o=L()==="en"?s??n:n;return et(t,o)}function gt(){y.formatters.cachedLocale=null,y.formatters.numberFormatter=null}function I(){return(L()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function H(){const t=L();if(t!==y.formatters.cachedLocale||!y.formatters.numberFormatter||!y.formatters.currencyFormatter){y.formatters.cachedLocale=t;const n=I();y.formatters.numberFormatter=new Intl.NumberFormat(n,{maximumFractionDigits:0}),y.formatters.currencyFormatter=new Intl.NumberFormat(n,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:y.formatters.numberFormatter,currencyFormatter:y.formatters.currencyFormatter}}function ht(t){const{numberFormatter:n}=H(),s=n.format(Math.round(t||0));return F(s)}function yt(t){const{currencyFormatter:n}=H(),s=Number.isFinite(Number(t))?Number(t):0,a=n.format(s);return`${F(a)} SR`}function k(t){const n=t instanceof Date?t:new Date(t);if(!(n instanceof Date)||Number.isNaN(n.getTime()))return"";const s=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0");return`${s}-${a}-${o}`}function bt(t){if(!t)return"—";const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return"—";const s=new Intl.DateTimeFormat(I(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return F(s.format(n))}function K(t){return new Intl.DateTimeFormat(I(),{month:"short"}).format(t)}const nt=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),j=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),E=1440*60*1e3,S={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function C(t){const n=Array.isArray(t)?t.length:0;if(n===0)return"0|";const s=t[0]||{},a=t[n-1]||{},o=`${s.id??s.reservationId??""}-${s.start??""}`,e=`${a.id??a.reservationId??""}-${a.start??""}`,r=y.formatters?.cachedLocale||"ar";return`${n}|${o}|${e}|${r}`}function P(t,n){return t.get(n)}function R(t,n,s){if(t.set(n,s),t.size>64){const a=t.keys().next().value;t.delete(a)}return s}function O(t){return F(String(t||"")).toLowerCase().trim()}function x(t){return(t||"").toString().trim()}function U(t,n){if(!t||!n)return 1;const s=new Date(t),a=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(a.getTime()))return 1;const o=a.getTime()-s.getTime();return o<=0?1:Math.max(1,Math.ceil(o/E))}function q(t){return t?(y.techniciansIndex||(y.techniciansIndex=new Map((y.data.technicians||[]).map(n=>[String(n.id),n]))),y.techniciansIndex.get(String(t))||null):null}function Y(t={}){const n=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const s of n){if(s==null)continue;const a=Number.parseFloat(F(String(s)));if(Number.isFinite(a))return a}return 0}function B(t={}){const n=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const s of n){if(s==null)continue;const a=Number.parseFloat(F(String(s)));if(Number.isFinite(a))return a}return Y(t)}function A(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;U(t.start,t.end);const n=Number(t.discount??t.discountValue??0)||0,s=t.discountType||t.discount_type||"percent",a=String(s).toLowerCase()==="amount"?"amount":"percent",o=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",e=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,r=e!=null?v(e):Number.NaN,l=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(r)&&r>0?r:null,m=Array.isArray(t.crewAssignments)?t.crewAssignments:[],d=m.length?m.map(h=>h?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],c=tt({items:Array.isArray(t.items)?t.items:[],technicianIds:d,crewAssignments:m,discount:n,discountType:a,applyTax:o,start:t.start,end:t.end,companySharePercent:l}),u=Number(t.cost);let p=c.finalTotal,f=c.taxAmount;if(Number.isFinite(u)&&u>0&&(p=$(u),o)){const h=p-c.taxableAmount;Number.isFinite(h)&&h>=0&&(f=$(h))}const g={rentalDays:c.rentalDays,equipmentTotal:c.equipmentTotal,crewTotal:c.crewTotal,crewCostTotal:c.crewCostTotal,discountAmount:c.discountAmount,subtotalAfterDiscount:c.subtotalAfterDiscount,taxableAmount:c.taxableAmount,taxAmount:f,finalTotal:p,companySharePercent:c.companySharePercent,companyShareAmount:c.companyShareAmount,netProfit:c.netProfit,companyShareEnabled:c.companySharePercent>0};return t.__financials=g,g}function W(t){return t?.projectId&&y.data.projectsMap.get(String(t.projectId))||null}function V(t=""){const n=String(t).toLowerCase().trim();return n?nt.get(n)||n:""}function at(t){const n=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const s of n){const a=String(s||"").toLowerCase().trim();if(a&&j.has(a))return j.get(a)}return t?.paid===!0||t?.paid==="true"}function N(t){const n=W(t),s=X(t,n),a=V(s.projectStatus);let o=V(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");s.projectLinked&&a&&o!=="cancelled"&&(o=a),o||(o=s.effectiveConfirmed?"confirmed":"pending"),o!=="cancelled"&&(Z(t)||a==="completed")&&(o="completed");let e=s.effectiveConfirmed||o==="confirmed"||o==="completed";o==="cancelled"&&(e=!1),e&&o!=="completed"&&o!=="cancelled"&&(o="confirmed");const r=at(t),i=t?.paidStatus??t?.paid_status??(r?"paid":"unpaid");return{statusValue:o,confirmed:e,paid:r,paidStatus:i}}function wt(t){const n=t.length;let s=0,a=0,o=0,e=0,r=0,i=0,l=0,m=0,d=0,c=0;t.forEach(p=>{const{statusValue:f,confirmed:g,paid:h}=N(p);if(f==="completed"&&(a+=1),f==="cancelled"&&(o+=1),g&&(s+=1),h&&f!=="cancelled"&&(e+=1),f!=="cancelled"){const b=A(p);r+=b.finalTotal,i+=b.companyShareAmount,l+=b.taxAmount,m+=b.crewTotal,d+=b.crewCostTotal??0,c+=b.netProfit}});const u=n?r/n:0;return{total:n,confirmed:s,completed:a,cancelled:o,activeTotal:Math.max(0,n-o),paidCount:e,revenue:r,average:u,companyShareTotal:i,taxTotal:l,crewTotal:m,crewCostTotal:d,netProfit:c}}function G({range:t,start:n,end:s}){const a=new Date;if(a.setHours(23,59,59,999),t==="custom"){const r=n?new Date(`${n}T00:00:00`):null,i=s?new Date(`${s}T23:59:59`):null;return{startDate:z(r)?r:null,endDate:z(i)?i:null}}let o=new Date(a),e=null;switch(t){case"last30":{e=new Date(a),e.setDate(e.getDate()-29);break}case"thisWeek":{const r=new Date(a),l=(r.getDay()-6+7)%7;r.setDate(r.getDate()-l),r.setHours(0,0,0,0);const m=new Date(r);m.setDate(r.getDate()+6),m.setHours(23,59,59,999),e=r,o=m;break}case"thisMonth":{e=new Date(a.getFullYear(),a.getMonth(),1),o=new Date(a.getFullYear(),a.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const r=Math.floor(a.getMonth()/3);e=new Date(a.getFullYear(),r*3,1),o=new Date(a.getFullYear(),(r+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{e=new Date(a.getFullYear(),0,1),o=new Date(a.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:e=null,o=null;break}return e&&e.setHours(0,0,0,0),{startDate:e,endDate:o}}function z(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function Dt(t,n){const{startDate:s,endDate:a}=G(n);let o=0;const e=[];return(t||[]).forEach(r=>{if(!r)return;const i=typeof r.repairCost=="number"?r.repairCost:Number.parseFloat(F(String(r.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const l=String(r.statusRaw??r.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const d=r.resolvedAt??r.resolved_at??null,c=r.reportedAt??r.reported_at??null,u=r.createdAt??r.created_at??null,p=d?new Date(d):null,f=c?new Date(c):u?new Date(u):null,g=p&&!Number.isNaN(p.getTime())?p:f&&!Number.isNaN(f.getTime())?f:null;if(g&&(s&&g<s||a&&g>a))return;const h=Math.round(i*100)/100;o+=h,e.push({id:r.id,cost:h,date:g})}),{total:o,items:e}}function Nt(t,n){const s=Number.isFinite(n)?n:0;return{...t,maintenanceExpense:s,netProfit:(t.netProfit||0)-s}}function St(t){const n=`trend:${C(t)}`,s=P(S.trend,n);if(s)return s;const a=new Date,o=[],e=(t||[]).map(l=>l?.start?new Date(l.start):null).filter(l=>l&&!Number.isNaN(l.getTime()));let r=6,i=new Date(a.getFullYear(),a.getMonth(),1);if(e.length){const l=new Date(Math.min(...e.map(f=>f.getTime()))),m=new Date(Math.max(...e.map(f=>f.getTime()))),d=new Date(l.getFullYear(),l.getMonth(),1);i=new Date(m.getFullYear(),m.getMonth(),1);const c=i.getFullYear()-d.getFullYear(),u=i.getMonth()-d.getMonth(),p=c*12+u;r=Math.min(12,Math.max(6,p+1))}for(let l=r-1;l>=0;l-=1){const m=new Date(i.getFullYear(),i.getMonth()-l,1),d=m.getFullYear(),c=m.getMonth(),u=t.filter(M=>{const T=M?.start?new Date(M.start):null;return T&&T.getFullYear()===d&&T.getMonth()===c}).filter(M=>N(M).statusValue!=="cancelled"),p=u.length;let f=0,g=0,h=0;u.forEach(M=>{const T=A(M);f+=T.finalTotal,g+=T.netProfit,h+=T.companyShareAmount});const b=K(m),w=new Date(m.getFullYear(),m.getMonth(),1),_=new Date(m.getFullYear(),m.getMonth()+1,0);o.push({label:b,count:p,revenue:f,netProfit:g,companyShare:h,periodStart:w,periodEnd:_,startInput:k(w),endInput:k(_)})}try{const l=new Map;(t||[]).forEach(c=>{if(N(c).statusValue==="cancelled")return;const u=c?.start?new Date(c.start):null;if(!u||Number.isNaN(u.getTime()))return;const p=`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`,f=A(c),g=l.get(p)||0;l.set(p,g+(Number(f.finalTotal)||0))});const m=o.map(c=>Number(c.revenue||0)),d=o.map((c,u)=>u<2?null:(m[u]+m[u-1]+m[u-2])/3);o.forEach((c,u)=>{const p=u>0?Number(o[u-1]?.revenue||0):null;let f=null;p!=null&&Number.isFinite(p)&&p>0&&(f=(Number(c.revenue||0)-p)/p*100);const g=c.periodStart instanceof Date?c.periodStart:null;let h=null;if(g&&!Number.isNaN(g.getTime())){const b=`${g.getFullYear()-1}-${String(g.getMonth()+1).padStart(2,"0")}`,w=l.get(b);Number.isFinite(w)&&w>0&&(h=(Number(c.revenue||0)-w)/w*100)}c.momChange=f,c.yoyChange=h,c.movingAvgRevenue=d[u]})}catch{}return R(S.trend,n,o)}function Mt(t){const n=new Date,s=(t||[]).map(r=>r?.start?new Date(r.start):null).filter(r=>r&&!Number.isNaN(r.getTime()));let a=6,o=new Date(n.getFullYear(),n.getMonth(),1);if(s.length){const r=new Date(Math.min(...s.map(u=>u.getTime()))),i=new Date(Math.max(...s.map(u=>u.getTime()))),l=new Date(r.getFullYear(),r.getMonth(),1);o=new Date(i.getFullYear(),i.getMonth(),1);const m=o.getFullYear()-l.getFullYear(),d=o.getMonth()-l.getMonth(),c=m*12+d;a=Math.min(12,Math.max(6,c+1))}const e=[];for(let r=a-1;r>=0;r-=1){const i=new Date(o.getFullYear(),o.getMonth()-r,1),l=i.getFullYear(),m=i.getMonth();let d=0,c=0;(t||[]).forEach(u=>{const p=u?.start?new Date(u.start):null;if(!p||p.getFullYear()!==l||p.getMonth()!==m)return;const{statusValue:f,confirmed:g}=N(u);f==="cancelled"?c+=1:(g||f==="confirmed"||f==="completed")&&(d+=1)}),e.push({label:K(i),confirmed:d,cancelled:c})}return e}function Tt(t){const n=`status:${C(t)}`,s=P(S.status,n);if(s)return s;const a={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(d=>{const{statusValue:c,confirmed:u}=N(d);c==="completed"?a.completed+=1:c==="cancelled"?a.cancelled+=1:c==="confirmed"||u?a.confirmed+=1:a.pending+=1});const o=Math.max(1,(t||[]).length),e=a.confirmed,r=a.pending,i=a.completed,l=a.cancelled,m=[{label:D("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:e,percent:Math.round(e/o*100)||0,rawCount:e,className:"status-confirmed",filterKey:"confirmed"},{label:D("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:r,percent:Math.round(r/o*100)||0,rawCount:r,className:"status-pending",filterKey:"pending"},{label:D("reservations.reports.status.completedLabel","منتهية","Completed"),value:i,percent:Math.round(i/o*100)||0,rawCount:i,className:"status-completed",filterKey:"completed"},{label:D("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:l,percent:Math.round(l/o*100)||0,rawCount:l,className:"status-cancelled",filterKey:"cancelled"}];return R(S.status,n,m)}function Ft(t){const n=`payment:${C(t)}`,s=P(S.payment,n);if(s)return s;const a=t.length||1;let o=0,e=0,r=0;(t||[]).forEach(l=>{const{paidStatus:m}=N(l);m==="paid"?o+=1:m==="partial"?e+=1:r+=1});const i=[{label:D("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-paid",filterKey:"paid"},{label:D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:e,percent:Math.round(e/a*100)||0,rawCount:e,className:"status-partial",filterKey:"partial"},{label:D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}];return R(S.payment,n,i)}function At(t,n){const s=`topCustomers:${C(t)}`,a=P(S.topCustomers,s);if(a)return a;const o=new Map,e=new Map((n||[]).map(i=>[String(i.id),i]));t.forEach(i=>{const{statusValue:l}=N(i);if(l==="cancelled")return;const m=String(i?.customerId??"unknown"),d=o.get(m)||{count:0,revenue:0},c=A(i);d.count+=1,d.revenue+=c.finalTotal,o.set(m,d)});const r=Array.from(o.entries()).map(([i,l])=>({name:e.get(i)?.customerName||D("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:l.count,revenue:l.revenue})).sort((i,l)=>l.revenue-i.revenue).slice(0,5);return R(S.topCustomers,s,r)}function Ct(t,n){const s=`topEquipment:${C(t)}`,a=P(S.topEquipment,s);if(a)return a;const o=new Map,e=new Map((n||[]).map(l=>[x(l?.barcode),l])),r=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(l=>{(l?.items||[]).forEach(m=>{const d=x(m?.barcode),c=d?e.get(d):null,u=m?.desc||m?.description||m?.name||c?.desc||c?.description||c?.name||"",p=u&&u.trim()?u:r,f=J(p)||"unknown",g=Number(m?.qty)||1,h=Number(m?.price)||0,b=g*h,w=o.get(f)||{name:p,count:0,revenue:0};w.name=p,w.count+=g,w.revenue+=b,o.set(f,w)})});const i=Array.from(o.values()).sort((l,m)=>m.count!==l.count?m.count-l.count:m.revenue-l.revenue).slice(0,5);return R(S.topEquipment,s,i)}function Pt(){Object.values(S).forEach(t=>t.clear())}function rt(t,n,s,a,o){const e=[],r=t?.reservationId||t?.id;r&&e.push(r),t?.notes&&e.push(t.notes);const{statusValue:i,paidStatus:l}=N(t);i&&e.push(i);const m=t?.paymentStatus||t?.payment_status;m&&e.push(m),t?.paid!=null&&e.push(t.paid?"paid":"unpaid"),l&&e.push(l);const d=s.get(String(t?.customerId));d&&e.push(d.customerName,d.company_name||d.companyName,d.contact_person||"");const c=W(t);return c&&e.push(c.title,c.code,c.status),e.push(ot(l)),(t?.items||[]).forEach(p=>{p?.desc&&e.push(p.desc),p?.barcode&&e.push(p.barcode);const f=a.get(x(p?.barcode));f&&e.push(f.desc,f.description,f.name)}),(t?.technicians||[]).forEach(p=>{const f=o.get(String(p));f&&e.push(f.name,f.role,f.department)}),O(e.filter(Boolean).join(" ")).includes(n)}function Rt(t,n,s,a,o){const{startDate:e,endDate:r}=G(n),i=O(n.search),l=!!i,m=new Map((s||[]).map(u=>[String(u.id),u])),d=new Map((a||[]).map(u=>[x(u?.barcode),u])),c=new Map((o||[]).map(u=>[String(u.id),u]));return(t||[]).filter(u=>{if(u&&u.projectId!=null&&String(u.projectId).trim()!=="")return!1;const p=u?.start?new Date(u.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let f=u?.end?new Date(u.end):p;if(Number.isNaN(f.getTime())&&(f=p),e&&f<e||r&&p>r)return!1;const{statusValue:g,confirmed:h,paid:b,paidStatus:w}=N(u);if(n.status==="confirmed"&&!(g==="confirmed"||g==="completed"||h)||n.status==="pending"&&g!=="pending"||n.status==="completed"&&g!=="completed"||n.status==="cancelled"&&g!=="cancelled"||n.payment==="paid"&&!b||n.payment==="unpaid"&&b||n.payment==="partial"&&w!=="partial")return!1;if(n.share&&n.share!=="all"){const M=A(u).companySharePercent>0;if(n.share==="with"&&!M||n.share==="without"&&M)return!1}return!(l&&!rt(u,i,m,d,c))})}function ot(t){const n=String(t??"").toLowerCase();return n==="paid"?D("reservations.reports.payment.paidLabel","مدفوعة","Paid"):n==="partial"?D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function xt(t,n){const s=new Map((n||[]).map(e=>[String(e.id),e])),a=new Map;return(t||[]).forEach(e=>{const{statusValue:r}=N(e);if(r==="cancelled")return;const i=U(e.start,e.end),l=Array.isArray(e.crewAssignments)?e.crewAssignments:[];if(l.length){l.forEach(d=>{const c=d?.technicianId!=null?String(d.technicianId):null;if(!c)return;const u=s.get(c)||q(c)||{},p=Number.isFinite(Number(d?.positionClientPrice))&&Number(d.positionClientPrice)>0?Number(d.positionClientPrice):B(u),f=Number.isFinite(Number(d?.positionCost))&&Number(d.positionCost)>0?Number(d.positionCost):Y(u),g=p*i,h=f*i,b=a.get(c)||{id:c,name:u?.name||String(c),days:0,billable:0,cost:0};b.days+=i,b.billable+=g,b.cost+=h,a.set(c,b)});return}(Array.isArray(e.technicians)?e.technicians.map(d=>String(d)):[]).forEach(d=>{const c=s.get(d)||q(d)||{},u=B(c),p=Y(c),f=u*i,g=p*i,h=a.get(d)||{id:d,name:c?.name||String(d),days:0,billable:0,cost:0};h.days+=i,h.billable+=f,h.cost+=g,a.set(d,h)})}),Array.from(a.values()).map(e=>({...e,net:e.billable-e.cost})).sort((e,r)=>r.net-e.net)}function st(t=[]){if(!Array.isArray(t)||!t.length)return 0;let n=0;return t.forEach(s=>{const a=Number(s?.amount);Number.isFinite(a)&&a>0&&(n+=a)}),n}function Q(t){const n=A(t),s=Number(n.finalTotal||0);let a=Number(t?.paidAmount);if(!Number.isFinite(a)||a<=0){const e=st(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(e)&&e>0&&(a=e)}if((!Number.isFinite(a)||a<=0)&&Number.isFinite(Number(t?.paidPercent))){const e=Number(t.paidPercent);e>0&&e<=100&&(a=e/100*s)}return Number.isFinite(a)||(a=0),Math.max(0,Math.round((s-a)*100)/100)}function _t(t,n,s=5){const a=new Map((n||[]).map(e=>[String(e.id),e])),o=[];return(t||[]).forEach(e=>{const{paidStatus:r,statusValue:i}=N(e);if(i==="cancelled"||r!=="unpaid"&&r!=="partial")return;const l=Q(e);if(!Number.isFinite(l)||l<=0)return;const m=a.get(String(e.customerId));o.push({id:e.id||e.reservationId||"",code:e.reservationCode||e.reservationId||e.id||"",customer:m?.customerName||e.customerName||"",outstanding:l,paidStatus:r})}),o.sort((e,r)=>r.outstanding-e.outstanding).slice(0,s)}function kt(t,{horizonDays:n=90}={}){const s=new Date,a=new Date(s.getTime()+n*E),o=new Map;return(t||[]).forEach(e=>{const{statusValue:r,paidStatus:i}=N(e);if(r==="cancelled"||i==="paid")return;const l=Q(e);if(!Number.isFinite(l)||l<=0)return;const m=e?.start?new Date(e.start):null,d=e?.end?new Date(e.end):m;let c=d&&!Number.isNaN(d.getTime())?d:m;if((!c||Number.isNaN(c.getTime()))&&(c=new Date(s.getTime()+7*E)),c<s||c>a)return;const u=k(new Date(c.getFullYear(),c.getMonth(),c.getDate())),p=o.get(u)||{date:u,amount:0,count:0};p.amount+=l,p.count+=1,o.set(u,p)}),Array.from(o.values()).sort((e,r)=>e.date<r.date?-1:1)}export{mt as A,dt as B,pt as C,ft as D,gt as E,A as a,yt as b,N as c,ht as d,k as e,bt as f,Pt as g,G as h,Rt as i,wt as j,Dt as k,Nt as l,St as m,Tt as n,Mt as o,ot as p,Ft as q,y as r,At as s,D as t,Ct as u,xt as v,kt as w,_t as x,ut as y,it as z};
