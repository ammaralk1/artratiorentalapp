import{x as Ae,n as x,d as O,t as m,h as C,a as ke,c as je,i as Te,m as Pe,l as Ne,b as It,A as Ce,s as ct}from"./auth.js";import{i as Le}from"./dashboardShell.js";import{e as Pt,g as Be,c as _e}from"./form.js";import{d as Jt,g as qt,h as we,j as Re,s as Fe,m as Me}from"./controller.js";import"./events.js";import{d as $e,g as qe,f as Ve,h as ze,D as ut,j as Nt,b as He,c as Ue}from"./reservationsService.js";import{g as xt,b as Oe,a as We,c as Ye,d as Xt,s as Ke,e as Qe,r as Ge}from"./projectFocusTemplates.js";Ae({ar:{"customerDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.title":"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.hero.subtitle":"ğŸ‘‹ Ù‡Ø°Ù‡ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.fields.taxId":"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:","customerDetails.fields.document":"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.reservations":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.stats.upcoming":"Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.projects":"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerDetails.stats.projectsEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.stats.lastActivity":"Ø¢Ø®Ø± Ù†Ø´Ø§Ø·","customerDetails.stats.lastActivityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.reservationsDesc":"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ","customerDetails.stats.upcomingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©","customerDetails.stats.nextReservation":"Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}","customerDetails.stats.projectsDesc":"Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.payment":"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentBreakdown":"Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚","customerDetails.stats.paymentPaid":"Ø§Ù„Ù…Ø¯ÙÙˆØ¹","customerDetails.stats.paymentOutstandingLabel":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","customerDetails.stats.totalValue":"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: {amount}","customerDetails.stats.totalValueEmpty":"Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ù…Ø¨Ø§Ù„Øº Ø¨Ø¹Ø¯.","customerDetails.stats.paymentOutstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}","customerDetails.stats.paymentAllSet":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.paymentOutstandingEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©","customerDetails.stats.activityEmpty":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«","customerDetails.stats.activityOn":"Ø¨ØªØ§Ø±ÙŠØ® {date}","customerDetails.stats.activityType.reservation":"Ø­Ø¬Ø²","customerDetails.stats.activityType.project":"Ù…Ø´Ø±ÙˆØ¹","customerDetails.stats.activityType.customer":"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.stats.complianceEmpty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©","customerDetails.stats.complianceProjects":"Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}","customerDetails.stats.complianceLabel.excellent":"Ø§Ù„ØªØ²Ø§Ù… Ù…Ù…ØªØ§Ø²","customerDetails.stats.complianceLabel.good":"Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯","customerDetails.stats.complianceLabel.average":"ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©","customerDetails.stats.complianceLabel.poor":"ØªØ£Ø®ÙŠØ± Ù…ØªÙƒØ±Ø±","customerDetails.document.open":"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯","customerDetails.document.defaultName":"Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·","customerDetails.primaryNav.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerDetails.primaryNav.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.reservations":"ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","customerTabs.projects":"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","customerTabs.customerReservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerTabs.customerProjects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","customerDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²...","customerDetails.fields.name":"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:","customerDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","customerDetails.fields.company":"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:","customerDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","customerDetails.fields.address":"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:","customerDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","customerDetails.toast.missingRequired":"âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†","customerDetails.toast.notFound":"âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","customerDetails.toast.updateSuccess":"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„","customerDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...","customerDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.loadFailed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.","customerDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","customerDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„","customerProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"ğŸ‘¤ Client Profile","customerDetails.hero.subtitle":"ğŸ‘‹ Here is a quick look at this client","customerDetails.fields.taxId":"ğŸ§¾ Tax Number:","customerDetails.fields.document":"ğŸ“ Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"ğŸ“… Booking Management","customerDetails.primaryNav.projects":"ğŸ“ Project Management","customerTabs.reservations":"ğŸ“… Booking Management","customerTabs.projects":"ğŸ“ Project Management","customerTabs.customerReservations":"ğŸ“… Client Reservations","customerTabs.customerProjects":"ğŸ“ Client Projects","customerDetails.actions.back":"â¬…ï¸ Back","customerDetails.actions.edit":"âœï¸ Edit Client","customerDetails.filters.search":"ğŸ” Search by client or reservation ID...","customerDetails.fields.name":"ğŸ‘¤ Name:","customerDetails.fields.phone":"ğŸ“ Phone:","customerDetails.fields.company":"ğŸ¢ Company:","customerDetails.fields.email":"ğŸ“§ Email:","customerDetails.fields.address":"ğŸ“ Address:","customerDetails.fields.notes":"ğŸ“ Notes:","customerDetails.toast.missingRequired":"âš ï¸ Name and phone are required","customerDetails.toast.notFound":"âš ï¸ Client not found","customerDetails.toast.updateSuccess":"âœ… Client information updated","customerDetails.status.loading":"â³ Loading client information...","customerDetails.errors.notFound":"âš ï¸ This client could not be found.","customerDetails.errors.loadFailed":"âš ï¸ Failed to load client information.","customerDetails.errors.missingId":"âš ï¸ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"âœï¸ Edit Client","customerProjects.title":"ğŸ“ Client Projects","customerProjects.empty":"No projects are linked to this client."}});let Ct={},I={initialized:!1,currentId:null,modal:{el:null,body:null}};function _t(t=""){return x(String(t)).trim().toLowerCase()}function fe(t,e,a){if(!e||!a)return;const{startDate:n,endDate:s}=qt(t);e._flatpickr?n?e._flatpickr.setDate(n,!1,"Y-m-d"):e._flatpickr.clear():e.value=n||"",a._flatpickr?s?a._flatpickr.setDate(s,!1,"Y-m-d"):a._flatpickr.clear():a.value=s||""}function Zt(t,{endOfDay:e=!1}={}){if(!t)return null;const a=String(t).trim();if(!a)return null;const n=a.includes("T")?a:`${a}T00:00:00`,s=new Date(n);return Number.isNaN(s.getTime())?null:(e?s.setHours(23,59,59,999):s.setHours(0,0,0,0),s)}function Lt(t){const e=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const a of e){if(!a)continue;const n=new Date(a);if(!Number.isNaN(n.getTime()))return n.setHours(0,0,0,0),n}return null}function At(t){if(!document.getElementById("customer-reservations"))return;const a=document.getElementById("customer-search-reservation"),n=document.getElementById("customer-filter-start-date"),s=document.getElementById("customer-filter-end-date"),r=document.getElementById("customer-reservation-date-range"),c=document.getElementById("customer-reservation-status-filter"),v=document.getElementById("customer-clear-filters");window.flatpickr&&(n&&window.flatpickr(n,{dateFormat:"Y-m-d"}),s&&window.flatpickr(s,{dateFormat:"Y-m-d"}));const u=()=>{let d=x(n?.value||"").trim(),g=x(s?.value||"").trim(),f=r?.value||"";if(new Set(["","today","week","month"]).has(f)||(f="",r&&(r.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),d="",g=""),!d&&!g&&f){const{startDate:S,endDate:T}=qt(f);d=S,g=T}return{searchTerm:_t(a?.value||""),startDate:d,endDate:g,status:c?.value||"",quickRange:f,customerId:t}},p=()=>{Ct=u(),Jt("customer-reservations",Ct)};a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{a.value=x(a.value),p()}),a.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{r&&(r.value=""),p()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{r&&(r.value=""),p()}),s.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{fe(r.value,n,s),p()}),r.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",p),c.dataset.listenerAttached="true"),v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{a&&(a.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),r&&(r.value=""),c&&(c.value=""),p()}),v.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{Jt("customer-reservations",Ct)},p()}function lt(t){I.currentId=t;const{container:e}=it();e&&(I.initialized||(Je(),Xe(),ta(),document.addEventListener("projects:changed",()=>{I.currentId&&B()}),document.addEventListener("language:changed",()=>{I.currentId&&B()}),document.addEventListener("technicians:updated",()=>{I.currentId&&B()}),I.initialized=!0),B())}function it(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Je(){const{searchInput:t,statusSelect:e,clearBtn:a,startInput:n,endInput:s,rangeSelect:r}=it();window.flatpickr&&(n&&!n.dataset.datepickerAttached&&(window.flatpickr(n,{dateFormat:"Y-m-d"}),n.dataset.datepickerAttached="true"),s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=x(t.value),B()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{B()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{n.value=x(n.value),r&&(r.value=""),B()}),n.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=x(s.value),r&&(r.value=""),B()}),s.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{fe(r.value,n,s),B()}),r.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{const{searchInput:c,statusSelect:v,startInput:u,endInput:p,rangeSelect:d}=it();c&&(c.value=""),v&&(v.value=""),d&&(d.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),p&&(p._flatpickr&&p._flatpickr.clear(),p.value=""),B()}),a.dataset.listenerAttached="true")}function Xe(){const{container:t}=it();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Ze),t.dataset.projectModalListenerAttached="true")}function Ze(t){const e=t.target.closest(".project-focus-card");if(!e||t.target.closest("[data-ignore-project-modal]"))return;const n=e.dataset.projectId?String(e.dataset.projectId):"";n&&wt(n)}function ta(){Vt()}function Vt(){if(I.modal?.el&&I.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(I.modal={el:t,body:e},!0)}function B(){const{container:t,searchInput:e,statusSelect:a,startInput:n,endInput:s,rangeSelect:r}=it();if(!t||!I.currentId)return;const c=_t(e?.value||""),v=a?.value||"";let u=x(n?.value||"").trim(),p=x(s?.value||"").trim(),d=r?.value||"";if(new Set(["","today","week","month"]).has(d)||(d="",r&&(r.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),u="",p=""),!u&&!p&&d){const{startDate:h,endDate:b}=qt(d);u=h,p=b}const f=Zt(u),D=Zt(p,{endOfDay:!0}),{projects:S=[],technicians:T=[],reservations:k=[],customers:E=[]}=O(),N=new Map(T.map(h=>[String(h.id),h])),A=ea(k),i=E.find(h=>String(h.id)===String(I.currentId))||null,l=S.filter(h=>String(h.clientId)===String(I.currentId)).filter(h=>{if(c){const b=[h.id,h.projectId,h.project_id,h.projectCode,h.project_code].map(G=>G==null?"":x(String(G)));if(!_t([h.title,h.description,h.notes,...b].filter(Boolean).join(" ")).includes(c))return!1}if(v&&$e(h)!==v)return!1;if(f||D){const b=Lt(h);if(!b||f&&b<f||D&&b>D)return!1}return!0}).sort((h,b)=>{const $=Lt(h)?.getTime()||0;return(Lt(b)?.getTime()||0)-$});if(!l.length){const h=m("customerProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${h}</div></div>`;return}t.innerHTML=l.map(h=>{const b=xt(h),$=b?A.get(b)||[]:[];return Oe(h,{customer:i,techniciansMap:N,reservations:$})}).join("")}function ea(t=[]){const e=new Map;return t.forEach(a=>{const n=a?.projectId??a?.project_id??a?.projectID;if(n==null)return;const s=String(n);e.has(s)||e.set(s,[]),e.get(s).push(a)}),e}function wt(t){const e=String(t||"").trim();if(!e||!Vt())return;const a=I.modal;if(!a?.body)return;a.body.dataset.mode="view";const{projects:n=[],reservations:s=[],customers:r=[]}=O(),c=ra(n,e);if(!c||I.currentId&&c.clientId!=null&&String(c.clientId)!==String(I.currentId))return;const v=r.find(d=>String(d.id)===String(c.clientId))||null,u=s.filter(d=>{const g=oa(d);return g&&g===e}),p=We(c,{customer:v,reservations:u});a.body.innerHTML=p,aa(c),na(a.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(a.el).show():(a.el.classList.add("show"),a.el.style.display="block")}function aa(t){if(!t||!I.modal?.body)return;const e=I.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",a=>{a.preventDefault(),sa(t)})}function na(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(a=>{a.dataset.listenerAttached!=="true"&&(a.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const s=qe();let r=Number.parseInt(a.dataset.index||"",10);if(!Number.isInteger(r)||r<0){const c=a.dataset.reservationId;c&&(r=s.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(d=>d!=null&&String(d)===c)))}Number.isInteger(r)&&r>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(r):C(m("projects.details.reservations.viewUnavailable","ØªØ¹Ø°Ø± ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"))}),a.dataset.listenerAttached="true")})}function sa(t){if(!t||!Vt())return;const e=I.modal;if(!e?.body)return;const{customers:a=[]}=O(),n=a.find(c=>String(c.id)===String(t.clientId))||null,s=n?.customerName||t.clientName||t.customerName||"",r=t.clientCompany||n?.companyName||n?.company||"";e.body.dataset.mode="edit",e.body.innerHTML=Ye(t,{clientName:s,clientCompany:r}),ia(t,{clientName:s,clientCompany:r})}function ia(t,{clientName:e="",clientCompany:a=""}={}){if(!t||!I.modal?.body)return;const n=I.modal.body,s=n.querySelector("#customer-project-edit-form")||n.querySelector("#project-details-edit-form");if(!s)return;const r=s.querySelector('[data-action="cancel-edit"]');r&&r.addEventListener("click",o=>{o.preventDefault();const l=xt(t);l&&wt(l)});const c=s.querySelector("#project-edit-expense-label"),v=s.querySelector("#project-edit-expense-amount"),u=s.querySelector('[data-action="add-expense"]'),p=s.querySelector("#project-edit-expense-list");s.querySelector('[name="project-start-date"]'),s.querySelector('[name="project-start-time"]'),s.querySelector('[name="project-end-date"]'),s.querySelector('[name="project-end-time"]');const d=s.querySelector("#project-edit-payment-status"),g=s.querySelector("#project-edit-tax"),f=s.querySelector("#project-edit-company-share"),D=s.querySelector("#project-edit-discount-type"),S=s.querySelector("#project-edit-discount"),T=s.querySelector("#project-edit-payment-progress-type"),k=s.querySelector("#project-edit-payment-progress-value"),E={expenses:Array.isArray(t?.expenses)?t.expenses.map(o=>({...o})):[]};let N=!1;const A=o=>{!g||!f||N||(N=!0,o==="share"?f.checked?(g.checked||(g.checked=!0),Pt(f,ut)):g.checked&&(g.checked=!1):o==="tax"&&(g.checked?Pt(f,ut):f.checked&&(f.checked=!1)),N=!1)},i=()=>{p&&(p.innerHTML=Qe(E.expenses))};i(),u&&!u.dataset.listenerAttached&&(u.addEventListener("click",o=>{o.preventDefault();const l=c?.value.trim()||"",h=x(v?.value||"0"),b=Number(h);if(!l){C(m("projects.toast.missingExpenseLabel","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ")),c?.focus();return}if(!Number.isFinite(b)||b<=0){C(m("projects.toast.invalidExpenseAmount","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­")),v?.focus();return}E.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:l,amount:b}),c&&(c.value=""),v&&(v.value=""),i()}),u.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("click",o=>{const l=o.target.closest('[data-action="remove-expense"]');if(!l)return;const{id:h}=l.dataset;E.expenses=E.expenses.filter(b=>String(b.id)!==String(h)),i()}),p.dataset.listenerAttached="true"),S&&!S.dataset.listenerAttached&&(S.addEventListener("input",o=>{const l=o.target;l instanceof HTMLInputElement&&(l.value=x(l.value||""))}),S.dataset.listenerAttached="true"),k&&!k.dataset.listenerAttached&&(k.addEventListener("input",o=>{const l=o.target;l instanceof HTMLInputElement&&(l.value=x(l.value||""))}),k.dataset.listenerAttached="true"),d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{d.dataset.userSelected="true"}),d.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>A("share")),f.dataset.listenerAttached="true"),g&&!g.dataset.listenerAttached&&(g.addEventListener("change",()=>A("tax")),g.dataset.listenerAttached="true"),f?.checked&&Pt(f,ut),A(f?.checked?"share":"tax"),s.addEventListener("submit",async o=>{if(o.preventDefault(),s.dataset.submitting==="true")return;const l=new FormData(s),h=(l.get("project-title")||"").toString().trim(),b=(l.get("project-type")||"").toString().trim(),$=(l.get("project-start-date")||"").toString().trim(),G=(l.get("project-start-time")||"").toString().trim(),Ut=(l.get("project-end-date")||"").toString().trim(),he=(l.get("project-end-time")||"").toString().trim(),ve=(l.get("project-description")||"").toString().trim(),Ot=(l.get("project-payment-status")||"unpaid").toString().toLowerCase(),Wt=["paid","partial"].includes(Ot)?Ot:"unpaid",J=g?.checked===!0;if(!h||!b||!$){C(m("projects.toast.missingRequiredFields","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"));return}const Yt=Xt($,G),kt=Ut?Xt(Ut,he):"";if(kt){const _=new Date(Yt),R=new Date(kt);if(!Number.isNaN(_.getTime())&&!Number.isNaN(R.getTime())&&_>R){C(m("projects.toast.invalidDateRange","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"));return}}const dt=xt(t);if(!dt){C(m("projects.toast.editMissing","âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡"));return}const Kt=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,De=E.expenses.reduce((_,R)=>_+(Number(R.amount)||0),0),Qt=D?.value==="amount"?"amount":"percent",Ee=x(S?.value||"0");let X=Number.parseFloat(Ee);(!Number.isFinite(X)||X<0)&&(X=0);const Z=f?.checked===!0;let tt=Z?Be(f):null;(!Number.isFinite(tt)||tt<=0)&&(tt=Z&&J?ut:null);const et=_e({equipmentEstimate:Kt,expensesTotal:De,discountValue:X,discountType:Qt,applyTax:J,companyShareEnabled:Z,companySharePercent:tt}),be=T?.value==="amount"?"amount":"percent",Gt=x(k?.value||""),Se=Gt?Number.parseFloat(Gt):null,Y=Ve({totalAmount:et.totalWithTax,progressType:be,progressValue:Se,history:[]}),jt=d?.dataset?.userSelected==="true",xe=ze({manualStatus:jt?Wt:null,paidAmount:Y.paidAmount,paidPercent:Y.paidPercent,totalAmount:et.totalWithTax}),Tt=jt?Wt:xe;!jt&&d&&(d.value=Tt),d?.dataset&&delete d.dataset.userSelected;const Ie=we({projectCode:t.projectCode,title:h,type:b,clientId:t.clientId,clientCompany:a,description:ve,start:Yt,end:kt||null,applyTax:J,paymentStatus:Tt,equipmentEstimate:Kt,expenses:E.expenses,discount:X,discountType:Qt,companyShareEnabled:Z&&J,companySharePercent:Z&&J?tt:null,companyShareAmount:et.companyShareAmount,taxAmount:et.taxAmount,totalWithTax:et.totalWithTax,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[],paidAmount:Y.paidAmount,paidPercentage:Y.paidPercent,paymentProgressType:Y.paymentProgressType,paymentProgressValue:Y.paymentProgressValue}),L=s.querySelector('button[type="submit"]');L&&(L.disabled=!0,L.dataset.originalText=L.textContent||"",L.textContent=m("projects.details.edit.saving","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...")),s.dataset.submitting="true";try{const _=await Re(dt,Ie);await Ke(dt,Tt),document.dispatchEvent(new CustomEvent("projects:changed")),C(m("projects.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")),B();const R=xt(_)||dt;R&&wt(R)}catch(_){console.error("âŒ [customerDetails] Failed to update project from customer modal",_);const R=typeof _?.message=="string"?_.message:m("projects.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");C(R,"error")}finally{delete s.dataset.submitting,L&&(L.disabled=!1,L.dataset.originalText&&(L.textContent=L.dataset.originalText,delete L.dataset.originalText))}})}function ra(t=[],e){const a=String(e);return t.find(n=>[n?.id,n?.projectId,n?.project_id].some(r=>r!=null&&String(r)===a))||null}function oa(t){if(!t)return null;const e=t.projectId??t.project_id??t.projectID??null;return e!=null?String(e):null}ke();je();Te();Le();Pe();const mt=document.getElementById("logout-btn");mt&&!mt.dataset.listenerAttached&&(mt.addEventListener("click",()=>Ne()),mt.dataset.listenerAttached="true");window.showReservationDetails=Fe;const ca=new URLSearchParams(window.location.search),j=ca.get("id"),W=document.getElementById("customer-details"),te=document.getElementById("customer-hero-name"),la=document.getElementById("customer-hero-phone"),da=document.getElementById("customer-hero-company"),ua=document.getElementById("customer-hero-email"),ma=document.getElementById("customer-hero-tax"),ee=document.getElementById("customer-hero-summary"),ae=document.getElementById("dashboard-greeting-customer-name"),ne=document.getElementById("dashboard-greeting-customer-company"),pt=document.getElementById("customer-stat-projects"),ft=document.getElementById("customer-stat-projects-desc"),yt=document.getElementById("customer-stat-payment"),gt=document.getElementById("customer-stat-payment-desc"),ht=document.getElementById("customer-stat-upcoming"),vt=document.getElementById("customer-stat-upcoming-desc"),at=document.getElementById("customer-stat-activity"),Dt=document.getElementById("customer-stat-activity-desc"),Et=document.getElementById("customer-stat-compliance"),nt=document.getElementById("customer-stat-compliance-desc"),se=document.getElementById("sidebar-stat-projects"),ie=document.getElementById("sidebar-stat-reservations"),re=document.getElementById("sidebar-stat-equipment"),oe=document.getElementById("sidebar-stat-technicians"),zt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),Rt=Array.from(document.querySelectorAll("[data-customer-tab]")),pa=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),H=document.getElementById("edit-document-file"),Q=document.getElementById("edit-document-preview"),ce=document.getElementById("edit-document-file-name"),rt=document.getElementById("edit-document-url"),ot=document.getElementById("edit-document-name");let P=null,F="idle",q=null;zt.forEach(t=>{t.disabled=!0});let y=null,st=!1,V="",Ht="reservations";function w(t=""){const e=document.createElement("div");return e.textContent=t==null?"":String(t),e.innerHTML}function fa(t=""){const e=w(t).replace(/\r/g,""),a=`
`;return e.includes(a)?e.split(a).join("<br>"):e}function ya(t=null){q=t&&typeof t=="object"?{...t}:null,P=null,F="idle",H&&(H.value=""),K()}function K(){if(!ce||!Q)return;const t=F==="uploading",e=!!P?.dataUrl;let a=m("customers.form.document.empty","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯");t?a=m("customers.form.document.uploading","ğŸ“¤ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..."):F==="error"?a=m("customers.form.document.uploadFailed","âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù"):e?a=P?.fileName||m("customers.form.document.selected","ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù."):q&&(q.fileName||q.url)&&(a=q.fileName||q.url),ce.textContent=a;const n=e||!!q?.url;Q.disabled=t||!n}function ga(){if(!H)return;const[t]=H.files||[];if(!t){F="idle",P=null,K();return}F="uploading",K();const e=new FileReader;e.onload=()=>{if(typeof e.result!="string"){F="error",P=null,K();return}P={dataUrl:e.result,fileName:t.name,mimeType:t.type,size:t.size},rt&&(rt.value=e.result),ot&&(ot.value=t.name),F="success",K()},e.onerror=()=>{F="error",P=null,K()},e.readAsDataURL(t)}H&&!H.dataset.listenerAttached&&(H.addEventListener("change",ga),H.dataset.listenerAttached="true");Q&&!Q.dataset.listenerAttached&&(Q.addEventListener("click",()=>{if(F==="uploading")return;const t=P?.dataUrl||q?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),Q.dataset.listenerAttached="true");function bt(t,e,a,{hideWhenEmpty:n=!1}={}){if(!t)return;const s=a==null?"":String(a).trim(),r=s.length>0,c=r?s:"â€”";t.textContent=`${e} ${c}`,n?t.classList.toggle("hidden",!r):t.classList.remove("hidden")}function Ft(t){const e=m("customerDetails.pageTitle","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"),a=t?.customerName||"â€”",n=t?.phone?x(t.phone):"",s=t?.companyName||"",r=t?.email||"",c=t?.tax_id??t?.taxId??"";if(te&&(te.textContent=a),ee&&(ee.textContent=a!=="â€”"?a:e),bt(la,"ğŸ“",n,{hideWhenEmpty:!1}),bt(da,"ğŸ¢",s,{hideWhenEmpty:!0}),bt(ua,"ğŸ“§",r,{hideWhenEmpty:!0}),bt(ma,"ğŸ§¾",c,{hideWhenEmpty:!0}),ae&&(ae.textContent=a),ne){const v=[];s&&v.push(s),n&&v.push(`ğŸ“ ${n}`);const u=typeof c=="string"?c.trim():String(c||"").trim();u&&v.push(`ğŸ§¾ ${u}`),ne.textContent=v.length?v.join(" â€¢ "):"â€”"}}function ha(t){if(t?.preventDefault?.(),!y)return;Na();const e=document.getElementById("editCustomerModal"),a=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!a)return;(a.getInstance(e)||new a(e)).show()}function va(){zt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",ha),t.dataset.listenerAttached="true")})}function Mt(t){zt.forEach(e=>{e&&(e.disabled=!!t)})}va();function $t(t){t&&(Ht=t,Rt.forEach(e=>{const a=e?.getAttribute("data-customer-tab")===t;e&&(e.classList.toggle("tab-active",a),e.classList.toggle("active",a),e.setAttribute("aria-selected",String(a)))}),pa.forEach((e,a)=>{e&&e.classList.toggle("hidden",a!==t)}),t==="projects"&&j&&y&&lt(j))}function Da(){Rt.length&&(Rt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-customer-tab");e&&$t(e)}),t.dataset.listenerAttached="true")}),$t(Ht))}Da();function ye(t={}){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(A=>A&&typeof A=="object"),a=A=>{for(const i of A)if(typeof i=="string"&&i.trim()!=="")return i.trim();return""},n=A=>{for(const i of A){if(typeof i=="number"&&Number.isFinite(i))return Math.max(0,Math.trunc(i));if(typeof i=="string"&&i.trim()!==""&&/^\d+$/.test(i.trim()))return Math.max(0,parseInt(i.trim(),10))}return null},s=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],r=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],c=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],v=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],u=[t.document_size,t.documentSize,t.size,e?.size,e?.length],p=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],d=a(s),g=a(c),f=a(v)||"application/octet-stream",D=a(r),S=a(p),T=n(u);if(!d&&!S)return null;let k=d,E=S;if(!k&&E&&E.startsWith("data:")){const A=E.indexOf(",");A!==-1&&(k=E,E=E.slice(A+1))}!k&&E&&(k=`${E.startsWith("data:")?"":`data:${f};base64,`}${E}`);const N={url:k,fileName:g,mimeType:f,path:D,data:E||null,size:T};return N.url&&/sirv\.com/i.test(N.url)&&(N.source="sirv"),N}function Ea(){return document.documentElement.getAttribute("lang")||"ar"}function M(t){const e=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(e)}catch{return String(e)}}function le(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const n=Ea()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(n,{dateStyle:"medium"}).format(e)}catch{const r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),v=e.getFullYear();return`${r}/${c}/${v}`}}function de(t){if(!t)return"";const e=t.trim().split(/\s+/),a=e.pop()||"";return`<span class="currency-amount">${e.join(" ")}</span> <span class="currency-unit currency-unit--sm">${a}</span>`}function ue(t,e){const a=m("customerDetails.stats.paymentPaid","Ø§Ù„Ù…Ø¯ÙÙˆØ¹"),n=m("customerDetails.stats.paymentOutstandingLabel","Ø§Ù„Ù…Ø³ØªØ­Ù‚");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${a}</span>
      ${de(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${n}</span>
      ${de(e)}
    </div>
  `}const me={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},ba={reservation:"Reservation",project:"Project",customer:"Client record"};function Bt(t=[]){let e=null;return t.forEach(a=>{if(!a)return;const n=a instanceof Date?a:new Date(a);Number.isNaN(n.getTime())||(!e||n>e)&&(e=n)}),e}function Sa(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function pe({projects:t=0,reservations:e=0,equipment:a=0,technicians:n=0}={}){se&&(se.textContent=M(t)),ie&&(ie.textContent=M(e)),re&&(re.textContent=M(a)),oe&&(oe.textContent=M(n))}function U(){if(!y||!j){const i=Nt(0);if(pt&&(pt.textContent="0"),ft&&(ft.textContent=m("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.")),yt&&(yt.innerHTML=ue(i,i)),gt){const o=m("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),l=m("customerDetails.stats.paymentOutstandingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");gt.textContent=`${o} â€¢ ${l}`}ht&&(ht.textContent="0"),vt&&(vt.textContent=m("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),at&&(at.textContent="â€”"),Dt&&(Dt.textContent=m("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Et&&(Et.textContent="0%"),nt&&(nt.textContent=m("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©")),pe({projects:0,reservations:0,equipment:0,technicians:0});return}const t=O(),a=(Array.isArray(t.reservations)?t.reservations:[]).filter(i=>i?[i.customerId,i.customer_id,i.customer?.id].some(l=>l!=null&&String(l)===String(j)):!1),n=a.length,s=Date.now(),r=a.filter(i=>{const o=i?.start??i?.startDatetime??i?.start_datetime??i?.start_date;if(!o)return!1;const l=new Date(o);return Number.isNaN(l.getTime())?!1:l.getTime()>=s}),c=r.map(i=>i?.start??i?.startDatetime??i?.start_datetime).map(i=>new Date(i)).filter(i=>!Number.isNaN(i.getTime())).sort((i,o)=>i-o)[0]||null,u=(Array.isArray(t.projects)?t.projects:[]).filter(i=>i?[i.clientId,i.client_id,i.customer_id].some(l=>l!=null&&String(l)===String(j)):!1),p=u.length,d=u.reduce((i,o)=>{if(!o)return i;const l=Ge(o)||{},h=Number(l.totalWithTax??l.subtotal??0)||0;return String(o?.paymentStatus??o?.status??"").toLowerCase()==="paid"?(i.paid+=h,i.paidCount+=1):i.outstanding+=h,i},{paid:0,outstanding:0,paidCount:0}),g=p>0?Math.round(d.paidCount/p*100):0,f=[];if(a.forEach(i=>{const o=Bt([i?.updatedAt,i?.updated_at,i?.end,i?.endDatetime,i?.end_datetime,i?.start,i?.startDatetime,i?.start_datetime,i?.createdAt,i?.created_at]);o&&f.push({date:o,type:"reservation"})}),u.forEach(i=>{const o=Bt([i?.updatedAt,i?.updated_at,i?.end,i?.end_datetime,i?.start,i?.start_datetime,i?.createdAt,i?.created_at]);o&&f.push({date:o,type:"project"})}),!f.length){const i=Bt([y?.updated_at,y?.updatedAt,y?.created_at,y?.createdAt]);i&&f.push({date:i,type:"customer"})}const D=f.reduce((i,o)=>i?o.date>i.date?o:i:o,null),S=D?.date??null,T=D?.type??null,k=a.reduce((i,o)=>Array.isArray(o?.items)?i+o.items.length:i,0),E=new Set;a.forEach(i=>{Array.isArray(i?.technicians)&&i.technicians.forEach(o=>{const l=o!=null?String(o):"";l&&E.add(l)}),Array.isArray(i?.techniciansDetails)&&i.techniciansDetails.forEach(o=>{const l=o?.id??o?.technician_id??o?.technicianId;l!=null&&E.add(String(l))})}),pt&&(pt.textContent=M(p)),ft&&(ft.textContent=p>0?m("customerDetails.stats.projectsDesc","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„"):m("customerDetails.stats.projectsEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„."));const N=Nt(d.paid),A=Nt(d.outstanding);if(yt&&(yt.innerHTML=ue(N,A)),gt){const i=m("customerDetails.stats.paymentBreakdown","Ù…Ø¯ÙÙˆØ¹ / Ù…Ø³ØªØ­Ù‚"),o=d.outstanding>0?m("customerDetails.stats.paymentOutstanding","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {amount}").replace("{amount}",A):m("customerDetails.stats.paymentAllSet","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªØ­Ù‚Ø©");gt.textContent=`${i} â€¢ ${o}`}if(ht&&(ht.textContent=M(r.length)),vt&&(vt.textContent=r.length>0&&c?m("customerDetails.stats.nextReservation","Ø£Ù‚Ø±Ø¨ Ø­Ø¬Ø²: {date}").replace("{date}",le(c)):m("customerDetails.stats.upcomingEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©")),at)if(T){const i=m(`customerDetails.stats.activityType.${T}`,ba[T]||T);at.textContent=i}else at.textContent="â€”";if(Dt&&(Dt.textContent=S?m("customerDetails.stats.activityOn","Ø¨ØªØ§Ø±ÙŠØ® {date}").replace("{date}",le(S)):m("customerDetails.stats.activityEmpty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«")),Et&&(Et.textContent=`${M(g)}%`),nt)if(p>0){const i=g>=90?"excellent":g>=70?"good":g>=40?"average":"poor",o=i?m(`customerDetails.stats.complianceLabel.${i}`,me[i]||me.poor):"",l=m("customerDetails.stats.complianceProjects","Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: {count} Ù…Ù† {total}").replace("{count}",M(d.paidCount)).replace("{total}",M(p));nt.textContent=o?`${o} â€¢ ${l}`:l}else nt.textContent=m("customerDetails.stats.complianceEmpty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹ ÙƒØ§ÙÙŠØ©");pe({projects:p,reservations:n,equipment:k,technicians:E.size})}function xa(t){const{customers:e}=O();if(!Array.isArray(e))return null;const a=e.find(c=>String(c.id)===String(t));if(!a)return null;const n=a.tax_id??a.taxId??"",s=typeof n=="string"?n.trim():String(n||"").trim(),r=a.document??ye(a);return{...a,tax_id:s,taxId:s,document:r}}function Ia(t={}){if(!t||typeof t!="object")return null;const e=t.id??t.customerId??t.customer_id??null,a=t.full_name??t.customerName??t.name??"",n=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",s=typeof n=="string"?n.trim():String(n||"").trim(),r=ye(t);return e==null?null:{id:String(e),customerName:a,full_name:a,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:s,taxId:s,document:r,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Aa(t){if(!t)return;const e=O(),a=Array.isArray(e.customers)?[...e.customers]:[],n=a.findIndex(s=>String(s.id)===String(t.id));n>=0?a[n]={...a[n],...t}:a.push(t),ct({customers:a})}async function ka(){const{technicians:t}=O();if(!(Array.isArray(t)&&t.length>0))try{const e=await It("/technicians/"),a=Array.isArray(e?.data)?e.data.map(He):[];a.length>0&&ct({technicians:a})}catch(e){console.warn("âš ï¸ Failed to load technicians list",e)}}async function ja(t){if(t)try{const e=new URLSearchParams({customer_id:String(t),limit:"200"}),a=await It(`/reservations/?${e.toString()}`),n=Array.isArray(a?.data)?a.data.map(Ue):[];ct({reservations:n})}catch(e){console.warn("âš ï¸ Failed to load customer reservations",e)}}async function Ta(t){if(t)try{const e=new URLSearchParams({client_id:String(t),limit:"200"}),a=await It(`/projects/?${e.toString()}`),n=Array.isArray(a?.data)?a.data.map(Me):[];ct({projects:n})}catch(e){console.warn("âš ï¸ Failed to load customer projects",e)}}async function Pa(t,{showSpinner:e=!1}={}){if(t){e?(st=!0,V="",z()):(st=!0,V="");try{const a=await It(`/customers/?id=${encodeURIComponent(t)}`),n=a?.data??a,s=Ia(n);if(!s)throw new Error("Invalid customer payload received from server");y=s,Aa(s),st=!1,V="",z(),await ka(),await Promise.all([ja(s.id),Ta(s.id)]),At(s.id),lt(s.id),U()}catch(a){if(st=!1,a instanceof Ce&&a.status===404){y=null,V="",z();return}console.error("âš ï¸ Failed to load customer details",a);const n=m("customerDetails.errors.loadFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");y?(V="",C(n),z()):(V=`${n}${a?.message?` (${a.message})`:""}`,z())}}}function z(){if(!W)return;if($t(Ht),!y){if(Ft(null),Mt(!0),U(),st){W.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(V){W.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${w(V)}</div>
        </div>
      `;return}const a=m("customerDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");W.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${w(a)}</div>
      </div>
    `;return}Ft(y),Mt(!1);const e=[{key:"customerDetails.fields.name",fallback:"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:",value:y.customerName||"â€”"},{key:"customerDetails.fields.phone",fallback:"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:",value:y.phone?x(y.phone):"â€”"},{key:"customerDetails.fields.company",fallback:"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:",value:y.companyName||"â€”"},{key:"customerDetails.fields.email",fallback:"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:",value:y.email||"â€”"},{key:"customerDetails.fields.address",fallback:"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:",value:y.address||"â€”"},{key:"customerDetails.fields.taxId",fallback:"ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:",value:y.tax_id??y.taxId??"â€”"},{key:"customerDetails.fields.notes",fallback:"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",value:y.notes||"â€”",multiline:!0},{key:"customerDetails.fields.document",fallback:"ğŸ“ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„",value:y.document??null,type:"document"}].map(a=>{const n=m(a.key,a.fallback);if(a.type==="document"){const u=a.value;let p='<span class="text-base-content/50">â€”</span>';if(u&&typeof u=="object"){const d=u.fileName?.trim()||u.path?.trim()||u.url||"";if(u.url){const g=w(d||m("customerDetails.document.defaultName","Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·")),f=Sa(u.url),D=w(m("customerDetails.document.open","Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"));p=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${g}</span><a class="btn btn-outline btn-sm" href="${f}" target="_blank" rel="noopener noreferrer">${D}</a></div>`}else d&&(p=`<span class="text-base-content break-all">${w(d)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${w(n)}</span>
          <div class="mt-2">${p}</div>
        </article>
      `}const r=(a.value==null?"":String(a.value)).trim(),c=r.length>0?r:"â€”",v=a.multiline?fa(c):w(c);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${w(n)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${v}</p>
      </article>
    `}).join("");W.innerHTML=e,U()}function Na(){document.getElementById("edit-id").value=y?.id||"",document.getElementById("edit-name").value=y?.customerName||"",document.getElementById("edit-phone").value=x(y?.phone||""),document.getElementById("edit-company").value=y?.companyName||"",document.getElementById("edit-email").value=y?.email||"",document.getElementById("edit-address").value=y?.address||"",document.getElementById("edit-tax-id").value=x(y?.tax_id??y?.taxId??"");const t=y?.document??null;rt&&(rt.value=t?.url||""),ot&&(ot.value=t?.fileName||""),ya(t),document.getElementById("edit-notes").value=y?.notes||""}const St=document.getElementById("save-edit-btn");St&&!St.dataset.listenerAttached&&(St.addEventListener("click",()=>{if(!y)return;const t=document.getElementById("edit-id").value,e=document.getElementById("edit-name").value.trim(),a=x(document.getElementById("edit-phone").value.trim()),n=document.getElementById("edit-company").value.trim(),s=document.getElementById("edit-email").value.trim(),r=document.getElementById("edit-address").value.trim(),c=x(document.getElementById("edit-tax-id").value.trim()),v=(rt?.value||"").trim(),u=(ot?.value||"").trim(),p=document.getElementById("edit-notes").value.trim();if(!e||!a){C(m("customerDetails.toast.missingRequired","âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù†"));return}const d=O(),g=Array.isArray(d.customers)?d.customers:[],f=g.findIndex(k=>String(k.id)===String(t));if(f===-1){C(m("customerDetails.toast.notFound","âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"));return}const D=g[f]?.document??null;let S=D;P?.dataUrl?S={...D||{},url:P.dataUrl,fileName:u||P.fileName||D?.fileName||"",mimeType:P.mimeType||D?.mimeType,size:P.size??D?.size}:v?S={...D||{},url:v,fileName:u||D?.fileName||""}:u&&D?S={...D,fileName:u}:!v&&!u&&(S=D),g[f]={...g[f],customerName:e,phone:a,companyName:n,email:s,address:r,notes:p,tax_id:c,taxId:c,document:S},ct({customers:g}),y=g[f],z(),At(j),lt(j),U(),document.dispatchEvent(new CustomEvent("customers:changed")),C(m("customerDetails.toast.updateSuccess","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),St.dataset.listenerAttached="true");async function Ca(){if(W){if(!j){Ft(null),Mt(!0),U(),W.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${m("customerDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}y=xa(j),y&&(z(),At(j),lt(j),U()),await Pa(j,{showSpinner:!y})}}Ca();const ge=()=>{!j||!y||U()};document.addEventListener("reservations:changed",ge);document.addEventListener("projects:changed",ge);document.addEventListener("language:changed",()=>{z(),j&&y&&(At(j),lt(j),U())});
