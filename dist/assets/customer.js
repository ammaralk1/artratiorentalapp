import{x as _t,n as A,e as L,t as p,h as k,a as Lt,c as Rt,i as Ft,m as Mt,l as wt,b as tt,A as Vt,s as q}from"./auth.js";import"./dashboard2.js";import"./projects2.js";/* empty css   */import{r as pt,a as jt,s as qt}from"./controller.js";import"./events.js";import{d as $t,c as zt,f as Ht}from"./projectsCommon.js";import{g as Z,b as Ut,a as Wt,c as Ot,d as gt,P as Yt,s as Kt}from"./projectFocusTemplates.js";import{g as Qt,k as Jt,l as Xt,a as Gt,b as Zt,o as te}from"./projectsService.js";import{i as ee}from"./dashboardShell.js";_t({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.hero.subtitle":"👋 هذه نظرة سريعة على بيانات العميل","customerDetails.fields.taxId":"🧾 الرقم الضريبي:","customerDetails.fields.document":"📎 مستند العميل","customerDetails.stats.reservations":"إجمالي الحجوزات","customerDetails.stats.upcoming":"حجوزات قادمة","customerDetails.stats.projects":"عدد المشاريع","customerDetails.stats.lastActivity":"آخر نشاط","customerDetails.stats.reservationsDesc":"عدد الحجوزات الكلي","customerDetails.stats.upcomingEmpty":"لا توجد حجوزات قادمة","customerDetails.stats.nextReservation":"أقرب حجز: {date}","customerDetails.stats.projectsDesc":"المشاريع المرتبطة بالعميل","customerDetails.stats.totalValue":"القيمة الإجمالية: {amount}","customerDetails.stats.totalValueEmpty":"لم يتم رصد مبالغ بعد.","customerDetails.document.open":"عرض المستند","customerDetails.document.defaultName":"المستند المرتبط","customerTabs.reservations":"📅 إدارة الحجوزات","customerTabs.projects":"📁 إدارة المشاريع","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.hero.subtitle":"👋 Here is a quick look at this client","customerDetails.fields.taxId":"🧾 Tax Number:","customerDetails.fields.document":"📎 Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerTabs.reservations":"📅 Booking Management","customerTabs.projects":"📁 Project Management","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let st={},D={initialized:!1,currentId:null,modal:{el:null,body:null}};function at(t=""){return A(String(t)).trim().toLowerCase()}function ne(t,n,e){if(!n||!e)return;const{startDate:s,endDate:i}=jt(t);n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s||"",e._flatpickr?i?e._flatpickr.setDate(i,!1,"Y-m-d"):e._flatpickr.clear():e.value=i||""}function et(t){if(!document.getElementById("customer-reservations"))return;const e=document.getElementById("customer-search-reservation"),s=document.getElementById("customer-filter-start-date"),i=document.getElementById("customer-filter-end-date"),r=document.getElementById("customer-reservation-date-range"),o=document.getElementById("customer-reservation-status-filter"),g=document.getElementById("customer-clear-filters");window.flatpickr&&(s&&window.flatpickr(s,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const u=()=>{let f=A(s?.value||"").trim(),m=A(i?.value||"").trim(),h=r?.value||"";if(new Set(["","today","week","month"]).has(h)||(h="",r&&(r.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),f="",m=""),!f&&!m&&h){const{startDate:a,endDate:c}=jt(h);f=a,m=c}return{searchTerm:at(e?.value||""),startDate:f,endDate:m,status:o?.value||"",quickRange:h,customerId:t}},y=()=>{st=u(),pt("customer-reservations",st)};e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=A(e.value),y()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{r&&(r.value=""),y()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{r&&(r.value=""),y()}),i.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{ne(r.value,s,i),y()}),r.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",y),o.dataset.listenerAttached="true"),g&&!g.dataset.listenerAttached&&(g.addEventListener("click",()=>{e&&(e.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),r&&(r.value=""),o&&(o.value=""),y()}),g.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{pt("customer-reservations",st)},y()}function $(t){D.currentId=t;const{container:n}=V();n&&(D.initialized||(se(),ae(),re(),document.addEventListener("projects:changed",()=>{D.currentId&&P()}),document.addEventListener("language:changed",()=>{D.currentId&&P()}),document.addEventListener("technicians:updated",()=>{D.currentId&&P()}),D.initialized=!0),P())}function V(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function se(){const{searchInput:t,statusSelect:n,clearBtn:e}=V();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=A(t.value),P()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{P()}),n.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{const{searchInput:s,statusSelect:i}=V();s&&(s.value=""),i&&(i.value=""),P()}),e.dataset.listenerAttached="true")}function ae(){const{container:t}=V();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",ie),t.dataset.projectModalListenerAttached="true")}function ie(t){const n=t.target.closest(".project-focus-card");if(!n||t.target.closest("[data-ignore-project-modal]"))return;const s=n.dataset.projectId?String(n.dataset.projectId):"";s&&it(s)}function re(){dt()}function dt(){if(D.modal?.el&&D.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),n=document.getElementById("project-details-body");return!t||!n?!1:(D.modal={el:t,body:n},!0)}function P(){const{container:t,searchInput:n,statusSelect:e}=V();if(!t||!D.currentId)return;const s=at(n?.value||""),i=e?.value||"",{projects:r=[],technicians:o=[],reservations:g=[],customers:u=[]}=L(),y=new Map(o.map(a=>[String(a.id),a])),f=oe(g),m=u.find(a=>String(a.id)===String(D.currentId))||null,v=r.filter(a=>String(a.clientId)===String(D.currentId)).filter(a=>!(s&&!at([a.title,a.description,a.notes].filter(Boolean).join(" ")).includes(s)||i&&$t(a)!==i)).sort((a,c)=>{const d=new Date(a.start||a.createdAt||0).getTime();return new Date(c.start||c.createdAt||0).getTime()-d});if(!v.length){const a=p("customerProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");t.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${a}</div></div>`;return}t.innerHTML=v.map(a=>{const c=Z(a),d=c?f.get(c)||[]:[];return Ut(a,{customer:m,techniciansMap:y,reservations:d})}).join("")}function oe(t=[]){const n=new Map;return t.forEach(e=>{const s=e?.projectId??e?.project_id??e?.projectID;if(s==null)return;const i=String(s);n.has(i)||n.set(i,[]),n.get(i).push(e)}),n}function it(t){const n=String(t||"").trim();if(!n||!dt())return;const e=D.modal;if(!e?.body)return;e.body.dataset.mode="view";const{projects:s=[],reservations:i=[],customers:r=[]}=L(),o=me(s,n);if(!o||D.currentId&&o.clientId!=null&&String(o.clientId)!==String(D.currentId))return;const g=r.find(f=>String(f.id)===String(o.clientId))||null,u=i.filter(f=>{const m=fe(f);return m&&m===n}),y=Wt(o,{customer:g,reservations:u});e.body.innerHTML=y,ce(o),le(e.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e.el).show():(e.el.classList.add("show"),e.el.style.display="block")}function ce(t){if(!t||!D.modal?.body)return;const n=D.modal.body.querySelector('[data-action="edit-project"]');n&&n.addEventListener("click",e=>{e.preventDefault(),de(t)})}function le(t){if(!t)return;const n=t.querySelectorAll('[data-action="view-reservation"]');n.length&&n.forEach(e=>{e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const i=Qt();let r=Number.parseInt(e.dataset.index||"",10);if(!Number.isInteger(r)||r<0){const o=e.dataset.reservationId;o&&(r=i.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(f=>f!=null&&String(f)===o)))}Number.isInteger(r)&&r>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(r):k(p("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),e.dataset.listenerAttached="true")})}function de(t){if(!t||!dt())return;const n=D.modal;if(!n?.body)return;const{customers:e=[]}=L(),s=e.find(o=>String(o.id)===String(t.clientId))||null,i=s?.customerName||t.clientName||t.customerName||"",r=t.clientCompany||s?.companyName||s?.company||"";n.body.dataset.mode="edit",n.body.innerHTML=Ot(t,{clientName:i,clientCompany:r}),ue(t,{clientName:i,clientCompany:r})}function ue(t,{clientName:n="",clientCompany:e=""}={}){if(!t||!D.modal?.body)return;const s=D.modal.body.querySelector("#customer-project-edit-form");if(!s)return;const i=s.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",r=>{r.preventDefault();const o=Z(t);o&&it(o)}),s.addEventListener("submit",async r=>{if(r.preventDefault(),s.dataset.submitting==="true")return;const o=new FormData(s),g=(o.get("project-title")||"").toString().trim(),u=(o.get("project-type")||"").toString().trim(),y=(o.get("project-start-date")||"").toString().trim(),f=(o.get("project-start-time")||"").toString().trim(),m=(o.get("project-end-date")||"").toString().trim(),h=(o.get("project-end-time")||"").toString().trim(),v=(o.get("project-description")||"").toString().trim(),a=(o.get("project-payment-status")||"").toString()==="paid"?"paid":"unpaid",c=s.querySelector('[name="project-apply-tax"]')?.checked===!0;if(!g||!u||!y){k(p("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const d=gt(y,f),E=m?gt(m,h):"";if(E){const B=new Date(d),R=new Date(E);if(!Number.isNaN(B.getTime())&&!Number.isNaN(R.getTime())&&B>R){k(p("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const N=Z(t);if(!N){k(p("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const I=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,x=Array.isArray(t?.expenses)?t.expenses:[],Tt=zt(t),nt=Number((I+Tt).toFixed(2)),ft=c?Number((nt*Yt).toFixed(2)):0,Ct=c?Number((nt+ft).toFixed(2)):nt,Pt=Jt({projectCode:t.projectCode,title:g,type:u,clientId:t.clientId,clientCompany:e,description:v,start:d,end:E||null,applyTax:c,paymentStatus:a,equipmentEstimate:I,expenses:x,taxAmount:ft,totalWithTax:Ct,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),S=s.querySelector('button[type="submit"]');S&&(S.disabled=!0,S.dataset.originalText=S.textContent||"",S.textContent=p("projects.details.edit.saving","جاري الحفظ...")),s.dataset.submitting="true";try{const B=await Xt(N,Pt);await Kt(N,a),document.dispatchEvent(new CustomEvent("projects:changed")),k(p("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),P();const R=Z(B)||N;R&&it(R)}catch(B){console.error("❌ [customerDetails] Failed to update project from customer modal",B);const R=typeof B?.message=="string"?B.message:p("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");k(R)}finally{delete s.dataset.submitting,S&&(S.disabled=!1,S.dataset.originalText&&(S.textContent=S.dataset.originalText,delete S.dataset.originalText))}})}function me(t=[],n){const e=String(n);return t.find(s=>[s?.id,s?.projectId,s?.project_id].some(r=>r!=null&&String(r)===e))||null}function fe(t){if(!t)return null;const n=t.projectId??t.project_id??t.projectID??null;return n!=null?String(n):null}Lt();Rt();Ft();ee();Mt();const z=document.getElementById("logout-btn");z&&!z.dataset.listenerAttached&&(z.addEventListener("click",()=>wt()),z.dataset.listenerAttached="true");window.showReservationDetails=qt;const pe=new URLSearchParams(window.location.search),b=pe.get("id"),F=document.getElementById("customer-details"),yt=document.getElementById("customer-hero-name"),ge=document.getElementById("customer-hero-phone"),ye=document.getElementById("customer-hero-company"),he=document.getElementById("customer-hero-email"),ve=document.getElementById("customer-hero-tax"),ht=document.getElementById("customer-hero-summary"),vt=document.getElementById("dashboard-greeting-customer-name"),Dt=document.getElementById("dashboard-greeting-customer-company"),H=document.getElementById("customer-stat-reservations"),U=document.getElementById("customer-stat-reservations-desc"),W=document.getElementById("customer-stat-upcoming"),O=document.getElementById("customer-stat-upcoming-desc"),Y=document.getElementById("customer-stat-projects"),K=document.getElementById("customer-stat-projects-desc"),Q=document.getElementById("customer-stat-last-activity"),J=document.getElementById("customer-stat-last-activity-desc"),Et=document.getElementById("sidebar-stat-projects"),bt=document.getElementById("sidebar-stat-reservations"),It=document.getElementById("sidebar-stat-equipment"),xt=document.getElementById("sidebar-stat-technicians"),ut=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),rt=Array.from(document.querySelectorAll("[data-customer-tab]")),De=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t]));ut.forEach(t=>{t.disabled=!0});let l=null,w=!1,T="",mt="reservations";function j(t=""){const n=document.createElement("div");return n.textContent=t==null?"":String(t),n.innerHTML}function Ee(t=""){const n=j(t).replace(/\r/g,""),e=`
`;return n.includes(e)?n.split(e).join("<br>"):n}function X(t,n,e,{hideWhenEmpty:s=!1}={}){if(!t)return;const i=e==null?"":String(e).trim(),r=i.length>0,o=r?i:"—";t.textContent=`${n} ${o}`,s?t.classList.toggle("hidden",!r):t.classList.remove("hidden")}function ot(t){const n=p("customerDetails.pageTitle","معلومات العميل"),e=t?.customerName||"—",s=t?.phone?A(t.phone):"",i=t?.companyName||"",r=t?.email||"",o=t?.tax_id??t?.taxId??"";if(yt&&(yt.textContent=e),ht&&(ht.textContent=e!=="—"?e:n),X(ge,"📞",s,{hideWhenEmpty:!1}),X(ye,"🏢",i,{hideWhenEmpty:!0}),X(he,"📧",r,{hideWhenEmpty:!0}),X(ve,"🧾",o,{hideWhenEmpty:!0}),vt&&(vt.textContent=e),Dt){const g=[];i&&g.push(i),s&&g.push(`📞 ${s}`);const u=typeof o=="string"?o.trim():String(o||"").trim();u&&g.push(`🧾 ${u}`),Dt.textContent=g.length?g.join(" • "):"—"}}function be(t){if(t?.preventDefault?.(),!l)return;Pe();const n=document.getElementById("editCustomerModal"),e=typeof bootstrap<"u"?bootstrap.Modal:null;if(!n||!e)return;(e.getInstance(n)||new e(n)).show()}function Ie(){ut.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",be),t.dataset.listenerAttached="true")})}function ct(t){ut.forEach(n=>{n&&(n.disabled=!!t)})}Ie();function lt(t){t&&(mt=t,rt.forEach(n=>{const e=n?.getAttribute("data-customer-tab")===t;n&&(n.classList.toggle("tab-active",e),n.classList.toggle("active",e),n.setAttribute("aria-selected",String(e)))}),De.forEach((n,e)=>{n&&n.classList.toggle("hidden",e!==t)}),t==="projects"&&b&&l&&$(b))}function xe(){rt.length&&(rt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const n=t.getAttribute("data-customer-tab");n&&lt(n)}),t.dataset.listenerAttached="true")}),lt(mt))}xe();function kt(t={}){if(!t||typeof t!="object")return null;const n=[t.document,t.attachment,t.file].find(I=>I&&typeof I=="object"),e=I=>{for(const x of I)if(typeof x=="string"&&x.trim()!=="")return x.trim();return""},s=I=>{for(const x of I){if(typeof x=="number"&&Number.isFinite(x))return Math.max(0,Math.trunc(x));if(typeof x=="string"&&x.trim()!==""&&/^\d+$/.test(x.trim()))return Math.max(0,parseInt(x.trim(),10))}return null},i=[t.document_url,t.documentUrl,t.url,t.href,t.link,n?.url,n?.href,n?.link],r=[t.document_path,t.documentPath,t.path,n?.path,n?.documentPath],o=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,n?.fileName,n?.filename,n?.name],g=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,n?.mimeType,n?.contentType,n?.type],u=[t.document_size,t.documentSize,t.size,n?.size,n?.length],y=[n?.data,n?.base64,n?.content,t.data,t.base64,t.content,t.document_data],f=e(i),m=e(o),h=e(g)||"application/octet-stream",v=e(r),a=e(y),c=s(u);if(!f&&!a)return null;let d=f,E=a;if(!d&&E&&E.startsWith("data:")){const I=E.indexOf(",");I!==-1&&(d=E,E=E.slice(I+1))}!d&&E&&(d=`${E.startsWith("data:")?"":`data:${h};base64,`}${E}`);const N={url:d,fileName:m,mimeType:h,path:v,data:E||null,size:c};return N.url&&/sirv\.com/i.test(N.url)&&(N.source="sirv"),N}function Nt(){return document.documentElement.getAttribute("lang")||"ar"}function M(t){const n=Number(t)||0,s=Nt()==="ar"?"ar-SA":"en-US";try{return new Intl.NumberFormat(s,{maximumFractionDigits:0}).format(n)}catch{return String(n)}}function St(t){if(!t)return"—";const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return"—";const s=Nt()==="ar"?"ar-SA":"en-US";try{return new Intl.DateTimeFormat(s,{dateStyle:"medium"}).format(n)}catch{return n.toLocaleDateString()}}function Se(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function At({projects:t=0,reservations:n=0,equipment:e=0,technicians:s=0}={}){Et&&(Et.textContent=M(t)),bt&&(bt.textContent=M(n)),It&&(It.textContent=M(e)),xt&&(xt.textContent=M(s))}function _(){if(!l||!b){H&&(H.textContent="0"),U&&(U.textContent=p("customerDetails.stats.reservationsDesc","عدد الحجوزات الكلي")),W&&(W.textContent="0"),O&&(O.textContent=p("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),Y&&(Y.textContent="0"),K&&(K.textContent=p("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل")),Q&&(Q.textContent="—"),J&&(J.textContent=p("customerDetails.stats.totalValueEmpty","لم يتم رصد مبالغ بعد.")),At({projects:0,reservations:0,equipment:0,technicians:0});return}const t=L(),e=(Array.isArray(t.reservations)?t.reservations:[]).filter(a=>a?[a.customerId,a.customer_id,a.customer?.id].some(d=>d!=null&&String(d)===String(b)):!1),s=e.length,i=Date.now(),r=e.filter(a=>{const c=a?.start??a?.startDatetime??a?.start_datetime??a?.start_date;if(!c)return!1;const d=new Date(c);return Number.isNaN(d.getTime())?!1:d.getTime()>=i}),o=r.map(a=>a?.start??a?.startDatetime??a?.start_datetime).map(a=>new Date(a)).filter(a=>!Number.isNaN(a.getTime())).sort((a,c)=>a-c)[0]||null,y=(Array.isArray(t.projects)?t.projects:[]).filter(a=>a?[a.clientId,a.client_id,a.customer_id].some(d=>d!=null&&String(d)===String(b)):!1).length,f=e.reduce((a,c)=>{const d=c?.totalAmount??c?.cost??c?.netTotal??0,E=Number(d);return a+(Number.isFinite(E)?E:0)},0);let m=null;if(e.forEach(a=>{const c=a?.updatedAt??a?.updated_at??a?.end??a?.endDatetime??a?.end_datetime??a?.start??a?.createdAt??a?.created_at;if(!c)return;const d=new Date(c);Number.isNaN(d.getTime())||(!m||d>m)&&(m=d)}),!m){const a=l?.updated_at??l?.created_at;if(a){const c=new Date(a);Number.isNaN(c.getTime())||(m=c)}}const h=e.reduce((a,c)=>Array.isArray(c?.items)?a+c.items.length:a,0),v=new Set;e.forEach(a=>{Array.isArray(a?.technicians)&&a.technicians.forEach(c=>{const d=c!=null?String(c):"";d&&v.add(d)}),Array.isArray(a?.techniciansDetails)&&a.techniciansDetails.forEach(c=>{const d=c?.id??c?.technician_id??c?.technicianId;d!=null&&v.add(String(d))})}),H&&(H.textContent=M(s)),U&&(U.textContent=p("customerDetails.stats.reservationsDesc","عدد الحجوزات الكلي")),W&&(W.textContent=M(r.length)),O&&(O.textContent=r.length>0&&o?p("customerDetails.stats.nextReservation","أقرب حجز: {date}").replace("{date}",St(o)):p("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),Y&&(Y.textContent=M(y)),K&&(K.textContent=p("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل")),Q&&(Q.textContent=m?St(m):"—"),J&&(J.textContent=f>0?p("customerDetails.stats.totalValue","القيمة الإجمالية: {amount}").replace("{amount}",Ht(f)):p("customerDetails.stats.totalValueEmpty","لم يتم رصد مبالغ بعد.")),At({projects:y,reservations:s,equipment:h,technicians:v.size})}function Ae(t){const{customers:n}=L();if(!Array.isArray(n))return null;const e=n.find(o=>String(o.id)===String(t));if(!e)return null;const s=e.tax_id??e.taxId??"",i=typeof s=="string"?s.trim():String(s||"").trim(),r=e.document??kt(e);return{...e,tax_id:i,taxId:i,document:r}}function je(t={}){if(!t||typeof t!="object")return null;const n=t.id??t.customerId??t.customer_id??null,e=t.full_name??t.customerName??t.name??"",s=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",i=typeof s=="string"?s.trim():String(s||"").trim(),r=kt(t);return n==null?null:{id:String(n),customerName:e,full_name:e,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:i,taxId:i,document:r,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function ke(t){if(!t)return;const n=L(),e=Array.isArray(n.customers)?[...n.customers]:[],s=e.findIndex(i=>String(i.id)===String(t.id));s>=0?e[s]={...e[s],...t}:e.push(t),q({customers:e})}async function Ne(){const{technicians:t}=L();if(!(Array.isArray(t)&&t.length>0))try{const n=await tt("/technicians/"),e=Array.isArray(n?.data)?n.data.map(Gt):[];e.length>0&&q({technicians:e})}catch(n){console.warn("⚠️ Failed to load technicians list",n)}}async function Be(t){if(t)try{const n=new URLSearchParams({customer_id:String(t),limit:"200"}),e=await tt(`/reservations/?${n.toString()}`),s=Array.isArray(e?.data)?e.data.map(Zt):[];q({reservations:s})}catch(n){console.warn("⚠️ Failed to load customer reservations",n)}}async function Te(t){if(t)try{const n=new URLSearchParams({client_id:String(t),limit:"200"}),e=await tt(`/projects/?${n.toString()}`),s=Array.isArray(e?.data)?e.data.map(te):[];q({projects:s})}catch(n){console.warn("⚠️ Failed to load customer projects",n)}}async function Ce(t,{showSpinner:n=!1}={}){if(t){n?(w=!0,T="",C()):(w=!0,T="");try{const e=await tt(`/customers/?id=${encodeURIComponent(t)}`),s=e?.data??e,i=je(s);if(!i)throw new Error("Invalid customer payload received from server");l=i,ke(i),w=!1,T="",C(),await Ne(),await Promise.all([Be(i.id),Te(i.id)]),et(i.id),$(i.id),_()}catch(e){if(w=!1,e instanceof Vt&&e.status===404){l=null,T="",C();return}console.error("⚠️ Failed to load customer details",e);const s=p("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");l?(T="",k(s),C()):(T=`${s}${e?.message?` (${e.message})`:""}`,C())}}}function C(){if(!F)return;if(lt(mt),!l){if(ot(null),ct(!0),_(),w){F.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(T){F.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${j(T)}</div>
        </div>
      `;return}const e=p("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.");F.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${j(e)}</div>
      </div>
    `;return}ot(l),ct(!1);const n=[{key:"customerDetails.fields.name",fallback:"👤 الاسم:",value:l.customerName||"—"},{key:"customerDetails.fields.phone",fallback:"📞 الجوال:",value:l.phone?A(l.phone):"—"},{key:"customerDetails.fields.company",fallback:"🏢 الشركة:",value:l.companyName||"—"},{key:"customerDetails.fields.email",fallback:"📧 البريد:",value:l.email||"—"},{key:"customerDetails.fields.address",fallback:"📍 العنوان:",value:l.address||"—"},{key:"customerDetails.fields.taxId",fallback:"🧾 الرقم الضريبي:",value:l.tax_id??l.taxId??"—"},{key:"customerDetails.fields.notes",fallback:"📝 الملاحظات:",value:l.notes||"—",multiline:!0},{key:"customerDetails.fields.document",fallback:"📎 مستند العميل",value:l.document??null,type:"document"}].map(e=>{const s=p(e.key,e.fallback);if(e.type==="document"){const u=e.value;let y='<span class="text-base-content/50">—</span>';if(u&&typeof u=="object"){const f=u.fileName?.trim()||u.path?.trim()||u.url||"";if(u.url){const m=j(f||p("customerDetails.document.defaultName","المستند المرتبط")),h=Se(u.url),v=j(p("customerDetails.document.open","عرض المستند"));y=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${m}</span><a class="btn btn-outline btn-sm" href="${h}" target="_blank" rel="noopener noreferrer">${v}</a></div>`}else f&&(y=`<span class="text-base-content break-all">${j(f)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${j(s)}</span>
          <div class="mt-2">${y}</div>
        </article>
      `}const r=(e.value==null?"":String(e.value)).trim(),o=r.length>0?r:"—",g=e.multiline?Ee(o):j(o);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${j(s)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${g}</p>
      </article>
    `}).join("");F.innerHTML=n,_()}function Pe(){document.getElementById("edit-id").value=l?.id||"",document.getElementById("edit-name").value=l?.customerName||"",document.getElementById("edit-phone").value=A(l?.phone||""),document.getElementById("edit-company").value=l?.companyName||"",document.getElementById("edit-email").value=l?.email||"",document.getElementById("edit-address").value=l?.address||"",document.getElementById("edit-tax-id").value=A(l?.tax_id??l?.taxId??"");const t=l?.document??null;document.getElementById("edit-document-url").value=t?.url||"",document.getElementById("edit-document-name").value=t?.fileName||"",document.getElementById("edit-notes").value=l?.notes||""}const G=document.getElementById("save-edit-btn");G&&!G.dataset.listenerAttached&&(G.addEventListener("click",()=>{if(!l)return;const t=document.getElementById("edit-id").value,n=document.getElementById("edit-name").value.trim(),e=A(document.getElementById("edit-phone").value.trim()),s=document.getElementById("edit-company").value.trim(),i=document.getElementById("edit-email").value.trim(),r=document.getElementById("edit-address").value.trim(),o=A(document.getElementById("edit-tax-id").value.trim()),g=document.getElementById("edit-document-url").value.trim(),u=document.getElementById("edit-document-name").value.trim(),y=document.getElementById("edit-notes").value.trim();if(!n||!e){k(p("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const f=L(),m=Array.isArray(f.customers)?f.customers:[],h=m.findIndex(d=>String(d.id)===String(t));if(h===-1){k(p("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}const v=m[h]?.document??null;let a=v;g?a={...v||{},url:g,fileName:u||v?.fileName||""}:u&&v?a={...v,fileName:u}:!g&&!u&&(a=v),m[h]={...m[h],customerName:n,phone:e,companyName:s,email:i,address:r,notes:y,tax_id:o,taxId:o,document:a},q({customers:m}),l=m[h],C(),et(b),$(b),_(),document.dispatchEvent(new CustomEvent("customers:changed")),k(p("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),G.dataset.listenerAttached="true");async function _e(){if(F){if(!b){ot(null),ct(!0),_(),F.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${p("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}l=Ae(b),l&&(C(),et(b),$(b),_()),await Ce(b,{showSpinner:!l})}}_e();const Bt=()=>{!b||!l||_()};document.addEventListener("reservations:changed",Bt);document.addEventListener("projects:changed",Bt);document.addEventListener("language:changed",()=>{C(),b&&l&&(et(b),$(b),_())});
