import{x as se,n as b,e as B,t as m,h as v,a as ne,c as ae,i as re,m as ie,l as oe,b as q,A as ce,s as x}from"./auth.js";/* empty css     */import{r as J,a as X,s as de}from"./controller.js";import"./projects2.js";import"./events.js";import{d as le,c as ue}from"./projectsCommon.js";import{g as M,b as me,a as fe,c as pe,d as W,P as ge,s as ye}from"./projectFocusTemplates.js";import{g as he,k as ve,l as De,a as Ie,b as Ee,o as Se}from"./projectsService.js";se({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let z={},l={initialized:!1,currentId:null,modal:{el:null,body:null}};function U(e=""){return b(String(e)).trim().toLowerCase()}function je(e,s,t){if(!s||!t)return;const{startDate:n,endDate:a}=X(e);s._flatpickr?n?s._flatpickr.setDate(n,!1,"Y-m-d"):s._flatpickr.clear():s.value=n||"",t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a||""}function $(e){if(!document.getElementById("customer-reservations"))return;const t=document.getElementById("customer-search-reservation"),n=document.getElementById("customer-filter-start-date"),a=document.getElementById("customer-filter-end-date"),r=document.getElementById("customer-reservation-date-range"),i=document.getElementById("customer-reservation-status-filter"),p=document.getElementById("customer-clear-filters");window.flatpickr&&(n&&window.flatpickr(n,{dateFormat:"Y-m-d"}),a&&window.flatpickr(a,{dateFormat:"Y-m-d"}));const u=()=>{let f=b(n?.value||"").trim(),g=b(a?.value||"").trim(),I=r?.value||"";if(new Set(["","today","week","month"]).has(I)||(I="",r&&(r.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),f="",g=""),!f&&!g&&I){const{startDate:o,endDate:y}=X(I);f=o,g=y}return{searchTerm:U(t?.value||""),startDate:f,endDate:g,status:i?.value||"",quickRange:I,customerId:e}},d=()=>{z=u(),J("customer-reservations",z)};t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=b(t.value),d()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{r&&(r.value=""),d()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{r&&(r.value=""),d()}),a.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{je(r.value,n,a),d()}),r.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",d),i.dataset.listenerAttached="true"),p&&!p.dataset.listenerAttached&&(p.addEventListener("click",()=>{t&&(t.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r.value=""),i&&(i.value=""),d()}),p.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{J("customer-reservations",z)},d()}function H(e){l.currentId=e;const{container:s}=T();s&&(l.initialized||(Ae(),be(),Ce(),document.addEventListener("projects:changed",()=>{l.currentId&&A()}),document.addEventListener("language:changed",()=>{l.currentId&&A()}),document.addEventListener("technicians:updated",()=>{l.currentId&&A()}),l.initialized=!0),A())}function T(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Ae(){const{searchInput:e,statusSelect:s,clearBtn:t}=T();e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=b(e.value),A()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{A()}),s.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const{searchInput:n,statusSelect:a}=T();n&&(n.value=""),a&&(a.value=""),A()}),t.dataset.listenerAttached="true")}function be(){const{container:e}=T();!e||e.dataset.projectModalListenerAttached==="true"||(e.addEventListener("click",ke),e.dataset.projectModalListenerAttached="true")}function ke(e){const s=e.target.closest(".project-focus-card");if(!s||e.target.closest("[data-ignore-project-modal]"))return;const n=s.dataset.projectId?String(s.dataset.projectId):"";n&&Y(n)}function Ce(){O()}function O(){if(l.modal?.el&&l.modal?.body)return!0;const e=document.getElementById("projectDetailsModal"),s=document.getElementById("project-details-body");return!e||!s?!1:(l.modal={el:e,body:s},!0)}function A(){const{container:e,searchInput:s,statusSelect:t}=T();if(!e||!l.currentId)return;const n=U(s?.value||""),a=t?.value||"",{projects:r=[],technicians:i=[],reservations:p=[],customers:u=[]}=B(),d=new Map(i.map(o=>[String(o.id),o])),f=Be(p),g=u.find(o=>String(o.id)===String(l.currentId))||null,P=r.filter(o=>String(o.clientId)===String(l.currentId)).filter(o=>!(n&&!U([o.title,o.description,o.notes].filter(Boolean).join(" ")).includes(n)||a&&le(o)!==a)).sort((o,y)=>{const w=new Date(o.start||o.createdAt||0).getTime();return new Date(y.start||y.createdAt||0).getTime()-w});if(!P.length){const o=m("customerProjects.empty",e.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");e.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${o}</div></div>`;return}e.innerHTML=P.map(o=>{const y=M(o),w=y?f.get(y)||[]:[];return me(o,{customer:g,techniciansMap:d,reservations:w})}).join("")}function Be(e=[]){const s=new Map;return e.forEach(t=>{const n=t?.projectId??t?.project_id??t?.projectID;if(n==null)return;const a=String(n);s.has(a)||s.set(a,[]),s.get(a).push(t)}),s}function Y(e){const s=String(e||"").trim();if(!s||!O())return;const t=l.modal;if(!t?.body)return;t.body.dataset.mode="view";const{projects:n=[],reservations:a=[],customers:r=[]}=B(),i=xe(n,s);if(!i||l.currentId&&i.clientId!=null&&String(i.clientId)!==String(l.currentId))return;const p=r.find(f=>String(f.id)===String(i.clientId))||null,u=a.filter(f=>{const g=Fe(f);return g&&g===s}),d=fe(i,{customer:p,reservations:u});t.body.innerHTML=d,we(i),Pe(t.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(t.el).show():(t.el.classList.add("show"),t.el.style.display="block")}function we(e){if(!e||!l.modal?.body)return;const s=l.modal.body.querySelector('[data-action="edit-project"]');s&&s.addEventListener("click",t=>{t.preventDefault(),Le(e)})}function Pe(e){if(!e)return;const s=e.querySelectorAll('[data-action="view-reservation"]');s.length&&s.forEach(t=>{t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const a=he();let r=Number.parseInt(t.dataset.index||"",10);if(!Number.isInteger(r)||r<0){const i=t.dataset.reservationId;i&&(r=a.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(f=>f!=null&&String(f)===i)))}Number.isInteger(r)&&r>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(r):v(m("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),t.dataset.listenerAttached="true")})}function Le(e){if(!e||!O())return;const s=l.modal;if(!s?.body)return;const{customers:t=[]}=B(),n=t.find(i=>String(i.id)===String(e.clientId))||null,a=n?.customerName||e.clientName||e.customerName||"",r=e.clientCompany||n?.companyName||n?.company||"";s.body.dataset.mode="edit",s.body.innerHTML=pe(e,{clientName:a,clientCompany:r}),Te(e,{clientName:a,clientCompany:r})}function Te(e,{clientName:s="",clientCompany:t=""}={}){if(!e||!l.modal?.body)return;const n=l.modal.body.querySelector("#customer-project-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",r=>{r.preventDefault();const i=M(e);i&&Y(i)}),n.addEventListener("submit",async r=>{if(r.preventDefault(),n.dataset.submitting==="true")return;const i=new FormData(n),p=(i.get("project-title")||"").toString().trim(),u=(i.get("project-type")||"").toString().trim(),d=(i.get("project-start-date")||"").toString().trim(),f=(i.get("project-start-time")||"").toString().trim(),g=(i.get("project-end-date")||"").toString().trim(),I=(i.get("project-end-time")||"").toString().trim(),P=(i.get("project-description")||"").toString().trim(),o=(i.get("project-payment-status")||"").toString()==="paid"?"paid":"unpaid",y=n.querySelector('[name="project-apply-tax"]')?.checked===!0;if(!p||!u||!d){v(m("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const w=W(d,f),F=g?W(g,I):"";if(F){const E=new Date(w),k=new Date(F);if(!Number.isNaN(E.getTime())&&!Number.isNaN(k.getTime())&&E>k){v(m("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const N=M(e);if(!N){v(m("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const K=Number(e?.equipmentEstimate??e?.equipment_estimate??0)||0,G=Array.isArray(e?.expenses)?e.expenses:[],Z=ue(e),V=Number((K+Z).toFixed(2)),Q=y?Number((V*ge).toFixed(2)):0,ee=y?Number((V+Q).toFixed(2)):V,te=ve({projectCode:e.projectCode,title:p,type:u,clientId:e.clientId,clientCompany:t,description:P,start:w,end:F||null,applyTax:y,paymentStatus:o,equipmentEstimate:K,expenses:G,taxAmount:Q,totalWithTax:ee,confirmed:e.confirmed,technicians:Array.isArray(e?.technicians)?e.technicians:[],equipment:Array.isArray(e?.equipment)?e.equipment:[]}),h=n.querySelector('button[type="submit"]');h&&(h.disabled=!0,h.dataset.originalText=h.textContent||"",h.textContent=m("projects.details.edit.saving","جاري الحفظ...")),n.dataset.submitting="true";try{const E=await De(N,te);await ye(N,o),document.dispatchEvent(new CustomEvent("projects:changed")),v(m("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),A();const k=M(E)||N;k&&Y(k)}catch(E){console.error("❌ [customerDetails] Failed to update project from customer modal",E);const k=typeof E?.message=="string"?E.message:m("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");v(k)}finally{delete n.dataset.submitting,h&&(h.disabled=!1,h.dataset.originalText&&(h.textContent=h.dataset.originalText,delete h.dataset.originalText))}})}function xe(e=[],s){const t=String(s);return e.find(n=>[n?.id,n?.projectId,n?.project_id].some(r=>r!=null&&String(r)===t))||null}function Fe(e){if(!e)return null;const s=e.projectId??e.project_id??e.projectID??null;return s!=null?String(s):null}ne();ae();re();ie();const R=document.getElementById("logout-btn");R&&!R.dataset.listenerAttached&&(R.addEventListener("click",()=>oe()),R.dataset.listenerAttached="true");window.showReservationDetails=de;const Ne=new URLSearchParams(window.location.search),D=Ne.get("id"),C=document.getElementById("customer-details");let c=null,L=!1,S="";function Re(e){const{customers:s}=B();return Array.isArray(s)?s.find(t=>String(t.id)===String(e)):null}function _e(e={}){if(!e||typeof e!="object")return null;const s=e.id??e.customerId??e.customer_id??null,t=e.full_name??e.customerName??e.name??"";return s==null?null:{id:String(s),customerName:t,full_name:t,phone:e.phone??"",companyName:e.company??e.company_name??e.companyName??"",company:e.company??e.company_name??e.companyName??"",email:e.email??"",address:e.address??"",notes:e.notes??"",created_at:e.created_at??e.createdAt??null,updated_at:e.updated_at??e.updatedAt??null}}function Me(e){if(!e)return;const s=B(),t=Array.isArray(s.customers)?[...s.customers]:[],n=t.findIndex(a=>String(a.id)===String(e.id));n>=0?t[n]={...t[n],...e}:t.push(e),x({customers:t})}async function qe(){const{technicians:e}=B();if(!(Array.isArray(e)&&e.length>0))try{const s=await q("/technicians/"),t=Array.isArray(s?.data)?s.data.map(Ie):[];t.length>0&&x({technicians:t})}catch(s){console.warn("⚠️ Failed to load technicians list",s)}}async function $e(e){if(e)try{const s=new URLSearchParams({customer_id:String(e),limit:"200"}),t=await q(`/reservations/?${s.toString()}`),n=Array.isArray(t?.data)?t.data.map(Ee):[];x({reservations:n})}catch(s){console.warn("⚠️ Failed to load customer reservations",s)}}async function He(e){if(e)try{const s=new URLSearchParams({client_id:String(e),limit:"200"}),t=await q(`/projects/?${s.toString()}`),n=Array.isArray(t?.data)?t.data.map(Se):[];x({projects:n})}catch(s){console.warn("⚠️ Failed to load customer projects",s)}}async function Ve(e,{showSpinner:s=!1}={}){if(e){s?(L=!0,S="",j()):(L=!0,S="");try{const t=await q(`/customers/?id=${encodeURIComponent(e)}`),n=t?.data??t,a=_e(n);if(!a)throw new Error("Invalid customer payload received from server");c=a,Me(a),L=!1,S="",j(),await qe(),await Promise.all([$e(a.id),He(a.id)]),$(a.id),H(a.id)}catch(t){if(L=!1,t instanceof ce&&t.status===404){c=null,S="",j();return}console.error("⚠️ Failed to load customer details",t);const n=m("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");c?(S="",v(n),j()):(S=`${n}${t?.message?` (${t.message})`:""}`,j())}}}function j(){if(!C)return;if(!c){if(L){C.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="customerDetails.status.loading">${m("customerDetails.status.loading","⏳ جارٍ تحميل بيانات العميل...")}</p>`;return}if(S){C.innerHTML=`<p class="text-danger">${S}</p>`;return}C.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.notFound">${m("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.")}</p>`;return}const e=[{key:"customerDetails.fields.name",value:c.customerName||"—"},{key:"customerDetails.fields.phone",value:c.phone?b(c.phone):"—"},{key:"customerDetails.fields.company",value:c.companyName||"—"},{key:"customerDetails.fields.email",value:c.email||"—"},{key:"customerDetails.fields.address",value:c.address||"—"},{key:"customerDetails.fields.notes",value:c.notes||"—"}].map(({key:s,value:t})=>`
    <p class="customer-detail-row">
      <strong data-i18n data-i18n-key="${s}">${m(s)}</strong>
      <span>${t}</span>
    </p>
  `).join("");C.innerHTML=`
    <div class="customer-details">
      ${e}
    </div>
    <button class="btn btn-warning mt-3" id="edit-btn" data-i18n data-i18n-key="customerDetails.actions.edit">${m("customerDetails.actions.edit","✏️ تعديل العميل")}</button>
  `,Ue()}function ze(){document.getElementById("edit-id").value=c?.id||"",document.getElementById("edit-name").value=c?.customerName||"",document.getElementById("edit-phone").value=b(c?.phone||""),document.getElementById("edit-company").value=c?.companyName||"",document.getElementById("edit-email").value=c?.email||"",document.getElementById("edit-address").value=c?.address||"",document.getElementById("edit-notes").value=c?.notes||""}function Ue(){const e=document.getElementById("edit-btn");!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{ze(),new bootstrap.Modal(document.getElementById("editCustomerModal")).show()}),e.dataset.listenerAttached="true")}const _=document.getElementById("save-edit-btn");_&&!_.dataset.listenerAttached&&(_.addEventListener("click",()=>{if(!c)return;const e=document.getElementById("edit-id").value,s=document.getElementById("edit-name").value.trim(),t=b(document.getElementById("edit-phone").value.trim()),n=document.getElementById("edit-company").value.trim(),a=document.getElementById("edit-email").value.trim(),r=document.getElementById("edit-address").value.trim(),i=document.getElementById("edit-notes").value.trim();if(!s||!t){v(m("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const p=B(),u=Array.isArray(p.customers)?p.customers:[],d=u.findIndex(g=>String(g.id)===String(e));if(d===-1){v(m("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}u[d]={...u[d],customerName:s,phone:t,companyName:n,email:a,address:r,notes:i},x({customers:u}),c=u[d],j(),$(D),H(D),document.dispatchEvent(new CustomEvent("customers:changed")),v(m("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),_.dataset.listenerAttached="true");async function Ye(){if(C){if(!D){C.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${m("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}c=Re(D),c&&(j(),$(D),H(D)),await Ve(D,{showSpinner:!c})}}Ye();document.addEventListener("language:changed",()=>{j(),D&&c&&($(D),H(D))});
