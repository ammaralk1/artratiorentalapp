import{x as Xt,n as k,d as U,t as l,h as _,a as Gt,c as Zt,i as te,m as ee,l as ae,b as yt,A as se,s as et}from"./auth.js";import{i as ne}from"./dashboardShell.js";import"./projects2.js";/* empty css   */import{r as Ct,a as jt,s as ie}from"./controller.js";import"./events.js";import{d as re,c as oe,f as ht}from"./projectsCommon.js";import{g as ft,b as ce,a as le,c as de,d as Pt,P as ue,s as me,r as pe}from"./projectFocusTemplates.js";import{g as fe,h as ye,j as ge,a as he,k as ve}from"./projectsService.js";import{m as De}from"./technicians.js";Xt({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.hero.subtitle":"👋 هذه نظرة سريعة على بيانات العميل","customerDetails.fields.taxId":"🧾 الرقم الضريبي:","customerDetails.fields.document":"📎 مستند العميل","customerDetails.stats.reservations":"إجمالي الحجوزات","customerDetails.stats.upcoming":"حجوزات قادمة","customerDetails.stats.projects":"عدد المشاريع","customerDetails.stats.projectsEmpty":"لا توجد مشاريع مرتبطة بهذا العميل.","customerDetails.stats.lastActivity":"آخر نشاط","customerDetails.stats.lastActivityEmpty":"لا يوجد نشاط حديث","customerDetails.stats.reservationsDesc":"عدد الحجوزات الكلي","customerDetails.stats.upcomingEmpty":"لا توجد حجوزات قادمة","customerDetails.stats.nextReservation":"أقرب حجز: {date}","customerDetails.stats.projectsDesc":"المشاريع المرتبطة بالعميل","customerDetails.stats.payment":"قيمة المدفوع/المستحق","customerDetails.stats.paymentBreakdown":"مدفوع / مستحق","customerDetails.stats.paymentPaid":"المدفوع","customerDetails.stats.paymentOutstandingLabel":"المستحق","customerDetails.stats.totalValue":"القيمة الإجمالية: {amount}","customerDetails.stats.totalValueEmpty":"لم يتم رصد مبالغ بعد.","customerDetails.stats.paymentOutstanding":"المتبقي: {amount}","customerDetails.stats.paymentAllSet":"لا توجد مبالغ مستحقة","customerDetails.stats.paymentOutstandingEmpty":"لا توجد مبالغ مستحقة","customerDetails.stats.activityEmpty":"لا يوجد نشاط حديث","customerDetails.stats.activityOn":"بتاريخ {date}","customerDetails.stats.activityType.reservation":"حجز","customerDetails.stats.activityType.project":"مشروع","customerDetails.stats.activityType.customer":"بيانات العميل","customerDetails.stats.complianceEmpty":"لا توجد بيانات دفع كافية","customerDetails.stats.complianceProjects":"مشاريع مدفوعة بالكامل: {count} من {total}","customerDetails.stats.complianceLabel.excellent":"التزام ممتاز","customerDetails.stats.complianceLabel.good":"دفع في الوقت المحدد","customerDetails.stats.complianceLabel.average":"يحتاج متابعة","customerDetails.stats.complianceLabel.poor":"تأخير متكرر","customerDetails.document.open":"عرض المستند","customerDetails.document.defaultName":"المستند المرتبط","customerDetails.primaryNav.reservations":"📅 إدارة الحجوزات","customerDetails.primaryNav.projects":"📁 إدارة المشاريع","customerTabs.reservations":"📅 إدارة الحجوزات","customerTabs.projects":"📁 إدارة المشاريع","customerTabs.customerReservations":"📅 حجوزات العميل","customerTabs.customerProjects":"📁 مشاريع العميل","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.hero.subtitle":"👋 Here is a quick look at this client","customerDetails.fields.taxId":"🧾 Tax Number:","customerDetails.fields.document":"📎 Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.primaryNav.reservations":"📅 Booking Management","customerDetails.primaryNav.projects":"📁 Project Management","customerTabs.reservations":"📅 Booking Management","customerTabs.projects":"📁 Project Management","customerTabs.customerReservations":"📅 Client Reservations","customerTabs.customerProjects":"📁 Client Projects","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let vt={},b={initialized:!1,currentId:null,modal:{el:null,body:null}};function bt(t=""){return k(String(t)).trim().toLowerCase()}function Kt(t,e,a){if(!e||!a)return;const{startDate:s,endDate:i}=jt(t);e._flatpickr?s?e._flatpickr.setDate(s,!1,"Y-m-d"):e._flatpickr.clear():e.value=s||"",a._flatpickr?i?a._flatpickr.setDate(i,!1,"Y-m-d"):a._flatpickr.clear():a.value=i||""}function Lt(t,{endOfDay:e=!1}={}){if(!t)return null;const a=String(t).trim();if(!a)return null;const s=a.includes("T")?a:`${a}T00:00:00`,i=new Date(s);return Number.isNaN(i.getTime())?null:(e?i.setHours(23,59,59,999):i.setHours(0,0,0,0),i)}function Dt(t){const e=[t?.start,t?.start_datetime,t?.startDatetime,t?.startDate,t?.createdAt,t?.created_at];for(const a of e){if(!a)continue;const s=new Date(a);if(!Number.isNaN(s.getTime()))return s.setHours(0,0,0,0),s}return null}function gt(t){if(!document.getElementById("customer-reservations"))return;const a=document.getElementById("customer-search-reservation"),s=document.getElementById("customer-filter-start-date"),i=document.getElementById("customer-filter-end-date"),r=document.getElementById("customer-reservation-date-range"),o=document.getElementById("customer-reservation-status-filter"),f=document.getElementById("customer-clear-filters");window.flatpickr&&(s&&window.flatpickr(s,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const c=()=>{let p=k(s?.value||"").trim(),v=k(i?.value||"").trim(),h=r?.value||"";if(new Set(["","today","week","month"]).has(h)||(h="",r&&(r.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),p="",v=""),!p&&!v&&h){const{startDate:I,endDate:j}=jt(h);p=I,v=j}return{searchTerm:bt(a?.value||""),startDate:p,endDate:v,status:o?.value||"",quickRange:h,customerId:t}},u=()=>{vt=c(),Ct("customer-reservations",vt)};a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{a.value=k(a.value),u()}),a.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{r&&(r.value=""),u()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{r&&(r.value=""),u()}),i.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{Kt(r.value,s,i),u()}),r.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",u),o.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{a&&(a.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),r&&(r.value=""),o&&(o.value=""),u()}),f.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{Ct("customer-reservations",vt)},u()}function at(t){b.currentId=t;const{container:e}=G();e&&(b.initialized||(Ee(),be(),xe(),document.addEventListener("projects:changed",()=>{b.currentId&&P()}),document.addEventListener("language:changed",()=>{b.currentId&&P()}),document.addEventListener("technicians:updated",()=>{b.currentId&&P()}),b.initialized=!0),P())}function G(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),startInput:document.getElementById("customer-project-start-date"),endInput:document.getElementById("customer-project-end-date"),rangeSelect:document.getElementById("customer-project-date-range"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Ee(){const{searchInput:t,statusSelect:e,clearBtn:a,startInput:s,endInput:i,rangeSelect:r}=G();window.flatpickr&&(s&&!s.dataset.datepickerAttached&&(window.flatpickr(s,{dateFormat:"Y-m-d"}),s.dataset.datepickerAttached="true"),i&&!i.dataset.datepickerAttached&&(window.flatpickr(i,{dateFormat:"Y-m-d"}),i.dataset.datepickerAttached="true")),t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=k(t.value),P()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{P()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{s.value=k(s.value),r&&(r.value=""),P()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{i.value=k(i.value),r&&(r.value=""),P()}),i.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{Kt(r.value,s,i),P()}),r.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{const{searchInput:o,statusSelect:f,startInput:c,endInput:u,rangeSelect:p}=G();o&&(o.value=""),f&&(f.value=""),p&&(p.value=""),c&&(c._flatpickr&&c._flatpickr.clear(),c.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),P()}),a.dataset.listenerAttached="true")}function be(){const{container:t}=G();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Ie),t.dataset.projectModalListenerAttached="true")}function Ie(t){const e=t.target.closest(".project-focus-card");if(!e||t.target.closest("[data-ignore-project-modal]"))return;const s=e.dataset.projectId?String(e.dataset.projectId):"";s&&It(s)}function xe(){Nt()}function Nt(){if(b.modal?.el&&b.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(b.modal={el:t,body:e},!0)}function P(){const{container:t,searchInput:e,statusSelect:a,startInput:s,endInput:i,rangeSelect:r}=G();if(!t||!b.currentId)return;const o=bt(e?.value||""),f=a?.value||"";let c=k(s?.value||"").trim(),u=k(i?.value||"").trim(),p=r?.value||"";if(new Set(["","today","week","month"]).has(p)||(p="",r&&(r.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),c="",u=""),!c&&!u&&p){const{startDate:y,endDate:S}=jt(p);c=y,u=S}const h=Lt(c),D=Lt(u,{endOfDay:!0}),{projects:I=[],technicians:j=[],reservations:T=[],customers:E=[]}=U(),B=new Map(j.map(y=>[String(y.id),y])),x=Se(T),n=E.find(y=>String(y.id)===String(b.currentId))||null,g=I.filter(y=>String(y.clientId)===String(b.currentId)).filter(y=>{if(o){const S=[y.id,y.projectId,y.project_id,y.projectCode,y.project_code].map(N=>N==null?"":k(String(N)));if(!bt([y.title,y.description,y.notes,...S].filter(Boolean).join(" ")).includes(o))return!1}if(f&&re(y)!==f)return!1;if(h||D){const S=Dt(y);if(!S||h&&S<h||D&&S>D)return!1}return!0}).sort((y,S)=>{const H=Dt(y)?.getTime()||0;return(Dt(S)?.getTime()||0)-H});if(!g.length){const y=l("customerProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${y}</div></div>`;return}t.innerHTML=g.map(y=>{const S=ft(y),H=S?x.get(S)||[]:[];return ce(y,{customer:n,techniciansMap:B,reservations:H})}).join("")}function Se(t=[]){const e=new Map;return t.forEach(a=>{const s=a?.projectId??a?.project_id??a?.projectID;if(s==null)return;const i=String(s);e.has(i)||e.set(i,[]),e.get(i).push(a)}),e}function It(t){const e=String(t||"").trim();if(!e||!Nt())return;const a=b.modal;if(!a?.body)return;a.body.dataset.mode="view";const{projects:s=[],reservations:i=[],customers:r=[]}=U(),o=Te(s,e);if(!o||b.currentId&&o.clientId!=null&&String(o.clientId)!==String(b.currentId))return;const f=r.find(p=>String(p.id)===String(o.clientId))||null,c=i.filter(p=>{const v=Be(p);return v&&v===e}),u=le(o,{customer:f,reservations:c});a.body.innerHTML=u,Ae(o),ke(a.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(a.el).show():(a.el.classList.add("show"),a.el.style.display="block")}function Ae(t){if(!t||!b.modal?.body)return;const e=b.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",a=>{a.preventDefault(),je(t)})}function ke(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(a=>{a.dataset.listenerAttached!=="true"&&(a.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const i=fe();let r=Number.parseInt(a.dataset.index||"",10);if(!Number.isInteger(r)||r<0){const o=a.dataset.reservationId;o&&(r=i.findIndex(c=>[c?.id,c?.reservationId,c?.reservation_id].some(p=>p!=null&&String(p)===o)))}Number.isInteger(r)&&r>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(r):_(l("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),a.dataset.listenerAttached="true")})}function je(t){if(!t||!Nt())return;const e=b.modal;if(!e?.body)return;const{customers:a=[]}=U(),s=a.find(o=>String(o.id)===String(t.clientId))||null,i=s?.customerName||t.clientName||t.customerName||"",r=t.clientCompany||s?.companyName||s?.company||"";e.body.dataset.mode="edit",e.body.innerHTML=de(t,{clientName:i,clientCompany:r}),Ne(t,{clientName:i,clientCompany:r})}function Ne(t,{clientName:e="",clientCompany:a=""}={}){if(!t||!b.modal?.body)return;const s=b.modal.body.querySelector("#customer-project-edit-form");if(!s)return;const i=s.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",r=>{r.preventDefault();const o=ft(t);o&&It(o)}),s.addEventListener("submit",async r=>{if(r.preventDefault(),s.dataset.submitting==="true")return;const o=new FormData(s),f=(o.get("project-title")||"").toString().trim(),c=(o.get("project-type")||"").toString().trim(),u=(o.get("project-start-date")||"").toString().trim(),p=(o.get("project-start-time")||"").toString().trim(),v=(o.get("project-end-date")||"").toString().trim(),h=(o.get("project-end-time")||"").toString().trim(),D=(o.get("project-description")||"").toString().trim(),I=(o.get("project-payment-status")||"").toString()==="paid"?"paid":"unpaid",j=s.querySelector('[name="project-apply-tax"]')?.checked===!0;if(!f||!c||!u){_(l("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const T=Pt(u,p),E=v?Pt(v,h):"";if(E){const F=new Date(T),V=new Date(E);if(!Number.isNaN(F.getTime())&&!Number.isNaN(V.getTime())&&F>V){_(l("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const B=ft(t);if(!B){_(l("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const x=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,n=Array.isArray(t?.expenses)?t.expenses:[],d=oe(t),g=Number((x+d).toFixed(2)),y=j?Number((g*ue).toFixed(2)):0,S=j?Number((g+y).toFixed(2)):g,H=ye({projectCode:t.projectCode,title:f,type:c,clientId:t.clientId,clientCompany:a,description:D,start:T,end:E||null,applyTax:j,paymentStatus:I,equipmentEstimate:x,expenses:n,taxAmount:y,totalWithTax:S,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),N=s.querySelector('button[type="submit"]');N&&(N.disabled=!0,N.dataset.originalText=N.textContent||"",N.textContent=l("projects.details.edit.saving","جاري الحفظ...")),s.dataset.submitting="true";try{const F=await ge(B,H);await me(B,I),document.dispatchEvent(new CustomEvent("projects:changed")),_(l("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),P();const V=ft(F)||B;V&&It(V)}catch(F){console.error("❌ [customerDetails] Failed to update project from customer modal",F);const V=typeof F?.message=="string"?F.message:l("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");_(V)}finally{delete s.dataset.submitting,N&&(N.disabled=!1,N.dataset.originalText&&(N.textContent=N.dataset.originalText,delete N.dataset.originalText))}})}function Te(t=[],e){const a=String(e);return t.find(s=>[s?.id,s?.projectId,s?.project_id].some(r=>r!=null&&String(r)===a))||null}function Be(t){if(!t)return null;const e=t.projectId??t.project_id??t.projectID??null;return e!=null?String(e):null}Gt();Zt();te();ne();ee();const st=document.getElementById("logout-btn");st&&!st.dataset.listenerAttached&&(st.addEventListener("click",()=>ae()),st.dataset.listenerAttached="true");window.showReservationDetails=ie;const Ce=new URLSearchParams(window.location.search),A=Ce.get("id"),W=document.getElementById("customer-details"),_t=document.getElementById("customer-hero-name"),Pe=document.getElementById("customer-hero-phone"),Le=document.getElementById("customer-hero-company"),_e=document.getElementById("customer-hero-email"),Re=document.getElementById("customer-hero-tax"),Rt=document.getElementById("customer-hero-summary"),wt=document.getElementById("dashboard-greeting-customer-name"),Ft=document.getElementById("dashboard-greeting-customer-company"),nt=document.getElementById("customer-stat-projects"),it=document.getElementById("customer-stat-projects-desc"),rt=document.getElementById("customer-stat-payment"),ot=document.getElementById("customer-stat-payment-desc"),ct=document.getElementById("customer-stat-upcoming"),lt=document.getElementById("customer-stat-upcoming-desc"),Q=document.getElementById("customer-stat-activity"),dt=document.getElementById("customer-stat-activity-desc"),ut=document.getElementById("customer-stat-compliance"),J=document.getElementById("customer-stat-compliance-desc"),$t=document.getElementById("sidebar-stat-projects"),Mt=document.getElementById("sidebar-stat-reservations"),qt=document.getElementById("sidebar-stat-equipment"),zt=document.getElementById("sidebar-stat-technicians"),Tt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),xt=Array.from(document.querySelectorAll("[data-customer-tab]")),we=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t])),z=document.getElementById("edit-document-file"),K=document.getElementById("edit-document-preview"),Ot=document.getElementById("edit-document-file-name"),Z=document.getElementById("edit-document-url"),tt=document.getElementById("edit-document-name");let C=null,R="idle",$=null;Tt.forEach(t=>{t.disabled=!0});let m=null,X=!1,M="",Bt="reservations";function L(t=""){const e=document.createElement("div");return e.textContent=t==null?"":String(t),e.innerHTML}function Fe(t=""){const e=L(t).replace(/\r/g,""),a=`
`;return e.includes(a)?e.split(a).join("<br>"):e}function $e(t=null){$=t&&typeof t=="object"?{...t}:null,C=null,R="idle",z&&(z.value=""),Y()}function Y(){if(!Ot||!K)return;const t=R==="uploading",e=!!C?.dataUrl;let a=l("customers.form.document.empty","لم يتم اختيار ملف بعد");t?a=l("customers.form.document.uploading","📤 جارٍ رفع الملف..."):R==="error"?a=l("customers.form.document.uploadFailed","⚠️ فشل رفع الملف"):e?a=C?.fileName||l("customers.form.document.selected","تم إرفاق ملف."):$&&($.fileName||$.url)&&(a=$.fileName||$.url),Ot.textContent=a;const s=e||!!$?.url;K.disabled=t||!s}function Me(){if(!z)return;const[t]=z.files||[];if(!t){R="idle",C=null,Y();return}R="uploading",Y();const e=new FileReader;e.onload=()=>{if(typeof e.result!="string"){R="error",C=null,Y();return}C={dataUrl:e.result,fileName:t.name,mimeType:t.type,size:t.size},Z&&(Z.value=e.result),tt&&(tt.value=t.name),R="success",Y()},e.onerror=()=>{R="error",C=null,Y()},e.readAsDataURL(t)}z&&!z.dataset.listenerAttached&&(z.addEventListener("change",Me),z.dataset.listenerAttached="true");K&&!K.dataset.listenerAttached&&(K.addEventListener("click",()=>{if(R==="uploading")return;const t=C?.dataUrl||$?.url;t&&window.open(t,"_blank","noopener,noreferrer")}),K.dataset.listenerAttached="true");function mt(t,e,a,{hideWhenEmpty:s=!1}={}){if(!t)return;const i=a==null?"":String(a).trim(),r=i.length>0,o=r?i:"—";t.textContent=`${e} ${o}`,s?t.classList.toggle("hidden",!r):t.classList.remove("hidden")}function St(t){const e=l("customerDetails.pageTitle","معلومات العميل"),a=t?.customerName||"—",s=t?.phone?k(t.phone):"",i=t?.companyName||"",r=t?.email||"",o=t?.tax_id??t?.taxId??"";if(_t&&(_t.textContent=a),Rt&&(Rt.textContent=a!=="—"?a:e),mt(Pe,"📞",s,{hideWhenEmpty:!1}),mt(Le,"🏢",i,{hideWhenEmpty:!0}),mt(_e,"📧",r,{hideWhenEmpty:!0}),mt(Re,"🧾",o,{hideWhenEmpty:!0}),wt&&(wt.textContent=a),Ft){const f=[];i&&f.push(i),s&&f.push(`📞 ${s}`);const c=typeof o=="string"?o.trim():String(o||"").trim();c&&f.push(`🧾 ${c}`),Ft.textContent=f.length?f.join(" • "):"—"}}function qe(t){if(t?.preventDefault?.(),!m)return;Ze();const e=document.getElementById("editCustomerModal"),a=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!a)return;(a.getInstance(e)||new a(e)).show()}function ze(){Tt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",qe),t.dataset.listenerAttached="true")})}function At(t){Tt.forEach(e=>{e&&(e.disabled=!!t)})}ze();function kt(t){t&&(Bt=t,xt.forEach(e=>{const a=e?.getAttribute("data-customer-tab")===t;e&&(e.classList.toggle("tab-active",a),e.classList.toggle("active",a),e.setAttribute("aria-selected",String(a)))}),we.forEach((e,a)=>{e&&e.classList.toggle("hidden",a!==t)}),t==="projects"&&A&&m&&at(A))}function Oe(){xt.length&&(xt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-customer-tab");e&&kt(e)}),t.dataset.listenerAttached="true")}),kt(Bt))}Oe();function Qt(t={}){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(x=>x&&typeof x=="object"),a=x=>{for(const n of x)if(typeof n=="string"&&n.trim()!=="")return n.trim();return""},s=x=>{for(const n of x){if(typeof n=="number"&&Number.isFinite(n))return Math.max(0,Math.trunc(n));if(typeof n=="string"&&n.trim()!==""&&/^\d+$/.test(n.trim()))return Math.max(0,parseInt(n.trim(),10))}return null},i=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],r=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],o=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],f=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],c=[t.document_size,t.documentSize,t.size,e?.size,e?.length],u=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],p=a(i),v=a(o),h=a(f)||"application/octet-stream",D=a(r),I=a(u),j=s(c);if(!p&&!I)return null;let T=p,E=I;if(!T&&E&&E.startsWith("data:")){const x=E.indexOf(",");x!==-1&&(T=E,E=E.slice(x+1))}!T&&E&&(T=`${E.startsWith("data:")?"":`data:${h};base64,`}${E}`);const B={url:T,fileName:v,mimeType:h,path:D,data:E||null,size:j};return B.url&&/sirv\.com/i.test(B.url)&&(B.source="sirv"),B}function Ue(){return document.documentElement.getAttribute("lang")||"ar"}function w(t){const e=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(e)}catch{return String(e)}}function Ut(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const s=Ue()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(s,{dateStyle:"medium"}).format(e)}catch{const r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),f=e.getFullYear();return`${r}/${o}/${f}`}}function Ht(t){if(!t)return"";const e=t.trim().split(/\s+/),a=e.pop()||"";return`<span class="currency-amount">${e.join(" ")}</span> <span class="currency-unit currency-unit--sm">${a}</span>`}function Vt(t,e){const a=l("customerDetails.stats.paymentPaid","المدفوع"),s=l("customerDetails.stats.paymentOutstandingLabel","المستحق");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${a}</span>
      ${Ht(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${s}</span>
      ${Ht(e)}
    </div>
  `}const Wt={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},He={reservation:"Reservation",project:"Project",customer:"Client record"};function Et(t=[]){let e=null;return t.forEach(a=>{if(!a)return;const s=a instanceof Date?a:new Date(a);Number.isNaN(s.getTime())||(!e||s>e)&&(e=s)}),e}function Ve(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function Yt({projects:t=0,reservations:e=0,equipment:a=0,technicians:s=0}={}){$t&&($t.textContent=w(t)),Mt&&(Mt.textContent=w(e)),qt&&(qt.textContent=w(a)),zt&&(zt.textContent=w(s))}function O(){if(!m||!A){const n=ht(0);if(nt&&(nt.textContent="0"),it&&(it.textContent=l("customerDetails.stats.projectsEmpty","لا توجد مشاريع مرتبطة بهذا العميل.")),rt&&(rt.innerHTML=Vt(n,n)),ot){const d=l("customerDetails.stats.paymentBreakdown","مدفوع / مستحق"),g=l("customerDetails.stats.paymentOutstandingEmpty","لا توجد مبالغ مستحقة");ot.textContent=`${d} • ${g}`}ct&&(ct.textContent="0"),lt&&(lt.textContent=l("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),Q&&(Q.textContent="—"),dt&&(dt.textContent=l("customerDetails.stats.activityEmpty","لا يوجد نشاط حديث")),ut&&(ut.textContent="0%"),J&&(J.textContent=l("customerDetails.stats.complianceEmpty","لا توجد بيانات دفع كافية")),Yt({projects:0,reservations:0,equipment:0,technicians:0});return}const t=U(),a=(Array.isArray(t.reservations)?t.reservations:[]).filter(n=>n?[n.customerId,n.customer_id,n.customer?.id].some(g=>g!=null&&String(g)===String(A)):!1),s=a.length,i=Date.now(),r=a.filter(n=>{const d=n?.start??n?.startDatetime??n?.start_datetime??n?.start_date;if(!d)return!1;const g=new Date(d);return Number.isNaN(g.getTime())?!1:g.getTime()>=i}),o=r.map(n=>n?.start??n?.startDatetime??n?.start_datetime).map(n=>new Date(n)).filter(n=>!Number.isNaN(n.getTime())).sort((n,d)=>n-d)[0]||null,c=(Array.isArray(t.projects)?t.projects:[]).filter(n=>n?[n.clientId,n.client_id,n.customer_id].some(g=>g!=null&&String(g)===String(A)):!1),u=c.length,p=c.reduce((n,d)=>{if(!d)return n;const g=pe(d)||{},y=Number(g.totalWithTax??g.subtotal??0)||0;return String(d?.paymentStatus??d?.status??"").toLowerCase()==="paid"?(n.paid+=y,n.paidCount+=1):n.outstanding+=y,n},{paid:0,outstanding:0,paidCount:0}),v=u>0?Math.round(p.paidCount/u*100):0,h=[];if(a.forEach(n=>{const d=Et([n?.updatedAt,n?.updated_at,n?.end,n?.endDatetime,n?.end_datetime,n?.start,n?.startDatetime,n?.start_datetime,n?.createdAt,n?.created_at]);d&&h.push({date:d,type:"reservation"})}),c.forEach(n=>{const d=Et([n?.updatedAt,n?.updated_at,n?.end,n?.end_datetime,n?.start,n?.start_datetime,n?.createdAt,n?.created_at]);d&&h.push({date:d,type:"project"})}),!h.length){const n=Et([m?.updated_at,m?.updatedAt,m?.created_at,m?.createdAt]);n&&h.push({date:n,type:"customer"})}const D=h.reduce((n,d)=>n?d.date>n.date?d:n:d,null),I=D?.date??null,j=D?.type??null,T=a.reduce((n,d)=>Array.isArray(d?.items)?n+d.items.length:n,0),E=new Set;a.forEach(n=>{Array.isArray(n?.technicians)&&n.technicians.forEach(d=>{const g=d!=null?String(d):"";g&&E.add(g)}),Array.isArray(n?.techniciansDetails)&&n.techniciansDetails.forEach(d=>{const g=d?.id??d?.technician_id??d?.technicianId;g!=null&&E.add(String(g))})}),nt&&(nt.textContent=w(u)),it&&(it.textContent=u>0?l("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل"):l("customerDetails.stats.projectsEmpty","لا توجد مشاريع مرتبطة بهذا العميل."));const B=ht(p.paid),x=ht(p.outstanding);if(rt&&(rt.innerHTML=Vt(B,x)),ot){const n=l("customerDetails.stats.paymentBreakdown","مدفوع / مستحق"),d=p.outstanding>0?l("customerDetails.stats.paymentOutstanding","المتبقي: {amount}").replace("{amount}",x):l("customerDetails.stats.paymentAllSet","لا توجد مبالغ مستحقة");ot.textContent=`${n} • ${d}`}if(ct&&(ct.textContent=w(r.length)),lt&&(lt.textContent=r.length>0&&o?l("customerDetails.stats.nextReservation","أقرب حجز: {date}").replace("{date}",Ut(o)):l("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),Q)if(j){const n=l(`customerDetails.stats.activityType.${j}`,He[j]||j);Q.textContent=n}else Q.textContent="—";if(dt&&(dt.textContent=I?l("customerDetails.stats.activityOn","بتاريخ {date}").replace("{date}",Ut(I)):l("customerDetails.stats.activityEmpty","لا يوجد نشاط حديث")),ut&&(ut.textContent=`${w(v)}%`),J)if(u>0){const n=v>=90?"excellent":v>=70?"good":v>=40?"average":"poor",d=n?l(`customerDetails.stats.complianceLabel.${n}`,Wt[n]||Wt.poor):"",g=l("customerDetails.stats.complianceProjects","مشاريع مدفوعة بالكامل: {count} من {total}").replace("{count}",w(p.paidCount)).replace("{total}",w(u));J.textContent=d?`${d} • ${g}`:g}else J.textContent=l("customerDetails.stats.complianceEmpty","لا توجد بيانات دفع كافية");Yt({projects:u,reservations:s,equipment:T,technicians:E.size})}function We(t){const{customers:e}=U();if(!Array.isArray(e))return null;const a=e.find(o=>String(o.id)===String(t));if(!a)return null;const s=a.tax_id??a.taxId??"",i=typeof s=="string"?s.trim():String(s||"").trim(),r=a.document??Qt(a);return{...a,tax_id:i,taxId:i,document:r}}function Ye(t={}){if(!t||typeof t!="object")return null;const e=t.id??t.customerId??t.customer_id??null,a=t.full_name??t.customerName??t.name??"",s=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",i=typeof s=="string"?s.trim():String(s||"").trim(),r=Qt(t);return e==null?null:{id:String(e),customerName:a,full_name:a,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:i,taxId:i,document:r,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Ke(t){if(!t)return;const e=U(),a=Array.isArray(e.customers)?[...e.customers]:[],s=a.findIndex(i=>String(i.id)===String(t.id));s>=0?a[s]={...a[s],...t}:a.push(t),et({customers:a})}async function Qe(){const{technicians:t}=U();if(!(Array.isArray(t)&&t.length>0))try{const e=await yt("/technicians/"),a=Array.isArray(e?.data)?e.data.map(De):[];a.length>0&&et({technicians:a})}catch(e){console.warn("⚠️ Failed to load technicians list",e)}}async function Je(t){if(t)try{const e=new URLSearchParams({customer_id:String(t),limit:"200"}),a=await yt(`/reservations/?${e.toString()}`),s=Array.isArray(a?.data)?a.data.map(he):[];et({reservations:s})}catch(e){console.warn("⚠️ Failed to load customer reservations",e)}}async function Xe(t){if(t)try{const e=new URLSearchParams({client_id:String(t),limit:"200"}),a=await yt(`/projects/?${e.toString()}`),s=Array.isArray(a?.data)?a.data.map(ve):[];et({projects:s})}catch(e){console.warn("⚠️ Failed to load customer projects",e)}}async function Ge(t,{showSpinner:e=!1}={}){if(t){e?(X=!0,M="",q()):(X=!0,M="");try{const a=await yt(`/customers/?id=${encodeURIComponent(t)}`),s=a?.data??a,i=Ye(s);if(!i)throw new Error("Invalid customer payload received from server");m=i,Ke(i),X=!1,M="",q(),await Qe(),await Promise.all([Je(i.id),Xe(i.id)]),gt(i.id),at(i.id),O()}catch(a){if(X=!1,a instanceof se&&a.status===404){m=null,M="",q();return}console.error("⚠️ Failed to load customer details",a);const s=l("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");m?(M="",_(s),q()):(M=`${s}${a?.message?` (${a.message})`:""}`,q())}}}function q(){if(!W)return;if(kt(Bt),!m){if(St(null),At(!0),O(),X){W.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(M){W.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${L(M)}</div>
        </div>
      `;return}const a=l("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.");W.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${L(a)}</div>
      </div>
    `;return}St(m),At(!1);const e=[{key:"customerDetails.fields.name",fallback:"👤 الاسم:",value:m.customerName||"—"},{key:"customerDetails.fields.phone",fallback:"📞 الجوال:",value:m.phone?k(m.phone):"—"},{key:"customerDetails.fields.company",fallback:"🏢 الشركة:",value:m.companyName||"—"},{key:"customerDetails.fields.email",fallback:"📧 البريد:",value:m.email||"—"},{key:"customerDetails.fields.address",fallback:"📍 العنوان:",value:m.address||"—"},{key:"customerDetails.fields.taxId",fallback:"🧾 الرقم الضريبي:",value:m.tax_id??m.taxId??"—"},{key:"customerDetails.fields.notes",fallback:"📝 الملاحظات:",value:m.notes||"—",multiline:!0},{key:"customerDetails.fields.document",fallback:"📎 مستند العميل",value:m.document??null,type:"document"}].map(a=>{const s=l(a.key,a.fallback);if(a.type==="document"){const c=a.value;let u='<span class="text-base-content/50">—</span>';if(c&&typeof c=="object"){const p=c.fileName?.trim()||c.path?.trim()||c.url||"";if(c.url){const v=L(p||l("customerDetails.document.defaultName","المستند المرتبط")),h=Ve(c.url),D=L(l("customerDetails.document.open","عرض المستند"));u=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${v}</span><a class="btn btn-outline btn-sm" href="${h}" target="_blank" rel="noopener noreferrer">${D}</a></div>`}else p&&(u=`<span class="text-base-content break-all">${L(p)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${L(s)}</span>
          <div class="mt-2">${u}</div>
        </article>
      `}const r=(a.value==null?"":String(a.value)).trim(),o=r.length>0?r:"—",f=a.multiline?Fe(o):L(o);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${a.key}">${L(s)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${f}</p>
      </article>
    `}).join("");W.innerHTML=e,O()}function Ze(){document.getElementById("edit-id").value=m?.id||"",document.getElementById("edit-name").value=m?.customerName||"",document.getElementById("edit-phone").value=k(m?.phone||""),document.getElementById("edit-company").value=m?.companyName||"",document.getElementById("edit-email").value=m?.email||"",document.getElementById("edit-address").value=m?.address||"",document.getElementById("edit-tax-id").value=k(m?.tax_id??m?.taxId??"");const t=m?.document??null;Z&&(Z.value=t?.url||""),tt&&(tt.value=t?.fileName||""),$e(t),document.getElementById("edit-notes").value=m?.notes||""}const pt=document.getElementById("save-edit-btn");pt&&!pt.dataset.listenerAttached&&(pt.addEventListener("click",()=>{if(!m)return;const t=document.getElementById("edit-id").value,e=document.getElementById("edit-name").value.trim(),a=k(document.getElementById("edit-phone").value.trim()),s=document.getElementById("edit-company").value.trim(),i=document.getElementById("edit-email").value.trim(),r=document.getElementById("edit-address").value.trim(),o=k(document.getElementById("edit-tax-id").value.trim()),f=(Z?.value||"").trim(),c=(tt?.value||"").trim(),u=document.getElementById("edit-notes").value.trim();if(!e||!a){_(l("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const p=U(),v=Array.isArray(p.customers)?p.customers:[],h=v.findIndex(T=>String(T.id)===String(t));if(h===-1){_(l("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}const D=v[h]?.document??null;let I=D;C?.dataUrl?I={...D||{},url:C.dataUrl,fileName:c||C.fileName||D?.fileName||"",mimeType:C.mimeType||D?.mimeType,size:C.size??D?.size}:f?I={...D||{},url:f,fileName:c||D?.fileName||""}:c&&D?I={...D,fileName:c}:!f&&!c&&(I=D),v[h]={...v[h],customerName:e,phone:a,companyName:s,email:i,address:r,notes:u,tax_id:o,taxId:o,document:I},et({customers:v}),m=v[h],q(),gt(A),at(A),O(),document.dispatchEvent(new CustomEvent("customers:changed")),_(l("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),pt.dataset.listenerAttached="true");async function ta(){if(W){if(!A){St(null),At(!0),O(),W.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${l("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}m=We(A),m&&(q(),gt(A),at(A),O()),await Ge(A,{showSpinner:!m})}}ta();const Jt=()=>{!A||!m||O()};document.addEventListener("reservations:changed",Jt);document.addEventListener("projects:changed",Jt);document.addEventListener("language:changed",()=>{q(),A&&m&&(gt(A),at(A),O())});
