import{x as ce,n as E,e as B,t as p,h as D,a as le,c as de,i as ue,m as me,l as fe,b as V,A as pe,s as F}from"./auth.js";import{r as Z,a as se,s as ge}from"./controller.js";import"./projects2.js";/* empty css   */import"./events.js";import{d as ye,c as he}from"./projectsCommon.js";import{g as H,b as ve,a as De,c as Ie,d as ee,P as Ee,s as be}from"./projectFocusTemplates.js";import{g as Se,k as ke,l as je,a as Ae,b as Ce,o as we}from"./projectsService.js";ce({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let W={},d={initialized:!1,currentId:null,modal:{el:null,body:null}};function O(e=""){return E(String(e)).trim().toLowerCase()}function Be(e,n,t){if(!n||!t)return;const{startDate:s,endDate:a}=se(e);n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s||"",t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a||""}function $(e){if(!document.getElementById("customer-reservations"))return;const t=document.getElementById("customer-search-reservation"),s=document.getElementById("customer-filter-start-date"),a=document.getElementById("customer-filter-end-date"),r=document.getElementById("customer-reservation-date-range"),i=document.getElementById("customer-reservation-status-filter"),m=document.getElementById("customer-clear-filters");window.flatpickr&&(s&&window.flatpickr(s,{dateFormat:"Y-m-d"}),a&&window.flatpickr(a,{dateFormat:"Y-m-d"}));const u=()=>{let f=E(s?.value||"").trim(),g=E(a?.value||"").trim(),b=r?.value||"";if(new Set(["","today","week","month"]).has(b)||(b="",r&&(r.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),f="",g=""),!f&&!g&&b){const{startDate:c,endDate:h}=se(b);f=c,g=h}return{searchTerm:O(t?.value||""),startDate:f,endDate:g,status:i?.value||"",quickRange:b,customerId:e}},l=()=>{W=u(),Z("customer-reservations",W)};t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=E(t.value),l()}),t.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{r&&(r.value=""),l()}),s.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{r&&(r.value=""),l()}),a.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{Be(r.value,s,a),l()}),r.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",l),i.dataset.listenerAttached="true"),m&&!m.dataset.listenerAttached&&(m.addEventListener("click",()=>{t&&(t.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),r&&(r.value=""),i&&(i.value=""),l()}),m.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{Z("customer-reservations",W)},l()}function z(e){d.currentId=e;const{container:n}=N();n&&(d.initialized||(Pe(),xe(),Te(),document.addEventListener("projects:changed",()=>{d.currentId&&A()}),document.addEventListener("language:changed",()=>{d.currentId&&A()}),document.addEventListener("technicians:updated",()=>{d.currentId&&A()}),d.initialized=!0),A())}function N(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function Pe(){const{searchInput:e,statusSelect:n,clearBtn:t}=N();e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=E(e.value),A()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{A()}),n.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const{searchInput:s,statusSelect:a}=N();s&&(s.value=""),a&&(a.value=""),A()}),t.dataset.listenerAttached="true")}function xe(){const{container:e}=N();!e||e.dataset.projectModalListenerAttached==="true"||(e.addEventListener("click",Le),e.dataset.projectModalListenerAttached="true")}function Le(e){const n=e.target.closest(".project-focus-card");if(!n||e.target.closest("[data-ignore-project-modal]"))return;const s=n.dataset.projectId?String(n.dataset.projectId):"";s&&K(s)}function Te(){J()}function J(){if(d.modal?.el&&d.modal?.body)return!0;const e=document.getElementById("projectDetailsModal"),n=document.getElementById("project-details-body");return!e||!n?!1:(d.modal={el:e,body:n},!0)}function A(){const{container:e,searchInput:n,statusSelect:t}=N();if(!e||!d.currentId)return;const s=O(n?.value||""),a=t?.value||"",{projects:r=[],technicians:i=[],reservations:m=[],customers:u=[]}=B(),l=new Map(i.map(c=>[String(c.id),c])),f=Ne(m),g=u.find(c=>String(c.id)===String(d.currentId))||null,x=r.filter(c=>String(c.clientId)===String(d.currentId)).filter(c=>!(s&&!O([c.title,c.description,c.notes].filter(Boolean).join(" ")).includes(s)||a&&ye(c)!==a)).sort((c,h)=>{const P=new Date(c.start||c.createdAt||0).getTime();return new Date(h.start||h.createdAt||0).getTime()-P});if(!x.length){const c=p("customerProjects.empty",e.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");e.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${c}</div></div>`;return}e.innerHTML=x.map(c=>{const h=H(c),P=h?f.get(h)||[]:[];return ve(c,{customer:g,techniciansMap:l,reservations:P})}).join("")}function Ne(e=[]){const n=new Map;return e.forEach(t=>{const s=t?.projectId??t?.project_id??t?.projectID;if(s==null)return;const a=String(s);n.has(a)||n.set(a,[]),n.get(a).push(t)}),n}function K(e){const n=String(e||"").trim();if(!n||!J())return;const t=d.modal;if(!t?.body)return;t.body.dataset.mode="view";const{projects:s=[],reservations:a=[],customers:r=[]}=B(),i=qe(s,n);if(!i||d.currentId&&i.clientId!=null&&String(i.clientId)!==String(d.currentId))return;const m=r.find(f=>String(f.id)===String(i.clientId))||null,u=a.filter(f=>{const g=He(f);return g&&g===n}),l=De(i,{customer:m,reservations:u});t.body.innerHTML=l,Fe(i),Re(t.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(t.el).show():(t.el.classList.add("show"),t.el.style.display="block")}function Fe(e){if(!e||!d.modal?.body)return;const n=d.modal.body.querySelector('[data-action="edit-project"]');n&&n.addEventListener("click",t=>{t.preventDefault(),Me(e)})}function Re(e){if(!e)return;const n=e.querySelectorAll('[data-action="view-reservation"]');n.length&&n.forEach(t=>{t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const a=Se();let r=Number.parseInt(t.dataset.index||"",10);if(!Number.isInteger(r)||r<0){const i=t.dataset.reservationId;i&&(r=a.findIndex(u=>[u?.id,u?.reservationId,u?.reservation_id].some(f=>f!=null&&String(f)===i)))}Number.isInteger(r)&&r>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(r):D(p("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),t.dataset.listenerAttached="true")})}function Me(e){if(!e||!J())return;const n=d.modal;if(!n?.body)return;const{customers:t=[]}=B(),s=t.find(i=>String(i.id)===String(e.clientId))||null,a=s?.customerName||e.clientName||e.customerName||"",r=e.clientCompany||s?.companyName||s?.company||"";n.body.dataset.mode="edit",n.body.innerHTML=Ie(e,{clientName:a,clientCompany:r}),_e(e,{clientName:a,clientCompany:r})}function _e(e,{clientName:n="",clientCompany:t=""}={}){if(!e||!d.modal?.body)return;const s=d.modal.body.querySelector("#customer-project-edit-form");if(!s)return;const a=s.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",r=>{r.preventDefault();const i=H(e);i&&K(i)}),s.addEventListener("submit",async r=>{if(r.preventDefault(),s.dataset.submitting==="true")return;const i=new FormData(s),m=(i.get("project-title")||"").toString().trim(),u=(i.get("project-type")||"").toString().trim(),l=(i.get("project-start-date")||"").toString().trim(),f=(i.get("project-start-time")||"").toString().trim(),g=(i.get("project-end-date")||"").toString().trim(),b=(i.get("project-end-time")||"").toString().trim(),x=(i.get("project-description")||"").toString().trim(),c=(i.get("project-payment-status")||"").toString()==="paid"?"paid":"unpaid",h=s.querySelector('[name="project-apply-tax"]')?.checked===!0;if(!m||!u||!l){D(p("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const P=ee(l,f),R=g?ee(g,b):"";if(R){const S=new Date(P),C=new Date(R);if(!Number.isNaN(S.getTime())&&!Number.isNaN(C.getTime())&&S>C){D(p("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const M=H(e);if(!M){D(p("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const X=Number(e?.equipmentEstimate??e?.equipment_estimate??0)||0,ae=Array.isArray(e?.expenses)?e.expenses:[],re=he(e),U=Number((X+re).toFixed(2)),G=h?Number((U*Ee).toFixed(2)):0,ie=h?Number((U+G).toFixed(2)):U,oe=ke({projectCode:e.projectCode,title:m,type:u,clientId:e.clientId,clientCompany:t,description:x,start:P,end:R||null,applyTax:h,paymentStatus:c,equipmentEstimate:X,expenses:ae,taxAmount:G,totalWithTax:ie,confirmed:e.confirmed,technicians:Array.isArray(e?.technicians)?e.technicians:[],equipment:Array.isArray(e?.equipment)?e.equipment:[]}),v=s.querySelector('button[type="submit"]');v&&(v.disabled=!0,v.dataset.originalText=v.textContent||"",v.textContent=p("projects.details.edit.saving","جاري الحفظ...")),s.dataset.submitting="true";try{const S=await je(M,oe);await be(M,c),document.dispatchEvent(new CustomEvent("projects:changed")),D(p("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),A();const C=H(S)||M;C&&K(C)}catch(S){console.error("❌ [customerDetails] Failed to update project from customer modal",S);const C=typeof S?.message=="string"?S.message:p("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");D(C)}finally{delete s.dataset.submitting,v&&(v.disabled=!1,v.dataset.originalText&&(v.textContent=v.dataset.originalText,delete v.dataset.originalText))}})}function qe(e=[],n){const t=String(n);return e.find(s=>[s?.id,s?.projectId,s?.project_id].some(r=>r!=null&&String(r)===t))||null}function He(e){if(!e)return null;const n=e.projectId??e.project_id??e.projectID??null;return n!=null?String(n):null}le();de();ue();me();const _=document.getElementById("logout-btn");_&&!_.dataset.listenerAttached&&(_.addEventListener("click",()=>fe()),_.dataset.listenerAttached="true");window.showReservationDetails=ge;const Ve=new URLSearchParams(window.location.search),I=Ve.get("id"),w=document.getElementById("customer-details"),te=document.getElementById("customer-hero-name"),$e=document.getElementById("customer-hero-phone"),ze=document.getElementById("customer-hero-company"),Ue=document.getElementById("customer-hero-email"),ne=document.getElementById("customer-hero-summary"),y=document.getElementById("customer-edit-btn");y&&(y.disabled=!0);let o=null,L=!1,k="";function T(e=""){const n=document.createElement("div");return n.textContent=e==null?"":String(e),n.innerHTML}function We(e=""){const n=T(e).replace(/\r/g,""),t=`
`;return n.includes(t)?n.split(t).join("<br>"):n}function Y(e,n,t,{hideWhenEmpty:s=!1}={}){if(!e)return;const a=t==null?"":String(t).trim(),r=a.length>0,i=r?a:"—";e.textContent=`${n} ${i}`,s?e.classList.toggle("hidden",!r):e.classList.remove("hidden")}function Q(e){const n=p("customerDetails.pageTitle","معلومات العميل");te&&(te.textContent=e?.customerName||"—"),ne&&(ne.textContent=e?.customerName||n);const t=e?.phone?E(e.phone):"";Y($e,"📞",t,{hideWhenEmpty:!1}),Y(ze,"🏢",e?.companyName||"",{hideWhenEmpty:!0}),Y(Ue,"📧",e?.email||"",{hideWhenEmpty:!0})}y&&!y.dataset.listenerAttached&&(y.addEventListener("click",()=>{if(!o)return;Ze();const e=document.getElementById("editCustomerModal"),n=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!n)return;(n.getInstance(e)||new n(e)).show()}),y.dataset.listenerAttached="true");function Ye(e){const{customers:n}=B();return Array.isArray(n)?n.find(t=>String(t.id)===String(e)):null}function Oe(e={}){if(!e||typeof e!="object")return null;const n=e.id??e.customerId??e.customer_id??null,t=e.full_name??e.customerName??e.name??"";return n==null?null:{id:String(n),customerName:t,full_name:t,phone:e.phone??"",companyName:e.company??e.company_name??e.companyName??"",company:e.company??e.company_name??e.companyName??"",email:e.email??"",address:e.address??"",notes:e.notes??"",created_at:e.created_at??e.createdAt??null,updated_at:e.updated_at??e.updatedAt??null}}function Ke(e){if(!e)return;const n=B(),t=Array.isArray(n.customers)?[...n.customers]:[],s=t.findIndex(a=>String(a.id)===String(e.id));s>=0?t[s]={...t[s],...e}:t.push(e),F({customers:t})}async function Qe(){const{technicians:e}=B();if(!(Array.isArray(e)&&e.length>0))try{const n=await V("/technicians/"),t=Array.isArray(n?.data)?n.data.map(Ae):[];t.length>0&&F({technicians:t})}catch(n){console.warn("⚠️ Failed to load technicians list",n)}}async function Je(e){if(e)try{const n=new URLSearchParams({customer_id:String(e),limit:"200"}),t=await V(`/reservations/?${n.toString()}`),s=Array.isArray(t?.data)?t.data.map(Ce):[];F({reservations:s})}catch(n){console.warn("⚠️ Failed to load customer reservations",n)}}async function Xe(e){if(e)try{const n=new URLSearchParams({client_id:String(e),limit:"200"}),t=await V(`/projects/?${n.toString()}`),s=Array.isArray(t?.data)?t.data.map(we):[];F({projects:s})}catch(n){console.warn("⚠️ Failed to load customer projects",n)}}async function Ge(e,{showSpinner:n=!1}={}){if(e){n?(L=!0,k="",j()):(L=!0,k="");try{const t=await V(`/customers/?id=${encodeURIComponent(e)}`),s=t?.data??t,a=Oe(s);if(!a)throw new Error("Invalid customer payload received from server");o=a,Ke(a),L=!1,k="",j(),await Qe(),await Promise.all([Je(a.id),Xe(a.id)]),$(a.id),z(a.id)}catch(t){if(L=!1,t instanceof pe&&t.status===404){o=null,k="",j();return}console.error("⚠️ Failed to load customer details",t);const s=p("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");o?(k="",D(s),j()):(k=`${s}${t?.message?` (${t.message})`:""}`,j())}}}function j(){if(!w)return;if(!o){if(Q(null),L){w.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `,y&&(y.disabled=!0);return}if(k){w.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${T(k)}</div>
        </div>
      `,y&&(y.disabled=!0);return}const t=p("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.");w.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${T(t)}</div>
      </div>
    `,y&&(y.disabled=!0);return}Q(o),y&&(y.disabled=!1);const n=[{key:"customerDetails.fields.name",fallback:"👤 الاسم:",value:o.customerName||"—"},{key:"customerDetails.fields.phone",fallback:"📞 الجوال:",value:o.phone?E(o.phone):"—"},{key:"customerDetails.fields.company",fallback:"🏢 الشركة:",value:o.companyName||"—"},{key:"customerDetails.fields.email",fallback:"📧 البريد:",value:o.email||"—"},{key:"customerDetails.fields.address",fallback:"📍 العنوان:",value:o.address||"—"},{key:"customerDetails.fields.notes",fallback:"📝 الملاحظات:",value:o.notes||"—",multiline:!0}].map(t=>{const s=p(t.key,t.fallback),r=(t.value==null?"":String(t.value)).trim(),i=r.length>0?r:"—",m=t.multiline?We(i):T(i);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${t.key}">${T(s)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${m}</p>
      </article>
    `}).join("");w.innerHTML=n}function Ze(){document.getElementById("edit-id").value=o?.id||"",document.getElementById("edit-name").value=o?.customerName||"",document.getElementById("edit-phone").value=E(o?.phone||""),document.getElementById("edit-company").value=o?.companyName||"",document.getElementById("edit-email").value=o?.email||"",document.getElementById("edit-address").value=o?.address||"",document.getElementById("edit-notes").value=o?.notes||""}const q=document.getElementById("save-edit-btn");q&&!q.dataset.listenerAttached&&(q.addEventListener("click",()=>{if(!o)return;const e=document.getElementById("edit-id").value,n=document.getElementById("edit-name").value.trim(),t=E(document.getElementById("edit-phone").value.trim()),s=document.getElementById("edit-company").value.trim(),a=document.getElementById("edit-email").value.trim(),r=document.getElementById("edit-address").value.trim(),i=document.getElementById("edit-notes").value.trim();if(!n||!t){D(p("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const m=B(),u=Array.isArray(m.customers)?m.customers:[],l=u.findIndex(g=>String(g.id)===String(e));if(l===-1){D(p("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}u[l]={...u[l],customerName:n,phone:t,companyName:s,email:a,address:r,notes:i},F({customers:u}),o=u[l],j(),$(I),z(I),document.dispatchEvent(new CustomEvent("customers:changed")),D(p("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),q.dataset.listenerAttached="true");async function et(){if(w){if(!I){Q(null),w.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${p("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}o=Ye(I),o&&(j(),$(I),z(I)),await Ge(I,{showSpinner:!o})}}et();document.addEventListener("language:changed",()=>{j(),I&&o&&($(I),z(I))});
