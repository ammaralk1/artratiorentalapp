import{x as Ct,n as j,e as L,t as p,h as k,a as Tt,c as Pt,i as _t,m as Lt,l as Rt,b as Z,A as Ft,s as q}from"./auth.js";import{r as ut,a as xt,s as Mt}from"./controller.js";import"./projects2.js";/* empty css   */import"./events.js";import{d as wt,c as Vt,f as qt}from"./projectsCommon.js";import{g as G,b as $t,a as zt,c as Ht,d as mt,P as Ut,s as Wt}from"./projectFocusTemplates.js";import{g as Ot,k as Yt,l as Kt,a as Qt,b as Jt,o as Xt}from"./projectsService.js";import{i as Gt}from"./dashboardShell.js";Ct({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.hero.subtitle":"👋 هذه نظرة سريعة على بيانات العميل","customerDetails.fields.taxId":"🧾 الرقم الضريبي:","customerDetails.fields.document":"📎 مستند العميل","customerDetails.stats.reservations":"إجمالي الحجوزات","customerDetails.stats.upcoming":"حجوزات قادمة","customerDetails.stats.projects":"عدد المشاريع","customerDetails.stats.lastActivity":"آخر نشاط","customerDetails.stats.reservationsDesc":"عدد الحجوزات الكلي","customerDetails.stats.upcomingEmpty":"لا توجد حجوزات قادمة","customerDetails.stats.nextReservation":"أقرب حجز: {date}","customerDetails.stats.projectsDesc":"المشاريع المرتبطة بالعميل","customerDetails.stats.totalValue":"القيمة الإجمالية: {amount}","customerDetails.stats.totalValueEmpty":"لم يتم رصد مبالغ بعد.","customerDetails.document.open":"عرض المستند","customerDetails.document.defaultName":"المستند المرتبط","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.hero.subtitle":"👋 Here is a quick look at this client","customerDetails.fields.taxId":"🧾 Tax Number:","customerDetails.fields.document":"📎 Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let st={},v={initialized:!1,currentId:null,modal:{el:null,body:null}};function at(t=""){return j(String(t)).trim().toLowerCase()}function Zt(t,n,e){if(!n||!e)return;const{startDate:s,endDate:i}=xt(t);n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s||"",e._flatpickr?i?e._flatpickr.setDate(i,!1,"Y-m-d"):e._flatpickr.clear():e.value=i||""}function tt(t){if(!document.getElementById("customer-reservations"))return;const e=document.getElementById("customer-search-reservation"),s=document.getElementById("customer-filter-start-date"),i=document.getElementById("customer-filter-end-date"),o=document.getElementById("customer-reservation-date-range"),r=document.getElementById("customer-reservation-status-filter"),g=document.getElementById("customer-clear-filters");window.flatpickr&&(s&&window.flatpickr(s,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const f=()=>{let m=j(s?.value||"").trim(),u=j(i?.value||"").trim(),h=o?.value||"";if(new Set(["","today","week","month"]).has(h)||(h="",o&&(o.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),m="",u=""),!m&&!u&&h){const{startDate:a,endDate:c}=xt(h);m=a,u=c}return{searchTerm:at(e?.value||""),startDate:m,endDate:u,status:r?.value||"",quickRange:h,customerId:t}},y=()=>{st=f(),ut("customer-reservations",st)};e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=j(e.value),y()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{o&&(o.value=""),y()}),s.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{o&&(o.value=""),y()}),i.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{Zt(o.value,s,i),y()}),o.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",y),r.dataset.listenerAttached="true"),g&&!g.dataset.listenerAttached&&(g.addEventListener("click",()=>{e&&(e.value=""),s&&(s._flatpickr&&s._flatpickr.clear(),s.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),o&&(o.value=""),r&&(r.value=""),y()}),g.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{ut("customer-reservations",st)},y()}function et(t){v.currentId=t;const{container:n}=V();n&&(v.initialized||(te(),ee(),se(),document.addEventListener("projects:changed",()=>{v.currentId&&P()}),document.addEventListener("language:changed",()=>{v.currentId&&P()}),document.addEventListener("technicians:updated",()=>{v.currentId&&P()}),v.initialized=!0),P())}function V(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function te(){const{searchInput:t,statusSelect:n,clearBtn:e}=V();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=j(t.value),P()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{P()}),n.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{const{searchInput:s,statusSelect:i}=V();s&&(s.value=""),i&&(i.value=""),P()}),e.dataset.listenerAttached="true")}function ee(){const{container:t}=V();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",ne),t.dataset.projectModalListenerAttached="true")}function ne(t){const n=t.target.closest(".project-focus-card");if(!n||t.target.closest("[data-ignore-project-modal]"))return;const s=n.dataset.projectId?String(n.dataset.projectId):"";s&&it(s)}function se(){ct()}function ct(){if(v.modal?.el&&v.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),n=document.getElementById("project-details-body");return!t||!n?!1:(v.modal={el:t,body:n},!0)}function P(){const{container:t,searchInput:n,statusSelect:e}=V();if(!t||!v.currentId)return;const s=at(n?.value||""),i=e?.value||"",{projects:o=[],technicians:r=[],reservations:g=[],customers:f=[]}=L(),y=new Map(r.map(a=>[String(a.id),a])),m=ae(g),u=f.find(a=>String(a.id)===String(v.currentId))||null,E=o.filter(a=>String(a.clientId)===String(v.currentId)).filter(a=>!(s&&!at([a.title,a.description,a.notes].filter(Boolean).join(" ")).includes(s)||i&&wt(a)!==i)).sort((a,c)=>{const d=new Date(a.start||a.createdAt||0).getTime();return new Date(c.start||c.createdAt||0).getTime()-d});if(!E.length){const a=p("customerProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");t.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${a}</div></div>`;return}t.innerHTML=E.map(a=>{const c=G(a),d=c?m.get(c)||[]:[];return $t(a,{customer:u,techniciansMap:y,reservations:d})}).join("")}function ae(t=[]){const n=new Map;return t.forEach(e=>{const s=e?.projectId??e?.project_id??e?.projectID;if(s==null)return;const i=String(s);n.has(i)||n.set(i,[]),n.get(i).push(e)}),n}function it(t){const n=String(t||"").trim();if(!n||!ct())return;const e=v.modal;if(!e?.body)return;e.body.dataset.mode="view";const{projects:s=[],reservations:i=[],customers:o=[]}=L(),r=le(s,n);if(!r||v.currentId&&r.clientId!=null&&String(r.clientId)!==String(v.currentId))return;const g=o.find(m=>String(m.id)===String(r.clientId))||null,f=i.filter(m=>{const u=de(m);return u&&u===n}),y=zt(r,{customer:g,reservations:f});e.body.innerHTML=y,ie(r),oe(e.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e.el).show():(e.el.classList.add("show"),e.el.style.display="block")}function ie(t){if(!t||!v.modal?.body)return;const n=v.modal.body.querySelector('[data-action="edit-project"]');n&&n.addEventListener("click",e=>{e.preventDefault(),re(t)})}function oe(t){if(!t)return;const n=t.querySelectorAll('[data-action="view-reservation"]');n.length&&n.forEach(e=>{e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const i=Ot();let o=Number.parseInt(e.dataset.index||"",10);if(!Number.isInteger(o)||o<0){const r=e.dataset.reservationId;r&&(o=i.findIndex(f=>[f?.id,f?.reservationId,f?.reservation_id].some(m=>m!=null&&String(m)===r)))}Number.isInteger(o)&&o>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(o):k(p("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),e.dataset.listenerAttached="true")})}function re(t){if(!t||!ct())return;const n=v.modal;if(!n?.body)return;const{customers:e=[]}=L(),s=e.find(r=>String(r.id)===String(t.clientId))||null,i=s?.customerName||t.clientName||t.customerName||"",o=t.clientCompany||s?.companyName||s?.company||"";n.body.dataset.mode="edit",n.body.innerHTML=Ht(t,{clientName:i,clientCompany:o}),ce(t,{clientName:i,clientCompany:o})}function ce(t,{clientName:n="",clientCompany:e=""}={}){if(!t||!v.modal?.body)return;const s=v.modal.body.querySelector("#customer-project-edit-form");if(!s)return;const i=s.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",o=>{o.preventDefault();const r=G(t);r&&it(r)}),s.addEventListener("submit",async o=>{if(o.preventDefault(),s.dataset.submitting==="true")return;const r=new FormData(s),g=(r.get("project-title")||"").toString().trim(),f=(r.get("project-type")||"").toString().trim(),y=(r.get("project-start-date")||"").toString().trim(),m=(r.get("project-start-time")||"").toString().trim(),u=(r.get("project-end-date")||"").toString().trim(),h=(r.get("project-end-time")||"").toString().trim(),E=(r.get("project-description")||"").toString().trim(),a=(r.get("project-payment-status")||"").toString()==="paid"?"paid":"unpaid",c=s.querySelector('[name="project-apply-tax"]')?.checked===!0;if(!g||!f||!y){k(p("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const d=mt(y,m),D=u?mt(u,h):"";if(D){const B=new Date(d),R=new Date(D);if(!Number.isNaN(B.getTime())&&!Number.isNaN(R.getTime())&&B>R){k(p("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const N=G(t);if(!N){k(p("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const b=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,x=Array.isArray(t?.expenses)?t.expenses:[],kt=Vt(t),nt=Number((b+kt).toFixed(2)),dt=c?Number((nt*Ut).toFixed(2)):0,Nt=c?Number((nt+dt).toFixed(2)):nt,Bt=Yt({projectCode:t.projectCode,title:g,type:f,clientId:t.clientId,clientCompany:e,description:E,start:d,end:D||null,applyTax:c,paymentStatus:a,equipmentEstimate:b,expenses:x,taxAmount:dt,totalWithTax:Nt,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),S=s.querySelector('button[type="submit"]');S&&(S.disabled=!0,S.dataset.originalText=S.textContent||"",S.textContent=p("projects.details.edit.saving","جاري الحفظ...")),s.dataset.submitting="true";try{const B=await Kt(N,Bt);await Wt(N,a),document.dispatchEvent(new CustomEvent("projects:changed")),k(p("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),P();const R=G(B)||N;R&&it(R)}catch(B){console.error("❌ [customerDetails] Failed to update project from customer modal",B);const R=typeof B?.message=="string"?B.message:p("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");k(R)}finally{delete s.dataset.submitting,S&&(S.disabled=!1,S.dataset.originalText&&(S.textContent=S.dataset.originalText,delete S.dataset.originalText))}})}function le(t=[],n){const e=String(n);return t.find(s=>[s?.id,s?.projectId,s?.project_id].some(o=>o!=null&&String(o)===e))||null}function de(t){if(!t)return null;const n=t.projectId??t.project_id??t.projectID??null;return n!=null?String(n):null}Tt();Pt();_t();Gt();Lt();const $=document.getElementById("logout-btn");$&&!$.dataset.listenerAttached&&($.addEventListener("click",()=>Rt()),$.dataset.listenerAttached="true");window.showReservationDetails=Mt;const ue=new URLSearchParams(window.location.search),I=ue.get("id"),F=document.getElementById("customer-details"),ft=document.getElementById("customer-hero-name"),me=document.getElementById("customer-hero-phone"),fe=document.getElementById("customer-hero-company"),pe=document.getElementById("customer-hero-email"),ge=document.getElementById("customer-hero-tax"),pt=document.getElementById("customer-hero-summary"),gt=document.getElementById("dashboard-greeting-customer-name"),yt=document.getElementById("dashboard-greeting-customer-company"),z=document.getElementById("customer-stat-reservations"),H=document.getElementById("customer-stat-reservations-desc"),U=document.getElementById("customer-stat-upcoming"),W=document.getElementById("customer-stat-upcoming-desc"),O=document.getElementById("customer-stat-projects"),Y=document.getElementById("customer-stat-projects-desc"),K=document.getElementById("customer-stat-last-activity"),Q=document.getElementById("customer-stat-last-activity-desc"),ht=document.getElementById("sidebar-stat-projects"),vt=document.getElementById("sidebar-stat-reservations"),Dt=document.getElementById("sidebar-stat-equipment"),Et=document.getElementById("sidebar-stat-technicians"),lt=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean);lt.forEach(t=>{t.disabled=!0});let l=null,w=!1,C="";function A(t=""){const n=document.createElement("div");return n.textContent=t==null?"":String(t),n.innerHTML}function ye(t=""){const n=A(t).replace(/\r/g,""),e=`
`;return n.includes(e)?n.split(e).join("<br>"):n}function J(t,n,e,{hideWhenEmpty:s=!1}={}){if(!t)return;const i=e==null?"":String(e).trim(),o=i.length>0,r=o?i:"—";t.textContent=`${n} ${r}`,s?t.classList.toggle("hidden",!o):t.classList.remove("hidden")}function ot(t){const n=p("customerDetails.pageTitle","معلومات العميل"),e=t?.customerName||"—",s=t?.phone?j(t.phone):"",i=t?.companyName||"",o=t?.email||"",r=t?.tax_id??t?.taxId??"";if(ft&&(ft.textContent=e),pt&&(pt.textContent=e!=="—"?e:n),J(me,"📞",s,{hideWhenEmpty:!1}),J(fe,"🏢",i,{hideWhenEmpty:!0}),J(pe,"📧",o,{hideWhenEmpty:!0}),J(ge,"🧾",r,{hideWhenEmpty:!0}),gt&&(gt.textContent=e),yt){const g=[];i&&g.push(i),s&&g.push(`📞 ${s}`);const f=typeof r=="string"?r.trim():String(r||"").trim();f&&g.push(`🧾 ${f}`),yt.textContent=g.length?g.join(" • "):"—"}}function he(t){if(t?.preventDefault?.(),!l)return;ke();const n=document.getElementById("editCustomerModal"),e=typeof bootstrap<"u"?bootstrap.Modal:null;if(!n||!e)return;(e.getInstance(n)||new e(n)).show()}function ve(){lt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",he),t.dataset.listenerAttached="true")})}function rt(t){lt.forEach(n=>{n&&(n.disabled=!!t)})}ve();function St(t={}){if(!t||typeof t!="object")return null;const n=[t.document,t.attachment,t.file].find(b=>b&&typeof b=="object"),e=b=>{for(const x of b)if(typeof x=="string"&&x.trim()!=="")return x.trim();return""},s=b=>{for(const x of b){if(typeof x=="number"&&Number.isFinite(x))return Math.max(0,Math.trunc(x));if(typeof x=="string"&&x.trim()!==""&&/^\d+$/.test(x.trim()))return Math.max(0,parseInt(x.trim(),10))}return null},i=[t.document_url,t.documentUrl,t.url,t.href,t.link,n?.url,n?.href,n?.link],o=[t.document_path,t.documentPath,t.path,n?.path,n?.documentPath],r=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,n?.fileName,n?.filename,n?.name],g=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,n?.mimeType,n?.contentType,n?.type],f=[t.document_size,t.documentSize,t.size,n?.size,n?.length],y=[n?.data,n?.base64,n?.content,t.data,t.base64,t.content,t.document_data],m=e(i),u=e(r),h=e(g)||"application/octet-stream",E=e(o),a=e(y),c=s(f);if(!m&&!a)return null;let d=m,D=a;if(!d&&D&&D.startsWith("data:")){const b=D.indexOf(",");b!==-1&&(d=D,D=D.slice(b+1))}!d&&D&&(d=`${D.startsWith("data:")?"":`data:${h};base64,`}${D}`);const N={url:d,fileName:u,mimeType:h,path:E,data:D||null,size:c};return N.url&&/sirv\.com/i.test(N.url)&&(N.source="sirv"),N}function jt(){return document.documentElement.getAttribute("lang")||"ar"}function M(t){const n=Number(t)||0,s=jt()==="ar"?"ar-SA":"en-US";try{return new Intl.NumberFormat(s,{maximumFractionDigits:0}).format(n)}catch{return String(n)}}function It(t){if(!t)return"—";const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return"—";const s=jt()==="ar"?"ar-SA":"en-US";try{return new Intl.DateTimeFormat(s,{dateStyle:"medium"}).format(n)}catch{return n.toLocaleDateString()}}function De(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function bt({projects:t=0,reservations:n=0,equipment:e=0,technicians:s=0}={}){ht&&(ht.textContent=M(t)),vt&&(vt.textContent=M(n)),Dt&&(Dt.textContent=M(e)),Et&&(Et.textContent=M(s))}function _(){if(!l||!I){z&&(z.textContent="0"),H&&(H.textContent=p("customerDetails.stats.reservationsDesc","عدد الحجوزات الكلي")),U&&(U.textContent="0"),W&&(W.textContent=p("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),O&&(O.textContent="0"),Y&&(Y.textContent=p("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل")),K&&(K.textContent="—"),Q&&(Q.textContent=p("customerDetails.stats.totalValueEmpty","لم يتم رصد مبالغ بعد.")),bt({projects:0,reservations:0,equipment:0,technicians:0});return}const t=L(),e=(Array.isArray(t.reservations)?t.reservations:[]).filter(a=>a?[a.customerId,a.customer_id,a.customer?.id].some(d=>d!=null&&String(d)===String(I)):!1),s=e.length,i=Date.now(),o=e.filter(a=>{const c=a?.start??a?.startDatetime??a?.start_datetime??a?.start_date;if(!c)return!1;const d=new Date(c);return Number.isNaN(d.getTime())?!1:d.getTime()>=i}),r=o.map(a=>a?.start??a?.startDatetime??a?.start_datetime).map(a=>new Date(a)).filter(a=>!Number.isNaN(a.getTime())).sort((a,c)=>a-c)[0]||null,y=(Array.isArray(t.projects)?t.projects:[]).filter(a=>a?[a.clientId,a.client_id,a.customer_id].some(d=>d!=null&&String(d)===String(I)):!1).length,m=e.reduce((a,c)=>{const d=c?.totalAmount??c?.cost??c?.netTotal??0,D=Number(d);return a+(Number.isFinite(D)?D:0)},0);let u=null;if(e.forEach(a=>{const c=a?.updatedAt??a?.updated_at??a?.end??a?.endDatetime??a?.end_datetime??a?.start??a?.createdAt??a?.created_at;if(!c)return;const d=new Date(c);Number.isNaN(d.getTime())||(!u||d>u)&&(u=d)}),!u){const a=l?.updated_at??l?.created_at;if(a){const c=new Date(a);Number.isNaN(c.getTime())||(u=c)}}const h=e.reduce((a,c)=>Array.isArray(c?.items)?a+c.items.length:a,0),E=new Set;e.forEach(a=>{Array.isArray(a?.technicians)&&a.technicians.forEach(c=>{const d=c!=null?String(c):"";d&&E.add(d)}),Array.isArray(a?.techniciansDetails)&&a.techniciansDetails.forEach(c=>{const d=c?.id??c?.technician_id??c?.technicianId;d!=null&&E.add(String(d))})}),z&&(z.textContent=M(s)),H&&(H.textContent=p("customerDetails.stats.reservationsDesc","عدد الحجوزات الكلي")),U&&(U.textContent=M(o.length)),W&&(W.textContent=o.length>0&&r?p("customerDetails.stats.nextReservation","أقرب حجز: {date}").replace("{date}",It(r)):p("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),O&&(O.textContent=M(y)),Y&&(Y.textContent=p("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل")),K&&(K.textContent=u?It(u):"—"),Q&&(Q.textContent=m>0?p("customerDetails.stats.totalValue","القيمة الإجمالية: {amount}").replace("{amount}",qt(m)):p("customerDetails.stats.totalValueEmpty","لم يتم رصد مبالغ بعد.")),bt({projects:y,reservations:s,equipment:h,technicians:E.size})}function Ee(t){const{customers:n}=L();if(!Array.isArray(n))return null;const e=n.find(r=>String(r.id)===String(t));if(!e)return null;const s=e.tax_id??e.taxId??"",i=typeof s=="string"?s.trim():String(s||"").trim(),o=e.document??St(e);return{...e,tax_id:i,taxId:i,document:o}}function Ie(t={}){if(!t||typeof t!="object")return null;const n=t.id??t.customerId??t.customer_id??null,e=t.full_name??t.customerName??t.name??"",s=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",i=typeof s=="string"?s.trim():String(s||"").trim(),o=St(t);return n==null?null:{id:String(n),customerName:e,full_name:e,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:i,taxId:i,document:o,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function be(t){if(!t)return;const n=L(),e=Array.isArray(n.customers)?[...n.customers]:[],s=e.findIndex(i=>String(i.id)===String(t.id));s>=0?e[s]={...e[s],...t}:e.push(t),q({customers:e})}async function xe(){const{technicians:t}=L();if(!(Array.isArray(t)&&t.length>0))try{const n=await Z("/technicians/"),e=Array.isArray(n?.data)?n.data.map(Qt):[];e.length>0&&q({technicians:e})}catch(n){console.warn("⚠️ Failed to load technicians list",n)}}async function Se(t){if(t)try{const n=new URLSearchParams({customer_id:String(t),limit:"200"}),e=await Z(`/reservations/?${n.toString()}`),s=Array.isArray(e?.data)?e.data.map(Jt):[];q({reservations:s})}catch(n){console.warn("⚠️ Failed to load customer reservations",n)}}async function je(t){if(t)try{const n=new URLSearchParams({client_id:String(t),limit:"200"}),e=await Z(`/projects/?${n.toString()}`),s=Array.isArray(e?.data)?e.data.map(Xt):[];q({projects:s})}catch(n){console.warn("⚠️ Failed to load customer projects",n)}}async function Ae(t,{showSpinner:n=!1}={}){if(t){n?(w=!0,C="",T()):(w=!0,C="");try{const e=await Z(`/customers/?id=${encodeURIComponent(t)}`),s=e?.data??e,i=Ie(s);if(!i)throw new Error("Invalid customer payload received from server");l=i,be(i),w=!1,C="",T(),await xe(),await Promise.all([Se(i.id),je(i.id)]),tt(i.id),et(i.id),_()}catch(e){if(w=!1,e instanceof Ft&&e.status===404){l=null,C="",T();return}console.error("⚠️ Failed to load customer details",e);const s=p("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");l?(C="",k(s),T()):(C=`${s}${e?.message?` (${e.message})`:""}`,T())}}}function T(){if(!F)return;if(!l){if(ot(null),rt(!0),_(),w){F.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(C){F.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${A(C)}</div>
        </div>
      `;return}const e=p("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.");F.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${A(e)}</div>
      </div>
    `;return}ot(l),rt(!1);const n=[{key:"customerDetails.fields.name",fallback:"👤 الاسم:",value:l.customerName||"—"},{key:"customerDetails.fields.phone",fallback:"📞 الجوال:",value:l.phone?j(l.phone):"—"},{key:"customerDetails.fields.company",fallback:"🏢 الشركة:",value:l.companyName||"—"},{key:"customerDetails.fields.email",fallback:"📧 البريد:",value:l.email||"—"},{key:"customerDetails.fields.address",fallback:"📍 العنوان:",value:l.address||"—"},{key:"customerDetails.fields.taxId",fallback:"🧾 الرقم الضريبي:",value:l.tax_id??l.taxId??"—"},{key:"customerDetails.fields.notes",fallback:"📝 الملاحظات:",value:l.notes||"—",multiline:!0},{key:"customerDetails.fields.document",fallback:"📎 مستند العميل",value:l.document??null,type:"document"}].map(e=>{const s=p(e.key,e.fallback);if(e.type==="document"){const f=e.value;let y='<span class="text-base-content/50">—</span>';if(f&&typeof f=="object"){const m=f.fileName?.trim()||f.path?.trim()||f.url||"";if(f.url){const u=A(m||p("customerDetails.document.defaultName","المستند المرتبط")),h=De(f.url),E=A(p("customerDetails.document.open","عرض المستند"));y=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${u}</span><a class="btn btn-outline btn-sm" href="${h}" target="_blank" rel="noopener noreferrer">${E}</a></div>`}else m&&(y=`<span class="text-base-content break-all">${A(m)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${A(s)}</span>
          <div class="mt-2">${y}</div>
        </article>
      `}const o=(e.value==null?"":String(e.value)).trim(),r=o.length>0?o:"—",g=e.multiline?ye(r):A(r);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${e.key}">${A(s)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${g}</p>
      </article>
    `}).join("");F.innerHTML=n,_()}function ke(){document.getElementById("edit-id").value=l?.id||"",document.getElementById("edit-name").value=l?.customerName||"",document.getElementById("edit-phone").value=j(l?.phone||""),document.getElementById("edit-company").value=l?.companyName||"",document.getElementById("edit-email").value=l?.email||"",document.getElementById("edit-address").value=l?.address||"",document.getElementById("edit-tax-id").value=j(l?.tax_id??l?.taxId??"");const t=l?.document??null;document.getElementById("edit-document-url").value=t?.url||"",document.getElementById("edit-document-name").value=t?.fileName||"",document.getElementById("edit-notes").value=l?.notes||""}const X=document.getElementById("save-edit-btn");X&&!X.dataset.listenerAttached&&(X.addEventListener("click",()=>{if(!l)return;const t=document.getElementById("edit-id").value,n=document.getElementById("edit-name").value.trim(),e=j(document.getElementById("edit-phone").value.trim()),s=document.getElementById("edit-company").value.trim(),i=document.getElementById("edit-email").value.trim(),o=document.getElementById("edit-address").value.trim(),r=j(document.getElementById("edit-tax-id").value.trim()),g=document.getElementById("edit-document-url").value.trim(),f=document.getElementById("edit-document-name").value.trim(),y=document.getElementById("edit-notes").value.trim();if(!n||!e){k(p("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const m=L(),u=Array.isArray(m.customers)?m.customers:[],h=u.findIndex(c=>String(c.id)===String(t));if(h===-1){k(p("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}let E=null;if(g){const c=u[h]?.document??null;E={...c||{},url:g,fileName:f||c?.fileName||""}}u[h]={...u[h],customerName:n,phone:e,companyName:s,email:i,address:o,notes:y,tax_id:r,taxId:r,document:E},q({customers:u}),l=u[h],T(),tt(I),et(I),_(),document.dispatchEvent(new CustomEvent("customers:changed")),k(p("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),X.dataset.listenerAttached="true");async function Ne(){if(F){if(!I){ot(null),rt(!0),_(),F.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${p("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}l=Ee(I),l&&(T(),tt(I),et(I),_()),await Ae(I,{showSpinner:!l})}}Ne();const At=()=>{!I||!l||_()};document.addEventListener("reservations:changed",At);document.addEventListener("projects:changed",At);document.addEventListener("language:changed",()=>{T(),I&&l&&(tt(I),et(I),_())});
