import{x as wt,n as T,e as $,t as l,h as B,a as qt,c as Vt,i as Ot,m as zt,l as Ht,b as it,A as Ut,s as U}from"./auth.js";import{i as Wt}from"./dashboardShell.js";import"./projects2.js";/* empty css   */import{r as bt,a as Ft,s as Yt}from"./controller.js";import"./events.js";import{d as Kt,c as Qt,f as rt}from"./projectsCommon.js";import{g as nt,b as Jt,a as Xt,c as Gt,d as It,P as Zt,s as te,r as ee}from"./projectFocusTemplates.js";import{g as se,k as ae,l as ne,a as ie,b as oe,o as re}from"./projectsService.js";wt({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.hero.subtitle":"👋 هذه نظرة سريعة على بيانات العميل","customerDetails.fields.taxId":"🧾 الرقم الضريبي:","customerDetails.fields.document":"📎 مستند العميل","customerDetails.stats.reservations":"إجمالي الحجوزات","customerDetails.stats.upcoming":"حجوزات قادمة","customerDetails.stats.projects":"عدد المشاريع","customerDetails.stats.projectsEmpty":"لا توجد مشاريع مرتبطة بهذا العميل.","customerDetails.stats.lastActivity":"آخر نشاط","customerDetails.stats.lastActivityEmpty":"لا يوجد نشاط حديث","customerDetails.stats.reservationsDesc":"عدد الحجوزات الكلي","customerDetails.stats.upcomingEmpty":"لا توجد حجوزات قادمة","customerDetails.stats.nextReservation":"أقرب حجز: {date}","customerDetails.stats.projectsDesc":"المشاريع المرتبطة بالعميل","customerDetails.stats.payment":"قيمة المدفوع/المستحق","customerDetails.stats.paymentBreakdown":"مدفوع / مستحق","customerDetails.stats.paymentPaid":"المدفوع","customerDetails.stats.paymentOutstandingLabel":"المستحق","customerDetails.stats.totalValue":"القيمة الإجمالية: {amount}","customerDetails.stats.totalValueEmpty":"لم يتم رصد مبالغ بعد.","customerDetails.stats.paymentOutstanding":"المتبقي: {amount}","customerDetails.stats.paymentAllSet":"لا توجد مبالغ مستحقة","customerDetails.stats.paymentOutstandingEmpty":"لا توجد مبالغ مستحقة","customerDetails.stats.activityEmpty":"لا يوجد نشاط حديث","customerDetails.stats.activityOn":"بتاريخ {date}","customerDetails.stats.activityType.reservation":"حجز","customerDetails.stats.activityType.project":"مشروع","customerDetails.stats.activityType.customer":"بيانات العميل","customerDetails.stats.complianceEmpty":"لا توجد بيانات دفع كافية","customerDetails.stats.complianceProjects":"مشاريع مدفوعة بالكامل: {count} من {total}","customerDetails.stats.complianceLabel.excellent":"التزام ممتاز","customerDetails.stats.complianceLabel.good":"دفع في الوقت المحدد","customerDetails.stats.complianceLabel.average":"يحتاج متابعة","customerDetails.stats.complianceLabel.poor":"تأخير متكرر","customerDetails.document.open":"عرض المستند","customerDetails.document.defaultName":"المستند المرتبط","customerTabs.reservations":"📅 إدارة الحجوزات","customerTabs.projects":"📁 إدارة المشاريع","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.status.loading":"⏳ جارٍ تحميل بيانات العميل...","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.loadFailed":"⚠️ تعذر تحميل بيانات العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.hero.subtitle":"👋 Here is a quick look at this client","customerDetails.fields.taxId":"🧾 Tax Number:","customerDetails.fields.document":"📎 Client Document","customerDetails.stats.reservations":"Total Reservations","customerDetails.stats.upcoming":"Upcoming Reservations","customerDetails.stats.projects":"Projects Count","customerDetails.stats.projectsEmpty":"No projects linked yet.","customerDetails.stats.lastActivity":"Last Activity","customerDetails.stats.lastActivityEmpty":"No recent activity","customerDetails.stats.reservationsDesc":"All linked reservations","customerDetails.stats.upcomingEmpty":"No upcoming reservations","customerDetails.stats.nextReservation":"Next reservation: {date}","customerDetails.stats.projectsDesc":"Projects tied to the client","customerDetails.stats.payment":"Paid vs Outstanding","customerDetails.stats.paymentBreakdown":"Paid / Outstanding","customerDetails.stats.paymentPaid":"Paid","customerDetails.stats.paymentOutstandingLabel":"Outstanding","customerDetails.stats.totalValue":"Total value: {amount}","customerDetails.stats.totalValueEmpty":"No financial data recorded yet.","customerDetails.stats.paymentOutstanding":"Outstanding: {amount}","customerDetails.stats.paymentAllSet":"No pending payments","customerDetails.stats.paymentOutstandingEmpty":"No pending payments","customerDetails.stats.activityEmpty":"No recent activity","customerDetails.stats.activityOn":"On {date}","customerDetails.stats.activityType.reservation":"Reservation","customerDetails.stats.activityType.project":"Project","customerDetails.stats.activityType.customer":"Client record","customerDetails.stats.complianceEmpty":"Not enough payment data yet","customerDetails.stats.complianceProjects":"Fully paid projects: {count} of {total}","customerDetails.stats.complianceLabel.excellent":"Excellent commitment","customerDetails.stats.complianceLabel.good":"On-time payments","customerDetails.stats.complianceLabel.average":"Needs follow-up","customerDetails.stats.complianceLabel.poor":"Repeated delays","customerDetails.document.open":"Open document","customerDetails.document.defaultName":"Linked document","customerTabs.reservations":"📅 Booking Management","customerTabs.projects":"📁 Project Management","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.status.loading":"⏳ Loading client information...","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.loadFailed":"⚠️ Failed to load client information.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let ct={},E={initialized:!1,currentId:null,modal:{el:null,body:null}};function dt(t=""){return T(String(t)).trim().toLowerCase()}function ce(t,e,s){if(!e||!s)return;const{startDate:a,endDate:i}=Ft(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",s._flatpickr?i?s._flatpickr.setDate(i,!1,"Y-m-d"):s._flatpickr.clear():s.value=i||""}function ot(t){if(!document.getElementById("customer-reservations"))return;const s=document.getElementById("customer-search-reservation"),a=document.getElementById("customer-filter-start-date"),i=document.getElementById("customer-filter-end-date"),o=document.getElementById("customer-reservation-date-range"),r=document.getElementById("customer-reservation-status-filter"),y=document.getElementById("customer-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const m=()=>{let p=T(a?.value||"").trim(),g=T(i?.value||"").trim(),D=o?.value||"";if(new Set(["","today","week","month"]).has(D)||(D="",o&&(o.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),p="",g=""),!p&&!g&&D){const{startDate:u,endDate:v}=Ft(D);p=u,g=v}return{searchTerm:dt(s?.value||""),startDate:p,endDate:g,status:r?.value||"",quickRange:D,customerId:t}},f=()=>{ct=m(),bt("customer-reservations",ct)};s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=T(s.value),f()}),s.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{o&&(o.value=""),f()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{o&&(o.value=""),f()}),i.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{ce(o.value,a,i),f()}),o.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("change",f),r.dataset.listenerAttached="true"),y&&!y.dataset.listenerAttached&&(y.addEventListener("click",()=>{s&&(s.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),o&&(o.value=""),r&&(r.value=""),f()}),y.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{bt("customer-reservations",ct)},f()}function W(t){E.currentId=t;const{container:e}=H();e&&(E.initialized||(le(),de(),me(),document.addEventListener("projects:changed",()=>{E.currentId&&R()}),document.addEventListener("language:changed",()=>{E.currentId&&R()}),document.addEventListener("technicians:updated",()=>{E.currentId&&R()}),E.initialized=!0),R())}function H(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function le(){const{searchInput:t,statusSelect:e,clearBtn:s}=H();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=T(t.value),R()}),t.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{R()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("click",()=>{const{searchInput:a,statusSelect:i}=H();a&&(a.value=""),i&&(i.value=""),R()}),s.dataset.listenerAttached="true")}function de(){const{container:t}=H();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",ue),t.dataset.projectModalListenerAttached="true")}function ue(t){const e=t.target.closest(".project-focus-card");if(!e||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&ut(a)}function me(){gt()}function gt(){if(E.modal?.el&&E.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");return!t||!e?!1:(E.modal={el:t,body:e},!0)}function R(){const{container:t,searchInput:e,statusSelect:s}=H();if(!t||!E.currentId)return;const a=dt(e?.value||""),i=s?.value||"",{projects:o=[],technicians:r=[],reservations:y=[],customers:m=[]}=$(),f=new Map(r.map(u=>[String(u.id),u])),p=pe(y),g=m.find(u=>String(u.id)===String(E.currentId))||null,b=o.filter(u=>String(u.clientId)===String(E.currentId)).filter(u=>!(a&&!dt([u.title,u.description,u.notes].filter(Boolean).join(" ")).includes(a)||i&&Kt(u)!==i)).sort((u,v)=>{const x=new Date(u.start||u.createdAt||0).getTime();return new Date(v.start||v.createdAt||0).getTime()-x});if(!b.length){const u=l("customerProjects.empty",t.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${u}</div></div>`;return}t.innerHTML=b.map(u=>{const v=nt(u),x=v?p.get(v)||[]:[];return Jt(u,{customer:g,techniciansMap:f,reservations:x})}).join("")}function pe(t=[]){const e=new Map;return t.forEach(s=>{const a=s?.projectId??s?.project_id??s?.projectID;if(a==null)return;const i=String(a);e.has(i)||e.set(i,[]),e.get(i).push(s)}),e}function ut(t){const e=String(t||"").trim();if(!e||!gt())return;const s=E.modal;if(!s?.body)return;s.body.dataset.mode="view";const{projects:a=[],reservations:i=[],customers:o=[]}=$(),r=De(a,e);if(!r||E.currentId&&r.clientId!=null&&String(r.clientId)!==String(E.currentId))return;const y=o.find(p=>String(p.id)===String(r.clientId))||null,m=i.filter(p=>{const g=ve(p);return g&&g===e}),f=Xt(r,{customer:y,reservations:m});s.body.innerHTML=f,fe(r),ye(s.body),window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(s.el).show():(s.el.classList.add("show"),s.el.style.display="block")}function fe(t){if(!t||!E.modal?.body)return;const e=E.modal.body.querySelector('[data-action="edit-project"]');e&&e.addEventListener("click",s=>{s.preventDefault(),ge(t)})}function ye(t){if(!t)return;const e=t.querySelectorAll('[data-action="view-reservation"]');e.length&&e.forEach(s=>{s.dataset.listenerAttached!=="true"&&(s.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const i=se();let o=Number.parseInt(s.dataset.index||"",10);if(!Number.isInteger(o)||o<0){const r=s.dataset.reservationId;r&&(o=i.findIndex(m=>[m?.id,m?.reservationId,m?.reservation_id].some(p=>p!=null&&String(p)===r)))}Number.isInteger(o)&&o>=0&&typeof window.showReservationDetails=="function"?window.showReservationDetails(o):B(l("projects.details.reservations.viewUnavailable","تعذر فتح تفاصيل الحجز الآن"))}),s.dataset.listenerAttached="true")})}function ge(t){if(!t||!gt())return;const e=E.modal;if(!e?.body)return;const{customers:s=[]}=$(),a=s.find(r=>String(r.id)===String(t.clientId))||null,i=a?.customerName||t.clientName||t.customerName||"",o=t.clientCompany||a?.companyName||a?.company||"";e.body.dataset.mode="edit",e.body.innerHTML=Gt(t,{clientName:i,clientCompany:o}),he(t,{clientName:i,clientCompany:o})}function he(t,{clientName:e="",clientCompany:s=""}={}){if(!t||!E.modal?.body)return;const a=E.modal.body.querySelector("#customer-project-edit-form");if(!a)return;const i=a.querySelector('[data-action="cancel-edit"]');i&&i.addEventListener("click",o=>{o.preventDefault();const r=nt(t);r&&ut(r)}),a.addEventListener("submit",async o=>{if(o.preventDefault(),a.dataset.submitting==="true")return;const r=new FormData(a),y=(r.get("project-title")||"").toString().trim(),m=(r.get("project-type")||"").toString().trim(),f=(r.get("project-start-date")||"").toString().trim(),p=(r.get("project-start-time")||"").toString().trim(),g=(r.get("project-end-date")||"").toString().trim(),D=(r.get("project-end-time")||"").toString().trim(),b=(r.get("project-description")||"").toString().trim(),u=(r.get("project-payment-status")||"").toString()==="paid"?"paid":"unpaid",v=a.querySelector('[name="project-apply-tax"]')?.checked===!0;if(!y||!m||!f){B(l("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const x=It(f,p),I=g?It(g,D):"";if(I){const L=new Date(x),M=new Date(I);if(!Number.isNaN(L.getTime())&&!Number.isNaN(M.getTime())&&L>M){B(l("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}}const j=nt(t);if(!j){B(l("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const S=Number(t?.equipmentEstimate??t?.equipment_estimate??0)||0,n=Array.isArray(t?.expenses)?t.expenses:[],c=Qt(t),h=Number((S+c).toFixed(2)),q=v?Number((h*Zt).toFixed(2)):0,vt=v?Number((h+q).toFixed(2)):h,Et=ae({projectCode:t.projectCode,title:y,type:m,clientId:t.clientId,clientCompany:s,description:b,start:x,end:I||null,applyTax:v,paymentStatus:u,equipmentEstimate:S,expenses:n,taxAmount:q,totalWithTax:vt,confirmed:t.confirmed,technicians:Array.isArray(t?.technicians)?t.technicians:[],equipment:Array.isArray(t?.equipment)?t.equipment:[]}),k=a.querySelector('button[type="submit"]');k&&(k.disabled=!0,k.dataset.originalText=k.textContent||"",k.textContent=l("projects.details.edit.saving","جاري الحفظ...")),a.dataset.submitting="true";try{const L=await ne(j,Et);await te(j,u),document.dispatchEvent(new CustomEvent("projects:changed")),B(l("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),R();const M=nt(L)||j;M&&ut(M)}catch(L){console.error("❌ [customerDetails] Failed to update project from customer modal",L);const M=typeof L?.message=="string"?L.message:l("projects.toast.updateFailed","تعذر تحديث المشروع، حاول مرة أخرى");B(M)}finally{delete a.dataset.submitting,k&&(k.disabled=!1,k.dataset.originalText&&(k.textContent=k.dataset.originalText,delete k.dataset.originalText))}})}function De(t=[],e){const s=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(o=>o!=null&&String(o)===s))||null}function ve(t){if(!t)return null;const e=t.projectId??t.project_id??t.projectID??null;return e!=null?String(e):null}qt();Vt();Ot();Wt();zt();const Y=document.getElementById("logout-btn");Y&&!Y.dataset.listenerAttached&&(Y.addEventListener("click",()=>Ht()),Y.dataset.listenerAttached="true");window.showReservationDetails=Yt;const Ee=new URLSearchParams(window.location.search),A=Ee.get("id"),w=document.getElementById("customer-details"),xt=document.getElementById("customer-hero-name"),be=document.getElementById("customer-hero-phone"),Ie=document.getElementById("customer-hero-company"),xe=document.getElementById("customer-hero-email"),Se=document.getElementById("customer-hero-tax"),St=document.getElementById("customer-hero-summary"),At=document.getElementById("dashboard-greeting-customer-name"),jt=document.getElementById("dashboard-greeting-customer-company"),K=document.getElementById("customer-stat-projects"),Q=document.getElementById("customer-stat-projects-desc"),J=document.getElementById("customer-stat-payment"),X=document.getElementById("customer-stat-payment-desc"),G=document.getElementById("customer-stat-upcoming"),Z=document.getElementById("customer-stat-upcoming-desc"),V=document.getElementById("customer-stat-activity"),tt=document.getElementById("customer-stat-activity-desc"),et=document.getElementById("customer-stat-compliance"),O=document.getElementById("customer-stat-compliance-desc"),kt=document.getElementById("sidebar-stat-projects"),Tt=document.getElementById("sidebar-stat-reservations"),Ct=document.getElementById("sidebar-stat-equipment"),Bt=document.getElementById("sidebar-stat-technicians"),ht=[document.getElementById("customer-edit-btn"),document.getElementById("customer-edit-btn-secondary")].filter(Boolean),mt=Array.from(document.querySelectorAll("[data-customer-tab]")),Ae=new Map(Array.from(document.querySelectorAll("[data-customer-tab-panel]")).map(t=>[t.getAttribute("data-customer-tab-panel"),t]));ht.forEach(t=>{t.disabled=!0});let d=null,z=!1,P="",Dt="reservations";function C(t=""){const e=document.createElement("div");return e.textContent=t==null?"":String(t),e.innerHTML}function je(t=""){const e=C(t).replace(/\r/g,""),s=`
`;return e.includes(s)?e.split(s).join("<br>"):e}function st(t,e,s,{hideWhenEmpty:a=!1}={}){if(!t)return;const i=s==null?"":String(s).trim(),o=i.length>0,r=o?i:"—";t.textContent=`${e} ${r}`,a?t.classList.toggle("hidden",!o):t.classList.remove("hidden")}function pt(t){const e=l("customerDetails.pageTitle","معلومات العميل"),s=t?.customerName||"—",a=t?.phone?T(t.phone):"",i=t?.companyName||"",o=t?.email||"",r=t?.tax_id??t?.taxId??"";if(xt&&(xt.textContent=s),St&&(St.textContent=s!=="—"?s:e),st(be,"📞",a,{hideWhenEmpty:!1}),st(Ie,"🏢",i,{hideWhenEmpty:!0}),st(xe,"📧",o,{hideWhenEmpty:!0}),st(Se,"🧾",r,{hideWhenEmpty:!0}),At&&(At.textContent=s),jt){const y=[];i&&y.push(i),a&&y.push(`📞 ${a}`);const m=typeof r=="string"?r.trim():String(r||"").trim();m&&y.push(`🧾 ${m}`),jt.textContent=y.length?y.join(" • "):"—"}}function ke(t){if(t?.preventDefault?.(),!d)return;qe();const e=document.getElementById("editCustomerModal"),s=typeof bootstrap<"u"?bootstrap.Modal:null;if(!e||!s)return;(s.getInstance(e)||new s(e)).show()}function Te(){ht.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",ke),t.dataset.listenerAttached="true")})}function ft(t){ht.forEach(e=>{e&&(e.disabled=!!t)})}Te();function yt(t){t&&(Dt=t,mt.forEach(e=>{const s=e?.getAttribute("data-customer-tab")===t;e&&(e.classList.toggle("tab-active",s),e.classList.toggle("active",s),e.setAttribute("aria-selected",String(s)))}),Ae.forEach((e,s)=>{e&&e.classList.toggle("hidden",s!==t)}),t==="projects"&&A&&d&&W(A))}function Ce(){mt.length&&(mt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-customer-tab");e&&yt(e)}),t.dataset.listenerAttached="true")}),yt(Dt))}Ce();function $t(t={}){if(!t||typeof t!="object")return null;const e=[t.document,t.attachment,t.file].find(S=>S&&typeof S=="object"),s=S=>{for(const n of S)if(typeof n=="string"&&n.trim()!=="")return n.trim();return""},a=S=>{for(const n of S){if(typeof n=="number"&&Number.isFinite(n))return Math.max(0,Math.trunc(n));if(typeof n=="string"&&n.trim()!==""&&/^\d+$/.test(n.trim()))return Math.max(0,parseInt(n.trim(),10))}return null},i=[t.document_url,t.documentUrl,t.url,t.href,t.link,e?.url,e?.href,e?.link],o=[t.document_path,t.documentPath,t.path,e?.path,e?.documentPath],r=[t.document_file_name,t.documentFileName,t.document_name,t.fileName,t.filename,t.name,e?.fileName,e?.filename,e?.name],y=[t.document_mime_type,t.documentMimeType,t.document_type,t.mimeType,t.contentType,t.type,e?.mimeType,e?.contentType,e?.type],m=[t.document_size,t.documentSize,t.size,e?.size,e?.length],f=[e?.data,e?.base64,e?.content,t.data,t.base64,t.content,t.document_data],p=s(i),g=s(r),D=s(y)||"application/octet-stream",b=s(o),u=s(f),v=a(m);if(!p&&!u)return null;let x=p,I=u;if(!x&&I&&I.startsWith("data:")){const S=I.indexOf(",");S!==-1&&(x=I,I=I.slice(S+1))}!x&&I&&(x=`${I.startsWith("data:")?"":`data:${D};base64,`}${I}`);const j={url:x,fileName:g,mimeType:D,path:b,data:I||null,size:v};return j.url&&/sirv\.com/i.test(j.url)&&(j.source="sirv"),j}function Be(){return document.documentElement.getAttribute("lang")||"ar"}function N(t){const e=Number(t)||0;try{return new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(e)}catch{return String(e)}}function Nt(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const a=Be()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),y=e.getFullYear();return`${o}/${r}/${y}`}}function Lt(t){if(!t)return"";const e=t.trim().split(/\s+/),s=e.pop()||"";return`<span class="currency-amount">${e.join(" ")}</span> <span class="currency-unit currency-unit--sm">${s}</span>`}function Pt(t,e){const s=l("customerDetails.stats.paymentPaid","المدفوع"),a=l("customerDetails.stats.paymentOutstandingLabel","المستحق");return`
    <div class="payment-line payment-line--paid">
      <span class="payment-line-label">${s}</span>
      ${Lt(t)}
    </div>
    <div class="payment-line payment-line--outstanding">
      <span class="payment-line-label">${a}</span>
      ${Lt(e)}
    </div>
  `}const _t={excellent:"Excellent commitment",good:"On-time payments",average:"Needs follow-up",poor:"Repeated delays"},Ne={reservation:"Reservation",project:"Project",customer:"Client record"};function lt(t=[]){let e=null;return t.forEach(s=>{if(!s)return;const a=s instanceof Date?s:new Date(s);Number.isNaN(a.getTime())||(!e||a>e)&&(e=a)}),e}function Le(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function Rt({projects:t=0,reservations:e=0,equipment:s=0,technicians:a=0}={}){kt&&(kt.textContent=N(t)),Tt&&(Tt.textContent=N(e)),Ct&&(Ct.textContent=N(s)),Bt&&(Bt.textContent=N(a))}function F(){if(!d||!A){const n=rt(0);if(K&&(K.textContent="0"),Q&&(Q.textContent=l("customerDetails.stats.projectsEmpty","لا توجد مشاريع مرتبطة بهذا العميل.")),J&&(J.innerHTML=Pt(n,n)),X){const c=l("customerDetails.stats.paymentBreakdown","مدفوع / مستحق"),h=l("customerDetails.stats.paymentOutstandingEmpty","لا توجد مبالغ مستحقة");X.textContent=`${c} • ${h}`}G&&(G.textContent="0"),Z&&(Z.textContent=l("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),V&&(V.textContent="—"),tt&&(tt.textContent=l("customerDetails.stats.activityEmpty","لا يوجد نشاط حديث")),et&&(et.textContent="0%"),O&&(O.textContent=l("customerDetails.stats.complianceEmpty","لا توجد بيانات دفع كافية")),Rt({projects:0,reservations:0,equipment:0,technicians:0});return}const t=$(),s=(Array.isArray(t.reservations)?t.reservations:[]).filter(n=>n?[n.customerId,n.customer_id,n.customer?.id].some(h=>h!=null&&String(h)===String(A)):!1),a=s.length,i=Date.now(),o=s.filter(n=>{const c=n?.start??n?.startDatetime??n?.start_datetime??n?.start_date;if(!c)return!1;const h=new Date(c);return Number.isNaN(h.getTime())?!1:h.getTime()>=i}),r=o.map(n=>n?.start??n?.startDatetime??n?.start_datetime).map(n=>new Date(n)).filter(n=>!Number.isNaN(n.getTime())).sort((n,c)=>n-c)[0]||null,m=(Array.isArray(t.projects)?t.projects:[]).filter(n=>n?[n.clientId,n.client_id,n.customer_id].some(h=>h!=null&&String(h)===String(A)):!1),f=m.length,p=m.reduce((n,c)=>{if(!c)return n;const h=ee(c)||{},q=Number(h.totalWithTax??h.subtotal??0)||0;return String(c?.paymentStatus??c?.status??"").toLowerCase()==="paid"?(n.paid+=q,n.paidCount+=1):n.outstanding+=q,n},{paid:0,outstanding:0,paidCount:0}),g=f>0?Math.round(p.paidCount/f*100):0,D=[];if(s.forEach(n=>{const c=lt([n?.updatedAt,n?.updated_at,n?.end,n?.endDatetime,n?.end_datetime,n?.start,n?.startDatetime,n?.start_datetime,n?.createdAt,n?.created_at]);c&&D.push({date:c,type:"reservation"})}),m.forEach(n=>{const c=lt([n?.updatedAt,n?.updated_at,n?.end,n?.end_datetime,n?.start,n?.start_datetime,n?.createdAt,n?.created_at]);c&&D.push({date:c,type:"project"})}),!D.length){const n=lt([d?.updated_at,d?.updatedAt,d?.created_at,d?.createdAt]);n&&D.push({date:n,type:"customer"})}const b=D.reduce((n,c)=>n?c.date>n.date?c:n:c,null),u=b?.date??null,v=b?.type??null,x=s.reduce((n,c)=>Array.isArray(c?.items)?n+c.items.length:n,0),I=new Set;s.forEach(n=>{Array.isArray(n?.technicians)&&n.technicians.forEach(c=>{const h=c!=null?String(c):"";h&&I.add(h)}),Array.isArray(n?.techniciansDetails)&&n.techniciansDetails.forEach(c=>{const h=c?.id??c?.technician_id??c?.technicianId;h!=null&&I.add(String(h))})}),K&&(K.textContent=N(f)),Q&&(Q.textContent=f>0?l("customerDetails.stats.projectsDesc","المشاريع المرتبطة بالعميل"):l("customerDetails.stats.projectsEmpty","لا توجد مشاريع مرتبطة بهذا العميل."));const j=rt(p.paid),S=rt(p.outstanding);if(J&&(J.innerHTML=Pt(j,S)),X){const n=l("customerDetails.stats.paymentBreakdown","مدفوع / مستحق"),c=p.outstanding>0?l("customerDetails.stats.paymentOutstanding","المتبقي: {amount}").replace("{amount}",S):l("customerDetails.stats.paymentAllSet","لا توجد مبالغ مستحقة");X.textContent=`${n} • ${c}`}if(G&&(G.textContent=N(o.length)),Z&&(Z.textContent=o.length>0&&r?l("customerDetails.stats.nextReservation","أقرب حجز: {date}").replace("{date}",Nt(r)):l("customerDetails.stats.upcomingEmpty","لا توجد حجوزات قادمة")),V)if(v){const n=l(`customerDetails.stats.activityType.${v}`,Ne[v]||v);V.textContent=n}else V.textContent="—";if(tt&&(tt.textContent=u?l("customerDetails.stats.activityOn","بتاريخ {date}").replace("{date}",Nt(u)):l("customerDetails.stats.activityEmpty","لا يوجد نشاط حديث")),et&&(et.textContent=`${N(g)}%`),O)if(f>0){const n=g>=90?"excellent":g>=70?"good":g>=40?"average":"poor",c=n?l(`customerDetails.stats.complianceLabel.${n}`,_t[n]||_t.poor):"",h=l("customerDetails.stats.complianceProjects","مشاريع مدفوعة بالكامل: {count} من {total}").replace("{count}",N(p.paidCount)).replace("{total}",N(f));O.textContent=c?`${c} • ${h}`:h}else O.textContent=l("customerDetails.stats.complianceEmpty","لا توجد بيانات دفع كافية");Rt({projects:f,reservations:a,equipment:x,technicians:I.size})}function Pe(t){const{customers:e}=$();if(!Array.isArray(e))return null;const s=e.find(r=>String(r.id)===String(t));if(!s)return null;const a=s.tax_id??s.taxId??"",i=typeof a=="string"?a.trim():String(a||"").trim(),o=s.document??$t(s);return{...s,tax_id:i,taxId:i,document:o}}function _e(t={}){if(!t||typeof t!="object")return null;const e=t.id??t.customerId??t.customer_id??null,s=t.full_name??t.customerName??t.name??"",a=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",i=typeof a=="string"?a.trim():String(a||"").trim(),o=$t(t);return e==null?null:{id:String(e),customerName:s,full_name:s,phone:t.phone??"",companyName:t.company??t.company_name??t.companyName??"",company:t.company??t.company_name??t.companyName??"",email:t.email??"",address:t.address??"",notes:t.notes??"",tax_id:i,taxId:i,document:o,created_at:t.created_at??t.createdAt??null,updated_at:t.updated_at??t.updatedAt??null}}function Re(t){if(!t)return;const e=$(),s=Array.isArray(e.customers)?[...e.customers]:[],a=s.findIndex(i=>String(i.id)===String(t.id));a>=0?s[a]={...s[a],...t}:s.push(t),U({customers:s})}async function Fe(){const{technicians:t}=$();if(!(Array.isArray(t)&&t.length>0))try{const e=await it("/technicians/"),s=Array.isArray(e?.data)?e.data.map(ie):[];s.length>0&&U({technicians:s})}catch(e){console.warn("⚠️ Failed to load technicians list",e)}}async function $e(t){if(t)try{const e=new URLSearchParams({customer_id:String(t),limit:"200"}),s=await it(`/reservations/?${e.toString()}`),a=Array.isArray(s?.data)?s.data.map(oe):[];U({reservations:a})}catch(e){console.warn("⚠️ Failed to load customer reservations",e)}}async function Me(t){if(t)try{const e=new URLSearchParams({client_id:String(t),limit:"200"}),s=await it(`/projects/?${e.toString()}`),a=Array.isArray(s?.data)?s.data.map(re):[];U({projects:a})}catch(e){console.warn("⚠️ Failed to load customer projects",e)}}async function we(t,{showSpinner:e=!1}={}){if(t){e?(z=!0,P="",_()):(z=!0,P="");try{const s=await it(`/customers/?id=${encodeURIComponent(t)}`),a=s?.data??s,i=_e(a);if(!i)throw new Error("Invalid customer payload received from server");d=i,Re(i),z=!1,P="",_(),await Fe(),await Promise.all([$e(i.id),Me(i.id)]),ot(i.id),W(i.id),F()}catch(s){if(z=!1,s instanceof Ut&&s.status===404){d=null,P="",_();return}console.error("⚠️ Failed to load customer details",s);const a=l("customerDetails.errors.loadFailed","⚠️ تعذر تحميل بيانات العميل.");d?(P="",B(a),_()):(P=`${a}${s?.message?` (${s.message})`:""}`,_())}}}function _(){if(!w)return;if(yt(Dt),!d){if(pt(null),ft(!0),F(),z){w.innerHTML=`
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
        <div class="skeleton h-24 w-full rounded-2xl"></div>
      `;return}if(P){w.innerHTML=`
        <div class="col-span-full">
          <div class="alert alert-error">${C(P)}</div>
        </div>
      `;return}const s=l("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.");w.innerHTML=`
      <div class="col-span-full">
        <div class="alert alert-warning" data-i18n data-i18n-key="customerDetails.errors.notFound">${C(s)}</div>
      </div>
    `;return}pt(d),ft(!1);const e=[{key:"customerDetails.fields.name",fallback:"👤 الاسم:",value:d.customerName||"—"},{key:"customerDetails.fields.phone",fallback:"📞 الجوال:",value:d.phone?T(d.phone):"—"},{key:"customerDetails.fields.company",fallback:"🏢 الشركة:",value:d.companyName||"—"},{key:"customerDetails.fields.email",fallback:"📧 البريد:",value:d.email||"—"},{key:"customerDetails.fields.address",fallback:"📍 العنوان:",value:d.address||"—"},{key:"customerDetails.fields.taxId",fallback:"🧾 الرقم الضريبي:",value:d.tax_id??d.taxId??"—"},{key:"customerDetails.fields.notes",fallback:"📝 الملاحظات:",value:d.notes||"—",multiline:!0},{key:"customerDetails.fields.document",fallback:"📎 مستند العميل",value:d.document??null,type:"document"}].map(s=>{const a=l(s.key,s.fallback);if(s.type==="document"){const m=s.value;let f='<span class="text-base-content/50">—</span>';if(m&&typeof m=="object"){const p=m.fileName?.trim()||m.path?.trim()||m.url||"";if(m.url){const g=C(p||l("customerDetails.document.defaultName","المستند المرتبط")),D=Le(m.url),b=C(l("customerDetails.document.open","عرض المستند"));f=`<div class="flex flex-wrap items-center gap-3"><span class="text-base-content break-all">${g}</span><a class="btn btn-outline btn-sm" href="${D}" target="_blank" rel="noopener noreferrer">${b}</a></div>`}else p&&(f=`<span class="text-base-content break-all">${C(p)}</span>`)}return`
        <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${s.key}">${C(a)}</span>
          <div class="mt-2">${f}</div>
        </article>
      `}const o=(s.value==null?"":String(s.value)).trim(),r=o.length>0?o:"—",y=s.multiline?je(r):C(r);return`
      <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
        <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${s.key}">${C(a)}</span>
        <p class="mt-2 text-lg font-semibold text-base-content">${y}</p>
      </article>
    `}).join("");w.innerHTML=e,F()}function qe(){document.getElementById("edit-id").value=d?.id||"",document.getElementById("edit-name").value=d?.customerName||"",document.getElementById("edit-phone").value=T(d?.phone||""),document.getElementById("edit-company").value=d?.companyName||"",document.getElementById("edit-email").value=d?.email||"",document.getElementById("edit-address").value=d?.address||"",document.getElementById("edit-tax-id").value=T(d?.tax_id??d?.taxId??"");const t=d?.document??null;document.getElementById("edit-document-url").value=t?.url||"",document.getElementById("edit-document-name").value=t?.fileName||"",document.getElementById("edit-notes").value=d?.notes||""}const at=document.getElementById("save-edit-btn");at&&!at.dataset.listenerAttached&&(at.addEventListener("click",()=>{if(!d)return;const t=document.getElementById("edit-id").value,e=document.getElementById("edit-name").value.trim(),s=T(document.getElementById("edit-phone").value.trim()),a=document.getElementById("edit-company").value.trim(),i=document.getElementById("edit-email").value.trim(),o=document.getElementById("edit-address").value.trim(),r=T(document.getElementById("edit-tax-id").value.trim()),y=document.getElementById("edit-document-url").value.trim(),m=document.getElementById("edit-document-name").value.trim(),f=document.getElementById("edit-notes").value.trim();if(!e||!s){B(l("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const p=$(),g=Array.isArray(p.customers)?p.customers:[],D=g.findIndex(x=>String(x.id)===String(t));if(D===-1){B(l("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}const b=g[D]?.document??null;let u=b;y?u={...b||{},url:y,fileName:m||b?.fileName||""}:m&&b?u={...b,fileName:m}:!y&&!m&&(u=b),g[D]={...g[D],customerName:e,phone:s,companyName:a,email:i,address:o,notes:f,tax_id:r,taxId:r,document:u},U({customers:g}),d=g[D],_(),ot(A),W(A),F(),document.dispatchEvent(new CustomEvent("customers:changed")),B(l("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل")),bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"))?.hide()}),at.dataset.listenerAttached="true");async function Ve(){if(w){if(!A){pt(null),ft(!0),F(),w.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${l("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`;return}d=Pe(A),d&&(_(),ot(A),W(A),F()),await we(A,{showSpinner:!d})}}Ve();const Mt=()=>{!A||!d||F()};document.addEventListener("reservations:changed",Mt);document.addEventListener("projects:changed",Mt);document.addEventListener("language:changed",()=>{_(),A&&d&&(ot(A),W(A),F())});
