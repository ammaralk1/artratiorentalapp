const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdfPages.BkH8Cw8A.js","./calculations.C9MgTfkQ.js","./reservationsService.DfT39y4i.js","./auth.Bd_qICJc.js","./auth.Cm9rYN26.css","./controller._PjU6y9p.js","./dashboard.BX73jsLV.js","./dashboardShell.qxgU1gzO.js","./customers.7L69s2EO.js","./index.Bvya4DNV.css","./maintenanceService.D0gXu_l1.js","./a4Unified.CgSYN-Ie.js","./preview.t3Llm4YJ.js"])))=>i.map(i=>d[i]);
import{_ as O}from"./dashboard.BX73jsLV.js";import{r as t,g as ce,h as xe,t as i,d as S,b as k,a as D,c as re,f as Se,p as le,e as de,i as ke,j as we,k as Ee,l as Ce,m as $e,n as Le,o as Ae,q as Re,s as Te,u as Me,v as Pe,w as De,x as Ie,y as Be,z as Ne,A as _e,B as je,C as ee}from"./calculations.C9MgTfkQ.js";import{l as He,a as H,b as Fe,n as W,g as qe}from"./auth.Bd_qICJc.js";import{z as ze,v as ue,w as Oe}from"./reservationsService.DfT39y4i.js";import{mapMaintenanceFromApi as pe}from"./maintenanceService.D0gXu_l1.js";import"./controller._PjU6y9p.js";function me(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function he(e={}){const r=String(e?.barcode??"").trim(),a=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:r,desc:a,description:a,name:e?.name??a,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function fe(e={}){const r=e?.title??e?.name??"",a=e?.project_code??e?.projectCode??"",n=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:r,code:a,status:n,confirmed:s}}function Ue(){let e;try{e=He()}catch(f){return console.warn("âš ï¸ [reports] Failed to access cached data",f),!1}if(!e||typeof e!="object")return!1;const{reservations:r=[],customers:a=[],equipment:n=[],technicians:s=[],projects:o=[],maintenance:c=[]}=e;if(!(r.length||a.length||n.length||s.length||o.length))return!1;t.data.reservations=Array.isArray(r)?r.map(ze):[],t.data.customers=Array.isArray(a)?a.map(me):[],t.data.equipment=Array.isArray(n)?n.map(he):[],t.data.technicians=Array.isArray(s)?s.map(ue):[],t.data.projects=Array.isArray(o)?o.map(fe):[],t.data.projectsMap=new Map(t.data.projects.map(f=>[f.id,f])),t.data.maintenance=Array.isArray(c)?c.map(pe):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(f=>[String(f.id),f]));try{ce()}catch{}return!0}async function U({silent:e=!1}={}){if(!t.loading){t.loading=!0,t.errorMessage="",e||t.callbacks.onBeforeRender?.();try{const{startDate:r,endDate:a}=xe(t.filters||{}),n=h=>{if(!h)return null;const x=h.getFullYear(),w=String(h.getMonth()+1).padStart(2,"0"),g=String(h.getDate()).padStart(2,"0");return`${x}-${w}-${g}`},s=n(r),o=n(a),c=200;let l=0,f=[];const y=50;for(let h=0;h<y;h+=1){const x=new URLSearchParams;x.set("limit",String(c)),x.set("offset",String(l)),s&&x.set("start_date",s),o&&x.set("end_date",o);const w=t.filters||{};w?.status&&w.status!=="all"&&x.set("status",String(w.status)),w?.search&&x.set("search",String(w.search));const g=await H(`/reservations/?${x.toString()}`),C=Array.isArray(g?.data)?g.data:[];if(f=f.concat(C),C.length<c)break;l+=c}const[p,b,d,m,E]=await Promise.all([H("/customers/?limit=500"),H("/equipment/?limit=500"),H("/technicians/?limit=500"),H("/projects/?limit=500"),H("/maintenance/?limit=500")]);t.data.reservations=Array.isArray(f)?f.map(h=>Oe(h)):[],t.data.customers=Array.isArray(p?.data)?p.data.map(me):[],t.data.equipment=Array.isArray(b?.data)?b.data.map(he):[],t.data.technicians=Array.isArray(d?.data)?d.data.map(ue):[],t.data.projects=Array.isArray(m?.data)?m.data.map(fe):[],t.data.projectsMap=new Map(t.data.projects.map(h=>[h.id,h])),t.data.maintenance=Array.isArray(E?.data)?E.data.map(pe):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(h=>[String(h.id),h]));try{ce()}catch{}}catch(r){console.error("âŒ [reports] Failed to load reports data",r),t.errorMessage=r instanceof Fe?r.message:i("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!t.data.projectsMap||!(t.data.projectsMap instanceof Map))&&(t.data.projectsMap=new Map)}finally{t.loading=!1,e||t.callbacks.onAfterRender?.()}}}function J(e){if(t.loadedScripts.has(e))return t.loadedScripts.get(e);const r=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,a=new Promise((n,s)=>{const o=()=>{r&&(r.dataset.loaded="true"),n()},c=f=>s(f);if(r){if(r.dataset.loaded==="true"){n();return}r.addEventListener("load",o,{once:!0}),r.addEventListener("error",c,{once:!0});return}const l=document.createElement("script");l.src=e,l.async=!0,l.onload=()=>{l.dataset.loaded="true",n()},l.onerror=f=>s(f),document.head.appendChild(l)});return t.loadedScripts.set(e,a),a}function K(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(t.apexChartsReady||(t.apexChartsReady=J("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),t.apexChartsReady)}function It(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(t.html2PdfReady||(t.html2PdfReady=J("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),t.html2PdfReady)}function Ve(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(t.xlsxReady||(t.xlsxReady=J("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),t.xlsxReady)}function Bt(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(t.jsZipReady||(t.jsZipReady=J("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),t.jsZipReady)}function _(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function B(e,r){const a=document.getElementById(e);if(a){if(!r||r.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}a.innerHTML=r.map(n=>{const s=Math.min(Math.max(n.percent??0,0),100),o=i("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",S(n.rawCount??n.value??0)),c=n.className?`reports-progress-fill ${n.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${n.label}</span>
            <span class="reports-progress-value">${S(n.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${c}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}function A(e,r){const a=document.querySelector(`[data-chart-loading="${e}"]`);a&&(a.style.display=r?"":"none")}async function We(e){const r=document.getElementById("reports-volume-chart");if(!r)return;const a=Array.isArray(e)?e:[];if(t.lastTrendData=a,A("volume",!0),!a.length){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("volume",!1);return}try{const n=await K();if(!n){r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("volume",!1);return}const s=a.map(g=>g.label),o=a.map(g=>Math.round(g.count||0)),c=a.map(g=>Number(g.revenue||0)),l=a.map(g=>Number(g.netProfit||0)),f=a.map(g=>g.movingAvgRevenue!=null?Number(g.movingAvgRevenue):null),y=o.reduce((g,C)=>g+(Number.isFinite(C)?C:0),0),p=c.reduce((g,C)=>g+(Number.isFinite(C)?C:0),0),b=l.reduce((g,C)=>g+(Number.isFinite(C)?C:0),0);if(y===0&&p===0&&b===0){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const d=[{name:i("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:o},{name:i("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:c,yAxisIndex:1},{name:i("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:l,yAxisIndex:1},{name:i("reservations.reports.chart.volume.series.movingAvg","Ù…ØªÙˆØ³Ø· Ù…ØªØ­Ø±Ùƒ (Ù£ Ø£Ø´Ù‡Ø±)","3-mo Moving Avg"),type:"line",data:f,yAxisIndex:1}],m={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(g,C,P)=>{if(P?.dataPointIndex!=null){const T=t.lastTrendData[P.dataPointIndex];t.callbacks.onTrendDrilldown?.(T,P.dataPointIndex)}}}},theme:{mode:_()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,4,4,0]},colors:["#6366f1","#22c55e","#f97316","#0ea5e9"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},stroke:{curve:"smooth",width:[0,2,2,2],dashArray:[0,0,0,6]},xaxis:{categories:s,labels:{style:{colors:_()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:i("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:g=>S(g)},title:{text:i("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:i("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:g=>k(g)},title:{text:i("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,custom:({series:g,dataPointIndex:C,w:P})=>{const T=t.lastTrendData?.[C]||{},X=s?.[C]||"",N=[],G=g?.[0]?.[C];G!=null&&N.push(`<div><span>ğŸ“¦</span> ${S(G)}</div>`);const R=g?.[1]?.[C];if(R!=null){const Q=Number.isFinite(T.yoyChange)?`${T.yoyChange>=0?"+":""}${S(Math.round(T.yoyChange))}% YoY`:"",be=Number.isFinite(T.momChange)?`${T.momChange>=0?"+":""}${S(Math.round(T.momChange))}% MoM`:"",se=[Q,be].filter(Boolean).join(" Â· ");N.push(`<div><span>ğŸ’°</span> ${k(R)}${se?` <small class="text-base-content/60">(${se})</small>`:""}</div>`)}const j=g?.[2]?.[C];j!=null&&N.push(`<div><span>ğŸ§®</span> ${k(j)}</div>`);const Y=g?.[3]?.[C];return Y!=null&&N.push(`<div><span>ğŸ“ˆ</span> ${k(Y)}</div>`),`
            <div class="apex-tooltip">
              <div class="mb-1 font-semibold">${X}</div>
              ${N.join("")}
            </div>
          `}}},E=_(),h=String(s.join("|")),x=t.chartsMeta.trend,w=t.charts.trend&&x.theme===E&&x.categoriesSig===h;t.charts.trend&&w?t.charts.trend.updateSeries(d,!0):t.charts.trend?(t.charts.trend.updateOptions({...m},!0,!0),t.charts.trend.updateSeries(d,!0)):(r.innerHTML="",t.charts.trend=new n(r,{...m,series:d}),t.charts.trend.render()),t.chartsMeta.trend={categoriesSig:h,theme:E},A("volume",!1)}catch(n){console.error("âš ï¸ [reports] Failed to render trend chart",n),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("volume",!1)}}async function Xe(e){const r=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!r)return;const n=Array.isArray(e)?e:[];t.lastStatusData=n,A("status",!0);const s=n.map(c=>Math.max(0,c.value||0)),o=s.reduce((c,l)=>c+l,0);if(!n.length||o===0){t.charts.status&&(t.charts.status.destroy(),t.charts.status=null),B(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("status",!1);return}try{const c=await K();if(!c){B(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("status",!1);return}const l=n.map(m=>m.label),f={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(m,E,h)=>{if(h?.dataPointIndex!=null){const x=t.lastStatusData[h.dataPointIndex];x?.filterKey&&t.callbacks.onStatusDrilldown?.(x,h.dataPointIndex)}}}},theme:{mode:_()},labels:l,series:s,colors:["#22c55e","#f97316","#6366f1","#ef4444"],legend:{position:"bottom"},dataLabels:{formatter:m=>`${Math.round(m)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:i("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>S(s.reduce((m,E)=>m+E,0))}}}}},tooltip:{y:{formatter:(m,E)=>{const h=t.lastStatusData?.[E?.seriesIndex||0],x=h?`${S(h.percent)}%`:`${S(m)}%`;return`${h?S(h.rawCount??h.value??0):S(m)} / ${x}`}}}},y=_(),p=String(l.join("|")),b=t.chartsMeta.status,d=t.charts.status&&b.theme===y&&b.labelsSig===p;t.charts.status&&d?t.charts.status.updateSeries(s,!0):t.charts.status?(t.charts.status.updateOptions({...f},!0,!0),t.charts.status.updateSeries(s,!0)):(r.innerHTML="",t.charts.status=new c(r,{...f,series:s}),t.charts.status.render()),B(a,n),t.chartsMeta.status={labelsSig:p,theme:y},A("status",!1)}catch(c){console.error("âš ï¸ [reports] Failed to render status chart",c),B(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("status",!1)}}async function Ge(e){const r=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!r)return;const n=Array.isArray(e)?e:[];t.lastPaymentData=n,A("payment",!0);const s=n.map(c=>Math.max(0,c.value||0)),o=s.reduce((c,l)=>c+l,0);if(!n.length||o===0){t.charts.payment&&(t.charts.payment.destroy(),t.charts.payment=null),B(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("payment",!1);return}try{const c=await K();if(!c){B(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("payment",!1);return}const l=n.map(m=>m.label),f={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(m,E,h)=>{if(h?.dataPointIndex!=null){const x=t.lastPaymentData[h.dataPointIndex];x?.filterKey&&t.callbacks.onPaymentDrilldown?.(x,h.dataPointIndex)}}}},theme:{mode:_()},labels:l,series:s,colors:["#00ac69","#f59e0b","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:m=>`${Math.round(m)}%`},tooltip:{y:{formatter:(m,E)=>{const h=t.lastPaymentData?.[E?.seriesIndex||0],x=h?`${S(h.percent)}%`:`${S(m)}%`;return`${h?S(h.rawCount??h.value??0):S(m)} / ${x}`}}}},y=_(),p=String(l.join("|")),b=t.chartsMeta.payment,d=t.charts.payment&&b.theme===y&&b.labelsSig===p;t.charts.payment&&d?t.charts.payment.updateSeries(s,!0):t.charts.payment?(t.charts.payment.updateOptions({...f},!0,!0),t.charts.payment.updateSeries(s,!0)):(r.innerHTML="",t.charts.payment=new c(r,{...f,series:s}),t.charts.payment.render()),B(a,n),t.chartsMeta.payment={labelsSig:p,theme:y},A("payment",!1)}catch(c){console.error("âš ï¸ [reports] Failed to render payment chart",c),B(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,A("payment",!1)}}async function Ye(e){const r=document.getElementById("reports-status-stacked-chart");if(!r)return;const a=Array.isArray(e)?e:[];if(!a.length){r.innerHTML=`<p class="text-base-content/60 text-sm">${i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const n=await K(),s=a.map(p=>p.label),o=a.map(p=>p.confirmed||0),c=a.map(p=>p.cancelled||0),l=[{name:i("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),data:o},{name:i("reservations.reports.status.cancelledLabel","Ù…Ù„ØºØ§Ø©","Cancelled"),data:c}],f={chart:{type:"bar",height:320,stacked:!0,toolbar:{show:!1}},series:l,xaxis:{categories:s},plotOptions:{bar:{columnWidth:"55%",borderRadius:6}},colors:["#22c55e","#ef4444"],dataLabels:{enabled:!1},legend:{position:"bottom"}};r.innerHTML="",new n(r,f).render()}catch(n){console.error("[reports] failed to render stacked status chart",n)}}function Ze(e){const r=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),n=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),c=document.getElementById("reports-kpi-confirmed"),l=document.getElementById("reports-kpi-confirmed-meta"),f=document.getElementById("reports-kpi-paid"),y=document.getElementById("reports-kpi-paid-meta"),p=e.total||0,b=e.cancelled||0,d=e.activeTotal!=null?e.activeTotal:Math.max(0,p-b),m=e.revenue||0,E=e.confirmed||0,h=e.paidCount||0,x=e.average||0,w=e.companyShareTotal||0,g=e.taxTotal||0,C=e.crewTotal||0,P=e.crewCostTotal||0,T=e.netProfit||0,X=e.maintenanceExpense||0,N=p?Math.round(E/p*100):0,G=d?Math.round(h/d*100):0;if(r&&(r.textContent=S(p)),a){const R=i("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",S(e.completed||0)),j=b>0?" "+i("reservations.reports.kpi.total.cancelledPart","â€¢ {count} Ù…Ù„ØºØ§Ø©","â€¢ {count} cancelled").replace("{count}",S(b)):"";a.textContent=R+j}if(n&&(n.textContent=k(m)),s)if(p===0)s.textContent=i("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const R=i("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");s.textContent=R.replace("{net}",k(T)).replace("{share}",k(w)).replace("{average}",k(x))}if(o)if(m>0){const R=[{label:i("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:k(m),hint:i("reservations.reports.kpi.revenue.details.grossHint","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)","Total bookings value (before discounts)")},{label:i("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:k(w),hint:i("reservations.reports.kpi.revenue.details.shareHint","ØªÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…ØŒ ÙˆØªÙØ¶Ø§Ù Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Applied after discount and added to total")},{label:i("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:k(g),hint:i("reservations.reports.kpi.revenue.details.taxHint","Ø¶Ø±ÙŠØ¨Ø© 15% Ø¹Ù„Ù‰ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… + Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©)","15% VAT on (after-discount total + company share)")},{label:i("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:k(C),hint:i("reservations.reports.kpi.revenue.details.crewGrossHint","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ø§Ù‚Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„","Crew price billed to client")},{label:i("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:k(P),hint:i("reservations.reports.kpi.revenue.details.crewHint","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©","Crew cost to company")}];X>0&&R.push({label:i("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${k(X)}`}),R.push({label:i("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:k(T)}),o.innerHTML=R.map(({label:j,value:Y,hint:Q})=>`
          <div class="reports-kpi-detail-row" title="${Q||""}">
            <span class="reports-kpi-detail-label">${j}</span>
            <span class="reports-kpi-detail-value">${Y}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(c&&(c.textContent=`${N}%`),l){const R=i("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",S(E));l.textContent=R}if(f&&(f.textContent=`${G}%`),y){const R=i("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",S(h));y.textContent=R}}function L(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function z(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Je(e,r,a){const n=document.getElementById("reports-reservations-body");if(!n)return[];if(!e||e.length===0)return n.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const s=new Map((r||[]).map(d=>[String(d.id),d]));new Map((a||[]).map(d=>[String(d.id),d]));const o={code:i("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:i("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),company:i("reservations.reports.results.headers.company","Ø§Ù„Ø´Ø±ÙƒØ©","Company"),phone:i("reservations.reports.results.headers.phone","Ø§Ù„Ù‡Ø§ØªÙ","Phone"),date:i("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:i("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:i("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),paymentsCount:i("reservations.reports.results.headers.paymentsCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª","Payments count"),days:i("reservations.reports.results.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…","Days"),equipment:i("reservations.reports.results.headers.equipment","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª","Equipment"),crewGross:i("reservations.reports.results.headers.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),crewCost:i("reservations.reports.results.headers.crewCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),discount:i("reservations.reports.results.headers.discount","Ø§Ù„Ø®ØµÙ…","Discount"),tax:i("reservations.reports.results.headers.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),total:i("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:i("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),sharePercent:i("reservations.reports.results.headers.sharePercent","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© %","Company share %"),shareAmount:i("reservations.reports.results.headers.shareAmount","Ù…Ø¨Ù„Øº Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share amount"),net:i("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},c=Qe([...e]),{page:l,pageSize:f}=t.pagination,y=Math.max(0,(l-1)*f),b=c.slice(y,y+f).map(d=>{const m=rt(d,s),E=s.get(String(d?.customerId)),x=(Array.isArray(d.paymentHistory)?d.paymentHistory:Array.isArray(d.payment_history)?d.payment_history:[]).length,w=D(d),g={[o.code]:m.code.text,[o.customer]:m.customer.text,[o.company]:E?.companyName||"",[o.phone]:E?.phone||"",[o.date]:m.date.text,[o.status]:m.status.text,[o.payment]:m.payment.text,[o.paymentsCount]:String(x),[o.days]:String(w.rentalDays??0),[o.equipment]:k(w.equipmentTotal),[o.crewGross]:k(w.crewTotal),[o.crewCost]:k(w.crewCostTotal??0),[o.discount]:k(w.discountAmount??0),[o.tax]:k(w.taxAmount??0),[o.total]:m.total.text,[o.share]:m.share.text,[o.sharePercent]:`${S(w.companySharePercent??0)}%`,[o.shareAmount]:k(w.companyShareAmount??0),[o.net]:m.net.text};return{formatted:m,exportRow:g}});return n.innerHTML=b.map(({formatted:d})=>`
      <tr data-drilldown="reservation" data-search="${z(d.code.text)}">
        <td data-report-column="code">${d.code.html}</td>
        <td data-report-column="customer">${d.customer.html}</td>
        <td data-report-column="date">${d.date.html}</td>
        <td data-report-column="status">${d.status.html}</td>
        <td data-report-column="payment">${d.payment.html}</td>
        <td data-report-column="total">${d.total.html}</td>
        <td data-report-column="share">${d.share.html}</td>
        <td data-report-column="net">${d.net.html}</td>
      </tr>
    `).join(""),tt(c.length),Ke(),b.map(({exportRow:d})=>d)}function Ke(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(r=>{r.dataset.sortBound!=="true"&&(r.addEventListener("click",()=>{const a=r.dataset.sortKey;a&&(t.sort.key===a?t.sort.dir=t.sort.dir==="asc"?"desc":"asc":(t.sort.key=a,t.sort.dir="asc"),t.pagination.page=1,t.callbacks.onRender?.())}),r.dataset.sortBound="true")})}function Qe(e){const{key:r,dir:a}=t.sort||{key:"date",dir:"desc"},n=a==="asc"?1:-1;return e.sort((s,o)=>n*et(s,o,r))}function et(e,r,a){switch(a){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(r?.reservationId??r?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(r?.customerName??r?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(r?.start||0);case"status":{const n=re(e)?.statusValue||"",s=re(r)?.statusValue||"";return String(n).localeCompare(String(s),"ar")}case"total":{const n=D(e)?.finalTotal||0,s=D(r)?.finalTotal||0;return n-s}case"share":{const n=D(e)?.companyShareAmount||0,s=D(r)?.companyShareAmount||0;return n-s}case"net":{const n=D(e)?.netProfit||0,s=D(r)?.netProfit||0;return n-s}default:return new Date(e?.start||0)-new Date(r?.start||0)}}function tt(e){const r=document.getElementById("reports-table-pagination");if(!r)return;const{page:a,pageSize:n}=t.pagination,s=Math.max(1,Math.ceil(e/n)),o=a<=1?"disabled":"",c=a>=s?"disabled":"",l=e===0?0:(a-1)*n+1,f=Math.min(a*n,e);if(e<=n){r.innerHTML=`<div class="page-info">${S(l)}â€“${S(f)} / ${S(e)}</div>`;return}r.innerHTML=`
    <div class="pager">
      <button type="button" ${o} data-page="prev">â—€</button>
      <button type="button" ${c} data-page="next">â–¶</button>
    </div>
    <div class="page-info">${S(l)}â€“${S(f)} / ${S(e)}</div>
    <div class="pager page-size">
      <label>${i("reservations.reports.pageSize","Ù„ÙƒÙ„ ØµÙØ­Ø©","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,r.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{t.pagination.page>1&&(t.pagination.page-=1,t.callbacks.onRender?.())}),r.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const y=Math.max(1,Math.ceil(e/t.pagination.pageSize));t.pagination.page<y&&(t.pagination.page+=1,t.callbacks.onRender?.())}),r.querySelectorAll("[data-size]")?.forEach(y=>{y.addEventListener("click",()=>{const p=Number(y.dataset.size);Number.isFinite(p)&&p>0&&(t.pagination.pageSize=p,t.pagination.page=1,t.callbacks.onRender?.())})})}function rt(e,r,a){const n=e?.reservationId||e?.id||"â€”",s=W(String(n)),c=r.get(String(e?.customerId))?.customerName||i("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),l=re(e),f=at(l.statusValue),y=nt(l.statusValue,f),p=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],b=st(l.paidStatus,p),d=p.length;let m=b.html;if(d>0){const P=i("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",S(d));m=`<div class="reports-payment-cell">${b.html}<small class="reports-payment-subtext">${L(P)}</small></div>`}const E=Se(e?.start),h=D(e),x=k(h.finalTotal),w=h.companySharePercent>0?`${S(h.companySharePercent)}% (${k(h.companyShareAmount)})`:i("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),g=k(h.netProfit),C=L(c);return{code:{html:L(s),text:s},customer:{html:C,text:c},date:{html:L(E),text:E},status:y,payment:{html:m,text:b.text},total:{html:L(x),text:x},share:{html:L(w),text:w},net:{html:L(g),text:g}}}function at(e){switch(e){case"completed":return V(i("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return V(i("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return V(i("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));case"cancelled":return V(i("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ","Cancelled"));default:return W(e||"â€”")}}function nt(e,r){const a=V(r);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending","cancelled"].includes(e)?e:"info"}">${L(a)}</span>`,text:a}}function st(e,r=[]){const a=le(e),n=String(e??"").toLowerCase(),s=n==="paid"?"paid":n==="partial"?"partial":"unpaid";let o="";const c=i("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(r)&&r.length&&(o=r.map(y=>{const p=y?.recordedAt?de(y.recordedAt):"â€”",b=Number.isFinite(Number(y?.amount))&&Number(y.amount)>0?`${W(Number(y.amount).toFixed(2))} ${c}`:"",d=Number.isFinite(Number(y?.percentage))&&Number(y.percentage)>0?`${W(Number(y.percentage).toFixed(2))}%`:"",m=[p];return b&&m.push(b),d&&m.push(d),m.filter(Boolean).join(" â€¢ ")}).join(`
`));const l=o?` title="${z(o)}"`:"";return{html:`<span class="reservation-chip status-${s}"${l}>${L(a)}</span>`,text:a}}function V(e){return W(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function ye(e){const r=de(new Date).replace(/-/g,"");return`${i("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${r}.${e}`}function ot(e,r,a){const n=new Blob([e],{type:a}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function ae(e){if(!e||!e.length)return;const r=Object.keys(e[0]),a=[r.join(",")];e.forEach(s=>{const o=r.map(c=>`"${String(s[c]??"").replace(/"/g,'""')}"`);a.push(o.join(","))});const n=`\uFEFF${a.join(`\r
`)}\r
`;ot(n,ye("csv"),"text/csv;charset=utf-8;")}async function it(e){try{const r=await Ve();if(!r){ae(e);return}const a=r.utils.json_to_sheet(e),n=r.utils.book_new(),s=i("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");r.utils.book_append_sheet(n,a,s),r.writeFile(n,ye("xlsx"))}catch(r){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",r),ae(e)}}async function ct(e=[],r={}){const{exportReportsPdf:a}=await O(async()=>{const{exportReportsPdf:s}=await import("./pdfPages.BkH8Cw8A.js");return{exportReportsPdf:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url),n=r?.action==="print"?"print":"save";await a(e,{action:n})}async function lt(e,r){switch(e){case"pdf":await ct(r);break;case"excel":await it(r);break;case"csv":default:ae(r);break}}function dt(e){const r=document.getElementById("reports-top-customers");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${z(a.name)}">
        <td>${L(a.name)}</td>
        <td>${S(a.count)}</td>
        <td>${k(a.revenue)}</td>
      </tr>
    `).join("")}}function ut(e){const r=document.getElementById("reports-top-equipment");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${z(a.name)}">
        <td>${L(a.name)}</td>
        <td>${S(a.count)}</td>
        <td>${k(a.revenue)}</td>
      </tr>
    `).join("")}}function pt(e){const r=document.getElementById("reports-crew-work");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="5" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="technician" data-search="${z(a.name)}">
        <td>${L(a.name)}</td>
        <td>${S(a.days)}</td>
        <td>${k(a.billable)}</td>
        <td>${k(a.cost)}</td>
        <td>${k(a.billable-a.cost)}</td>
      </tr>
    `).join("")}}function mt(e){const r=document.getElementById("reports-payment-forecast");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr>
        <td>${a.date}</td>
        <td>${i("reservations.reports.forecast.count","{count} Ø­Ø¬ÙˆØ²Ø§Øª","{count} reservations").replace("{count}",String(a.count||0))}</td>
        <td>${k(a.amount||0)}</td>
      </tr>
    `).join("")}}function ht(e){const r=document.getElementById("reports-top-outstanding");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${i("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="reservation" data-search="${z(a.code)}">
        <td>#${L(String(a.code))} â€” ${L(a.customer||"")}</td>
        <td>${L(le(a.paidStatus))}</td>
        <td>${k(a.outstanding)}</td>
      </tr>
    `).join("")}}const v=t.filters;function ft(e){if(t.columnControlsBound)return;const r=document.getElementById("reports-column-controls");r&&(r.querySelectorAll("input[data-column-toggle]").forEach(a=>{const n=a.dataset.columnToggle;n&&(a.checked=t.columnPreferences[n]!==!1,a.addEventListener("change",()=>{t.columnPreferences[n]=a.checked,e()}))}),t.columnControlsBound=!0,e())}function ge(){Object.entries(t.columnPreferences).forEach(([e,r])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(a=>{a.classList.toggle("hidden",!r)})})}function yt(e){if(t.exportHandlersBound)return;const r=document.querySelectorAll("[data-export]");r.length&&(r.forEach(a=>{a.addEventListener("click",async()=>{const{export:n=""}=a.dataset;if(n){a.disabled=!0;try{await e(n)}catch(s){console.error("âš ï¸ [reports] export failed",s)}finally{a.disabled=!1}}})}),t.exportHandlersBound=!0)}function gt(e,r){t.searchDebounceTimer&&(clearTimeout(t.searchDebounceTimer),t.searchDebounceTimer=null),t.searchDebounceTimer=setTimeout(()=>{v.search=e||"",r()},220)}function vt(e,r){e&&(v.range="custom",v.start=e.startInput||null,v.end=e.endInput||null,r())}function bt(e,r){e&&(v.status=v.status===e?"all":e,r())}function xt(e,r){e&&(v.payment=v.payment===e?"all":e,r())}function St(e,r){e&&(v.search=e,r())}function kt({onClear:e}={}){const r=document.getElementById("reservations-active-filters");if(!r)return;const a=[],n=(s,o,c)=>{a.push(`<span class="filter-chip" data-chip="${s}">${o} <button type="button" aria-label="clear" data-clear="${s}">âœ•</button></span>`)};if(v.range&&v.range!=="all"){let s="";switch(v.range){case"last30":s=i("reservations.reports.filters.range.last30","Ø¢Ø®Ø± 30 ÙŠÙˆÙ…","Last 30 days");break;case"thisWeek":s=i("reservations.reports.filters.range.thisWeek","Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","This week");break;case"thisMonth":s=i("reservations.reports.filters.range.thisMonth","Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±","This month");break;case"thisQuarter":s=i("reservations.reports.filters.range.thisQuarter","Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹","This quarter");break;case"thisYear":s=i("reservations.reports.filters.range.thisYear","Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…","This year");break;case"custom":s=`${i("reservations.reports.filters.range.custom","Ù…Ø®ØµØµ","Custom")} (${v.start||"â€”"} â†’ ${v.end||"â€”"})`;break;default:s=v.range}n("range",s)}if(v.status&&v.status!=="all"){const s=i(`reservations.reports.filters.status.${v.status}`,v.status,v.status);n("status",s)}if(v.payment&&v.payment!=="all"){const s=i(`reservations.reports.filters.payment.${v.payment}`,v.payment,v.payment);n("payment",s)}if(v.share&&v.share!=="all"){const s=i(`reservations.reports.filters.share.${v.share}`,v.share,v.share);n("share",s)}v.search&&v.search.trim().length&&n("search",`ğŸ” ${v.search.trim()}`),r.innerHTML=a.join(""),r.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.clear;o&&(o==="range"?(v.range="all",v.start=null,v.end=null):o in v&&(o==="search"?v.search="":v[o]="all"),e?.(o))})})}const u=t.filters;function oe(){ee(),$(),setTimeout(()=>{ee(),$(),Z()},0),setTimeout(()=>{ee(),$(),Z()},60),Z()}function q(){u.range==="custom"&&$()}function Z(e,r){if(!window.flatpickr)return;e&&(t.startDateInputRef=e),r&&(t.endDateInputRef=r);const a=t.startDateInputRef,n=t.endDateInputRef;if(!a&&!n)return;const s=wt(),o=c=>{const l={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...c};return s&&(l.locale=s),l};if(t.startDatePicker&&(t.startDatePicker.destroy(),t.startDatePicker=null),t.endDatePicker&&(t.endDatePicker.destroy(),t.endDatePicker=null),a&&(t.startDatePicker=window.flatpickr(a,o({onChange(c,l){u.start=l||null,t.endDatePicker&&(c?.length?t.endDatePicker.set("minDate",c[0]):t.endDatePicker.set("minDate",null)),q()},onValueUpdate(c,l){u.start=l||null,q()}}))),n&&(t.endDatePicker=window.flatpickr(n,o({onChange(c,l){u.end=l||null,t.startDatePicker&&(c?.length?t.startDatePicker.set("maxDate",c[0]):t.startDatePicker.set("maxDate",null)),q()},onValueUpdate(c,l){u.end=l||null,q()}}))),t.startDatePicker&&a){t.startDatePicker.setDate(a.value,!1);const c=t.endDatePicker?.selectedDates?.[0]||t.endDateInputRef?.value;c&&t.startDatePicker.set("maxDate",c)}if(t.endDatePicker&&n){t.endDatePicker.setDate(n.value,!1);const c=t.startDatePicker?.selectedDates?.[0]||t.startDateInputRef?.value;c&&t.endDatePicker.set("minDate",c)}}function wt(){return(qe()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function ne(e,r){e&&(e.classList.toggle("active",!!r),e.classList.toggle("hidden",!r))}function I(){const e=document.getElementById("reports-range"),r=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),o=document.getElementById("reports-start"),c=document.getElementById("reports-end"),l=document.getElementById("reports-custom-range");e&&e.value!==u.range&&(e.value=u.range),r&&r.value!==u.status&&(r.value=u.status),a&&a.value!==u.payment&&(a.value=u.payment),n&&n.value!==u.share&&(n.value=u.share),s&&s.value!==u.search&&(s.value=u.search||""),o&&o.value!==(u.start||"")&&(o.value=u.start||""),c&&c.value!==(u.end||"")&&(c.value=u.end||""),ne(l,u.range==="custom")}function Et(){try{const e=new URLSearchParams(window.location.search),r=n=>e.get(n),a=n=>n==null||n===""?null:n;u.range=r("range")||u.range,u.status=r("status")||u.status,u.payment=r("payment")||u.payment,u.share=r("share")||u.share,u.search=r("search")||"",u.start=a(r("start")),u.end=a(r("end")),u.range!=="custom"&&(u.start=null,u.end=null)}catch{}}let te=null;function M(){te&&clearTimeout(te),te=setTimeout(()=>{try{const e=new URLSearchParams,r=(s,o,c)=>{o!=null&&o!==""&&o!==c&&e.set(s,o)};r("range",u.range,"all"),r("status",u.status,"all"),r("payment",u.payment,"all"),r("share",u.share,"all"),r("search",u.search,""),u.range==="custom"&&(r("start",u.start,null),r("end",u.end,null));const a=e.toString(),n=a?`${location.pathname}?${a}`:location.pathname;window.history.replaceState({},"",n)}catch{}},120)}function ve({active:e,icon:r,title:a,subtitle:n}){const s=document.getElementById("reports-empty-state");if(!s)return;const o=s.querySelector(".reports-empty-icon"),c=s.querySelector("h4"),l=s.querySelector("p");t.emptyDefaults.icon===null&&o&&(t.emptyDefaults.icon=o.textContent),t.emptyDefaults.title===null&&c&&(t.emptyDefaults.title=c.textContent),t.emptyDefaults.subtitle===null&&l&&(t.emptyDefaults.subtitle=l.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!o||!c||!l)&&(e?(o.textContent=r!==void 0?r:t.emptyDefaults.icon??o.textContent,c.textContent=a!==void 0?a:t.emptyDefaults.title??c.textContent,l.textContent=n!==void 0?n:t.emptyDefaults.subtitle??l.textContent):(o.textContent=t.emptyDefaults.icon??o.textContent,c.textContent=t.emptyDefaults.title??c.textContent,l.textContent=t.emptyDefaults.subtitle??l.textContent))}function Ct(e){ve({active:!!e})}function ie(e){const r=document.getElementById("reports-kpi-skeleton"),a=document.getElementById("reservations-reports-kpis"),n=document.getElementById("reports-table-skeleton"),s=document.getElementById("reports-reservations-table"),o=document.getElementById("reservations-revenue-skeleton"),c=document.getElementById("reservations-revenue-breakdown");r&&a&&(r.style.display=e?"":"none",a.style.opacity=e?"0.4":"1"),n&&s&&(n.style.display=e?"":"none",s.style.opacity=e?"0.4":"1"),o&&c&&(o.style.display=e?"":"none",c.style.opacity=e?"0.4":"1")}function $t(){if(t.drilldownBound)return;const e=document.getElementById("reports-top-customers"),r=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),n=s=>{const o=s.target?.closest("[data-drilldown]");if(!o)return;const c=o.dataset.search||"";St(c,()=>{I(),$()})};e?.addEventListener("click",n),r?.addEventListener("click",n),a?.addEventListener("click",n),t.drilldownBound=!0}function F(){U({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function $(){if(I(),M(),kt({onClear:()=>{I(),M(),$()}}),t.loading){ie(!0);return}if(t.errorMessage){ve({active:!0,icon:"âš ï¸",title:t.errorMessage,subtitle:i("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}ie(!1);const{reservations:e,customers:r,equipment:a,technicians:n,maintenance:s}=t.data,o=ke(e,u,r,a,n),c=we(o),l=Ee(s,u),f=Ce(c,l.total),y=$e(o),p=Le(o),b=calculateMonthlyStatusStack(o),d=Ae(o),m=Re(o,r),E=Te(o,a),h=Me(o,n),x=calculatePaymentForecast(o),w=Pe(o,r,5);Ze(f),We(y),Xe(p),Ye(b),Ge(d),dt(m),ut(E),ht(w),pt(h);try{mt(x)}catch{}const g=Je(o,r,n);ge(),Ct(o.length===0),t.lastSnapshot.filtered=o,t.lastSnapshot.metrics=f,t.lastSnapshot.trend=y,t.lastSnapshot.statusBreakdown=p,t.lastSnapshot.paymentBreakdown=d,t.lastSnapshot.tableRows=g,t.lastSnapshot.maintenance=l,t.lastSnapshot.outstanding=w,t.lastSnapshot.crewWork=h,t.lastSnapshot.paymentForecast=x}function Lt(){if(t.initialized)return;t.initialized=!0;const e=document.getElementById("reports-range"),r=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),c=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;Et(),I(),Ue()&&$(),e.addEventListener("change",()=>{u.range=e.value,ne(c,u.range==="custom"),u.range!=="custom"&&(u.start=null,u.end=null),M(),$(),U({silent:!0}).catch(()=>{})}),r?.addEventListener("change",()=>{u.status=r.value,M(),$()}),a?.addEventListener("change",()=>{u.payment=a.value,M(),$()}),n?.addEventListener("change",()=>{u.share=n.value,M(),$()}),l?.addEventListener("input",()=>{const p=l.value||"";gt(p,()=>{I(),M(),$()})}),s?.addEventListener("change",()=>{u.start=s.value||null,M(),q(),u.range==="custom"&&U({silent:!0}).catch(()=>{})}),o?.addEventListener("change",()=>{u.end=o.value||null,M(),q(),u.range==="custom"&&U({silent:!0}).catch(()=>{})}),Z(s,o),ne(c,u.range==="custom"),t.languageListenerAttached||(document.addEventListener("language:changed",oe),document.addEventListener("language:translationsReady",oe),t.languageListenerAttached=!0),t.dataListenersAttached||(document.addEventListener("reservations:changed",F),document.addEventListener("customers:changed",F),document.addEventListener("equipment:changed",F),document.addEventListener("projects:changed",F),document.addEventListener("technicians:updated",F),window.addEventListener("maintenance:updated",F),t.dataListenersAttached=!0),ft?.(ge),yt(async p=>{const b=t.lastSnapshot.tableRows||[];if(!b.length){console.warn("[reports] No reservation data to export");return}if(p==="pdf")try{const{exportA4ReportPdf:d}=await O(async()=>{const{exportA4ReportPdf:m}=await import("./a4Unified.CgSYN-Ie.js");return{exportA4ReportPdf:m}},__vite__mapDeps([11,1,2,3,4,6,5,7,8,9,10]),import.meta.url);await d(b,{action:"save",strict:!0});return}catch(d){console.warn("[reports] page-based PDF export failed, falling back to legacy",d)}else if(p==="excel")try{const{exportA4ReportExcel:d}=await O(async()=>{const{exportA4ReportExcel:m}=await import("./a4Unified.CgSYN-Ie.js");return{exportA4ReportExcel:m}},__vite__mapDeps([11,1,2,3,4,6,5,7,8,9,10]),import.meta.url);await d(b);return}catch(d){console.warn("[reports] A4-based Excel export failed, falling back to legacy",d)}else if(p==="csv")try{const{exportA4ReportCsv:d}=await O(async()=>{const{exportA4ReportCsv:m}=await import("./a4Unified.CgSYN-Ie.js");return{exportA4ReportCsv:m}},__vite__mapDeps([11,1,2,3,4,6,5,7,8,9,10]),import.meta.url);await d(b);return}catch(d){console.warn("[reports] A4-based CSV export failed, falling back to legacy",d)}await lt(p,b)});const y=document.getElementById("reports-preview-pdf");y&&!y.dataset.bound&&(y.addEventListener("click",async()=>{try{const p=await O(()=>import("./preview.t3Llm4YJ.js"),__vite__mapDeps([12,1,2,3,4,11,6,5,7,8,9,10]),import.meta.url),b=t.lastSnapshot.tableRows||[];p.openReportsPdfPreview(b)}catch(p){console.error("âš ï¸ [reports] Failed to open PDF preview",p)}}),y.dataset.bound="true"),$t(),t.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>$(),0)}),t.themeListenerAttached=!0),De($),Ie(()=>{$()}),Be(()=>{$()}),Ne(p=>{vt(p,()=>{I(),$()})}),_e(p=>{bt(p?.filterKey,()=>{I(),$()})}),je(p=>{xt(p?.filterKey,()=>{I(),$()})}),U().catch(p=>{console.error("âŒ [reports] Failed to initialise reports data",p)})}const Nt=Object.freeze(Object.defineProperty({__proto__:null,initReports:Lt,renderReports:$},Symbol.toStringTag,{value:"Module"}));export{Ve as a,Bt as b,It as e,J as l,Nt as r};
