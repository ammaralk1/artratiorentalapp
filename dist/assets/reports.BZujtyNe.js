import{r as a,a as J,t as c,f as v,b as k,d as X,e as fe,c as R,p as he,g as ee,h as ye,i as ge,j as ve,k as be,l as xe,m as ke,n as we,o as Se,q as Ee,s as Ce,u as Le,v as $e,w as De,x as Re,y as Ie,z as U}from"./calculations.NWA1WuZo.js";import{l as Te,a as T,b as Ae,n as P,g as Be}from"./auth.DeRd8Lwk.js";import{z as Pe,v as te,w as Me}from"./reservationsService.uHRkBvfi.js";import{mapMaintenanceFromApi as ae}from"./maintenanceService.C8F2r3-g.js";import{C as Ne,D as He,E as Fe,F as je}from"./controller.DxuTUCXb.js";function re(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ne(e={}){const t=String(e?.barcode??"").trim(),r=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:r,description:r,name:e?.name??r,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function se(e={}){const t=e?.title??e?.name??"",r=e?.project_code??e?.projectCode??"",n=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:r,status:n,confirmed:s}}function qe(){let e;try{e=Te()}catch(y){return console.warn("⚠️ [reports] Failed to access cached data",y),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:r=[],equipment:n=[],technicians:s=[],projects:o=[],maintenance:i=[]}=e;if(!(t.length||r.length||n.length||s.length||o.length))return!1;a.data.reservations=Array.isArray(t)?t.map(Pe):[],a.data.customers=Array.isArray(r)?r.map(re):[],a.data.equipment=Array.isArray(n)?n.map(ne):[],a.data.technicians=Array.isArray(s)?s.map(te):[],a.data.projects=Array.isArray(o)?o.map(se):[],a.data.projectsMap=new Map(a.data.projects.map(y=>[y.id,y])),a.data.maintenance=Array.isArray(i)?i.map(ae):[],a.techniciansIndex=new Map((a.data.technicians||[]).map(y=>[String(y.id),y]));try{J()}catch{}return!0}async function oe({silent:e=!1}={}){if(!a.loading){a.loading=!0,a.errorMessage="",e||a.callbacks.onBeforeRender?.();try{const[t,r,n,s,o,i]=await Promise.all([T("/reservations/?limit=500"),T("/customers/?limit=500"),T("/equipment/?limit=500"),T("/technicians/?limit=500"),T("/projects/?limit=500"),T("/maintenance/?limit=500")]);a.data.reservations=Array.isArray(t?.data)?t.data.map(l=>Me(l)):[],a.data.customers=Array.isArray(r?.data)?r.data.map(re):[],a.data.equipment=Array.isArray(n?.data)?n.data.map(ne):[],a.data.technicians=Array.isArray(s?.data)?s.data.map(te):[],a.data.projects=Array.isArray(o?.data)?o.data.map(se):[],a.data.projectsMap=new Map(a.data.projects.map(l=>[l.id,l])),a.data.maintenance=Array.isArray(i?.data)?i.data.map(ae):[],a.techniciansIndex=new Map((a.data.technicians||[]).map(l=>[String(l.id),l]));try{J()}catch{}}catch(t){console.error("❌ [reports] Failed to load reports data",t),a.errorMessage=t instanceof Ae?t.message:c("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),(!a.data.projectsMap||!(a.data.projectsMap instanceof Map))&&(a.data.projectsMap=new Map)}finally{a.loading=!1,e||a.callbacks.onAfterRender?.()}}}function V(e){if(a.loadedScripts.has(e))return a.loadedScripts.get(e);const t=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,r=new Promise((n,s)=>{const o=()=>{t&&(t.dataset.loaded="true"),n()},i=y=>s(y);if(t){if(t.dataset.loaded==="true"){n();return}t.addEventListener("load",o,{once:!0}),t.addEventListener("error",i,{once:!0});return}const l=document.createElement("script");l.src=e,l.async=!0,l.onload=()=>{l.dataset.loaded="true",n()},l.onerror=y=>s(y),document.head.appendChild(l)});return a.loadedScripts.set(e,r),r}function K(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(a.apexChartsReady||(a.apexChartsReady=V("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),a.apexChartsReady)}function ze(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(a.html2PdfReady||(a.html2PdfReady=V("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),a.html2PdfReady)}function _e(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(a.xlsxReady||(a.xlsxReady=V("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),a.xlsxReady)}function z(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function D(e,t){const r=document.getElementById(e);if(r){if(!t||t.length===0){r.innerHTML=`<div class="text-sm text-base-content/60">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}r.innerHTML=t.map(n=>{const s=Math.min(Math.max(n.percent??0,0),100),o=c("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",v(n.rawCount??n.value??0)),i=n.className?`reports-progress-fill ${n.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${n.label}</span>
            <span class="reports-progress-value">${v(n.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}function w(e,t){const r=document.querySelector(`[data-chart-loading="${e}"]`);r&&(r.style.display=t?"":"none")}async function Ue(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const r=Array.isArray(e)?e:[];if(a.lastTrendData=r,w("volume",!0),!r.length){a.charts.trend&&(a.charts.trend.destroy(),a.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("volume",!1);return}try{const n=await K();if(!n){t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("volume",!1);return}const s=r.map(f=>f.label),o=r.map(f=>Math.round(f.count||0)),i=r.map(f=>Number(f.revenue||0)),l=r.map(f=>Number(f.netProfit||0)),y=o.reduce((f,b)=>f+(Number.isFinite(b)?b:0),0),p=i.reduce((f,b)=>f+(Number.isFinite(b)?b:0),0),g=l.reduce((f,b)=>f+(Number.isFinite(b)?b:0),0);if(y===0&&p===0&&g===0){a.charts.trend&&(a.charts.trend.destroy(),a.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const u=[{name:c("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:o},{name:c("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:i},{name:c("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:l,yAxisIndex:1}],m={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(f,b,S)=>{if(S?.dataPointIndex!=null){const I=a.lastTrendData[S.dataPointIndex];a.callbacks.onTrendDrilldown?.(I,S.dataPointIndex)}}}},theme:{mode:z()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:s,labels:{style:{colors:z()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:c("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:f=>v(f)},title:{text:c("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:c("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:f=>k(f)},title:{text:c("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(f,{seriesIndex:b})=>b===0?v(f):k(f)}}};a.charts.trend?(a.charts.trend.updateOptions({...m},!0,!0),a.charts.trend.updateSeries(u,!0)):(t.innerHTML="",a.charts.trend=new n(t,{...m,series:u}),a.charts.trend.render()),w("volume",!1)}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("volume",!1)}}async function Oe(e){const t=document.getElementById("reports-status-chart"),r="reports-status-breakdown";if(!t)return;const n=Array.isArray(e)?e:[];a.lastStatusData=n,w("status",!0);const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,l)=>i+l,0);if(!n.length||o===0){a.charts.status&&(a.charts.status.destroy(),a.charts.status=null),D(r,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("status",!1);return}try{const i=await K();if(!i){D(r,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("status",!1);return}const l=n.map(p=>p.label),y={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,g,u)=>{if(u?.dataPointIndex!=null){const m=a.lastStatusData[u.dataPointIndex];m?.filterKey&&a.callbacks.onStatusDrilldown?.(m,u.dataPointIndex)}}}},theme:{mode:z()},labels:l,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:c("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>v(s.reduce((p,g)=>p+g,0))}}}}},tooltip:{y:{formatter:(p,g)=>{const u=a.lastStatusData?.[g?.seriesIndex||0],m=u?`${v(u.percent)}%`:`${v(p)}%`;return`${u?v(u.rawCount??u.value??0):v(p)} / ${m}`}}}};a.charts.status?(a.charts.status.updateOptions({...y},!0,!0),a.charts.status.updateSeries(s,!0)):(t.innerHTML="",a.charts.status=new i(t,{...y,series:s}),a.charts.status.render()),D(r,n),w("status",!1)}catch(i){console.error("⚠️ [reports] Failed to render status chart",i),D(r,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("status",!1)}}async function Xe(e){const t=document.getElementById("reports-payment-chart"),r="reports-payment-breakdown";if(!t)return;const n=Array.isArray(e)?e:[];a.lastPaymentData=n,w("payment",!0);const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,l)=>i+l,0);if(!n.length||o===0){a.charts.payment&&(a.charts.payment.destroy(),a.charts.payment=null),D(r,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("payment",!1);return}try{const i=await K();if(!i){D(r,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("payment",!1);return}const l=n.map(p=>p.label),y={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,g,u)=>{if(u?.dataPointIndex!=null){const m=a.lastPaymentData[u.dataPointIndex];m?.filterKey&&a.callbacks.onPaymentDrilldown?.(m,u.dataPointIndex)}}}},theme:{mode:z()},labels:l,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},tooltip:{y:{formatter:(p,g)=>{const u=a.lastPaymentData?.[g?.seriesIndex||0],m=u?`${v(u.percent)}%`:`${v(p)}%`;return`${u?v(u.rawCount??u.value??0):v(p)} / ${m}`}}}};a.charts.payment?(a.charts.payment.updateOptions({...y},!0,!0),a.charts.payment.updateSeries(s,!0)):(t.innerHTML="",a.charts.payment=new i(t,{...y,series:s}),a.charts.payment.render()),D(r,n),w("payment",!1)}catch(i){console.error("⚠️ [reports] Failed to render payment chart",i),D(r,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,w("payment",!1)}}function We(e){const t=document.getElementById("reports-kpi-total"),r=document.getElementById("reports-kpi-total-meta"),n=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),l=document.getElementById("reports-kpi-confirmed-meta"),y=document.getElementById("reports-kpi-paid"),p=document.getElementById("reports-kpi-paid-meta"),g=e.total||0,u=e.revenue||0,m=e.confirmed||0,f=e.paidCount||0,b=e.average||0,S=e.companyShareTotal||0,I=e.taxTotal||0,M=e.crewTotal||0,N=e.crewCostTotal||0,H=e.netProfit||0,F=e.maintenanceExpense||0,le=g?Math.round(m/g*100):0,de=g?Math.round(f/g*100):0;if(t&&(t.textContent=v(g)),r){const E=c("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",v(e.completed||0));r.textContent=E}if(n&&(n.textContent=k(u)),s)if(g===0)s.textContent=c("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.");else{const E=c("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");s.textContent=E.replace("{net}",k(H)).replace("{share}",k(S)).replace("{average}",k(b))}if(o)if(u>0){const E=[{label:c("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:k(u),hint:c("reservations.reports.kpi.revenue.details.grossHint","إجمالي قيمة الحجوزات (قبل الخصومات)","Total bookings value (before discounts)")},{label:c("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:k(S),hint:c("reservations.reports.kpi.revenue.details.shareHint","تُحسب بعد الخصم، وتُضاف للإجمالي","Applied after discount and added to total")},{label:c("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:k(I),hint:c("reservations.reports.kpi.revenue.details.taxHint","ضريبة 15% على (الإجمالي بعد الخصم + نسبة الشركة)","15% VAT on (after-discount total + company share)")},{label:c("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:k(M),hint:c("reservations.reports.kpi.revenue.details.crewGrossHint","قيمة الطاقم للعميل","Crew price billed to client")},{label:c("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:k(N),hint:c("reservations.reports.kpi.revenue.details.crewHint","تكلفة الطاقم على الشركة","Crew cost to company")}];F>0&&E.push({label:c("reservations.reports.kpi.revenue.details.maintenance","مصاريف الصيانة","Maintenance expenses"),value:`−${k(F)}`}),E.push({label:c("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:k(H)}),o.innerHTML=E.map(({label:ue,value:pe,hint:me})=>`
          <div class="reports-kpi-detail-row" title="${me||""}">
            <span class="reports-kpi-detail-label">${ue}</span>
            <span class="reports-kpi-detail-value">${pe}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(i&&(i.textContent=`${le}%`),l){const E=c("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",v(m));l.textContent=E}if(y&&(y.textContent=`${de}%`),p){const E=c("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",v(f));p.textContent=E}}function C(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ge(e,t,r){const n=document.getElementById("reports-reservations-body");if(!n)return[];if(!e||e.length===0)return n.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const s=new Map((t||[]).map(m=>[String(m.id),m]));new Map((r||[]).map(m=>[String(m.id),m]));const o={code:c("reservations.reports.results.headers.id","الحجز","Reservation"),customer:c("reservations.reports.results.headers.customer","العميل","Customer"),date:c("reservations.reports.results.headers.date","التاريخ","Date"),status:c("reservations.reports.results.headers.status","الحالة","Status"),payment:c("reservations.reports.results.headers.payment","الدفع","Payment"),total:c("reservations.reports.results.headers.total","الإجمالي","Total"),share:c("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:c("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=Ke([...e]),{page:l,pageSize:y}=a.pagination,p=Math.max(0,(l-1)*y),u=i.slice(p,p+y).map(m=>{const f=Ze(m,s),b={[o.code]:f.code.text,[o.customer]:f.customer.text,[o.date]:f.date.text,[o.status]:f.status.text,[o.payment]:f.payment.text,[o.total]:f.total.text,[o.share]:f.share.text,[o.net]:f.net.text};return{formatted:f,exportRow:b}});return n.innerHTML=u.map(({formatted:m})=>`
      <tr data-drilldown="reservation" data-search="${_(m.code.text)}">
        <td data-report-column="code">${m.code.html}</td>
        <td data-report-column="customer">${m.customer.html}</td>
        <td data-report-column="date">${m.date.html}</td>
        <td data-report-column="status">${m.status.html}</td>
        <td data-report-column="payment">${m.payment.html}</td>
        <td data-report-column="total">${m.total.html}</td>
        <td data-report-column="share">${m.share.html}</td>
        <td data-report-column="net">${m.net.html}</td>
      </tr>
    `).join(""),Qe(i.length),Ve(),u.map(({exportRow:m})=>m)}function Ve(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(t=>{t.dataset.sortBound!=="true"&&(t.addEventListener("click",()=>{const r=t.dataset.sortKey;r&&(a.sort.key===r?a.sort.dir=a.sort.dir==="asc"?"desc":"asc":(a.sort.key=r,a.sort.dir="asc"),a.pagination.page=1,a.callbacks.onRender?.())}),t.dataset.sortBound="true")})}function Ke(e){const{key:t,dir:r}=a.sort||{key:"date",dir:"desc"},n=r==="asc"?1:-1;return e.sort((s,o)=>n*Ye(s,o,t))}function Ye(e,t,r){switch(r){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(t?.reservationId??t?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(t?.customerName??t?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(t?.start||0);case"status":{const n=X(e)?.statusValue||"",s=X(t)?.statusValue||"";return String(n).localeCompare(String(s),"ar")}case"total":{const n=R(e)?.finalTotal||0,s=R(t)?.finalTotal||0;return n-s}case"share":{const n=R(e)?.companyShareAmount||0,s=R(t)?.companyShareAmount||0;return n-s}case"net":{const n=R(e)?.netProfit||0,s=R(t)?.netProfit||0;return n-s}default:return new Date(e?.start||0)-new Date(t?.start||0)}}function Qe(e){const t=document.getElementById("reports-table-pagination");if(!t)return;const{page:r,pageSize:n}=a.pagination,s=Math.max(1,Math.ceil(e/n)),o=r<=1?"disabled":"",i=r>=s?"disabled":"",l=e===0?0:(r-1)*n+1,y=Math.min(r*n,e);t.innerHTML=`
    <div class="pager">
      <button type="button" ${o} data-page="prev">◀</button>
      <button type="button" ${i} data-page="next">▶</button>
    </div>
    <div class="page-info">${v(l)}–${v(y)} / ${v(e)}</div>
    <div class="pager page-size">
      <label>${c("reservations.reports.pageSize","لكل صفحة","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,t.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{a.pagination.page>1&&(a.pagination.page-=1,a.callbacks.onRender?.())}),t.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const p=Math.max(1,Math.ceil(e/a.pagination.pageSize));a.pagination.page<p&&(a.pagination.page+=1,a.callbacks.onRender?.())}),t.querySelectorAll("[data-size]")?.forEach(p=>{p.addEventListener("click",()=>{const g=Number(p.dataset.size);Number.isFinite(g)&&g>0&&(a.pagination.pageSize=g,a.pagination.page=1,a.callbacks.onRender?.())})})}function Ze(e,t,r){const n=e?.reservationId||e?.id||"—",s=P(String(n)),i=t.get(String(e?.customerId))?.customerName||c("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),l=X(e),y=Je(l.statusValue),p=et(l.statusValue,y),g=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],u=tt(l.paidStatus,g),m=g.length;let f=u.html;if(m>0){const F=c("reservations.paymentHistory.countLabel","{count} دفعة","{count} payments").replace("{count}",v(m));f=`<div class="reports-payment-cell">${u.html}<small class="reports-payment-subtext">${C(F)}</small></div>`}const b=fe(e?.start),S=R(e),I=k(S.finalTotal),M=S.companySharePercent>0?`${v(S.companySharePercent)}% (${k(S.companyShareAmount)})`:c("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),N=k(S.netProfit),H=C(i);return{code:{html:C(s),text:s},customer:{html:H,text:i},date:{html:C(b),text:b},status:p,payment:{html:f,text:u.text},total:{html:C(I),text:I},share:{html:C(M),text:M},net:{html:C(N),text:N}}}function Je(e){switch(e){case"completed":return j(c("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return j(c("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return j(c("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return P(e||"—")}}function et(e,t){const r=j(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${C(r)}</span>`,text:r}}function tt(e,t=[]){const r=he(e),n=String(e??"").toLowerCase(),s=n==="paid"?"paid":n==="partial"?"partial":"unpaid";let o="";const i=c("reservations.create.summary.currency","ريال","SR");Array.isArray(t)&&t.length&&(o=t.map(p=>{const g=p?.recordedAt?ee(p.recordedAt):"—",u=Number.isFinite(Number(p?.amount))&&Number(p.amount)>0?`${P(Number(p.amount).toFixed(2))} ${i}`:"",m=Number.isFinite(Number(p?.percentage))&&Number(p.percentage)>0?`${P(Number(p.percentage).toFixed(2))}%`:"",f=[g];return u&&f.push(u),m&&f.push(m),f.filter(Boolean).join(" • ")}).join(`
`));const l=o?` title="${_(o)}"`:"";return{html:`<span class="reservation-chip status-${s}"${l}>${C(r)}</span>`,text:r}}function j(e){return P(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function Y(e){const t=ee(new Date).replace(/-/g,"");return`${c("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${t}.${e}`}function at(e,t,r){const n=new Blob([e],{type:r}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function W(e){if(!e||!e.length)return;const t=Object.keys(e[0]),r=[t.join(",")];e.forEach(s=>{const o=t.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);r.push(o.join(","))});const n=`\uFEFF${r.join(`\r
`)}\r
`;at(n,Y("csv"),"text/csv;charset=utf-8;")}async function rt(e){try{const t=await _e();if(!t){W(e);return}const r=t.utils.json_to_sheet(e),n=t.utils.book_new(),s=c("reservations.reports.export.sheetName","الحجوزات","Reservations");t.utils.book_append_sheet(n,r,s),t.writeFile(n,Y("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),W(e)}}async function nt(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await ze();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const r=Y("pdf");Ne();const n=[];He(e,window,n),Fe(e,window,n);try{await t().set({margin:10,filename:r,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(s){console.error("⚠️ [reports] export failed",s)}finally{je(n)}}async function st(e,t){switch(e){case"pdf":await nt();break;case"excel":await rt(t);break;case"csv":default:W(t);break}}function ot(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${_(r.name)}">
        <td>${C(r.name)}</td>
        <td>${v(r.count)}</td>
        <td>${k(r.revenue)}</td>
      </tr>
    `).join("")}}function it(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${_(r.name)}">
        <td>${C(r.name)}</td>
        <td>${v(r.count)}</td>
        <td>${k(r.revenue)}</td>
      </tr>
    `).join("")}}const h=a.filters;function ct(e){if(a.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(r=>{const n=r.dataset.columnToggle;n&&(r.checked=a.columnPreferences[n]!==!1,r.addEventListener("change",()=>{a.columnPreferences[n]=r.checked,e()}))}),a.columnControlsBound=!0,e())}function ie(){Object.entries(a.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(r=>{r.classList.toggle("hidden",!t)})})}function lt(e){if(a.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(r=>{r.addEventListener("click",async()=>{const{export:n=""}=r.dataset;if(n){r.disabled=!0;try{await e(n)}catch(s){console.error("⚠️ [reports] export failed",s)}finally{r.disabled=!1}}})}),a.exportHandlersBound=!0)}function dt(e,t){a.searchDebounceTimer&&(clearTimeout(a.searchDebounceTimer),a.searchDebounceTimer=null),a.searchDebounceTimer=setTimeout(()=>{h.search=e||"",t()},220)}function ut(e,t){e&&(h.range="custom",h.start=e.startInput||null,h.end=e.endInput||null,t())}function pt(e,t){e&&(h.status=h.status===e?"all":e,t())}function mt(e,t){e&&(h.payment=h.payment===e?"all":e,t())}function ft(e,t){e&&(h.search=e,t())}function ht({onClear:e}={}){const t=document.getElementById("reservations-active-filters");if(!t)return;const r=[],n=(s,o,i)=>{r.push(`<span class="filter-chip" data-chip="${s}">${o} <button type="button" aria-label="clear" data-clear="${s}">✕</button></span>`)};if(h.range&&h.range!=="all"){let s="";switch(h.range){case"last30":s=c("reservations.reports.filters.range.last30","آخر 30 يوم","Last 30 days");break;case"thisWeek":s=c("reservations.reports.filters.range.thisWeek","هذا الأسبوع","This week");break;case"thisMonth":s=c("reservations.reports.filters.range.thisMonth","هذا الشهر","This month");break;case"thisQuarter":s=c("reservations.reports.filters.range.thisQuarter","هذا الربع","This quarter");break;case"thisYear":s=c("reservations.reports.filters.range.thisYear","هذا العام","This year");break;case"custom":s=`${c("reservations.reports.filters.range.custom","مخصص","Custom")} (${h.start||"—"} → ${h.end||"—"})`;break;default:s=h.range}n("range",s)}if(h.status&&h.status!=="all"){const s=c(`reservations.reports.filters.status.${h.status}`,h.status,h.status);n("status",s)}if(h.payment&&h.payment!=="all"){const s=c(`reservations.reports.filters.payment.${h.payment}`,h.payment,h.payment);n("payment",s)}if(h.share&&h.share!=="all"){const s=c(`reservations.reports.filters.share.${h.share}`,h.share,h.share);n("share",s)}h.search&&h.search.trim().length&&n("search",`🔍 ${h.search.trim()}`),t.innerHTML=r.join(""),t.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.clear;o&&(o==="range"?(h.range="all",h.start=null,h.end=null):o in h&&(o==="search"?h.search="":h[o]="all"),e?.(o))})})}const d=a.filters;function Q(){U(),x(),setTimeout(()=>{U(),x(),q()},0),setTimeout(()=>{U(),x(),q()},60),q()}function B(){d.range==="custom"&&x()}function q(e,t){if(!window.flatpickr)return;e&&(a.startDateInputRef=e),t&&(a.endDateInputRef=t);const r=a.startDateInputRef,n=a.endDateInputRef;if(!r&&!n)return;const s=yt(),o=i=>{const l={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(l.locale=s),l};if(a.startDatePicker&&(a.startDatePicker.destroy(),a.startDatePicker=null),a.endDatePicker&&(a.endDatePicker.destroy(),a.endDatePicker=null),r&&(a.startDatePicker=window.flatpickr(r,o({onChange(i,l){d.start=l||null,a.endDatePicker&&(i?.length?a.endDatePicker.set("minDate",i[0]):a.endDatePicker.set("minDate",null)),B()},onValueUpdate(i,l){d.start=l||null,B()}}))),n&&(a.endDatePicker=window.flatpickr(n,o({onChange(i,l){d.end=l||null,a.startDatePicker&&(i?.length?a.startDatePicker.set("maxDate",i[0]):a.startDatePicker.set("maxDate",null)),B()},onValueUpdate(i,l){d.end=l||null,B()}}))),a.startDatePicker&&r){a.startDatePicker.setDate(r.value,!1);const i=a.endDatePicker?.selectedDates?.[0]||a.endDateInputRef?.value;i&&a.startDatePicker.set("maxDate",i)}if(a.endDatePicker&&n){a.endDatePicker.setDate(n.value,!1);const i=a.startDatePicker?.selectedDates?.[0]||a.startDateInputRef?.value;i&&a.endDatePicker.set("minDate",i)}}function yt(){return(Be()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function G(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function $(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),o=document.getElementById("reports-start"),i=document.getElementById("reports-end"),l=document.getElementById("reports-custom-range");e&&e.value!==d.range&&(e.value=d.range),t&&t.value!==d.status&&(t.value=d.status),r&&r.value!==d.payment&&(r.value=d.payment),n&&n.value!==d.share&&(n.value=d.share),s&&s.value!==d.search&&(s.value=d.search||""),o&&o.value!==(d.start||"")&&(o.value=d.start||""),i&&i.value!==(d.end||"")&&(i.value=d.end||""),G(l,d.range==="custom")}function gt(){try{const e=new URLSearchParams(window.location.search),t=n=>e.get(n),r=n=>n==null||n===""?null:n;d.range=t("range")||d.range,d.status=t("status")||d.status,d.payment=t("payment")||d.payment,d.share=t("share")||d.share,d.search=t("search")||"",d.start=r(t("start")),d.end=r(t("end")),d.range!=="custom"&&(d.start=null,d.end=null)}catch{}}let O=null;function L(){O&&clearTimeout(O),O=setTimeout(()=>{try{const e=new URLSearchParams,t=(s,o,i)=>{o!=null&&o!==""&&o!==i&&e.set(s,o)};t("range",d.range,"all"),t("status",d.status,"all"),t("payment",d.payment,"all"),t("share",d.share,"all"),t("search",d.search,""),d.range==="custom"&&(t("start",d.start,null),t("end",d.end,null));const r=e.toString(),n=r?`${location.pathname}?${r}`:location.pathname;window.history.replaceState({},"",n)}catch{}},120)}function ce({active:e,icon:t,title:r,subtitle:n}){const s=document.getElementById("reports-empty-state");if(!s)return;const o=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),l=s.querySelector("p");a.emptyDefaults.icon===null&&o&&(a.emptyDefaults.icon=o.textContent),a.emptyDefaults.title===null&&i&&(a.emptyDefaults.title=i.textContent),a.emptyDefaults.subtitle===null&&l&&(a.emptyDefaults.subtitle=l.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!o||!i||!l)&&(e?(o.textContent=t!==void 0?t:a.emptyDefaults.icon??o.textContent,i.textContent=r!==void 0?r:a.emptyDefaults.title??i.textContent,l.textContent=n!==void 0?n:a.emptyDefaults.subtitle??l.textContent):(o.textContent=a.emptyDefaults.icon??o.textContent,i.textContent=a.emptyDefaults.title??i.textContent,l.textContent=a.emptyDefaults.subtitle??l.textContent))}function vt(e){ce({active:!!e})}function Z(e){const t=document.getElementById("reports-kpi-skeleton"),r=document.getElementById("reservations-reports-kpis"),n=document.getElementById("reports-table-skeleton"),s=document.getElementById("reports-reservations-table"),o=document.getElementById("reservations-revenue-skeleton"),i=document.getElementById("reservations-revenue-breakdown");t&&r&&(t.style.display=e?"":"none",r.style.opacity=e?"0.4":"1"),n&&s&&(n.style.display=e?"":"none",s.style.opacity=e?"0.4":"1"),o&&i&&(o.style.display=e?"":"none",i.style.opacity=e?"0.4":"1")}function bt(){if(a.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),r=document.getElementById("reports-reservations-body"),n=s=>{const o=s.target?.closest("[data-drilldown]");if(!o)return;const i=o.dataset.search||"";ft(i,()=>{$(),x()})};e?.addEventListener("click",n),t?.addEventListener("click",n),r?.addEventListener("click",n),a.drilldownBound=!0}function A(){oe({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function x(){if($(),L(),ht({onClear:()=>{$(),L(),x()}}),a.loading){Z(!0);return}if(a.errorMessage){ce({active:!0,icon:"⚠️",title:a.errorMessage,subtitle:c("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}Z(!1);const{reservations:e,customers:t,equipment:r,technicians:n,maintenance:s}=a.data,o=ye(e,d,t,r,n),i=ge(o),l=ve(s,d),y=be(i,l.total),p=xe(o),g=ke(o),u=we(o),m=Se(o,t),f=Ee(o,r);We(y),Ue(p),Oe(g),Xe(u),ot(m),it(f);const b=Ge(o,t,n);ie(),vt(o.length===0),a.lastSnapshot.filtered=o,a.lastSnapshot.metrics=y,a.lastSnapshot.trend=p,a.lastSnapshot.statusBreakdown=g,a.lastSnapshot.paymentBreakdown=u,a.lastSnapshot.tableRows=b,a.lastSnapshot.maintenance=l}function Ct(){if(a.initialized)return;a.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),l=document.getElementById("reports-print"),y=document.getElementById("reports-custom-range"),p=document.getElementById("reports-search");if(!e)return;gt(),$(),qe()&&x(),e.addEventListener("change",()=>{d.range=e.value,G(y,d.range==="custom"),d.range!=="custom"&&(d.start=null,d.end=null),L(),x()}),t?.addEventListener("change",()=>{d.status=t.value,L(),x()}),r?.addEventListener("change",()=>{d.payment=r.value,L(),x()}),n?.addEventListener("change",()=>{d.share=n.value,L(),x()}),p?.addEventListener("input",()=>{const u=p.value||"";dt(u,()=>{$(),L(),x()})}),s?.addEventListener("change",()=>{d.start=s.value||null,L(),B()}),o?.addEventListener("change",()=>{d.end=o.value||null,L(),B()}),i?.addEventListener("click",()=>{d.range==="custom"&&(d.start=s?.value||null,d.end=o?.value||null),L(),x()}),l?.addEventListener("click",()=>{try{window.print()}catch{}}),q(s,o),G(y,d.range==="custom"),a.languageListenerAttached||(document.addEventListener("language:changed",Q),document.addEventListener("language:translationsReady",Q),a.languageListenerAttached=!0),a.dataListenersAttached||(document.addEventListener("reservations:changed",A),document.addEventListener("customers:changed",A),document.addEventListener("equipment:changed",A),document.addEventListener("projects:changed",A),document.addEventListener("technicians:updated",A),window.addEventListener("maintenance:updated",A),a.dataListenersAttached=!0),ct(ie),lt(async u=>{const m=a.lastSnapshot.tableRows||[];if(!m.length){console.warn("[reports] No reservation data to export");return}await st(u,m)}),bt(),a.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>x(),0)}),a.themeListenerAttached=!0),Ce(x),Le(()=>{x()}),$e(()=>{x()}),De(u=>{ut(u,()=>{$(),x()})}),Re(u=>{pt(u?.filterKey,()=>{$(),x()})}),Ie(u=>{mt(u?.filterKey,()=>{$(),x()})}),oe().catch(u=>{console.error("❌ [reports] Failed to initialise reports data",u)})}export{Ct as initReports,x as renderReports};
