import{t as m,r as z,f as nt,c as rt,p as at,a as st,b as I,d as G,e as it}from"./calculations.BlsvwTLx.js";import{e as ct}from"./reports.ByPAIYfB.js";import{s as lt,c as pt,d as dt,q as mt}from"./controller.-K6OuT9X.js";import{n as B}from"./auth.D09_E0J1.js";import"./reservationsService.DwVbVNH4.js";import"./dashboard.CRVrocLd.js";/* empty css              */import"./dashboardShell.BTjbDc9Z.js";import"./customers.Cpz8J_vg.js";import"./maintenanceService.DLPgwUA9.js";const U=96,X=25.4,J=210,ut=297,N=Math.round(J/X*U),A=Math.round(ut/X*U),j=U/X,ht=/safari/i,ft=/(iphone|ipad|ipod)/i,gt=/(crios|fxios|edgios|opios)/i;function Y(){try{const o=navigator.userAgent||"";return ft.test(o)&&ht.test(o)&&!gt.test(o)}catch{return!1}}function bt(){try{return Math.min(window.innerWidth,window.innerHeight)<=820}catch{return!1}}function yt(o="preview"){const t=document.createElement("div");t.id="quotation-pdf-root",t.setAttribute("dir",document.documentElement.getAttribute("dir")||"rtl"),t.setAttribute("data-quote-render-context",o);const n=document.createElement("style");n.textContent=String(mt).trim(),t.appendChild(n);const l=document.createElement("div");l.className="quote-preview-pages",l.setAttribute("data-quote-pages",""),t.appendChild(l);const e=document.createElement("style");return e.textContent=`
    .rpt-header { display:flex; flex-direction:column; gap:6px; }
    .rpt-header h1 { margin:0; font-weight:800; font-size:18px; text-align:right; }
    .rpt-subtitle { margin:0; font-size:12px; opacity:.8; text-align:right; }
    .rpt-kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin:8px 0 4px; }
    .rpt-kpi { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff; }
    .rpt-kpi .label { font-size:11px; opacity:.8; }
    .rpt-kpi .value { font-weight:700; font-size:14px; }
    .rpt-table { width:100%; border-collapse:collapse; font-size:12px; color:#000 !important; table-layout:fixed; }
    .rpt-table th { background:#f3f4f6 !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; font-weight:800; }
    .rpt-table td { background:#ffffff !important; color:#000 !important; border:1px solid #e5e7eb; padding:6px 8px; text-align:right; }
    .rpt-table th, .rpt-table td { vertical-align: middle !important; line-height: 1.6; }
    /* Generic lift for all table cells in export root even without wrapper */
    #quotation-pdf-root[data-quote-render-context="export"] table td > *:first-child { position: relative; top: var(--cell-text-nudge, -5px); }
    .rpt-table th > *, .rpt-table td > * { vertical-align: middle !important; }
    /* Use the same robust centering wrapper used by quotes, but right-justify for RTL numbers/text */
    .rpt-table .quote-cell { display:flex; align-items:center; justify-content:flex-end; width:100%; min-height:30px; text-align:right; line-height:1.3; position:relative; top: var(--cell-text-nudge, -5px); transform: none; }
    /* force light mode inside PDF root regardless of app theme */
    #quotation-pdf-root, #quotation-pdf-root * { color:#000 !important; background:#fff !important; box-shadow:none !important; filter:none !important; }
    #quotation-pdf-root { color-scheme: light; }
    /* تطابق كامل بين المعاينة والتصدير دون تغييرات خاصة بالتصدير */
  `,t.appendChild(e),t}function K(){try{const o=Number(localStorage.getItem("reportsPdf.shiftRightMm")),t=Number(localStorage.getItem("reportsPdf.shiftTopMm")),n=Number(localStorage.getItem("reportsPdf.scalePct"));return{rightMm:Number.isFinite(o)?o:6,topMm:Number.isFinite(t)?t:-10,scale:Number.isFinite(n)?Math.max(90,Math.min(100,n))/100:.985}}catch{return{rightMm:6,topMm:-10,scale:.985}}}function V({rightMm:o,topMm:t,scale:n}){try{localStorage.setItem("reportsPdf.shiftRightMm",String(o)),localStorage.setItem("reportsPdf.shiftTopMm",String(t)),localStorage.setItem("reportsPdf.scalePct",String(Math.round((n||1)*1e3)/10))}catch{}}function xt(o){try{const t=K(),n=document.createElement("div");n.setAttribute("data-rpt-controls",""),Object.assign(n.style,{position:"sticky",top:"6px",zIndex:"10",display:"inline-flex",gap:"6px",alignItems:"center",background:"rgba(15, 23, 42, 0.75)",color:"#fff",padding:"6px 10px",borderRadius:"10px",boxShadow:"0 2px 8px rgba(0,0,0,.35)"});const l="min-width:68px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#111;padding:0 6px;";n.innerHTML=`
      <span style="opacity:.9">محاذاة PDF</span>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">يمين(mm)</span>
        <input type="number" step="0.5" value="${t.rightMm}" data-rpt-right style="${l}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">أعلى(mm)</span>
        <input type="number" step="0.5" value="${t.topMm}" data-rpt-top style="${l}">
      </label>
      <label style="display:inline-flex;gap:4px;align-items:center;">
        <span style="opacity:.85">تقليص(%)</span>
        <input type="number" step="0.1" min="90" max="100" value="${Math.round(t.scale*1e3)/10}" data-rpt-scale style="${l}">
      </label>
      <button type="button" data-rpt-apply style="height:28px;border-radius:8px;background:#22c55e;color:#0b1e15;border:0;padding:0 10px;font-weight:700;">تطبيق</button>
      <button type="button" data-rpt-reset style="height:28px;border-radius:8px;background:#cbd5e1;color:#0b1e15;border:0;padding:0 10px;">إعادة ضبط</button>
    `;const e=o.querySelector("[data-quote-pages]");o.insertBefore(n,e);const w=()=>{const b=Number(n.querySelector("[data-rpt-right]").value),u=Number(n.querySelector("[data-rpt-top]").value),s=Number(n.querySelector("[data-rpt-scale]").value),f=Math.max(.9,Math.min(1,s/100));V({rightMm:b,topMm:u,scale:f});const p=b*j,r=u*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${p}px, ${r}px) scale(${f})`})};n.querySelector("[data-rpt-apply]").addEventListener("click",w),n.querySelector("[data-rpt-reset]").addEventListener("click",()=>{n.querySelector("[data-rpt-right]").value=0,n.querySelector("[data-rpt-top]").value=0,n.querySelector("[data-rpt-scale]").value=100,V({rightMm:0,topMm:0,scale:1});const b=o.querySelector("[data-quote-pages]");Object.assign(b.style,{transform:"none"})});const c=t.rightMm*j,a=t.topMm*j;Object.assign(e.style,{transformOrigin:"top left",transform:`translate(${c}px, ${a}px) scale(${t.scale})`})}catch{}}function wt({primary:o=!1}={}){const t=document.createElement("div");return t.className="quote-page",o&&t.classList.add("quote-page--primary"),t}function vt(o){const t=document.createElement("div");t.className="rpt-header";const n=document.createElement("h1");n.textContent=m("reservations.reports.print.title","تقرير الحجوزات","Reservations report");const l=document.createElement("p");l.className="rpt-subtitle",l.textContent=`${it(new Date)} • ${m("reservations.reports.print.generated","تاريخ التوليد","Generated on")}`,t.appendChild(n),t.appendChild(l);const e=document.createElement("div");e.className="rpt-kpis";const w=(c,a)=>{const b=document.createElement("div");return b.className="rpt-kpi",b.innerHTML=`<div class="label">${c}</div><div class="value">${a}</div>`,b};return e.appendChild(w(m("reservations.reports.kpi.total.label","الحجوزات","Reservations"),G(o.total||0))),e.appendChild(w(m("reservations.reports.kpi.revenue.label","الإيرادات","Revenue"),I(o.revenue||0))),e.appendChild(w(m("reservations.reports.kpi.net.label","صافي الربح","Net profit"),I(o.netProfit||0))),e.appendChild(w(m("reservations.reports.kpi.share.label","نسبة الشركة","Company share"),I(o.companyShareTotal||0))),e.appendChild(w(m("reservations.reports.kpi.tax.label","الضريبة","Tax"),I(o.taxTotal||0))),e.appendChild(w(m("reservations.reports.kpi.maintenance.label","مصاريف الصيانة","Maintenance"),I(o.maintenanceExpense||0))),t.appendChild(e),t}function Ct(){try{const o=z?.data||{},t=z?.lastSnapshot?.filtered||o.reservations||[],n=new Map((o.customers||[]).map(a=>[String(a.id),a])),l=[...t].sort((a,b)=>new Date(b?.start||0)-new Date(a?.start||0)),e={code:m("reservations.reports.results.headers.id","الحجز","Reservation"),customer:m("reservations.reports.results.headers.customer","العميل","Customer"),date:m("reservations.reports.results.headers.date","التاريخ","Date"),status:m("reservations.reports.results.headers.status","الحالة","Status"),payment:m("reservations.reports.results.headers.payment","الدفع","Payment"),total:m("reservations.reports.results.headers.total","الإجمالي","Total"),share:m("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:m("reservations.reports.results.headers.net","صافي الربح","Net profit")},w=[e.code,e.customer,e.date,e.status,e.payment,e.total,e.share,e.net],c=l.map(a=>{const b=a?.reservationId||a?.id||"—",u=B(String(b)),f=n.get(String(a?.customerId))?.customerName||m("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),p=nt(a?.start),r=rt(a),S=(()=>{switch(r.statusValue){case"completed":return String(m("reservations.list.status.completed","منتهي","Completed")).replace(/^\W+/,"");case"confirmed":return String(m("reservations.list.status.confirmed","مؤكد","Confirmed")).replace(/^\W+/,"");case"pending":return String(m("reservations.list.status.pending","غير مؤكد","Pending")).replace(/^\W+/,"");default:return B(String(r.statusValue||"—"))}})(),k=at(r.paidStatus),P=st(a),F=I(P.finalTotal),O=P.companySharePercent>0?`${G(P.companySharePercent)}% (${I(P.companyShareAmount)})`:m("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),h=I(P.netProfit);return{[e.code]:u,[e.customer]:f,[e.date]:p,[e.status]:S,[e.payment]:k,[e.total]:F,[e.share]:O,[e.net]:h}});return{headers:w,rows:c}}catch(o){return console.warn("[reports/pdf] failed to build export rows from state",o),{headers:[],rows:[]}}}function Pt(o){const t=document.createElement("table");t.className="rpt-table";const n=document.createElement("thead"),l=document.createElement("tr");o.forEach(w=>{const c=document.createElement("th");c.textContent=w,l.appendChild(c)}),n.appendChild(l);const e=document.createElement("tbody");return t.appendChild(n),t.appendChild(e),{table:t,tbody:e}}function Mt(o,t,n,l){const e=o.querySelector("[data-quote-pages]"),w=s=>{const f=wt({primary:!!s});if(!s)try{f.classList.add("quote-page--continuation")}catch{}if(e.appendChild(f),s){const r=vt(l);f.appendChild(r)}const p=Pt(n);return f.appendChild(p.table),{page:f,table:p.table,tbody:p.tbody}},c=(s,f)=>{const p=document.createElement("tr");return n.forEach(r=>{const S=document.createElement("td"),k=document.createElement("div");k.className="quote-cell",k.textContent=f[r]!=null?String(f[r]):"",S.appendChild(k),p.appendChild(S)}),s.appendChild(p),p},a=(s,f)=>{try{const p=s.getBoundingClientRect(),r=f.lastElementChild;if(!r)return!0;const S=r.getBoundingClientRect(),k=parseFloat(getComputedStyle(s).paddingBottom||"0")||0,P=p.bottom-k-1;return S.bottom<=P}catch{return!0}};let{page:b,tbody:u}=w(!0);for(let s=0;s<t.length;s+=1){const f=c(u,t[s]);a(b,u)||(f.remove(),{page:b,tbody:u}=w(!1),c(u,t[s]))}}function Et(o=[],{context:t="preview"}={}){const l=(z.lastSnapshot||{}).metrics||{};let e,w=o&&o.length?o:null;if(w)e=Object.keys(w[0]||{});else{const b=Ct();e=b.headers,w=b.rows}const c=yt(t),a=document.createElement("div");a.style.position="fixed",a.style.left="0",a.style.top="0",a.style.width=`${N}px`,a.style.zIndex="-1",a.style.visibility="hidden",document.body.appendChild(a),a.appendChild(c);try{lt(c),pt(c),dt(c)}catch{}return Mt(c,w||[],e,l),c.parentElement?.removeChild(c),a.parentElement?.removeChild(a),t==="preview"&&xt(c),c}async function Wt(o=[],{action:t="save"}={}){const n=Et(o,{context:"export"}),l=document.createElement("div");Object.assign(l.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),l.appendChild(n),document.body.appendChild(l);try{if(t==="print"){if(Y()){const r=window.open("","_blank");if(!r)throw new Error("Popup blocked");const S=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${m("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{r.document.open(),r.document.write(S),r.document.close()}catch{}const k=n.cloneNode(!0);try{r.document.body.appendChild(k)}catch{}try{r.document?.fonts?.ready&&await r.document.fonts.ready}catch{}await new Promise(P=>setTimeout(P,60));try{r.focus(),r.print()}catch{}return}const u=document.createElement("iframe");Object.assign(u.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0",opacity:"0",pointerEvents:"none"}),document.body.appendChild(u);const s=u.contentWindow?.document,f=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>${m("reservations.reports.print.title","تقرير الحجوزات","Reservations report")}</title><style>@page{size:A4;margin:0;}html,body{margin:0;padding:0;background:#fff;direction:rtl;text-align:right;} .quote-preview-pages{gap:0 !important} .quote-page{box-shadow:none !important;border-radius:0 !important}</style></head><body></body></html>`;try{s.open(),s.write(f),s.close()}catch{}const p=n.cloneNode(!0);try{s.body.appendChild(p)}catch{}try{s.fonts?.ready&&await s.fonts.ready}catch{}await new Promise(r=>setTimeout(r,60));try{u.contentWindow?.focus(),u.contentWindow?.print()}catch{}setTimeout(()=>{try{u.remove()}catch{}},1500);return}const c=Y()&&!bt()?window.open("","_blank"):null;if(c)try{c.document.open(),c.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${m("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${m("reservations.quote.status.exporting","جاري تجهيز ملف PDF...","Preparing PDF...")}</h1><p>${m("reservations.quote.status.exportingHint","قد يستغرق ذلك بضع ثوانٍ، الرجاء الانتظار...","This may take a few seconds...")}</p></div></body></html>`),c.document.close()}catch{}await ct();try{document?.fonts?.ready&&await document.fonts.ready}catch{}const a=window.jspdf&&window.jspdf.jsPDF||window.jsPDF&&window.jsPDF.jsPDF,b=window.html2canvas;if(typeof a=="function"&&typeof b=="function"){const u=K(),s=new a({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),p={scale:Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},r=Array.from(n.querySelectorAll(".quote-page"));let S=0;const k=(h,d=250)=>{try{const i=h.getContext("2d"),{width:y,height:v}=h,g=new Uint8ClampedArray(y*4),C=x=>{const R=i.getImageData(0,x,y,1).data||g;let _=0;for(let E=0;E<y;E+=1){const q=E*4,T=R[q],$=R[q+1],D=R[q+2];if((T<d||$<d||D<d)&&(_+=1,_>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let M=0;for(let x=0;x<v;x+=2)if(!C(x)){M=x;break}return M}catch{return 0}},P=(h,d=245)=>{try{const i=h.getContext("2d"),{width:y,height:v}=h,g=Math.floor(y*.55),C=Math.max(10,y-g),M=Math.max(3,Math.ceil(C*.015));for(let x=0;x<v;x+=2){const R=i.getImageData(g,x,C,1).data;let _=0;for(let E=0;E<C;E+=1){const q=E*4,T=R[q],$=R[q+1],D=R[q+2];if((T<d||$<d||D<d)&&(_+=1,_>=M))return x}}return 0}catch{return 0}},F=(h,d=250)=>{try{const i=h.getContext("2d"),{width:y,height:v}=h,g=M=>{const x=i.getImageData(0,M,y,1).data;let R=0;for(let _=0;_<y;_+=1){const E=_*4,q=x[E],T=x[E+1],$=x[E+2];if((q<d||T<d||$<d)&&(R+=1,R>Math.max(2,Math.ceil(y*.003))))return!1}return!0};let C=0;for(let M=v-1;M>=0;M-=2)if(!g(M)){C=v-1-M;break}return C}catch{return 0}},O=(h,d,i)=>{try{const{width:y,height:v}=h,g=Math.max(0,Math.min(v-1,Math.round(d))),C=Math.max(0,Math.min(v-g,Math.round(i))),M=Math.max(1,v-g-C);if(g===0&&C===0)return h;const x=document.createElement("canvas");return x.width=y,x.height=M,x.getContext("2d").drawImage(h,0,-g),x}catch{return h}};for(let h=0;h<r.length;h+=1){const d=r[h],i=d.ownerDocument||document,y=i.createElement("div");Object.assign(y.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const v=i.createElement("div");v.id="quotation-pdf-root",v.setAttribute("data-quote-render-context","export"),v.style.width=`${N}px`,v.style.maxWidth=`${N}px`,v.style.minWidth=`${N}px`,v.style.background="#ffffff";const g=d.cloneNode(!0);g.style.width=`${N}px`,g.style.maxWidth=`${N}px`,g.style.minWidth=`${N}px`,g.style.height=`${A}px`,g.style.maxHeight=`${A}px`,g.style.minHeight=`${A}px`,g.style.position="relative",g.style.background="#ffffff",g.style.overflow="hidden",v.appendChild(g),y.appendChild(v),i.body.appendChild(y);let C;try{C=await b(g,{...p,scrollX:0,scrollY:0,windowWidth:N,windowHeight:A})}finally{y.parentNode?.removeChild(y)}if(!C)continue;const M=k(C,246),x=P(C,244),R=Math.max(M,x),_=F(C,246),E=O(C,R,_),q=Math.max(.9,Math.min(1,u.scale||1)),T=J*q,$=E.height/E.width*T;let D=Number(u.rightMm)||0;const Q=d.classList.contains("quote-page--primary")?6:12;let L=0;try{const W=d.querySelector(".rpt-header")||d.firstElementChild;if(W){const et=W.getBoundingClientRect(),ot=d.getBoundingClientRect();L=Math.max(0,et.top-ot.top)}}catch{L=0}const Z=L/j;let H=(Number(u.topMm)||0)+Q-Z;H<-80&&(H=-80);const tt=E.toDataURL("image/jpeg",.95);S>0&&s.addPage(),s.addImage(tt,"JPEG",D,H,T,$,`page-${S+1}`,"FAST"),S+=1,await new Promise(W=>requestAnimationFrame(W))}if(S===0)throw new Error("PDF generation produced no pages");if(t==="print"){const h=s.output("bloburl");if(c)try{c.location.href=h}catch{}else await new Promise(d=>{const i=document.createElement("iframe");Object.assign(i.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),i.onload=()=>{try{i.contentWindow?.focus(),i.contentWindow?.print()}catch{}setTimeout(()=>{i.remove(),d()},700)},i.src=h,document.body.appendChild(i)})}else try{const h=s.output("blob"),d=URL.createObjectURL(h),i=document.createElement("a");i.href=d,i.download="reservations-report.pdf",i.rel="noopener",i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{try{URL.revokeObjectURL(d),i.remove()}catch{}},1500)}catch{s.save("reservations-report.pdf")}}else{const u=window.html2pdf().set({margin:0,html2canvas:{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff"},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","legacy"]},image:{type:"jpeg",quality:.98}}).from(n).toPdf();if(t==="print"){const s=await u.get("pdf").then(f=>f.output("bloburl"));await new Promise(f=>{const p=document.createElement("iframe");Object.assign(p.style,{position:"fixed",right:"0",bottom:"0",width:"1px",height:"1px",border:"0"}),p.onload=()=>{try{p.contentWindow?.focus(),p.contentWindow?.print()}catch{}setTimeout(()=>{p.remove(),f()},700)},p.src=s,document.body.appendChild(p)})}else await u.save("reservations-report.pdf")}}finally{l.remove()}}export{Et as buildReportsPdfPages,Wt as exportReportsPdf};
