const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reservationsUI.BxNkC03r.js","./controller.Cnc9ilWq.js","./auth.CJ8hUxus.js","./auth.BL7Ui-VB.css","./reservationsActions.VB07Zig_.js","./reservationsService.CKBqxPIy.js","./technicians.CkrqkAg4.js","./uiBridge.-LBhd-Ju.js","./quotePdf.WC1ebubv.js","./canvasColorUtils.CviLtv6S.js","./projectsService.Bh2VHH5A.js"])))=>i.map(i=>d[i]);
import{r as ue,t as d,n as A,d as mt,b as ht,a as me,c as he,i as pe,j as W,l as fe}from"./auth.CJ8hUxus.js";import"./dashboard.gfQJt0Lc.js";import{g as Nt,b as ge,e as ye}from"./projectFocusTemplates.BogWC0iA.js";import{o as be,m as ve}from"./modals.BjvKJMy4.js";import{_ as De,s as kt,r as Jt,g as Xt}from"./technicians.CkrqkAg4.js";import{r as Zt,a as Ee,s as Ae,g as Ie}from"./controller.Cnc9ilWq.js";import{e as te,d as Rt,s as gt}from"./reservationsActions.VB07Zig_.js";import{ensureProjectsLoaded as Fe,getProjectsState as we,refreshProjectsFromApi as Se}from"./projectsService.Bh2VHH5A.js";import{a as Mt,g as pt,r as je,b as Te}from"./reservationsService.CKBqxPIy.js";import{b as ke}from"./uiBridge.-LBhd-Ju.js";import{i as Le}from"./dashboardShell.DF2kUed9.js";import{initDashboardMetrics as Pe}from"./dashboardMetrics.DPawAI_T.js";import"./quotePdf.WC1ebubv.js";import"./canvasColorUtils.CviLtv6S.js";ue({ar:{"technicianDetails.pageTitle":"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.title":"ğŸ˜ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.actions.back":"â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©","technicianDetails.actions.edit":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicianDetails.hero.subtitle":"Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø§Ø· Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… ÙˆÙ…Ù‡Ø§Ù…Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianDetails.hero.helper":"Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù….","technicianTabs.reservations":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianTabs.projects":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianFinancial.stats.total":"ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª","technicianFinancial.stats.paid":"ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©","technicianFinancial.stats.outstanding":"ğŸ§¾ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.stats.totalDesc":"Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…","technicianFinancial.stats.paidDesc":"ØªÙ… ØªØ³Ø¬ÙŠÙ„ {count} Ø¯ÙØ¹Ø§Øª","technicianFinancial.stats.outstandingDesc":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„","technicianFinancial.modal.title":"ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„ÙÙ†ÙŠ","technicianFinancial.modal.subtitle":"Ù†Ø¸Ø±Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø­Ø§Ù„ÙŠØ©.","technicianFinancial.list.title":"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹","technicianFinancial.assignments.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø£Ùˆ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.","technicianFinancial.list.reservation":"Ø§Ù„Ø­Ø¬Ø² / Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","technicianFinancial.list.period":"Ø§Ù„ÙØªØ±Ø©","technicianFinancial.list.due":"Ø§Ù„Ù…Ø³ØªØ­Ù‚","technicianFinancial.list.status":"Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹","technicianFinancial.list.outstanding":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ","technicianFinancial.list.settled":"Ù„Ø§ ÙŠÙˆØ¬Ø¯","technicianFinancial.list.reservationFallback":"Ø­Ø¬Ø² Ø±Ù‚Ù… {id}","technicianFinancial.list.projectReference":"Ù…Ø´Ø±ÙˆØ¹ #{id}","technicianFinancial.list.projectReferenceWithName":"Ù…Ø´Ø±ÙˆØ¹ #{id} â€¢ {name}","technicianFinancial.list.projectReferenceNameOnly":"Ù…Ø´Ø±ÙˆØ¹: {name}","technicianFinancial.status.paid":"Ù…Ø¯ÙÙˆØ¹","technicianFinancial.status.partial":"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹","technicianFinancial.status.unpaid":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹","technicianFinancial.payouts.title":"ğŸ’¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©","technicianFinancial.payouts.helper":"Ø³Ø¬Ù‘Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªÙŠ ØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ø¶Ù…Ø§Ù† ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø¯Ø§Ø¯.","technicianFinancial.payouts.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.","technicianFinancial.payouts.form.amount":"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº","technicianFinancial.payouts.form.date":"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹","technicianFinancial.payouts.form.note":"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","technicianFinancial.payouts.form.notePlaceholder":"Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© Ø³Ø±ÙŠØ¹Ø© Ø£Ùˆ Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„","technicianFinancial.payouts.form.submit":"ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmDelete":"âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©","technicianFinancial.payouts.confirmMessage":"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.","technicianFinancial.payouts.confirmCancel":"Ø¥Ù„ØºØ§Ø¡","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Ø­Ø°Ù","technicianFinancial.payouts.toast.added":"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.","technicianFinancial.payouts.toast.failed":"âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.filters.search":"ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² (Ù…Ø«Ù„ #123) Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...","technicianDetails.fields.role":"ğŸ‘” Ø§Ù„ÙˆØ¸ÙŠÙØ©:","technicianDetails.fields.department":"ğŸ§© Ø§Ù„Ù‚Ø³Ù…:","technicianDetails.fields.phone":"ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„:","technicianDetails.fields.email":"ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:","technicianDetails.fields.wage":"ğŸ’° Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:","technicianDetails.fields.total":"ğŸ’¼ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:","technicianDetails.fields.baseStatus":"âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:","technicianDetails.fields.notes":"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:","technicianDetails.fallback.email":"â€”","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"ØºÙŠØ± Ù…Ø­Ø¯Ø¯","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.","technicianDetails.errors.notFound":"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.","technicianDetails.errors.loadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.","technicianDetails.errors.reservationsLoadFailed":"âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.","technicianDetails.status.loading":"â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...","technicianDetails.edit.modalTitle":"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…","technicians.picker.actions.apply":"ØªÙ…","technicianProjects.title":"ğŸ“ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠ","technicianReservations.title":"ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†ÙŠ","technicianProjects.empty":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"ğŸ˜ Crew Member Profile","technicianDetails.actions.back":"â¬…ï¸ Back","technicianDetails.actions.edit":"âœï¸ Edit Crew Member","technicianDetails.hero.subtitle":"Review the crew memberâ€™s activity and current assignments.","technicianDetails.hero.helper":"Use this page to keep track of their reservations and linked projects.","technicianTabs.reservations":"ğŸ“… Technician Reservations","technicianTabs.projects":"ğŸ“ Technician Projects","technicianFinancial.stats.total":"ğŸ’¼ Total Due","technicianFinancial.stats.paid":"ğŸ’° Paid Amount","technicianFinancial.stats.outstanding":"ğŸ§¾ Outstanding","technicianFinancial.stats.totalDesc":"Across {count} assignments","technicianFinancial.stats.paidDesc":"{count} payouts recorded","technicianFinancial.stats.outstandingDesc":"Outstanding {amount}","technicianFinancial.actions.viewDetails":"ğŸ“Š View details","technicianFinancial.modal.title":"ğŸ“Š Technician Financial Summary","technicianFinancial.modal.subtitle":"Detailed look at outstanding dues, completed payments, and linked work.","technicianFinancial.list.title":"Linked reservations & projects","technicianFinancial.assignments.empty":"No linked reservations or projects to display yet.","technicianFinancial.list.reservation":"Reservation / Project","technicianFinancial.list.period":"Period","technicianFinancial.list.due":"Due amount","technicianFinancial.list.status":"Payment status","technicianFinancial.list.outstanding":"Outstanding","technicianFinancial.list.settled":"None","technicianFinancial.list.reservationFallback":"Reservation #{id}","technicianFinancial.list.projectReference":"Project #{id}","technicianFinancial.list.projectReferenceWithName":"Project #{id} â€¢ {name}","technicianFinancial.list.projectReferenceNameOnly":"Project: {name}","technicianFinancial.status.paid":"Paid","technicianFinancial.status.partial":"Partially paid","technicianFinancial.status.unpaid":"Unpaid","technicianFinancial.payouts.title":"ğŸ’¸ Internal payout log","technicianFinancial.payouts.helper":"Record company payouts issued to this crew member to track settlements.","technicianFinancial.payouts.empty":"No payouts recorded yet.","technicianFinancial.payouts.form.amount":"ğŸ’° Amount","technicianFinancial.payouts.form.date":"ğŸ“… Payment date","technicianFinancial.payouts.form.note":"ğŸ“ Notes (optional)","technicianFinancial.payouts.form.submit":"ğŸ’¸ Record payout","technicianFinancial.payouts.confirmDelete":"âŒ Delete this payout?","technicianFinancial.payouts.confirmTitle":"ğŸ—‘ï¸ Delete payout","technicianFinancial.payouts.confirmMessage":"Are you sure you want to delete this payout? This action cannot be undone.","technicianFinancial.payouts.confirmCancel":"Cancel","technicianFinancial.payouts.confirmAccept":"ğŸ—‘ï¸ Delete","technicianFinancial.payouts.toast.added":"âœ… Payout logged successfully.","technicianFinancial.payouts.toast.removed":"ğŸ—‘ï¸ Payout removed.","technicianFinancial.payouts.toast.invalidAmount":"âš ï¸ Enter a valid payout amount.","technicianFinancial.payouts.toast.failed":"âš ï¸ Unable to record the payout. Please try again.","technicianFinancial.payouts.toast.invalidTechnician":"âš ï¸ Unable to determine the crew member right now.","technicianDetails.filters.search":"ğŸ” Search by client or enter the reservation ID (e.g. #123) or project ID...","technicianDetails.fields.role":"ğŸ‘” Role:","technicianDetails.fields.department":"ğŸ§© Department:","technicianDetails.fields.phone":"ğŸ“ Phone:","technicianDetails.fields.email":"ğŸ“§ Email:","technicianDetails.fields.wage":"ğŸ’° Daily Rate:","technicianDetails.fields.total":"ğŸ’¼ Total Charge:","technicianDetails.fields.baseStatus":"âš™ï¸ Base Status:","technicianDetails.fields.notes":"ğŸ“ Notes:","technicianDetails.fallback.email":"â€”","technicianDetails.fallback.name":"â€”","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"â€”","technicianDetails.fallback.notes":"â€”","technicianDetails.errors.missingId":"âš ï¸ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"âš ï¸ Crew member not found.","technicianDetails.errors.loadFailed":"âŒ Unable to load crew member details. Please try again later.","technicianDetails.errors.reservationsLoadFailed":"âŒ Unable to load this crew member's reservations right now.","technicianDetails.status.loading":"â³ Loading crew member details...","technicianDetails.edit.modalTitle":"âœï¸ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"ğŸ“ Technician Projects","technicianReservations.title":"ğŸ“… Technician Reservations","technicianProjects.empty":"No projects are linked to this crew member."}});let yt={},v={initialized:!1,currentId:null,modal:{el:null,body:null},projectsMap:new Map},Ct=!1;function Ft(t=""){return A(String(t)).replace(/[Ù¬ØŒ]/g,"").trim().toLowerCase()}function ee(t,e,n){if(!e||!n)return;const{startDate:a,endDate:i}=Zt(t);e._flatpickr?a?e._flatpickr.setDate(a,!1,"Y-m-d"):e._flatpickr.clear():e.value=a||"",n._flatpickr?i?n._flatpickr.setDate(i,!1,"Y-m-d"):n._flatpickr.clear():n.value=i||""}function U(t){if(!Array.isArray(t))return[];const e=new Set;return t.map(n=>{if(n==null)return null;if(typeof n=="object"){const a=n.id??n.technicianId??n.technician_id??n.technician?.id??null;return a!=null?String(a):null}return typeof n=="string"||typeof n=="number"?String(n):null}).filter(n=>!n||e.has(n)?!1:(e.add(n),!0))}async function ne(t){const e=document.getElementById("technician-reservations");if(!e)return;if(!Ct){try{await Promise.all([te({suppressError:!1,force:!0}),Fe({force:!0}).catch(()=>{})])}catch(h){console.error("âŒ [technician-details] Failed to hydrate reservations list",h),e.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.reservationsLoadFailed">${d("technicianDetails.errors.reservationsLoadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹.")}</p>`;return}Ct=!0}const n=document.getElementById("technician-search-reservation"),a=document.getElementById("technician-filter-start-date"),i=document.getElementById("technician-filter-end-date"),c=document.getElementById("technician-reservation-date-range"),o=document.getElementById("technician-reservation-status-filter"),r=document.getElementById("technician-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const u=()=>{let h=A(a?.value||"").trim(),D=A(i?.value||"").trim(),w=c?.value||"";if(new Set(["","today","week","month"]).has(w)||(w="",c&&(c.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),h="",D=""),!h&&!D&&w){const{startDate:$,endDate:l}=Zt(w);h=$,D=l}return{searchTerm:Ft(n?.value||""),startDate:h,endDate:D,status:o?.value||"",quickRange:w,technicianId:t}},m=()=>{yt=u(),$t("technician-reservations",yt)};n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=A(n.value),m()}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{c&&(c.value=""),m()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{c&&(c.value=""),m()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{ee(c.value,a,i),m()}),c.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",m),o.dataset.listenerAttached="true"),r&&!r.dataset.listenerAttached&&(r.addEventListener("click",()=>{n&&(n.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),c&&(c.value=""),o&&(o.value=""),m()}),r.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{$t("technician-reservations",yt)},document.__techReservationsProjectListenerAttached||(document.addEventListener("projects:changed",()=>{try{typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews()}catch{}}),document.__techReservationsProjectListenerAttached=!0),m()}function ae(t){v.currentId=t;const{container:e}=X();e&&(v.initialized||(_e(),Be(),Me(),document.addEventListener("projects:changed",()=>{v.currentId&&_()}),document.addEventListener("language:changed",()=>{v.currentId&&_()}),document.addEventListener("customers:changed",()=>{v.currentId&&_()}),document.addEventListener("technicians:updated",()=>{v.currentId&&_()}),v.initialized=!0),_())}function X(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),startInput:document.getElementById("technician-project-start-date"),endInput:document.getElementById("technician-project-end-date"),rangeSelect:document.getElementById("technician-project-date-range"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function _e(){const{searchInput:t,statusSelect:e,clearBtn:n,startInput:a,endInput:i,rangeSelect:c}=X();t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=A(t.value),_()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(a,{dateFormat:"Y-m-d"}),a.addEventListener("change",()=>{c&&(c.value=""),_()}),a.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(window.flatpickr&&window.flatpickr(i,{dateFormat:"Y-m-d"}),i.addEventListener("change",()=>{c&&(c.value=""),_()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{ee(c.value,a,i),_()}),c.dataset.listenerAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{_()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",()=>{const{searchInput:o,statusSelect:r,startInput:u,endInput:m,rangeSelect:h}=X();o&&(o.value=""),r&&(r.value=""),u&&(u._flatpickr&&u._flatpickr.clear(),u.value=""),m&&(m._flatpickr&&m._flatpickr.clear(),m.value=""),h&&(h.value=""),_()}),n.dataset.listenerAttached="true")}function Be(){const{container:t}=X();!t||t.dataset.projectModalListenerAttached==="true"||(t.addEventListener("click",Re),t.dataset.projectModalListenerAttached="true")}function Ne(){const{container:t}=X();t&&t.querySelectorAll(".project-focus-card").forEach(e=>{e.dataset.technicianModalListenerAttached!=="true"&&(e.addEventListener("click",n=>{if(n.target.closest("[data-ignore-project-modal]"))return;const i=e.dataset.projectId?String(e.dataset.projectId):"";i&&ce(i)}),e.dataset.technicianModalListenerAttached="true")})}function Re(t){const e=t.target.closest(".project-focus-card");if(!e||(console.debug("[technician] card click",e.dataset.projectId),!e)||t.target.closest("[data-ignore-project-modal]"))return;const a=e.dataset.projectId?String(e.dataset.projectId):"";a&&ce(a)}function Me(){ie()}function ie(){if(v.modal?.el&&v.modal?.body)return!0;const t=document.getElementById("projectDetailsModal"),e=document.getElementById("project-details-body");if(!t||!e){const i=document.createElement("div");i.innerHTML=`
      <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${d("projects.details.modalTitle","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="project-details-body"></div>
          </div>
        </div>
      </div>`,document.body.appendChild(i.firstElementChild)}const n=document.getElementById("projectDetailsModal"),a=document.getElementById("project-details-body");return!n||!a?!1:(v.modal={el:n,body:a},!0)}function _(){const{container:t,searchInput:e,statusSelect:n,startInput:a,endInput:i}=X();if(!t||!v.currentId)return;const c=Ft(e?.value||""),o=n?.value||"",r=a?.value||"",u=i?.value||"",m=r?new Date(`${r}T00:00:00`):null,h=u?new Date(`${u}T23:59:59`):null,{projects:D=[],customers:w=[],technicians:B=[],reservations:x=[]}=mt(),$=new Map(w.map(s=>[String(s.id),s])),l=new Map(B.map(s=>[String(s.id),s])),p=new Map(D.map(s=>[String(s.id),s])),R=Ce(x),N=String(v.currentId),j=new Map,V=(s,f=null)=>{if(!s)return;const g=s.id!=null?String(s.id):s.projectId!=null?String(s.projectId):null;if(g&&!j.has(g)){const E=f??U(s?.technicians);j.set(g,{...s,technicians:E})}};D.forEach(s=>{const f=U(s?.technicians);f.length&&f.includes(N)&&V({...s,technicians:f},f)}),x.forEach(s=>{if(!s?.projectId)return;const f=U(s.technicians);if(!f.includes(N))return;const g=String(s.projectId),E=j.get(g),S=p.get(g),{effectiveConfirmed:at}=Mt(s,S??E??null);if(E){const b=U(E.technicians),k=Array.from(new Set([...b,...f]));j.set(g,{...E,technicians:k,confirmed:E.confirmed||at});return}if(S){const b=U(S?.technicians),k=Array.from(new Set([...b,...f]));V({...S,technicians:k,confirmed:Mt(s,S).effectiveConfirmed},k);return}V({id:g,title:s.projectTitle||s.title||s.project_title||`#${g}`,description:s.notes||"",start:s.projectStart||s.start||null,end:s.projectEnd||s.end||null,technicians:f,clientId:s.projectClientId??s.customerId??null,confirmed:at,status:s.status??null,equipmentEstimate:s.totalAmount??s.total_amount??0,createdAt:s.start??s.created_at??null},f)});const ft=Array.from(j.values());v.projectsMap=j,typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{projectsMap:j,keys:()=>Array.from(j.keys())}});const nt=ft.filter(s=>{if(c){const f=$.get(String(s.clientId))?.customerName||"",g=[s.id,s.projectId,s.project_id,s.projectCode,s.project_code,s.reference,s.reference_code,s.code,Nt(s)];if(!Ft([s.title,s.description,f,g.filter(S=>S!=null&&S!=="").map(String).join(" ")].filter(Boolean).join(" ")).includes(c))return!1}if(o&&xe(s)!==o)return!1;if(m||h){const f=s.start||s.createdAt||s.created_at||null,g=s.end||s.projectEnd||s.project_end||null,E=f?new Date(f):null,S=g?new Date(g):E;if(m&&E&&E<m||h&&S&&S>h)return!1}return!0}).sort((s,f)=>{const g=new Date(s.start||s.createdAt||0).getTime();return new Date(f.start||f.createdAt||0).getTime()-g});if(!nt.length){const s=d("technicianProjects.empty",t.dataset.empty||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ.");t.innerHTML=`<div class="project-card-grid__item project-card-grid__item--full"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}t.innerHTML=nt.map(s=>{const f=Nt(s),g=f?R.get(f)||[]:[],E=$.get(String(s.clientId))||null;return ge(s,{customer:E,techniciansMap:l,reservations:g})}).join(""),Ne()}function Ce(t=[]){const e=new Map;return t.forEach(n=>{const a=n?.projectId??n?.project_id??n?.projectID;if(a==null)return;const i=String(a);e.has(i)||e.set(i,[]),e.get(i).push(n)}),e}function ce(t){const e=String(t||"").trim();if(console.debug("[technician] open details",e),!e||!ie()||!v.modal?.body)return;const{projects:a=[],reservations:i=[],customers:c=[]}=mt(),o=v.projectsMap?.get(e)||null;let r=o??xt(a,e);if(r||(r=xt(a,e)),!r)return;const u=String(v.currentId||"");let m=U(r.technicians);!m.length&&o&&(m=U(o.technicians),r={...o,...r}),typeof window=="object"&&(window.__ART_RATIO_APP_DEBUG={...window.__ART_RATIO_APP_DEBUG||{},technicianProjects:{...window.__ART_RATIO_APP_DEBUG?.technicianProjects||{},lastOpen:{id:e,activeTechnicianId:u,normalizedTechnicians:m}}}),r={...r,technicians:m},c.find(h=>String(h.id)===String(r.clientId)),i.filter(h=>{const D=ye(h);return D&&D===e}),Rt.detailsModalEl=v.modal.el,Rt.detailsBody=v.modal.body,gt.projects=we(),gt.reservations=pt(),gt.customers=c||[],be(e);try{if(!(window.bootstrap&&window.bootstrap.Modal)&&v.modal?.el){const h=v.modal.el;h.classList.add("show"),h.style.display="block",h.removeAttribute("aria-hidden")}}catch{}}function xt(t=[],e){const n=String(e);return t.find(a=>[a?.id,a?.projectId,a?.project_id].some(c=>c!=null&&String(c)===n))||null}function xe(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}async function $t(t,e){try{const n=await De(()=>import("./reservationsUI.BxNkC03r.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url);try{n.renderReservations?.(t,e)}catch(a){console.error("âŒ [technician-details] renderReservations failed",a)}}catch(n){console.error("âŒ [technician-details] Failed to load reservations UI module",n)}}async function $e(t,{signal:e}={}){const n=new URLSearchParams;t&&n.set("technician_id",t);const a=n.toString(),i=await ht(`/technician-payouts/${a?`?${a}`:""}`,{signal:e});return Array.isArray(i?.data)?i.data:[]}async function qe({technicianId:t,amount:e,note:n,paidAt:a}){return(await ht("/technician-payouts/",{method:"POST",body:{technician_id:t,amount:e,note:n,paid_at:a}}))?.data??null}async function ze(t){return(await ht(`/technician-payouts/?id=${encodeURIComponent(t)}`,{method:"DELETE"}))?.data??null}ve();me();he();Le();Ee();const qt=()=>{try{Ae(Ie())}catch(t){console.warn("âš ï¸ [technicianPage] Failed to initialize reservation edit modal",t)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",qt,{once:!0}):qt();const Ue=new URLSearchParams(window.location.search),y=Ue.get("id"),M=document.getElementById("technician-details"),zt=document.getElementById("technician-hero-name"),He=document.getElementById("technician-hero-status"),Ut=document.getElementById("technician-hero-role"),bt=document.getElementById("technician-hero-position"),it=document.getElementById("dashboard-greeting-technician-name"),Z=document.getElementById("dashboard-greeting-technician-role"),Oe=document.getElementById("dashboard-greeting-technician-status"),Ht=document.getElementById("dashboard-greeting-technician-role-badge"),Ve=document.getElementById("sidebar-stat-projects"),We=document.getElementById("sidebar-stat-reservations"),Ke=document.getElementById("sidebar-stat-equipment"),Ye=document.getElementById("sidebar-stat-technicians"),L={total:document.getElementById("technician-financial-total"),totalDesc:document.getElementById("technician-financial-total-desc"),paid:document.getElementById("technician-financial-paid"),paidDesc:document.getElementById("technician-financial-paid-desc"),outstanding:document.getElementById("technician-financial-outstanding"),outstandingDesc:document.getElementById("technician-financial-outstanding-desc")},F=document.getElementById("technician-financial-modal"),ct=document.getElementById("technician-financial-open"),Ot=document.getElementById("technician-financial-modal-total"),Vt=document.getElementById("technician-financial-modal-paid"),Wt=document.getElementById("technician-financial-modal-outstanding"),vt=document.getElementById("technician-financial-modal-empty"),Dt=document.getElementById("technician-financial-modal-table-wrapper"),Et=document.getElementById("technician-financial-modal-rows"),Ge=Array.from(document.querySelectorAll("[data-financial-modal-close]")),K=document.getElementById("technician-payout-form"),I=document.getElementById("technician-payout-amount"),G=document.getElementById("technician-payout-date"),Qe=document.getElementById("technician-payout-note"),O=document.getElementById("technician-payouts-list"),At=document.getElementById("technician-payouts-empty"),Q=document.getElementById("technician-payout-confirm-modal"),q=document.getElementById("technician-payout-confirm-yes"),Je=Array.from(document.querySelectorAll("[data-payout-confirm-close]")),wt=Array.from(document.querySelectorAll("[data-technician-tab]")),Xe=new Map(Array.from(document.querySelectorAll("[data-technician-tab-panel]")).map(t=>[t.getAttribute("data-technician-tab-panel"),t]));let Lt="reservations",T=null,H={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},It=[],ut=null;pe();function Pt(){return document.documentElement.getAttribute("lang")||"ar"}function st(t){const e=Number(t)||0,a=Pt()==="ar"?"ar-SA-u-nu-latn":"en-US";try{return new Intl.NumberFormat(a,{maximumFractionDigits:0}).format(e)}catch{return A(String(e))||"0"}}function Ze(t){if(!t||typeof t!="object")return null;const e=n=>{const a=Number.parseInt(String(n??"0"),10);return Number.isFinite(a)?a:0};return{projects:e(t?.projects?.total),reservations:e(t?.reservations?.total),equipment:e(t?.equipment?.total),technicians:e(t?.technicians?.total)}}function tn(){const t=mt();return{projects:Array.isArray(t.projects)?t.projects.length:0,reservations:Array.isArray(t.reservations)?t.reservations.length:0,equipment:Array.isArray(t.equipment)?t.equipment.length:0,technicians:Array.isArray(t.technicians)?t.technicians.length:0}}function rt(t,e,n){let a=document.getElementById(t);if(a)return a;let i=document.getElementById("dashboard-sidebar");i||(i=document.createElement("aside"),i.id="dashboard-sidebar",i.className="sidebar-shell sidebar-drawer",(document.body||document.documentElement).prepend(i));let c=i.querySelector(".sidebar-panel--stats");c||(c=document.createElement("div"),c.className="sidebar-panel sidebar-panel--stats",c.innerHTML=`
      <h3 class="sidebar-heading">${d?.("dashboard.sidebar.statsHeading","Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…")}</h3>
      <div class="sidebar-stats" role="list"></div>
    `,i.prepend(c));let o=c.querySelector(".sidebar-stats");o||(o=document.createElement("div"),o.className="sidebar-stats",o.setAttribute("role","list"),c.appendChild(o));const r=document.createElement("div");r.className="sidebar-stats-row",r.setAttribute("role","listitem");const u=d?.(e,n)??n??"";return r.innerHTML=`<span>${u}</span><span id="${t}" class="badge-soft">0</span>`,o.appendChild(r),a=r.querySelector(`#${t}`),a}function C(t={}){const e=tn(),n={projects:t.projects??e.projects,reservations:t.reservations??e.reservations,equipment:t.equipment??e.equipment,technicians:t.technicians??e.technicians},a={projects:Ve||rt("sidebar-stat-projects","dashboard.metrics.projects.label","Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹"),reservations:We||rt("sidebar-stat-reservations","dashboard.metrics.reservations.label","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"),equipment:Ke||rt("sidebar-stat-equipment","dashboard.metrics.equipment.label","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),technicians:Ye||rt("sidebar-stat-technicians","dashboard.metrics.technicians.label","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„")};a.projects&&(a.projects.textContent=st(n.projects)),a.reservations&&(a.reservations.textContent=st(n.reservations)),a.equipment&&(a.equipment.textContent=st(n.equipment)),a.technicians&&(a.technicians.textContent=st(n.technicians));try{window.__TECHNICIAN_STATS__={...n}}catch{}}function en(){if(!y)return[];const t=pt(),e=String(y);return Array.isArray(t)?t.filter(n=>{if(!n)return!1;const a=String(n.status||"").toLowerCase();return a==="cancelled"||a==="canceled"||a==="Ù…Ù„ØºÙŠ"||a==="Ù…Ù„ØºÙ‰"||a==="Ù…Ù„ØºÙŠØ©"?!1:(Array.isArray(n.technicians)?n.technicians.map(c=>String(c)):[]).includes(e)}):[]}function nn(){const t=en(),e=se(t,y?String(y):null);return C(e),e}function an(t){if(!t||typeof t!="object")return 0;const e=[t.quantity,t.qty,t.count];for(const n of e){if(n==null||n==="")continue;const a=Number(A(String(n)));if(Number.isFinite(a))return a>0?a:0}return 1}function _t(t){if(!t)return[];const e=new Set,n=a=>{U(a).forEach(i=>e.add(i))};return n(t.technicians),n(t.crewAssignments),n(t.techniciansDetails),Array.from(e)}let ot=null;function cn(){if(ot)return ot;const t=mt(),e=new Map;return t&&Array.isArray(t.projects)&&t.projects.forEach(n=>{const a=n?.id!=null?String(n.id):n?.projectId!=null?String(n.projectId):null;a&&e.set(a,n)}),ot=e,ot}function sn(t){if(!t)return null;const e=t.projectId??t.project_id??t.project?.id??t.project?.projectId,n=e!=null?String(e):null,a=t.projectTitle||t.project_title||t.projectName||t.project_name||t.project?.title||t.project?.name;if(a&&n)return{id:n,name:a};if(a)return{id:null,name:a};if(n){const c=cn().get(n),o=c?.title||c?.name||c?.projectTitle||c?.project_name;return o?{id:n,name:o}:{id:n,name:null}}return null}function se(t,e){if(!Array.isArray(t)||!t.length)return{projects:0,reservations:0,equipment:0,technicians:e?1:0};const n=new Set,a=new Set;e&&a.add(String(e));let i=0;return t.forEach(c=>{if(!c)return;c.projectId!=null&&n.add(String(c.projectId)),_t(c).forEach(r=>a.add(r)),Array.isArray(c.items)&&c.items.forEach(r=>{i+=an(r)})}),{projects:n.size,reservations:t.length,equipment:i,technicians:a.size||(e?1:0)}}async function rn(){try{const t=await ht("/summary/"),e=Ze(t?.data??null);if(e){C(e);return}}catch{}try{await Promise.allSettled([Se(),je(),Jt(),ke({showToastOnError:!1})])}catch{}C()}function P(t){const e=Number(t)||0,a=Pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{const i=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${A(i)} SR`}catch{const c=Math.round(e);return`${A(String(c))} SR`}}function St(t){if(!t)return d("common.placeholder.empty","â€”");const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return d("common.placeholder.empty","â€”");const a=Pt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";try{return new Intl.DateTimeFormat(a,{dateStyle:"medium"}).format(e)}catch{const c=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),r=e.getFullYear();return`${c}/${o}/${r}`}}function J(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Kt(t={}){const e=[t.positionCost,t.position_cost,t.cost,t.dailyWage,t.daily_rate,t.dailyRate,t.rate,t.wage];for(const n of e){if(n==null||n==="")continue;const a=Number(A(String(n)));if(Number.isFinite(a))return a}return 0}function on(t){const e=typeof t=="string"?t.toLowerCase():"unpaid";let n="technicianFinancial.status.unpaid",a="technician-payment-badge technician-payment-badge--unpaid";return e==="paid"?(n="technicianFinancial.status.paid",a="technician-payment-badge technician-payment-badge--paid"):e==="partial"&&(n="technicianFinancial.status.partial",a="technician-payment-badge technician-payment-badge--partial"),`<span class="${a}" data-i18n data-i18n-key="${n}">${d(n,n)}</span>`}function Yt(t){const{totals:e,metrics:n}=t,a=Number(n.assignments??0),i=Number(n.payoutsCount??0),c=d("technicianFinancial.stats.totalDesc","Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {count} Ù…Ù‡Ø§Ù…").replace("{count}",A(String(a))),o=d("technicianFinancial.stats.paidDesc","{count} Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©").replace("{count}",A(String(i))),r=d("technicianFinancial.stats.outstandingDesc","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ {amount}"),u=e.outstanding>0?r.replace("{amount}",P(e.outstanding)):d("common.placeholder.empty","â€”");L.total&&(L.total.textContent=P(e.total)),L.totalDesc&&(L.totalDesc.textContent=a>0?c:d("common.placeholder.empty","â€”")),L.paid&&(L.paid.textContent=P(e.paid)),L.paidDesc&&(L.paidDesc.textContent=i>0?o:d("common.placeholder.empty","â€”")),L.outstanding&&(L.outstanding.textContent=P(e.outstanding)),L.outstandingDesc&&(L.outstandingDesc.textContent=u)}function jt(t){const{totals:e,breakdown:n,payouts:a}=t;if(Ot&&(Ot.textContent=P(e.total)),Vt&&(Vt.textContent=P(e.paid)),Wt&&(Wt.textContent=P(e.outstanding)),!(!Et||!Dt||!vt)){if(!n.length)Et.innerHTML="",Dt.classList.add("hidden"),vt.classList.remove("hidden");else{vt.classList.add("hidden"),Dt.classList.remove("hidden");const i=n.map(c=>{const o=c.period||"â€”",r=c.outstandingAmount>0?P(c.outstandingAmount):`<span class="text-success">${d("technicianFinancial.list.settled","Ù„Ø§ ÙŠÙˆØ¬Ø¯")}</span>`;return`
        <tr>
          <td>
            <div class="font-semibold text-base-content">${J(c.label)}</div>
            <div class="text-xs text-base-content/60">${J(c.reference)}</div>
          </td>
          <td class="whitespace-nowrap">${J(o)}</td>
          <td>${P(c.dueAmount)}</td>
          <td>${on(c.paidStatus)}</td>
          <td>${r}</td>
        </tr>
      `}).join("");Et.innerHTML=i}ln(a)}}function ln(t=[]){if(!O||!At)return;if(!Array.isArray(t)||t.length===0){O.innerHTML="",At.classList.remove("hidden");return}const e=t.map(n=>{const a=P(n.amount||0),i=St(n.paidAt||n.createdAt),c=n.note?`<p class="technician-payout-note text-sm text-base-content/70">${J(n.note)}</p>`:"",o=d("actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <li class="technician-payout-item">
        <div class="technician-payout-item-body">
          <div class="technician-payout-item-head">
            <span class="technician-payout-amount">${a}</span>
            <span class="technician-payout-date">${J(i)}</span>
          </div>
          ${c}
        </div>
        <button type="button" class="btn btn-outline btn-sm technician-payout-remove" data-payout-remove="${J(n.id)}" data-i18n data-i18n-key="actions.delete">${o}</button>
      </li>
    `}).join("");O.innerHTML=e,At.classList.add("hidden")}function re(t){const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10)}function dn(t){if(!t)return new Date;const e=new Date(`${t}T00:00:00`);return Number.isNaN(e.getTime())?new Date:e}function un(t){const e=A(String(t??""));if(!e)return"";const i=e.replace(/[Ù¬ØŒ]/g,"").replace(/[Ù«,]/g,".").replace(/[^0-9.]/g,"").split("."),c=i[0]||"",o=i.length>1?i.slice(1).join(""):"",r=c.replace(/^0+(\d)/,"$1"),u=r.length?r:o?"0":"",m=o?o.replace(/\D/g,"").slice(0,2):"";return m?`${u}.${m}`:u}function mn(t){if(t.preventDefault(),!y){W(d("technicianFinancial.payouts.toast.invalidTechnician","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø­Ø§Ù„ÙŠØ§Ù‹."));return}const e=I?.value??"",n=Number.parseFloat(A(String(e)));if(!Number.isFinite(n)||n<=0){W(d("technicianFinancial.payouts.toast.invalidAmount","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¨Ù„Øº.")),I?.focus();return}const a=Qe?.value?.trim()||"",i=dn(G?.value||null),c=K?.querySelector('button[type="submit"]');c&&(c.disabled=!0),qe({technicianId:y,amount:Number(n.toFixed(2)),note:a,paidAt:i.toISOString()}).then(o=>{W(d("technicianFinancial.payouts.toast.added","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©.")),K?.reset(),G&&(G.value=re(o?.paidAt||new Date)),T&&et(T)}).catch(o=>{console.error("âŒ [technician-page] Failed to create technician payout",o);const r=o?.message||d("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");W(r)}).finally(()=>{c&&(c.disabled=!1)})}function hn(t){t&&fn(t)}function pn(){F&&(F.classList.remove("hidden"),F.classList.add("show"),F.classList.add("modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"),G&&!G.value&&(G.value=re(new Date)))}function Bt(){F&&(F.classList.remove("show"),F.classList.remove("modal-open"),F.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"))}function fn(t){Q&&(ut=t||null,Q.classList.remove("hidden"),Q.classList.add("show","modal-open"),document.documentElement.classList.add("modal-open"),document.body.classList.add("overflow-hidden"))}function Tt(){Q&&(Q.classList.remove("show","modal-open"),Q.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("overflow-hidden"),ut=null,q&&(q.disabled=!1))}function oe(){return Array.from(document.querySelectorAll("[data-technician-edit]"))}function gn(t){if(t.preventDefault(),!T)return;try{document.dispatchEvent(new CustomEvent("technician:prefill",{detail:{...T}}))}catch(a){console.error("âš ï¸ [technician-page] Failed to prefill technician edit modal",a)}const e=document.getElementById("editTechnicianModal");if(!e||!window.bootstrap?.Modal)return;window.bootstrap.Modal.getOrCreateInstance(e).show()}function le(){oe().forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",gn),t.dataset.listenerAttached="true")})}async function et(t){if(H={totals:{total:0,paid:0,outstanding:0},metrics:{assignments:0,payoutsCount:0,outstandingAmount:0},breakdown:[],payouts:[]},Yt(H),jt(H),C(),!y||!t)return;try{await te({suppressError:!0})}catch(l){console.error("âš ï¸ [technician-page] Failed to load reservations for financial summary",l)}const n=pt(),a=String(y);try{const l=await $e(a);It=Array.isArray(l)?l:[]}catch(l){console.error("âš ï¸ [technician-page] Failed to load technician payouts from API",l),It=[]}const i=n.filter(l=>{if(!l)return!1;const p=String(l.status||"").toLowerCase();return p==="cancelled"||p==="canceled"||p==="Ù…Ù„ØºÙŠ"||p==="Ù…Ù„ØºÙ‰"||p==="Ù…Ù„ØºÙŠØ©"?!1:_t(l).includes(a)}),c=se(i,a);C(c);const o=i.map((l,p)=>{const R=Array.isArray(l.techniciansDetails)?l.techniciansDetails.find(b=>{const k=b?.id??b?.technician_id??b?.technicianId??b?.ID;return k!=null&&String(k)===a}):null,N=Kt(R)||Kt(t),j=Math.max(1,Te(l.start,l.end)),V=Math.max(0,Math.round(N*j)),ft=d("technicianFinancial.list.reservationFallback","Ø­Ø¬Ø² Ø±Ù‚Ù… {id}").replace("{id}",A(String(l.reservationId||l.id||"?"))),nt=l.title&&l.title.trim().length?l.title.trim():ft,s=[];if(l.reservationId||l.id){const b=l.reservationId||l.id;s.push(`#${A(String(b))}`)}const f=sn(l);if(f?.id){const b=A(String(f.id));if(f.name){const k=d("technicianFinancial.list.projectReferenceWithName","Ù…Ø´Ø±ÙˆØ¹ #{id} â€¢ {name}");s.push(k.replace("{id}",b).replace("{name}",String(f.name)))}else s.push(d("technicianFinancial.list.projectReference","Ù…Ø´Ø±ÙˆØ¹ #{id}").replace("{id}",b))}else if(f?.name){const b=d("technicianFinancial.list.projectReferenceNameOnly","Ù…Ø´Ø±ÙˆØ¹: {name}");s.push(b.replace("{name}",String(f.name)))}if(l.status){const b=`reservations.status.${l.status}`;s.push(d(b,l.status))}const g=St(l.start),E=St(l.end),S=g===E?g:`${g} â€“ ${E}`,at=(()=>{const b=l.start||l.startDatetime||l.createdAt||l.created_at,k=b?new Date(b).getTime():NaN;return Number.isNaN(k)?p:k})();return{label:nt,reference:s.join(" â€¢ ")||"â€”",period:S,dueAmount:V,paidAmount:0,outstandingAmount:V,paidStatus:"unpaid",sortKey:at,originalIndex:p}}),r=It.map(l=>({...l,amount:Number(l.amount)||0}));let u=r.reduce((l,p)=>l+p.amount,0);const h=[...o].sort((l,p)=>l.sortKey===p.sortKey?l.originalIndex-p.originalIndex:l.sortKey-p.sortKey).map(l=>{const p={...l},R=Number(l.dueAmount)||0,N=Math.min(R,Math.max(0,Number(u.toFixed(2))));N>0&&(u=Number((u-N).toFixed(2))),p.paidAmount=Number(N.toFixed(2));const j=Math.max(0,Number((R-N).toFixed(2)));return p.outstandingAmount=j,j<=.009?(p.paidStatus="paid",p.outstandingAmount=0):N>0?p.paidStatus="partial":p.paidStatus="unpaid",p}).sort((l,p)=>l.originalIndex-p.originalIndex).map(({sortKey:l,originalIndex:p,...R})=>R),D=h.reduce((l,p)=>l+p.dueAmount,0),w=r.reduce((l,p)=>l+(Number(p.amount)||0),0),B=Math.max(0,Number((D-w).toFixed(2))),x={total:Math.max(0,Number(D.toFixed(2))),paid:Math.max(0,Number(w.toFixed(2))),outstanding:B},$={assignments:h.length,payoutsCount:r.length,outstandingAmount:B};H={totals:x,metrics:$,breakdown:h,payouts:r},Yt(H),jt(H)}function z(t,e,n,{hideWhenEmpty:a=!1}={}){if(!t)return;const i=n==null?"":String(n).trim(),c=i.length>0;t.textContent=c?`${e} ${i}`:`${e} ${d("common.placeholder.empty","â€”")}`,a?t.classList.toggle("hidden",!c):c||t.classList.remove("hidden")}function Gt(t){const e=[He,Oe].filter(Boolean);if(!e.length)return;const n=typeof t=="string"?t.toLowerCase():"";if(!n){e.forEach(r=>{r.className="technician-badge hidden",r.textContent=d("common.placeholder.empty","â€”")});return}const a=n==="busy",i=["technician-badge"];i.push(a?"technician-badge--status-busy":"technician-badge--status-available");const c=a?"technicians.status.busy":"technicians.status.available",o=a?"â›” Ù…Ø´ØºÙˆÙ„":"âœ… Ù…ØªØ§Ø­";if(e.forEach(r=>{r.className=i.join(" "),r.classList.remove("hidden"),r.setAttribute("data-i18n",""),r.setAttribute("data-i18n-key",c),r.textContent=d(c,o)}),bt)if(a){const r=yn(y),u=r&&String(r).trim().length?r:"";z(bt,"ğŸ·ï¸",u,{hideWhenEmpty:!0})}else z(bt,"ğŸ·ï¸","",{hideWhenEmpty:!0})}function yn(t){try{const e=pt();if(!Array.isArray(e)||e.length===0)return"";const n=t!=null?String(t):null;if(!n)return"";const a=new Date,i=e.find(u=>{if(!u||!u.start&&!u.startDatetime&&!u.start_datetime)return!1;const m=_t(u);if(!Array.isArray(m)||!m.includes(n))return!1;const h=u.start??u.startDatetime??u.start_datetime,D=u.end??u.endDatetime??u.end_datetime;if(!h||!D)return!1;const w=new Date(h),B=new Date(D);return Number.isNaN(w.getTime())||Number.isNaN(B.getTime())?!1:w<=a&&a<B});if(!i)return"";const o=(Array.isArray(i.crewAssignments)&&i.crewAssignments.length?i.crewAssignments:Array.isArray(i.techniciansDetails)?i.techniciansDetails:[]).find(u=>{const m=u?.id??u?.technicianId??u?.technician_id;return m!=null&&String(m)===n});return o&&(o.positionLabel??o.position_name??o.position_label??o.positionKey??o.position)||""}catch{return""}}function Y(t){if(!t){z(zt,"ğŸ˜",d("common.placeholder.empty","â€”")),z(Ut,"ğŸ¯","",{hideWhenEmpty:!0}),it&&(it.textContent=d("common.placeholder.empty","â€”")),Z&&(Z.textContent=d("common.placeholder.empty","â€”")),z(Ht,"ğŸ¯","",{hideWhenEmpty:!0}),Gt(null);return}if(z(zt,"ğŸ˜",t.name||d("common.placeholder.empty","â€”")),z(Ut,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),it&&(it.textContent=t.name||d("common.placeholder.empty","â€”")),Z){const e=t.role?t.role:"";if(e)Z.textContent=`ğŸ¯ ${e}`;else{const n=d("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯");Z.textContent=`ğŸ¯ ${n}`}}z(Ht,"ğŸ¯",t.role||"",{hideWhenEmpty:!0}),Gt(t.status||t.baseStatus||"available")}function tt(t){oe().forEach(e=>{e.disabled=!!t})}function dt(t){t&&(Lt=t,wt.forEach(e=>{if(!e)return;const n=e.getAttribute("data-technician-tab")===t;e.classList.toggle("tab-active",n),e.classList.toggle("active",n),e.setAttribute("aria-selected",String(n))}),Xe.forEach((e,n)=>{e&&e.classList.toggle("hidden",n!==t)}),t==="projects"&&y&&ae(y),t==="reservations"&&y&&ne(y))}function bn(){wt.length&&(wt.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{const e=t.getAttribute("data-technician-tab");e&&dt(e)}),t.dataset.listenerAttached="true")}),document.querySelectorAll("[data-technician-tab-trigger]").forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-technician-tab-trigger");n&&dt(n)}),t.dataset.listenerAttached="true")}),dt(Lt))}Y(null);tt(!0);bn();le();ct&&!ct.dataset.listenerAttached&&(ct.addEventListener("click",()=>{jt(H),pn()}),ct.dataset.listenerAttached="true");Ge.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",()=>{Bt()}),t.dataset.listenerAttached="true")});K&&!K.dataset.listenerAttached&&(K.addEventListener("submit",mn),K.dataset.listenerAttached="true");O&&!O.dataset.listenerAttached&&(O.addEventListener("click",t=>{const e=t.target.closest("[data-payout-remove]");if(!e)return;const n=e.getAttribute("data-payout-remove");hn(n)}),O.dataset.listenerAttached="true");if(I&&!I.dataset.normalizerAttached){const t=()=>{const e=un(I.value);if(e!==I.value){const n=e.length;I.value=e,I.setSelectionRange&&I.setSelectionRange(n,n)}};I.addEventListener("input",t),I.addEventListener("blur",()=>{if(t(),I.value){const e=Number.parseFloat(I.value);Number.isFinite(e)&&(I.value=e.toFixed(2))}}),I.dataset.normalizerAttached="true"}Je.forEach(t=>{!t||t.dataset.listenerAttached||(t.addEventListener("click",Tt),t.dataset.listenerAttached="true")});q&&!q.dataset.listenerAttached&&(q.addEventListener("click",()=>{if(!ut){Tt();return}q.disabled=!0,ze(ut).then(()=>{W(d("technicianFinancial.payouts.toast.removed","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.")),Tt(),T&&et(T)}).catch(t=>{console.error("âŒ [technician-page] Failed to remove technician payout",t);const e=t?.message||d("technicianFinancial.payouts.toast.failed","âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");W(e),q.disabled=!1})}),q.dataset.listenerAttached="true");F&&!F.dataset.listenerAttached&&(F.addEventListener("click",t=>{t.target===F&&Bt()}),F.dataset.listenerAttached="true");document.addEventListener("keydown",t=>{t.key==="Escape"&&F&&F.classList.contains("modal-open")&&Bt()});const lt=document.getElementById("logout-btn");lt&&!lt.dataset.listenerAttached&&(lt.addEventListener("click",()=>fe()),lt.dataset.listenerAttached="true");function vn(t){const e=Number(t??0);return Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function Dn(t){const e=Number(t??0);if(!Number.isFinite(e)||e<=0)return"";const n=d("technicians.badge.perDay","/Ø§Ù„ÙŠÙˆÙ…");return`${P(e)} ${n}`}function Qt(t){const e=Number(t??0);return!Number.isFinite(e)||e<=0?"":P(e)}function de(t){if(!M)return;if(Y(t),!t){M.innerHTML=`<p class="text-base-content/60" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,tt(!0);return}const e=t.phone?A(t.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${d("reservations.details.technicians.phoneUnknown","ØºÙŠØ± Ù…ØªÙˆÙØ±")}</span>`,n=t.email?t.email:`<span data-i18n data-i18n-key="technicianDetails.fallback.email">${d("technicianDetails.fallback.email","â€”")}</span>`,a=t.role?t.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${d("technicianDetails.fallback.role","ØºÙŠØ± Ù…Ø­Ø¯Ø¯")}</span>`,i=t.department?t.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${d("technicianDetails.fallback.department","â€”")}</span>`,c=t.notes?t.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${d("technicianDetails.fallback.notes","â€”")}</span>`,r=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${d("reservations.create.summary.currency","SR")}</span>`,u=Dn(t.dailyWage)||`${vn(t.dailyWage)} ${r}`,m=Qt(t.dailyTotal),h=u,D=m||Qt(t.dailyWage)||u;console.debug("[technician] amounts",{id:t.id,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,wageValue:h,totalValue:D});const B=[{key:"technicianDetails.fields.role",value:a},{key:"technicianDetails.fields.department",value:i},{key:"technicianDetails.fields.phone",value:e},{key:"technicianDetails.fields.email",value:n},{key:"technicianDetails.fields.notes",value:c}].map(({key:x,value:$})=>`
    <article class="rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
      <span class="text-sm font-medium text-base-content/70" data-i18n data-i18n-key="${x}">${d(x)}</span>
      <p class="mt-2 text-lg font-semibold text-base-content">${$}</p>
    </article>
  `).join("");M.innerHTML=B,le(),tt(!1),dt(Lt)}async function En(){if(!M)return;if(!y){Y(null),C(),tt(!0),T=null,M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${d("technicianDetails.errors.missingId","âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.")}</p>`;return}M.innerHTML=`<p class="text-muted" data-i18n data-i18n-key="technicianDetails.status.loading">${d("technicianDetails.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…...")}</p>`,tt(!0),Y(null);let t=null,e=null;try{await Jt(),kt()}catch(n){e=n,console.error("âŒ [technician-details] Failed to refresh technician from API",n)}if(t=Xt(y),!t){e?M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.loadFailed">${d("technicianDetails.errors.loadFailed","âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.")}</p>`:M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,Y(null),C(),T=null;return}if(!t){M.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${d("technicianDetails.errors.notFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.")}</p>`,Y(null),C(),T=null;return}T=t,await et(t),de(t),ne(y),ae(y)}kt();En();["projects:changed","reservations:changed","equipment:changed","technicians:changed"].forEach(t=>{document.addEventListener(t,()=>{y?nn():C()},{passive:!0})});Pe();rn();const An=async()=>{if(!y)return;kt();const t=Xt(y);t&&(T=t,await et(t),de(t))};window.addEventListener("technicians:updated",An);const In=()=>{!y||!T||et(T)};document.addEventListener("reservations:changed",In,{passive:!0});
