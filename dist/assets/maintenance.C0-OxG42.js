import{n as je,E as La,i as Ca,r as Ta,h as Ia,g as wa,c as cn}from"./reservations.C_D60Eux.js";const Ba={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_BASE_URL:"http://127.0.0.1:8000/api"},$a="/backend/api";class H extends Error{constructor(t,{status:n,payload:a}={}){super(t),this.name="ApiError",this.status=n??null,this.payload=a??null}}function Na(){const e=typeof import.meta<"u"&&Ba&&"http://127.0.0.1:8000/api",t=typeof window<"u"?window.APP_API_BASE:null;return String(e||t||$a).replace(/\/$/,"")}async function I(e,{method:t="GET",headers:n={},body:a,signal:r,credentials:s="include"}={}){if(typeof e!="string"){try{console.warn("[apiClient] Invalid path passed to apiRequest:",e)}catch{}e=String(e||"")}const i=e.startsWith("/")?e:`/${e}`,o=`${Na()}${i}`,l={Accept:"application/json",...n},u={method:t,headers:l,signal:r,credentials:s};a!==void 0&&(a instanceof FormData?(delete l["Content-Type"],u.body=a):typeof a=="string"?(l["Content-Type"]=l["Content-Type"]||"application/json",u.body=a):(l["Content-Type"]=l["Content-Type"]||"application/json",u.body=JSON.stringify(a)));const d=await fetch(o,u),p=d.headers.get("content-type")||"";let m=null;if(p.includes("application/json"))try{m=await d.json()}catch{throw new H("Failed to parse server response as JSON",{status:d.status})}else{const f=await d.text();m=f?{raw:f}:null}if(!d.ok){const f=m?.error||`Request failed with status ${d.status}`;throw new H(f,{status:d.status,payload:m})}if(m&&typeof m=="object"&&m.ok===!1){const f=m.error||"API returned an error response";throw new H(f,{status:d.status,payload:m})}return m}const G=Object.freeze({language:"ar",theme:"light",dashboardTab:null,dashboardSubTab:null,projectsTab:null,projectsSubTab:null});let z=null,We=null;const Bt=new Set,Sn="__ART_RATIO_SKIP_PREF_FETCH__",_n="__ART_RATIO_PREFERENCES__";function An(){try{return typeof window>"u"?!1:!!window[Sn]}catch{return!1}}function xa(){try{typeof window<"u"&&delete window[Sn]}catch{}}function ve(e={}){const t=e.language==="en"?"en":"ar",n=e.theme==="dark"?"dark":"light",a=typeof e.dashboardTab=="string"?Ye(e.dashboardTab):null,r=typeof e.dashboardSubTab=="string"?Ye(e.dashboardSubTab):null,s=typeof e.projectsTab=="string"?Ye(e.projectsTab):null,i=typeof e.projectsSubTab=="string"?Ye(e.projectsSubTab):null;return{language:t,theme:n,dashboardTab:a,dashboardSubTab:r,projectsTab:s,projectsSubTab:i}}function Ye(e){const t=String(e||"").trim();return t&&/^[a-z0-9\-]+$/i.test(t)?t:null}function ka(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(_n);if(!e)return null;const t=JSON.parse(e);return ve(t)}catch(e){return console.warn("⚠️ [preferencesService] Failed to read cached preferences",e),null}}function Ma(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.setItem(_n,JSON.stringify(e))}catch(t){console.warn("⚠️ [preferencesService] Failed to persist preferences",t)}}const ln=ka();ln&&(z=ln);function Da(){const e=$();Bt.forEach(t=>{try{t(e)}catch(n){console.error("⚠️ [preferencesService] listener failed",n)}})}function ie(e){const n={...z?{...z}:{...G},...e};z=ve(n),Ma(z),Da()}function $(){return z?{...z}:null}function Ln(e){if(typeof e!="function")return()=>{};if(Bt.add(e),z)try{e($())}catch(t){console.error("⚠️ [preferencesService] listener failed",t)}return()=>{Bt.delete(e)}}function Cn({refresh:e=!1}={}){if(An()){const t=$()||{...G};return Promise.resolve(t)}return!e&&z?Promise.resolve($()):(We||(We=I("/preferences/").then(t=>{const n=t?.data??G;return ie(n),$()}).catch(t=>t instanceof H&&t.status===401?(z=null,G):(console.warn("⚠️ [preferencesService] Failed to load preferences",t),ie(G),G)).finally(()=>{We=null})),We)}function Fa(e=null){if(!e){const t=$();return ve(t||G)}return ve(e)}async function Rt(e={}){if(An())return ie(e),$()||{...G};e.language!==void 0&&e.language,e.theme!==void 0&&e.theme,e.dashboardTab!==void 0&&e.dashboardTab,e.dashboardSubTab!==void 0&&e.dashboardSubTab,e.projectsTab!==void 0&&e.projectsTab,e.projectsSubTab!==void 0&&e.projectsSubTab;const t=Fa(),n={...t,...e},a=ve(n),r={},s={};["language","theme","dashboardTab","dashboardSubTab","projectsTab","projectsSubTab"].forEach(u=>{if(e[u]===void 0)return;const d=a[u],p=t[u];d!==p&&(r[u]=d,(u==="language"||u==="theme")&&(s[u]=d))});const o=Object.keys(r).length>0,l=Object.keys(s).length>0;if(!l&&!o)return $();if(!l&&o)return ie(a),$();try{const u=await I("/preferences/",{method:"PATCH",body:s});return ie(u?.data??G),o&&ie({...$(),...r}),$()}catch(u){if(u instanceof H&&u.status===422)return console.warn("⚠️ [preferencesService] Server rejected preference update (no changes)."),ie(a),$();throw u}}const ce="ar",Ra="ar",Pa="language-loading",un="language-ready",Tn=["Placeholder","Title","AriaLabel","AriaDescription","Value"],Oe={ar:Object.create(null),en:Object.create(null)};let me=ce,nt=!1,At=null;function ze(e){return e==="en"?"en":"ar"}function In(){if(!At){const e=$();if(e?.language){const t=ze(e.language);Me(t,{persist:!1,dispatch:!1})}At=Cn().then(t=>{const n=ze(t?.language??ce);return Me(n,{persist:!1}),nt=!0,n}).catch(t=>(console.warn("⚠️ تعذر تحميل تفضيل اللغة من الخادم",t),Me(ce,{persist:!1}),nt=!0,ce))}return At}function ja(e){if(e.dataset.i18nCached==="true")return;e.dataset.i18nHtml==="true"?e.dataset.arHtml===void 0&&(e.dataset.arHtml=e.innerHTML):e.dataset.ar===void 0&&(e.dataset.ar=e.textContent),Tn.forEach(n=>{const a=n.charAt(0).toLowerCase()+n.slice(1),r=e.getAttribute(a);r!=null&&e.dataset[`ar${n}`]===void 0&&(e.dataset[`ar${n}`]=r)}),e.dataset.i18nCached="true"}function dn(e,t){if(!t)return;const n=Oe[e]??(Oe[e]=Object.create(null));Object.entries(t).forEach(([a,r])=>{typeof a=="string"&&(n[a]=r)})}function mn(e,t){if(!t)return;const n=Oe[e];return n?n[t]:void 0}function Oa(e,t){ja(e);const n=e.dataset.i18nHtml==="true",a=e.dataset.i18nKey,r=mn(t,a);r!==void 0?n?e.innerHTML=r:e.textContent=r:t==="en"?n?e.dataset.enHtml!==void 0&&(e.innerHTML=e.dataset.enHtml):e.dataset.en!==void 0&&(e.textContent=e.dataset.en):n?e.innerHTML=e.dataset.arHtml??e.innerHTML:e.textContent=e.dataset.ar??e.textContent,Tn.forEach(s=>{const i=s.charAt(0).toLowerCase()+s.slice(1),o=e.dataset[`i18n${s}Key`],l=mn(t,o);if(l!==void 0){e.setAttribute(i,l);return}const u=t==="en"?`en${s}`:`ar${s}`,d=e.dataset[u];d!==void 0&&e.setAttribute(i,d)})}function wn(e){document.querySelectorAll("[data-i18n]").forEach(n=>Oa(n,e))}function za(e){const t=document.documentElement,n=document.body,a=e===Ra?"rtl":"ltr";t.setAttribute("lang",e),t.setAttribute("dir",a),n&&(n.setAttribute("dir",a),n.dataset.lang=e)}function Ha(){const e=document.documentElement;e&&(e.classList.contains(un)||(e.classList.remove(Pa),e.classList.add(un)))}function Bn(e){document.querySelectorAll(".language-toggle-btn").forEach(t=>{const n=t.dataset.labelAr||"🇸🇦 العربية",a=t.dataset.labelEn||"🇬🇧 English";t.textContent=e==="en"?n:a,t.setAttribute("aria-pressed",e==="en"?"true":"false")})}function Me(e,{persist:t=!1,dispatch:n=!0}={}){const a=ze(e);me===a&&nt&&!t||(me=a,nt=!0,za(a),wn(a),Bn(a),Ha(),n&&document.dispatchEvent(new CustomEvent("language:changed",{detail:{language:a}})),t&&Rt({language:a}).catch(r=>{console.warn("⚠️ تعذر حفظ تفضيل اللغة في الخادم",r)}))}function Ua(){Va(me==="ar"?"en":"ar")}function $n(){document.querySelectorAll(".language-toggle-btn").forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",()=>{Ua()}),t.dataset.listenerAttached="true")}),Bn(me)}function Ei(e={}){dn("ar",e.ar),dn("en",e.en);const t=$t();wn(t),document.dispatchEvent(new CustomEvent("language:translationsReady",{detail:{language:t}}))}function c(e,t=""){if(!e)return t;const n=me||ce,a=Oe[n];if(a&&a[e]!==void 0)return a[e];const s=Oe[n==="en"?"ar":"en"];return s&&s[e]!==void 0?s[e]:t}function Va(e){const t=ze(e);Me(t,{persist:!0})}function Si(){In().catch(()=>ce).finally(()=>{$n()})}function $t(){return me}function pn(){In().catch(()=>ce),$n()}Ln(e=>{e&&e.language&&ze(e.language)!==me&&Me(e.language,{persist:!1})});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pn,{once:!0}):pn();const he="dark-mode",Je=new WeakSet,fn="theme-loading",Nn="art-ratio:session-theme";let gn=!1;function xn(){return Array.from(document.querySelectorAll("[data-theme-toggle], .theme-toggle-btn"))}function kn(e){return e==="dark"?"dark":"light"}function Ka(e){try{window.sessionStorage?.setItem(Nn,kn(e))}catch{}}function Qa(){try{const e=window.sessionStorage?.getItem(Nn);return e==="dark"?"dark":e==="light"?"light":null}catch{return null}}function Xa(){document.documentElement.classList.remove(fn);const e=document.body;e&&e.classList.remove(fn)}function lt(e,{persist:t=!0}={}){const n=kn(e),a=document.documentElement,r=document.body;n==="dark"?(a.classList.add(he,"dark"),r&&r.classList.add(he,"dark")):(a.classList.remove(he,"dark"),r&&r.classList.remove(he,"dark"));const s=n==="dark"?"dark":"light";a.setAttribute("data-theme",s),r&&r.setAttribute("data-theme",s),Ka(n),Pt(n);try{document.dispatchEvent(new CustomEvent("theme:changed",{detail:{theme:n}}))}catch(i){console.warn("⚠️ [theme.js] Failed to dispatch theme change event",i)}t&&Rt({theme:n}).catch(i=>{console.warn("⚠️ تعذر حفظ تفضيل السمة في الخادم",i)})}function Ve(){const e=document.body;return e&&e.classList.contains(he)||document.documentElement.classList.contains(he)?"dark":"light"}function Lt(){const e=Ve()==="dark"?"light":"dark";lt(e,{persist:!0})}function Ga(e,t){if(!e)return;const n=t==="dark",a=c("theme.toggle.toLight","☀️ الوضع العادي"),r=c("theme.toggle.toDark","🌙 الوضع الليلي"),s=c("theme.toggle.ariaLight","الوضع العادي مفعل"),i=c("theme.toggle.ariaDark","الوضع الليلي مفعل"),o=c("theme.toggle.titleLight","التبديل إلى الوضع العادي"),l=c("theme.toggle.titleDark","التبديل إلى الوضع الليلي");if(e.matches("[data-theme-toggle]")){const u=e.matches("input")?e:e.querySelector('input[type="checkbox"]'),d=n?a:r,p=n?s:i,m=n?o:l;u&&(u.checked=n,u.setAttribute("aria-label",d),u.setAttribute("aria-checked",String(n))),e.setAttribute("title",m),e.setAttribute("aria-label",p),e.setAttribute("data-theme-state",n?"dark":"light");const f=e.querySelector("[data-theme-label]");f&&(f.textContent=d)}else e.textContent=n?a:r,e.setAttribute("aria-pressed",String(n)),e.setAttribute("title",n?o:l),e.setAttribute("aria-label",n?s:i)}function Pt(e){xn().forEach(t=>Ga(t,e)),Xa()}function Wa(){const e=xn();Pt(Ve()),e.forEach(t=>{if(!(!t||Je.has(t))){if(t.matches("[data-theme-toggle]")){const n=t.matches("input")?t:t.querySelector('input[type="checkbox"]'),a=()=>{Lt()};n&&!Je.has(n)?(n.addEventListener("change",a),Je.add(n)):n||t.addEventListener("click",r=>{r.preventDefault(),Lt()})}else t.getAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",n=>{n.preventDefault(),Lt()});Je.add(t)}})}function _i({skipRemote:e=!1}={}){const t=$(),r=(t?.theme==="dark"?"dark":t?.theme==="light"?"light":null)||Qa()||Ya();lt(r,{persist:!1}),Ja({skipRemote:e})}function Ya(){try{if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return"dark"}catch{}return"light"}function Ja({skipRemote:e=!1}={}){gn||(gn=!0,!e&&Cn().then(t=>{const n=t?.theme==="dark"?"dark":t?.theme==="light"?"light":null;n&&lt(n,{persist:!1})}).catch(t=>{console.warn("⚠️ تعذر تحميل تفضيل السمة من الخادم",t)}))}document.addEventListener("language:changed",()=>{Pt(Ve()),Wa()});Ln(e=>{const t=e?.theme==="dark"?"dark":e?.theme==="light"?"light":null;t&&t!==Ve()&&lt(t,{persist:!1})});function jt(){const e=typeof window<"u"?window:globalThis;return e.__APP_DATA_STORE__||(e.__APP_DATA_STORE__={customers:[],reservations:[],equipment:[],technicians:[],maintenance:[],projects:[],technicianPayouts:[],packages:[]}),e.__APP_DATA_STORE__}function Z(e,t,n){n!=null&&(e[t]=Array.isArray(n)?[...n]:n)}function ne(){const e=jt();return{customers:[...e.customers],reservations:[...e.reservations],equipment:[...e.equipment],technicians:[...e.technicians],maintenance:[...e.maintenance],projects:[...e.projects],technicianPayouts:[...e.technicianPayouts],packages:[...e.packages]}}function Ot(e={}){const t=jt();Z(t,"customers",e.customers),Z(t,"reservations",e.reservations),Z(t,"equipment",e.equipment),Z(t,"technicians",e.technicians),Z(t,"maintenance",e.maintenance),Z(t,"projects",e.projects),Z(t,"technicianPayouts",e.technicianPayouts),Z(t,"packages",e.packages)}let Ct=!1;function Ai(e=null){if(Ct)return;const t=e||(typeof window<"u"?window.__LEGACY_DATA__:null);if(!t||typeof t!="object"){Ct=!0;return}const n=jt();if(["customers","reservations","equipment","technicians","maintenance","projects","technicianPayouts","packages"].forEach(r=>{const s=t[r];Array.isArray(s)&&s.length>0&&(n[r]=[...s])}),Ct=!0,!e&&typeof window<"u")try{delete window.__LEGACY_DATA__}catch{}}function Mn(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="9999",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.width="min(92vw, 380px)",e.style.pointerEvents="none",document.body.appendChild(e)),e}function Dn(e){e.style.background="#333",e.style.color="#fff",e.style.padding="10px 18px",e.style.marginTop="10px",e.style.borderRadius="10px",e.style.boxShadow="0 8px 24px rgba(15, 23, 42, 0.32)",e.style.opacity="0",e.style.transition="opacity 0.3s ease",e.style.fontSize="0.875rem",e.style.lineHeight="1.4",e.style.pointerEvents="auto",e.style.backdropFilter="blur(4px)"}function Fn(e){requestAnimationFrame(()=>{e.style.opacity="1"})}function Rn(e,t){let n;const a=()=>{n&&(clearTimeout(n),n=null),e.style.opacity="0",setTimeout(()=>e.remove(),320)};return n=setTimeout(a,t),{hide:a,timeoutId:n}}function h(e,t=3e3,n){const a=Mn(),r=document.createElement("div");r.className="toast-message",r.textContent=e;const s=new Set(["success","error","info","warning"]);let i="info",o=3e3;typeof t=="number"&&Number.isFinite(t)?o=Math.max(0,t):typeof t=="string"&&s.has(t)&&(i=t),Dn(r);const l={success:{bg:"#14532d",border:"rgba(34,197,94,0.35)",glow:"rgba(34,197,94,0.35)"},error:{bg:"#7f1d1d",border:"rgba(239,68,68,0.35)",glow:"rgba(239,68,68,0.35)"},info:{bg:"#1e3a8a",border:"rgba(59,130,246,0.35)",glow:"rgba(59,130,246,0.35)"},warning:{bg:"#7c2d12",border:"rgba(245,158,11,0.35)",glow:"rgba(245,158,11,0.35)"}},{bg:u,border:d,glow:p}=l[i]||l.info;r.style.background=u,r.style.border=`1px solid ${d}`,r.style.boxShadow=`0 8px 24px rgba(15, 23, 42, 0.32), 0 0 0 4px ${p}`,a.appendChild(r),Fn(r);const{hide:m}=Rn(r,o);r.addEventListener("click",m)}function Li({message:e,duration:t=6e3,actionLabel:n,onAction:a,linkLabel:r,linkHref:s}={}){const i=Mn(),o=document.createElement("div");o.className="toast-message",Dn(o);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="8px";const u=document.createElement("span");u.textContent=e,l.appendChild(u);const d=document.createElement("div");d.style.display="flex",d.style.flexWrap="wrap",d.style.gap="8px";let p=!1,m=()=>{};if(r&&s){const b=document.createElement("a");b.href=s,b.textContent=r,b.target="_blank",b.rel="noopener noreferrer",b.style.color="#bfdbfe",b.style.textDecoration="underline",b.style.fontWeight="500",b.style.pointerEvents="auto",d.appendChild(b),p=!0}if(n&&typeof a=="function"){const b=document.createElement("button");b.type="button",b.textContent=n,b.style.border="1px solid rgba(255,255,255,0.4)",b.style.background="rgba(15, 23, 42, 0.2)",b.style.color="#fff",b.style.borderRadius="999px",b.style.padding="6px 14px",b.style.fontSize="0.78rem",b.style.cursor="pointer",b.addEventListener("click",y=>{y.preventDefault();try{a()}catch(v){console.error("⚠️ [toast] action callback failed",v)}finally{m()}}),d.appendChild(b),p=!0}p&&l.appendChild(d),o.appendChild(l),i.appendChild(o),Fn(o);const{hide:f}=Rn(o,t);m=f,o.addEventListener("click",f)}const bn="RSV",yn="PRJ",Za=4,Ee=(()=>{try{const e=typeof globalThis<"u"?globalThis:window;return e.__APP_SEQUENCE_STATE__=e.__APP_SEQUENCE_STATE__||{reservation:0,project:0},e.__APP_SEQUENCE_STATE__}catch{return{reservation:0,project:0}}})();function er(){return Number.isFinite(Ee.reservation)?Ee.reservation:0}function tr(e){Ee.reservation=Math.max(0,Number.parseInt(e,10)||0)}function nr(){return Number.isFinite(Ee.project)?Ee.project:0}function ar(e){Ee.project=Math.max(0,Number.parseInt(e,10)||0)}function Pn(){try{const e=ne();return{reservations:Array.isArray(e?.reservations)?e.reservations:[],projects:Array.isArray(e?.projects)?e.projects:[]}}catch(e){return console.warn("⚠️ [utils] Failed to load data snapshot for code generation",e),{reservations:[],projects:[]}}}function rr(e,t){if(e==null)return 0;if(typeof e=="number")return Number.isFinite(e)?Math.max(0,Math.trunc(e)):0;const n=String(e).trim();if(!n)return 0;const a=`${t.toUpperCase()}-`,r=n.toUpperCase();let s=n;r.startsWith(a)&&(s=n.slice(a.length));const i=s.match(/(\d+)$/);if(i){const l=Number.parseInt(i[1],10);return Number.isFinite(l)?Math.max(0,l):0}const o=Number.parseInt(n,10);return Number.isFinite(o)?Math.max(0,o):0}function ir(e){return Array.isArray(e)?e:[e]}function jn(e,t,n){return!Array.isArray(e)||e.length===0?0:e.reduce((a,r)=>{const s=n(r),o=ir(s).reduce((l,u)=>{const d=rr(u,t);return d>l?d:l},0);return o>a?o:a},0)}function On(e,t){const n=Math.max(0,Number.parseInt(t,10)||0);return`${e}-${String(n).padStart(Za,"0")}`}function Ci(){const{reservations:e}=Pn(),t=jn(e,bn,a=>[a?.reservationCode,a?.reservation_code,a?.reservationId,a?.reservation_id,a?.id]),n=Math.max(t,er())+1;return tr(n),On(bn,n)}function Ti(){const{projects:e}=Pn(),t=jn(e,yn,a=>[a?.projectCode,a?.project_code,a?.code,a?.id]),n=Math.max(t,nr())+1;return ar(n),On(yn,n)}function ke(e,t={}){if(!e)return"-";const n=new Date(e);if(Number.isNaN(n.getTime()))return"-";const a=document?.documentElement?.getAttribute("lang")||(typeof $t=="function"?$t():null)||"ar",s=String(a).toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.DateTimeFormat(s,{dateStyle:"short",timeStyle:"short",hour12:!0,calendar:"gregory",...t}).formatToParts(n),l=n.getHours()>=12?"PM":"AM",u=o.map(d=>d.type==="dayPeriod"?l:d.value).join("").replace(/\u200f/g,"");return g(u)}function g(e){if(e==null)return"";e=String(e);const t=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"],n=["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"],a=["0","1","2","3","4","5","6","7","8","9"];return Array.from(e).map(r=>{const s=t.indexOf(r);if(s>-1)return a[s];const i=n.indexOf(r);return i>-1?a[i]:r}).join("")}const hn={INVALID:{key:"login.errors.invalidCredentials",fallback:"❌ بيانات الدخول غير صحيحة"},NETWORK:{key:"login.errors.network",fallback:"🌐 تعذر الاتصال بالخادم. حاول مرة أخرى."},GENERIC:{key:"login.errors.generic",fallback:"⚠️ حدث خطأ غير متوقع. حاول مرة أخرى."}};let M=null;const zt={USER_UPDATED:"auth:user-updated"};function sr(){try{const e=window?.location?.hostname||"";return e==="localhost"||e==="127.0.0.1"||e===""||e==="::1"}catch{return!1}}function zn(){try{if(!sr())return!1;const e=new URL(window.location.href),t=(e.searchParams.get("bypassAuth")||e.searchParams.get("dev")||e.searchParams.get("debug")||"").toLowerCase();return window.__BYPASS_AUTH__===!0||t==="1"||t==="true"}catch{return!1}}function or(e){if(typeof document>"u")return;const t=document.documentElement;t&&(e?t.dataset.userRole=e:delete t.dataset.userRole)}function cr(){typeof document>"u"||document.dispatchEvent(new CustomEvent(zt.USER_UPDATED,{detail:M?{...M}:null}))}function le(e){if(e&&typeof e=="object"){const t=typeof e.role=="string"?e.role.trim().toLowerCase():null;M={id:Number.isFinite(e.id)?Number(e.id):null,username:String(e.username||""),loginAt:e.loginAt??null,role:t}}else M=null;or(M?.role||""),cr()}function lr(e="INVALID",t){if(t&&typeof t=="string")return t;const n=hn[e]||hn.INVALID;return c(n.key,n.fallback)}function ur(){const e=document.getElementById("login-error");e&&(e.textContent="",e.classList.add("hidden"))}function Ne(e="INVALID",t){const n=lr(e,t);h(n);const a=document.getElementById("login-error");a&&(a.textContent=n,a.classList.remove("hidden"))}async function dr({username:e,password:t,form:n}){if(!(!e||!t))try{if(typeof window>"u"||typeof navigator>"u"||!window.isSecureContext||!navigator.credentials||typeof navigator.credentials.store!="function")return;const a=(()=>{try{const s=document.querySelector('link[rel~="icon"]');return s?s.href:void 0}catch{return}})();let r=null;if(n&&n instanceof HTMLFormElement&&typeof window.PasswordCredential<"u")try{r=new window.PasswordCredential(n)}catch(s){console.warn("⚠️ تعذر إنشاء بيانات الاعتماد من النموذج",s)}if(!r&&typeof window.PasswordCredential<"u")try{r=new window.PasswordCredential({id:e,name:e,password:t,iconURL:a})}catch(s){console.warn("⚠️ تعذر إنشاء PasswordCredential مباشر",s)}!r&&typeof navigator.credentials.create=="function"&&(r=await navigator.credentials.create({password:{id:e,name:e,password:t,iconURL:a}})),r&&await navigator.credentials.store(r)}catch(a){console.warn("⚠️ تعذر حفظ بيانات الاعتماد في المتصفح",a)}}async function Ii(e,t,{form:n}={}){const a=(e||"").trim(),r=t||"";if(ur(),!a||!r)return Ne("INVALID"),!1;try{const s=await I("/auth/",{method:"POST",body:{username:a,password:r}});le(s?.data??null);try{await Rt({theme:Ve()})}catch(i){console.warn("⚠️ تعذر حفظ تفضيل السمة بعد تسجيل الدخول",i)}return xa(),await dr({username:a,password:r,form:n}),window.location.href="home.html",!0}catch(s){if(console.error("❌ فشل تسجيل الدخول",s),le(null),s instanceof H)if(s.status===401||s.status===403)Ne("INVALID");else if(s.status>=500)Ne("GENERIC");else{const o=typeof s.message=="string"&&!/^request failed with status/i.test(s.message)?s.message:null;Ne("GENERIC",o)}else Ne("NETWORK");return!1}}async function wi(){try{await I("/auth/",{method:"DELETE"})}catch(e){console.warn("⚠️ فشل تسجيل الخروج من الخادم",e)}finally{le(null),h("🚪 تم تسجيل الخروج"),window.location.href="login.html"}}async function mr({refresh:e=!1}={}){if(zn())return M||le({id:0,username:"dev-local",loginAt:new Date().toISOString(),role:"admin"}),M;if(!e&&M)return M;try{const t=await I("/auth/");return le(t?.data??null),M}catch(t){throw t instanceof H&&t.status===401&&le(null),t}}function Bi({redirect:e=!0}={}){return zn()?(M||le({id:0,username:"dev-local",loginAt:new Date().toISOString(),role:"admin"}),Promise.resolve(M)):mr({refresh:!0}).then(t=>(!t&&e&&(window.location.href="login.html"),t)).catch(t=>t instanceof H&&t.status===401?(e&&(window.location.href="login.html"),null):(console.error("❌ خطأ أثناء التحقق من الجلسة",t),e&&(window.location.href="login.html"),null))}function pr(){return M?.role||null}function J(){return pr()==="admin"}function Te(){h(c("auth.permissions.denied","⚠️ ليس لديك صلاحية لتنفيذ هذا الإجراء"),"error")}const Tt="select.form-select:not([data-no-enhance]):not([multiple])",U=new WeakMap;let It=null,vn=!1,W=null;function $i(e=document){e&&(e.querySelectorAll(Tt).forEach(t=>tt(t)),!It&&e===document&&(It=new MutationObserver(t=>{for(const n of t)n.addedNodes?.forEach(a=>{a instanceof Element&&(a.matches?.(Tt)&&tt(a),a.querySelectorAll?.(Tt).forEach(r=>tt(r)))})}),It.observe(document.body,{childList:!0,subtree:!0})),vn||(vn=!0,document.addEventListener("pointerdown",br,{capture:!0})))}function et(e){if(!(e instanceof HTMLSelectElement))return;if(!e.dataset.enhancedSelect){tt(e);return}const t=e.closest(".enhanced-select");t&&(Ht(t),at(t),Nt(t))}function tt(e){if(!(e instanceof HTMLSelectElement))return;if(e.dataset.enhancedSelect){et(e);return}if(e.multiple||e.size>1)return;const t=document.createElement("div");t.className="enhanced-select";const n=e.parentNode;n&&n.insertBefore(t,e),t.appendChild(e),e.dataset.enhancedSelect="true",e.classList.add("enhanced-select__native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const a=document.createElement("button");a.type="button",a.className="enhanced-select__trigger",a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const r=document.createElement("ul");r.className="enhanced-select__menu",r.setAttribute("role","listbox"),r.setAttribute("tabindex","-1"),t.append(a,r);const s={select:e,trigger:a,menu:r,observer:null,refreshRaf:null};U.set(t,s),a.addEventListener("click",()=>gr(t)),a.addEventListener("keydown",i=>yr(i,t)),r.addEventListener("click",i=>vr(i,t)),r.addEventListener("keydown",i=>hr(i,t)),e.addEventListener("change",()=>{at(t),Hn(t)}),s.observer=new MutationObserver(i=>{let o=!1,l=!1;for(const u of i)u.type==="attributes"&&u.attributeName==="disabled"&&(l=!0),u.type==="childList"&&(o=!0);l&&Nt(t),o&&fr(s,t)}),s.observer.observe(e,{attributes:!0,attributeFilter:["disabled"],childList:!0}),Ht(t),at(t),Nt(t)}function fr(e,t){e&&(e.refreshRaf||(e.refreshRaf=requestAnimationFrame(()=>{e.refreshRaf=null,Ht(t),at(t)})))}function Ht(e){const t=U.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const r=Array.from(n.options||[]),s=document.createDocumentFragment();r.forEach(i=>{const o=document.createElement("li");o.className="enhanced-select__option",o.textContent=i.textContent??i.value??"",o.dataset.value=i.value??"",o.setAttribute("role","option"),o.setAttribute("tabindex","-1"),i.disabled&&(o.setAttribute("aria-disabled","true"),o.classList.add("is-disabled")),i.selected&&(o.setAttribute("aria-selected","true"),o.dataset.selected="true",o.setAttribute("tabindex","0")),s.appendChild(o)}),a.innerHTML="",a.appendChild(s),Hn(e)}function at(e){const t=U.get(e);if(!t)return;const{select:n,trigger:a}=t;if(!n||!a)return;const r=n.selectedOptions?.[0]??n.options?.[n.selectedIndex],s=r?.textContent?.trim()||r?.value||"";a.textContent=s}function Hn(e){const t=U.get(e);if(!t)return;const{select:n,menu:a}=t;if(!n||!a)return;const r=n.value;a.querySelectorAll(".enhanced-select__option").forEach(i=>{const o=i.dataset.value===r;i.toggleAttribute("aria-selected",o),i.dataset.selected=o?"true":"",i.setAttribute("tabindex",o?"0":"-1")})}function Nt(e){const t=U.get(e);if(!t)return;const{select:n,trigger:a}=t,r=!!n?.disabled;e.classList.toggle("enhanced-select--disabled",r),a.disabled=r}function gr(e){U.get(e)&&(e.getAttribute("data-open")==="true"?Ie(e):Un(e))}function Un(e){const t=U.get(e);if(!t)return;W&&W!==e&&Ie(W,{focusTrigger:!1}),e.setAttribute("data-open","true"),t.trigger.setAttribute("aria-expanded","true"),W=e;const n=t.menu.querySelector('.enhanced-select__option[aria-selected="true"]')??t.menu.querySelector(".enhanced-select__option:not([aria-disabled='true'])");n?n.focus():t.menu.focus()}function Ie(e,{focusTrigger:t=!0}={}){const n=U.get(e);n&&(e.setAttribute("data-open","false"),n.trigger.setAttribute("aria-expanded","false"),t&&n.trigger.focus({preventScroll:!0}),W===e&&(W=null))}function br(e){if(!W)return;const t=e.target;t instanceof Node&&(W.contains(t)||Ie(W,{focusTrigger:!1}))}function yr(e,t){const n=e.key;n==="ArrowDown"||n==="ArrowUp"||n===" "||n==="Enter"?(e.preventDefault(),Un(t)):n==="Escape"&&Ie(t)}function hr(e,t){const n=e.key,a=U.get(t);if(!a)return;const r=Array.from(a.menu.querySelectorAll(".enhanced-select__option:not([aria-disabled='true'])"));if(!r.length)return;const s=r.findIndex(i=>i===document.activeElement);if(n==="ArrowDown"||n==="ArrowUp"){e.preventDefault();const o=(s+(n==="ArrowDown"?1:-1)+r.length)%r.length;r[o].focus()}else if(n==="Home")e.preventDefault(),r[0].focus();else if(n==="End")e.preventDefault(),r[r.length-1].focus();else if(n==="Enter"||n===" "){e.preventDefault();const i=document.activeElement;i&&i.classList.contains("enhanced-select__option")&&Vn(i,t)}else n==="Escape"&&(e.preventDefault(),Ie(t))}function vr(e,t){const n=e.target?.closest?.(".enhanced-select__option");n&&Vn(n,t)}function Vn(e,t){const n=U.get(t);if(!n||e.getAttribute("aria-disabled")==="true")return;const{select:a}=n,r=e.dataset.value??"";a.value!==r&&(a.value=r,a.dispatchEvent(new Event("change",{bubbles:!0}))),Ie(t)}const qr=new Map([["available","available"],["متاح","available"],["متوفر","available"],["جاهز","available"],["ready","available"],["reserved","reserved"],["محجوز","reserved"],["محجوزة","reserved"],["maintenance","maintenance"],["صيانة","maintenance"],["under_maintenance","maintenance"],["retired","retired"],["متوقف","retired"],["خارج الخدمة","retired"]]),Er=new Set(["maintenance","reserved","retired"]);function Sr(e){const t=String(e??"").trim().toLowerCase();return t&&qr.get(t)||"available"}function _r(e){return e?typeof e=="object"?e:Cr(e):null}function Ar(e){const t=_r(e);return t?Sr(t.status||t.state||t.statusLabel||t.status_label):"available"}function Lr(e){return!Er.has(Ar(e))}function Ni(e={}){return e.image||e.imageUrl||e.img||""}function xi(e){if(!e)return null;const t=je(e),{equipment:n=[]}=ne();return(n||[]).find(a=>je(a?.barcode)===t)||null}function Cr(e){const t=je(e);if(!t)return null;const{equipment:n=[]}=ne();return(n||[]).find(a=>je(a?.barcode)===t)||null}const Tr=ne()||{};let ee=(Tr.equipment||[]).map(Br),xt=!1,De="",oe=null,pe=null,fe=null,ut=!1,qn=!1;function Ir(e){if(!e)return null;const t=window?.bootstrap?.Modal??(typeof bootstrap<"u"?bootstrap.Modal:null);return t?t.getOrCreateInstance(e):null}function wr(){document.dispatchEvent(new CustomEvent("equipment:changed"))}function Br(e={}){return Ut({...e,subcategory:e.subcategory??e.sub??"",description:e.description??e.desc??e.name??"",quantity:e.quantity??e.qty??0,unit_price:e.unit_price??e.price??0,image_url:e.image_url??e.imageUrl??e.image??""})}function dt(e={}){return Ut(e)}function Ut(e={}){const t=e.id??e.equipment_id??e.equipmentId??e.item_id??e.itemId??null,n=e.description??e.desc??e.name??"",a=e.category??"",r=e.subcategory??e.sub??"",s=Ke(e.quantity??e.qty??0),i=mt(e.unit_price??e.price??0),o=g(String(e.barcode??"").trim()),l=N(e.status??e.state??e.status_label??e.statusLabel??"available"),u=e.image_url??e.imageUrl??e.image??"",d=e.name??e.item_name??n;return{id:$r(t)?String(t):"",category:a,sub:r,desc:n,name:d,qty:s,price:i,barcode:o,status:l,image:u,imageUrl:u,created_at:e.created_at??null,updated_at:e.updated_at??null}}function $r(e){return e!=null&&e!==""}function Ke(e){const t=Number.parseInt(e,10);return Number.isFinite(t)&&t>=0?t:0}function mt(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function Nr(e){!e||e.dataset.englishDigitsAttached||(e.addEventListener("input",()=>{const{selectionStart:t,selectionEnd:n,value:a}=e,r=g(a);if(r!==a&&(e.value=r,t!=null&&n!=null)){const s=r.length-a.length,i=t+s,o=n+s;e.setSelectionRange(i,o)}}),e.dataset.englishDigitsAttached="true")}function En(e){if(!e)return"";const t=g(String(e.barcode??"")).trim();if(t)return t;if(Array.isArray(e.variants))for(const n of e.variants){const a=g(String(n?.barcode??"")).trim();if(a)return a}return""}function xr(e,t){const n=En(e),a=En(t);if(!n&&!a)return 0;if(!n)return 1;if(!a)return-1;const r=/^[0-9]+$/,s=r.test(n),i=r.test(a);if(s&&i){if(n.length!==a.length)return n.length-a.length;const u=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(u!==0)return u}else{if(s!==i)return s?-1:1;{const u=n.localeCompare(a,"ar",{numeric:!0,sensitivity:"base"});if(u!==0)return u}}const o=rt(e?.desc||e?.description||e?.name||""),l=rt(t?.desc||t?.description||t?.name||"");return o.localeCompare(l,"ar",{sensitivity:"base"})}function _(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function N(e){switch(String(e??"").trim().toLowerCase()){case"available":case"متاح":case"متوفر":return"available";case"reserved":case"محجوز":return"reserved";case"maintenance":case"صيانة":return"maintenance";case"retired":case"متوقف":case"خارج الخدمة":return"retired";default:return"available"}}function kr(e){return N(e)}function kt(){if(!Ca())return null;const e=wa();return e?{...e}:null}function Mr(e){const t=kt();if(!t)return{active:!1};const n=Array.isArray(e?.variants)&&e.variants.length?e.variants:[e],{start:a,end:r,ignoreReservationId:s=null}=t,i=t?.mode||t?.source||"",o=[],l=new Set;if(n.forEach(m=>{const f=je(m?.barcode);!f||l.has(f)||(l.add(f),o.push({variant:m,barcode:f}))}),!o.length)return{active:!0,canSelect:!1,reason:c("reservations.toast.equipmentMissingBarcode","⚠️ هذه المعدة لا تحتوي على باركود معرف")};if(i==="package-manager"||i==="equipment-packages"){const m=Math.max(1,o.length||1);return{active:!0,canSelect:!0,barcode:o[0].barcode,availableBarcodes:o.map(({barcode:f})=>f),maxQuantity:m,reason:""}}const u=o.filter(({variant:m})=>Lr(m));if(!a||!r)return{active:!0,canSelect:!1,barcode:u[0]?.barcode||o[0].barcode,reason:c("reservations.toast.requireDatesBeforeAdd","⚠️ يرجى تحديد تاريخ ووقت البداية والنهاية قبل إضافة المعدات"),availableBarcodes:[],maxQuantity:0};const d=u.filter(({barcode:m})=>!Ia(m,a,r,s));if(d.length)return{active:!0,canSelect:!0,barcode:d[0].barcode,availableBarcodes:d.map(({barcode:m})=>m),maxQuantity:d.length};let p=c("reservations.toast.equipmentUnavailable","⚠️ هذه المعدة غير متاحة حالياً");if(u.length>0)p=c("reservations.toast.equipmentTimeConflict","⚠️ لا يمكن إضافة المعدة لأنها محجوزة في نفس الفترة الزمنية");else{const m=new Set(o.map(({variant:f})=>N(f?.status)));m.has("maintenance")?p=c("reservations.toast.equipmentMaintenance","⚠️ هذه المعدة قيد الصيانة ولا يمكن إضافتها حالياً"):m.has("reserved")?p=c("reservations.toast.equipmentReserved","⚠️ هذه المعدة محجوزة حالياً ولا يمكن إضافتها"):m.has("retired")&&(p=c("reservations.toast.equipmentRetired","⚠️ هذه المعدة خارج الخدمة حالياً"))}return{active:!0,canSelect:!1,barcode:u[0]?.barcode||o[0].barcode,reason:p,availableBarcodes:[],maxQuantity:0}}function Dr(){const e=document.querySelector('[data-tab="reservations-tab"]');e&&(e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.querySelector("#sub-tab-trigger-create-tab")?.click(),document.getElementById("equipment-barcode")?.focus()},200)}))}function Kn(){if(typeof document>"u")return;const e=document.getElementById("equipment-selection-banner"),t=document.getElementById("equipment-selection-return"),n=document.getElementById("equipment-selection-banner-title"),a=document.getElementById("equipment-selection-banner-hint");if(!e)return;const r=kt();e.hidden=!r;const s=r?.mode||r?.source||"";r&&(s==="package-manager"||s==="equipment-packages")?(n&&(n.textContent=c("equipment.packages.selection.bannerTitle","📦 اختيار معدات للحزمة")),a&&(a.textContent=c("equipment.packages.selection.bannerHint","اختر المعدات المطلوبة من البطاقات أدناه ثم اضغط على زر إنهاء الاختيار لإضافتها إلى الحزمة.")),t&&(t.textContent=c("equipment.packages.selection.doneButton","✅ إنهاء اختيار الحزمة"))):(n&&(n.textContent=c("reservations.create.equipment.selector.bannerTitle","🔗 اختيار معدات لحجز جديد")),a&&(a.textContent=c("reservations.create.equipment.selector.bannerHint","ابحث في القائمة أدناه، ثم أضف المعدات المتاحة مباشرة إلى نموذج الحجز.")),t&&(t.textContent=c("reservations.create.equipment.selector.returnButton","⬅️ العودة إلى الحجز"))),r&&t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const o=kt(),l=o?.mode||o?.source||"";l==="package-manager"||l==="equipment-packages"?cn("package-finish-button"):(cn("return-button"),Dr())}),t.dataset.listenerAttached="true")}function P(){return ee}function ge(e){ee=Array.isArray(e)?e.map(Ut):[],Ot({equipment:ee}),wr()}function rt(e){return String(e??"").trim().toLowerCase()}function te(e){if(!e)return"";const t=e.desc||e.description||e.name||"";let n=rt(t);return n||(n=rt(e.category||"")),n||(n=g(String(e.barcode||"")).trim().toLowerCase()),n}function pt(e){const t=te(e);return t?P().filter(n=>te(n)===t):[]}function ft(e){const t=document.getElementById("equipment-details-cover");if(!t)return;const n=gt(e);if(n){const a=_(e.desc||e.description||e.name||"");t.innerHTML=`<img src="${_(n)}" alt="${a}">`,t.classList.add("has-image")}else t.innerHTML='<span class="equipment-details-header__placeholder" aria-hidden="true">📦</span>',t.classList.remove("has-image")}function Vt(){return{category:document.getElementById("edit-equipment-category"),subcategory:document.getElementById("edit-equipment-subcategory"),description:document.getElementById("edit-equipment-description"),quantity:document.getElementById("edit-equipment-quantity"),price:document.getElementById("edit-equipment-price"),image:document.getElementById("edit-equipment-image"),barcode:document.getElementById("edit-equipment-barcode"),status:document.getElementById("edit-equipment-status")}}function it(){const e=Vt();return{category:e.category?.value??"",subcategory:e.subcategory?.value??"",description:e.description?.value??"",quantity:e.quantity?.value??"",price:e.price?.value??"",image:e.image?.value??"",barcode:e.barcode?.value??"",status:e.status?.value??""}}function Kt(e={}){const t=Vt();t.category&&(t.category.value=e.category??""),t.subcategory&&(t.subcategory.value=e.subcategory??""),t.description&&(t.description.value=e.description??""),t.quantity&&(t.quantity.value=e.quantity!=null?g(String(e.quantity)):""),t.price&&(t.price.value=e.price!=null?g(String(e.price)):""),t.image&&(t.image.value=e.image??""),t.barcode&&(t.barcode.value=e.barcode??""),t.status&&(t.status.value=e.status??"")}function Se(e){ut=e;const t=Vt(),n=document.getElementById("equipment-edit-cancel"),a=document.getElementById("save-equipment-changes"),r=document.getElementById("edit-equipment-form");if(r&&r.classList.toggle("equipment-details-form--editing",e),[t.category,t.subcategory,t.description,t.quantity,t.price,t.image].forEach(i=>{i&&(e?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"))}),n&&(n.hidden=!e,n.disabled=!e),a){a.disabled=!1;const i=e?"equipment.modal.actions.save":"equipment.modal.actions.edit",o=e?"💾 حفظ التعديلات":"✏️ تعديل";a.textContent=c(i,o),a.dataset.mode=e?"save":"view"}if(e){const i=t.description||t.category||t.subcategory;i&&setTimeout(()=>{i.focus(),typeof i.select=="function"&&i.select()},0)}}async function Fr(e){if(!J()){Te();return}if(!e)return;try{await Pr()}catch(n){console.error("❌ [equipment.js] Unable to load XLSX",n),alert(c("equipment.toast.xlsxMissing","⚠️ مكتبة Excel (XLSX) غير محملة."));return}const t=new FileReader;t.onload=async function(n){try{const a=new Uint8Array(n.target.result),r=XLSX.read(a,{type:"array"}),s=r.Sheets[r.SheetNames[0]],i=XLSX.utils.sheet_to_json(s,{defval:""});if(!Array.isArray(i)||i.length===0){h(c("equipment.toast.uploadEmpty","⚠️ لم يتم العثور على بيانات في الملف"));return}const o=[];let l=0;if(i.forEach(u=>{const d=u.القسم??u.category??"",p=u["القسم الثانوي"]??u.subcategory??"",m=u.الوصف??u.description??u.name??"",f=u.الكمية??u.quantity??0,b=u.السعر??u.price??0,y=u.الباركود??u.barcode??"",v=u.الحالة??u.status??"متاح",L=u.الصورة??u.image_url??u.image??"",C=g(String(y||"")).trim();if(!m||!C){l+=1;return}o.push(Qt({category:d,subcategory:p,description:m,quantity:f,unit_price:b,barcode:C,status:v,image_url:L}))}),!o.length){h(c("equipment.toast.uploadEmpty","⚠️ لم يتم العثور على بيانات في الملف"));return}try{const u=await I("/equipment/?bulk=1",{method:"POST",body:o}),d=Array.isArray(u?.data)?u.data.map(dt):[];if(d.length){const f=[...P(),...d];ge(f)}await we({showToastOnError:!1}),x();const p=u?.meta?.count??d.length,m=[];p&&m.push(`${p} ✔️`),l&&m.push(`${l} ⚠️`),h(c("equipment.toast.uploadSuccess","✅ تم رفع المعدات بنجاح")+(m.length?` (${m.join(" / ")})`:""))}catch(u){const d=Be(u,"equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل");h(d,"error")}}catch(a){console.error("❌ [equipment.js] Failed to process Excel file",a),h(c("equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل"),"error")}},t.onerror=function(){console.error("❌ [equipment.js] FileReader error",t.error),h(c("equipment.toast.uploadFailed","❌ حدث خطأ أثناء قراءة ملف الإكسل"),"error")},t.readAsArrayBuffer(e)}const Rr="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";let xe=null;function Pr(){return typeof XLSX<"u"?Promise.resolve():typeof window>"u"||typeof document>"u"?Promise.reject(new Error("XLSX library is not available in this environment")):xe||(xe=new Promise((e,t)=>{const n=document.querySelector('script[data-xlsx-loader="true"]');if(n){n.addEventListener("load",r,{once:!0}),n.addEventListener("error",s,{once:!0});return}const a=document.createElement("script");a.src=Rr,a.async=!0,a.defer=!0,a.dataset.xlsxLoader="true",a.addEventListener("load",r,{once:!0}),a.addEventListener("error",s,{once:!0}),document.head.appendChild(a);function r(){if(typeof XLSX>"u"){t(new Error("XLSX did not load correctly"));return}e()}function s(){t(new Error("Failed to load XLSX library"))}}).catch(e=>{throw console.warn("⚠️ [equipment.js] ensureXLSXLoaded failed",e),xe=null,e}),xe)}function Qt({category:e="",subcategory:t="",description:n="",quantity:a=0,unit_price:r=0,barcode:s="",status:i="متاح",image_url:o=""}){const l=g(String(s||"")).trim(),u=kr(i);return{category:e?.trim()||null,subcategory:t?.trim()||null,name:n?.trim()||null,description:n?.trim()||null,quantity:Ke(a),unit_price:mt(r),barcode:l,status:u,image_url:o?.trim()||null}}async function Qn(){if(!J()){Te();return}if(confirm(c("equipment.toast.clearConfirm","⚠️ هل أنت متأكد من حذف كل المعدات؟")))try{const t=(await I("/equipment/?all=1",{method:"DELETE"}))?.meta?.deleted??0;await we({showToastOnError:!1}),h(c("equipment.toast.clearSuccess","🗑️ تم مسح جميع المعدات")+(t?` (${t})`:""))}catch(e){const t=Be(e,"equipment.toast.clearFailed","⚠️ تعذر حذف بعض المعدات");h(t,"error")}}function gt(e){return e.image||e.imageUrl||e.img||""}function jr(e){const t=N(e),n={available:{label:c("equipment.form.options.available","✅ متاح"),className:"equipment-status-badge equipment-status-badge--available"},reserved:{label:c("equipment.form.options.booked","📌 محجوز"),className:"equipment-status-badge equipment-status-badge--reserved"},maintenance:{label:c("equipment.form.options.maintenance","🛠️ صيانة"),className:"equipment-status-badge equipment-status-badge--maintenance"},retired:{label:c("equipment.form.options.retired","📦 خارج الخدمة"),className:"equipment-status-badge equipment-status-badge--retired"}},{label:a,className:r}=n[t]||{label:e||"-",className:"equipment-status-badge equipment-status-badge--default"};return`<span class="${r}">${a}</span>`}function st(){const e=document.getElementById("equipment-variants-section"),t=document.getElementById("equipment-variants-table-body"),n=document.getElementById("equipment-variants-count");if(e&&(e.hidden=!0),t){const a=c("equipment.modal.variants.empty","لا توجد قطع مرتبطة أخرى.");t.innerHTML=`<tr><td colspan="4" class="text-center text-muted">${_(a)}</td></tr>`}n&&(n.textContent="0")}function Xn(e){const t=document.getElementById("equipment-variants-section"),n=document.getElementById("equipment-variants-table-body"),a=document.getElementById("equipment-variants-count");if(!t||!n||!e)return;const s=oe?.groupKey||te(e);if(!s){st();return}const i=P().filter(p=>te(p)===s).sort((p,m)=>{const f=String(p.barcode||"").trim(),b=String(m.barcode||"").trim();return!f&&!b?0:f?b?f.localeCompare(b,"ar",{numeric:!0,sensitivity:"base"}):-1:1});if(!i.length){st();return}t.hidden=!1,a&&(a.textContent=String(i.length));const o=c("equipment.modal.variants.current","الحالي"),l=c("equipment.form.labels.quantity","الكمية"),u=P(),d=i.map(p=>{const m=p.id&&e.id?String(p.id)===String(e.id):String(p.barcode||"")===String(e.barcode||""),f=m?"equipment-variants-table__row--current":"",b=_(String(p.barcode||"-")),y=m?`<span class="equipment-variants-current-badge">${_(o)}</span>`:"",v=g(String(Number.isFinite(Number(p.qty))?Number(p.qty):0)),L=u.indexOf(p),C=_(c("equipment.item.actions.delete","🗑️ حذف")),D=L>=0?`<div class="table-action-buttons equipment-variant-actions">
            <button type="button" class="btn btn-sm btn-error equipment-variant-action equipment-variant-action--danger" data-variant-action="delete" data-variant-index="${L}">${C}</button>
          </div>`:"";return`
        <tr class="${f}">
          <td>
            ${b}
            ${y}
          </td>
          <td>${jr(p.status)}</td>
          <td>
            <span class="equipment-variants-qty" title="${_(l)}">${v}</span>
          </td>
          <td class="table-actions-cell">${D}</td>
        </tr>
      `}).join("");n.innerHTML=d}function Or({item:e,index:t}){const n=gt(e),a=c("equipment.item.actions.delete","🗑️ حذف"),r=c("equipment.item.imageAlt","صورة"),s=c("equipment.item.currency","SR"),i=J(),o={description:c("equipment.card.labels.description","الوصف"),status:c("equipment.card.labels.status","الحالة"),alias:c("equipment.card.labels.alias","الاسم"),quantity:c("equipment.card.labels.quantity","الكمية"),price:c("equipment.card.labels.price","السعر"),category:c("equipment.card.labels.category","القسم"),subcategory:c("equipment.card.labels.subcategory","القسم الثانوي"),barcode:c("equipment.card.labels.barcode","الباركود"),available:c("equipment.card.labels.available","متاح")},l=Number.isFinite(Number(e.qty))?Number(e.qty):0,u=Number.isFinite(Number(e.price))?Number(e.price):0,d=l.toLocaleString("en-US"),p=u.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),m=Number.isFinite(Number(e.reservedQty))?Number(e.reservedQty):0,f=Number.isFinite(Number(e.maintenanceQty))?Number(e.maintenanceQty):0,b=Number.isFinite(Number(e.availableQty))?Number(e.availableQty):Math.max(l-m-f,0),y=b.toLocaleString("en-US"),v=c("equipment.card.labels.availableOfTotal","من أصل"),L=N(e.status);let C=`${_(o.available)}: ${_(y)} ${_(v)} ${_(d)}`,D="available";if(b===0){const X={reserved:{text:l===1?c("equipment.card.availability.reservedSingle","مؤجرة"):c("equipment.card.availability.reserved","مؤجرة بالكامل"),modifier:"reserved"},maintenance:{text:c("equipment.card.availability.maintenance","تحت الصيانة"),modifier:"maintenance"},retired:{text:c("equipment.card.availability.retired","غير متاحة"),modifier:"retired"},default:{text:c("equipment.card.availability.unavailable","غير متاحة حالياً"),modifier:"unavailable"}},F=X[L]||X.default;C=_(F.text),D=F.modifier}const E=`<span class="equipment-card__availability equipment-card__availability--${D}">${C}</span>`,V="",K=e.desc||e.name||"—",w=e.name&&e.name!==e.desc?e.name:"",ye=`
    <div class="equipment-card__info-row equipment-card__info-row--center">
      ${[{label:o.quantity,value:d},{label:o.price,value:`${p} ${s}`}].map(({label:X,value:F})=>`
            <span class="equipment-card__info-item equipment-card__info-item--stacked">
              <span class="equipment-card__detail-label">${X}</span>
              <span class="equipment-card__detail-value">${F}</span>
            </span>
          `).join("")}
    </div>`,re=[e.category?{label:o.category,value:e.category}:null,e.sub?{label:o.subcategory,value:e.sub}:null].filter(Boolean),ht=re.length?`<div class="equipment-card__categories">${re.map(({label:X,value:F})=>`
            <div class="equipment-card__category">
              <span class="equipment-card__detail-label">${X}</span>
              <span class="equipment-card__detail-value">${F}</span>
            </div>
          `).join("")}</div>`:"",Ge=w?`<div class="equipment-card__alias">
        <span class="equipment-card__detail-label">${o.alias}</span>
        <span class="equipment-card__detail-value">${w}</span>
      </div>`:"",vt=`
    <div class="equipment-card__details">
      ${`
    <div class="equipment-card__description">
      <span class="equipment-card__label">${o.description}</span>
      <h3 class="equipment-card__title">${K}</h3>
    </div>
  `}
      ${ye}
    </div>
  `,Q=[],B=Mr(e),an=B?.availableBarcodes?.length?B.availableBarcodes.join(","):B?.barcode?B.barcode:"";let qt="",Et="";if(B.active){const X=`equipment-select-qty-${t}`,F=!!B.canSelect,St=F?Math.max(1,Number(B.maxQuantity||B.availableBarcodes?.length||1)):1,ha=Math.max(1,Math.min(St,99)),sn=[];for(let $e=1;$e<=ha;$e+=1){const Aa=g(String($e));sn.push(`<option value="${$e}"${$e===1?" selected":""}>${Aa}</option>`)}const va=F?"":" disabled",qa=c("reservations.create.equipment.selector.quantityLabel","الكمية"),on=F?`${c("reservations.create.equipment.selector.availableHint","الوحدات المتاحة")}: ${g(String(St))}`:B.reason?B.reason:"";qt=`
      <div class="equipment-card__selection-controls">
        <label class="equipment-card__selection-label" for="${X}">${qa}</label>
        <select class="equipment-card__quantity-select" id="${X}" data-equipment-select-quantity${va}>
          ${sn.join("")}
        </select>
        ${on?`<span class="equipment-card__selection-hint">${_(on)}</span>`:""}
      </div>
    `;const Ea=c("reservations.create.equipment.selector.addToReservation","➕ أضف إلى الحجز"),Sa=F?"":" disabled",_a=B.reason?` title="${_(B.reason)}"`:"",_t=['data-equipment-action="select-reservation"',`data-selection-max="${F?St:0}"`];an&&_t.push(`data-selection-barcodes="${_(an)}"`),e.groupKey&&_t.push(`data-selection-group="${_(String(e.groupKey))}"`),Et=`
      <button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--select" ${_t.join(" ")}${Sa}${_a}>${Ea}</button>
    `}i&&Q.push(`<button type="button" class="btn btn-sm equipment-card__action-btn equipment-card__action-btn--delete" data-equipment-action="delete" data-equipment-index="${t}">${a}</button>`);const rn=Q.length?Q.join(`
`):"",ya=_(K);return`
    <article
      class="equipment-card"
      data-equipment-index="${t}"
      ${e.groupKey?`data-equipment-group-key="${_(String(e.groupKey))}"`:""}
      data-equipment-card="true"
      role="listitem"
      tabindex="0"
      aria-label="${ya}"
    >
      <div class="equipment-card__header">
      <div class="equipment-card__status-block">
        ${V}
        ${E}
      </div>
        <div class="equipment-card__media-wrapper">
          <div class="equipment-card__media" aria-hidden="true">
            ${n?`<img src="${n}" alt="${r}" loading="lazy">`:'<div class="equipment-card__placeholder">📦</div>'}
          </div>
          ${vt}
        </div>
      </div>
      <div class="equipment-card__body">
        ${ht}
        ${Ge}
      </div>
      ${qt||Et||rn?`<div class="equipment-card__actions equipment-card__actions--center">
            ${qt}
            ${Et}
            ${rn}
          </div>`:""}
    </article>
  `}function zr(e){const t=[...new Set(e.map(i=>i.category).filter(Boolean))],n=[...new Set(e.map(i=>i.sub).filter(Boolean))],a=document.getElementById("filter-category"),r=document.getElementById("filter-sub");if(a){const i=a.value;for(;a.options.length>1;)a.remove(1);t.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=o,a.appendChild(l)}),t.includes(i)&&(a.value=i),et(a)}if(r){const i=r.value;for(;r.options.length>1;)r.remove(1);n.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=o,r.appendChild(l)}),n.includes(i)&&(r.value=i),et(r)}const s=document.getElementById("filter-status");s&&et(s)}function Gn(){const e=ne();let{equipment:t=[],reservations:n=[],maintenance:a=[]}=e;if(!Array.isArray(t)||t.length===0)return ee=t||[],ee;const r=new Date;let s=!1;const i=new Set((a||[]).filter(l=>l?.status==="open").map(l=>g(String(l?.equipmentBarcode??"")).trim().toLowerCase())),o=t.map(l=>{if(!l)return l;const u=N(l.status),d=g(String(l.barcode??"")).trim().toLowerCase(),p=d&&i.has(d);let m=p?"maintenance":"available";if(!p&&d)for(const f of n||[]){if(!Hr(f,r))continue;if(f.items?.some(y=>g(String(y?.barcode??"")).trim().toLowerCase()===d)){m="reserved";break}}return m!==u?(s=!0,{...l,status:m}):{...l,status:m}});return s?ge(o):(ee=o,Ot({equipment:ee})),ee}function Hr(e,t){if(!e?.start||!e?.end)return!1;const n=new Date(e.start),a=new Date(e.end);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?!1:n<=t&&t<a}function wt(e,{tone:t="",icon:n="📦"}={}){const a=["equipment-empty-state"];return t&&a.push(`equipment-empty-state--${t}`),`
    <div class="${a.join(" ")}">
      <div class="equipment-empty-state__icon" aria-hidden="true">${n}</div>
      <p class="equipment-empty-state__text">${e}</p>
    </div>
  `}function x(){const e=document.getElementById("equipment-list");if(!e)return;Kn();const t=Gn(),n=Array.isArray(t)?t:P(),a=new Map;n.forEach(y=>{if(!y)return;const v=te(y);v&&(a.has(v)||a.set(v,[]),a.get(v).push(y))});const r=Array.from(a.values()).map(y=>{const v=y[0],L=y.reduce((w,O)=>w+(Number.isFinite(Number(O.qty))?Number(O.qty):0),0),C=["maintenance","reserved","available","retired"],D=y.map(w=>N(w.status)).sort((w,O)=>C.indexOf(w)-C.indexOf(O))[0]||"available",E=y.reduce((w,O)=>{const ye=Ke(O?.qty??0)||0,re=N(O?.status);return re==="reserved"?w.reserved+=ye:re==="maintenance"&&(w.maintenance+=ye),w},{reserved:0,maintenance:0}),V=Math.max(L-E.reserved-E.maintenance,0);return{item:{...v,qty:L,status:D,variants:y,groupKey:te(v),reservedQty:E.reserved,maintenanceQty:E.maintenance,availableQty:V},index:n.indexOf(v)}});r.sort((y,v)=>xr(y.item,v.item));const s=document.getElementById("search-equipment")?.value||"",i=g(s).toLowerCase().trim(),o=document.getElementById("filter-category")?.value||"",l=document.getElementById("filter-sub")?.value||"",u=document.getElementById("filter-status")?.value||"",d=u?N(u):"";if(xt&&!n.length){e.innerHTML=wt(c("equipment.list.loading","⏳ جاري تحميل المعدات..."),{icon:"⏳"});return}if(De&&!n.length){e.innerHTML=wt(De,{tone:"error",icon:"⚠️"});return}const p=r.filter(({item:y})=>{const v=g(String(y.barcode??"")).toLowerCase().trim(),L=Array.isArray(y.variants)?y.variants.map(K=>g(String(K.barcode??"")).toLowerCase().trim()).filter(Boolean):[],C=!i||y.name&&y.name.toLowerCase().includes(i)||y.desc&&y.desc.toLowerCase().includes(i)||v&&v.includes(i)||L.some(K=>K.includes(i))||y.category&&y.category.toLowerCase().includes(i)||y.sub&&y.sub.toLowerCase().includes(i),D=!o||y.category===o,E=!l||y.sub===l,V=!d||N(y.status)===d;return C&&D&&E&&V}),m=i?c("equipment.list.emptyFiltered","⚠️ لا توجد معدات مطابقة."):c("equipment.list.empty","لا توجد معدات مسجلة بعد."),f=p;e.innerHTML=f.length?f.map(Or).join(""):wt(m);const b=document.getElementById("equipment-list-count");if(b){const y=c("equipment.list.countSuffix","عنصر"),v=g(String(f.length)),L=f.length?`${v} ${y}`:`0 ${y}`;b.textContent=L}zr(n)}async function we({showToastOnError:e=!0}={}){xt=!0,De="",x();try{const t=await I("/equipment/?all=1"),n=t?.data??t;let a=[];Array.isArray(n)?a=n:n&&typeof n=="object"&&(Array.isArray(n.items)?a=n.items:Array.isArray(n.results)?a=n.results:Array.isArray(n.data)?a=n.data:Array.isArray(n.records)&&(a=n.records));const r=a.map(dt);ge(r)}catch(t){De=Be(t,"equipment.toast.fetchFailed","تعذر تحميل قائمة المعدات"),e&&h(De,"error")}finally{xt=!1,x()}}function Be(e,t,n){if(e instanceof H){const a=e.payload?.errors;if(a&&typeof a=="object"){const r=Object.values(a)[0];if(Array.isArray(r))return r[0];if(typeof r=="string")return r}if(e.message)return e.message}return c(t,n)}async function Ur(e){e.preventDefault();const t=e.target,n=t.querySelector("#new-equipment-desc")?.value?.trim()||"",a=t.querySelector("#new-equipment-barcode")?.value||"",r=g(a).trim(),s=mt(t.querySelector("#new-equipment-price")?.value||"0"),i=Ke(t.querySelector("#new-equipment-qty")?.value||"1"),o=t.querySelector("#new-equipment-image")?.value?.trim()||"",l=t.querySelector("#new-equipment-category")?.value?.trim()||"",u=t.querySelector("#new-equipment-sub")?.value?.trim()||"",d=t.querySelector("#new-equipment-status")?.value||"متاح";if(!n||!r){h(c("equipment.toast.missingFields","⚠️ يرجى إدخال الوصف والباركود"));return}const p=Qt({category:l,subcategory:u,description:n,quantity:i,unit_price:s,barcode:r,status:d,image_url:o});try{const m=await I("/equipment/",{method:"POST",body:p}),f=dt(m?.data),b=[...P(),f];ge(b),x(),t.reset();const y=t.querySelector("#new-equipment-status");y&&(y.value="متاح"),h(c("equipment.toast.addSuccess","✅ تم إضافة المعدة"))}catch(m){const f=Be(m,"equipment.toast.addFailed","تعذر إضافة المعدة");h(f,"error")}}async function Wn(e){if(!J()){Te();return}const t=P(),n=t[e];if(n&&confirm(c("equipment.toast.deleteConfirm","❌ هل أنت متأكد من حذف هذه المعدة؟")))try{n.id&&await I(`/equipment/?id=${encodeURIComponent(n.id)}`,{method:"DELETE"});const a=[...t];a.splice(e,1),ge(a),x(),h(c("equipment.toast.deleteSuccess","🗑️ تم حذف المعدة"))}catch(a){const r=Be(a,"equipment.toast.deleteFailed","تعذر حذف المعدة، يرجى المحاولة مجدداً");h(r,"error")}}async function Vr(e,t){const n=P(),a=n[e];if(!a)throw new Error("Equipment item not found");if(!a.id){const s=[...n];s[e]={...s[e],...t},ge(s),x();return}const r=Qt({category:t.category,subcategory:t.sub,description:t.desc,quantity:t.qty,unit_price:t.price,barcode:t.barcode,status:t.status,image_url:t.image});try{const s=await I(`/equipment/?id=${encodeURIComponent(a.id)}`,{method:"PATCH",body:r}),i=dt(s?.data),o=[...n];o[e]=i,ge(o),x(),h(c("equipment.toast.updateSuccess","✅ تم تحديث بيانات المعدة بنجاح"))}catch(s){const i=Be(s,"equipment.toast.updateFailed","تعذر تحديث بيانات المعدة");throw h(i,"error"),s}}function Ze(){x()}function Yn(e){const n=P()[e];if(!n)return;pe=e;const a=pt(n),r=a[0]||n,s=a.reduce((l,u)=>l+(Number.isFinite(Number(u.qty))?Number(u.qty):0),0),i=["maintenance","reserved","available","retired"],o=a.map(l=>N(l.status)).sort((l,u)=>i.indexOf(l)-i.indexOf(u))[0]||N(r.status);document.getElementById("edit-equipment-index").value=e,Kt({category:r.category||"",subcategory:r.sub||"",description:r.desc||r.description||"",quantity:String(s||r.qty||0),price:r.price!=null?String(r.price):"0",image:gt(r)||"",barcode:r.barcode||"",status:r.status||o}),Se(!1),fe=it(),ft(r),Xn(r),oe={groupKey:te(r),barcode:String(r.barcode||""),id:r.id||null},Ir(document.getElementById("editEquipmentModal"))?.show()}function Kr(e){const t=e.target.closest('[data-equipment-action="select-reservation"]');if(t){e.preventDefault(),e.stopPropagation();const r=t.closest('[data-equipment-card="true"]'),s=r?.querySelector("[data-equipment-select-quantity]");let i=Number.parseInt(s?.value||"1",10);(!Number.isFinite(i)||i<=0)&&(i=1);const o=Number.parseInt(t.dataset.selectionMax||"0",10);Number.isFinite(o)&&o>0&&i>o&&(i=o);const u=(t.dataset.selectionBarcodes||"").split(",").map(f=>f.trim()).filter(f=>f.length>0),d=r?.querySelector(".equipment-card__title")?.textContent?.trim()||"",p=r?.dataset.equipmentGroupKey||t.dataset.selectionGroup||"";Ta({barcodes:u,quantity:i,groupKey:p,description:d})||h(c("reservations.create.equipment.selector.selectionInactive","⚠️ يرجى العودة إلى نموذج الحجز وتفعيل اختيار المعدات من جديد"));return}if(e.target.closest("[data-equipment-select-quantity]")||e.target.closest(".equipment-card__selection-controls"))return;const n=e.target.closest('[data-equipment-action="delete"]');if(n){e.preventDefault(),e.stopPropagation();const r=Number(n.dataset.equipmentIndex);Number.isNaN(r)||Wn(r).catch(s=>{console.error("❌ [equipment.js] deleteEquipment",s)});return}const a=e.target.closest('[data-equipment-card="true"]');if(a){const r=Number(a.dataset.equipmentIndex);Number.isNaN(r)||Yn(r)}}function Qr(e){if(e.defaultPrevented||e.target.closest("[data-equipment-action]")||e.target.matches("[data-equipment-select-quantity]")||e.target.closest(".equipment-card__selection-controls"))return;const t=e.target.closest('[data-equipment-card="true"]');if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const n=Number(t.dataset.equipmentIndex);Number.isNaN(n)||Yn(n)}}function Xr(e){const t=e.target.closest('[data-variant-action="delete"]');if(t){const n=Number(t.dataset.variantIndex);Number.isNaN(n)||Wn(n).catch(a=>{console.error("❌ [equipment.js] deleteEquipment",a)});return}}function Jn(){if(!oe||!document.getElementById("editEquipmentModal")?.classList.contains("show"))return;const n=P(),a=oe.id?n.find(l=>String(l.id)===String(oe.id)):null,r=oe.groupKey,s=r?n.find(l=>te(l)===r):null,i=a||s;if(!i){st();return}const o=n.findIndex(l=>l===i);if(o>=0){const l=document.getElementById("edit-equipment-index");l&&(l.value=String(o)),pe=o}if(Xn(i),!ut){const l=pt(i),u=l[0]||i,d=l.reduce((f,b)=>f+(Number.isFinite(Number(b.qty))?Number(b.qty):0),0),p=["maintenance","reserved","available","retired"],m=l.map(f=>N(f.status)).sort((f,b)=>p.indexOf(f)-p.indexOf(b))[0]||N(u.status);Kt({category:u.category||"",subcategory:u.sub||"",description:u.desc||u.description||"",quantity:String(d||u.qty||0),price:u.price!=null?String(u.price):"0",image:gt(u)||"",barcode:u.barcode||"",status:u.status||m}),fe=it()}ft(primary)}function Gr(){document.getElementById("search-equipment")?.addEventListener("input",Ze),document.getElementById("filter-category")?.addEventListener("change",Ze),document.getElementById("filter-sub")?.addEventListener("change",Ze),document.getElementById("filter-status")?.addEventListener("change",Ze),document.getElementById("add-equipment-form")?.addEventListener("submit",Ur);const e=document.getElementById("equipment-clear-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",a=>{a.preventDefault(),Qn().catch(r=>{console.error("❌ [equipment.js] clearEquipment",r)})}),e.dataset.listenerAttached="true");const t=document.getElementById("equipment-list");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",Kr),t.addEventListener("keydown",Qr),t.dataset.listenerAttached="true");const n=document.getElementById("equipment-variants-table-body");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Xr),n.dataset.listenerAttached="true"),["edit-equipment-quantity","edit-equipment-price","edit-equipment-barcode"].forEach(a=>{const r=document.getElementById(a);Nr(r)})}document.getElementById("save-equipment-changes")?.addEventListener("click",async()=>{if(!ut){fe=it(),Se(!0);return}const e=document.getElementById("edit-equipment-index").value,t=Number.parseInt(e,10);if(Number.isNaN(t)){h(c("equipment.toast.updateFailed","تعذر تحديث بيانات المعدة"),"error");return}const n={category:document.getElementById("edit-equipment-category").value,sub:document.getElementById("edit-equipment-subcategory").value,desc:document.getElementById("edit-equipment-description").value,qty:Ke(document.getElementById("edit-equipment-quantity").value)||1,price:mt(document.getElementById("edit-equipment-price").value)||0,barcode:g(document.getElementById("edit-equipment-barcode").value).trim(),status:document.getElementById("edit-equipment-status").value,image:document.getElementById("edit-equipment-image").value};try{await Vr(t,n),fe=it(),Se(!1),Jn()}catch(a){console.error("❌ [equipment.js] editEquipment",a)}});document.addEventListener("DOMContentLoaded",()=>{Gr(),x(),we();const e=document.getElementById("equipment-edit-cancel");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{if(fe&&Kt(fe),pe!=null){const a=P()[pe];if(a){const s=pt(a)[0]||a;ft(s)}}Se(!1)}),e.dataset.listenerAttached="true");const t=document.getElementById("save-equipment-changes");t&&!t.dataset.listenerAttached&&(t.dataset.listenerAttached="true",t.dataset.mode||(t.dataset.mode="view"))});document.addEventListener("language:changed",()=>{if(x(),Se(ut),pe!=null){const t=P()[pe];if(t){const a=pt(t)[0]||t;ft(a)}}});document.addEventListener("equipment:refreshRequested",()=>{we({showToastOnError:!1})});document.addEventListener(zt.USER_UPDATED,()=>{x()});document.addEventListener("equipment:changed",()=>{Jn()});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editEquipmentModal");e&&!e.dataset.variantsListenerAttached&&(e.addEventListener("hidden.bs.modal",()=>{oe=null,st(),pe=null,fe=null,Se(!1)}),e.dataset.variantsListenerAttached="true")});typeof document<"u"&&!qn&&(document.addEventListener(La.change,()=>{Kn(),x()}),qn=!0);const ki=Object.freeze(Object.defineProperty({__proto__:null,clearEquipment:Qn,refreshEquipmentFromApi:we,renderEquipment:x,syncEquipmentStatuses:Gn,uploadEquipmentFromExcel:Fr},Symbol.toStringTag,{value:"Module"})),Wr=ne()||{};let ue=(Wr.maintenance||[]).map(Xt);function Qe(){return ue}function Xe(e){return ue=Array.isArray(e)?e.map(Xt):[],Ot({maintenance:ue}),ni(),ue}async function Zn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&t.set(o,String(l))});const n=t.toString(),a=await I(`/maintenance/${n?`?${n}`:""}`),r=a?.data??a;let s=[];Array.isArray(r)?s=r:r&&typeof r=="object"&&(Array.isArray(r.items)?s=r.items:Array.isArray(r.results)?s=r.results:Array.isArray(r.data)?s=r.data:Array.isArray(r.records)&&(s=r.records));const i=s.map(bt);return Xe(i)}async function ea(e){const t=await I("/maintenance/",{method:"POST",body:e}),n=bt(t?.data??{});return Xe([n,...ue.filter(a=>a.id!==n.id)]),n}async function ta(e,t){const n=await I(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=bt(n?.data??{});return Xe(ue.map(r=>String(r.id)===String(e)?a:r)),a}async function na(e){await I(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Xe(ue.filter(t=>String(t.id)!==String(e)))}function aa({equipmentId:e,technicianId:t,issue:n,priority:a,status:r,scheduledAt:s,resolutionReport:i}){return{equipment_id:e,technician_id:t||null,maintenance_type:null,priority:a??"medium",reported_at:null,scheduled_at:s||null,status:r??"open",notes:n??"",resolution_report:i??null,repair_cost:null}}function bt(e={}){return ra({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function Xt(e={}){return ra(e)}function ra(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Jr(e.status_raw??e.status??"open"),r=Zr(a),s=ti(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:ei(e.priority??"medium"),status:r,statusRaw:a,statusLabel:s,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:Yr(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function Yr(e){if(e==null||e==="")return null;const t=Number.parseFloat(g(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function Jr(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Zr(e){const t=Gt(e);return["completed","cancelled"].includes(t)?"closed":"open"}function ei(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function ti(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,r=>r.toUpperCase())}function Gt(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function ni(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function _e(e){return e instanceof H}const Mi=Object.freeze(Object.defineProperty({__proto__:null,buildMaintenancePayload:aa,categorizeMaintenanceStatus:Gt,createMaintenanceRequest:ea,deleteMaintenanceRequest:na,getMaintenanceState:Qe,isApiError:_e,mapLegacyMaintenanceTicket:Xt,mapMaintenanceFromApi:bt,refreshMaintenanceFromApi:Zn,setMaintenanceState:Xe,updateMaintenanceRequest:ta},Symbol.toStringTag,{value:"Module"}));function Mt(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getFullYear()).slice(-2);return`${n}/${a}/${r}`}let be=Qe(),de=[],Fe=null,qe=!1,Re="",Ae=be.length>0,j={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},Wt=null,T=null,S=null,k=null,Le=null,Pe=null,Ce=null,A=null;async function He({showToastOnError:e=!0}={}){if(!qe){qe=!0,Re="",R();try{await Zn(),Ae=!0}catch(t){Ae=be.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),Re=_e(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&h(Re,"error")}finally{qe=!1,be=Qe(),R()}}}function Dt(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function Y(e){return g(String(e||"")).trim().toLowerCase()}function Yt(e=""){return g(String(e)).trim().toLowerCase()}function ai(e={}){const t=String(e?.desc??"").trim(),n=g(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function ri(e){const t=g(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function ot(e){return g(String(e||"")).trim().toLowerCase()}function q(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ii(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function ae(){return be=Qe(),be}function ia(e){return ae().find(n=>Number(n.id)===Number(e))||null}function sa(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function Jt(){const{equipment:e=[]}=ne(),t=c("maintenance.table.noName","بدون اسم");return de=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),r=Y(a),s=Number.parseInt(n?.qty??n?.quantity??0,10),i=Number.isFinite(s)?Math.max(s,0):1,o=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"متاح",u=n?.desc||n?.description||n?.name||t,d=ai({desc:u,displayBarcode:a,barcode:r});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:r,displayBarcode:a,desc:u,status:l,statusNormalized:sa(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:i,image:o,searchValue:d,searchValueNormalized:ot(d),descriptionNormalized:Yt(u)}}),de.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),de}function Zt(){const e=new Set,t=new Map;return ae().filter(n=>n.status==="open").forEach(n=>{const a=Y(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function oa(e){const t=Y(e);if(!t)return 0;const{map:n}=Zt();return n.get(t)||0}function yt(e){const t=Y(e);return t&&(de.length?de:Jt()).find(a=>a.barcode===t)||null}function si(e){const t=de.length?de:Jt();if(!t.length)return null;const n=ot(e);if(n){const o=t.find(l=>l.searchValueNormalized===n);if(o)return o}const{description:a,barcode:r}=ri(e);if(r){const o=Y(r);if(o){const l=t.find(u=>u.barcode===o);if(l)return l}}const s=Yt(a||e);if(!s)return null;const i=t.find(o=>o.descriptionNormalized===s);return i||t.find(o=>o.descriptionNormalized.includes(s))||null}function Ft(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,s=(t||Zt().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||s>=1:s>=a}function se({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search"),s=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),r&&(r.value="")),s&&(s.textContent=Dt(),s.classList.remove("maintenance-selected-info--has-selection")),Fe=null}function ca(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر"),r=c("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),s=c("maintenance.info.categoryLabel","القسم"),i=e.displayBarcode||e.barcode||a,o=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,u=oa(o),d=Math.max(l-u,0),p=e.category?`
    <div class="maintenance-selected-info__meta">${s}: <strong>${q(e.category)}</strong></div>
  `:"",m=l>0?`
    <div class="maintenance-selected-info__meta">
      ${r}: <strong>${d}</strong> / ${l}
    </div>
  `:"",f=e.image?`<img class="maintenance-selected-info__image" src="${q(e.image)}" alt="${q(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${f}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${q(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${q(i)}</strong></div>
      ${m}
      ${p}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function en(e,{silent:t=!1}={}){if(!e)return!1;if(Ft(e))return t||h(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),r&&(r.value=e.searchValue||e.desc),ca(e),Fe=e,!0}function la(e,{showFeedback:t=!0}={}){const n=yt(e);return n?en(n,{silent:!t}):(t&&h(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function ua(e,{showFeedback:t=!0}={}){const n=si(e);return n?en(n,{silent:!t}):(t&&h(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function tn(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=Jt(),{map:r}=Zt();e&&(e.innerHTML=a.map(i=>`<option value="${q(i.searchValue||i.desc)}"></option>`).join(""));const s=document.getElementById("maintenance-selected-barcode");if(s&&s.value){const i=yt(s.value);!i||Ft(i,r)?(se({keepInputs:!0,silent:!0}),i&&Ft(i,r)&&h(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):en(i,{silent:!0})}else se({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),la(t.value)||se({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const i=()=>{if(!n.value){se({keepInputs:!0,silent:!0});return}ua(n.value)||se({keepInputs:!0,silent:!0})};n.addEventListener("change",i),n.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),i())}),n.dataset.listenerAttached="true"}}async function ct(){try{await we({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{x(),tn()}}function da(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;Wt=t.Modal.getOrCreateInstance(e),T||(T=e.querySelector("#maintenance-close-report")),S||(S=e.querySelector("#maintenance-close-cost")),S&&S.dataset.normalizeAttached!=="true"&&(S.addEventListener("input",a=>{oi(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),S.dataset.normalizeAttached="true"),k||(k=e.querySelector("#maintenance-close-submit")),Le||(Le=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",li),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",ma),e.dataset.listenerAttached="true"),!0}function ma(){j={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},T&&(T.value="",T.classList.remove("is-invalid")),S&&(S.value="",S.classList.remove("is-invalid")),Le&&(Le.innerHTML=""),Ue(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),n&&(n.textContent=c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.")),k&&(k.textContent=c("maintenance.closeModal.confirm","إغلاق التذكرة"))}}function pa(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(Pe=t.Modal.getOrCreateInstance(e),Ce||(Ce=e.querySelector("#maintenance-report-modal-content")),A||(A=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",fa),e.dataset.listenerAttached="true"),A&&A.dataset.listenerAttached!=="true"&&(A.addEventListener("click",gi),A.dataset.listenerAttached="true"),!0):!1}function fa(){Ce&&(Ce.innerHTML=""),A&&(A.hidden=!0,A.disabled=!1,delete A.dataset.id)}function Ue(e){if(!k)return;const t=j.mode==="edit",n=t?c("maintenance.closeModal.editSaving","⏳ جاري الحفظ..."):c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),a=t?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(k.disabled=!0,k.dataset.loading="true",k.textContent=n):(k.disabled=!1,k.removeAttribute("data-loading"),k.textContent=a)}function oi(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=g(t).replace(/٫/g,".").replace(/٬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:r}=e;if(e.value=n,a!==null&&r!==null)try{e.setSelectionRange(a,r)}catch{}}}function ci(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const s=g(n).replace(/٫/g,".").replace(/٬/g,",").replace(/[^0-9.,-]/g,"");if(!s)return{provided:!0,value:null,error:"invalid"};const i=s.includes(","),o=s.includes(".");let l=s;i&&!o?l=s.replace(",","."):i&&o&&(l=s.replace(/,/g,""));const u=Number.parseFloat(l);return!Number.isFinite(u)||u<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(u*100)/100,error:null}}function ga(e,{mode:t="close"}={}){const n=ia(e);if(!n){h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!da()){const l=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(l===null)return;const u=l.trim();if(!u){h(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}ba(e,u);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(g(String(n.repairCost))):null,r=Number.isFinite(a)?Math.round(a*100)/100:null,s=t==="edit"?"edit":"close";if(j={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:r,resolvedAt:n.resolvedAt||null,mode:s},T&&(T.value=n.resolutionReport||"",T.classList.remove("is-invalid")),S&&(r!==null?S.value=g(r.toFixed(2)):S.value="",S.classList.remove("is-invalid")),Le){const l=c("maintenance.report.barcode","الباركود"),u=c("maintenance.report.notAvailable","غير متوفر"),d=j.equipmentDesc||u,p=j.equipmentBarcode?g(j.equipmentBarcode):u;Le.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${d}</div>
          <div class="maintenance-close-modal__ticket-meta">${l}: <span>${p}</span></div>
        </div>
      </div>
    `}Ue(!1);const i=s==="edit";k&&(k.textContent=i?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة"));const o=document.getElementById("closeMaintenanceModal");if(o){const l=o.querySelector("#maintenance-close-modal-title"),u=o.querySelector(".maintenance-close-modal__subtitle");l&&(l.textContent=i?c("maintenance.closeModal.editTitle","✏️ تعديل بيانات الإغلاق"):c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),u&&(u.textContent=i?c("maintenance.closeModal.editSubtitle","يمكنك تحديث تقرير الإصلاح وتكلفته."):c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة."))}Wt?.show(),setTimeout(()=>{T?.focus(),T?.setSelectionRange(T.value.length,T.value.length)},150)}async function li(e){if(e?.preventDefault(),!j.id){h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!T)return;const t=T.value.trim();if(!t){h(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),T.focus();return}S&&S.classList.remove("is-invalid");const n=S?ci(S.value,j.repairCost):{provided:!1,value:null,error:null};if(n.error){h(c("maintenance.toast.invalidRepairCost","⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح"),"error"),S?.classList.add("is-invalid"),S?.focus();return}Ue(!0),(await ba(j.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:j.mode,resolvedAt:j.resolvedAt})).success?Wt?.hide():Ue(!1)}function ui(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(p=>p.status==="open").length,r=n-a,s=p=>g(String(p)),i=c("maintenance.stats.summaryTitle","ملخص الصيانة"),o=c("maintenance.filters.status.open","قيد الصيانة"),l=c("maintenance.filters.status.closed","مغلقة"),u=c("maintenance.stats.totalLabel","إجمالي التذاكر"),d=(p,m,f)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${f}">
      <span class="maintenance-summary__value">${s(p)}</span>
      <span class="maintenance-summary__label">${m}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${i}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${d(a,o,"open")}
        ${d(r,l,"closed")}
        ${d(n,u,"total")}
      </div>
    </section>
  `}function di(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Gt(n)||"open",r={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},s=r[a]??r.open,i=s?c(s.key,s.fallback):c("maintenance.status.open","قيد الصيانة"),o=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():i,l=["maintenance-status-badge","maintenance-status-tag"];return s?.className&&l.push(s.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${o}</span>`}function mi(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),r=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${r}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const r=di(a),s=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",i=(()=>{const D=c("maintenance.priority.high","مرتفعة"),E=c("maintenance.priority.medium","متوسطة"),V=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${D}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${V}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${E}</span>`}})(),o=[],l=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),u=c("maintenance.actions.view","👁️ عرض التقرير"),d=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?o.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):o.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${u}</button>`),J()&&o.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${d}</button>`);const p=o.join(""),m=c("maintenance.table.noBarcode","بدون باركود"),f=c("maintenance.report.none","—"),b=a.equipmentBarcode?g(a.equipmentBarcode):m,y=a.issue?g(a.issue):f,v=a.repairCost!=null?Number.parseFloat(g(String(a.repairCost))):null,L=a.status==="closed"&&Number.isFinite(v)?`<div class="maintenance-repair-cost">${q(c("maintenance.table.repairCost","💰 تكلفة الإصلاح: {amount}").replace("{amount}",g(v.toFixed(2))))}</div>`:"",C=a.createdAt?g(Mt(a.createdAt)||ke(a.createdAt)):"—";return`
        <tr class="${s}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${b}</small>
          </td>
          <td class="maintenance-issue-text">${y}${L}</td>
          <td>${i}</td>
          <td>${C}</td>
          <td>${r}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${p}
            </div>
          </td>
        </tr>
      `}).join("")}}function pi(e){if(!Ae||qe){h(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")ga(a);else if(n==="view")fi(a);else if(n==="delete"){if(!J()){Te();return}bi(a).catch(r=>{console.error("❌ [maintenance] deleteTicket failed",r)})}}}async function ba(e,t,n={}){const a=ia(e);if(!a)return h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const r=(t??"").trim();if(!r)return h(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const s=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:ii(new Date)||new Date().toISOString(),i={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:r,resolved_at:s};n?.repairCostProvided&&(i.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await ta(e,i),await He({showToastOnError:!1});const o=document.getElementById("maintenance-status-filter");return o&&o.value==="open"&&(o.value="all"),await ct(),R(),h(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(o){if(console.error("❌ [maintenance] closeTicket failed",o),_e(o)&&o.status===404)return await He({showToastOnError:!1}),await ct(),R(),h(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const l=_e(o)?o.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return h(l,"error"),{success:!1,error:o}}}function fi(e){const n=ae().find(E=>Number(E.id)===Number(e));if(!n)return;if(n.id,!pa()){const E=c("maintenance.report.equipment","المعدة"),V=c("maintenance.report.barcode","الباركود"),K=c("maintenance.report.issue","الوصف"),w=c("maintenance.report.createdAt","تاريخ الإنشاء"),O=c("maintenance.report.closedAt","تاريخ الإغلاق"),ye=c("maintenance.report.summary","التقرير"),re=c("maintenance.report.repairCost","تكلفة الإصلاح"),ht=c("maintenance.report.currencyLabel","ريال"),Ge=Number.parseFloat(g(String(n.repairCost??""))),nn=Number.isFinite(Ge)?`${g(Ge.toFixed(2))} ${ht}`:Q,vt=c("maintenance.report.notAvailable","غير متوفر"),Q=c("maintenance.report.none","—"),B=[`${E}: ${n.equipmentDesc}`,`${V}: ${n.equipmentBarcode?g(n.equipmentBarcode):vt}`,`${K}: ${n.issue?g(n.issue):Q}`,`${w}: ${n.createdAt?g(Mt(n.createdAt)||ke(n.createdAt)):Q}`,`${O}: ${n.resolvedAt?g(ke(n.resolvedAt)):Q}`,`${re}: ${nn}`,`${ye}: ${n.resolutionReport?g(n.resolutionReport):Q}`].join(`
`);alert(B);return}const a=c("maintenance.report.equipment","المعدة"),r=c("maintenance.report.barcode","الباركود"),s=c("maintenance.report.issue","الوصف"),i=c("maintenance.report.createdAt","تاريخ الإنشاء"),o=c("maintenance.report.closedAt","تاريخ الإغلاق"),l=c("maintenance.report.repairCost","تكلفة الإصلاح"),u=c("maintenance.report.summary","التقرير"),d=c("maintenance.report.notAvailable","غير متوفر"),p=c("maintenance.report.none","—"),m=Number.parseFloat(g(String(n.repairCost??""))),f=Number.isFinite(m)?g(m.toFixed(2)):null,b=c("maintenance.report.currencyLabel","ريال"),y=[{label:a,value:`<span class="maintenance-report-modal__value">${q(n.equipmentDesc||p)}</span>`},{label:r,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${q(g(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(d)}</span>`},{label:s,value:n.issue?`<span class="maintenance-report-modal__value">${q(g(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(p)}</span>`},{label:i,value:n.createdAt?`<span class="maintenance-report-modal__value">${q(g(Mt(n.createdAt)||ke(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(p)}</span>`},{label:o,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${q(g(ke(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(p)}</span>`},{label:l,value:f?`<span class="maintenance-report-modal__value">${q(f)} ${q(b)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(p)}</span>`}],v=n.resolutionReport?g(n.resolutionReport):"",L=v?`<p>${q(v).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(p)}</p>`,C=y.map(E=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${q(E.label)}</span>
        ${E.value}
      </div>
    `).join(""),D=`
    <div class="maintenance-report-modal__summary">
      <h6>${q(u)}</h6>
      ${L}
    </div>
  `;if(Ce&&(Ce.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${C}
        </div>
        ${D}
      </div>
    `),A){const E=J()&&n.status==="closed";A.hidden=!E,A.disabled=!E,A.textContent=c("maintenance.actions.editClosed","✏️ تعديل بيانات الإغلاق"),E?A.dataset.id=String(n.id):delete A.dataset.id}Pe?.show()}function gi(){if(!A)return;const e=Number(A.dataset.id);if(!e){Pe?.hide();return}if(!J()){Pe?.hide(),Te();return}Pe?.hide(),setTimeout(()=>{ga(e,{mode:"edit"})},220)}async function bi(e){if(!J()){Te();return}if(!ae().find(a=>Number(a.id)===Number(e))){h(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await na(e),await He({showToastOnError:!1}),await ct(),h(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const r=_e(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");h(r,"error")}}async function yi(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),r=document.getElementById("maintenance-issue"),s=document.getElementById("maintenance-priority");let i=Fe,o=Y(a?.value);if(!i&&o&&(i=yt(o)),!i&&t?.value&&la(t.value,{showFeedback:!0})&&(i=Fe,o=Y(i?.barcode)),!i&&n?.value&&ua(n.value,{showFeedback:!0})&&(i=Fe,o=Y(i?.barcode)),!i||!o){h(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=ne();let u=(l||[]).find(v=>Y(v?.barcode)===o);if(!u&&i&&(u={id:i.id,barcode:i.barcode,desc:i.desc,name:i.desc,status:i.status||"متاح",quantity:i.quantity,qty:i.quantity}),!u||u.id==null){h(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),se();return}const d=Number.parseInt(u.qty??u.quantity??i?.quantity??1,10),p=Number.isFinite(d)&&d>0?d:1,m=oa(o);if(sa(u.status||i?.status)==="maintenance"&&p<=1){h(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(m>=p){h(c("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const b=aa({equipmentId:u.id,technicianId:null,issue:r?.value.trim()||"",priority:s?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await ea(b),await He({showToastOnError:!1}),await ct(),h(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),se(),r&&(r.value=""),s&&(s.value="medium");const y=document.getElementById("maintenance-status-filter");y&&(y.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=_e(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");h(n,"error")}}function hi({status:e="all",query:t="",priority:n="all"}={}){let r=ae();e!=="all"&&(r=r.filter(i=>i.status===e)),n!=="all"&&(r=r.filter(i=>String(i.priority||"medium")===n));const s=ot(t||"");return s&&(r=r.filter(i=>{const o=Yt(i.equipmentDesc||""),l=ot(i.equipmentBarcode||"");return o.includes(s)||l.includes(s)})),r}function R(){const e=ae();tn(),ui(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",r=document.getElementById("maintenance-search")?.value||"",i=document.getElementById("maintenance-priority-filter")?.value||"all",o=document.getElementById("maintenance-table-body"),l=document.getElementById("maintenance-empty-state");if(!o)return;if(qe&&!Ae){const d=c("maintenance.table.loading","جاري التحميل...");o.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${d}</td></tr>`,l&&l.classList.remove("active");return}if(Re&&!Ae){o.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${Re}</td></tr>`,l&&l.classList.remove("active");return}const u=hi({status:n,query:r,priority:i});mi(u)}function vi(){ae(),tn(),Ae=be.length>0,qe=!1,R(),He({showToastOnError:!1}),da()&&ma(),pa()&&fa();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",s=>{yi(s).catch(i=>{console.error("❌ [maintenance] submit handler failed",i)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{R()}),t.dataset.listenerAttached="true");const n=document.getElementById("maintenance-priority-filter");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{R()}),n.dataset.listenerAttached="true");const a=document.getElementById("maintenance-search");if(a&&!a.dataset.listenerAttached){const s=()=>R();a.addEventListener("input",s),a.addEventListener("change",s),a.dataset.listenerAttached="true"}const r=document.querySelector(".maintenance-table");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",pi),r.dataset.listenerAttached="true")}ae();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=yt(e.value);n?ca(n):t&&(t.textContent=Dt())}else t&&(t.textContent=Dt());R(),Ue(!1)});document.addEventListener(zt.USER_UPDATED,()=>{R()});window.addEventListener("maintenance:updated",()=>{be=Qe(),R()});const Di=Object.freeze(Object.defineProperty({__proto__:null,initMaintenance:vi,renderMaintenance:R},Symbol.toStringTag,{value:"Module"}));export{H as A,xi as B,Lr as C,Ci as D,ke as E,Li as F,mr as G,$i as H,Fr as I,Si as J,Ii as K,Ei as L,ki as M,Mi as N,Di as O,I as a,_i as b,Bi as c,wi as d,zt as e,h as f,$t as g,Te as h,Wa as i,Gn as j,Ti as k,ne as l,Ai as m,g as n,Rt as o,Ln as p,Cn as q,x as r,Ot as s,c as t,J as u,$ as v,bt as w,Ar as x,Ni as y,Cr as z};
