import{t as c,d as P,e as O,n as b,f as ce,b as R,A as Ct,s as Sn,h as An,j as y,k as Xe,o as Bt,u as Se,p as Ie,q as wn,r as Ln,a as kn,c as In,i as qn,l as Cn}from"./auth-CXJ9BVF7.js";import"./common-DiVDZi68.js";import{r as $t,l as Bn}from"./controller-CuVK2rR_.js";/* empty css            */import{r as $n}from"./customers-C_bDRz6Y.js";import{e as Mn,i as Dn,g as Ye,s as xn,c as Rn,r as Mt,m as _n,a as Dt,b as Fn,d as Nn,f as jn,h as et,j as Pn,u as On}from"./projectsService-D_k_Qiiq.js";import{s as xt}from"./events-CH5R5ku-.js";const Hn={limit:200};let T=null,ut=!1,mt=!1,pt=!1,ft=!1,je=null,Pe=null,Oe=!1,V="";function Rt(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Vn(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function J({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:o}=Rt();if(!a||!o)return;const s=typeof t=="string"?t.trim().length>0:!!t,r=!e&&!s&&!!n,i=e||s||r;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",s),a.classList.toggle("is-empty",r),!i){o.textContent="";return}let d="";e?d=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):s?d=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):r&&(d=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة.")),o.textContent=d}function He(){T&&(T.destroy(),T=null)}function Un(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const o=e.paidStatus??e.paid_status??null,s=e.paid!=null?e.paid:o==="paid",{effectiveConfirmed:r}=Mt(e,t),i=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,d=e.customerName??e.customer_name??"";let l=!!e.completed;if(!l&&a){const u=new Date(a);Number.isNaN(u.getTime())||(l=u<new Date)}return{id:e.id??i??n,start:n,end:a||n,paid:s,confirmed:r,completed:l,reservationId:i??"",customerName:d,raw:e}}function _t(e=[]){const{projects:t=[]}=O(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const o=a?.projectId??a?.project_id??null,s=o!=null&&o!==""&&n.get(String(o))||null,r=Un(a,s);if(!r)return null;const i=Zn({...a,paid:r.paid,confirmed:r.confirmed,completed:r.completed});return{id:r.id,title:"",start:r.start,end:r.end,backgroundColor:i.background,borderColor:i.border,textColor:i.text,display:"auto",extendedProps:{...a,paid:r.paid,confirmed:r.confirmed,completed:r.completed,reservationId:r.reservationId,customerName:r.customerName}}}).filter(Boolean)}function gt(){return{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")}}async function zn(){if(Oe)return Ye();Oe=!0,V="";try{await Mn({suppressError:!1,params:Hn})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),V=Dn(e)?e.message:e instanceof Error&&e.message||""}finally{Oe=!1}return Ye()}function Ft(e){T&&T.batchRendering(()=>{T.removeAllEvents(),T.addEventSource(e)})}function Nt(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function jt(){const e=Ye(),t=_t(e);if(!T){De();return}T.setOption("locale",P()),Ft(t),re(),J({loading:!1,error:"",empty:t.length===0}),Nt(t)}function Yn(){ut||(document.addEventListener("language:changed",()=>{T&&T.setOption("locale",P()),De()}),ut=!0),mt||(document.addEventListener("reservations:changed",()=>{jt()}),mt=!0)}function Pt(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function re(){if(!T)return;const e=Pt();T.view?.type!==e&&T.changeView(e),T.updateSize()}function Gn(){pt||typeof window>"u"||(window.addEventListener("resize",()=>{re()}),pt=!0)}function Wn(){if(ft||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{Pe&&clearTimeout(Pe),Pe=setTimeout(()=>{T&&jt()},80)};je=new MutationObserver(e),je.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&je.observe(document.body,{attributes:!0,attributeFilter:["class"]}),ft=!0}function Kn(){return typeof document>"u"?!1:document.documentElement?.classList.contains("dark-mode")||document.body?.classList.contains("dark-mode")}function Zn(){return Kn()?{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(30, 58, 138, 0.7))",border:"rgba(59, 130, 246, 0.5)",text:"#e2e8f0"}:{background:"linear-gradient(135deg, #4361ee, #3a0ca3)",border:"#240c62",text:"#ffffff"}}function Qn(e){const{reservationId:t,customerName:n,paid:a,confirmed:o,completed:s}=e.event.extendedProps,r=a===!0||a==="paid",i=o===!0||o==="true",d=document.createElement("div");d.className="fc-reservation-event";const l=i?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),u=r?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),g=c("calendar.badges.completed","منتهي"),m=c("calendar.labels.unknownCustomer","غير معروف");return d.innerHTML=`
    <div class="fc-reservation-id">${t}</div>
    <div class="fc-reservation-customer">${n||m}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${i?"bg-success":"bg-warning text-dark"}">${l}</span>
      <span class="badge ${r?"bg-primary":"bg-danger"}">${u}</span>
      ${s?`<span class="badge bg-secondary">${g}</span>`:""}
    </div>
  `,{domNodes:[d]}}function Jn(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",o=!!e.completed,s=n?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),r=a?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),i=c("calendar.badges.completed","منتهي"),d=P(),l=e.items||[],u=xn()||[],g=new Map(u.map(p=>[String(p.id),p])),m=(e.technicians||[]).map(p=>g.get(String(p))).filter(Boolean),f=Rn(e.start,e.end),N=l.reduce((p,I)=>p+(I.qty||1)*(I.price||0),0)*f,w=(p={})=>{const I=[p.dailyWage,p.daily_rate,p.dailyRate,p.wage,p.rate];for(const se of I){if(se==null)continue;const he=parseFloat(b(String(se)));if(Number.isFinite(he))return he}return 0},fe=m.reduce((p,I)=>p+w(I),0)*f,ge=N+fe,Fe=(()=>{const p=parseFloat(e.discount)||0;return p?e.discountType==="amount"?p:ge*(p/100):0})(),ct=Math.max(0,ge-Fe),Ne=e.applyTax?ct*.15:0,un=e.cost??Math.round(ct+Ne),lt=c("calendar.labels.currencySuffix","ريال"),mn=l.length?l.map((p,I)=>{const se=p.image||p.imageUrl||p.img||"",he=b(String(p.barcode||"-")),vn=b(String(p.qty||1)),En=b(String(p.price||0)),Tn=se?`<img src="${se}" alt="${p.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${b(String(I+1))}</td>
            <td>${he}</td>
            <td>${p.desc||"-"}</td>
            <td>${vn}</td>
            <td>${En} ${lt}</td>
            <td>${Tn}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${c("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,be=[`<div>${c("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",N.toFixed(2))}</div>`,`<div>${c("calendar.summary.crewTotal","😎 إجمالي الفريق: <strong>{value} ريال</strong>").replace("{value}",fe.toFixed(2))}</div>`,`<div>${c("calendar.summary.duration","⏱️ عدد الأيام: <strong>{value}</strong>").replace("{value}",b(String(f)))}</div>`];if(Fe>0){const p=d==="en"?"%":"٪",I=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${p}`:`${Fe.toFixed(2)} ${lt}`;be.push(`<div>${c("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",I)}</div>`)}e.applyTax&&Ne>0&&be.push(`<div>${c("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",Ne.toFixed(2))}</div>`),be.push(`<div>${c("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",un.toFixed(2))}</div>`);const pn=b(String(e.reservationId??e.id??"")),fn=e.start?b(ce(e.start)):"-",gn=e.end?b(ce(e.end)):"-",bn=e.notes?b(e.notes):c("calendar.labels.noNotes","لا توجد ملاحظات"),hn=e.customerName||c("calendar.labels.unknownCustomer","غير معروف"),yn=[{icon:"🆔",label:c("calendar.labels.reservationId","رقم الحجز"),value:pn},{icon:"👤",label:c("calendar.labels.customer","العميل"),value:hn},{icon:"🗓️",label:c("calendar.labels.start","بداية الحجز"),value:fn},{icon:"🗓️",label:c("calendar.labels.end","نهاية الحجز"),value:gn},{icon:"📝",label:c("calendar.labels.notes","الملاحظات"),value:bn}];t.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${s}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${r}</span>
      ${o?`<span class="badge bg-secondary">${i}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${yn.map(p=>`
        <div class="calendar-info-row">
          <span class="label">${p.icon} ${p.label}</span>
          <span class="value">${p.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${c("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${m.length?`<ul class="list-unstyled calendar-reservation-technicians">${m.map(p=>{const I=p.role?` — ${p.role}`:"";return`<li><strong>${p.name}</strong>${I}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${c("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${c("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${c("calendar.table.headers.barcode","الباركود")}</th>
            <th>${c("calendar.table.headers.description","الوصف")}</th>
            <th>${c("calendar.table.headers.quantity","الكمية")}</th>
            <th>${c("calendar.table.headers.price","السعر")}</th>
            <th>${c("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${mn}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${be.join("")}
    </div>
  `;const dt=document.getElementById("calendarReservationModal");dt&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(dt).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function De(){Yn(),Gn(),Wn();const{calendarEl:e}=Rt();if(!e)return;const t=Vn();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");J({error:n}),He();return}(async()=>{J({loading:!0});const n=await zn();if(V){const o=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");J({loading:!1,error:V||o}),He();return}const a=_t(n);T?(T.setOption("locale",P()),T.setOption("buttonText",gt()),Ft(a)):(T=new t.Calendar(e,{initialView:Pt(),locale:P(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:gt(),events:a,eventContent:Qn,eventClick(o){Jn(o.event.extendedProps)},windowResize:re}),T.render()),re(),Nt(a),J({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{re()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),V=n instanceof Error&&n.message||V||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");J({loading:!1,error:V||a}),He()})}let Ge=null,Ae=null,we=null;const S={range:"all",status:"all",payment:"all",search:"",start:null,end:null};let bt=!1,ht=!1,Ve=null;const E={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let Le=!1,qe="";const q={icon:null,title:null,subtitle:null};let yt=!1;function v(e,t,n=t){const a=P()==="en"?n??t:t;return c(e,a)}function vt(){Ue(),L(),setTimeout(()=>{Ue(),L()},0),setTimeout(()=>{Ue(),L()},60)}function X(){S.range==="custom"&&L()}function Ue(){Ge=null,Ae=null,we=null}function tt(){return(P()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function Ot(){const e=P();if(e!==Ge||!Ae||!we){Ge=e;const t=tt();Ae=new Intl.NumberFormat(t,{maximumFractionDigits:0}),we=new Intl.NumberFormat(t,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Ae,currencyFormatter:we}}function Xn(e){const t=tt();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function Ht(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Vt(e={}){const t=b(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function Ut(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",o=e?.confirmed===!0||Ce(a)==="confirmed"||Ce(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:o}}function ea(){if(typeof O!="function")return!1;let e;try{e=O()}catch(i){return console.warn("⚠️ [reports] Failed to access cached data",i),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:o=[],projects:s=[]}=e;return t.length||n.length||a.length||o.length||s.length?(E.reservations=Array.isArray(t)?t.map(_n):[],E.customers=Array.isArray(n)?n.map(Ht):[],E.equipment=Array.isArray(a)?a.map(Vt):[],E.technicians=Array.isArray(o)?o.map(Dt):[],E.projects=Array.isArray(s)?s.map(Ut):[],E.projectsMap=new Map(E.projects.map(i=>[i.id,i])),!0):!1}function zt(e){return e?.projectId&&E.projectsMap.get(String(e.projectId))||null}function Q(e){const t=zt(e),n=Mt(e,t),a=Ce(n.projectStatus);let o=Ce(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(o=a),(!o||o==="cancelled")&&(o=n.effectiveConfirmed?"confirmed":"pending"),(Nn(e)||a==="completed")&&(o="completed");const s=n.effectiveConfirmed||o==="confirmed"||o==="completed";s&&o!=="completed"&&(o="confirmed");const r=ia(e);return{statusValue:o,confirmed:s,paid:r}}async function Yt({silent:e=!1}={}){if(!Le){Le=!0,qe="",e||L();try{const[t,n,a,o,s]=await Promise.all([R("/reservations/?limit=500"),R("/customers/?limit=500"),R("/equipment/?limit=500"),R("/technicians/?limit=500"),R("/projects/?limit=500")]);E.reservations=Array.isArray(t?.data)?t.data.map(r=>Fn(r)):[],E.customers=Array.isArray(n?.data)?n.data.map(Ht):[],E.equipment=Array.isArray(a?.data)?a.data.map(Vt):[],E.technicians=Array.isArray(o?.data)?o.data.map(Dt):[],E.projects=Array.isArray(s?.data)?s.data.map(Ut):[],E.projectsMap=new Map(E.projects.map(r=>[r.id,r]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),qe=t instanceof Ct?t.message:c("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),E.reservations=[],E.customers=[],E.equipment=[],E.technicians=[],E.projects=[],E.projectsMap=new Map}finally{Le=!1,L()}}}function ye(){Yt({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function We({active:e,icon:t,title:n,subtitle:a}){const o=document.getElementById("reports-empty-state");if(!o)return;const s=o.querySelector(".reports-empty-icon"),r=o.querySelector("h4"),i=o.querySelector("p");q.icon===null&&s&&(q.icon=s.textContent),q.title===null&&r&&(q.title=r.textContent),q.subtitle===null&&i&&(q.subtitle=i.textContent),o.classList.toggle("active",!!e),!(!s||!r||!i)&&(e?(s.textContent=t!==void 0?t:q.icon??s.textContent,r.textContent=n!==void 0?n:q.title??r.textContent,i.textContent=a!==void 0?a:q.subtitle??i.textContent):(s.textContent=q.icon??s.textContent,r.textContent=q.title??r.textContent,i.textContent=q.subtitle??i.textContent))}function ta(){if(bt)return;bt=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-start"),o=document.getElementById("reports-end"),s=document.getElementById("reports-refresh"),r=document.getElementById("reports-custom-range"),i=document.getElementById("reports-search");if(!e)return;e.value=S.range,ea()&&L(),e.addEventListener("change",()=>{S.range=e.value,Et(r,S.range==="custom"),S.range!=="custom"&&(S.start=null,S.end=null),L()}),t?.addEventListener("change",()=>{S.status=t.value,L()}),n?.addEventListener("change",()=>{S.payment=n.value,L()}),i?.addEventListener("input",()=>{const l=i.value||"";Ve&&clearTimeout(Ve),Ve=setTimeout(()=>{S.search=l,L()},220)}),a?.addEventListener("change",()=>{S.start=a.value||null,X()}),o?.addEventListener("change",()=>{S.end=o.value||null,X()}),s?.addEventListener("click",()=>{S.range==="custom"&&(S.start=a?.value||null,S.end=o?.value||null),L()}),na(a,o),Et(r,!1),ht||(document.addEventListener("language:changed",vt),document.addEventListener("language:translationsReady",vt),ht=!0),yt||(document.addEventListener("reservations:changed",ye),document.addEventListener("customers:changed",ye),document.addEventListener("equipment:changed",ye),document.addEventListener("technicians:updated",ye),yt=!0),Yt()}function L(){if(Le){We({active:!0,icon:"⏳",title:c("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:c("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(qe){We({active:!0,icon:"⚠️",title:qe,subtitle:c("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=E,o=aa(e,S,t,n,a),s=ca(o),r=la(o),i=da(o),d=ua(o),l=ma(o,t),u=pa(o,n);Ta(s),ga(r),At("reports-status-breakdown",i),At("reports-payment-breakdown",d),ba(l),ha(u),fa(o,t,a),Sa(o.length===0)}function na(e,t){if(!window.flatpickr)return;const n=window.flatpickr?.l10ns?.ar?window.flatpickr.l10ns.ar:null,a=r=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...r};return n&&(i.locale=n),i};let o=null,s=null;e&&(o=window.flatpickr(e,a({onChange(r,i){S.start=i||null,s&&(r?.length?s.set("minDate",r[0]):s.set("minDate",null),X())},onValueUpdate(r,i){S.start=i||null,X()}}))),t&&(s=window.flatpickr(t,a({onChange(r,i){S.end=i||null,o&&(r?.length?o.set("maxDate",r[0]):o.set("maxDate",null),X())},onValueUpdate(r,i){S.end=i||null,X()}}))),o&&t?.value&&(o.setDate(e.value,!1),o.set("maxDate",s?.selectedDates?.[0]||t.value)),s&&e?.value&&(s.setDate(t.value,!1),s.set("minDate",o?.selectedDates?.[0]||e.value))}function Et(e,t){e&&e.classList.toggle("active",!!t)}function Gt(e){return b(String(e||"")).toLowerCase().trim()}function aa(e,t,n,a,o){const{startDate:s,endDate:r}=ra(t),i=Gt(t.search),d=!!i,l=new Map((n||[]).map(m=>[String(m.id),m])),u=new Map((a||[]).map(m=>[Be(m?.barcode),m])),g=new Map((o||[]).map(m=>[String(m.id),m]));return(e||[]).filter(m=>{const f=m?.start?new Date(m.start):null;if(!f||Number.isNaN(f.getTime())||s&&f<s||r&&f>r)return!1;const{statusValue:A,confirmed:N,paid:w}=Q(m);return!(t.status==="confirmed"&&!(A==="confirmed"||A==="completed"||N)||t.status==="pending"&&A!=="pending"||t.status==="completed"&&A!=="completed"||t.payment==="paid"&&!w||t.payment==="unpaid"&&w||d&&!sa(m,i,l,u,g))})}function sa(e,t,n,a,o){const s=[],r=e?.reservationId||e?.id;r&&s.push(r),e?.notes&&s.push(e.notes);const{statusValue:i}=Q(e);i&&s.push(i);const d=e?.paymentStatus||e?.payment_status;d&&s.push(d),e?.paid!=null&&s.push(e.paid?"paid":"unpaid");const l=n.get(String(e?.customerId));l&&s.push(l.customerName,l.company_name||l.companyName,l.contact_person||"");const u=zt(e);return u&&s.push(u.title,u.code,u.status),s.push(Wt(e)),(e?.items||[]).forEach(m=>{m?.desc&&s.push(m.desc),m?.barcode&&s.push(m.barcode);const f=a.get(Be(m?.barcode));f&&s.push(f.desc,f.description,f.name)}),(e?.technicians||[]).forEach(m=>{const f=o.get(String(m));f&&s.push(f.name,f.role,f.department)}),Gt(s.filter(Boolean).join(" ")).includes(t)}function ra({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const r=t?new Date(`${t}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:Tt(r)?r:null,endDate:Tt(i)?i:null}}let o=new Date(a),s=null;switch(e){case"last30":{s=new Date(a),s.setDate(s.getDate()-29);break}case"thisWeek":{const r=new Date(a),d=(r.getDay()-6+7)%7;r.setDate(r.getDate()-d),r.setHours(0,0,0,0);const l=new Date(r);l.setDate(r.getDate()+6),l.setHours(23,59,59,999),s=r,o.setTime(l.getTime());break}case"thisMonth":{s=new Date(a.getFullYear(),a.getMonth(),1);const r=new Date(a.getFullYear(),a.getMonth()+1,0);o.setTime(r.setHours(23,59,59,999));break}case"thisQuarter":{const r=Math.floor(a.getMonth()/3);s=new Date(a.getFullYear(),r*3,1);const i=new Date(a.getFullYear(),(r+1)*3,0);o.setTime(i.setHours(23,59,59,999));break}case"thisYear":{s=new Date(a.getFullYear(),0,1);const r=new Date(a.getFullYear(),12,0);o.setTime(r.setHours(23,59,59,999));break}case"all":default:s=null,o=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:o}}function Tt(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const oa=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),St=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function Ce(e=""){const t=String(e).toLowerCase().trim();return t?oa.get(t)||t:""}function ia(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&St.has(a))return St.get(a)}return e?.paid===!0||e?.paid==="true"}function ca(e){const t=e.length;let n=0,a=0,o=0,s=0;e.forEach(i=>{const{statusValue:d,confirmed:l,paid:u}=Q(i);d==="completed"&&(a+=1),l&&(n+=1),u&&(o+=1),s+=Number(i?.cost)||0});const r=t?s/t:0;return{total:t,confirmed:n,completed:a,paidCount:o,revenue:s,average:r}}function la(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const o=new Date(t.getFullYear(),t.getMonth()-a,1),s=o.getFullYear(),r=o.getMonth(),i=e.filter(g=>{const m=g?.start?new Date(g.start):null;return m&&m.getFullYear()===s&&m.getMonth()===r}),d=i.length,l=i.reduce((g,m)=>g+(Number(m?.cost)||0),0),u=Xn(o);n.push({label:u,count:d,revenue:l})}return n}function da(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(r=>{const{statusValue:i,confirmed:d}=Q(r);i==="completed"?t.completed+=1:i==="confirmed"||d?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,o=t.pending,s=t.completed;return[{label:v("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed"},{label:v("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-pending"},{label:v("reservations.reports.status.completedLabel","منتهية","Completed"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-completed"}]}function ua(e){const t=e.length||1,n=e.filter(o=>Q(o).paid).length,a=e.length-n;return[{label:v("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid"},{label:v("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid"}]}function ma(e,t){const n=new Map,a=new Map((t||[]).map(o=>[String(o.id),o]));return e.forEach(o=>{const s=String(o?.customerId??"unknown"),r=n.get(s)||{count:0,revenue:0};r.count+=1,r.revenue+=Number(o?.cost)||0,n.set(s,r)}),Array.from(n.entries()).map(([o,s])=>({name:a.get(o)?.customerName||v("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:s.count,revenue:s.revenue})).sort((o,s)=>s.revenue-o.revenue).slice(0,5)}function pa(e,t){const n=new Map,a=new Map((t||[]).map(o=>[Be(o?.barcode),o]));return e.forEach(o=>{(o?.items||[]).forEach(s=>{const r=Be(s?.barcode),i=r||(s?.desc??"unknown"),d=s?.desc||a.get(r)?.desc||a.get(r)?.description||v("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),l=Number(s?.qty)||1,u=l*(Number(s?.price)||0),g=n.get(i)||{name:d,count:0,revenue:0};g.name=d,g.count+=l,g.revenue+=u,n.set(i,g)})}),Array.from(n.values()).sort((o,s)=>s.count-o.count).slice(0,5)}function fa(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return;if(!e||e.length===0){a.innerHTML=`<tr><td colspan="6" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}const o=new Map((t||[]).map(i=>[String(i.id),i])),s=new Map((n||[]).map(i=>[String(i.id),i])),r=[...e].sort((i,d)=>new Date(d.start||0)-new Date(i.start||0)).slice(0,20).map(i=>ya(i,o,s));a.innerHTML=r.map(i=>`
      <tr>
        <td>${i.code}</td>
        <td>${i.customer}</td>
        <td>${i.date}</td>
        <td>${i.status}</td>
        <td>${i.payment}</td>
        <td>${i.total}</td>
      </tr>
    `).join("")}function ga(e){const t=document.getElementById("reports-volume-chart");if(!t)return;if(!e||e.length===0){t.innerHTML=`<p class="text-muted">${v("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const n=Math.max(1,...e.map(a=>a.count));t.innerHTML=e.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/n*100))}%"></div>
          <span class="value">${_(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function At(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<p class="text-muted">${v("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}n.innerHTML=t.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${_(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${v("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",_(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function ba(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${_(n.count)}</td>
        <td>${le(n.revenue)}</td>
      </tr>
    `).join("")}}function ha(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${_(n.count)}</td>
        <td>${le(n.revenue)}</td>
      </tr>
    `).join("")}}function ya(e,t,n){const a=e?.reservationId||e?.id||"—",s=t.get(String(e?.customerId))?.customerName||v("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),r=Ea(e?.start),i=va(e),d=Wt(e),l=le(e?.cost||0),u=(e?.technicians||[]).map(A=>n.get(String(A))?.name).filter(Boolean),g=v("reservations.list.crew.separator","، ",", "),m=u.map(A=>$(A)).join($(g)),f=u.length?`${$(s)}<br><small class="text-muted">${m}</small>`:$(s);return{code:$(a),customer:f,date:$(r),status:$(i),payment:$(d),total:$(l)}}function Wt(e){const{paid:t}=Q(e);return t?v("reservations.reports.payment.paidLabel","مدفوعة","Paid"):v("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function va(e){const{statusValue:t}=Q(e);return t==="completed"?v("reservations.list.status.completed","📁 منتهي","Completed"):t==="confirmed"?v("reservations.list.status.confirmed","✅ مؤكد","Confirmed"):t==="pending"?v("reservations.list.status.pending","⏳ غير مؤكد","Pending"):$(t)}function Ea(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=tt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return b(a.format(t))}function Ta(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-kpi-confirmed"),r=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),d=document.getElementById("reports-kpi-paid-meta"),l=e.total||0,u=e.revenue||0,g=e.confirmed||0,m=e.paidCount||0,f=e.average||0,A=l?Math.round(g/l*100):0,N=l?Math.round(m/l*100):0;if(t&&(t.textContent=_(l)),n){const w=v("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",_(e.completed||0));n.textContent=w}if(a&&(a.textContent=le(u)),o){const w=v("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",le(f));o.textContent=w}if(s&&(s.textContent=`${A}%`),r){const w=v("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",_(g));r.textContent=w}if(i&&(i.textContent=`${N}%`),d){const w=v("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",_(m));d.textContent=w}}function Sa(e){We({active:!!e})}function $(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _(e){const{numberFormatter:t}=Ot(),n=t.format(Math.round(e||0));return b(n)}function le(e){const{currencyFormatter:t}=Ot(),n=t.format(Math.max(0,Math.round(e||0)));return b(n)}function Be(e){return(e||"").toString().trim()}const Aa=O()||{};let W=(Aa.maintenance||[]).map(Kt);function xe(){return W}function Re(e){return W=Array.isArray(e)?e.map(Kt):[],Sn({maintenance:W}),Da(),W}async function wa(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,r])=>{r!=null&&r!==""&&t.set(s,String(r))});const n=t.toString(),a=await R(`/maintenance/${n?`?${n}`:""}`),o=Array.isArray(a?.data)?a.data.map(nt):[];return Re(o)}async function La(e){const t=await R("/maintenance/",{method:"POST",body:e}),n=nt(t?.data??{});return Re([n,...W.filter(a=>a.id!==n.id)]),n}async function ka(e,t){const n=await R(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=nt(n?.data??{});return Re(W.map(o=>String(o.id)===String(e)?a:o)),a}async function Ia(e){await R(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Re(W.filter(t=>String(t.id)!==String(e)))}function qa({equipmentId:e,technicianId:t,issue:n,priority:a,status:o,scheduledAt:s,resolutionReport:r}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:o,notes:n??"",resolution_report:null}}function nt(e={}){return Zt({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function Kt(e={}){return Zt(e)}function Zt(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Ca(e.status_raw??e.status??"open"),o=Ba(a),s=Ma(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:$a(e.priority??"medium"),status:o,statusRaw:a,statusLabel:s,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Ca(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Ba(e){const t=Qt(e);return["completed","cancelled"].includes(t)?"closed":"open"}function $a(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Ma(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,o=>o.toUpperCase())}function Qt(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function Da(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function de(e){return e instanceof Ct}let Z=xe(),K=[],oe=null,ee=!1,ie="",te=Z.length>0,Y={id:null,equipmentDesc:"",equipmentBarcode:""},at=null,k=null,D=null,ne=null;async function ue({showToastOnError:e=!0}={}){if(!ee){ee=!0,ie="",M();try{await wa(),te=!0}catch(t){te=Z.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),ie=de(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&y(ie,"error")}finally{ee=!1,Z=xe(),M()}}}function Ke(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function j(e){return b(String(e||"")).trim().toLowerCase()}function wt(e=""){return b(String(e)).trim().toLowerCase()}function xa(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function F(){return Z=xe(),Z}function Jt(e){return F().find(n=>Number(n.id)===Number(e))||null}function st(){const{equipment:e=[]}=O(),t=c("maintenance.table.noName","بدون اسم");return K=(e||[]).map(n=>({barcode:j(n?.barcode),desc:n?.desc||n?.description||n?.name||t,status:n?.status||"متاح",price:Number(n?.price)||0,category:n?.category||""})),K.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),K}function Xt(){return new Set(F().filter(e=>e.status==="open").map(e=>j(e.equipmentBarcode)))}function _e(e){const t=j(e);return t&&(K.length?K:st()).find(a=>a.barcode===t)||null}function Ra(e){const t=wt(e);return t&&(K.length?K:st()).find(a=>wt(a.desc).includes(t))||null}function Ze(e){if(!e)return!0;const t=Xt();return e.status==="صيانة"||t.has(e.barcode)}function U({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search"),s=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),o&&(o.value="")),s&&(s.textContent=Ke()),oe=null}function en(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر");t.innerHTML=`
    <strong>${e.desc}</strong><br>
    <span class="text-muted">${n}: ${e.barcode||a}</span>
  `}function rt(e,{silent:t=!1}={}){if(!e)return!1;if(Ze(e))return t||y(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.barcode),o&&(o.value=e.desc),en(e),oe=e,!0}function tn(e,{showFeedback:t=!0}={}){const n=_e(e);return n?rt(n,{silent:!t}):(t&&y(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function nn(e,{showFeedback:t=!0}={}){const n=Ra(e);return n?rt(n,{silent:!t}):(t&&y(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function ot(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=st(),o=Xt();if(e){const r=c("maintenance.form.blockedSuffix","(صيانة)");e.innerHTML=a.map(i=>{const l=i.status==="صيانة"||o.has(i.barcode)?`${i.desc} ${r}`:i.desc,u=i.desc.replace(/"/g,"&quot;"),g=l.replace(/"/g,"&quot;");return`<option value="${u}" label="${g}"></option>`}).join("")}const s=document.getElementById("maintenance-selected-barcode");if(s&&s.value){const r=_e(s.value);!r||Ze(r)?(U({keepInputs:!0,silent:!0}),r&&Ze(r)&&y(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):rt(r,{silent:!0})}else U({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),tn(t.value)||U({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const r=()=>{if(!n.value){U({keepInputs:!0,silent:!0});return}nn(n.value)||U({keepInputs:!0,silent:!0})};n.addEventListener("change",r),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),r())}),n.dataset.listenerAttached="true"}}async function $e(){try{await jn({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{et(),ot()}}function an(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;at=t.Modal.getOrCreateInstance(e),k||(k=e.querySelector("#maintenance-close-report")),D||(D=e.querySelector("#maintenance-close-submit")),ne||(ne=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",Fa),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",sn),e.dataset.listenerAttached="true"),!0}function sn(){Y={id:null,equipmentDesc:"",equipmentBarcode:""},k&&(k.value=""),ne&&(ne.innerHTML=""),me(!1)}function me(e){if(!D)return;const t=c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),n=c("maintenance.closeModal.confirm","✅ إغلاق التذكرة");e?(D.disabled=!0,D.dataset.loading="true",D.textContent=t):(D.disabled=!1,D.removeAttribute("data-loading"),D.textContent=n)}function _a(e){const t=Jt(e);if(!t){y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!an()){const n=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(n===null)return;const a=n.trim();if(!a){y(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}rn(e,a);return}if(Y={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},k&&(k.value=t.resolutionReport||""),ne){const n=c("maintenance.report.barcode","الباركود"),a=c("maintenance.report.notAvailable","غير متوفر"),o=Y.equipmentDesc||a,s=Y.equipmentBarcode?b(Y.equipmentBarcode):a;ne.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${o}</div>
          <div class="maintenance-close-modal__ticket-meta">${n}: <span>${s}</span></div>
        </div>
      </div>
    `}me(!1),at?.show(),setTimeout(()=>{k?.focus(),k?.setSelectionRange(k.value.length,k.value.length)},150)}async function Fa(e){if(e?.preventDefault(),!Y.id){y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!k)return;const t=k.value.trim();if(!t){y(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),k.focus();return}me(!0),(await rn(Y.id,t)).success?at?.hide():me(!1)}function Na(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(l=>l.status==="open").length,o=n-a,s=l=>b(String(l)),r=c("maintenance.stats.open","{count} قيد الصيانة").replace("{count}",`<strong>${s(a)}</strong>`),i=c("maintenance.stats.closed","{count} مغلقة").replace("{count}",`<strong>${s(o)}</strong>`),d=c("maintenance.stats.total","{count} إجمالي التذاكر").replace("{count}",`<strong>${s(n)}</strong>`);t.innerHTML=`
    <span class="maintenance-stat">${r}</span>
    <span class="maintenance-stat">${i}</span>
    <span class="maintenance-stat">${d}</span>
  `}function ja(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Qt(n)||"open",o={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},s=o[a]??o.open,r=s?c(s.key,s.fallback):c("maintenance.status.open","قيد الصيانة"),i=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():r,d=["maintenance-status-badge","maintenance-status-tag"];return s?.className&&d.push(s.className),d.push(`maintenance-status-tag--${a}`),d.push(`maintenance-status-tag--${n}`),`<span class="${d.filter(Boolean).join(" ")}">${i}</span>`}function Pa(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),o=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${o}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const o=ja(a),s=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",r=(()=>{const it=c("maintenance.priority.high","مرتفعة"),fe=c("maintenance.priority.medium","متوسطة"),ge=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${it}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${ge}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${fe}</span>`}})(),i=[],d=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),l=c("maintenance.actions.view","👁️ عرض التقرير"),u=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?i.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${d}</button>`):i.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${l}</button>`),Xe()&&i.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${u}</button>`);const g=i.join(""),m=c("maintenance.table.noBarcode","بدون باركود"),f=c("maintenance.report.none","—"),A=a.equipmentBarcode?b(a.equipmentBarcode):m,N=a.issue?b(a.issue):f,w=a.createdAt?b(ce(a.createdAt)):"—";return`
        <tr class="${s}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${A}</small>
          </td>
          <td class="maintenance-issue-text">${N}</td>
          <td>${r}</td>
          <td>${w}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${g}
            </div>
          </td>
        </tr>
      `}).join("")}}function Oa(e){if(!te||ee){y(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")_a(a);else if(n==="view")Ha(a);else if(n==="delete"){if(!Xe()){Bt();return}Va(a).catch(o=>{console.error("❌ [maintenance] deleteTicket failed",o)})}}}async function rn(e,t){const n=Jt(e);if(!n)return y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const a=(t??"").trim();if(!a)return y(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const o=xa(new Date)||new Date().toISOString();try{await ka(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:o}),await ue({showToastOnError:!1});const s=document.getElementById("maintenance-status-filter");return s&&s.value==="open"&&(s.value="all"),await $e(),M(),y(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(s){if(console.error("❌ [maintenance] closeTicket failed",s),de(s)&&s.status===404)return await ue({showToastOnError:!1}),await $e(),M(),y(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const r=de(s)?s.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return y(r,"error"),{success:!1,error:s}}}function Ha(e){const n=F().find(m=>Number(m.id)===Number(e));if(!n)return;const a=c("maintenance.report.equipment","المعدة"),o=c("maintenance.report.barcode","الباركود"),s=c("maintenance.report.issue","الوصف"),r=c("maintenance.report.createdAt","تاريخ الإنشاء"),i=c("maintenance.report.closedAt","تاريخ الإغلاق"),d=c("maintenance.report.summary","التقرير"),l=c("maintenance.report.notAvailable","غير متوفر"),u=c("maintenance.report.none","—"),g=[`${a}: ${n.equipmentDesc}`,`${o}: ${n.equipmentBarcode?b(n.equipmentBarcode):l}`,`${s}: ${n.issue?b(n.issue):u}`,`${r}: ${n.createdAt?b(ce(n.createdAt)):u}`,`${i}: ${n.resolvedAt?b(ce(n.resolvedAt)):u}`,`${d}: ${n.resolutionReport?b(n.resolutionReport):u}`].join(`
`);alert(g)}async function Va(e){if(!Xe()){Bt();return}if(!F().find(a=>Number(a.id)===Number(e))){y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Ia(e),await ue({showToastOnError:!1}),await $e(),y(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const o=de(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");y(o,"error")}}async function Ua(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),o=document.getElementById("maintenance-issue"),s=document.getElementById("maintenance-priority");let r=oe,i=j(a?.value);if(!r&&i&&(r=_e(i)),!r&&t?.value&&tn(t.value,{showFeedback:!0})&&(r=oe,i=j(r?.barcode)),!r&&n?.value&&nn(n.value,{showFeedback:!0})&&(r=oe,i=j(r?.barcode)),!r||!i){y(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:d=[]}=O();let l=(d||[]).find(A=>j(A?.barcode)===i);if(!l&&r&&(l={id:r.id,barcode:r.barcode,desc:r.desc,name:r.desc,status:r.status||"متاح"}),!l||l.id==null){y(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),U();return}if(l.status==="صيانة"){y(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(F().filter(A=>A.status==="open").some(A=>j(A.equipmentBarcode)===i)){y(c("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const m=qa({equipmentId:l.id,technicianId:null,issue:o?.value.trim()||"",priority:s?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await La(m),await ue({showToastOnError:!1}),await $e(),y(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),U(),o&&(o.value=""),s&&(s.value="medium");const f=document.getElementById("maintenance-status-filter");f&&(f.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=de(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");y(n,"error")}}function za(e){const t=F();return e==="all"?t:t.filter(n=>n.status===e)}function M(){const e=F();ot(),Na(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),o=document.getElementById("maintenance-empty-state");if(!a)return;if(ee&&!te){const r=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${r}</td></tr>`,o&&o.classList.remove("active");return}if(ie&&!te){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${ie}</td></tr>`,o&&o.classList.remove("active");return}const s=za(n);Pa(s)}function Ya(){F(),ot(),te=Z.length>0,ee=!1,M(),ue({showToastOnError:!1}),an()&&sn();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Ua(a).catch(o=>{console.error("❌ [maintenance] submit handler failed",o)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{M()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Oa),n.dataset.listenerAttached="true")}F();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=_e(e.value);n?en(n):t&&(t.textContent=Ke())}else t&&(t.textContent=Ke());M(),me(!1)});document.addEventListener(An.USER_UPDATED,()=>{M()});window.addEventListener("maintenance:updated",()=>{Z=xe(),M()});const Qe="__ART_RATIO_LAST_DASHBOARD_TAB__",pe="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",on=/^[a-z0-9\-]+$/i;function Me(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!on.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function cn(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!on.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function ln(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let H=null,G=null,z=!1,B=null,Lt=null,ae=null,ze=null,h={attempts:0,delay:30};function Ga(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(s,{skipStore:r=!1}={})=>{if(!s)return;const i=e.filter(l=>l?.getAttribute("data-tab")===s),d=document.getElementById(s);!i.length||!d||(e.forEach(l=>{const u=l?.getAttribute("data-tab")===s;l.classList.toggle("active",u),u?(l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0")):(l.setAttribute("aria-selected","false"),l.setAttribute("tabindex","-1"))}),t.forEach(l=>{const u=l.id===s;l.style.display=u?"block":"none",l.classList.toggle("active",u)}),H=s,cn(Qe,s),r||Se({dashboardTab:s}).catch(l=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",l)}),s!=="reservations-tab"&&(G=null,B=null,ln(pe),r||Se({dashboardSubTab:null}).catch(l=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",l)})),s==="customers-tab"&&(console.log("👤 Rendering customers"),$n()),s==="equipment-tab"&&(console.log("📦 Rendering equipment"),et()),s==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),M()),s==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Pn()),s==="reservations-tab"&&(console.log("📅 Rendering reservations"),$t(),Wa(),B&&(ke(B),B=null)))};e.forEach(s=>{s&&(s.getAttribute("type")||s.setAttribute("type","button"),s.setAttribute("role","tab"),s.hasAttribute("tabindex")||s.setAttribute("tabindex",s.classList.contains("active")?"0":"-1"),s.addEventListener("click",()=>{const r=s.getAttribute("data-tab");console.log("🖱️ Tab clicked:",r),n(r),r!=="reservations-tab"&&Se({dashboardSubTab:null}).catch(i=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",i)})}))});const a=s=>{const r=document.querySelector("[data-tab].active"),i=Me(Qe),d=e[0]?.getAttribute("data-tab")||null,u=[s?.dashboardTab,i,H,r?.getAttribute("data-tab"),d].filter(Boolean).find(f=>document.getElementById(f))||d;u&&(!z||u!==H)&&(console.log("⭐ Initial tab:",u),n(u,{skipStore:!0}));const m=[s?.dashboardSubTab,Me(pe)].filter(Boolean).find(f=>document.getElementById(f));m&&(H==="reservations-tab"&&typeof ae=="function"?(!z||m!==G)&&ae(m,{skipStore:!0}):B=m),z||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),z=!0)},o=typeof Ie=="function"?Ie():null;a(o||null),wn().then(s=>a(s||null)).catch(s=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",s),a(null)}),Lt||(Lt=Ln(s=>{!z||!s||(s.dashboardTab&&s.dashboardTab!==H&&n(s.dashboardTab,{skipStore:!0}),H==="reservations-tab"?s.dashboardSubTab&&s.dashboardSubTab!==G?ke(s.dashboardSubTab):!s.dashboardSubTab&&G&&ke(null):s.dashboardSubTab&&(B=s.dashboardSubTab))}))}function Wa(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(o=>o?.getAttribute("data-sub-tab")).filter(o=>typeof o=="string"&&o.trim().length>0),a=(o,{skipStore:s=!1}={})=>{if(!n.length)return;let r=o;(!r||!n.includes(r))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:r,available:n}),r=n[0]);const i=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${r}"]`),d=document.getElementById(r);if(!i||!d){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:r});return}e.forEach(l=>{l.classList.remove("active"),l.classList.contains("tab")&&l.classList.remove("tab-active"),l.setAttribute("aria-selected","false"),l.setAttribute("tabindex","-1")}),i.classList.add("active"),i.classList.contains("tab")&&i.classList.add("tab-active"),i.setAttribute("aria-selected","true"),i.setAttribute("tabindex","0"),t.forEach(l=>{const u=l.id===r;l.classList.toggle("active",u),l.setAttribute("aria-hidden",u?"false":"true"),u?(l.removeAttribute("hidden"),l.style.display="block"):(l.setAttribute("hidden",""),l.style.display="none")}),G=r,cn(pe,r),s||Se({dashboardSubTab:r}).catch(l=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",l)}),r==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{$t()},50)):r==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{De()},100)):r==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{L()},50))};if(ae=(o,s={})=>{o?a(o,s):(e.forEach(r=>{r.classList.remove("active"),r.classList.contains("tab")&&r.classList.remove("tab-active"),r.setAttribute("aria-selected","false"),r.setAttribute("tabindex","-1")}),t.forEach(r=>{r.classList.remove("active"),r.setAttribute("aria-hidden","true"),r.setAttribute("hidden",""),r.style.display="none"}),G=null,ln(pe))},e.forEach(o=>{o.addEventListener("click",()=>{const s=o.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",s),a(s)})}),B)a(B,{skipStore:!0}),B=null;else{const o=document.querySelector("#reservations-tab .sub-tab-button.active"),s=n[0]||null,r=o?.getAttribute("data-sub-tab")||s;r&&(console.log("⭐ Initial sub-tab:",r),a(r,{skipStore:!0}))}xt()}function ke(e){typeof ae=="function"?ae(e,{skipStore:!0}):e&&(B=e)}function Ka(){try{if(typeof Ie=="function")return Ie()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function Za(){if(!z)return;const e=Ka(),t=Array.from(document.querySelectorAll("[data-tab]")),n=Array.from(document.querySelectorAll(".tab-content-wrapper > .tab"));if(!t.length||!n.length){h.attempts>0&&x({attempts:h.attempts,delay:h.delay});return}const a=n.find(r=>r.classList.contains("active")),o=t.find(r=>r.classList.contains("active"));let s=a?.id??o?.dataset.tab??(e.dashboardTab&&document.getElementById(e.dashboardTab)?e.dashboardTab:null)??(()=>{const r=Me(Qe);return r&&document.getElementById(r)?r:null})()??t[0]?.dataset.tab;if(!s){h.attempts>0&&x({attempts:h.attempts,delay:h.delay});return}if(t.forEach(r=>{const i=r.dataset.tab===s;r.classList.toggle("active",i),r.classList.contains("tab")&&r.classList.toggle("tab-active",i)}),n.forEach(r=>{const i=r.id===s;r.style.display=i?"block":"none",r.classList.toggle("active",i)}),H=s,s==="reservations-tab"){const r=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button")),i=r[0]?.getAttribute("data-sub-tab")||null;if(!r.length){h.attempts>0&&x({attempts:h.attempts,delay:h.delay});return}const l=[G,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,e.dashboardSubTab&&document.getElementById(e.dashboardSubTab)?e.dashboardSubTab:null,(()=>{const u=Me(pe);return u&&document.getElementById(u)?u:null})(),i].filter(Boolean).find(u=>document.getElementById(u))||i;if(l){if(typeof ae=="function")ke(l);else if(i){B=l,h.attempts>0&&x({attempts:h.attempts,delay:h.delay});return}else if(h.attempts>0){x({attempts:h.attempts,delay:h.delay});return}}else if(h.attempts>0){x({attempts:h.attempts,delay:h.delay});return}}h={attempts:0,delay:h.delay}}function x({attempts:e=3,delay:t=30}={}){z&&(h={attempts:e,delay:t},ze&&clearTimeout(ze),ze=setTimeout(()=>{h.attempts>0&&(h={attempts:h.attempts-1,delay:h.delay}),Za()},t))}document.addEventListener("language:translationsReady",x);document.addEventListener("language:changed",x);document.addEventListener("theme:changed",x);const ve={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let Je=!1;const Qa=1632,Ja=1776;function Xa(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-Qa)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-Ja)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function es(e){try{const t=Xa(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function Ee(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=es(t))}function kt(){Je=!1;const e=O(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,o=Array.isArray(e.technicians)?e.technicians.length:0;ve.projects.forEach(s=>Ee(s,t)),ve.reservations.forEach(s=>Ee(s,n)),ve.equipment.forEach(s=>Ee(s,a)),ve.technicians.forEach(s=>Ee(s,o))}function It(){Je||(Je=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(kt):setTimeout(kt,16))}function ts(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,It,{passive:!0})}),It()}function ns(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function as({sidebar:e,backdrop:t}){e?.classList.add("open"),t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function Te({sidebar:e,backdrop:t}){e?.classList.remove("open"),t?.classList.remove("open"),e?.setAttribute("aria-hidden","true")}function ss(){const e=document.querySelector("[data-dashboard-greeting]");if(!e)return;const t=e.querySelector("[data-greeting-toggle]"),n=e.querySelector("[data-greeting-panel]");if(!t||!n)return;const a=i=>{i.target instanceof Node&&(e.contains(i.target)||r(!1))},o=()=>{window.requestAnimationFrame(()=>{document.addEventListener("click",a,{capture:!0})})},s=()=>{document.removeEventListener("click",a,{capture:!0})},r=i=>{n.hidden=!i,t.setAttribute("aria-expanded",String(i)),e.dataset.state=i?"open":"closed",i?o():s()};r(!1),t.addEventListener("click",()=>{const d=!(t.getAttribute("aria-expanded")==="true");r(d),d&&!window.matchMedia("(min-width: 768px)").matches&&n.scrollIntoView({behavior:"smooth",block:"start"})})}function rs(){const e=ns(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:o}=e;t&&(t.setAttribute("aria-hidden","true"),a?.addEventListener("click",s=>{s.preventDefault(),as(e)}),o?.addEventListener("click",s=>{s.preventDefault(),Te(e)}),n?.addEventListener("click",()=>{Te(e)}),t.addEventListener("click",s=>{const r=s.target;if(r instanceof HTMLElement){if(r.hasAttribute("data-close-sidebar")||r.closest("[data-close-sidebar]")){Te(e);return}r.closest("[data-tab]")&&Te(e)}}),ss())}kn();let C=null;async function qt(){if(!await In())return;rs(),Ga(),ts(),qn(),et(),De(),Ya(),ta(),Bn(),xt();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const o=a.target.files&&a.target.files[0];o&&(await On(o),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",Cn),os(),is()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{qt().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):qt().catch(e=>{console.error("❌ Failed to initialise app",e)});function os(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[o]=a.split(":"),s=`${o.padStart(2,"0")}:00`,r=`${n}T${s}`;e.value!==r&&(e.value=r,setTimeout(()=>e.blur(),150))})})}function is(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;C={reservationId:t,reservationIndex:n!=null?Number(n):null},dn(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),o=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,o)}function dn(){if(!C)return;const t=O().reservations||[];let n=null;if(C.reservationId){const a=t.findIndex(o=>String(o?.id)===C.reservationId||String(o?.reservationId)===C.reservationId);a!==-1&&(n=a)}n===null&&typeof C.reservationIndex=="number"&&!Number.isNaN(C.reservationIndex)&&C.reservationIndex>=0&&C.reservationIndex<t.length&&(n=C.reservationIndex),n!==null&&(C=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const o=window.editReservation;typeof o=="function"&&o(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{C&&dn()});
