import{r as t,a as Z,t as d,f as v,b as k,d as O,e as ue,c as $,p as pe,g as J,h as me,i as fe,j as he,k as ye,l as ge,m as ve,n as be,o as xe,q as ke,s as Se,u as we,v as Ee,w as Ce,x as Le,y as De,z as _}from"./calculations.Coh920ba.js";import{l as $e,a as T,b as Re,n as I,g as Te}from"./auth.CEd-_0Yw.js";import{z as Pe,v as ee,w as Ae}from"./reservationsService.D3p0GGnB.js";import{mapMaintenanceFromApi as te}from"./maintenanceService.CumtOplj.js";import{C as Ie,D as Me,E as Be,F as Ne}from"./controller.gCj0UkD7.js";function ae(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function re(e={}){const a=String(e?.barcode??"").trim(),r=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:a,desc:r,description:r,name:e?.name??r,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function ne(e={}){const a=e?.title??e?.name??"",r=e?.project_code??e?.projectCode??"",n=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:a,code:r,status:n,confirmed:s}}function Fe(){let e;try{e=$e()}catch(g){return console.warn("âš ï¸ [reports] Failed to access cached data",g),!1}if(!e||typeof e!="object")return!1;const{reservations:a=[],customers:r=[],equipment:n=[],technicians:s=[],projects:o=[],maintenance:i=[]}=e;if(!(a.length||r.length||n.length||s.length||o.length))return!1;t.data.reservations=Array.isArray(a)?a.map(Pe):[],t.data.customers=Array.isArray(r)?r.map(ae):[],t.data.equipment=Array.isArray(n)?n.map(re):[],t.data.technicians=Array.isArray(s)?s.map(ee):[],t.data.projects=Array.isArray(o)?o.map(ne):[],t.data.projectsMap=new Map(t.data.projects.map(g=>[g.id,g])),t.data.maintenance=Array.isArray(i)?i.map(te):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(g=>[String(g.id),g]));try{Z()}catch{}return!0}async function se({silent:e=!1}={}){if(!t.loading){t.loading=!0,t.errorMessage="",e||t.callbacks.onBeforeRender?.();try{const[a,r,n,s,o,i]=await Promise.all([T("/reservations/?limit=500"),T("/customers/?limit=500"),T("/equipment/?limit=500"),T("/technicians/?limit=500"),T("/projects/?limit=500"),T("/maintenance/?limit=500")]);t.data.reservations=Array.isArray(a?.data)?a.data.map(c=>Ae(c)):[],t.data.customers=Array.isArray(r?.data)?r.data.map(ae):[],t.data.equipment=Array.isArray(n?.data)?n.data.map(re):[],t.data.technicians=Array.isArray(s?.data)?s.data.map(ee):[],t.data.projects=Array.isArray(o?.data)?o.data.map(ne):[],t.data.projectsMap=new Map(t.data.projects.map(c=>[c.id,c])),t.data.maintenance=Array.isArray(i?.data)?i.data.map(te):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(c=>[String(c.id),c]));try{Z()}catch{}}catch(a){console.error("âŒ [reports] Failed to load reports data",a),t.errorMessage=a instanceof Re?a.message:d("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!t.data.projectsMap||!(t.data.projectsMap instanceof Map))&&(t.data.projectsMap=new Map)}finally{t.loading=!1,e||t.callbacks.onAfterRender?.()}}}function G(e){if(t.loadedScripts.has(e))return t.loadedScripts.get(e);const a=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,r=new Promise((n,s)=>{const o=()=>{a&&(a.dataset.loaded="true"),n()},i=g=>s(g);if(a){if(a.dataset.loaded==="true"){n();return}a.addEventListener("load",o,{once:!0}),a.addEventListener("error",i,{once:!0});return}const c=document.createElement("script");c.src=e,c.async=!0,c.onload=()=>{c.dataset.loaded="true",n()},c.onerror=g=>s(g),document.head.appendChild(c)});return t.loadedScripts.set(e,r),r}function K(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(t.apexChartsReady||(t.apexChartsReady=G("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),t.apexChartsReady)}function je(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(t.html2PdfReady||(t.html2PdfReady=G("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),t.html2PdfReady)}function He(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(t.xlsxReady||(t.xlsxReady=G("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),t.xlsxReady)}function q(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function D(e,a){const r=document.getElementById(e);if(r){if(!a||a.length===0){r.innerHTML=`<div class="text-sm text-base-content/60">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}r.innerHTML=a.map(n=>{const s=Math.min(Math.max(n.percent??0,0),100),o=d("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",v(n.rawCount??n.value??0)),i=n.className?`reports-progress-fill ${n.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${n.label}</span>
            <span class="reports-progress-value">${v(n.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}async function qe(e){const a=document.getElementById("reports-volume-chart");if(!a)return;const r=Array.isArray(e)?e:[];if(t.lastTrendData=r,!r.length){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const n=await K();if(!n){a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const s=r.map(p=>p.label),o=r.map(p=>Math.round(p.count||0)),i=r.map(p=>Number(p.revenue||0)),c=r.map(p=>Number(p.netProfit||0)),g=o.reduce((p,b)=>p+(Number.isFinite(b)?b:0),0),u=i.reduce((p,b)=>p+(Number.isFinite(b)?b:0),0),h=c.reduce((p,b)=>p+(Number.isFinite(b)?b:0),0);if(g===0&&u===0&&h===0){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const f=[{name:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:o},{name:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:i},{name:d("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:c,yAxisIndex:1}],m={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(p,b,S)=>{if(S?.dataPointIndex!=null){const R=t.lastTrendData[S.dataPointIndex];t.callbacks.onTrendDrilldown?.(R,S.dataPointIndex)}}}},theme:{mode:q()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:s,labels:{style:{colors:q()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:p=>v(p)},title:{text:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:p=>k(p)},title:{text:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(p,{seriesIndex:b})=>b===0?v(p):k(p)}}};t.charts.trend?(t.charts.trend.updateOptions({...m},!0,!0),t.charts.trend.updateSeries(f,!0)):(a.innerHTML="",t.charts.trend=new n(a,{...m,series:f}),t.charts.trend.render())}catch(n){console.error("âš ï¸ [reports] Failed to render trend chart",n),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ze(e){const a=document.getElementById("reports-status-chart"),r="reports-status-breakdown";if(!a)return;const n=Array.isArray(e)?e:[];t.lastStatusData=n;const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,c)=>i+c,0);if(!n.length||o===0){t.charts.status&&(t.charts.status.destroy(),t.charts.status=null),D(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const i=await K();if(!i){D(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const c=n.map(u=>u.label),g={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,h,f)=>{if(f?.dataPointIndex!=null){const m=t.lastStatusData[f.dataPointIndex];m?.filterKey&&t.callbacks.onStatusDrilldown?.(m,f.dataPointIndex)}}}},theme:{mode:q()},labels:c,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:d("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>v(s.reduce((u,h)=>u+h,0))}}}}},tooltip:{y:{formatter:(u,h)=>{const f=t.lastStatusData?.[h?.seriesIndex||0],m=f?`${v(f.percent)}%`:`${v(u)}%`;return`${f?v(f.rawCount??f.value??0):v(u)} / ${m}`}}}};t.charts.status?(t.charts.status.updateOptions({...g},!0,!0),t.charts.status.updateSeries(s,!0)):(a.innerHTML="",t.charts.status=new i(a,{...g,series:s}),t.charts.status.render()),D(r,n)}catch(i){console.error("âš ï¸ [reports] Failed to render status chart",i),D(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function _e(e){const a=document.getElementById("reports-payment-chart"),r="reports-payment-breakdown";if(!a)return;const n=Array.isArray(e)?e:[];t.lastPaymentData=n;const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,c)=>i+c,0);if(!n.length||o===0){t.charts.payment&&(t.charts.payment.destroy(),t.charts.payment=null),D(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const i=await K();if(!i){D(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const c=n.map(u=>u.label),g={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(u,h,f)=>{if(f?.dataPointIndex!=null){const m=t.lastPaymentData[f.dataPointIndex];m?.filterKey&&t.callbacks.onPaymentDrilldown?.(m,f.dataPointIndex)}}}},theme:{mode:q()},labels:c,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:u=>`${Math.round(u)}%`},tooltip:{y:{formatter:(u,h)=>{const f=t.lastPaymentData?.[h?.seriesIndex||0],m=f?`${v(f.percent)}%`:`${v(u)}%`;return`${f?v(f.rawCount??f.value??0):v(u)} / ${m}`}}}};t.charts.payment?(t.charts.payment.updateOptions({...g},!0,!0),t.charts.payment.updateSeries(s,!0)):(a.innerHTML="",t.charts.payment=new i(a,{...g,series:s}),t.charts.payment.render()),D(r,n)}catch(i){console.error("âš ï¸ [reports] Failed to render payment chart",i),D(r,[]),a.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}function Ue(e){const a=document.getElementById("reports-kpi-total"),r=document.getElementById("reports-kpi-total-meta"),n=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),g=document.getElementById("reports-kpi-paid"),u=document.getElementById("reports-kpi-paid-meta"),h=e.total||0,f=e.revenue||0,m=e.confirmed||0,p=e.paidCount||0,b=e.average||0,S=e.companyShareTotal||0,R=e.taxTotal||0,M=e.crewTotal||0,B=e.crewCostTotal||0,N=e.netProfit||0,F=e.maintenanceExpense||0,ie=h?Math.round(m/h*100):0,ce=h?Math.round(p/h*100):0;if(a&&(a.textContent=v(h)),r){const w=d("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",v(e.completed||0));r.textContent=w}if(n&&(n.textContent=k(f)),s)if(h===0)s.textContent=d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const w=d("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");s.textContent=w.replace("{net}",k(N)).replace("{share}",k(S)).replace("{average}",k(b))}if(o)if(f>0){const w=[{label:d("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:k(f)},{label:d("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:k(S)},{label:d("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:k(R)},{label:d("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:k(M)},{label:d("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:k(B)}];F>0&&w.push({label:d("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${k(F)}`}),w.push({label:d("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:k(N)}),o.innerHTML=w.map(({label:le,value:de})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${le}</span>
            <span class="reports-kpi-detail-value">${de}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(i&&(i.textContent=`${ie}%`),c){const w=d("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",v(m));c.textContent=w}if(g&&(g.textContent=`${ce}%`),u){const w=d("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",v(p));u.textContent=w}}function E(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function z(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Oe(e,a,r){const n=document.getElementById("reports-reservations-body");if(!n)return[];if(!e||e.length===0)return n.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const s=new Map((a||[]).map(m=>[String(m.id),m]));new Map((r||[]).map(m=>[String(m.id),m]));const o={code:d("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:d("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:d("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:d("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:d("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:d("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:d("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:d("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},i=We([...e]),{page:c,pageSize:g}=t.pagination,u=Math.max(0,(c-1)*g),f=i.slice(u,u+g).map(m=>{const p=Ke(m,s),b={[o.code]:p.code.text,[o.customer]:p.customer.text,[o.date]:p.date.text,[o.status]:p.status.text,[o.payment]:p.payment.text,[o.total]:p.total.text,[o.share]:p.share.text,[o.net]:p.net.text};return{formatted:p,exportRow:b}});return n.innerHTML=f.map(({formatted:m})=>`
      <tr data-drilldown="reservation" data-search="${z(m.code.text)}">
        <td data-report-column="code">${m.code.html}</td>
        <td data-report-column="customer">${m.customer.html}</td>
        <td data-report-column="date">${m.date.html}</td>
        <td data-report-column="status">${m.status.html}</td>
        <td data-report-column="payment">${m.payment.html}</td>
        <td data-report-column="total">${m.total.html}</td>
        <td data-report-column="share">${m.share.html}</td>
        <td data-report-column="net">${m.net.html}</td>
      </tr>
    `).join(""),Ge(i.length),Xe(),f.map(({exportRow:m})=>m)}function Xe(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(a=>{a.dataset.sortBound!=="true"&&(a.addEventListener("click",()=>{const r=a.dataset.sortKey;r&&(t.sort.key===r?t.sort.dir=t.sort.dir==="asc"?"desc":"asc":(t.sort.key=r,t.sort.dir="asc"),t.pagination.page=1,t.callbacks.onRender?.())}),a.dataset.sortBound="true")})}function We(e){const{key:a,dir:r}=t.sort||{key:"date",dir:"desc"},n=r==="asc"?1:-1;return e.sort((s,o)=>n*Ve(s,o,a))}function Ve(e,a,r){switch(r){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(a?.reservationId??a?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(a?.customerName??a?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(a?.start||0);case"status":{const n=O(e)?.statusValue||"",s=O(a)?.statusValue||"";return String(n).localeCompare(String(s),"ar")}case"total":{const n=$(e)?.finalTotal||0,s=$(a)?.finalTotal||0;return n-s}case"share":{const n=$(e)?.companyShareAmount||0,s=$(a)?.companyShareAmount||0;return n-s}case"net":{const n=$(e)?.netProfit||0,s=$(a)?.netProfit||0;return n-s}default:return new Date(e?.start||0)-new Date(a?.start||0)}}function Ge(e){const a=document.getElementById("reports-table-pagination");if(!a)return;const{page:r,pageSize:n}=t.pagination,s=Math.max(1,Math.ceil(e/n)),o=r<=1?"disabled":"",i=r>=s?"disabled":"",c=e===0?0:(r-1)*n+1,g=Math.min(r*n,e);a.innerHTML=`
    <div class="pager">
      <button type="button" ${o} data-page="prev">â—€</button>
      <button type="button" ${i} data-page="next">â–¶</button>
    </div>
    <div class="page-info">${v(c)}â€“${v(g)} / ${v(e)}</div>
    <div class="pager page-size">
      <label>${d("reservations.reports.pageSize","Ù„ÙƒÙ„ ØµÙØ­Ø©","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,a.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{t.pagination.page>1&&(t.pagination.page-=1,t.callbacks.onRender?.())}),a.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const u=Math.max(1,Math.ceil(e/t.pagination.pageSize));t.pagination.page<u&&(t.pagination.page+=1,t.callbacks.onRender?.())}),a.querySelectorAll("[data-size]")?.forEach(u=>{u.addEventListener("click",()=>{const h=Number(u.dataset.size);Number.isFinite(h)&&h>0&&(t.pagination.pageSize=h,t.pagination.page=1,t.callbacks.onRender?.())})})}function Ke(e,a,r){const n=e?.reservationId||e?.id||"â€”",s=I(String(n)),i=a.get(String(e?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),c=O(e),g=Ye(c.statusValue),u=Qe(c.statusValue,g),h=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],f=Ze(c.paidStatus,h),m=h.length;let p=f.html;if(m>0){const F=d("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",v(m));p=`<div class="reports-payment-cell">${f.html}<small class="reports-payment-subtext">${E(F)}</small></div>`}const b=ue(e?.start),S=$(e),R=k(S.finalTotal),M=S.companySharePercent>0?`${v(S.companySharePercent)}% (${k(S.companyShareAmount)})`:d("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),B=k(S.netProfit),N=E(i);return{code:{html:E(s),text:s},customer:{html:N,text:i},date:{html:E(b),text:b},status:u,payment:{html:p,text:f.text},total:{html:E(R),text:R},share:{html:E(M),text:M},net:{html:E(B),text:B}}}function Ye(e){switch(e){case"completed":return j(d("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return j(d("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return j(d("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return I(e||"â€”")}}function Qe(e,a){const r=j(a);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${E(r)}</span>`,text:r}}function Ze(e,a=[]){const r=pe(e),n=String(e??"").toLowerCase(),s=n==="paid"?"paid":n==="partial"?"partial":"unpaid";let o="";const i=d("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(a)&&a.length&&(o=a.map(u=>{const h=u?.recordedAt?J(u.recordedAt):"â€”",f=Number.isFinite(Number(u?.amount))&&Number(u.amount)>0?`${I(Number(u.amount).toFixed(2))} ${i}`:"",m=Number.isFinite(Number(u?.percentage))&&Number(u.percentage)>0?`${I(Number(u.percentage).toFixed(2))}%`:"",p=[h];return f&&p.push(f),m&&p.push(m),p.filter(Boolean).join(" â€¢ ")}).join(`
`));const c=o?` title="${z(o)}"`:"";return{html:`<span class="reservation-chip status-${s}"${c}>${E(r)}</span>`,text:r}}function j(e){return I(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function Y(e){const a=J(new Date).replace(/-/g,"");return`${d("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${a}.${e}`}function Je(e,a,r){const n=new Blob([e],{type:r}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=a,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function X(e){if(!e||!e.length)return;const a=Object.keys(e[0]),r=[a.join(",")];e.forEach(s=>{const o=a.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);r.push(o.join(","))});const n=`\uFEFF${r.join(`\r
`)}\r
`;Je(n,Y("csv"),"text/csv;charset=utf-8;")}async function et(e){try{const a=await He();if(!a){X(e);return}const r=a.utils.json_to_sheet(e),n=a.utils.book_new(),s=d("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");a.utils.book_append_sheet(n,r,s),a.writeFile(n,Y("xlsx"))}catch(a){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",a),X(e)}}async function tt(){const e=document.getElementById("reservations-report-printable");if(!e)return;const a=await je();if(typeof a!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const r=Y("pdf");Ie();const n=[];Me(e,window,n),Be(e,window,n);try{await a().set({margin:10,filename:r,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(s){console.error("âš ï¸ [reports] export failed",s)}finally{Ne(n)}}async function at(e,a){switch(e){case"pdf":await tt();break;case"excel":await et(a);break;case"csv":default:X(a);break}}function rt(e){const a=document.getElementById("reports-top-customers");if(a){if(!e||e.length===0){a.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}a.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${z(r.name)}">
        <td>${E(r.name)}</td>
        <td>${v(r.count)}</td>
        <td>${k(r.revenue)}</td>
      </tr>
    `).join("")}}function nt(e){const a=document.getElementById("reports-top-equipment");if(a){if(!e||e.length===0){a.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}a.innerHTML=e.map(r=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${z(r.name)}">
        <td>${E(r.name)}</td>
        <td>${v(r.count)}</td>
        <td>${k(r.revenue)}</td>
      </tr>
    `).join("")}}const y=t.filters;function st(e){if(t.columnControlsBound)return;const a=document.getElementById("reports-column-controls");a&&(a.querySelectorAll("input[data-column-toggle]").forEach(r=>{const n=r.dataset.columnToggle;n&&(r.checked=t.columnPreferences[n]!==!1,r.addEventListener("change",()=>{t.columnPreferences[n]=r.checked,e()}))}),t.columnControlsBound=!0,e())}function oe(){Object.entries(t.columnPreferences).forEach(([e,a])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(r=>{r.classList.toggle("hidden",!a)})})}function ot(e){if(t.exportHandlersBound)return;const a=document.querySelectorAll("[data-export]");a.length&&(a.forEach(r=>{r.addEventListener("click",async()=>{const{export:n=""}=r.dataset;if(n){r.disabled=!0;try{await e(n)}catch(s){console.error("âš ï¸ [reports] export failed",s)}finally{r.disabled=!1}}})}),t.exportHandlersBound=!0)}function it(e,a){t.searchDebounceTimer&&(clearTimeout(t.searchDebounceTimer),t.searchDebounceTimer=null),t.searchDebounceTimer=setTimeout(()=>{y.search=e||"",a()},220)}function ct(e,a){e&&(y.range="custom",y.start=e.startInput||null,y.end=e.endInput||null,a())}function lt(e,a){e&&(y.status=y.status===e?"all":e,a())}function dt(e,a){e&&(y.payment=y.payment===e?"all":e,a())}function ut(e,a){e&&(y.search=e,a())}function pt({onClear:e}={}){const a=document.getElementById("reservations-active-filters");if(!a)return;const r=[],n=(s,o,i)=>{r.push(`<span class="filter-chip" data-chip="${s}">${o} <button type="button" aria-label="clear" data-clear="${s}">âœ•</button></span>`)};if(y.range&&y.range!=="all"){let s="";switch(y.range){case"last30":s=translate("reservations.reports.filters.range.last30","Ø¢Ø®Ø± 30 ÙŠÙˆÙ…","Last 30 days");break;case"thisWeek":s=translate("reservations.reports.filters.range.thisWeek","Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","This week");break;case"thisMonth":s=translate("reservations.reports.filters.range.thisMonth","Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±","This month");break;case"thisQuarter":s=translate("reservations.reports.filters.range.thisQuarter","Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹","This quarter");break;case"thisYear":s=translate("reservations.reports.filters.range.thisYear","Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…","This year");break;case"custom":s=`${translate("reservations.reports.filters.range.custom","Ù…Ø®ØµØµ","Custom")} (${y.start||"â€”"} â†’ ${y.end||"â€”"})`;break;default:s=y.range}n("range",s)}if(y.status&&y.status!=="all"){const s=translate(`reservations.reports.filters.status.${y.status}`,y.status,y.status);n("status",s)}if(y.payment&&y.payment!=="all"){const s=translate(`reservations.reports.filters.payment.${y.payment}`,y.payment,y.payment);n("payment",s)}if(y.share&&y.share!=="all"){const s=translate(`reservations.reports.filters.share.${y.share}`,y.share,y.share);n("share",s)}y.search&&y.search.trim().length&&n("search",`ğŸ” ${y.search.trim()}`),a.innerHTML=r.join(""),a.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.clear;o&&(o==="range"?(y.range="all",y.start=null,y.end=null):o in y&&(o==="search"?y.search="":y[o]="all"),e?.(o))})})}const l=t.filters;function Q(){_(),x(),setTimeout(()=>{_(),x(),H()},0),setTimeout(()=>{_(),x(),H()},60),H()}function A(){l.range==="custom"&&x()}function H(e,a){if(!window.flatpickr)return;e&&(t.startDateInputRef=e),a&&(t.endDateInputRef=a);const r=t.startDateInputRef,n=t.endDateInputRef;if(!r&&!n)return;const s=mt(),o=i=>{const c={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(c.locale=s),c};if(t.startDatePicker&&(t.startDatePicker.destroy(),t.startDatePicker=null),t.endDatePicker&&(t.endDatePicker.destroy(),t.endDatePicker=null),r&&(t.startDatePicker=window.flatpickr(r,o({onChange(i,c){l.start=c||null,t.endDatePicker&&(i?.length?t.endDatePicker.set("minDate",i[0]):t.endDatePicker.set("minDate",null)),A()},onValueUpdate(i,c){l.start=c||null,A()}}))),n&&(t.endDatePicker=window.flatpickr(n,o({onChange(i,c){l.end=c||null,t.startDatePicker&&(i?.length?t.startDatePicker.set("maxDate",i[0]):t.startDatePicker.set("maxDate",null)),A()},onValueUpdate(i,c){l.end=c||null,A()}}))),t.startDatePicker&&r){t.startDatePicker.setDate(r.value,!1);const i=t.endDatePicker?.selectedDates?.[0]||t.endDateInputRef?.value;i&&t.startDatePicker.set("maxDate",i)}if(t.endDatePicker&&n){t.endDatePicker.setDate(n.value,!1);const i=t.startDatePicker?.selectedDates?.[0]||t.startDateInputRef?.value;i&&t.endDatePicker.set("minDate",i)}}function mt(){return(Te()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function W(e,a){e&&(e.classList.toggle("active",!!a),e.classList.toggle("hidden",!a))}function L(){const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),o=document.getElementById("reports-start"),i=document.getElementById("reports-end"),c=document.getElementById("reports-custom-range");e&&e.value!==l.range&&(e.value=l.range),a&&a.value!==l.status&&(a.value=l.status),r&&r.value!==l.payment&&(r.value=l.payment),n&&n.value!==l.share&&(n.value=l.share),s&&s.value!==l.search&&(s.value=l.search||""),o&&o.value!==(l.start||"")&&(o.value=l.start||""),i&&i.value!==(l.end||"")&&(i.value=l.end||""),W(c,l.range==="custom")}function ft(){try{const e=new URLSearchParams(window.location.search),a=n=>e.get(n),r=n=>n==null||n===""?null:n;l.range=a("range")||l.range,l.status=a("status")||l.status,l.payment=a("payment")||l.payment,l.share=a("share")||l.share,l.search=a("search")||"",l.start=r(a("start")),l.end=r(a("end")),l.range!=="custom"&&(l.start=null,l.end=null)}catch{}}let U=null;function C(){U&&clearTimeout(U),U=setTimeout(()=>{try{const e=new URLSearchParams,a=(s,o,i)=>{o!=null&&o!==""&&o!==i&&e.set(s,o)};a("range",l.range,"all"),a("status",l.status,"all"),a("payment",l.payment,"all"),a("share",l.share,"all"),a("search",l.search,""),l.range==="custom"&&(a("start",l.start,null),a("end",l.end,null));const r=e.toString(),n=r?`${location.pathname}?${r}`:location.pathname;window.history.replaceState({},"",n)}catch{}},120)}function V({active:e,icon:a,title:r,subtitle:n}){const s=document.getElementById("reports-empty-state");if(!s)return;const o=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),c=s.querySelector("p");t.emptyDefaults.icon===null&&o&&(t.emptyDefaults.icon=o.textContent),t.emptyDefaults.title===null&&i&&(t.emptyDefaults.title=i.textContent),t.emptyDefaults.subtitle===null&&c&&(t.emptyDefaults.subtitle=c.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!o||!i||!c)&&(e?(o.textContent=a!==void 0?a:t.emptyDefaults.icon??o.textContent,i.textContent=r!==void 0?r:t.emptyDefaults.title??i.textContent,c.textContent=n!==void 0?n:t.emptyDefaults.subtitle??c.textContent):(o.textContent=t.emptyDefaults.icon??o.textContent,i.textContent=t.emptyDefaults.title??i.textContent,c.textContent=t.emptyDefaults.subtitle??c.textContent))}function ht(e){V({active:!!e})}function yt(){if(t.drilldownBound)return;const e=document.getElementById("reports-top-customers"),a=document.getElementById("reports-top-equipment"),r=document.getElementById("reports-reservations-body"),n=s=>{const o=s.target?.closest("[data-drilldown]");if(!o)return;const i=o.dataset.search||"";ut(i,()=>{L(),x()})};e?.addEventListener("click",n),a?.addEventListener("click",n),r?.addEventListener("click",n),t.drilldownBound=!0}function P(){se({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function x(){if(L(),C(),pt({onClear:()=>{L(),C(),x()}}),t.loading){V({active:!0,icon:"â³",title:d("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:d("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(t.errorMessage){V({active:!0,icon:"âš ï¸",title:t.errorMessage,subtitle:d("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:e,customers:a,equipment:r,technicians:n,maintenance:s}=t.data,o=me(e,l,a,r,n),i=fe(o),c=he(s,l),g=ye(i,c.total),u=ge(o),h=ve(o),f=be(o),m=xe(o,a),p=ke(o,r);Ue(g),qe(u),ze(h),_e(f),rt(m),nt(p);const b=Oe(o,a,n);oe(),ht(o.length===0),t.lastSnapshot.filtered=o,t.lastSnapshot.metrics=g,t.lastSnapshot.trend=u,t.lastSnapshot.statusBreakdown=h,t.lastSnapshot.paymentBreakdown=f,t.lastSnapshot.tableRows=b,t.lastSnapshot.maintenance=c}function St(){if(t.initialized)return;t.initialized=!0;const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),c=document.getElementById("reports-custom-range"),g=document.getElementById("reports-search");if(!e)return;ft(),L(),Fe()&&x(),e.addEventListener("change",()=>{l.range=e.value,W(c,l.range==="custom"),l.range!=="custom"&&(l.start=null,l.end=null),C(),x()}),a?.addEventListener("change",()=>{l.status=a.value,C(),x()}),r?.addEventListener("change",()=>{l.payment=r.value,C(),x()}),n?.addEventListener("change",()=>{l.share=n.value,C(),x()}),g?.addEventListener("input",()=>{const h=g.value||"";it(h,()=>{L(),C(),x()})}),s?.addEventListener("change",()=>{l.start=s.value||null,C(),A()}),o?.addEventListener("change",()=>{l.end=o.value||null,C(),A()}),i?.addEventListener("click",()=>{l.range==="custom"&&(l.start=s?.value||null,l.end=o?.value||null),C(),x()}),H(s,o),W(c,l.range==="custom"),t.languageListenerAttached||(document.addEventListener("language:changed",Q),document.addEventListener("language:translationsReady",Q),t.languageListenerAttached=!0),t.dataListenersAttached||(document.addEventListener("reservations:changed",P),document.addEventListener("customers:changed",P),document.addEventListener("equipment:changed",P),document.addEventListener("projects:changed",P),document.addEventListener("technicians:updated",P),window.addEventListener("maintenance:updated",P),t.dataListenersAttached=!0),st(oe),ot(async h=>{const f=t.lastSnapshot.tableRows||[];if(!f.length){console.warn("[reports] No reservation data to export");return}await at(h,f)}),yt(),t.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>x(),0)}),t.themeListenerAttached=!0),Se(x),we(()=>{x()}),Ee(()=>{x()}),Ce(h=>{ct(h,()=>{L(),x()})}),Le(h=>{lt(h?.filterKey,()=>{L(),x()})}),De(h=>{dt(h?.filterKey,()=>{L(),x()})}),se().catch(h=>{console.error("âŒ [reports] Failed to initialise reports data",h)})}export{St as initReports,x as renderReports};
