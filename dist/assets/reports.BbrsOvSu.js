const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdfPages.ThjZquB0.js","./calculations.Da10Qu6G.js","./reservationsService.B1hsYPEN.js","./auth.JZrLedpn.js","./auth.BnBq_NNs.css","./controller.BzUaX7iX.js","./dashboard.rx3f4ToS.js","./dashboardShell.BOz0qBLn.js","./customers.D4PMCgmj.js","./index.CUo9sM62.css","./maintenanceService.B262iOVL.js","./a4Unified.SJ3XiqPC.js","./preview.C1ghwbBc.js"])))=>i.map(i=>d[i]);
import{_ as H}from"./dashboard.rx3f4ToS.js";import{r as t,g as Q,t as l,d as x,b as S,c as Z,f as he,a as T,p as ye,e as ee,h as ge,i as ve,j as be,k as xe,l as ke,m as we,n as Se,o as Ee,q as Ce,s as Le,u as Re,v as Ae,w as De,x as Pe,y as $e,z as V}from"./calculations.Da10Qu6G.js";import{l as Ie,a as N,b as Te,n as F,g as Me}from"./auth.JZrLedpn.js";import{z as Be,v as te,w as Ne}from"./reservationsService.B1hsYPEN.js";import{mapMaintenanceFromApi as re}from"./maintenanceService.B262iOVL.js";import"./controller.BzUaX7iX.js";function ae(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ne(e={}){const r=String(e?.barcode??"").trim(),a=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:r,desc:a,description:a,name:e?.name??a,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function se(e={}){const r=e?.title??e?.name??"",a=e?.project_code??e?.projectCode??"",n=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:r,code:a,status:n,confirmed:s}}function _e(){let e;try{e=Ie()}catch(y){return console.warn("⚠️ [reports] Failed to access cached data",y),!1}if(!e||typeof e!="object")return!1;const{reservations:r=[],customers:a=[],equipment:n=[],technicians:s=[],projects:o=[],maintenance:i=[]}=e;if(!(r.length||a.length||n.length||s.length||o.length))return!1;t.data.reservations=Array.isArray(r)?r.map(Be):[],t.data.customers=Array.isArray(a)?a.map(ae):[],t.data.equipment=Array.isArray(n)?n.map(ne):[],t.data.technicians=Array.isArray(s)?s.map(te):[],t.data.projects=Array.isArray(o)?o.map(se):[],t.data.projectsMap=new Map(t.data.projects.map(y=>[y.id,y])),t.data.maintenance=Array.isArray(i)?i.map(re):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(y=>[String(y.id),y]));try{Q()}catch{}return!0}async function oe({silent:e=!1}={}){if(!t.loading){t.loading=!0,t.errorMessage="",e||t.callbacks.onBeforeRender?.();try{const[r,a,n,s,o,i]=await Promise.all([N("/reservations/?limit=500"),N("/customers/?limit=500"),N("/equipment/?limit=500"),N("/technicians/?limit=500"),N("/projects/?limit=500"),N("/maintenance/?limit=500")]);t.data.reservations=Array.isArray(r?.data)?r.data.map(c=>Ne(c)):[],t.data.customers=Array.isArray(a?.data)?a.data.map(ae):[],t.data.equipment=Array.isArray(n?.data)?n.data.map(ne):[],t.data.technicians=Array.isArray(s?.data)?s.data.map(te):[],t.data.projects=Array.isArray(o?.data)?o.data.map(se):[],t.data.projectsMap=new Map(t.data.projects.map(c=>[c.id,c])),t.data.maintenance=Array.isArray(i?.data)?i.data.map(re):[],t.techniciansIndex=new Map((t.data.technicians||[]).map(c=>[String(c.id),c]));try{Q()}catch{}}catch(r){console.error("❌ [reports] Failed to load reports data",r),t.errorMessage=r instanceof Te?r.message:l("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),(!t.data.projectsMap||!(t.data.projectsMap instanceof Map))&&(t.data.projectsMap=new Map)}finally{t.loading=!1,e||t.callbacks.onAfterRender?.()}}}function O(e){if(t.loadedScripts.has(e))return t.loadedScripts.get(e);const r=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,a=new Promise((n,s)=>{const o=()=>{r&&(r.dataset.loaded="true"),n()},i=y=>s(y);if(r){if(r.dataset.loaded==="true"){n();return}r.addEventListener("load",o,{once:!0}),r.addEventListener("error",i,{once:!0});return}const c=document.createElement("script");c.src=e,c.async=!0,c.onload=()=>{c.dataset.loaded="true",n()},c.onerror=y=>s(y),document.head.appendChild(c)});return t.loadedScripts.set(e,a),a}function J(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(t.apexChartsReady||(t.apexChartsReady=O("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),t.apexChartsReady)}function St(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(t.html2PdfReady||(t.html2PdfReady=O("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),t.html2PdfReady)}function je(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(t.xlsxReady||(t.xlsxReady=O("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),t.xlsxReady)}function Et(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(t.jsZipReady||(t.jsZipReady=O("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),t.jsZipReady)}function M(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function I(e,r){const a=document.getElementById(e);if(a){if(!r||r.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}a.innerHTML=r.map(n=>{const s=Math.min(Math.max(n.percent??0,0),100),o=l("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",x(n.rawCount??n.value??0)),i=n.className?`reports-progress-fill ${n.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${n.label}</span>
            <span class="reports-progress-value">${x(n.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${o}</div>
        </div>
      `}).join("")}}function L(e,r){const a=document.querySelector(`[data-chart-loading="${e}"]`);a&&(a.style.display=r?"":"none")}async function He(e){const r=document.getElementById("reports-volume-chart");if(!r)return;const a=Array.isArray(e)?e:[];if(t.lastTrendData=a,L("volume",!0),!a.length){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("volume",!1);return}try{const n=await J();if(!n){r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("volume",!1);return}const s=a.map(b=>b.label),o=a.map(b=>Math.round(b.count||0)),i=a.map(b=>Number(b.revenue||0)),c=a.map(b=>Number(b.netProfit||0)),y=o.reduce((b,C)=>b+(Number.isFinite(C)?C:0),0),h=i.reduce((b,C)=>b+(Number.isFinite(C)?C:0),0),m=c.reduce((b,C)=>b+(Number.isFinite(C)?C:0),0);if(y===0&&h===0&&m===0){t.charts.trend&&(t.charts.trend.destroy(),t.charts.trend=null),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const g=[{name:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:o},{name:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:i},{name:l("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:c,yAxisIndex:1}],u={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(b,C,P)=>{if(P?.dataPointIndex!=null){const B=t.lastTrendData[P.dataPointIndex];t.callbacks.onTrendDrilldown?.(B,P.dataPointIndex)}}}},theme:{mode:M()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:s,labels:{style:{colors:M()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:b=>x(b)},title:{text:l("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:b=>S(b)},title:{text:l("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(b,{seriesIndex:C})=>C===0?x(b):S(b)}}},p=M(),w=String(s.join("|")),v=t.chartsMeta.trend,E=t.charts.trend&&v.theme===p&&v.categoriesSig===w;t.charts.trend&&E?t.charts.trend.updateSeries(g,!0):t.charts.trend?(t.charts.trend.updateOptions({...u},!0,!0),t.charts.trend.updateSeries(g,!0)):(r.innerHTML="",t.charts.trend=new n(r,{...u,series:g}),t.charts.trend.render()),t.chartsMeta.trend={categoriesSig:w,theme:p},L("volume",!1)}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("volume",!1)}}async function Fe(e){const r=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!r)return;const n=Array.isArray(e)?e:[];t.lastStatusData=n,L("status",!0);const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,c)=>i+c,0);if(!n.length||o===0){t.charts.status&&(t.charts.status.destroy(),t.charts.status=null),I(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("status",!1);return}try{const i=await J();if(!i){I(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("status",!1);return}const c=n.map(p=>p.label),y={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,w,v)=>{if(v?.dataPointIndex!=null){const E=t.lastStatusData[v.dataPointIndex];E?.filterKey&&t.callbacks.onStatusDrilldown?.(E,v.dataPointIndex)}}}},theme:{mode:M()},labels:c,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:l("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>x(s.reduce((p,w)=>p+w,0))}}}}},tooltip:{y:{formatter:(p,w)=>{const v=t.lastStatusData?.[w?.seriesIndex||0],E=v?`${x(v.percent)}%`:`${x(p)}%`;return`${v?x(v.rawCount??v.value??0):x(p)} / ${E}`}}}},h=M(),m=String(c.join("|")),g=t.chartsMeta.status,u=t.charts.status&&g.theme===h&&g.labelsSig===m;t.charts.status&&u?t.charts.status.updateSeries(s,!0):t.charts.status?(t.charts.status.updateOptions({...y},!0,!0),t.charts.status.updateSeries(s,!0)):(r.innerHTML="",t.charts.status=new i(r,{...y,series:s}),t.charts.status.render()),I(a,n),t.chartsMeta.status={labelsSig:m,theme:h},L("status",!1)}catch(i){console.error("⚠️ [reports] Failed to render status chart",i),I(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("status",!1)}}async function qe(e){const r=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!r)return;const n=Array.isArray(e)?e:[];t.lastPaymentData=n,L("payment",!0);const s=n.map(i=>Math.max(0,i.value||0)),o=s.reduce((i,c)=>i+c,0);if(!n.length||o===0){t.charts.payment&&(t.charts.payment.destroy(),t.charts.payment=null),I(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("payment",!1);return}try{const i=await J();if(!i){I(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("payment",!1);return}const c=n.map(p=>p.label),y={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,w,v)=>{if(v?.dataPointIndex!=null){const E=t.lastPaymentData[v.dataPointIndex];E?.filterKey&&t.callbacks.onPaymentDrilldown?.(E,v.dataPointIndex)}}}},theme:{mode:M()},labels:c,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},tooltip:{y:{formatter:(p,w)=>{const v=t.lastPaymentData?.[w?.seriesIndex||0],E=v?`${x(v.percent)}%`:`${x(p)}%`;return`${v?x(v.rawCount??v.value??0):x(p)} / ${E}`}}}},h=M(),m=String(c.join("|")),g=t.chartsMeta.payment,u=t.charts.payment&&g.theme===h&&g.labelsSig===m;t.charts.payment&&u?t.charts.payment.updateSeries(s,!0):t.charts.payment?(t.charts.payment.updateOptions({...y},!0,!0),t.charts.payment.updateSeries(s,!0)):(r.innerHTML="",t.charts.payment=new i(r,{...y,series:s}),t.charts.payment.render()),I(a,n),t.chartsMeta.payment={labelsSig:m,theme:h},L("payment",!1)}catch(i){console.error("⚠️ [reports] Failed to render payment chart",i),I(a,[]),r.innerHTML=`<p class="text-base-content/60 text-sm">${l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`,L("payment",!1)}}function ze(e){const r=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),n=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),y=document.getElementById("reports-kpi-paid"),h=document.getElementById("reports-kpi-paid-meta"),m=e.total||0,g=e.revenue||0,u=e.confirmed||0,p=e.paidCount||0,w=e.average||0,v=e.companyShareTotal||0,E=e.taxTotal||0,b=e.crewTotal||0,C=e.crewCostTotal||0,P=e.netProfit||0,B=e.maintenanceExpense||0,de=m?Math.round(u/m*100):0,ue=m?Math.round(p/m*100):0;if(r&&(r.textContent=x(m)),a){const R=l("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",x(e.completed||0));a.textContent=R}if(n&&(n.textContent=S(g)),s)if(m===0)s.textContent=l("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.");else{const R=l("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");s.textContent=R.replace("{net}",S(P)).replace("{share}",S(v)).replace("{average}",S(w))}if(o)if(g>0){const R=[{label:l("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:S(g),hint:l("reservations.reports.kpi.revenue.details.grossHint","إجمالي قيمة الحجوزات (قبل الخصومات)","Total bookings value (before discounts)")},{label:l("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:S(v),hint:l("reservations.reports.kpi.revenue.details.shareHint","تُحسب بعد الخصم، وتُضاف للإجمالي","Applied after discount and added to total")},{label:l("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:S(E),hint:l("reservations.reports.kpi.revenue.details.taxHint","ضريبة 15% على (الإجمالي بعد الخصم + نسبة الشركة)","15% VAT on (after-discount total + company share)")},{label:l("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:S(b),hint:l("reservations.reports.kpi.revenue.details.crewGrossHint","قيمة الطاقم للعميل","Crew price billed to client")},{label:l("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:S(C),hint:l("reservations.reports.kpi.revenue.details.crewHint","تكلفة الطاقم على الشركة","Crew cost to company")}];B>0&&R.push({label:l("reservations.reports.kpi.revenue.details.maintenance","مصاريف الصيانة","Maintenance expenses"),value:`−${S(B)}`}),R.push({label:l("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:S(P)}),o.innerHTML=R.map(({label:pe,value:me,hint:fe})=>`
          <div class="reports-kpi-detail-row" title="${fe||""}">
            <span class="reports-kpi-detail-label">${pe}</span>
            <span class="reports-kpi-detail-value">${me}</span>
          </div>
        `).join(""),o.classList.remove("hidden")}else o.innerHTML="",o.classList.add("hidden");if(i&&(i.textContent=`${de}%`),c){const R=l("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",x(u));c.textContent=R}if(y&&(y.textContent=`${ue}%`),h){const R=l("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",x(p));h.textContent=R}}function A(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function U(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Oe(e,r,a){const n=document.getElementById("reports-reservations-body");if(!n)return[];if(!e||e.length===0)return n.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const s=new Map((r||[]).map(u=>[String(u.id),u]));new Map((a||[]).map(u=>[String(u.id),u]));const o={code:l("reservations.reports.results.headers.id","الحجز","Reservation"),customer:l("reservations.reports.results.headers.customer","العميل","Customer"),date:l("reservations.reports.results.headers.date","التاريخ","Date"),status:l("reservations.reports.results.headers.status","الحالة","Status"),payment:l("reservations.reports.results.headers.payment","الدفع","Payment"),total:l("reservations.reports.results.headers.total","الإجمالي","Total"),share:l("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:l("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=Ve([...e]),{page:c,pageSize:y}=t.pagination,h=Math.max(0,(c-1)*y),g=i.slice(h,h+y).map(u=>{const p=We(u,s),w={[o.code]:p.code.text,[o.customer]:p.customer.text,[o.date]:p.date.text,[o.status]:p.status.text,[o.payment]:p.payment.text,[o.total]:p.total.text,[o.share]:p.share.text,[o.net]:p.net.text};return{formatted:p,exportRow:w}});return n.innerHTML=g.map(({formatted:u})=>`
      <tr data-drilldown="reservation" data-search="${U(u.code.text)}">
        <td data-report-column="code">${u.code.html}</td>
        <td data-report-column="customer">${u.customer.html}</td>
        <td data-report-column="date">${u.date.html}</td>
        <td data-report-column="status">${u.status.html}</td>
        <td data-report-column="payment">${u.payment.html}</td>
        <td data-report-column="total">${u.total.html}</td>
        <td data-report-column="share">${u.share.html}</td>
        <td data-report-column="net">${u.net.html}</td>
      </tr>
    `).join(""),Ze(i.length),Ue(),g.map(({exportRow:u})=>u)}function Ue(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(r=>{r.dataset.sortBound!=="true"&&(r.addEventListener("click",()=>{const a=r.dataset.sortKey;a&&(t.sort.key===a?t.sort.dir=t.sort.dir==="asc"?"desc":"asc":(t.sort.key=a,t.sort.dir="asc"),t.pagination.page=1,t.callbacks.onRender?.())}),r.dataset.sortBound="true")})}function Ve(e){const{key:r,dir:a}=t.sort||{key:"date",dir:"desc"},n=a==="asc"?1:-1;return e.sort((s,o)=>n*Xe(s,o,r))}function Xe(e,r,a){switch(a){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(r?.reservationId??r?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(r?.customerName??r?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(r?.start||0);case"status":{const n=Z(e)?.statusValue||"",s=Z(r)?.statusValue||"";return String(n).localeCompare(String(s),"ar")}case"total":{const n=T(e)?.finalTotal||0,s=T(r)?.finalTotal||0;return n-s}case"share":{const n=T(e)?.companyShareAmount||0,s=T(r)?.companyShareAmount||0;return n-s}case"net":{const n=T(e)?.netProfit||0,s=T(r)?.netProfit||0;return n-s}default:return new Date(e?.start||0)-new Date(r?.start||0)}}function Ze(e){const r=document.getElementById("reports-table-pagination");if(!r)return;const{page:a,pageSize:n}=t.pagination,s=Math.max(1,Math.ceil(e/n)),o=a<=1?"disabled":"",i=a>=s?"disabled":"",c=e===0?0:(a-1)*n+1,y=Math.min(a*n,e);r.innerHTML=`
    <div class="pager">
      <button type="button" ${o} data-page="prev">◀</button>
      <button type="button" ${i} data-page="next">▶</button>
    </div>
    <div class="page-info">${x(c)}–${x(y)} / ${x(e)}</div>
    <div class="pager page-size">
      <label>${l("reservations.reports.pageSize","لكل صفحة","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,r.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{t.pagination.page>1&&(t.pagination.page-=1,t.callbacks.onRender?.())}),r.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const h=Math.max(1,Math.ceil(e/t.pagination.pageSize));t.pagination.page<h&&(t.pagination.page+=1,t.callbacks.onRender?.())}),r.querySelectorAll("[data-size]")?.forEach(h=>{h.addEventListener("click",()=>{const m=Number(h.dataset.size);Number.isFinite(m)&&m>0&&(t.pagination.pageSize=m,t.pagination.page=1,t.callbacks.onRender?.())})})}function We(e,r,a){const n=e?.reservationId||e?.id||"—",s=F(String(n)),i=r.get(String(e?.customerId))?.customerName||l("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),c=Z(e),y=Ge(c.statusValue),h=Je(c.statusValue,y),m=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],g=Ke(c.paidStatus,m),u=m.length;let p=g.html;if(u>0){const B=l("reservations.paymentHistory.countLabel","{count} دفعة","{count} payments").replace("{count}",x(u));p=`<div class="reports-payment-cell">${g.html}<small class="reports-payment-subtext">${A(B)}</small></div>`}const w=he(e?.start),v=T(e),E=S(v.finalTotal),b=v.companySharePercent>0?`${x(v.companySharePercent)}% (${S(v.companyShareAmount)})`:l("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),C=S(v.netProfit),P=A(i);return{code:{html:A(s),text:s},customer:{html:P,text:i},date:{html:A(w),text:w},status:h,payment:{html:p,text:g.text},total:{html:A(E),text:E},share:{html:A(b),text:b},net:{html:A(C),text:C}}}function Ge(e){switch(e){case"completed":return q(l("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return q(l("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return q(l("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return F(e||"—")}}function Je(e,r){const a=q(r);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${A(a)}</span>`,text:a}}function Ke(e,r=[]){const a=ye(e),n=String(e??"").toLowerCase(),s=n==="paid"?"paid":n==="partial"?"partial":"unpaid";let o="";const i=l("reservations.create.summary.currency","ريال","SR");Array.isArray(r)&&r.length&&(o=r.map(h=>{const m=h?.recordedAt?ee(h.recordedAt):"—",g=Number.isFinite(Number(h?.amount))&&Number(h.amount)>0?`${F(Number(h.amount).toFixed(2))} ${i}`:"",u=Number.isFinite(Number(h?.percentage))&&Number(h.percentage)>0?`${F(Number(h.percentage).toFixed(2))}%`:"",p=[m];return g&&p.push(g),u&&p.push(u),p.filter(Boolean).join(" • ")}).join(`
`));const c=o?` title="${U(o)}"`:"";return{html:`<span class="reservation-chip status-${s}"${c}>${A(a)}</span>`,text:a}}function q(e){return F(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function ie(e){const r=ee(new Date).replace(/-/g,"");return`${l("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${r}.${e}`}function Ye(e,r,a){const n=new Blob([e],{type:a}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function W(e){if(!e||!e.length)return;const r=Object.keys(e[0]),a=[r.join(",")];e.forEach(s=>{const o=r.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);a.push(o.join(","))});const n=`\uFEFF${a.join(`\r
`)}\r
`;Ye(n,ie("csv"),"text/csv;charset=utf-8;")}async function Qe(e){try{const r=await je();if(!r){W(e);return}const a=r.utils.json_to_sheet(e),n=r.utils.book_new(),s=l("reservations.reports.export.sheetName","الحجوزات","Reservations");r.utils.book_append_sheet(n,a,s),r.writeFile(n,ie("xlsx"))}catch(r){console.error("⚠️ [reports] Excel export failed, falling back to CSV",r),W(e)}}async function et(e=[],r={}){const{exportReportsPdf:a}=await H(async()=>{const{exportReportsPdf:s}=await import("./pdfPages.ThjZquB0.js");return{exportReportsPdf:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url),n=r?.action==="print"?"print":"save";await a(e,{action:n})}async function tt(e,r){switch(e){case"pdf":await et(r);break;case"excel":await Qe(r);break;case"csv":default:W(r);break}}function rt(e){const r=document.getElementById("reports-top-customers");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${U(a.name)}">
        <td>${A(a.name)}</td>
        <td>${x(a.count)}</td>
        <td>${S(a.revenue)}</td>
      </tr>
    `).join("")}}function at(e){const r=document.getElementById("reports-top-equipment");if(r){if(!e||e.length===0){r.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${l("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}r.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${U(a.name)}">
        <td>${A(a.name)}</td>
        <td>${x(a.count)}</td>
        <td>${S(a.revenue)}</td>
      </tr>
    `).join("")}}const f=t.filters;function nt(e){if(t.columnControlsBound)return;const r=document.getElementById("reports-column-controls");r&&(r.querySelectorAll("input[data-column-toggle]").forEach(a=>{const n=a.dataset.columnToggle;n&&(a.checked=t.columnPreferences[n]!==!1,a.addEventListener("change",()=>{t.columnPreferences[n]=a.checked,e()}))}),t.columnControlsBound=!0,e())}function ce(){Object.entries(t.columnPreferences).forEach(([e,r])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(a=>{a.classList.toggle("hidden",!r)})})}function st(e){if(t.exportHandlersBound)return;const r=document.querySelectorAll("[data-export]");r.length&&(r.forEach(a=>{a.addEventListener("click",async()=>{const{export:n=""}=a.dataset;if(n){a.disabled=!0;try{await e(n)}catch(s){console.error("⚠️ [reports] export failed",s)}finally{a.disabled=!1}}})}),t.exportHandlersBound=!0)}function ot(e,r){t.searchDebounceTimer&&(clearTimeout(t.searchDebounceTimer),t.searchDebounceTimer=null),t.searchDebounceTimer=setTimeout(()=>{f.search=e||"",r()},220)}function it(e,r){e&&(f.range="custom",f.start=e.startInput||null,f.end=e.endInput||null,r())}function ct(e,r){e&&(f.status=f.status===e?"all":e,r())}function lt(e,r){e&&(f.payment=f.payment===e?"all":e,r())}function dt(e,r){e&&(f.search=e,r())}function ut({onClear:e}={}){const r=document.getElementById("reservations-active-filters");if(!r)return;const a=[],n=(s,o,i)=>{a.push(`<span class="filter-chip" data-chip="${s}">${o} <button type="button" aria-label="clear" data-clear="${s}">✕</button></span>`)};if(f.range&&f.range!=="all"){let s="";switch(f.range){case"last30":s=l("reservations.reports.filters.range.last30","آخر 30 يوم","Last 30 days");break;case"thisWeek":s=l("reservations.reports.filters.range.thisWeek","هذا الأسبوع","This week");break;case"thisMonth":s=l("reservations.reports.filters.range.thisMonth","هذا الشهر","This month");break;case"thisQuarter":s=l("reservations.reports.filters.range.thisQuarter","هذا الربع","This quarter");break;case"thisYear":s=l("reservations.reports.filters.range.thisYear","هذا العام","This year");break;case"custom":s=`${l("reservations.reports.filters.range.custom","مخصص","Custom")} (${f.start||"—"} → ${f.end||"—"})`;break;default:s=f.range}n("range",s)}if(f.status&&f.status!=="all"){const s=l(`reservations.reports.filters.status.${f.status}`,f.status,f.status);n("status",s)}if(f.payment&&f.payment!=="all"){const s=l(`reservations.reports.filters.payment.${f.payment}`,f.payment,f.payment);n("payment",s)}if(f.share&&f.share!=="all"){const s=l(`reservations.reports.filters.share.${f.share}`,f.share,f.share);n("share",s)}f.search&&f.search.trim().length&&n("search",`🔍 ${f.search.trim()}`),r.innerHTML=a.join(""),r.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.clear;o&&(o==="range"?(f.range="all",f.start=null,f.end=null):o in f&&(o==="search"?f.search="":f[o]="all"),e?.(o))})})}const d=t.filters;function K(){V(),k(),setTimeout(()=>{V(),k(),z()},0),setTimeout(()=>{V(),k(),z()},60),z()}function j(){d.range==="custom"&&k()}function z(e,r){if(!window.flatpickr)return;e&&(t.startDateInputRef=e),r&&(t.endDateInputRef=r);const a=t.startDateInputRef,n=t.endDateInputRef;if(!a&&!n)return;const s=pt(),o=i=>{const c={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(c.locale=s),c};if(t.startDatePicker&&(t.startDatePicker.destroy(),t.startDatePicker=null),t.endDatePicker&&(t.endDatePicker.destroy(),t.endDatePicker=null),a&&(t.startDatePicker=window.flatpickr(a,o({onChange(i,c){d.start=c||null,t.endDatePicker&&(i?.length?t.endDatePicker.set("minDate",i[0]):t.endDatePicker.set("minDate",null)),j()},onValueUpdate(i,c){d.start=c||null,j()}}))),n&&(t.endDatePicker=window.flatpickr(n,o({onChange(i,c){d.end=c||null,t.startDatePicker&&(i?.length?t.startDatePicker.set("maxDate",i[0]):t.startDatePicker.set("maxDate",null)),j()},onValueUpdate(i,c){d.end=c||null,j()}}))),t.startDatePicker&&a){t.startDatePicker.setDate(a.value,!1);const i=t.endDatePicker?.selectedDates?.[0]||t.endDateInputRef?.value;i&&t.startDatePicker.set("maxDate",i)}if(t.endDatePicker&&n){t.endDatePicker.setDate(n.value,!1);const i=t.startDatePicker?.selectedDates?.[0]||t.startDateInputRef?.value;i&&t.endDatePicker.set("minDate",i)}}function pt(){return(Me()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function G(e,r){e&&(e.classList.toggle("active",!!r),e.classList.toggle("hidden",!r))}function $(){const e=document.getElementById("reports-range"),r=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),o=document.getElementById("reports-start"),i=document.getElementById("reports-end"),c=document.getElementById("reports-custom-range");e&&e.value!==d.range&&(e.value=d.range),r&&r.value!==d.status&&(r.value=d.status),a&&a.value!==d.payment&&(a.value=d.payment),n&&n.value!==d.share&&(n.value=d.share),s&&s.value!==d.search&&(s.value=d.search||""),o&&o.value!==(d.start||"")&&(o.value=d.start||""),i&&i.value!==(d.end||"")&&(i.value=d.end||""),G(c,d.range==="custom")}function mt(){try{const e=new URLSearchParams(window.location.search),r=n=>e.get(n),a=n=>n==null||n===""?null:n;d.range=r("range")||d.range,d.status=r("status")||d.status,d.payment=r("payment")||d.payment,d.share=r("share")||d.share,d.search=r("search")||"",d.start=a(r("start")),d.end=a(r("end")),d.range!=="custom"&&(d.start=null,d.end=null)}catch{}}let X=null;function D(){X&&clearTimeout(X),X=setTimeout(()=>{try{const e=new URLSearchParams,r=(s,o,i)=>{o!=null&&o!==""&&o!==i&&e.set(s,o)};r("range",d.range,"all"),r("status",d.status,"all"),r("payment",d.payment,"all"),r("share",d.share,"all"),r("search",d.search,""),d.range==="custom"&&(r("start",d.start,null),r("end",d.end,null));const a=e.toString(),n=a?`${location.pathname}?${a}`:location.pathname;window.history.replaceState({},"",n)}catch{}},120)}function le({active:e,icon:r,title:a,subtitle:n}){const s=document.getElementById("reports-empty-state");if(!s)return;const o=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),c=s.querySelector("p");t.emptyDefaults.icon===null&&o&&(t.emptyDefaults.icon=o.textContent),t.emptyDefaults.title===null&&i&&(t.emptyDefaults.title=i.textContent),t.emptyDefaults.subtitle===null&&c&&(t.emptyDefaults.subtitle=c.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!o||!i||!c)&&(e?(o.textContent=r!==void 0?r:t.emptyDefaults.icon??o.textContent,i.textContent=a!==void 0?a:t.emptyDefaults.title??i.textContent,c.textContent=n!==void 0?n:t.emptyDefaults.subtitle??c.textContent):(o.textContent=t.emptyDefaults.icon??o.textContent,i.textContent=t.emptyDefaults.title??i.textContent,c.textContent=t.emptyDefaults.subtitle??c.textContent))}function ft(e){le({active:!!e})}function Y(e){const r=document.getElementById("reports-kpi-skeleton"),a=document.getElementById("reservations-reports-kpis"),n=document.getElementById("reports-table-skeleton"),s=document.getElementById("reports-reservations-table"),o=document.getElementById("reservations-revenue-skeleton"),i=document.getElementById("reservations-revenue-breakdown");r&&a&&(r.style.display=e?"":"none",a.style.opacity=e?"0.4":"1"),n&&s&&(n.style.display=e?"":"none",s.style.opacity=e?"0.4":"1"),o&&i&&(o.style.display=e?"":"none",i.style.opacity=e?"0.4":"1")}function ht(){if(t.drilldownBound)return;const e=document.getElementById("reports-top-customers"),r=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),n=s=>{const o=s.target?.closest("[data-drilldown]");if(!o)return;const i=o.dataset.search||"";dt(i,()=>{$(),k()})};e?.addEventListener("click",n),r?.addEventListener("click",n),a?.addEventListener("click",n),t.drilldownBound=!0}function _(){oe({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function k(){if($(),D(),ut({onClear:()=>{$(),D(),k()}}),t.loading){Y(!0);return}if(t.errorMessage){le({active:!0,icon:"⚠️",title:t.errorMessage,subtitle:l("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}Y(!1);const{reservations:e,customers:r,equipment:a,technicians:n,maintenance:s}=t.data,o=ge(e,d,r,a,n),i=ve(o),c=be(s,d),y=xe(i,c.total),h=ke(o),m=we(o),g=Se(o),u=Ee(o,r),p=Ce(o,a);ze(y),He(h),Fe(m),qe(g),rt(u),at(p);const w=Oe(o,r,n);ce(),ft(o.length===0),t.lastSnapshot.filtered=o,t.lastSnapshot.metrics=y,t.lastSnapshot.trend=h,t.lastSnapshot.statusBreakdown=m,t.lastSnapshot.paymentBreakdown=g,t.lastSnapshot.tableRows=w,t.lastSnapshot.maintenance=c}function yt(){if(t.initialized)return;t.initialized=!0;const e=document.getElementById("reports-range"),r=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),n=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range"),c=document.getElementById("reports-search");if(!e)return;mt(),$(),_e()&&k(),e.addEventListener("change",()=>{d.range=e.value,G(i,d.range==="custom"),d.range!=="custom"&&(d.start=null,d.end=null),D(),k()}),r?.addEventListener("change",()=>{d.status=r.value,D(),k()}),a?.addEventListener("change",()=>{d.payment=a.value,D(),k()}),n?.addEventListener("change",()=>{d.share=n.value,D(),k()}),c?.addEventListener("input",()=>{const m=c.value||"";ot(m,()=>{$(),D(),k()})}),s?.addEventListener("change",()=>{d.start=s.value||null,D(),j()}),o?.addEventListener("change",()=>{d.end=o.value||null,D(),j()}),z(s,o),G(i,d.range==="custom"),t.languageListenerAttached||(document.addEventListener("language:changed",K),document.addEventListener("language:translationsReady",K),t.languageListenerAttached=!0),t.dataListenersAttached||(document.addEventListener("reservations:changed",_),document.addEventListener("customers:changed",_),document.addEventListener("equipment:changed",_),document.addEventListener("projects:changed",_),document.addEventListener("technicians:updated",_),window.addEventListener("maintenance:updated",_),t.dataListenersAttached=!0),nt?.(ce),st(async m=>{const g=t.lastSnapshot.tableRows||[];if(!g.length){console.warn("[reports] No reservation data to export");return}if(m==="pdf")try{const{exportA4ReportPdf:u}=await H(async()=>{const{exportA4ReportPdf:p}=await import("./a4Unified.SJ3XiqPC.js");return{exportA4ReportPdf:p}},__vite__mapDeps([11,1,2,3,4,6,5,7,8,9,10]),import.meta.url);await u(g,{action:"save",strict:!0});return}catch(u){console.warn("[reports] page-based PDF export failed, falling back to legacy",u)}else if(m==="excel")try{const{exportA4ReportExcel:u}=await H(async()=>{const{exportA4ReportExcel:p}=await import("./a4Unified.SJ3XiqPC.js");return{exportA4ReportExcel:p}},__vite__mapDeps([11,1,2,3,4,6,5,7,8,9,10]),import.meta.url);await u(g);return}catch(u){console.warn("[reports] A4-based Excel export failed, falling back to legacy",u)}else if(m==="csv")try{const{exportA4ReportCsv:u}=await H(async()=>{const{exportA4ReportCsv:p}=await import("./a4Unified.SJ3XiqPC.js");return{exportA4ReportCsv:p}},__vite__mapDeps([11,1,2,3,4,6,5,7,8,9,10]),import.meta.url);await u(g);return}catch(u){console.warn("[reports] A4-based CSV export failed, falling back to legacy",u)}await tt(m,g)});const h=document.getElementById("reports-preview-pdf");h&&!h.dataset.bound&&(h.addEventListener("click",async()=>{try{const m=await H(()=>import("./preview.C1ghwbBc.js"),__vite__mapDeps([12,1,2,3,4,11,6,5,7,8,9,10]),import.meta.url),g=t.lastSnapshot.tableRows||[];m.openReportsPdfPreview(g)}catch(m){console.error("⚠️ [reports] Failed to open PDF preview",m)}}),h.dataset.bound="true"),ht(),t.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>k(),0)}),t.themeListenerAttached=!0),Le(k),Re(()=>{k()}),Ae(()=>{k()}),De(m=>{it(m,()=>{$(),k()})}),Pe(m=>{ct(m?.filterKey,()=>{$(),k()})}),$e(m=>{lt(m?.filterKey,()=>{$(),k()})}),oe().catch(m=>{console.error("❌ [reports] Failed to initialise reports data",m)})}const Ct=Object.freeze(Object.defineProperty({__proto__:null,initReports:yt,renderReports:k},Symbol.toStringTag,{value:"Module"}));export{je as a,Et as b,St as e,O as l,Ct as r};
