import{n as k,j,t as c,d as Te,b as At,h as _i,p as Ne,z as Ci,y as Pt,B as $r,C as xi,v as $i,w as Li,u as Ni}from"./auth.Bccf-xsM.js";import{i as Pi,y as _t,z as kn,A as is,B as Ti,C as Xt,p as ji,D as Bi,E as Lr,F as Nr,G as Di,H as Fi}from"./reservationsActions.CEh-q5jr.js";import{n as dt,s as nt,p as pt,a as In,b as fn,d as cs,l as nn,D as Ht,g as wa,r as Pr,c as Rn,e as Mn,h as ls,o as ds,q as Ws,t as Ys,v as an,w as St,x as sn,y as Tr,z as Ri,A as jr,B as Mi,C as Oi,i as Br,E as Oa,F as Dr,G as Fr,H as za,I as zi,J as Hi,K as Ki,u as Vi,L as Ui,k as Gi}from"./reservationsService.Bz_TAegX.js";import{s as yn,i as gn,j as Js,o as us,p as Rr,q as ps,u as Mr,v as Qi,w as Zt,x as Kn,y as ft,n as Se,z as Or,A as ms,l as jt,B as hn,C as ka,D as sa,E as Wi,F as zr,G as Hr,H as Kr,I as rt,J as Vr,b as fs,K as Yi,L as Ji,M as Ur,N as Xi,O as Zi,k as Gr}from"./technicians.BROQVNHZ.js";import{s as ys,E as Qr,a as ec,d as Wr,e as tc,c as nc,r as ac,f as sc}from"./uiBridge.VwHEGM0R.js";import{q as rc}from"./quotePdf.WC1ebubv.js";import{s as gs,a as hs,e as bs,p as oc}from"./canvasColorUtils.CviLtv6S.js";import{ensureProjectsLoaded as ic}from"./projectsService.DRnu6uhL.js";function Yr(e){const t=new Date;if(t.setHours(0,0,0,0),e==="today")return{startDate:Wt(t),endDate:Wt(t)};if(e==="week"){const n=new Date(t),a=n.getDay(),s=a===0?6:a-1;n.setDate(n.getDate()-s);const r=new Date(n);return r.setDate(n.getDate()+6),{startDate:Wt(n),endDate:Wt(r)}}if(e==="month"){const n=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0);return{startDate:Wt(n),endDate:Wt(a)}}return e==="upcoming"?{startDate:Wt(t),endDate:""}:{startDate:"",endDate:""}}function cc(){const e=document.getElementById("search-reservation"),t=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date"),a=document.getElementById("reservation-date-range"),s=document.getElementById("reservation-status-filter");let r=k(t?.value||"").trim(),o=k(n?.value||"").trim(),i=a?.value||"";if(new Set(["","today","week","month"]).has(i)||(i="",a&&(a.value=""),ra(t),ra(n),r="",o=""),!r&&!o&&i){const d=Yr(i);r=d.startDate,o=d.endDate}return{searchTerm:dt(e?.value||""),startDate:r,endDate:o,status:s?.value||"",quickRange:i}}function gu(e){const t=()=>{typeof e=="function"&&e()},n=document.getElementById("search-reservation");n&&!n.dataset.listenerAttached&&(n.addEventListener("input",()=>{n.value=k(n.value),t()}),n.dataset.listenerAttached="true");const a=document.getElementById("filter-start-date");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{const l=document.getElementById("reservation-date-range");l&&(l.value=""),t()}),a.dataset.listenerAttached="true");const s=document.getElementById("filter-end-date");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{const l=document.getElementById("reservation-date-range");l&&(l.value=""),t()}),s.dataset.listenerAttached="true");const r=document.getElementById("reservation-date-range");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{lc(r.value),t()}),r.dataset.listenerAttached="true");const o=document.getElementById("reservation-status-filter");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",t),o.dataset.listenerAttached="true");const i=document.getElementById("clear-filters");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",()=>{n&&(n.value=""),ra(a),ra(s),r&&(r.value=""),o&&(o.value=""),t()}),i.dataset.listenerAttached="true")}function lc(e){const t=document.getElementById("filter-start-date"),n=document.getElementById("filter-end-date");if(!t||!n)return;const{startDate:a,endDate:s}=Yr(e);t._flatpickr?a?t._flatpickr.setDate(a,!1,"Y-m-d"):t._flatpickr.clear():t.value=a,n._flatpickr?s?n._flatpickr.setDate(s,!1,"Y-m-d"):n._flatpickr.clear():n.value=s}function Wt(e){if(!e)return"";const t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().split("T")[0]}function ra(e){e&&(e._flatpickr&&e._flatpickr.clear(),e.value="")}const dc=""+new URL("Tajawal-400.ttf",import.meta.url).href,uc=""+new URL("Tajawal-500.ttf",import.meta.url).href,Xs=""+new URL("Tajawal-700.ttf",import.meta.url).href,pc="reservations.quote.sequence",Zs={reservation:"reservations.quote.togglePrefs.v1",project:"projects.quote.togglePrefs.v1",reservationChecklist:"reservations.checklist.togglePrefs.v1"},Jr="https://help.artratio.sa/guide/quote-preview",Ye={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"Ø´Ø±ÙƒØ© ÙÙˆØ¯ Ø¢Ø±Øª Ù„Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø´Ø±ÙƒØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯)",commercialRegistry:"4030485240",beneficiaryName:"Ø´Ø±ÙƒØ© ÙÙˆØ¯ Ø¢Ø±Øª Ù„Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø´Ø±ÙƒØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯)",bankName:"Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ",accountNumber:"Ù£Ù¥Ù¨Ù Ù Ù Ù Ù¡Ù Ù Ù Ù¦Ù Ù¨Ù¦Ù Ù¦Ù¥Ù§Ù Ù¦",iban:"SA1680000358608016065706",approvalNote:"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ØªØ¹ØªØ¨Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…."},mc=["ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„ Ù‡Ùˆ 12 Ø³Ø§Ø¹Ø©ØŒ ÙˆÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù†ØµÙ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ 20 Ø³Ø§Ø¹Ø©ØŒ Ø«Ù… ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.","ÙŠÙ…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ø£Ù†Ø´Ø·Ø© ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©.","ÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø£ÙŠ ØªÙ„Ù Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù†.","ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©.","ÙŠØªÙ… ÙØ±Ø¶ Ø±Ø³ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù‚Ø¨Ù„ 24 Ø³Ø§Ø¹Ø©."],mt=[...mc],fc=["ÙŠØªÙ… Ø¯ÙØ¹ 50% Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±ØŒ ÙˆÙŠØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù€ 50% Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.","ÙŠØ­ØµÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ±Ø§Ù‡ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ØŒ Ø¨ÙŠÙ†Ù…Ø§ ØªØ­ØªÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… ÙˆÙ„Ø§ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø§ Ù„Ù… ÙŠÙØªÙÙ‚ Ø¹Ù„Ù‰ ØºÙŠØ± Ø°Ù„Ùƒ.","ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ù„Ù„ØªÙ†ÙÙŠØ°ØŒ ÙˆØ£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ ØªØ®Ø¶Ø¹ Ù„Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©.","Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ØªÙˆÙÙŠØ± Ø§Ù„ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„ØªØµÙˆÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙˆØ£ÙŠ ØªØ£Ø®ÙŠØ± Ù†Ø§ØªØ¬ Ø¹Ù† Ø°Ù„Ùƒ Ù‚Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….","ØªÙØ­ÙÙŽØ¸ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù…Ø¯Ø© 12 Ø´Ù‡Ø±Ø§Ù‹ ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ø±ÙƒØ©ØŒ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø·Ù„Ø¨ Ù†Ø³Ø® Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ù„Ø§Ù„ ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©.","ÙŠØªØ­Ù…Ù‘Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„ Ø¢Ù…Ù†Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØµÙˆÙŠØ±ØŒ ÙˆÙŠØ¶Ù…Ù† Ø§ØªØ®Ø§Ø° ÙƒØ§ÙØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…ØªÙ‡Ù…."];function Ha(e){return e?e.split(/\r?\n/).map(t=>t.trim()).filter(t=>t.length>0):[...mt]}function yc(){const e=document.getElementById("reservation-terms");if(e&&e.value.trim().length>0){const a=Ha(e.value);if(a.length)return a}const t=document.getElementById("edit-res-terms");if(t&&t.value.trim().length>0){const a=Ha(t.value);if(a.length)return a}const n=mt.join(`
`);return e&&e.value.trim().length===0&&(e.value=n),t&&t.value.trim().length===0&&(t.value=n),[...mt]}const gc=[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"financialSummary",labelKey:"reservations.quote.sections.financial",fallback:"Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"payment",labelKey:"reservations.quote.sections.payment",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹",defaultSelected:!1}],Ia=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>h(k(String(t+1)))},{id:"code",labelKey:"reservations.details.table.headers.code",fallback:"Ø§Ù„ÙƒÙˆØ¯",render:e=>{if(e?.isPackage){const t=e?.packageCodeResolved||e?.barcode||"";return h(t||"-")}return h(e?.barcode||"-")}},{id:"description",labelKey:"reservations.details.table.headers.description",fallback:"Ø§Ù„ÙˆØµÙ",render:e=>{const t=String(e?.desc||e?.description||"-");return`<div class="quote-cell quote-cell--desc">${h(t)}</div>`}},{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:e=>h(k(String(e?.qty||1)))},{id:"unitPrice",labelKey:"reservations.quote.columns.unitPrice",fallback:"Ù„ÙƒÙ„ ÙŠÙˆÙ…",render:e=>h(k(Number(e?.unitPriceValue||0).toFixed(2)))},{id:"price",labelKey:"reservations.quote.columns.total",fallback:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",render:e=>h(k(Number(e?.price||0).toFixed(2)))}],Aa=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>h(k(String(t+1)))},{id:"position",labelKey:"reservations.details.crew.position",fallback:"Ø§Ù„Ù…Ù†ØµØ¨",render:e=>{const t=typeof Ne=="function"?Ne():"ar",n=e?.positionLabelEn??e?.position_label_en??e?.position_name_en??e?.positionLabelAlt??e?.position_label_alt??e?.role,a=e?.positionLabel??e?.position_name??e?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return h(k(String(t==="en"&&n?n:a)))}},{id:"unitPrice",labelKey:"reservations.quote.columns.unitPrice",fallback:"Ù„ÙƒÙ„ ÙŠÙˆÙ…",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return h(`${k(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}},{id:"price",labelKey:"reservations.quote.columns.total",fallback:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",render:e=>{const t=Number.isFinite(Number(e?.positionClientPrice))?Number(e.positionClientPrice):0;return h(`${k(t.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`)}}],Rt={customerInfo:[{id:"customerName",labelKey:"reservations.details.labels.customer",fallback:"Ø§Ù„Ø¹Ù…ÙŠÙ„"},{id:"customerCompany",labelKey:"reservations.details.labels.company",fallback:"Ø§Ù„Ø´Ø±ÙƒØ©"},{id:"customerPhone",labelKey:"reservations.details.labels.phone",fallback:"Ø§Ù„Ù‡Ø§ØªÙ"},{id:"customerEmail",labelKey:"reservations.details.labels.email",fallback:"Ø§Ù„Ø¨Ø±ÙŠØ¯"}],reservationInfo:[{id:"reservationId",labelKey:"reservations.details.labels.reservationId",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationStart",labelKey:"reservations.details.labels.start",fallback:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationEnd",labelKey:"reservations.details.labels.end",fallback:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"},{id:"reservationDuration",labelKey:"reservations.details.labels.duration",fallback:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"}],projectInfo:[{id:"projectTitle",labelKey:"reservations.details.labels.project",fallback:"Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectCode",labelKey:"reservations.details.labels.code",fallback:"Ø§Ù„Ø±Ù…Ø²"}],financialSummary:[{id:"discountAmount",labelKey:"reservations.details.labels.discount",fallback:"Ø§Ù„Ø®ØµÙ…"},{id:"subtotalBeforeTax",labelKey:"reservations.details.labels.subtotalBeforeTax",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"taxAmount",labelKey:"reservations.details.labels.tax",fallback:"Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"finalTotal",labelKey:"reservations.details.labels.total",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"}],payment:[{id:"beneficiary",labelKey:"reservations.quote.labels.beneficiary",fallback:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"},{id:"bank",labelKey:"reservations.quote.labels.bank",fallback:"Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"},{id:"account",labelKey:"reservations.quote.labels.account",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"},{id:"iban",labelKey:"reservations.quote.labels.iban",fallback:"Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"}],items:[...Ia.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"}],crew:[...Aa.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©"},{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"}]},Xr=[{id:"rowNumber",labelKey:null,fallback:"#",render:(e,t)=>h(k(String(t+1)))},{id:"label",labelKey:null,fallback:"Ø§Ù„Ø¨Ù†Ø¯",render:e=>h(e?.label||"-")},{id:"amount",labelKey:null,fallback:"Ø§Ù„Ø³Ø¹Ø±",render:e=>{const t=Number.isFinite(Number(e?.salePrice??e?.sale_price))?Number(e?.salePrice??e?.sale_price):Number(e?.amount??0)||0;return h(_e(t,c("reservations.create.summary.currency","SR")))}},{id:"note",labelKey:null,fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª",render:e=>h(e?.note||"-")}],hc=[{id:"customerInfo",labelKey:"projects.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"projectInfo",labelKey:"projects.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"projectExpenses",labelKey:"projects.quote.sections.expenses",fallback:"Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©",defaultSelected:!0},{id:"projectCrew",labelKey:"projects.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0},{id:"financialSummary",labelKey:"projects.quote.sections.financial",fallback:"Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",defaultSelected:!0},{id:"projectEquipment",labelKey:"projects.quote.sections.equipment",fallback:"Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"projectNotes",labelKey:"projects.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"payment",labelKey:"reservations.quote.sections.payment",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹",defaultSelected:!1}],bc={customerInfo:Rt.customerInfo,projectInfo:[{id:"projectTitle",labelKey:"projects.details.overview.heading",fallback:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectCode",labelKey:"projects.details.labels.code",fallback:"Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectType",labelKey:"projects.details.type",fallback:"Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectStart",labelKey:"projects.details.start",fallback:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectEnd",labelKey:"projects.details.end",fallback:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectDuration",labelKey:"projects.details.duration",fallback:"Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"},{id:"projectStatus",labelKey:"projects.details.status",fallback:"Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"}],financialSummary:[{id:"reservationsTotal",labelKey:"projects.details.reservationsTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª"},{id:"discountAmount",labelKey:"projects.details.summary.discount",fallback:"Ø§Ù„Ø®ØµÙ…"},{id:"taxAmount",labelKey:"projects.details.summary.combinedTax",fallback:"Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"},{id:"overallTotal",labelKey:"projects.details.summary.overallTotal",fallback:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"}],payment:Rt.payment,projectExpenses:[...Xr.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"expensesSubtotal",labelKey:"projects.details.expensesTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"}],projectCrew:[...Aa.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©"},{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"crewSubtotal",labelKey:"reservations.details.labels.crewTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"}],projectEquipment:[...Ia.map(({id:e,labelKey:t,fallback:n})=>({id:e,labelKey:t,fallback:n})),{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…"},{id:"equipmentSubtotal",labelKey:"reservations.details.labels.equipmentTotal",fallback:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"}],projectNotes:[]},Ba=new Map;function Ea(e="reservation"){if(Ba.has(e))return Ba.get(e);const t=e==="project"?hc:e==="reservationChecklist"?[{id:"customerInfo",labelKey:"reservations.quote.sections.customer",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„",defaultSelected:!0},{id:"reservationInfo",labelKey:"reservations.quote.sections.reservation",fallback:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"projectInfo",labelKey:"reservations.quote.sections.project",fallback:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",defaultSelected:!0},{id:"notes",labelKey:"reservations.quote.sections.notes",fallback:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²",defaultSelected:!0},{id:"items",labelKey:"reservations.quote.sections.items",fallback:"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",defaultSelected:!0},{id:"crew",labelKey:"reservations.quote.sections.crew",fallback:"Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„",defaultSelected:!0}]:gc,n=e==="project"?bc:e==="reservationChecklist"?{customerInfo:Rt.customerInfo,reservationInfo:Rt.reservationInfo,projectInfo:Rt.projectInfo,notes:[],items:Rt.items,crew:Rt.crew}:Rt,a=new Set(t.map(({id:o})=>o)),s=Object.fromEntries(Object.entries(n).map(([o,i=[]])=>[o,new Set(i.map(l=>l.id))])),r={sectionDefs:t,fieldDefs:n,sectionIdSet:a,fieldIdMap:s};return Ba.set(e,r),r}function qa(e="reservation"){return Ea(e).sectionDefs}function Zr(e="reservation"){return Ea(e).fieldDefs}function eo(e="reservation"){return Ea(e).sectionIdSet}function to(e="reservation"){return Ea(e).fieldIdMap}function no(e){switch(e){case"export":return c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF...");case"render":default:return c("reservations.quote.status.rendering","Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...")}}const vc="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",Sc="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",wc="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",ao=rc.trim(),so=`
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 400; font-display: swap; src: url(${JSON.stringify(dc)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 500; font-display: swap; src: url(${JSON.stringify(uc)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 600; font-display: swap; src: url(${JSON.stringify(Xs)}) format('truetype'); }
@font-face { font-family: 'Tajawal'; font-style: normal; font-weight: 700; font-display: swap; src: url(${JSON.stringify(Xs)}) format('truetype'); }
`,ro=/^data:image\/svg\+xml/i,kc=/\.svg($|[?#])/i,Cn=512,Ka="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/B8AAusB9YwpClgAAAAASUVORK5CYII=",oo=96,io=25.4,Va=210,Yn=297,xn=Math.round(Va/io*oo),$n=Math.round(Yn/io*oo);function Le(e){const t=Number(e),n=Number.isFinite(t)?t:0;try{const a=Math.abs(n%1)>1e-9;return k(n.toLocaleString("en-US",{minimumFractionDigits:a?2:0,maximumFractionDigits:2}))}catch{return Number.isInteger(n)?k(String(n)):k(n.toFixed(2))}}let oa=!1,ia=null;function vs(){oa||(ia=async function(){try{if(!p||!X?.modal?.classList.contains("show")||(p.context||"reservation")!=="reservation")return;const n=p.reservation;if(!n)return;const a=[n.id,n.reservationId,n.reservation_id,n.reservationCode,n.reservation_code].map(u=>u==null?"":String(u)).filter(u=>u.length>0);if(!a.length)return;const s=wa(),r=(Array.isArray(s)?s:[]).find(u=>[u?.id,u?.reservationId,u?.reservation_id,u?.reservationCode,u?.reservation_code].map(b=>b==null?"":String(b)).filter(b=>b.length>0).some(b=>a.includes(b)));if(!r)return;const o=La(r),{totalsDisplay:i,totals:l,rentalDays:d}=Bs(r,o,p.project);p.reservation=r,p.crewAssignments=o,p.totals=l,p.totalsDisplay=i,p.rentalDays=d,p.context==="reservationChecklist"&&fo(),Xn(),Xe()}catch(t){console.warn("[reservationPdf] live update failed",t)}},document.addEventListener("reservations:changed",ia),oa=!0)}function co(){if(oa){try{document.removeEventListener("reservations:changed",ia)}catch{}ia=null,oa=!1}}const lo=2,uo=/safari/i,Ic=/(iphone|ipad|ipod)/i,er=/(iphone|ipad|ipod)/i,Ac=/(crios|fxios|edgios|opios)/i,ca="[reservations/pdf]";let X=null,p=null,qt=1,An=null,En=null,Mt=null,ln=null,Nn=!1;const la="quoteBlockOffsets",tr=1800,da="quoteInfoAlignments",Ec=["customer","reservation","project","projectCustomer","projectDetails"],Ss={customer:"left",reservation:"left",project:"left",projectCustomer:"left",projectDetails:"left"},Ua={project:{customer:"left",reservation:"left",project:"left",projectCustomer:"left",projectDetails:"left"},reservationChecklist:{customer:"left",reservation:"left",project:"left",projectCustomer:"left",projectDetails:"left"}};let bn=!1,ws=!1,On=!1;const ks={project:{"project-title":{x:-182.78680419921875,y:-5.0181427001953125},"project-content":{x:-140.1977996826172,y:-4.7384796142578125}}},dn={blockOffsets:"data-block-offsets",infoAlignments:"data-info-alignments",context:"data-quote-source-context"};function po(e){return k(String(e??"")).trim().toLowerCase()}function mo(e){return e==null?"":k(String(e)).trim().toLowerCase()}function Is(){const e=Te()||{},t=Array.isArray(e.equipment)?e.equipment:[],n=new Map,a=new Map;return t.forEach(s=>{if(!s||typeof s!="object")return;[s.id,s.equipment_id,s.equipmentId,s.item_id,s.itemId].forEach(o=>{o==null||o===""||n.set(String(o),s)});const r=mo(s.barcode);r&&a.set(r,s)}),{byId:n,byBarcode:a}}function qc(e={},t){if(!t)return null;const n=[e.equipmentId,e.equipment_id,e.id,e.itemId,e.item_id];for(const s of n){if(s==null||s==="")continue;const r=String(s);if(t.byId.has(r))return t.byId.get(r)}const a=[e.barcode,e.normalizedBarcode,e.code];for(const s of a){const r=mo(s);if(r&&t.byBarcode.has(r))return t.byBarcode.get(r)}return null}function As(e,t,n=new Set){const a=new Set;if(!e||typeof e!="object")return a;const s=o=>{const i=typeof o=="string"?o.trim():"";i&&a.add(i)};if(s(e.lessor??e.owner??e.lessor_name??e.lessorName),Array.isArray(e.packageItems)&&e.packageItems.length>0&&!n.has(e)&&(n.add(e),e.packageItems.forEach(o=>{As(o,t,n).forEach(i=>a.add(i))}),n.delete(e)),!a.size){const o=qc(e,t);o&&s(o.lessor??o.owner??o.lessor_name??o.lessorName)}return a}function _c(e,t,n){if(!(t instanceof Set)||t.size===0)return!0;const a=As(e,n);if(!a.size)return!1;for(const s of a){const r=po(s);if(r&&t.has(r))return!0}return!1}function Cc(e,t){const n=Array.isArray(e?.items)?e.items:[],a=new Map;n.forEach(r=>{As(r,t).forEach(o=>{const i=po(o);i&&(a.has(i)||a.set(i,{key:i,label:o,count:0}),a.get(i).count+=1)})});const s=new Intl.Collator("ar",{sensitivity:"base"});return Array.from(a.values()).sort((r,o)=>s.compare(r.label,o.label))}function fo(){if(!p||p.context!=="reservationChecklist")return;const e=Is();p.checklistEquipmentLookup=e;const t=Cc(p.reservation,e),n=new Set(t.map(s=>s.key)),a=p.checklistLessorFilter instanceof Set?p.checklistLessorFilter:new Set;Array.from(a).forEach(s=>{n.has(s)||a.delete(s)}),p.checklistLessorOptions=t,p.checklistLessorFilter=a,ua()}function ua(){if(!X?.checklistLessorContainer)return;const e=X.checklistLessorContainer,t=X.checklistLessorOptionsHost;if(!p||p.context!=="reservationChecklist"){e.hidden=!0;return}const n=Array.isArray(p.checklistLessorOptions)?p.checklistLessorOptions:[],a=p.checklistLessorFilter instanceof Set?p.checklistLessorFilter:new Set;if(!t){e.hidden=!0;return}if(!n.length){e.hidden=!0,t.innerHTML=`<p class="text-muted" data-lessor-empty>${h(c("reservations.checklist.controls.lessors.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¤Ø¬Ø± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø¹Ø¯Ø§Øª."))}</p>`;const r=e.querySelector("[data-lessor-clear]");r&&(r.disabled=!0);return}e.hidden=!1,t.innerHTML=n.map(r=>{const o=`checklist-lessor-${r.key}`,i=r.count?` <small>(${h(k(String(r.count)))})</small>`:"";return`
      <label for="${o}" style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="${o}" value="${r.key}" ${a.has(r.key)?"checked":""}>
        <span>${h(r.label)}${i}</span>
      </label>
    `}).join(""),t.querySelectorAll('input[type="checkbox"]').forEach(r=>{r.addEventListener("change",()=>{p.checklistLessorFilter instanceof Set||(p.checklistLessorFilter=new Set),r.checked?p.checklistLessorFilter.add(r.value):p.checklistLessorFilter.delete(r.value),ua(),Xe()})});const s=e.querySelector("[data-lessor-clear]");s&&(s.disabled=a.size===0,s.onclick=()=>{p.checklistLessorFilter instanceof Set&&(p.checklistLessorFilter.clear(),ua(),Xe())})}function yo(){if(!p?.reservation||p.context!=="reservationChecklist")return p?.reservation||null;const e=p.checklistLessorFilter;if(!(e instanceof Set)||e.size===0)return p.reservation;const t=p.checklistEquipmentLookup||Is();p.checklistEquipmentLookup=t;const n=Array.isArray(p.reservation.items)?p.reservation.items:[],a=n.filter(s=>_c(s,e,t));return a.length===n.length?p.reservation:{...p.reservation,items:a}}function nr(e){try{return encodeURIComponent(JSON.stringify(e))}catch{return""}}function ar(e,t){if(!e)return null;const n=e.getAttribute(t);if(!n)return null;try{return JSON.parse(decodeURIComponent(n))}catch{return null}}function xc(e={}){const t=[],n=e.context||xt(e);if(t.push(`${dn.context}="${h(String(n))}"`),e.blockOffsets&&Object.keys(e.blockOffsets).length){const a=nr(e.blockOffsets);a&&t.push(`${dn.blockOffsets}="${a}"`)}if(e.infoAlignments&&Object.keys(e.infoAlignments).length){const a=nr(e.infoAlignments);a&&t.push(`${dn.infoAlignments}="${a}"`)}return t.length?` ${t.join(" ")}`:""}let zt=null;function go(e){return e&&typeof e=="object"?e:zt||p||null}function xt(e=null){return go(e)?.context||"reservation"}function $c(e="reservation"){try{const n=JSON.parse(localStorage.getItem(la)||"{}")?.[e];if(n&&typeof n=="object")return JSON.parse(JSON.stringify(n))}catch{}return{}}function ho(e,t={}){try{const n=JSON.parse(localStorage.getItem(la)||"{}");t&&Object.keys(t).length>0?n[e]=t:delete n[e],localStorage.setItem(la,JSON.stringify(n))}catch{}}function Es(e){if(!e)return;const t=xt(e),n=$c(t);e.blockOffsets={...ks[t]||{},...n},ws=!1,bn=!1,_a()}function Lc(e,t={}){if(!e)return;e.querySelectorAll("[data-drag-key]").forEach(a=>{const s=a.dataset.dragKey,r=t?.[s],o=Number(r?.x)||0,i=Number(r?.y)||0;o||i?a.style.transform=`translate(${o}px, ${i}px)`:a.style.transform="",a.dataset.dragX=String(o),a.dataset.dragY=String(i)})}function qs(e){try{const t=e?.getElementById("quotation-pdf-root");if(!t)return;t.dataset.blockDragMode=bn?"on":"off"}catch{}}function _a(){const e=X?.blockDragToggle;if(e){const n=bn?c("reservations.quote.drag.disable","ðŸ”’ Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ"):c("reservations.quote.drag.enable","ðŸŽ¯ ÙˆØ¶Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª");e.setAttribute("aria-label",n),e.setAttribute("title",n),e.classList.toggle("is-active",bn)}const t=X?.blockDragSave;t&&(t.disabled=!ws)}function Nc(e){bn=!!e,_a();try{qs(X?.previewFrame?.contentDocument)}catch{}}function _s(e=!0){ws=!!e,_a()}function Pc(){if(!p)return;const e=xt(p),t=p.blockOffsets||{};ho(e,t),_s(!1),j(c("reservations.quote.drag.saved","âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª."))}function Tc(){if(!p)return;const e=xt(p);p.blockOffsets={...ks[e]||{}},ho(e,p.blockOffsets),_s(!1),Xe(),j(c("reservations.quote.drag.reset","â†º ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ."))}function sr(e){return Math.min(Math.max(e,-tr),tr)}function jc(e="reservation"){try{const n=JSON.parse(localStorage.getItem(da)||"{}")?.[e];if(n&&typeof n=="object")return{...n}}catch{}return null}function Bc(e,t={}){try{const n=JSON.parse(localStorage.getItem(da)||"{}");n[e]=t,localStorage.setItem(da,JSON.stringify(n))}catch{}}function Cs(e){if(!e||On)return;const t=xt(e),n=jc(t);e.infoAlignments={...Ss,...Ua[t]||{},...n||{}},On=!0}function bo(e,t){const n=go(e),a=n?.infoAlignments;if(a&&Object.prototype.hasOwnProperty.call(a,t))return a[t];const s=xt(n);return Ua[s]?.[t]?Ua[s][t]:Ss[t]||"right"}function Pn(e,t){return`info-plain info-plain--align-${bo(e,t)}`}function Dc(e,t){if(!p)return;const n=Ec.includes(e)?e:"customer",a=["left","center","right"].includes(t)?t:"right";p.infoAlignments||(p.infoAlignments={...Ss}),p.infoAlignments[n]=a;const s=xt(p);Bc(s,p.infoAlignments),Xe(),Ca()}function Ca(){if(!X?.alignTarget)return;const e=X.alignTarget.value||"customer",t=bo(p,e);(X.alignButtons||[]).forEach(n=>{const a=n.dataset.alignValue;a&&n.classList.toggle("is-active",a===t)})}async function Fc(){try{if(!p)return;const e=xt(p),t=JSON.parse(localStorage.getItem(la)||"{}"),n=JSON.parse(localStorage.getItem(da)||"{}"),a={context:e,blockOffsets:p.blockOffsets||t[e]||{},infoAlignments:p.infoAlignments||n[e]||{}},s=JSON.stringify(a,null,2);let r=!1;if(navigator?.clipboard?.writeText)try{await navigator.clipboard.writeText(s),r=!0}catch{r=!1}r?j(c("reservations.quote.align.copied","âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©")):window.prompt(c("reservations.quote.align.copyPrompt","Ø§Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©"),s)}catch(e){console.error("[quote align export] failed",e),j(c("reservations.quote.align.copyFailed","âš ï¸ ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹"),"error")}}function Rc(e){try{const t=e?.getElementById("quotation-pdf-root");if(!t)return;Array.from(t.querySelectorAll("[data-drag-key]")).forEach(a=>{if(a.dataset.blockDragHandleAttached==="true")return;a.style.position=a.style.position||"relative",a.style.touchAction="none";const s=e.createElement("button");s.type="button",s.className="quote-block-drag-handle",s.setAttribute("data-block-handle",a.dataset.dragKey||""),s.setAttribute("aria-label",c("reservations.quote.drag.handle","Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…")),s.innerHTML='<span aria-hidden="true">â ¿</span>';const r=o=>{t.dataset.blockDragMode==="on"&&Mc(o,a)};s.addEventListener("pointerdown",r),a.prepend(s),a.dataset.blockDragHandleAttached="true"}),qs(e)}catch{}}function Mc(e,t){if(!t||!p)return;e.preventDefault(),e.stopPropagation();const n=t.ownerDocument||document,a=e.pointerId;t.setPointerCapture?.(a);const s=e.clientX,r=e.clientY,o=Number(t.dataset.dragX||0),i=Number(t.dataset.dragY||0);let l=o,d=i;const u=t.dataset.dragKey,y=m=>{m.preventDefault();const f=m.clientX-s,v=m.clientY-r;l=sr(o+f),d=sr(i+v),t.style.transform=`translate(${l}px, ${d}px)`,t.dataset.dragTempX=String(l),t.dataset.dragTempY=String(d)},b=()=>{n.removeEventListener("pointermove",y),n.removeEventListener("pointerup",b),t.releasePointerCapture?.(a);const m=Number(t.dataset.dragTempX??o),f=Number(t.dataset.dragTempY??i);t.dataset.dragX=String(m),t.dataset.dragY=String(f),t.dataset.dragTempX="",t.dataset.dragTempY="",p.blockOffsets||(p.blockOffsets={}),Math.abs(m)<=.5&&Math.abs(f)<=.5?delete p.blockOffsets[u]:p.blockOffsets[u]={x:m,y:f},_s(!0)};n.addEventListener("pointermove",y),n.addEventListener("pointerup",b)}function Jt(e="render",{message:t,actionLabel:n,onAction:a,showSpinner:s=e!=="error"}={}){if(!X?.statusIndicator||!X?.statusText)return;X.statusKind=e;const r=t||no(e);X.statusText.textContent=r,X.statusSpinner&&(X.statusSpinner.hidden=!s),X.statusAction&&(X.statusAction.hidden=!0,X.statusAction.onclick=null,n&&typeof a=="function"&&(X.statusAction.textContent=n,X.statusAction.hidden=!1,X.statusAction.onclick=o=>{o.preventDefault(),a()})),X.statusIndicator.hidden=!1,requestAnimationFrame(()=>{X.statusIndicator.classList.add("is-visible")})}function un(e){try{return String(e||"").toLowerCase().normalize("NFKD").replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,"").replace(/\s+/g," ").trim()}catch{return String(e||"").trim().toLowerCase()}}function Tn(e){!X?.statusIndicator||!X?.statusText||(X.statusKind=null,X.statusIndicator.classList.remove("is-visible"),setTimeout(()=>{X?.statusIndicator&&(X.statusIndicator.hidden=!0,X.statusAction&&(X.statusAction.hidden=!0,X.statusAction.onclick=null),X.statusSpinner&&(X.statusSpinner.hidden=!1))},220))}function Ga(){return!!window?.bootstrap?.Modal}function Oc(e){if(e&&!e.classList.contains("show")){e.classList.add("show"),e.style.display="block",e.removeAttribute("aria-hidden"),e.setAttribute("aria-modal","true"),e.getAttribute("role")||e.setAttribute("role","dialog"),document.body.classList.add("modal-open"),Mt||(Mt=document.createElement("div"),Mt.className="modal-backdrop fade show",Mt.dataset.quotePdfFallbackBackdrop="true",document.body.appendChild(Mt)),ln||(ln=t=>{t.key==="Escape"&&Qa(e)},document.addEventListener("keydown",ln));try{e.focus({preventScroll:!0})}catch{}}}function Qa(e){if(!(!e||!e.classList.contains("show"))){try{const t=e.ownerDocument?.activeElement;if(t&&e.contains(t)){try{t.blur()}catch{}try{e.ownerDocument?.body?.focus({preventScroll:!0})}catch{}}}catch{}e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal"),document.body.classList.remove("modal-open"),Mt&&(Mt.remove(),Mt=null),ln&&(document.removeEventListener("keydown",ln),ln=null);try{co()}catch{}}}function zc(e){if(e){if(Ga()){const t=window.bootstrap.Modal.getOrCreateInstance(e);try{const n=()=>{try{const a=document.activeElement;if(a&&e.contains(a)){try{a.blur()}catch{}try{document.body?.focus({preventScroll:!0})}catch{}}}catch{}try{co()}catch{}try{e.removeEventListener("hidden.bs.modal",n)}catch{}};e.addEventListener("hidden.bs.modal",n,{once:!0}),e.addEventListener("hide.bs.modal",()=>{try{const a=document.activeElement;if(a&&e.contains(a))try{a.blur()}catch{}}catch{}})}catch{}t.show();return}Oc(e)}}function Hc(){if(Nn)return;Nn=!0;const e=c("reservations.quote.toast.viewGuide","ðŸ“˜ Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹"),t=c("reservations.quote.toast.retry","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"),n=c("reservations.quote.toast.assetsFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± Ø¶Ù…Ù† Ø¹Ø±Ø¶ Ø³Ø¹Ø±."),a=!!X?.modal?.classList.contains("show"),s=()=>{X?.modal?.classList.contains("show")&&(Jt("render"),Nn=!1,Xe())};$r({message:n,duration:9e3,actionLabel:a?t:void 0,onAction:a?s:void 0,linkLabel:e,linkHref:Jr}),a&&Jt("error",{message:n,actionLabel:t,onAction:s,showSpinner:!1})}function Vn(e="reservation"){const t={},n=Zr(e);return Object.entries(n).forEach(([a,s=[]])=>{t[a]=new Set(s.filter(r=>r?.default!==!1).map(r=>r.id))}),t}function xs(e={}){const t={};return Object.entries(e).forEach(([n,a])=>{t[n]=new Set(Array.from(a||[]))}),t}function Kc(e={},t){if(t)return e[t]||(e[t]=new Set),e[t]}function $s(e={},t,n){const a=e?.[t];return a?a instanceof Set?a.has(n):Array.isArray(a)?a.includes(n):!!a?.[n]:!0}function xa(e="reservation"){return Object.fromEntries(qa(e).map(({id:t})=>[t,!1]))}function Ls(e,t){return e.sectionExpansions||(e.sectionExpansions=xa(e.context||"reservation")),t&&typeof e.sectionExpansions[t]!="boolean"&&(e.sectionExpansions[t]=!1),e.sectionExpansions}function Vc(e,t){return Ls(e,t)?.[t]!==!1}function Ns(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 768px)").matches}function Uc(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||navigator.platform||"";return Ic.test(e)}function Gc(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=uo.test(e),n=e.includes("Chrome")||e.includes("CriOS")||e.includes("Chromium"),a=e.includes("Edg");return t&&!n&&!a}function vo(){return Uc()&&Gc()}function $a(){if(typeof navigator>"u")return!1;const e=navigator.userAgent||"",t=navigator.platform||"",n=Number.isFinite(navigator.maxTouchPoints)?navigator.maxTouchPoints:0,a=er.test(e)||er.test(t),s=/Macintosh/i.test(e)&&n>1;return uo.test(e)&&!Ac.test(e)&&(a||s)}function Da(e,...t){try{console.log(`${ca} ${e}`,...t)}catch{}}function Nt(e,...t){try{console.warn(`${ca} ${e}`,...t)}catch{}}function Qc(e,t,...n){try{t?console.error(`${ca} ${e}`,t,...n):console.error(`${ca} ${e}`,...n)}catch{}}function Re(e,{blockType:t="section",extraAttributes:n=""}={}){if(!e)return"";const a=n?` ${n.trim()}`:"";return e.replace(/^(<\w+)/,`$1 data-quote-block data-block-type="${t}"${a}`)}function Wc(e,t="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶."){const n=h(c(e,t));return Re(`<section class="quote-section quote-placeholder">${n}</section>`,{blockType:"placeholder"})}function pa(e,t){return Array.isArray(e)&&e.length?e:[Wc(t)]}const Yc=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;function So(e=""){return Yc.test(e)}function Jc(){const e=window.CanvasRenderingContext2D?.prototype;if(!e||e.__artRatioDirectionPatched)return;const t=n=>{const a=e[n];typeof a=="function"&&(e[n]=function(r,...o){if(typeof r!="string"||!So(r))return a.call(this,r,...o);let i,l=!1;try{"direction"in this&&(i=this.direction,i!=="rtl"&&(this.direction="rtl"),l=!0)}catch{}try{if(!l){const d=this.canvas;d&&d.style?.direction!=="rtl"&&(d.__artRatioOriginalDirection=d.style.direction,d.style.direction="rtl")}return a.call(this,r,...o)}finally{if(l&&i!==void 0&&i!=="rtl")try{this.direction=i}catch{}else if(!l){const d=this.canvas;d&&d.__artRatioOriginalDirection!==void 0&&(d.style.direction=d.__artRatioOriginalDirection,delete d.__artRatioOriginalDirection)}}})};t("fillText"),t("strokeText"),e.__artRatioDirectionPatched=!0}function rr(e,t=Cn){if(typeof e!="string"&&typeof e!="number")return t;const n=parseFloat(String(e).replace(/[^0-9.+-]/g,""));return Number.isFinite(n)&&n>0?n:t}function Xc(e){if(!e)return{width:Cn,height:Cn};const t=e.getAttribute?.("width"),n=e.getAttribute?.("height");let a=t?rr(t,0):0,s=n?rr(n,0):0;if(a>0&&s>0)return{width:a,height:s};const r=e.getAttribute?.("viewBox");if(r){const o=r.trim().split(/[\s,]+/).map(i=>parseFloat(i||"0"));if(o.length>=4){const[,,i,l]=o;a=a||(Number.isFinite(i)&&i>0?i:0),s=s||(Number.isFinite(l)&&l>0?l:0)}}return{width:a||Cn,height:s||Cn}}function wo(e=""){return typeof e!="string"?!1:ro.test(e)||kc.test(e)}function Zc(e=""){const t=e.indexOf(",");if(t===-1)return"";const n=e.slice(0,t),a=e.slice(t+1);try{return/;base64/i.test(n)?typeof atob=="function"?atob(a):"":decodeURIComponent(a)}catch(s){return console.warn("[reservations/pdf] failed to decode SVG data URI",s),""}}function el(e,{crossOrigin:t}={}){return new Promise((n,a)=>{const s=new Image;t&&(s.crossOrigin=t),s.onload=()=>n(s),s.onerror=r=>{const o=r?.message||`Unable to load image from ${e}`;a(new Error(o))},s.src=e})}async function ko(e,t={}){if(!e)return null;const n=document,a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a);try{const r=await el(s),o=n.createElement("canvas"),i=Math.max(t.width||r.naturalWidth||r.width||0,1),l=Math.max(t.height||r.naturalHeight||r.height||i,1);o.width=i,o.height=l;const d=o.getContext("2d");return d.clearRect(0,0,i,l),d.drawImage(r,0,0,i,l),o.toDataURL("image/png")}catch(r){return console.warn("[reservations/pdf] failed to rasterize SVG content",r),null}finally{URL.revokeObjectURL(s)}}async function tl(e){if(!e)return null;if(ro.test(e))return Zc(e);try{const t=await fetch(e,{mode:"cors",credentials:"omit",cache:"default"});return t.ok?await t.text():(console.warn("[reservations/pdf] failed to fetch SVG image",e,t.status),null)}catch(t){return console.warn("[reservations/pdf] error fetching SVG image",e,t),null}}async function nl(e){if(!e)return!1;const t=e.getAttribute?.("src")||"";if(!wo(t))return!1;const n=await tl(t);if(!n)return e.dataset.svgRasterization="failed",e.setAttribute("src",Ka),!1;const a=await ko(n);return a?(e.dataset.svgOriginalSrc=t,e.setAttribute("src",a),e.setAttribute("data-rasterized","true"),!0):(e.dataset.svgRasterization="failed",e.setAttribute("src",Ka),!1)}async function al(e){if(!e||e.tagName?.toLowerCase()!=="svg")return!1;const n=new XMLSerializer().serializeToString(e),a=Xc(e),s=await ko(n,a),o=(e.ownerDocument||document).createElement("img");o.setAttribute("src",s||Ka),o.setAttribute("alt",e.getAttribute("aria-label")||e.getAttribute("title")||""),o.setAttribute("data-svg-replaced","true"),e.hasAttribute("class")&&o.setAttribute("class",e.getAttribute("class")),e.hasAttribute("style")&&o.setAttribute("style",e.getAttribute("style"));const i=e.getAttribute("width"),l=e.getAttribute("height");return i&&o.setAttribute("width",i),l&&o.setAttribute("height",l),e.parentNode?.replaceChild(o,e),!!s}async function Io(e){if(!e)return;const t=Array.from(e.querySelectorAll?.("img")||[]),n=Array.from(e.querySelectorAll?.("svg")||[]),a=[];t.forEach(s=>{wo(s.getAttribute?.("src"))&&a.push(nl(s))}),n.forEach(s=>{a.push(al(s))}),a.length&&await Promise.allSettled(a)}function sl(e,{pixelRatio:t=1}={}){if(!e)return null;const n=e.ownerDocument||document,s=(n.defaultView||window).getComputedStyle?.(e);if(!s)return null;const r=(M,P=0)=>{const G=parseFloat(M);return Number.isFinite(G)?G:P},o=r(s.paddingTop),i=r(s.paddingBottom),l=r(s.paddingRight),d=r(s.paddingLeft),u=r(s.borderRadius),y=r(s.fontSize,14),b=(()=>{const M=s.lineHeight;if(!M||M==="normal")return y*1.6;const P=r(M,y*1.6);return P>0?P:y*1.6})(),m=Math.max(e.clientWidth||0,e.scrollWidth||0,r(s.width,0));if(m<=0)return null;const f=Math.max(1,m-d-l),v=e.textContent||"",I=v.split(/\r?\n/),A=n.createElement("canvas"),w=A.getContext("2d");if(!w)return null;const D=s.fontStyle||"normal",U=s.fontVariant||"normal",Y=s.fontWeight||"400",S=s.fontFamily||"sans-serif",C=s.fontStretch||"normal",q=M=>M.join(" "),E=[],Q=M=>w.measureText(M).width;w.font=`${D} ${U} ${Y} ${C} ${y}px ${S}`,I.forEach(M=>{const P=M.trim();if(P.length===0){E.push("");return}const G=P.split(/\s+/);let ie=[];G.forEach((Z,me)=>{const be=Z.trim();if(!be)return;const J=q(ie.concat(be));if(Q(J)<=f||ie.length===0){ie.push(be);return}E.push(q(ie)),ie=[be]}),ie.length&&E.push(q(ie))}),E.length||E.push("");const B=o+i+E.length*b,ne=Math.ceil(Math.max(1,m)*t),F=Math.ceil(Math.max(1,B)*t);A.width=ne,A.height=F,A.style.width=`${Math.max(1,m)}px`,A.style.height=`${Math.max(1,B)}px`,w.scale(t,t);const W=s.backgroundColor&&s.backgroundColor!=="rgba(0, 0, 0, 0)"?s.backgroundColor:"#ffffff";if(u>0){w.save(),w.beginPath();const M=Math.max(1,m),P=Math.max(1,B),G=Math.min(u,M/2,P/2);w.moveTo(G,0),w.lineTo(M-G,0),w.quadraticCurveTo(M,0,M,G),w.lineTo(M,P-G),w.quadraticCurveTo(M,P,M-G,P),w.lineTo(G,P),w.quadraticCurveTo(0,P,0,P-G),w.lineTo(0,G),w.quadraticCurveTo(0,0,G,0),w.closePath(),w.clip()}if(w.fillStyle=W,w.fillRect(0,0,Math.max(1,m),Math.max(1,B)),w.font=`${D} ${U} ${Y} ${C} ${y}px ${S}`,w.fillStyle=s.color||"#000000",w.textBaseline="top",w.textAlign="right","direction"in w)try{w.direction="rtl"}catch{}const N=Math.max(0,m-l);let T=o;E.forEach(M=>{const P=M.length?M:" ";w.fillText(P,N,T,f),T+=b});const H=n.createElement("img");let K;try{K=A.toDataURL("image/png")}catch(M){return Nt("note canvas toDataURL failed",M),null}return H.src=K,H.alt=v,H.style.width=`${Math.max(1,m)}px`,H.style.height=`${Math.max(1,B)}px`,H.style.display="block",H.setAttribute("data-quote-note-image","true"),{image:H,canvas:A,totalHeight:B,width:m}}function rl(e,{pixelRatio:t=1}={}){if(!e||!$a())return;Array.from(e.querySelectorAll?.(".quote-notes")||[]).forEach(a=>{if(!a||a.dataset.quoteNoteRasterized==="true"||!So(a.textContent||""))return;let s;try{s=sl(a,{pixelRatio:t})}catch(r){Nt("failed to rasterize note content",r),s=null}s&&(a.dataset.quoteNoteRasterized="true",a.innerHTML="",a.appendChild(s.image))})}function Wa(e,t="export",{toastMessage:n,suppressToast:a=!1}={}){Qc(`${t} failed`,e);const s=!!(e&&e.__artRatioPdfNotified);if(!a&&!s){const r=c("reservations.quote.errors.exportFailed","âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDFØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."),o=n||r,i=c("reservations.quote.toast.viewGuide","ðŸ“˜ Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹"),l=c("reservations.quote.toast.retry","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"),d=["exportQuoteAsPdf","renderQuotePreview","layoutQuoteDocument","pageCapture"].includes(t),u=()=>{t==="exportQuoteAsPdf"?(Jt("export"),No()):(Jt("render"),Nn=!1,Xe())};if($r({message:o,duration:9e3,actionLabel:d?l:void 0,onAction:d?u:void 0,linkLabel:i,linkHref:Jr}),X?.modal?.classList.contains("show")&&Jt("error",{message:o,actionLabel:d?l:void 0,onAction:d?u:void 0,showSpinner:!1}),e&&typeof e=="object")try{Object.defineProperty(e,"__artRatioPdfNotified",{value:!0,writable:!1,enumerable:!1,configurable:!0})}catch{}}}function Ya({container:e,safariWindowRef:t,mobileWindowRef:n}={}){try{n&&!n.closed&&n.close()}catch(a){Nt("failed to close mobile window",a)}try{t&&!t.closed&&t.close()}catch(a){Nt("failed to close safari window",a)}e&&e.parentNode&&e.parentNode.removeChild(e)}function Ps(e){return new Promise((t,n)=>{const a=document.querySelector(`script[src="${e}"]`);if(a){a.addEventListener("load",()=>t()),a.addEventListener("error",r=>n(r)),a.readyState==="complete"&&t();return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>t(),s.onerror=r=>n(r),document.head.appendChild(s)})}function or(){const e=[window.jspdf?.jsPDF,typeof window.jspdf=="function"?window.jspdf:null,window.jsPDF?.jsPDF,typeof window.jsPDF=="function"?window.jsPDF:null].filter(t=>typeof t=="function");return e.length?e[0]:null}function ir(){return typeof window.html2canvas=="function"?window.html2canvas:null}async function ol(){const e=ir();return e||(En||(En=Ps(Sc).catch(t=>{throw En=null,t}).then(()=>{const t=ir();if(!t)throw En=null,new Error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© html2canvas Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");return t})),En)}async function il(){const e=or();return e||(An||(An=Ps(wc).catch(t=>{throw An=null,t}).then(()=>{const t=or();if(!t)throw An=null,new Error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© jsPDF Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");return t})),An)}async function cl(){if(window.html2pdf||await Ps(vc),window.html2pdf&&!window.html2pdf.__artRatioConfigured){const e=window.html2pdf.defaultOptions||window.html2pdf.defaultOpt||{},t={...e.html2canvas||{}};t.useCORS=!0,t.allowTaint=!1,t.logging=!0;const n={unit:"mm",format:"a4",orientation:"portrait",compress:!0,...e.jsPDF||{}},a={image:{type:"jpeg",quality:.95,...e.image||{}},margin:e.margin??[0,0,0,0],filename:e.filename||"document.pdf",html2canvas:t,jsPDF:n};window.html2pdf.defaultOptions=a,window.html2pdf.defaultOpt=a,window.html2pdf.__artRatioConfigured=!0}oc(),Jc()}function h(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ao(e="reservation"){return Zs[e]||Zs.reservation}function ll(){try{window.localStorage?.removeItem?.(pc)}catch{}}function dl(e="reservation"){try{ll();const t=Ao(e),n=window.localStorage?.getItem?.(t);if(!n)return null;const a=JSON.parse(n);return a&&typeof a=="object"?a:null}catch(t){return console.warn("âš ï¸ [reservations/pdf] failed to read toggle preferences",t),null}}function ul(e,t="reservation"){try{const n=Ao(t);if(!e){window.localStorage?.removeItem?.(n);return}window.localStorage?.setItem?.(n,JSON.stringify(e))}catch(n){console.warn("âš ï¸ [reservations/pdf] failed to persist toggle preferences",n)}}function pl(e){if(!e)return{ids:null,emptyExplicitly:!1};if(e instanceof Set)return{ids:Array.from(e),emptyExplicitly:e.size===0};if(Array.isArray(e))return{ids:e.slice(),emptyExplicitly:e.length===0};if(typeof e=="object"){const t=Object.entries(e).filter(([,n])=>!!n);return{ids:t.map(([n])=>n),emptyExplicitly:t.length===0}}return{ids:null,emptyExplicitly:!1}}function ml(e,t="reservation"){if(!e)return null;const n=eo(t),a=to(t),s=Array.from(e.sections instanceof Set?e.sections:new Set(e.sections||[])).filter(i=>n.has(i)),r={},o=e.fields||{};return Object.entries(a).forEach(([i,l])=>{const d=o[i];if(d==null)return;const{ids:u,emptyExplicitly:y}=pl(d);if(!u&&!y)return;const b=Array.isArray(u)?u.filter(m=>l.has(m)):[];(b.length>0||y)&&(r[i]=b)}),{version:1,sections:s,fields:r}}function Eo(e){if(!e)return;const t=e.context||"reservation",n=ml(e,t);n&&ul(n,t)}function Ts(e){if(!e)return;const t=e.context||"reservation",n=dl(t);if(!n)return;const a=eo(t),s=Array.isArray(n.sections)?n.sections.filter(r=>a.has(r)):[];if(s.length&&(e.sections=new Set(s)),n.fields&&typeof n.fields=="object"){const r=xs(e.fields||Vn(t)),o=to(t);Object.entries(n.fields).forEach(([i,l])=>{const d=o[i];if(!d)return;const u=Array.isArray(l)?l.filter(y=>d.has(y)):[];r[i]=new Set(u)}),e.fields=r}}function js(e=new Date){try{return e.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return e.toISOString().slice(0,10)}}function La(e){const t=yn()||[],{technicians:n=[]}=Te(),a=[].concat(Array.isArray(t)?t:[]).concat(Array.isArray(n)?n:[]),s=new Map;return a.forEach(o=>{if(!o||o.id==null)return;const i=String(o.id),l=s.get(i)||{};s.set(i,{...l,...o})}),(Array.isArray(e.crewAssignments)&&e.crewAssignments.length?e.crewAssignments:Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length?e.techniciansDetails:(e.technicians||[]).map(o=>({technicianId:o}))).map((o,i)=>{const l=o?.technicianId!=null?s.get(String(o.technicianId)):null;let d=o.positionLabel??o.position_name??o.position_label??o.role??o.position??l?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");(!d||d.trim()==="")&&(d=o.positionLabelAr??o.position_label_ar??o.positionLabelEn??o.position_label_en??o.position_name_ar??o.position_name_en??l?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"));try{const b=typeof gn=="function"?gn()||[]:[];let m=null;if(o?.positionId!=null&&(m=b.find(f=>String(f?.id)===String(o.positionId))||null),!m){const f=o.positionKey??o.position_key??o.positionName??o.position_name??o.position??"";if(f&&(m=typeof Js=="function"&&Js(f)||null,!m&&b.length)){const v=String(f).trim().toLowerCase();m=b.find(I=>[I.name,I.labelAr,I.labelEn].filter(Boolean).map(A=>String(A).toLowerCase()).includes(v))||null}}if(m){const f=m.labelAr||m.labelEn||m.name||"";f&&f.trim()&&(d=f)}}catch{}const u=nt(pt(o.positionCost??o.position_cost??o.cost??o.daily_wage??o.dailyWage??l?.dailyWage??l?.wage??0)),y=nt(pt(o.positionClientPrice??o.position_client_price??o.client_price??o.clientPrice??o.daily_total??o.dailyTotal??o.total??l?.dailyTotal??l?.total??l?.total_wage??0));return{assignmentId:o.assignmentId??o.assignment_id??`crew-${i}`,positionId:o.positionId??o.position_id??null,positionLabel:d,positionLabelAlt:o.positionLabelAlt??o.position_label_alt??"",positionCost:u,positionClientPrice:y,technicianId:o.technicianId!=null?String(o.technicianId):l?.id!=null?String(l.id):null,technicianName:o.technicianName??o.technician_name??l?.name??null,technicianRole:o.technicianRole??l?.role??null}})}function Bs(e,t,n){const{projectLinked:a}=In(e,n);fn(e.start,e.end);const s=e.discount??e.discountValue??0,r=Number(k(String(s)))||0,o=e.discountType??e.discount_type??"percent",i=String(o).toLowerCase()==="amount"?"amount":"percent",l=a?!1:!!(e.applyTax??e.apply_tax??e.taxApplied),d=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,u=d!=null?pt(d):Number.NaN,b=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied)===!0&&Number.isFinite(u)&&u>0?u:null,m=Array.isArray(t)?t.map(U=>U?.technicianId).filter(Boolean):[],f=cs({items:Array.isArray(e.items)?e.items:[],technicianIds:m,crewAssignments:Array.isArray(t)?t:[],discount:r,discountType:i,applyTax:l,start:e.start,end:e.end,companySharePercent:b,groupingSource:e}),v=pt(e.cost??e.total??e.finalTotal),I=Number.isFinite(v),A=a?f.finalTotal:I?nt(v):f.finalTotal,w={equipmentTotal:f.equipmentTotal,equipmentCostTotal:f.equipmentCostTotal,crewTotal:f.crewTotal,crewCostTotal:f.crewCostTotal,discountAmount:f.discountAmount,subtotalAfterDiscount:f.subtotalAfterDiscount,taxableAmount:f.taxableAmount,taxAmount:f.taxAmount,finalTotal:A,companySharePercent:f.companySharePercent,companyShareAmount:f.companyShareAmount,netProfit:f.netProfit},D={equipmentTotal:Le(f.equipmentTotal),equipmentCostTotal:Le(f.equipmentCostTotal),crewTotal:Le(f.crewTotal),discountAmount:Le(f.discountAmount),subtotalAfterDiscount:Le(f.subtotalAfterDiscount),taxableAmount:Le(f.taxableAmount),taxAmount:Le(f.taxAmount),finalTotal:Le(A),companySharePercent:k((Number.isFinite(f.companySharePercent)?f.companySharePercent:0).toFixed(2)),companyShareAmount:Le(f.companyShareAmount),netProfit:k(f.netProfit.toFixed(2))};return{totals:w,totalsDisplay:D,rentalDays:f.rentalDays}}function vn(e){if(e==null||e==="")return null;const t=Number.parseFloat(k(String(e)));return Number.isFinite(t)?t:null}function qo(e){if(!e)return new Date().toISOString();const t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function fl(e){if(!e||typeof e!="object")return null;const t=e.type??e.payment_type??e.paymentType??null;let n=typeof t=="string"?t.trim().toLowerCase():null;n!=="percent"&&(n="amount");const a=vn(e.amount??(n==="amount"?e.value:null)),s=vn(e.percentage??(n==="percent"?e.value:null)),r=n==="percent"?s??null:a??null,o=e.note??e.memo??null,i=qo(e.recordedAt??e.recorded_at??e.date??e.created_at??null);return n==="amount"&&a==null||n==="percent"&&s==null?null:{type:n,amount:a??null,percentage:s??null,value:r,note:o,recordedAt:i}}function yl(e={}){const n=(Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[]).map(fl).filter(Boolean);if(n.length>0)return n;const a=vn(e.paidPercent??e.paid_percent),s=vn(e.paidAmount??e.paid_amount),r=e.updatedAt??e.updated_at??e.createdAt??e.created_at??null,o=qo(r);return a!=null&&a>0?[{type:"percent",amount:s!=null&&s>0?s:null,percentage:a,value:a,note:null,recordedAt:o}]:s!=null&&s>0?[{type:"amount",amount:s,percentage:null,value:s,note:null,recordedAt:o}]:[]}function gl(e){if(!e)return c("projects.form.types.unknown","Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯");const t={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[e]||"projects.form.types.unknown";return c(t,e)}function hl(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function bl(e){if(Array.isArray(e?.expenses)&&e.expenses.some(a=>Number.isFinite(Number(a?.salePrice??a?.sale_price))))return e.expenses.reduce((a,s)=>a+(Number(s?.salePrice??s?.sale_price)||0),0);const t=Number(e?.servicesClientPrice??e?.services_client_price);return Number.isFinite(t)&&t>=0?t:typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((n,a)=>n+(Number(a?.amount)||0),0):0}function vl(e){if(!e)return 0;const t=Array.isArray(e.items)?e.items:[],n=e.discount??0,a=Number(k(String(n)))||0,s=e.discountType||"percent",r=Array.isArray(e.crewAssignments)?e.crewAssignments:[],o=r.length?r:Array.isArray(e.technicians)?e.technicians:[],i=ls(t,a,s,!1,o,{start:e.start,end:e.end,companySharePercent:0});if(Number.isFinite(i))return i;const l=Number(k(String(e.cost??0)));return Number.isFinite(l)?Math.round(l):0}function Sl(e,t){if(!e)return"â€”";const n=Pt(e);return t?`${n} - ${Pt(t)}`:n}function _e(e,t="SR",n=2){const a=Number(e);return`${Le(a)} ${t}`}function cr(e,t=2){if(!Number.isFinite(Number(e)))return"0%";const n=Number.isInteger(t)?t:2;return`${k(Number(e).toFixed(n))}%`}function _o(){if(!p)return!1;if((p.context||"reservation")==="project"){const a=p.project||{};if([a.companyShareEnabled,a.company_share_enabled,a.companyShareApplied,a.company_share_applied].some(r=>r===!0||r==="true"))return!0;const s=p.projectTotals||{};return!!(Number.isFinite(Number(s.companyShareAmount))&&Number(s.companyShareAmount)>0)}const t=p.reservation||{};if([t.companyShareEnabled,t.company_share_enabled,t.companyShareApplied,t.company_share_applied].some(a=>a===!0||a==="true"))return!0;const n=p.totals||{};return Number.isFinite(Number(n.companyShareAmount))&&Number(n.companyShareAmount)>0}function wl(){if(!p)return!1;if((p.context||"reservation")==="project"){const a=p.project||{};if([a.applyTax,a.apply_tax].some(r=>r===!0||r==="true"))return!0;const s=p.projectTotals||{};return[s.applyTax].some(r=>r===!0||r==="true")?!0:Number.isFinite(Number(s.taxAmount))&&Number(s.taxAmount)>0}const t=p.reservation||{};if([t.applyTax,t.apply_tax,t.taxApplied,t.tax_applied].some(a=>a===!0||a==="true"))return!0;const n=p.totals||{};return Number.isFinite(Number(n.taxAmount))&&Number(n.taxAmount)>0}function kl(){return _o()&&wl()}function Il(){if(!p)return null;const t=(p.context||"reservation")==="project"?[p.project?.companySharePercent,p.project?.company_share_percent,p.project?.companyShare,p.project?.company_share,p.projectTotals?.companySharePercent,p.projectTotals?.projectSharePercent]:[p.reservation?.companySharePercent,p.reservation?.company_share_percent,p.reservation?.companyShare,p.reservation?.company_share,p.totals?.companySharePercent];for(let n=0;n<t.length;n+=1){const a=t[n],s=Number(a);if(Number.isFinite(s)&&s>0)return s}return null}function Al(){if(!_o())return 0;const e=Il();return Number.isFinite(e)&&e>0?e:Ht}function El(){if(!kl())return 1;const e=Al();return e>0?1+e/100:1}function ct(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return t;const n=El();return n===1?t:Number((t*n).toFixed(2))}function ql(e){if(!e?.start)return null;if(!e?.end)return 1;const t=fn(e.start,e.end);return Number.isFinite(t)?t:1}function _l(e){return Number.isFinite(e)?e<=1?"ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯":`${k(String(Math.round(e)))} Ø£ÙŠØ§Ù…`:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}function lr(e){const t=c("reservations.create.summary.currency","SR"),n=Te()||{},a=Array.isArray(n.customers)?n.customers:[],s=Array.isArray(n.projects)?n.projects:[],r=Array.isArray(n.technicians)?n.technicians:[];let o=[];try{const g=wa?.()||[];o=Array.isArray(g)&&g.length?g:n.reservations||[]}catch{o=n.reservations||[]}const i=e?.id!=null?s.find(g=>String(g.id)===String(e.id))||e:e||null,l={projectStatusLabel:c("projects.status.ongoing","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"),paymentStatusLabel:c("projects.paymentStatus.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹")};if(!i)return{project:null,customer:null,clientInfo:{name:"-",company:"-",phone:"-",email:"-"},projectInfo:{title:"-",code:"-",typeLabel:"-",startDisplay:"-",endDisplay:"-",durationLabel:"-",statusLabel:l.projectStatusLabel},expenses:[],equipment:[],reservations:[],totals:{equipmentEstimate:0,expensesTotal:0,baseSubtotal:0,discountAmount:0,subtotalAfterDiscount:0,companyShareAmount:0,subtotal:0,applyTax:!1,taxAmount:0,totalWithTax:0},totalsDisplay:{projectSubtotal:_e(0,t),expensesTotal:_e(0,t),reservationsTotal:_e(0,t),discountAmount:_e(0,t),taxAmount:_e(0,t),overallTotal:_e(0,t),paidAmount:_e(0,t),remainingAmount:_e(0,t)},projectTotals:{combinedTaxAmount:0,overallTotal:0,reservationsTotal:0,paidAmount:0,paidPercent:0,remainingAmount:0,paymentStatus:"unpaid"},paymentSummary:{status:"unpaid",statusLabel:l.paymentStatusLabel,paidAmount:0,paidPercent:0,remainingAmount:0,paidAmountDisplay:_e(0,t),remainingAmountDisplay:_e(0,t),paidPercentDisplay:cr(0)},notes:"",currencyLabel:t,projectStatus:"ongoing",projectStatusLabel:l.projectStatusLabel,projectDurationDays:null,projectDurationLabel:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",paymentHistory:[]};const d=i.clientId??i.customerId??i.client_id??i.customer_id??null,u=d!=null&&a.find(g=>String(g.id)===String(d))||null,y=u?.customerName??u?.name??i.clientName??i.customerName??c("projects.fallback.unknownClient","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),b=(i.clientCompany||u?.companyName||u?.company||"").trim(),m=u?.phone??u?.customerPhone??i.clientPhone??i.customerPhone??"",f=m?k(String(m).trim()):c("projects.details.client.noPhone","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…ØªØ§Ø­"),v=u?.email??i.clientEmail??i.customerEmail??"",I=v?String(v).trim():c("projects.details.client.noEmail","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ù…ØªØ§Ø­"),A=i.projectCode||`PRJ-${k(String(i.id??""))}`,w=k(String(A)),D=(i.title||"").trim()||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"),U=gl(i.type),Y=i.start?Pt(i.start):"â€”",S=i.end?Pt(i.end):"â€”",C=ql(i),q=C!=null?_l(C):"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",E=hl(i),Q={upcoming:"Ù‚Ø§Ø¯Ù…",ongoing:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",completed:"Ù…ÙƒØªÙ…Ù„"},B=c(`projects.status.${E}`,Q[E]||E),ne=i.id!=null?String(i.id):null,F=ne?o.filter(g=>{const $=g?.projectId??g?.project_id??null;return $!=null&&String($)===ne}):[];F.map(g=>{const $=g.reservationId||g.id||"",O=g.status||g.state||"pending",ee=String(O).toLowerCase(),te=c(`reservations.status.${ee}`,ee),ae=vl(g),he=g.start?new Date(g.start).getTime():0;return{reservationId:k(String($||"-")),status:ee,statusLabel:te,total:ae,totalLabel:_e(ae,t),dateRange:Sl(g.start,g.end),startTimestamp:Number.isNaN(he)?0:he}}).sort((g,$)=>$.startTimestamp-g.startTimestamp).map(({startTimestamp:g,...$})=>$);let W=0,N=0;try{F.forEach(g=>{const $=cs({items:Array.isArray(g.items)?g.items:[],technicianIds:Array.isArray(g.technicians)?g.technicians:[],crewAssignments:Array.isArray(g.crewAssignments)?g.crewAssignments:[],discount:Number(g.discount??0)||0,discountType:g.discountType||"percent",applyTax:!1,start:g.start,end:g.end,groupingSource:g,companySharePercent:0});W+=Number($.equipmentTotal||0),N+=Number($.crewTotal||0)})}catch{}const T=bl(i),H=Number(W+N+T),K=[];try{F.forEach(g=>{const{groups:$}=nn(g);$.forEach(O=>{const ee=Number(O?.count??O?.quantity??1)||1,te=Number(O?.unitPrice);let ae=Number.isFinite(te)?te:0;if(!ae||ae<=0){const He=Number(O?.totalPrice);Number.isFinite(He)&&ee>0&&(ae=Number((He/ee).toFixed(2)))}Number.isFinite(ae)||(ae=0);const he=O?.type==="package"||Array.isArray(O?.items)&&O.items.some(He=>He?.type==="package"),ce=Array.isArray(O?.barcodes)&&O.barcodes.length?O.barcodes[0]:Array.isArray(O?.items)&&O.items.length?O.items[0]?.barcode:null;let le=O?.packageDisplayCode??O?.package_code??O?.code??O?.packageCode??(Array.isArray(O?.items)&&O.items.length?O.items[0]?.package_code??O.items[0]?.code??O.items[0]?.packageCode:null);const We=He=>{const it=(He==null?"":String(He)).trim();return!!(!it||/^pkg-/i.test(it)||/^\d+$/.test(it)&&it.length<=4)};if(!le||We(le)){const He=O?.packageId??O?.package_id??(Array.isArray(O?.items)&&O.items.length?O.items[0]?.packageId??O.items[0]?.package_id:null);if(He)try{const it=us(He);it&&it.package_code&&(le=it.package_code)}catch{}}if(!le||We(le))try{const He=un(O?.description||"");if(He){const it=Rr();let bt=it.find($t=>un($t?.name||$t?.title||$t?.label||"")===He);bt||(bt=it.find($t=>{const Gt=un($t?.name||$t?.title||$t?.label||"");return Gt.includes(He)||He.includes(Gt)})),bt&&bt.package_code&&(le=bt.package_code)}}catch{}const Ve=he?le??ce??"":O?.barcode??ce??"",yt=Ve!=null?String(Ve):"",on=Number.isFinite(Number(O?.totalPrice))?Number(O.totalPrice):Number((ae*ee).toFixed(2));K.push({...O,isPackage:he,desc:O?.description,barcode:yt,packageCodeResolved:le||"",qty:ee,price:ae,totalPrice:nt(on),unitPriceValue:ae})})})}catch{}const M=new Map;F.forEach(g=>{const $=Array.isArray(g.items)?g.items:[],O=fn(g.start,g.end),ee=g.reservationId||g.id||"";$.forEach((te,ae)=>{if(!te)return;const he=te.barcode||te.code||te.id||te.desc||te.description||`item-${ae}`,ce=String(he||`item-${ae}`),le=M.get(ce)||{description:te.desc||te.description||te.name||te.barcode||`#${k(String(ae+1))}`,totalQuantity:0,reservationsCount:0,reservationIds:new Set,totalCost:0},We=Number(te.qty)||1,Ve=Number(te.price)||0;le.totalQuantity+=We,le.reservationIds.add(String(ee));const yt=Ve*We*Math.max(1,O);Number.isFinite(yt)&&(le.totalCost+=yt),M.set(ce,le)})});const P=Array.from(M.values()).map(g=>({description:g.description,totalQuantity:g.totalQuantity,reservationsCount:g.reservationIds.size,displayCost:_e(g.totalCost,t)})),G=new Map((r||[]).filter(Boolean).map(g=>[String(g.id),g])),ie=new Map,Z=g=>{if(!g)return;let $=null;typeof g=="object"?$=g.id??g.technicianId??g.technician_id??g.userId??g.user_id??null:(typeof g=="string"||typeof g=="number")&&($=g);const O=$!=null?String($):null,ee=O&&G.has(O)?G.get(O):typeof g=="object"?g:null,te=ee?.name||ee?.full_name||ee?.fullName||ee?.displayName||(typeof g=="string"?g:null),ae=ee?.role||ee?.title||null,he=ee?.phone||ee?.mobile||ee?.contact||null;if(!te&&!O)return;const ce=O||te;ie.has(ce)||ie.set(ce,{id:O,name:te||"-",role:ae||null,phone:he||null})};Array.isArray(i?.technicians)&&i.technicians.forEach(g=>Z(g)),F.forEach(g=>{(Array.isArray(g.crewAssignments)&&g.crewAssignments.length?g.crewAssignments:Array.isArray(g.technicians)?g.technicians.map(O=>({technicianId:O})):[]).forEach(O=>Z(O))});const me=Array.from(ie.values()),be=Array.isArray(i.expenses)?i.expenses.map(g=>{const $=Number(g?.salePrice??g?.sale_price??g?.amount)||0;return{label:g?.label||g?.name||"-",amount:$,displayAmount:_e($,t),note:g?.note||g?.description||""}}):[],J=i?.applyTax===!0||i?.applyTax==="true",ge=Number.parseFloat(i?.discount??i?.discountValue??0)||0;let Ie=(i?.discountType==="amount"?"amount":"percent")==="amount"?ge:H*(ge/100);(!Number.isFinite(Ie)||Ie<0)&&(Ie=0),Ie>H&&(Ie=H);const je=Math.max(0,H-Ie),Be=i?.companyShareEnabled===!0||i?.company_share_enabled===!0||i?.companyShareApplied===!0||i?.company_share_applied===!0,De=Number.parseFloat(i?.companySharePercent??i?.company_share_percent??i?.companyShare??i?.company_share??0)||0,Ce=Be&&De>0?De:0,Oe=Ce>0?Number((je*(Ce/100)).toFixed(2)):0,Ke=Number((je+Oe).toFixed(2)),xe=J?Number((Ke*Pi).toFixed(2)):0,Fe=Number((Ke+xe).toFixed(2)),ze=yl(i),V=vn(i.paidAmount??i.paid_amount)||0,re=vn(i.paidPercent??i.paid_percent)||0,R=Rn({totalAmount:Fe,paidAmount:V,paidPercent:re,history:ze}),de=typeof i.paymentStatus=="string"?i.paymentStatus.toLowerCase():"",$e=Mn({manualStatus:de,paidAmount:R.paidAmount,paidPercent:R.paidPercent,totalAmount:Fe}),qe={paid:"Ù…Ø¯ÙÙˆØ¹",partial:"Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹",unpaid:"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"},Ae=c(`projects.paymentStatus.${$e}`,qe[$e]||$e),ke=Number(R.paidAmount||0),Pe=Number(R.paidPercent||0),x=Math.max(0,Number((Fe-ke).toFixed(2))),se={projectSubtotal:_e(Ke,t),expensesTotal:_e(T,t),reservationsTotal:_e(Ke,t),discountAmount:_e(Ie,t),taxAmount:_e(xe,t),overallTotal:_e(Fe,t),paidAmount:_e(ke,t),remainingAmount:_e(x,t)},oe={status:$e,statusLabel:Ae,paidAmount:ke,paidPercent:Pe,remainingAmount:x,paidAmountDisplay:_e(ke,t),remainingAmountDisplay:_e(x,t),paidPercentDisplay:cr(Pe)},_=(i.description||"").trim();return{project:i,customer:u,clientInfo:{name:y,company:b||"â€”",phone:f,email:I},projectInfo:{title:D,code:w,typeLabel:U,startDisplay:Y,endDisplay:S,durationLabel:q,statusLabel:B},expenses:be,equipment:P,crew:me,equipmentItems:K,crewAssignments:F.flatMap(g=>La(g)),totals:{equipmentEstimate:W,expensesTotal:T,baseSubtotal:H,discountAmount:Ie,subtotalAfterDiscount:je,companyShareAmount:Oe,subtotal:Ke,applyTax:J,taxAmount:xe,totalWithTax:Fe},totalsDisplay:se,projectTotals:{combinedTaxAmount:xe,overallTotal:Fe,reservationsTotal:Ke,paidAmount:ke,paidPercent:Pe,remainingAmount:x,paymentStatus:$e},paymentSummary:oe,notes:_,currencyLabel:t,projectStatus:E,projectStatusLabel:B,projectDurationDays:C,projectDurationLabel:q,paymentHistory:ze}}function Cl({project:e,clientInfo:t={},projectInfo:n={},projectCrew:a=[],projectExpenses:s=[],projectEquipment:r=[],totalsDisplay:o={},projectTotals:i={},paymentSummary:l={},currencyLabel:d="SR",sections:u,fieldSelections:y={},quoteNumber:b,quoteDate:m,terms:f=mt,rootAttributes:v=""}){const I=xs(y),A=(x,se)=>$s(I,x,se),w=x=>u?.has?.(x),D=`<div class="quote-placeholder">${h(c("reservations.quote.placeholder.noFields","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."))}</div>`,U=(x,se)=>`<div class="info-plain__item">
      <span class="info-plain__label">${h(x)}</span>
      <span class="info-plain__separator">:</span>
      <span class="info-plain__value">${h(se)}</span>
    </div>`,Y=(x,se,{variant:oe="inline"}={})=>oe==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${h(x)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${h(se)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${h(x)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${h(se)}</span>
    </span>`,S=(x,se)=>`<div class="payment-row">
      <span class="payment-row__label">${h(x)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${h(se)}</span>
    </div>`,C=(x,se,oe)=>{const _=`${x}-title`,z=`${x}-content`;return`
      <div class="quote-section__head" data-drag-key="${h(_)}">
        ${se}
      </div>
      <div class="quote-section__body" data-drag-key="${h(z)}">
        ${oe}
      </div>
    `},q=[];A("customerInfo","customerName")&&q.push(U(c("projects.details.client","Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.name||"-")),A("customerInfo","customerCompany")&&q.push(U(c("projects.details.company","Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.company||"â€”")),A("customerInfo","customerPhone")&&q.push(U(c("projects.details.labels.clientPhone","Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"),t.phone||"-")),A("customerInfo","customerEmail")&&q.push(U(c("projects.details.labels.clientEmail","Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"),t.email||"-"));const E=Pn(p,"projectCustomer"),Q=w("customerInfo")?`<section class="quote-section quote-section--plain quote-section--customer">
        ${C("customer",`<h3 class="quote-section__title">${h(c("projects.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"))}</h3>`,q.length?`<div class="${E}">${q.join("")}</div>`:D)}
      </section>`:"",B=[];A("projectInfo","projectType")&&B.push(U(c("projects.details.type","Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.typeLabel||"-")),A("projectInfo","projectTitle")&&B.push(U(c("projects.details.projectTitle","Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.title||"-")),A("projectInfo","projectCode")&&B.push(U(c("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.code||"-")),A("projectInfo","projectStart")&&B.push(U(c("projects.details.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.startDisplay||"-")),A("projectInfo","projectEnd")&&B.push(U(c("projects.details.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.endDisplay||"-")),A("projectInfo","projectDuration")&&B.push(U(c("projects.details.duration","Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.durationLabel||"-")),A("projectInfo","projectStatus")&&B.push(U(c("projects.details.status","Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),n.statusLabel||"-"));const ne=Pn(p,"projectDetails"),F=w("projectInfo")?`<section class="quote-section quote-section--plain quote-section--project">
        ${C("project",`<h3 class="quote-section__title">${h(c("projects.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>`,B.length?`<div class="${ne}">${B.join("")}</div>`:D)}
      </section>`:"",W=Aa.filter(x=>A("projectCrew",x.id)),N=Array.isArray(p?.crewAssignments)?p.crewAssignments:[],T=x=>{const se=x&&x.positionId!=null?`id:${String(x.positionId)}`:(()=>{const z=(x?.positionLabel||x?.position_name||x?.position||"").trim().toLowerCase();return z?`label:${z}`:""})(),oe=Number.isFinite(Number(x?.positionClientPrice))?Number(x.positionClientPrice):0,_=oe>0?`|p:${oe.toFixed(2)}`:"";return`${se}${_}`};(()=>{const x=new Map;return N.forEach(se=>{const oe=T(se);oe&&x.set(oe,(x.get(oe)||0)+1)}),x})();const H=(()=>{const x=[];if(W.forEach(g=>{g.id==="position"?(x.push({...g,render:$=>{const O=typeof Ne=="function"?Ne():"ar";let ee=$?.positionLabelEn??$?.position_label_en??$?.position_name_en??$?.positionLabelAlt??$?.position_label_alt??$?.role;if(!ee&&O==="en")try{const he=typeof gn=="function"?gn():[];let ce=null;if($?.positionId!=null&&(ce=he.find(le=>String(le.id)===String($.positionId))||null),!ce){const le=$?.positionKey??$?.position_key??$?.positionName??$?.position_name??$?.position??"";if(le){const We=String(le).toLowerCase();ce=he.find(Ve=>String(Ve.name).toLowerCase()===We)||null}}ce&&(ee=ce.labelEn??ce.label_en??ce.name_en??ee)}catch{}const te=$?.positionLabel??$?.position_name??$?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return h(k(String(O==="en"&&ee?ee:te)))}}),A("projectCrew","quantity")&&x.push({id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:$=>h(k(String(Math.max(1,Number($?.__count||1)))))})):g.id==="price"?x.push({...g,render:$=>{const O=Number.isFinite(Number($?.positionClientPrice))?Number($.positionClientPrice):0,ee=Math.max(1,Number($?.__count||1)),te=Math.max(1,Number(p?.rentalDays||1)),he=ct(O)*ee*te;return h(`${Le(he)} ${c("reservations.create.summary.currency","SR")}`)}}):g.id==="unitPrice"?x.push({...g,render:$=>{const O=Number.isFinite(Number($?.positionClientPrice))?Number($.positionClientPrice):0,ee=ct(O);return h(`${Le(ee)} ${c("reservations.create.summary.currency","SR")}`)}}):x.push(g)}),A("projectCrew","days")){const g=Math.max(1,Number(p?.rentalDays||1)),$=x.findIndex(ee=>ee.id==="price"),O=Math.max(0,$);x.splice(O,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(k(String(g)))})}const se=new Map(x.map(g=>[g.id,g])),oe=new Set,_=[],z=g=>{const $=se.get(g);$&&!oe.has(g)&&(_.push($),oe.add(g))};return z("rowNumber"),z("position"),z("unitPrice"),z("quantity"),z("days"),z("price"),x.forEach(g=>{oe.has(g.id)||(_.push(g),oe.add(g.id))}),_})(),K=(()=>{const x=new Map;return N.forEach(se=>{const oe=T(se);if(!oe)return;const _=x.get(oe);_?_.__count+=1:x.set(oe,{...se,__count:1})}),Array.from(x.values())})(),M=(()=>{try{const x=Math.max(1,Number(p?.rentalDays||1)),se=(K||[]).reduce((oe,_)=>{const z=Number.isFinite(Number(_?.positionClientPrice))?Number(_.positionClientPrice):0,g=Math.max(1,Number(_?.__count||1)),$=ct(z);return oe+$*g*x},0);return Le(se)}catch{return"0.00"}})(),P=w("projectCrew")?H.length?`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.crew","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${H.map(x=>`<th>${h(x.labelKey?c(x.labelKey,x.fallback):x.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${K.length?K.map((x,se)=>`<tr>${H.map(oe=>`<td><div class="quote-cell">${oe.render(x,se)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(H.length,1)}" class="empty">${h(c("projects.details.crew.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù‚Ù… ÙÙ†ÙŠ Ù…Ø±ØªØ¨Ø·."))}</td></tr>`}
              </tbody>
            </table>
            ${A("projectCrew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${M} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.crew","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            ${D}
          </section>`:"",G=[];A("financialSummary","discountAmount")&&G.push(Y(c("reservations.details.labels.discount","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…"),o.discountAmount||_e(0,d)));const ie=c("projects.details.summary.preTaxTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©");A("financialSummary","reservationsTotal")&&G.push(Y(ie,o.reservationsTotal||_e(0,d))),A("financialSummary","taxAmount")&&G.push(Y(c("projects.details.summary.combinedTax","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),o.taxAmount||_e(0,d)));const Z=[];A("financialSummary","overallTotal")&&Z.push(Y(c("projects.details.summary.overallTotal","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"),o.overallTotal||_e(0,d),{variant:"final"}));const me=w("financialSummary")?!G.length&&!Z.length?`<section class="quote-section quote-section--financial">${D}</section>`:`<section class="quote-section quote-section--financial">
          ${C("projectFinancial",`<h3>${h(c("projects.quote.sections.financial","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</h3>`,`<div class="totals-block">
              ${G.length?`<div class="totals-inline">${G.join("")}</div>`:""}
              ${Z.length?`<div class="totals-final">${Z.join("")}</div>`:""}
            </div>`)}
        </section>`:"",be=Xr.filter(x=>A("projectExpenses",x.id)),J=(()=>{const x=[...be];return x.forEach(se=>{se.id==="amount"&&(se.render=oe=>{const _=oe?.salePrice??oe?.sale_price,z=_??oe?.amount,g=Number(z),$=ct(Number.isFinite(g)?g:0);return h(_e($,d))})}),x})(),ge=(()=>{try{const x=s.reduce((se,oe)=>{const _=oe?.salePrice??oe?.sale_price,z=_??oe?.amount,g=Number(z),$=ct(Number.isFinite(g)?g:0);return se+$},0);return Le(x)}catch{return Le(0)}})(),pe=w("projectExpenses")?J.length?`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.expenses","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${J.map(x=>`<th>${h(x.labelKey?c(x.labelKey,x.fallback):x.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${s.length?s.map((x,se)=>`<tr>${J.map(oe=>`<td><div class="quote-cell">${oe.render(x,se)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(J.length,1)}" class="empty">${h(c("projects.details.expenses.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©."))}</td></tr>`}
              </tbody>
            </table>
            ${A("projectExpenses","expensesSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("projects.details.expensesTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${ge} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.expenses","Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©"))}</h3>
            ${D}
          </section>`:"",Ie=Ia.filter(x=>A("projectEquipment",x.id)),je=(()=>{let x=[];if(Ie.forEach(z=>{z.id==="price"?x.push({...z,render:g=>{const $=Number.isFinite(Number(g?.unitPriceValue))?Number(g.unitPriceValue):0,O=Number.isFinite(Number(g?.qty))?Math.max(1,Number(g.qty)):1,ee=Math.max(1,Number(p?.rentalDays||1)),ae=ct($)*O*ee;return h(`${Le(ae)} ${c("reservations.create.summary.currency","SR")}`)}}):z.id==="unitPrice"?x.push({...z,render:g=>{const $=Number.isFinite(Number(g?.unitPriceValue))?Number(g.unitPriceValue):0,O=ct($);return h(`${Le(O)} ${c("reservations.create.summary.currency","SR")}`)}}):x.push(z)}),A("projectEquipment","days")){const z=Math.max(1,Number(p?.rentalDays||1)),g=x.findIndex(O=>O.id==="price"),$=Math.max(0,g);x.splice($,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(k(String(z)))})}const se=new Map(x.map(z=>[z.id,z])),oe=x.filter(z=>!["unitPrice","quantity","days","price"].includes(z.id)),_=["unitPrice","quantity","days","price"].map(z=>se.get(z)).filter(Boolean);return x=[...oe,..._],x})(),Be=Array.isArray(p?.equipmentItems)?p.equipmentItems:[],De=(()=>{try{const x=Math.max(1,Number(p?.rentalDays||1)),se=(Be||[]).reduce((oe,_)=>{const z=Number.isFinite(Number(_?.unitPriceValue))?Number(_.unitPriceValue):0,g=Number.isFinite(Number(_?.qty))?Math.max(1,Number(_.qty)):1,$=ct(z);return oe+$*g*x},0);return Le(se)}catch{return"0.00"}})(),Ce=w("projectEquipment")?je.length?`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${je.map(x=>`<th>${h(x.labelKey?c(x.labelKey,x.fallback):x.fallback)}</th>`).join("")}</tr>
              </thead>
              <tbody>${Be.length?Be.map((x,se)=>`<tr>${je.map(oe=>`<td><div class="quote-cell">${oe.render(x,se)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(je.length,1)}" class="empty">${h(c("projects.details.equipment.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."))}</td></tr>`}
              </tbody>
            </table>
            ${A("projectEquipment","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.equipmentTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${De} ${d}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("projects.quote.sections.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            ${D}
          </section>`:"",Oe=(e?.description||"").trim()||"",Ke=w("projectNotes")?`<section class="quote-section">
        <h3>${h(c("projects.quote.sections.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>
        <div class="quote-notes">${h(Oe||c("projects.fallback.noDescription","Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹."))}</div>
      </section>`:"",xe=[];A("payment","beneficiary")&&xe.push(S(c("reservations.quote.labels.beneficiary","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"),Ye.beneficiaryName)),A("payment","bank")&&xe.push(S(c("reservations.quote.labels.bank","Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"),Ye.bankName)),A("payment","account")&&xe.push(S(c("reservations.quote.labels.account","Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"),k(Ye.accountNumber))),A("payment","iban")&&xe.push(S(c("reservations.quote.labels.iban","Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"),k(Ye.iban)));const Fe=`<section class="quote-section">
      <div class="payment-block">
        <h3>${h(c("reservations.quote.sections.payment","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹"))}</h3>
        <div class="payment-rows">${xe.length?xe.join(""):D}</div>
      </div>
      <p class="quote-approval-note">${h(Ye.approvalNote)}</p>
    </section>`,ze=Array.isArray(f)&&f.length?f:mt,V=`<footer class="quote-footer">
        <h4>${h(c("reservations.quote.labels.terms","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©"))}</h4>
        <ul>${ze.map(x=>`<li>${h(x)}</li>`).join("")}</ul>
      </footer>`,re=[],R=[];if(F&&R.push({key:"project",html:F}),Q&&R.push({key:"customer",html:Q}),R.length>1){const x=R.find(_=>_.key==="project"),se=R.find(_=>_.key==="customer"),oe=[];x?.html&&oe.push(x.html),se?.html&&oe.push(se.html),re.push(Re(`<div class="quote-section-row quote-section-row--primary">${oe.join("")}</div>`,{blockType:"group"}))}else R.length===1&&re.push(Re(R[0].html));const de=[];P&&de.push(Re(P,{blockType:"table",extraAttributes:'data-table-id="project-crew"'})),pe&&de.push(Re(pe,{blockType:"table",extraAttributes:'data-table-id="project-expenses"'})),Ce&&de.push(Re(Ce,{blockType:"table",extraAttributes:'data-table-id="project-equipment"'}));const $e=[];me&&$e.push(Re(me,{blockType:"summary"})),Ke&&$e.push(Re(Ke));let qe=[];qe=[...w("payment")?[Re(Fe,{blockType:"payment"})]:[],Re(V,{blockType:"footer"})];const Ae=[...pa(re,"projects.quote.placeholder.primary"),...de,...pa($e,"projects.quote.placeholder.summary"),...qe],ke=typeof Ne=="function"?Ne():"ar",Pe=`
    <header class="quote-header" data-quote-header-template>
      <div class="quote-header__logo">
        <img class="quote-logo" src="${h(Ye.logoUrl)}" alt="${h(Ye.companyName)}" crossorigin="anonymous"/>
      </div>
      <div class="quote-header__title">
        <h1>${h(c("projects.quote.title","Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h1>
        <p class="quote-company-name">${h(c("quote.companyName",Ye.companyName))}</p>
        <p class="quote-company-cr">${h(c("reservations.quote.labels.cr","Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"))}: ${h(Ye.commercialRegistry)}</p>
        <p class="quote-company-license">${h(c("reservations.quote.labels.mediaLicense","ØªØ±Ø®ÙŠØµ Ø¥Ø¹Ù„Ø§Ù…ÙŠ"))}: 159460</p>
      </div>
      <div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${h(c("projects.details.labels.code","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</span>
          <strong>${h(b)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${h(c("projects.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${h(m)}</strong>
        </div>
      </div>
    </header>
  `.trim();return`
    <div id="quotation-pdf-root" dir="rtl" data-lang="${h(ke)}"${v}>
      <style>${so}${ao}</style>
      <div class="quote-document" data-quote-document>
        <div class="quote-preview-pages" data-quote-pages></div>
        <div class="quote-content-source" data-quote-source>
          ${Pe}
          ${Ae.join("")}
        </div>
      </div>
    </div>
  `}function Co(e={}){const t={context:e?.context||xt(),blockOffsets:e?.blockOffsets||p?.blockOffsets||null,infoAlignments:e?.infoAlignments||p?.infoAlignments||null},n=xc(t),a=zt;zt=t;try{if(e?.context==="project")return Cl({...e,rootAttributes:n});const{reservation:s,customer:r,project:o,crewAssignments:i,totals:l,totalsDisplay:d,rentalDays:u,currencyLabel:y,sections:b,fieldSelections:m={},quoteNumber:f,quoteDate:v,terms:I=mt}=e,A=k(String(s?.reservationId??s?.id??"")),w=typeof Ne=="function"?Ne():"ar",D=s.start?k(Pt(s.start)):"-",U=s.end?k(Pt(s.end)):"-",Y=r?.customerName||r?.full_name||r?.name||"-",S=r?.phone||"-",C=r?.email||"-",q=r?.company||r?.company_name||"-",E=k(S),Q=o?.title||o?.name||c("reservations.details.project.none","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),B=o?.code||o?.projectCode||"",ne=k(String(u)),F=s?.notes||"",W=Array.isArray(I)&&I.length?I:mt,N=xs(m),T=(L,ye)=>$s(N,L,ye),H=L=>b?.has?.(L),K=`<div class="quote-placeholder">${h(c("reservations.quote.placeholder.noFields","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."))}</div>`,M=(L,ye)=>{const ve=w==="en"?": ":" / ";return`<div class="info-plain__item">${h(L)}<span class="info-plain__slash">${ve}</span><strong class="info-plain__value">${h(ye)}</strong></div>`},P=(L,ye,{variant:ve="inline"}={})=>ve==="final"?`<div class="totals-item totals-item--final">
        <span class="totals-item__label">${h(L)}</span>
        <span class="totals-item__slash">/</span>
        <span class="totals-item__value">${h(ye)}</span>
      </div>`:`<span class="totals-inline__item">
      <span class="totals-inline__label">${h(L)}</span>
      <span class="totals-inline__slash">/</span>
      <span class="totals-inline__value">${h(ye)}</span>
    </span>`,G=(L,ye)=>`<div class="payment-row">
      <span class="payment-row__label">${h(L)}</span>
      <span class="payment-row__slash">/</span>
      <span class="payment-row__value">${h(ye)}</span>
    </div>`,ie=(L,ye,ve)=>{const Ee=`${L}-title`,Ue=`${L}-content`;return`
      <div class="quote-section__head" data-drag-key="${h(Ee)}">
        ${ye}
      </div>
      <div class="quote-section__body" data-drag-key="${h(Ue)}">
        ${ve}
      </div>
    `},Z=[];T("customerInfo","customerName")&&Z.push(M(c("reservations.details.labels.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„"),Y)),T("customerInfo","customerCompany")&&Z.push(M(c("reservations.details.labels.company","Ø§Ù„Ø´Ø±ÙƒØ©"),q)),T("customerInfo","customerPhone")&&Z.push(M(c("reservations.details.labels.phone","Ø§Ù„Ù‡Ø§ØªÙ"),E)),T("customerInfo","customerEmail")&&Z.push(M(c("reservations.details.labels.email","Ø§Ù„Ø¨Ø±ÙŠØ¯"),C));const me=Pn(p,"customer"),be=H("customerInfo")&&Z.length?`<section class="quote-section quote-section--plain quote-section--customer">
            ${ie("customer",`<h3 class="quote-section__title">${h(c("reservations.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„"))}</h3>`,`<div class="${me}">${Z.join("")}</div>`)}
          </section>`:"",J=[];T("reservationInfo","reservationId")&&J.push(M(c("reservations.details.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"),A||"-")),T("reservationInfo","reservationStart")&&J.push(M(c("reservations.details.labels.start","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),D)),T("reservationInfo","reservationEnd")&&J.push(M(c("reservations.details.labels.end","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),U)),T("reservationInfo","reservationDuration")&&J.push(M(c("reservations.details.labels.duration","Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…"),ne));const ge=Pn(p,"reservation"),pe=H("reservationInfo")&&J.length?`<section class="quote-section quote-section--plain quote-section--reservation">
            ${ie("reservation",`<h3 class="quote-section__title">${h(c("reservations.quote.sections.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"))}</h3>`,`<div class="${ge}">${J.join("")}</div>`)}
          </section>`:"",Ie=[];T("projectInfo","projectTitle")&&Ie.push(M(c("reservations.details.labels.project","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),Q)),T("projectInfo","projectCode")&&Ie.push(M(c("reservations.details.labels.code","Ø§Ù„Ø±Ù…Ø²"),B||"-"));const je=Pn(p,"project"),Be=H("projectInfo")&&Ie.length?`<section class="quote-section quote-section--plain quote-section--project">
            ${ie("project",`<h3 class="quote-section__title">${h(c("reservations.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"))}</h3>`,`<div class="${je}">${Ie.join("")}</div>`)}
          </section>`:"",De=[];T("financialSummary","discountAmount")&&De.push(P(c("reservations.details.labels.discount","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…"),`${d.discountAmount} ${y}`)),T("financialSummary","subtotalBeforeTax")&&De.push(P(c("reservations.details.labels.subtotalBeforeTax","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),`${d.taxableAmount} ${y}`)),T("financialSummary","taxAmount")&&De.push(P(c("reservations.details.labels.tax","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"),`${d.taxAmount} ${y}`));const Ce=T("financialSummary","finalTotal"),Oe=[];Ce&&Oe.push(P(c("reservations.details.labels.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),`${d.finalTotal} ${y}`,{variant:"final"}));const Ke=Oe.length?`<div class="totals-final">${Oe.join("")}</div>`:"",xe=H("financialSummary")?!De.length&&!Ce?`<section class="quote-section quote-section--financial">${K}</section>`:`<section class="quote-section quote-section--financial">
          ${ie("financial",`<h3 class="quote-section__title">${h(c("reservations.details.labels.summary","Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ"))}</h3>`,`<div class="totals-block">
              ${De.length?`<div class="totals-inline">${De.join("")}</div>`:""}
              ${Ke}
            </div>`)}
        </section>`:"",{groups:Fe}=nn(s),ze=Fe.map(L=>{const ye=Number(L?.count??L?.quantity??1)||1,ve=Number(L?.unitPrice);let Ee=Number.isFinite(ve)?ve:0;if(!Ee||Ee<=0){const Me=Number(L?.totalPrice);Number.isFinite(Me)&&ye>0&&(Ee=Number((Me/ye).toFixed(2)))}Number.isFinite(Ee)||(Ee=0);const Ue=L?.type==="package"||Array.isArray(L?.items)&&L.items.some(Me=>Me?.type==="package"),st=Array.isArray(L?.barcodes)&&L.barcodes.length?L.barcodes[0]:Array.isArray(L?.items)&&L.items.length?L.items[0]?.barcode:null;let ue=L?.packageDisplayCode??L?.package_code??L?.code??L?.packageCode??(Array.isArray(L?.items)&&L.items.length?L.items[0]?.package_code??L.items[0]?.code??L.items[0]?.packageCode:null);const fe=Me=>{const Qe=(Me==null?"":String(Me)).trim();return!!(!Qe||/^pkg-/i.test(Qe)||/^\d+$/.test(Qe)&&Qe.length<=4)};if(!ue||fe(ue)){const Me=L?.packageId??L?.package_id??(Array.isArray(L?.items)&&L.items.length?L.items[0]?.packageId??L.items[0]?.package_id:null);if(Me)try{const Qe=us(Me);Qe&&Qe.package_code&&(ue=Qe.package_code)}catch{}}if(!ue||fe(ue))try{const Me=un(L?.description||"");if(Me){const Qe=Rr();let Ft=Qe.find(Lt=>un(Lt?.name||Lt?.title||Lt?.label||"")===Me);Ft||(Ft=Qe.find(Lt=>{const cn=un(Lt?.name||Lt?.title||Lt?.label||"");return cn.includes(Me)||Me.includes(cn)})),Ft&&Ft.package_code&&(ue=Ft.package_code)}}catch{}const Ge=Ue?ue??st??"":L?.barcode??st??"",Ze=Ge!=null?String(Ge):"";let It=Number.isFinite(Number(L?.totalPrice))?Number(L.totalPrice):Number((Ee*ye).toFixed(2));return It=nt(It),{...L,isPackage:Ue,desc:L?.description,barcode:Ze,packageCodeResolved:ue||"",qty:ye,price:It,totalPrice:It,unitPriceValue:Ee}}),V=Ia.filter(L=>T("items",L.id)),re=(()=>{let L=[];V.forEach(ue=>{ue.id==="price"?L.push({...ue,render:fe=>{const Ge=Number.isFinite(Number(fe?.unitPriceValue))?Number(fe.unitPriceValue):0,Ze=Number.isFinite(Number(fe?.qty))?Math.max(1,Number(fe.qty)):1,It=Math.max(1,Number(p?.rentalDays||1)),Qe=ct(Ge)*Ze*It;return h(`${Le(Qe)} ${c("reservations.create.summary.currency","SR")}`)}}):ue.id==="unitPrice"?L.push({...ue,render:fe=>{const Ge=Number.isFinite(Number(fe?.unitPriceValue))?Number(fe.unitPriceValue):0,Ze=ct(Ge);return h(`${Le(Ze)} ${c("reservations.create.summary.currency","SR")}`)}}):L.push(ue)});const ye=Math.max(1,Number(p?.rentalDays||1));if(T("items","days")){const ue=L.findIndex(Ge=>Ge.id==="price"),fe=Math.max(0,ue);L.splice(fe,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(k(String(ye)))})}const ve=new Map(L.map(ue=>[ue.id,ue])),Ee=L.filter(ue=>!["unitPrice","quantity","days","price"].includes(ue.id)),Ue=["unitPrice","quantity"];ve.has("days")&&Ue.push("days"),Ue.push("price");const st=Ue.map(ue=>ve.get(ue)).filter(Boolean);return L=[...Ee,...st],L})(),R=re.length>0,de=R?re.map(L=>`<th>${h(L.labelKey?c(L.labelKey,L.fallback):L.fallback)}</th>`).join(""):"",qe=ze.length>0?ze.map((L,ye)=>`<tr>${re.map(ve=>`<td><div class="quote-cell">${ve.render(L,ye)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(re.length,1)}" class="empty">${h(c("reservations.details.noItems","ðŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø­Ø§Ù„ÙŠØ§Ù‹."))}</td></tr>`,Ae=(()=>{try{const L=Math.max(1,Number(p?.rentalDays||1)),ye=ze.reduce((ve,Ee)=>{const Ue=Number.isFinite(Number(Ee?.unitPriceValue))?Number(Ee.unitPriceValue):0,st=Number.isFinite(Number(Ee?.qty))?Math.max(1,Number(Ee.qty)):1,ue=ct(Ue);return ve+ue*st*L},0);return Le(ye)}catch{return Le(0)}})(),ke=H("items")?R?`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.items.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${de}</tr>
              </thead>
              <tbody>${qe}</tbody>
            </table>
            ${T("items","equipmentSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.equipmentTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${Ae} ${y}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.items.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"))}</h3>
            ${K}
          </section>`:"",Pe=Aa.filter(L=>T("crew",L.id)),x=!0,se=Pe.length>0,oe=Array.isArray(i)?i:[],_=L=>{const ye=L&&L.positionId!=null?`id:${String(L.positionId)}`:(()=>{const Ue=(L?.positionLabel||L?.position_name||L?.position||"").trim().toLowerCase();return Ue?`label:${Ue}`:""})(),ve=Number.isFinite(Number(L?.positionClientPrice))?Number(L.positionClientPrice):0,Ee=ve>0?`|p:${ve.toFixed(2)}`:"";return`${ye}${Ee}`},z=(()=>{const L=new Map;return oe.forEach(ye=>{const ve=_(ye);ve&&L.set(ve,(L.get(ve)||0)+1)}),L})(),g=(()=>{let L=[],ye=null;if(Pe.forEach(ue=>{ue.id==="position"?(L.push({...ue,render:fe=>{const Ge=typeof Ne=="function"?Ne():"ar";let Ze=fe?.positionLabelEn??fe?.position_label_en??fe?.position_name_en??fe?.positionLabelAlt??fe?.position_label_alt??fe?.role;if(!Ze&&Ge==="en")try{const cn=typeof gn=="function"?gn():[];let Qt=null;if(fe?.positionId!=null&&(Qt=cn.find(Qn=>String(Qn.id)===String(fe.positionId))||null),!Qt){const Qn=fe?.positionKey??fe?.position_key??fe?.positionName??fe?.position_name??fe?.position??"";if(Qn){const Ei=String(Qn).toLowerCase();Qt=cn.find(qi=>String(qi.name).toLowerCase()===Ei)||null}}Qt&&(Ze=Qt.labelEn??Qt.label_en??Qt.name_en??Ze)}catch{}const It=fe?.positionLabel??fe?.position_name??fe?.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),Me=Ge==="en"&&Ze?Ze:It;if(x)return h(k(String(Me)));const Qe=_(fe),Ft=Qe&&z.get(Qe)||0,Lt=Ft>1?` Ã— ${k(String(Ft))}`:"";return h(k(String(Me))+Lt)}}),T("crew","quantity")&&(ye={id:"quantity",labelKey:"reservations.details.table.headers.quantity",fallback:"Ø§Ù„ÙƒÙ…ÙŠØ©",render:fe=>{const Ge=Number(fe?.__count||1);return h(k(String(Math.max(1,Ge))))}})):ue.id==="price"?x&&L.push({...ue,render:fe=>{const Ge=Number.isFinite(Number(fe?.positionClientPrice))?Number(fe.positionClientPrice):0,Ze=Math.max(1,Number(fe?.__count||1)),It=Math.max(1,Number(p?.rentalDays||1)),Qe=ct(Ge)*Ze*It;return h(`${Le(Qe)} ${c("reservations.create.summary.currency","SR")}`)}}):ue.id==="unitPrice"?L.push({...ue,render:fe=>{const Ge=Number.isFinite(Number(fe?.positionClientPrice))?Number(fe.positionClientPrice):0,Ze=ct(Ge);return h(`${Le(Ze)} ${c("reservations.create.summary.currency","SR")}`)}}):L.push(ue)}),ye&&L.push(ye),T("crew","days")){const ue=Math.max(1,Number(p?.rentalDays||1)),fe=L.findIndex(Ze=>Ze.id==="price"),Ge=Math.max(0,fe);L.splice(Ge,0,{id:"days",labelKey:"reservations.details.table.headers.days",fallback:"Ø§Ù„Ø£ÙŠØ§Ù…",render:()=>h(k(String(ue)))})}const ve=new Map(L.map(ue=>[ue.id,ue])),Ee=new Set,Ue=[],st=ue=>{const fe=ve.get(ue);fe&&!Ee.has(ue)&&(Ue.push(fe),Ee.add(ue))};return st("rowNumber"),st("position"),st("unitPrice"),st("quantity"),st("days"),st("price"),L.forEach(ue=>{Ee.has(ue.id)||(Ue.push(ue),Ee.add(ue.id))}),L=Ue,L})(),$=se?g.map(L=>`<th>${h(L.labelKey?c(L.labelKey,L.fallback):L.fallback)}</th>`).join(""):"",O=x?(()=>{const L=new Map;return oe.forEach(ye=>{const ve=_(ye);if(!ve)return;const Ee=L.get(ve);Ee?Ee.__count+=1:L.set(ve,{...ye,__count:1})}),Array.from(L.values())})():oe,ee=O.length?O.map((L,ye)=>`<tr>${g.map(ve=>`<td><div class="quote-cell">${ve.render(L,ye)}</div></td>`).join("")}</tr>`).join(""):`<tr><td colspan="${Math.max(g.length,1)}" class="empty">${h(c("reservations.details.noCrew","ðŸ˜Ž Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²."))}</td></tr>`,te=(()=>{try{const L=Math.max(1,Number(p?.rentalDays||1)),ye=O.reduce((ve,Ee)=>{const Ue=Number.isFinite(Number(Ee?.positionClientPrice))?Number(Ee.positionClientPrice):0,st=Math.max(1,Number(Ee?.__count||1)),ue=ct(Ue);return ve+ue*st*L},0);return Le(ye)}catch{return Le(0)}})(),ae=H("crew")?se?`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.technicians.title","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            <table class="quote-table">
              <thead>
                <tr>${$}</tr>
              </thead>
              <tbody>${ee}</tbody>
            </table>
            ${T("crew","crewSubtotal")?`
              <div class="quote-table-subtotal">
                <span class="quote-table-subtotal__pill">
                  <span class="quote-table-subtotal__label">${h(c("reservations.details.labels.crewTotal","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚"))}</span>
                  <span class="quote-table-subtotal__value">${h(`${te} ${y}`)}</span>
                </span>
              </div>
            `:""}
          </section>`:`<section class="quote-section quote-section--table">
            <h3>${h(c("reservations.details.technicians.title","Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„"))}</h3>
            ${K}
          </section>`:"",he=H("notes")?`<section class="quote-section">
        <h3>${h(c("reservations.details.labels.notes","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¬Ø²"))}</h3>
        <div class="quote-notes">${h(F||c("reservations.quote.emptyNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©."))}</div>
      </section>`:"",ce=[];T("payment","beneficiary")&&ce.push(G(c("reservations.quote.labels.beneficiary","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"),Ye.beneficiaryName)),T("payment","bank")&&ce.push(G(c("reservations.quote.labels.bank","Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ"),Ye.bankName)),T("payment","account")&&ce.push(G(c("reservations.quote.labels.account","Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"),k(Ye.accountNumber))),T("payment","iban")&&ce.push(G(c("reservations.quote.labels.iban","Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†"),k(Ye.iban)));const le=`<section class="quote-section">
      <div class="payment-block">
        <h3>${h(c("reservations.quote.sections.payment","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹"))}</h3>
        <div class="payment-rows">${ce.length?ce.join(""):K}</div>
      </div>
      <p class="quote-approval-note">${h(Ye.approvalNote)}</p>
    </section>`,We=`<footer class="quote-footer">
        <h4>${h(c("reservations.quote.labels.terms","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©"))}</h4>
        <ul>${W.map(L=>`<li>${h(L)}</li>`).join("")}</ul>
      </footer>`,Ve=[];if(be&&pe){const ye=(typeof Ne=="function"?Ne():"ar")==="en"?`${pe}${be}`:`${be}${pe}`;Ve.push(Re(`<div class="quote-section-row">${ye}</div>`,{blockType:"group"}))}else pe&&Ve.push(Re(pe)),be&&Ve.push(Re(be));if(Be)try{const L=typeof Ne=="function"?Ne():"ar",ye='<section class="quote-section quote-section--empty"></section>',ve=L==="en"?`<div class="quote-section-row">${ye}${Be}</div>`:`<div class="quote-section-row">${ye}${Be}</div>`;Ve.push(Re(ve,{blockType:"group"}))}catch{Ve.push(Re(Be))}const yt=[];ke&&yt.push(Re(ke,{blockType:"table",extraAttributes:'data-table-id="items"'})),ae&&yt.push(Re(ae,{blockType:"table",extraAttributes:'data-table-id="crew"'}));const on=[];xe&&on.push(Re(xe,{blockType:"summary"})),he&&on.push(Re(he));let He=[];if((e?.context||"reservation")!=="reservationChecklist")He=[...H("payment")?[Re(le,{blockType:"payment"})]:[],Re(We,{blockType:"footer"})];else{const L=String(e?.checklistNotes||"").trim(),ye=String(e?.checklistNotesTitle||"").trim()||c("reservations.checklist.controls.notes.sectionTitleDefault","Ù…Ù„Ø§Ø­Ø¸Ø§Øª");if(L.length>0){const ve=`<section class="quote-section">
        <h3>${h(ye)}</h3>
        <div class="quote-notes">${h(L)}</div>
      </section>`;He=[Re(ve)]}}const it=[...e?.context==="reservationChecklist"?Ve:pa(Ve,"reservations.quote.placeholder.page1"),...yt,...e?.context==="reservationChecklist"?on:pa(on,"reservations.quote.placeholder.page2"),...He],bt=e?.context==="reservationChecklist",$t=e?.checklistType==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":e?.checklistType==="both"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",Gt=typeof Ne=="function"?Ne():"ar",vi=e?.checklistType==="crew"?"Crew List":e?.checklistType==="both"?"Equipment & Crew List":"Equipment List",Si=bt?Gt==="en"?vi:$t:c("reservations.quote.title","Ø¹Ø±Ø¶ Ø³Ø¹Ø±"),wi=bt?`<div class="quote-header__meta" ${Gt==="en"?'dir="ltr"':""}>
        <div class="quote-header__meta-item">
          <span>${h(c("reservations.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${h(v)}</strong>
        </div>
      </div>`:`<div class="quote-header__meta">
        <div class="quote-header__meta-item">
          <span>${h(c("reservations.details.labels.reservationId","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²","Reservation ID"))}</span>
          <strong>${h(f)}</strong>
        </div>
        <div class="quote-header__meta-item">
          <span>${h(c("reservations.quote.labels.date","Ø§Ù„ØªØ§Ø±ÙŠØ®"))}</span>
          <strong>${h(v)}</strong>
        </div>
      </div>`,ki=!bt||!e?.hideLogo,Ii=!bt||!e?.hideCompany,Ai=`
    <header class="quote-header" data-quote-header-template style="${Number.isFinite(Number(e?.headerOffset))?`margin-top:${Number(e.headerOffset)}px;`:""}">
      <div class="quote-header__logo">
        ${ki?`<img class="quote-logo" src="${h(Ye.logoUrl)}" alt="${h(Ye.companyName)}" crossorigin="anonymous"/>`:'<span class="quote-logo quote-logo--placeholder" aria-hidden="true"></span>'}
      </div>
      <div class="quote-header__title">
        <h1>${h(Si)}</h1>
        ${Ii?`
          <p class="quote-company-name">${h(c("quote.companyName",Ye.companyName))}</p>
          <p class="quote-company-cr">${h(c("reservations.quote.labels.cr","Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"))}: ${h(Ye.commercialRegistry)}</p>
          <p class="quote-company-license">${h(c("reservations.quote.labels.mediaLicense","ØªØ±Ø®ÙŠØµ Ø¥Ø¹Ù„Ø§Ù…ÙŠ"))}: 159460</p>
        `:""}
      </div>
      ${wi}
    </header>
  `.trim();return`
      <div id="quotation-pdf-root" dir="${h(bt&&Gt==="en"?"ltr":"rtl")}" data-lang="${h(Gt)}"${n}>
        <style>${so}${ao}</style>
        <div class="quote-document" data-quote-document>
          <div class="quote-preview-pages" data-quote-pages></div>
          <div class="quote-content-source" data-quote-source>
            ${Ai}
            ${it.join("")}
          </div>
        </div>
      </div>
    `}finally{zt=a}}async function Ds(){try{const e=Te();if((Array.isArray(e?.packages)?e.packages:[]).length>0)return;const n=await At("/packages/?all=1"),a=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];a.length&&(_i({packages:a}),document.dispatchEvent?.(new CustomEvent("packages:changed",{detail:{packages:a}})))}catch{}}function xl(e){return e?e.complete?e.naturalHeight===0?Promise.reject(new Error(`image failed to load: ${e.src||"unknown"}`)):Promise.resolve():new Promise((t,n)=>{const a=()=>{r(),t()},s=()=>{r(),n(new Error(`image failed to load: ${e.src||"unknown"}`))},r=()=>{e.removeEventListener("load",a),e.removeEventListener("error",s)};e.addEventListener("load",a,{once:!0}),e.addEventListener("error",s,{once:!0})}):Promise.resolve()}async function zn(e){if(!e)return;const t=e.ownerDocument||document,n=t.defaultView||window,a=Array.from(e.querySelectorAll?.("img")||[]),s=t.fonts?.ready?t.fonts.ready:Promise.resolve(),r=a.map(i=>xl(i)),o=[s,...r].map(i=>i.catch(l=>(Nt("asset load failed",l),Hc(),null)));await Promise.all(o),await new Promise(i=>n.requestAnimationFrame(()=>i()))}async function ma(e,{context:t="preview"}={}){if(!e)return;const n=t==="preview",a=e.ownerDocument||document;e.setAttribute("data-quote-render-context",t);const s=e.querySelector("[data-quote-pages]"),r=e.querySelector("[data-quote-source]"),o=r?.querySelector("[data-quote-header-template]");if(!s||!r||!o)return;s.style.display="block",s.style.margin="0",s.style.padding="0",s.style.gap="0px",s.style.rowGap="0px",s.style.columnGap="0px",s.style.alignItems="stretch",s.style.justifyContent="flex-start",await Io(r),await zn(r),s.innerHTML="";const i=Array.from(r.querySelectorAll(":scope > [data-quote-block]")),l=e.getAttribute(dn.context)||null,d=ar(e,dn.blockOffsets),u=ar(e,dn.infoAlignments),y=zt,b=l||d||u;b&&(zt={context:l||null,blockOffsets:d||null,infoAlignments:u||null});let m=null,f=null;const v=q=>{q.style.margin="0 auto",q.style.breakInside="avoid",q.style.pageBreakInside="avoid",q.style.pageBreakAfter="auto",q.style.breakAfter="auto"},I=()=>{const q=a.createElement("div"),E=s.childElementCount===0;if(q.className="quote-page",q.dataset.pageIndex=String(s.childElementCount),E){q.classList.add("quote-page--primary");const B=o.cloneNode(!0);B.removeAttribute("data-quote-header-template"),q.appendChild(B)}else q.classList.add("quote-page--continuation");const Q=a.createElement("main");Q.className="quote-body",q.appendChild(Q),s.appendChild(q),v(q),m=q,f=Q},A=()=>{(!m||!f||!f.isConnected)&&I()},w=()=>{if(!m||!f||f.childElementCount>0)return;const q=m;m=null,f=null,q.parentNode&&q.parentNode.removeChild(q)},D=()=>{m=null,f=null},U=()=>m?m.scrollHeight-m.clientHeight>lo:!1,Y=(q,{allowOverflow:E=!1}={})=>(A(),f.appendChild(q),U()&&!E?(f.removeChild(q),w(),!1):!0),S=q=>{const E=q.cloneNode(!0);E.removeAttribute?.("data-quote-block"),E.removeAttribute?.("data-block-type"),E.removeAttribute?.("data-table-id"),!Y(E)&&(D(),!Y(E)&&Y(E,{allowOverflow:!0}))},C=q=>{const E=q.querySelector("table");if(!E){S(q);return}const Q=q.querySelector("h3"),B=E.querySelector("thead"),ne=Array.from(E.querySelectorAll("tbody tr"));if(!ne.length){S(q);return}let F=null,W=0;const N=(H=!1)=>{const K=q.cloneNode(!1);K.removeAttribute("data-quote-block"),K.removeAttribute("data-block-type"),K.removeAttribute("data-table-id"),K.classList.add("quote-section--table-fragment"),H&&K.classList.add("quote-section--table-fragment--continued");const M=Q?Q.cloneNode(!0):null;M&&K.appendChild(M);const P=E.cloneNode(!1);P.classList.add("quote-table--fragment"),B&&P.appendChild(B.cloneNode(!0));const G=a.createElement("tbody");return P.appendChild(G),K.appendChild(P),{section:K,body:G}},T=(H=!1)=>F||(F=N(H),Y(F.section)||(D(),Y(F.section)||Y(F.section,{allowOverflow:!0})),F);ne.forEach(H=>{T(W>0);const K=H.cloneNode(!0);if(F.body.appendChild(K),U()&&(F.body.removeChild(K),F.body.childElementCount||(f.removeChild(F.section),F=null,w()),D(),F=null,T(W>0),F.body.appendChild(K),U())){F.section.classList.add("quote-section--table-fragment--overflow"),W+=1;return}W+=1}),F=null;try{const H=q.querySelector(":scope > .quote-table-subtotal");H&&S(H)}catch{}};try{if(!i.length)return;i.forEach(N=>{N.getAttribute("data-block-type")==="table"?C(N):S(N)});const q=Array.from(s.children),E=[];if(q.forEach((N,T)=>{const H=N.querySelector(".quote-body");if(T!==0&&(!H||H.childElementCount===0)){N.remove();return}E.push(N)}),!n){const N=a.defaultView||window,T=Math.min(3,Math.max(1,N.devicePixelRatio||1)),H=$a()?Math.min(2,T):T;E.forEach(K=>rl(K,{pixelRatio:H}))}E.forEach((N,T)=>{const H=T===0;N.style.pageBreakAfter="auto",N.style.breakAfter="auto",N.style.pageBreakBefore=H?"auto":"always",N.style.breakBefore=H?"auto":"page",n?N.style.boxShadow="":N.style.boxShadow="none"});const Q=E[E.length-1]||null;m=Q,f=Q?.querySelector(".quote-body")||null,await zn(s);const B=N=>N&&typeof N=="object"&&Object.keys(N).length>0,F=ks[xt(p||(l?{context:l}:null))]||{},W=B(d)?d:B(p?.blockOffsets)?p.blockOffsets:F;try{Lc(e,W)}catch{}}finally{b&&(zt=y)}n&&(s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="flex-start",s.style.rowGap="18px",s.style.columnGap="0px",s.style.gap="18px")}function xo(e=0){return e<=0?new Promise(t=>requestAnimationFrame(()=>t())):new Promise(t=>setTimeout(t,e))}function $o(e){return e?Array.from(e.querySelectorAll(".quote-page")).some(n=>n.scrollHeight-n.clientHeight>lo):!1}function Fs(e,t="#000000"){if(!e)return;e.querySelectorAll('[style*="color"], [class*="text"], h1, h2, h3, h4, h5, h6, p, span, th, td, li, strong, em, label, dt, dd, caption, div').forEach(a=>{a instanceof HTMLElement&&a.style.setProperty("color",t,"important")})}async function $l(e,{filename:t,safariWindowRef:n=null,mobileWindowRef:a=null}){if(!e)return;const s=Array.from(e.querySelectorAll(".quote-page"));if(!s.length)throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙØ­Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");const[r,o]=await Promise.all([il(),ol()]),i=e.ownerDocument||document,l=i?.defaultView?.getComputedStyle?.(e)?.direction,u=[e.getAttribute?.("dir"),e.style?.direction,l,i?.documentElement?.getAttribute?.("dir")].some(S=>typeof S=="string"&&S.toLowerCase().startsWith("rtl")),y=typeof window<"u"&&window.devicePixelRatio||1,b=Ns(),m=vo(),f=$a();let v;f?v=1.5:m?v=Math.min(1.7,Math.max(1.2,y*1.1)):b?v=Math.min(1.8,Math.max(1.25,y*1.2)):v=Math.min(2,Math.max(1.6,y*1.4));const I=f||m?.9:b?.92:.95,A=new r({unit:"mm",format:"a4",orientation:"portrait",compress:!0}),w={scale:v,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!u,removeContainer:!1,logging:!0};let D=0;const U=c("reservations.quote.errors.browserLimit","ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");try{for(let S=0;S<s.length;S+=1){const C=s[S];await Io(C),await zn(C);const q=C.ownerDocument||document,E=q.createElement("div");Object.assign(E.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const Q=C.cloneNode(!0);Q.style.width=`${xn}px`,Q.style.maxWidth=`${xn}px`,Q.style.minWidth=`${xn}px`,Q.style.height=`${$n}px`,Q.style.maxHeight=`${$n}px`,Q.style.minHeight=`${$n}px`,Q.style.position="relative",Q.style.background="#ffffff",Fs(Q);const B=q.createElement("div"),ne=Array.from(e?.attributes||[]),F=e?.id&&typeof e.id=="string"&&e.id.trim().length?e.id:"quotation-pdf-root";if(B.id=F,ne.forEach(pe=>{!pe?.name||pe.name==="id"||B.setAttribute(pe.name,pe.value)}),!B.hasAttribute("dir")){const pe=e?.getAttribute("dir")||q.documentElement?.getAttribute("dir")||"rtl";B.setAttribute("dir",pe)}const W=q.createElement("iframe");W.setAttribute("title","quote-pdf-capture"),Object.assign(W.style,{position:"absolute",width:`${xn}px`,height:`${$n}px`,border:"0",top:"0",left:"0",opacity:"0",pointerEvents:"none"}),E.appendChild(W),q.body.appendChild(E);const N=W.contentDocument||W.contentWindow?.document;N.open(),N.write("<!DOCTYPE html><html><head></head><body></body></html>"),N.close(),N.documentElement.setAttribute("dir",B.getAttribute("dir")||"rtl");const T=N.head,H=N.body;Array.from(e.children||[]).forEach(pe=>{pe&&pe.tagName==="STYLE"&&T.appendChild(pe.cloneNode(!0))});const K=N.createElement("div");K.className="quote-document",K.setAttribute("data-quote-document","");const M=N.createElement("div");M.className="quote-preview-pages",M.setAttribute("data-quote-pages",""),M.appendChild(Q),K.appendChild(M),B.appendChild(K),H.appendChild(B);let P;try{await zn(B);const pe=N.defaultView||W.contentWindow||window;hs(B,pe),bs(B,pe),gs(B),P=await o(B,{...w,scale:v,backgroundColor:"#ffffff",scrollX:0,scrollY:0})}catch(pe){throw Wa(pe,"pageCapture",{toastMessage:U}),pe}finally{E.parentNode?.removeChild(E)}if(!P)continue;const G=P.width||1,Z=(P.height||1)/G;let me=Va,be=me*Z,J=0;if(be>Yn){const pe=Yn/be;be=Yn,me=me*pe,J=Math.max(0,(Va-me)/2)}const ge=P.toDataURL("image/jpeg",I);D>0&&A.addPage(),A.addImage(ge,"JPEG",J,0,me,be,`page-${D+1}`,"FAST"),D+=1,await new Promise(pe=>window.requestAnimationFrame(pe))}}catch(S){throw Ya({safariWindowRef:n,mobileWindowRef:a}),S}if(D===0)throw Ya({safariWindowRef:n,mobileWindowRef:a}),new Error("PDF generation produced no pages.");if(m||f){const S=A.output("blob");if(f){const C=URL.createObjectURL(S);Tn();try{window.location.assign(C)}catch(q){Nt("mobile safari blob navigation failed",q)}finally{setTimeout(()=>URL.revokeObjectURL(C),6e4)}}else{const C=URL.createObjectURL(S),q=()=>m&&n&&!n.closed?n:a&&!a.closed?a:null,E=(B,ne)=>{if(Tn(),!B){window.location.assign(ne);return}try{B.location.replace(ne),B.focus?.()}catch(F){Nt("direct blob navigation failed",F);try{B.document.open(),B.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${h(c("reservations.quote.actions.export","ØªÙ†Ø²ÙŠÙ„ PDF"))}</title><style>html,body{margin:0;height:100%;background:#0f172a;color:#f8fafc;font-family:'Tajawal',sans-serif;} iframe{border:none;width:100%;height:100%;display:block;}</style></head><body><iframe src="${ne}" title="PDF preview"></iframe></body></html>`),B.document.close()}catch(W){Nt("iframe blob delivery failed",W),window.location.assign(ne)}}},Q=q();E(Q,C),setTimeout(()=>URL.revokeObjectURL(C),6e4)}}else{Tn();const S=A.output("bloburl"),C=document.createElement("a");C.href=S,C.download=t,C.rel="noopener",C.style.display="none",document.body.appendChild(C),C.click(),setTimeout(()=>{URL.revokeObjectURL(S),C.remove()},2e3)}}function Xe(){if(!p||!X)return;const{previewFrame:e}=X;if(!e)return;Po();const t=p.context||"reservation",n=t==="reservationChecklist"?yo():p.reservation,a=Co({context:t,reservation:n||p.reservation,customer:p.customer,project:p.project,crewAssignments:p.crewAssignments,totals:p.totals,totalsDisplay:p.totalsDisplay,rentalDays:p.rentalDays,currencyLabel:p.currencyLabel,sections:p.sections,fieldSelections:p.fields,quoteNumber:p.quoteNumber,quoteDate:p.quoteDateLabel,terms:p.terms,checklistType:p.checklistType,checklistNotes:p.checklistNotes,checklistNotesTitle:p.checklistNotesTitle,hideLogo:!!p.hideLogo,hideCompany:!!p.hideCompany,headerOffset:Number(p.headerOffset||0),projectCrew:p.projectCrew,projectExpenses:p.projectExpenses,projectEquipment:p.projectEquipment,projectInfo:p.projectInfo,clientInfo:p.clientInfo,paymentSummary:p.paymentSummary,projectTotals:p.projectTotals,blockOffsets:p.blockOffsets,infoAlignments:p.infoAlignments});Jt("render"),e.srcdoc=`<!DOCTYPE html>${a}`,e.addEventListener("load",async()=>{try{const s=e.contentDocument,r=s?.defaultView||window,o=s?.documentElement||s;o&&(gs(o),hs(o,r),bs(o,r));const i=s?.getElementById("quotation-pdf-root");try{i&&(await ma(i,{context:"preview"}),await xo(120),$o(i)&&await ma(i,{context:"preview"}),Fs(i))}catch(f){console.error("[reservations/pdf] failed to layout preview document",f)}const l=Array.from(s?.querySelectorAll?.(".quote-page")||[]);try{if(p?.context==="reservationChecklist"&&p?.hideCompany){const v=s.querySelector(".quote-header");if(v&&!v.dataset.dragReady){v.style.cursor="grab";let I=!1,A=0,w=Number(p.headerOffset||0);const D=S=>{I=!0,A=S.clientY||S.touches?.[0]?.clientY||0,w=Number(p.headerOffset||0),v.style.cursor="grabbing",s.addEventListener("mousemove",U),s.addEventListener("mouseup",Y,{once:!0}),s.addEventListener("touchmove",U,{passive:!1}),s.addEventListener("touchend",Y,{once:!0})},U=S=>{if(!I)return;const q=(S.clientY||S.touches?.[0]?.clientY||0)-A,E=Math.max(0,Math.min(240,w+q));v.style.marginTop=`${E}px`,p.headerOffset=E,S.preventDefault?.()},Y=()=>{I=!1,v.style.cursor="grab",s.removeEventListener("mousemove",U),s.removeEventListener("touchmove",U)};v.addEventListener("mousedown",D),v.addEventListener("touchstart",D,{passive:!0}),v.dataset.dragReady="true"}}}catch{}Rc(s),qs(s),Ca();const d=s?.querySelector(".quote-preview-pages"),u=xn;let y=18;if(d&&s?.defaultView){const f=s.defaultView.getComputedStyle(d),v=parseFloat(f.rowGap||f.gap||`${y}`);Number.isFinite(v)&&v>=0&&(y=v)}const b=$n,m=l.length?l.length*b+Math.max(0,(l.length-1)*y):b;if(e.dataset.baseWidth=String(u),e.dataset.baseHeight=String(m),e.style.width=`${u}px`,e.style.minWidth=`${u}px`,e.style.height=`${m}px`,e.style.minHeight=`${m}px`,X?.previewFrameWrapper&&!X?.userAdjustedZoom){const f=X.previewFrameWrapper.clientWidth-24;f>0&&f<u?qt=Math.max(f/u,.3):qt=1}Lo(qt)}finally{Tn()}},{once:!0})}function Ll(e){if(!p)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(t.checked?p.sections.add(n):p.sections.delete(n),Eo(p),Jn(),Xe())}function Nl(e){if(!p)return;const t=e.currentTarget,n=t?.dataset?.sectionId,a=t?.dataset?.fieldId;if(!n||!a)return;const s=p.context||"reservation",r=p.fields||(p.fields=Vn(s)),o=Kc(r,n);t.checked?o.add(a):o.delete(a),Eo(p),Xe()}function Pl(e){if(!p)return;const t=e.currentTarget,n=t?.dataset?.sectionId;n&&(Ls(p,n),p.sectionExpansions[n]=t.open)}function Jn(){if(!X?.toggles||!p)return;const{toggles:e}=X,t=p.fields||{},n=p.context||"reservation";Ls(p);const a=qa(n),s=Zr(n),r=a.map(({id:o,labelKey:i,fallback:l})=>{const d=c(i,l),u=p.sections.has(o),y=s[o]||[],b=Vc(p,o),m=y.length?`<div class="quote-toggle-sublist">
          ${y.map(f=>{const v=$s(t,o,f.id),I=u?"":"disabled",A=f.labelKey?c(f.labelKey,f.fallback):f.fallback;return`
              <label class="quote-toggle quote-toggle--field">
                <input type="checkbox" data-field-toggle data-section-id="${o}" data-field-id="${f.id}" ${v?"checked":""} ${I}>
                <span>${h(A)}</span>
              </label>
            `}).join("")}
        </div>`:"";return`
      <details class="quote-toggle-group" data-section-group data-section-id="${o}" ${b?"open":""}>
        <summary class="quote-toggle-summary">
          <label class="quote-toggle quote-toggle--section">
            <input type="checkbox" data-section-toggle data-section-id="${o}" ${u?"checked":""}>
            <span>${h(d)}</span>
          </label>
          ${y.length?'<span class="quote-toggle-caret" aria-hidden="true"></span>':""}
        </summary>
        ${m}
      </details>
    `}).join("");e.innerHTML=r,e.querySelectorAll("input[data-section-toggle]").forEach(o=>{o.addEventListener("change",Ll)}),e.querySelectorAll("input[data-field-toggle]").forEach(o=>{o.addEventListener("change",Nl)}),e.querySelectorAll("details[data-section-group]").forEach(o=>{o.addEventListener("toggle",Pl)})}function Tl(){if(X?.modal)return X;const e=document.createElement("div");e.id="reservationQuoteModal",e.className="modal fade quote-preview-modal",e.tabIndex=-1,e.setAttribute("aria-labelledby","reservationQuoteModalLabel"),e.setAttribute("aria-hidden","true"),e.style.display="none",e.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationQuoteModalLabel">${h(c("reservations.quote.previewTitle","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="quote-preview-layout">
            <aside class="quote-preview-sidebar">
              <h6>${h(c("reservations.quote.toggleHeading","Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØµØ¯ÙŠØ±Ù‡Ø§"))}</h6>
              <div class="quote-toggle-list" data-quote-toggles></div>
              <div class="quote-meta-info" data-quote-meta></div>
              <div class="quote-terms-editor" data-quote-terms-editor>
                <label class="quote-terms-editor__label" for="quote-terms-input">${h(c("reservations.quote.termsEditor.title","Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)"))}</label>
                <textarea id="quote-terms-input" class="quote-terms-editor__textarea" rows="6" data-quote-terms-input placeholder="${h(c("reservations.quote.termsEditor.placeholder","Ø§ÙƒØªØ¨ ÙƒÙ„ Ø´Ø±Ø· ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„"))}"></textarea>
                <button type="button" class="quote-terms-reset" data-quote-terms-reset>${h(c("reservations.quote.termsEditor.reset","Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"))}</button>
              </div>
            </aside>
            <section class="quote-preview-panel">
              <div class="quote-preview" data-quote-preview></div>
            </section>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">${h(c("reservations.quote.actions.close","Ø¥ØºÙ„Ø§Ù‚"))}</button>
          <button type="button" class="btn btn-primary" data-quote-download>
            ${h(c("reservations.quote.actions.export","ðŸ“„ ØªÙ†Ø²ÙŠÙ„ PDF"))}
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector("[data-quote-toggles]"),n=e.querySelector("[data-quote-preview]"),a=e.querySelector("[data-quote-meta]"),s=e.querySelector("[data-quote-terms-input]"),r=e.querySelector("[data-quote-terms-reset]"),o=e.querySelector("[data-quote-download]"),i=e.querySelector(".modal-header"),l=i?.querySelector(".btn-close"),d=Array.from(e.querySelectorAll('[data-bs-dismiss="modal"]')),u=document.createElement("div");u.className="quote-preview-header-actions",i&&i.insertBefore(u,l||null);const y=[],b=(K=null)=>{y.forEach(M=>{M!==K&&(M.menu.hidden=!0,M.toggle.setAttribute("aria-expanded","false"),M.wrapper.classList.remove("is-open"))})},m=(K,M,P)=>{y.push({wrapper:K,toggle:M,menu:P})},f=K=>{if(!y.length)return;const M=K.target;y.some(G=>G.wrapper.contains(M))||b()};document.addEventListener("click",f),document.addEventListener("keydown",K=>{K.key==="Escape"&&b()});const v=({label:K,icon:M,content:P})=>{const G=document.createElement("div");G.className="quote-controls-dropdown";const ie=document.createElement("button");ie.type="button",ie.className="quote-controls-dropdown__toggle",ie.setAttribute("aria-haspopup","true"),ie.setAttribute("aria-expanded","false"),ie.innerHTML=`
      ${M?`<span class="quote-controls-dropdown__icon" aria-hidden="true">${h(M)}</span>`:""}
      <span class="quote-controls-dropdown__label">${h(K)}</span>
      <span class="quote-controls-dropdown__caret" aria-hidden="true">â–¾</span>
    `;const Z=document.createElement("div");return Z.className="quote-controls-dropdown__menu",Z.hidden=!0,Z.appendChild(P),G.appendChild(ie),G.appendChild(Z),ie.addEventListener("click",me=>{me.stopPropagation();const be=G.classList.contains("is-open");b(),be||(G.classList.add("is-open"),Z.hidden=!1,ie.setAttribute("aria-expanded","true"))}),m(G,ie,Z),G},I=document.createElement("iframe");I.className="quote-preview-frame",I.setAttribute("title",c("reservations.quote.previewTitle","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø±Ø¶ Ø³Ø¹Ø±")),I.setAttribute("loading","lazy"),I.setAttribute("frameborder","0");const A=document.createElement("div");A.className="quote-preview-zoom-controls",A.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-zoom-out title="${h(c("reservations.quote.zoom.out","ØªØµØºÙŠØ±"))}">âˆ’</button>
    <span class="quote-preview-zoom-value" data-zoom-value>100%</span>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-in title="${h(c("reservations.quote.zoom.in","ØªÙƒØ¨ÙŠØ±"))}">+</button>
    <button type="button" class="quote-preview-zoom-btn" data-zoom-reset title="${h(c("reservations.quote.zoom.reset","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·"))}">1:1</button>
  `;const w=document.createElement("div");w.className="quote-preview-zoom-controls quote-preview-drag-controls",w.innerHTML=`
    <button type="button" class="quote-preview-zoom-btn" data-block-drag-toggle title="${h(c("reservations.quote.drag.enable","ÙˆØ¶Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª"))}" aria-label="${h(c("reservations.quote.drag.enable","ÙˆØ¶Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª"))}">
      <span aria-hidden="true">â†•ï¸</span>
    </button>
    <button type="button" class="quote-preview-zoom-btn" data-block-drag-save disabled title="${h(c("reservations.quote.drag.save","ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}" aria-label="${h(c("reservations.quote.drag.save","ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}">
      <span aria-hidden="true">ðŸ’¾</span>
    </button>
    <button type="button" class="quote-preview-zoom-btn" data-block-drag-reset title="${h(c("reservations.quote.drag.resetBtn","ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}" aria-label="${h(c("reservations.quote.drag.resetBtn","ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹"))}">
      <span aria-hidden="true">âŸ²</span>
    </button>
  `;const D=document.createElement("div");D.className="quote-preview-zoom-controls quote-preview-align-controls";const U=h(c("reservations.quote.align.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")),Y=h(c("reservations.quote.align.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²")),S=h(c("reservations.quote.align.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));D.innerHTML=`
    <select class="quote-preview-align-select" data-align-target>
      <option value="customer">${U}</option>
      <option value="reservation">${Y}</option>
      <option value="project">${S}</option>
    </select>
    <div class="quote-preview-align-buttons">
      <button type="button" class="quote-preview-zoom-btn" data-align-value="left" title="${h(c("reservations.quote.align.left","Ù…Ø­Ø§Ø°Ø§Ø© ÙŠØ³Ø§Ø±"))}">â¬…ï¸</button>
      <button type="button" class="quote-preview-zoom-btn" data-align-value="center" title="${h(c("reservations.quote.align.center","Ù…Ø­Ø§Ø°Ø§Ø© ÙˆØ³Ø·"))}">â†”ï¸</button>
      <button type="button" class="quote-preview-zoom-btn" data-align-value="right" title="${h(c("reservations.quote.align.right","Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†"))}">âž¡ï¸</button>
    </div>
    <button type="button" class="quote-preview-zoom-btn" data-layout-export title="${h(c("reservations.quote.align.export","Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"))}">ðŸ“‹</button>
  `;const C=document.createElement("div");C.className="quote-preview-frame-wrapper",C.appendChild(I),n.innerHTML="";const q=document.createElement("div");q.className="quote-preview-scroll",q.appendChild(C),n.appendChild(q);const E=document.createElement("div");E.className="quote-preview-status",E.setAttribute("role","status"),E.setAttribute("aria-live","polite"),E.hidden=!0,E.innerHTML=`
    <span class="quote-preview-spinner" data-quote-status-spinner aria-hidden="true"></span>
    <span data-quote-status-text>${h(no("render"))}</span>
    <button type="button" class="quote-preview-status-action" data-quote-status-action hidden></button>
  `,n.appendChild(E);const Q=c("reservations.quote.dropdown.drag","Ø§Ù„ØªØ­Ø±ÙŠÙƒ"),B=c("reservations.quote.dropdown.align","Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©"),ne=v({label:Q,icon:"ðŸŽšï¸",content:w}),F=v({label:B,icon:"ðŸ“",content:D});u.appendChild(A),u.appendChild(ne),u.appendChild(F),o?.addEventListener("click",async()=>{if(p){o.disabled=!0;try{await No()}finally{o.disabled=!1}}});const W=()=>{Ga()||Qa(e)};d.forEach(K=>{K?.addEventListener("click",W)}),l&&!d.includes(l)&&l.addEventListener("click",W),e.addEventListener("click",K=>{Ga()||K.target===e&&Qa(e)}),X={modal:e,toggles:t,preview:n,previewScroll:q,previewFrameWrapper:C,zoomControls:A,zoomValue:A.querySelector("[data-zoom-value]"),previewFrame:I,meta:a,downloadBtn:o,statusIndicator:E,statusText:E.querySelector("[data-quote-status-text]"),statusSpinner:E.querySelector("[data-quote-status-spinner]"),statusAction:E.querySelector("[data-quote-status-action]"),termsInput:s,termsReset:r,statusKind:null,userAdjustedZoom:!1,blockDragToggle:w.querySelector("[data-block-drag-toggle]"),blockDragSave:w.querySelector("[data-block-drag-save]"),blockDragReset:w.querySelector("[data-block-drag-reset]"),alignTarget:D.querySelector("[data-align-target]"),alignButtons:Array.from(D.querySelectorAll("[data-align-value]")),layoutExportBtn:D.querySelector("[data-layout-export]")};const N=A.querySelector("[data-zoom-out]"),T=A.querySelector("[data-zoom-in]"),H=A.querySelector("[data-zoom-reset]");return N?.addEventListener("click",()=>dr(-.1)),T?.addEventListener("click",()=>dr(.1)),H?.addEventListener("click",()=>fa(1,{markManual:!0})),X.blockDragToggle?.addEventListener("click",()=>Nc(!bn)),X.blockDragSave?.addEventListener("click",Pc),X.blockDragReset?.addEventListener("click",Tc),X.alignTarget?.addEventListener("change",()=>Ca()),(X.alignButtons||[]).forEach(K=>{K.addEventListener("click",()=>{const M=X.alignTarget?.value||"customer",P=K.dataset.alignValue||"right";Dc(M,P)})}),X.layoutExportBtn?.addEventListener("click",Fc),_a(),Po(),s&&s.addEventListener("input",jl),r&&r.addEventListener("click",Bl),fa(qt),X}function fa(e,{silent:t=!1,markManual:n=!1}={}){qt=Math.min(Math.max(e,.25),2.2),n&&X&&(X.userAdjustedZoom=!0),Lo(qt),!t&&X?.zoomValue&&(X.zoomValue.textContent=`${Math.round(qt*100)}%`)}function dr(e){fa(qt+e,{markManual:!0})}function Lo(e){if(!X?.previewFrame||!X.previewFrameWrapper)return;const t=X.previewFrame,n=X.previewFrameWrapper,a=Number(t.dataset.baseWidth)||794,s=Number(t.dataset.baseHeight)||t.contentDocument?.body?.scrollHeight||1123;t.style.transform=`scale(${e})`,t.style.transformOrigin="top center",Ns()?(n.style.width="100%",n.style.maxWidth="100%",n.style.minWidth="0"):(n.style.width=`${a}px`,n.style.maxWidth=`${a}px`,n.style.minWidth=`${a}px`),n.style.minHeight=`${s}px`,n.style.height=`${s}px`}function Xn(){if(!X?.meta||!p)return;const{meta:e}=X;(p.context||"reservation")==="reservationChecklist"?e.innerHTML=`
      <div class="quote-meta-card">
        <div><span>${h(c("reservations.quote.labels.dateGregorian","Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ"))}</span><strong>${h(p.quoteDateLabel)}</strong></div>
      </div>
    `:e.innerHTML=`
      <div class="quote-meta-card">
        <div><span>${h(c("reservations.quote.labels.number","Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø³Ø¹Ø±"))}</span><strong>${h(p.quoteNumber)}</strong></div>
        <div><span>${h(c("reservations.quote.labels.dateGregorian","Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ"))}</span><strong>${h(p.quoteDateLabel)}</strong></div>
      </div>
    `}function Rs(){if(!X?.termsInput)return;const e=(p?.terms&&p.terms.length?p.terms:mt).join(`
`);X.termsInput.value!==e&&(X.termsInput.value=e)}function jl(e){if(!p)return;const t=Ha(e?.target?.value??"");if(t.length){p.terms=t;const n=document.getElementById("reservation-terms");n&&(n.value=e.target.value);const a=document.getElementById("edit-res-terms");a&&(a.value=e.target.value)}else{p.terms=[...mt],Rs();const n=mt.join(`
`),a=document.getElementById("reservation-terms");a&&(a.value=n);const s=document.getElementById("edit-res-terms");s&&(s.value=n)}Xe()}function Bl(e){if(e?.preventDefault?.(),!p)return;p.terms=[...mt];const t=document.getElementById("reservation-terms");t&&(t.value=mt.join(`
`));const n=document.getElementById("edit-res-terms");n&&(n.value=mt.join(`
`)),Rs(),Xe()}async function No(){if(!p)return;Jt("export");const t=!Ns()&&vo(),n=$a(),a=null,s=!n&&t?window.open("","_blank"):null;(l=>{if(l)try{l.document.open(),l.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${h(c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF..."))}</title><style>body{font-family:'Tajawal',sans-serif;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#f8fafc;text-align:center;padding:24px;} .loader{width:42px;height:42px;border-radius:50%;border:4px solid rgba(248,250,252,0.35);border-top-color:#38bdf8;animation:spin 1s linear infinite;margin:0 auto 18px;}@keyframes spin{to{transform:rotate(360deg);}} h1{margin:0 0 6px;font-size:1.05rem;} p{margin:0;font-size:0.9rem;opacity:0.8;}</style></head><body><div><div class="loader" aria-hidden="true"></div><h1>${h(c("reservations.quote.status.exporting","Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF..."))}</h1><p>${h(c("reservations.quote.status.exportingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±..."))}</p></div></body></html>`),l.document.close()}catch(d){Nt("failed to prime download window",d)}})(s);let o=null;const i=c("reservations.quote.errors.browserLimit","ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");try{await cl(),Da("html2pdf ensured");const l=p.context||"reservation",d=l==="reservationChecklist"?yo():p.reservation,u=Co({context:l,reservation:d||p.reservation,customer:p.customer,project:p.project,crewAssignments:p.crewAssignments,totals:p.totals,totalsDisplay:p.totalsDisplay,rentalDays:p.rentalDays,currencyLabel:p.currencyLabel,sections:p.sections,fieldSelections:p.fields,quoteNumber:p.quoteNumber,quoteDate:p.quoteDateLabel,terms:p.terms,checklistType:p.checklistType,checklistNotes:p.checklistNotes,checklistNotesTitle:p.checklistNotesTitle,hideLogo:!!p.hideLogo,hideCompany:!!p.hideCompany,headerOffset:Number(p.headerOffset||0),projectCrew:p.projectCrew,projectExpenses:p.projectExpenses,projectEquipment:p.projectEquipment,projectInfo:p.projectInfo,clientInfo:p.clientInfo,paymentSummary:p.paymentSummary,projectTotals:p.projectTotals,blockOffsets:p.blockOffsets,infoAlignments:p.infoAlignments});o=document.createElement("div"),o.innerHTML=u,Object.assign(o.style,{position:"fixed",top:"0",left:"0",pointerEvents:"none",zIndex:"-1"}),document.body.appendChild(o),gs(o),hs(o),bs(o),Da("export container prepared");const y=o.firstElementChild;if(y){try{const m=typeof Ne=="function"?Ne():y.getAttribute("data-lang")||"ar",v=p?.context==="reservationChecklist"&&m==="en"?"ltr":"rtl";y.setAttribute("dir",v),y.style.direction=v,y.setAttribute("data-lang",m),y.style.textAlign=""}catch{}y.setAttribute("data-theme","light"),y.classList.remove("dark","dark-mode"),y.style.margin="0",y.style.padding="0",y.style.width="210mm",y.style.maxWidth="210mm",y.style.marginLeft="auto",y.style.marginRight="auto",y.scrollTop=0,y.scrollLeft=0;try{await ma(y,{context:"export"}),await xo(120),$o(y)&&await ma(y,{context:"export"}),await zn(y),Fs(y),Da("layout complete for export document")}catch(m){Wa(m,"layoutQuoteDocument",{suppressToast:!0})}}const b=l==="reservationChecklist"?(()=>{const m=p?.reservation?.reservationCode||p?.reservation?.reservationId||p?.reservation?.id||"res",f=p?.checklistType==="crew"?"crew":p?.checklistType==="both"?"equipment-crew":"equipment";return`checklist-${String(m)}-${f}.pdf`})():`quotation-${p.quoteNumber}.pdf`;await $l(y,{filename:b,safariWindowRef:s,mobileWindowRef:a})}catch(l){Ya({container:o,safariWindowRef:s,mobileWindowRef:a}),o=null,Wa(l,"exportQuoteAsPdf",{toastMessage:i})}finally{o&&o.parentNode&&o.parentNode.removeChild(o),Tn()}}function Ms(){const e=Tl();if(e?.modal){if(Nn=!1,qt=1,X&&(X.userAdjustedZoom=!1),fa(qt,{silent:!0}),p?.context==="reservationChecklist")try{const t=e.modal.querySelector("#reservationQuoteModalLabel"),n=e.modal.querySelector(".quote-preview-sidebar"),a=e.modal.querySelector("[data-quote-terms-editor]");a&&(a.style.display="none");let s=n.querySelector("[data-checklist-controls]");if(!s){s=document.createElement("div"),s.setAttribute("data-checklist-controls","");const r=h(c("reservations.checklist.controls.items","Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")),o=h(c("reservations.checklist.controls.crew","Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ")),i=h(c("reservations.checklist.controls.both","Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ")),l=h(c("reservations.checklist.controls.hideLogo","Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø¹Ø§Ø±")),d=h(c("reservations.checklist.controls.hideCompany","Ø¥Ø®ÙØ§Ø¡ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©")),u=h(c("reservations.checklist.controls.notes.title","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù„Ø³ØªØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)")),y=h(c("reservations.checklist.controls.notes.placeholder","Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø³ØªØ©")),b=typeof Ne=="function"?Ne():"ar",m=h(b==="en"?c("language.toggle.labelAr","ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"):c("language.toggle.labelEn","ðŸ‡¬ðŸ‡§ English")),f=h(c("reservations.checklist.controls.lessors.title","ðŸ¢ ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¤Ø¬Ø±")),v=h(c("reservations.checklist.controls.lessors.clear","Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø§Ù„Ù…Ø¤Ø¬Ø±ÙŠÙ†"));s.innerHTML=`
          <div class="quote-meta-card" style="margin-bottom:10px">
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:6px">
                <input type="radio" name="checklist-type" value="items" checked>
                <span data-i18n data-i18n-key="reservations.checklist.controls.items">${r}</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="radio" name="checklist-type" value="crew">
                <span data-i18n data-i18n-key="reservations.checklist.controls.crew">${o}</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="radio" name="checklist-type" value="both">
                <span data-i18n data-i18n-key="reservations.checklist.controls.both">${i}</span>
              </label>
            </div>
          </div>
          <div class="quote-meta-card" style="margin-bottom:10px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button type="button" class="btn btn-sm btn-light" data-checklist-lang>${m}</button>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" data-checklist-hide-logo>
                <span data-i18n data-i18n-key="reservations.checklist.controls.hideLogo">${l}</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" data-checklist-hide-company>
                <span data-i18n data-i18n-key="reservations.checklist.controls.hideCompany">${d}</span>
              </label>
            </div>
          </div>
          <div class="quote-terms-editor" data-checklist-notes>
            <label class="quote-terms-editor__label" for="checklist-notes-title-input" data-i18n data-i18n-key="reservations.checklist.controls.notes.titleLabel">${h(c("reservations.checklist.controls.notes.titleLabel","Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"))}</label>
            <input id="checklist-notes-title-input" class="quote-terms-editor__input" type="text" value="${h(c("reservations.checklist.controls.notes.sectionTitleDefault","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"))}" data-i18n-value-key="reservations.checklist.controls.notes.sectionTitleDefault">
            <label class="quote-terms-editor__label" for="checklist-notes-input" data-i18n data-i18n-key="reservations.checklist.controls.notes.title">${u}</label>
            <textarea id="checklist-notes-input" class="quote-terms-editor__textarea" rows="4" data-i18n-placeholder-key="reservations.checklist.controls.notes.placeholder" placeholder="${y}"></textarea>
          </div>
          <div class="quote-meta-card" data-checklist-lessors hidden>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;">
              <span data-i18n data-i18n-key="reservations.checklist.controls.lessors.title">${f}</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-lessor-clear>${v}</button>
            </div>
            <div data-lessor-options style="display:flex;flex-direction:column;gap:6px;"></div>
          </div>
        `,n.prepend(s),s.querySelectorAll('input[name="checklist-type"]').forEach(q=>{q.addEventListener("change",()=>{const E=s.querySelector('input[name="checklist-type"]:checked')?.value||"items";p.checklistType=E==="crew"||E==="both"?E:"items";const Q=new Set(["customerInfo","reservationInfo","projectInfo","notes"]);if(p.checklistType==="crew"?Q.add("crew"):p.checklistType==="both"?(Q.add("items"),Q.add("crew")):Q.add("items"),p.sections=Q,t){const B=Ne?.()||"ar",ne=p.checklistType==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":p.checklistType==="both"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",F=p.checklistType==="crew"?"Crew List":p.checklistType==="both"?"Equipment & Crew List":"Equipment List";t.textContent=B==="en"?F:ne}Jn(),Xn(),Xe()})});const A=s.querySelector("#checklist-notes-input"),w=s.querySelector("#checklist-notes-title-input"),D=()=>{try{const q=Ne?.()||"ar",E=q==="en"?"ltr":"rtl",Q=q==="en"?"left":"right";A&&(A.setAttribute("dir",E),A.style.textAlign=Q),w&&(w.setAttribute("dir",E),w.style.textAlign=Q)}catch{}};D();try{const q=()=>D();document.addEventListener("language:changed",q),s._onLangChanged=q}catch{}A.addEventListener("input",q=>{p.checklistNotes=String(q.target.value||""),Xe()}),w.addEventListener("input",q=>{p.checklistNotesTitle=String(q.target.value||""),Xe()});const U=s.querySelector("[data-checklist-lang]");if(U){const q=()=>{const E=Ne?.()||"ar";U.textContent=E==="ar"?"ðŸ‡¬ðŸ‡§ English":"ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"};q(),U.addEventListener("click",()=>{const Q=(Ne?.()||"ar")==="ar"?"en":"ar";try{Ci?.(Q)}catch{}if(q(),D(),t){const B=Ne?.()||"ar",ne=p.checklistType,F=ne==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":ne==="both"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª",W=ne==="crew"?"Crew List":ne==="both"?"Equipment & Crew List":"Equipment List";t.textContent=B==="en"?W:F}Jn(),Xn(),Xe()})}const Y=s.querySelector("[data-checklist-hide-logo]"),S=s.querySelector("[data-checklist-hide-company]");(()=>{Y&&(Y.checked=!!p.hideLogo),S&&(S.checked=!!p.hideCompany)})(),Y?.addEventListener("change",q=>{p.hideLogo=!!q.target.checked,Xe()}),S?.addEventListener("change",q=>{p.hideCompany=!!q.target.checked,Xe()})}e.checklistControls=s,e.checklistLessorContainer=s.querySelector("[data-checklist-lessors]"),e.checklistLessorOptionsHost=s.querySelector("[data-lessor-options]"),ua(),t&&(t.textContent=p.checklistType==="crew"?"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ":"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");try{e.previewFrame?.setAttribute("title","Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„Ø³ØªØ©")}catch{}}catch{}Jn(),Xn(),Rs(),Xe(),zc(e.modal)}}async function Dl({reservation:e,customer:t,project:n}){if(!e){j(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}await Ds();const a=La(e),{totalsDisplay:s,totals:r,rentalDays:o}=Bs(e,a,n),i=c("reservations.create.summary.currency","SR"),d=(m=>{if(!m)return"1";const v=[m.reservationCode,m.reservation_code,m.reservationId,m.reservation_id,m.id].find(w=>w!=null&&String(w).trim()!==""),I=k(String(v??"1"));return I.replace(/\D+/g,"")||I||"1"})(e),u=Number.parseInt(d,10)||1,y=new Date,b=yc();p={context:"reservation",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:o,currencyLabel:i,projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(qa("reservation").filter(m=>m.defaultSelected).map(m=>m.id)),sectionExpansions:xa("reservation"),fields:Vn("reservation"),terms:b,quoteSequence:u,quoteNumber:d,quoteDate:y,quoteDateLabel:js(y),sequenceCommitted:!1},On=!1,Ts(p),Es(p),Cs(p),Ms();try{vs()}catch{}}async function Fl({reservation:e,customer:t,project:n}){if(!e){j(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}await Ds();const a=La(e),{totalsDisplay:s,totals:r,rentalDays:o}=Bs(e,a,n),i=c("reservations.create.summary.currency","SR"),l=new Date;p={context:"reservationChecklist",reservation:e,customer:t,project:n,crewAssignments:a,totals:r,totalsDisplay:s,rentalDays:o,currencyLabel:i,checklistType:"items",checklistNotes:"",projectCrew:[],projectExpenses:[],projectEquipment:[],sections:new Set(["customerInfo","reservationInfo","projectInfo","notes","items"]),sectionExpansions:xa("reservationChecklist"),fields:Vn("reservationChecklist"),terms:[],quoteDate:l,quoteDateLabel:js(l),sequenceCommitted:!1},p.checklistLessorFilter=new Set,p.checklistLessorOptions=[],p.checklistEquipmentLookup=Is(),On=!1,fo(),Ts(p),Es(p),Cs(p),Ms();try{vs()}catch{}}async function hu({project:e}){if(!e){j(c("projects.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));return}await Ds();let t=lr(e);const{project:n}=t;if(!n){j(c("projects.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"));return}try{(!Array.isArray(t.equipmentItems)||t.equipmentItems.length===0)&&n?.id!=null&&(await Pr({project_id:n.id}),t=lr(n))}catch(l){console.warn("[reservationPdf] refreshReservationsForProject failed, proceeding with snapshot/state",l)}const s=(l=>{if(!l)return"1";const u=[l.projectCode,l.project_code,l.code,l.id].find(m=>m!=null&&String(m).trim()!==""),y=k(String(u??"1"));return y.replace(/\D+/g,"")||y||"1"})(n),r=Number.parseInt(s,10)||1,o=new Date,i=[...fc];p={context:"project",reservation:null,customer:t.customer,project:n,technicians:t.crew||[],clientInfo:t.clientInfo,projectInfo:t.projectInfo,projectCrew:t.crew,projectExpenses:t.expenses,projectEquipment:t.equipment,equipmentItems:t.equipmentItems||[],crewAssignments:t.crewAssignments||[],totals:t.totals,projectTotals:t.projectTotals,totalsDisplay:t.totalsDisplay,rentalDays:t.projectDurationDays,currencyLabel:t.currencyLabel,sections:new Set(qa("project").filter(l=>l.defaultSelected).map(l=>l.id)),sectionExpansions:xa("project"),fields:Vn("project"),terms:i,quoteSequence:r,quoteNumber:s,quoteDate:o,quoteDateLabel:js(o),sequenceCommitted:!1,paymentSummary:t.paymentSummary,projectNotes:t.notes,paymentHistory:t.paymentHistory},On=!1,Ts(p),Es(p),Cs(p),Ms();try{vs()}catch{}}function Rl(e="reservation"){return e==="project"?[{value:"projectCustomer",label:c("projects.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")},{value:"projectDetails",label:c("projects.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}]:[{value:"customer",label:c("reservations.quote.sections.customer","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„")},{value:"reservation",label:c("reservations.quote.sections.reservation","ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²")},{value:"project",label:c("reservations.quote.sections.project","Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")}]}function Po(){if(!X?.alignTarget)return;const e=p?.context||"reservation",t=Rl(e),n=X.alignTarget,a=n.value;n.innerHTML=t.map(s=>`<option value="${h(s.value)}">${h(s.label)}</option>`).join(""),t.some(s=>s.value===a)?n.value=a:n.value=t[0]?.value||"",Ca()}const Ml="__DEBUG_CREW__";function Ol(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Ml);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function ur(e,t){if(Ol())try{console.log(`ðŸªµ [crew-debug:create] ${e}`,t)}catch{}}const To="projects:create:draft",jo="projects.html#projects-section";let Ja=null,Bo=[],Xa=new Map,Za=new Map,ya=new Map,Fa=!1,Zn=null,pr=!1,Do=[];const zl="__DEBUG_RESERVATION__";function Hl(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugReservation")==="1")return!0;const t=window.localStorage?.getItem(zl);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function et(e,t){if(Hl())try{console.log(`ðŸ§­ [reservation:create] ${e}`,t??"")}catch{}}function Kl(e){return new Promise(t=>setTimeout(t,e))}async function Vl({reservationCode:e}={}){if(!e)return null;try{let n=600;for(let a=1;a<=4;a+=1){await Kl(n);let s=null;try{s=await At(`/reservations/?search=${encodeURIComponent(String(e))}&limit=5`)}catch(o){et("recover:attempt_failed",{attempt:a,message:o?.message})}const r=Array.isArray(s?.data)?s.data:[];if(r.length)return r.find(i=>String(i?.reservation_code||i?.reservationCode)===String(e))||r[0]||null;n=Math.min(4e3,Math.round(n*1.8))}return null}catch{return null}}function mr(e){ys(),Ut(),yn(),ai(),j(c("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const t=document.getElementById("sub-tab-trigger-my-reservations-tab");t&&typeof t.click=="function"&&setTimeout(()=>t.click(),0)}catch{}typeof Ja=="function"&&Ja({type:"created",reservation:e}),fd(e)}function Sn(e=[],t){const n=Array.isArray(e)?e.map(s=>k(String(s??"")).trim()).filter(Boolean):[];if(!n.length)return t||c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(n.length===1)return c("reservations.toast.equipmentConflictSingle","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø­Ø¬Ø² Ø±Ù‚Ù… {code}").replace("{code}",n[0]);const a=n.join("ØŒ ");return c("reservations.toast.equipmentConflictMultiple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø­Ø¬ÙˆØ²Ø§Øª Ø£Ø±Ù‚Ø§Ù…: {codes}").replace("{codes}",a)}const Ot="reservations:create:draft";let pn=!1;function Na(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function Os(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function Ul(){if(typeof document>"u"||!Na())return null;try{const{input:t,hidden:n}=wn(),{input:a,hidden:s}=Bt(),r=document.getElementById("res-start")?.value||"",o=document.getElementById("res-end")?.value||"",i=document.getElementById("res-start-time")?.value||"",l=document.getElementById("res-end-time")?.value||"",d=document.getElementById("res-notes")?.value||"",u=document.getElementById("res-discount")?.value||"",y=document.getElementById("res-discount-type")?.value||"percent",b=!!document.getElementById("res-tax")?.checked,f=!!document.getElementById("res-company-share")?.checked,v=f?tn("res-company-share"):null,I=document.getElementById("res-payment-status")?.value||"unpaid",A=document.getElementById("res-payment-progress-type")?.value||"percent",w=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:r,endDate:o,startTime:i,endTime:l,customerId:n?.value||"",customerLabel:t?.value||"",projectId:s?.value||"",projectLabel:a?.value||"",notes:d,discount:String(u||""),discountType:y,taxEnabled:b,companyShareEnabled:f,companySharePercent:v,paymentStatus:I,paymentProgressType:A,paymentProgressValue:String(w||""),items:ft()||[],technicianIds:Oi()||[],crewAssignments:ds()||[]}}catch{return null}}function Et(){if(pn)return;const e=Na(),t=Os();if(!e&&!t)return;const n=Ul();if(n){try{const s=(()=>{const o=e?e.getItem(Ot):null,i=!o&&t?t.getItem(Ot):null,l=o||i;return l?JSON.parse(l):null})(),r=o=>{if(!o)return!1;const i=Array.isArray(o.items)&&o.items.length>0,l=Array.isArray(o.technicianIds)&&o.technicianIds.length>0,d=!!(o.startDate||o.endDate||o.startTime||o.endTime),u=!!(o.customerId||o.customerLabel);return i||l||d||u};if(r(s)&&!r(n))return}catch{}try{const a=JSON.stringify(n);e&&e.setItem(Ot,a),t&&t!==e&&t.setItem(Ot,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function Fo(){const e=Na(),t=Os();if(!(!e&&!t))try{e&&e.removeItem(Ot),t&&t!==e&&t.removeItem(Ot)}catch(n){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",n)}}function Gl(){const e=Na(),t=Os();if(!e&&!t)return;pn=!0;let n=null;try{const a=e?e.getItem(Ot):null,s=!a&&t?t.getItem(Ot):null,r=a||s;n=r?JSON.parse(r):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),pn=!1;return}if(n)try{if(n.startDate||n.startTime){const o=Zt(n.startDate||"",n.startTime||"");Vt("res-start","res-start-time",o)}if(n.endDate||n.endTime){const o=Zt(n.endDate||"",n.endTime||"");Vt("res-end","res-end-time",o)}if(n.customerId){vt({selectedValue:String(n.customerId)});const{input:o,hidden:i}=wn();o&&(o.dataset.selectedId=String(n.customerId))}else if(n.customerLabel){vt({selectedValue:"",resetInput:!0});const{input:o,hidden:i}=wn();o&&(o.value=n.customerLabel),i&&(i.value="");try{const l=ba(n.customerLabel,{allowPartial:!0});l&&(i.value=String(l.id),o.value=l.label,o.dataset.selectedId=String(l.id))}catch{}}if(n.projectId)Kt({selectedValue:String(n.projectId)});else if(n.projectLabel){Kt({selectedValue:"",resetInput:!0});const{input:o,hidden:i}=Bt();o&&(o.value=n.projectLabel),i&&(i.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=n.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=n.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=n.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!n.taxEnabled);const s=document.getElementById("res-company-share");s&&(s.checked=!!n.companyShareEnabled,n.companySharePercent!=null&&(s.dataset.companyShare=String(n.companySharePercent)));const r=document.getElementById("res-payment-status");if(r&&(r.value=n.paymentStatus||r.value||"unpaid",ut(r,r.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=n.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=n.paymentProgressValue||""),Array.isArray(n.items)&&(Kn(n.items),at()),Array.isArray(n.crewAssignments)&&n.crewAssignments.length)try{Ys(n.crewAssignments)}catch{}else if(Array.isArray(n.technicianIds)&&n.technicianIds.length)try{Ys(n.technicianIds)}catch{}Tt();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(o=>document.getElementById(o)).filter(Boolean).forEach(o=>{o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}we()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{pn=!1}}function Ql(e){if(!e)return null;let t=Do.find(a=>a.id===e)||null;if(t)return t;const n=us(e);return n?(t={id:e,name:Ji(n)||e,price:Yi(n),items:fs(n),raw:n},t):null}function ga(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ha(e){return k(String(e||"")).trim().toLowerCase()}function Wl(e={}){const t=String(e?.desc||e?.description||"")?.trim(),n=k(String(e?.barcode||"")).trim();return n?`${t} | ${n}`:t}function Ro(e){const t=k(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Mo(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function Oo(e){if(!e)return null;const t=k(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function zo(e,t){if(e){if(t==null||!Number.isFinite(t)||t<=0){e.value="";return}e.value=k(String(t))}}function en(e){switch(e){case"maintenance":return c("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return c("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return c("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return c("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function wn(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function Bt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function ht(){const{input:e,hidden:t}=Bt();return e?.dataset?.pendingLinked==="true"?!0:!!t?.value}function Yt(e,t){if(!e)return;const n=new Set([e]),a=e.parentElement;if(a&&n.add(a),e.id){const r=document.querySelector(`label[for="${e.id}"]`);r&&n.add(r)}const s=r=>{t()&&j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};n.forEach(r=>{!r||r.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(o=>{r.addEventListener(o,s,{capture:!0})}),r.dataset.linkedGuardAttached="true")})}function Ho(e,t,{allowPartial:n=!1}={}){const a=dt(t);if(!a)return null;const s=e.get(a);if(s)return s;if(!n)return null;const r=[];return e.forEach((o,i)=>{i.includes(a)&&r.push(o)}),r.length===1?r[0]:null}function ba(e,t={}){return Ho(Xa,e,t)}function es(e,t={}){return Ho(Za,e,t)}function ut(e,t){if(!e)return;const n=t??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),n==="paid"?e.classList.add("payment-status-select--paid"):n==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function Ko(e){Bo=Array.isArray(e)?[...e]:[]}function zs(){return Bo}function Hs(e){return e&&zs().find(t=>String(t.id)===String(e))||null}function fr(e){if(!e)return"";const t=typeof e.title=="string"?e.title.trim():"";return t||c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function tn(e="res-company-share"){const t=document.getElementById(e);if(!t||!t.checked)return null;const n=t.dataset.companyShare??t.value??Ht,a=k(String(n).replace("%","").trim()),s=parseFloat(a);return Number.isFinite(s)?s:Ht}function wt(e="res-company-share"){const t=document.getElementById(e);if(!t)return;let n=t.dataset.companyShare??t.value??Ht,a=k(String(n).replace("%","").trim()),s=parseFloat(a);(!Number.isFinite(s)||s<=0)&&(s=Ht),t.dataset.companyShare=String(s),t.checked=!0}function ts(e){const t=document.getElementById("res-tax"),n=document.getElementById("res-company-share");if(!t||!n)return;if(Fa){we();return}Fa=!0;const a=()=>{Fa=!1,we()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(Ht)),t.disabled){n.checked=!1,j(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}t.checked||(t.checked=!0),wt()}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?wt():n.checked&&(n.checked=!1));a()}function Yl(e){if(!e)return!1;if(e.confirmed===!0)return!0;const t=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(t)}function yr(e,t){if(!e)return"";if(e[t])return e[t];if(e[`${t}Datetime`])return e[`${t}Datetime`];if(e[`${t}datetime`])return e[`${t}datetime`];if(e[`${t}_datetime`])return e[`${t}_datetime`];const n=e[`${t}Date`]??e[`${t}_date`],a=e[`${t}Time`]??e[`${t}_time`];if(n){const s=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${n}T${s}`}return""}function gr(e){if(!e)return"";const t=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof t=="string"?t.trim():String(t||"").trim()}function vt({selectedValue:e="",resetInput:t=!1}={}){const{input:n,hidden:a,list:s}=wn();if(!n||!a||!s)return;const r=ps()||[],o=c("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),i=c("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");n.setAttribute("placeholder",o);const l=new Set;Xa=new Map;const d=r.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:gr(m)||i})).filter(m=>{if(!m.label)return!1;const f=dt(m.label);return!f||l.has(f)?!1:(l.add(f),Xa.set(f,m),!0)}).sort((m,f)=>m.label.localeCompare(f.label,void 0,{sensitivity:"base"}));s.innerHTML=d.map(m=>`<option value="${ga(m.label)}"></option>`).join("");const u=t?"":n.value,y=e?String(e):a.value?String(a.value):"",b=y?r.find(m=>String(m.id)===y):null;if(b){const m=gr(b)||i;a.value=String(b.id),n.value=m,n.dataset.selectedId=String(b.id)}else a.value="",n.dataset.selectedId="",n.value=t?"":u}function Kt({selectedValue:e="",projectsList:t=null,resetInput:n=!1}={}){const{input:a,hidden:s,list:r}=Bt();if(!a||!s||!r)return;const o=Array.isArray(t)?t:zs()||[],i=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",i);const l=[...o].filter(v=>v&&v.id!=null).sort((v,I)=>String(I.createdAt||I.start||"").localeCompare(String(v.createdAt||v.start||""))),d=n?"":a.value,u=c("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),y=new Set;Za=new Map;const b=l.map(v=>{const I=fr(v)||u;return{id:String(v.id),label:I}}).filter(v=>{if(!v.label)return!1;const I=dt(v.label);return!I||y.has(I)?!1:(y.add(I),Za.set(I,v),!0)});r.innerHTML=b.map(v=>`<option value="${ga(v.label)}"></option>`).join("");const m=e?String(e):s.value?String(s.value):"",f=m?l.find(v=>String(v.id)===m):null;if(f){const v=fr(f)||u;s.value=String(f.id),a.value=v,a.dataset.selectedId=String(f.id)}else s.value="",a.dataset.selectedId="",a.value=n?"":d}function Vt(e,t,n){const{date:a,time:s}=Vr(n),r=document.getElementById(e),o=document.getElementById(t);if(r){if(a)if(r._flatpickr){const i=r._flatpickr.config?.dateFormat||"Y-m-d";r._flatpickr.setDate(a,!1,i)}else r.value=a;else r._flatpickr?r._flatpickr.clear():r.value="";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}if(o){if(s)if(o._flatpickr){const i=o._flatpickr.config?.dateFormat||"H:i";o._flatpickr.setDate(s,!1,i)}else o.value=s;else o._flatpickr?o._flatpickr.clear():o.value="";o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}}function Vo(e,{forceNotes:t=!1,skipProjectSelectUpdate:n=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";n||Kt({selectedValue:a});const r=(ps()||[]).find(u=>String(u.id)===String(e.clientId)),o=r?.id!=null?String(r.id):"";vt(o?{selectedValue:o}:{selectedValue:"",resetInput:!0});const i=yr(e,"start"),l=yr(e,"end");i&&Vt("res-start","res-start-time",i),l&&Vt("res-end","res-end-time",l);const d=document.getElementById("res-notes");d&&e.description&&(t||!d.value)&&(d.value=e.description),we(),Tt()}function Uo({projectsList:e=null,preselectId:t=null}={}){const n=document.getElementById("res-project");if(!n)return;const{projects:a}=e?{projects:e}:Te(),s=Array.isArray(a)?a:[];Ko(s);const r=t!=null?String(t):n.value?String(n.value):"";Kt({selectedValue:r,projectsList:s}),Tt(),we()}function Tt(){const{input:e,hidden:t}=Bt(),n=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),s=document.getElementById("res-payment-status"),r=document.getElementById("res-payment-progress-type"),o=document.getElementById("res-payment-progress-value"),i=document.getElementById("res-discount"),l=document.getElementById("res-discount-type"),d=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),y=e?.dataset?.pendingLinked==="true"||!!t?.value;if(n&&(Yt(n,ht),a&&Yt(a,ht)),s&&Yt(s,ht),r&&Yt(r,ht),o&&Yt(o,ht),i&&Yt(i,ht),l&&Yt(l,ht),y)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled","reservation-input-disabled"),n.title=d),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=d),s&&(s.value="unpaid",ut(s,"unpaid"),s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=d),r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=d),o&&(o.value="",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=d),i&&(i.value="0",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=d),l&&(l.value="percent",l.disabled=!0,l.classList.add("reservation-input-disabled"),l.title=d);else{if(n){const b=n.disabled;n.disabled=!1,n.classList.remove("disabled","reservation-input-disabled"),n.title="",b&&(n.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),l&&(l.disabled=!1,l.classList.remove("reservation-input-disabled"),l.title="")}ts("tax"),we()}function Ks(){const{input:e,hidden:t}=Bt();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?es(s,{allowPartial:a}):null;if(r){t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id);const o=Hs(r.id);o?Vo(o,{skipProjectSelectUpdate:!0}):(Tt(),we())}else t.value="",e.dataset.selectedId="",Tt(),we()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?es(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="");try{Et()}catch{}}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Vs(){const{input:e,hidden:t}=wn();if(!e||!t||e.dataset.listenerAttached)return;const n=(a=!1)=>{const s=e.value.trim(),r=s?ba(s,{allowPartial:a}):null;r?(t.value=String(r.id),e.value=r.label,e.dataset.selectedId=String(r.id)):(t.value="",e.dataset.selectedId=""),we()};e.addEventListener("input",()=>{const a=e.value.trim(),s=a?ba(a):null;s?(t.value=String(s.id),e.dataset.selectedId=String(s.id)):a||(t.value="",e.dataset.selectedId="");try{Et()}catch{}}),e.addEventListener("change",()=>n(!0)),e.addEventListener("blur",()=>n(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),n(!0))}),e.dataset.listenerAttached="true"}function Jl(){const e=new URLSearchParams(window.location.search),t=e.get("reservationProjectContext");if(!t){jn({clearValue:!0});return}let n=null;try{const d=decodeURIComponent(t);n=JSON.parse(d)}catch(d){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",d)}e.delete("reservationProjectContext");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,s),jn({clearValue:!1}),!n)return;n.fromProjectForm&&(Zn={draftStorageKey:n.draftStorageKey||To,returnUrl:n.returnUrl||jo});const r=document.getElementById("res-project");if(n.projectId){r&&(Kt({selectedValue:String(n.projectId)}),Tt());const d=Hs(n.projectId);d?Vo(d,{forceNotes:!!n.forceNotes}):we(),jn()}else{r&&Kt({selectedValue:""});const d=n.projectTitle?n.projectTitle:c("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");yd(c("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),d)}n.start&&Vt("res-start","res-start-time",n.start),n.end&&Vt("res-end","res-end-time",n.end);const o=document.getElementById("res-customer-input"),i=document.getElementById("res-customer");if(n.customerId){const u=(ps()||[]).find(y=>String(y.id)===String(n.customerId));u?.id!=null&&(vt({selectedValue:String(u.id)}),i&&(i.value=String(u.id)),o&&(o.value=u.customerName||u.name||o.value))}else n.customerName&&o?(vt({selectedValue:""}),o.value=n.customerName,o.dataset.selectedId="",i&&(i.value="")):vt({selectedValue:""});const l=document.getElementById("res-notes");l&&n.description&&!l.value&&(l.value=n.description),we()}function Dt(){const e=document.getElementById("res-start")?.value?.trim(),t=document.getElementById("res-end")?.value?.trim(),n=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!t?{start:null,end:null}:{start:Zt(e,n),end:Zt(t,a)}}function qn(){if(!Wr())return;const{start:e,end:t}=Dt();!e||!t||tc({start:e,end:t})}function Go(e){const t=ha(e);if(t){const i=ya.get(t);if(i)return i}const{description:n,barcode:a}=Ro(e);if(a){const i=is(a);if(i)return i}const s=dt(n||e);if(!s)return null;let r=Or();if(!r?.length){const i=Te();r=Array.isArray(i?.equipment)?i.equipment:[],r.length&&Ur(r)}const o=r.find(i=>dt(i?.desc||i?.description||"")===s);return o||r.find(i=>dt(i?.desc||i?.description||"").includes(s))||null}function Qo(e,t="equipment-description-options"){const n=ha(e);if(!n)return!1;const a=document.getElementById(t);if(a&&a.options&&Array.from(a.options).some(l=>ha(l.value)===n)||ya.has(n))return!0;const{description:s}=Ro(e);if(!s)return!1;const r=dt(s);return r?(Or()||[]).some(i=>dt(i?.desc||i?.description||"")===r):!1}const Xl={available:0,reserved:1,maintenance:2,retired:3};function Zl(e){return Xl[e]??5}function hr(e){switch(e){case"available":return c("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return c("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return c("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return c("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return c("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function ed(e){const t=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return t;const n=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(s=>s!=="available")||e.bestStatus;if(n==="available")return`${t} â€” ${hr(n)}`;const a=c("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${t} â€” ${a} (${hr(n)})`}function Ut(){const e=document.getElementById("equipment-description-options"),t=document.getElementById("edit-res-equipment-description-options"),n=ys(),a=Te(),s=Array.isArray(n)&&n.length?n:a?.equipment||[],r=Array.isArray(s)?s:[];Ur(r);const o=new Map;r.forEach(d=>{const u=Wl(d),y=ha(u);if(!y||!u)return;const b=_t(d),m=Zl(b),f=o.get(y);if(!f){o.set(y,{normalized:y,value:u,bestItem:d,bestStatus:b,bestPriority:m,statuses:new Set([b])});return}f.statuses.add(b),m<f.bestPriority&&(f.bestItem=d,f.bestStatus=b,f.bestPriority=m,f.value=u)}),ya=new Map;const l=Array.from(o.values()).sort((d,u)=>d.value.localeCompare(u.value,"ar",{sensitivity:"base"})).map(d=>{ya.set(d.normalized,d.bestItem);const u=ed(d),y=ga(d.value);if(u===d.value)return`<option value="${y}"></option>`;const b=ga(u);return`<option value="${y}" label="${b}"></option>`}).join("");e&&(e.innerHTML=l),t&&(t.innerHTML=l)}function Wo(e,t,n={}){const{silent:a=!1}=n,s=Se(e);if(!s)return{success:!1,message:null};const{start:r,end:o}=Dt();if(!r||!o){const f=c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||j(f),{success:!1,message:f}}const i=ft();if(Us(i).has(s)){const f=c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||j(f),{success:!1,message:f}}const d=ms(s,r,o);if(d.length){const f=d.map(I=>I.name).join(", "),v=c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${f}`);return a||j(v),{success:!1,message:v}}if(jt(s,r,o)){const f=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),v=hn([s],r,o),I=Sn(v,f);if(!a)if(v.length)j(I);else try{const A=new URLSearchParams({type:"equipment",id:s,start:r,end:o});At(`/reservations/availability.php?${A.toString()}`).then(w=>{const D=Array.isArray(w?.conflicts)?w.conflicts:[],U=Array.from(new Set(D.map(S=>S?.reservation_code||(S?.reservation_id!=null?`#${S.reservation_id}`:null)).filter(Boolean))),Y=Sn(U,f);j(Y)}).catch(()=>j(I))}catch{j(I)}return{success:!1,message:I}}const u=is(s);if(!u){const f=c("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||j(f),{success:!1,message:f}}const y=_t(u);if(y==="maintenance"||y==="retired"){const f=en(y);return a||j(f),{success:!1,message:f}}const b=sn(u);if(!b){const f=c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||j(f),{success:!1,message:f}}ka({id:b,equipmentId:b,barcode:s,desc:u.desc,qty:1,price:u.price,cost:Xt(u),image:kn(u)}),t&&(t.value=""),at(),we();const m=c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||j(m),{success:!0,message:m,barcode:s}}function ns(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Go(t);if(!n){j(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=Ti(n.barcode),s=_t(a||n);if(s==="maintenance"||s==="retired"){j(en(s));return}const r=Se(n.barcode);if(!r){j(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o=sn(n);if(!o){j(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i={id:o,equipmentId:o,barcode:r,desc:n.desc||n.description||n.name||"",qty:1,price:Number.isFinite(Number(n.price))?Number(n.price):0,cost:Xt(n),image:kn(n)},{start:l,end:d}=Dt();if(!l||!d){j(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const u=ft();if(Us(u).has(r)){j(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const b=ms(r,l,d);if(b.length){const m=b.map(f=>f.name).join(", ");j(c("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(jt(r,l,d)){const m=c("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),f=hn([r],l,d),v=Sn(f,m);if(f.length)j(v);else try{const I=new URLSearchParams({type:"equipment",id:r,start:l,end:d});At(`/reservations/availability.php?${I.toString()}`).then(A=>{const w=Array.isArray(A?.conflicts)?A.conflicts:[],D=Array.from(new Set(w.map(Y=>Y?.reservation_code||(Y?.reservation_id!=null?`#${Y.reservation_id}`:null)).filter(Boolean))),U=Sn(D,m);j(U)}).catch(()=>j(v))}catch{j(v)}return}ka(i),at(),we(),j(c("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function td(){Ut();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),ns(e))});const t=()=>{Qo(e.value,"equipment-description-options")&&ns(e)};e.addEventListener("focus",()=>{if(Ut(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}function br(e,t){if(!e)return;const n=!!t;e.dataset.selectionActive=n?"true":"false",e.setAttribute("aria-pressed",n?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",n)}function Us(e=ft()){const t=new Set;return e.forEach(n=>{if(!n)return;const a=Se(n.barcode??n.normalizedBarcode);a&&t.add(a),Array.isArray(n.packageItems)&&n.packageItems.forEach(s=>{const r=Se(s?.normalizedBarcode??s?.barcode);r&&t.add(r)})}),t}function nd(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:t,end:n}=Dt();if(!t||!n){j(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}ec({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:t,end:n});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):j(c("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(Qr.change,t=>{br(e,t?.detail?.active)}),e.dataset.selectionObserverAttached="true"),br(e,Wr()))}function ad(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const t=e.detail,n=t.selection?.mode||t.selection?.source||"";if(n==="package-manager"||n==="equipment-packages")return;const a=Array.isArray(t.barcodes)?t.barcodes:[],s=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=a.length?a:t.barcode?[t.barcode]:[];if(!r.length)return;let o=0,i=null;const l=[],d=new Set;r.forEach(y=>{const b=Se(y);b&&!d.has(b)&&(d.add(b),l.push(b))});const u=Math.min(s,l.length);for(let y=0;y<u;y+=1){const b=l[y],m=Wo(b,null,{silent:!0});m.success&&(o+=1),m.message&&(i=m.message)}if(o>0){const b=c("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",k(String(o)));j(b)}else i&&j(i)}function Yo(){nd(),!(pr||typeof document>"u")&&(document.addEventListener(Qr.requestAdd,ad),pr=!0)}function Un(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),t=document.querySelector('[data-equipment-mode="single"]'),n=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),s=document.getElementById("reservation-package-hint"),r=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:t,packageContainer:n,packageSelect:a,packageHint:s,packageAddButton:r}}function as(e){const t=e==="package"?"package":"single",{singleContainer:n,packageContainer:a,packageSelect:s}=Un();n&&(n.hidden=t!=="single",n.setAttribute("aria-hidden",t!=="single"?"true":"false")),a&&(a.hidden=t!=="package",a.setAttribute("aria-hidden",t!=="package"?"true":"false"));const r=document.getElementById("equipment-barcode"),o=document.getElementById("equipment-description"),i=t==="package";r&&(r.disabled=i),o&&(o.disabled=i),s&&(s.disabled=t!=="package"||s.options.length===0),Xi(t),t==="package"&&Pa()}function Pa(){const{packageSelect:e,packageHint:t}=Un();if(!e)return;const n=Mr();Do=n,Qi(n.map(i=>i.raw??i));const a=c("reservations.create.summary.currency","SR"),s=`<option value="" disabled selected>${c("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,r=n.map(i=>{const l=Number.isFinite(Number(i.price))?Number(i.price):0,d=k(l.toFixed(2)),u=`${i.name} â€” ${d} ${a}`;return`<option value="${i.id}">${u}</option>`}).join("");e.innerHTML=`${s}${r}`,e.selectedIndex=0;const o=n.length>0;e.disabled=!o,t&&(o?(t.textContent=c("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),t.dataset.state="ready"):(t.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),Zo()}function sd(e,t){const n=e?.name||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=c("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${n} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),s=t.map(({item:r,blockingPackages:o})=>{const i=r?.desc||k(String(r?.barcode??r?.normalizedBarcode??""))||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(o)&&o.length){const l=o.map(d=>d.name).join(", ");return`â€¢ ${i} (${c("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${l})`}return`â€¢ ${i} (${c("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...s].join(`
`)}function Jo(e,{existingItems:t=[],start:n,end:a,ignoreReservationId:s=null}={}){const r=rt(e);if(!r)return{success:!1,reason:"invalid",message:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const o=Ql(r);if(!o)return{success:!1,reason:"not_found",message:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!n||!a)return{success:!1,reason:"missing_dates",message:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(t.some(m=>m?.type==="package"&&rt(m.packageId)===r))return{success:!1,reason:"duplicate",message:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(zr(r,n,a,s)){const m=o.name||r;return{success:!1,reason:"package_conflict",message:c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const i=Array.isArray(o.items)&&o.items.length?o.items:fs(o.raw??{}),l=Us(t),d=[],u=new Set;if(i.forEach(m=>{const f=Se(m?.normalizedBarcode??m?.barcode);if(f){if(u.has(f)){d.push({item:m,type:"internal"});return}u.add(f),l.has(f)&&d.push({item:m,type:"external"})}}),d.length){const m=d.map(({item:v})=>v?.desc||v?.description||v?.name||v?.barcode||v?.normalizedBarcode||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(v=>k(String(v))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:d.some(v=>v.type==="external")?c("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):c("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:d}}const y=[];return i.forEach(m=>{const f=Se(m?.normalizedBarcode??m?.barcode);if(f&&jt(f,n,a,s)){const v=ms(f,n,a,s);y.push({item:m,blockingPackages:v})}}),y.length?{success:!1,reason:"item_conflict",message:sd(o,y),conflicts:y}:{success:!0,package:{id:`package::${r}`,packageId:r,type:"package",desc:o.name||`Package ${r}`,qty:1,price:Number.isFinite(Number(o.price))?Number(o.price):0,cost:Number.isFinite(Number(o.cost))?Number(o.cost):0,barcode:o.code||o.raw?.package_code||`pkg-${r}`,packageItems:i.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:Se(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0,cost:0})),image:i.find(m=>m?.image)?.image??null},packageInfo:o}}function Xo(e,{silent:t=!1}={}){const n=rt(e);if(!n)return t||j(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:s}=Dt(),r=ft(),o=Jo(n,{existingItems:r,start:a,end:s});if(!o.success){if(!t){const l={invalid:c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:c("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:c("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[o.reason]||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");j(o.message||l)}return o}return ka(o.package),at(),we(),t||j(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:o.package}}function Zo(){const{packageSelect:e}=Un();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const t=e.value;if(!t)return;Xo(t)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function rd(){const{packageAddButton:e,packageSelect:t}=Un();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const n=t?.value||"";if(!n){j(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}Xo(n)}),e.dataset.listenerAttached="true")}function ei(){const{modeRadios:e}=Un();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",s=>{s.target.checked&&as(s.target.value)}),a.dataset.listenerAttached="true")}),rd(),Zo();const t=sa(),n=e.find(a=>a.value===t);n&&(n.checked=!0),as(t)}function od(e={}){const t=[e.packageId,e.package_id,e.packageCode,e.package_code,e.packageDisplayCode,e.barcode,e.key];for(const n of t){if(!n)continue;const a=rt(n);if(a)return a;const s=k(String(n)).trim().toLowerCase();if(s)return s}return null}function Ra(e={}){if(!e||typeof e!="object")return null;const t=rt(e.packageId??e.package_id??e.package_code??e.packageCode??e.barcode??e.id??null);if(t)return t;const n=e.package_code??e.packageCode??e.barcode??null;return n?k(String(n)).trim().toLowerCase():null}function at(e="reservation-items"){const t=document.getElementById(e);if(!t)return;const n=ft(),a=c("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),s=c("reservations.create.summary.currency","SR"),r=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),o=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),l=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(n.length===0){t.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;try{Et()}catch{}return}const d=an(n);t.innerHTML=d.map(u=>{const y=u.items[0]||{},b=kn(y)||u.image,m=b?`<img src="${b}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ðŸŽ¥</div>',f=k(String(u.count)),v=Number.isFinite(Number(u.unitPrice))?Number(u.unitPrice):0,I=(()=>{try{const{start:N,end:T}=Dt(),H=fn(N,T);return Number.isFinite(H)&&H>0?H:1}catch{return 1}})(),A=k(String(I)),w=v*u.count*I,D=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${u.key}"
          min="0"
          step="0.01"
          value="${k(String(v))}"
          aria-label="${c("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,U=`${k(w.toFixed(2))} ${s}`,Y=Number.isFinite(Number(u.unitCost))?Number(u.unitCost):0,S=u.items.some(N=>N?.type==="package"),C=u.barcodes.map(N=>k(String(N||""))).filter(Boolean),q=C.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${C.map(N=>`<li>${N}</li>`).join("")}
            </ul>
          </details>`:"";let E="";if(S){const N=new Map;if(u.items.forEach(T=>{Array.isArray(T?.packageItems)&&T.packageItems.forEach(H=>{if(!H)return;const K=Se(H.barcode||H.desc||Math.random()),M=N.get(K);if(M){M.qty+=Number.isFinite(Number(H.qty))?Number(H.qty):1;return}N.set(K,{desc:H.desc||H.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(H.qty))?Number(H.qty):1,barcode:H.barcode??H.normalizedBarcode??""})})}),N.size){const T=Array.from(N.values()).map(H=>{const K=k(String(H.qty)),M=H.desc||k(String(H.barcode||"")),P=H.barcode?` <span class="reservation-package-items__barcode">(${k(String(H.barcode))})</span>`:"";return`<li>${M}${P} Ã— ${K}</li>`}).join("");E=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${T}
              </ul>
            </details>
          `}}const Q=(()=>{if(!S)return null;for(let N=0;N<n.length;N+=1){const T=n[N];if(!(!T||String(T.type||"").toLowerCase()!=="package")&&St(T)===u.key)return N}return null})(),B=S?od(u):null,ne=B?`data-package-identity="${B}"`:"",F=Q!=null&&Number.isInteger(Q)?`data-package-index="${Q}"`:"",W=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          data-group-key="${u.key}"
          ${ne}
          ${F}
          min="0"
          step="0.01"
          value="${k(String(Y))}"
          aria-label="${c("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `;return`
        <tr data-group-key="${u.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${S?`${E||""}${q||""}`:q}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${u.key}" aria-label="${i}" ${S?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${u.key}" aria-label="${o}" ${S?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${A}</span></td>
          <td>${D}</td>
          <td>${W}</td>
          <td>${U}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${u.key}" aria-label="${l}">ðŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("");try{Et()}catch{}}function id(e){const t=ft(),a=an(t).find(r=>r.key===e);if(!a)return;const s=a.itemIndices[a.itemIndices.length-1];s!=null&&(Wi(s),at(),we())}function cd(e){const t=ft(),n=t.filter(a=>St(a)!==e);n.length!==t.length&&(Kn(n),at(),we())}function ld(e,t){const n=ti(t),a=Number.isFinite(n)&&n>=0?ni(n):0,s=ft(),o=an(s).find(l=>l.key===e);if(!o||!Array.isArray(o.itemIndices))return;const i=[...s];o.itemIndices.forEach(l=>{i[l]&&(i[l]={...i[l],price:a,unit_price:a})}),Kn(i),at(),we()}function dd(e,t){const n=ti(t),a=Number.isFinite(n)&&n>=0?ni(n):0,s=ft(),o=an(s).find(l=>l.key===e);if(!o||!Array.isArray(o.itemIndices))return;const i=[...s];o.itemIndices.forEach(l=>{if(i[l]){const d={...i[l],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};i[l]=d}}),Kn(i),at(),we()}function ti(e){const t=k(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),n=Number.parseFloat(t);return Number.isFinite(n)?n:NaN}function ni(e){const t=Number(e);return!Number.isFinite(t)||t<0?0:Number(t.toFixed(2))}function ud(e){const t=ft(),a=an(t).find(y=>y.key===e);if(!a)return;const{start:s,end:r}=Dt();if(!s||!r){j(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const o=new Set(t.map(y=>Se(y.barcode))),{equipment:i=[]}=Te(),l=(i||[]).find(y=>{const b=Se(y?.barcode);if(!b||o.has(b)||St({desc:y?.desc||y?.description||y?.name||"",price:Number(y?.price)||0})!==e)return!1;const f=_t(y);return f==="maintenance"||f==="retired"?!1:!jt(b,s,r)});if(!l){j(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const d=Se(l.barcode),u=sn(l);if(!u){j(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}ka({id:u,equipmentId:u,barcode:d,desc:l.desc||l.description||l.name||a.description||"",qty:1,price:Number.isFinite(Number(l.price))?Number(l.price):a.unitPrice,cost:Number.isFinite(Number(l.cost))?Number(l.cost):Number.isFinite(Number(l.unit_cost))?Number(l.unit_cost):Number(a.unitCost)||0,image:kn(l)}),at(),we()}function we(){const e=!!document.getElementById("res-project")?.value,t=document.getElementById("res-discount")?.value||"0",n=e?0:parseFloat(k(t))||0,a=document.getElementById("res-discount-type")?.value||"percent",s=e?"percent":a,r=document.getElementById("res-tax"),o=e?!1:r?.checked||!1,i=document.getElementById("res-payment-status"),l=i?.value||"unpaid",{start:d,end:u}=Dt();o&&wt();const y=tn(),b=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),f=Mo(b),v=Oo(m);ds(),Ws({selectedItems:ft(),discount:n,discountType:s,applyTax:o,paidStatus:l,paymentProgressType:f,paymentProgressValue:v,start:d,end:u,companySharePercent:y,paymentHistory:[]});const I=Ws.lastResult;I?(zo(m,I.paymentProgressValue),i&&(i.value=I.paymentStatus,ut(i,I.paymentStatus))):ut(i,l);try{Et()}catch{}}function pd(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",i=>{i.target.value=k(i.target.value),we()}),e.dataset.listenerAttached="true");const t=document.getElementById("res-discount-type");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",we),t.dataset.listenerAttached="true");const n=document.getElementById("res-tax");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{if(ht()){n.checked=!1,j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ts("tax")}),n.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if(ht()){a.checked=!1,j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ts("share")}),a.dataset.listenerAttached="true");const s=document.getElementById("res-payment-status");s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{if(ht()){s.value="unpaid",ut(s,"unpaid"),j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}ut(s),we()}),s.dataset.listenerAttached="true");const r=document.getElementById("res-payment-progress-type");r&&!r.dataset.listenerAttached?(r.dataset.userSelected!=="true"&&(r.value="percent"),r.addEventListener("change",i=>{if(ht()){r.value="percent",j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}r.dataset.userSelected="true",we()}),r.dataset.listenerAttached="true"):r&&r.dataset.userSelected!=="true"&&!r.value&&(r.value="percent");const o=document.getElementById("res-payment-progress-value");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",i=>{if(ht()){o.value="",j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}i.target.value=k(i.target.value),we()}),o.dataset.listenerAttached="true"),we()}function md(){const e=document.getElementById("res-start-time"),t=document.getElementById("res-end-time");if(!e||!t||e.dataset.timeSyncAttached)return;try{const r=document.getElementById("res-start"),o=document.getElementById("res-end");if(r&&!r.dataset.persistAttached){const i=()=>{try{Et()}catch{}},l=()=>{try{at(),we()}catch{}qn()};r.addEventListener("input",i),r.addEventListener("change",i),r.addEventListener("input",l),r.addEventListener("change",l),r.dataset.persistAttached="true"}if(o&&!o.dataset.persistAttached){const i=()=>{try{Et()}catch{}},l=()=>{try{at(),we()}catch{}qn()};o.addEventListener("input",i),o.addEventListener("change",i),o.addEventListener("input",l),o.addEventListener("change",l),o.dataset.persistAttached="true"}}catch{}let n=!1;const a=()=>{const r=e.value?.trim();if(!r){we();return}const o=t.dataset.syncedWithStart;(!t.value?.trim()||o!=="false")&&(n=!0,t.value=r,t.dataset.syncedWithStart="true",t.dataset.syncedValue=r,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n=!1),we();try{at()}catch{}qn()};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),t.addEventListener("input",()=>{if(!n){t.value===e.value?(t.dataset.syncedWithStart="true",t.dataset.syncedValue=t.value):t.dataset.syncedWithStart="false";try{Et()}catch{}try{at(),we()}catch{}qn()}});const s=()=>{try{Et()}catch{}qn()};e.addEventListener("input",s),e.addEventListener("change",s),t.addEventListener("change",s),t.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function vr(){const e=Date.now();et("submit:start",{ts:new Date().toISOString()});const{input:t,hidden:n}=wn(),{input:a,hidden:s}=Bt(),{customers:r}=Te();let o=n?.value?String(n.value):"";if(!o&&t?.value){const V=ba(t.value,{allowPartial:!0});V&&(o=String(V.id),n&&(n.value=o),t.value=V.label,t.dataset.selectedId=o)}const i=r.find(V=>String(V.id)===o);if(!i){et("validation:customer_not_found",{customerValue:o}),j(c("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const l=i.id;let d=s?.value?String(s.value):"";if(!d&&a?.value){const V=es(a.value,{allowPartial:!0});V&&(d=String(V.id),s&&(s.value=d),a.value=V.label,a.dataset.selectedId=d)}const u=document.getElementById("res-start").value,y=document.getElementById("res-end").value,b=document.getElementById("res-start-time")?.value||"00:00",m=document.getElementById("res-end-time")?.value||"00:00";if(!u||!y){et("validation:missing_dates",{startDate:u,endDate:y}),j(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const f=`${u}T${b}`,v=`${y}T${m}`,I=new Date(f),A=new Date(v);if(Number.isNaN(I.getTime())||Number.isNaN(A.getTime())||I>=A){et("validation:invalid_date_range",{start:f,end:v}),j(c("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const w=ds();w.map(V=>V.technicianId).filter(Boolean);const D=ft();if(D.length===0&&w.length===0){et("validation:no_items_or_crew",{items:D.length,crew:w.length}),j(c("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const U=document.getElementById("res-notes")?.value||"",Y=parseFloat(k(document.getElementById("res-discount")?.value))||0,S=document.getElementById("res-discount-type")?.value||"percent",C=document.getElementById("res-payment-status"),q=C?.value||"unpaid",E=document.getElementById("res-payment-progress-type"),Q=document.getElementById("res-payment-progress-value"),B=Mo(E),ne=Oo(Q),F=d?Hs(d):null,W=Yl(F);if(d&&!F){et("validation:project_not_found",{projectIdValue:d}),j(c("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const V of D){const re=_t(V.barcode);if(re==="maintenance"||re==="retired"){et("validation:equipment_unavailable",{barcode:V.barcode,status:re}),j(en(re));return}}const N=[];for(const V of D){const re=Se(V.barcode);if(jt(re,f,v)){const R=V?.desc||V?.name||V?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");N.push({label:k(String(R)),barcode:re})}}if(N.length){et("validation:equipment_conflict",{count:N.length});const V=c("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let re=null;try{const de=Array.from(new Set(N.map(qe=>qe.barcode).filter(Boolean))),$e=new Map;await Promise.all(de.map(async qe=>{const Ae=new URLSearchParams({type:"equipment",id:qe,start:f,end:v}),ke=await At(`/reservations/availability.php?${Ae.toString()}`),Pe=Array.isArray(ke?.conflicts)?ke.conflicts:[],x=Array.from(new Set(Pe.map(se=>se?.reservation_code||(se?.reservation_id!=null?`#${se.reservation_id}`:null)).filter(Boolean)));$e.set(qe,x)})),re=N.map(({label:qe,barcode:Ae})=>{const ke=$e.get(Ae)||[];return ke.length?`${qe} (${ke.join("ØŒ ")})`:qe}).join("ØŒ ")}catch{}const R=re||N.map(de=>de.label).filter(Boolean).map(String).join("ØŒ ");j(`${V}: ${R}`,"warning",6e3);return}const T=[];for(const V of D){if(V?.type!=="package")continue;const re=V.packageId??V.package_id??null;if(re&&zr(re,f,v)){const R=V.desc||V.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let de=[];try{const $e=new URLSearchParams({type:"package",id:String(re),start:f,end:v}),qe=await At(`/reservations/availability.php?${$e.toString()}`),Ae=Array.isArray(qe?.conflicts)?qe.conflicts:[];de=Array.from(new Set(Ae.map(ke=>ke?.reservation_code||(ke?.reservation_id!=null?`#${ke.reservation_id}`:null)).filter(Boolean)))}catch{}T.push({label:k(String(R)),codes:de})}}if(T.length){et("validation:package_conflict",{count:T.length});const V=T.map(({label:R,codes:de})=>de&&de.length?`${R} (${de.join("ØŒ ")})`:R).join("ØŒ "),re=c("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");j(`${re}: ${V}`,"warning",6e3);return}const H=[];for(const V of w){if(!V?.technicianId||!Hr(V.technicianId,f,v))continue;const re=V?.technicianName||V?.positionLabel||String(V.technicianId);let R=[];try{R=Kr(V.technicianId,f,v,null)}catch{}H.push({label:k(String(re)),codes:R})}if(H.length){et("validation:crew_conflict",{count:H.length});const V=c("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),re=H.map(({label:R,codes:de})=>de&&de.length?`${R} (${de.join("ØŒ ")})`:R).join("ØŒ ");j(`${V}: ${re}`);return}const K=document.getElementById("res-tax"),M=document.getElementById("res-company-share"),P=!!d;P?(K&&(K.checked=!1,K.disabled=!0,K.classList.add("disabled"),K.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),M&&(M.checked=!1,M.disabled=!0,M.classList.add("disabled"),M.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),C&&(C.value="unpaid",C.disabled=!0,ut(C,"unpaid"),C.title=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),E&&(E.disabled=!0,E.classList.add("disabled")),Q&&(Q.value="",Q.disabled=!0,Q.classList.add("disabled"))):(K&&(K.disabled=!1,K.classList.remove("disabled"),K.title=""),M&&(M.disabled=!1,M.classList.remove("disabled"),M.title=""),C&&(C.disabled=!1,C.title=""),E&&(E.disabled=!1,E.classList.remove("disabled")),Q&&(Q.disabled=!1,Q.classList.remove("disabled")));const G=P?!1:K?.checked||!1,ie=!!M?.checked;if(!P&&ie!==G){et("validation:company_share_requires_tax",{shareChecked:ie,applyTax:G}),j(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let Z=ie?tn():null;ie&&(!Number.isFinite(Z)||Z<=0)&&(wt(),Z=tn());const me=ie&&G&&Number.isFinite(Z)&&Z>0;G&&wt();const be=ls(D,Y,S,G,w,{start:f,end:v,companySharePercent:me?Z:0}),J=xi(),ge=Rn({totalAmount:be,progressType:B,progressValue:ne,history:[]});Q&&zo(Q,ge.paymentProgressValue);const pe=[];ge.paymentProgressValue!=null&&ge.paymentProgressValue>0&&pe.push({type:ge.paymentProgressType||B,value:ge.paymentProgressValue,amount:ge.paidAmount,percentage:ge.paidPercent,recordedAt:new Date().toISOString()});const Ie=Mn({manualStatus:q,paidAmount:ge.paidAmount,paidPercent:ge.paidPercent,totalAmount:be});C&&(C.value=Ie,ut(C,Ie));const je=typeof F?.paymentStatus=="string"?F.paymentStatus.toLowerCase():null,Be=je&&["paid","partial","unpaid"].includes(je)?je:"unpaid",De=new Map,Ce=new Map,Oe=new Map;document.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(V=>{const re=pt(V.value),R=Number.isFinite(re)&&re>=0?nt(re):null;if(R===null)return;const de=V.dataset.packageIndex;if(de!==void 0&&de!==""){const Ae=Number.parseInt(de,10);if(Number.isInteger(Ae)&&Ae>=0){Ce.set(Ae,R);const ke=D[Ae];if(ke){const Pe=Ra(ke);Pe&&Oe.set(Pe,R)}}}const $e=V.dataset.packageIdentity;if($e){const Ae=rt($e)||k(String($e)).trim().toLowerCase();Ae&&Oe.set(Ae,R)}const qe=V.dataset.groupKey;qe&&De.set(qe,R)});const xe=D.map((V,re)=>{let R=Ce.has(re)?Ce.get(re):void 0;if(R===void 0){const de=Ra(V);de&&(R=Oe.get(de))}if(R===void 0){const de=St(V);de&&(R=De.get(de))}return R===void 0?V:{...V,cost:R,unit_cost:R,rental_cost:R,purchase_price:R,internal_cost:R,equipment_cost:R,package_cost:R,packageCost:R}}),Fe=(()=>{const V=[];xe.forEach((R,de)=>{if(String(R?.type||"").toLowerCase()!=="package")return;const $e=Number.isFinite(Number(R.qty??R.quantity))?Number(R.qty??R.quantity):1,qe=Number.isFinite(Number(R.unit_price??R.price))?Number(R.unit_price??R.price):0;let Ae=Number.isFinite(Number(R.unit_cost??R.cost))?Number(R.unit_cost??R.cost):0;const ke=St(R),Pe=Ra(R),x=(Ce.has(de)?Ce.get(de):void 0)??(Pe?Oe.get(Pe):void 0)??(ke!==void 0?De.get(ke):void 0);x!==void 0&&Number.isFinite(x)&&(Ae=nt(x));const se=x!==void 0?2:Number.isFinite(Ae)&&Ae>0?1:0;V.push({__dedupeKey:Pe??`pkg-${de}`,__priority:se,package_code:R.package_code??R.packageCode??R.barcode??R.code??null,name:R.name??R.desc??R.package_name??null,quantity:$e,unit_price:qe,unit_cost:Ae,package_cost:Ae,packageCost:Ae,cost:Ae,items:Array.isArray(R.packageItems)?R.packageItems:[]})});const re=new Map;return V.forEach(R=>{const de=R.__dedupeKey;(!re.has(de)||(R.__priority??0)>=(re.get(de).__priority??0))&&re.set(de,R)}),Array.from(re.values()).map(R=>{const{__dedupeKey:de,__priority:$e,...qe}=R;return qe})})(),ze=Tr({reservationCode:J,customerId:l,start:f,end:v,status:W?"confirmed":"pending",title:null,location:null,notes:U,projectId:d||null,totalAmount:be,discount:P?0:Y,discountType:P?"percent":S,applyTax:G,paidStatus:P?Be:Ie,confirmed:W,items:xe.map(V=>({...V,equipmentId:V.equipmentId??V.id})),packages:Fe,crewAssignments:w,companySharePercent:P||!me?null:Z,companyShareEnabled:P?!1:me,paidAmount:P?0:ge.paidAmount,paidPercentage:P?0:ge.paidPercent,paymentProgressType:P?null:ge.paymentProgressType,paymentProgressValue:P?null:ge.paymentProgressValue,paymentHistory:P?[]:pe});try{et("submit:payload",{reservationCode:J,customerId:l,projectId:d||null,start:f,end:v,items:xe.length,packages:Fe.length,technicians:w.length,totalAmount:be}),ur("about to submit",{crewAssignments:w,techniciansPayload:ze?.technicians,payload:ze});const V=await Ri(ze);ur("server response",{reservation:V?.id??V?.reservationId??V?.reservation_code,technicians:V?.technicians,crewAssignments:V?.crewAssignments,techniciansDetails:V?.techniciansDetails}),et("submit:success",{reservationId:V?.id??V?.reservationId??V?.reservation_code,durationMs:Date.now()-e}),mr(V)}catch(V){if(console.error("âŒ [reservations/createForm] Failed to create reservation",V),V?.name==="AbortError"){et("submit:abort",{durationMs:Date.now()-e});const R=await Vl({reservationCode:J});if(R){et("submit:recovered",{reservationId:R?.id??R?.reservationId??R?.reservation_code}),mr(R);return}}et("submit:failed",{name:V?.name,message:V?.message,durationMs:Date.now()-e});const re=jr(V)?V.message:c("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");j(re,"error"),P&&(j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),jn({clearValue:!1}))}}function fd(e){if(!Zn)return;const{draftStorageKey:t=To,returnUrl:n=jo}=Zn,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const s=window.sessionStorage.getItem(t),r=s?JSON.parse(s)||{}:{},o=Array.isArray(r.linkedReservationIds)?r.linkedReservationIds:[],i=String(a);o.includes(i)||o.push(i),r.linkedReservationIds=o,window.sessionStorage.setItem(t,JSON.stringify(r))}catch(s){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",s)}Zn=null,n&&(window.location.href=n)}function jn({clearValue:e=!1}={}){const{input:t,hidden:n}=Bt();t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("title"),e&&(t.value="",t.dataset.selectedId="",n&&(n.value="")),t.dataset&&delete t.dataset.pendingLinked,Tt())}function yd(e,t=""){const{input:n,hidden:a}=Bt();n&&(n.disabled=!0,n.classList.add("reservation-input-disabled"),n.setAttribute("aria-disabled","true"),t!=null&&(n.value=t),n.dataset.selectedId="",e&&(n.title=e),n.dataset&&(n.dataset.pendingLinked="true"),a&&(a.value=""),Tt())}function ai(){const e=document.getElementById("res-customer"),t=document.getElementById("res-customer-input");e&&(e.value=""),t&&(t.value="",t.dataset.selectedId=""),vt({selectedValue:"",resetInput:!0});try{Vt("res-start","res-start-time","")}catch{}try{Vt("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const n=document.getElementById("res-project"),a=document.getElementById("res-project-input");n&&(n.value=""),a&&(a.value="",a.dataset.selectedId=""),jn({clearValue:!1}),Kt({selectedValue:"",resetInput:!0});const s=document.getElementById("equipment-description");s&&(s.value="");const r=document.getElementById("res-payment-status");r&&(r.value="unpaid",ut(r,"unpaid"));const o=document.getElementById("res-payment-progress-type");o&&(o.value="percent");const i=document.getElementById("res-payment-progress-value");i&&(i.value=""),Mi(),Kn([]),nc("form-reset"),at(),Tt(),we(),Fo()}function gd(){const e=document.getElementById("reservation-items");if(!e||e.dataset.listenerAttached)return;e.addEventListener("click",n=>{const a=n.target.closest("button[data-action]");if(!a)return;const{action:s,groupKey:r}=a.dataset;if(s==="decrease-group"&&r){id(r);return}if(s==="increase-group"&&r){ud(r);return}if(s==="remove-group"&&r){cd(r);return}});const t=n=>{const a=n.target.closest(".reservation-unit-price-input");if(a){const r=a.dataset.groupKey;r&&ld(r,a.value);return}const s=n.target.closest(".reservation-unit-cost-input");if(s){const r=s.dataset.groupKey;r&&dd(r,s.value)}};e.addEventListener("change",t),e.dataset.listenerAttached="true"}function hd(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let t=null;const n=()=>{if(sa()!=="single")return;const s=e.value;s?.trim()&&(clearTimeout(t),t=null,Wo(s,e))};e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n())});const a=()=>{if(clearTimeout(t),!e.value?.trim()||sa()!=="single")return;const{start:r,end:o}=Dt();!r||!o||(t=setTimeout(()=>{n()},150))};e.addEventListener("input",a),e.addEventListener("change",n),e.dataset.listenerAttached="true"}function bd(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await vr()}),e.dataset.listenerAttached="true");const t=document.getElementById("create-reservation-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async a=>{a.preventDefault(),await vr()}),t.dataset.listenerAttached="true");const n=document.getElementById("clear-reservation-form-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",a=>{a.preventDefault(),ai();try{Fo()}catch{}j(c("reservations.toast.formCleared","ðŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),n.dataset.listenerAttached="true")}function bu({onAfterSubmit:e}={}){Ja=typeof e=="function"?e:null,pn=!0;const{customers:t,projects:n}=Te();Zi(t||[]),vt(),Vs(),Ko(n||[]),Uo({projectsList:n}),Ks(),Ut(),Pa(),td(),Yo(),ei(),md(),pd(),gd(),hd(),bd(),Gl(),Jl(),we(),at();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Et()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}pn=!1}function si(){Ut(),Pa(),Uo(),vt(),Vs(),Ks(),Yo(),ei(),at(),we()}if(typeof document<"u"){const e=()=>{vt(),Kt({projectsList:zs()}),Vs(),Ks(),we()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{Ut()}),document.addEventListener("packages:changed",()=>{Pa(),sa()==="package"&&as("package")})}typeof window<"u"&&(window.getCompanySharePercent=tn);function Wn(e){if(!e)return null;const n=new Date(e).getTime();return Number.isNaN(n)?null:n}function vd(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim();if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const a=n[n.length-1],s=Number.parseInt(a,10);return Number.isFinite(s)?s:null}function Sd(e){const t=[e?.reservationId,e?.reservation_id,e?.id];for(const n of t){const a=vd(n);if(a!==null)return a}return null}function Sr(e,t=0){const n=Sd(e);if(n!=null)return n;const a=Wn(e.createdAt??e.created_at);if(a!=null)return a;const s=Wn(e.updatedAt??e.updated_at);if(s!=null)return s;const r=Wn(e.start);if(r!=null)return r;const o=Wn(e.end);if(o!=null)return o;const i=Number(e.id??e.reservationId);return Number.isFinite(i)?i:Number.isFinite(t)?t:0}function wd({reservations:e=[],filters:t={},customersMap:n,techniciansMap:a,projectsMap:s}){const r=e.map((w,D)=>({reservation:w,index:D})),o=t.searchTerm||"",i=t.searchReservationId||"",l=t.searchCustomerName||"",d=t.searchProjectId||"",u=t.startDate||"",y=t.endDate||"",b=t.status||"",m=Object.prototype.hasOwnProperty.call(t,"customerId")?t.customerId:null,f=Object.prototype.hasOwnProperty.call(t,"technicianId")?t.technicianId:null,v=u?new Date(`${u}T00:00:00`):null,I=y?new Date(`${y}T23:59:59`):null,A=r.filter(({reservation:w})=>{const D=n.get(String(w.customerId)),U=s?.get?.(String(w.projectId)),Y=w.start?new Date(w.start):null,S=Br(w),{effectiveConfirmed:C}=In(w,U);if(m!=null&&String(w.customerId)!==String(m)||f!=null&&!(Array.isArray(w.technicians)?w.technicians.map(ne=>String(ne)):[]).includes(String(f))||b==="confirmed"&&!C||b==="pending"&&C||b==="completed"&&!S)return!1;if(b==="cancelled"){const B=String(w?.status||w?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(B))return!1}if(v&&Y&&Y<v||I&&Y&&Y>I)return!1;if(i){const B=[w.reservationId,w.id,w.reservation_id,w.reservationCode,w.reservation_code,w.code,w.reference,w.referenceNumber,w.reference_number],ne=dt(B.filter(W=>W!=null&&W!=="").map(String).join(" ")).replace(/\s+/g,""),F=i.replace(/\s+/g,"");if(!ne.includes(F))return!1}if(l&&!dt(D?.customerName||w.customerName||"").includes(l))return!1;if(d){const B=[w.projectId,w.project_id,w.projectID,U?.id,U?.projectCode,U?.project_code],ne=dt(B.filter(W=>W!=null&&W!=="").map(String).join(" ")).replace(/\s+/g,""),F=d.replace(/\s+/g,"");if(!ne.includes(F))return!1}if(!o)return!0;const q=w.items?.map?.(B=>`${B.barcode} ${B.desc}`).join(" ")||"",E=(w.technicians||[]).map(B=>a.get(String(B))?.name).filter(Boolean).join(" ");return dt([w.reservationId,D?.customerName||w.customerName,w.notes,q,E,U?.title].filter(Boolean).join(" ")).includes(o)});return A.sort((w,D)=>{const U=Sr(w.reservation,w.index),Y=Sr(D.reservation,D.index);return U!==Y?Y-U:D.index-w.index}),A}function kd({entries:e,customersMap:t,techniciansMap:n,projectsMap:a}){const s=c("reservations.create.summary.currency","SR"),r=c("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),o=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),i=c("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),l=c("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),d=c("reservations.list.crew.separator","ØŒ "),u=c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),y=c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),b=c("reservations.list.status.completed","ðŸ“ Ù…ØºÙ„Ù‚"),m=c("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ"),f=c("reservations.list.payment.paid","ðŸ’³ Ù…Ø¯ÙÙˆØ¹"),v=c("reservations.list.payment.unpaid","ðŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),I=c("reservations.list.payment.partial","ðŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),A=c("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),w=c("reservations.list.actions.close","ðŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),D=c("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),U=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),Y={client:c("reservations.list.labels.client","ðŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:c("reservations.list.labels.project","ðŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:c("reservations.list.labels.start","ðŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:c("reservations.list.labels.end","ðŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:c("reservations.list.labels.cost","ðŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:c("reservations.list.labels.equipment","ðŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:c("reservations.list.labels.crew","ðŸ˜Ž Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:S,index:C})=>{const q=t.get(String(S.customerId)),E=S.projectId?a?.get?.(String(S.projectId)):null,Q=S.id??S.reservationId??S.reservation_code??S.reservationCode??"",B=Br(S),ne=String(S?.status||S?.reservationStatus||"").toLowerCase(),F=ne==="cancelled"||ne==="canceled",W=S.items?.length||0,N=Array.isArray(S.crewAssignments)?S.crewAssignments:[],T=(S.technicians||[]).map(ce=>n.get(String(ce))).filter(Boolean),H=N.length?N.map(ce=>{const le=ce.positionLabel??ce.position_name??ce.role??c("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),We=ce.technicianName??n.get(String(ce.technicianId??""))?.name??null;return We?`${k(le)} (${k(We)})`:k(le)}):T.map(ce=>ce.name),K=H.length?H.join(d):"â€”",M=k(String(S.reservationId??"")),P=S.start?k(Pt(S.start)):"-",G=S.end?k(Pt(S.end)):"-",ie=S.discount??S.discountValue??S.discount_value??S.discountAmount??0,Z=Number.parseFloat(k(String(ie))),me=Number.isFinite(Z)?Z:0,be=S.discountType??S.discount_type??S.discountMode??"percent",J=String(be).toLowerCase()==="amount"?"amount":"percent",ge=!!(S.applyTax??S.apply_tax??S.taxApplied),pe=S.companySharePercent??S.company_share_percent??S.companyShare??S.company_share,Ie=S.companyShareEnabled??S.company_share_enabled??S.companyShareApplied,je=Number.parseFloat(k(String(pe))),De=(Ie===!0||Number.isFinite(je)&&je>0)&&Number.isFinite(je)?je:0;let Ce=0;try{const ce=cs({items:S.items||[],technicianIds:S.technicians||[],crewAssignments:Array.isArray(S.crewAssignments)?S.crewAssignments:[],discount:me,discountType:J,applyTax:ge,start:S.start,end:S.end,companySharePercent:De,groupingSource:S}),le=Number(ce?.finalTotal||0);Ce=Number.isFinite(le)?Number(le.toFixed(2)):0}catch{Ce=0}const Oe=Number.parseFloat(k(String(S.cost??0)))||0,Ke=Ce>0?Ce:Oe,xe=S.paymentHistory||S.payment_history||[],Fe=Rn({totalAmount:Ke,paidAmount:xe.length?0:S.paidAmount,paidPercent:xe.length?0:S.paidPercent,history:xe});let V=Mn({manualStatus:null,paidAmount:Fe.paidAmount,paidPercent:Fe.paidPercent,totalAmount:Ke});if(E)try{const{totalWithTax:ce}=ji(E)||{totalWithTax:0},le=E.paymentHistory||E.payments||[],We=Rn({totalAmount:ce,paidAmount:le.length?0:E.paidAmount,paidPercent:le.length?0:E.paidPercent,history:le}),Ve=Mn({manualStatus:null,paidAmount:We.paidAmount,paidPercent:We.paidPercent,totalAmount:ce});Ve&&(V=Ve)}catch{}const re=V==="paid",R=V==="partial",{effectiveConfirmed:de,projectLinked:$e}=In(S,E),qe=de?"status-confirmed":"status-pending",Ae=re?"status-paid":R?"status-partial":"status-unpaid",ke=re?f:R?I:v;let Pe=`<span class="reservation-chip status-chip ${qe}">${de?u:y}</span>`,x=`<span class="reservation-chip status-chip ${Ae}">${ke}</span>`,se="",oe="";F?(Pe=`<span class="reservation-chip status-chip status-cancelled">${m}</span>`,x="",se=" tile-cancelled"):(se=re?" tile-paid":R?" tile-partial":" tile-unpaid",B&&(se+=" tile-completed",Pe=`<span class="reservation-chip status-chip status-completed">${b}</span>`,x=re?`<span class="reservation-chip status-chip status-completed">${ke}</span>`:`<span class="reservation-chip status-chip ${Ae}">${ke}</span>`,oe=` data-completed-label="${c("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`));let _="";!$e&&!F&&(de?B||(_=`<button class="tile-confirm" data-reservation-index="${C}" data-reservation-id="${Q}" data-action="close">${w}</button>`):_=`<button class="tile-confirm" data-reservation-index="${C}" data-reservation-id="${Q}" data-action="confirm">${A}</button>`);const z=_?`<div class="tile-actions">${_}</div>`:"",g=k(Ke.toFixed(2)),$=k(String(W)),O=S.notes?k(S.notes):i,ee=l.replace("{count}",$),te=S.applyTax?`<small>${r}</small>`:"";let ae=D;return S.projectId&&(ae=E?.title?k(E.title):U),`
      <div class="${_?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${se}"${oe} data-reservation-index="${C}" data-reservation-id="${Q}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${M}</div>
          <div class="tile-badges">
            ${Pe}
            ${x}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${Y.client}</span>
            <span class="tile-value">${q?.customerName||S.customerName||o}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.project}</span>
            <span class="tile-value">${ae}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.start}</span>
            <span class="tile-value tile-inline">${P}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.end}</span>
            <span class="tile-value tile-inline">${G}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.cost}</span>
            <span class="tile-value">${g} ${s} ${te}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.equipment}</span>
            <span class="tile-value">${ee}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${Y.crew}</span>
            <span class="tile-value">${H.length?K:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ðŸ“ ${O}</span>
          </div>
        </div>
        ${z}
      </div>
    `}).join("")}const Bn=8;function wr(e,t){const n=Number.parseInt(e,10);return!Number.isFinite(n)||n<=0?1:Math.min(n,Math.max(1,t))}function kr(e={}){const t=Object.entries(e||{}).map(([n,a])=>[n,a==null?"":String(a)]).sort(([n],[a])=>n.localeCompare(a));return JSON.stringify(t)}function Id(e,t){const a=Math.floor(2.5);let s=Math.max(1,e-a),r=Math.min(t,s+5-1);r-s+1<5&&(s=Math.max(1,r-5+1));const o=[];for(let i=s;i<=r;i+=1)o.push(i);return o}function Ad({currentPage:e,totalPages:t,totalItems:n}){if(t<=1)return"";const a=c("reservations.list.pagination.prev","Ø§Ù„Ø³Ø§Ø¨Ù‚"),s=c("reservations.list.pagination.next","Ø§Ù„ØªØ§Ù„ÙŠ"),r=c("reservations.list.pagination.page","ØµÙØ­Ø© {page}"),o=c("reservations.list.pagination.range","{from}-{to} Ù…Ù† {total}"),i=(e-1)*Bn+1,l=Math.min(n,e*Bn),d=o.replace("{from}",i).replace("{to}",l).replace("{total}",n),u=Id(e,t).map(y=>{const b=r.replace("{page}",y),m=y===e;return`<button type="button" class="reservation-page-btn${m?" is-active":""}" data-page="${y}" aria-label="${b}"${m?' aria-current="page"':""}>${y}</button>`}).join("");return`
    <div class="reservations-pagination" data-total-pages="${t}">
      <div class="reservations-pagination__controls">
        <button type="button" class="reservation-page-nav" data-page="${e-1}" ${e<=1?"disabled":""} aria-label="${a}">â€¹</button>
        <div class="reservation-page-list">${u}</div>
        <button type="button" class="reservation-page-nav" data-page="${e+1}" ${e>=t?"disabled":""} aria-label="${s}">â€º</button>
      </div>
      <div class="reservations-pagination__summary">${d}</div>
    </div>
  `}function Ed({containerId:e="reservations-list",filters:t=null,onShowDetails:n,onConfirmReservation:a,onCloseReservation:s,onReopenReservation:r}={}){const o=yn(),{reservations:i=[],customers:l=[],technicians:d=[],projects:u=[]}=Te(),y=i.map(F=>{const W=Oa(F);return{...W,id:F.id??W.id,reservationId:F.reservationId??F.reservation_id??W.reservationId,reservationCode:F.reservationCode??F.reservation_code??W.reservationCode}}),b=y,m=Array.isArray(o)?o:d||[],f=new Map((u||[]).map(F=>[String(F.id),F])),v=document.getElementById(e);if(!v){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!b||b.length===0){v.innerHTML=`<p>${c("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const I=t||cc(),A=new Map(l.map(F=>[String(F.id),F])),w=new Map(m.map(F=>[String(F.id),F])),D=wd({reservations:y,filters:I,customersMap:A,techniciansMap:w,projectsMap:f});if(D.length===0){v.innerHTML=`<p>${c("reservations.list.noResults","ðŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`,v.dataset.reservationsPage="1",v.dataset.reservationsFilters=kr(I);return}const U=Math.ceil(D.length/Bn),Y=kr(I),C=(v.dataset.reservationsFilters||"")!==Y,q=wr(v.dataset.reservationsPage,U);let E=C?1:q;v.dataset.reservationsFilters=Y;const Q=()=>{v.querySelectorAll('[data-action="details"]').forEach(F=>{const W=Number(F.dataset.reservationIndex),N=F.dataset.reservationId||null;Number.isNaN(W)||F.addEventListener("click",()=>{typeof n=="function"&&n(W,N)})}),v.querySelectorAll('button[data-action="confirm"]').forEach(F=>{const W=Number(F.dataset.reservationIndex),N=F.dataset.reservationId||null;Number.isNaN(W)||F.addEventListener("click",T=>{T.stopPropagation(),typeof a=="function"&&a(W,T,N)})}),v.querySelectorAll('button[data-action="close"]').forEach(F=>{const W=Number(F.dataset.reservationIndex),N=F.dataset.reservationId||null;Number.isNaN(W)||F.addEventListener("click",T=>{T.stopPropagation(),typeof s=="function"&&s(W,T,N)})})},B=()=>{v.querySelectorAll(".reservations-pagination [data-page]").forEach(W=>{const N=Number.parseInt(W.dataset.page,10);Number.isFinite(N)&&W.addEventListener("click",T=>{W.disabled||(T.preventDefault(),T.stopPropagation(),ne(N))})})},ne=F=>{E=wr(F,U),v.dataset.reservationsPage=String(E);const W=(E-1)*Bn,N=D.slice(W,W+Bn),T=kd({entries:N,customersMap:A,techniciansMap:w,projectsMap:f}),H=Ad({currentPage:E,totalPages:U,totalItems:D.length});v.innerHTML=`<div class="reservations-grid">${T}</div>${H}`,Q(),B()};ne(E)}function qd(e,{onEdit:t,onDelete:n,getEditContext:a}={}){const{reservations:s=[],customers:r=[],projects:o=[]}=Te(),i=s.map(I=>{const A=Oa(I);return{...A,id:I.id??A.id,reservationId:I.reservationId??I.reservation_id??A.reservationId,reservationCode:I.reservationCode??I.reservation_code??A.reservationCode}}),l=s[e];if(!l)return j(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;let d=i[e]??Oa(l);const u=r.find(I=>String(I.id)===String(l.customerId)),y=l.projectId?o.find(I=>String(I.id)===String(l.projectId)):null,b=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),f=(I,A=null)=>{if(b){const w=A??(yn()||[]);b.innerHTML=Bi(I,u,w,e,y)}},v=()=>{const I=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},A=document.getElementById("reservation-details-edit-btn");A&&(A.onclick=()=>{I(),typeof t=="function"&&t(e,{reservation:l,customer:u,getEditContext:a})});const w=document.getElementById("reservation-details-delete-btn");w&&(w.onclick=()=>{I(),typeof n=="function"&&n(e,{reservation:l,customer:u})});const D=b?.querySelector('[data-action="open-project"]');D&&y&&D.addEventListener("click",()=>{I();const S=y?.id!=null?String(y.id):"",C=S?`projects.html?project=${encodeURIComponent(S)}`:"projects.html";window.location.href=C});const U=document.getElementById("reservation-details-export-btn");U&&(U.onclick=async S=>{S?.preventDefault?.(),S?.stopPropagation?.(),U.blur();try{await Dl({reservation:l,customer:u,project:y})}catch(C){console.error("âŒ [reservations] export to PDF failed",C),j(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const Y=document.getElementById("reservation-details-checklist-btn");Y&&(Y.onclick=async S=>{S?.preventDefault?.(),S?.stopPropagation?.(),Y.blur();try{await Fl({reservation:l,customer:u,project:y})}catch(C){console.error("âŒ [reservations] export checklist PDF failed",C),j(c("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const S=b?.querySelector("[data-tech-slider]");if(S){const C=S.querySelector("[data-slider-track]"),q=S.querySelector("[data-slider-prev]"),E=S.querySelector("[data-slider-next]");if(C&&(q||E)){const Q=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",B=()=>{const W=C.querySelector(".reservation-technician-card"),N=W&&W.getBoundingClientRect().width||220,T=12,H=Math.max(1,Math.floor(C.clientWidth/(N+T)));return Math.max(N+T,Math.floor(H*(N+T)*.9))},ne=()=>{const W=Math.max(0,C.scrollWidth-C.clientWidth-2),N=C.scrollLeft<=1,T=C.scrollLeft>=W;q&&(q.disabled=N),E&&(E.disabled=T)},F=W=>{const N=B()*W,T=Q?-N:N;C.scrollBy({left:T,behavior:"smooth"})};q?.addEventListener("click",()=>F(-1)),E?.addEventListener("click",()=>F(1)),C.addEventListener("scroll",ne,{passive:!0}),window.addEventListener("resize",ne,{passive:!0}),setTimeout(ne,0)}}}catch{}};if(b&&(f(d),v(),Gr().then(()=>{const I=yn()||[];f(d,I),v()}).catch(()=>{})),Dr(d)){const I=d.id||d.reservationId||d.reservation_code;Fr(I).then(A=>{A&&(d=A,f(d),v())}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function _d(){try{const e=window.__EDIT_RESERVATION_RANGE__;if(e&&typeof e=="object")return{start:typeof e.start=="string"?e.start:null,end:typeof e.end=="string"?e.end:null}}catch{}return{start:null,end:null}}function Ir(e,t){const n=_d(),a={start:e||n.start||null,end:t||n.end||null};try{window.__EDIT_RESERVATION_RANGE__=a}catch{}return a}function rn(){const e=document.getElementById("edit-res-start")?.value?.trim(),t=document.getElementById("edit-res-end")?.value?.trim(),n=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";let s=null,r=null;if(e&&(s=Zt(e,n)||`${e}T${n}`),t&&(r=Zt(t,a)||`${t}T${a}`),!s||!r){const o=Ir(s,r);s=s||o.start,r=r||o.end}else Ir(s,r);return{start:s||null,end:r||null}}function va(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Gs(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function ea(){const{container:e,select:t,hint:n,addButton:a}=Gs();if(!t)return;const s=t.value,r=Mr(),o=c("reservations.create.summary.currency","SR"),i=`<option value="" disabled selected>${c("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,l=r.map(u=>{const y=Number.isFinite(Number(u.price))?Number(u.price):0,b=k(y.toFixed(2)),m=`${u.name} â€” ${b} ${o}`;return`<option value="${va(u.id)}">${va(m)}</option>`}).join("");t.innerHTML=`${i}${l}`;const d=r.length>0;t.disabled=!d,a&&(a.disabled=!d),e&&(e.hidden=!d,e.setAttribute("aria-hidden",d?"false":"true")),n&&(d?(n.textContent=c("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),n.dataset.state="ready"):(n.textContent=c("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),d&&s&&r.some(u=>u.id===s)?t.value=s:t.selectedIndex=0}function Cd(e,{silent:t=!1}={}){const n=String(e??"").trim();if(!n)return t||j(c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:s=[]}=tt(),{start:r,end:o}=rn(),{reservations:i=[]}=Te(),l=a!=null&&i[a]||null,d=l?.id??l?.reservationId??null,u=Jo(n,{existingItems:s,start:r,end:o,ignoreReservationId:d});if(!u.success)return t||j(u.message||c("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),u;const y=[...s,u.package];return kt(a,y),lt(y),ot(),t||j(c("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),u}function Ar(){const{select:e}=Gs();if(!e)return;const t=e.value||"";Cd(t)?.success&&e&&(e.value="",e.selectedIndex=0)}function xd(){const{addButton:e,select:t}=Gs();t&&!t.dataset.langRefreshAttached&&(document.addEventListener("language:changed",ea),document.addEventListener("language:translationsReady",ea),t.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Ar()}),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Ar())}),t.dataset.listenerAttached="true"),ea()}function lt(e=[]){const t=document.getElementById("edit-res-items");if(!t)return;const n=c("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=c("reservations.create.summary.currency","SR"),s=c("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),r=c("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=c("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),i=c("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){t.innerHTML=`<tr><td colspan="7" class="text-center">${n}</td></tr>`,qr(t);return}const{groups:l}=nn({items:e},{preserveOriginalOrder:!0}),d=c("reservations.equipment.table.reorder","Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨");t.innerHTML=l.map(u=>{const y=u.items[0]||{},b=kn(y)||u.image,m=b?`<img src="${b}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ðŸŽ¥</div>',f=String(u?.type||"").toLowerCase()==="package"||u.items.some(P=>P?.type==="package"),v=k(String(u.count)),I=pt(u.unitPrice),A=Number.isFinite(I)?nt(I):0,w=pt(u.unitCost);let D=Number.isFinite(w)?nt(w):0;const U=(()=>{try{const{start:P,end:G}=rn(),ie=typeof fn=="function"?fn(P,G):1;return Number.isFinite(ie)&&ie>0?ie:1}catch{return 1}})(),Y=(()=>{const P=u.count??u.quantity??1;if(typeof P=="number")return Number.isFinite(P)&&P>0?P:1;const G=Number.parseFloat(k(String(P)).replace(/[^0-9.]/g,""));return Number.isFinite(G)&&G>0?G:1})(),S=nt(A*Y*U),C=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${u.key}"
          min="0"
          step="0.01"
          value="${k(String(A))}"
          aria-label="${c("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,q=`edit-unit-cost-${u.key}`,E=(()=>{for(let P=0;P<e.length;P+=1){const G=e[P];if(!(!G||String(G.type||"").toLowerCase()!=="package")&&St(G)===u.key)return P}return null})();if(E!=null&&Number.isInteger(E)&&e[E]){const P=e[E],G=pt(P.unit_cost??P.cost??P.package_cost??P.packageCost);Number.isFinite(G)&&(D=nt(G))}const Q=(()=>{if(!f)return null;const P=[u.packageId,u.package_id,u.packageCode,u.package_code,u.packageDisplayCode,u.barcode,u.key];for(const G of P){if(!G)continue;const ie=rt(G);if(ie)return ie;const Z=k(String(G)).trim().toLowerCase();if(Z)return Z}return null})(),B=Q?`data-package-identity="${Q}"`:"",ne=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${q}"
          data-group-key="${u.key}"
          ${B}
          ${E!=null&&Number.isInteger(E)?`data-package-index="${E}"`:""}
          min="0"
          step="0.01"
          value="${k(String(D))}"
          aria-label="${c("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,F=`${k(S.toFixed(2))} ${a}`,W=`
        <span
          class="reservation-row-handle"
          data-drag-handle="true"
          draggable="true"
          title="${d}"
          aria-label="${d}"
          role="button"
          tabindex="0"
        >
          â‹®â‹®
        </span>
      `,N=u.barcodes.map(P=>k(String(P||""))).filter(Boolean),T=N.length?`<details class="reservation-item-barcodes">
            <summary>${c("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${N.map(P=>`<li>${P}</li>`).join("")}
            </ul>
          </details>`:"";let H="";if(f){const P=new Map,G=Z=>{const me=Number.parseFloat(k(String(Z??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(me)||me<=0||me>99?1:Math.round(me)},ie=[];if(Array.isArray(u.packageItems)&&u.packageItems.length&&ie.push(...u.packageItems),u.items.forEach(Z=>{Array.isArray(Z?.packageItems)&&ie.push(...Z.packageItems)}),ie.forEach(Z=>{if(!Z)return;const me=Se(Z.barcode||Z.normalizedBarcode||Z.desc||Math.random());if(!me)return;const be=P.get(me),J=G(Z.qtyPerPackage??Z.perPackageQty??Z.quantityPerPackage??Z.qty??Z.quantity??1),ge=Math.max(1,Math.min(J,99));if(be){be.qty=ge;return}P.set(me,{desc:Z.desc||Z.barcode||c("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:ge,barcode:Z.barcode??Z.normalizedBarcode??""})}),P.size){const Z=Array.from(P.values()).map(me=>{const be=k(String(me.qty>0?Math.min(me.qty,99):1)),J=va(me.desc||""),ge=me.barcode?` <span class="reservation-package-items__barcode">(${va(k(String(me.barcode)))})</span>`:"";return`<li>${J}${ge} Ã— ${be}</li>`}).join("");H=`
            <details class="reservation-package-items">
              <summary>${c("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${Z}
              </ul>
            </details>
          `}}const K=f?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",M=f?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${u.key}" data-drag-row="true" draggable="true">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-drag">
                ${W}
              </div>
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${u.description||"-"}</div>
                ${f?`${H||""}${T||""}`:T}
              </div>
            </div>
          </td>
          <td>
            <div class="${K}" data-group-key="${u.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${u.key}" aria-label="${o}"${M}>âˆ’</button>
              <span class="reservation-qty-value">${v}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${u.key}" aria-label="${r}"${M}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${k(String(U))}</span></td>
          <td>${C}</td>
          <td>${ne}</td>
          <td>${F}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${u.key}" aria-label="${i}">ðŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Ld(t),qr(t)}function $d(e=[]){if(!Array.isArray(e)||!e.length)return;const{index:t,items:n}=tt();if(!Array.isArray(n)||!n.length)return;const{groups:a}=nn({items:n},{preserveOriginalOrder:!0}),s=new Map;a.forEach(l=>{Array.isArray(l.itemIndices)&&l.itemIndices.length&&s.set(l.key,[...l.itemIndices])});const r=new Set,o=[];if(e.forEach(l=>{const d=s.get(l);!d||!d.length||d.forEach(u=>{r.has(u)||n[u]&&(o.push(n[u]),r.add(u))})}),!o.length||(n.forEach((l,d)=>{r.has(d)||o.push(l)}),o.length!==n.length))return;if(o.every((l,d)=>l===n[d])){lt(n);return}kt(t,o),lt(o),ot()}function Ld(e){if(!e||e.dataset.dragListenerAttached==="true")return;let t=null;const n=()=>Array.from(e.querySelectorAll("tr[data-group-key]")).map(s=>s.dataset.groupKey),a=s=>{const r=e.querySelector("tr[data-group-key].is-dragging");if(r&&r.classList.remove("is-dragging"),!t)return;const o=t.initialOrder||[];if(t=null,!s){lt(tt().items);return}const i=n();if(o.length===i.length&&o.every((d,u)=>d===i[u])){lt(tt().items);return}$d(i)};e.addEventListener("dragstart",s=>{if(s.target.closest("button, input, textarea, select, a[href]")&&!s.target.closest("[data-drag-handle]"))return;const o=s.target.closest("[data-drag-handle], tr[data-group-key]");if(!o)return;const i=o.closest("tr[data-group-key]");if(i){t={key:i.dataset.groupKey,initialOrder:n()},i.classList.add("is-dragging");try{s.dataTransfer?.setData?.("text/plain",i.dataset.groupKey||""),s.dataTransfer.effectAllowed="move"}catch{}}}),e.addEventListener("dragover",s=>{if(!t)return;const r=s.target.closest("tr[data-group-key]"),o=e.querySelector("tr[data-group-key].is-dragging");if(!r||!o||r===o)return;s.preventDefault();const i=r.getBoundingClientRect();s.clientY>i.top+i.height/2?r.after(o):r.before(o)}),e.addEventListener("drop",s=>{t&&(s.preventDefault(),a(!0))}),e.addEventListener("dragend",()=>{t&&a(!1)}),e.dataset.dragListenerAttached="true"}function Nd(e){switch(e){case"amount":return c("reservations.paymentHistory.type.amount","ðŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return c("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return c("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Ta(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let t=ja();const n=document.getElementById("edit-res-project")?.value||"";if(n)try{const o=(Te()?.projects||[]).find(l=>String(l.id)===String(n)),i=Array.isArray(o?.paymentHistory)?o.paymentHistory:Array.isArray(o?.payment_history)?o.payment_history:Array.isArray(o?.payments)?o.payments:Array.isArray(o?.paymentLogs)?o.paymentLogs:[];Array.isArray(i)&&i.length&&(t=i)}catch{}if(!Array.isArray(t)||t.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${c("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Er();return}const a=c("reservations.create.summary.currency","SR"),s=t.map((r,o)=>{const i=Number.isFinite(Number(r?.amount))&&Number(r.amount)>0?`${k(Number(r.amount).toFixed(2))} ${a}`:"â€”",l=Number.isFinite(Number(r?.percentage))&&Number(r.percentage)>0?`${k(Number(r.percentage).toFixed(2))}%`:"â€”",d=r?.recordedAt?k(Pt(r.recordedAt)):"â€”",u=Nd(r?.type),y=r?.note?k(r.note):"";return`
      <tr>
        <td>${u}</td>
        <td>${i}</td>
        <td>${l}</td>
        <td>${d}</td>
        <td>${y}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${o}" aria-label="${c("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ðŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${c("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${c("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${c("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${c("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${s}</tbody>
      </table>
    </div>
  `,Er()}function Pd(){if(Hn()){j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),t=document.getElementById("edit-res-payment-progress-value"),n=ii(e);let a=ci(t);if(!Number.isFinite(a)||a<=0){j(c("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const s=za.lastResult,r=Number(s?.total)||0,o=Number(s?.paidPercent)||0,i=Number(s?.paidAmount)||0,l=c("reservations.create.summary.currency","SR");let d=null,u=null;if(n==="percent"){const b=Math.max(0,100-o);if(b<=1e-4){j(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,b);if(m!==a){const f=k(m.toFixed(2));j(c("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",f)),a=m}u=Number(a.toFixed(2)),r>0&&(d=a/100*r)}else{const b=Math.max(0,r-i);if(b<=1e-4){j(c("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,b);if(m!==a){const f=`${k(m.toFixed(2))} ${l}`;j(c("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",f)),a=m}d=Number(a.toFixed(2)),r>0&&(u=d/r*100)}d!=null&&(d=Number(d.toFixed(2))),u!=null&&(u=Number(u.toFixed(2)));const y={type:n,value:a,amount:d,percentage:u,recordedAt:new Date().toISOString()};Qd(y),Qs(ja()),Ta(),ot(),t&&(t.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),j(c("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Er(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",n=>{if(Hn()){n.preventDefault(),j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Pd()}),e.dataset.listenerAttached="true");const t=document.getElementById("edit-res-payment-history");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",n=>{const a=n.target.closest('[data-action="remove-payment"]');if(!a)return;if(Hn()){n.preventDefault(),j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const s=Number(a.dataset.index);Number.isNaN(s)||(Wd(s),Qs(ja()),Ta(),ot(),j(c("reservations.toast.paymentRemoved","ðŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),t.dataset.listenerAttached="true")}function Td(e){const{index:t,items:n}=tt(),{groups:a}=nn({items:n}),s=a.find(i=>i.key===e);if(!s||s.items.some(i=>i?.type==="package"))return;let r=-1;for(let i=n.length-1;i>=0;i-=1){const l=n[i];if(St(l)===e&&l?.type!=="package"){r=i;break}}if(r<0)return;const o=n.filter((i,l)=>l!==r);kt(t,o),lt(o),ot()}function jd(e){const{index:t,items:n}=tt(),{groups:a}=nn({items:n}),s=a.find(i=>i.key===e);if(!s)return;let r=n.filter(i=>St(i)!==e);if(s.items.some(i=>i&&i.type==="package")){const i=rt(s.packageId??s.items.find(y=>y?.type==="package")?.packageId??""),l=Se(s.package_code??s.packageDisplayCode??s.barcode??"");r=r.filter(y=>{if(!y||typeof y!="object"||y.type!=="package")return!0;const b=rt(y.packageId??y.package_id??y.id??""),m=Se(y.barcode??y.package_code??"");return!(i&&b===i||l&&m&&m===l)});const d=new Set,u=new Set;s.items.forEach(y=>{(Array.isArray(y?.packageItems)?y.packageItems:[]).forEach(m=>{const f=Se(m?.barcode||m?.normalizedBarcode||"");f&&d.add(f);const v=m?.equipmentId??m?.equipment_id??null;v!=null&&u.add(String(v))})}),(d.size||u.size)&&(r=r.filter(y=>{const b=Se(y?.barcode||""),m=y?.equipmentId??y?.id??null;return!(b&&d.has(b)||m!=null&&u.has(String(m)))}))}r.length!==n.length&&(kt(t,r),lt(r),ot())}function Bd(e){const{index:t,items:n}=tt(),{groups:a}=nn({items:n}),s=a.find(I=>I.key===e);if(!s||s.items.some(I=>I?.type==="package"))return;const{start:r,end:o}=rn();if(!r||!o){j(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:i=[]}=Te(),l=t!=null&&i[t]||null,d=l?.id??l?.reservationId??null,u=new Set(n.map(I=>Se(I.barcode))),{equipment:y=[]}=Te(),b=(y||[]).find(I=>{const A=Se(I?.barcode);if(!A||u.has(A)||St({desc:I?.desc||I?.description||I?.name||"",price:Number(I?.price)||0})!==e)return!1;const D=_t(I);return D==="maintenance"||D==="retired"?!1:!jt(A,r,o,d)});if(!b){j(c("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=Se(b.barcode),f=sn(b);if(!f){j(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const v=[...n,{id:f,equipmentId:f,barcode:m,desc:b.desc||b.description||b.name||s.description||"",qty:1,price:Number.isFinite(Number(b.price))?Number(b.price):s.unitPrice,cost:Xt(b),image:kn(b)}];kt(t,v),lt(v),ot()}function Dd(e,t,n=null){const a=pt(t),s=Number.isFinite(a)&&a>=0?nt(a):0,{index:r,items:o}=tt();if(!Array.isArray(o))return;const l=an(o).find(y=>y.key===e);if(!l)return;const d=Number.isInteger(n)?[n]:Array.isArray(l.itemIndices)?l.itemIndices:[];if(!d.length)return;const u=[...o];d.forEach(y=>{if(u[y]){const b={...u[y],cost:s,unit_cost:s,rental_cost:s,purchase_price:s,internal_cost:s,equipment_cost:s};u[y]=b}}),kt(r,u),lt(u),ot()}function Fd(e,t){const n=pt(t),a=Number.isFinite(n)&&n>=0?nt(n):0,{index:s,items:r}=tt();if(!Array.isArray(r))return;const i=an(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const l=[...r];i.itemIndices.forEach(d=>{l[d]&&(l[d]={...l[d],price:a,unit_price:a})}),kt(s,l),lt(l),ot()}function qr(e){if(!e||e.dataset.groupListenerAttached)return;e.addEventListener("click",a=>{const s=a.target.closest("button[data-action]");if(!s)return;const{action:r,groupKey:o,itemIndex:i}=s.dataset;if(r==="decrease-edit-group"&&o){Td(o);return}if(r==="increase-edit-group"&&o){Bd(o);return}if(r==="remove-edit-group"&&o){jd(o);return}if(r==="remove-edit-item"){const l=Number(i);Number.isNaN(l)||Od(l)}});const t=a=>{const s=a.target.closest(".reservation-unit-cost-input");if(!s)return;const r=s.dataset.groupKey;if(!r)return;const o=s.dataset.packageIndex??"",i=o!==""?Number.parseInt(o,10):null;Dd(r,s.value,Number.isInteger(i)?i:null)},n=a=>{const s=a.target.closest(".reservation-unit-price-input");if(!s)return;const r=s.dataset.groupKey;r&&Fd(r,s.value)};e.addEventListener("change",t),e.addEventListener("change",n),e.dataset.groupListenerAttached="true"}function Hn(){return!!document.getElementById("edit-res-project")?.value}function Rd(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const t=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&t.add(a)}e.parentElement&&t.add(e.parentElement);const n=a=>{Hn()&&(j(c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};t.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(s=>a.addEventListener(s,n,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function Md(e){const t=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),n=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),s=document.getElementById("edit-res-paid"),r=document.getElementById("edit-res-payment-progress-type"),o=document.getElementById("edit-res-payment-progress-value"),i=document.getElementById("edit-res-payment-add"),l=document.getElementById("edit-res-payment-history");if([n,a,s,r,o,i,l].forEach(Rd),e){if(n&&(n.checked=!1,n.disabled=!0,n.classList.add("reservation-input-disabled"),n.title=t),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=t),s){const d=document.getElementById("edit-res-project")?.value||"";let u="unpaid";if(d)try{const b=(Te()?.projects||[]).find(f=>String(f.id)===String(d)),m=typeof b?.paymentStatus=="string"?b.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(u=m)}catch{}s.value=u,s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=t,s.dataset&&delete s.dataset.userSelected}r&&(r.value=r.value||"percent",r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=t),o&&(o.value="",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=t),i&&(i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=t),l&&(l.dataset.linkedDisabled="true")}else n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),l&&(l.dataset.linkedDisabled="false")}function ot(){const e=document.getElementById("edit-res-summary");if(!e)return;Ta();const t=document.getElementById("edit-res-discount"),n=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),ut(a),ot()}),a.dataset.listenerAttached="true");const s=k(t?.value||"0");t&&(t.value=s);const r=parseFloat(s)||0,o=n?.value||"percent",i=Hn();Md(i);const l=document.getElementById("edit-res-tax"),d=i?!1:l?.checked||!1,u=!i&&a?.dataset?.userSelected==="true";let y="unpaid";if(i){const D=document.getElementById("edit-res-project")?.value||"";if(D)try{const Y=(Te()?.projects||[]).find(C=>String(C.id)===String(D)),S=typeof Y?.paymentStatus=="string"?Y.paymentStatus.toLowerCase():null;S&&["paid","partial","unpaid"].includes(S)&&(y=S)}catch{}}else y=u&&a?.value||"unpaid";let b=null;!i&&d&&(wt("edit-res-company-share"),b=tn("edit-res-company-share"),(!Number.isFinite(b)||b<=0)&&(wt("edit-res-company-share"),b=tn("edit-res-company-share")));const{items:m=[],payments:f=[]}=tt(),{start:v,end:I}=rn(),A=za({items:m,discount:r,discountType:o,applyTax:d,paidStatus:y,start:v,end:I,companySharePercent:b,paymentHistory:f});e.innerHTML=A;const w=za.lastResult;if(w&&a){const D=w.paymentStatus;u?ut(a,a.value):(a.value!==D&&(a.value=D),a.dataset&&delete a.dataset.userSelected,ut(a,D))}else a&&ut(a,a.value)}function Od(e){if(e==null)return;const{index:t,items:n}=tt();if(!Array.isArray(n))return;const a=n.filter((s,r)=>r!==e);kt(t,a),lt(a),ot()}async function zd(e){const t=e?.value??"",n=Se(t)||k(String(t)).trim().toLowerCase();if(!n)return;const a=is(n);if(!a){j(c("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const s=_t(a);if(s==="maintenance"||s==="retired"){j(en(s));return}const r=Se(n),{index:o,items:i=[]}=tt();if(i.findIndex(A=>Se(A.barcode)===r)>-1){j(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:d,end:u}=rn();if(!d||!u){j(c("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:y=[]}=Te(),b=o!=null&&y[o]||null,m=b?.id??b?.reservationId??null;if(jt(r,d,u,m)){const A=c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),w=hn([r],d,u,m),D=Sn(w,A);j(D);return}const f=sn(a);if(!f){j(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const v=typeof Xt=="function"?Xt(a):Number.isFinite(Number(a?.cost))?Number(a.cost):0,I=[...i,{id:f,equipmentId:f,barcode:r,desc:a.desc,qty:1,price:a.price,cost:v,image:a.image||a.imageUrl||a.img||null}];kt(o,I),e&&(e.value=""),lt(I),ot()}async function Sa(e){if(!e)return;const t=e.value.trim();if(!t)return;const n=Go(t),a=Se(n?.barcode||t)||k(String(n?.barcode||t)).trim().toLowerCase();if(!n||!a){j(c("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const s=_t(n);if(s==="maintenance"||s==="retired"){j(en(s));return}const{start:r,end:o}=rn();if(!r||!o){j(c("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:i,items:l=[]}=tt();if(l.some(I=>Se(I.barcode)===a)){j(c("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:u=[]}=Te(),y=i!=null&&u[i]||null,b=y?.id??y?.reservationId??null;if(jt(a,r,o,b)){const I=c("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"),A=hn([a],r,o,b),w=Sn(A,I);j(w);return}const m=sn(n);if(!m){j(c("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const f=typeof Xt=="function"?Xt(n):Number.isFinite(Number(n?.cost))?Number(n.cost):0,v=[...l,{id:m,equipmentId:m,barcode:a,desc:n.desc,qty:1,price:n.price,cost:f,image:n.image||n.imageUrl||n.img||null}];kt(i,v),lt(v),ot(),e.value=""}function ri(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Sa(e))});const t=()=>{Qo(e.value,"edit-res-equipment-description-options")&&Sa(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",t),e.addEventListener("change",t),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{ot()});const e=()=>{xd()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{ea()})}typeof window<"u"&&(window.getEditReservationDateRange=rn,window.renderEditPaymentHistory=Ta);function Hd(e,t="create"){if(!(!e||!e.value.trim())){if(t==="create"){ns(e);return}Sa(e)}}function vu(){Ut(),ri()}function Kd(e,t){const n=document.getElementById(e);if(n){if(n._flatpickr){if(t){const a=n._flatpickr.config?.dateFormat||"Y-m-d";n._flatpickr.setDate(t,!1,a)}else n._flatpickr.clear();return}n.value=t||""}}let mn=null,gt=[],Ct=[],ss=null,Je={},Ma=!1,_r=!1;function Vd(){if(!_r)try{document.addEventListener("click",e=>{const t=e.target?.closest?.("#save-reservation-changes");if(t){try{if(t.dataset.listenerAttached==="true")return}catch{}try{t.dataset.saving||(t.dataset.saving="true",setTimeout(()=>{try{delete t.dataset.saving}catch{}},1200))}catch{}try{ui(Je).catch(n=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",n)})}catch(n){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",n)}}},!0),_r=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Ud="__DEBUG_CREW__";function Gd(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const t=window.localStorage?.getItem(Ud);if(t&&["1","true","on","yes"].includes(String(t).toLowerCase()))return!0}}catch{}return!1}function Cr(e,t){if(Gd())try{console.log(`ðŸªµ [crew-debug:edit] ${e}`,t)}catch{}}function Dn(e,{disable:t=!1}={}){const n=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),s=document.getElementById("edit-res-confirmed-wrapper"),r=!!e;if(n&&(n.value=r?"true":"false"),a){const o=c("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),i=c("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=r?o:i,a.dataset.state=r?"confirmed":"pending",a.classList.toggle("btn-success",r&&!t),a.classList.toggle("btn-outline-secondary",!r||t),a.disabled=t,a.setAttribute("aria-pressed",r?"true":"false")}s&&s.classList.toggle("is-disabled",t)}function Ln(){return document.getElementById("edit-res-confirmed")?.value==="true"}function tt(){return{index:mn,items:gt,payments:Ct}}function kt(e,t,n=Ct){mn=typeof e=="number"?e:null,gt=Array.isArray(t)?[...t]:[],Ct=Array.isArray(n)?[...n]:[]}function oi(){mn=null,gt=[],Ui(),Ct=[]}function ja(){return[...Ct]}function Qs(e){Ct=Array.isArray(e)?[...e]:[]}function Qd(e){e&&(Ct=[...Ct,e])}function Wd(e){!Number.isInteger(e)||e<0||(Ct=Ct.filter((t,n)=>n!==e))}function ta(e,t=1){const n=Number.parseFloat(k(String(e??"")));return!Number.isFinite(n)||n<=0?t:Math.floor(n)}function Fn(e,t=0){if(e==null||e==="")return t;const n=Number.parseFloat(k(String(e)));return Number.isFinite(n)?Number(n.toFixed(2)):t}function Yd(e={}){if(!e||typeof e!="object")return null;const t=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,n=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(n?Se(n):"");return{equipmentId:t!=null?String(t):null,barcode:n,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:ta(e.qty??e.quantity??e.count??1),price:Fn(e.price??e.unit_price??e.unitPrice??0),cost:Fn(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.purchase_price??0),image:e.image??e.image_url??e.imageUrl??null}}function Jd(e,t=0){if(!e||typeof e!="object")return null;const n=rt(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${t}`)||`pkg-${t}`,a=1,r=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:fs(e)).map(m=>Yd(m)).filter(Boolean),o=e.total_price??e.totalPrice??e.total??null;let i=Fn(e.unit_price??e.unitPrice??e.price??null,0);if((!i||i===0)&&o!=null){const m=Fn(o,0);m>0&&a>0&&(i=Number((m/a).toFixed(2)))}let l=Fn(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??null,0);(!l||l===0)&&r.length&&(l=0);const d=e.package_code??e.packageCode??e.barcode??null,y=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,d,n].find(m=>m!=null&&String(m).trim()!=="")||`Package ${n}`,b=e.image??e.cover??e.thumbnail??r.find(m=>m?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${n}`,type:"package",packageId:n,package_id:n,desc:k(String(y)),name:k(String(y)),qty:a,price:i,cost:l,unit_cost:l,rental_cost:l,purchase_price:l,internal_cost:l,equipment_cost:l,barcode:d,packageItems:r,image:b}}function Xd(e,t=[],n=0){!n||n<=0||t.forEach(a=>{if(!a)return;const s=e.get(a);if(s==null)return;const r=s-n;e.set(a,r>0?r:0)})}function Zd(e={},t=[]){const n=Array.isArray(t)?t.map(d=>({...d})):[],a=new Map;Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(d=>{if(!d||typeof d!="object")return;const u=rt(d.packageId??d.package_id??d.package_code??d.packageCode??d.code??d.id??"");u&&a.set(u,d)});const r=(Array.isArray(e?.packages)?e.packages:[]).map(d=>{const u=rt(d.packageId??d.package_id??d.package_code??d.packageCode??d.code??d.id??"");if(!u||!a.has(u))return d;const y=pt(d.unit_cost??d.unitCost??d.cost??d.rental_cost??d.purchase_price??d.internal_cost??d.equipment_cost??d.item_cost);if(Number.isFinite(y)&&y>0)return d;const b=a.get(u),m=pt(b.unit_cost??b.unitCost??b.cost??b.package_cost??b.rental_cost??b.purchase_price??b.internal_cost??b.equipment_cost??b.item_cost);if(!Number.isFinite(m)||m<=0)return d;const f=nt(m);return{...d,unit_cost:f,unitCost:f,cost:f,rental_cost:d.rental_cost??f,purchase_price:d.purchase_price??f,internal_cost:d.internal_cost??f,equipment_cost:d.equipment_cost??f,item_cost:d.item_cost??f}});if(!r.length)return n;const o=r.map((d,u)=>Jd(d,u)).filter(Boolean);if(!o.length)return n;const i=new Map;o.forEach(d=>{const u=ta(d.qty??d.quantity??1);if(d.barcode){const y=Se(d.barcode);if(y){const b=`package::${y}`;i.set(b,(i.get(b)??0)+u)}}(d.packageItems||[]).forEach(y=>{if(!y)return;const b=u*ta(y.qty??y.quantity??1),m=y.equipmentId??null,f=y.normalizedBarcode||(y.barcode?Se(y.barcode):null);if(m!=null){const v=`equipment::${String(m)}`;i.set(v,(i.get(v)??0)+b)}if(f){const v=`barcode::${f}`;i.set(v,(i.get(v)??0)+b)}})});const l=[];return n.forEach(d=>{if(!d||typeof d!="object"){l.push(d);return}if(d.type==="package"){const w=rt(d.packageId??d.package_id??d.id??"");o.some(U=>U.packageId===w)||l.push({...d});return}const u=ta(d.qty??d.quantity??1),y=sn(d),b=d.barcode?Se(d.barcode):null,m=[];y!=null&&m.push(`equipment::${String(y)}`),b&&m.push(`barcode::${b}`);const f=m.map(w=>i.get(w)??0).filter(w=>w>0);if(!f.length){l.push({...d});return}const v=Math.min(...f);if(v<=0){l.push({...d});return}const I=Math.min(v,u);if(Xd(i,m,I),I>=u)return;const A=u-I;l.push({...d,qty:A,quantity:A})}),[...l,...o.map(d=>({...d}))]}function eu(e,t){return e?typeof t=="function"?t(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function ii(e,t="percent"){const n=e?.value;return n==="amount"||n==="percent"?n:t}function ci(e){if(!e)return null;const t=k(String(e.value||"")).replace("%","").trim();if(!t)return null;const n=Number.parseFloat(t);return!Number.isFinite(n)||n<0?null:n}function tu(e,t){if(e){e.value="";return}}function _n(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function li(e){if(!e||typeof e!="object")return null;const t=e.type==="amount"||e.type==="percent"?e.type:null,n=Number.parseFloat(k(String(e.value??""))),a=Number.parseFloat(k(String(e.amount??""))),s=Number.parseFloat(k(String(e.percentage??""))),r=Number.isFinite(a)?a:t==="amount"&&Number.isFinite(n)?n:null,o=Number.isFinite(s)?s:t==="percent"&&Number.isFinite(n)?n:null,i=t??(Number.isFinite(r)?"amount":Number.isFinite(o)?"percent":null),l=i==="amount"?r??null:i==="percent"?o??null:Number.isFinite(n)?n:null,d=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:i,value:l,amount:Number.isFinite(r)?r:null,percentage:Number.isFinite(o)?o:null,note:e.note??null,recordedAt:d}}function nu(e=[],t=null){const n=document.getElementById("edit-res-project");if(!n)return;const a=c("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),s=c("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),r=t?.projectId?String(t.projectId):"",o=Array.isArray(e)?[...e].sort((l,d)=>String(d.createdAt||d.start||"").localeCompare(String(l.createdAt||l.start||""))):[],i=[`<option value="">${_n(a)}</option>`];o.forEach(l=>{i.push(`<option value="${_n(l.id)}">${_n(l.title||a)}</option>`)}),r&&!o.some(l=>String(l.id)===r)&&i.push(`<option value="${_n(r)}">${_n(s)}</option>`),n.innerHTML=i.join(""),r?n.value=r:n.value=""}function di(){const e=document.getElementById("edit-res-project"),t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),s=document.getElementById("edit-res-discount-type"),r=c("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled"),t.title=r),n&&(n.checked&&(n.checked=!1),n.disabled=!0,n.classList.add("disabled"),n.title=r),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=r),s&&(s.value="percent",s.disabled=!0,s.classList.add("disabled","reservation-input-disabled"),s.title=r);else{if(t){const l=t.disabled;t.disabled=!1,t.classList.remove("disabled"),t.title="",l&&(t.checked=!1)}n&&(n.disabled=!1,n.classList.remove("disabled"),n.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),s&&(s.disabled=!1,s.classList.remove("disabled","reservation-input-disabled"),s.title="")}rs("tax");const i=Je?.updateEditReservationSummary;typeof i=="function"&&i()}function rs(e){const t=document.getElementById("edit-res-tax"),n=document.getElementById("edit-res-company-share");if(!t||!n)return;const a=()=>{const r=Je?.updateEditReservationSummary;typeof r=="function"&&r()};if(Ma){a();return}Ma=!0;const s=()=>{Ma=!1,a()};if(e==="share")if(n.checked){if(n.dataset.companyShare||(n.dataset.companyShare=String(Ht)),t.disabled){n.checked=!1,j(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),s();return}t.checked||(t.checked=!0),wt("edit-res-company-share")}else t.checked&&!t.disabled&&(t.checked=!1);else e==="tax"&&(t.checked?wt("edit-res-company-share"):n.checked&&(n.checked=!1));s()}async function xr(e,{populateEquipmentDescriptionLists:t,setFlatpickrValue:n,splitDateTime:a,renderEditItems:s,updateEditReservationSummary:r,ensureModal:o}={}){const{customers:i,projects:l}=Te();let u=wa()?.[e];if(!u){j(c("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}if(Dr(u))try{const J=await Fr(u.id||u.reservationId||u.reservation_code);J&&(u=J)}catch(J){console.warn("[reservationsEdit] Failed to hydrate reservation packages",J)}Je={...Je,reservation:u,projects:l||[]},t?.(),nu(l||[],u);const y=u.projectId&&l?.find?.(J=>String(J.id)===String(u.projectId))||null,{effectiveConfirmed:b,projectLinked:m}=In(u,y),f=u.items?u.items.map(J=>({...J,equipmentId:J.equipmentId??J.equipment_id??J.id,barcode:Se(J?.barcode)})):[],v=Zd(u,f),A=(Array.isArray(u.paymentHistory)?u.paymentHistory:Array.isArray(u.payment_history)?u.payment_history:[]).map(J=>li(J)).filter(Boolean);kt(e,v,A);const w=c("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),D=i?.find?.(J=>String(J.id)===String(u.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const U=document.getElementById("edit-res-id");U&&(U.value=u.reservationId||u.id);const Y=document.getElementById("edit-res-customer");Y&&(Y.value=D?.customerName||w);const S=typeof a=="function"?a(u.start):{date:"",time:""},C=typeof a=="function"?a(u.end):{date:"",time:""};n?.("edit-res-start",S.date),n?.("edit-res-start-time",S.time),n?.("edit-res-end",C.date),n?.("edit-res-end-time",C.time);const q=(J,ge,pe)=>{if(!J&&pe)return pe;if(!J)return"";const Ie=ge&&ge.length?ge:"00:00";return`${J}T${Ie}`},E=q(S.date,S.time,u.start),Q=q(C.date,C.time,u.end);try{window.__EDIT_RESERVATION_RANGE__={start:E||null,end:Q||null}}catch{}const B=document.getElementById("edit-res-notes");B&&(B.value=u.notes||"");const ne=document.getElementById("edit-res-discount");if(ne){const J=m?0:u.discount??0;ne.value=k(J)}const F=document.getElementById("edit-res-discount-type");F&&(F.value=m?"percent":u.discountType||"percent");const W=u.projectId?!1:!!u.applyTax,N=document.getElementById("edit-res-tax");N&&(N.checked=W);const T=document.getElementById("edit-res-company-share");if(T){const J=u.companySharePercent??u.company_share_percent??u.companyShare??u.company_share??null,ge=J!=null?Number.parseFloat(k(String(J).replace("%","").trim())):NaN,pe=u.companyShareEnabled??u.company_share_enabled??u.companyShareApplied??u.company_share_applied??null,Ie=pe!=null?pe===!0||pe===1||pe==="1"||String(pe).toLowerCase()==="true":Number.isFinite(ge)&&ge>0,je=Ie&&Number.isFinite(ge)&&ge>0?ge:Ht,Be=W||Ie;T.checked=Be,T.dataset.companyShare=String(je)}Dn(b,{disable:m});const H=document.getElementById("edit-res-close-btn"),K=document.getElementById("edit-res-reopen-btn");H&&(H.disabled=!(b&&!m)||String(u.status||"").toLowerCase()==="completed"),K&&(K.disabled=String(u.status||"").toLowerCase()!=="completed");const M=document.getElementById("edit-res-paid"),P=u.paidStatus??(u.paid===!0||u.paid==="paid"?"paid":"unpaid");M&&(M.value=P,M.dataset&&delete M.dataset.userSelected);const G=document.getElementById("edit-res-payment-progress-type"),ie=document.getElementById("edit-res-payment-progress-value");G?.dataset?.userSelected&&delete G.dataset.userSelected,G&&(G.value="percent"),tu(ie);const Z=document.getElementById("edit-res-cancelled");if(Z){const J=String(u?.status||u?.reservationStatus||"").toLowerCase();Z.checked=["cancelled","canceled"].includes(J),Z.checked&&Dn(b,{disable:!0})}let me=Array.isArray(u.crewAssignments)&&u.crewAssignments.length?u.crewAssignments:Array.isArray(u.techniciansDetails)&&u.techniciansDetails.length?u.techniciansDetails:(u.technicians||[]).map(J=>String(J));if(!Array.isArray(me)||me.length===0){const J=zi(u.id??u.reservationId??u.reservation_code??null);Array.isArray(J)&&J.length&&(me=J)}try{await Gr()}catch(J){console.warn("[reservationsEdit] positions load failed (non-fatal)",J)}if(Hi(me),s?.(v),typeof window<"u"){const J=window?.renderEditPaymentHistory;typeof J=="function"&&J()}di(),r?.();const be=document.getElementById("editReservationModal");ss=eu(be,o),ss?.show?.();try{au?.(Je)}catch(J){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",J)}Vd()}async function ui({combineDateTime:e,hasEquipmentConflict:t,hasPackageConflict:n,hasTechnicianConflict:a,updateEditReservationSummary:s,renderReservations:r,populateEquipmentDescriptionLists:o,handleReservationsMutation:i}={}){if(mn===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const l=document.getElementById("edit-res-start")?.value?.trim(),d=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",u=document.getElementById("edit-res-end")?.value?.trim(),y=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",b=document.getElementById("edit-res-notes")?.value||"",m=k(document.getElementById("edit-res-discount")?.value||"0");let f=parseFloat(m)||0,v=document.getElementById("edit-res-discount-type")?.value||"percent";const I=Ln(),A=document.getElementById("edit-res-paid"),w=A?.dataset?.userSelected==="true",D=w&&A?.value||"unpaid",U=document.getElementById("edit-res-payment-progress-type"),Y=document.getElementById("edit-res-payment-progress-value"),S=ii(U),C=ci(Y),q=document.getElementById("edit-res-project")?.value||"",Q=document.getElementById("edit-res-cancelled")?.checked===!0,B=Ki();B.map(_=>_?.technicianId).filter(Boolean);const ne=document.getElementById("edit-res-company-share"),F=document.getElementById("edit-res-tax");if(!l||!u){j(c("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const W=typeof e=="function"?e:(_,z)=>`${_}T${z||"00:00"}`,N=W(l,d),T=W(u,y);if(N&&T&&new Date(N)>new Date(T)){j(c("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const K=wa()?.[mn];if(!K){j(c("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(gt)||gt.length===0&&B.length===0){j(c("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const M=typeof t=="function"?t:()=>!1,P=K.id??K.reservationId;for(const _ of gt){if(_?.type==="package"&&Array.isArray(_.packageItems)){for(const g of _.packageItems){const $=g?.barcode??g?.normalizedBarcode??"";if(!$)continue;const O=_t($);if(O!=="reserved"&&O!=="available"){j(en(O));return}}continue}const z=_t(_.barcode);if(z!=="reserved"&&z!=="available"){j(en(z));return}}{const _=typeof n=="function"?n:()=>!1;for(const z of gt){if(z?.type!=="package")continue;const g=z.packageId??z.package_id??null,$=z.desc||z.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(g&&_(g,N,T,P)){const O=Array.isArray(z?.packageItems)?z.packageItems.map(ae=>Se(ae?.barcode??ae?.normalizedBarcode??"")).filter(Boolean):[];let ee=hn(O,N,T,P);if(!ee.length)try{const ae=new URLSearchParams;ae.set("type","package"),ae.set("id",String(g)),ae.set("start",N),ae.set("end",T),P!=null&&ae.set("ignore",String(P));const he=await At(`/reservations/availability.php?${ae.toString()}`),ce=Array.isArray(he?.conflicts)?he.conflicts:[];ee=Array.from(new Set(ce.map(le=>le?.reservation_code||(le?.reservation_id!=null?`#${le.reservation_id}`:null)).filter(Boolean)))}catch{}const te=ee.length?` (${ee.join("ØŒ ")})`:"";j(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String($))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+te,"warning",-1);return}if(Array.isArray(z?.packageItems)&&z.packageItems.length){const O=(z.packageItems||[]).map(ae=>Se(ae?.barcode??ae?.normalizedBarcode??"")).filter(Boolean),ee=O.length,te=O.filter(ae=>M(ae,N,T,P)).length;if(ee>0&&te>=ee){const ae=(z.packageItems||[]).map(le=>Se(le?.barcode??le?.normalizedBarcode??"")).filter(Boolean);let he=hn(ae,N,T,P);if(!he.length)try{const le=new URLSearchParams;le.set("type","package"),g!=null&&le.set("id",String(g)),le.set("start",N),le.set("end",T),P!=null&&le.set("ignore",String(P));const We=await At(`/reservations/availability.php?${le.toString()}`),Ve=Array.isArray(We?.conflicts)?We.conflicts:[];he=Array.from(new Set(Ve.map(yt=>yt?.reservation_code||(yt?.reservation_id!=null?`#${yt.reservation_id}`:null)).filter(Boolean)))}catch{}const ce=he.length?` (${he.join("ØŒ ")})`:"";j(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String($))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ce,"warning",6e3);return}}}}const G=[];for(const _ of gt){if(_?.type==="package"&&Array.isArray(_.packageItems)){for(const g of _.packageItems){const $=Se(g?.barcode??g?.normalizedBarcode??"");if($&&M($,N,T,P)){const O=g?.desc||g?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");G.push({label:k(String(O)),barcode:$})}}continue}const z=Se(_.barcode);if(M(z,N,T,P)){const g=_?.desc||_?.name||_?.barcode||c("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");G.push({label:k(String(g)),barcode:z})}}if(G.length){const _=c("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let z=null;try{const $=Array.from(new Set(G.map(ee=>ee.barcode).filter(Boolean))),O=new Map;await Promise.all($.map(async ee=>{const te=new URLSearchParams;te.set("type","equipment"),te.set("id",ee),te.set("start",N),te.set("end",T),P!=null&&te.set("ignore",String(P));const ae=await At(`/reservations/availability.php?${te.toString()}`),he=Array.isArray(ae?.conflicts)?ae.conflicts:[],ce=Array.from(new Set(he.map(le=>le?.reservation_code||(le?.reservation_id!=null?`#${le.reservation_id}`:null)).filter(Boolean)));O.set(ee,ce)})),z=G.map(({label:ee,barcode:te})=>{const ae=O.get(te)||[];return ae.length?`${ee} (${ae.join("ØŒ ")})`:ee}).join("ØŒ ")}catch{}const g=z||G.map($=>$.label).filter(Boolean).map(String).join("ØŒ ");j(`${_}: ${g}`,"warning",6e3);return}const ie=typeof n=="function"?n:()=>!1;for(const _ of gt){if(_?.type!=="package")continue;const z=_.packageId??_.package_id??null;if(z&&ie(z,N,T,P)){const g=_.desc||_.packageName||c("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const $=new URLSearchParams;$.set("type","package"),$.set("id",String(z)),$.set("start",N),$.set("end",T),P!=null&&$.set("ignore",String(P));const O=await At(`/reservations/availability.php?${$.toString()}`),ee=Array.isArray(O?.conflicts)?O.conflicts:[],te=Array.from(new Set(ee.map(he=>he?.reservation_code||(he?.reservation_id!=null?`#${he.reservation_id}`:null)).filter(Boolean))),ae=te.length?` (${te.join("ØŒ ")})`:"";j(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String(g))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+ae,"warning",6e3)}catch{j(c("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${k(String(g))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const Z=typeof a=="function"?a:()=>!1,me=[];for(const _ of B){if(!_?.technicianId||!Z(_.technicianId,N,T,P))continue;const z=_?.technicianName||_?.positionLabel||String(_.technicianId);let g=[];try{g=Kr(_.technicianId,N,T,P)}catch{}me.push({label:k(String(z)),codes:g})}if(me.length){const _=c("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),z=me.map(({label:g,codes:$})=>$&&$.length?`${g} (${$.join("ØŒ ")})`:g).join("ØŒ ");j(`${_}: ${z}`,"warning",6e3);return}const be=Array.isArray(Je.projects)&&Je.projects.length?Je.projects:Te().projects||[],J=q&&be.find(_=>String(_.id)===String(q))||null,ge={...K,projectId:q?String(q):null,confirmed:I},{effectiveConfirmed:pe,projectLinked:Ie,projectStatus:je}=In(ge,J);let Be=!!ne?.checked,De=!!F?.checked;if(Ie&&(Be&&(ne.checked=!1,Be=!1),De=!1),!Ie&&Be!==De){j(c("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}De&&(wt("edit-res-company-share"),Be=!!ne?.checked);let Ce=Be?getCompanySharePercent("edit-res-company-share"):null;Be&&(!Number.isFinite(Ce)||Ce<=0)&&(wt("edit-res-company-share"),Ce=getCompanySharePercent("edit-res-company-share"));const Oe=Be&&De&&Number.isFinite(Ce)&&Ce>0,Ke=Ie?!1:De;Ie&&(f=0,v="percent");const xe=ls(gt,f,v,Ke,B,{start:N,end:T,companySharePercent:Oe?Ce:0});let Fe=ja();if(Number.isFinite(C)&&C>0){const _=xe;let z=null,g=null;S==="amount"?(z=C,_>0&&(g=C/_*100)):(g=C,_>0&&(z=C/100*_));const $=li({type:S,value:C,amount:z,percentage:g,recordedAt:new Date().toISOString()});$&&(Fe=[...Fe,$],Qs(Fe)),Y&&(Y.value="")}const ze=Rn({totalAmount:xe,history:Fe}),V=new Map,re=new Map,R=new Map,$e=document.getElementById("editReservationModal")||document,qe=_=>{const z=rt(_.packageId??_.package_id??_.package_code??_.packageCode??_.barcode??_.id??null);if(z)return z;const g=_.package_code??_.packageCode??_.barcode??null;return g?k(String(g)).trim().toLowerCase():null};$e.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(_=>{const z=pt(_.value),g=Number.isFinite(z)&&z>=0?nt(z):null;if(g===null)return;const $=_.dataset.packageIndex;if($!==void 0&&$!==""){const te=Number.parseInt($,10);if(Number.isInteger(te)&&te>=0){re.set(te,g);const ae=gt[te];if(ae){const he=qe(ae);he&&R.set(he,g)}}}const O=_.dataset.packageIdentity;if(O){const te=rt(O)||k(String(O)).trim().toLowerCase();te&&R.set(te,g)}const ee=_.dataset.groupKey;ee&&V.set(ee,g)});const ke=gt.map((_,z)=>{let g=re.has(z)?re.get(z):void 0;if(g===void 0){const $=St(_);$&&(g=V.get($))}return g===void 0?_:{..._,cost:g,unit_cost:g,rental_cost:g,purchase_price:g,internal_cost:g,equipment_cost:g}}),Pe=Mn({manualStatus:D,paidAmount:ze.paidAmount,paidPercent:ze.paidPercent,totalAmount:xe});A&&!w&&(A.value=Pe,A.dataset&&delete A.dataset.userSelected);let x=K.status??"pending";Ie?x=J?.status??je??x:Q?x="cancelled":["completed","cancelled"].includes(String(x).toLowerCase())||(x=I?"confirmed":"pending");const se=(()=>{const _=[];ke.forEach((g,$)=>{if(String(g?.type||"").toLowerCase()!=="package")return;const O=Number.isFinite(Number(g.qty??g.quantity))?Number(g.qty??g.quantity):1,ee=Number.isFinite(Number(g.unit_price??g.price))?Number(g.unit_price??g.price):0;let te=Number.isFinite(Number(g.unit_cost??g.cost))?Number(g.unit_cost??g.cost):0;const ae=St(g),he=qe(g),ce=(re.has($)?re.get($):void 0)??(he?R.get(he):void 0)??(ae!==void 0?V.get(ae):void 0);ce!==void 0&&Number.isFinite(ce)&&(te=nt(ce));const le=ce!==void 0?2:Number.isFinite(te)&&te>0?1:0;_.push({__dedupeKey:he??`pkg-${$}`,__priority:le,package_code:g.package_code??g.packageCode??g.barcode??g.code??null,name:g.name??g.desc??g.package_name??null,quantity:O,unit_price:ee,unit_cost:te,package_cost:te,packageCost:te,cost:te,items:Array.isArray(g.packageItems)?g.packageItems:[]})});const z=new Map;return _.forEach(g=>{const $=g.__dedupeKey;(!z.has($)||(g.__priority??0)>=(z.get($).__priority??0))&&z.set($,g)}),Array.from(z.values()).map(g=>{const{__dedupeKey:$,__priority:O,...ee}=g;return ee})})(),oe=Tr({reservationCode:K.reservationCode??K.reservationId??null,customerId:K.customerId,start:N,end:T,status:x,title:K.title??null,location:K.location??null,notes:b,projectId:q?String(q):null,totalAmount:xe,discount:f,discountType:v,applyTax:Ke,paidStatus:Pe,confirmed:pe,items:ke.map(_=>({..._,equipmentId:_.equipmentId??_.id})),crewAssignments:B,companySharePercent:Oe?Ce:null,companyShareEnabled:Oe,paidAmount:ze.paidAmount,paidPercentage:ze.paidPercent,paymentProgressType:ze.paymentProgressType,paymentProgressValue:ze.paymentProgressValue,paymentHistory:Fe,packages:se});try{Cr("about to submit",{editingIndex:mn,crewAssignments:B,techniciansPayload:oe?.technicians,payload:oe});const _=await Vi(K.id||K.reservationId,oe);Cr("server response",{reservation:_?.id??_?.reservationId??_?.reservation_code,technicians:_?.technicians,crewAssignments:_?.crewAssignments,techniciansDetails:_?.techniciansDetails}),await Pr(),ys(),yn(),ac(),j(c("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),s?.(),oi(),i?.({type:"updated",reservation:_}),r?.(),o?.(),ss?.hide?.()}catch(_){console.error("âŒ [reservationsEdit] Failed to update reservation",_);const z=jr(_)?_.message:c("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");j(z,"error")}}function au(e={}){Je={...e};const{updateEditReservationSummary:t,addEquipmentToEditingReservation:n,addEquipmentByDescription:a,renderEditItems:s}=Je,r=document.getElementById("edit-res-discount");r&&!r.dataset.listenerAttached&&(r.addEventListener("input",()=>{r.value=k(r.value),t?.()}),r.dataset.listenerAttached="true");const o=document.getElementById("edit-res-discount-type");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>t?.()),o.dataset.listenerAttached="true");const i=document.getElementById("edit-res-tax");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{rs("tax")}),i.dataset.listenerAttached="true");const l=document.getElementById("edit-res-company-share");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{rs("share")}),l.dataset.listenerAttached="true");const d=document.getElementById("edit-res-payment-progress-type");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{d.dataset.userSelected="true",t?.()}),d.dataset.listenerAttached="true");const u=document.getElementById("edit-res-payment-progress-value");u&&!u.dataset.listenerAttached&&(u.addEventListener("input",()=>{u.value=k(u.value)}),u.dataset.listenerAttached="true");const y=["edit-res-start","edit-res-end"],b=["edit-res-start-time","edit-res-end-time"],m=S=>{const C=document.getElementById(S);if(!C||C.dataset.editDateListenerAttached==="true")return;const q=()=>{try{t?.()}catch{}try{const E=typeof tt=="function"?tt().items:[];s?.(E)}catch{}};C.addEventListener("input",q),C.addEventListener("change",q),C.dataset.editDateListenerAttached="true"};y.forEach(m),b.forEach(m),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const f=document.getElementById("edit-res-project");f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>{di();const S=Array.isArray(Je.projects)&&Je.projects.length?Je.projects:Te().projects||[],C=f.value&&S.find(ne=>String(ne.id)===String(f.value))||null,E={...Je?.reservation??{},projectId:f.value||null,confirmed:Ln()},{effectiveConfirmed:Q,projectLinked:B}=In(E,C);Dn(Q,{disable:B}),t?.()}),f.dataset.listenerAttached="true");const v=document.getElementById("edit-res-confirmed-btn");v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{if(v.disabled)return;const S=!Ln();Dn(S);const C=document.getElementById("edit-res-close-btn");C&&(C.disabled=!S),t?.()}),v.dataset.listenerAttached="true");const I=document.getElementById("edit-res-cancelled");I&&!I.dataset.listenerAttached&&(I.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&Dn(Ln(),{disable:I.checked});const C=document.getElementById("edit-res-close-btn");C&&(C.disabled=I.checked||!Ln()),t?.()}),I.dataset.listenerAttached="true");const A=document.getElementById("save-reservation-changes");A&&!A.dataset.listenerAttached&&(A.addEventListener("click",()=>{ui(Je).catch(S=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",S)})}),A.dataset.listenerAttached="true");const w=document.getElementById("edit-res-close-btn");w&&!w.dataset.listenerAttached&&(w.addEventListener("click",()=>{try{const{index:S}=tt(),C=document.getElementById("closeReservationModal"),q=document.getElementById("close-reservation-notes"),E=document.getElementById("close-reservation-submit"),Q=document.getElementById("edit-res-notes")?.value||"";if(q&&(q.value=Q),E&&E.__tmpCloseListener&&(E.removeEventListener("click",E.__tmpCloseListener),E.__tmpCloseListener=null),E){const B=async()=>{const ne=q?.value||"";try{await Lr(S,ne,{onAfterChange:Je?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(C)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(C))?.hide?.()}catch{}}};E.__tmpCloseListener=B,E.addEventListener("click",B,{once:!0})}C&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(C).show()}catch(S){console.warn("[reservationsEdit] failed to open close modal",S)}}),w.dataset.listenerAttached="true");const D=document.getElementById("edit-res-reopen-btn");D&&!D.dataset.listenerAttached&&(D.addEventListener("click",async()=>{try{const{index:S}=tt();await Nr(S,{onAfterChange:Je?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{D.disabled=!0}catch{}}catch(S){console.warn("[reservationsEdit] failed to reopen reservation",S)}}),D.dataset.listenerAttached="true");const U=document.getElementById("edit-res-equipment-barcode");if(U&&!U.dataset.listenerAttached){let S=null;const C=()=>{U.value?.trim()&&(clearTimeout(S),S=null,n?.(U))};U.addEventListener("keydown",E=>{E.key==="Enter"&&(E.preventDefault(),C())});const q=()=>{if(clearTimeout(S),!U.value?.trim())return;const{start:E,end:Q}=getEditReservationDateRange();!E||!Q||(S=setTimeout(()=>{C()},150))};U.addEventListener("input",q),U.addEventListener("change",C),U.dataset.listenerAttached="true"}ri?.();const Y=document.getElementById("editReservationModal");Y&&!Y.dataset.cleanupAttached&&(Y.addEventListener("hidden.bs.modal",()=>{oi(),t?.(),s?.([])}),Y.dataset.cleanupAttached="true")}function Su(){return ic().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=Te()||{};Gi(e||[]),si()})}function Gn(e=null){si(),pi(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const t=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",t))}function su(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function os(){return{populateEquipmentDescriptionLists:Ut,setFlatpickrValue:Kd,splitDateTime:Vr,renderEditItems:lt,updateEditReservationSummary:ot,addEquipmentByDescription:Hd,addEquipmentToEditingReservation:zd,addEquipmentToEditingByDescription:Sa,combineDateTime:Zt,hasEquipmentConflict:jt,hasTechnicianConflict:Hr,renderReservations:pi,handleReservationsMutation:Gn,ensureModal:su}}function pi(e="reservations-list",t=null){Ed({containerId:e,filters:t,onShowDetails:mi,onConfirmReservation:yi,onCloseReservation:ru,onReopenReservation:gi})}function mi(e){return qd(e,{getEditContext:os,onEdit:(t,{reservation:n})=>{bi(t,n)},onDelete:fi})}function fi(e){return $i()?window.confirm(c("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?Di(e,{onAfterChange:Gn}):!1:(Li(),!1)}function yi(e){return Fi(e,{onAfterChange:Gn})}function gi(e){return Nr(e,{onAfterChange:Gn})}let na=null,aa=null;function hi(){const e=document.getElementById("closeReservationModal"),t=document.getElementById("close-reservation-notes"),n=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:t,submit:n,cancel:a}}function ru(e,t=null,n=null){na=e,aa=n??null;const{modal:a,note:s}=hi();s&&(s.value=""),a&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(a).show()}function ou(){const{modal:e,note:t,submit:n,cancel:a}=hi();e&&(n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async()=>{const s=t?.value||"";try{await Lr(na,s,{onAfterChange:Gn,reservationId:aa})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}na=null,aa=null}}),n.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{na=null,aa=null}),a.dataset.listenerAttached="true"))}function bi(e,t=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",r)}xr(e,os());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",r)}xr(e,os());return}const n=new URLSearchParams;if(t?.id||t?.reservationId){const r=t.id??t.reservationId;n.set("reservationEditId",String(r));try{localStorage.setItem("pendingReservationEditId",String(r)),localStorage.removeItem("pendingReservationEditIndex")}catch(o){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",o)}}else{n.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(r){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",r)}}Ni({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(r=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",r)});const a=n.toString(),s=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=s}function wu(){sc({showReservationDetails:mi,deleteReservation:fi,confirmReservation:yi,openReservationEditor:bi,reopenReservation:gi});try{ou()}catch{}}export{wu as a,gu as b,vu as c,pi as d,hu as e,si as f,os as g,Gn as h,bu as i,we as j,mi as k,Su as l,fi as m,yi as n,bi as o,Et as p,Kd as q,Yr as r,au as s,ot as u};
