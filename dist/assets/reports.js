import{t as ve,n as T,e as Y,d as we,b as P,A as xe}from"./auth.js";import{ag as De,m as re,o as Se,z as Ce,e as ke,x as Te,a5 as Ae,a6 as Ee,a4 as J}from"./reservationsService.js";import{m as se}from"./dashboard.js";import{U as Le,V as Pe,W as Me,X as Re}from"./controller.js";/* empty css     */import"./dashboardShell.js";import"./customers.js";const n={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function Ne(e){n.callbacks.onRender=typeof e=="function"?e:null}function Ie(e){n.callbacks.onBeforeRender=typeof e=="function"?e:null}function $e(e){n.callbacks.onAfterRender=typeof e=="function"?e:null}function Be(e){n.callbacks.onTrendDrilldown=typeof e=="function"?e:null}function Fe(e){n.callbacks.onStatusDrilldown=typeof e=="function"?e:null}function je(e){n.callbacks.onPaymentDrilldown=typeof e=="function"?e:null}function d(e,t,a=t){const o=Y()==="en"?a??t:t;return ve(e,o)}function V(){n.formatters.cachedLocale=null,n.formatters.numberFormatter=null}function K(){return(Y()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function _e(){const e=Y();if(e!==n.formatters.cachedLocale||!n.formatters.numberFormatter){n.formatters.cachedLocale=e;const t=K();n.formatters.numberFormatter=new Intl.NumberFormat(t,{maximumFractionDigits:0})}return{numberFormatter:n.formatters.numberFormatter}}function w(e){const{numberFormatter:t}=_e(),a=t.format(Math.round(e||0));return T(a)}function D(e){return`${w(e)} SR`}function H(e){const t=e instanceof Date?e:new Date(e);if(!(t instanceof Date)||Number.isNaN(t.getTime()))return"";const a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${a}-${s}-${o}`}function He(e){if(!e)return"â€”";const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"â€”";const a=new Intl.DateTimeFormat(K(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return T(a.format(t))}function qe(e){return new Intl.DateTimeFormat(K(),{month:"short"}).format(e)}function oe(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ce(e={}){const t=String(e?.barcode??"").trim(),a=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:a,description:a,name:e?.name??a,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function ie(e={}){const t=e?.title??e?.name??"",a=e?.project_code??e?.projectCode??"",s=e?.status??"",o=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:a,status:s,confirmed:o}}function ze(){let e;try{e=we()}catch(l){return console.warn("âš ï¸ [reports] Failed to access cached data",l),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:a=[],equipment:s=[],technicians:o=[],projects:r=[],maintenance:c=[]}=e;return t.length||a.length||s.length||o.length||r.length?(n.data.reservations=Array.isArray(t)?t.map(De):[],n.data.customers=Array.isArray(a)?a.map(oe):[],n.data.equipment=Array.isArray(s)?s.map(ce):[],n.data.technicians=Array.isArray(o)?o.map(re):[],n.data.projects=Array.isArray(r)?r.map(ie):[],n.data.projectsMap=new Map(n.data.projects.map(l=>[l.id,l])),n.data.maintenance=Array.isArray(c)?c.map(se):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(l=>[String(l.id),l])),!0):!1}async function le({silent:e=!1}={}){if(!n.loading){n.loading=!0,n.errorMessage="",e||n.callbacks.onBeforeRender?.();try{const[t,a,s,o,r,c]=await Promise.all([P("/reservations/?limit=500"),P("/customers/?limit=500"),P("/equipment/?limit=500"),P("/technicians/?limit=500"),P("/projects/?limit=500"),P("/maintenance/?limit=500")]);n.data.reservations=Array.isArray(t?.data)?t.data.map(i=>Se(i)):[],n.data.customers=Array.isArray(a?.data)?a.data.map(oe):[],n.data.equipment=Array.isArray(s?.data)?s.data.map(ce):[],n.data.technicians=Array.isArray(o?.data)?o.data.map(re):[],n.data.projects=Array.isArray(r?.data)?r.data.map(ie):[],n.data.projectsMap=new Map(n.data.projects.map(i=>[i.id,i])),n.data.maintenance=Array.isArray(c?.data)?c.data.map(se):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(i=>[String(i.id),i]))}catch(t){console.error("âŒ [reports] Failed to load reports data",t),n.errorMessage=t instanceof xe?t.message:d("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!n.data.projectsMap||!(n.data.projectsMap instanceof Map))&&(n.data.projectsMap=new Map)}finally{n.loading=!1,e||n.callbacks.onAfterRender?.()}}}const Ye=new Map([["confirmed","confirmed"],["Ù…Ø¤ÙƒØ¯","confirmed"],["Ù…Ø¤ÙƒØ¯Ø©","confirmed"],["approved","confirmed"],["pending","pending"],["Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","pending"],["ØºÙŠØ± Ù…Ø¤ÙƒØ¯","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["Ù…Ù†ØªÙ‡ÙŠ","completed"],["Ù…Ù†ØªÙ‡ÙŠØ©","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["Ù…Ù„ØºÙŠ","cancelled"]]),ee=new Map([["paid",!0],["Ù…Ø¯ÙÙˆØ¹",!0],["Ù…Ø¯ÙÙˆØ¹Ø©",!0],["ØªÙ… Ø§Ù„Ø¯ÙØ¹",!0],["completed",!0],["unpaid",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",!1],["pending",!1],["Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",!1]]),Oe=1440*60*1e3;function ue(e){return T(String(e||"")).toLowerCase().trim()}function q(e){return(e||"").toString().trim()}function Ve(e,t){if(!e||!t)return 1;const a=new Date(e),s=new Date(t);if(Number.isNaN(a.getTime())||Number.isNaN(s.getTime()))return 1;const o=s.getTime()-a.getTime();return o<=0?1:Math.max(1,Math.ceil(o/Oe))}function $(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;Ve(e.start,e.end);const t=Number(e.discount??e.discountValue??0)||0,a=e.discountType||e.discount_type||"percent",s=String(a).toLowerCase()==="amount"?"amount":"percent",o=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1",r=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,c=r!=null?Ae(r):Number.NaN,l=(e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null)===!0&&Number.isFinite(c)&&c>0?c:null,m=Array.isArray(e.crewAssignments)?e.crewAssignments:[],u=m.length?m.map(b=>b?.technicianId).filter(Boolean):Array.isArray(e.technicians)?e.technicians:[],p=Ee({items:Array.isArray(e.items)?e.items:[],technicianIds:u,crewAssignments:m,discount:t,discountType:s,applyTax:o,start:e.start,end:e.end,companySharePercent:l}),f=Number(e.cost);let h=p.finalTotal,g=p.taxAmount;if(Number.isFinite(f)&&f>0&&(h=J(f),o)){const b=h-p.taxableAmount;Number.isFinite(b)&&b>=0&&(g=J(b))}const v={rentalDays:p.rentalDays,equipmentTotal:p.equipmentTotal,crewTotal:p.crewTotal,crewCostTotal:p.crewCostTotal,discountAmount:p.discountAmount,subtotalAfterDiscount:p.subtotalAfterDiscount,taxableAmount:p.taxableAmount,taxAmount:g,finalTotal:h,companySharePercent:p.companySharePercent,companyShareAmount:p.companyShareAmount,netProfit:p.netProfit,companyShareEnabled:p.companySharePercent>0};return e.__financials=v,v}function de(e){return e?.projectId&&n.data.projectsMap.get(String(e.projectId))||null}function te(e=""){const t=String(e).toLowerCase().trim();return t?Ye.get(t)||t:""}function Ue(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const a of t){const s=String(a||"").toLowerCase().trim();if(s&&ee.has(s))return ee.get(s)}return e?.paid===!0||e?.paid==="true"}function N(e){const t=de(e),a=ke(e,t),s=te(a.projectStatus);let o=te(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");a.projectLinked&&s&&(o=s),(!o||o==="cancelled")&&(o=a.effectiveConfirmed?"confirmed":"pending"),(Te(e)||s==="completed")&&(o="completed");const r=a.effectiveConfirmed||o==="confirmed"||o==="completed";r&&o!=="completed"&&(o="confirmed");const c=Ue(e),i=e?.paidStatus??e?.paid_status??(c?"paid":"unpaid");return{statusValue:o,confirmed:r,paid:c,paidStatus:i}}function Xe(e){const t=e.length;let a=0,s=0,o=0,r=0,c=0,i=0,l=0,m=0,u=0;e.forEach(f=>{const{statusValue:h,confirmed:g,paid:v}=N(f);h==="completed"&&(s+=1),g&&(a+=1),v&&(o+=1);const b=$(f);r+=b.finalTotal,c+=b.companyShareAmount,i+=b.taxAmount,l+=b.crewTotal,m+=b.crewCostTotal??0,u+=b.netProfit});const p=t?r/t:0;return{total:t,confirmed:a,completed:s,paidCount:o,revenue:r,average:p,companyShareTotal:c,taxTotal:i,crewTotal:l,crewCostTotal:m,netProfit:u}}function pe({range:e,start:t,end:a}){const s=new Date;if(s.setHours(23,59,59,999),e==="custom"){const c=t?new Date(`${t}T00:00:00`):null,i=a?new Date(`${a}T23:59:59`):null;return{startDate:ne(c)?c:null,endDate:ne(i)?i:null}}let o=new Date(s),r=null;switch(e){case"last30":{r=new Date(s),r.setDate(r.getDate()-29);break}case"thisWeek":{const c=new Date(s),l=(c.getDay()-6+7)%7;c.setDate(c.getDate()-l),c.setHours(0,0,0,0);const m=new Date(c);m.setDate(c.getDate()+6),m.setHours(23,59,59,999),r=c,o=m;break}case"thisMonth":{r=new Date(s.getFullYear(),s.getMonth(),1),o=new Date(s.getFullYear(),s.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const c=Math.floor(s.getMonth()/3);r=new Date(s.getFullYear(),c*3,1),o=new Date(s.getFullYear(),(c+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{r=new Date(s.getFullYear(),0,1),o=new Date(s.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:r=null,o=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:o}}function ne(e){return e instanceof Date&&!Number.isNaN(e.getTime())}function We(e,t){const{startDate:a,endDate:s}=pe(t);let o=0;const r=[];return(e||[]).forEach(c=>{if(!c)return;const i=typeof c.repairCost=="number"?c.repairCost:Number.parseFloat(T(String(c.repairCost??"")));if(!Number.isFinite(i)||i<=0)return;const l=String(c.statusRaw??c.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const u=c.resolvedAt??c.resolved_at??null,p=c.reportedAt??c.reported_at??null,f=c.createdAt??c.created_at??null,h=u?new Date(u):null,g=p?new Date(p):f?new Date(f):null,v=h&&!Number.isNaN(h.getTime())?h:g&&!Number.isNaN(g.getTime())?g:null;if(v&&(a&&v<a||s&&v>s))return;const b=Math.round(i*100)/100;o+=b,r.push({id:c.id,cost:b,date:v})}),{total:o,items:r}}function Ke(e,t){const a=Number.isFinite(t)?t:0;return{...e,maintenanceExpense:a,netProfit:(e.netProfit||0)-a}}function Ge(e){const t=new Date,a=[];for(let s=5;s>=0;s-=1){const o=new Date(t.getFullYear(),t.getMonth()-s,1),r=o.getFullYear(),c=o.getMonth(),i=e.filter(v=>{const b=v?.start?new Date(v.start):null;return b&&b.getFullYear()===r&&b.getMonth()===c}),l=i.length;let m=0,u=0,p=0;i.forEach(v=>{const b=$(v);m+=b.finalTotal,u+=b.netProfit,p+=b.companyShareAmount});const f=qe(o),h=new Date(o.getFullYear(),o.getMonth(),1),g=new Date(o.getFullYear(),o.getMonth()+1,0);a.push({label:f,count:l,revenue:m,netProfit:u,companyShare:p,periodStart:h,periodEnd:g,startInput:H(h),endInput:H(g)})}return a}function Qe(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(c=>{const{statusValue:i,confirmed:l}=N(c);i==="completed"?t.completed+=1:i==="confirmed"||l?t.confirmed+=1:t.pending+=1});const a=Math.max(1,(e||[]).length),s=t.confirmed,o=t.pending,r=t.completed;return[{label:d("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),value:s,percent:Math.round(s/a*100)||0,rawCount:s,className:"status-confirmed",filterKey:"confirmed"},{label:d("reservations.reports.status.pendingLabel","Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","Pending confirmation"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:d("reservations.reports.status.completedLabel","Ù…Ù†ØªÙ‡ÙŠØ©","Completed"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-completed",filterKey:"completed"}]}function Ze(e){const t=e.length||1,a=e.filter(o=>N(o).paid).length,s=e.length-a;return[{label:d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-paid",filterKey:"paid"},{label:d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid"),value:s,percent:Math.round(s/t*100)||0,rawCount:s,className:"status-unpaid",filterKey:"unpaid"}]}function Je(e,t){const a=new Map,s=new Map((t||[]).map(o=>[String(o.id),o]));return e.forEach(o=>{const r=String(o?.customerId??"unknown"),c=a.get(r)||{count:0,revenue:0},i=$(o);c.count+=1,c.revenue+=i.finalTotal,a.set(r,c)}),Array.from(a.entries()).map(([o,r])=>({name:s.get(o)?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),count:r.count,revenue:r.revenue})).sort((o,r)=>r.revenue-o.revenue).slice(0,5)}function et(e,t){const a=new Map,s=new Map((t||[]).map(r=>[q(r?.barcode),r])),o=d("reservations.reports.topEquipment.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…","Unnamed equipment");return e.forEach(r=>{(r?.items||[]).forEach(c=>{const i=q(c?.barcode),l=i?s.get(i):null,m=c?.desc||c?.description||c?.name||l?.desc||l?.description||l?.name||"",u=m&&m.trim()?m:o,p=Ce(u)||"unknown",f=Number(c?.qty)||1,h=Number(c?.price)||0,g=f*h,v=a.get(p)||{name:u,count:0,revenue:0};v.name=u,v.count+=f,v.revenue+=g,a.set(p,v)})}),Array.from(a.values()).sort((r,c)=>c.count!==r.count?c.count-r.count:c.revenue-r.revenue).slice(0,5)}function tt(e,t,a,s,o){const r=[],c=e?.reservationId||e?.id;c&&r.push(c),e?.notes&&r.push(e.notes);const{statusValue:i,paidStatus:l}=N(e);i&&r.push(i);const m=e?.paymentStatus||e?.payment_status;m&&r.push(m),e?.paid!=null&&r.push(e.paid?"paid":"unpaid"),l&&r.push(l);const u=a.get(String(e?.customerId));u&&r.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const p=de(e);return p&&r.push(p.title,p.code,p.status),r.push(me(l)),(e?.items||[]).forEach(h=>{h?.desc&&r.push(h.desc),h?.barcode&&r.push(h.barcode);const g=s.get(q(h?.barcode));g&&r.push(g.desc,g.description,g.name)}),(e?.technicians||[]).forEach(h=>{const g=o.get(String(h));g&&r.push(g.name,g.role,g.department)}),ue(r.filter(Boolean).join(" ")).includes(t)}function nt(e,t,a,s,o){const{startDate:r,endDate:c}=pe(t),i=ue(t.search),l=!!i,m=new Map((a||[]).map(f=>[String(f.id),f])),u=new Map((s||[]).map(f=>[q(f?.barcode),f])),p=new Map((o||[]).map(f=>[String(f.id),f]));return(e||[]).filter(f=>{const h=f?.start?new Date(f.start):null;if(!h||Number.isNaN(h.getTime())||r&&h<r||c&&h>c)return!1;const{statusValue:g,confirmed:v,paid:b}=N(f);if(t.status==="confirmed"&&!(g==="confirmed"||g==="completed"||v)||t.status==="pending"&&g!=="pending"||t.status==="completed"&&g!=="completed"||t.payment==="paid"&&!b||t.payment==="unpaid"&&b)return!1;if(t.share&&t.share!=="all"){const E=$(f).companySharePercent>0;if(t.share==="with"&&!E||t.share==="without"&&E)return!1}return!(l&&!tt(f,i,m,u,p))})}function me(e){const t=String(e??"").toLowerCase();return t==="paid"?d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"):t==="partial"?d("reservations.reports.payment.partialLabel","Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹","Partially paid"):d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid")}function G(e){if(n.loadedScripts.has(e))return n.loadedScripts.get(e);const t=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,a=new Promise((s,o)=>{const r=()=>{t&&(t.dataset.loaded="true"),s()},c=l=>o(l);if(t){if(t.dataset.loaded==="true"){s();return}t.addEventListener("load",r,{once:!0}),t.addEventListener("error",c,{once:!0});return}const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>{i.dataset.loaded="true",s()},i.onerror=l=>o(l),document.head.appendChild(i)});return n.loadedScripts.set(e,a),a}function Q(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(n.apexChartsReady||(n.apexChartsReady=G("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),n.apexChartsReady)}function at(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(n.html2PdfReady||(n.html2PdfReady=G("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),n.html2PdfReady)}function rt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(n.xlsxReady||(n.xlsxReady=G("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),n.xlsxReady)}function z(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function A(e,t){const a=document.getElementById(e);if(a){if(!t||t.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}a.innerHTML=t.map(s=>{const o=Math.min(Math.max(s.percent??0,0),100),r=d("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",w(s.rawCount??s.value??0)),c=s.className?`reports-progress-fill ${s.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${s.label}</span>
            <span class="reports-progress-value">${w(s.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${c}" style="width: ${o}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}async function st(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const a=Array.isArray(e)?e:[];if(n.lastTrendData=a,!a.length){n.charts.trend&&(n.charts.trend.destroy(),n.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const s=await Q();if(!s){t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const o=a.map(u=>u.label),r=a.map(u=>Math.round(u.count||0)),c=a.map(u=>Math.round(u.revenue||0)),i=a.map(u=>Math.round(u.netProfit||0)),l=[{name:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:r},{name:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:c},{name:d("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:i,yAxisIndex:1}],m={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(u,p,f)=>{if(f?.dataPointIndex!=null){const h=n.lastTrendData[f.dataPointIndex];n.callbacks.onTrendDrilldown?.(h,f.dataPointIndex)}}}},theme:{mode:z()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:o,labels:{style:{colors:z()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:u=>w(u)},title:{text:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:u=>D(u)},title:{text:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(u,{seriesIndex:p})=>p===0?w(u):D(u)}}};n.charts.trend?(n.charts.trend.updateOptions({...m},!0,!0),n.charts.trend.updateSeries(l,!0)):(t.innerHTML="",n.charts.trend=new s(t,{...m,series:l}),n.charts.trend.render())}catch(s){console.error("âš ï¸ [reports] Failed to render trend chart",s),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ot(e){const t=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!t)return;const s=Array.isArray(e)?e:[];if(n.lastStatusData=s,!s.length){n.charts.status&&(n.charts.status.destroy(),n.charts.status=null),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await Q();if(!o){A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const r=s.map(l=>Math.max(0,l.value||0)),c=s.map(l=>l.label),i={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(l,m,u)=>{if(u?.dataPointIndex!=null){const p=n.lastStatusData[u.dataPointIndex];p?.filterKey&&n.callbacks.onStatusDrilldown?.(p,u.dataPointIndex)}}}},theme:{mode:z()},labels:c,series:r,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:l=>`${Math.round(l)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:d("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>w(r.reduce((l,m)=>l+m,0))}}}}},tooltip:{y:{formatter:(l,m)=>{const u=n.lastStatusData?.[m?.seriesIndex||0],p=u?`${w(u.percent)}%`:`${w(l)}%`;return`${w(u?u.rawCount??u.value??0:l)} / ${p}`}}}};n.charts.status?(n.charts.status.updateOptions({...i},!0,!0),n.charts.status.updateSeries(r,!0)):(t.innerHTML="",n.charts.status=new o(t,{...i,series:r}),n.charts.status.render()),A(a,s)}catch(o){console.error("âš ï¸ [reports] Failed to render status chart",o),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ct(e){const t=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!t)return;const s=Array.isArray(e)?e:[];if(n.lastPaymentData=s,!s.length){n.charts.payment&&(n.charts.payment.destroy(),n.charts.payment=null),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await Q();if(!o){A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const r=s.map(l=>Math.max(0,l.value||0)),c=s.map(l=>l.label),i={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(l,m,u)=>{if(u?.dataPointIndex!=null){const p=n.lastPaymentData[u.dataPointIndex];p?.filterKey&&n.callbacks.onPaymentDrilldown?.(p,u.dataPointIndex)}}}},theme:{mode:z()},labels:c,series:r,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:l=>`${Math.round(l)}%`},tooltip:{y:{formatter:(l,m)=>{const u=n.lastPaymentData?.[m?.seriesIndex||0],p=u?`${w(u.percent)}%`:`${w(l)}%`;return`${w(u?u.rawCount??u.value??0:l)} / ${p}`}}}};n.charts.payment?(n.charts.payment.updateOptions({...i},!0,!0),n.charts.payment.updateSeries(r,!0)):(t.innerHTML="",n.charts.payment=new o(t,{...i,series:r}),n.charts.payment.render()),A(a,s)}catch(o){console.error("âš ï¸ [reports] Failed to render payment chart",o),A(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}function it(e){const t=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),s=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-revenue-breakdown"),c=document.getElementById("reports-kpi-confirmed"),i=document.getElementById("reports-kpi-confirmed-meta"),l=document.getElementById("reports-kpi-paid"),m=document.getElementById("reports-kpi-paid-meta"),u=e.total||0,p=e.revenue||0,f=e.confirmed||0,h=e.paidCount||0,g=e.average||0,v=e.companyShareTotal||0,b=e.taxTotal||0,I=e.crewTotal||0,E=e.crewCostTotal||0,B=e.netProfit||0,F=e.maintenanceExpense||0,he=u?Math.round(f/u*100):0,ye=u?Math.round(h/u*100):0;if(t&&(t.textContent=w(u)),a){const S=d("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",w(e.completed||0));a.textContent=S}if(s&&(s.textContent=D(p)),o){const S=d("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");o.textContent=S.replace("{net}",D(B)).replace("{share}",D(v)).replace("{average}",D(g))}if(r)if(p>0){const S=[{label:d("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:D(p)},{label:d("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:D(v)},{label:d("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:D(b)},{label:d("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:D(I)},{label:d("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:D(E)}];F>0&&S.push({label:d("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${D(F)}`}),S.push({label:d("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:D(B)}),r.innerHTML=S.map(({label:ge,value:be})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${ge}</span>
            <span class="reports-kpi-detail-value">${be}</span>
          </div>
        `).join(""),r.classList.remove("hidden")}else r.innerHTML="",r.classList.add("hidden");if(c&&(c.textContent=`${he}%`),i){const S=d("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",w(f));i.textContent=S}if(l&&(l.textContent=`${ye}%`),m){const S=d("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",w(h));m.textContent=S}}function C(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function O(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function lt(e,t,a){const s=document.getElementById("reports-reservations-body");if(!s)return[];if(!e||e.length===0)return s.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const o=new Map((t||[]).map(i=>[String(i.id),i]));new Map((a||[]).map(i=>[String(i.id),i]));const r={code:d("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:d("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:d("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:d("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:d("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:d("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:d("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:d("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},c=[...e].sort((i,l)=>new Date(l.start||0)-new Date(i.start||0)).slice(0,20).map(i=>{const l=ut(i,o),m={[r.code]:l.code.text,[r.customer]:l.customer.text,[r.date]:l.date.text,[r.status]:l.status.text,[r.payment]:l.payment.text,[r.total]:l.total.text,[r.share]:l.share.text,[r.net]:l.net.text};return{formatted:l,exportRow:m}});return s.innerHTML=c.map(({formatted:i})=>`
      <tr data-drilldown="reservation" data-search="${O(i.code.text)}">
        <td data-report-column="code">${i.code.html}</td>
        <td data-report-column="customer">${i.customer.html}</td>
        <td data-report-column="date">${i.date.html}</td>
        <td data-report-column="status">${i.status.html}</td>
        <td data-report-column="payment">${i.payment.html}</td>
        <td data-report-column="total">${i.total.html}</td>
        <td data-report-column="share">${i.share.html}</td>
        <td data-report-column="net">${i.net.html}</td>
      </tr>
    `).join(""),c.map(({exportRow:i})=>i)}function ut(e,t,a){const s=e?.reservationId||e?.id||"â€”",o=T(String(s)),c=t.get(String(e?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),i=N(e),l=dt(i.statusValue),m=pt(i.statusValue,l),u=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],p=mt(i.paidStatus,u),f=u.length;let h=p.html;if(f>0){const F=d("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",w(f));h=`<div class="reports-payment-cell">${p.html}<small class="reports-payment-subtext">${C(F)}</small></div>`}const g=He(e?.start),v=$(e),b=D(v.finalTotal),I=v.companySharePercent>0?`${w(v.companySharePercent)}% (${D(v.companyShareAmount)})`:d("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),E=D(v.netProfit),B=C(c);return{code:{html:C(o),text:o},customer:{html:B,text:c},date:{html:C(g),text:g},status:m,payment:{html:h,text:p.text},total:{html:C(b),text:b},share:{html:C(I),text:I},net:{html:C(E),text:E}}}function dt(e){switch(e){case"completed":return j(d("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return j(d("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return j(d("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return T(e||"â€”")}}function pt(e,t){const a=j(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${C(a)}</span>`,text:a}}function mt(e,t=[]){const a=me(e),s=String(e??"").toLowerCase(),o=s==="paid"?"paid":s==="partial"?"partial":"unpaid";let r="";const c=d("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(t)&&t.length&&(r=t.map(m=>{const u=m?.recordedAt?H(m.recordedAt):"â€”",p=Number.isFinite(Number(m?.amount))&&Number(m.amount)>0?`${T(Number(m.amount).toFixed(2))} ${c}`:"",f=Number.isFinite(Number(m?.percentage))&&Number(m.percentage)>0?`${T(Number(m.percentage).toFixed(2))}%`:"",h=[u];return p&&h.push(p),f&&h.push(f),h.filter(Boolean).join(" â€¢ ")}).join(`
`));const i=r?` title="${O(r)}"`:"";return{html:`<span class="reservation-chip status-${o}"${i}>${C(a)}</span>`,text:a}}function j(e){return T(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function Z(e){const t=H(new Date).replace(/-/g,"");return`${d("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${t}.${e}`}function ft(e,t,a){const s=new Blob([e],{type:a}),o=URL.createObjectURL(s),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(o),4e3)}function U(e){if(!e||!e.length)return;const t=Object.keys(e[0]),a=[t.join(",")];e.forEach(o=>{const r=t.map(c=>`"${String(o[c]??"").replace(/"/g,'""')}"`);a.push(r.join(","))});const s=`\uFEFF${a.join(`\r
`)}\r
`;ft(s,Z("csv"),"text/csv;charset=utf-8;")}async function ht(e){try{const t=await rt();if(!t){U(e);return}const a=t.utils.json_to_sheet(e),s=t.utils.book_new(),o=d("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");t.utils.book_append_sheet(s,a,o),t.writeFile(s,Z("xlsx"))}catch(t){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",t),U(e)}}async function yt(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await at();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const a=Z("pdf");Le();const s=[];Pe(e,window,s),Me(e,window,s);try{await t().set({margin:10,filename:a,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{Re(s)}}async function gt(e,t){switch(e){case"pdf":await yt();break;case"excel":await ht(t);break;case"csv":default:U(t);break}}function bt(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${O(a.name)}">
        <td>${C(a.name)}</td>
        <td>${w(a.count)}</td>
        <td>${D(a.revenue)}</td>
      </tr>
    `).join("")}}function vt(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${O(a.name)}">
        <td>${C(a.name)}</td>
        <td>${w(a.count)}</td>
        <td>${D(a.revenue)}</td>
      </tr>
    `).join("")}}const k=n.filters;function wt(e){if(n.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(a=>{const s=a.dataset.columnToggle;s&&(a.checked=n.columnPreferences[s]!==!1,a.addEventListener("change",()=>{n.columnPreferences[s]=a.checked,e()}))}),n.columnControlsBound=!0,e())}function fe(){Object.entries(n.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(a=>{a.classList.toggle("hidden",!t)})})}function xt(e){if(n.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(a=>{a.addEventListener("click",async()=>{const{export:s=""}=a.dataset;if(s){a.disabled=!0;try{await e(s)}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{a.disabled=!1}}})}),n.exportHandlersBound=!0)}function Dt(e,t){n.searchDebounceTimer&&(clearTimeout(n.searchDebounceTimer),n.searchDebounceTimer=null),n.searchDebounceTimer=setTimeout(()=>{k.search=e||"",t()},220)}function St(e,t){e&&(k.range="custom",k.start=e.startInput||null,k.end=e.endInput||null,t())}function Ct(e,t){e&&(k.status=k.status===e?"all":e,t())}function kt(e,t){e&&(k.payment=k.payment===e?"all":e,t())}function Tt(e,t){e&&(k.search=e,t())}const y=n.filters;function ae(){V(),x(),setTimeout(()=>{V(),x(),_()},0),setTimeout(()=>{V(),x(),_()},60),_()}function R(){y.range==="custom"&&x()}function _(e,t){if(!window.flatpickr)return;e&&(n.startDateInputRef=e),t&&(n.endDateInputRef=t);const a=n.startDateInputRef,s=n.endDateInputRef;if(!a&&!s)return;const o=At(),r=c=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...c};return o&&(i.locale=o),i};if(n.startDatePicker&&(n.startDatePicker.destroy(),n.startDatePicker=null),n.endDatePicker&&(n.endDatePicker.destroy(),n.endDatePicker=null),a&&(n.startDatePicker=window.flatpickr(a,r({onChange(c,i){y.start=i||null,n.endDatePicker&&(c?.length?n.endDatePicker.set("minDate",c[0]):n.endDatePicker.set("minDate",null)),R()},onValueUpdate(c,i){y.start=i||null,R()}}))),s&&(n.endDatePicker=window.flatpickr(s,r({onChange(c,i){y.end=i||null,n.startDatePicker&&(c?.length?n.startDatePicker.set("maxDate",c[0]):n.startDatePicker.set("maxDate",null)),R()},onValueUpdate(c,i){y.end=i||null,R()}}))),n.startDatePicker&&a){n.startDatePicker.setDate(a.value,!1);const c=n.endDatePicker?.selectedDates?.[0]||n.endDateInputRef?.value;c&&n.startDatePicker.set("maxDate",c)}if(n.endDatePicker&&s){n.endDatePicker.setDate(s.value,!1);const c=n.startDatePicker?.selectedDates?.[0]||n.startDateInputRef?.value;c&&n.endDatePicker.set("minDate",c)}}function At(){return(Y()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function X(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function L(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),s=document.getElementById("reports-share-filter"),o=document.getElementById("reports-search"),r=document.getElementById("reports-start"),c=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");e&&e.value!==y.range&&(e.value=y.range),t&&t.value!==y.status&&(t.value=y.status),a&&a.value!==y.payment&&(a.value=y.payment),s&&s.value!==y.share&&(s.value=y.share),o&&o.value!==y.search&&(o.value=y.search||""),r&&r.value!==(y.start||"")&&(r.value=y.start||""),c&&c.value!==(y.end||"")&&(c.value=y.end||""),X(i,y.range==="custom")}function W({active:e,icon:t,title:a,subtitle:s}){const o=document.getElementById("reports-empty-state");if(!o)return;const r=o.querySelector(".reports-empty-icon"),c=o.querySelector("h4"),i=o.querySelector("p");n.emptyDefaults.icon===null&&r&&(n.emptyDefaults.icon=r.textContent),n.emptyDefaults.title===null&&c&&(n.emptyDefaults.title=c.textContent),n.emptyDefaults.subtitle===null&&i&&(n.emptyDefaults.subtitle=i.textContent),o.classList.toggle("active",!!e),o.classList.toggle("hidden",!e),!(!r||!c||!i)&&(e?(r.textContent=t!==void 0?t:n.emptyDefaults.icon??r.textContent,c.textContent=a!==void 0?a:n.emptyDefaults.title??c.textContent,i.textContent=s!==void 0?s:n.emptyDefaults.subtitle??i.textContent):(r.textContent=n.emptyDefaults.icon??r.textContent,c.textContent=n.emptyDefaults.title??c.textContent,i.textContent=n.emptyDefaults.subtitle??i.textContent))}function Et(e){W({active:!!e})}function Lt(){if(n.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),s=o=>{const r=o.target?.closest("[data-drilldown]");if(!r)return;const c=r.dataset.search||"";Tt(c,()=>{L(),x()})};e?.addEventListener("click",s),t?.addEventListener("click",s),a?.addEventListener("click",s),n.drilldownBound=!0}function M(){le({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function x(){if(L(),n.loading){W({active:!0,icon:"â³",title:d("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:d("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(n.errorMessage){W({active:!0,icon:"âš ï¸",title:n.errorMessage,subtitle:d("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:e,customers:t,equipment:a,technicians:s,maintenance:o}=n.data,r=nt(e,y,t,a,s),c=Xe(r),i=We(o,y),l=Ke(c,i.total),m=Ge(r),u=Qe(r),p=Ze(r),f=Je(r,t),h=et(r,a);it(l),st(m),ot(u),ct(p),bt(f),vt(h);const g=lt(r,t,s);fe(),Et(r.length===0),n.lastSnapshot.filtered=r,n.lastSnapshot.metrics=l,n.lastSnapshot.trend=m,n.lastSnapshot.statusBreakdown=u,n.lastSnapshot.paymentBreakdown=p,n.lastSnapshot.tableRows=g,n.lastSnapshot.maintenance=i}function Ft(){if(n.initialized)return;n.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),s=document.getElementById("reports-share-filter"),o=document.getElementById("reports-start"),r=document.getElementById("reports-end"),c=document.getElementById("reports-refresh"),i=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;L(),ze()&&x(),e.addEventListener("change",()=>{y.range=e.value,X(i,y.range==="custom"),y.range!=="custom"&&(y.start=null,y.end=null),x()}),t?.addEventListener("change",()=>{y.status=t.value,x()}),a?.addEventListener("change",()=>{y.payment=a.value,x()}),s?.addEventListener("change",()=>{y.share=s.value,x()}),l?.addEventListener("input",()=>{const u=l.value||"";Dt(u,()=>{L(),x()})}),o?.addEventListener("change",()=>{y.start=o.value||null,R()}),r?.addEventListener("change",()=>{y.end=r.value||null,R()}),c?.addEventListener("click",()=>{y.range==="custom"&&(y.start=o?.value||null,y.end=r?.value||null),x()}),_(o,r),X(i,y.range==="custom"),n.languageListenerAttached||(document.addEventListener("language:changed",ae),document.addEventListener("language:translationsReady",ae),n.languageListenerAttached=!0),n.dataListenersAttached||(document.addEventListener("reservations:changed",M),document.addEventListener("customers:changed",M),document.addEventListener("equipment:changed",M),document.addEventListener("projects:changed",M),document.addEventListener("technicians:updated",M),window.addEventListener("maintenance:updated",M),n.dataListenersAttached=!0),wt(fe),xt(async u=>{const p=n.lastSnapshot.tableRows||[];if(!p.length){console.warn("[reports] No reservation data to export");return}await gt(u,p)}),Lt(),n.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>x(),0)}),n.themeListenerAttached=!0),Ne(x),Ie(()=>{x()}),$e(()=>{x()}),Be(u=>{St(u,()=>{L(),x()})}),Fe(u=>{Ct(u?.filterKey,()=>{L(),x()})}),je(u=>{kt(u?.filterKey,()=>{L(),x()})}),le().catch(u=>{console.error("âŒ [reports] Failed to initialise reports data",u)})}export{Ft as initReports,x as renderReports};
