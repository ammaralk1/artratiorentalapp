import{t as bt,n as k,e as O,d as wt,b as P,A as xt}from"./auth.js";import{ae as Dt,m as rt,o as St,z as Ct,e as Tt,x as kt,a5 as Et,a6 as At,a4 as J}from"./reservationsService.js";import{m as st}from"./dashboard.js";import{U as Lt,V as Pt,W as Mt,X as Rt}from"./controller.js";/* empty css     */import"./dashboardShell.js";import"./customers.js";const n={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function $t(t){n.callbacks.onRender=typeof t=="function"?t:null}function Nt(t){n.callbacks.onBeforeRender=typeof t=="function"?t:null}function It(t){n.callbacks.onAfterRender=typeof t=="function"?t:null}function Bt(t){n.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function Ft(t){n.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function jt(t){n.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function d(t,e,a=e){const o=O()==="en"?a??e:e;return bt(t,o)}function U(){n.formatters.cachedLocale=null,n.formatters.numberFormatter=null}function K(){return(O()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function _t(){const t=O();if(t!==n.formatters.cachedLocale||!n.formatters.numberFormatter){n.formatters.cachedLocale=t;const e=K();n.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0})}return{numberFormatter:n.formatters.numberFormatter}}function w(t){const{numberFormatter:e}=_t(),a=e.format(Math.round(t||0));return k(a)}function D(t){return`${w(t)} SR`}function q(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${a}-${r}-${o}`}function Ht(t){if(!t)return"â€”";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"â€”";const a=new Intl.DateTimeFormat(K(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return k(a.format(e))}function qt(t){return new Intl.DateTimeFormat(K(),{month:"short"}).format(t)}function ot(t={}){return{id:t?.id!=null?String(t.id):"",customerName:t?.full_name??t?.customerName??t?.name??"",companyName:t?.company??t?.company_name??t?.companyName??"",phone:t?.phone??""}}function ct(t={}){const e=String(t?.barcode??"").trim(),a=t?.description??t?.name??"";return{id:t?.id!=null?String(t.id):"",barcode:e,desc:a,description:a,name:t?.name??a,category:t?.category??"",subcategory:t?.subcategory??"",status:t?.status??"",price:Number.parseFloat(t?.unit_price??t?.price??0)||0}}function it(t={}){const e=t?.title??t?.name??"",a=t?.project_code??t?.projectCode??"",r=t?.status??"",o=t?.confirmed===!0;return{id:t?.id!=null?String(t.id):"",title:e,code:a,status:r,confirmed:o}}function zt(){let t;try{t=wt()}catch(i){return console.warn("âš ï¸ [reports] Failed to access cached data",i),!1}if(!t||typeof t!="object")return!1;const{reservations:e=[],customers:a=[],equipment:r=[],technicians:o=[],projects:s=[],maintenance:c=[]}=t;return e.length||a.length||r.length||o.length||s.length?(n.data.reservations=Array.isArray(e)?e.map(Dt):[],n.data.customers=Array.isArray(a)?a.map(ot):[],n.data.equipment=Array.isArray(r)?r.map(ct):[],n.data.technicians=Array.isArray(o)?o.map(rt):[],n.data.projects=Array.isArray(s)?s.map(it):[],n.data.projectsMap=new Map(n.data.projects.map(i=>[i.id,i])),n.data.maintenance=Array.isArray(c)?c.map(st):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(i=>[String(i.id),i])),!0):!1}async function lt({silent:t=!1}={}){if(!n.loading){n.loading=!0,n.errorMessage="",t||n.callbacks.onBeforeRender?.();try{const[e,a,r,o,s,c]=await Promise.all([P("/reservations/?limit=500"),P("/customers/?limit=500"),P("/equipment/?limit=500"),P("/technicians/?limit=500"),P("/projects/?limit=500"),P("/maintenance/?limit=500")]);n.data.reservations=Array.isArray(e?.data)?e.data.map(l=>St(l)):[],n.data.customers=Array.isArray(a?.data)?a.data.map(ot):[],n.data.equipment=Array.isArray(r?.data)?r.data.map(ct):[],n.data.technicians=Array.isArray(o?.data)?o.data.map(rt):[],n.data.projects=Array.isArray(s?.data)?s.data.map(it):[],n.data.projectsMap=new Map(n.data.projects.map(l=>[l.id,l])),n.data.maintenance=Array.isArray(c?.data)?c.data.map(st):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(l=>[String(l.id),l]))}catch(e){console.error("âŒ [reports] Failed to load reports data",e),n.errorMessage=e instanceof xt?e.message:d("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),n.data.reservations=[],n.data.customers=[],n.data.equipment=[],n.data.technicians=[],n.data.projects=[],n.data.projectsMap=new Map,n.data.maintenance=[],n.techniciansIndex=null}finally{n.loading=!1,t||n.callbacks.onAfterRender?.()}}}const Yt=new Map([["confirmed","confirmed"],["Ù…Ø¤ÙƒØ¯","confirmed"],["Ù…Ø¤ÙƒØ¯Ø©","confirmed"],["approved","confirmed"],["pending","pending"],["Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","pending"],["ØºÙŠØ± Ù…Ø¤ÙƒØ¯","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["Ù…Ù†ØªÙ‡ÙŠ","completed"],["Ù…Ù†ØªÙ‡ÙŠØ©","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["Ù…Ù„ØºÙŠ","cancelled"]]),tt=new Map([["paid",!0],["Ù…Ø¯ÙÙˆØ¹",!0],["Ù…Ø¯ÙÙˆØ¹Ø©",!0],["ØªÙ… Ø§Ù„Ø¯ÙØ¹",!0],["completed",!0],["unpaid",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",!1],["pending",!1],["Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",!1]]),Ot=1440*60*1e3;function ut(t){return k(String(t||"")).toLowerCase().trim()}function z(t){return(t||"").toString().trim()}function Ut(t,e){if(!t||!e)return 1;const a=new Date(t),r=new Date(e);if(Number.isNaN(a.getTime())||Number.isNaN(r.getTime()))return 1;const o=r.getTime()-a.getTime();return o<=0?1:Math.max(1,Math.ceil(o/Ot))}function B(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;Ut(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,a=t.discountType||t.discount_type||"percent",r=String(a).toLowerCase()==="amount"?"amount":"percent",o=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",s=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,c=s!=null?Et(s):Number.NaN,i=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(c)&&c>0?c:null,p=Array.isArray(t.crewAssignments)?t.crewAssignments:[],u=p.length?p.map(v=>v?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],m=At({items:Array.isArray(t.items)?t.items:[],technicianIds:u,crewAssignments:p,discount:e,discountType:r,applyTax:o,start:t.start,end:t.end,companySharePercent:i}),f=Number(t.cost);let h=m.finalTotal,g=m.taxAmount;if(Number.isFinite(f)&&f>0&&(h=J(f),o)){const v=h-m.taxableAmount;Number.isFinite(v)&&v>=0&&(g=J(v))}const b={rentalDays:m.rentalDays,equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal,crewCostTotal:m.crewCostTotal,discountAmount:m.discountAmount,subtotalAfterDiscount:m.subtotalAfterDiscount,taxableAmount:m.taxableAmount,taxAmount:g,finalTotal:h,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,netProfit:m.netProfit,companyShareEnabled:m.companySharePercent>0};return t.__financials=b,b}function dt(t){return t?.projectId&&n.data.projectsMap.get(String(t.projectId))||null}function et(t=""){const e=String(t).toLowerCase().trim();return e?Yt.get(e)||e:""}function Vt(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const a of e){const r=String(a||"").toLowerCase().trim();if(r&&tt.has(r))return tt.get(r)}return t?.paid===!0||t?.paid==="true"}function $(t){const e=dt(t),a=Tt(t,e),r=et(a.projectStatus);let o=et(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");a.projectLinked&&r&&(o=r),(!o||o==="cancelled")&&(o=a.effectiveConfirmed?"confirmed":"pending"),(kt(t)||r==="completed")&&(o="completed");const s=a.effectiveConfirmed||o==="confirmed"||o==="completed";s&&o!=="completed"&&(o="confirmed");const c=Vt(t),l=t?.paidStatus??t?.paid_status??(c?"paid":"unpaid");return{statusValue:o,confirmed:s,paid:c,paidStatus:l}}function Wt(t){const e=t.length;let a=0,r=0,o=0,s=0,c=0,l=0,i=0,p=0,u=0;t.forEach(f=>{const{statusValue:h,confirmed:g,paid:b}=$(f);h==="completed"&&(r+=1),g&&(a+=1),b&&(o+=1);const v=B(f);s+=v.finalTotal,c+=v.companyShareAmount,l+=v.taxAmount,i+=v.crewTotal,p+=v.crewCostTotal??0,u+=v.netProfit});const m=e?s/e:0;return{total:e,confirmed:a,completed:r,paidCount:o,revenue:s,average:m,companyShareTotal:c,taxTotal:l,crewTotal:i,crewCostTotal:p,netProfit:u}}function pt({range:t,start:e,end:a}){const r=new Date;if(r.setHours(23,59,59,999),t==="custom"){const c=e?new Date(`${e}T00:00:00`):null,l=a?new Date(`${a}T23:59:59`):null;return{startDate:nt(c)?c:null,endDate:nt(l)?l:null}}let o=new Date(r),s=null;switch(t){case"last30":{s=new Date(r),s.setDate(s.getDate()-29);break}case"thisWeek":{const c=new Date(r),i=(c.getDay()-6+7)%7;c.setDate(c.getDate()-i),c.setHours(0,0,0,0);const p=new Date(c);p.setDate(c.getDate()+6),p.setHours(23,59,59,999),s=c,o=p;break}case"thisMonth":{s=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const c=Math.floor(r.getMonth()/3);s=new Date(r.getFullYear(),c*3,1),o=new Date(r.getFullYear(),(c+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{s=new Date(r.getFullYear(),0,1),o=new Date(r.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:s=null,o=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:o}}function nt(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function Xt(t,e){const{startDate:a,endDate:r}=pt(e);let o=0;const s=[];return(t||[]).forEach(c=>{if(!c)return;const l=typeof c.repairCost=="number"?c.repairCost:Number.parseFloat(k(String(c.repairCost??"")));if(!Number.isFinite(l)||l<=0)return;const i=String(c.statusRaw??c.status??"").toLowerCase();if(!(i==="closed"||i==="completed"||i==="cancelled"))return;const u=c.resolvedAt??c.resolved_at??null,m=c.reportedAt??c.reported_at??null,f=c.createdAt??c.created_at??null,h=u?new Date(u):null,g=m?new Date(m):f?new Date(f):null,b=h&&!Number.isNaN(h.getTime())?h:g&&!Number.isNaN(g.getTime())?g:null;if(b&&(a&&b<a||r&&b>r))return;const v=Math.round(l*100)/100;o+=v,s.push({id:c.id,cost:v,date:b})}),{total:o,items:s}}function Kt(t,e){const a=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:a,netProfit:(t.netProfit||0)-a}}function Gt(t){const e=new Date,a=[];for(let r=5;r>=0;r-=1){const o=new Date(e.getFullYear(),e.getMonth()-r,1),s=o.getFullYear(),c=o.getMonth(),l=t.filter(b=>{const v=b?.start?new Date(b.start):null;return v&&v.getFullYear()===s&&v.getMonth()===c}),i=l.length;let p=0,u=0,m=0;l.forEach(b=>{const v=B(b);p+=v.finalTotal,u+=v.netProfit,m+=v.companyShareAmount});const f=qt(o),h=new Date(o.getFullYear(),o.getMonth(),1),g=new Date(o.getFullYear(),o.getMonth()+1,0);a.push({label:f,count:i,revenue:p,netProfit:u,companyShare:m,periodStart:h,periodEnd:g,startInput:q(h),endInput:q(g)})}return a}function Qt(t){const e={confirmed:0,pending:0,completed:0};(t||[]).forEach(c=>{const{statusValue:l,confirmed:i}=$(c);l==="completed"?e.completed+=1:l==="confirmed"||i?e.confirmed+=1:e.pending+=1});const a=Math.max(1,(t||[]).length),r=e.confirmed,o=e.pending,s=e.completed;return[{label:d("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-confirmed",filterKey:"confirmed"},{label:d("reservations.reports.status.pendingLabel","Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","Pending confirmation"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:d("reservations.reports.status.completedLabel","Ù…Ù†ØªÙ‡ÙŠØ©","Completed"),value:s,percent:Math.round(s/a*100)||0,rawCount:s,className:"status-completed",filterKey:"completed"}]}function Zt(t){const e=t.length||1,a=t.filter(o=>$(o).paid).length,r=t.length-a;return[{label:d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"),value:a,percent:Math.round(a/e*100)||0,rawCount:a,className:"status-paid",filterKey:"paid"},{label:d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid"),value:r,percent:Math.round(r/e*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}]}function Jt(t,e){const a=new Map,r=new Map((e||[]).map(o=>[String(o.id),o]));return t.forEach(o=>{const s=String(o?.customerId??"unknown"),c=a.get(s)||{count:0,revenue:0},l=B(o);c.count+=1,c.revenue+=l.finalTotal,a.set(s,c)}),Array.from(a.entries()).map(([o,s])=>({name:r.get(o)?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),count:s.count,revenue:s.revenue})).sort((o,s)=>s.revenue-o.revenue).slice(0,5)}function te(t,e){const a=new Map,r=new Map((e||[]).map(s=>[z(s?.barcode),s])),o=d("reservations.reports.topEquipment.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…","Unnamed equipment");return t.forEach(s=>{(s?.items||[]).forEach(c=>{const l=z(c?.barcode),i=l?r.get(l):null,p=c?.desc||c?.description||c?.name||i?.desc||i?.description||i?.name||"",u=p&&p.trim()?p:o,m=Ct(u)||"unknown",f=Number(c?.qty)||1,h=Number(c?.price)||0,g=f*h,b=a.get(m)||{name:u,count:0,revenue:0};b.name=u,b.count+=f,b.revenue+=g,a.set(m,b)})}),Array.from(a.values()).sort((s,c)=>c.count!==s.count?c.count-s.count:c.revenue-s.revenue).slice(0,5)}function ee(t,e,a,r,o){const s=[],c=t?.reservationId||t?.id;c&&s.push(c),t?.notes&&s.push(t.notes);const{statusValue:l,paidStatus:i}=$(t);l&&s.push(l);const p=t?.paymentStatus||t?.payment_status;p&&s.push(p),t?.paid!=null&&s.push(t.paid?"paid":"unpaid"),i&&s.push(i);const u=a.get(String(t?.customerId));u&&s.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const m=dt(t);return m&&s.push(m.title,m.code,m.status),s.push(mt(i)),(t?.items||[]).forEach(h=>{h?.desc&&s.push(h.desc),h?.barcode&&s.push(h.barcode);const g=r.get(z(h?.barcode));g&&s.push(g.desc,g.description,g.name)}),(t?.technicians||[]).forEach(h=>{const g=o.get(String(h));g&&s.push(g.name,g.role,g.department)}),ut(s.filter(Boolean).join(" ")).includes(e)}function ne(t,e,a,r,o){const{startDate:s,endDate:c}=pt(e),l=ut(e.search),i=!!l,p=new Map((a||[]).map(f=>[String(f.id),f])),u=new Map((r||[]).map(f=>[z(f?.barcode),f])),m=new Map((o||[]).map(f=>[String(f.id),f]));return(t||[]).filter(f=>{const h=f?.start?new Date(f.start):null;if(!h||Number.isNaN(h.getTime())||s&&h<s||c&&h>c)return!1;const{statusValue:g,confirmed:b,paid:v}=$(f);if(e.status==="confirmed"&&!(g==="confirmed"||g==="completed"||b)||e.status==="pending"&&g!=="pending"||e.status==="completed"&&g!=="completed"||e.payment==="paid"&&!v||e.payment==="unpaid"&&v)return!1;if(e.share&&e.share!=="all"){const A=B(f).companySharePercent>0;if(e.share==="with"&&!A||e.share==="without"&&A)return!1}return!(i&&!ee(f,l,p,u,m))})}function mt(t){const e=String(t??"").toLowerCase();return e==="paid"?d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"):e==="partial"?d("reservations.reports.payment.partialLabel","Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹","Partially paid"):d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid")}function G(t){if(n.loadedScripts.has(t))return n.loadedScripts.get(t);const e=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,a=new Promise((r,o)=>{const s=()=>{e&&(e.dataset.loaded="true"),r()},c=i=>o(i);if(e){if(e.dataset.loaded==="true"){r();return}e.addEventListener("load",s,{once:!0}),e.addEventListener("error",c,{once:!0});return}const l=document.createElement("script");l.src=t,l.async=!0,l.onload=()=>{l.dataset.loaded="true",r()},l.onerror=i=>o(i),document.head.appendChild(l)});return n.loadedScripts.set(t,a),a}function Q(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(n.apexChartsReady||(n.apexChartsReady=G("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),n.apexChartsReady)}function ae(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(n.html2PdfReady||(n.html2PdfReady=G("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),n.html2PdfReady)}function re(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(n.xlsxReady||(n.xlsxReady=G("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),n.xlsxReady)}function Y(){const t=document.documentElement;return t.classList.contains("dark")||t.dataset.theme==="dark"?"dark":"light"}function E(t,e){const a=document.getElementById(t);if(a){if(!e||e.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}a.innerHTML=e.map(r=>{const o=Math.min(Math.max(r.percent??0,0),100),s=d("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",w(r.rawCount??r.value??0)),c=r.className?`reports-progress-fill ${r.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${r.label}</span>
            <span class="reports-progress-value">${w(r.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${c}" style="width: ${o}%;"></div>
          </div>
          <div class="reports-progress-meta">${s}</div>
        </div>
      `}).join("")}}async function se(t){const e=document.getElementById("reports-volume-chart");if(!e)return;const a=Array.isArray(t)?t:[];if(n.lastTrendData=a,!a.length){n.charts.trend&&(n.charts.trend.destroy(),n.charts.trend=null),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const r=await Q();if(!r){e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const o=a.map(u=>u.label),s=a.map(u=>Math.round(u.count||0)),c=a.map(u=>Math.round(u.revenue||0)),l=a.map(u=>Math.round(u.netProfit||0)),i=[{name:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:s},{name:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:c},{name:d("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:l,yAxisIndex:1}],p={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(u,m,f)=>{if(f?.dataPointIndex!=null){const h=n.lastTrendData[f.dataPointIndex];n.callbacks.onTrendDrilldown?.(h,f.dataPointIndex)}}}},theme:{mode:Y()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:o,labels:{style:{colors:Y()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:u=>w(u)},title:{text:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:u=>D(u)},title:{text:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(u,{seriesIndex:m})=>m===0?w(u):D(u)}}};n.charts.trend?(n.charts.trend.updateOptions({...p},!0,!0),n.charts.trend.updateSeries(i,!0)):(e.innerHTML="",n.charts.trend=new r(e,{...p,series:i}),n.charts.trend.render())}catch(r){console.error("âš ï¸ [reports] Failed to render trend chart",r),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function oe(t){const e=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!e)return;const r=Array.isArray(t)?t:[];if(n.lastStatusData=r,!r.length){n.charts.status&&(n.charts.status.destroy(),n.charts.status=null),E(a,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await Q();if(!o){E(a,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const s=r.map(i=>Math.max(0,i.value||0)),c=r.map(i=>i.label),l={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(i,p,u)=>{if(u?.dataPointIndex!=null){const m=n.lastStatusData[u.dataPointIndex];m?.filterKey&&n.callbacks.onStatusDrilldown?.(m,u.dataPointIndex)}}}},theme:{mode:Y()},labels:c,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:d("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>w(s.reduce((i,p)=>i+p,0))}}}}},tooltip:{y:{formatter:(i,p)=>{const u=n.lastStatusData?.[p?.seriesIndex||0],m=u?`${w(u.percent)}%`:`${w(i)}%`;return`${w(u?u.rawCount??u.value??0:i)} / ${m}`}}}};n.charts.status?(n.charts.status.updateOptions({...l},!0,!0),n.charts.status.updateSeries(s,!0)):(e.innerHTML="",n.charts.status=new o(e,{...l,series:s}),n.charts.status.render()),E(a,r)}catch(o){console.error("âš ï¸ [reports] Failed to render status chart",o),E(a,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ce(t){const e=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!e)return;const r=Array.isArray(t)?t:[];if(n.lastPaymentData=r,!r.length){n.charts.payment&&(n.charts.payment.destroy(),n.charts.payment=null),E(a,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await Q();if(!o){E(a,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const s=r.map(i=>Math.max(0,i.value||0)),c=r.map(i=>i.label),l={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(i,p,u)=>{if(u?.dataPointIndex!=null){const m=n.lastPaymentData[u.dataPointIndex];m?.filterKey&&n.callbacks.onPaymentDrilldown?.(m,u.dataPointIndex)}}}},theme:{mode:Y()},labels:c,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},tooltip:{y:{formatter:(i,p)=>{const u=n.lastPaymentData?.[p?.seriesIndex||0],m=u?`${w(u.percent)}%`:`${w(i)}%`;return`${w(u?u.rawCount??u.value??0:i)} / ${m}`}}}};n.charts.payment?(n.charts.payment.updateOptions({...l},!0,!0),n.charts.payment.updateSeries(s,!0)):(e.innerHTML="",n.charts.payment=new o(e,{...l,series:s}),n.charts.payment.render()),E(a,r)}catch(o){console.error("âš ï¸ [reports] Failed to render payment chart",o),E(a,[]),e.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}function ie(t){const e=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),r=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-revenue-breakdown"),c=document.getElementById("reports-kpi-confirmed"),l=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),p=document.getElementById("reports-kpi-paid-meta"),u=t.total||0,m=t.revenue||0,f=t.confirmed||0,h=t.paidCount||0,g=t.average||0,b=t.companyShareTotal||0,v=t.taxTotal||0,N=t.crewTotal||0,A=t.crewCostTotal||0,F=t.netProfit||0,j=t.maintenanceExpense||0,ht=u?Math.round(f/u*100):0,yt=u?Math.round(h/u*100):0;if(e&&(e.textContent=w(u)),a){const S=d("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",w(t.completed||0));a.textContent=S}if(r&&(r.textContent=D(m)),o){const S=d("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");o.textContent=S.replace("{net}",D(F)).replace("{share}",D(b)).replace("{average}",D(g))}if(s)if(m>0){const S=[{label:d("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:D(m)},{label:d("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:D(b)},{label:d("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:D(v)},{label:d("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:D(N)},{label:d("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:D(A)}];j>0&&S.push({label:d("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${D(j)}`}),S.push({label:d("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:D(F)}),s.innerHTML=S.map(({label:gt,value:vt})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${gt}</span>
            <span class="reports-kpi-detail-value">${vt}</span>
          </div>
        `).join(""),s.classList.remove("hidden")}else s.innerHTML="",s.classList.add("hidden");if(c&&(c.textContent=`${ht}%`),l){const S=d("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",w(f));l.textContent=S}if(i&&(i.textContent=`${yt}%`),p){const S=d("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",w(h));p.textContent=S}}function C(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function I(t=""){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function le(t,e,a){const r=document.getElementById("reports-reservations-body");if(!r)return[];const o=r.closest(".reports-table-wrapper")||r.parentElement;if(!t||t.length===0){const i=d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period."),p=`
      <div class="reports-card">
        <div class="reports-table-wrapper">
          <table class="reports-table">
            <thead>
              <tr>
                <th data-report-column="code">${d("reports.reservations.code","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²","Booking #")}</th>
                <th data-report-column="customer">${d("reports.reservations.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer")}</th>
                <th data-report-column="date">${d("reports.reservations.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date")}</th>
                <th data-report-column="status">${d("reports.reservations.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status")}</th>
                <th data-report-column="payment">${d("reports.reservations.payment","Ø§Ù„Ø¯ÙØ¹","Payment")}</th>
                <th data-report-column="total">${d("reports.reservations.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total")}</th>
                <th data-report-column="share">${d("reports.reservations.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company Share")}</th>
                <th data-report-column="net">${d("reports.reservations.net","Ø§Ù„ØµØ§ÙÙŠ","Net")}</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" class="text-base-content/60">${i}</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;return o?o.innerHTML=p:r.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${i}</td></tr>`,[]}const s=new Map((e||[]).map(i=>[String(i.id),i]));new Map((a||[]).map(i=>[String(i.id),i]));const c={code:d("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:d("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:d("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:d("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:d("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:d("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:d("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:d("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},l=[...t].sort((i,p)=>new Date(p.start||0)-new Date(i.start||0)).slice(0,20).map(i=>{const p=ue(i,s),u={[c.code]:p.code.text,[c.customer]:p.customer.text,[c.date]:p.date.text,[c.status]:p.status.text,[c.payment]:p.payment.text,[c.total]:p.total.text,[c.share]:p.share.text,[c.net]:p.net.text};return{formatted:p,exportRow:u}});if(o)o.innerHTML=`
      <div class="reports-card">
        <div class="reports-table-wrapper">
          <table class="reports-table">
            <thead>
              <tr>
                <th data-report-column="code">${d("reports.reservations.code","Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²","Booking #")}</th>
                <th data-report-column="customer">${d("reports.reservations.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer")}</th>
                <th data-report-column="date">${d("reports.reservations.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date")}</th>
                <th data-report-column="status">${d("reports.reservations.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status")}</th>
                <th data-report-column="payment">${d("reports.reservations.payment","Ø§Ù„Ø¯ÙØ¹","Payment")}</th>
                <th data-report-column="total">${d("reports.reservations.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total")}</th>
                <th data-report-column="share">${d("reports.reservations.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company Share")}</th>
                <th data-report-column="net">${d("reports.reservations.net","Ø§Ù„ØµØ§ÙÙŠ","Net")}</th>
              </tr>
            </thead>
            <tbody>
              ${l.map(({formatted:i})=>`
                <tr data-drilldown="reservation" data-search="${I(i.code.text)}">
                  <td data-report-column="code">${i.code.html}</td>
                  <td data-report-column="customer">${i.customer.html}</td>
                  <td data-report-column="date">${i.date.html}</td>
                  <td data-report-column="status">${i.status.html}</td>
                  <td data-report-column="payment">${i.payment.html}</td>
                  <td data-report-column="total">${i.total.html}</td>
                  <td data-report-column="share">${i.share.html}</td>
                  <td data-report-column="net">${i.net.html}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>`;else{const i=[];for(const{formatted:p}of l)i.push('<tr data-drilldown="reservation" data-search="'+I(p.code.text)+'"><td data-report-column="code">'+p.code.html+'</td><td data-report-column="customer">'+p.customer.html+'</td><td data-report-column="date">'+p.date.html+'</td><td data-report-column="status">'+p.status.html+'</td><td data-report-column="payment">'+p.payment.html+'</td><td data-report-column="total">'+p.total.html+'</td><td data-report-column="share">'+p.share.html+'</td><td data-report-column="net">'+p.net.html+"</td></tr>");return r.innerHTML=i.join(""),l.map(({exportRow:p})=>p)}}function ue(t,e,a){const r=t?.reservationId||t?.id||"â€”",o=k(String(r)),c=e.get(String(t?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),l=$(t),i=de(l.statusValue),p=pe(l.statusValue,i),u=Array.isArray(t.paymentHistory)?t.paymentHistory:Array.isArray(t.payment_history)?t.payment_history:[],m=me(l.paidStatus,u),f=u.length;let h=m.html;if(f>0){const j=d("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",w(f));h=`<div class="reports-payment-cell">${m.html}<small class="reports-payment-subtext">${C(j)}</small></div>`}const g=Ht(t?.start),b=B(t),v=D(b.finalTotal),N=b.companySharePercent>0?`${w(b.companySharePercent)}% (${D(b.companyShareAmount)})`:d("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),A=D(b.netProfit),F=C(c);return{code:{html:C(o),text:o},customer:{html:F,text:c},date:{html:C(g),text:g},status:p,payment:{html:h,text:m.text},total:{html:C(v),text:v},share:{html:C(N),text:N},net:{html:C(A),text:A}}}function de(t){switch(t){case"completed":return _(d("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return _(d("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return _(d("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return k(t||"â€”")}}function pe(t,e){const a=_(e);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(t)?t:"info"}">${C(a)}</span>`,text:a}}function me(t,e=[]){const a=mt(t),r=String(t??"").toLowerCase(),o=r==="paid"?"paid":r==="partial"?"partial":"unpaid";let s="";const c=d("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(e)&&e.length&&(s=e.map(p=>{const u=p?.recordedAt?q(p.recordedAt):"â€”",m=Number.isFinite(Number(p?.amount))&&Number(p.amount)>0?`${k(Number(p.amount).toFixed(2))} ${c}`:"",f=Number.isFinite(Number(p?.percentage))&&Number(p.percentage)>0?`${k(Number(p.percentage).toFixed(2))}%`:"",h=[u];return m&&h.push(m),f&&h.push(f),h.filter(Boolean).join(" â€¢ ")}).join(`
`));const l=s?` title="${I(s)}"`:"";return{html:`<span class="reservation-chip status-${o}"${l}>${C(a)}</span>`,text:a}}function _(t){return k(String(t??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function Z(t){const e=q(new Date).replace(/-/g,"");return`${d("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${e}.${t}`}function fe(t,e,a){const r=new Blob([t],{type:a}),o=URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(o),4e3)}function V(t){if(!t||!t.length)return;const e=Object.keys(t[0]),a=[e.join(",")];t.forEach(o=>{const s=e.map(c=>`"${String(o[c]??"").replace(/"/g,'""')}"`);a.push(s.join(","))});const r=`\uFEFF${a.join(`\r
`)}\r
`;fe(r,Z("csv"),"text/csv;charset=utf-8;")}async function he(t){try{const e=await re();if(!e){V(t);return}const a=e.utils.json_to_sheet(t),r=e.utils.book_new(),o=d("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");e.utils.book_append_sheet(r,a,o),e.writeFile(r,Z("xlsx"))}catch(e){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",e),V(t)}}async function ye(){const t=document.getElementById("reservations-report-printable");if(!t)return;const e=await ae();if(typeof e!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const a=Z("pdf");Lt();const r=[];Pt(t,window,r),Mt(t,window,r);try{await e().set({margin:10,filename:a,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(t).save()}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{Rt(r)}}async function ge(t,e){switch(t){case"pdf":await ye();break;case"excel":await he(e);break;case"csv":default:V(e);break}}function ve(t){const e=document.getElementById("reports-top-customers");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}e.innerHTML=`
    <div class="reports-card">
      <div class="reports-card-header">
        <h3>${d("reports.topCustomers.title","Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡","Top Customers")}</h3>
      </div>
      <div class="reports-table-wrapper">
        <table class="reports-table">
          <thead>
            <tr>
              <th>${d("reports.topCustomers.name","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer")}</th>
              <th>${d("reports.topCustomers.count","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Bookings")}</th>
              <th>${d("reports.topCustomers.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª","Revenue")}</th>
            </tr>
          </thead>
          <tbody>
            ${t.map(a=>`
              <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${I(a.name)}">
                <td>${C(a.name)}</td>
                <td>${w(a.count)}</td>
                <td>${D(a.revenue)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>`.join("")}}function be(t){const e=document.getElementById("reports-top-equipment");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}e.innerHTML=`
    <div class="reports-card">
      <div class="reports-card-header">
        <h3>${d("reports.topEquipment.title","Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹","Most Used Equipment")}</h3>
      </div>
      <div class="reports-table-wrapper">
        <table class="reports-table">
          <thead>
            <tr>
              <th>${d("reports.topEquipment.name","Ø§Ù„Ù…Ø¹Ø¯Ø©","Equipment")}</th>
              <th>${d("reports.topEquipment.count","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Bookings")}</th>
              <th>${d("reports.topEquipment.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª","Revenue")}</th>
            </tr>
          </thead>
          <tbody>
            ${t.map(a=>`
              <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${I(a.name)}">
                <td>${C(a.name)}</td>
                <td>${w(a.count)}</td>
                <td>${D(a.revenue)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>`.join("")}}const T=n.filters;function we(t){if(n.columnControlsBound)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(a=>{const r=a.dataset.columnToggle;r&&(a.checked=n.columnPreferences[r]!==!1,a.addEventListener("change",()=>{n.columnPreferences[r]=a.checked,t()}))}),n.columnControlsBound=!0,t())}function ft(){Object.entries(n.columnPreferences).forEach(([t,e])=>{document.querySelectorAll(`[data-report-column="${t}"]`).forEach(a=>{a.classList.toggle("hidden",!e)})})}function xe(t){if(n.exportHandlersBound)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(a=>{a.addEventListener("click",async()=>{const{export:r=""}=a.dataset;if(r){a.disabled=!0;try{await t(r)}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{a.disabled=!1}}})}),n.exportHandlersBound=!0)}function De(t,e){n.searchDebounceTimer&&(clearTimeout(n.searchDebounceTimer),n.searchDebounceTimer=null),n.searchDebounceTimer=setTimeout(()=>{T.search=t||"",e()},220)}function Se(t,e){t&&(T.range="custom",T.start=t.startInput||null,T.end=t.endInput||null,e())}function Ce(t,e){t&&(T.status=T.status===t?"all":t,e())}function Te(t,e){t&&(T.payment=T.payment===t?"all":t,e())}function ke(t,e){t&&(T.search=t,e())}const y=n.filters;function at(){U(),x(),setTimeout(()=>{U(),x(),H()},0),setTimeout(()=>{U(),x(),H()},60),H()}function R(){y.range==="custom"&&x()}function H(t,e){if(!window.flatpickr)return;t&&(n.startDateInputRef=t),e&&(n.endDateInputRef=e);const a=n.startDateInputRef,r=n.endDateInputRef;if(!a&&!r)return;const o=Ee(),s=c=>{const l={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...c};return o&&(l.locale=o),l};if(n.startDatePicker&&(n.startDatePicker.destroy(),n.startDatePicker=null),n.endDatePicker&&(n.endDatePicker.destroy(),n.endDatePicker=null),a&&(n.startDatePicker=window.flatpickr(a,s({onChange(c,l){y.start=l||null,n.endDatePicker&&(c?.length?n.endDatePicker.set("minDate",c[0]):n.endDatePicker.set("minDate",null)),R()},onValueUpdate(c,l){y.start=l||null,R()}}))),r&&(n.endDatePicker=window.flatpickr(r,s({onChange(c,l){y.end=l||null,n.startDatePicker&&(c?.length?n.startDatePicker.set("maxDate",c[0]):n.startDatePicker.set("maxDate",null)),R()},onValueUpdate(c,l){y.end=l||null,R()}}))),n.startDatePicker&&a){n.startDatePicker.setDate(a.value,!1);const c=n.endDatePicker?.selectedDates?.[0]||n.endDateInputRef?.value;c&&n.startDatePicker.set("maxDate",c)}if(n.endDatePicker&&r){n.endDatePicker.setDate(r.value,!1);const c=n.startDatePicker?.selectedDates?.[0]||n.startDateInputRef?.value;c&&n.endDatePicker.set("minDate",c)}}function Ee(){return(O()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function W(t,e){t&&(t.classList.toggle("active",!!e),t.classList.toggle("hidden",!e))}function L(){let t=document.querySelector(".filters-group");if(!t){const p=document.querySelector("#reports-filters");p&&(t=document.createElement("div"),t.className="filters-group",[...p.children].forEach(u=>{const m=document.createElement("div");m.className="filter-control",u.parentNode.insertBefore(m,u),m.appendChild(u)}),p.appendChild(t))}const e=document.getElementById("reports-range"),a=document.getElementById("reports-status-filter"),r=document.getElementById("reports-payment-filter"),o=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),c=document.getElementById("reports-start"),l=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");e&&e.value!==y.range&&(e.value=y.range),a&&a.value!==y.status&&(a.value=y.status),r&&r.value!==y.payment&&(r.value=y.payment),o&&o.value!==y.share&&(o.value=y.share),s&&s.value!==y.search&&(s.value=y.search||""),c&&c.value!==(y.start||"")&&(c.value=y.start||""),l&&l.value!==(y.end||"")&&(l.value=y.end||""),W(i,y.range==="custom")}function X({active:t,icon:e,title:a,subtitle:r}){const o=document.getElementById("reports-empty-state");if(!o)return;const s=o.querySelector(".reports-empty-icon"),c=o.querySelector("h4"),l=o.querySelector("p");n.emptyDefaults.icon===null&&s&&(n.emptyDefaults.icon=s.textContent),n.emptyDefaults.title===null&&c&&(n.emptyDefaults.title=c.textContent),n.emptyDefaults.subtitle===null&&l&&(n.emptyDefaults.subtitle=l.textContent),o.classList.toggle("active",!!t),o.classList.toggle("hidden",!t),!(!s||!c||!l)&&(t?(s.textContent=e!==void 0?e:n.emptyDefaults.icon??s.textContent,c.textContent=a!==void 0?a:n.emptyDefaults.title??c.textContent,l.textContent=r!==void 0?r:n.emptyDefaults.subtitle??l.textContent):(s.textContent=n.emptyDefaults.icon??s.textContent,c.textContent=n.emptyDefaults.title??c.textContent,l.textContent=n.emptyDefaults.subtitle??l.textContent))}function Ae(t){X({active:!!t})}function Le(){if(n.drilldownBound)return;const t=document.getElementById("reports-top-customers"),e=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),r=o=>{const s=o.target?.closest("[data-drilldown]");if(!s)return;const c=s.dataset.search||"";ke(c,()=>{L(),x()})};t?.addEventListener("click",r),e?.addEventListener("click",r),a?.addEventListener("click",r),n.drilldownBound=!0}function M(){lt({silent:!0}).catch(t=>{console.error("âŒ [reports] Background refresh failed",t)})}function x(){if(L(),n.loading){X({active:!0,icon:"â³",title:d("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:d("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(n.errorMessage){X({active:!0,icon:"âš ï¸",title:n.errorMessage,subtitle:d("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:t,customers:e,equipment:a,technicians:r,maintenance:o}=n.data,s=ne(t,y,e,a,r),c=Wt(s),l=Xt(o,y),i=Kt(c,l.total),p=Gt(s),u=Qt(s),m=Zt(s),f=Jt(s,e),h=te(s,a);ie(i),se(p),oe(u),ce(m),ve(f),be(h);const g=le(s,e,r);ft(),Ae(s.length===0),n.lastSnapshot.filtered=s,n.lastSnapshot.metrics=i,n.lastSnapshot.trend=p,n.lastSnapshot.statusBreakdown=u,n.lastSnapshot.paymentBreakdown=m,n.lastSnapshot.tableRows=g,n.lastSnapshot.maintenance=l}function Fe(){if(n.initialized)return;n.initialized=!0;const t=document.getElementById("reports-range"),e=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),r=document.getElementById("reports-share-filter"),o=document.getElementById("reports-start"),s=document.getElementById("reports-end"),c=document.getElementById("reports-refresh"),l=document.getElementById("reports-custom-range"),i=document.getElementById("reports-search");if(!t)return;L(),zt()&&x(),t.addEventListener("change",()=>{y.range=t.value,W(l,y.range==="custom"),y.range!=="custom"&&(y.start=null,y.end=null),x()}),e?.addEventListener("change",()=>{y.status=e.value,x()}),a?.addEventListener("change",()=>{y.payment=a.value,x()}),r?.addEventListener("change",()=>{y.share=r.value,x()}),i?.addEventListener("input",()=>{const u=i.value||"";De(u,()=>{L(),x()})}),o?.addEventListener("change",()=>{y.start=o.value||null,R()}),s?.addEventListener("change",()=>{y.end=s.value||null,R()}),c?.addEventListener("click",()=>{y.range==="custom"&&(y.start=o?.value||null,y.end=s?.value||null),x()}),H(o,s),W(l,y.range==="custom"),n.languageListenerAttached||(document.addEventListener("language:changed",at),document.addEventListener("language:translationsReady",at),n.languageListenerAttached=!0),n.dataListenersAttached||(document.addEventListener("reservations:changed",M),document.addEventListener("customers:changed",M),document.addEventListener("equipment:changed",M),document.addEventListener("projects:changed",M),document.addEventListener("technicians:updated",M),window.addEventListener("maintenance:updated",M),n.dataListenersAttached=!0),we(ft),xe(async u=>{const m=n.lastSnapshot.tableRows||[];if(!m.length){console.warn("[reports] No reservation data to export");return}await ge(u,m)}),Le(),n.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>x(),0)}),n.themeListenerAttached=!0),$t(x),Nt(()=>{x()}),It(()=>{x()}),Bt(u=>{Se(u,()=>{L(),x()})}),Ft(u=>{Ce(u?.filterKey,()=>{L(),x()})}),jt(u=>{Te(u?.filterKey,()=>{L(),x()})}),lt().catch(u=>{console.error("âŒ [reports] Failed to initialise reports data",u)})}export{Fe as initReports,x as renderReports};
