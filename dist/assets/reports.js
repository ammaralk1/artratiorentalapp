import{t as ke,n as T,e as K,d as Ee,b as $,A as Re}from"./auth.js";import{ad as Le,m as pe,o as Me,z as Ne,e as Ae,x as Pe,D as Ie}from"./reservationsService.js";import{m as me}from"./dashboard.js";import{U as Fe,V as $e,W as Be,X as _e}from"./controller.js";import"./dashboardShell.js";import"./customers.js";const n={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null}};function je(e){n.callbacks.onRender=typeof e=="function"?e:null}function He(e){n.callbacks.onBeforeRender=typeof e=="function"?e:null}function qe(e){n.callbacks.onAfterRender=typeof e=="function"?e:null}function ze(e){n.callbacks.onTrendDrilldown=typeof e=="function"?e:null}function Ye(e){n.callbacks.onStatusDrilldown=typeof e=="function"?e:null}function Oe(e){n.callbacks.onPaymentDrilldown=typeof e=="function"?e:null}function d(e,t,a=t){const o=K()==="en"?a??t:t;return ke(e,o)}function Z(){n.formatters.cachedLocale=null,n.formatters.numberFormatter=null}function ne(){return(K()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function Ue(){const e=K();if(e!==n.formatters.cachedLocale||!n.formatters.numberFormatter){n.formatters.cachedLocale=e;const t=ne();n.formatters.numberFormatter=new Intl.NumberFormat(t,{maximumFractionDigits:0})}return{numberFormatter:n.formatters.numberFormatter}}function x(e){const{numberFormatter:t}=Ue(),a=t.format(Math.round(e||0));return T(a)}function D(e){return`${x(e)} SR`}function V(e){const t=e instanceof Date?e:new Date(e);if(!(t instanceof Date)||Number.isNaN(t.getTime()))return"";const a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${a}-${r}-${o}`}function Ve(e){if(!e)return"â€”";const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"â€”";const a=new Intl.DateTimeFormat(ne(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return T(a.format(t))}function We(e){return new Intl.DateTimeFormat(ne(),{month:"short"}).format(e)}function fe(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function he(e={}){const t=String(e?.barcode??"").trim(),a=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:a,description:a,name:e?.name??a,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function ye(e={}){const t=e?.title??e?.name??"",a=e?.project_code??e?.projectCode??"",r=e?.status??"",o=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:a,status:r,confirmed:o}}function Xe(){let e;try{e=Ee()}catch(l){return console.warn("âš ï¸ [reports] Failed to access cached data",l),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:a=[],equipment:r=[],technicians:o=[],projects:s=[],maintenance:i=[]}=e;return t.length||a.length||r.length||o.length||s.length?(n.data.reservations=Array.isArray(t)?t.map(Le):[],n.data.customers=Array.isArray(a)?a.map(fe):[],n.data.equipment=Array.isArray(r)?r.map(he):[],n.data.technicians=Array.isArray(o)?o.map(pe):[],n.data.projects=Array.isArray(s)?s.map(ye):[],n.data.projectsMap=new Map(n.data.projects.map(l=>[l.id,l])),n.data.maintenance=Array.isArray(i)?i.map(me):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(l=>[String(l.id),l])),!0):!1}async function ge({silent:e=!1}={}){if(!n.loading){n.loading=!0,n.errorMessage="",e||n.callbacks.onBeforeRender?.();try{const[t,a,r,o,s,i]=await Promise.all([$("/reservations/?limit=500"),$("/customers/?limit=500"),$("/equipment/?limit=500"),$("/technicians/?limit=500"),$("/projects/?limit=500"),$("/maintenance/?limit=500")]);n.data.reservations=Array.isArray(t?.data)?t.data.map(c=>Me(c)):[],n.data.customers=Array.isArray(a?.data)?a.data.map(fe):[],n.data.equipment=Array.isArray(r?.data)?r.data.map(he):[],n.data.technicians=Array.isArray(o?.data)?o.data.map(pe):[],n.data.projects=Array.isArray(s?.data)?s.data.map(ye):[],n.data.projectsMap=new Map(n.data.projects.map(c=>[c.id,c])),n.data.maintenance=Array.isArray(i?.data)?i.data.map(me):[],n.techniciansIndex=new Map((n.data.technicians||[]).map(c=>[String(c.id),c]))}catch(t){console.error("âŒ [reports] Failed to load reports data",t),n.errorMessage=t instanceof Re?t.message:d("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),n.data.reservations=[],n.data.customers=[],n.data.equipment=[],n.data.technicians=[],n.data.projects=[],n.data.projectsMap=new Map,n.data.maintenance=[],n.techniciansIndex=null}finally{n.loading=!1,e||n.callbacks.onAfterRender?.()}}}const Ke=new Map([["confirmed","confirmed"],["Ù…Ø¤ÙƒØ¯","confirmed"],["Ù…Ø¤ÙƒØ¯Ø©","confirmed"],["approved","confirmed"],["pending","pending"],["Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","pending"],["ØºÙŠØ± Ù…Ø¤ÙƒØ¯","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["Ù…Ù†ØªÙ‡ÙŠ","completed"],["Ù…Ù†ØªÙ‡ÙŠØ©","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["Ù…Ù„ØºÙŠ","cancelled"]]),ie=new Map([["paid",!0],["Ù…Ø¯ÙÙˆØ¹",!0],["Ù…Ø¯ÙÙˆØ¹Ø©",!0],["ØªÙ… Ø§Ù„Ø¯ÙØ¹",!0],["completed",!0],["unpaid",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",!1],["ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",!1],["pending",!1],["Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",!1]]),Ge=1440*60*1e3;function be(e){return T(String(e||"")).toLowerCase().trim()}function W(e){return(e||"").toString().trim()}function Qe(e,t){if(!e||!t)return 1;const a=new Date(e),r=new Date(t);if(Number.isNaN(a.getTime())||Number.isNaN(r.getTime()))return 1;const o=r.getTime()-a.getTime();return o<=0?1:Math.max(1,Math.ceil(o/Ge))}function ce(e){return e?(n.techniciansIndex||(n.techniciansIndex=new Map((n.data.technicians||[]).map(t=>[String(t.id),t]))),n.techniciansIndex.get(String(e))||null):null}function ve(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const a of t){if(a==null)continue;const r=Number.parseFloat(T(String(a)));if(Number.isFinite(r))return r}return 0}function Ze(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];for(const a of t){if(a==null)continue;const r=Number.parseFloat(T(String(a)));if(Number.isFinite(r))return r}return ve(e)}function z(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;const t=Qe(e.start,e.end),r=(e.items||[]).reduce((N,P)=>{const q=Number(P?.qty)||Number(P?.quantity)||1,Te=Number(P?.price)||Number(P?.unit_price)||0;return N+q*Te},0)*t,o=(e.technicians||[]).reduce((N,P)=>{const q=ce(P);return N+ve(q)},0),s=(e.technicians||[]).reduce((N,P)=>{const q=ce(P);return N+Ze(q)},0),i=o*t,c=s*t,l=r+c,m=Number(e.discount)||0;let p=(e.discountType||e.discount_type||"percent")==="amount"?m:l*(m/100);(!Number.isFinite(p)||p<0)&&(p=0),p>l&&(p=l);const f=Math.max(0,l-p),h=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1",g=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,b=g!=null?Number.parseFloat(T(String(g).replace("%","").trim())):NaN,v=e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null;let L=v!=null?v===!0||v===1||v==="1"||String(v).toLowerCase()==="true":Number.isFinite(b)&&b>0,C=L&&Number.isFinite(b)?Number(b):0;h&&C<=0&&(C=Ie,L=!0);let E=C>0?Math.max(0,f*(C/100)):0;E=Number.isFinite(E)?Number(E.toFixed(2)):0;const M=f+E;let R=h?M*.15:0;(!Number.isFinite(R)||R<0)&&(R=0),R=Number(R.toFixed(2));const Y=M+R,S=Number(e.cost);let H=Number.isFinite(Y)?Number(Y.toFixed(2)):0;if(Number.isFinite(S)&&S>0&&(H=S,h)){const N=H-M;Number.isFinite(N)&&N>=0&&(R=Number(N.toFixed(2)))}const Q=Math.max(0,r+c-p),Ce=Math.max(0,Q-i),oe={rentalDays:t,equipmentTotal:r,crewTotal:c,crewCostTotal:i,discountAmount:p,subtotalAfterDiscount:f,taxableAmount:M,taxAmount:R,finalTotal:H,companySharePercent:C,companyShareAmount:E,netProfit:Ce,companyShareEnabled:L};return e.__financials=oe,oe}function xe(e){return e?.projectId&&n.data.projectsMap.get(String(e.projectId))||null}function le(e=""){const t=String(e).toLowerCase().trim();return t?Ke.get(t)||t:""}function Je(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const a of t){const r=String(a||"").toLowerCase().trim();if(r&&ie.has(r))return ie.get(r)}return e?.paid===!0||e?.paid==="true"}function j(e){const t=xe(e),a=Ae(e,t),r=le(a.projectStatus);let o=le(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");a.projectLinked&&r&&(o=r),(!o||o==="cancelled")&&(o=a.effectiveConfirmed?"confirmed":"pending"),(Pe(e)||r==="completed")&&(o="completed");const s=a.effectiveConfirmed||o==="confirmed"||o==="completed";s&&o!=="completed"&&(o="confirmed");const i=Je(e),c=e?.paidStatus??e?.paid_status??(i?"paid":"unpaid");return{statusValue:o,confirmed:s,paid:i,paidStatus:c}}function et(e){const t=e.length;let a=0,r=0,o=0,s=0,i=0,c=0,l=0,m=0,u=0;e.forEach(f=>{const{statusValue:h,confirmed:g,paid:b}=j(f);h==="completed"&&(r+=1),g&&(a+=1),b&&(o+=1);const v=z(f);s+=v.finalTotal,i+=v.companyShareAmount,c+=v.taxAmount,l+=v.crewTotal,m+=v.crewCostTotal??0,u+=v.netProfit});const p=t?s/t:0;return{total:t,confirmed:a,completed:r,paidCount:o,revenue:s,average:p,companyShareTotal:i,taxTotal:c,crewTotal:l,crewCostTotal:m,netProfit:u}}function we({range:e,start:t,end:a}){const r=new Date;if(r.setHours(23,59,59,999),e==="custom"){const i=t?new Date(`${t}T00:00:00`):null,c=a?new Date(`${a}T23:59:59`):null;return{startDate:ue(i)?i:null,endDate:ue(c)?c:null}}let o=new Date(r),s=null;switch(e){case"last30":{s=new Date(r),s.setDate(s.getDate()-29);break}case"thisWeek":{const i=new Date(r),l=(i.getDay()-6+7)%7;i.setDate(i.getDate()-l),i.setHours(0,0,0,0);const m=new Date(i);m.setDate(i.getDate()+6),m.setHours(23,59,59,999),s=i,o=m;break}case"thisMonth":{s=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const i=Math.floor(r.getMonth()/3);s=new Date(r.getFullYear(),i*3,1),o=new Date(r.getFullYear(),(i+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{s=new Date(r.getFullYear(),0,1),o=new Date(r.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:s=null,o=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:o}}function ue(e){return e instanceof Date&&!Number.isNaN(e.getTime())}function tt(e,t){const{startDate:a,endDate:r}=we(t);let o=0;const s=[];return(e||[]).forEach(i=>{if(!i)return;const c=typeof i.repairCost=="number"?i.repairCost:Number.parseFloat(T(String(i.repairCost??"")));if(!Number.isFinite(c)||c<=0)return;const l=String(i.statusRaw??i.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const u=i.resolvedAt??i.resolved_at??null,p=i.reportedAt??i.reported_at??null,f=i.createdAt??i.created_at??null,h=u?new Date(u):null,g=p?new Date(p):f?new Date(f):null,b=h&&!Number.isNaN(h.getTime())?h:g&&!Number.isNaN(g.getTime())?g:null;if(b&&(a&&b<a||r&&b>r))return;const v=Math.round(c*100)/100;o+=v,s.push({id:i.id,cost:v,date:b})}),{total:o,items:s}}function nt(e,t){const a=Number.isFinite(t)?t:0;return{...e,maintenanceExpense:a,netProfit:(e.netProfit||0)-a}}function at(e){const t=new Date,a=[];for(let r=5;r>=0;r-=1){const o=new Date(t.getFullYear(),t.getMonth()-r,1),s=o.getFullYear(),i=o.getMonth(),c=e.filter(b=>{const v=b?.start?new Date(b.start):null;return v&&v.getFullYear()===s&&v.getMonth()===i}),l=c.length;let m=0,u=0,p=0;c.forEach(b=>{const v=z(b);m+=v.finalTotal,u+=v.netProfit,p+=v.companyShareAmount});const f=We(o),h=new Date(o.getFullYear(),o.getMonth(),1),g=new Date(o.getFullYear(),o.getMonth()+1,0);a.push({label:f,count:l,revenue:m,netProfit:u,companyShare:p,periodStart:h,periodEnd:g,startInput:V(h),endInput:V(g)})}return a}function rt(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(i=>{const{statusValue:c,confirmed:l}=j(i);c==="completed"?t.completed+=1:c==="confirmed"||l?t.confirmed+=1:t.pending+=1});const a=Math.max(1,(e||[]).length),r=t.confirmed,o=t.pending,s=t.completed;return[{label:d("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-confirmed",filterKey:"confirmed"},{label:d("reservations.reports.status.pendingLabel","Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯","Pending confirmation"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:d("reservations.reports.status.completedLabel","Ù…Ù†ØªÙ‡ÙŠØ©","Completed"),value:s,percent:Math.round(s/a*100)||0,rawCount:s,className:"status-completed",filterKey:"completed"}]}function st(e){const t=e.length||1,a=e.filter(o=>j(o).paid).length,r=e.length-a;return[{label:d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-paid",filterKey:"paid"},{label:d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid"),value:r,percent:Math.round(r/t*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}]}function ot(e,t){const a=new Map,r=new Map((t||[]).map(o=>[String(o.id),o]));return e.forEach(o=>{const s=String(o?.customerId??"unknown"),i=a.get(s)||{count:0,revenue:0},c=z(o);i.count+=1,i.revenue+=c.finalTotal,a.set(s,i)}),Array.from(a.entries()).map(([o,s])=>({name:r.get(o)?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),count:s.count,revenue:s.revenue})).sort((o,s)=>s.revenue-o.revenue).slice(0,5)}function it(e,t){const a=new Map,r=new Map((t||[]).map(s=>[W(s?.barcode),s])),o=d("reservations.reports.topEquipment.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…","Unnamed equipment");return e.forEach(s=>{(s?.items||[]).forEach(i=>{const c=W(i?.barcode),l=c?r.get(c):null,m=i?.desc||i?.description||i?.name||l?.desc||l?.description||l?.name||"",u=m&&m.trim()?m:o,p=Ne(u)||"unknown",f=Number(i?.qty)||1,h=Number(i?.price)||0,g=f*h,b=a.get(p)||{name:u,count:0,revenue:0};b.name=u,b.count+=f,b.revenue+=g,a.set(p,b)})}),Array.from(a.values()).sort((s,i)=>i.count!==s.count?i.count-s.count:i.revenue-s.revenue).slice(0,5)}function ct(e,t,a,r,o){const s=[],i=e?.reservationId||e?.id;i&&s.push(i),e?.notes&&s.push(e.notes);const{statusValue:c,paidStatus:l}=j(e);c&&s.push(c);const m=e?.paymentStatus||e?.payment_status;m&&s.push(m),e?.paid!=null&&s.push(e.paid?"paid":"unpaid"),l&&s.push(l);const u=a.get(String(e?.customerId));u&&s.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const p=xe(e);return p&&s.push(p.title,p.code,p.status),s.push(De(l)),(e?.items||[]).forEach(h=>{h?.desc&&s.push(h.desc),h?.barcode&&s.push(h.barcode);const g=r.get(W(h?.barcode));g&&s.push(g.desc,g.description,g.name)}),(e?.technicians||[]).forEach(h=>{const g=o.get(String(h));g&&s.push(g.name,g.role,g.department)}),be(s.filter(Boolean).join(" ")).includes(t)}function lt(e,t,a,r,o){const{startDate:s,endDate:i}=we(t),c=be(t.search),l=!!c,m=new Map((a||[]).map(f=>[String(f.id),f])),u=new Map((r||[]).map(f=>[W(f?.barcode),f])),p=new Map((o||[]).map(f=>[String(f.id),f]));return(e||[]).filter(f=>{const h=f?.start?new Date(f.start):null;if(!h||Number.isNaN(h.getTime())||s&&h<s||i&&h>i)return!1;const{statusValue:g,confirmed:b,paid:v}=j(f);if(t.status==="confirmed"&&!(g==="confirmed"||g==="completed"||b)||t.status==="pending"&&g!=="pending"||t.status==="completed"&&g!=="completed"||t.payment==="paid"&&!v||t.payment==="unpaid"&&v)return!1;if(t.share&&t.share!=="all"){const C=z(f).companySharePercent>0;if(t.share==="with"&&!C||t.share==="without"&&C)return!1}return!(l&&!ct(f,c,m,u,p))})}function De(e){const t=String(e??"").toLowerCase();return t==="paid"?d("reservations.reports.payment.paidLabel","Ù…Ø¯ÙÙˆØ¹Ø©","Paid"):t==="partial"?d("reservations.reports.payment.partialLabel","Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹","Partially paid"):d("reservations.reports.payment.unpaidLabel","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©","Unpaid")}function ae(e){if(n.loadedScripts.has(e))return n.loadedScripts.get(e);const t=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,a=new Promise((r,o)=>{const s=()=>{t&&(t.dataset.loaded="true"),r()},i=l=>o(l);if(t){if(t.dataset.loaded==="true"){r();return}t.addEventListener("load",s,{once:!0}),t.addEventListener("error",i,{once:!0});return}const c=document.createElement("script");c.src=e,c.async=!0,c.onload=()=>{c.dataset.loaded="true",r()},c.onerror=l=>o(l),document.head.appendChild(c)});return n.loadedScripts.set(e,a),a}function re(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(n.apexChartsReady||(n.apexChartsReady=ae("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),n.apexChartsReady)}function ut(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(n.html2PdfReady||(n.html2PdfReady=ae("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),n.html2PdfReady)}function dt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(n.xlsxReady||(n.xlsxReady=ae("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),n.xlsxReady)}function X(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function I(e,t){const a=document.getElementById(e);if(a){if(!t||t.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}a.innerHTML=t.map(r=>{const o=Math.min(Math.max(r.percent??0,0),100),s=d("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",x(r.rawCount??r.value??0)),i=r.className?`reports-progress-fill ${r.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${r.label}</span>
            <span class="reports-progress-value">${x(r.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${o}%;"></div>
          </div>
          <div class="reports-progress-meta">${s}</div>
        </div>
      `}).join("")}}async function pt(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const a=Array.isArray(e)?e:[];if(n.lastTrendData=a,!a.length){n.charts.trend&&(n.charts.trend.destroy(),n.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const r=await re();if(!r){t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const o=a.map(u=>u.label),s=a.map(u=>Math.round(u.count||0)),i=a.map(u=>Math.round(u.revenue||0)),c=a.map(u=>Math.round(u.netProfit||0)),l=[{name:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:s},{name:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:i},{name:d("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:c,yAxisIndex:1}],m={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(u,p,f)=>{if(f?.dataPointIndex!=null){const h=n.lastTrendData[f.dataPointIndex];n.callbacks.onTrendDrilldown?.(h,f.dataPointIndex)}}}},theme:{mode:X()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:o,labels:{style:{colors:X()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:u=>x(u)},title:{text:d("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:u=>D(u)},title:{text:d("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(u,{seriesIndex:p})=>p===0?x(u):D(u)}}};n.charts.trend?(n.charts.trend.updateOptions({...m},!0,!0),n.charts.trend.updateSeries(l,!0)):(t.innerHTML="",n.charts.trend=new r(t,{...m,series:l}),n.charts.trend.render())}catch(r){console.error("âš ï¸ [reports] Failed to render trend chart",r),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function mt(e){const t=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!t)return;const r=Array.isArray(e)?e:[];if(n.lastStatusData=r,!r.length){n.charts.status&&(n.charts.status.destroy(),n.charts.status=null),I(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await re();if(!o){I(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const s=r.map(l=>Math.max(0,l.value||0)),i=r.map(l=>l.label),c={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(l,m,u)=>{if(u?.dataPointIndex!=null){const p=n.lastStatusData[u.dataPointIndex];p?.filterKey&&n.callbacks.onStatusDrilldown?.(p,u.dataPointIndex)}}}},theme:{mode:X()},labels:i,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:l=>`${Math.round(l)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:d("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>x(s.reduce((l,m)=>l+m,0))}}}}},tooltip:{y:{formatter:(l,m)=>{const u=n.lastStatusData?.[m?.seriesIndex||0],p=u?`${x(u.percent)}%`:`${x(l)}%`;return`${x(u?u.rawCount??u.value??0:l)} / ${p}`}}}};n.charts.status?(n.charts.status.updateOptions({...c},!0,!0),n.charts.status.updateSeries(s,!0)):(t.innerHTML="",n.charts.status=new o(t,{...c,series:s}),n.charts.status.render()),I(a,r)}catch(o){console.error("âš ï¸ [reports] Failed to render status chart",o),I(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}async function ft(e){const t=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!t)return;const r=Array.isArray(e)?e:[];if(n.lastPaymentData=r,!r.length){n.charts.payment&&(n.charts.payment.destroy(),n.charts.payment=null),I(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await re();if(!o){I(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const s=r.map(l=>Math.max(0,l.value||0)),i=r.map(l=>l.label),c={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(l,m,u)=>{if(u?.dataPointIndex!=null){const p=n.lastPaymentData[u.dataPointIndex];p?.filterKey&&n.callbacks.onPaymentDrilldown?.(p,u.dataPointIndex)}}}},theme:{mode:X()},labels:i,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:l=>`${Math.round(l)}%`},tooltip:{y:{formatter:(l,m)=>{const u=n.lastPaymentData?.[m?.seriesIndex||0],p=u?`${x(u.percent)}%`:`${x(l)}%`;return`${x(u?u.rawCount??u.value??0:l)} / ${p}`}}}};n.charts.payment?(n.charts.payment.updateOptions({...c},!0,!0),n.charts.payment.updateSeries(s,!0)):(t.innerHTML="",n.charts.payment=new o(t,{...c,series:s}),n.charts.payment.render()),I(a,r)}catch(o){console.error("âš ï¸ [reports] Failed to render payment chart",o),I(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${d("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`}}function ht(e){const t=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),r=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),l=document.getElementById("reports-kpi-paid"),m=document.getElementById("reports-kpi-paid-meta"),u=e.total||0,p=e.revenue||0,f=e.confirmed||0,h=e.paidCount||0,g=e.average||0,b=e.companyShareTotal||0,v=e.taxTotal||0,L=e.crewTotal||0,C=e.crewCostTotal||0,E=e.netProfit||0,M=e.maintenanceExpense||0,R=u?Math.round(f/u*100):0,Y=u?Math.round(h/u*100):0;if(t&&(t.textContent=x(u)),a){const S=d("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",x(e.completed||0));a.textContent=S}if(r&&(r.textContent=D(p)),o){const S=d("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");o.textContent=S.replace("{net}",D(E)).replace("{share}",D(b)).replace("{average}",D(g))}if(s)if(p>0){const S=[{label:d("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:D(p)},{label:d("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:D(b)},{label:d("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:D(v)},{label:d("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:D(L)},{label:d("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:D(C)}];M>0&&S.push({label:d("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${D(M)}`}),S.push({label:d("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:D(E)}),s.innerHTML=S.map(({label:H,value:Q})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${H}</span>
            <span class="reports-kpi-detail-value">${Q}</span>
          </div>
        `).join(""),s.classList.remove("hidden")}else s.innerHTML="",s.classList.add("hidden");if(i&&(i.textContent=`${R}%`),c){const S=d("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",x(f));c.textContent=S}if(l&&(l.textContent=`${Y}%`),m){const S=d("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",x(h));m.textContent=S}}function k(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function G(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function yt(e,t,a){const r=document.getElementById("reports-reservations-body");if(!r)return[];if(!e||e.length===0)return r.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const o=new Map((t||[]).map(c=>[String(c.id),c]));new Map((a||[]).map(c=>[String(c.id),c]));const s={code:d("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:d("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),date:d("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:d("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:d("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),total:d("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:d("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),net:d("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},i=[...e].sort((c,l)=>new Date(l.start||0)-new Date(c.start||0)).slice(0,20).map(c=>{const l=gt(c,o),m={[s.code]:l.code.text,[s.customer]:l.customer.text,[s.date]:l.date.text,[s.status]:l.status.text,[s.payment]:l.payment.text,[s.total]:l.total.text,[s.share]:l.share.text,[s.net]:l.net.text};return{formatted:l,exportRow:m}});return r.innerHTML=i.map(({formatted:c})=>`
      <tr data-drilldown="reservation" data-search="${G(c.code.text)}">
        <td data-report-column="code">${c.code.html}</td>
        <td data-report-column="customer">${c.customer.html}</td>
        <td data-report-column="date">${c.date.html}</td>
        <td data-report-column="status">${c.status.html}</td>
        <td data-report-column="payment">${c.payment.html}</td>
        <td data-report-column="total">${c.total.html}</td>
        <td data-report-column="share">${c.share.html}</td>
        <td data-report-column="net">${c.net.html}</td>
      </tr>
    `).join(""),i.map(({exportRow:c})=>c)}function gt(e,t,a){const r=e?.reservationId||e?.id||"â€”",o=T(String(r)),i=t.get(String(e?.customerId))?.customerName||d("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),c=j(e),l=bt(c.statusValue),m=vt(c.statusValue,l),u=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],p=xt(c.paidStatus,u),f=u.length;let h=p.html;if(f>0){const M=d("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",x(f));h=`<div class="reports-payment-cell">${p.html}<small class="reports-payment-subtext">${k(M)}</small></div>`}const g=Ve(e?.start),b=z(e),v=D(b.finalTotal),L=b.companySharePercent>0?`${x(b.companySharePercent)}% (${D(b.companyShareAmount)})`:d("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),C=D(b.netProfit),E=k(i);return{code:{html:k(o),text:o},customer:{html:E,text:i},date:{html:k(g),text:g},status:m,payment:{html:h,text:p.text},total:{html:k(v),text:v},share:{html:k(L),text:L},net:{html:k(C),text:C}}}function bt(e){switch(e){case"completed":return O(d("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return O(d("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return O(d("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));default:return T(e||"â€”")}}function vt(e,t){const a=O(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${k(a)}</span>`,text:a}}function xt(e,t=[]){const a=De(e),r=String(e??"").toLowerCase(),o=r==="paid"?"paid":r==="partial"?"partial":"unpaid";let s="";const i=d("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(t)&&t.length&&(s=t.map(m=>{const u=m?.recordedAt?V(m.recordedAt):"â€”",p=Number.isFinite(Number(m?.amount))&&Number(m.amount)>0?`${T(Number(m.amount).toFixed(2))} ${i}`:"",f=Number.isFinite(Number(m?.percentage))&&Number(m.percentage)>0?`${T(Number(m.percentage).toFixed(2))}%`:"",h=[u];return p&&h.push(p),f&&h.push(f),h.filter(Boolean).join(" â€¢ ")}).join(`
`));const c=s?` title="${G(s)}"`:"";return{html:`<span class="reservation-chip status-${o}"${c}>${k(a)}</span>`,text:a}}function O(e){return T(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function se(e){const t=V(new Date).replace(/-/g,"");return`${d("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${t}.${e}`}function wt(e,t,a){const r=new Blob([e],{type:a}),o=URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(o),4e3)}function J(e){if(!e||!e.length)return;const t=Object.keys(e[0]),a=[t.join(",")];e.forEach(o=>{const s=t.map(i=>`"${String(o[i]??"").replace(/"/g,'""')}"`);a.push(s.join(","))});const r=`\uFEFF${a.join(`\r
`)}\r
`;wt(r,se("csv"),"text/csv;charset=utf-8;")}async function Dt(e){try{const t=await dt();if(!t){J(e);return}const a=t.utils.json_to_sheet(e),r=t.utils.book_new(),o=d("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");t.utils.book_append_sheet(r,a,o),t.writeFile(r,se("xlsx"))}catch(t){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",t),J(e)}}async function St(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await ut();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const a=se("pdf");Fe();const r=[];$e(e,window,r),Be(e,window,r);try{await t().set({margin:10,filename:a,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{_e(r)}}async function Ct(e,t){switch(e){case"pdf":await St();break;case"excel":await Dt(t);break;case"csv":default:J(t);break}}function Tt(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${G(a.name)}">
        <td>${k(a.name)}</td>
        <td>${x(a.count)}</td>
        <td>${D(a.revenue)}</td>
      </tr>
    `).join("")}}function kt(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${d("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${G(a.name)}">
        <td>${k(a.name)}</td>
        <td>${x(a.count)}</td>
        <td>${D(a.revenue)}</td>
      </tr>
    `).join("")}}const A=n.filters;function Et(e){if(n.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(a=>{const r=a.dataset.columnToggle;r&&(a.checked=n.columnPreferences[r]!==!1,a.addEventListener("change",()=>{n.columnPreferences[r]=a.checked,e()}))}),n.columnControlsBound=!0,e())}function Se(){Object.entries(n.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(a=>{a.classList.toggle("hidden",!t)})})}function Rt(e){if(n.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(a=>{a.addEventListener("click",async()=>{const{export:r=""}=a.dataset;if(r){a.disabled=!0;try{await e(r)}catch(o){console.error("âš ï¸ [reports] export failed",o)}finally{a.disabled=!1}}})}),n.exportHandlersBound=!0)}function Lt(e,t){n.searchDebounceTimer&&(clearTimeout(n.searchDebounceTimer),n.searchDebounceTimer=null),n.searchDebounceTimer=setTimeout(()=>{A.search=e||"",t()},220)}function Mt(e,t){e&&(A.range="custom",A.start=e.startInput||null,A.end=e.endInput||null,t())}function Nt(e,t){e&&(A.status=A.status===e?"all":e,t())}function At(e,t){e&&(A.payment=A.payment===e?"all":e,t())}function Pt(e,t){e&&(A.search=e,t())}const y=n.filters;function de(){Z(),w(),setTimeout(()=>{Z(),w(),U()},0),setTimeout(()=>{Z(),w(),U()},60),U()}function _(){y.range==="custom"&&w()}function U(e,t){if(!window.flatpickr)return;e&&(n.startDateInputRef=e),t&&(n.endDateInputRef=t);const a=n.startDateInputRef,r=n.endDateInputRef;if(!a&&!r)return;const o=It(),s=i=>{const c={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return o&&(c.locale=o),c};if(n.startDatePicker&&(n.startDatePicker.destroy(),n.startDatePicker=null),n.endDatePicker&&(n.endDatePicker.destroy(),n.endDatePicker=null),a&&(n.startDatePicker=window.flatpickr(a,s({onChange(i,c){y.start=c||null,n.endDatePicker&&(i?.length?n.endDatePicker.set("minDate",i[0]):n.endDatePicker.set("minDate",null)),_()},onValueUpdate(i,c){y.start=c||null,_()}}))),r&&(n.endDatePicker=window.flatpickr(r,s({onChange(i,c){y.end=c||null,n.startDatePicker&&(i?.length?n.startDatePicker.set("maxDate",i[0]):n.startDatePicker.set("maxDate",null)),_()},onValueUpdate(i,c){y.end=c||null,_()}}))),n.startDatePicker&&a){n.startDatePicker.setDate(a.value,!1);const i=n.endDatePicker?.selectedDates?.[0]||n.endDateInputRef?.value;i&&n.startDatePicker.set("maxDate",i)}if(n.endDatePicker&&r){n.endDatePicker.setDate(r.value,!1);const i=n.startDatePicker?.selectedDates?.[0]||n.startDateInputRef?.value;i&&n.endDatePicker.set("minDate",i)}}function It(){return(K()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function ee(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function F(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),r=document.getElementById("reports-share-filter"),o=document.getElementById("reports-search"),s=document.getElementById("reports-start"),i=document.getElementById("reports-end"),c=document.getElementById("reports-custom-range");e&&e.value!==y.range&&(e.value=y.range),t&&t.value!==y.status&&(t.value=y.status),a&&a.value!==y.payment&&(a.value=y.payment),r&&r.value!==y.share&&(r.value=y.share),o&&o.value!==y.search&&(o.value=y.search||""),s&&s.value!==(y.start||"")&&(s.value=y.start||""),i&&i.value!==(y.end||"")&&(i.value=y.end||""),ee(c,y.range==="custom")}function te({active:e,icon:t,title:a,subtitle:r}){const o=document.getElementById("reports-empty-state");if(!o)return;const s=o.querySelector(".reports-empty-icon"),i=o.querySelector("h4"),c=o.querySelector("p");n.emptyDefaults.icon===null&&s&&(n.emptyDefaults.icon=s.textContent),n.emptyDefaults.title===null&&i&&(n.emptyDefaults.title=i.textContent),n.emptyDefaults.subtitle===null&&c&&(n.emptyDefaults.subtitle=c.textContent),o.classList.toggle("active",!!e),o.classList.toggle("hidden",!e),!(!s||!i||!c)&&(e?(s.textContent=t!==void 0?t:n.emptyDefaults.icon??s.textContent,i.textContent=a!==void 0?a:n.emptyDefaults.title??i.textContent,c.textContent=r!==void 0?r:n.emptyDefaults.subtitle??c.textContent):(s.textContent=n.emptyDefaults.icon??s.textContent,i.textContent=n.emptyDefaults.title??i.textContent,c.textContent=n.emptyDefaults.subtitle??c.textContent))}function Ft(e){te({active:!!e})}function $t(){if(n.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),r=o=>{const s=o.target?.closest("[data-drilldown]");if(!s)return;const i=s.dataset.search||"";Pt(i,()=>{F(),w()})};e?.addEventListener("click",r),t?.addEventListener("click",r),a?.addEventListener("click",r),n.drilldownBound=!0}function B(){ge({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function w(){if(F(),n.loading){te({active:!0,icon:"â³",title:d("reservations.reports.status.loading","Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±..."),subtitle:d("reservations.reports.status.loadingHint","Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.")});return}if(n.errorMessage){te({active:!0,icon:"âš ï¸",title:n.errorMessage,subtitle:d("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}const{reservations:e,customers:t,equipment:a,technicians:r,maintenance:o}=n.data,s=lt(e,y,t,a,r),i=et(s),c=tt(o,y),l=nt(i,c.total),m=at(s),u=rt(s),p=st(s),f=ot(s,t),h=it(s,a);ht(l),pt(m),mt(u),ft(p),Tt(f),kt(h);const g=yt(s,t,r);Se(),Ft(s.length===0),n.lastSnapshot.filtered=s,n.lastSnapshot.metrics=l,n.lastSnapshot.trend=m,n.lastSnapshot.statusBreakdown=u,n.lastSnapshot.paymentBreakdown=p,n.lastSnapshot.tableRows=g,n.lastSnapshot.maintenance=c}function Yt(){if(n.initialized)return;n.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),r=document.getElementById("reports-share-filter"),o=document.getElementById("reports-start"),s=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),c=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;F(),Xe()&&w(),e.addEventListener("change",()=>{y.range=e.value,ee(c,y.range==="custom"),y.range!=="custom"&&(y.start=null,y.end=null),w()}),t?.addEventListener("change",()=>{y.status=t.value,w()}),a?.addEventListener("change",()=>{y.payment=a.value,w()}),r?.addEventListener("change",()=>{y.share=r.value,w()}),l?.addEventListener("input",()=>{const u=l.value||"";Lt(u,()=>{F(),w()})}),o?.addEventListener("change",()=>{y.start=o.value||null,_()}),s?.addEventListener("change",()=>{y.end=s.value||null,_()}),i?.addEventListener("click",()=>{y.range==="custom"&&(y.start=o?.value||null,y.end=s?.value||null),w()}),U(o,s),ee(c,y.range==="custom"),n.languageListenerAttached||(document.addEventListener("language:changed",de),document.addEventListener("language:translationsReady",de),n.languageListenerAttached=!0),n.dataListenersAttached||(document.addEventListener("reservations:changed",B),document.addEventListener("customers:changed",B),document.addEventListener("equipment:changed",B),document.addEventListener("projects:changed",B),document.addEventListener("technicians:updated",B),window.addEventListener("maintenance:updated",B),n.dataListenersAttached=!0),Et(Se),Rt(async u=>{const p=n.lastSnapshot.tableRows||[];if(!p.length){console.warn("[reports] No reservation data to export");return}await Ct(u,p)}),$t(),n.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>w(),0)}),n.themeListenerAttached=!0),je(w),He(()=>{w()}),qe(()=>{w()}),ze(u=>{Mt(u,()=>{F(),w()})}),Ye(u=>{Nt(u?.filterKey,()=>{F(),w()})}),Oe(u=>{At(u?.filterKey,()=>{F(),w()})}),ge().catch(u=>{console.error("âŒ [reports] Failed to initialise reports data",u)})}export{Yt as initReports,w as renderReports};
