import{n as H,r as K,i as U,p as O,l as W,m as E}from"./reservationsService.CvB8O3yO.js";import{t as G,n as N,g as k}from"./auth.Cojl8C1z.js";const y={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function rt(t){y.callbacks.onRender=typeof t=="function"?t:null}function ot(t){y.callbacks.onBeforeRender=typeof t=="function"?t:null}function st(t){y.callbacks.onAfterRender=typeof t=="function"?t:null}function ct(t){y.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function lt(t){y.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function ut(t){y.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function w(t,e,s=e){const a=k()==="en"?s??e:e;return G(t,a)}function it(){y.formatters.cachedLocale=null,y.formatters.numberFormatter=null}function L(){return(k()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function $(){const t=k();if(t!==y.formatters.cachedLocale||!y.formatters.numberFormatter||!y.formatters.currencyFormatter){y.formatters.cachedLocale=t;const e=L();y.formatters.numberFormatter=new Intl.NumberFormat(e,{maximumFractionDigits:0}),y.formatters.currencyFormatter=new Intl.NumberFormat(e,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:y.formatters.numberFormatter,currencyFormatter:y.formatters.currencyFormatter}}function mt(t){const{numberFormatter:e}=$(),s=e.format(Math.round(t||0));return N(s)}function pt(t){const{currencyFormatter:e}=$(),s=Number.isFinite(Number(t))?Number(t):0,n=e.format(s);return`${N(n)} SR`}function I(t){const e=t instanceof Date?t:new Date(t);if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${a}`}function dt(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const s=new Intl.DateTimeFormat(L(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return N(s.format(e))}function Q(t){return new Intl.DateTimeFormat(L(),{month:"short"}).format(t)}const J=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),Y=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),X=1440*60*1e3,b={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function A(t){const e=Array.isArray(t)?t.length:0;if(e===0)return"0|";const s=t[0]||{},n=t[e-1]||{},a=`${s.id??s.reservationId??""}-${s.start??""}`,r=`${n.id??n.reservationId??""}-${n.start??""}`,o=y.formatters?.cachedLocale||"ar";return`${e}|${a}|${r}|${o}`}function C(t,e){return t.get(e)}function F(t,e,s){if(t.set(e,s),t.size>64){const n=t.keys().next().value;t.delete(n)}return s}function B(t){return N(String(t||"")).toLowerCase().trim()}function R(t){return(t||"").toString().trim()}function Z(t,e){if(!t||!e)return 1;const s=new Date(t),n=new Date(e);if(Number.isNaN(s.getTime())||Number.isNaN(n.getTime()))return 1;const a=n.getTime()-s.getTime();return a<=0?1:Math.max(1,Math.ceil(a/X))}function x(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;Z(t.start,t.end);const e=Number(t.discount??t.discountValue??0)||0,s=t.discountType||t.discount_type||"percent",n=String(s).toLowerCase()==="amount"?"amount":"percent",a=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",r=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,o=r!=null?O(r):Number.NaN,c=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(o)&&o>0?o:null,l=Array.isArray(t.crewAssignments)?t.crewAssignments:[],f=l.length?l.map(h=>h?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],m=W({items:Array.isArray(t.items)?t.items:[],technicianIds:f,crewAssignments:l,discount:e,discountType:n,applyTax:a,start:t.start,end:t.end,companySharePercent:c}),i=Number(t.cost);let d=m.finalTotal,p=m.taxAmount;if(Number.isFinite(i)&&i>0&&(d=E(i),a)){const h=d-m.taxableAmount;Number.isFinite(h)&&h>=0&&(p=E(h))}const g={rentalDays:m.rentalDays,equipmentTotal:m.equipmentTotal,crewTotal:m.crewTotal,crewCostTotal:m.crewCostTotal,discountAmount:m.discountAmount,subtotalAfterDiscount:m.subtotalAfterDiscount,taxableAmount:m.taxableAmount,taxAmount:p,finalTotal:d,companySharePercent:m.companySharePercent,companyShareAmount:m.companyShareAmount,netProfit:m.netProfit,companyShareEnabled:m.companySharePercent>0};return t.__financials=g,g}function z(t){return t?.projectId&&y.data.projectsMap.get(String(t.projectId))||null}function j(t=""){const e=String(t).toLowerCase().trim();return e?J.get(e)||e:""}function v(t){const e=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const s of e){const n=String(s||"").toLowerCase().trim();if(n&&Y.has(n))return Y.get(n)}return t?.paid===!0||t?.paid==="true"}function P(t){const e=z(t),s=K(t,e),n=j(s.projectStatus);let a=j(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");s.projectLinked&&n&&a!=="cancelled"&&(a=n),a||(a=s.effectiveConfirmed?"confirmed":"pending"),a!=="cancelled"&&(U(t)||n==="completed")&&(a="completed");const r=s.effectiveConfirmed||a==="confirmed"||a==="completed";r&&a!=="completed"&&(a="confirmed");const o=v(t),u=t?.paidStatus??t?.paid_status??(o?"paid":"unpaid");return{statusValue:a,confirmed:r,paid:o,paidStatus:u}}function ft(t){const e=t.length;let s=0,n=0,a=0,r=0,o=0,u=0,c=0,l=0,f=0;t.forEach(i=>{const{statusValue:d,confirmed:p,paid:g}=P(i);d==="completed"&&(n+=1),p&&(s+=1),g&&(a+=1);const h=x(i);r+=h.finalTotal,o+=h.companyShareAmount,u+=h.taxAmount,c+=h.crewTotal,l+=h.crewCostTotal??0,f+=h.netProfit});const m=e?r/e:0;return{total:e,confirmed:s,completed:n,paidCount:a,revenue:r,average:m,companyShareTotal:o,taxTotal:u,crewTotal:c,crewCostTotal:l,netProfit:f}}function V({range:t,start:e,end:s}){const n=new Date;if(n.setHours(23,59,59,999),t==="custom"){const o=e?new Date(`${e}T00:00:00`):null,u=s?new Date(`${s}T23:59:59`):null;return{startDate:q(o)?o:null,endDate:q(u)?u:null}}let a=new Date(n),r=null;switch(t){case"last30":{r=new Date(n),r.setDate(r.getDate()-29);break}case"thisWeek":{const o=new Date(n),c=(o.getDay()-6+7)%7;o.setDate(o.getDate()-c),o.setHours(0,0,0,0);const l=new Date(o);l.setDate(o.getDate()+6),l.setHours(23,59,59,999),r=o,a=l;break}case"thisMonth":{r=new Date(n.getFullYear(),n.getMonth(),1),a=new Date(n.getFullYear(),n.getMonth()+1,0),a.setHours(23,59,59,999);break}case"thisQuarter":{const o=Math.floor(n.getMonth()/3);r=new Date(n.getFullYear(),o*3,1),a=new Date(n.getFullYear(),(o+1)*3,0),a.setHours(23,59,59,999);break}case"thisYear":{r=new Date(n.getFullYear(),0,1),a=new Date(n.getFullYear(),12,0),a.setHours(23,59,59,999);break}case"all":default:r=null,a=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:a}}function q(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function ht(t,e){const{startDate:s,endDate:n}=V(e);let a=0;const r=[];return(t||[]).forEach(o=>{if(!o)return;const u=typeof o.repairCost=="number"?o.repairCost:Number.parseFloat(N(String(o.repairCost??"")));if(!Number.isFinite(u)||u<=0)return;const c=String(o.statusRaw??o.status??"").toLowerCase();if(!(c==="closed"||c==="completed"||c==="cancelled"))return;const f=o.resolvedAt??o.resolved_at??null,m=o.reportedAt??o.reported_at??null,i=o.createdAt??o.created_at??null,d=f?new Date(f):null,p=m?new Date(m):i?new Date(i):null,g=d&&!Number.isNaN(d.getTime())?d:p&&!Number.isNaN(p.getTime())?p:null;if(g&&(s&&g<s||n&&g>n))return;const h=Math.round(u*100)/100;a+=h,r.push({id:o.id,cost:h,date:g})}),{total:a,items:r}}function gt(t,e){const s=Number.isFinite(e)?e:0;return{...t,maintenanceExpense:s,netProfit:(t.netProfit||0)-s}}function yt(t){const e=`trend:${A(t)}`,s=C(b.trend,e);if(s)return s;const n=new Date,a=[],r=(t||[]).map(c=>c?.start?new Date(c.start):null).filter(c=>c&&!Number.isNaN(c.getTime()));let o=6,u=new Date(n.getFullYear(),n.getMonth(),1);if(r.length){const c=new Date(Math.min(...r.map(p=>p.getTime()))),l=new Date(Math.max(...r.map(p=>p.getTime()))),f=new Date(c.getFullYear(),c.getMonth(),1);u=new Date(l.getFullYear(),l.getMonth(),1);const m=u.getFullYear()-f.getFullYear(),i=u.getMonth()-f.getMonth(),d=m*12+i;o=Math.min(12,Math.max(6,d+1))}for(let c=o-1;c>=0;c-=1){const l=new Date(u.getFullYear(),u.getMonth()-c,1),f=l.getFullYear(),m=l.getMonth(),i=t.filter(S=>{const M=S?.start?new Date(S.start):null;return M&&M.getFullYear()===f&&M.getMonth()===m}),d=i.length;let p=0,g=0,h=0;i.forEach(S=>{const M=x(S);p+=M.finalTotal,g+=M.netProfit,h+=M.companyShareAmount});const T=Q(l),D=new Date(l.getFullYear(),l.getMonth(),1),_=new Date(l.getFullYear(),l.getMonth()+1,0);a.push({label:T,count:d,revenue:p,netProfit:g,companyShare:h,periodStart:D,periodEnd:_,startInput:I(D),endInput:I(_)})}return F(b.trend,e,a)}function wt(t){const e=`status:${A(t)}`,s=C(b.status,e);if(s)return s;const n={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(f=>{const{statusValue:m,confirmed:i}=P(f);m==="completed"?n.completed+=1:m==="cancelled"?n.cancelled+=1:m==="confirmed"||i?n.confirmed+=1:n.pending+=1});const a=Math.max(1,(t||[]).length),r=n.confirmed,o=n.pending,u=n.completed,c=n.cancelled,l=[{label:w("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-confirmed",filterKey:"confirmed"},{label:w("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:w("reservations.reports.status.completedLabel","منتهية","Completed"),value:u,percent:Math.round(u/a*100)||0,rawCount:u,className:"status-completed",filterKey:"completed"},{label:w("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:c,percent:Math.round(c/a*100)||0,rawCount:c,className:"status-cancelled",filterKey:"cancelled"}];return F(b.status,e,l)}function bt(t){const e=`payment:${A(t)}`,s=C(b.payment,e);if(s)return s;const n=t.length||1;let a=0,r=0,o=0;(t||[]).forEach(c=>{const{paidStatus:l}=P(c);l==="paid"?a+=1:l==="partial"?r+=1:o+=1});const u=[{label:w("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-paid",filterKey:"paid"},{label:w("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-partial",filterKey:"partial"},{label:w("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-unpaid",filterKey:"unpaid"}];return F(b.payment,e,u)}function Dt(t,e){const s=`topCustomers:${A(t)}`,n=C(b.topCustomers,s);if(n)return n;const a=new Map,r=new Map((e||[]).map(u=>[String(u.id),u]));t.forEach(u=>{const c=String(u?.customerId??"unknown"),l=a.get(c)||{count:0,revenue:0},f=x(u);l.count+=1,l.revenue+=f.finalTotal,a.set(c,l)});const o=Array.from(a.entries()).map(([u,c])=>({name:r.get(u)?.customerName||w("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:c.count,revenue:c.revenue})).sort((u,c)=>c.revenue-u.revenue).slice(0,5);return F(b.topCustomers,s,o)}function St(t,e){const s=`topEquipment:${A(t)}`,n=C(b.topEquipment,s);if(n)return n;const a=new Map,r=new Map((e||[]).map(c=>[R(c?.barcode),c])),o=w("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(c=>{(c?.items||[]).forEach(l=>{const f=R(l?.barcode),m=f?r.get(f):null,i=l?.desc||l?.description||l?.name||m?.desc||m?.description||m?.name||"",d=i&&i.trim()?i:o,p=H(d)||"unknown",g=Number(l?.qty)||1,h=Number(l?.price)||0,T=g*h,D=a.get(p)||{name:d,count:0,revenue:0};D.name=d,D.count+=g,D.revenue+=T,a.set(p,D)})});const u=Array.from(a.values()).sort((c,l)=>l.count!==c.count?l.count-c.count:l.revenue-c.revenue).slice(0,5);return F(b.topEquipment,s,u)}function Mt(){Object.values(b).forEach(t=>t.clear())}function tt(t,e,s,n,a){const r=[],o=t?.reservationId||t?.id;o&&r.push(o),t?.notes&&r.push(t.notes);const{statusValue:u,paidStatus:c}=P(t);u&&r.push(u);const l=t?.paymentStatus||t?.payment_status;l&&r.push(l),t?.paid!=null&&r.push(t.paid?"paid":"unpaid"),c&&r.push(c);const f=s.get(String(t?.customerId));f&&r.push(f.customerName,f.company_name||f.companyName,f.contact_person||"");const m=z(t);return m&&r.push(m.title,m.code,m.status),r.push(et(c)),(t?.items||[]).forEach(d=>{d?.desc&&r.push(d.desc),d?.barcode&&r.push(d.barcode);const p=n.get(R(d?.barcode));p&&r.push(p.desc,p.description,p.name)}),(t?.technicians||[]).forEach(d=>{const p=a.get(String(d));p&&r.push(p.name,p.role,p.department)}),B(r.filter(Boolean).join(" ")).includes(e)}function Tt(t,e,s,n,a){const{startDate:r,endDate:o}=V(e),u=B(e.search),c=!!u,l=new Map((s||[]).map(i=>[String(i.id),i])),f=new Map((n||[]).map(i=>[R(i?.barcode),i])),m=new Map((a||[]).map(i=>[String(i.id),i]));return(t||[]).filter(i=>{if(i&&i.projectId!=null&&String(i.projectId).trim()!=="")return!1;const d=i?.start?new Date(i.start):null;if(!d||Number.isNaN(d.getTime()))return!1;let p=i?.end?new Date(i.end):d;if(Number.isNaN(p.getTime())&&(p=d),r&&p<r||o&&d>o)return!1;const{statusValue:g,confirmed:h,paid:T,paidStatus:D}=P(i);if(e.status==="confirmed"&&!(g==="confirmed"||g==="completed"||h)||e.status==="pending"&&g!=="pending"||e.status==="completed"&&g!=="completed"||e.status==="cancelled"&&g!=="cancelled"||e.payment==="paid"&&!T||e.payment==="unpaid"&&T||e.payment==="partial"&&D!=="partial")return!1;if(e.share&&e.share!=="all"){const S=x(i).companySharePercent>0;if(e.share==="with"&&!S||e.share==="without"&&S)return!1}return!(c&&!tt(i,u,l,f,m))})}function et(t){const e=String(t??"").toLowerCase();return e==="paid"?w("reservations.reports.payment.paidLabel","مدفوعة","Paid"):e==="partial"?w("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):w("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}export{it as A,x as a,pt as b,P as c,mt as d,I as e,dt as f,Mt as g,V as h,Tt as i,ft as j,ht as k,gt as l,yt as m,wt as n,bt as o,et as p,Dt as q,y as r,St as s,w as t,rt as u,ot as v,st as w,ct as x,lt as y,ut as z};
