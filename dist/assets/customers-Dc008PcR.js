import{e as j,h as D,t as i,k,n as _,b as x,A,j as l,o as V,s as q}from"./auth-CXJ9BVF7.js";let g=null,N=!1,L="";const z=j()||{};let C=(z.customers||[]).map(B),m=null,y=null;function $(t){if(!t||typeof t!="object")return null;let n=t.data??t.base64??t.content??"";if(typeof n=="string"&&(n=n.trim(),n.startsWith("data:"))){const e=n.indexOf(",");n=e!==-1?n.slice(e+1):n}return n?{fileName:t.fileName??t.filename??t.name??"",mimeType:t.mimeType??t.contentType??t.type??"application/octet-stream",data:n}:null}function F(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function v(){y&&(URL.revokeObjectURL(y),y=null)}function B(t={}){if(!t||typeof t!="object")return{id:"",full_name:"",customerName:"",name:"",phone:"",email:"",address:"",company:"",notes:"",created_at:null,updated_at:null};const n=t.id??t.customerId??t.reservationId??t.customerID,e=t.full_name??t.customerName??t.name??"",o=typeof e=="string"?e.trim():String(e||"").trim(),s=t.tax_id??t.taxId??t.vat_number??t.vatNumber??t.taxNumber??"",a=$(t.document??t.attachment??t.file);return{id:n!=null?String(n):"",full_name:o,customerName:o,name:o,phone:t.phone??t.phoneNumber??"",email:t.email??"",address:t.address??"",company:t.company??t.companyName??"",notes:t.notes??"",tax_id:typeof s=="string"?s.trim():String(s||"").trim(),taxId:typeof s=="string"?s.trim():String(s||"").trim(),document:a,created_at:t.created_at??null,updated_at:t.updated_at??null}}function w(){document.dispatchEvent(new CustomEvent("customers:changed"))}function I(){return C}function T(t){C=Array.isArray(t)?t.map(B):[],q({customers:C})}function f(){return{form:document.getElementById("customer-form"),idInput:document.getElementById("customer-id"),nameInput:document.getElementById("customer-name"),phoneInput:document.getElementById("customer-phone"),emailInput:document.getElementById("customer-email"),addressInput:document.getElementById("customer-address"),companyInput:document.getElementById("customer-company"),notesInput:document.getElementById("customer-notes"),taxInput:document.getElementById("customer-tax-id"),documentInput:document.getElementById("customer-document"),documentNameLabel:document.getElementById("customer-document-name"),documentPreviewBtn:document.getElementById("customer-document-preview"),submitBtn:document.getElementById("submit-btn"),cancelBtn:document.getElementById("customer-cancel-btn")}}function E(){const{documentNameLabel:t,documentPreviewBtn:n}=f(),e=!!m?.data;if(n&&(n.disabled=!e),t){const o=i("customers.form.document.empty","لم يتم اختيار ملف بعد");if(e){const s=m.fileName?.trim()||i("customers.form.document.selected","تم إرفاق ملف.");t.textContent=s}else t.textContent=o}}function M(t="add"){const{submitBtn:n}=f();if(!n)return;const e=t==="update"?"customers.form.actions.update":"customers.form.actions.submit",o=t==="update"?"💾 حفظ التعديل":"➕ إضافة عميل";n.textContent=i(e,o)}function U(t){const{cancelBtn:n}=f();n&&(t?n.classList.remove("d-none"):n.classList.add("d-none"),n.textContent=i("customers.form.actions.cancel","إلغاء التعديل"))}function H(){const t=!!g;M(t?"update":"add"),U(t),E()}function R(){const{form:t,idInput:n,phoneInput:e}=f();t?.reset(),n&&(n.value=""),e&&(e.value=e.value.trim()),m=null,v(),E(),g=null,M("add"),U(!1)}function W(t){const{idInput:n,nameInput:e,phoneInput:o,emailInput:s,addressInput:a,companyInput:r,notesInput:u,taxInput:d,documentInput:c}=f();!t||!e||!o||(n&&(n.value=t.id),e.value=t.full_name||"",o.value=_(t.phone||""),s&&(s.value=t.email||""),a&&(a.value=t.address||""),r&&(r.value=t.company||""),u&&(u.value=t.notes||""),d&&(d.value=t.tax_id||""),c&&(c.value=""),m=t.document?{...t.document}:null,v(),E(),g=t.id,M("update"),U(!0))}function G(){const{idInput:t,nameInput:n,phoneInput:e,emailInput:o,addressInput:s,companyInput:a,notesInput:r,taxInput:u}=f();if(!n||!e)return null;const d=n.value.trim(),c=_(e.value.trim());if(e.value=c,!d||!c)return l(i("customers.toast.missingFields","يرجى تعبئة الاسم ورقم الهاتف"),"error"),null;const p={full_name:d,phone:c,email:o?.value.trim()||"",address:s?.value.trim()||"",company:a?.value.trim()||"",notes:r?.value.trim()||""},h=u?.value.trim()||"";return p.tax_id=h,p.taxId=h,m?.data&&(p.document=m),{payload:p,id:t?.value||g||""}}function J(t){const{documentInput:n}=f(),e=t.target?.files&&t.target.files[0];if(!e){E(),n&&(n.value=""),v();return}const o=new FileReader;o.onload=()=>{const s=typeof o.result=="string"?o.result:"",a=s.includes(",")?s.split(",")[1]:s;m={fileName:e.name,mimeType:e.type||"application/octet-stream",data:a},v(),E(),n&&(n.value="")},o.readAsDataURL(e)}function K(t){return t?.data?`data:${t.mimeType||"application/octet-stream"};base64,${t.data}`:""}function Q(t,n="application/octet-stream"){try{const e=t.replace(/\s/g,""),o=atob(e),s=1024,a=[];for(let r=0;r<o.length;r+=s){const u=o.slice(r,r+s),d=new Array(u.length);for(let c=0;c<u.length;c+=1)d[c]=u.charCodeAt(c);a.push(new Uint8Array(d))}return new Blob(a,{type:n})}catch(e){return console.warn("[customers] Failed to convert base64 to blob",e),null}}function P(t,n=""){if(!t?.data){l(i("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const e=document.getElementById("customerDocumentModal");if(!e)return;const o=document.getElementById("customer-document-preview-container"),s=document.getElementById("customer-document-download"),a=document.getElementById("customer-document-modal-title");a&&(a.textContent=n||t.fileName||i("customers.documents.modalTitle","📎 ملف العميل")),v();const r=Q(t.data,t.mimeType||"application/octet-stream");if(!r){o&&(o.innerHTML=`<p class="text-muted">${i("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل.")}</p>`),s&&(s.href=K(t),s.download=t.fileName||"customer-document"),bootstrap.Modal.getOrCreateInstance(e).show();return}if(y=URL.createObjectURL(r),s&&(s.href=y,s.download=t.fileName||"customer-document"),o){const d=(t.mimeType||"").toLowerCase();d.startsWith("image/")?o.innerHTML=`<img src="${y}" alt="${F(t.fileName||"customer document")}" class="img-fluid">`:d==="application/pdf"||d.includes("pdf")?o.innerHTML=`<iframe src="${y}" title="${F(t.fileName||"customer document")}" class="customer-document-frame w-100" type="application/pdf"></iframe>`:o.innerHTML=`<p class="text-muted">${i("customers.documents.unsupportedPreview","لا يمكن معاينة هذا النوع من الملفات، يمكنك تحميله بالأسفل.")}</p>`}const u=bootstrap.Modal.getOrCreateInstance(e);e.dataset.documentCleanupAttached||(e.addEventListener("hidden.bs.modal",()=>{v();const d=document.getElementById("customer-document-preview-container");d&&(d.innerHTML=`<p class="text-muted">${i("customers.documents.emptyState","لا يوجد ملف لعرضه.")}</p>`)}),e.dataset.documentCleanupAttached="true"),u.show()}function X(){if(!m?.data){l(i("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const{nameInput:t}=f(),e=t?.value?.trim()||""||i("customers.documents.modalTitle","📎 ملف العميل"),o=m.fileName?`${e} - ${m.fileName}`.trim():e;P(m,o)}async function O({showToastOnError:t=!0}={}){N=!0,L="",b();try{const n=await x("/customers/"),e=Array.isArray(n?.data)?n.data.map(B):[];T(e)}catch(n){L=n instanceof A?n.message:i("customers.toast.fetchFailed","تعذر تحميل قائمة العملاء"),t&&l(L,"error")}finally{N=!1,b()}}async function Y(t){t.preventDefault();const n=G();if(!n)return;const{payload:e}=n,o=!!g;try{if(o){const s=g,a=await x(`/customers/?id=${encodeURIComponent(s)}`,{method:"PATCH",body:e}),r=B(a?.data),u=$(e.document),d={...r,document:r.document??u,tax_id:r.tax_id??e.tax_id??"",taxId:r.taxId??e.taxId??""},c=I().map(p=>String(p.id)===String(s)?d:p);T(c),l(i("customers.toast.updateSuccess","تم تحديث بيانات العميل بنجاح"))}else{const s=await x("/customers/",{method:"POST",body:e}),a=B(s?.data),r=$(e.document),u={...a,document:a.document??r,tax_id:a.tax_id??e.tax_id??"",taxId:a.taxId??e.taxId??""},d=[...I(),u];T(d),l(i("customers.toast.createSuccess","تمت إضافة العميل بنجاح"))}b(),R(),w()}catch(s){const a=s instanceof A?s.message:i("customers.toast.submitFailed","حدث خطأ أثناء حفظ بيانات العميل");l(a,"error")}}async function Z(t){const n=t.target;if(!(n instanceof HTMLElement))return;const e=n.closest("button");if(e instanceof HTMLElement){if(e.classList.contains("customer-delete-btn")){if(!k()){V();return}const o=e.dataset.id;if(!confirm(i("customers.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العميل؟")))return;try{await x(`/customers/?id=${encodeURIComponent(o)}`,{method:"DELETE"});const s=I().filter(a=>String(a.id)!==String(o));T(s),b(),String(g)===String(o)&&R(),l(i("customers.toast.deleteSuccess","تم حذف العميل")),w()}catch(s){const a=s instanceof A?s.message:i("customers.toast.deleteFailed","تعذر حذف العميل، يرجى المحاولة مجدداً");l(a,"error")}return}if(e.classList.contains("customer-view-file-btn")){const o=e.dataset.id,s=I().find(u=>String(u.id)===String(o));if(!s?.document){l(i("customers.documents.missing","لا يوجد ملف لعرضه"),"info");return}const a=[s.full_name,s.document.fileName].filter(Boolean),r=a.length?a.join(" - "):void 0;P(s.document,r);return}if(e.classList.contains("customer-edit-btn")){const o=e.dataset.id,s=I().find(a=>String(a.id)===String(o));if(!s)return;W(s)}}}function tt(t){const n=t.target.value.trim().toLowerCase(),o=I().filter(a=>{const r=a.full_name?.toLowerCase()||"",u=a.phone?.toLowerCase()||"",d=a.company?.toLowerCase()||"";return r.includes(n)||u.includes(n)||d.includes(n)}),s=n?i("customers.table.noResults","لا توجد نتائج مطابقة"):void 0;b(o,{emptyMessage:s})}function et(){const{form:t,cancelBtn:n}=f();t&&t.addEventListener("submit",Y);const{documentInput:e,documentPreviewBtn:o}=f();e&&!e.dataset.listenerAttached&&(e.addEventListener("change",J),e.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("click",X),o.dataset.listenerAttached="true"),n&&n.addEventListener("click",()=>{R()});const s=document.getElementById("customers-table");s&&s.addEventListener("click",Z);const a=document.getElementById("search-customer-input");a&&a.addEventListener("input",tt),E()}document.addEventListener("DOMContentLoaded",()=>{et(),b(),H(),O()});document.addEventListener("language:changed",()=>{H(),b()});document.addEventListener("customers:refreshRequested",()=>{O({showToastOnError:!1}),H()});document.addEventListener(D.USER_UPDATED,()=>{b()});function b(t,n={}){const e=Array.isArray(t),o=e?t:I(),s=document.getElementById("customers-table");if(!s)return;if(s.innerHTML="",!e){if(N){s.innerHTML=`<tr><td colspan='5'>${i("customers.table.loading","جاري التحميل...")}</td></tr>`;return}if(L){s.innerHTML=`<tr><td colspan='5' class='text-danger'>${L}</td></tr>`;return}}if(o.length===0){const c=n.emptyMessage||i("customers.table.empty","لا يوجد عملاء");s.innerHTML=`<tr><td colspan='5'>${c}</td></tr>`;return}const a=i("customers.actions.edit","✏️ تعديل"),r=i("customers.actions.delete","🗑️ حذف"),u=i("customers.actions.viewDocument","📎 عرض المستند"),d=k();o.forEach(c=>{const p=g&&String(g)===String(c.id),h=document.createElement("tr");p&&h.classList.add("customer-table-row-editing");const S=[`<button type="button" class="customer-action-btn customer-action-btn--edit customer-edit-btn" data-id="${c.id}">${a}</button>`];c.document?.data&&S.push(`<button type="button" class="customer-action-btn customer-action-btn--file customer-view-file-btn" data-id="${c.id}">${u}</button>`),d&&S.push(`<button type="button" class="customer-action-btn customer-action-btn--delete customer-delete-btn" data-id="${c.id}">${r}</button>`),h.innerHTML=`
      <td><a href="customer.html?id=${c.id}" class="text-decoration-none">${c.full_name}</a></td>
      <td>${_(c.phone)}</td>
      <td>${c.company||""}</td>
      <td class="table-notes-cell">${c.notes||"—"}</td>
      <td class="table-actions-cell">
        <div class="table-action-buttons">
          ${S.join("")}
        </div>
      </td>
    `,s.appendChild(h)})}export{b as r};
