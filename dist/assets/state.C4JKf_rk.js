import{d as w,n as _,h as it,b as P,A as re,a as at,m as st,c as ot,i as ct,l as rt,p as ne,t as u,q as lt,w as qe,j as g,x as dt}from"./auth.CrIkFaWD.js";const ut=w()||{};let $=(ut.technicians||[]).map(he);function G(){return $}function H(e){return $=Array.isArray(e)?e.map(he):[],it({technicians:$}),typeof window<"u"&&typeof window.dispatchEvent=="function"?(window.dispatchEvent(new CustomEvent("technicians:updated")),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent("technicians:updated"))):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("technicians:updated")),$}async function Fe(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([i,l])=>{l!=null&&l!==""&&t.set(i,String(l))});const n=t.toString(),a=await P(`/technicians/${n?`?${n}`:""}`),s=a?.data??a;let o=[];Array.isArray(s)?o=s:s&&typeof s=="object"&&(Array.isArray(s.items)?o=s.items:Array.isArray(s.results)?o=s.results:Array.isArray(s.data)?o=s.data:Array.isArray(s.records)&&(o=s.records));const c=o.map(ie);return H(c)}async function ze(e){const t=await P("/technicians/",{method:"POST",body:e}),n=ie(t?.data??{});return H([...$,n]),n}async function me(e,t){const n=await P(`/technicians/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=ie(n?.data??{}),s=$.map(o=>String(o.id)===String(e)?a:o);return H(s),a}async function De(e){await P(`/technicians/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),H($.filter(t=>String(t.id)!==String(e)))}function pe({name:e,phone:t,email:n,role:a,department:s,dailyWage:o,dailyTotal:c,status:i,notes:l,active:r=!0}){return{full_name:e??"",phone:t??"",email:n??null,specialization:a??"",department:s??null,daily_wage:o??0,daily_total:c??null,status:i??"available",notes:l??null,active:r?1:0}}function ie(e={}){return $e({id:e.id,full_name:e.full_name,phone:e.phone,email:e.email,specialization:e.specialization,department:e.department,daily_wage:e.daily_wage,daily_total:e.daily_total,status:e.status,notes:e.notes,active:e.active})}function he(e={}){return $e(e)}function $e(e={}){const t=e.id??e.technicianId??e.technician_id??e.ID??e.uuid??e._id??null,n=e.full_name??e.name??e.fullName??"",a=e.phone??"",s=e.email??null,o=e.specialization??e.role??e.position??"",c=e.department??e.team??"",i=Ce(e.daily_wage??e.dailyWage??e.wage??e.rate??0),l=Ce(e.daily_total??e.dailyTotal??e.total??e.total_wage??i),r=we(e.baseStatus??e.status??"available"),d=we(e.status??e.baseStatus??"available"),m=e.notes??"",f=e.active!=null?!!e.active:!0;return{id:t!=null?String(t):"",name:n,phone:a,email:s,role:o,department:c,dailyWage:i,dailyTotal:l,status:d,baseStatus:r,notes:m,active:f}}function Ce(e){const t=Number.parseFloat(_(String(e??"0")));return Number.isFinite(t)?Number(t.toFixed(2)):0}function we(e){switch(String(e??"").trim().toLowerCase()){case"available":case"Ù…ØªØ§Ø­":return"available";case"busy":case"Ù…Ø´ØºÙˆÙ„":case"Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„":return"busy";case"leave":case"Ø¥Ø¬Ø§Ø²Ø©":case"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©":return"leave";case"inactive":case"Ù…ØªÙˆÙ‚Ù":return"inactive";default:return"available"}}function Z(e){return e instanceof re}const sn=Object.freeze(Object.defineProperty({__proto__:null,buildTechnicianPayload:pe,createTechnicianApi:ze,deleteTechnicianApi:De,getTechniciansState:G,isApiError:Z,mapLegacyTechnician:he,mapTechnicianFromApi:ie,refreshTechniciansFromApi:Fe,setTechniciansState:H,updateTechnicianApi:me},Symbol.toStringTag,{value:"Module"}));at();st();ot();document.addEventListener("DOMContentLoaded",()=>{ct();const e=document.getElementById("logout-btn");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>rt()),e.dataset.listenerAttached="true")});function te(e){const t=Number(e)||0,a=ne()==="ar"?"ar-SA-u-nu-latn":"en-US",s=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(t));return`${_(s)} SR`}function on(e){return typeof e?.expensesTotal=="number"?e.expensesTotal:Array.isArray(e?.expenses)?e.expenses.reduce((t,n)=>t+(Number(n?.amount)||0),0):0}function cn(e){const t=new Date,n=e?.start?new Date(e.start):null,a=e?.end?new Date(e.end):null;return n&&!Number.isNaN(n.getTime())&&n>t?"upcoming":a&&!Number.isNaN(a.getTime())&&a<t?"completed":"ongoing"}function rn(e,t){return e?e.length<=t?e:`${e.slice(0,t).trim()}â€¦`:""}function D(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const ft="technicianPositions:updated";let B=[],Me=!1,W=null;function ge(e={}){return{id:Number(e.id)||0,name:String(e.name??"").trim(),labelAr:typeof e.label_ar=="string"?e.label_ar.trim():null,labelEn:typeof e.label_en=="string"?e.label_en.trim():null,cost:Number.parseFloat(e.cost??0)||0,clientPrice:e.client_price==null?null:Number.parseFloat(e.client_price),createdAt:e.created_at??null,updatedAt:e.updated_at??null}}function Re({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}){return{name:String(e??"").trim(),cost:t??0,client_price:n,label_ar:a??null,label_en:s??null}}function mt(e){return B=Array.isArray(e)?e.map(ge).filter(t=>t.name!=="").sort((t,n)=>j(t).localeCompare(j(n),"ar",{sensitivity:"base"})):[],Me=!0,ae(),q()}function ae(){try{const e={positions:q()},t=new CustomEvent(ft,{detail:e});typeof window<"u"&&window.dispatchEvent(t),typeof document<"u"&&document.dispatchEvent(t)}catch(e){console.warn("[technicianPositions] Failed to dispatch update event",e)}}function j(e={}){return(e.labelAr||e.labelEn||e.name||"").toLowerCase()}function q(){return B.map(e=>({...e}))}function pt(e){const t=String(e??"").trim().toLowerCase();return t&&B.find(n=>!!(n.name&&n.name.toLowerCase()===t||n.labelAr&&n.labelAr.toLowerCase()===t||n.labelEn&&n.labelEn.toLowerCase()===t))||null}async function ht({forceRefresh:e=!1}={}){return Me&&!e?q():(W&&!e||(W=P("/technician-positions/").then(t=>{const n=Array.isArray(t?.data)?t.data:[];return mt(n)}).finally(()=>{W=null})),W)}async function se({forceRefresh:e=!1}={}){try{return await ht({forceRefresh:e})}catch(t){throw t instanceof re?t:new re(t?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"))}}async function gt({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}){const o=Re({name:e,cost:t,clientPrice:n,labelAr:a,labelEn:s}),c=await P("/technician-positions/",{method:"POST",body:o}),i=ge(c?.data??{});return B=[...B,i],B.sort((l,r)=>j(l).localeCompare(j(r),"ar",{sensitivity:"base"})),ae(),i}async function bt(e,{name:t,cost:n,clientPrice:a,labelAr:s,labelEn:o}){if(!e)throw new Error("Position id is required");const c=Re({name:t,cost:n,clientPrice:a,labelAr:s,labelEn:o}),i=await P(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:c}),l=ge(i?.data??{});return B=B.map(r=>r.id===l.id?l:r),B.sort((r,d)=>j(r).localeCompare(j(d),"ar",{sensitivity:"base"})),ae(),l}async function yt(e){if(!e)throw new Error("Position id is required");return await P(`/technician-positions/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),B=B.filter(t=>t.id!==Number(e)),ae(),q()}const le="__ART_RATIO_TECH_SUB_TAB__",xe=["technicians-management","technicians-positions"];let A=null,Ne=!1,ee=!1,K="",de=!1,C=null,M="technicians-management";const Le=Et();Le&&(M=Le);async function je({showToastOnError:e=!0}={}){if(!ee){ee=!0,K="",S();try{await Fe(),de=!0}catch(t){console.error("âŒ [technicians] loadTechniciansFromApi failed",t),K=Z(t)?t.message:u("technicians.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©"),e&&g(K,"error")}finally{ee=!1,S()}}}function Ue(){return G()}function Y(e=""){return _(String(e)).trim().toLowerCase()}function It(e){return e==null?"":String(e)}function U(e=""){return _(String(e)).replace(/[^0-9+]/g,"")}function T(e=""){const t=_(String(e)).replace(/[^0-9.]/g,"");if(!t.includes("."))return t;const[n,...a]=t.split(".");return`${n}.${a.join("")}`}function x(e,t){!e||e.dataset.normalizerAttached||(e.addEventListener("input",()=>{const n=t(e.value);if(e.value!==n){const a=e.selectionEnd;e.value=n,a!=null&&e.setSelectionRange(n.length,n.length)}}),e.dataset.normalizerAttached="true")}function Et(){try{if(typeof window>"u"||!window.localStorage)return null;const e=window.localStorage.getItem(le);return e&&xe.includes(e)?e:null}catch(e){return console.warn("âš ï¸ [technicians] Failed to read stored sub-tab",e),null}}function St(e){try{if(typeof window>"u"||!window.localStorage)return;if(!xe.includes(e)){window.localStorage.removeItem(le);return}window.localStorage.setItem(le,e)}catch(t){console.warn("âš ï¸ [technicians] Failed to store sub-tab",t)}}function Ve(e,t=0,n=null){const a=String(e??"").trim(),s=a?pt(a):null;return s?{matchedPosition:s,dailyWage:Number.isFinite(s.cost)?s.cost:0,dailyTotal:s.clientPrice==null?null:Number.isFinite(s.clientPrice)?s.clientPrice:0}:{matchedPosition:null,dailyWage:Number.isFinite(t)?t:0,dailyTotal:n==null?null:Number.isFinite(n)?n:0}}function Oe(){const e=document.getElementById("technician-position-summary"),t=document.getElementById("technician-position-summary-body");return{container:e,body:t}}function ue(e,t=ne()){return e?t==="ar"?e.labelAr||e.labelEn||e.name||"":e.labelEn||e.labelAr||e.name||"":""}function At(e,t=ne()){return t==="ar"?e.labelEn||e.labelAr||e.name||"":e.labelAr||e.labelEn||e.name||""}function He(){const{container:e,body:t}=Oe();!e||!t||(t.textContent="",e.hidden=!0)}function be(e,t={}){const{container:n,body:a}=Oe();if(!n||!a)return;const s=String(e??"").trim();if(!s){He();return}const o=Ve(s,t?.dailyWage??0,t?.dailyTotal??null),c=te(o.dailyWage||0),i=o.dailyTotal!=null?te(o.dailyTotal):u("technicians.positionSummary.noClientPrice","â€”");o.matchedPosition?a.textContent=u("technicians.positionSummary.match","Ø§Ù„ØªÙƒÙ„ÙØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",i):a.textContent=u("technicians.positionSummary.custom","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØµØ¨ Ù…Ø·Ø§Ø¨Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§ØµØ¨. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {cost} Â· Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: {price}").replace("{cost}",c).replace("{price}",i),n.hidden=!1}function J(){const e=document.getElementById("technician-position-options");if(!e)return;const t=q(),n=ne(),a=new Set,s=[];t.forEach(o=>{const c=ue(o,n).trim();c&&!a.has(c.toLowerCase())&&(s.push(`<option value="${D(c)}"></option>`),a.add(c.toLowerCase()));const i=At(o,n).trim();i&&!a.has(i.toLowerCase())&&(s.push(`<option value="${D(i)}"></option>`),a.add(i.toLowerCase()));const l=o.name?.trim();l&&!a.has(l.toLowerCase())&&(s.push(`<option value="${D(l)}"></option>`),a.add(l.toLowerCase()))}),e.innerHTML=s.join("")}function Pe(e){const t=Array.from(document.querySelectorAll("[data-tech-tab]")),n=Array.from(document.querySelectorAll("[data-tech-tab-panel]")),s=t.map(i=>i?.getAttribute("data-tech-tab")).filter(Boolean).includes(e)?e:"technicians-management";t.forEach(i=>{if(!i)return;const r=i.getAttribute("data-tech-tab")===s;i.classList.toggle("tab-active",r),i.classList.toggle("active",r),i.setAttribute("aria-selected",r?"true":"false"),i.setAttribute("tabindex",r?"0":"-1")}),n.forEach(i=>{if(!i)return;const r=i.getAttribute("data-tech-tab-panel")===s;i.hidden=!r,i.classList.toggle("active",r)}),M=s,St(s);const c=t.find(i=>i?.getAttribute("data-tech-tab")===s)?.closest("[data-tab-scroll]");c&&c.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0})),s==="technicians-positions"&&(N(),se().then(()=>{N()}).catch(i=>{console.error("âŒ [technicians] failed to load positions for tab switch",i),g(i?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}))}function ye(e="add"){const t=document.getElementById("technician-submit-btn");if(!t)return;const n=e==="update"?"technicians.form.actions.update":"technicians.form.actions.submit",a=e==="update"?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø·Ø§Ù‚Ù…";t.textContent=u(n,a)}function Ie(e){const t=document.getElementById("technician-cancel-btn");t&&(e?t.classList.remove("d-none"):t.classList.add("d-none"),t.textContent=u("technicians.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}function Ee(){ye(A?"update":"add"),Ie(!!A),S()}function vt(e=[]){const t=document.getElementById("technician-role-filter");if(!t)return"";const n=t.value,a=Array.from(new Set(e.map(o=>(o?.role||"").trim()).filter(Boolean))).sort((o,c)=>o.localeCompare(c,"ar",{sensitivity:"base"})),s=u("technicians.search.filters.allRoles","ğŸ‘” ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù");return t.innerHTML=`<option value="">${s}</option>`+a.map(o=>`<option value="${o}">${o}</option>`).join(""),n&&a.includes(n)?t.value=n:t.value="",t.value}function oe(){const e=document.getElementById("technician-form");e&&(e.reset(),A=null,ye("add"),Ie(!1),He())}function Tt(e){const t=document.getElementById("technician-name"),n=document.getElementById("technician-phone"),a=document.getElementById("technician-email"),s=document.getElementById("technician-role"),o=document.getElementById("technician-department"),c=document.getElementById("technician-notes");!t||!n||!s||(t.value=e.name||"",n.value=U(e.phone||""),a&&(a.value=e.email||""),s.value=e.role||"",o&&(o.value=e.department||""),c&&(c.value=e.notes||""),A=String(e.id),ye("update"),Ie(!0),be(s.value,e))}function Bt(){const e=document.getElementById("technician-name"),t=document.getElementById("technician-phone"),n=document.getElementById("technician-email"),a=document.getElementById("technician-role"),s=document.getElementById("technician-department"),o=document.getElementById("technician-notes");if(!e||!t||!a)return null;const c=e.value.trim(),i=U(t.value.trim());t.value=i;const l=(n?.value||"").trim(),r=a.value.trim(),d=s?.value.trim()||"",m="available",f=o?.value.trim()||"",h=A?ke(A):null,{dailyWage:p,dailyTotal:b}=Ve(r,h?.dailyWage??0,h?.dailyTotal??null);return c?i?r?!Number.isFinite(p)||p<0?(g(u("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),null):b!=null&&(!Number.isFinite(b)||b<0)?(g(u("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),null):(be(r,{dailyWage:p,dailyTotal:b}),{name:c,phone:i,email:l,role:r,department:d,dailyWage:Number.isFinite(p)?p:0,dailyTotal:b==null?null:Number(b),status:m,baseStatus:m,notes:f}):(g(u("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),a.focus(),null):(g(u("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),t.focus(),null):(g(u("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),e.focus(),null)}async function _t(e){e.preventDefault();try{await se()}catch(a){console.error("âŒ [technicians] failed to load positions before submit",a);const s=a?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(s,"error");return}const t=Bt();if(!t)return;const n=pe({name:t.name,phone:t.phone,email:t.email||null,role:t.role,department:t.department,dailyWage:t.dailyWage,dailyTotal:t.dailyTotal,status:t.status,notes:t.notes,active:!0});try{A?(await me(A,n),g(u("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))):(await ze(n),g(u("technicians.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"))),oe(),S()}catch(a){console.error("âŒ [technicians] handleTechnicianSubmit failed",a);const s=Z(a)?a.message:u("technicians.toast.saveFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(s,"error")}}function Ct(){oe()}function wt(e){const t={id:document.getElementById("edit-technician-id"),name:document.getElementById("edit-technician-name"),phone:document.getElementById("edit-technician-phone"),email:document.getElementById("edit-technician-email"),role:document.getElementById("edit-technician-role"),department:document.getElementById("edit-technician-department"),wage:document.getElementById("edit-technician-wage"),total:document.getElementById("edit-technician-total"),status:document.getElementById("edit-technician-status"),notes:document.getElementById("edit-technician-notes")};if(!t.id||!t.name||!t.phone||!t.role||!t.wage||!t.total||!t.status)return;t.id.value=e.id||"",t.name.value!==(e.name||"")&&(t.name.value=e.name||"");const n=U(e.phone||"");t.phone.value!==n&&(t.phone.value=n),t.email&&t.email.value!==(e.email||"")&&(t.email.value=e.email||""),t.role.value!==(e.role||"")&&(t.role.value=e.role||""),t.department&&t.department.value!==(e.department||"")&&(t.department.value=e.department||"");const a=T(e.dailyWage!=null?e.dailyWage:"");t.wage.value!==a&&(t.wage.value=a);const s=T(e.dailyTotal!=null?e.dailyTotal:"");t.total.value!==s&&(t.total.value=s);const o=e.baseStatus||e.status||"available";t.status.value!==o&&(t.status.value=o),t.notes&&t.notes.value!==(e.notes||"")&&(t.notes.value=e.notes||""),x(t.phone,U),x(t.wage,T),x(t.total,T)}function Nt(){const e=document.getElementById("edit-technician-id"),t=document.getElementById("edit-technician-name"),n=document.getElementById("edit-technician-phone"),a=document.getElementById("edit-technician-email"),s=document.getElementById("edit-technician-role"),o=document.getElementById("edit-technician-department"),c=document.getElementById("edit-technician-wage"),i=document.getElementById("edit-technician-total"),l=document.getElementById("edit-technician-status"),r=document.getElementById("edit-technician-notes");if(!e||!t||!n||!s||!c||!i||!l)return null;const d=e.value.trim(),m=t.value.trim(),f=U(n.value.trim());n.value=f;const h=(a?.value||"").trim(),p=s.value.trim(),b=o?.value.trim()||"",y=T(c.value.trim());c.value=y;const E=y===""?0:parseFloat(y),F=T(i.value.trim());i.value=F;const z=F===""?null:parseFloat(F),_e=l.value||"available",nt=r?.value.trim()||"";return d?m?f?p?Number.isNaN(E)||E<0?(g(u("technicians.toast.invalidWage","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ")),c.focus(),null):z!=null&&(Number.isNaN(z)||z<0)?(g(u("technicians.toast.invalidTotal","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©")),i.focus(),null):{id:d,name:m,phone:f,email:h,role:p,department:b,dailyWage:Number.isFinite(E)?E:0,dailyTotal:z==null?null:Number(z),status:_e,baseStatus:_e,notes:nt}:(g(u("technicians.toast.missingRole","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©")),s.focus(),null):(g(u("technicians.toast.missingPhone","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„")),n.focus(),null):(g(u("technicians.toast.missingName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),t.focus(),null):(g(u("technicians.toast.unidentified","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")),null)}async function Lt(){const e=Nt();if(!e)return;const t=pe({name:e.name,phone:e.phone,email:e.email||null,role:e.role,department:e.department,dailyWage:e.dailyWage,dailyTotal:e.dailyTotal,status:e.status,notes:e.notes,active:!0});try{await me(e.id,t),g(u("technicians.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));const n=document.getElementById("editTechnicianModal");n&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(n)?.hide(),S()}catch(n){console.error("âŒ [technicians] handleTechnicianModalSave failed",n);const a=Z(n)?n.message:u("technicians.toast.updateFailed","ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…");g(a,"error")}}function S(){const e=document.getElementById("technicians-table");if(!e)return;const t=document.getElementById("search-technician-input"),n=Y(t?.value||"");if(ee&&!de){const r=u("technicians.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}if(K&&!de){e.innerHTML=`<tr><td colspan='6' class='text-danger'>${K}</td></tr>`;return}const a=Ae(),{reservations:s=[]}=w(),o=new Date;vt(a);const c=document.getElementById("technician-role-filter"),i=Y(c?.value||""),l=a.filter(r=>i&&Y(r.role||"")!==i?!1:n?Y([r.name,r.phone,r.email,r.role,r.department,r.notes].filter(Boolean).join(" ")).includes(n):!0);if(l.length===0){const r=u("technicians.table.empty","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø·Ø§Ù‚Ù… Ø¨Ø¹Ø¯.");e.innerHTML=`<tr><td colspan='6'>${r}</td></tr>`;return}e.innerHTML=l.map(r=>{const d=A&&String(A)===String(r.id),h=(Ke(r.id,s,o)?"busy":r.status||r.baseStatus||"available")==="busy"?{label:u("technicians.status.busy","â›” Ù…Ø´ØºÙˆÙ„"),className:"technician-status-badge technician-status-badge--busy"}:{label:u("technicians.status.available","âœ… Ù…ØªØ§Ø­"),className:"technician-status-badge technician-status-badge--available"},p=u("technicians.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),b=u("technicians.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù"),y=qe(),E=[`<button type="button" class="technician-action-btn technician-action-btn--edit technician-edit-btn" data-id="${r.id}">${p}</button>`];return y&&E.push(`<button type="button" class="technician-action-btn technician-action-btn--delete technician-delete-btn" data-id="${r.id}">${b}</button>`),`
      <tr${d?' class="technician-table-row-editing"':""}>
        <td><a href="technician.html?id=${r.id}" class="text-decoration-none">${r.name}</a></td>
        <td>${r.role||""}</td>
        <td>${r.department||"â€”"}</td>
        <td><span class="${h.className}"><span class="technician-status-badge__text">${h.label}</span></span></td>
        <td class="table-notes-cell">${r.notes||"â€”"}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            ${E.join("")}
          </div>
        </td>
      </tr>
    `}).join("")}function ce(){return{form:document.getElementById("position-form"),idInput:document.getElementById("position-id"),nameArInput:document.getElementById("position-name-ar"),nameEnInput:document.getElementById("position-name-en"),costInput:document.getElementById("position-cost"),clientPriceInput:document.getElementById("position-client-price"),submitBtn:document.getElementById("position-submit-btn"),cancelBtn:document.getElementById("position-cancel-btn")}}function We(e="add"){const{submitBtn:t,cancelBtn:n}=ce(),a=e==="update";if(t){const s=a?"positions.form.actions.update":"positions.form.actions.submit",o=a?"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØµØ¨":"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ¨";t.textContent=u(s,o)}n&&(n.classList.toggle("d-none",!a),n.textContent=u("positions.form.actions.cancel","Ø¥Ù„ØºØ§Ø¡"))}function Se(){const{form:e,idInput:t,nameArInput:n,nameEnInput:a,costInput:s,clientPriceInput:o}=ce();e&&e.reset(),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),s&&(s.value=""),o&&(o.value=""),C=null,We("add")}function Pt(e){const{idInput:t,nameArInput:n,nameEnInput:a,costInput:s,clientPriceInput:o}=ce();!e||!s||(t&&(t.value=e.id||""),n&&(n.value=e.labelAr||""),a&&(a.value=e.labelEn||""),s.value=T(e.cost??0),o&&(o.value=e.clientPrice==null?"":T(e.clientPrice)),C=e.id||null,We("update"))}function qt(){const{nameArInput:e,nameEnInput:t,costInput:n,clientPriceInput:a}=ce();if(!n)return null;const s=e?.value.trim()||"",o=t?.value.trim()||"",c=o||s,i=C?q().find(f=>String(f.id)===String(C)):null,l=T(n.value.trim());n.value=l;const r=l===""?0:parseFloat(l),d=a?T(a.value.trim()):"";a&&(a.value=d);const m=d===""?null:parseFloat(d);return c?!Number.isFinite(r)||r<0?(g(u("positions.toast.invalidCost","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙƒÙ„ÙØ©")),n.focus(),null):m!=null&&(!Number.isFinite(m)||m<0)?(g(u("positions.toast.invalidClientPrice","âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„")),a?.focus(),null):{id:C,name:i?.name||c,cost:Number(r.toFixed(2)),clientPrice:m==null?null:Number(m.toFixed(2)),labelAr:s||null,labelEn:o||null}:(g(u("positions.toast.invalidName","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ¨")),e&&e.focus(),null)}function V(){const e=document.getElementById("technician-role");if(!e)return;const t=A?ke(A):null;be(e.value,t||{})}function N(){const e=document.getElementById("positions-table"),t=document.getElementById("positions-count");if(!e)return;const n=q();if(t&&(t.textContent=_(String(n.length))),!n.length){e.innerHTML=`
      <tr>
        <td colspan="5">${u("positions.table.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ØµØ¨ Ø¨Ø¹Ø¯.")}</td>
      </tr>
    `;return}e.innerHTML=n.map(a=>{const s=C&&String(C)===String(a.id),o=te(a.cost||0),c=a.clientPrice==null?u("technicians.positionSummary.noClientPrice","â€”"):te(a.clientPrice),i=ue(a,"ar")||"â€”",l=ue(a,"en")||"â€”",r=u("positions.table.actions.edit","âœï¸ ØªØ¹Ø¯ÙŠÙ„"),d=u("positions.table.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù");return`
      <tr${s?' class="technician-table-row-editing"':""}>
        <td>${D(i)}</td>
        <td>${D(l)}</td>
        <td>${D(o)}</td>
        <td>${D(c)}</td>
        <td class="table-actions-cell">
          <div class="table-action-buttons">
            <button type="button" class="technician-action-btn technician-action-btn--edit position-edit-btn" data-id="${a.id}">${r}</button>
            <button type="button" class="technician-action-btn technician-action-btn--delete position-delete-btn" data-id="${a.id}">${d}</button>
          </div>
        </td>
      </tr>
    `}).join("")}async function Ft(e){e.preventDefault();const t=qt();if(t)try{const n=!!C;n?await bt(t.id,t):await gt(t);const a=n?u("positions.toast.updateSuccess","ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"):u("positions.toast.addSuccess","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØµØ¨");g(a),Se(),N(),J(),V()}catch(n){console.error("âŒ [technicians] handlePositionSubmit failed",n);const a=n?.message||u("positions.toast.saveFailed","âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(a,"error")}}function zt(){Se()}async function Dt(e){try{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.id;if(!n)return;if(t.classList.contains("position-edit-btn")){await se();const a=q().find(s=>String(s.id)===String(n));if(!a){g(u("positions.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ¨"),"error");return}Pt(a),N();return}if(t.classList.contains("position-delete-btn")){if(!confirm(u("positions.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØµØ¨ØŸ")))return;await yt(n),C&&String(C)===String(n)&&Se(),g(u("positions.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØµØ¨")),N(),J(),V()}}catch(t){console.error("âŒ [technicians] handlePositionsTableClick failed",t);const n=t?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(n,"error")}}function $t(e){const t=Ue().find(n=>String(n.id)===String(e));if(!t){g(u("technicians.toast.dataNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…"));return}Tt(t),g(u("technicians.toast.editReady","âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¢Ù† Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"))}async function Mt(e){if(!qe()){dt();return}if(confirm(u("technicians.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")))try{await De(e),g(u("technicians.toast.deleteSuccess","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…")),A&&String(A)===String(e)&&oe(),S()}catch(t){console.error("âŒ [technicians] handleDeleteClick failed",t);const n=Z(t)?t.message:u("technicians.toast.deleteFailed","ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ù„Ø·Ø§Ù‚Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(n,"error")}}function ln(){ve(),S()}function ke(e){return Ue().find(t=>String(t.id)===String(e))||null}function Rt(e){const t=new Set,n=s=>{if(s==null)return;const o=String(s).trim();o&&t.add(o)},a=s=>{Array.isArray(s)&&s.forEach(o=>{if(o!=null)if(typeof o=="object"){const c=o.id??o.technicianId??o.technician_id??(o.technician&&(o.technician.id??o.technician.technicianId??o.technician.technician_id));n(c)}else n(o)})};return a(e?.technicians),a(e?.techniciansDetails),Array.from(t)}function xt(e){const t=e?.start??e?.startDatetime??e?.start_datetime??e?.start_date??null,n=e?.end??e?.endDatetime??e?.end_datetime??e?.end_date??null;return{start:t,end:n}}function Ke(e,t=[],n){const a=It(e);return a?t.some(s=>{if(!s)return!1;const o=String(s?.status||s?.reservationStatus||"").toLowerCase();if(o==="cancelled"||o==="canceled"||!Rt(s).includes(a))return!1;const{start:i,end:l}=xt(s);if(!i||!l)return!1;const r=new Date(i),d=new Date(l);return Number.isNaN(r.getTime())||Number.isNaN(d.getTime())?!1:r<=n&&n<d}):!1}function Ae(){const e=w().reservations||[],t=G();if(!Array.isArray(t)||t.length===0)return t;const n=new Date;let a=!1;const s=t.map(o=>{if(!o)return o;const c=o.baseStatus||o.status||"available";let i=c==="busy"?"busy":c;return Ke(o.id,e,n)&&(i="busy"),(i!==o.status||c!==o.baseStatus)&&(a=!0),{...o,baseStatus:c,status:i}});return a?(H(s),s):t}document.addEventListener("reservations:changed",()=>{const e=G();if(Ae()===e)try{S()}catch{}});document.addEventListener("reservations:updated",()=>{const e=G();if(Ae()===e)try{S()}catch{}});function ve(){const e=document.getElementById("technician-form"),t=e&&!e.dataset.initialized;e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",f=>{_t(f).catch(h=>{console.error("âŒ [technicians] submit handler failed",h)})}),e.dataset.listenerAttached="true"),e&&(e.dataset.initialized="true");const n=document.getElementById("technician-cancel-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ct),n.dataset.listenerAttached="true"),x(document.getElementById("technician-phone"),U);const a=document.getElementById("technician-role");a&&!a.dataset.listenerAttached&&(a.addEventListener("input",()=>{V()}),a.dataset.listenerAttached="true");const s=document.getElementById("technicians-table");s&&!s.dataset.listenerAttached&&(s.addEventListener("click",f=>{const h=f.target;if(h instanceof HTMLElement){if(h.classList.contains("technician-edit-btn")){const p=h.dataset.id;$t(p)}if(h.classList.contains("technician-delete-btn")){const p=h.dataset.id;Mt(p).catch(b=>{console.error("âŒ [technicians] delete handler failed",b)})}}}),s.dataset.listenerAttached="true");const o=document.getElementById("search-technician-input");o&&!o.dataset.listenerAttached&&(o.addEventListener("input",()=>{o.value=_(o.value),S()}),o.dataset.listenerAttached="true");const c=document.getElementById("technician-role-filter");c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{S()}),c.dataset.listenerAttached="true");const i=document.getElementById("save-technician-changes");i&&!i.dataset.listenerAttached&&(i.addEventListener("click",()=>{Lt().catch(f=>{console.error("âŒ [technicians] modal save failed",f)})}),i.dataset.listenerAttached="true");const l=document.getElementById("position-form");l&&!l.dataset.listenerAttached&&(l.addEventListener("submit",f=>{Ft(f).catch(h=>{console.error("âŒ [technicians] position submit failed",h)})}),l.dataset.listenerAttached="true");const r=document.getElementById("position-cancel-btn");r&&!r.dataset.listenerAttached&&(r.addEventListener("click",zt),r.dataset.listenerAttached="true");const d=document.getElementById("positions-table");d&&!d.dataset.listenerAttached&&(d.addEventListener("click",Dt),d.dataset.listenerAttached="true"),x(document.getElementById("position-cost"),T),x(document.getElementById("position-client-price"),T);const m=document.querySelector("[data-tech-tabs]");m&&!m.dataset.listenerAttached&&(m.querySelectorAll("[data-tech-tab]").forEach(h=>{h&&h.addEventListener("click",()=>{const p=h.getAttribute("data-tech-tab");Pe(p)})}),m.dataset.listenerAttached="true"),Pe(M),se().then(()=>{J(),M==="technicians-positions"&&N(),V()}).catch(f=>{console.error("âŒ [technicians] failed to load technician positions",f),g(f?.message||u("positions.toast.fetchFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ØµØ¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"),"error")}),Ne||(document.addEventListener("technician:prefill",f=>{const h=f.detail;h&&wt(h)}),Ne=!0),t&&oe(),M==="technicians-positions"&&N()}window.addEventListener("DOMContentLoaded",()=>{ve(),S(),Ee(),je()});const Ge=()=>{S()};window.addEventListener("technicians:updated",Ge);document.addEventListener("technicians:updated",Ge);document.addEventListener("technicians:refreshRequested",()=>{ve(),S(),Ee(),je({showToastOnError:!1})});document.addEventListener("language:changed",()=>{Ee(),J(),M==="technicians-positions"&&N(),V()});document.addEventListener(lt.USER_UPDATED,()=>{S()});const Ze=()=>{J(),M==="technicians-positions"&&N(),V()};window.addEventListener("technicianPositions:updated",Ze);document.addEventListener("technicianPositions:updated",Ze);function k(e){return _(String(e||"")).trim().toLowerCase()}function jt(e){const t=Number.parseFloat(_(String(e??"1")));return!Number.isFinite(t)||t<=0||t>50?1:Math.max(1,Math.round(t))}function L(e){const t=String(e??"").trim().toLowerCase();return t||""}function Je(){const{packages:e=[]}=w();return Array.isArray(e)?e.filter(t=>t&&typeof t=="object"):[]}function Ut(e){const t=L(e);return t&&Je().find(a=>L(a?.id??a?.packageId??a?.package_id)===t)||null}function Te(e){if(!e||typeof e!="object")return[];const t=[],n=[];Array.isArray(e.items)&&n.push(...e.items),Array.isArray(e.packageItems)&&n.push(...e.packageItems),Array.isArray(e.bundleItems)&&n.push(...e.bundleItems),Array.isArray(e.barcodes)&&n.push(...e.barcodes.map(i=>({barcode:i}))),n.forEach(i=>{if(!i)return;if(typeof i=="string"||typeof i=="number"){const f=k(i);if(!f)return;t.push({equipmentId:null,barcode:f,normalizedBarcode:f,qty:1,price:0,desc:""});return}if(typeof i!="object")return;const l=k(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number),r=[i.equipmentId,i.equipment_id,i.itemId,i.item_id,i.id].find(f=>f!=null&&f!==""),d=[i.unit_price,i.unitPrice,i.price,i.daily_rate].find(f=>Number.isFinite(Number(f))),m=[i.quantity,i.qty,i.count].find(f=>f!=null&&String(f).trim()!=="");t.push({equipmentId:r!=null?String(r):null,barcode:i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??"",normalizedBarcode:l,qty:jt(m),price:d!=null?Number(d):0,desc:i.description??i.desc??i.name??"",image:i.image??i.imageUrl??i.img??null})});const a=new Map,{equipment:s=[]}=w()||{},o=new Map,c=new Map;return(Array.isArray(s)?s:[]).forEach(i=>{if(!i||typeof i!="object")return;[i.id,i.equipment_id,i.equipmentId,i.item_id,i.itemId].map(d=>d!=null?String(d):"").filter(Boolean).forEach(d=>{o.has(d)||o.set(d,i)});const r=k(i.barcode);r&&!c.has(r)&&c.set(r,i)}),t.forEach(i=>{if(i.equipmentId&&o.has(i.equipmentId)){const l=o.get(i.equipmentId);if(l){if(i.desc||(i.desc=l.desc||l.description||l.name||""),i.barcode||(i.barcode=l.barcode||""),i.price==null||i.price===0){const r=l.price??l.unit_price,d=Number(r);Number.isFinite(d)&&d>=0&&d<1e6&&(i.price=d)}i.image||(i.image=l.image||l.imageUrl||l.img||null)}}else if(i.normalizedBarcode&&c.has(i.normalizedBarcode)){const l=c.get(i.normalizedBarcode);if(l){if(i.desc||(i.desc=l.desc||l.description||l.name||""),i.barcode||(i.barcode=l.barcode||""),i.price==null||i.price===0){const r=l.price??l.unit_price,d=Number(r);Number.isFinite(d)&&d>=0&&d<1e6&&(i.price=d)}i.image||(i.image=l.image||l.imageUrl||l.img||null)}}}),t.forEach(i=>{const l=i.normalizedBarcode||(i.barcode?k(i.barcode):""),r=l||(i.equipmentId?`id:${i.equipmentId}`:null);if(!r)return;if(!a.has(r)){a.set(r,{...i,normalizedBarcode:l});return}const d=a.get(r);d.qty+=i.qty,!d.price&&i.price&&(d.price=i.price),!d.desc&&i.desc&&(d.desc=i.desc),!d.image&&i.image&&(d.image=i.image)}),Array.from(a.values())}function Vt(e){if(!e||typeof e!="object")return 0;const t=[e.price,e.totalPrice,e.total_price,e.packagePrice,e.package_price];for(const a of t){const s=Number(a);if(Number.isFinite(s))return s}return Te(e).reduce((a,s)=>a+(s.price||0)*(s.qty||1),0)}function Ot(e){return!e||typeof e!="object"?"":e.name??e.title??e.label??e.package_name??e.packageName??""}function Ht(){return Je().map(t=>{const n=L(t?.id??t?.packageId??t?.package_id??t?.code),a=Ot(t)||n||"package",s=Vt(t);return{id:n,name:a,price:s,code:t?.package_code??t?.code??n,items:Te(t),raw:t}}).filter(t=>t.id)}function Wt(e){const t=k(e);return t?Ht().filter(n=>n.items.some(a=>a.normalizedBarcode===t)):[]}function kt(e){return Te(e).map(n=>({equipmentId:n.equipmentId,barcode:n.barcode,normalizedBarcode:n.normalizedBarcode,qty:n.qty,price:n.price,desc:n.desc,image:n.image??null}))}let O=[],Qe=[],Xe=[],Ye="single";function dn(){return O}function un(e){O=Array.isArray(e)?e:[]}function fn(e){O=[...O,e]}function mn(e){Number.isInteger(e)&&e>=0&&(O=O.filter((t,n)=>n!==e))}function pn(){return Qe}function hn(e){Qe=Array.isArray(e)?e:[]}function gn(){return Xe}function bn(e){Xe=Array.isArray(e)?e:[]}function yn(e){}function In(){return Ye==="package"?"package":"single"}function En(e){Ye=e==="package"?"package":"single"}function Sn(e){if(!e)return{date:"",time:""};const t=String(e).trim();if(!t)return{date:"",time:""};let n=t;n.includes(" ")&&!n.includes("T")&&(n=n.replace(" ","T"));const[a="",s=""]=n.split("T"),o=a?a.slice(0,10):"",c=s.match(/(\d{1,2}:\d{2})/);let i="";if(c){const[l="00",r="00"]=c[0].split(":");i=`${l.padStart(2,"0")}:${r.padStart(2,"0")}`}return{date:o,time:i}}function An(e,t){if(!e)return"";const n=t&&t.length?t:"00:00";return`${e}T${n}`}function v(e){return _(String(e||"")).trim().toLowerCase()}const Kt=864e13;function I(e){if(!e&&e!==0)return null;if(e instanceof Date){const a=e.getTime();return Number.isNaN(a)?null:new Date(a)}if(typeof e=="number"){if(!Number.isFinite(e))return null;const a=new Date(e);return Number.isNaN(a.getTime())?null:a}let t=String(e??"").trim();if(!t)return null;if(/^\d+$/.test(t)){const a=Number(t);if(Number.isFinite(a)){const s=new Date(a);if(!Number.isNaN(s.getTime()))return s}}if(!t.includes("T")&&t.includes(" ")){const a=t.indexOf(" ");t=`${t.slice(0,a)}T${t.slice(a+1).trimStart()}`}else t.includes(" ")&&(t=t.replace(" ","T"));const n=new Date(t);if(!Number.isNaN(n.getTime()))return n;if(!t.endsWith("Z")&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?$/.test(t)){const a=new Date(`${t}Z`);if(!Number.isNaN(a.getTime()))return a}return null}function vn(e,t,n,a=null){if(!e||!t||!n)return!1;const s=I(t),o=I(n);if(!s||!o||s>=o)return!1;const c=v(e);if(!c)return!1;const i=w()||{},l=Array.isArray(i.reservations)?i.reservations:[],r=Array.isArray(i.maintenance)?i.maintenance:[],d=Array.isArray(i.equipment)?i.equipment:[],m=nn(d),f=Q(a);return l.some(p=>{if(!p||X(p,f)||!p.start||!p.end)return!1;const b=String(p?.status||p?.reservationStatus||"").toLowerCase();if(b==="cancelled"||b==="canceled")return!1;const y=I(p.start),E=I(p.end);return!y||!E||!(y<o&&E>s)?!1:tt(p,c)})?!0:r.some(p=>{if(!Qt(p)||!Yt(p,m).has(c))return!1;const{start:y,end:E}=en(p);if(!y&&!E)return!0;const F=y??new Date(0),z=E??new Date(Kt);return F<o&&z>s})}function Gt(e,t,n,a=null){const s=L(e);if(!s||!t||!n)return!1;const o=I(t),c=I(n);if(!o||!c||o>=c)return!1;const i=w()||{},l=Array.isArray(i.reservations)?i.reservations:[],r=Q(a);return l.some(d=>{if(!d?.start||!d?.end||X(d,r))return!1;const m=String(d?.status||d?.reservationStatus||"").toLowerCase();if(m==="cancelled"||m==="canceled")return!1;const f=I(d.start),h=I(d.end);return!f||!h||!(f<c&&h>o)?!1:Zt(d,s)})}function Tn(e,t,n,a=null){const s=v(e);if(!s||!t||!n)return[];const o=Wt(s);return o.length?o.filter(c=>Gt(c.id,t,n,a)):[]}function et(e){const t=[];return!e||typeof e!="object"||["items","equipment","packages","packageItems","package_items","reservedItems","reserved_items"].forEach(a=>{const s=e[a];Array.isArray(s)&&s.length&&t.push(s)}),t}function tt(e,t){if(!t||!e||typeof e!="object")return!1;const n=v(e?.barcode);if(n&&n===t)return!0;const a=et(e);for(const s of a)for(const o of s)if(Jt(o).has(t))return!0;return!1}function Zt(e,t){if(!t||!e||typeof e!="object")return!1;const n=[e.packageId,e.package_id,e.bundleId,e.bundle_id,e.packageCode,e.package_code];for(const o of n){if(!o&&o!==0)continue;const c=L(o);if(c&&c===t)return!0}const a=e.packages;if(Array.isArray(a))for(const o of a){const c=L(o);if(c&&c===t)return!0}const s=et(e);for(const o of s)for(const c of o)if(Be(c).has(t))return!0;return!1}function Jt(e){const t=new Set;if(!e&&e!==0)return t;if(typeof e=="string"||typeof e=="number"){const o=v(e);return o&&t.add(o),t}if(typeof e!="object")return t;const n=v(e.barcode??e.equipmentBarcode??e.code??e.serial??e.serialNumber??e.serial_number);n&&t.add(n),["packageItems","package_items","items","equipment","bundleItems","bundle_items"].forEach(o=>{const c=e[o];Array.isArray(c)&&c.forEach(i=>{if(i!=null){if(typeof i=="string"||typeof i=="number"){const l=v(i);l&&t.add(l);return}if(typeof i=="object"){const l=v(i.barcode??i.equipmentBarcode??i.code??i.serial??i.serialNumber??i.serial_number);l&&t.add(l)}}})});const s=Be(e);return s.size&&s.forEach(o=>{const c=Ut(o);if(!c)return;kt(c).forEach(l=>{const r=l.normalizedBarcode??v(l.barcode);r&&t.add(r)})}),t}function Be(e){const t=new Set;if(!e&&e!==0||typeof e=="string"||typeof e=="number"||typeof e!="object")return t;const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.bundleId,e.bundle_id];return(e.type==="package"||e.kind==="package"||e.category==="package")&&n.push(e.id,e.code,e.uuid),n.forEach(a=>{const s=L(a);s&&t.add(s)}),e.package&&typeof e.package=="object"&&Be(e.package).forEach(s=>t.add(s)),Array.isArray(e.packages)&&e.packages.forEach(a=>{const s=L(a);s&&t.add(s)}),t}function Qt(e){const t=[e?.statusRaw,e?.status_raw,e?.status,e?.statusLabel,e?.status_label];if(tn(e))return!1;for(const n of t){const a=Xt(n);if(a){if(a==="completed"||a==="cancelled"||a==="closed")return!1;if(a==="open"||a==="in_progress")return!0}}return!0}function Xt(e){const t=String(e??"").trim().toLowerCase().replace(/\s+/g,"_");return t?t==="completed"||t==="done"||t==="finished"||t==="resolved"||t==="closed"||t==="Ù…ÙƒØªÙ…Ù„"||t==="Ù…ØºÙ„Ù‚"?"completed":t==="cancelled"||t==="canceled"||t==="Ù…Ù„ØºÙŠ"?"cancelled":t==="in_progress"||t==="in-progress"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØªÙ†ÙÙŠØ°"||t==="Ø¬Ø§Ø±ÙŠ_Ø§Ù„Ø¹Ù…Ù„"||t==="inprogress"?"in_progress":t==="open"||t==="Ù‚ÙŠØ¯_Ø§Ù„ØµÙŠØ§Ù†Ø©"||t==="Ù‚ÙŠØ¯_Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"||t==="pending"||t==="scheduled"||t==="active"?"open":t.includes("progress")||t.includes("ongoing")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("close")||t.includes("complete")||t.includes("finish")||t.includes("resolve")?"completed":t.includes("cancel")?"cancelled":"open":""}function Yt(e,t){const n=new Set;[e?.equipmentBarcode,e?.equipment_barcode,e?.barcode].forEach(c=>{const i=v(c);i&&n.add(i)});const s=e?.equipment&&typeof e.equipment=="object"?e.equipment:null;if(s){const c=v(s.barcode??s.equipmentBarcode??s.code??s.serial??s.serialNumber??s.serial_number);c&&n.add(c)}return[e?.equipmentId,e?.equipment_id,s?.id,s?.equipmentId,s?.equipment_id].map(c=>c!=null?String(c):"").filter(Boolean).forEach(c=>{const i=t.get(c);if(!i)return;const l=v(i?.barcode??i?.equipmentBarcode??i?.code??i?.serial??i?.serialNumber??i?.serial_number);l&&n.add(l)}),n}function en(e){const t=fe([e?.scheduledAt,e?.scheduled_at,e?.startAt,e?.start_at,e?.startDate,e?.start_date,e?.reportedAt,e?.reported_at,e?.createdAt,e?.created_at]),n=fe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at]);return{start:t,end:n}}function tn(e){return!!fe([e?.resolvedAt,e?.resolved_at,e?.closedAt,e?.closed_at,e?.completedAt,e?.completed_at,e?.finishedAt,e?.finished_at,e?.endAt,e?.end_at,e?.endDate,e?.end_date,e?.expectedCompletionAt,e?.expected_completion_at,e?.dueAt,e?.due_at])}function fe(e=[]){for(const t of e){const n=I(t);if(n)return n}return null}function nn(e){const t=new Map;return Array.isArray(e)&&e.forEach(n=>{if(!n||typeof n!="object")return;[n?.id,n?.ID,n?.equipment_id,n?.equipmentId,n?.item_id,n?.itemId,n?.uuid,n?.UUID].map(s=>s!=null?String(s):"").filter(Boolean).forEach(s=>{t.has(s)||t.set(s,n)})}),t}function Bn(e,t,n,a=null){if(!e||!t||!n)return!1;const s=new Date(t),o=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(o.getTime()))return!1;const{reservations:c=[]}=w(),i=String(e),l=Q(a);return c.some(r=>{if(!r?.start||!r?.end||X(r,l))return!1;const d=String(r?.status||r?.reservationStatus||"").toLowerCase();if(d==="cancelled"||d==="canceled")return!1;const m=new Date(r.start),f=new Date(r.end);return Number.isNaN(m.getTime())||Number.isNaN(f.getTime())||!(m<o&&f>s)?!1:(Array.isArray(r.technicians)?r.technicians:[]).some(b=>String(b)===i)})}function _n(e,t,n,a=null){if(!e||!t||!n)return[];const s=I(t),o=I(n);if(!s||!o||s>=o)return[];const{reservations:c=[]}=w(),i=String(e),l=Q(a),r=[];return c.forEach(d=>{if(!d?.start||!d?.end||X(d,l))return;const m=String(d?.status||d?.reservationStatus||"").toLowerCase();if(m==="cancelled"||m==="canceled")return;const f=I(d.start),h=I(d.end);if(!f||!h||!(f<o&&h>s)||!(Array.isArray(d.technicians)?d.technicians:[]).some(y=>String(y)===i))return;const b=d.reservationCode||d.reservation_code||null;if(b)r.push(String(b));else if(d.id!=null||d.reservationId!=null){const y=d.id??d.reservationId;r.push(`#${String(y)}`)}}),Array.from(new Set(r))}function Cn(e=[],t,n,a=null){const o=(Array.isArray(e)?e:[e]).map(m=>v(m)).filter(Boolean);if(!o.length||!t||!n)return[];const c=I(t),i=I(n);if(!c||!i||c>=i)return[];const{reservations:l=[]}=w(),r=Q(a),d=[];return l.forEach(m=>{if(!m?.start||!m?.end||X(m,r))return;const f=String(m?.status||m?.reservationStatus||"").toLowerCase();if(f==="cancelled"||f==="canceled")return;const h=I(m.start),p=I(m.end);if(!(!h||!p)&&h<i&&p>c){for(const b of o)if(tt(m,b)){const y=m.reservationCode||m.reservation_code||null;if(y)d.push(String(y));else if(m.id!=null||m.reservationId!=null){const E=m.id??m.reservationId;d.push(`#${String(E)}`)}break}}}),Array.from(new Set(d))}function Q(e){return R(e,new Set)}function X(e,t){if(!t||t.size===0)return!1;const n=R([e?.id,e?.reservationId,e?.reservation_id,e?.reservationCode,e?.reservation_code,e?.uuid,e?.UUID,e?._id],new Set);for(const a of n)if(t.has(a))return!0;return!1}function R(e,t){if(e==null)return t;if(e instanceof Set)return e.forEach(o=>R(o,t)),t;if(Array.isArray(e))return e.forEach(o=>R(o,t)),t;if(typeof e=="object"){const o=["id","reservationId","reservation_id","reservationCode","reservation_code","uuid","UUID","_id"];let c=!1;return o.forEach(i=>{Object.prototype.hasOwnProperty.call(e,i)&&(c=!0,R(e[i],t))}),c||Object.values(e).forEach(i=>R(i,t)),t}const n=_(String(e??"")).trim();if(!n)return t;const a=[n,n.toLowerCase(),n.toUpperCase()],s=n.replace(/\D+/g,"");if(s){a.push(s);const o=Number.parseInt(s,10);Number.isNaN(o)||a.push(String(o))}return a.forEach(o=>{o&&t.add(o)}),t}export{Sn as A,L as B,un as C,Ut as D,Vt as E,Ot as F,bn as G,En as H,hn as I,q as J,pt as K,Je as L,se as M,Cn as N,sn as O,ln as a,Te as b,on as c,cn as d,D as e,te as f,ke as g,pn as h,Ht as i,yn as j,dn as k,An as l,ie as m,v as n,gn as o,Tn as p,vn as q,Fe as r,Ae as s,rn as t,fn as u,In as v,mn as w,Gt as x,Bn as y,_n as z};
