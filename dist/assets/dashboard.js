const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reports.js","./auth.js","./auth.css","./reservationsService.js","./controller.js","./dashboardShell.js","./customers.js","./dashboardMetrics.js"])))=>i.map(i=>d[i]);
import{d as J,t as c,e as W,n as v,b as Ce,A as Gt,s as Yt,f as Kt,h as g,j as ge,k as ce,o as Ye,u as le,p as Ae,q as Qt,r as Wt,a as Zt,c as Jt,i as Xt,l as en}from"./auth.js";import{i as tn}from"./dashboardShell.js";import{r as nn}from"./customers.js";import{e as mt,a as an,r as Ie,b as rn,i as sn,s as on,c as cn,l as ln,d as dn,f as un,u as ft,g as mn,h as fn,j as pn,k as bn,m as vn,n as gn,o as Ke,p as hn,q as yn,t as En,w as Sn}from"./controller.js";import{i as _n,b as Tn,c as An,g as xe,s as wn,e as Ln}from"./reservationsService.js";const Cn="modulepreload",In=function(e,t){return new URL(e,t).href},rt={},pt=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){let m=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};const i=document.getElementsByTagName("link"),s=document.querySelector("meta[property=csp-nonce]"),l=s?.nonce||s?.getAttribute("nonce");o=m(n.map(u=>{if(u=In(u,a),u in rt)return;rt[u]=!0;const d=u.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(a)for(let S=i.length-1;S>=0;S--){const T=i[S];if(T.href===u&&(!d||T.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${u}"]${f}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":Cn,d||(p.as="script"),p.crossOrigin="",p.href=u,l&&p.setAttribute("nonce",l),document.head.appendChild(p),d)return new Promise((S,T)=>{p.addEventListener("load",S),p.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(i){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=i,window.dispatchEvent(s),!s.defaultPrevented)throw i}return o.then(i=>{for(const s of i||[])s.status==="rejected"&&r(s.reason);return t().catch(r)})};let Pe=!1;function qn(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.setAttribute("step","300")})}function Bn(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):(console.warn("âš ï¸ Flatpickr ØºÙŠØ± Ù…ØªØ§Ø­ - Ø³ÙŠØªÙ… ØªØ®Ø·ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"),null)}function kn(){const e=Bn(),t={dateFormat:"Y-m-d",altInput:!0,altFormat:"Y-m-d",allowInput:!0,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"},n=[["#res-start",{}],["#res-end",{}],["#filter-start-date",{}],["#filter-end-date",{}],["#edit-res-start",{}],["#edit-res-end",{}]],a={enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,disableMobile:!0,minuteIncrement:5,altInputClass:"flatpickr-alt-input form-control"},o=["#res-start-time","#res-end-time","#edit-res-start-time","#edit-res-end-time"];e&&(n.forEach(([i,s])=>{document.querySelector(i)&&e(i,{...t,...s})}),o.forEach(i=>{document.querySelector(i)&&e(i,{...a})}));const r=document.querySelector("#res-start-time");r&&r.dispatchEvent(new Event("change",{bubbles:!0}))}function bt(){Pe||(qn(),on(()=>Ie()),cn(mn()),_n({onDraftChange:fn,onEditChange:ft}),ln(),dn(),Pe=!0)}function $n(){const e=document.body;e&&e.dataset.reservationsTechListener!=="true"&&(document.addEventListener("technicians:updated",()=>{const{technicians:t=[]}=J();Tn(t),un(),ft()}),e.dataset.reservationsTechListener="true")}async function Mn(){await mt();try{await an({force:!0})}catch(e){console.warn("âš ï¸ [reservations/events] Failed to pre-load projects for reservation form",e)}Ie(),rn(),sn({onAfterSubmit:pn}),Pe||bt(),kn(),$n()}const Rn={limit:200};let y=null,st=!1,it=!1,ot=!1,ct=!1,Me=null,Re=null,Fe=!1,H="";const Fn=[{key:"confirmed",chipClass:"reservation-chip status-confirmed"},{key:"pending",chipClass:"reservation-chip status-pending"},{key:"paid",chipClass:"reservation-chip status-paid"},{key:"unpaid",chipClass:"reservation-chip status-unpaid"},{key:"completed",chipClass:"reservation-chip status-completed"}],Dn={confirmed:"Ø­Ø¬Ø² Ù…Ø¤ÙƒØ¯",pending:"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯",paid:"Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„",unpaid:"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹",completed:"Ù…Ù†ØªÙ‡ÙŠ"},Nn={confirmed:"Confirmed reservation",pending:"Awaiting confirmation",paid:"Paid in full",unpaid:"Payment pending",completed:"Completed"},De=new Map;function x(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Qe(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function xn(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function Pn(e){return De.has(e)||De.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),De.get(e)}function jn(e,t,n=!1){if(n){const u=(W?.()==="en"?"en":"ar")==="en"?"All day":"Ø·ÙˆØ§Ù„ Ø§Ù„ÙŠÙˆÙ…";return c("calendar.labels.allDay",u)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const o=W?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",r=Pn(o),i=r.format(a);if(!t)return i;const s=new Date(t);if(Number.isNaN(s.getTime()))return i;const l=r.format(s);return i===l?i:`${i} â€“ ${l}`}function zn({paid:e,confirmed:t,completed:n}){const a=["calendar-event"];return(n===!0||n==="true")&&a.push("calendar-event--completed"),t===!0||t==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function vt(){const e=document.getElementById("calendar-legend");if(!e)return;const t=W?.()==="en"?"en":"ar";e.innerHTML=Fn.map(({key:n,chipClass:a})=>{const o=t==="en"?Nn[n]??n:Dn[n]??n,r=x(c(`calendar.legend.${n}`,o));return`<span class="calendar-legend__item" role="listitem"><span class="${a} calendar-legend__chip">${r}</span></span>`}).join("")}function te(){const{calendarEl:e}=Qe();if(!e)return;const t=e.querySelector(".fc-header-toolbar");if(!t)return;t.classList.add("calendar-toolbar"),t.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const n=t.querySelector(".fc-toolbar-title");n&&n.classList.add("calendar-toolbar__title"),t.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function ne({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:o}=Qe();if(!a||!o)return;const r=typeof t=="string"?t.trim().length>0:!!t,i=!e&&!r&&!!n,s=e||r||i;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",i),o.dataset.initialized||(o.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),o.dataset.initialized="true"),o.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),o.classList.toggle("hidden",!s),!s){o.innerHTML="",o.removeAttribute("data-status");return}let l="";e?l=c("calendar.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª..."):r?l=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹."):i&&(l=c("calendar.status.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©."));const m=e?"loading":r?"error":"empty";if(o.setAttribute("data-status",m),o.classList.add(`calendar-status-card--${m}`),o.innerHTML="",e){const d=document.createElement("span");d.className="loading loading-spinner loading-md text-primary",d.setAttribute("aria-hidden","true"),o.appendChild(d)}else{const d=document.createElement("span");d.className="calendar-status-card__icon",d.setAttribute("aria-hidden","true"),d.textContent=r?"âš ï¸":"ğŸ—“ï¸",o.appendChild(d)}const u=document.createElement("span");u.className="calendar-status-card__message text-center text-sm font-semibold",u.textContent=l,o.appendChild(u)}function Ne(){y&&(y.destroy(),y=null)}function On(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const o=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:o==="paid",{effectiveConfirmed:i}=vn(e,t),s=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let m=!!e.completed;if(!m&&a){const u=new Date(a);Number.isNaN(u.getTime())||(m=u<new Date)}return{id:e.id??s??n,start:n,end:a||n,paid:r,confirmed:i,completed:m,reservationId:s??"",customerName:l,raw:e}}function gt(e=[]){const{projects:t=[]}=J(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const o=a?.projectId??a?.project_id??null,r=o!=null&&o!==""&&n.get(String(o))||null,i=On(a,r);if(!i)return null;const s=zn({paid:i.paid,confirmed:i.confirmed,completed:i.completed});return{id:i.id,title:"",start:i.start,end:i.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:s,extendedProps:{...a,raw:a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}function lt(){return{today:c("calendar.buttons.today","Ø§Ù„ÙŠÙˆÙ…"),month:c("calendar.buttons.month","Ø´Ù‡Ø±"),week:c("calendar.buttons.week","Ø£Ø³Ø¨ÙˆØ¹"),day:c("calendar.buttons.day","ÙŠÙˆÙ…")}}async function Hn(){if(Fe)return xe();Fe=!0,H="";try{await mt({suppressError:!1,params:Rn})}catch(e){console.error("âŒ [calendar] Failed to load reservations for calendar view",e),H=An(e)?e.message:e instanceof Error&&e.message||""}finally{Fe=!1}return xe()}function ht(e){y&&y.batchRendering(()=>{y.removeAllEvents(),y.addEventSource(e)})}function yt(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Et(){const e=xe(),t=gt(e);if(!y){qe();return}y.setOption("locale",W()),ht(t),de(),ne({loading:!1,error:"",empty:t.length===0}),yt(t),vt(),te()}function Vn(){st||(document.addEventListener("language:changed",()=>{y&&y.setOption("locale",W()),qe()}),st=!0),it||(document.addEventListener("reservations:changed",()=>{Et()}),it=!0)}function St(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function de(){if(!y)return;const e=St();y.view?.type!==e&&y.changeView(e),y.updateSize()}function Un(){ot||typeof window>"u"||(window.addEventListener("resize",()=>{de()}),ot=!0)}function Gn(){if(ct||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{Re&&clearTimeout(Re),Re=setTimeout(()=>{y&&Et()},80)};Me=new MutationObserver(e),Me.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&Me.observe(document.body,{attributes:!0,attributeFilter:["class"]}),ct=!0}function Yn(e){const{reservationId:t,customerName:n,paid:a,confirmed:o,completed:r}=e.event.extendedProps,i=a===!0||a==="paid",s=o===!0||o==="true",l=r===!0||r==="true",m=document.createElement("div");m.className="calendar-event-wrapper";const u=s?c("calendar.badges.confirmed","Ù…Ø¤ÙƒØ¯"):c("calendar.badges.pending","ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),d=i?c("calendar.badges.paid","Ù…Ø¯ÙÙˆØ¹"):c("calendar.badges.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),f=c("calendar.badges.completed","Ù…Ù†ØªÙ‡ÙŠ"),p=c("calendar.labels.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),S=[`<span class="reservation-chip calendar-chip ${s?"status-confirmed":"status-pending"}">${x(u)}</span>`,`<span class="reservation-chip calendar-chip ${i?"status-paid":"status-unpaid"}">${x(d)}</span>`];l&&S.push(`<span class="reservation-chip calendar-chip status-completed">${x(f)}</span>`);const T=jn(e.event.startStr,e.event.endStr,e.event.allDay),I=x(T||""),j=x(t||"â€”"),R=x(n||p),z=I?`<span class="calendar-event-card__time">${I}</span>`:"";return m.innerHTML=`
    <article class="calendar-event-card">
      <header class="calendar-event-card__head">
        ${z}
        <span class="calendar-event-card__id">${j}</span>
      </header>
      <div class="calendar-event-card__customer">${R}</div>
      <div class="calendar-event-card__chips">${S.join("")}</div>
    </article>
  `,{domNodes:[m]}}function Kn(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"));return}const n=J()||{},{reservations:a=[],customers:o=[],projects:r=[],technicians:i=[]}=n,s=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},l=[s.id,s.reservationId,s.reservation_id,s.reservationCode,s.reservation_code].map(b=>b==null?"":String(b)).filter(b=>b.length>0);let m=-1,u=null;l.length>0&&(m=a.findIndex(b=>{const F=[b?.id,b?.reservationId,b?.reservation_id,b?.reservationCode,b?.reservation_code].map($=>$==null?"":String($)).filter($=>$.length>0);return F.length===0?!1:F.some($=>l.includes($))}),m>=0&&(u=a[m]));const d=u?{...u,...s}:s,f=d.projectId??d.project_id??null,p=f!=null&&r.find(b=>String(b.id)===String(f))||null,S=d.customerId??d.customer_id,T=o.find(b=>String(b.id)===String(S)),I=wn(),j=[...Array.isArray(I)?I:[],...Array.isArray(i)?i:[]],R=new Map;j.forEach(b=>{if(!b||b.id==null)return;const F=String(b.id),$=R.get(F)||{};R.set(F,{...$,...b})});const z=Array.from(R.values());let A="";try{A=bn(d,T,z,m>=0?m:0,p)}catch(b){console.error("âŒ [calendar] Failed to build reservation details for calendar modal",b),t.innerHTML=`<p class="text-sm text-error">${x(c("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"))}</p>`;return}t.innerHTML=A,t.classList.add("calendar-reservation-details"),t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(b=>{b instanceof HTMLElement&&(b.setAttribute("disabled","true"),b.setAttribute("aria-disabled","true"),b.setAttribute("tabindex","-1"))});const X=t.querySelector('[data-action="open-project"]');X&&(p?X.addEventListener("click",()=>{const b=p?.id!=null?String(p.id):"",F=b?`projects.html?project=${encodeURIComponent(b)}`:"projects.html";window.location.href=F}):X instanceof HTMLElement&&X.setAttribute("disabled","true"));const ye=document.getElementById("calendarReservationModal");ye&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(ye).show():alert(c("calendar.alerts.cannotOpenModal","Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„"))}function qe(){Vn(),Un(),Gn();const{calendarEl:e}=Qe();if(!e)return;const t=xn();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");ne({error:n}),Ne();return}(async()=>{ne({loading:!0});const n=await Hn();if(H){const o=c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");ne({loading:!1,error:H||o}),Ne();return}const a=gt(n);y?(y.setOption("locale",W()),y.setOption("buttonText",lt()),ht(a),te()):(y=new t.Calendar(e,{initialView:St(),locale:W(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:lt(),events:a,eventContent:Yn,eventClick(o){Kn(o.event.extendedProps)},windowResize:de,datesSet(){te()}}),y.render(),te()),de(),yt(a),ne({loading:!1,error:"",empty:a.length===0}),vt(),te(),setTimeout(()=>{de(),te()},120)})().catch(n=>{console.error("âŒ [calendar] renderCalendar failed",n),H=n instanceof Error&&n.message||H||"";const a=c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");ne({loading:!1,error:H||a}),Ne()})}const Qn=J()||{};let K=(Qn.maintenance||[]).map(_t);function Be(){return K}function ke(e){return K=Array.isArray(e)?e.map(_t):[],Yt({maintenance:K}),ia(),K}async function Wn(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,i])=>{i!=null&&i!==""&&t.set(r,String(i))});const n=t.toString(),a=await Ce(`/maintenance/${n?`?${n}`:""}`),o=Array.isArray(a?.data)?a.data.map(We):[];return ke(o)}async function Zn(e){const t=await Ce("/maintenance/",{method:"POST",body:e}),n=We(t?.data??{});return ke([n,...K.filter(a=>a.id!==n.id)]),n}async function Jn(e,t){const n=await Ce(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=We(n?.data??{});return ke(K.map(o=>String(o.id)===String(e)?a:o)),a}async function Xn(e){await Ce(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ke(K.filter(t=>String(t.id)!==String(e)))}function ea({equipmentId:e,technicianId:t,issue:n,priority:a,status:o,scheduledAt:r,resolutionReport:i}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:o,notes:n??"",resolution_report:null,repair_cost:null}}function We(e={}){return Tt({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function _t(e={}){return Tt(e)}function Tt(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=na(e.status_raw??e.status??"open"),o=aa(a),r=sa(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:ra(e.priority??"medium"),status:o,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:ta(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function ta(e){if(e==null||e==="")return null;const t=Number.parseFloat(v(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function na(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function aa(e){const t=At(e);return["completed","cancelled"].includes(t)?"closed":"open"}function ra(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function sa(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,o=>o.toUpperCase())}function At(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"open";case"in_progress":case"in-progress":case"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":case"ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­":case"closed":case"Ù…ØºÙ„Ù‚":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return t.includes("progress")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("Ù…Ù†Ø¬Ø²")||t.includes("Ù…ØºÙ„Ù‚")?"completed":t.includes("cancel")||t.includes("Ù…Ù„ØºÙŠ")?"cancelled":t||"open"}}function ia(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function pe(e){return e instanceof Gt}function je(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getFullYear()).slice(-2);return`${n}/${a}/${o}`}let Z=Be(),Q=[],ue=null,ae=!1,me="",re=Z.length>0,k={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},Ze=null,L=null,E=null,q=null,se=null,fe=null,ie=null,_=null;async function be({showToastOnError:e=!0}={}){if(!ae){ae=!0,me="",M();try{await Wn(),re=!0}catch(t){re=Z.length>0,console.error("âŒ [maintenance] Failed to load maintenance tickets",t),me=pe(t)?t.message:c("maintenance.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."),e&&g(me,"error")}finally{ae=!1,Z=Be(),M()}}}function ze(){return c("maintenance.form.selectedInfo","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø¯Ø© Ø¨Ø¹Ø¯.")}function N(e){return v(String(e||"")).trim().toLowerCase()}function wt(e=""){return v(String(e)).trim().toLowerCase()}function oa(e={}){const t=String(e?.desc??"").trim(),n=v(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function ca(e){const t=v(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Lt(e){return v(String(e||"")).trim().toLowerCase()}function h(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function la(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function P(){return Z=Be(),Z}function Ct(e){return P().find(n=>Number(n.id)===Number(e))||null}function It(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","ØµÙŠØ§Ù†Ø©"].includes(t)?"maintenance":["reserved","Ù…Ø­Ø¬ÙˆØ²"].includes(t)?"reserved":["retired","Ù…ØªÙˆÙ‚Ù","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©"].includes(t)?"retired":"available":"available"}function Je(){const{equipment:e=[]}=J(),t=c("maintenance.table.noName","Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return Q=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),o=N(a),r=Number.parseInt(n?.qty??n?.quantity??0,10),i=Number.isFinite(r)?Math.max(r,0):1,s=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"Ù…ØªØ§Ø­",m=n?.desc||n?.description||n?.name||t,u=oa({desc:m,displayBarcode:a,barcode:o});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:o,displayBarcode:a,desc:m,status:l,statusNormalized:It(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:i,image:s,searchValue:u,searchValueNormalized:Lt(u),descriptionNormalized:wt(m)}}),Q.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),Q}function Xe(){const e=new Set,t=new Map;return P().filter(n=>n.status==="open").forEach(n=>{const a=N(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function qt(e){const t=N(e);if(!t)return 0;const{map:n}=Xe();return n.get(t)||0}function $e(e){const t=N(e);return t&&(Q.length?Q:Je()).find(a=>a.barcode===t)||null}function da(e){const t=Q.length?Q:Je();if(!t.length)return null;const n=Lt(e);if(n){const s=t.find(l=>l.searchValueNormalized===n);if(s)return s}const{description:a,barcode:o}=ca(e);if(o){const s=N(o);if(s){const l=t.find(m=>m.barcode===s);if(l)return l}}const r=wt(a||e);if(!r)return null;const i=t.find(s=>s.descriptionNormalized===r);return i||t.find(s=>s.descriptionNormalized.includes(r))||null}function Oe(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,r=(t||Xe().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||r>=1:r>=a}function V({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),o&&(o.value="")),r&&(r.textContent=ze(),r.classList.remove("maintenance-selected-info--has-selection")),ue=null}function Bt(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","Ø¨Ø§Ø±ÙƒÙˆØ¯"),a=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),o=c("maintenance.info.unitsAvailable","Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†"),r=c("maintenance.info.categoryLabel","Ø§Ù„Ù‚Ø³Ù…"),i=e.displayBarcode||e.barcode||a,s=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,m=qt(s),u=Math.max(l-m,0),d=e.category?`
    <div class="maintenance-selected-info__meta">${r}: <strong>${h(e.category)}</strong></div>
  `:"",f=l>0?`
    <div class="maintenance-selected-info__meta">
      ${o}: <strong>${u}</strong> / ${l}
    </div>
  `:"",p=e.image?`<img class="maintenance-selected-info__image" src="${h(e.image)}" alt="${h(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">ğŸ¥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${p}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${h(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${h(i)}</strong></div>
      ${f}
      ${d}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function et(e,{silent:t=!1}={}){if(!e)return!1;if(Oe(e))return t||g(c("maintenance.toast.equipmentBlocked","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),o&&(o.value=e.searchValue||e.desc),Bt(e),ue=e,!0}function kt(e,{showFeedback:t=!0}={}){const n=$e(e);return n?et(n,{silent:!t}):(t&&g(c("maintenance.toast.equipmentNotFoundBarcode","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯")),!1)}function $t(e,{showFeedback:t=!0}={}){const n=da(e);return n?et(n,{silent:!t}):(t&&g(c("maintenance.toast.equipmentNotFoundName","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„")),!1)}function tt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=Je(),{map:o}=Xe();e&&(e.innerHTML=a.map(i=>`<option value="${h(i.searchValue||i.desc)}"></option>`).join(""));const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const i=$e(r.value);!i||Oe(i,o)?(V({keepInputs:!0,silent:!0}),i&&Oe(i,o)&&g(c("maintenance.toast.equipmentBecameBlocked","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø£ØµØ¨Ø­Øª Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§"))):et(i,{silent:!0})}else V({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),kt(t.value)||V({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const i=()=>{if(!n.value){V({keepInputs:!0,silent:!0});return}$t(n.value)||V({keepInputs:!0,silent:!0})};n.addEventListener("change",i),n.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),i())}),n.dataset.listenerAttached="true"}}async function we(){try{await gn({showToastOnError:!1})}catch(e){console.error("âŒ [maintenance] refreshEquipmentData failed",e)}finally{Ke(),tt()}}function Mt(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;Ze=t.Modal.getOrCreateInstance(e),L||(L=e.querySelector("#maintenance-close-report")),E||(E=e.querySelector("#maintenance-close-cost")),E&&E.dataset.normalizeAttached!=="true"&&(E.addEventListener("input",a=>{ua(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),E.dataset.normalizeAttached="true"),q||(q=e.querySelector("#maintenance-close-submit")),se||(se=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",fa),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Rt),e.dataset.listenerAttached="true"),!0}function Rt(){k={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},L&&(L.value="",L.classList.remove("is-invalid")),E&&(E.value="",E.classList.remove("is-invalid")),se&&(se.innerHTML=""),ve(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=c("maintenance.closeModal.title","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),n&&(n.textContent=c("maintenance.closeModal.subtitle","ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø©.")),q&&(q.textContent=c("maintenance.closeModal.confirm","Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©"))}}function Ft(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(fe=t.Modal.getOrCreateInstance(e),ie||(ie=e.querySelector("#maintenance-report-modal-content")),_||(_=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Dt),e.dataset.listenerAttached="true"),_&&_.dataset.listenerAttached!=="true"&&(_.addEventListener("click",ya),_.dataset.listenerAttached="true"),!0):!1}function Dt(){ie&&(ie.innerHTML=""),_&&(_.hidden=!0,_.disabled=!1,delete _.dataset.id)}function ve(e){if(!q)return;const t=k.mode==="edit",n=t?c("maintenance.closeModal.editSaving","â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."):c("maintenance.closeModal.saving","â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚..."),a=t?c("maintenance.closeModal.editConfirm","Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"):c("maintenance.closeModal.confirm","Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©");e?(q.disabled=!0,q.dataset.loading="true",q.textContent=n):(q.disabled=!1,q.removeAttribute("data-loading"),q.textContent=a)}function ua(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=v(t).replace(/Ù«/g,".").replace(/Ù¬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:o}=e;if(e.value=n,a!==null&&o!==null)try{e.setSelectionRange(a,o)}catch{}}}function ma(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const r=v(n).replace(/Ù«/g,".").replace(/Ù¬/g,",").replace(/[^0-9.,-]/g,"");if(!r)return{provided:!0,value:null,error:"invalid"};const i=r.includes(","),s=r.includes(".");let l=r;i&&!s?l=r.replace(",","."):i&&s&&(l=r.replace(/,/g,""));const m=Number.parseFloat(l);return!Number.isFinite(m)||m<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(m*100)/100,error:null}}function Nt(e,{mode:t="close"}={}){const n=Ct(e);if(!n){g(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(!Mt()){const l=prompt(c("maintenance.prompt.closeReport","Ø£Ø¯Ø®Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©:"));if(l===null)return;const m=l.trim();if(!m){g(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error");return}xt(e,m);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(v(String(n.repairCost))):null,o=Number.isFinite(a)?Math.round(a*100)/100:null,r=t==="edit"?"edit":"close";if(k={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:o,resolvedAt:n.resolvedAt||null,mode:r},L&&(L.value=n.resolutionReport||"",L.classList.remove("is-invalid")),E&&(o!==null?E.value=v(o.toFixed(2)):E.value="",E.classList.remove("is-invalid")),se){const l=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),m=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),u=k.equipmentDesc||m,d=k.equipmentBarcode?v(k.equipmentBarcode):m;se.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${u}</div>
          <div class="maintenance-close-modal__ticket-meta">${l}: <span>${d}</span></div>
        </div>
      </div>
    `}ve(!1);const i=r==="edit";q&&(q.textContent=i?c("maintenance.closeModal.editConfirm","Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"):c("maintenance.closeModal.confirm","Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©"));const s=document.getElementById("closeMaintenanceModal");if(s){const l=s.querySelector("#maintenance-close-modal-title"),m=s.querySelector(".maintenance-close-modal__subtitle");l&&(l.textContent=i?c("maintenance.closeModal.editTitle","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"):c("maintenance.closeModal.title","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),m&&(m.textContent=i?c("maintenance.closeModal.editSubtitle","ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆØªÙƒÙ„ÙØªÙ‡."):c("maintenance.closeModal.subtitle","ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø©."))}Ze?.show(),setTimeout(()=>{L?.focus(),L?.setSelectionRange(L.value.length,L.value.length)},150)}async function fa(e){if(e?.preventDefault(),!k.id){g(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(!L)return;const t=L.value.trim();if(!t){g(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error"),L.focus();return}E&&E.classList.remove("is-invalid");const n=E?ma(E.value,k.repairCost):{provided:!1,value:null,error:null};if(n.error){g(c("maintenance.toast.invalidRepairCost","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),"error"),E?.classList.add("is-invalid"),E?.focus();return}ve(!0),(await xt(k.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:k.mode,resolvedAt:k.resolvedAt})).success?Ze?.hide():ve(!1)}function pa(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(d=>d.status==="open").length,o=n-a,r=d=>v(String(d)),i=c("maintenance.stats.summaryTitle","Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø©"),s=c("maintenance.filters.status.open","Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),l=c("maintenance.filters.status.closed","Ù…ØºÙ„Ù‚Ø©"),m=c("maintenance.stats.totalLabel","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±"),u=(d,f,p)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${p}">
      <span class="maintenance-summary__value">${r(d)}</span>
      <span class="maintenance-summary__label">${f}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">ğŸ› ï¸</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${i}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${u(a,s,"open")}
        ${u(o,l,"closed")}
        ${u(n,m,"total")}
      </div>
    </section>
  `}function ba(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=At(n)||"open",o={open:{key:"maintenance.status.open",fallback:"Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"Ù…ÙƒØªÙ…Ù„Ø©",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"Ù…Ù„ØºØ§Ø©",className:"maintenance-status-tag--cancelled"}},r=o[a]??o.open,i=r?c(r.key,r.fallback):c("maintenance.status.open","Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),s=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():i,l=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&l.push(r.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${s}</span>`}function va(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± ØµÙŠØ§Ù†Ø©"),o=c("maintenance.empty.subtitle","Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">âœ…</div>
          <h5>${a}</h5>
          <p>${o}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const o=ba(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",i=(()=>{const z=c("maintenance.priority.high","Ù…Ø±ØªÙØ¹Ø©"),A=c("maintenance.priority.medium","Ù…ØªÙˆØ³Ø·Ø©"),he=c("maintenance.priority.low","Ù…Ù†Ø®ÙØ¶Ø©");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${z}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${he}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${A}</span>`}})(),s=[],l=c("maintenance.actions.close","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),m=c("maintenance.actions.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),u=c("maintenance.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒØ±Ø©");a.status==="open"?s.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):s.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${m}</button>`),ge()&&s.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${u}</button>`);const d=s.join(""),f=c("maintenance.table.noBarcode","Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯"),p=c("maintenance.report.none","â€”"),S=a.equipmentBarcode?v(a.equipmentBarcode):f,T=a.issue?v(a.issue):p,I=a.repairCost!=null?Number.parseFloat(v(String(a.repairCost))):null,j=a.status==="closed"&&Number.isFinite(I)?`<div class="maintenance-repair-cost">${h(c("maintenance.table.repairCost","ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­: {amount}").replace("{amount}",v(I.toFixed(2))))}</div>`:"",R=a.createdAt?v(je(a.createdAt)||ce(a.createdAt)):"â€”";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${S}</small>
          </td>
          <td class="maintenance-issue-text">${T}${j}</td>
          <td>${i}</td>
          <td>${R}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${d}
            </div>
          </td>
        </tr>
      `}).join("")}}function ga(e){if(!re||ae){g(c("maintenance.toast.loading","â³ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø©..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Nt(a);else if(n==="view")ha(a);else if(n==="delete"){if(!ge()){Ye();return}Ea(a).catch(o=>{console.error("âŒ [maintenance] deleteTicket failed",o)})}}}async function xt(e,t,n={}){const a=Ct(e);if(!a)return g(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),{success:!1};const o=(t??"").trim();if(!o)return g(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error"),{success:!1};const r=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:la(new Date)||new Date().toISOString(),i={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:o,resolved_at:r};n?.repairCostProvided&&(i.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await Jn(e,i),await be({showToastOnError:!1});const s=document.getElementById("maintenance-status-filter");return s&&s.value==="open"&&(s.value="all"),await we(),M(),g(c("maintenance.toast.ticketClosed","âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©")),{success:!0}}catch(s){if(console.error("âŒ [maintenance] closeTicket failed",s),pe(s)&&s.status===404)return await be({showToastOnError:!1}),await we(),M(),g(c("maintenance.toast.ticketAlreadyClosed","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ°Ø§ÙƒØ±ØŒ ÙˆÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹"),"info"),{success:!0};const l=pe(s)?s.message:c("maintenance.toast.updateError","âš ï¸ ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return g(l,"error"),{success:!1,error:s}}}function ha(e){const n=P().find(A=>Number(A.id)===Number(e));if(!n)return;if(n.id,!Ft()){const A=c("maintenance.report.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø©"),he=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),X=c("maintenance.report.issue","Ø§Ù„ÙˆØµÙ"),ye=c("maintenance.report.createdAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"),b=c("maintenance.report.closedAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),F=c("maintenance.report.summary","Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),$=c("maintenance.report.repairCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),Ot=c("maintenance.report.currencyLabel","Ø±ÙŠØ§Ù„"),at=Number.parseFloat(v(String(n.repairCost??""))),Ht=Number.isFinite(at)?`${v(at.toFixed(2))} ${Ot}`:oe,Vt=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),oe=c("maintenance.report.none","â€”"),Ut=[`${A}: ${n.equipmentDesc}`,`${he}: ${n.equipmentBarcode?v(n.equipmentBarcode):Vt}`,`${X}: ${n.issue?v(n.issue):oe}`,`${ye}: ${n.createdAt?v(je(n.createdAt)||ce(n.createdAt)):oe}`,`${b}: ${n.resolvedAt?v(ce(n.resolvedAt)):oe}`,`${$}: ${Ht}`,`${F}: ${n.resolutionReport?v(n.resolutionReport):oe}`].join(`
`);alert(Ut);return}const a=c("maintenance.report.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø©"),o=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),r=c("maintenance.report.issue","Ø§Ù„ÙˆØµÙ"),i=c("maintenance.report.createdAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"),s=c("maintenance.report.closedAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),l=c("maintenance.report.repairCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),m=c("maintenance.report.summary","Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),u=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),d=c("maintenance.report.none","â€”"),f=Number.parseFloat(v(String(n.repairCost??""))),p=Number.isFinite(f)?v(f.toFixed(2)):null,S=c("maintenance.report.currencyLabel","Ø±ÙŠØ§Ù„"),T=[{label:a,value:`<span class="maintenance-report-modal__value">${h(n.equipmentDesc||d)}</span>`},{label:o,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${h(v(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${h(u)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${h(v(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${h(d)}</span>`},{label:i,value:n.createdAt?`<span class="maintenance-report-modal__value">${h(v(je(n.createdAt)||ce(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${h(d)}</span>`},{label:s,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${h(v(ce(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${h(d)}</span>`},{label:l,value:p?`<span class="maintenance-report-modal__value">${h(p)} ${h(S)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${h(d)}</span>`}],I=n.resolutionReport?v(n.resolutionReport):"",j=I?`<p>${h(I).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${h(d)}</p>`,R=T.map(A=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${h(A.label)}</span>
        ${A.value}
      </div>
    `).join(""),z=`
    <div class="maintenance-report-modal__summary">
      <h6>${h(m)}</h6>
      ${j}
    </div>
  `;if(ie&&(ie.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${R}
        </div>
        ${z}
      </div>
    `),_){const A=ge()&&n.status==="closed";_.hidden=!A,_.disabled=!A,_.textContent=c("maintenance.actions.editClosed","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),A?_.dataset.id=String(n.id):delete _.dataset.id}fe?.show()}function ya(){if(!_)return;const e=Number(_.dataset.id);if(!e){fe?.hide();return}if(!ge()){fe?.hide(),Ye();return}fe?.hide(),setTimeout(()=>{Nt(e,{mode:"edit"})},220)}async function Ea(e){if(!ge()){Ye();return}if(!P().find(a=>Number(a.id)===Number(e))){g(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©ØŸ")))try{await Xn(e),await be({showToastOnError:!1}),await we(),g(c("maintenance.toast.ticketDeleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"))}catch(a){console.error("âŒ [maintenance] deleteTicket failed",a);const o=pe(a)?a.message:c("maintenance.toast.deleteError","âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");g(o,"error")}}async function Sa(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),o=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let i=ue,s=N(a?.value);if(!i&&s&&(i=$e(s)),!i&&t?.value&&kt(t.value,{showFeedback:!0})&&(i=ue,s=N(i?.barcode)),!i&&n?.value&&$t(n.value,{showFeedback:!0})&&(i=ue,s=N(i?.barcode)),!i||!s){g(c("maintenance.toast.selectEquipment","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø©"));return}const{equipment:l=[]}=J();let m=(l||[]).find(I=>N(I?.barcode)===s);if(!m&&i&&(m={id:i.id,barcode:i.barcode,desc:i.desc,name:i.desc,status:i.status||"Ù…ØªØ§Ø­",quantity:i.quantity,qty:i.quantity}),!m||m.id==null){g(c("maintenance.toast.selectedNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")),V();return}const u=Number.parseInt(m.qty??m.quantity??i?.quantity??1,10),d=Number.isFinite(u)&&u>0?u:1,f=qt(s);if(It(m.status||i?.status)==="maintenance"&&d<=1){g(c("maintenance.toast.equipmentAlreadyMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø­Ø§Ù„Ø© ØµÙŠØ§Ù†Ø©"));return}if(f>=d){g(c("maintenance.toast.noUnitsAvailable","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ØµÙŠØ§Ù†Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const S=ea({equipmentId:m.id,technicianId:null,issue:o?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Zn(S),await be({showToastOnError:!1}),await we(),g(c("maintenance.toast.ticketCreated","ğŸ› ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø¯Ø©")),V(),o&&(o.value=""),r&&(r.value="medium");const T=document.getElementById("maintenance-status-filter");T&&(T.value="all")}catch(t){console.error("âŒ [maintenance] Failed to create ticket",t);const n=pe(t)?t.message:c("maintenance.toast.submitError","âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");g(n,"error")}}function _a(e){const t=P();return e==="all"?t:t.filter(n=>n.status===e)}function M(){const e=P();tt(),pa(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),o=document.getElementById("maintenance-empty-state");if(!a)return;if(ae&&!re){const i=c("maintenance.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${i}</td></tr>`,o&&o.classList.remove("active");return}if(me&&!re){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${me}</td></tr>`,o&&o.classList.remove("active");return}const r=_a(n);va(r)}function Ta(){P(),tt(),re=Z.length>0,ae=!1,M(),be({showToastOnError:!1}),Mt()&&Rt(),Ft()&&Dt();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Sa(a).catch(o=>{console.error("âŒ [maintenance] submit handler failed",o)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{M()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",ga),n.dataset.listenerAttached="true")}P();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=$e(e.value);n?Bt(n):t&&(t.textContent=ze())}else t&&(t.textContent=ze());M(),ve(!1)});document.addEventListener(Kt.USER_UPDATED,()=>{M()});window.addEventListener("maintenance:updated",()=>{Z=Be(),M()});const He="__ART_RATIO_LAST_DASHBOARD_TAB__",D="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Le="create-tab",Pt=/^[a-z0-9\-]+$/i;function Ve(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("âš ï¸ [tabs.js] Failed to keep tab visible",t)}}function U(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!Pt.test(t)?null:t}catch(t){return console.warn("âš ï¸ [tabs.js] Failed to read stored tab",t),null}}function Ue(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!Pt.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("âš ï¸ [tabs.js] Failed to persist tab",n)}}function jt(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("âš ï¸ [tabs.js] Failed to clear stored tab",t)}}let O=null,B=null,G=!1,C=null,dt=null,Y=null,Ge=null,ee=null,Ee=null;function Aa(){return Ee||(Ee=pt(()=>import("./reports.js"),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url).then(e=>{try{typeof e.initReports=="function"&&e.initReports()}catch(t){console.error("âŒ [tabs.js] Failed to initialise reports module",t)}return e}).catch(e=>{throw console.error("âŒ [tabs.js] Failed to load reports module",e),Ee=null,e})),Ee}function wa(){console.log("ğŸš€ [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("ğŸ“Œ tabButtons:",e),console.log("ğŸ“Œ tabContents:",t);const n=(r,{skipStore:i=!1,skipRender:s=!1}={})=>{if(!r)return;const l=e.filter(u=>u?.getAttribute("data-tab")===r),m=document.getElementById(r);if(!(!l.length||!m)&&(e.forEach(u=>{const d=u?.getAttribute("data-tab")===r;u.classList.toggle("active",d),d?(u.setAttribute("aria-selected","true"),u.setAttribute("tabindex","0"),Ve(u)):(u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1"))}),t.forEach(u=>{const d=u.id===r;u.style.display=d?"block":"none",u.classList.toggle("active",d)}),O=r,Ue(He,r),typeof document<"u"&&document.dispatchEvent(new CustomEvent("dashboard:tabChanged",{detail:{tabId:r}})),i||le({dashboardTab:r}).catch(u=>{console.warn("âš ï¸ [tabs.js] Failed to store dashboard tab preference",u)}),r!=="reservations-tab"&&(B=null,C=null,jt(D),i||le({dashboardSubTab:null}).catch(u=>{console.warn("âš ï¸ [tabs.js] Failed to clear sub-tab preference",u)})),!s&&r==="customers-tab"&&(console.log("ğŸ‘¤ Rendering customers"),nn()),!s&&r==="equipment-tab"&&(console.log("ğŸ“¦ Rendering equipment"),Ke()),!s&&r==="maintenance-tab"&&(console.log("ğŸ› ï¸ Rendering maintenance"),M()),!s&&r==="technicians-tab"&&(console.log("ğŸ› ï¸ Rendering technicians"),Ln()),r==="reservations-tab")){if(console.log("ğŸ“… Rendering reservations"),s||Ie(),!C){const u=U(D);C=B||u||Le}La(),C&&(Se(C),C=null)}};Ge=n,e.forEach(r=>{r&&(r.getAttribute("type")||r.setAttribute("type","button"),r.setAttribute("role","tab"),r.hasAttribute("tabindex")||r.setAttribute("tabindex",r.classList.contains("active")?"0":"-1"),r.addEventListener("click",()=>{const i=r.getAttribute("data-tab");if(console.log("ğŸ–±ï¸ Tab clicked:",i),n(i),i==="reservations-tab"){const s=B||U(D)||Le;typeof Y=="function"?Y(s):C=s}else le({dashboardSubTab:null}).catch(s=>{console.warn("âš ï¸ [tabs.js] Failed to clear sub-tab preference",s)})}))});const a=r=>{const i=document.querySelector("[data-tab].active"),s=U(He),l=e[0]?.getAttribute("data-tab")||null,u=[r?.dashboardTab,s,O,i?.getAttribute("data-tab"),l].filter(Boolean).find(p=>document.getElementById(p))||l;u&&(!G||u!==O)&&(console.log("â­ Initial tab:",u),n(u,{skipStore:!0}));const f=[r?.dashboardSubTab,U(D)].filter(Boolean).find(p=>document.getElementById(p));f&&(O==="reservations-tab"&&typeof Y=="function"?(!G||f!==B)&&Y(f,{skipStore:!0}):C=f),G||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),G=!0)},o=typeof Ae=="function"?Ae():null;a(o||null),Qt().then(r=>a(r||null)).catch(r=>{console.warn("âš ï¸ [tabs.js] Failed to load tab preferences",r),a(null)}),dt||(dt=Wt(r=>{if(!(!G||!r))if(r.dashboardTab&&r.dashboardTab!==O&&n(r.dashboardTab,{skipStore:!0}),O==="reservations-tab"){if(r.dashboardSubTab&&r.dashboardSubTab!==B)Se(r.dashboardSubTab);else if(!r.dashboardSubTab&&B){const i=U(D);i?i!==B&&Se(i):Se(null)}}else r.dashboardSubTab&&(C=r.dashboardSubTab)}))}function La(){console.log("ğŸš€ [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("ğŸ“Œ subTabButtons:",e),console.log("ğŸ“Œ subTabContents:",t),!e.length){console.warn("âš ï¸ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(Le)?Le:n[0]:null,o=(r,{skipStore:i=!1}={})=>{if(!n.length)return;let s=r;(!s||!n.includes(s))&&(console.warn("âš ï¸ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:s,available:n}),s=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${s}"]`),m=document.getElementById(s);if(!l||!m){console.warn("âš ï¸ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:s});return}if(B===s&&l.classList.contains("active")&&m.classList.contains("active")&&m.getAttribute("aria-hidden")==="false"){m.removeAttribute("hidden"),m.style.display="block",m.setAttribute("aria-hidden","false"),B=s,Ve(l),i||(Ue(D,s),le({dashboardSubTab:s}).catch(d=>{console.warn("âš ï¸ [tabs.js] Failed to store sub-tab preference",d)}));return}e.forEach(d=>{d.classList.remove("active"),d.classList.contains("tab")&&d.classList.remove("tab-active"),d.setAttribute("aria-selected","false"),d.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),Ve(l),t.forEach(d=>{const f=d.id===s;d.classList.toggle("active",f),d.setAttribute("aria-hidden",f?"false":"true"),f?(d.removeAttribute("hidden"),d.style.display="block"):(d.setAttribute("hidden",""),d.style.display="none")}),B=s,Ue(D,s),i||le({dashboardSubTab:s}).catch(d=>{console.warn("âš ï¸ [tabs.js] Failed to store sub-tab preference",d)}),typeof document<"u"&&document.dispatchEvent(new CustomEvent("reservations:subTabChanged",{detail:{subTabId:s}})),s==="my-reservations-tab"?(console.log("ğŸ“‹ Rendering reservations list"),setTimeout(()=>{Ie()},50)):s==="calendar-tab"?(console.log("ğŸ“… Rendering calendar view"),setTimeout(()=>{qe()},100)):s==="reports-tab"&&(console.log("ğŸ“Š Rendering reports view"),Aa().then(d=>{const{renderReports:f}=d;setTimeout(()=>{try{f?.()}catch(p){console.error("âŒ [tabs.js] Failed to render reports tab",p)}},50)}).catch(d=>{console.error("âŒ [tabs.js] Unable to load reports tab",d)}))};if(Y=(r,i={})=>{r?o(r,i):(e.forEach(s=>{s.classList.remove("active"),s.classList.contains("tab")&&s.classList.remove("tab-active"),s.setAttribute("aria-selected","false"),s.setAttribute("tabindex","-1")}),t.forEach(s=>{s.classList.remove("active"),s.setAttribute("aria-hidden","true"),s.setAttribute("hidden",""),s.style.display="none"}),B=null,jt(D))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const i=r.getAttribute("data-sub-tab");console.log("ğŸ–±ï¸ Sub-tab clicked:",i),o(i)}),r.dataset.subTabListenerAttached="true")}),C)o(C,{skipStore:!0}),C=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),i=a(),s=r?.getAttribute("data-sub-tab")||i;s&&(console.log("â­ Initial sub-tab:",s),o(s,{skipStore:!0}))}bt()}function Se(e){typeof Y=="function"?Y(e,{skipStore:!0}):e&&(C=e)}function Ca(){try{if(typeof Ae=="function")return Ae()||{}}catch(e){console.warn("âš ï¸ [tabs.js] Failed to read cached preferences",e)}return{}}function Ia({attemptsLeft:e=0}={}){if(!G||typeof Ge!="function")return!1;const t=Ca(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[O,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,U(He),a].filter(Boolean).find(s=>document.getElementById(s));if(!r)return!1;const i=()=>{const s=document.querySelector(`[data-tab].active[data-tab="${r}"]`),l=document.getElementById(r);return!!(s&&l?.classList.contains("active")&&l?.style.display!=="none")};if(r==="reservations-tab"){const s=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!s.length)return!1;const l=s[0]?.getAttribute("data-sub-tab")||null,u=[B,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,U(D),l].filter(Boolean).find(S=>document.getElementById(S)),d=document.querySelector("#reservations-tab .sub-tab-button.active"),f=document.querySelector("#reservations-tab .sub-tab.active"),p=f?.id||d?.getAttribute("data-sub-tab")||null;if(u&&p===u&&i())return f&&(f.removeAttribute("hidden"),f.style.display="block",f.setAttribute("aria-hidden","false")),!0;if(u)C=u;else if(e>0)return!1}else if(i())return!0;return Ge(r,{skipStore:!0,skipRender:!0}),!0}function nt(){if(!G)return;let e=0;const t=5;ee&&(clearTimeout(ee),ee=null);const n=()=>{if(Ia({attemptsLeft:t-e})){ee=null;return}if(e>=t){ee=null;return}e+=1,ee=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",nt);document.addEventListener("language:changed",nt);document.addEventListener("theme:changed",nt);Zt();let w=null,_e=null,Te=null;function qa(){return Te||(Te=pt(()=>import("./dashboardMetrics.js"),__vite__mapDeps([7,1,2]),import.meta.url).then(e=>{try{typeof e.initDashboardMetrics=="function"&&e.initDashboardMetrics()}catch(t){console.error("âŒ Failed to initialise dashboard metrics",t)}return e}).catch(e=>{throw console.error("âŒ Failed to load dashboard metrics module",e),Te=null,e})),Te}function Ba(){const e=()=>{qa()};typeof window<"u"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>{e()},{timeout:1500}):setTimeout(e,0)}async function ut(){if(!await Jt())return;tn(),wa(),Xt(),Ke(),hn(),qe(),Ta(),await Mn(),Ba();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const o=a.target.files&&a.target.files[0];o&&(await yn(o),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",en),ka(),$a()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ut().catch(e=>{console.error("âŒ Failed to initialise app",e)})},{once:!0}):ut().catch(e=>{console.error("âŒ Failed to initialise app",e)});function ka(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[o]=a.split(":"),r=`${o.padStart(2,"0")}:00`,i=`${n}T${r}`;e.value!==i&&(e.value=i,setTimeout(()=>e.blur(),150))})})}function $a(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;w={reservationId:t,reservationIndex:n!=null?Number(n):null},zt(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),o=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,o)}function Ma(e){const t=document.getElementById(e);return!!(t?.classList.contains("active")&&t?.style.display!=="none")}function Ra(e){return new Promise(t=>{if(Ma(e)){t();return}const n=o=>{o?.detail?.tabId===e&&(document.removeEventListener("dashboard:tabChanged",n),t())};document.addEventListener("dashboard:tabChanged",n),document.querySelector(`[data-tab="${e}"]`)?.click()})}function Fa(e){const t=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`),n=document.getElementById(e);return!!(t?.classList.contains("active")&&n?.classList.contains("active")&&n?.getAttribute("aria-hidden")==="false")}function Da(e){return new Promise(t=>{if(Fa(e)){t();return}const n=o=>{o?.detail?.subTabId===e&&(document.removeEventListener("reservations:subTabChanged",n),t())};document.addEventListener("reservations:subTabChanged",n),document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`)?.click()})}async function Na(){const e=En("openReservationEditor");if(typeof e=="function")return e;const t=await Sn("openReservationEditor");if(typeof t=="function")return t;throw new Error("Reservation editor handler is unavailable")}async function zt(){if(!w)return;if(_e)return _e;const e=(async()=>{const n=J().reservations||[];let a=null;if(w.reservationId){const s=n.findIndex(l=>String(l?.id)===w.reservationId||String(l?.reservationId)===w.reservationId);s!==-1&&(a=s)}if(a===null&&typeof w.reservationIndex=="number"&&!Number.isNaN(w.reservationIndex)&&w.reservationIndex>=0&&w.reservationIndex<n.length&&(a=w.reservationIndex),a===null)return;const o="my-reservations-tab",r="reservations-tab",i=w;w=null;try{await Ra(r),await Da(o);const s=await Na();typeof s=="function"?s(a):(console.warn("âš ï¸ Pending reservation edit skipped: editor is not available"),w=i)}catch(s){console.error("âŒ Failed to open pending reservation editor",s),w=i}})();_e=e;try{await e}finally{_e=null}}document.addEventListener("reservations:changed",()=>{w&&zt()});export{We as m};
