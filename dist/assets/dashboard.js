const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reports.js","./auth.js","./auth.css","./reservationsService.js","./controller.js","./dashboardShell.js","./customers.js","./dashboardMetrics.js"])))=>i.map(i=>d[i]);
import{d as x,t as c,e as ae,n as g,b as W,A as mn,s as It,f as pn,h as v,j as Ae,k as be,o as nt,u as ge,p as Me,q as fn,r as bn,a as gn,c as vn,i as hn,l as yn}from"./auth.js";import{i as En}from"./dashboardShell.js";import{r as Sn}from"./customers.js";import{e as At,a as qn,r as Ne,b as _n,i as In,s as An,c as Tn,l as kn,d as Ln,f as wn,u as Tt,g as Cn,h as Bn,j as $n,k as Mn,m as Rn,n as Fn,o as at,E as pt,p as Nn,q as Dn,t as xn,v as Pn,w as zn,x as jn}from"./controller.js";import{i as On,b as Hn,c as Vn,g as Ge,s as Un,e as Gn,n as kt,f as Wn}from"./reservationsService.js";const Yn="modulepreload",Kn=function(e,t){return new URL(e,t).href},ft={},Lt=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){let p=function(m){return Promise.all(m.map(u=>Promise.resolve(u).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};const s=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),d=r?.nonce||r?.getAttribute("nonce");o=p(n.map(m=>{if(m=Kn(m,a),m in ft)return;ft[m]=!0;const u=m.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(a)for(let y=s.length-1;y>=0;y--){const E=s[y];if(E.href===m&&(!u||E.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${m}"]${f}`))return;const b=document.createElement("link");if(b.rel=u?"stylesheet":Yn,u||(b.as="script"),b.crossOrigin="",b.href=m,d&&b.setAttribute("nonce",d),document.head.appendChild(b),u)return new Promise((y,E)=>{b.addEventListener("load",y),b.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${m}`)))})}))}function i(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return o.then(s=>{for(const r of s||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})};let We=!1;function Qn(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.setAttribute("step","300")})}function Zn(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):(console.warn("âš ï¸ Flatpickr ØºÙŠØ± Ù…ØªØ§Ø­ - Ø³ÙŠØªÙ… ØªØ®Ø·ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"),null)}function Jn(){const e=Zn(),t={dateFormat:"Y-m-d",altInput:!0,altFormat:"Y-m-d",allowInput:!0,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"},n=[["#res-start",{}],["#res-end",{}],["#filter-start-date",{}],["#filter-end-date",{}],["#edit-res-start",{}],["#edit-res-end",{}]],a={enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,disableMobile:!0,minuteIncrement:5,altInputClass:"flatpickr-alt-input form-control"},o=["#res-start-time","#res-end-time","#edit-res-start-time","#edit-res-end-time"];e&&(n.forEach(([s,r])=>{document.querySelector(s)&&e(s,{...t,...r})}),o.forEach(s=>{document.querySelector(s)&&e(s,{...a})}));const i=document.querySelector("#res-start-time");i&&i.dispatchEvent(new Event("change",{bubbles:!0}))}function wt(){We||(Qn(),An(()=>Ne()),Tn(Cn()),On({onDraftChange:Bn,onEditChange:Tt}),kn(),Ln(),We=!0)}function Xn(){const e=document.body;e&&e.dataset.reservationsTechListener!=="true"&&(document.addEventListener("technicians:updated",()=>{const{technicians:t=[]}=x();Hn(t),wn(),Tt()}),e.dataset.reservationsTechListener="true")}async function ea(){await At();try{await qn({force:!0})}catch(e){console.warn("âš ï¸ [reservations/events] Failed to pre-load projects for reservation form",e)}Ne(),_n(),In({onAfterSubmit:$n}),We||wt(),Jn(),Xn()}const ta={limit:200};let q=null,bt=!1,gt=!1,vt=!1,ht=!1,je=null,Oe=null,He=!1,Q="";const na=[{key:"confirmed",chipClass:"reservation-chip status-confirmed"},{key:"pending",chipClass:"reservation-chip status-pending"},{key:"paid",chipClass:"reservation-chip status-paid"},{key:"unpaid",chipClass:"reservation-chip status-unpaid"},{key:"completed",chipClass:"reservation-chip status-completed"}],aa={confirmed:"Ø­Ø¬Ø² Ù…Ø¤ÙƒØ¯",pending:"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯",paid:"Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„",unpaid:"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹",completed:"Ù…Ù†ØªÙ‡ÙŠ"},ia={confirmed:"Confirmed reservation",pending:"Awaiting confirmation",paid:"Paid in full",unpaid:"Payment pending",completed:"Completed"},Ve=new Map;function U(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function it(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function ra(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function sa(e){return Ve.has(e)||Ve.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),Ve.get(e)}function oa(e,t,n=!1){if(n){const m=(ae?.()==="en"?"en":"ar")==="en"?"All day":"Ø·ÙˆØ§Ù„ Ø§Ù„ÙŠÙˆÙ…";return c("calendar.labels.allDay",m)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const o=ae?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",i=sa(o),s=i.format(a);if(!t)return s;const r=new Date(t);if(Number.isNaN(r.getTime()))return s;const d=i.format(r);return s===d?s:`${s} â€“ ${d}`}function ca({paid:e,confirmed:t,completed:n}){const a=["calendar-event"];return(n===!0||n==="true")&&a.push("calendar-event--completed"),t===!0||t==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function Ct(){const e=document.getElementById("calendar-legend");if(!e)return;const t=ae?.()==="en"?"en":"ar";e.innerHTML=na.map(({key:n,chipClass:a})=>{const o=t==="en"?ia[n]??n:aa[n]??n,i=U(c(`calendar.legend.${n}`,o));return`<span class="calendar-legend__item" role="listitem"><span class="${a} calendar-legend__chip">${i}</span></span>`}).join("")}function oe(){const{calendarEl:e}=it();if(!e)return;const t=e.querySelector(".fc-header-toolbar");if(!t)return;t.classList.add("calendar-toolbar"),t.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const n=t.querySelector(".fc-toolbar-title");n&&n.classList.add("calendar-toolbar__title"),t.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function ce({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:o}=it();if(!a||!o)return;const i=typeof t=="string"?t.trim().length>0:!!t,s=!e&&!i&&!!n,r=e||i||s;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",i),a.classList.toggle("is-empty",s),o.dataset.initialized||(o.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),o.dataset.initialized="true"),o.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),o.classList.toggle("hidden",!r),!r){o.innerHTML="",o.removeAttribute("data-status");return}let d="";e?d=c("calendar.status.loading","â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª..."):i?d=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹."):s&&(d=c("calendar.status.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©."));const p=e?"loading":i?"error":"empty";if(o.setAttribute("data-status",p),o.classList.add(`calendar-status-card--${p}`),o.innerHTML="",e){const u=document.createElement("span");u.className="loading loading-spinner loading-md text-primary",u.setAttribute("aria-hidden","true"),o.appendChild(u)}else{const u=document.createElement("span");u.className="calendar-status-card__icon",u.setAttribute("aria-hidden","true"),u.textContent=i?"âš ï¸":"ğŸ—“ï¸",o.appendChild(u)}const m=document.createElement("span");m.className="calendar-status-card__message text-center text-sm font-semibold",m.textContent=d,o.appendChild(m)}function Ue(){q&&(q.destroy(),q=null)}function la(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const o=e.paidStatus??e.paid_status??null,i=e.paid!=null?e.paid:o==="paid",{effectiveConfirmed:s}=Rn(e,t),r=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,d=e.customerName??e.customer_name??"";let p=!!e.completed;if(!p&&a){const m=new Date(a);Number.isNaN(m.getTime())||(p=m<new Date)}return{id:e.id??r??n,start:n,end:a||n,paid:i,confirmed:s,completed:p,reservationId:r??"",customerName:d,raw:e}}function Bt(e=[]){const{projects:t=[]}=x(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const o=a?.projectId??a?.project_id??null,i=o!=null&&o!==""&&n.get(String(o))||null,s=la(a,i);if(!s)return null;const r=ca({paid:s.paid,confirmed:s.confirmed,completed:s.completed});return{id:s.id,title:"",start:s.start,end:s.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:r,extendedProps:{...a,raw:a,paid:s.paid,confirmed:s.confirmed,completed:s.completed,reservationId:s.reservationId,customerName:s.customerName}}}).filter(Boolean)}function yt(){return{today:c("calendar.buttons.today","Ø§Ù„ÙŠÙˆÙ…"),month:c("calendar.buttons.month","Ø´Ù‡Ø±"),week:c("calendar.buttons.week","Ø£Ø³Ø¨ÙˆØ¹"),day:c("calendar.buttons.day","ÙŠÙˆÙ…")}}async function da(){if(He)return Ge();He=!0,Q="";try{await At({suppressError:!1,params:ta})}catch(e){console.error("âŒ [calendar] Failed to load reservations for calendar view",e),Q=Vn(e)?e.message:e instanceof Error&&e.message||""}finally{He=!1}return Ge()}function $t(e){q&&q.batchRendering(()=>{q.removeAllEvents(),q.addEventSource(e)})}function Mt(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Rt(){const e=Ge(),t=Bt(e);if(!q){De();return}q.setOption("locale",ae()),$t(t),ve(),ce({loading:!1,error:"",empty:t.length===0}),Mt(t),Ct(),oe()}function ua(){bt||(document.addEventListener("language:changed",()=>{q&&q.setOption("locale",ae()),De()}),bt=!0),gt||(document.addEventListener("reservations:changed",()=>{Rt()}),gt=!0)}function Ft(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function ve(){if(!q)return;const e=Ft();q.view?.type!==e&&q.changeView(e),q.updateSize()}function ma(){vt||typeof window>"u"||(window.addEventListener("resize",()=>{ve()}),vt=!0)}function pa(){if(ht||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{Oe&&clearTimeout(Oe),Oe=setTimeout(()=>{q&&Rt()},80)};je=new MutationObserver(e),je.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&je.observe(document.body,{attributes:!0,attributeFilter:["class"]}),ht=!0}function fa(e){const{reservationId:t,customerName:n,paid:a,confirmed:o,completed:i}=e.event.extendedProps,s=a===!0||a==="paid",r=o===!0||o==="true",d=i===!0||i==="true",p=document.createElement("div");p.className="calendar-event-wrapper";const m=r?c("calendar.badges.confirmed","Ù…Ø¤ÙƒØ¯"):c("calendar.badges.pending","ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),u=s?c("calendar.badges.paid","Ù…Ø¯ÙÙˆØ¹"):c("calendar.badges.unpaid","ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),f=c("calendar.badges.completed","Ù…Ù†ØªÙ‡ÙŠ"),b=c("calendar.labels.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),y=[`<span class="reservation-chip calendar-chip ${r?"status-confirmed":"status-pending"}">${U(m)}</span>`,`<span class="reservation-chip calendar-chip ${s?"status-paid":"status-unpaid"}">${U(u)}</span>`];d&&y.push(`<span class="reservation-chip calendar-chip status-completed">${U(f)}</span>`);const E=oa(e.event.startStr,e.event.endStr,e.event.allDay),A=U(E||""),P=U(t||"â€”"),$=U(n||b),z=A?`<span class="calendar-event-card__time">${A}</span>`:"";return p.innerHTML=`
    <article class="calendar-event-card">
      <header class="calendar-event-card__head">
        ${z}
        <span class="calendar-event-card__id">${P}</span>
      </header>
      <div class="calendar-event-card__customer">${$}</div>
      <div class="calendar-event-card__chips">${y.join("")}</div>
    </article>
  `,{domNodes:[p]}}function ba(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"));return}const n=x()||{},{reservations:a=[],customers:o=[],projects:i=[],technicians:s=[]}=n,r=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},d=[r.id,r.reservationId,r.reservation_id,r.reservationCode,r.reservation_code].map(h=>h==null?"":String(h)).filter(h=>h.length>0);let p=-1,m=null;d.length>0&&(p=a.findIndex(h=>{const j=[h?.id,h?.reservationId,h?.reservation_id,h?.reservationCode,h?.reservation_code].map(F=>F==null?"":String(F)).filter(F=>F.length>0);return j.length===0?!1:j.some(F=>d.includes(F))}),p>=0&&(m=a[p]));const u=m?{...m,...r}:r,f=u.projectId??u.project_id??null,b=f!=null&&i.find(h=>String(h.id)===String(f))||null,y=u.customerId??u.customer_id,E=o.find(h=>String(h.id)===String(y)),A=Un(),P=[...Array.isArray(A)?A:[],...Array.isArray(s)?s:[]],$=new Map;P.forEach(h=>{if(!h||h.id==null)return;const j=String(h.id),F=$.get(j)||{};$.set(j,{...F,...h})});const z=Array.from($.values());let T="";try{T=Mn(u,E,z,p>=0?p:0,b)}catch(h){console.error("âŒ [calendar] Failed to build reservation details for calendar modal",h),t.innerHTML=`<p class="text-sm text-error">${U(c("calendar.alerts.cannotShowDetails","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²"))}</p>`;return}t.innerHTML=T,t.classList.add("calendar-reservation-details"),t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(h=>{h instanceof HTMLElement&&(h.setAttribute("disabled","true"),h.setAttribute("aria-disabled","true"),h.setAttribute("tabindex","-1"))});const re=t.querySelector('[data-action="open-project"]');re&&(b?re.addEventListener("click",()=>{const h=b?.id!=null?String(b.id):"",j=h?`projects.html?project=${encodeURIComponent(h)}`:"projects.html";window.location.href=j}):re instanceof HTMLElement&&re.setAttribute("disabled","true"));const Le=document.getElementById("calendarReservationModal");Le&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(Le).show():alert(c("calendar.alerts.cannotOpenModal","Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„"))}function De(){ua(),ma(),pa();const{calendarEl:e}=it();if(!e)return;const t=ra();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");ce({error:n}),Ue();return}(async()=>{ce({loading:!0});const n=await da();if(Q){const o=c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");ce({loading:!1,error:Q||o}),Ue();return}const a=Bt(n);q?(q.setOption("locale",ae()),q.setOption("buttonText",yt()),$t(a),oe()):(q=new t.Calendar(e,{initialView:Ft(),locale:ae(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:yt(),events:a,eventContent:fa,eventClick(o){ba(o.event.extendedProps)},windowResize:ve,datesSet(){oe()}}),q.render(),oe()),ve(),Mt(a),ce({loading:!1,error:"",empty:a.length===0}),Ct(),oe(),setTimeout(()=>{ve(),oe()},120)})().catch(n=>{console.error("âŒ [calendar] renderCalendar failed",n),Q=n instanceof Error&&n.message||Q||"";const a=c("calendar.status.error","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");ce({loading:!1,error:Q||a}),Ue()})}const ga=x()||{};let te=(ga.maintenance||[]).map(Nt);function xe(){return te}function Pe(e){return te=Array.isArray(e)?e.map(Nt):[],It({maintenance:te}),ka(),te}async function va(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([i,s])=>{s!=null&&s!==""&&t.set(i,String(s))});const n=t.toString(),a=await W(`/maintenance/${n?`?${n}`:""}`),o=Array.isArray(a?.data)?a.data.map(rt):[];return Pe(o)}async function ha(e){const t=await W("/maintenance/",{method:"POST",body:e}),n=rt(t?.data??{});return Pe([n,...te.filter(a=>a.id!==n.id)]),n}async function ya(e,t){const n=await W(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=rt(n?.data??{});return Pe(te.map(o=>String(o.id)===String(e)?a:o)),a}async function Ea(e){await W(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Pe(te.filter(t=>String(t.id)!==String(e)))}function Sa({equipmentId:e,technicianId:t,issue:n,priority:a,status:o,scheduledAt:i,resolutionReport:s}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:o,notes:n??"",resolution_report:null,repair_cost:null}}function rt(e={}){return Dt({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function Nt(e={}){return Dt(e)}function Dt(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=_a(e.status_raw??e.status??"open"),o=Ia(a),i=Ta(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:Aa(e.priority??"medium"),status:o,statusRaw:a,statusLabel:i,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:qa(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function qa(e){if(e==null||e==="")return null;const t=Number.parseFloat(g(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function _a(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Ia(e){const t=xt(e);return["completed","cancelled"].includes(t)?"closed":"open"}function Aa(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Ta(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,o=>o.toUpperCase())}function xt(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©":case"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±":return"open";case"in_progress":case"in-progress":case"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„":return"in_progress";case"completed":case"Ù…ÙƒØªÙ…Ù„":case"ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­":case"closed":case"Ù…ØºÙ„Ù‚":return"completed";case"cancelled":case"Ù…Ù„ØºÙŠ":return"cancelled";default:return t.includes("progress")||t.includes("ØªÙ†ÙÙŠØ°")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("Ù…Ù†Ø¬Ø²")||t.includes("Ù…ØºÙ„Ù‚")?"completed":t.includes("cancel")||t.includes("Ù…Ù„ØºÙŠ")?"cancelled":t||"open"}}function ka(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function Se(e){return e instanceof mn}function Ye(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getFullYear()).slice(-2);return`${n}/${a}/${o}`}let ie=xe(),ne=[],he=null,le=!1,ye="",de=ie.length>0,R={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},st=null,L=null,_=null,B=null,ue=null,Ee=null,me=null,I=null;async function qe({showToastOnError:e=!0}={}){if(!le){le=!0,ye="",N();try{await va(),de=!0}catch(t){de=ie.length>0,console.error("âŒ [maintenance] Failed to load maintenance tickets",t),ye=Se(t)?t.message:c("maintenance.toast.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."),e&&v(ye,"error")}finally{le=!1,ie=xe(),N()}}}function Ke(){return c("maintenance.form.selectedInfo","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø¯Ø© Ø¨Ø¹Ø¯.")}function H(e){return g(String(e||"")).trim().toLowerCase()}function Pt(e=""){return g(String(e)).trim().toLowerCase()}function La(e={}){const t=String(e?.desc??"").trim(),n=g(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function wa(e){const t=g(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function zt(e){return g(String(e||"")).trim().toLowerCase()}function S(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ca(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function Y(){return ie=xe(),ie}function jt(e){return Y().find(n=>Number(n.id)===Number(e))||null}function Ot(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","ØµÙŠØ§Ù†Ø©"].includes(t)?"maintenance":["reserved","Ù…Ø­Ø¬ÙˆØ²"].includes(t)?"reserved":["retired","Ù…ØªÙˆÙ‚Ù","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©"].includes(t)?"retired":"available":"available"}function ot(){const{equipment:e=[]}=x(),t=c("maintenance.table.noName","Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");return ne=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),o=H(a),i=Number.parseInt(n?.qty??n?.quantity??0,10),s=Number.isFinite(i)?Math.max(i,0):1,r=n?.image||n?.imageUrl||n?.image_url||"",d=n?.status||"Ù…ØªØ§Ø­",p=n?.desc||n?.description||n?.name||t,m=La({desc:p,displayBarcode:a,barcode:o});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:o,displayBarcode:a,desc:p,status:d,statusNormalized:Ot(d),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:s,image:r,searchValue:m,searchValueNormalized:zt(m),descriptionNormalized:Pt(p)}}),ne.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),ne}function ct(){const e=new Set,t=new Map;return Y().filter(n=>n.status==="open").forEach(n=>{const a=H(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function Ht(e){const t=H(e);if(!t)return 0;const{map:n}=ct();return n.get(t)||0}function ze(e){const t=H(e);return t&&(ne.length?ne:ot()).find(a=>a.barcode===t)||null}function Ba(e){const t=ne.length?ne:ot();if(!t.length)return null;const n=zt(e);if(n){const r=t.find(d=>d.searchValueNormalized===n);if(r)return r}const{description:a,barcode:o}=wa(e);if(o){const r=H(o);if(r){const d=t.find(p=>p.barcode===r);if(d)return d}}const i=Pt(a||e);if(!i)return null;const s=t.find(r=>r.descriptionNormalized===i);return s||t.find(r=>r.descriptionNormalized.includes(i))||null}function Qe(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,i=(t||ct().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||i>=1:i>=a}function Z({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search"),i=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),o&&(o.value="")),i&&(i.textContent=Ke(),i.classList.remove("maintenance-selected-info--has-selection")),he=null}function Vt(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","Ø¨Ø§Ø±ÙƒÙˆØ¯"),a=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),o=c("maintenance.info.unitsAvailable","Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†"),i=c("maintenance.info.categoryLabel","Ø§Ù„Ù‚Ø³Ù…"),s=e.displayBarcode||e.barcode||a,r=e.barcode,d=Number.isFinite(e.quantity)?e.quantity:0,p=Ht(r),m=Math.max(d-p,0),u=e.category?`
    <div class="maintenance-selected-info__meta">${i}: <strong>${S(e.category)}</strong></div>
  `:"",f=d>0?`
    <div class="maintenance-selected-info__meta">
      ${o}: <strong>${m}</strong> / ${d}
    </div>
  `:"",b=e.image?`<img class="maintenance-selected-info__image" src="${S(e.image)}" alt="${S(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">ğŸ¥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${b}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${S(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${S(s)}</strong></div>
      ${f}
      ${u}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function lt(e,{silent:t=!1}={}){if(!e)return!1;if(Qe(e))return t||v(c("maintenance.toast.equipmentBlocked","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),o&&(o.value=e.searchValue||e.desc),Vt(e),he=e,!0}function Ut(e,{showFeedback:t=!0}={}){const n=ze(e);return n?lt(n,{silent:!t}):(t&&v(c("maintenance.toast.equipmentNotFoundBarcode","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯")),!1)}function Gt(e,{showFeedback:t=!0}={}){const n=Ba(e);return n?lt(n,{silent:!t}):(t&&v(c("maintenance.toast.equipmentNotFoundName","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„")),!1)}function dt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=ot(),{map:o}=ct();e&&(e.innerHTML=a.map(s=>`<option value="${S(s.searchValue||s.desc)}"></option>`).join(""));const i=document.getElementById("maintenance-selected-barcode");if(i&&i.value){const s=ze(i.value);!s||Qe(s,o)?(Z({keepInputs:!0,silent:!0}),s&&Qe(s,o)&&v(c("maintenance.toast.equipmentBecameBlocked","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø£ØµØ¨Ø­Øª Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§"))):lt(s,{silent:!0})}else Z({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),Ut(t.value)||Z({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const s=()=>{if(!n.value){Z({keepInputs:!0,silent:!0});return}Gt(n.value)||Z({keepInputs:!0,silent:!0})};n.addEventListener("change",s),n.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),s())}),n.dataset.listenerAttached="true"}}async function Re(){try{await Fn({showToastOnError:!1})}catch(e){console.error("âŒ [maintenance] refreshEquipmentData failed",e)}finally{at(),dt()}}function Wt(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;st=t.Modal.getOrCreateInstance(e),L||(L=e.querySelector("#maintenance-close-report")),_||(_=e.querySelector("#maintenance-close-cost")),_&&_.dataset.normalizeAttached!=="true"&&(_.addEventListener("input",a=>{$a(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),_.dataset.normalizeAttached="true"),B||(B=e.querySelector("#maintenance-close-submit")),ue||(ue=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",Ra),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Yt),e.dataset.listenerAttached="true"),!0}function Yt(){R={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},L&&(L.value="",L.classList.remove("is-invalid")),_&&(_.value="",_.classList.remove("is-invalid")),ue&&(ue.innerHTML=""),_e(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=c("maintenance.closeModal.title","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),n&&(n.textContent=c("maintenance.closeModal.subtitle","ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø©.")),B&&(B.textContent=c("maintenance.closeModal.confirm","Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©"))}}function Kt(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(Ee=t.Modal.getOrCreateInstance(e),me||(me=e.querySelector("#maintenance-report-modal-content")),I||(I=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Qt),e.dataset.listenerAttached="true"),I&&I.dataset.listenerAttached!=="true"&&(I.addEventListener("click",za),I.dataset.listenerAttached="true"),!0):!1}function Qt(){me&&(me.innerHTML=""),I&&(I.hidden=!0,I.disabled=!1,delete I.dataset.id)}function _e(e){if(!B)return;const t=R.mode==="edit",n=t?c("maintenance.closeModal.editSaving","â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."):c("maintenance.closeModal.saving","â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚..."),a=t?c("maintenance.closeModal.editConfirm","Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"):c("maintenance.closeModal.confirm","Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©");e?(B.disabled=!0,B.dataset.loading="true",B.textContent=n):(B.disabled=!1,B.removeAttribute("data-loading"),B.textContent=a)}function $a(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=g(t).replace(/Ù«/g,".").replace(/Ù¬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:o}=e;if(e.value=n,a!==null&&o!==null)try{e.setSelectionRange(a,o)}catch{}}}function Ma(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const i=g(n).replace(/Ù«/g,".").replace(/Ù¬/g,",").replace(/[^0-9.,-]/g,"");if(!i)return{provided:!0,value:null,error:"invalid"};const s=i.includes(","),r=i.includes(".");let d=i;s&&!r?d=i.replace(",","."):s&&r&&(d=i.replace(/,/g,""));const p=Number.parseFloat(d);return!Number.isFinite(p)||p<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(p*100)/100,error:null}}function Zt(e,{mode:t="close"}={}){const n=jt(e);if(!n){v(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(!Wt()){const d=prompt(c("maintenance.prompt.closeReport","Ø£Ø¯Ø®Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©:"));if(d===null)return;const p=d.trim();if(!p){v(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error");return}Jt(e,p);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(g(String(n.repairCost))):null,o=Number.isFinite(a)?Math.round(a*100)/100:null,i=t==="edit"?"edit":"close";if(R={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:o,resolvedAt:n.resolvedAt||null,mode:i},L&&(L.value=n.resolutionReport||"",L.classList.remove("is-invalid")),_&&(o!==null?_.value=g(o.toFixed(2)):_.value="",_.classList.remove("is-invalid")),ue){const d=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),p=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),m=R.equipmentDesc||p,u=R.equipmentBarcode?g(R.equipmentBarcode):p;ue.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${m}</div>
          <div class="maintenance-close-modal__ticket-meta">${d}: <span>${u}</span></div>
        </div>
      </div>
    `}_e(!1);const s=i==="edit";B&&(B.textContent=s?c("maintenance.closeModal.editConfirm","Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"):c("maintenance.closeModal.confirm","Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©"));const r=document.getElementById("closeMaintenanceModal");if(r){const d=r.querySelector("#maintenance-close-modal-title"),p=r.querySelector(".maintenance-close-modal__subtitle");d&&(d.textContent=s?c("maintenance.closeModal.editTitle","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"):c("maintenance.closeModal.title","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),p&&(p.textContent=s?c("maintenance.closeModal.editSubtitle","ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆØªÙƒÙ„ÙØªÙ‡."):c("maintenance.closeModal.subtitle","ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø©."))}st?.show(),setTimeout(()=>{L?.focus(),L?.setSelectionRange(L.value.length,L.value.length)},150)}async function Ra(e){if(e?.preventDefault(),!R.id){v(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(!L)return;const t=L.value.trim();if(!t){v(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error"),L.focus();return}_&&_.classList.remove("is-invalid");const n=_?Ma(_.value,R.repairCost):{provided:!1,value:null,error:null};if(n.error){v(c("maintenance.toast.invalidRepairCost","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),"error"),_?.classList.add("is-invalid"),_?.focus();return}_e(!0),(await Jt(R.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:R.mode,resolvedAt:R.resolvedAt})).success?st?.hide():_e(!1)}function Fa(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(u=>u.status==="open").length,o=n-a,i=u=>g(String(u)),s=c("maintenance.stats.summaryTitle","Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø©"),r=c("maintenance.filters.status.open","Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),d=c("maintenance.filters.status.closed","Ù…ØºÙ„Ù‚Ø©"),p=c("maintenance.stats.totalLabel","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±"),m=(u,f,b)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${b}">
      <span class="maintenance-summary__value">${i(u)}</span>
      <span class="maintenance-summary__label">${f}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">ğŸ› ï¸</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${s}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${m(a,r,"open")}
        ${m(o,d,"closed")}
        ${m(n,p,"total")}
      </div>
    </section>
  `}function Na(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=xt(n)||"open",o={open:{key:"maintenance.status.open",fallback:"Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"Ù…ÙƒØªÙ…Ù„Ø©",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"Ù…Ù„ØºØ§Ø©",className:"maintenance-status-tag--cancelled"}},i=o[a]??o.open,s=i?c(i.key,i.fallback):c("maintenance.status.open","Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©"),r=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():s,d=["maintenance-status-badge","maintenance-status-tag"];return i?.className&&d.push(i.className),d.push(`maintenance-status-tag--${a}`),d.push(`maintenance-status-tag--${n}`),`<span class="${d.filter(Boolean).join(" ")}">${r}</span>`}function Da(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± ØµÙŠØ§Ù†Ø©"),o=c("maintenance.empty.subtitle","Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">âœ…</div>
          <h5>${a}</h5>
          <p>${o}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const o=Na(a),i=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",s=(()=>{const z=c("maintenance.priority.high","Ù…Ø±ØªÙØ¹Ø©"),T=c("maintenance.priority.medium","Ù…ØªÙˆØ³Ø·Ø©"),ke=c("maintenance.priority.low","Ù…Ù†Ø®ÙØ¶Ø©");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${z}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${ke}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${T}</span>`}})(),r=[],d=c("maintenance.actions.close","ğŸ”§ Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),p=c("maintenance.actions.view","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),m=c("maintenance.actions.delete","ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒØ±Ø©");a.status==="open"?r.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${d}</button>`):r.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${p}</button>`),Ae()&&r.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${m}</button>`);const u=r.join(""),f=c("maintenance.table.noBarcode","Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯"),b=c("maintenance.report.none","â€”"),y=a.equipmentBarcode?g(a.equipmentBarcode):f,E=a.issue?g(a.issue):b,A=a.repairCost!=null?Number.parseFloat(g(String(a.repairCost))):null,P=a.status==="closed"&&Number.isFinite(A)?`<div class="maintenance-repair-cost">${S(c("maintenance.table.repairCost","ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­: {amount}").replace("{amount}",g(A.toFixed(2))))}</div>`:"",$=a.createdAt?g(Ye(a.createdAt)||be(a.createdAt)):"â€”";return`
        <tr class="${i}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${y}</small>
          </td>
          <td class="maintenance-issue-text">${E}${P}</td>
          <td>${s}</td>
          <td>${$}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${u}
            </div>
          </td>
        </tr>
      `}).join("")}}function xa(e){if(!de||le){v(c("maintenance.toast.loading","â³ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø©..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Zt(a);else if(n==="view")Pa(a);else if(n==="delete"){if(!Ae()){nt();return}ja(a).catch(o=>{console.error("âŒ [maintenance] deleteTicket failed",o)})}}}async function Jt(e,t,n={}){const a=jt(e);if(!a)return v(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©")),{success:!1};const o=(t??"").trim();if(!o)return v(c("maintenance.toast.reportRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),"error"),{success:!1};const i=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:Ca(new Date)||new Date().toISOString(),s={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:o,resolved_at:i};n?.repairCostProvided&&(s.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await ya(e,s),await qe({showToastOnError:!1});const r=document.getElementById("maintenance-status-filter");return r&&r.value==="open"&&(r.value="all"),await Re(),N(),v(c("maintenance.toast.ticketClosed","âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©")),{success:!0}}catch(r){if(console.error("âŒ [maintenance] closeTicket failed",r),Se(r)&&r.status===404)return await qe({showToastOnError:!1}),await Re(),N(),v(c("maintenance.toast.ticketAlreadyClosed","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ°Ø§ÙƒØ±ØŒ ÙˆÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹"),"info"),{success:!0};const d=Se(r)?r.message:c("maintenance.toast.updateError","âš ï¸ ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");return v(d,"error"),{success:!1,error:r}}}function Pa(e){const n=Y().find(T=>Number(T.id)===Number(e));if(!n)return;if(n.id,!Kt()){const T=c("maintenance.report.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø©"),ke=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),re=c("maintenance.report.issue","Ø§Ù„ÙˆØµÙ"),Le=c("maintenance.report.createdAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"),h=c("maintenance.report.closedAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),j=c("maintenance.report.summary","Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),F=c("maintenance.report.repairCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),cn=c("maintenance.report.currencyLabel","Ø±ÙŠØ§Ù„"),mt=Number.parseFloat(g(String(n.repairCost??""))),ln=Number.isFinite(mt)?`${g(mt.toFixed(2))} ${cn}`:fe,dn=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),fe=c("maintenance.report.none","â€”"),un=[`${T}: ${n.equipmentDesc}`,`${ke}: ${n.equipmentBarcode?g(n.equipmentBarcode):dn}`,`${re}: ${n.issue?g(n.issue):fe}`,`${Le}: ${n.createdAt?g(Ye(n.createdAt)||be(n.createdAt)):fe}`,`${h}: ${n.resolvedAt?g(be(n.resolvedAt)):fe}`,`${F}: ${ln}`,`${j}: ${n.resolutionReport?g(n.resolutionReport):fe}`].join(`
`);alert(un);return}const a=c("maintenance.report.equipment","Ø§Ù„Ù…Ø¹Ø¯Ø©"),o=c("maintenance.report.barcode","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"),i=c("maintenance.report.issue","Ø§Ù„ÙˆØµÙ"),s=c("maintenance.report.createdAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"),r=c("maintenance.report.closedAt","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),d=c("maintenance.report.repairCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­"),p=c("maintenance.report.summary","Ø§Ù„ØªÙ‚Ø±ÙŠØ±"),m=c("maintenance.report.notAvailable","ØºÙŠØ± Ù…ØªÙˆÙØ±"),u=c("maintenance.report.none","â€”"),f=Number.parseFloat(g(String(n.repairCost??""))),b=Number.isFinite(f)?g(f.toFixed(2)):null,y=c("maintenance.report.currencyLabel","Ø±ÙŠØ§Ù„"),E=[{label:a,value:`<span class="maintenance-report-modal__value">${S(n.equipmentDesc||u)}</span>`},{label:o,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${S(g(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${S(m)}</span>`},{label:i,value:n.issue?`<span class="maintenance-report-modal__value">${S(g(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${S(u)}</span>`},{label:s,value:n.createdAt?`<span class="maintenance-report-modal__value">${S(g(Ye(n.createdAt)||be(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${S(u)}</span>`},{label:r,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${S(g(be(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${S(u)}</span>`},{label:d,value:b?`<span class="maintenance-report-modal__value">${S(b)} ${S(y)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${S(u)}</span>`}],A=n.resolutionReport?g(n.resolutionReport):"",P=A?`<p>${S(A).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${S(u)}</p>`,$=E.map(T=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${S(T.label)}</span>
        ${T.value}
      </div>
    `).join(""),z=`
    <div class="maintenance-report-modal__summary">
      <h6>${S(p)}</h6>
      ${P}
    </div>
  `;if(me&&(me.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${$}
        </div>
        ${z}
      </div>
    `),I){const T=Ae()&&n.status==="closed";I.hidden=!T,I.disabled=!T,I.textContent=c("maintenance.actions.editClosed","âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"),T?I.dataset.id=String(n.id):delete I.dataset.id}Ee?.show()}function za(){if(!I)return;const e=Number(I.dataset.id);if(!e){Ee?.hide();return}if(!Ae()){Ee?.hide(),nt();return}Ee?.hide(),setTimeout(()=>{Zt(e,{mode:"edit"})},220)}async function ja(e){if(!Ae()){nt();return}if(!Y().find(a=>Number(a.id)===Number(e))){v(c("maintenance.toast.ticketNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©ØŸ")))try{await Ea(e),await qe({showToastOnError:!1}),await Re(),v(c("maintenance.toast.ticketDeleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"))}catch(a){console.error("âŒ [maintenance] deleteTicket failed",a);const o=Se(a)?a.message:c("maintenance.toast.deleteError","âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");v(o,"error")}}async function Oa(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),o=document.getElementById("maintenance-issue"),i=document.getElementById("maintenance-priority");let s=he,r=H(a?.value);if(!s&&r&&(s=ze(r)),!s&&t?.value&&Ut(t.value,{showFeedback:!0})&&(s=he,r=H(s?.barcode)),!s&&n?.value&&Gt(n.value,{showFeedback:!0})&&(s=he,r=H(s?.barcode)),!s||!r){v(c("maintenance.toast.selectEquipment","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø©"));return}const{equipment:d=[]}=x();let p=(d||[]).find(A=>H(A?.barcode)===r);if(!p&&s&&(p={id:s.id,barcode:s.barcode,desc:s.desc,name:s.desc,status:s.status||"Ù…ØªØ§Ø­",quantity:s.quantity,qty:s.quantity}),!p||p.id==null){v(c("maintenance.toast.selectedNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")),Z();return}const m=Number.parseInt(p.qty??p.quantity??s?.quantity??1,10),u=Number.isFinite(m)&&m>0?m:1,f=Ht(r);if(Ot(p.status||s?.status)==="maintenance"&&u<=1){v(c("maintenance.toast.equipmentAlreadyMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø­Ø§Ù„Ø© ØµÙŠØ§Ù†Ø©"));return}if(f>=u){v(c("maintenance.toast.noUnitsAvailable","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ØµÙŠØ§Ù†Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const y=Sa({equipmentId:p.id,technicianId:null,issue:o?.value.trim()||"",priority:i?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await ha(y),await qe({showToastOnError:!1}),await Re(),v(c("maintenance.toast.ticketCreated","ğŸ› ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø¯Ø©")),Z(),o&&(o.value=""),i&&(i.value="medium");const E=document.getElementById("maintenance-status-filter");E&&(E.value="all")}catch(t){console.error("âŒ [maintenance] Failed to create ticket",t);const n=Se(t)?t.message:c("maintenance.toast.submitError","âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");v(n,"error")}}function Ha(e){const t=Y();return e==="all"?t:t.filter(n=>n.status===e)}function N(){const e=Y();dt(),Fa(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),o=document.getElementById("maintenance-empty-state");if(!a)return;if(le&&!de){const s=c("maintenance.table.loading","Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${s}</td></tr>`,o&&o.classList.remove("active");return}if(ye&&!de){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${ye}</td></tr>`,o&&o.classList.remove("active");return}const i=Ha(n);Da(i)}function Va(){Y(),dt(),de=ie.length>0,le=!1,N(),qe({showToastOnError:!1}),Wt()&&Yt(),Kt()&&Qt();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Oa(a).catch(o=>{console.error("âŒ [maintenance] submit handler failed",o)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{N()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",xa),n.dataset.listenerAttached="true")}Y();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=ze(e.value);n?Vt(n):t&&(t.textContent=Ke())}else t&&(t.textContent=Ke());N(),_e(!1)});document.addEventListener(pn.USER_UPDATED,()=>{N()});window.addEventListener("maintenance:updated",()=>{ie=xe(),N()});const Ze="__ART_RATIO_LAST_DASHBOARD_TAB__",O="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Fe="create-tab",Xt=/^[a-z0-9\-]+$/i;function Je(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("âš ï¸ [tabs.js] Failed to keep tab visible",t)}}function J(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!Xt.test(t)?null:t}catch(t){return console.warn("âš ï¸ [tabs.js] Failed to read stored tab",t),null}}function Xe(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!Xt.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("âš ï¸ [tabs.js] Failed to persist tab",n)}}function en(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("âš ï¸ [tabs.js] Failed to clear stored tab",t)}}let K=null,M=null,X=!1,C=null,Et=null,ee=null,et=null,se=null,we=null;function Ua(){return we||(we=Lt(()=>import("./reports.js"),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url).then(e=>{try{typeof e.initReports=="function"&&e.initReports()}catch(t){console.error("âŒ [tabs.js] Failed to initialise reports module",t)}return e}).catch(e=>{throw console.error("âŒ [tabs.js] Failed to load reports module",e),we=null,e})),we}function Ga(){console.log("ğŸš€ [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("ğŸ“Œ tabButtons:",e),console.log("ğŸ“Œ tabContents:",t);const n=(i,{skipStore:s=!1,skipRender:r=!1}={})=>{if(!i)return;const d=e.filter(m=>m?.getAttribute("data-tab")===i),p=document.getElementById(i);if(!(!d.length||!p)&&(e.forEach(m=>{const u=m?.getAttribute("data-tab")===i;m.classList.toggle("active",u),u?(m.setAttribute("aria-selected","true"),m.setAttribute("tabindex","0"),Je(m)):(m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1"))}),t.forEach(m=>{const u=m.id===i;m.style.display=u?"block":"none",m.classList.toggle("active",u)}),K=i,Xe(Ze,i),typeof document<"u"&&document.dispatchEvent(new CustomEvent("dashboard:tabChanged",{detail:{tabId:i}})),s||ge({dashboardTab:i}).catch(m=>{console.warn("âš ï¸ [tabs.js] Failed to store dashboard tab preference",m)}),i!=="reservations-tab"&&(M=null,C=null,en(O),s||ge({dashboardSubTab:null}).catch(m=>{console.warn("âš ï¸ [tabs.js] Failed to clear sub-tab preference",m)})),!r&&i==="customers-tab"&&(console.log("ğŸ‘¤ Rendering customers"),Sn()),!r&&i==="equipment-tab"&&(console.log("ğŸ“¦ Rendering equipment"),at()),!r&&i==="maintenance-tab"&&(console.log("ğŸ› ï¸ Rendering maintenance"),N()),!r&&i==="technicians-tab"&&(console.log("ğŸ› ï¸ Rendering technicians"),Gn()),i==="reservations-tab")){if(console.log("ğŸ“… Rendering reservations"),r||Ne(),!C){const m=J(O);C=M||m||Fe}Wa(),C&&(Ce(C),C=null)}};et=n,e.forEach(i=>{i&&(i.getAttribute("type")||i.setAttribute("type","button"),i.setAttribute("role","tab"),i.hasAttribute("tabindex")||i.setAttribute("tabindex",i.classList.contains("active")?"0":"-1"),i.addEventListener("click",()=>{const s=i.getAttribute("data-tab");if(console.log("ğŸ–±ï¸ Tab clicked:",s),n(s),s==="reservations-tab"){const r=M||J(O)||Fe;typeof ee=="function"?ee(r):C=r}else ge({dashboardSubTab:null}).catch(r=>{console.warn("âš ï¸ [tabs.js] Failed to clear sub-tab preference",r)})}))});const a=i=>{const s=document.querySelector("[data-tab].active"),r=J(Ze),d=e[0]?.getAttribute("data-tab")||null,m=[i?.dashboardTab,r,K,s?.getAttribute("data-tab"),d].filter(Boolean).find(b=>document.getElementById(b))||d;m&&(!X||m!==K)&&(console.log("â­ Initial tab:",m),n(m,{skipStore:!0}));const f=[i?.dashboardSubTab,J(O)].filter(Boolean).find(b=>document.getElementById(b));f&&(K==="reservations-tab"&&typeof ee=="function"?(!X||f!==M)&&ee(f,{skipStore:!0}):C=f),X||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),X=!0)},o=typeof Me=="function"?Me():null;a(o||null),fn().then(i=>a(i||null)).catch(i=>{console.warn("âš ï¸ [tabs.js] Failed to load tab preferences",i),a(null)}),Et||(Et=bn(i=>{if(!(!X||!i))if(i.dashboardTab&&i.dashboardTab!==K&&n(i.dashboardTab,{skipStore:!0}),K==="reservations-tab"){if(i.dashboardSubTab&&i.dashboardSubTab!==M)Ce(i.dashboardSubTab);else if(!i.dashboardSubTab&&M){const s=J(O);s?s!==M&&Ce(s):Ce(null)}}else i.dashboardSubTab&&(C=i.dashboardSubTab)}))}function Wa(){console.log("ğŸš€ [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("ğŸ“Œ subTabButtons:",e),console.log("ğŸ“Œ subTabContents:",t),!e.length){console.warn("âš ï¸ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(i=>i?.getAttribute("data-sub-tab")).filter(i=>typeof i=="string"&&i.trim().length>0),a=()=>n.length?n.includes(Fe)?Fe:n[0]:null,o=(i,{skipStore:s=!1}={})=>{if(!n.length)return;let r=i;(!r||!n.includes(r))&&(console.warn("âš ï¸ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:r,available:n}),r=a());const d=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${r}"]`),p=document.getElementById(r);if(!d||!p){console.warn("âš ï¸ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:r});return}if(M===r&&d.classList.contains("active")&&p.classList.contains("active")&&p.getAttribute("aria-hidden")==="false"){p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false"),M=r,Je(d),s||(Xe(O,r),ge({dashboardSubTab:r}).catch(u=>{console.warn("âš ï¸ [tabs.js] Failed to store sub-tab preference",u)}));return}e.forEach(u=>{u.classList.remove("active"),u.classList.contains("tab")&&u.classList.remove("tab-active"),u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1")}),d.classList.add("active"),d.classList.contains("tab")&&d.classList.add("tab-active"),d.setAttribute("aria-selected","true"),d.setAttribute("tabindex","0"),Je(d),t.forEach(u=>{const f=u.id===r;u.classList.toggle("active",f),u.setAttribute("aria-hidden",f?"false":"true"),f?(u.removeAttribute("hidden"),u.style.display="block"):(u.setAttribute("hidden",""),u.style.display="none")}),M=r,Xe(O,r),s||ge({dashboardSubTab:r}).catch(u=>{console.warn("âš ï¸ [tabs.js] Failed to store sub-tab preference",u)}),typeof document<"u"&&document.dispatchEvent(new CustomEvent("reservations:subTabChanged",{detail:{subTabId:r}})),r==="my-reservations-tab"?(console.log("ğŸ“‹ Rendering reservations list"),setTimeout(()=>{Ne()},50)):r==="calendar-tab"?(console.log("ğŸ“… Rendering calendar view"),setTimeout(()=>{De()},100)):r==="reports-tab"&&(console.log("ğŸ“Š Rendering reports view"),Ua().then(u=>{const{renderReports:f}=u;setTimeout(()=>{try{f?.()}catch(b){console.error("âŒ [tabs.js] Failed to render reports tab",b)}},50)}).catch(u=>{console.error("âŒ [tabs.js] Unable to load reports tab",u)}))};if(ee=(i,s={})=>{i?o(i,s):(e.forEach(r=>{r.classList.remove("active"),r.classList.contains("tab")&&r.classList.remove("tab-active"),r.setAttribute("aria-selected","false"),r.setAttribute("tabindex","-1")}),t.forEach(r=>{r.classList.remove("active"),r.setAttribute("aria-hidden","true"),r.setAttribute("hidden",""),r.style.display="none"}),M=null,en(O))},e.forEach(i=>{i.dataset.subTabListenerAttached||(i.addEventListener("click",()=>{const s=i.getAttribute("data-sub-tab");console.log("ğŸ–±ï¸ Sub-tab clicked:",s),o(s)}),i.dataset.subTabListenerAttached="true")}),C)o(C,{skipStore:!0}),C=null;else{const i=document.querySelector("#reservations-tab .sub-tab-button.active"),s=a(),r=i?.getAttribute("data-sub-tab")||s;r&&(console.log("â­ Initial sub-tab:",r),o(r,{skipStore:!0}))}wt()}function Ce(e){typeof ee=="function"?ee(e,{skipStore:!0}):e&&(C=e)}function Ya(){try{if(typeof Me=="function")return Me()||{}}catch(e){console.warn("âš ï¸ [tabs.js] Failed to read cached preferences",e)}return{}}function Ka({attemptsLeft:e=0}={}){if(!X||typeof et!="function")return!1;const t=Ya(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,i=[K,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,J(Ze),a].filter(Boolean).find(r=>document.getElementById(r));if(!i)return!1;const s=()=>{const r=document.querySelector(`[data-tab].active[data-tab="${i}"]`),d=document.getElementById(i);return!!(r&&d?.classList.contains("active")&&d?.style.display!=="none")};if(i==="reservations-tab"){const r=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!r.length)return!1;const d=r[0]?.getAttribute("data-sub-tab")||null,m=[M,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,J(O),d].filter(Boolean).find(y=>document.getElementById(y)),u=document.querySelector("#reservations-tab .sub-tab-button.active"),f=document.querySelector("#reservations-tab .sub-tab.active"),b=f?.id||u?.getAttribute("data-sub-tab")||null;if(m&&b===m&&s())return f&&(f.removeAttribute("hidden"),f.style.display="block",f.setAttribute("aria-hidden","false")),!0;if(m)C=m;else if(e>0)return!1}else if(s())return!0;return et(i,{skipStore:!0,skipRender:!0}),!0}function ut(){if(!X)return;let e=0;const t=5;se&&(clearTimeout(se),se=null);const n=()=>{if(Ka({attemptsLeft:t-e})){se=null;return}if(e>=t){se=null;return}e+=1,se=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",ut);document.addEventListener("language:changed",ut);document.addEventListener("theme:changed",ut);let w=[],D=[],Ie=null,G=!1,St=!1;const l={};function Qa(){l.form=document.getElementById("equipment-package-form"),l.hiddenId=document.getElementById("equipment-package-id"),l.nameInput=document.getElementById("equipment-package-name"),l.codeInput=document.getElementById("equipment-package-code"),l.priceInput=document.getElementById("equipment-package-price"),l.descriptionInput=document.getElementById("equipment-package-description"),l.openSelector=document.getElementById("equipment-package-open-selector"),l.selectionWrapper=document.getElementById("equipment-package-selection-active"),l.selectionCounter=document.getElementById("equipment-package-selection-counter"),l.applySelection=document.getElementById("equipment-package-apply-selection"),l.cancelSelection=document.getElementById("equipment-package-cancel-selection"),l.itemsTableBody=document.querySelector("#equipment-package-items-table tbody"),l.itemsEmptyMessage=document.getElementById("equipment-package-items-empty"),l.resetButton=document.getElementById("equipment-package-reset"),l.submitButton=document.getElementById("equipment-package-submit"),l.tableBody=document.getElementById("equipment-packages-table-body"),l.emptyRow=document.getElementById("equipment-packages-empty-row"),l.countBadge=document.getElementById("equipment-packages-count"),l.applySelection&&(l.applySelection.style.display="none")}function tn(){const{equipment:e=[]}=x()||{};return Array.isArray(e)?e:[]}function nn(){const e=new Map;return tn().forEach(t=>{const n=t?.id??t?.equipment_id??t?.equipmentId??null;n!=null&&e.set(String(n),t)}),e}function Za(){const e=new Map;return tn().forEach(t=>{const n=kt(t?.barcode);n&&!e.has(n)&&e.set(n,t)}),e}function pe(e,{persist:t=!1}={}){w=Array.isArray(e)?e.map(an):[],ti(),t&&(It({packages:w}),document.dispatchEvent(new CustomEvent("packages:changed",{detail:{packages:w}})))}function an(e={}){const t=Ja(e.items??e.equipment_ids??e.equipmentIds??[]);return{id:e.id!=null?String(e.id):"",package_code:e.package_code??e.code??e.slug??"",slug:e.slug??null,name:e.name??e.title??e.label??"",description:e.description??"",price:Xa(e.price??e.total_price??e.package_price??0),is_active:ei(e.is_active??e.active??!0),items:t,created_at:e.created_at??null,updated_at:e.updated_at??null}}function Ja(e){return Array.isArray(e)||(e=[]),e.map(t=>{if(t==null)return null;if(typeof t=="number"||typeof t=="string"){const n=String(t).trim();return n?{equipment_id:n,quantity:1,unit_price:null}:null}if(typeof t=="object"){const n=t.equipment_id??t.equipmentId??t.id??t.item_id??t.itemId??null;if(n==null)return null;const a=Number.isFinite(Number(t.quantity??t.qty))?Number(t.quantity??t.qty):1,o=Number.isFinite(Number(t.unit_price??t.price))?Number(t.unit_price??t.price):null;return{equipment_id:String(n),quantity:a>0?a:1,unit_price:o}}return null}).filter(Boolean)}function Xa(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function ei(e){if(e===!0||e===!1)return e;if(e==null)return!0;const t=String(e).trim().toLowerCase();return!(t==="0"||t==="false"||t==="no")}function Te(){if(!l.itemsTableBody||!l.itemsEmptyMessage)return;if(D.length===0){l.itemsTableBody.innerHTML="",l.itemsEmptyMessage.hidden=!1;return}const e=nn(),t=D.map((n,a)=>{const o=e.get(String(n.equipment_id)),i=o?.desc||o?.name||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),s=o?.barcode?g(String(o.barcode)):"",r=g(String(n.quantity??1)),d=s?`${i} â€” ${s}`:i;return`
      <tr data-package-item-index="${a}">
        <td>${d}</td>
        <td>${r}</td>
        <td>
          <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-item" data-index="${a}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `});l.itemsTableBody.innerHTML=t.join(""),l.itemsEmptyMessage.hidden=!0}function ti(){if(!l.tableBody||!l.emptyRow)return;if(!w.length){l.tableBody.innerHTML="",l.tableBody.appendChild(l.emptyRow),l.emptyRow.hidden=!1,l.countBadge&&(l.countBadge.textContent="0");return}const e=nn(),t=w.map(n=>{const a=Wn({...n,items:n.items}),o=a.map(r=>{const d=e.get(String(r.equipmentId??r.equipment_id)),p=d?.desc||d?.name||r.desc||c("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),m=g(String(r.qty??r.quantity??1)),u=r.barcode||d?.barcode,f=u?` (${g(String(u))})`:"";return`<li>${p}${f} Ã— ${m}</li>`}),i=a.reduce((r,d)=>r+(Number(d.qty??d.quantity??1)||0),0),s=`${g(n.price.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`;return`
      <tr data-package-id="${n.id}">
        <td>${n.name||"â€”"}</td>
        <td>${n.package_code||"â€”"}</td>
        <td>${s}</td>
        <td>
          <details>
            <summary>${g(String(i||0))}</summary>
            <ul class="equipment-package-items-summary">${o.join("")}</ul>
          </details>
        </td>
        <td>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-action="edit-package" data-id="${n.id}">âœï¸</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete-package" data-id="${n.id}">ğŸ—‘ï¸</button>
          </div>
        </td>
      </tr>
    `});l.tableBody.innerHTML=t.join(""),l.emptyRow.hidden=!0,l.countBadge&&(l.countBadge.textContent=g(String(w.length)))}function rn(){Ie=null,D=[],l.hiddenId&&(l.hiddenId.value=""),l.nameInput&&(l.nameInput.value=""),l.codeInput&&(l.codeInput.value=""),l.priceInput&&(l.priceInput.value=""),l.descriptionInput&&(l.descriptionInput.value=""),l.submitButton&&(l.submitButton.textContent=c("equipment.packages.form.actions.save","ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø²Ù…Ø©")),Te(),V(!1)}function ni(e){Ie=e.id||null,D=e.items.map(t=>({...t})),l.hiddenId&&(l.hiddenId.value=Ie||""),l.nameInput&&(l.nameInput.value=e.name||""),l.codeInput&&(l.codeInput.value=e.package_code||""),l.priceInput&&(l.priceInput.value=e.price!=null?String(e.price):""),l.descriptionInput&&(l.descriptionInput.value=e.description||""),l.submitButton&&(l.submitButton.textContent=c("equipment.packages.form.actions.update","ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø²Ù…Ø©")),Te(),V(!1)}function V(e=G){G=e,l.selectionWrapper&&(G?l.selectionWrapper.hidden=!1:l.selectionWrapper.hidden=!0),l.openSelector&&(l.openSelector.disabled=G),l.cancelSelection&&(l.cancelSelection.disabled=!G),sn()}function sn(){if(l.selectionCounter){if(!G){l.selectionCounter.textContent=c("equipment.packages.selection.counter","Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.");return}l.selectionCounter.textContent=c("equipment.packages.selection.autoMode","Ø£ÙŠ Ù…Ø¹Ø¯Ø© ØªØ®ØªØ§Ø±Ù‡Ø§ Ø³ØªÙØ¶Ø§Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø²Ù…Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ù„Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.")}}function ai(e){const t=e?.detail||{},n=!!t.active,a=t.selection||t.previous||{},o=a?.mode||a?.source||"";if(o!=="package-manager"&&o!=="equipment-packages"){!n&&G&&(V(!1),tt());return}if(n){V(!0);return}V(!1),tt()}function ii(e){const t=e?.detail;if(!t)return;const n=t.selection||{},a=n?.mode||n?.source||"";if(a!=="package-manager"&&a!=="equipment-packages")return;const o=Array.isArray(t.barcodes)?t.barcodes:[],i=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,s=o.length?o:t.barcode?[t.barcode]:[];if(!s.length)return;const r=Za(),d=[],p=new Set;s.forEach(b=>{const y=kt(b);y&&!p.has(y)&&(p.add(y),d.push(y))});const m=Math.min(d.length,i);let u=0;const f=[];for(let b=0;b<m;b+=1){const y=d[b],E=r.get(y);if(!E)continue;const A=E?.id??E?.equipment_id??E?.equipmentId??null;if(A==null)continue;const P=E?.desc||E?.name||y,$=D.find(z=>z.equipment_id===String(A));$?$.quantity+=1:D.push({equipment_id:String(A),quantity:1,unit_price:Number.isFinite(Number(E?.price))?Number(E.price):null}),u+=1,f.push(P)}if(u>0){Te(),sn();const b=u===1?c("equipment.packages.selection.itemAddedSingle","âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© {name} Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø²Ù…Ø©"):c("equipment.packages.selection.itemAddedMulti","âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø²Ù…Ø©"),y=u===1?b.replace("{name}",f[0]||""):b.replace("{count}",g(String(u)));v(y)}else v(c("equipment.packages.selection.noMatch","âš ï¸ ØªØ¹Ø°Ø± Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¨Ø§Ù„Ø­Ø²Ù…ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),4e3)}function ri(){V(!1),Dn("package-cancel"),tt()}function tt(){l.form&&(l.form.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{l.nameInput?.focus()},200))}function qt(){const e=l.priceInput;if(!e)return;const t=e.value;if(t==null)return;const n=t.replace(/[\u066B\u066C\u060C,]/gu,".");let o=g(n).replace(/[^0-9.]/gu,"");const i=o.indexOf(".");if(i!==-1){const s=o.slice(0,i+1),r=o.slice(i+1).replace(/\./g,"");o=`${s}${r}`}if(o!==t&&(e.value=o,typeof e.setSelectionRange=="function")){const s=o.length;try{e.setSelectionRange(s,s)}catch{}}}function si(){const e=l.nameInput?.value.trim(),t=l.codeInput?.value.trim(),n=l.descriptionInput?.value.trim()??"",a=l.priceInput?.value??"",o=Number.parseFloat(g(a));if(!e)return v(c("equipment.packages.validation.nameRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø©")),null;if(!t)return v(c("equipment.packages.validation.codeRequired","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø­Ø²Ù…Ø©")),null;if(!D.length)return v(c("equipment.packages.validation.itemsRequired","âš ï¸ Ø£Ø¶Ù Ø¹Ù†ØµØ±Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø²Ù…Ø©")),null;const i=D.map(s=>({equipment_id:s.equipment_id,quantity:Number.isFinite(Number(s.quantity))?Number(s.quantity):1,unit_price:s.unit_price!=null&&Number.isFinite(Number(s.unit_price))?Number(s.unit_price):null}));return{package_code:t,name:e,description:n,price:Number.isFinite(o)?o:0,is_active:!0,items:i}}async function oi(e){if(e.preventDefault(),!l.form)return;const t=si();if(t)try{let n;Ie?(n=await W(`/packages/?id=${encodeURIComponent(Ie)}`,{method:"PATCH",body:t}),v(c("equipment.packages.toast.updated","âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­"))):(n=await W("/packages/",{method:"POST",body:t}),v(c("equipment.packages.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")));const a=an(n?.data??n),o=w.findIndex(i=>i.id===a.id);o>=0?w.splice(o,1,a):w=[a,...w],pe(w,{persist:!0}),rn()}catch(n){console.error("[equipmentPackagesManager] handlePackageSubmit error",n);const a=n?.message||c("equipment.packages.toast.saveFailed","âŒ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø­Ø²Ù…Ø©");v(a,4e3)}}function ci(e){const t=e.target.closest('[data-action="remove-item"]');if(!t)return;const n=Number(t.dataset.index);Number.isNaN(n)||(D=D.filter((a,o)=>o!==n),Te())}async function li(e){const t=e.target.closest('[data-action="edit-package"]');if(t){const a=t.dataset.id;if(!a)return;const o=w.find(i=>i.id===a);if(!o)return;ni(o);return}const n=e.target.closest('[data-action="delete-package"]');if(n){const a=n.dataset.id;if(!a||!window.confirm(c("equipment.packages.confirm.delete","Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø­Ø²Ù…Ø©ØŸ")))return;try{await W(`/packages/?id=${encodeURIComponent(a)}`,{method:"DELETE"}),w=w.filter(i=>i.id!==a),pe(w,{persist:!0}),v(c("equipment.packages.toast.deleted","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­"))}catch(i){console.error("[equipmentPackagesManager] delete package error",i),v(c("equipment.packages.toast.deleteFailed","âŒ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø²Ù…Ø©"),4e3)}}}async function di(){try{const e=await W("/packages/?all=1"),t=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];pe(t,{persist:!0})}catch(e){console.warn("[equipmentPackagesManager] Failed to fetch packages from API, falling back to cache",e);const{packages:t=[]}=x()||{};pe(t,{persist:!1})}}function ui(){const{packages:e=[]}=x()||{};Array.isArray(e)&&e.length?pe(e,{persist:!1}):pe([],{persist:!1}),Te(),V(!1)}function mi(){if(G){V(!0);return}V(!0),Nn({mode:"package-manager",source:"equipment-packages",activatedAt:Date.now()});const e=document.querySelector('[data-tab="equipment-tab"]');e&&e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus();const t=document.getElementById("equipment-list");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},200)})}function pi(){if(l.form){if(l.form.addEventListener("submit",oi),l.itemsTableBody?.addEventListener("click",ci),l.resetButton?.addEventListener("click",()=>{rn()}),l.tableBody?.addEventListener("click",li),l.openSelector?.addEventListener("click",e=>{e.preventDefault(),mi()}),l.cancelSelection?.addEventListener("click",e=>{e.preventDefault(),ri()}),l.priceInput&&!l.priceInput.dataset.normalizedAttached){const e=()=>qt();l.priceInput.addEventListener("input",e),l.priceInput.addEventListener("blur",e),l.priceInput.dataset.normalizedAttached="true",qt()}St||(document.addEventListener(pt.change,ai),document.addEventListener(pt.requestAdd,ii),St=!0)}}function fi(){typeof document>"u"||(Qa(),l.form&&(ui(),pi(),di()))}gn();let k=null,Be=null,$e=null;function bi(){return $e||($e=Lt(()=>import("./dashboardMetrics.js"),__vite__mapDeps([7,1,2]),import.meta.url).then(e=>{try{typeof e.initDashboardMetrics=="function"&&e.initDashboardMetrics()}catch(t){console.error("âŒ Failed to initialise dashboard metrics",t)}return e}).catch(e=>{throw console.error("âŒ Failed to load dashboard metrics module",e),$e=null,e})),$e}function gi(){const e=()=>{bi()};typeof window<"u"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>{e()},{timeout:1500}):setTimeout(e,0)}async function _t(){if(!await vn())return;En(),Ga(),hn(),at(),fi(),xn(),De(),Va(),await ea(),gi();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const o=a.target.files&&a.target.files[0];o&&(await Pn(o),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",yn),vi(),hi()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{_t().catch(e=>{console.error("âŒ Failed to initialise app",e)})},{once:!0}):_t().catch(e=>{console.error("âŒ Failed to initialise app",e)});function vi(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[o]=a.split(":"),i=`${o.padStart(2,"0")}:00`,s=`${n}T${i}`;e.value!==s&&(e.value=s,setTimeout(()=>e.blur(),150))})})}function hi(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;k={reservationId:t,reservationIndex:n!=null?Number(n):null},on(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),o=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,o)}function yi(e){const t=document.getElementById(e);return!!(t?.classList.contains("active")&&t?.style.display!=="none")}function Ei(e){return new Promise(t=>{if(yi(e)){t();return}const n=o=>{o?.detail?.tabId===e&&(document.removeEventListener("dashboard:tabChanged",n),t())};document.addEventListener("dashboard:tabChanged",n),document.querySelector(`[data-tab="${e}"]`)?.click()})}function Si(e){const t=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`),n=document.getElementById(e);return!!(t?.classList.contains("active")&&n?.classList.contains("active")&&n?.getAttribute("aria-hidden")==="false")}function qi(e){return new Promise(t=>{if(Si(e)){t();return}const n=o=>{o?.detail?.subTabId===e&&(document.removeEventListener("reservations:subTabChanged",n),t())};document.addEventListener("reservations:subTabChanged",n),document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`)?.click()})}async function _i(){const e=zn("openReservationEditor");if(typeof e=="function")return e;const t=await jn("openReservationEditor");if(typeof t=="function")return t;throw new Error("Reservation editor handler is unavailable")}async function on(){if(!k)return;if(Be)return Be;const e=(async()=>{const n=x().reservations||[];let a=null;if(k.reservationId){const r=n.findIndex(d=>String(d?.id)===k.reservationId||String(d?.reservationId)===k.reservationId);r!==-1&&(a=r)}if(a===null&&typeof k.reservationIndex=="number"&&!Number.isNaN(k.reservationIndex)&&k.reservationIndex>=0&&k.reservationIndex<n.length&&(a=k.reservationIndex),a===null)return;const o="my-reservations-tab",i="reservations-tab",s=k;k=null;try{await Ei(i),await qi(o);const r=await _i();typeof r=="function"?r(a):(console.warn("âš ï¸ Pending reservation edit skipped: editor is not available"),k=s)}catch(r){console.error("âŒ Failed to open pending reservation editor",r),k=s}})();Be=e;try{await e}finally{Be=null}}document.addEventListener("reservations:changed",()=>{k&&on()});export{rt as m};
