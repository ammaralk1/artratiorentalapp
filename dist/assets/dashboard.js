import{t as c,d as Q,e as J,n as y,f as ce,b as z,A as cn,s as ea,h as ta,j as w,k as kt,o as ln,u as xe,p as He,q as na,r as aa,a as ra,c as sa,i as oa,l as ia}from"./auth.js";import"./common.js";import{r as dn,l as ca}from"./controller.js";/* empty css   */import{r as la}from"./customers.js";import{e as da,i as ua,g as mt,s as ma,c as pa,r as un,m as fa,a as mn,b as ba,d as ga,D as ha,f as ya,h as It,j as va,k as Sa,u as Ta}from"./projectsService.js";import{s as pn}from"./events.js";const Ea={limit:200};let x=null,Ot=!1,Ht=!1,Ut=!1,Vt=!1,tt=null,nt=null,at=!1,re="";function fn(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function wa(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function ge({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:o}=fn();if(!a||!o)return;const r=typeof t=="string"?t.trim().length>0:!!t,s=!e&&!r&&!!n,i=e||r||s;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",s),!i){o.textContent="";return}let u="";e?u=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):r?u=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):s&&(u=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة.")),o.textContent=u}function rt(){x&&(x.destroy(),x=null)}function Aa(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const o=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:o==="paid",{effectiveConfirmed:s}=un(e,t),i=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,u=e.customerName??e.customer_name??"";let l=!!e.completed;if(!l&&a){const d=new Date(a);Number.isNaN(d.getTime())||(l=d<new Date)}return{id:e.id??i??n,start:n,end:a||n,paid:r,confirmed:s,completed:l,reservationId:i??"",customerName:u,raw:e}}function bn(e=[]){const{projects:t=[]}=J(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const o=a?.projectId??a?.project_id??null,r=o!=null&&o!==""&&n.get(String(o))||null,s=Aa(a,r);if(!s)return null;const i=$a({...a,paid:s.paid,confirmed:s.confirmed,completed:s.completed});return{id:s.id,title:"",start:s.start,end:s.end,backgroundColor:i.background,borderColor:i.border,textColor:i.text,display:"auto",extendedProps:{...a,paid:s.paid,confirmed:s.confirmed,completed:s.completed,reservationId:s.reservationId,customerName:s.customerName}}}).filter(Boolean)}function zt(){return{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")}}async function La(){if(at)return mt();at=!0,re="";try{await da({suppressError:!1,params:Ea})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),re=ua(e)?e.message:e instanceof Error&&e.message||""}finally{at=!1}return mt()}function gn(e){x&&x.batchRendering(()=>{x.removeAllEvents(),x.addEventSource(e)})}function hn(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function yn(){const e=mt(),t=bn(e);if(!x){Xe();return}x.setOption("locale",Q()),gn(t),ke(),ge({loading:!1,error:"",empty:t.length===0}),hn(t)}function xa(){Ot||(document.addEventListener("language:changed",()=>{x&&x.setOption("locale",Q()),Xe()}),Ot=!0),Ht||(document.addEventListener("reservations:changed",()=>{yn()}),Ht=!0)}function vn(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function ke(){if(!x)return;const e=vn();x.view?.type!==e&&x.changeView(e),x.updateSize()}function ka(){Ut||typeof window>"u"||(window.addEventListener("resize",()=>{ke()}),Ut=!0)}function Ia(){if(Vt||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{nt&&clearTimeout(nt),nt=setTimeout(()=>{x&&yn()},80)};tt=new MutationObserver(e),tt.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&tt.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Vt=!0}function _a(){return typeof document>"u"?!1:document.documentElement?.classList.contains("dark-mode")||document.body?.classList.contains("dark-mode")}function $a(){return _a()?{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(30, 58, 138, 0.7))",border:"rgba(59, 130, 246, 0.5)",text:"#e2e8f0"}:{background:"linear-gradient(135deg, #4361ee, #3a0ca3)",border:"#240c62",text:"#ffffff"}}function Ca(e){const{reservationId:t,customerName:n,paid:a,confirmed:o,completed:r}=e.event.extendedProps,s=a===!0||a==="paid",i=o===!0||o==="true",u=document.createElement("div");u.className="fc-reservation-event";const l=i?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),d=s?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),m=c("calendar.badges.completed","منتهي"),p=c("calendar.labels.unknownCustomer","غير معروف");return u.innerHTML=`
    <div class="fc-reservation-id">${t}</div>
    <div class="fc-reservation-customer">${n||p}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${i?"bg-success":"bg-warning text-dark"}">${l}</span>
      <span class="badge ${s?"bg-primary":"bg-danger"}">${d}</span>
      ${r?`<span class="badge bg-secondary">${m}</span>`:""}
    </div>
  `,{domNodes:[u]}}function Ba(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",o=!!e.completed,r=n?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),s=a?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),i=c("calendar.badges.completed","منتهي"),u=Q(),l=e.items||[],d=ma()||[],m=new Map(d.map(h=>[String(h.id),h])),p=(e.technicians||[]).map(h=>m.get(String(h))).filter(Boolean),f=pa(e.start,e.end),A=l.reduce((h,q)=>h+(q.qty||1)*(q.price||0),0)*f,S=(h={})=>{const q=[h.dailyWage,h.daily_rate,h.dailyRate,h.wage,h.rate];for(const Ae of q){if(Ae==null)continue;const qe=parseFloat(y(String(Ae)));if(Number.isFinite(qe))return qe}return 0},L=p.reduce((h,q)=>h+S(q),0)*f,H=A+L,P=(()=>{const h=parseFloat(e.discount)||0;return h?e.discountType==="amount"?h:H*(h/100):0})(),ee=Math.max(0,H-P),te=e.applyTax?ee*.15:0,U=e.cost??Math.round(ee+te),M=c("calendar.labels.currencySuffix","ريال"),W=l.length?l.map((h,q)=>{const Ae=h.image||h.imageUrl||h.img||"",qe=y(String(h.barcode||"-")),Zn=y(String(h.qty||1)),Qn=y(String(h.price||0)),Jn=Ae?`<img src="${Ae}" alt="${h.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${y(String(q+1))}</td>
            <td>${qe}</td>
            <td>${h.desc||"-"}</td>
            <td>${Zn}</td>
            <td>${Qn} ${M}</td>
            <td>${Jn}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${c("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,X=[`<div>${c("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",A.toFixed(2))}</div>`,`<div>${c("calendar.summary.crewTotal","😎 إجمالي الفريق: <strong>{value} ريال</strong>").replace("{value}",L.toFixed(2))}</div>`,`<div>${c("calendar.summary.duration","⏱️ عدد الأيام: <strong>{value}</strong>").replace("{value}",y(String(f)))}</div>`];if(P>0){const h=u==="en"?"%":"٪",q=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${h}`:`${P.toFixed(2)} ${M}`;X.push(`<div>${c("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",q)}</div>`)}e.applyTax&&te>0&&X.push(`<div>${c("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",te.toFixed(2))}</div>`),X.push(`<div>${c("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",U.toFixed(2))}</div>`);const et=y(String(e.reservationId??e.id??"")),Yn=e.start?y(ce(e.start)):"-",Gn=e.end?y(ce(e.end)):"-",Wn=e.notes?y(e.notes):c("calendar.labels.noNotes","لا توجد ملاحظات"),Xn=e.customerName||c("calendar.labels.unknownCustomer","غير معروف"),Kn=[{icon:"🆔",label:c("calendar.labels.reservationId","رقم الحجز"),value:et},{icon:"👤",label:c("calendar.labels.customer","العميل"),value:Xn},{icon:"🗓️",label:c("calendar.labels.start","بداية الحجز"),value:Yn},{icon:"🗓️",label:c("calendar.labels.end","نهاية الحجز"),value:Gn},{icon:"📝",label:c("calendar.labels.notes","الملاحظات"),value:Wn}];t.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${r}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${s}</span>
      ${o?`<span class="badge bg-secondary">${i}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${Kn.map(h=>`
        <div class="calendar-info-row">
          <span class="label">${h.icon} ${h.label}</span>
          <span class="value">${h.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${c("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${p.length?`<ul class="list-unstyled calendar-reservation-technicians">${p.map(h=>{const q=h.role?` — ${h.role}`:"";return`<li><strong>${h.name}</strong>${q}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${c("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${c("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${c("calendar.table.headers.barcode","الباركود")}</th>
            <th>${c("calendar.table.headers.description","الوصف")}</th>
            <th>${c("calendar.table.headers.quantity","الكمية")}</th>
            <th>${c("calendar.table.headers.price","السعر")}</th>
            <th>${c("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${W}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${X.join("")}
    </div>
  `;const jt=document.getElementById("calendarReservationModal");jt&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(jt).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function Xe(){xa(),ka(),Ia();const{calendarEl:e}=fn();if(!e)return;const t=wa();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");ge({error:n}),rt();return}(async()=>{ge({loading:!0});const n=await La();if(re){const o=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");ge({loading:!1,error:re||o}),rt();return}const a=bn(n);x?(x.setOption("locale",Q()),x.setOption("buttonText",zt()),gn(a)):(x=new t.Calendar(e,{initialView:vn(),locale:Q(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:zt(),events:a,eventContent:Ca,eventClick(o){Ba(o.event.extendedProps)},windowResize:ke}),x.render()),ke(),hn(a),ge({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{ke()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),re=n instanceof Error&&n.message||re||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");ge({loading:!1,error:re||a}),rt()})}let pt=null,Pe=null,je=null;const b={range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null};let Yt=!1,Gt=!1,ye=null;const T={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let Oe=!1,Ue="";const D={icon:null,title:null,subtitle:null};let Wt=!1;const st=new Map;let ot=null,it=null,ct=null,ve=null;const E={trend:null,status:null,payment:null},ne={filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[]},ft={code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0};let Xt=!1,Kt=!1,Zt=!1,Sn=[],lt=[],dt=[],Qt=!1;function g(e,t,n=t){const a=Q()==="en"?n??t:t;return c(e,a)}function Jt(){ut(),I(),setTimeout(()=>{ut(),I()},0),setTimeout(()=>{ut(),I()},60)}function he(){b.range==="custom"&&I()}function ut(){pt=null,Pe=null,je=null}function _t(){return(Q()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function Tn(){const e=Q();if(e!==pt||!Pe||!je){pt=e;const t=_t();Pe=new Intl.NumberFormat(t,{maximumFractionDigits:0}),je=new Intl.NumberFormat(t,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Pe,currencyFormatter:je}}function Ma(e){const t=_t();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function bt(e){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"";const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${o}`}function $t(e){if(st.has(e))return st.get(e);const t=document.querySelector(`script[src="${e}"]`),n=new Promise((a,o)=>{const r=()=>{t&&(t.dataset.loaded="true"),a()},s=u=>o(u);if(t){if(t.dataset.loaded==="true"){a();return}t.addEventListener("load",r,{once:!0}),t.addEventListener("error",s,{once:!0});return}const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>{i.dataset.loaded="true",a()},i.onerror=u=>o(u),document.head.appendChild(i)});return st.set(e,n),n}function Ct(){return window.ApexCharts?Promise.resolve(window.ApexCharts):(ot||(ot=$t("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),ot)}function qa(){return window.html2pdf?Promise.resolve(window.html2pdf):(it||(it=$t("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),it)}function Da(){return window.XLSX?Promise.resolve(window.XLSX):(ct||(ct=$t("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),ct)}function Ve(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function En(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function wn(e={}){const t=y(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function An(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",o=e?.confirmed===!0||ze(a)==="confirmed"||ze(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:o}}function Ra(){if(typeof J!="function")return!1;let e;try{e=J()}catch(i){return console.warn("⚠️ [reports] Failed to access cached data",i),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:o=[],projects:r=[]}=e;return t.length||n.length||a.length||o.length||r.length?(T.reservations=Array.isArray(t)?t.map(fa):[],T.customers=Array.isArray(n)?n.map(En):[],T.equipment=Array.isArray(a)?a.map(wn):[],T.technicians=Array.isArray(o)?o.map(mn):[],T.projects=Array.isArray(r)?r.map(An):[],T.projectsMap=new Map(T.projects.map(i=>[i.id,i])),ve=new Map((T.technicians||[]).map(i=>[String(i.id),i])),!0):!1}const Fa=1440*60*1e3;function Na(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const o=a.getTime()-n.getTime();return o<=0?1:Math.max(1,Math.ceil(o/Fa))}function Pa(e){return e?(ve||(ve=new Map((T.technicians||[]).map(t=>[String(t.id),t]))),ve.get(String(e))||null):null}function ja(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null)continue;const a=Number.parseFloat(y(String(n)));if(Number.isFinite(a))return a}return 0}function Me(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,discountAmount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;const t=Na(e.start,e.end),a=(e.items||[]).reduce((M,W)=>{const X=Number(W?.qty)||Number(W?.quantity)||1,et=Number(W?.price)||Number(W?.unit_price)||0;return M+X*et},0)*t,r=(e.technicians||[]).reduce((M,W)=>{const X=Pa(W);return M+ja(X)},0)*t,s=a+r,i=Number(e.discount)||0;let l=(e.discountType||e.discount_type||"percent")==="amount"?i:s*(i/100);(!Number.isFinite(l)||l<0)&&(l=0),l>s&&(l=s);const d=Math.max(0,s-l),m=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1";let p=m?d*.15:0;(!Number.isFinite(p)||p<0)&&(p=0);const f=Number(e.cost),v=d+p;let A=Math.max(0,Math.round(v));if(Number.isFinite(f)&&f>0&&(A=f,m)){const M=A-d;Number.isFinite(M)&&M>=0&&(p=M)}const S=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,B=S!=null?Number.parseFloat(y(String(S).replace("%","").trim())):NaN,L=e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null;let H=L!=null?L===!0||L===1||L==="1"||String(L).toLowerCase()==="true":Number.isFinite(B)&&B>0,P=H&&Number.isFinite(B)?Number(B):0;m&&P<=0&&(P=ha,H=!0);const ee=P>0?Math.max(0,A*(P/100)):0,te=Math.max(0,A-p-ee),U={rentalDays:t,equipmentTotal:a,crewTotal:r,discountAmount:l,taxableAmount:d,taxAmount:p,finalTotal:A,companySharePercent:P,companyShareAmount:ee,netProfit:te};return e.__financials=U,U}function Ln(e){return e?.projectId&&T.projectsMap.get(String(e.projectId))||null}function fe(e){const t=Ln(e),n=un(e,t),a=ze(n.projectStatus);let o=ze(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(o=a),(!o||o==="cancelled")&&(o=n.effectiveConfirmed?"confirmed":"pending"),(ga(e)||a==="completed")&&(o="completed");const r=n.effectiveConfirmed||o==="confirmed"||o==="completed";r&&o!=="completed"&&(o="confirmed");const s=Ga(e);return{statusValue:o,confirmed:r,paid:s}}async function xn({silent:e=!1}={}){if(!Oe){Oe=!0,Ue="",e||I();try{const[t,n,a,o,r]=await Promise.all([z("/reservations/?limit=500"),z("/customers/?limit=500"),z("/equipment/?limit=500"),z("/technicians/?limit=500"),z("/projects/?limit=500")]);T.reservations=Array.isArray(t?.data)?t.data.map(s=>ba(s)):[],T.customers=Array.isArray(n?.data)?n.data.map(En):[],T.equipment=Array.isArray(a?.data)?a.data.map(wn):[],T.technicians=Array.isArray(o?.data)?o.data.map(mn):[],T.projects=Array.isArray(r?.data)?r.data.map(An):[],T.projectsMap=new Map(T.projects.map(s=>[s.id,s])),ve=new Map((T.technicians||[]).map(s=>[String(s.id),s]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),Ue=t instanceof cn?t.message:c("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),T.reservations=[],T.customers=[],T.equipment=[],T.technicians=[],T.projects=[],T.projectsMap=new Map,ve=null}finally{Oe=!1,I()}}}function Le(){xn({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function gt({active:e,icon:t,title:n,subtitle:a}){const o=document.getElementById("reports-empty-state");if(!o)return;const r=o.querySelector(".reports-empty-icon"),s=o.querySelector("h4"),i=o.querySelector("p");D.icon===null&&r&&(D.icon=r.textContent),D.title===null&&s&&(D.title=s.textContent),D.subtitle===null&&i&&(D.subtitle=i.textContent),o.classList.toggle("active",!!e),o.classList.toggle("hidden",!e),!(!r||!s||!i)&&(e?(r.textContent=t!==void 0?t:D.icon??r.textContent,s.textContent=n!==void 0?n:D.title??s.textContent,i.textContent=a!==void 0?a:D.subtitle??i.textContent):(r.textContent=D.icon??r.textContent,s.textContent=D.title??s.textContent,i.textContent=D.subtitle??i.textContent))}function Oa(){if(Yt)return;Yt=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),o=document.getElementById("reports-start"),r=document.getElementById("reports-end"),s=document.getElementById("reports-refresh"),i=document.getElementById("reports-custom-range"),u=document.getElementById("reports-search");if(!e)return;e.value=b.range,Ra()&&I(),e.addEventListener("change",()=>{b.range=e.value,ht(i,b.range==="custom"),b.range!=="custom"&&(b.start=null,b.end=null),I()}),t?.addEventListener("change",()=>{b.status=t.value,I()}),n?.addEventListener("change",()=>{b.payment=n.value,I()}),a?.addEventListener("change",()=>{b.share=a.value,I()}),u?.addEventListener("input",()=>{const d=u.value||"";ye&&clearTimeout(ye),ye=setTimeout(()=>{b.search=d,I()},220)}),o?.addEventListener("change",()=>{b.start=o.value||null,he()}),r?.addEventListener("change",()=>{b.end=r.value||null,he()}),s?.addEventListener("click",()=>{b.range==="custom"&&(b.start=o?.value||null,b.end=r?.value||null),I()}),Ha(o,r),ht(i,!1),Gt||(document.addEventListener("language:changed",Jt),document.addEventListener("language:translationsReady",Jt),Gt=!0),Wt||(document.addEventListener("reservations:changed",Le),document.addEventListener("customers:changed",Le),document.addEventListener("equipment:changed",Le),document.addEventListener("projects:changed",Le),document.addEventListener("technicians:updated",Le),Wt=!0),sr(),or(),ur(),Qt||(document.addEventListener("theme:changed",()=>{setTimeout(()=>I(),0)}),Qt=!0),xn()}function Ke(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),o=document.getElementById("reports-search"),r=document.getElementById("reports-start"),s=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");e&&e.value!==b.range&&(e.value=b.range),t&&t.value!==b.status&&(t.value=b.status),n&&n.value!==b.payment&&(n.value=b.payment),a&&a.value!==b.share&&(a.value=b.share),o&&o.value!==b.search&&(o.value=b.search||""),r&&r.value!==(b.start||"")&&(r.value=b.start||""),s&&s.value!==(b.end||"")&&(s.value=b.end||""),ht(i,b.range==="custom")}function I(){if(Ke(),Oe){gt({active:!0,icon:"⏳",title:c("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:c("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(Ue){gt({active:!0,icon:"⚠️",title:Ue,subtitle:c("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=T,o=Ua(e,b,t,n,a),r=Wa(o),s=Xa(o),i=Ka(o),u=Za(o),l=Qa(o,t),d=Ja(o,n);Sr(r),mr(s),pr(i),fr(u),br(l),gr(d);const m=er(o,t,a);yt(),Tr(o.length===0),ne.filtered=o,ne.metrics=r,ne.trend=s,ne.statusBreakdown=i,ne.paymentBreakdown=u,ne.tableRows=m}function Ha(e,t){if(!window.flatpickr)return;const n=window.flatpickr?.l10ns?.ar?window.flatpickr.l10ns.ar:null,a=s=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...s};return n&&(i.locale=n),i};let o=null,r=null;e&&(o=window.flatpickr(e,a({onChange(s,i){b.start=i||null,r&&(s?.length?r.set("minDate",s[0]):r.set("minDate",null),he())},onValueUpdate(s,i){b.start=i||null,he()}}))),t&&(r=window.flatpickr(t,a({onChange(s,i){b.end=i||null,o&&(s?.length?o.set("maxDate",s[0]):o.set("maxDate",null),he())},onValueUpdate(s,i){b.end=i||null,he()}}))),o&&t?.value&&(o.setDate(e.value,!1),o.set("maxDate",r?.selectedDates?.[0]||t.value)),r&&e?.value&&(r.setDate(t.value,!1),r.set("minDate",o?.selectedDates?.[0]||e.value))}function ht(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function kn(e){return y(String(e||"")).toLowerCase().trim()}function Ua(e,t,n,a,o){const{startDate:r,endDate:s}=za(t),i=kn(t.search),u=!!i,l=new Map((n||[]).map(p=>[String(p.id),p])),d=new Map((a||[]).map(p=>[Ye(p?.barcode),p])),m=new Map((o||[]).map(p=>[String(p.id),p]));return(e||[]).filter(p=>{const f=p?.start?new Date(p.start):null;if(!f||Number.isNaN(f.getTime())||r&&f<r||s&&f>s)return!1;const{statusValue:v,confirmed:A,paid:S}=fe(p);if(t.status==="confirmed"&&!(v==="confirmed"||v==="completed"||A)||t.status==="pending"&&v!=="pending"||t.status==="completed"&&v!=="completed"||t.payment==="paid"&&!S||t.payment==="unpaid"&&S)return!1;if(t.share&&t.share!=="all"){const L=Me(p).companySharePercent>0;if(t.share==="with"&&!L||t.share==="without"&&L)return!1}return!(u&&!Va(p,i,l,d,m))})}function Va(e,t,n,a,o){const r=[],s=e?.reservationId||e?.id;s&&r.push(s),e?.notes&&r.push(e.notes);const{statusValue:i}=fe(e);i&&r.push(i);const u=e?.paymentStatus||e?.payment_status;u&&r.push(u),e?.paid!=null&&r.push(e.paid?"paid":"unpaid");const l=n.get(String(e?.customerId));l&&r.push(l.customerName,l.company_name||l.companyName,l.contact_person||"");const d=Ln(e);return d&&r.push(d.title,d.code,d.status),r.push(In(e)),(e?.items||[]).forEach(p=>{p?.desc&&r.push(p.desc),p?.barcode&&r.push(p.barcode);const f=a.get(Ye(p?.barcode));f&&r.push(f.desc,f.description,f.name)}),(e?.technicians||[]).forEach(p=>{const f=o.get(String(p));f&&r.push(f.name,f.role,f.department)}),kn(r.filter(Boolean).join(" ")).includes(t)}function za({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const s=t?new Date(`${t}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:en(s)?s:null,endDate:en(i)?i:null}}let o=new Date(a),r=null;switch(e){case"last30":{r=new Date(a),r.setDate(r.getDate()-29);break}case"thisWeek":{const s=new Date(a),u=(s.getDay()-6+7)%7;s.setDate(s.getDate()-u),s.setHours(0,0,0,0);const l=new Date(s);l.setDate(s.getDate()+6),l.setHours(23,59,59,999),r=s,o.setTime(l.getTime());break}case"thisMonth":{r=new Date(a.getFullYear(),a.getMonth(),1);const s=new Date(a.getFullYear(),a.getMonth()+1,0);o.setTime(s.setHours(23,59,59,999));break}case"thisQuarter":{const s=Math.floor(a.getMonth()/3);r=new Date(a.getFullYear(),s*3,1);const i=new Date(a.getFullYear(),(s+1)*3,0);o.setTime(i.setHours(23,59,59,999));break}case"thisYear":{r=new Date(a.getFullYear(),0,1);const s=new Date(a.getFullYear(),12,0);o.setTime(s.setHours(23,59,59,999));break}case"all":default:r=null,o=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:o}}function en(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const Ya=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),tn=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function ze(e=""){const t=String(e).toLowerCase().trim();return t?Ya.get(t)||t:""}function Ga(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&tn.has(a))return tn.get(a)}return e?.paid===!0||e?.paid==="true"}function Wa(e){const t=e.length;let n=0,a=0,o=0,r=0,s=0,i=0,u=0;e.forEach(d=>{const{statusValue:m,confirmed:p,paid:f}=fe(d);m==="completed"&&(a+=1),p&&(n+=1),f&&(o+=1);const v=Me(d);r+=v.finalTotal,s+=v.companyShareAmount,i+=v.taxAmount,u+=v.netProfit});const l=t?r/t:0;return{total:t,confirmed:n,completed:a,paidCount:o,revenue:r,average:l,companyShareTotal:s,taxTotal:i,netProfit:u}}function Xa(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const o=new Date(t.getFullYear(),t.getMonth()-a,1),r=o.getFullYear(),s=o.getMonth(),i=e.filter(A=>{const S=A?.start?new Date(A.start):null;return S&&S.getFullYear()===r&&S.getMonth()===s}),u=i.length;let l=0,d=0,m=0;i.forEach(A=>{const S=Me(A);l+=S.finalTotal,d+=S.netProfit,m+=S.companyShareAmount});const p=Ma(o),f=new Date(o.getFullYear(),o.getMonth(),1),v=new Date(o.getFullYear(),o.getMonth()+1,0);n.push({label:p,count:u,revenue:l,netProfit:d,companyShare:m,periodStart:f,periodEnd:v,startInput:bt(f),endInput:bt(v)})}return n}function Ka(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(s=>{const{statusValue:i,confirmed:u}=fe(s);i==="completed"?t.completed+=1:i==="confirmed"||u?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,o=t.pending,r=t.completed;return[{label:g("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:g("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:g("reservations.reports.status.completedLabel","منتهية","Completed"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-completed",filterKey:"completed"}]}function Za(e){const t=e.length||1,n=e.filter(o=>fe(o).paid).length,a=e.length-n;return[{label:g("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:g("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function Qa(e,t){const n=new Map,a=new Map((t||[]).map(o=>[String(o.id),o]));return e.forEach(o=>{const r=String(o?.customerId??"unknown"),s=n.get(r)||{count:0,revenue:0},i=Me(o);s.count+=1,s.revenue+=i.finalTotal,n.set(r,s)}),Array.from(n.entries()).map(([o,r])=>({name:a.get(o)?.customerName||g("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:r.count,revenue:r.revenue})).sort((o,r)=>r.revenue-o.revenue).slice(0,5)}function Ja(e,t){const n=new Map,a=new Map((t||[]).map(o=>[Ye(o?.barcode),o]));return e.forEach(o=>{(o?.items||[]).forEach(r=>{const s=Ye(r?.barcode),i=s||(r?.desc??"unknown"),u=r?.desc||a.get(s)?.desc||a.get(s)?.description||g("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),l=Number(r?.qty)||1,d=l*(Number(r?.price)||0),m=n.get(i)||{name:u,count:0,revenue:0};m.name=u,m.count+=l,m.revenue+=d,n.set(i,m)})}),Array.from(n.values()).sort((o,r)=>r.count-o.count).slice(0,5)}function er(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${g("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const o=new Map((t||[]).map(s=>[String(s.id),s]));new Map((n||[]).map(s=>[String(s.id),s]));const r=[...e].sort((s,i)=>new Date(i.start||0)-new Date(s.start||0)).slice(0,20).map(s=>{const i=hr(s,o),u={Reservation:i.code.text,Customer:i.customer.text,Date:i.date.text,Status:i.status.text,Payment:i.payment.text,Total:i.total.text,"Company Share":i.share.text,"Net Profit":i.net.text};return{formatted:i,exportRow:u}});return a.innerHTML=r.map(({formatted:s})=>`
      <tr data-drilldown="reservation" data-search="${Mt(s.code.text)}">
        <td data-report-column="code">${s.code.html}</td>
        <td data-report-column="customer">${s.customer.html}</td>
        <td data-report-column="date">${s.date.html}</td>
        <td data-report-column="status">${s.status.html}</td>
        <td data-report-column="payment">${s.payment.html}</td>
        <td data-report-column="total">${s.total.html}</td>
        <td data-report-column="share">${s.share.html}</td>
        <td data-report-column="net">${s.net.html}</td>
      </tr>
    `).join(""),r.map(({exportRow:s})=>s)}function tr(e){const t=Sn?.[e];t&&(b.range="custom",b.start=t.startInput||null,b.end=t.endInput||null,Ke(),I())}function nr(e){e&&(b.status=b.status===e?"all":e,Ke(),I())}function ar(e){e&&(b.payment=b.payment===e?"all":e,Ke(),I())}function rr(e){ye&&(clearTimeout(ye),ye=null),b.search=e||"";const t=document.getElementById("reports-search");t&&t.value!==b.search&&(t.value=b.search),I()}function sr(){if(Kt)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(t=>{const n=t.dataset.columnToggle;n&&(t.checked=ft[n]!==!1,t.addEventListener("change",()=>{ft[n]=t.checked,yt()}))}),Kt=!0,yt())}function yt(){Object.entries(ft).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{t?n.classList.remove("hidden"):n.classList.add("hidden")})})}function or(){if(Xt)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(t=>{t.addEventListener("click",async()=>{const{export:n=""}=t.dataset;if(n){t.disabled=!0;try{await ir(n)}catch(a){console.error("⚠️ [reports] export failed",a)}finally{t.disabled=!1}}})}),Xt=!0)}async function ir(e){const t=ne.tableRows||[];if(!t.length){console.warn("[reports] No reservation data to export");return}switch(e){case"pdf":await dr();break;case"excel":await lr(t);break;case"csv":default:vt(t);break}}function Bt(e){return`reservations-report-${bt(new Date).replace(/-/g,"")}.${e}`}function cr(e,t,n){const a=new Blob([e],{type:n}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(o),4e3)}function vt(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(o=>{const r=t.map(s=>`"${String(o[s]??"").replace(/"/g,'""')}"`);n.push(r.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;cr(a,Bt("csv"),"text/csv;charset=utf-8;")}async function lr(e){try{const t=await Da();if(!t){vt(e);return}const n=t.utils.json_to_sheet(e),a=t.utils.book_new();t.utils.book_append_sheet(a,n,"Reservations"),t.writeFile(a,Bt("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),vt(e)}}async function dr(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await qa();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=Bt("pdf");await t().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}function ur(){if(Zt)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=o=>{const r=o.target?.closest("[data-drilldown]");if(!r)return;const s=r.dataset.search||"";rr(s)};e?.addEventListener("click",a),t?.addEventListener("click",a),n?.addEventListener("click",a),Zt=!0}async function mr(e){const t=document.getElementById("reports-volume-chart");if(t){if(Sn=Array.isArray(e)?e:[],!e||e.length===0){E.trend&&(E.trend.destroy(),E.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const n=await Ct();if(!n){t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const a=e.map(l=>l.label),o=e.map(l=>Math.round(l.count||0)),r=e.map(l=>Math.round(l.revenue||0)),s=e.map(l=>Math.round(l.netProfit||0)),i=[{name:g("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:o},{name:g("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),type:"line",data:r},{name:g("reservations.reports.chart.volume.series.net","صافي الربح (ر.س)","Net profit (SAR)"),type:"line",data:s,yAxisIndex:1}],u={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(l,d,m)=>{m?.dataPointIndex!=null&&tr(m.dataPointIndex)}}},theme:{mode:Ve()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:["solid","gradient","gradient"],gradient:{shadeIntensity:.6,opacityFrom:.65,opacityTo:.1}},xaxis:{categories:a,labels:{style:{colors:Ve()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:g("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:l=>k(l)},title:{text:g("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:g("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:l=>j(l)},title:{text:g("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(l,{seriesIndex:d})=>d===0?k(l):j(l)}}};E.trend?(E.trend.updateOptions({...u},!0,!0),E.trend.updateSeries(i,!0)):(t.innerHTML="",E.trend=new n(t,{...u,series:i}),E.trend.render())}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function pr(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(t){if(lt=Array.isArray(e)?e:[],!e||e.length===0){E.status&&(E.status.destroy(),E.status=null),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Ct();if(!a){Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const o=e.map(i=>Math.max(0,i.value||0)),r=e.map(i=>i.label),s={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},events:{dataPointSelection:(i,u,l)=>{if(l?.dataPointIndex!=null){const d=lt[l.dataPointIndex];d?.filterKey&&nr(d.filterKey)}}}},theme:{mode:Ve()},labels:r,series:o,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:g("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>k(o.reduce((i,u)=>i+u,0))}}}}},tooltip:{y:{formatter:(i,u)=>{const l=lt?.[u?.seriesIndex||0],d=l?`${k(l.percent)}%`:`${k(i)}%`;return`${k(l?l.rawCount??l.value??0:i)} / ${d}`}}}};E.status?(E.status.updateOptions({...s},!0,!0),E.status.updateSeries(o,!0)):(t.innerHTML="",E.status=new a(t,{...s,series:o}),E.status.render()),Z(n,e)}catch(a){console.error("⚠️ [reports] Failed to render status chart",a),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function fr(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(t){if(dt=Array.isArray(e)?e:[],!e||e.length===0){E.payment&&(E.payment.destroy(),E.payment=null),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Ct();if(!a){Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const o=e.map(i=>Math.max(0,i.value||0)),r=e.map(i=>i.label),s={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},events:{dataPointSelection:(i,u,l)=>{if(l?.dataPointIndex!=null){const d=dt[l.dataPointIndex];d?.filterKey&&ar(d.filterKey)}}}},theme:{mode:Ve()},labels:r,series:o,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},tooltip:{y:{formatter:(i,u)=>{const l=dt?.[u?.seriesIndex||0],d=l?`${k(l.percent)}%`:`${k(i)}%`;return`${k(l?l.rawCount??l.value??0:i)} / ${d}`}}}};E.payment?(E.payment.updateOptions({...s},!0,!0),E.payment.updateSeries(o,!0)):(t.innerHTML="",E.payment=new a(t,{...s,series:o}),E.payment.render()),Z(n,e)}catch(a){console.error("⚠️ [reports] Failed to render payment chart",a),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}function Z(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}n.innerHTML=t.map(a=>{const o=Math.min(Math.max(a.percent??0,0),100),r=g("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",k(a.rawCount??a.value??0)),s=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${F(a.label)}</span>
            <span class="reports-progress-value">${k(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${s}" style="width: ${o}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}function br(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${g("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${Mt(n.name)}">
        <td>${F(n.name)}</td>
        <td>${k(n.count)}</td>
        <td>${j(n.revenue)}</td>
      </tr>
    `).join("")}}function gr(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${g("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${Mt(n.name)}">
        <td>${F(n.name)}</td>
        <td>${k(n.count)}</td>
        <td>${j(n.revenue)}</td>
      </tr>
    `).join("")}}function hr(e,t,n){const a=e?.reservationId||e?.id||"—",o=y(String(a)),s=t.get(String(e?.customerId))?.customerName||g("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),i=vr(e?.start),u=yr(e),l=In(e),d=Me(e),m=j(d.finalTotal),p=d.companySharePercent>0?`${k(d.companySharePercent)}% (${j(d.companyShareAmount)})`:g("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),f=j(d.netProfit),v=F(s),A=s;return{code:{html:F(o),text:o},customer:{html:v,text:A},date:{html:F(i),text:i},status:{html:F(u),text:u},payment:{html:F(l),text:l},total:{html:F(m),text:m},share:{html:F(p),text:p},net:{html:F(f),text:f}}}function In(e){const{paid:t}=fe(e);return t?g("reservations.reports.payment.paidLabel","مدفوعة","Paid"):g("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function yr(e){const{statusValue:t}=fe(e);return t==="completed"?g("reservations.list.status.completed","📁 منتهي","Completed"):t==="confirmed"?g("reservations.list.status.confirmed","✅ مؤكد","Confirmed"):t==="pending"?g("reservations.list.status.pending","⏳ غير مؤكد","Pending"):F(t)}function vr(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=_t(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return y(a.format(t))}function Sr(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-kpi-confirmed"),s=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),u=document.getElementById("reports-kpi-paid-meta"),l=e.total||0,d=e.revenue||0,m=e.confirmed||0,p=e.paidCount||0,f=e.average||0,v=e.companyShareTotal||0,A=e.netProfit||0,S=l?Math.round(m/l*100):0,B=l?Math.round(p/l*100):0;if(t&&(t.textContent=k(l)),n){const L=g("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",k(e.completed||0));n.textContent=L}if(a&&(a.textContent=j(d)),o){const L=g("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");o.textContent=L.replace("{net}",j(A)).replace("{share}",j(v)).replace("{average}",j(f))}if(r&&(r.textContent=`${S}%`),s){const L=g("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",k(m));s.textContent=L}if(i&&(i.textContent=`${B}%`),u){const L=g("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",k(p));u.textContent=L}}function Tr(e){gt({active:!!e})}function F(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Mt(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function k(e){const{numberFormatter:t}=Tn(),n=t.format(Math.round(e||0));return y(n)}function j(e){const{currencyFormatter:t}=Tn(),n=t.format(Math.max(0,Math.round(e||0)));return y(n)}function Ye(e){return(e||"").toString().trim()}const Er=J()||{};let ue=(Er.maintenance||[]).map(_n);function Ze(){return ue}function Qe(e){return ue=Array.isArray(e)?e.map(_n):[],ea({maintenance:ue}),Br(),ue}async function wr(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,s])=>{s!=null&&s!==""&&t.set(r,String(s))});const n=t.toString(),a=await z(`/maintenance/${n?`?${n}`:""}`),o=Array.isArray(a?.data)?a.data.map(qt):[];return Qe(o)}async function Ar(e){const t=await z("/maintenance/",{method:"POST",body:e}),n=qt(t?.data??{});return Qe([n,...ue.filter(a=>a.id!==n.id)]),n}async function Lr(e,t){const n=await z(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=qt(n?.data??{});return Qe(ue.map(o=>String(o.id)===String(e)?a:o)),a}async function xr(e){await z(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Qe(ue.filter(t=>String(t.id)!==String(e)))}function kr({equipmentId:e,technicianId:t,issue:n,priority:a,status:o,scheduledAt:r,resolutionReport:s}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:o,notes:n??"",resolution_report:null}}function qt(e={}){return $n({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function _n(e={}){return $n(e)}function $n(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Ir(e.status_raw??e.status??"open"),o=_r(a),r=Cr(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:$r(e.priority??"medium"),status:o,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Ir(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function _r(e){const t=Cn(e);return["completed","cancelled"].includes(t)?"closed":"open"}function $r(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Cr(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,o=>o.toUpperCase())}function Cn(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function Br(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function $e(e){return e instanceof cn}let pe=Ze(),me=[],Ie=null,Se=!1,_e="",Te=pe.length>0,le={id:null,equipmentDesc:"",equipmentBarcode:""},Dt=null,C=null,V=null,Ee=null,Bn=null,we=null;async function Ce({showToastOnError:e=!0}={}){if(!Se){Se=!0,_e="",O();try{await wr(),Te=!0}catch(t){Te=pe.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),_e=$e(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&w(_e,"error")}finally{Se=!1,pe=Ze(),O()}}}function St(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function K(e){return y(String(e||"")).trim().toLowerCase()}function nn(e=""){return y(String(e)).trim().toLowerCase()}function $(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Mr(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function G(){return pe=Ze(),pe}function Mn(e){return G().find(n=>Number(n.id)===Number(e))||null}function Rt(){const{equipment:e=[]}=J(),t=c("maintenance.table.noName","بدون اسم");return me=(e||[]).map(n=>({barcode:K(n?.barcode),desc:n?.desc||n?.description||n?.name||t,status:n?.status||"متاح",price:Number(n?.price)||0,category:n?.category||""})),me.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),me}function qn(){return new Set(G().filter(e=>e.status==="open").map(e=>K(e.equipmentBarcode)))}function Je(e){const t=K(e);return t&&(me.length?me:Rt()).find(a=>a.barcode===t)||null}function qr(e){const t=nn(e);return t&&(me.length?me:Rt()).find(a=>nn(a.desc).includes(t))||null}function Tt(e){if(!e)return!0;const t=qn();return e.status==="صيانة"||t.has(e.barcode)}function se({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),o&&(o.value="")),r&&(r.textContent=St()),Ie=null}function Dn(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر");t.innerHTML=`
    <strong>${e.desc}</strong><br>
    <span class="text-muted">${n}: ${e.barcode||a}</span>
  `}function Ft(e,{silent:t=!1}={}){if(!e)return!1;if(Tt(e))return t||w(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.barcode),o&&(o.value=e.desc),Dn(e),Ie=e,!0}function Rn(e,{showFeedback:t=!0}={}){const n=Je(e);return n?Ft(n,{silent:!t}):(t&&w(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function Fn(e,{showFeedback:t=!0}={}){const n=qr(e);return n?Ft(n,{silent:!t}):(t&&w(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function Nt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=Rt(),o=qn();if(e){const s=c("maintenance.form.blockedSuffix","(صيانة)");e.innerHTML=a.map(i=>{const l=i.status==="صيانة"||o.has(i.barcode)?`${i.desc} ${s}`:i.desc,d=i.desc.replace(/"/g,"&quot;"),m=l.replace(/"/g,"&quot;");return`<option value="${d}" label="${m}"></option>`}).join("")}const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const s=Je(r.value);!s||Tt(s)?(se({keepInputs:!0,silent:!0}),s&&Tt(s)&&w(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):Ft(s,{silent:!0})}else se({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),Rn(t.value)||se({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const s=()=>{if(!n.value){se({keepInputs:!0,silent:!0});return}Fn(n.value)||se({keepInputs:!0,silent:!0})};n.addEventListener("change",s),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),s())}),n.dataset.listenerAttached="true"}}async function Ge(){try{await ya({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{It(),Nt()}}function Nn(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;Dt=t.Modal.getOrCreateInstance(e),C||(C=e.querySelector("#maintenance-close-report")),V||(V=e.querySelector("#maintenance-close-submit")),Ee||(Ee=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",Rr),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Pn),e.dataset.listenerAttached="true"),!0}function Pn(){le={id:null,equipmentDesc:"",equipmentBarcode:""},C&&(C.value=""),Ee&&(Ee.innerHTML=""),Be(!1)}function jn(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(Bn=t.Modal.getOrCreateInstance(e),we||(we=e.querySelector("#maintenance-report-modal-content")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",On),e.dataset.listenerAttached="true"),!0):!1}function On(){we&&(we.innerHTML="")}function Be(e){if(!V)return;const t=c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),n=c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(V.disabled=!0,V.dataset.loading="true",V.textContent=t):(V.disabled=!1,V.removeAttribute("data-loading"),V.textContent=n)}function Dr(e){const t=Mn(e);if(!t){w(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!Nn()){const n=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(n===null)return;const a=n.trim();if(!a){w(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}Hn(e,a);return}if(le={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},C&&(C.value=t.resolutionReport||""),Ee){const n=c("maintenance.report.barcode","الباركود"),a=c("maintenance.report.notAvailable","غير متوفر"),o=le.equipmentDesc||a,r=le.equipmentBarcode?y(le.equipmentBarcode):a;Ee.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${o}</div>
          <div class="maintenance-close-modal__ticket-meta">${n}: <span>${r}</span></div>
        </div>
      </div>
    `}Be(!1),Dt?.show(),setTimeout(()=>{C?.focus(),C?.setSelectionRange(C.value.length,C.value.length)},150)}async function Rr(e){if(e?.preventDefault(),!le.id){w(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!C)return;const t=C.value.trim();if(!t){w(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),C.focus();return}Be(!0),(await Hn(le.id,t)).success?Dt?.hide():Be(!1)}function Fr(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(m=>m.status==="open").length,o=n-a,r=m=>y(String(m)),s=c("maintenance.stats.summaryTitle","ملخص الصيانة"),i=c("maintenance.filters.status.open","قيد الصيانة"),u=c("maintenance.filters.status.closed","مغلقة"),l=c("maintenance.stats.totalLabel","إجمالي التذاكر"),d=(m,p,f)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${f}">
      <span class="maintenance-summary__value">${r(m)}</span>
      <span class="maintenance-summary__label">${p}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${s}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${d(a,i,"open")}
        ${d(o,u,"closed")}
        ${d(n,l,"total")}
      </div>
    </section>
  `}function Nr(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Cn(n)||"open",o={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},r=o[a]??o.open,s=r?c(r.key,r.fallback):c("maintenance.status.open","قيد الصيانة"),i=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():s,u=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&u.push(r.className),u.push(`maintenance-status-tag--${a}`),u.push(`maintenance-status-tag--${n}`),`<span class="${u.filter(Boolean).join(" ")}">${i}</span>`}function Pr(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),o=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${o}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const o=Nr(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",s=(()=>{const B=c("maintenance.priority.high","مرتفعة"),L=c("maintenance.priority.medium","متوسطة"),H=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${B}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${H}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${L}</span>`}})(),i=[],u=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),l=c("maintenance.actions.view","👁️ عرض التقرير"),d=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?i.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${u}</button>`):i.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${l}</button>`),kt()&&i.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${d}</button>`);const m=i.join(""),p=c("maintenance.table.noBarcode","بدون باركود"),f=c("maintenance.report.none","—"),v=a.equipmentBarcode?y(a.equipmentBarcode):p,A=a.issue?y(a.issue):f,S=a.createdAt?y(ce(a.createdAt)):"—";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${v}</small>
          </td>
          <td class="maintenance-issue-text">${A}</td>
          <td>${s}</td>
          <td>${S}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${m}
            </div>
          </td>
        </tr>
      `}).join("")}}function jr(e){if(!Te||Se){w(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Dr(a);else if(n==="view")Or(a);else if(n==="delete"){if(!kt()){ln();return}Hr(a).catch(o=>{console.error("❌ [maintenance] deleteTicket failed",o)})}}}async function Hn(e,t){const n=Mn(e);if(!n)return w(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const a=(t??"").trim();if(!a)return w(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const o=Mr(new Date)||new Date().toISOString();try{await Lr(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:o}),await Ce({showToastOnError:!1});const r=document.getElementById("maintenance-status-filter");return r&&r.value==="open"&&(r.value="all"),await Ge(),O(),w(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(r){if(console.error("❌ [maintenance] closeTicket failed",r),$e(r)&&r.status===404)return await Ce({showToastOnError:!1}),await Ge(),O(),w(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const s=$e(r)?r.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return w(s,"error"),{success:!1,error:r}}}function Or(e){const n=G().find(S=>Number(S.id)===Number(e));if(!n)return;if(!jn()){const S=c("maintenance.report.equipment","المعدة"),B=c("maintenance.report.barcode","الباركود"),L=c("maintenance.report.issue","الوصف"),H=c("maintenance.report.createdAt","تاريخ الإنشاء"),P=c("maintenance.report.closedAt","تاريخ الإغلاق"),ee=c("maintenance.report.summary","التقرير"),te=c("maintenance.report.notAvailable","غير متوفر"),U=c("maintenance.report.none","—"),M=[`${S}: ${n.equipmentDesc}`,`${B}: ${n.equipmentBarcode?y(n.equipmentBarcode):te}`,`${L}: ${n.issue?y(n.issue):U}`,`${H}: ${n.createdAt?y(ce(n.createdAt)):U}`,`${P}: ${n.resolvedAt?y(ce(n.resolvedAt)):U}`,`${ee}: ${n.resolutionReport?y(n.resolutionReport):U}`].join(`
`);alert(M);return}const a=c("maintenance.report.equipment","المعدة"),o=c("maintenance.report.barcode","الباركود"),r=c("maintenance.report.issue","الوصف"),s=c("maintenance.report.createdAt","تاريخ الإنشاء"),i=c("maintenance.report.closedAt","تاريخ الإغلاق"),u=c("maintenance.report.summary","التقرير"),l=c("maintenance.report.notAvailable","غير متوفر"),d=c("maintenance.report.none","—"),m=[{label:a,value:`<span class="maintenance-report-modal__value">${$(n.equipmentDesc||d)}</span>`},{label:o,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${$(y(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${$(l)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${$(y(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${$(d)}</span>`},{label:s,value:n.createdAt?`<span class="maintenance-report-modal__value">${$(y(ce(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${$(d)}</span>`},{label:i,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${$(y(ce(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${$(d)}</span>`}],p=n.resolutionReport?y(n.resolutionReport):"",f=p?`<p>${$(p).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${$(d)}</p>`,v=m.map(S=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${$(S.label)}</span>
        ${S.value}
      </div>
    `).join(""),A=`
    <div class="maintenance-report-modal__summary">
      <h6>${$(u)}</h6>
      ${f}
    </div>
  `;we&&(we.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${v}
        </div>
        ${A}
      </div>
    `),Bn?.show()}async function Hr(e){if(!kt()){ln();return}if(!G().find(a=>Number(a.id)===Number(e))){w(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await xr(e),await Ce({showToastOnError:!1}),await Ge(),w(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const o=$e(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");w(o,"error")}}async function Ur(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),o=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let s=Ie,i=K(a?.value);if(!s&&i&&(s=Je(i)),!s&&t?.value&&Rn(t.value,{showFeedback:!0})&&(s=Ie,i=K(s?.barcode)),!s&&n?.value&&Fn(n.value,{showFeedback:!0})&&(s=Ie,i=K(s?.barcode)),!s||!i){w(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:u=[]}=J();let l=(u||[]).find(v=>K(v?.barcode)===i);if(!l&&s&&(l={id:s.id,barcode:s.barcode,desc:s.desc,name:s.desc,status:s.status||"متاح"}),!l||l.id==null){w(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),se();return}if(l.status==="صيانة"){w(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(G().filter(v=>v.status==="open").some(v=>K(v.equipmentBarcode)===i)){w(c("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const p=kr({equipmentId:l.id,technicianId:null,issue:o?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Ar(p),await Ce({showToastOnError:!1}),await Ge(),w(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),se(),o&&(o.value=""),r&&(r.value="medium");const f=document.getElementById("maintenance-status-filter");f&&(f.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=$e(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");w(n,"error")}}function Vr(e){const t=G();return e==="all"?t:t.filter(n=>n.status===e)}function O(){const e=G();Nt(),Fr(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),o=document.getElementById("maintenance-empty-state");if(!a)return;if(Se&&!Te){const s=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${s}</td></tr>`,o&&o.classList.remove("active");return}if(_e&&!Te){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${_e}</td></tr>`,o&&o.classList.remove("active");return}const r=Vr(n);Pr(r)}function zr(){G(),Nt(),Te=pe.length>0,Se=!1,O(),Ce({showToastOnError:!1}),Nn()&&Pn(),jn()&&On();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Ur(a).catch(o=>{console.error("❌ [maintenance] submit handler failed",o)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{O()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",jr),n.dataset.listenerAttached="true")}G();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=Je(e.value);n?Dn(n):t&&(t.textContent=St())}else t&&(t.textContent=St());O(),Be(!1)});document.addEventListener(ta.USER_UPDATED,()=>{O()});window.addEventListener("maintenance:updated",()=>{pe=Ze(),O()});const Et="__ART_RATIO_LAST_DASHBOARD_TAB__",Y="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",We="create-tab",Un=/^[a-z0-9\-]+$/i;function wt(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function oe(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!Un.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function At(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!Un.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function Vn(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let ae=null,N=null,ie=!1,_=null,an=null,de=null,Lt=null,be=null;function Yr(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(r,{skipStore:s=!1,skipRender:i=!1}={})=>{if(!r)return;const u=e.filter(d=>d?.getAttribute("data-tab")===r),l=document.getElementById(r);if(!(!u.length||!l)&&(e.forEach(d=>{const m=d?.getAttribute("data-tab")===r;d.classList.toggle("active",m),m?(d.setAttribute("aria-selected","true"),d.setAttribute("tabindex","0"),wt(d)):(d.setAttribute("aria-selected","false"),d.setAttribute("tabindex","-1"))}),t.forEach(d=>{const m=d.id===r;d.style.display=m?"block":"none",d.classList.toggle("active",m)}),ae=r,At(Et,r),s||xe({dashboardTab:r}).catch(d=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",d)}),r!=="reservations-tab"&&(N=null,_=null,Vn(Y),s||xe({dashboardSubTab:null}).catch(d=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",d)})),!i&&r==="customers-tab"&&(console.log("👤 Rendering customers"),la()),!i&&r==="equipment-tab"&&(console.log("📦 Rendering equipment"),It()),!i&&r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),O()),!i&&r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),va()),r==="reservations-tab")){if(console.log("📅 Rendering reservations"),i||dn(),!_){const d=oe(Y);_=N||d||We}Gr(),_&&(De(_),_=null)}};Lt=n,e.forEach(r=>{r&&(r.getAttribute("type")||r.setAttribute("type","button"),r.setAttribute("role","tab"),r.hasAttribute("tabindex")||r.setAttribute("tabindex",r.classList.contains("active")?"0":"-1"),r.addEventListener("click",()=>{const s=r.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",s),n(s),s==="reservations-tab"){const i=N||oe(Y)||We;typeof de=="function"?de(i):_=i}else xe({dashboardSubTab:null}).catch(i=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",i)})}))});const a=r=>{const s=document.querySelector("[data-tab].active"),i=oe(Et),u=e[0]?.getAttribute("data-tab")||null,d=[r?.dashboardTab,i,ae,s?.getAttribute("data-tab"),u].filter(Boolean).find(f=>document.getElementById(f))||u;d&&(!ie||d!==ae)&&(console.log("⭐ Initial tab:",d),n(d,{skipStore:!0}));const p=[r?.dashboardSubTab,oe(Y)].filter(Boolean).find(f=>document.getElementById(f));p&&(ae==="reservations-tab"&&typeof de=="function"?(!ie||p!==N)&&de(p,{skipStore:!0}):_=p),ie||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),ie=!0)},o=typeof He=="function"?He():null;a(o||null),na().then(r=>a(r||null)).catch(r=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",r),a(null)}),an||(an=aa(r=>{if(!(!ie||!r))if(r.dashboardTab&&r.dashboardTab!==ae&&n(r.dashboardTab,{skipStore:!0}),ae==="reservations-tab"){if(r.dashboardSubTab&&r.dashboardSubTab!==N)De(r.dashboardSubTab);else if(!r.dashboardSubTab&&N){const s=oe(Y);s?s!==N&&De(s):De(null)}}else r.dashboardSubTab&&(_=r.dashboardSubTab)}))}function Gr(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(We)?We:n[0]:null,o=(r,{skipStore:s=!1}={})=>{if(!n.length)return;let i=r;(!i||!n.includes(i))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:i,available:n}),i=a());const u=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${i}"]`),l=document.getElementById(i);if(!u||!l){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:i});return}if(N===i&&u.classList.contains("active")&&l.classList.contains("active")&&l.getAttribute("aria-hidden")==="false"){l.removeAttribute("hidden"),l.style.display="block",l.setAttribute("aria-hidden","false"),N=i,wt(u),s||(At(Y,i),xe({dashboardSubTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}));return}e.forEach(m=>{m.classList.remove("active"),m.classList.contains("tab")&&m.classList.remove("tab-active"),m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1")}),u.classList.add("active"),u.classList.contains("tab")&&u.classList.add("tab-active"),u.setAttribute("aria-selected","true"),u.setAttribute("tabindex","0"),wt(u),t.forEach(m=>{const p=m.id===i;m.classList.toggle("active",p),m.setAttribute("aria-hidden",p?"false":"true"),p?(m.removeAttribute("hidden"),m.style.display="block"):(m.setAttribute("hidden",""),m.style.display="none")}),N=i,At(Y,i),s||xe({dashboardSubTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}),i==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{dn()},50)):i==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{Xe()},100)):i==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{I()},50))};if(de=(r,s={})=>{r?o(r,s):(e.forEach(i=>{i.classList.remove("active"),i.classList.contains("tab")&&i.classList.remove("tab-active"),i.setAttribute("aria-selected","false"),i.setAttribute("tabindex","-1")}),t.forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden",""),i.style.display="none"}),N=null,Vn(Y))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const s=r.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",s),o(s)}),r.dataset.subTabListenerAttached="true")}),_)o(_,{skipStore:!0}),_=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),s=a(),i=r?.getAttribute("data-sub-tab")||s;i&&(console.log("⭐ Initial sub-tab:",i),o(i,{skipStore:!0}))}pn()}function De(e){typeof de=="function"?de(e,{skipStore:!0}):e&&(_=e)}function Wr(){try{if(typeof He=="function")return He()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function Xr({attemptsLeft:e=0}={}){if(!ie||typeof Lt!="function")return!1;const t=Wr(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[ae,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,oe(Et),a].filter(Boolean).find(i=>document.getElementById(i));if(!r)return!1;const s=()=>{const i=document.querySelector(`[data-tab].active[data-tab="${r}"]`),u=document.getElementById(r);return!!(i&&u?.classList.contains("active")&&u?.style.display!=="none")};if(r==="reservations-tab"){const i=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!i.length)return!1;const u=i[0]?.getAttribute("data-sub-tab")||null,d=[N,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,oe(Y),u].filter(Boolean).find(v=>document.getElementById(v)),m=document.querySelector("#reservations-tab .sub-tab-button.active"),p=document.querySelector("#reservations-tab .sub-tab.active"),f=p?.id||m?.getAttribute("data-sub-tab")||null;if(d&&f===d&&s())return p&&(p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false")),!0;if(d)_=d;else if(e>0)return!1}else if(s())return!0;return Lt(r,{skipStore:!0,skipRender:!0}),!0}function Pt(){if(!ie)return;let e=0;const t=5;be&&(clearTimeout(be),be=null);const n=()=>{if(Xr({attemptsLeft:t-e})){be=null;return}if(e>=t){be=null;return}e+=1,be=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",Pt);document.addEventListener("language:changed",Pt);document.addEventListener("theme:changed",Pt);const Re={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let xt=!1;const Kr=1632,Zr=1776;function Qr(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-Kr)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-Zr)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function Jr(e){try{const t=Qr(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function Fe(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=Jr(t))}function rn(){xt=!1;const e=J(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,o=Array.isArray(e.technicians)?e.technicians.length:0;Re.projects.forEach(r=>Fe(r,t)),Re.reservations.forEach(r=>Fe(r,n)),Re.equipment.forEach(r=>Fe(r,a)),Re.technicians.forEach(r=>Fe(r,o))}function sn(){xt||(xt=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(rn):setTimeout(rn,16))}function es(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,sn,{passive:!0})}),sn()}function ts(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function ns({sidebar:e,backdrop:t}){e?.classList.add("open"),t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function Ne({sidebar:e,backdrop:t}){e?.classList.remove("open"),t?.classList.remove("open"),e?.setAttribute("aria-hidden","true")}function as(){const e=document.querySelector("[data-dashboard-greeting]");if(!e)return;const t=e.querySelector("[data-greeting-toggle]"),n=e.querySelector("[data-greeting-panel]");if(!t||!n)return;const a=i=>{i.target instanceof Node&&(e.contains(i.target)||s(!1))},o=()=>{window.requestAnimationFrame(()=>{document.addEventListener("click",a,{capture:!0})})},r=()=>{document.removeEventListener("click",a,{capture:!0})},s=i=>{n.hidden=!i,t.setAttribute("aria-expanded",String(i)),e.dataset.state=i?"open":"closed",i?o():r()};s(!1),t.addEventListener("click",()=>{const u=!(t.getAttribute("aria-expanded")==="true");s(u),u&&!window.matchMedia("(min-width: 768px)").matches&&n.scrollIntoView({behavior:"smooth",block:"start"})})}function rs(){const e=ts(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:o}=e;t&&(t.setAttribute("aria-hidden","true"),a?.addEventListener("click",r=>{r.preventDefault(),ns(e)}),o?.addEventListener("click",r=>{r.preventDefault(),Ne(e)}),n?.addEventListener("click",()=>{Ne(e)}),t.addEventListener("click",r=>{const s=r.target;if(s instanceof HTMLElement){if(s.hasAttribute("data-close-sidebar")||s.closest("[data-close-sidebar]")){Ne(e);return}s.closest("[data-tab]")&&Ne(e)}}),as())}ra();let R=null;async function on(){if(!await sa())return;rs(),Yr(),es(),oa(),It(),Sa(),Xe(),zr(),Oa(),ca(),pn();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const o=a.target.files&&a.target.files[0];o&&(await Ta(o),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",ia),ss(),os()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{on().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):on().catch(e=>{console.error("❌ Failed to initialise app",e)});function ss(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[o]=a.split(":"),r=`${o.padStart(2,"0")}:00`,s=`${n}T${r}`;e.value!==s&&(e.value=s,setTimeout(()=>e.blur(),150))})})}function os(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;R={reservationId:t,reservationIndex:n!=null?Number(n):null},zn(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),o=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,o)}function zn(){if(!R)return;const t=J().reservations||[];let n=null;if(R.reservationId){const a=t.findIndex(o=>String(o?.id)===R.reservationId||String(o?.reservationId)===R.reservationId);a!==-1&&(n=a)}n===null&&typeof R.reservationIndex=="number"&&!Number.isNaN(R.reservationIndex)&&R.reservationIndex>=0&&R.reservationIndex<t.length&&(n=R.reservationIndex),n!==null&&(R=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const o=window.editReservation;typeof o=="function"&&o(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{R&&zn()});
