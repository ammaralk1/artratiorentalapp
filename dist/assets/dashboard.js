import{t as d,e as O,d as Q,b as K,A as dn,n as E,s as Zn,f as Jn,h as L,j as Ct,k as _e,o as mn,u as xe,p as Oe,q as ea,r as ta,a as na,c as aa,i as ra,l as sa}from"./auth.js";import{i as oa}from"./dashboardShell.js";/* empty css   */import{r as ia}from"./customers.js";import{e as ca,i as la,g as mt,r as pn,m as ua,a as da,n as ma,b as pa,D as fa,c as ba,d as It,f as ha,u as ga}from"./projectsService.js";import{b as ya,r as fn,l as va}from"./controller.js";import{s as bn}from"./events.js";import{s as Sa,m as hn,r as Ea}from"./technicians.js";const Ta={limit:200};let _=null,zt=!1,Vt=!1,Ut=!1,Yt=!1,et=null,tt=null,nt=!1,re="";const wa=[{key:"confirmed",chipClass:"reservation-chip status-confirmed"},{key:"pending",chipClass:"reservation-chip status-pending"},{key:"paid",chipClass:"reservation-chip status-paid"},{key:"unpaid",chipClass:"reservation-chip status-unpaid"},{key:"completed",chipClass:"reservation-chip status-completed"}],Aa={confirmed:"حجز مؤكد",pending:"بانتظار التأكيد",paid:"مدفوع بالكامل",unpaid:"لم يتم الدفع",completed:"منتهي"},La={confirmed:"Confirmed reservation",pending:"Awaiting confirmation",paid:"Paid in full",unpaid:"Payment pending",completed:"Completed"},at=new Map;function J(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function kt(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function _a(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function xa(e){return at.has(e)||at.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),at.get(e)}function Ca(e,t,n=!1){if(n){const u=(O?.()==="en"?"en":"ar")==="en"?"All day":"طوال اليوم";return d("calendar.labels.allDay",u)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const s=O?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",r=xa(s),o=r.format(a);if(!t)return o;const i=new Date(t);if(Number.isNaN(i.getTime()))return o;const l=r.format(i);return o===l?o:`${o} – ${l}`}function Ia({paid:e,confirmed:t,completed:n}){const a=["calendar-event"];return(n===!0||n==="true")&&a.push("calendar-event--completed"),t===!0||t==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function gn(){const e=document.getElementById("calendar-legend");if(!e)return;const t=O?.()==="en"?"en":"ar";e.innerHTML=wa.map(({key:n,chipClass:a})=>{const s=t==="en"?La[n]??n:Aa[n]??n,r=J(d(`calendar.legend.${n}`,s));return`<span class="calendar-legend__item" role="listitem"><span class="${a} calendar-legend__chip">${r}</span></span>`}).join("")}function fe(){const{calendarEl:e}=kt();if(!e)return;const t=e.querySelector(".fc-header-toolbar");if(!t)return;t.classList.add("calendar-toolbar"),t.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const n=t.querySelector(".fc-toolbar-title");n&&n.classList.add("calendar-toolbar__title"),t.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function be({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:s}=kt();if(!a||!s)return;const r=typeof t=="string"?t.trim().length>0:!!t,o=!e&&!r&&!!n,i=e||r||o;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",o),s.dataset.initialized||(s.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),s.dataset.initialized="true"),s.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),s.classList.toggle("hidden",!i),!i){s.innerHTML="",s.removeAttribute("data-status");return}let l="";e?l=d("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):r?l=typeof t=="string"&&t.trim().length>0?t:d("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):o&&(l=d("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const c=e?"loading":r?"error":"empty";if(s.setAttribute("data-status",c),s.classList.add(`calendar-status-card--${c}`),s.innerHTML="",e){const m=document.createElement("span");m.className="loading loading-spinner loading-md text-primary",m.setAttribute("aria-hidden","true"),s.appendChild(m)}else{const m=document.createElement("span");m.className="calendar-status-card__icon",m.setAttribute("aria-hidden","true"),m.textContent=r?"⚠️":"🗓️",s.appendChild(m)}const u=document.createElement("span");u.className="calendar-status-card__message text-center text-sm font-semibold",u.textContent=l,s.appendChild(u)}function rt(){_&&(_.destroy(),_=null)}function ka(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const s=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:s==="paid",{effectiveConfirmed:o}=pn(e,t),i=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let c=!!e.completed;if(!c&&a){const u=new Date(a);Number.isNaN(u.getTime())||(c=u<new Date)}return{id:e.id??i??n,start:n,end:a||n,paid:r,confirmed:o,completed:c,reservationId:i??"",customerName:l,raw:e}}function yn(e=[]){const{projects:t=[]}=Q(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&s!==""&&n.get(String(s))||null,o=ka(a,r);if(!o)return null;const i=Ia({paid:o.paid,confirmed:o.confirmed,completed:o.completed});return{id:o.id,title:"",start:o.start,end:o.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:i,extendedProps:{...a,raw:a,paid:o.paid,confirmed:o.confirmed,completed:o.completed,reservationId:o.reservationId,customerName:o.customerName}}}).filter(Boolean)}function Gt(){return{today:d("calendar.buttons.today","اليوم"),month:d("calendar.buttons.month","شهر"),week:d("calendar.buttons.week","أسبوع"),day:d("calendar.buttons.day","يوم")}}async function Ma(){if(nt)return mt();nt=!0,re="";try{await ca({suppressError:!1,params:Ta})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),re=la(e)?e.message:e instanceof Error&&e.message||""}finally{nt=!1}return mt()}function vn(e){_&&_.batchRendering(()=>{_.removeAllEvents(),_.addEventSource(e)})}function Sn(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function En(){const e=mt(),t=yn(e);if(!_){We();return}_.setOption("locale",O()),vn(t),Ce(),be({loading:!1,error:"",empty:t.length===0}),Sn(t),gn(),fe()}function qa(){zt||(document.addEventListener("language:changed",()=>{_&&_.setOption("locale",O()),We()}),zt=!0),Vt||(document.addEventListener("reservations:changed",()=>{En()}),Vt=!0)}function Tn(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function Ce(){if(!_)return;const e=Tn();_.view?.type!==e&&_.changeView(e),_.updateSize()}function Ba(){Ut||typeof window>"u"||(window.addEventListener("resize",()=>{Ce()}),Ut=!0)}function $a(){if(Yt||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{tt&&clearTimeout(tt),tt=setTimeout(()=>{_&&En()},80)};et=new MutationObserver(e),et.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&et.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Yt=!0}function Da(e){const{reservationId:t,customerName:n,paid:a,confirmed:s,completed:r}=e.event.extendedProps,o=a===!0||a==="paid",i=s===!0||s==="true",l=r===!0||r==="true",c=document.createElement("div");c.className="calendar-event-wrapper";const u=i?d("calendar.badges.confirmed","مؤكد"):d("calendar.badges.pending","غير مؤكد"),m=o?d("calendar.badges.paid","مدفوع"):d("calendar.badges.unpaid","غير مدفوع"),p=d("calendar.badges.completed","منتهي"),f=d("calendar.labels.unknownCustomer","غير معروف"),g=[`<span class="reservation-chip calendar-chip ${i?"status-confirmed":"status-pending"}">${J(u)}</span>`,`<span class="reservation-chip calendar-chip ${o?"status-paid":"status-unpaid"}">${J(m)}</span>`];l&&g.push(`<span class="reservation-chip calendar-chip status-completed">${J(p)}</span>`);const S=Ca(e.event.startStr,e.event.endStr,e.event.allDay),v=J(S||""),k=J(t||"—"),T=J(n||f),z=v?`<span class="calendar-event-card__time">${v}</span>`:"";return c.innerHTML=`
    <article class="calendar-event-card">
      <header class="calendar-event-card__head">
        ${z}
        <span class="calendar-event-card__id">${k}</span>
      </header>
      <div class="calendar-event-card__customer">${T}</div>
      <div class="calendar-event-card__chips">${g.join("")}</div>
    </article>
  `,{domNodes:[c]}}function Ra(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(d("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=Q()||{},{reservations:a=[],customers:s=[],projects:r=[],technicians:o=[]}=n,i=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},l=[i.id,i.reservationId,i.reservation_id,i.reservationCode,i.reservation_code].map(y=>y==null?"":String(y)).filter(y=>y.length>0);let c=-1,u=null;l.length>0&&(c=a.findIndex(y=>{const M=[y?.id,y?.reservationId,y?.reservation_id,y?.reservationCode,y?.reservation_code].map($=>$==null?"":String($)).filter($=>$.length>0);return M.length===0?!1:M.some($=>l.includes($))}),c>=0&&(u=a[c]));const m=u?{...u,...i}:i,p=m.projectId??m.project_id??null,f=p!=null&&r.find(y=>String(y.id)===String(p))||null,g=m.customerId??m.customer_id,S=s.find(y=>String(y.id)===String(g)),v=Sa(),k=[...Array.isArray(v)?v:[],...Array.isArray(o)?o:[]],T=new Map;k.forEach(y=>{if(!y||y.id==null)return;const M=String(y.id),$=T.get(M)||{};T.set(M,{...$,...y})});const z=Array.from(T.values());let V="";try{V=ya(m,S,z,c>=0?c:0,f)}catch(y){console.error("❌ [calendar] Failed to build reservation details for calendar modal",y),t.innerHTML=`<p class="text-sm text-error">${J(d("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"))}</p>`;return}t.innerHTML=V,t.classList.add("calendar-reservation-details"),t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(y=>{y instanceof HTMLElement&&(y.setAttribute("disabled","true"),y.setAttribute("aria-disabled","true"),y.setAttribute("tabindex","-1"))});const Z=t.querySelector('[data-action="open-project"]');Z&&(f?Z.addEventListener("click",()=>{const y=f?.id!=null?String(f.id):"",M=y?`projects.html?project=${encodeURIComponent(y)}`:"projects.html";window.location.href=M}):Z instanceof HTMLElement&&Z.setAttribute("disabled","true"));const U=document.getElementById("calendarReservationModal");U&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(U).show():alert(d("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function We(){qa(),Ba(),$a();const{calendarEl:e}=kt();if(!e)return;const t=_a();if(!t||typeof t.Calendar!="function"){const n=d("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");be({error:n}),rt();return}(async()=>{be({loading:!0});const n=await Ma();if(re){const s=d("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");be({loading:!1,error:re||s}),rt();return}const a=yn(n);_?(_.setOption("locale",O()),_.setOption("buttonText",Gt()),vn(a),fe()):(_=new t.Calendar(e,{initialView:Tn(),locale:O(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:Gt(),events:a,eventContent:Da,eventClick(s){Ra(s.event.extendedProps)},windowResize:Ce,datesSet(){fe()}}),_.render(),fe()),Ce(),Sn(a),be({loading:!1,error:"",empty:a.length===0}),gn(),fe(),setTimeout(()=>{Ce(),fe()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),re=n instanceof Error&&n.message||re||"";const a=d("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");be({loading:!1,error:re||a}),rt()})}let pt=null,Fe=null;const h={range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null};let Kt=!1,Wt=!1,ge=null;const w={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let je=!1,ze="";const D={icon:null,title:null,subtitle:null};let Xt=!1;const st=new Map;let ot=null,it=null,ct=null,ye=null;const A={trend:null,status:null,payment:null},ne={filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[]},ft={code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0};let Qt=!1,Zt=!1,Jt=!1,wn=[],lt=[],ut=[],en=!1,F=null,j=null,tn=null,nn=null;function b(e,t,n=t){const a=O()==="en"?n??t:t;return d(e,a)}function an(){dt(),I(),setTimeout(()=>{dt(),I(),Pe()},0),setTimeout(()=>{dt(),I(),Pe()},60),Pe()}function he(){h.range==="custom"&&I()}function dt(){pt=null,Fe=null}function Mt(){return(O()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function Na(){const e=O();if(e!==pt||!Fe){pt=e;const t=Mt();Fe=new Intl.NumberFormat(t,{maximumFractionDigits:0})}return{numberFormatter:Fe}}function Fa(e){const t=Mt();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function bt(e){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"";const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${s}`}function qt(e){if(st.has(e))return st.get(e);const t=document.querySelector(`script[src="${e}"]`),n=new Promise((a,s)=>{const r=()=>{t&&(t.dataset.loaded="true"),a()},o=l=>s(l);if(t){if(t.dataset.loaded==="true"){a();return}t.addEventListener("load",r,{once:!0}),t.addEventListener("error",o,{once:!0});return}const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>{i.dataset.loaded="true",a()},i.onerror=l=>s(l),document.head.appendChild(i)});return st.set(e,n),n}function Bt(){return window.ApexCharts?Promise.resolve(window.ApexCharts):(ot||(ot=qt("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),ot)}function ja(){return window.html2pdf?Promise.resolve(window.html2pdf):(it||(it=qt("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),it)}function Pa(){return window.XLSX?Promise.resolve(window.XLSX):(ct||(ct=qt("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),ct)}function Ve(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function An(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Ln(e={}){const t=E(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function _n(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",s=e?.confirmed===!0||Ue(a)==="confirmed"||Ue(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:s}}function Ha(){if(typeof Q!="function")return!1;let e;try{e=Q()}catch(i){return console.warn("⚠️ [reports] Failed to access cached data",i),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:s=[],projects:r=[]}=e;return t.length||n.length||a.length||s.length||r.length?(w.reservations=Array.isArray(t)?t.map(ua):[],w.customers=Array.isArray(n)?n.map(An):[],w.equipment=Array.isArray(a)?a.map(Ln):[],w.technicians=Array.isArray(s)?s.map(hn):[],w.projects=Array.isArray(r)?r.map(_n):[],w.projectsMap=new Map(w.projects.map(i=>[i.id,i])),ye=new Map((w.technicians||[]).map(i=>[String(i.id),i])),!0):!1}const Oa=1440*60*1e3;function za(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const s=a.getTime()-n.getTime();return s<=0?1:Math.max(1,Math.ceil(s/Oa))}function Va(e){return e?(ye||(ye=new Map((w.technicians||[]).map(t=>[String(t.id),t]))),ye.get(String(e))||null):null}function Ua(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null)continue;const a=Number.parseFloat(E(String(n)));if(Number.isFinite(a))return a}return 0}function $e(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,discountAmount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;const t=za(e.start,e.end),a=(e.items||[]).reduce((y,M)=>{const $=Number(M?.qty)||Number(M?.quantity)||1,Qn=Number(M?.price)||Number(M?.unit_price)||0;return y+$*Qn},0)*t,r=(e.technicians||[]).reduce((y,M)=>{const $=Va(M);return y+Ua($)},0)*t,o=a+r,i=Number(e.discount)||0;let c=(e.discountType||e.discount_type||"percent")==="amount"?i:o*(i/100);(!Number.isFinite(c)||c<0)&&(c=0),c>o&&(c=o);const u=Math.max(0,o-c),m=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1";let p=m?u*.15:0;(!Number.isFinite(p)||p<0)&&(p=0);const f=Number(e.cost),g=u+p;let S=Math.max(0,Math.round(g));if(Number.isFinite(f)&&f>0&&(S=f,m)){const y=S-u;Number.isFinite(y)&&y>=0&&(p=y)}const v=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,k=v!=null?Number.parseFloat(E(String(v).replace("%","").trim())):NaN,T=e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null;let z=T!=null?T===!0||T===1||T==="1"||String(T).toLowerCase()==="true":Number.isFinite(k)&&k>0,V=z&&Number.isFinite(k)?Number(k):0;m&&V<=0&&(V=fa,z=!0);const Ae=V>0?Math.max(0,S*(V/100)):0,Z=Math.max(0,S-p-Ae),U={rentalDays:t,equipmentTotal:a,crewTotal:r,discountAmount:c,taxableAmount:u,taxAmount:p,finalTotal:S,companySharePercent:V,companyShareAmount:Ae,netProfit:Z};return e.__financials=U,U}function xn(e){return e?.projectId&&w.projectsMap.get(String(e.projectId))||null}function we(e){const t=xn(e),n=pn(e,t),a=Ue(n.projectStatus);let s=Ue(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(s=a),(!s||s==="cancelled")&&(s=n.effectiveConfirmed?"confirmed":"pending"),(pa(e)||a==="completed")&&(s="completed");const r=n.effectiveConfirmed||s==="confirmed"||s==="completed";r&&s!=="completed"&&(s="confirmed");const o=Za(e);return{statusValue:s,confirmed:r,paid:o}}async function Cn({silent:e=!1}={}){if(!je){je=!0,ze="",e||I();try{const[t,n,a,s,r]=await Promise.all([K("/reservations/?limit=500"),K("/customers/?limit=500"),K("/equipment/?limit=500"),K("/technicians/?limit=500"),K("/projects/?limit=500")]);w.reservations=Array.isArray(t?.data)?t.data.map(o=>da(o)):[],w.customers=Array.isArray(n?.data)?n.data.map(An):[],w.equipment=Array.isArray(a?.data)?a.data.map(Ln):[],w.technicians=Array.isArray(s?.data)?s.data.map(hn):[],w.projects=Array.isArray(r?.data)?r.data.map(_n):[],w.projectsMap=new Map(w.projects.map(o=>[o.id,o])),ye=new Map((w.technicians||[]).map(o=>[String(o.id),o]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),ze=t instanceof dn?t.message:d("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),w.reservations=[],w.customers=[],w.equipment=[],w.technicians=[],w.projects=[],w.projectsMap=new Map,ye=null}finally{je=!1,I()}}}function Le(){Cn({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function ht({active:e,icon:t,title:n,subtitle:a}){const s=document.getElementById("reports-empty-state");if(!s)return;const r=s.querySelector(".reports-empty-icon"),o=s.querySelector("h4"),i=s.querySelector("p");D.icon===null&&r&&(D.icon=r.textContent),D.title===null&&o&&(D.title=o.textContent),D.subtitle===null&&i&&(D.subtitle=i.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!r||!o||!i)&&(e?(r.textContent=t!==void 0?t:D.icon??r.textContent,o.textContent=n!==void 0?n:D.title??o.textContent,i.textContent=a!==void 0?a:D.subtitle??i.textContent):(r.textContent=D.icon??r.textContent,o.textContent=D.title??o.textContent,i.textContent=D.subtitle??i.textContent))}function Ya(){if(Kt)return;Kt=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),r=document.getElementById("reports-end"),o=document.getElementById("reports-refresh"),i=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;e.value=h.range,Ha()&&I(),e.addEventListener("change",()=>{h.range=e.value,gt(i,h.range==="custom"),h.range!=="custom"&&(h.start=null,h.end=null),I()}),t?.addEventListener("change",()=>{h.status=t.value,I()}),n?.addEventListener("change",()=>{h.payment=n.value,I()}),a?.addEventListener("change",()=>{h.share=a.value,I()}),l?.addEventListener("input",()=>{const u=l.value||"";ge&&clearTimeout(ge),ge=setTimeout(()=>{h.search=u,I()},220)}),s?.addEventListener("change",()=>{h.start=s.value||null,he()}),r?.addEventListener("change",()=>{h.end=r.value||null,he()}),o?.addEventListener("click",()=>{h.range==="custom"&&(h.start=s?.value||null,h.end=r?.value||null),I()}),Pe(s,r),gt(i,!1),Wt||(document.addEventListener("language:changed",an),document.addEventListener("language:translationsReady",an),Wt=!0),Xt||(document.addEventListener("reservations:changed",Le),document.addEventListener("customers:changed",Le),document.addEventListener("equipment:changed",Le),document.addEventListener("projects:changed",Le),document.addEventListener("technicians:updated",Le),Xt=!0),ur(),dr(),hr(),en||(document.addEventListener("theme:changed",()=>{setTimeout(()=>I(),0)}),en=!0),Cn()}function Xe(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),r=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");e&&e.value!==h.range&&(e.value=h.range),t&&t.value!==h.status&&(t.value=h.status),n&&n.value!==h.payment&&(n.value=h.payment),a&&a.value!==h.share&&(a.value=h.share),s&&s.value!==h.search&&(s.value=h.search||""),r&&r.value!==(h.start||"")&&(r.value=h.start||""),o&&o.value!==(h.end||"")&&(o.value=h.end||""),gt(i,h.range==="custom")}function I(){if(Xe(),je){ht({active:!0,icon:"⏳",title:d("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:d("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(ze){ht({active:!0,icon:"⚠️",title:ze,subtitle:d("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=w,s=Ka(e,h,t,n,a),r=Ja(s),o=er(s),i=tr(s),l=nr(s),c=ar(s,t),u=rr(s,n);xr(r),gr(o),yr(i),vr(l),Sr(c),Er(u);const m=sr(s,t,a);yt(),Cr(s.length===0),ne.filtered=s,ne.metrics=r,ne.trend=o,ne.statusBreakdown=i,ne.paymentBreakdown=l,ne.tableRows=m}function Pe(e,t){if(!window.flatpickr)return;e&&(tn=e),t&&(nn=t);const n=tn,a=nn;if(!n&&!a)return;const s=Ga(),r=o=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...o};return s&&(i.locale=s),i};if(F&&(F.destroy(),F=null),j&&(j.destroy(),j=null),n&&(F=window.flatpickr(n,r({onChange(o,i){h.start=i||null,j&&(o?.length?j.set("minDate",o[0]):j.set("minDate",null)),he()},onValueUpdate(o,i){h.start=i||null,he()}}))),a&&(j=window.flatpickr(a,r({onChange(o,i){h.end=i||null,F&&(o?.length?F.set("maxDate",o[0]):F.set("maxDate",null)),he()},onValueUpdate(o,i){h.end=i||null,he()}}))),F&&n){F.setDate(n.value,!1);const o=j?.selectedDates?.[0]||a?.value;o&&F.set("maxDate",o)}if(j&&a){j.setDate(a.value,!1);const o=F?.selectedDates?.[0]||n?.value;o&&j.set("minDate",o)}}function Ga(){return(O()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function gt(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function In(e){return E(String(e||"")).toLowerCase().trim()}function Ka(e,t,n,a,s){const{startDate:r,endDate:o}=Xa(t),i=In(t.search),l=!!i,c=new Map((n||[]).map(p=>[String(p.id),p])),u=new Map((a||[]).map(p=>[Ye(p?.barcode),p])),m=new Map((s||[]).map(p=>[String(p.id),p]));return(e||[]).filter(p=>{const f=p?.start?new Date(p.start):null;if(!f||Number.isNaN(f.getTime())||r&&f<r||o&&f>o)return!1;const{statusValue:g,confirmed:S,paid:v}=we(p);if(t.status==="confirmed"&&!(g==="confirmed"||g==="completed"||S)||t.status==="pending"&&g!=="pending"||t.status==="completed"&&g!=="completed"||t.payment==="paid"&&!v||t.payment==="unpaid"&&v)return!1;if(t.share&&t.share!=="all"){const T=$e(p).companySharePercent>0;if(t.share==="with"&&!T||t.share==="without"&&T)return!1}return!(l&&!Wa(p,i,c,u,m))})}function Wa(e,t,n,a,s){const r=[],o=e?.reservationId||e?.id;o&&r.push(o),e?.notes&&r.push(e.notes);const{statusValue:i,paid:l}=we(e);i&&r.push(i);const c=e?.paymentStatus||e?.payment_status;c&&r.push(c),e?.paid!=null&&r.push(e.paid?"paid":"unpaid");const u=n.get(String(e?.customerId));u&&r.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const m=xn(e);return m&&r.push(m.title,m.code,m.status),r.push(kn(l)),(e?.items||[]).forEach(f=>{f?.desc&&r.push(f.desc),f?.barcode&&r.push(f.barcode);const g=a.get(Ye(f?.barcode));g&&r.push(g.desc,g.description,g.name)}),(e?.technicians||[]).forEach(f=>{const g=s.get(String(f));g&&r.push(g.name,g.role,g.department)}),In(r.filter(Boolean).join(" ")).includes(t)}function Xa({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const o=t?new Date(`${t}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:rn(o)?o:null,endDate:rn(i)?i:null}}let s=new Date(a),r=null;switch(e){case"last30":{r=new Date(a),r.setDate(r.getDate()-29);break}case"thisWeek":{const o=new Date(a),l=(o.getDay()-6+7)%7;o.setDate(o.getDate()-l),o.setHours(0,0,0,0);const c=new Date(o);c.setDate(o.getDate()+6),c.setHours(23,59,59,999),r=o,s.setTime(c.getTime());break}case"thisMonth":{r=new Date(a.getFullYear(),a.getMonth(),1);const o=new Date(a.getFullYear(),a.getMonth()+1,0);s.setTime(o.setHours(23,59,59,999));break}case"thisQuarter":{const o=Math.floor(a.getMonth()/3);r=new Date(a.getFullYear(),o*3,1);const i=new Date(a.getFullYear(),(o+1)*3,0);s.setTime(i.setHours(23,59,59,999));break}case"thisYear":{r=new Date(a.getFullYear(),0,1);const o=new Date(a.getFullYear(),12,0);s.setTime(o.setHours(23,59,59,999));break}case"all":default:r=null,s=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:s}}function rn(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const Qa=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),sn=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function Ue(e=""){const t=String(e).toLowerCase().trim();return t?Qa.get(t)||t:""}function Za(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&sn.has(a))return sn.get(a)}return e?.paid===!0||e?.paid==="true"}function Ja(e){const t=e.length;let n=0,a=0,s=0,r=0,o=0,i=0,l=0;e.forEach(u=>{const{statusValue:m,confirmed:p,paid:f}=we(u);m==="completed"&&(a+=1),p&&(n+=1),f&&(s+=1);const g=$e(u);r+=g.finalTotal,o+=g.companyShareAmount,i+=g.taxAmount,l+=g.netProfit});const c=t?r/t:0;return{total:t,confirmed:n,completed:a,paidCount:s,revenue:r,average:c,companyShareTotal:o,taxTotal:i,netProfit:l}}function er(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const s=new Date(t.getFullYear(),t.getMonth()-a,1),r=s.getFullYear(),o=s.getMonth(),i=e.filter(S=>{const v=S?.start?new Date(S.start):null;return v&&v.getFullYear()===r&&v.getMonth()===o}),l=i.length;let c=0,u=0,m=0;i.forEach(S=>{const v=$e(S);c+=v.finalTotal,u+=v.netProfit,m+=v.companyShareAmount});const p=Fa(s),f=new Date(s.getFullYear(),s.getMonth(),1),g=new Date(s.getFullYear(),s.getMonth()+1,0);n.push({label:p,count:l,revenue:c,netProfit:u,companyShare:m,periodStart:f,periodEnd:g,startInput:bt(f),endInput:bt(g)})}return n}function tr(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(o=>{const{statusValue:i,confirmed:l}=we(o);i==="completed"?t.completed+=1:i==="confirmed"||l?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,s=t.pending,r=t.completed;return[{label:b("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:b("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-pending",filterKey:"pending"},{label:b("reservations.reports.status.completedLabel","منتهية","Completed"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-completed",filterKey:"completed"}]}function nr(e){const t=e.length||1,n=e.filter(s=>we(s).paid).length,a=e.length-n;return[{label:b("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function ar(e,t){const n=new Map,a=new Map((t||[]).map(s=>[String(s.id),s]));return e.forEach(s=>{const r=String(s?.customerId??"unknown"),o=n.get(r)||{count:0,revenue:0},i=$e(s);o.count+=1,o.revenue+=i.finalTotal,n.set(r,o)}),Array.from(n.entries()).map(([s,r])=>({name:a.get(s)?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:r.count,revenue:r.revenue})).sort((s,r)=>r.revenue-s.revenue).slice(0,5)}function rr(e,t){const n=new Map,a=new Map((t||[]).map(r=>[Ye(r?.barcode),r])),s=b("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");return e.forEach(r=>{(r?.items||[]).forEach(o=>{const i=Ye(o?.barcode),l=i?a.get(i):null,c=o?.desc||o?.description||o?.name||l?.desc||l?.description||l?.name||"",u=c&&c.trim()?c:s,m=ma(u)||"unknown",p=Number(o?.qty)||1,f=Number(o?.price)||0,g=p*f,S=n.get(m)||{name:u,count:0,revenue:0};S.name=u,S.count+=p,S.revenue+=g,n.set(m,S)})}),Array.from(n.values()).sort((r,o)=>o.count!==r.count?o.count-r.count:o.revenue-r.revenue).slice(0,5)}function sr(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const s=new Map((t||[]).map(i=>[String(i.id),i]));new Map((n||[]).map(i=>[String(i.id),i]));const r={code:b("reservations.reports.results.headers.id","الحجز","Reservation"),customer:b("reservations.reports.results.headers.customer","العميل","Customer"),date:b("reservations.reports.results.headers.date","التاريخ","Date"),status:b("reservations.reports.results.headers.status","الحالة","Status"),payment:b("reservations.reports.results.headers.payment","الدفع","Payment"),total:b("reservations.reports.results.headers.total","الإجمالي","Total"),share:b("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:b("reservations.reports.results.headers.net","صافي الربح","Net profit")},o=[...e].sort((i,l)=>new Date(l.start||0)-new Date(i.start||0)).slice(0,20).map(i=>{const l=Tr(i,s),c={[r.code]:l.code.text,[r.customer]:l.customer.text,[r.date]:l.date.text,[r.status]:l.status.text,[r.payment]:l.payment.text,[r.total]:l.total.text,[r.share]:l.share.text,[r.net]:l.net.text};return{formatted:l,exportRow:c}});return a.innerHTML=o.map(({formatted:i})=>`
      <tr data-drilldown="reservation" data-search="${Dt(i.code.text)}">
        <td data-report-column="code">${i.code.html}</td>
        <td data-report-column="customer">${i.customer.html}</td>
        <td data-report-column="date">${i.date.html}</td>
        <td data-report-column="status">${i.status.html}</td>
        <td data-report-column="payment">${i.payment.html}</td>
        <td data-report-column="total">${i.total.html}</td>
        <td data-report-column="share">${i.share.html}</td>
        <td data-report-column="net">${i.net.html}</td>
      </tr>
    `).join(""),o.map(({exportRow:i})=>i)}function or(e){const t=wn?.[e];t&&(h.range="custom",h.start=t.startInput||null,h.end=t.endInput||null,Xe(),I())}function ir(e){e&&(h.status=h.status===e?"all":e,Xe(),I())}function cr(e){e&&(h.payment=h.payment===e?"all":e,Xe(),I())}function lr(e){ge&&(clearTimeout(ge),ge=null),h.search=e||"";const t=document.getElementById("reports-search");t&&t.value!==h.search&&(t.value=h.search),I()}function ur(){if(Zt)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(t=>{const n=t.dataset.columnToggle;n&&(t.checked=ft[n]!==!1,t.addEventListener("change",()=>{ft[n]=t.checked,yt()}))}),Zt=!0,yt())}function yt(){Object.entries(ft).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{t?n.classList.remove("hidden"):n.classList.add("hidden")})})}function dr(){if(Qt)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(t=>{t.addEventListener("click",async()=>{const{export:n=""}=t.dataset;if(n){t.disabled=!0;try{await mr(n)}catch(a){console.error("⚠️ [reports] export failed",a)}finally{t.disabled=!1}}})}),Qt=!0)}async function mr(e){const t=ne.tableRows||[];if(!t.length){console.warn("[reports] No reservation data to export");return}switch(e){case"pdf":await br();break;case"excel":await fr(t);break;case"csv":default:vt(t);break}}function $t(e){const t=bt(new Date).replace(/-/g,"");return`${b("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${t}.${e}`}function pr(e,t,n){const a=new Blob([e],{type:n}),s=URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function vt(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(s=>{const r=t.map(o=>`"${String(s[o]??"").replace(/"/g,'""')}"`);n.push(r.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;pr(a,$t("csv"),"text/csv;charset=utf-8;")}async function fr(e){try{const t=await Pa();if(!t){vt(e);return}const n=t.utils.json_to_sheet(e),a=t.utils.book_new(),s=b("reservations.reports.export.sheetName","الحجوزات","Reservations");t.utils.book_append_sheet(a,n,s),t.writeFile(a,$t("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),vt(e)}}async function br(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await ja();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=$t("pdf");await t().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}function hr(){if(Jt)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=s=>{const r=s.target?.closest("[data-drilldown]");if(!r)return;const o=r.dataset.search||"";lr(o)};e?.addEventListener("click",a),t?.addEventListener("click",a),n?.addEventListener("click",a),Jt=!0}async function gr(e){const t=document.getElementById("reports-volume-chart");if(t){if(wn=Array.isArray(e)?e:[],!e||e.length===0){A.trend&&(A.trend.destroy(),A.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const n=await Bt();if(!n){t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const a=e.map(c=>c.label),s=e.map(c=>Math.round(c.count||0)),r=e.map(c=>Math.round(c.revenue||0)),o=e.map(c=>Math.round(c.netProfit||0)),i=[{name:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:s},{name:b("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:r},{name:b("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:o,yAxisIndex:1}],l={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(c,u,m)=>{m?.dataPointIndex!=null&&or(m.dataPointIndex)}}},theme:{mode:Ve()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:a,labels:{style:{colors:Ve()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:c=>x(c)},title:{text:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:b("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:c=>H(c)},title:{text:b("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(c,{seriesIndex:u})=>u===0?x(c):H(c)}}};A.trend?(A.trend.updateOptions({...l},!0,!0),A.trend.updateSeries(i,!0)):(t.innerHTML="",A.trend=new n(t,{...l,series:i}),A.trend.render())}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function yr(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(t){if(lt=Array.isArray(e)?e:[],!e||e.length===0){A.status&&(A.status.destroy(),A.status=null),ee(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Bt();if(!a){ee(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=e.map(i=>Math.max(0,i.value||0)),r=e.map(i=>i.label),o={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(i,l,c)=>{if(c?.dataPointIndex!=null){const u=lt[c.dataPointIndex];u?.filterKey&&ir(u.filterKey)}}}},theme:{mode:Ve()},labels:r,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:b("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>x(s.reduce((i,l)=>i+l,0))}}}}},tooltip:{y:{formatter:(i,l)=>{const c=lt?.[l?.seriesIndex||0],u=c?`${x(c.percent)}%`:`${x(i)}%`;return`${x(c?c.rawCount??c.value??0:i)} / ${u}`}}}};A.status?(A.status.updateOptions({...o},!0,!0),A.status.updateSeries(s,!0)):(t.innerHTML="",A.status=new a(t,{...o,series:s}),A.status.render()),ee(n,e)}catch(a){console.error("⚠️ [reports] Failed to render status chart",a),ee(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function vr(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(t){if(ut=Array.isArray(e)?e:[],!e||e.length===0){A.payment&&(A.payment.destroy(),A.payment=null),ee(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Bt();if(!a){ee(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=e.map(i=>Math.max(0,i.value||0)),r=e.map(i=>i.label),o={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(i,l,c)=>{if(c?.dataPointIndex!=null){const u=ut[c.dataPointIndex];u?.filterKey&&cr(u.filterKey)}}}},theme:{mode:Ve()},labels:r,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},tooltip:{y:{formatter:(i,l)=>{const c=ut?.[l?.seriesIndex||0],u=c?`${x(c.percent)}%`:`${x(i)}%`;return`${x(c?c.rawCount??c.value??0:i)} / ${u}`}}}};A.payment?(A.payment.updateOptions({...o},!0,!0),A.payment.updateSeries(s,!0)):(t.innerHTML="",A.payment=new a(t,{...o,series:s}),A.payment.render()),ee(n,e)}catch(a){console.error("⚠️ [reports] Failed to render payment chart",a),ee(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}function ee(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}n.innerHTML=t.map(a=>{const s=Math.min(Math.max(a.percent??0,0),100),r=b("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",x(a.rawCount??a.value??0)),o=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${P(a.label)}</span>
            <span class="reports-progress-value">${x(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${o}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}function Sr(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${Dt(n.name)}">
        <td>${P(n.name)}</td>
        <td>${x(n.count)}</td>
        <td>${H(n.revenue)}</td>
      </tr>
    `).join("")}}function Er(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${Dt(n.name)}">
        <td>${P(n.name)}</td>
        <td>${x(n.count)}</td>
        <td>${H(n.revenue)}</td>
      </tr>
    `).join("")}}function Tr(e,t,n){const a=e?.reservationId||e?.id||"—",s=E(String(a)),o=t.get(String(e?.customerId))?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),i=we(e),l=wr(i.statusValue),c=Ar(i.statusValue,l),u=Lr(i.paid),m=_r(e?.start),p=$e(e),f=H(p.finalTotal),g=p.companySharePercent>0?`${x(p.companySharePercent)}% (${H(p.companyShareAmount)})`:b("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),S=H(p.netProfit),v=P(o),k=o;return{code:{html:P(s),text:s},customer:{html:v,text:k},date:{html:P(m),text:m},status:c,payment:u,total:{html:P(f),text:f},share:{html:P(g),text:g},net:{html:P(S),text:S}}}function kn(e){return e?b("reservations.reports.payment.paidLabel","مدفوعة","Paid"):b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function wr(e){switch(e){case"completed":return He(b("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return He(b("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return He(b("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return E(e||"—")}}function Ar(e,t){const n=He(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${P(n)}</span>`,text:n}}function Lr(e){const t=kn(e);return{html:`<span class="reservation-chip status-${e?"paid":"unpaid"}">${P(t)}</span>`,text:t}}function He(e){return E(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function _r(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=Mt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return E(a.format(t))}function xr(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-kpi-confirmed"),o=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),l=document.getElementById("reports-kpi-paid-meta"),c=e.total||0,u=e.revenue||0,m=e.confirmed||0,p=e.paidCount||0,f=e.average||0,g=e.companyShareTotal||0,S=e.netProfit||0,v=c?Math.round(m/c*100):0,k=c?Math.round(p/c*100):0;if(t&&(t.textContent=x(c)),n){const T=b("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",x(e.completed||0));n.textContent=T}if(a&&(a.textContent=H(u)),s){const T=b("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");s.textContent=T.replace("{net}",H(S)).replace("{share}",H(g)).replace("{average}",H(f))}if(r&&(r.textContent=`${v}%`),o){const T=b("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",x(m));o.textContent=T}if(i&&(i.textContent=`${k}%`),l){const T=b("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",x(p));l.textContent=T}}function Cr(e){ht({active:!!e})}function P(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Dt(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function x(e){const{numberFormatter:t}=Na(),n=t.format(Math.round(e||0));return E(n)}function H(e){return`${x(e)} SR`}function Ye(e){return(e||"").toString().trim()}const Ir=Q()||{};let ue=(Ir.maintenance||[]).map(Mn);function Qe(){return ue}function Ze(e){return ue=Array.isArray(e)?e.map(Mn):[],Zn({maintenance:ue}),jr(),ue}async function kr(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,o])=>{o!=null&&o!==""&&t.set(r,String(o))});const n=t.toString(),a=await K(`/maintenance/${n?`?${n}`:""}`),s=Array.isArray(a?.data)?a.data.map(Rt):[];return Ze(s)}async function Mr(e){const t=await K("/maintenance/",{method:"POST",body:e}),n=Rt(t?.data??{});return Ze([n,...ue.filter(a=>a.id!==n.id)]),n}async function qr(e,t){const n=await K(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Rt(n?.data??{});return Ze(ue.map(s=>String(s.id)===String(e)?a:s)),a}async function Br(e){await K(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Ze(ue.filter(t=>String(t.id)!==String(e)))}function $r({equipmentId:e,technicianId:t,issue:n,priority:a,status:s,scheduledAt:r,resolutionReport:o}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:s,notes:n??"",resolution_report:null}}function Rt(e={}){return qn({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function Mn(e={}){return qn(e)}function qn(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Dr(e.status_raw??e.status??"open"),s=Rr(a),r=Fr(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:Nr(e.priority??"medium"),status:s,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Dr(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Rr(e){const t=Bn(e);return["completed","cancelled"].includes(t)?"closed":"open"}function Nr(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Fr(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function Bn(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function jr(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function Me(e){return e instanceof dn}function St(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getFullYear()).slice(-2);return`${n}/${a}/${s}`}let me=Qe(),de=[],Ie=null,ve=!1,ke="",Se=me.length>0,ce={id:null,equipmentDesc:"",equipmentBarcode:""},Nt=null,B=null,G=null,Ee=null,$n=null,Te=null;async function qe({showToastOnError:e=!0}={}){if(!ve){ve=!0,ke="",Y();try{await kr(),Se=!0}catch(t){Se=me.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),ke=Me(t)?t.message:d("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&L(ke,"error")}finally{ve=!1,me=Qe(),Y()}}}function Et(){return d("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function X(e){return E(String(e||"")).trim().toLowerCase()}function Dn(e=""){return E(String(e)).trim().toLowerCase()}function Pr(e={}){const t=String(e?.desc??"").trim(),n=E(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function Hr(e){const t=E(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Rn(e){return E(String(e||"")).trim().toLowerCase()}function C(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Or(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function te(){return me=Qe(),me}function Nn(e){return te().find(n=>Number(n.id)===Number(e))||null}function Fn(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function Ft(){const{equipment:e=[]}=Q(),t=d("maintenance.table.noName","بدون اسم");return de=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),s=X(a),r=Number.parseInt(n?.qty??n?.quantity??0,10),o=Number.isFinite(r)?Math.max(r,0):1,i=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"متاح",c=n?.desc||n?.description||n?.name||t,u=Pr({desc:c,displayBarcode:a,barcode:s});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:s,displayBarcode:a,desc:c,status:l,statusNormalized:Fn(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:o,image:i,searchValue:u,searchValueNormalized:Rn(u),descriptionNormalized:Dn(c)}}),de.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),de}function jt(){const e=new Set,t=new Map;return te().filter(n=>n.status==="open").forEach(n=>{const a=X(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function jn(e){const t=X(e);if(!t)return 0;const{map:n}=jt();return n.get(t)||0}function Je(e){const t=X(e);return t&&(de.length?de:Ft()).find(a=>a.barcode===t)||null}function zr(e){const t=de.length?de:Ft();if(!t.length)return null;const n=Rn(e);if(n){const i=t.find(l=>l.searchValueNormalized===n);if(i)return i}const{description:a,barcode:s}=Hr(e);if(s){const i=X(s);if(i){const l=t.find(c=>c.barcode===i);if(l)return l}}const r=Dn(a||e);if(!r)return null;const o=t.find(i=>i.descriptionNormalized===r);return o||t.find(i=>i.descriptionNormalized.includes(r))||null}function Tt(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,r=(t||jt().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||r>=1:r>=a}function se({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),s&&(s.value="")),r&&(r.textContent=Et(),r.classList.remove("maintenance-selected-info--has-selection")),Ie=null}function Pn(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=d("maintenance.info.barcodeLabel","باركود"),a=d("maintenance.report.notAvailable","غير متوفر"),s=d("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),r=d("maintenance.info.categoryLabel","القسم"),o=e.displayBarcode||e.barcode||a,i=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,c=jn(i),u=Math.max(l-c,0),m=e.category?`
    <div class="maintenance-selected-info__meta">${r}: <strong>${C(e.category)}</strong></div>
  `:"",p=l>0?`
    <div class="maintenance-selected-info__meta">
      ${s}: <strong>${u}</strong> / ${l}
    </div>
  `:"",f=e.image?`<img class="maintenance-selected-info__image" src="${C(e.image)}" alt="${C(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${f}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${C(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${C(o)}</strong></div>
      ${p}
      ${m}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function Pt(e,{silent:t=!1}={}){if(!e)return!1;if(Tt(e))return t||L(d("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),s&&(s.value=e.searchValue||e.desc),Pn(e),Ie=e,!0}function Hn(e,{showFeedback:t=!0}={}){const n=Je(e);return n?Pt(n,{silent:!t}):(t&&L(d("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function On(e,{showFeedback:t=!0}={}){const n=zr(e);return n?Pt(n,{silent:!t}):(t&&L(d("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function Ht(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=Ft(),{map:s}=jt();e&&(e.innerHTML=a.map(o=>`<option value="${C(o.searchValue||o.desc)}"></option>`).join(""));const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const o=Je(r.value);!o||Tt(o,s)?(se({keepInputs:!0,silent:!0}),o&&Tt(o,s)&&L(d("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):Pt(o,{silent:!0})}else se({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),Hn(t.value)||se({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const o=()=>{if(!n.value){se({keepInputs:!0,silent:!0});return}On(n.value)||se({keepInputs:!0,silent:!0})};n.addEventListener("change",o),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),o())}),n.dataset.listenerAttached="true"}}async function Ge(){try{await ba({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{It(),Ht()}}function zn(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;Nt=t.Modal.getOrCreateInstance(e),B||(B=e.querySelector("#maintenance-close-report")),G||(G=e.querySelector("#maintenance-close-submit")),Ee||(Ee=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",Ur),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Vn),e.dataset.listenerAttached="true"),!0}function Vn(){ce={id:null,equipmentDesc:"",equipmentBarcode:""},B&&(B.value=""),Ee&&(Ee.innerHTML=""),Be(!1)}function Un(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?($n=t.Modal.getOrCreateInstance(e),Te||(Te=e.querySelector("#maintenance-report-modal-content")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Yn),e.dataset.listenerAttached="true"),!0):!1}function Yn(){Te&&(Te.innerHTML="")}function Be(e){if(!G)return;const t=d("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),n=d("maintenance.closeModal.confirm","إغلاق التذكرة");e?(G.disabled=!0,G.dataset.loading="true",G.textContent=t):(G.disabled=!1,G.removeAttribute("data-loading"),G.textContent=n)}function Vr(e){const t=Nn(e);if(!t){L(d("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!zn()){const n=prompt(d("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(n===null)return;const a=n.trim();if(!a){L(d("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}Gn(e,a);return}if(ce={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},B&&(B.value=t.resolutionReport||""),Ee){const n=d("maintenance.report.barcode","الباركود"),a=d("maintenance.report.notAvailable","غير متوفر"),s=ce.equipmentDesc||a,r=ce.equipmentBarcode?E(ce.equipmentBarcode):a;Ee.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${s}</div>
          <div class="maintenance-close-modal__ticket-meta">${n}: <span>${r}</span></div>
        </div>
      </div>
    `}Be(!1),Nt?.show(),setTimeout(()=>{B?.focus(),B?.setSelectionRange(B.value.length,B.value.length)},150)}async function Ur(e){if(e?.preventDefault(),!ce.id){L(d("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!B)return;const t=B.value.trim();if(!t){L(d("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),B.focus();return}Be(!0),(await Gn(ce.id,t)).success?Nt?.hide():Be(!1)}function Yr(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(m=>m.status==="open").length,s=n-a,r=m=>E(String(m)),o=d("maintenance.stats.summaryTitle","ملخص الصيانة"),i=d("maintenance.filters.status.open","قيد الصيانة"),l=d("maintenance.filters.status.closed","مغلقة"),c=d("maintenance.stats.totalLabel","إجمالي التذاكر"),u=(m,p,f)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${f}">
      <span class="maintenance-summary__value">${r(m)}</span>
      <span class="maintenance-summary__label">${p}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${o}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${u(a,i,"open")}
        ${u(s,l,"closed")}
        ${u(n,c,"total")}
      </div>
    </section>
  `}function Gr(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Bn(n)||"open",s={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},r=s[a]??s.open,o=r?d(r.key,r.fallback):d("maintenance.status.open","قيد الصيانة"),i=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():o,l=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&l.push(r.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${i}</span>`}function Kr(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=d("maintenance.empty.title","لا توجد تذاكر صيانة"),s=d("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${s}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const s=Gr(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",o=(()=>{const k=d("maintenance.priority.high","مرتفعة"),T=d("maintenance.priority.medium","متوسطة"),z=d("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${k}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${z}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${T}</span>`}})(),i=[],l=d("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),c=d("maintenance.actions.view","👁️ عرض التقرير"),u=d("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?i.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):i.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${c}</button>`),Ct()&&i.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${u}</button>`);const m=i.join(""),p=d("maintenance.table.noBarcode","بدون باركود"),f=d("maintenance.report.none","—"),g=a.equipmentBarcode?E(a.equipmentBarcode):p,S=a.issue?E(a.issue):f,v=a.createdAt?E(St(a.createdAt)||_e(a.createdAt)):"—";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${g}</small>
          </td>
          <td class="maintenance-issue-text">${S}</td>
          <td>${o}</td>
          <td>${v}</td>
          <td>${s}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${m}
            </div>
          </td>
        </tr>
      `}).join("")}}function Wr(e){if(!Se||ve){L(d("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Vr(a);else if(n==="view")Xr(a);else if(n==="delete"){if(!Ct()){mn();return}Qr(a).catch(s=>{console.error("❌ [maintenance] deleteTicket failed",s)})}}}async function Gn(e,t){const n=Nn(e);if(!n)return L(d("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const a=(t??"").trim();if(!a)return L(d("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const s=Or(new Date)||new Date().toISOString();try{await qr(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:s}),await qe({showToastOnError:!1});const r=document.getElementById("maintenance-status-filter");return r&&r.value==="open"&&(r.value="all"),await Ge(),Y(),L(d("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(r){if(console.error("❌ [maintenance] closeTicket failed",r),Me(r)&&r.status===404)return await qe({showToastOnError:!1}),await Ge(),Y(),L(d("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const o=Me(r)?r.message:d("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return L(o,"error"),{success:!1,error:r}}}function Xr(e){const n=te().find(v=>Number(v.id)===Number(e));if(!n)return;if(!Un()){const v=d("maintenance.report.equipment","المعدة"),k=d("maintenance.report.barcode","الباركود"),T=d("maintenance.report.issue","الوصف"),z=d("maintenance.report.createdAt","تاريخ الإنشاء"),V=d("maintenance.report.closedAt","تاريخ الإغلاق"),Ae=d("maintenance.report.summary","التقرير"),Z=d("maintenance.report.notAvailable","غير متوفر"),U=d("maintenance.report.none","—"),y=[`${v}: ${n.equipmentDesc}`,`${k}: ${n.equipmentBarcode?E(n.equipmentBarcode):Z}`,`${T}: ${n.issue?E(n.issue):U}`,`${z}: ${n.createdAt?E(St(n.createdAt)||_e(n.createdAt)):U}`,`${V}: ${n.resolvedAt?E(_e(n.resolvedAt)):U}`,`${Ae}: ${n.resolutionReport?E(n.resolutionReport):U}`].join(`
`);alert(y);return}const a=d("maintenance.report.equipment","المعدة"),s=d("maintenance.report.barcode","الباركود"),r=d("maintenance.report.issue","الوصف"),o=d("maintenance.report.createdAt","تاريخ الإنشاء"),i=d("maintenance.report.closedAt","تاريخ الإغلاق"),l=d("maintenance.report.summary","التقرير"),c=d("maintenance.report.notAvailable","غير متوفر"),u=d("maintenance.report.none","—"),m=[{label:a,value:`<span class="maintenance-report-modal__value">${C(n.equipmentDesc||u)}</span>`},{label:s,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${C(E(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${C(c)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${C(E(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${C(u)}</span>`},{label:o,value:n.createdAt?`<span class="maintenance-report-modal__value">${C(E(St(n.createdAt)||_e(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${C(u)}</span>`},{label:i,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${C(E(_e(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${C(u)}</span>`}],p=n.resolutionReport?E(n.resolutionReport):"",f=p?`<p>${C(p).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${C(u)}</p>`,g=m.map(v=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${C(v.label)}</span>
        ${v.value}
      </div>
    `).join(""),S=`
    <div class="maintenance-report-modal__summary">
      <h6>${C(l)}</h6>
      ${f}
    </div>
  `;Te&&(Te.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${g}
        </div>
        ${S}
      </div>
    `),$n?.show()}async function Qr(e){if(!Ct()){mn();return}if(!te().find(a=>Number(a.id)===Number(e))){L(d("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(d("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Br(e),await qe({showToastOnError:!1}),await Ge(),L(d("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const s=Me(a)?a.message:d("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");L(s,"error")}}async function Zr(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let o=Ie,i=X(a?.value);if(!o&&i&&(o=Je(i)),!o&&t?.value&&Hn(t.value,{showFeedback:!0})&&(o=Ie,i=X(o?.barcode)),!o&&n?.value&&On(n.value,{showFeedback:!0})&&(o=Ie,i=X(o?.barcode)),!o||!i){L(d("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=Q();let c=(l||[]).find(v=>X(v?.barcode)===i);if(!c&&o&&(c={id:o.id,barcode:o.barcode,desc:o.desc,name:o.desc,status:o.status||"متاح",quantity:o.quantity,qty:o.quantity}),!c||c.id==null){L(d("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),se();return}const u=Number.parseInt(c.qty??c.quantity??o?.quantity??1,10),m=Number.isFinite(u)&&u>0?u:1,p=jn(i);if(Fn(c.status||o?.status)==="maintenance"&&m<=1){L(d("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(p>=m){L(d("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const g=$r({equipmentId:c.id,technicianId:null,issue:s?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Mr(g),await qe({showToastOnError:!1}),await Ge(),L(d("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),se(),s&&(s.value=""),r&&(r.value="medium");const S=document.getElementById("maintenance-status-filter");S&&(S.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=Me(t)?t.message:d("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");L(n,"error")}}function Jr(e){const t=te();return e==="all"?t:t.filter(n=>n.status===e)}function Y(){const e=te();Ht(),Yr(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),s=document.getElementById("maintenance-empty-state");if(!a)return;if(ve&&!Se){const o=d("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${o}</td></tr>`,s&&s.classList.remove("active");return}if(ke&&!Se){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${ke}</td></tr>`,s&&s.classList.remove("active");return}const r=Jr(n);Kr(r)}function es(){te(),Ht(),Se=me.length>0,ve=!1,Y(),qe({showToastOnError:!1}),zn()&&Vn(),Un()&&Yn();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Zr(a).catch(s=>{console.error("❌ [maintenance] submit handler failed",s)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{Y()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Wr),n.dataset.listenerAttached="true")}te();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=Je(e.value);n?Pn(n):t&&(t.textContent=Et())}else t&&(t.textContent=Et());Y(),Be(!1)});document.addEventListener(Jn.USER_UPDATED,()=>{Y()});window.addEventListener("maintenance:updated",()=>{me=Qe(),Y()});const wt="__ART_RATIO_LAST_DASHBOARD_TAB__",W="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Ke="create-tab",Kn=/^[a-z0-9\-]+$/i;function At(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function oe(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!Kn.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function Lt(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!Kn.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function Wn(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let ae=null,N=null,ie=!1,q=null,on=null,le=null,_t=null,pe=null;function ts(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(r,{skipStore:o=!1,skipRender:i=!1}={})=>{if(!r)return;const l=e.filter(u=>u?.getAttribute("data-tab")===r),c=document.getElementById(r);if(!(!l.length||!c)&&(e.forEach(u=>{const m=u?.getAttribute("data-tab")===r;u.classList.toggle("active",m),m?(u.setAttribute("aria-selected","true"),u.setAttribute("tabindex","0"),At(u)):(u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1"))}),t.forEach(u=>{const m=u.id===r;u.style.display=m?"block":"none",u.classList.toggle("active",m)}),ae=r,Lt(wt,r),o||xe({dashboardTab:r}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",u)}),r!=="reservations-tab"&&(N=null,q=null,Wn(W),o||xe({dashboardSubTab:null}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",u)})),!i&&r==="customers-tab"&&(console.log("👤 Rendering customers"),ia()),!i&&r==="equipment-tab"&&(console.log("📦 Rendering equipment"),It()),!i&&r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),Y()),!i&&r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Ea()),r==="reservations-tab")){if(console.log("📅 Rendering reservations"),i||fn(),!q){const u=oe(W);q=N||u||Ke}ns(),q&&(De(q),q=null)}};_t=n,e.forEach(r=>{r&&(r.getAttribute("type")||r.setAttribute("type","button"),r.setAttribute("role","tab"),r.hasAttribute("tabindex")||r.setAttribute("tabindex",r.classList.contains("active")?"0":"-1"),r.addEventListener("click",()=>{const o=r.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",o),n(o),o==="reservations-tab"){const i=N||oe(W)||Ke;typeof le=="function"?le(i):q=i}else xe({dashboardSubTab:null}).catch(i=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",i)})}))});const a=r=>{const o=document.querySelector("[data-tab].active"),i=oe(wt),l=e[0]?.getAttribute("data-tab")||null,u=[r?.dashboardTab,i,ae,o?.getAttribute("data-tab"),l].filter(Boolean).find(f=>document.getElementById(f))||l;u&&(!ie||u!==ae)&&(console.log("⭐ Initial tab:",u),n(u,{skipStore:!0}));const p=[r?.dashboardSubTab,oe(W)].filter(Boolean).find(f=>document.getElementById(f));p&&(ae==="reservations-tab"&&typeof le=="function"?(!ie||p!==N)&&le(p,{skipStore:!0}):q=p),ie||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),ie=!0)},s=typeof Oe=="function"?Oe():null;a(s||null),ea().then(r=>a(r||null)).catch(r=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",r),a(null)}),on||(on=ta(r=>{if(!(!ie||!r))if(r.dashboardTab&&r.dashboardTab!==ae&&n(r.dashboardTab,{skipStore:!0}),ae==="reservations-tab"){if(r.dashboardSubTab&&r.dashboardSubTab!==N)De(r.dashboardSubTab);else if(!r.dashboardSubTab&&N){const o=oe(W);o?o!==N&&De(o):De(null)}}else r.dashboardSubTab&&(q=r.dashboardSubTab)}))}function ns(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(Ke)?Ke:n[0]:null,s=(r,{skipStore:o=!1}={})=>{if(!n.length)return;let i=r;(!i||!n.includes(i))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:i,available:n}),i=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${i}"]`),c=document.getElementById(i);if(!l||!c){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:i});return}if(N===i&&l.classList.contains("active")&&c.classList.contains("active")&&c.getAttribute("aria-hidden")==="false"){c.removeAttribute("hidden"),c.style.display="block",c.setAttribute("aria-hidden","false"),N=i,At(l),o||(Lt(W,i),xe({dashboardSubTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}));return}e.forEach(m=>{m.classList.remove("active"),m.classList.contains("tab")&&m.classList.remove("tab-active"),m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),At(l),t.forEach(m=>{const p=m.id===i;m.classList.toggle("active",p),m.setAttribute("aria-hidden",p?"false":"true"),p?(m.removeAttribute("hidden"),m.style.display="block"):(m.setAttribute("hidden",""),m.style.display="none")}),N=i,Lt(W,i),o||xe({dashboardSubTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}),i==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{fn()},50)):i==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{We()},100)):i==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{I()},50))};if(le=(r,o={})=>{r?s(r,o):(e.forEach(i=>{i.classList.remove("active"),i.classList.contains("tab")&&i.classList.remove("tab-active"),i.setAttribute("aria-selected","false"),i.setAttribute("tabindex","-1")}),t.forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden",""),i.style.display="none"}),N=null,Wn(W))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const o=r.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",o),s(o)}),r.dataset.subTabListenerAttached="true")}),q)s(q,{skipStore:!0}),q=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),o=a(),i=r?.getAttribute("data-sub-tab")||o;i&&(console.log("⭐ Initial sub-tab:",i),s(i,{skipStore:!0}))}bn()}function De(e){typeof le=="function"?le(e,{skipStore:!0}):e&&(q=e)}function as(){try{if(typeof Oe=="function")return Oe()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function rs({attemptsLeft:e=0}={}){if(!ie||typeof _t!="function")return!1;const t=as(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[ae,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,oe(wt),a].filter(Boolean).find(i=>document.getElementById(i));if(!r)return!1;const o=()=>{const i=document.querySelector(`[data-tab].active[data-tab="${r}"]`),l=document.getElementById(r);return!!(i&&l?.classList.contains("active")&&l?.style.display!=="none")};if(r==="reservations-tab"){const i=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!i.length)return!1;const l=i[0]?.getAttribute("data-sub-tab")||null,u=[N,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,oe(W),l].filter(Boolean).find(g=>document.getElementById(g)),m=document.querySelector("#reservations-tab .sub-tab-button.active"),p=document.querySelector("#reservations-tab .sub-tab.active"),f=p?.id||m?.getAttribute("data-sub-tab")||null;if(u&&f===u&&o())return p&&(p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false")),!0;if(u)q=u;else if(e>0)return!1}else if(o())return!0;return _t(r,{skipStore:!0,skipRender:!0}),!0}function Ot(){if(!ie)return;let e=0;const t=5;pe&&(clearTimeout(pe),pe=null);const n=()=>{if(rs({attemptsLeft:t-e})){pe=null;return}if(e>=t){pe=null;return}e+=1,pe=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",Ot);document.addEventListener("language:changed",Ot);document.addEventListener("theme:changed",Ot);const Re={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let xt=!1;const ss=1632,os=1776;function is(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-ss)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-os)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function cs(e){try{const t=is(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function Ne(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=cs(t))}function cn(){xt=!1;const e=Q(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,s=Array.isArray(e.technicians)?e.technicians.length:0;Re.projects.forEach(r=>Ne(r,t)),Re.reservations.forEach(r=>Ne(r,n)),Re.equipment.forEach(r=>Ne(r,a)),Re.technicians.forEach(r=>Ne(r,s))}function ln(){xt||(xt=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(cn):setTimeout(cn,16))}function ls(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,ln,{passive:!0})}),ln()}na();let R=null;async function un(){if(!await aa())return;oa(),ts(),ls(),ra(),It(),ha(),We(),es(),Ya(),va(),bn();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await ga(s),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",sa),us(),ds()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{un().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):un().catch(e=>{console.error("❌ Failed to initialise app",e)});function us(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[s]=a.split(":"),r=`${s.padStart(2,"0")}:00`,o=`${n}T${r}`;e.value!==o&&(e.value=o,setTimeout(()=>e.blur(),150))})})}function ds(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;R={reservationId:t,reservationIndex:n!=null?Number(n):null},Xn(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,s)}function Xn(){if(!R)return;const t=Q().reservations||[];let n=null;if(R.reservationId){const a=t.findIndex(s=>String(s?.id)===R.reservationId||String(s?.reservationId)===R.reservationId);a!==-1&&(n=a)}n===null&&typeof R.reservationIndex=="number"&&!Number.isNaN(R.reservationIndex)&&R.reservationIndex>=0&&R.reservationIndex<t.length&&(n=R.reservationIndex),n!==null&&(R=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const s=window.editReservation;typeof s=="function"&&s(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{R&&Xn()});
