import{t as u,e as Z,d as re,n as v,b as ee,A as En,s as la,f as da,h as A,j as He,k as Ne,o as Pt,u as $e,p as Qe,q as ua,r as ma,a as pa,c as fa,i as ba,l as ha}from"./auth.js";import{i as ga}from"./dashboardShell.js";import{r as ya}from"./customers.js";import{e as va,b as Sa,r as Tn,n as Ea,i as Ta,a as wa,c as jt,d as wn,f as Aa,l as Ca,u as La}from"./controller.js";import{s as An}from"./events.js";import{i as _a,g as wt,s as xa,m as Ia,b as Cn,c as Ma,D as ka,d as Na}from"./reservationsService.js";const $a={limit:200};let M=null,Zt=!1,Jt=!1,en=!1,tn=!1,ut=null,mt=null,pt=!1,me="";const qa=[{key:"confirmed",chipClass:"reservation-chip status-confirmed"},{key:"pending",chipClass:"reservation-chip status-pending"},{key:"paid",chipClass:"reservation-chip status-paid"},{key:"unpaid",chipClass:"reservation-chip status-unpaid"},{key:"completed",chipClass:"reservation-chip status-completed"}],Ba={confirmed:"حجز مؤكد",pending:"بانتظار التأكيد",paid:"مدفوع بالكامل",unpaid:"لم يتم الدفع",completed:"منتهي"},Da={confirmed:"Confirmed reservation",pending:"Awaiting confirmation",paid:"Paid in full",unpaid:"Payment pending",completed:"Completed"},ft=new Map;function oe(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ht(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Ra(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function Fa(e){return ft.has(e)||ft.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),ft.get(e)}function Pa(e,t,n=!1){if(n){const d=(Z?.()==="en"?"en":"ar")==="en"?"All day":"طوال اليوم";return u("calendar.labels.allDay",d)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const o=Z?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",r=Fa(o),i=r.format(a);if(!t)return i;const s=new Date(t);if(Number.isNaN(s.getTime()))return i;const l=r.format(s);return i===l?i:`${i} – ${l}`}function ja({paid:e,confirmed:t,completed:n}){const a=["calendar-event"];return(n===!0||n==="true")&&a.push("calendar-event--completed"),t===!0||t==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function Ln(){const e=document.getElementById("calendar-legend");if(!e)return;const t=Z?.()==="en"?"en":"ar";e.innerHTML=qa.map(({key:n,chipClass:a})=>{const o=t==="en"?Da[n]??n:Ba[n]??n,r=oe(u(`calendar.legend.${n}`,o));return`<span class="calendar-legend__item" role="listitem"><span class="${a} calendar-legend__chip">${r}</span></span>`}).join("")}function Te(){const{calendarEl:e}=Ht();if(!e)return;const t=e.querySelector(".fc-header-toolbar");if(!t)return;t.classList.add("calendar-toolbar"),t.querySelectorAll(".fc-toolbar-chunk").forEach(a=>{a.classList.add("calendar-toolbar__chunk")});const n=t.querySelector(".fc-toolbar-title");n&&n.classList.add("calendar-toolbar__title"),t.querySelectorAll(".fc-button").forEach(a=>{a.classList.add("calendar-toolbar__button")})}function we({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:o}=Ht();if(!a||!o)return;const r=typeof t=="string"?t.trim().length>0:!!t,i=!e&&!r&&!!n,s=e||r||i;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",i),o.dataset.initialized||(o.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),o.dataset.initialized="true"),o.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),o.classList.toggle("hidden",!s),!s){o.innerHTML="",o.removeAttribute("data-status");return}let l="";e?l=u("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):r?l=typeof t=="string"&&t.trim().length>0?t:u("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):i&&(l=u("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const c=e?"loading":r?"error":"empty";if(o.setAttribute("data-status",c),o.classList.add(`calendar-status-card--${c}`),o.innerHTML="",e){const m=document.createElement("span");m.className="loading loading-spinner loading-md text-primary",m.setAttribute("aria-hidden","true"),o.appendChild(m)}else{const m=document.createElement("span");m.className="calendar-status-card__icon",m.setAttribute("aria-hidden","true"),m.textContent=r?"⚠️":"🗓️",o.appendChild(m)}const d=document.createElement("span");d.className="calendar-status-card__message text-center text-sm font-semibold",d.textContent=l,o.appendChild(d)}function bt(){M&&(M.destroy(),M=null)}function Ha(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const o=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:o==="paid",{effectiveConfirmed:i}=Tn(e,t),s=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let c=!!e.completed;if(!c&&a){const d=new Date(a);Number.isNaN(d.getTime())||(c=d<new Date)}return{id:e.id??s??n,start:n,end:a||n,paid:r,confirmed:i,completed:c,reservationId:s??"",customerName:l,raw:e}}function _n(e=[]){const{projects:t=[]}=re(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const o=a?.projectId??a?.project_id??null,r=o!=null&&o!==""&&n.get(String(o))||null,i=Ha(a,r);if(!i)return null;const s=ja({paid:i.paid,confirmed:i.confirmed,completed:i.completed});return{id:i.id,title:"",start:i.start,end:i.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:s,extendedProps:{...a,raw:a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}function nn(){return{today:u("calendar.buttons.today","اليوم"),month:u("calendar.buttons.month","شهر"),week:u("calendar.buttons.week","أسبوع"),day:u("calendar.buttons.day","يوم")}}async function za(){if(pt)return wt();pt=!0,me="";try{await va({suppressError:!1,params:$a})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),me=_a(e)?e.message:e instanceof Error&&e.message||""}finally{pt=!1}return wt()}function xn(e){M&&M.batchRendering(()=>{M.removeAllEvents(),M.addEventSource(e)})}function In(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Mn(){const e=wt(),t=_n(e);if(!M){rt();return}M.setOption("locale",Z()),xn(t),qe(),we({loading:!1,error:"",empty:t.length===0}),In(t),Ln(),Te()}function Oa(){Zt||(document.addEventListener("language:changed",()=>{M&&M.setOption("locale",Z()),rt()}),Zt=!0),Jt||(document.addEventListener("reservations:changed",()=>{Mn()}),Jt=!0)}function kn(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function qe(){if(!M)return;const e=kn();M.view?.type!==e&&M.changeView(e),M.updateSize()}function Va(){en||typeof window>"u"||(window.addEventListener("resize",()=>{qe()}),en=!0)}function Ua(){if(tn||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{mt&&clearTimeout(mt),mt=setTimeout(()=>{M&&Mn()},80)};ut=new MutationObserver(e),ut.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&ut.observe(document.body,{attributes:!0,attributeFilter:["class"]}),tn=!0}function Ya(e){const{reservationId:t,customerName:n,paid:a,confirmed:o,completed:r}=e.event.extendedProps,i=a===!0||a==="paid",s=o===!0||o==="true",l=r===!0||r==="true",c=document.createElement("div");c.className="calendar-event-wrapper";const d=s?u("calendar.badges.confirmed","مؤكد"):u("calendar.badges.pending","غير مؤكد"),m=i?u("calendar.badges.paid","مدفوع"):u("calendar.badges.unpaid","غير مدفوع"),p=u("calendar.badges.completed","منتهي"),f=u("calendar.labels.unknownCustomer","غير معروف"),g=[`<span class="reservation-chip calendar-chip ${s?"status-confirmed":"status-pending"}">${oe(d)}</span>`,`<span class="reservation-chip calendar-chip ${i?"status-paid":"status-unpaid"}">${oe(m)}</span>`];l&&g.push(`<span class="reservation-chip calendar-chip status-completed">${oe(p)}</span>`);const S=Pa(e.event.startStr,e.event.endStr,e.event.allDay),y=oe(S||""),R=oe(t||"—"),L=oe(n||f),$=y?`<span class="calendar-event-card__time">${y}</span>`:"";return c.innerHTML=`
    <article class="calendar-event-card">
      <header class="calendar-event-card__head">
        ${$}
        <span class="calendar-event-card__id">${R}</span>
      </header>
      <div class="calendar-event-card__customer">${L}</div>
      <div class="calendar-event-card__chips">${g.join("")}</div>
    </article>
  `,{domNodes:[c]}}function Ga(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(u("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=re()||{},{reservations:a=[],customers:o=[],projects:r=[],technicians:i=[]}=n,s=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},l=[s.id,s.reservationId,s.reservation_id,s.reservationCode,s.reservation_code].map(E=>E==null?"":String(E)).filter(E=>E.length>0);let c=-1,d=null;l.length>0&&(c=a.findIndex(E=>{const H=[E?.id,E?.reservationId,E?.reservation_id,E?.reservationCode,E?.reservation_code].map(O=>O==null?"":String(O)).filter(O=>O.length>0);return H.length===0?!1:H.some(O=>l.includes(O))}),c>=0&&(d=a[c]));const m=d?{...d,...s}:s,p=m.projectId??m.project_id??null,f=p!=null&&r.find(E=>String(E.id)===String(p))||null,g=m.customerId??m.customer_id,S=o.find(E=>String(E.id)===String(g)),y=xa(),R=[...Array.isArray(y)?y:[],...Array.isArray(i)?i:[]],L=new Map;R.forEach(E=>{if(!E||E.id==null)return;const H=String(E.id),O=L.get(H)||{};L.set(H,{...O,...E})});const $=Array.from(L.values());let w="";try{w=Sa(m,S,$,c>=0?c:0,f)}catch(E){console.error("❌ [calendar] Failed to build reservation details for calendar modal",E),t.innerHTML=`<p class="text-sm text-error">${oe(u("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"))}</p>`;return}t.innerHTML=w,t.classList.add("calendar-reservation-details"),t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(E=>{E instanceof HTMLElement&&(E.setAttribute("disabled","true"),E.setAttribute("aria-disabled","true"),E.setAttribute("tabindex","-1"))});const W=t.querySelector('[data-action="open-project"]');W&&(f?W.addEventListener("click",()=>{const E=f?.id!=null?String(f.id):"",H=E?`projects.html?project=${encodeURIComponent(E)}`:"projects.html";window.location.href=H}):W instanceof HTMLElement&&W.setAttribute("disabled","true"));const I=document.getElementById("calendarReservationModal");I&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(I).show():alert(u("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function rt(){Oa(),Va(),Ua();const{calendarEl:e}=Ht();if(!e)return;const t=Ra();if(!t||typeof t.Calendar!="function"){const n=u("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");we({error:n}),bt();return}(async()=>{we({loading:!0});const n=await za();if(me){const o=u("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");we({loading:!1,error:me||o}),bt();return}const a=_n(n);M?(M.setOption("locale",Z()),M.setOption("buttonText",nn()),xn(a),Te()):(M=new t.Calendar(e,{initialView:kn(),locale:Z(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:nn(),events:a,eventContent:Ya,eventClick(o){Ga(o.event.extendedProps)},windowResize:qe,datesSet(){Te()}}),M.render(),Te()),qe(),In(a),we({loading:!1,error:"",empty:a.length===0}),Ln(),Te(),setTimeout(()=>{qe(),Te()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),me=n instanceof Error&&n.message||me||"";const a=u("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");we({loading:!1,error:me||a}),bt()})}const Wa=re()||{};let ge=(Wa.maintenance||[]).map(Nn);function st(){return ge}function ot(e){return ge=Array.isArray(e)?e.map(Nn):[],la({maintenance:ge}),sr(),ge}async function Ka(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,i])=>{i!=null&&i!==""&&t.set(r,String(i))});const n=t.toString(),a=await ee(`/maintenance/${n?`?${n}`:""}`),o=Array.isArray(a?.data)?a.data.map(it):[];return ot(o)}async function Xa(e){const t=await ee("/maintenance/",{method:"POST",body:e}),n=it(t?.data??{});return ot([n,...ge.filter(a=>a.id!==n.id)]),n}async function Qa(e,t){const n=await ee(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=it(n?.data??{});return ot(ge.map(o=>String(o.id)===String(e)?a:o)),a}async function Za(e){await ee(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),ot(ge.filter(t=>String(t.id)!==String(e)))}function Ja({equipmentId:e,technicianId:t,issue:n,priority:a,status:o,scheduledAt:r,resolutionReport:i}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:o,notes:n??"",resolution_report:null,repair_cost:null}}function it(e={}){return $n({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function Nn(e={}){return $n(e)}function $n(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=tr(e.status_raw??e.status??"open"),o=nr(a),r=rr(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:ar(e.priority??"medium"),status:o,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:er(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function er(e){if(e==null||e==="")return null;const t=Number.parseFloat(v(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function tr(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function nr(e){const t=qn(e);return["completed","cancelled"].includes(t)?"closed":"open"}function ar(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function rr(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,o=>o.toUpperCase())}function qn(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function sr(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function Fe(e){return e instanceof En}let At=null,Ge=null;const h={range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null};let an=!1,rn=!1,Ce=null;const T={reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map};let We=!1,Ze="";const U={icon:null,title:null,subtitle:null};let sn=!1;const ht=new Map;let gt=null,yt=null,vt=null,Le=null;const C={trend:null,status:null,payment:null},se={filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{}},Ct={code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0};let on=!1,cn=!1,ln=!1,Bn=[],St=[],Et=[],dn=!1,K=null,X=null,un=null,mn=null;function b(e,t,n=t){const a=Z()==="en"?n??t:t;return u(e,a)}function pn(){Tt(),k(),setTimeout(()=>{Tt(),k(),Ke()},0),setTimeout(()=>{Tt(),k(),Ke()},60),Ke()}function Ae(){h.range==="custom"&&k()}function Tt(){At=null,Ge=null}function zt(){return(Z()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function or(){const e=Z();if(e!==At||!Ge){At=e;const t=zt();Ge=new Intl.NumberFormat(t,{maximumFractionDigits:0})}return{numberFormatter:Ge}}function ir(e){const t=zt();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function Lt(e){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"";const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${o}`}function Ot(e){if(ht.has(e))return ht.get(e);const t=document.querySelector(`script[src="${e}"]`),n=new Promise((a,o)=>{const r=()=>{t&&(t.dataset.loaded="true"),a()},i=l=>o(l);if(t){if(t.dataset.loaded==="true"){a();return}t.addEventListener("load",r,{once:!0}),t.addEventListener("error",i,{once:!0});return}const s=document.createElement("script");s.src=e,s.async=!0,s.onload=()=>{s.dataset.loaded="true",a()},s.onerror=l=>o(l),document.head.appendChild(s)});return ht.set(e,n),n}function Vt(){return window.ApexCharts?Promise.resolve(window.ApexCharts):(gt||(gt=Ot("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),gt)}function cr(){return window.html2pdf?Promise.resolve(window.html2pdf):(yt||(yt=Ot("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),yt)}function lr(){return window.XLSX?Promise.resolve(window.XLSX):(vt||(vt=Ot("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),vt)}function Je(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function Dn(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Rn(e={}){const t=v(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function Fn(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",o=e?.confirmed===!0||et(a)==="confirmed"||et(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:o}}function dr(){if(typeof re!="function")return!1;let e;try{e=re()}catch(s){return console.warn("⚠️ [reports] Failed to access cached data",s),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:o=[],projects:r=[]}=e;return t.length||n.length||a.length||o.length||r.length?(T.reservations=Array.isArray(t)?t.map(Ia):[],T.customers=Array.isArray(n)?n.map(Dn):[],T.equipment=Array.isArray(a)?a.map(Rn):[],T.technicians=Array.isArray(o)?o.map(Cn):[],T.projects=Array.isArray(r)?r.map(Fn):[],T.projectsMap=new Map(T.projects.map(s=>[s.id,s])),Le=new Map((T.technicians||[]).map(s=>[String(s.id),s])),!0):!1}const ur=1440*60*1e3;function mr(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const o=a.getTime()-n.getTime();return o<=0?1:Math.max(1,Math.ceil(o/ur))}function fn(e){return e?(Le||(Le=new Map((T.technicians||[]).map(t=>[String(t.id),t]))),Le.get(String(e))||null):null}function Pn(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null)continue;const a=Number.parseFloat(v(String(n)));if(Number.isFinite(a))return a}return 0}function pr(e={}){const t=[e.dailyTotal,e.daily_total,e.totalRate,e.total,e.total_wage];for(const n of t){if(n==null)continue;const a=Number.parseFloat(v(String(n)));if(Number.isFinite(a))return a}return Pn(e)}function ze(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;const t=mr(e.start,e.end),a=(e.items||[]).reduce((V,J)=>{const le=Number(J?.qty)||Number(J?.quantity)||1,de=Number(J?.price)||Number(J?.unit_price)||0;return V+le*de},0)*t,o=(e.technicians||[]).reduce((V,J)=>{const le=fn(J);return V+Pn(le)},0),r=(e.technicians||[]).reduce((V,J)=>{const le=fn(J);return V+pr(le)},0),i=o*t,s=r*t,l=a+s,c=Number(e.discount)||0;let m=(e.discountType||e.discount_type||"percent")==="amount"?c:l*(c/100);(!Number.isFinite(m)||m<0)&&(m=0),m>l&&(m=l);const p=Math.max(0,l-m),f=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1",g=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,S=g!=null?Number.parseFloat(v(String(g).replace("%","").trim())):NaN,y=e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null;let R=y!=null?y===!0||y===1||y==="1"||String(y).toLowerCase()==="true":Number.isFinite(S)&&S>0,L=R&&Number.isFinite(S)?Number(S):0;f&&L<=0&&(L=ka,R=!0);let $=L>0?Math.max(0,p*(L/100)):0;$=Number.isFinite($)?Number($.toFixed(2)):0;const w=p+$;let D=f?w*.15:0;(!Number.isFinite(D)||D<0)&&(D=0),D=Number(D.toFixed(2));const W=w+D,I=Number(e.cost);let E=Number.isFinite(W)?Number(W.toFixed(2)):0;if(Number.isFinite(I)&&I>0&&(E=I,f)){const V=E-w;Number.isFinite(V)&&V>=0&&(D=Number(V.toFixed(2)))}const H=Math.max(0,a+s-m),O=Math.max(0,H-i),Oe={rentalDays:t,equipmentTotal:a,crewTotal:s,crewCostTotal:i,discountAmount:m,subtotalAfterDiscount:p,taxableAmount:w,taxAmount:D,finalTotal:E,companySharePercent:L,companyShareAmount:$,netProfit:O};return e.__financials=Oe,Oe}function jn(e){return e?.projectId&&T.projectsMap.get(String(e.projectId))||null}function ke(e){const t=jn(e),n=Tn(e,t),a=et(n.projectStatus);let o=et(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(o=a),(!o||o==="cancelled")&&(o=n.effectiveConfirmed?"confirmed":"pending"),(Ta(e)||a==="completed")&&(o="completed");const r=n.effectiveConfirmed||o==="confirmed"||o==="completed";r&&o!=="completed"&&(o="confirmed");const i=vr(e),s=e?.paidStatus??e?.paid_status??(i?"paid":"unpaid");return{statusValue:o,confirmed:r,paid:i,paidStatus:s}}async function Hn({silent:e=!1}={}){if(!We){We=!0,Ze="",e||k();try{const[t,n,a,o,r,i]=await Promise.all([ee("/reservations/?limit=500"),ee("/customers/?limit=500"),ee("/equipment/?limit=500"),ee("/technicians/?limit=500"),ee("/projects/?limit=500"),ee("/maintenance/?limit=500")]);T.reservations=Array.isArray(t?.data)?t.data.map(s=>Ma(s)):[],T.customers=Array.isArray(n?.data)?n.data.map(Dn):[],T.equipment=Array.isArray(a?.data)?a.data.map(Rn):[],T.technicians=Array.isArray(o?.data)?o.data.map(Cn):[],T.projects=Array.isArray(r?.data)?r.data.map(Fn):[],T.projectsMap=new Map(T.projects.map(s=>[s.id,s])),T.maintenance=Array.isArray(i?.data)?i.data.map(it):[],Le=new Map((T.technicians||[]).map(s=>[String(s.id),s]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),Ze=t instanceof En?t.message:u("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),T.reservations=[],T.customers=[],T.equipment=[],T.technicians=[],T.projects=[],T.projectsMap=new Map,T.maintenance=[],Le=null}finally{We=!1,k()}}}function Se(){Hn({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function _t({active:e,icon:t,title:n,subtitle:a}){const o=document.getElementById("reports-empty-state");if(!o)return;const r=o.querySelector(".reports-empty-icon"),i=o.querySelector("h4"),s=o.querySelector("p");U.icon===null&&r&&(U.icon=r.textContent),U.title===null&&i&&(U.title=i.textContent),U.subtitle===null&&s&&(U.subtitle=s.textContent),o.classList.toggle("active",!!e),o.classList.toggle("hidden",!e),!(!r||!i||!s)&&(e?(r.textContent=t!==void 0?t:U.icon??r.textContent,i.textContent=n!==void 0?n:U.title??i.textContent,s.textContent=a!==void 0?a:U.subtitle??s.textContent):(r.textContent=U.icon??r.textContent,i.textContent=U.title??i.textContent,s.textContent=U.subtitle??s.textContent))}function fr(){if(an)return;an=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),o=document.getElementById("reports-start"),r=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),s=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;e.value=h.range,dr()&&k(),e.addEventListener("change",()=>{h.range=e.value,xt(s,h.range==="custom"),h.range!=="custom"&&(h.start=null,h.end=null),k()}),t?.addEventListener("change",()=>{h.status=t.value,k()}),n?.addEventListener("change",()=>{h.payment=n.value,k()}),a?.addEventListener("change",()=>{h.share=a.value,k()}),l?.addEventListener("input",()=>{const d=l.value||"";Ce&&clearTimeout(Ce),Ce=setTimeout(()=>{h.search=d,k()},220)}),o?.addEventListener("change",()=>{h.start=o.value||null,Ae()}),r?.addEventListener("change",()=>{h.end=r.value||null,Ae()}),i?.addEventListener("click",()=>{h.range==="custom"&&(h.start=o?.value||null,h.end=r?.value||null),k()}),Ke(o,r),xt(s,!1),rn||(document.addEventListener("language:changed",pn),document.addEventListener("language:translationsReady",pn),rn=!0),sn||(document.addEventListener("reservations:changed",Se),document.addEventListener("customers:changed",Se),document.addEventListener("equipment:changed",Se),document.addEventListener("projects:changed",Se),document.addEventListener("technicians:updated",Se),window.addEventListener("maintenance:updated",Se),sn=!0),$r(),qr(),Pr(),dn||(document.addEventListener("theme:changed",()=>{setTimeout(()=>k(),0)}),dn=!0),Hn()}function ct(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),o=document.getElementById("reports-search"),r=document.getElementById("reports-start"),i=document.getElementById("reports-end"),s=document.getElementById("reports-custom-range");e&&e.value!==h.range&&(e.value=h.range),t&&t.value!==h.status&&(t.value=h.status),n&&n.value!==h.payment&&(n.value=h.payment),a&&a.value!==h.share&&(a.value=h.share),o&&o.value!==h.search&&(o.value=h.search||""),r&&r.value!==(h.start||"")&&(r.value=h.start||""),i&&i.value!==(h.end||"")&&(i.value=h.end||""),xt(s,h.range==="custom")}function k(){if(ct(),We){_t({active:!0,icon:"⏳",title:u("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:u("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(Ze){_t({active:!0,icon:"⚠️",title:Ze,subtitle:u("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=T,o=hr(e,h,t,n,a),r=Sr(o),i=Er(T.maintenance,h),s=Tr(r,i.total),l=wr(o),c=Ar(o),d=Cr(o),m=Lr(o,t),p=_r(o,n);Xr(s),jr(l),Hr(c),zr(d),Or(m),Vr(p);const f=xr(o,t,a);It(),Qr(o.length===0),se.filtered=o,se.metrics=s,se.trend=l,se.statusBreakdown=c,se.paymentBreakdown=d,se.tableRows=f,se.maintenance=i}function Ke(e,t){if(!window.flatpickr)return;e&&(un=e),t&&(mn=t);const n=un,a=mn;if(!n&&!a)return;const o=br(),r=i=>{const s={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return o&&(s.locale=o),s};if(K&&(K.destroy(),K=null),X&&(X.destroy(),X=null),n&&(K=window.flatpickr(n,r({onChange(i,s){h.start=s||null,X&&(i?.length?X.set("minDate",i[0]):X.set("minDate",null)),Ae()},onValueUpdate(i,s){h.start=s||null,Ae()}}))),a&&(X=window.flatpickr(a,r({onChange(i,s){h.end=s||null,K&&(i?.length?K.set("maxDate",i[0]):K.set("maxDate",null)),Ae()},onValueUpdate(i,s){h.end=s||null,Ae()}}))),K&&n){K.setDate(n.value,!1);const i=X?.selectedDates?.[0]||a?.value;i&&K.set("maxDate",i)}if(X&&a){X.setDate(a.value,!1);const i=K?.selectedDates?.[0]||n?.value;i&&X.set("minDate",i)}}function br(){return(Z()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function xt(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function zn(e){return v(String(e||"")).toLowerCase().trim()}function hr(e,t,n,a,o){const{startDate:r,endDate:i}=On(t),s=zn(t.search),l=!!s,c=new Map((n||[]).map(p=>[String(p.id),p])),d=new Map((a||[]).map(p=>[tt(p?.barcode),p])),m=new Map((o||[]).map(p=>[String(p.id),p]));return(e||[]).filter(p=>{const f=p?.start?new Date(p.start):null;if(!f||Number.isNaN(f.getTime())||r&&f<r||i&&f>i)return!1;const{statusValue:g,confirmed:S,paid:y}=ke(p);if(t.status==="confirmed"&&!(g==="confirmed"||g==="completed"||S)||t.status==="pending"&&g!=="pending"||t.status==="completed"&&g!=="completed"||t.payment==="paid"&&!y||t.payment==="unpaid"&&y)return!1;if(t.share&&t.share!=="all"){const L=ze(p).companySharePercent>0;if(t.share==="with"&&!L||t.share==="without"&&L)return!1}return!(l&&!gr(p,s,c,d,m))})}function gr(e,t,n,a,o){const r=[],i=e?.reservationId||e?.id;i&&r.push(i),e?.notes&&r.push(e.notes);const{statusValue:s,paidStatus:l}=ke(e);s&&r.push(s);const c=e?.paymentStatus||e?.payment_status;c&&r.push(c),e?.paid!=null&&r.push(e.paid?"paid":"unpaid"),l&&r.push(l);const d=n.get(String(e?.customerId));d&&r.push(d.customerName,d.company_name||d.companyName,d.contact_person||"");const m=jn(e);return m&&r.push(m.title,m.code,m.status),r.push(Vn(l)),(e?.items||[]).forEach(f=>{f?.desc&&r.push(f.desc),f?.barcode&&r.push(f.barcode);const g=a.get(tt(f?.barcode));g&&r.push(g.desc,g.description,g.name)}),(e?.technicians||[]).forEach(f=>{const g=o.get(String(f));g&&r.push(g.name,g.role,g.department)}),zn(r.filter(Boolean).join(" ")).includes(t)}function On({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const i=t?new Date(`${t}T00:00:00`):null,s=n?new Date(`${n}T23:59:59`):null;return{startDate:bn(i)?i:null,endDate:bn(s)?s:null}}let o=new Date(a),r=null;switch(e){case"last30":{r=new Date(a),r.setDate(r.getDate()-29);break}case"thisWeek":{const i=new Date(a),l=(i.getDay()-6+7)%7;i.setDate(i.getDate()-l),i.setHours(0,0,0,0);const c=new Date(i);c.setDate(i.getDate()+6),c.setHours(23,59,59,999),r=i,o.setTime(c.getTime());break}case"thisMonth":{r=new Date(a.getFullYear(),a.getMonth(),1);const i=new Date(a.getFullYear(),a.getMonth()+1,0);o.setTime(i.setHours(23,59,59,999));break}case"thisQuarter":{const i=Math.floor(a.getMonth()/3);r=new Date(a.getFullYear(),i*3,1);const s=new Date(a.getFullYear(),(i+1)*3,0);o.setTime(s.setHours(23,59,59,999));break}case"thisYear":{r=new Date(a.getFullYear(),0,1);const i=new Date(a.getFullYear(),12,0);o.setTime(i.setHours(23,59,59,999));break}case"all":default:r=null,o=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:o}}function bn(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const yr=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),hn=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function et(e=""){const t=String(e).toLowerCase().trim();return t?yr.get(t)||t:""}function vr(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&hn.has(a))return hn.get(a)}return e?.paid===!0||e?.paid==="true"}function Sr(e){const t=e.length;let n=0,a=0,o=0,r=0,i=0,s=0,l=0,c=0,d=0;e.forEach(p=>{const{statusValue:f,confirmed:g,paid:S}=ke(p);f==="completed"&&(a+=1),g&&(n+=1),S&&(o+=1);const y=ze(p);r+=y.finalTotal,i+=y.companyShareAmount,s+=y.taxAmount,l+=y.crewTotal,c+=y.crewCostTotal??0,d+=y.netProfit});const m=t?r/t:0;return{total:t,confirmed:n,completed:a,paidCount:o,revenue:r,average:m,companyShareTotal:i,taxTotal:s,crewTotal:l,crewCostTotal:c,netProfit:d}}function Er(e,t){const{startDate:n,endDate:a}=On(t);let o=0;const r=[];return(e||[]).forEach(i=>{if(!i)return;const s=typeof i.repairCost=="number"?i.repairCost:Number.parseFloat(v(String(i.repairCost??"")));if(!Number.isFinite(s)||s<=0)return;const l=String(i.statusRaw??i.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const d=i.resolvedAt??i.resolved_at??null,m=i.reportedAt??i.reported_at??null,p=i.createdAt??i.created_at??null,f=d?new Date(d):null,g=m?new Date(m):p?new Date(p):null,S=f&&!Number.isNaN(f.getTime())?f:g&&!Number.isNaN(g.getTime())?g:null;if(S&&(n&&S<n||a&&S>a))return;const y=Math.round(s*100)/100;o+=y,r.push({id:i.id,cost:y,date:S})}),{total:o,items:r}}function Tr(e,t){const n=Number.isFinite(t)?t:0;return{...e,maintenanceExpense:n,netProfit:(e.netProfit||0)-n}}function wr(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const o=new Date(t.getFullYear(),t.getMonth()-a,1),r=o.getFullYear(),i=o.getMonth(),s=e.filter(S=>{const y=S?.start?new Date(S.start):null;return y&&y.getFullYear()===r&&y.getMonth()===i}),l=s.length;let c=0,d=0,m=0;s.forEach(S=>{const y=ze(S);c+=y.finalTotal,d+=y.netProfit,m+=y.companyShareAmount});const p=ir(o),f=new Date(o.getFullYear(),o.getMonth(),1),g=new Date(o.getFullYear(),o.getMonth()+1,0);n.push({label:p,count:l,revenue:c,netProfit:d,companyShare:m,periodStart:f,periodEnd:g,startInput:Lt(f),endInput:Lt(g)})}return n}function Ar(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(i=>{const{statusValue:s,confirmed:l}=ke(i);s==="completed"?t.completed+=1:s==="confirmed"||l?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,o=t.pending,r=t.completed;return[{label:b("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:b("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-pending",filterKey:"pending"},{label:b("reservations.reports.status.completedLabel","منتهية","Completed"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-completed",filterKey:"completed"}]}function Cr(e){const t=e.length||1,n=e.filter(o=>ke(o).paid).length,a=e.length-n;return[{label:b("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function Lr(e,t){const n=new Map,a=new Map((t||[]).map(o=>[String(o.id),o]));return e.forEach(o=>{const r=String(o?.customerId??"unknown"),i=n.get(r)||{count:0,revenue:0},s=ze(o);i.count+=1,i.revenue+=s.finalTotal,n.set(r,i)}),Array.from(n.entries()).map(([o,r])=>({name:a.get(o)?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:r.count,revenue:r.revenue})).sort((o,r)=>r.revenue-o.revenue).slice(0,5)}function _r(e,t){const n=new Map,a=new Map((t||[]).map(r=>[tt(r?.barcode),r])),o=b("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");return e.forEach(r=>{(r?.items||[]).forEach(i=>{const s=tt(i?.barcode),l=s?a.get(s):null,c=i?.desc||i?.description||i?.name||l?.desc||l?.description||l?.name||"",d=c&&c.trim()?c:o,m=Ea(d)||"unknown",p=Number(i?.qty)||1,f=Number(i?.price)||0,g=p*f,S=n.get(m)||{name:d,count:0,revenue:0};S.name=d,S.count+=p,S.revenue+=g,n.set(m,S)})}),Array.from(n.values()).sort((r,i)=>i.count!==r.count?i.count-r.count:i.revenue-r.revenue).slice(0,5)}function xr(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const o=new Map((t||[]).map(s=>[String(s.id),s]));new Map((n||[]).map(s=>[String(s.id),s]));const r={code:b("reservations.reports.results.headers.id","الحجز","Reservation"),customer:b("reservations.reports.results.headers.customer","العميل","Customer"),date:b("reservations.reports.results.headers.date","التاريخ","Date"),status:b("reservations.reports.results.headers.status","الحالة","Status"),payment:b("reservations.reports.results.headers.payment","الدفع","Payment"),total:b("reservations.reports.results.headers.total","الإجمالي","Total"),share:b("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:b("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=[...e].sort((s,l)=>new Date(l.start||0)-new Date(s.start||0)).slice(0,20).map(s=>{const l=Ur(s,o),c={[r.code]:l.code.text,[r.customer]:l.customer.text,[r.date]:l.date.text,[r.status]:l.status.text,[r.payment]:l.payment.text,[r.total]:l.total.text,[r.share]:l.share.text,[r.net]:l.net.text};return{formatted:l,exportRow:c}});return a.innerHTML=i.map(({formatted:s})=>`
      <tr data-drilldown="reservation" data-search="${lt(s.code.text)}">
        <td data-report-column="code">${s.code.html}</td>
        <td data-report-column="customer">${s.customer.html}</td>
        <td data-report-column="date">${s.date.html}</td>
        <td data-report-column="status">${s.status.html}</td>
        <td data-report-column="payment">${s.payment.html}</td>
        <td data-report-column="total">${s.total.html}</td>
        <td data-report-column="share">${s.share.html}</td>
        <td data-report-column="net">${s.net.html}</td>
      </tr>
    `).join(""),i.map(({exportRow:s})=>s)}function Ir(e){const t=Bn?.[e];t&&(h.range="custom",h.start=t.startInput||null,h.end=t.endInput||null,ct(),k())}function Mr(e){e&&(h.status=h.status===e?"all":e,ct(),k())}function kr(e){e&&(h.payment=h.payment===e?"all":e,ct(),k())}function Nr(e){Ce&&(clearTimeout(Ce),Ce=null),h.search=e||"";const t=document.getElementById("reports-search");t&&t.value!==h.search&&(t.value=h.search),k()}function $r(){if(cn)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(t=>{const n=t.dataset.columnToggle;n&&(t.checked=Ct[n]!==!1,t.addEventListener("change",()=>{Ct[n]=t.checked,It()}))}),cn=!0,It())}function It(){Object.entries(Ct).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{t?n.classList.remove("hidden"):n.classList.add("hidden")})})}function qr(){if(on)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(t=>{t.addEventListener("click",async()=>{const{export:n=""}=t.dataset;if(n){t.disabled=!0;try{await Br(n)}catch(a){console.error("⚠️ [reports] export failed",a)}finally{t.disabled=!1}}})}),on=!0)}async function Br(e){const t=se.tableRows||[];if(!t.length){console.warn("[reports] No reservation data to export");return}switch(e){case"pdf":await Fr();break;case"excel":await Rr(t);break;case"csv":default:Mt(t);break}}function Ut(e){const t=Lt(new Date).replace(/-/g,"");return`${b("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${t}.${e}`}function Dr(e,t,n){const a=new Blob([e],{type:n}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(o),4e3)}function Mt(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(o=>{const r=t.map(i=>`"${String(o[i]??"").replace(/"/g,'""')}"`);n.push(r.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;Dr(a,Ut("csv"),"text/csv;charset=utf-8;")}async function Rr(e){try{const t=await lr();if(!t){Mt(e);return}const n=t.utils.json_to_sheet(e),a=t.utils.book_new(),o=b("reservations.reports.export.sheetName","الحجوزات","Reservations");t.utils.book_append_sheet(a,n,o),t.writeFile(a,Ut("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),Mt(e)}}async function Fr(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await cr();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=Ut("pdf");await t().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}function Pr(){if(ln)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=o=>{const r=o.target?.closest("[data-drilldown]");if(!r)return;const i=r.dataset.search||"";Nr(i)};e?.addEventListener("click",a),t?.addEventListener("click",a),n?.addEventListener("click",a),ln=!0}async function jr(e){const t=document.getElementById("reports-volume-chart");if(t){if(Bn=Array.isArray(e)?e:[],!e||e.length===0){C.trend&&(C.trend.destroy(),C.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const n=await Vt();if(!n){t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const a=e.map(c=>c.label),o=e.map(c=>Math.round(c.count||0)),r=e.map(c=>Math.round(c.revenue||0)),i=e.map(c=>Math.round(c.netProfit||0)),s=[{name:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:o},{name:b("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),type:"line",data:r},{name:b("reservations.reports.chart.volume.series.net","صافي الربح (SR)","Net profit (SR)"),type:"line",data:i,yAxisIndex:1}],l={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(c,d,m)=>{m?.dataPointIndex!=null&&Ir(m.dataPointIndex)}}},theme:{mode:Je()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:a,labels:{style:{colors:Je()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:c=>x(c)},title:{text:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:b("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:c=>q(c)},title:{text:b("reservations.reports.chart.volume.series.revenue","الإيرادات (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(c,{seriesIndex:d})=>d===0?x(c):q(c)}}};C.trend?(C.trend.updateOptions({...l},!0,!0),C.trend.updateSeries(s,!0)):(t.innerHTML="",C.trend=new n(t,{...l,series:s}),C.trend.render())}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function Hr(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(t){if(St=Array.isArray(e)?e:[],!e||e.length===0){C.status&&(C.status.destroy(),C.status=null),ie(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Vt();if(!a){ie(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const o=e.map(s=>Math.max(0,s.value||0)),r=e.map(s=>s.label),i={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(s,l,c)=>{if(c?.dataPointIndex!=null){const d=St[c.dataPointIndex];d?.filterKey&&Mr(d.filterKey)}}}},theme:{mode:Je()},labels:r,series:o,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:s=>`${Math.round(s)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:b("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>x(o.reduce((s,l)=>s+l,0))}}}}},tooltip:{y:{formatter:(s,l)=>{const c=St?.[l?.seriesIndex||0],d=c?`${x(c.percent)}%`:`${x(s)}%`;return`${x(c?c.rawCount??c.value??0:s)} / ${d}`}}}};C.status?(C.status.updateOptions({...i},!0,!0),C.status.updateSeries(o,!0)):(t.innerHTML="",C.status=new a(t,{...i,series:o}),C.status.render()),ie(n,e)}catch(a){console.error("⚠️ [reports] Failed to render status chart",a),ie(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function zr(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(t){if(Et=Array.isArray(e)?e:[],!e||e.length===0){C.payment&&(C.payment.destroy(),C.payment=null),ie(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Vt();if(!a){ie(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const o=e.map(s=>Math.max(0,s.value||0)),r=e.map(s=>s.label),i={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(s,l,c)=>{if(c?.dataPointIndex!=null){const d=Et[c.dataPointIndex];d?.filterKey&&kr(d.filterKey)}}}},theme:{mode:Je()},labels:r,series:o,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:s=>`${Math.round(s)}%`},tooltip:{y:{formatter:(s,l)=>{const c=Et?.[l?.seriesIndex||0],d=c?`${x(c.percent)}%`:`${x(s)}%`;return`${x(c?c.rawCount??c.value??0:s)} / ${d}`}}}};C.payment?(C.payment.updateOptions({...i},!0,!0),C.payment.updateSeries(o,!0)):(t.innerHTML="",C.payment=new a(t,{...i,series:o}),C.payment.render()),ie(n,e)}catch(a){console.error("⚠️ [reports] Failed to render payment chart",a),ie(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}function ie(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}n.innerHTML=t.map(a=>{const o=Math.min(Math.max(a.percent??0,0),100),r=b("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",x(a.rawCount??a.value??0)),i=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${j(a.label)}</span>
            <span class="reports-progress-value">${x(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${o}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}function Or(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${lt(n.name)}">
        <td>${j(n.name)}</td>
        <td>${x(n.count)}</td>
        <td>${q(n.revenue)}</td>
      </tr>
    `).join("")}}function Vr(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${lt(n.name)}">
        <td>${j(n.name)}</td>
        <td>${x(n.count)}</td>
        <td>${q(n.revenue)}</td>
      </tr>
    `).join("")}}function Ur(e,t,n){const a=e?.reservationId||e?.id||"—",o=v(String(a)),i=t.get(String(e?.customerId))?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),s=ke(e),l=Yr(s.statusValue),c=Gr(s.statusValue,l),d=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],m=Wr(s.paidStatus,d),p=d.length;let f=m.html;if(p>0){const D=b("reservations.paymentHistory.countLabel","{count} دفعة","{count} payments").replace("{count}",x(p));f=`<div class="reports-payment-cell">${m.html}<small class="reports-payment-subtext">${j(D)}</small></div>`}const g=Kr(e?.start),S=ze(e),y=q(S.finalTotal),R=S.companySharePercent>0?`${x(S.companySharePercent)}% (${q(S.companyShareAmount)})`:b("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),L=q(S.netProfit),$=j(i),w=i;return{code:{html:j(o),text:o},customer:{html:$,text:w},date:{html:j(g),text:g},status:c,payment:{html:f,text:m.text},total:{html:j(y),text:y},share:{html:j(R),text:R},net:{html:j(L),text:L}}}function Vn(e){const t=String(e??"").toLowerCase();return t==="paid"?b("reservations.reports.payment.paidLabel","مدفوعة","Paid"):t==="partial"?b("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Yr(e){switch(e){case"completed":return Xe(b("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return Xe(b("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return Xe(b("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return v(e||"—")}}function Gr(e,t){const n=Xe(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${j(n)}</span>`,text:n}}function Wr(e,t=[]){const n=Vn(e),a=String(e??"").toLowerCase(),o=a==="paid"?"paid":a==="partial"?"partial":"unpaid";let r="";const i=b("reservations.create.summary.currency","ريال","SR");Array.isArray(t)&&t.length&&(r=t.map(c=>{const d=c?.recordedAt?v(String(c.recordedAt).split("T")[0]):"—",m=Number.isFinite(Number(c?.amount))&&Number(c.amount)>0?`${v(Number(c.amount).toFixed(2))} ${i}`:"",p=Number.isFinite(Number(c?.percentage))&&Number(c.percentage)>0?`${v(Number(c.percentage).toFixed(2))}%`:"",f=[d];return m&&f.push(`${m}`),p&&f.push(p),f.filter(Boolean).join(" • ")}).join(`
`));const s=r?` title="${lt(r)}"`:"";return{html:`<span class="reservation-chip status-${o}"${s}>${j(n)}</span>`,text:n}}function Xe(e){return v(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function Kr(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=zt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return v(a.format(t))}function Xr(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),o=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),s=document.getElementById("reports-kpi-confirmed-meta"),l=document.getElementById("reports-kpi-paid"),c=document.getElementById("reports-kpi-paid-meta"),d=e.total||0,m=e.revenue||0,p=e.confirmed||0,f=e.paidCount||0,g=e.average||0,S=e.companyShareTotal||0,y=e.taxTotal||0,R=e.crewTotal||0,L=e.crewCostTotal||0,$=e.netProfit||0,w=e.maintenanceExpense||0,D=d?Math.round(p/d*100):0,W=d?Math.round(f/d*100):0;if(t&&(t.textContent=x(d)),n){const I=b("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",x(e.completed||0));n.textContent=I}if(a&&(a.textContent=q(m)),o){const I=b("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");o.textContent=I.replace("{net}",q($)).replace("{share}",q(S)).replace("{average}",q(g))}if(r)if(m>0){const I=[{label:b("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:q(m)},{label:b("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:q(S)},{label:b("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:q(y)},{label:b("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:q(R)},{label:b("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:q(L)}];w>0&&I.splice(I.length,0,{label:b("reservations.reports.kpi.revenue.details.maintenance","مصاريف الصيانة","Maintenance expenses"),value:`−${q(w)}`}),I.push({label:b("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:q($)}),r.innerHTML=I.map(({label:E,value:H})=>`
          <div class="reports-kpi-detail-row">
            <span class="reports-kpi-detail-label">${j(E)}</span>
            <span class="reports-kpi-detail-value">${j(H)}</span>
          </div>
        `).join(""),r.classList.remove("hidden")}else r.innerHTML="",r.classList.add("hidden");if(i&&(i.textContent=`${D}%`),s){const I=b("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",x(p));s.textContent=I}if(l&&(l.textContent=`${W}%`),c){const I=b("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",x(f));c.textContent=I}}function Qr(e){_t({active:!!e})}function j(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function lt(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function x(e){const{numberFormatter:t}=or(),n=t.format(Math.round(e||0));return v(n)}function q(e){return`${x(e)} SR`}function tt(e){return(e||"").toString().trim()}function kt(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getFullYear()).slice(-2);return`${n}/${a}/${o}`}let ve=st(),ye=[],Be=null,_e=!1,De="",xe=ve.length>0,Q={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},Yt=null,F=null,N=null,z=null,Ie=null,Re=null,Me=null,B=null;async function Pe({showToastOnError:e=!0}={}){if(!_e){_e=!0,De="",te();try{await Ka(),xe=!0}catch(t){xe=ve.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),De=Fe(t)?t.message:u("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&A(De,"error")}finally{_e=!1,ve=st(),te()}}}function Nt(){return u("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function ae(e){return v(String(e||"")).trim().toLowerCase()}function Un(e=""){return v(String(e)).trim().toLowerCase()}function Zr(e={}){const t=String(e?.desc??"").trim(),n=v(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function Jr(e){const t=v(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Yn(e){return v(String(e||"")).trim().toLowerCase()}function _(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function es(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function ce(){return ve=st(),ve}function Gn(e){return ce().find(n=>Number(n.id)===Number(e))||null}function Wn(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function Gt(){const{equipment:e=[]}=re(),t=u("maintenance.table.noName","بدون اسم");return ye=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),o=ae(a),r=Number.parseInt(n?.qty??n?.quantity??0,10),i=Number.isFinite(r)?Math.max(r,0):1,s=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"متاح",c=n?.desc||n?.description||n?.name||t,d=Zr({desc:c,displayBarcode:a,barcode:o});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:o,displayBarcode:a,desc:c,status:l,statusNormalized:Wn(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:i,image:s,searchValue:d,searchValueNormalized:Yn(d),descriptionNormalized:Un(c)}}),ye.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),ye}function Wt(){const e=new Set,t=new Map;return ce().filter(n=>n.status==="open").forEach(n=>{const a=ae(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function Kn(e){const t=ae(e);if(!t)return 0;const{map:n}=Wt();return n.get(t)||0}function dt(e){const t=ae(e);return t&&(ye.length?ye:Gt()).find(a=>a.barcode===t)||null}function ts(e){const t=ye.length?ye:Gt();if(!t.length)return null;const n=Yn(e);if(n){const s=t.find(l=>l.searchValueNormalized===n);if(s)return s}const{description:a,barcode:o}=Jr(e);if(o){const s=ae(o);if(s){const l=t.find(c=>c.barcode===s);if(l)return l}}const r=Un(a||e);if(!r)return null;const i=t.find(s=>s.descriptionNormalized===r);return i||t.find(s=>s.descriptionNormalized.includes(r))||null}function $t(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,r=(t||Wt().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||r>=1:r>=a}function pe({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),o&&(o.value="")),r&&(r.textContent=Nt(),r.classList.remove("maintenance-selected-info--has-selection")),Be=null}function Xn(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=u("maintenance.info.barcodeLabel","باركود"),a=u("maintenance.report.notAvailable","غير متوفر"),o=u("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),r=u("maintenance.info.categoryLabel","القسم"),i=e.displayBarcode||e.barcode||a,s=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,c=Kn(s),d=Math.max(l-c,0),m=e.category?`
    <div class="maintenance-selected-info__meta">${r}: <strong>${_(e.category)}</strong></div>
  `:"",p=l>0?`
    <div class="maintenance-selected-info__meta">
      ${o}: <strong>${d}</strong> / ${l}
    </div>
  `:"",f=e.image?`<img class="maintenance-selected-info__image" src="${_(e.image)}" alt="${_(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${f}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${_(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${_(i)}</strong></div>
      ${p}
      ${m}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function Kt(e,{silent:t=!1}={}){if(!e)return!1;if($t(e))return t||A(u("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),o&&(o.value=e.searchValue||e.desc),Xn(e),Be=e,!0}function Qn(e,{showFeedback:t=!0}={}){const n=dt(e);return n?Kt(n,{silent:!t}):(t&&A(u("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function Zn(e,{showFeedback:t=!0}={}){const n=ts(e);return n?Kt(n,{silent:!t}):(t&&A(u("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function Xt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=Gt(),{map:o}=Wt();e&&(e.innerHTML=a.map(i=>`<option value="${_(i.searchValue||i.desc)}"></option>`).join(""));const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const i=dt(r.value);!i||$t(i,o)?(pe({keepInputs:!0,silent:!0}),i&&$t(i,o)&&A(u("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):Kt(i,{silent:!0})}else pe({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),Qn(t.value)||pe({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const i=()=>{if(!n.value){pe({keepInputs:!0,silent:!0});return}Zn(n.value)||pe({keepInputs:!0,silent:!0})};n.addEventListener("change",i),n.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),i())}),n.dataset.listenerAttached="true"}}async function nt(){try{await wa({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{jt(),Xt()}}function Jn(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;Yt=t.Modal.getOrCreateInstance(e),F||(F=e.querySelector("#maintenance-close-report")),N||(N=e.querySelector("#maintenance-close-cost")),N&&N.dataset.normalizeAttached!=="true"&&(N.addEventListener("input",a=>{ns(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),N.dataset.normalizeAttached="true"),z||(z=e.querySelector("#maintenance-close-submit")),Ie||(Ie=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",rs),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",ea),e.dataset.listenerAttached="true"),!0}function ea(){Q={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},F&&(F.value="",F.classList.remove("is-invalid")),N&&(N.value="",N.classList.remove("is-invalid")),Ie&&(Ie.innerHTML=""),je(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=u("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),n&&(n.textContent=u("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.")),z&&(z.textContent=u("maintenance.closeModal.confirm","إغلاق التذكرة"))}}function ta(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(Re=t.Modal.getOrCreateInstance(e),Me||(Me=e.querySelector("#maintenance-report-modal-content")),B||(B=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",na),e.dataset.listenerAttached="true"),B&&B.dataset.listenerAttached!=="true"&&(B.addEventListener("click",ds),B.dataset.listenerAttached="true"),!0):!1}function na(){Me&&(Me.innerHTML=""),B&&(B.hidden=!0,B.disabled=!1,delete B.dataset.id)}function je(e){if(!z)return;const t=Q.mode==="edit",n=t?u("maintenance.closeModal.editSaving","⏳ جاري الحفظ..."):u("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),a=t?u("maintenance.closeModal.editConfirm","حفظ التعديلات"):u("maintenance.closeModal.confirm","إغلاق التذكرة");e?(z.disabled=!0,z.dataset.loading="true",z.textContent=n):(z.disabled=!1,z.removeAttribute("data-loading"),z.textContent=a)}function ns(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=v(t).replace(/٫/g,".").replace(/٬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:o}=e;if(e.value=n,a!==null&&o!==null)try{e.setSelectionRange(a,o)}catch{}}}function as(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const r=v(n).replace(/٫/g,".").replace(/٬/g,",").replace(/[^0-9.,-]/g,"");if(!r)return{provided:!0,value:null,error:"invalid"};const i=r.includes(","),s=r.includes(".");let l=r;i&&!s?l=r.replace(",","."):i&&s&&(l=r.replace(/,/g,""));const c=Number.parseFloat(l);return!Number.isFinite(c)||c<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(c*100)/100,error:null}}function aa(e,{mode:t="close"}={}){const n=Gn(e);if(!n){A(u("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!Jn()){const l=prompt(u("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(l===null)return;const c=l.trim();if(!c){A(u("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}ra(e,c);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(v(String(n.repairCost))):null,o=Number.isFinite(a)?Math.round(a*100)/100:null,r=t==="edit"?"edit":"close";if(Q={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:o,resolvedAt:n.resolvedAt||null,mode:r},F&&(F.value=n.resolutionReport||"",F.classList.remove("is-invalid")),N&&(o!==null?N.value=v(o.toFixed(2)):N.value="",N.classList.remove("is-invalid")),Ie){const l=u("maintenance.report.barcode","الباركود"),c=u("maintenance.report.notAvailable","غير متوفر"),d=Q.equipmentDesc||c,m=Q.equipmentBarcode?v(Q.equipmentBarcode):c;Ie.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${d}</div>
          <div class="maintenance-close-modal__ticket-meta">${l}: <span>${m}</span></div>
        </div>
      </div>
    `}je(!1);const i=r==="edit";z&&(z.textContent=i?u("maintenance.closeModal.editConfirm","حفظ التعديلات"):u("maintenance.closeModal.confirm","إغلاق التذكرة"));const s=document.getElementById("closeMaintenanceModal");if(s){const l=s.querySelector("#maintenance-close-modal-title"),c=s.querySelector(".maintenance-close-modal__subtitle");l&&(l.textContent=i?u("maintenance.closeModal.editTitle","✏️ تعديل بيانات الإغلاق"):u("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),c&&(c.textContent=i?u("maintenance.closeModal.editSubtitle","يمكنك تحديث تقرير الإصلاح وتكلفته."):u("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة."))}Yt?.show(),setTimeout(()=>{F?.focus(),F?.setSelectionRange(F.value.length,F.value.length)},150)}async function rs(e){if(e?.preventDefault(),!Q.id){A(u("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!F)return;const t=F.value.trim();if(!t){A(u("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),F.focus();return}N&&N.classList.remove("is-invalid");const n=N?as(N.value,Q.repairCost):{provided:!1,value:null,error:null};if(n.error){A(u("maintenance.toast.invalidRepairCost","⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح"),"error"),N?.classList.add("is-invalid"),N?.focus();return}je(!0),(await ra(Q.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:Q.mode,resolvedAt:Q.resolvedAt})).success?Yt?.hide():je(!1)}function ss(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(m=>m.status==="open").length,o=n-a,r=m=>v(String(m)),i=u("maintenance.stats.summaryTitle","ملخص الصيانة"),s=u("maintenance.filters.status.open","قيد الصيانة"),l=u("maintenance.filters.status.closed","مغلقة"),c=u("maintenance.stats.totalLabel","إجمالي التذاكر"),d=(m,p,f)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${f}">
      <span class="maintenance-summary__value">${r(m)}</span>
      <span class="maintenance-summary__label">${p}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${i}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${d(a,s,"open")}
        ${d(o,l,"closed")}
        ${d(n,c,"total")}
      </div>
    </section>
  `}function os(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=qn(n)||"open",o={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},r=o[a]??o.open,i=r?u(r.key,r.fallback):u("maintenance.status.open","قيد الصيانة"),s=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():i,l=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&l.push(r.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${s}</span>`}function is(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=u("maintenance.empty.title","لا توجد تذاكر صيانة"),o=u("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${o}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const o=os(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",i=(()=>{const $=u("maintenance.priority.high","مرتفعة"),w=u("maintenance.priority.medium","متوسطة"),D=u("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${$}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${D}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${w}</span>`}})(),s=[],l=u("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),c=u("maintenance.actions.view","👁️ عرض التقرير"),d=u("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?s.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):s.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${c}</button>`),He()&&s.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${d}</button>`);const m=s.join(""),p=u("maintenance.table.noBarcode","بدون باركود"),f=u("maintenance.report.none","—"),g=a.equipmentBarcode?v(a.equipmentBarcode):p,S=a.issue?v(a.issue):f,y=a.repairCost!=null?Number.parseFloat(v(String(a.repairCost))):null,R=a.status==="closed"&&Number.isFinite(y)?`<div class="maintenance-repair-cost">${_(u("maintenance.table.repairCost","💰 تكلفة الإصلاح: {amount}").replace("{amount}",v(y.toFixed(2))))}</div>`:"",L=a.createdAt?v(kt(a.createdAt)||Ne(a.createdAt)):"—";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${g}</small>
          </td>
          <td class="maintenance-issue-text">${S}${R}</td>
          <td>${i}</td>
          <td>${L}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${m}
            </div>
          </td>
        </tr>
      `}).join("")}}function cs(e){if(!xe||_e){A(u("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")aa(a);else if(n==="view")ls(a);else if(n==="delete"){if(!He()){Pt();return}us(a).catch(o=>{console.error("❌ [maintenance] deleteTicket failed",o)})}}}async function ra(e,t,n={}){const a=Gn(e);if(!a)return A(u("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const o=(t??"").trim();if(!o)return A(u("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const r=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:es(new Date)||new Date().toISOString(),i={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:o,resolved_at:r};n?.repairCostProvided&&(i.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await Qa(e,i),await Pe({showToastOnError:!1});const s=document.getElementById("maintenance-status-filter");return s&&s.value==="open"&&(s.value="all"),await nt(),te(),A(u("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(s){if(console.error("❌ [maintenance] closeTicket failed",s),Fe(s)&&s.status===404)return await Pe({showToastOnError:!1}),await nt(),te(),A(u("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const l=Fe(s)?s.message:u("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return A(l,"error"),{success:!1,error:s}}}function ls(e){const n=ce().find(w=>Number(w.id)===Number(e));if(!n)return;if(n.id,!ta()){const w=u("maintenance.report.equipment","المعدة"),D=u("maintenance.report.barcode","الباركود"),W=u("maintenance.report.issue","الوصف"),I=u("maintenance.report.createdAt","تاريخ الإنشاء"),E=u("maintenance.report.closedAt","تاريخ الإغلاق"),H=u("maintenance.report.summary","التقرير"),O=u("maintenance.report.repairCost","تكلفة الإصلاح"),Oe=u("maintenance.report.currencyLabel","ريال"),V=Number.parseFloat(v(String(n.repairCost??""))),J=Number.isFinite(V)?`${v(V.toFixed(2))} ${Oe}`:de,le=u("maintenance.report.notAvailable","غير متوفر"),de=u("maintenance.report.none","—"),ca=[`${w}: ${n.equipmentDesc}`,`${D}: ${n.equipmentBarcode?v(n.equipmentBarcode):le}`,`${W}: ${n.issue?v(n.issue):de}`,`${I}: ${n.createdAt?v(kt(n.createdAt)||Ne(n.createdAt)):de}`,`${E}: ${n.resolvedAt?v(Ne(n.resolvedAt)):de}`,`${O}: ${J}`,`${H}: ${n.resolutionReport?v(n.resolutionReport):de}`].join(`
`);alert(ca);return}const a=u("maintenance.report.equipment","المعدة"),o=u("maintenance.report.barcode","الباركود"),r=u("maintenance.report.issue","الوصف"),i=u("maintenance.report.createdAt","تاريخ الإنشاء"),s=u("maintenance.report.closedAt","تاريخ الإغلاق"),l=u("maintenance.report.repairCost","تكلفة الإصلاح"),c=u("maintenance.report.summary","التقرير"),d=u("maintenance.report.notAvailable","غير متوفر"),m=u("maintenance.report.none","—"),p=Number.parseFloat(v(String(n.repairCost??""))),f=Number.isFinite(p)?v(p.toFixed(2)):null,g=u("maintenance.report.currencyLabel","ريال"),S=[{label:a,value:`<span class="maintenance-report-modal__value">${_(n.equipmentDesc||m)}</span>`},{label:o,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${_(v(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(d)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${_(v(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(m)}</span>`},{label:i,value:n.createdAt?`<span class="maintenance-report-modal__value">${_(v(kt(n.createdAt)||Ne(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(m)}</span>`},{label:s,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${_(v(Ne(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(m)}</span>`},{label:l,value:f?`<span class="maintenance-report-modal__value">${_(f)} ${_(g)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(m)}</span>`}],y=n.resolutionReport?v(n.resolutionReport):"",R=y?`<p>${_(y).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(m)}</p>`,L=S.map(w=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${_(w.label)}</span>
        ${w.value}
      </div>
    `).join(""),$=`
    <div class="maintenance-report-modal__summary">
      <h6>${_(c)}</h6>
      ${R}
    </div>
  `;if(Me&&(Me.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${L}
        </div>
        ${$}
      </div>
    `),B){const w=He()&&n.status==="closed";B.hidden=!w,B.disabled=!w,B.textContent=u("maintenance.actions.editClosed","✏️ تعديل بيانات الإغلاق"),w?B.dataset.id=String(n.id):delete B.dataset.id}Re?.show()}function ds(){if(!B)return;const e=Number(B.dataset.id);if(!e){Re?.hide();return}if(!He()){Re?.hide(),Pt();return}Re?.hide(),setTimeout(()=>{aa(e,{mode:"edit"})},220)}async function us(e){if(!He()){Pt();return}if(!ce().find(a=>Number(a.id)===Number(e))){A(u("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(u("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Za(e),await Pe({showToastOnError:!1}),await nt(),A(u("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const o=Fe(a)?a.message:u("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");A(o,"error")}}async function ms(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),o=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let i=Be,s=ae(a?.value);if(!i&&s&&(i=dt(s)),!i&&t?.value&&Qn(t.value,{showFeedback:!0})&&(i=Be,s=ae(i?.barcode)),!i&&n?.value&&Zn(n.value,{showFeedback:!0})&&(i=Be,s=ae(i?.barcode)),!i||!s){A(u("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=re();let c=(l||[]).find(y=>ae(y?.barcode)===s);if(!c&&i&&(c={id:i.id,barcode:i.barcode,desc:i.desc,name:i.desc,status:i.status||"متاح",quantity:i.quantity,qty:i.quantity}),!c||c.id==null){A(u("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),pe();return}const d=Number.parseInt(c.qty??c.quantity??i?.quantity??1,10),m=Number.isFinite(d)&&d>0?d:1,p=Kn(s);if(Wn(c.status||i?.status)==="maintenance"&&m<=1){A(u("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(p>=m){A(u("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const g=Ja({equipmentId:c.id,technicianId:null,issue:o?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Xa(g),await Pe({showToastOnError:!1}),await nt(),A(u("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),pe(),o&&(o.value=""),r&&(r.value="medium");const S=document.getElementById("maintenance-status-filter");S&&(S.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=Fe(t)?t.message:u("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");A(n,"error")}}function ps(e){const t=ce();return e==="all"?t:t.filter(n=>n.status===e)}function te(){const e=ce();Xt(),ss(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),o=document.getElementById("maintenance-empty-state");if(!a)return;if(_e&&!xe){const i=u("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${i}</td></tr>`,o&&o.classList.remove("active");return}if(De&&!xe){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${De}</td></tr>`,o&&o.classList.remove("active");return}const r=ps(n);is(r)}function fs(){ce(),Xt(),xe=ve.length>0,_e=!1,te(),Pe({showToastOnError:!1}),Jn()&&ea(),ta()&&na();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{ms(a).catch(o=>{console.error("❌ [maintenance] submit handler failed",o)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{te()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",cs),n.dataset.listenerAttached="true")}ce();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=dt(e.value);n?Xn(n):t&&(t.textContent=Nt())}else t&&(t.textContent=Nt());te(),je(!1)});document.addEventListener(da.USER_UPDATED,()=>{te()});window.addEventListener("maintenance:updated",()=>{ve=st(),te()});const qt="__ART_RATIO_LAST_DASHBOARD_TAB__",ne="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",at="create-tab",sa=/^[a-z0-9\-]+$/i;function Bt(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function fe(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!sa.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function Dt(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!sa.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function oa(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let ue=null,G=null,be=!1,P=null,gn=null,he=null,Rt=null,Ee=null;function bs(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(r,{skipStore:i=!1,skipRender:s=!1}={})=>{if(!r)return;const l=e.filter(d=>d?.getAttribute("data-tab")===r),c=document.getElementById(r);if(!(!l.length||!c)&&(e.forEach(d=>{const m=d?.getAttribute("data-tab")===r;d.classList.toggle("active",m),m?(d.setAttribute("aria-selected","true"),d.setAttribute("tabindex","0"),Bt(d)):(d.setAttribute("aria-selected","false"),d.setAttribute("tabindex","-1"))}),t.forEach(d=>{const m=d.id===r;d.style.display=m?"block":"none",d.classList.toggle("active",m)}),ue=r,Dt(qt,r),i||$e({dashboardTab:r}).catch(d=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",d)}),r!=="reservations-tab"&&(G=null,P=null,oa(ne),i||$e({dashboardSubTab:null}).catch(d=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",d)})),!s&&r==="customers-tab"&&(console.log("👤 Rendering customers"),ya()),!s&&r==="equipment-tab"&&(console.log("📦 Rendering equipment"),jt()),!s&&r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),te()),!s&&r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Na()),r==="reservations-tab")){if(console.log("📅 Rendering reservations"),s||wn(),!P){const d=fe(ne);P=G||d||at}hs(),P&&(Ve(P),P=null)}};Rt=n,e.forEach(r=>{r&&(r.getAttribute("type")||r.setAttribute("type","button"),r.setAttribute("role","tab"),r.hasAttribute("tabindex")||r.setAttribute("tabindex",r.classList.contains("active")?"0":"-1"),r.addEventListener("click",()=>{const i=r.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",i),n(i),i==="reservations-tab"){const s=G||fe(ne)||at;typeof he=="function"?he(s):P=s}else $e({dashboardSubTab:null}).catch(s=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",s)})}))});const a=r=>{const i=document.querySelector("[data-tab].active"),s=fe(qt),l=e[0]?.getAttribute("data-tab")||null,d=[r?.dashboardTab,s,ue,i?.getAttribute("data-tab"),l].filter(Boolean).find(f=>document.getElementById(f))||l;d&&(!be||d!==ue)&&(console.log("⭐ Initial tab:",d),n(d,{skipStore:!0}));const p=[r?.dashboardSubTab,fe(ne)].filter(Boolean).find(f=>document.getElementById(f));p&&(ue==="reservations-tab"&&typeof he=="function"?(!be||p!==G)&&he(p,{skipStore:!0}):P=p),be||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),be=!0)},o=typeof Qe=="function"?Qe():null;a(o||null),ua().then(r=>a(r||null)).catch(r=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",r),a(null)}),gn||(gn=ma(r=>{if(!(!be||!r))if(r.dashboardTab&&r.dashboardTab!==ue&&n(r.dashboardTab,{skipStore:!0}),ue==="reservations-tab"){if(r.dashboardSubTab&&r.dashboardSubTab!==G)Ve(r.dashboardSubTab);else if(!r.dashboardSubTab&&G){const i=fe(ne);i?i!==G&&Ve(i):Ve(null)}}else r.dashboardSubTab&&(P=r.dashboardSubTab)}))}function hs(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(at)?at:n[0]:null,o=(r,{skipStore:i=!1}={})=>{if(!n.length)return;let s=r;(!s||!n.includes(s))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:s,available:n}),s=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${s}"]`),c=document.getElementById(s);if(!l||!c){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:s});return}if(G===s&&l.classList.contains("active")&&c.classList.contains("active")&&c.getAttribute("aria-hidden")==="false"){c.removeAttribute("hidden"),c.style.display="block",c.setAttribute("aria-hidden","false"),G=s,Bt(l),i||(Dt(ne,s),$e({dashboardSubTab:s}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}));return}e.forEach(m=>{m.classList.remove("active"),m.classList.contains("tab")&&m.classList.remove("tab-active"),m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),Bt(l),t.forEach(m=>{const p=m.id===s;m.classList.toggle("active",p),m.setAttribute("aria-hidden",p?"false":"true"),p?(m.removeAttribute("hidden"),m.style.display="block"):(m.setAttribute("hidden",""),m.style.display="none")}),G=s,Dt(ne,s),i||$e({dashboardSubTab:s}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}),s==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{wn()},50)):s==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{rt()},100)):s==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{k()},50))};if(he=(r,i={})=>{r?o(r,i):(e.forEach(s=>{s.classList.remove("active"),s.classList.contains("tab")&&s.classList.remove("tab-active"),s.setAttribute("aria-selected","false"),s.setAttribute("tabindex","-1")}),t.forEach(s=>{s.classList.remove("active"),s.setAttribute("aria-hidden","true"),s.setAttribute("hidden",""),s.style.display="none"}),G=null,oa(ne))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const i=r.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",i),o(i)}),r.dataset.subTabListenerAttached="true")}),P)o(P,{skipStore:!0}),P=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),i=a(),s=r?.getAttribute("data-sub-tab")||i;s&&(console.log("⭐ Initial sub-tab:",s),o(s,{skipStore:!0}))}An()}function Ve(e){typeof he=="function"?he(e,{skipStore:!0}):e&&(P=e)}function gs(){try{if(typeof Qe=="function")return Qe()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function ys({attemptsLeft:e=0}={}){if(!be||typeof Rt!="function")return!1;const t=gs(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[ue,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,fe(qt),a].filter(Boolean).find(s=>document.getElementById(s));if(!r)return!1;const i=()=>{const s=document.querySelector(`[data-tab].active[data-tab="${r}"]`),l=document.getElementById(r);return!!(s&&l?.classList.contains("active")&&l?.style.display!=="none")};if(r==="reservations-tab"){const s=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!s.length)return!1;const l=s[0]?.getAttribute("data-sub-tab")||null,d=[G,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,fe(ne),l].filter(Boolean).find(g=>document.getElementById(g)),m=document.querySelector("#reservations-tab .sub-tab-button.active"),p=document.querySelector("#reservations-tab .sub-tab.active"),f=p?.id||m?.getAttribute("data-sub-tab")||null;if(d&&f===d&&i())return p&&(p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false")),!0;if(d)P=d;else if(e>0)return!1}else if(i())return!0;return Rt(r,{skipStore:!0,skipRender:!0}),!0}function Qt(){if(!be)return;let e=0;const t=5;Ee&&(clearTimeout(Ee),Ee=null);const n=()=>{if(ys({attemptsLeft:t-e})){Ee=null;return}if(e>=t){Ee=null;return}e+=1,Ee=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",Qt);document.addEventListener("language:changed",Qt);document.addEventListener("theme:changed",Qt);const Ue={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let Ft=!1;const vs=1632,Ss=1776;function Es(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-vs)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-Ss)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function Ts(e){try{const t=Es(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function Ye(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=Ts(t))}function yn(){Ft=!1;const e=re(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,o=Array.isArray(e.technicians)?e.technicians.length:0;Ue.projects.forEach(r=>Ye(r,t)),Ue.reservations.forEach(r=>Ye(r,n)),Ue.equipment.forEach(r=>Ye(r,a)),Ue.technicians.forEach(r=>Ye(r,o))}function vn(){Ft||(Ft=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(yn):setTimeout(yn,16))}function ws(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,vn,{passive:!0})}),vn()}pa();let Y=null;async function Sn(){if(!await fa())return;ga(),bs(),ws(),ba(),jt(),Aa(),rt(),fs(),fr(),Ca(),An();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const o=a.target.files&&a.target.files[0];o&&(await La(o),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",ha),As(),Cs()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Sn().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):Sn().catch(e=>{console.error("❌ Failed to initialise app",e)});function As(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[o]=a.split(":"),r=`${o.padStart(2,"0")}:00`,i=`${n}T${r}`;e.value!==i&&(e.value=i,setTimeout(()=>e.blur(),150))})})}function Cs(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;Y={reservationId:t,reservationIndex:n!=null?Number(n):null},ia(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),o=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,o)}function ia(){if(!Y)return;const t=re().reservations||[];let n=null;if(Y.reservationId){const a=t.findIndex(o=>String(o?.id)===Y.reservationId||String(o?.reservationId)===Y.reservationId);a!==-1&&(n=a)}n===null&&typeof Y.reservationIndex=="number"&&!Number.isNaN(Y.reservationIndex)&&Y.reservationIndex>=0&&Y.reservationIndex<t.length&&(n=Y.reservationIndex),n!==null&&(Y=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const o=window.editReservation;typeof o=="function"&&o(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{Y&&ia()});
